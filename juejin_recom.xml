<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Moltbot的出现，我们不由的得思考给AI的权限是否过大？]]></title>    <link>https://juejin.cn/post/7600414546190221322</link>    <guid>https://juejin.cn/post/7600414546190221322</guid>    <pubDate>2026-01-29T12:30:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600414546190221322" data-draft-id="7600414546190188554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Moltbot的出现，我们不由的得思考给AI的权限是否过大？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T12:30:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LucianaiB"/> <meta itemprop="url" content="https://juejin.cn/user/1269294586664749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Moltbot的出现，我们不由的得思考给AI的权限是否过大？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1269294586664749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LucianaiB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T12:30:43.000Z" title="Thu Jan 29 2026 12:30:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是LucianaiB。</p>
<p>今天我们不聊虚的，聊点“危险”又迷人的东西。</p>
<h2 data-id="heading-0"><strong>为什么Moltbot爆火？</strong></h2>
<p>先说说为什么 Moltbot 会爆火？因为 Moltbot 解决了AI只说不做的问题。</p>
<p>先问大家一个问题：你现在的 AI 助手（ChatGPT 也好，Claude 也好），是不是**只能“动口不动手”？**你让它写代码，它写了，但得你复制粘贴去运行；你让它整理文件，它告诉你步骤，但得你自己去点鼠标。</p>
<p><strong>这种“只说不做”的 AI，很快就要过时了。</strong></p>
<p>最近 <strong>Moltbot</strong>（前身 Clawdbot）在极客圈子里突然爆火。为什么？因为它解决了一个核心痛点：<strong>它是一个拥有系统超级权限的 Agent。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72dfda73d47542f888956f020a46c4c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=Rqd%2F%2FJoOdoMouWoDdSzMFttPeaI%3D" alt="img" loading="lazy"/></p>
<p>这是什么概念？意味着你可以给它下达指令：“帮我把下载文件夹里所有的 PDF 发票整理到一个文件夹，并按日期重命名”。然后，你就可以去喝咖啡了，它会自己在后台静默执行，就像一个真实的员工坐在你的电脑前一样。</p>
<p><strong>这听起来很爽，但也让人后背发凉。</strong> 真的敢把 <code>rm -rf</code> 的权限交给 AI 吗？为了验证它的能力和安全性，我拿了一台闲置的 Windows 电脑做了个极限测试，并把这一整套**“Moltbot +** <strong>飞书</strong> **= 24小时私人助理”**的搭建流程跑通了。</p>
<p>不由的我们需要思考，给AI的权限是否过大，例如他会删除移动文件等操作，会产生不可逆的操作，目前没有人敢在自己的本机操作，基本都是用到的虚拟机或者云服务器。目前 Moltbot 可以直接接管一台电脑，真的会替代人的工作吗？我也是用了有些后怕，我做了一个测试，整理下载文件夹，没想到，效果非常的不错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee86e821790942d3ac70a082b1ac731c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=pCNwfZS4EvKYk3Kkoeccuf98QO0%3D" alt="img" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>Moltbot 部署教程并接入飞书（Windows版）—— 搭建你的24×7 AI员工</strong></h2>
<p>本文除过思考给AI的权限是否过大，还带来了在 Windows 部署 Moltbot 并配置飞书的完整过程。</p>
<h3 data-id="heading-2"><strong>什么是Moltbot？</strong></h3>
<p>Clawdbot 是一个 AI 助手，可以部署在本地电脑上或者服务器，可以理解为是一个拥有系统超级权限（root）的 Agent。</p>
<p>如果你用过 Claude Code， 就可以把它理解为拥有各种 skills 以及可以调用各种 MCP 服务协助完成任务的闭环。</p>
<p>可以让它帮你整理邮件、管理日程、炒股、写推文、读PPT等，在后台24小时运行，但这是非常耗 Token。</p>
<p>简单来说:</p>
<p>传统 AI:这是整理文件的方法,你照着做</p>
<p>Moltbot:已帮你整理520个文件到10大个分类!</p>
<p>其本质是将顶尖大语言模型(LLM)的「大脑」与本地设备的「执行能力」结合,通过聊天软件作为交互入口,打</p>
<p>造出7×24小时待命、无需人工干预的「数字员工」。</p>
<p>为了让大家更直观地理解 <strong>Moltbot 凭什么能接管电脑？</strong>，我画了一张架构图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3415c839a42743f3b7f2e688d05b5cb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=wtnCEK0BWdM8RLWMWtORjINnyNI%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-3"><strong>Moltbot 部署教程</strong></h3>
<h4 data-id="heading-4"><strong>1.安装Node.js (版本关键！)</strong></h4>
<p>下载 Node.js：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn" target="_blank" title="https://nodejs.org/zh-cn" ref="nofollow noopener noreferrer">nodejs.org/zh-cn</a>（不过多的介绍，不会的可以直接网上搜索下载教程）。</p>
<pre><code class="hljs language-javascript" lang="javascript"># 检查 <span class="hljs-title class_">Node</span> 版本，必须 &gt; v22
node --version
​
# 检查 npm 版本
npm --version
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6daa5e2540704cbf88f87c0181f6a982~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=gfbxMfH1sloamfX%2Brl13qQ8L3I4%3D" alt="img" loading="lazy"/></p>
<h4 data-id="heading-5"><strong>2.安装Moltbot</strong></h4>
<blockquote>
<p>虽然工具改名为 Moltbot 了，但在 npm 仓库里的包名目前依然沿用 <code>clawdbot</code>。</p>
</blockquote>
<pre><code class="hljs language-javascript" lang="javascript"># 安装核心包 (-g 代表全局安装)
npm install -g clawdbot@latest --registry=<span class="hljs-attr">https</span>:<span class="hljs-comment">//registry.npmmirror.com</span>
​
# 安装完成后，再次验证
clawdbot --version
# 如果能看到版本号，说明安装成功
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7d4cdcf94a64d26aa506e59bf33f33a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=1GRlb83FCxsiIKciJKLgOFgRs6E%3D" alt="img" loading="lazy"/></p>
<h4 data-id="heading-6"><strong>3.初次启动并配置</strong></h4>
<p>初次启动需要完成一些基本的配置，完成“入职培训”。。</p>
<pre><code class="hljs language-javascript" lang="javascript"># 必须以管理员身份运行
clawdbot onboard --install-daemon
</code></pre>
<p>这个命令会:</p>
<blockquote>
<p>启动交互式配置向导  自动配置后台服务  设置开机自启动（如果不想要开机自启，可以在文章末尾有解决方案）</p>
</blockquote>
<p>左右键选择，选择<code>Yes</code>然后回车。（这一步就是忽略安全警告）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deba4fb03b1840a1803fd8c23c3e863f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=qj0cJVZxnd2g8IbaAWlxrQLWrw4%3D" alt="img" loading="lazy"/></p>
<p>选择<code>QuickStart</code>（这一步就是快速开始）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b416e46cac11443aa88ca546e824a8c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=yeBWWvAHpLw%2BGwJJY5ngWEO3qc8%3D" alt="img" loading="lazy"/></p>
<p>这里模型的话我推荐选择<code>Z.AI (GLM 4.7)</code>，选择其余都可</p>
<blockquote>
<p>因为最近有优惠，优惠专属链接（立减10%），来一起薅羊毛：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bigmodel.cn%2Fglm-coding%3Fic%3D4G1ARPDRUV" target="_blank" title="https://www.bigmodel.cn/glm-coding?ic=4G1ARPDRUV" ref="nofollow noopener noreferrer">www.bigmodel.cn/glm-coding?…</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98a6a45d538e48f495bd99a3f896cdd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=ewpWEIMkiQbA%2Bsj3SJ9n6e4lmmY%3D" alt="img" loading="lazy"/></p>
<p>输入获取的密钥。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d63d9109ec77463c9428725c73b0761a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=bcDfckjpc1pbTAdf7B2wd2hLYes%3D" alt="img" loading="lazy"/></p>
<p>选择默认具体的模型即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2f10780e52c4344b2a650943b2571b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=Cpn1ip3Y8GH4A0WbAwErcuiuclc%3D" alt="img" loading="lazy"/></p>
<p>选择Skip for now。（这里就是选择用什么去操控，由于我用的飞书，在下一章节会写，这里就跳过）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3412bf2399934479971b5c5523c8dd6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=GC%2FtJC5pvQObFCA4Gkb9xFWme%2F0%3D" alt="img" loading="lazy"/></p>
<p>选择skills。（如果本地的话，可以选择<code>NO</code>，跳过）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/094cf8367d8a4d7d90961bd6ee491490~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=H9OXAnkITMczvAYxIq8IfhSmGR4%3D" alt="img" loading="lazy"/></p>
<p>这里的话3个都选择（启用全部钩子），可以通过空格键来选择确定。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8283a7bde1164d90abfb662c0ec7d43b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=jqKCs%2FH8xkKRqcmNKxrnJaHPNEE%3D" alt="img" loading="lazy"/></p>
<p>这里就是选择直接对话，还是web对话，我这里推荐使用web对话比较直观。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69e5d3f2635048008ca8c98b6ce7ea8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=ZFaJ6RG03FKML1bYglYZ42o4QpA%3D" alt="img" loading="lazy"/></p>
<p>配置完成后，它会自动开启 <code>18789</code> 端口。你可以先在浏览器访问 <code>http://127.0.0.1:18789/</code> 感受一下和它对话。（如果没有反应，可以看文章末尾解决办法）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f4f9df488204fc5a3c5116802c15257~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=cpwEp8sL%2FlULO2kIZOiFcI%2BDG2I%3D" alt="img" loading="lazy"/></p>
<p>后续正常使用下面的命令即可：</p>
<pre><code class="hljs language-javascript" lang="javascript">clawdbot dashboard
</code></pre>
<h3 data-id="heading-7"><strong>赋予灵魂：接入飞书实现远程操控</strong></h3>
<p>在本地运行虽然好，但我们不可能永远守在电脑前。接入飞书（Lark），就能让你在手机上随时随地给家里的电脑下达指令。</p>
<p>1.打开飞书开放平台配置：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp" target="_blank" title="https://open.feishu.cn/app" ref="nofollow noopener noreferrer">open.feishu.cn/app</a>，新建一个，输入相关信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aceb1896febc4b03aa15a1e57486c0ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=eyt0TwdjXj%2Bmsr7ZVhe%2B4rb%2Fd18%3D" alt="img" loading="lazy"/></p>
<p>2.获取到：App ID和App Secret</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/965778138d7b44929b01a7b9309735d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=zk6Ga9M5p9%2BYlsAU22d4jE5SsVc%3D" alt="img" loading="lazy"/></p>
<p>3.在添加应用能力里选择机器人并添加。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/200a6e399de942aa926bce8a742dd2b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=ybTMNz2JcGB1TnNE9HKwGQurh%2BE%3D" alt="img" loading="lazy"/></p>
<p>4.给机器人开通全部的权限。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/947f2a73dd3548deae41c699c0c4f397~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=m5Gp0iNtvyhWf1OK2MRhiLGs%2Bx0%3D" alt="img" loading="lazy"/></p>
<p>4.接下来就是下载插件使飞书和 Moltbot 连接，安装飞书插件 (两种方法)。</p>
<p><strong>方法 A：自动安装 (网络环境好推荐)</strong></p>
<p>我们在本地使用下载下面的包即可（可能考虑网络问题）。</p>
<pre><code class="hljs language-javascript" lang="javascript"># 正常是
clawdbot plugins install @m1heng-clawd/feishu
</code></pre>
<p><strong>方法 B：手动安装 (国内环境推荐)</strong></p>
<p>下面是手动下载并添加插件的过程</p>
<p>在~.clawdbot 创建一个 extensions 文件夹，然后把下面的减压到本文件夹（如果没有可以文章末尾，加我获取）。</p>
<p>暂时无法在飞书文档外展示此内容</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c43ca605dee74d4d8c31aedb52d64dee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=tA2eC8EEXvZEnNfIa0PZUTXQIao%3D" alt="img" loading="lazy"/></p>
<p>然后以管理员身份在本文件夹运行下面的命令进行安装即可（把第一步获取的飞书 App ID 填入 Moltbot 的配置中。）。</p>
<pre><code class="hljs language-javascript" lang="javascript"># 安装
npm install
​
clawdbot config set channels.<span class="hljs-property">feishu</span>.<span class="hljs-property">appId</span> <span class="hljs-string">"cli_xxxxx"</span>
clawdbot config set channels.<span class="hljs-property">feishu</span>.<span class="hljs-property">appSecret</span> <span class="hljs-string">"your_app_secret"</span>
clawdbot config set channels.<span class="hljs-property">feishu</span>.<span class="hljs-property">enabled</span> <span class="hljs-literal">true</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e6108d833849a3a33c2826ada9da48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=Jkcye61hIa2SBJENd79HdZBqopw%3D" alt="img" loading="lazy"/></p>
<p>5.接下来就是在事件与回调中选择长连接即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c335f96d806841e2ac274c89da433d4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=p%2BgTUzJ0OLQPnOpAQIoaYD0eIO8%3D" alt="img" loading="lazy"/></p>
<p>然后在添加事件中全部勾选即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/531551e3c40f4ec0a3ae4233b96a6801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=S9NGf2pxTHZ7BtUQ61zPUEiijwg%3D" alt="img" loading="lazy"/></p>
<p>6.最后就是插件一个版本进行发布即可，点击左侧“版本管理与发布” -&gt; 创建版本 -&gt; 申请发布。。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c2fe04359ac47faada174ca32f86b69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=F1fNIsUwgMWX124hmWrHf3ErPIk%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-8"><strong>实战演示：让 AI 帮我写文章与整理文件</strong></h3>
<p>直接在飞书中搜索刚刚插件的机器人给他命令即可，这里我让它给我写一篇文章。</p>
<p>我在飞书里发给它：</p>
<blockquote>
<p>“请帮我写一篇关于机器学习的文章。”</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2129d1b484c4dee9c9cee7d792581b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=uRfSY%2BK8Vw9XTpxxXd0wN%2Fj8WkQ%3D" alt="img" loading="lazy"/></p>
<p>打开电脑可以看到真的成功的写了一篇文章，虽然质量不怎么样，都是可以通过skills这些直接强化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7da0849b7a344143b319f01b97aac2e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770295043&amp;x-signature=5KPnVyUSuseSUemObm2kM8BhSTI%3D" alt="img" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>附录：常见问题自救指南</strong></h2>
<h3 data-id="heading-10"><strong>Q1: 对话没有回答，飞书显示已读？</strong></h3>
<p><strong>排查</strong>：通常是模型 API 额度用完了，或者 Key 过期。检查一下后台日志（<code>clawdbot logs</code>），如果看到 <code>401 Unauthorized</code> 就是这个问题。</p>
<h3 data-id="heading-11"><strong>Q2: 怎么彻底卸载并取消开机自启？</strong></h3>
<p>不想用了，想删干净，请执行以下命令：</p>
<pre><code class="hljs language-javascript" lang="javascript"># 停止正在运行的 <span class="hljs-title class_">Gateway</span> 服务
clawdbot gateway stop
​
# 卸载后台服务（关键步骤，否则每次开机都会报错）
clawdbot gateway uninstall
​
# 删除全局包
npm uninstall -g clawdbot
</code></pre>
<p><strong>Q3: 插件下载失败怎么办？</strong></p>
<ul>
<li>如果网络环境确实恶劣，可以关注 LucianaiB 私信“Moltbot的飞书插件”，我把打包好的离线包发给你。</li>
</ul>
<h2 data-id="heading-12"><strong>总结</strong></h2>
<p><strong>总体来说，瑕不掩瑜，Moltbot 绝对值得一试。</strong></p>
<p>但是，为了保护你的数字资产，我有以下<strong>强烈建议</strong>：</p>
<ul>
<li><strong>不要在主力生产力工具（存有重要资料且未备份）的物理机上直接裸奔运行。</strong></li>
<li><strong>最佳实践</strong>：使用虚拟机（VMware/VirtualBox）或者 Docker 容器部署 Moltbot。即使它“发疯”删库，你也只是损失了一个镜像文件，几秒钟就能恢复。</li>
<li><strong>权限最小化</strong>：在配置时，如果不是必要，不要赋予它全盘的 root 权限，限制它的活动范围在特定的工作目录（Workspace）内。</li>
</ul>
<p>拥抱变化，但在变化中保持谨慎。Moltbot 只是一个开始，未来的数字员工，一定会更加强大和安全。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[花一天研究了 565 个 Skills，我的 Clawdbot 比 ChatGPT 更懂我！]]></title>    <link>https://juejin.cn/post/7600562816458850346</link>    <guid>https://juejin.cn/post/7600562816458850346</guid>    <pubDate>2026-01-29T11:01:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600562816458850346" data-draft-id="7600560664407998527" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="花一天研究了 565 个 Skills，我的 Clawdbot 比 ChatGPT 更懂我！"/> <meta itemprop="keywords" content="AIGC,AI编程,Agent"/> <meta itemprop="datePublished" content="2026-01-29T11:01:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟健AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287073895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            花一天研究了 565 个 Skills，我的 Clawdbot 比 ChatGPT 更懂我！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287073895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟健AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T11:01:36.000Z" title="Thu Jan 29 2026 11:01:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是孟健。</p>
<p>昨天，我花了一整天时间研究 Clawdbot（现已更名为 Moltbot）官方的 565 个 Skills，说实话看得眼花缭乱。</p>
<p>最终，我从中挑选了 20 多个适合自己的 skill，全部装到了我的 AI 助理身上：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/906817c8608947ad8b3c79b98644c47b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=oqCzuhFzG7DCyKV%2Fb0bNdmiCbK0%3D" alt="" loading="lazy"/></p>
<p>今天就来分享一下我的安装过程和心得，照着做你也能打造一个真正懂你的私人助理。</p>
<h2 data-id="heading-0">00 先让助理认识你</h2>
<p>在装任何 skill 之前，<strong>第一步应该是让助理了解你这个人。</strong></p>
<p>比如，这是我助理的记忆文件：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c34ac71b514858a8f268ca2417af98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=eYO2Tyua%2BNahbrmKQPvkKhTQEd8%3D" alt="" loading="lazy"/></p>
<p>我是怎么做的呢？其实很简单——找几篇我之前写过个人经历的公众号文章，直接发给它：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d6514b9b2844718a9991c8d4d230edc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=FprIhu%2BpoVkjCSrxWVbQ6f%2FldrQ%3D" alt="" loading="lazy"/></p>
<p>它会自动提取关键信息，生成长期记忆。这样以后它回答问题、帮你做决策时，都是基于对你的了解来的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d698b93754ff4c938df05a3067adbfa4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=2nPMTvmd5vMnFhZudI21IQu7XQA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">01 邮件管理：gog</h2>
<p>第一个装的 skill 是 gog，用来连接 Gmail。</p>
<p>只需要通过 Google Cloud Console 生成一个 OAuth token 给它就行，不会操作的话可以让 AI 一步步教你。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Ftree%2Fmain%2Fskills%2Fsteipete%2Fgog%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/tree/main/skills/steipete/gog/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 获取 Google OAuth credentials（从 Google Cloud Console）</span>
<span class="hljs-comment"># 2. 配置认证</span>
gog auth credentials /path/to/client_secret.json
gog auth add you@gmail.com --services gmail,calendar,drive,contacts,docs,sheets
gog auth list
</code></pre>
<p>装完之后，我现在完全让它帮我看邮件、筛选重要信息、处理回复：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c411b210602044bc9b4d93ce1cea13e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=WVjBek%2Bk9EHbA4mxCjiNjeZN1iY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">02 自动更新 &amp; 文档同步</h2>
<p>接着装了两个基础 skill：：</p>
<p><strong>自动更新</strong>——让它能定时自己更新版本，不用我操心：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Ftree%2Fmain%2Fskills%2Fmaximeprades%2Fauto-updater%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/tree/main/skills/maximeprades/auto-updater/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f9557b34e0a44b6aec3895eff5d78a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=o10EIkM2wj6aDy5WKmWXcJNaZHw%3D" alt="" loading="lazy"/></p>
<p><strong>文档同步</strong>——让它更了解自己的能力边界，后续你可以用它来操控 Clawdbot 本身：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Ftree%2Fmain%2Fskills%2Faranej%2Fclawd-docs-v2%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/tree/main/skills/aranej/clawd-docs-v2/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eee7b5528c57464abfaf6550169b6f3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=b9sChewLUxj6IfqLKcDkWfed2vM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">03 PDF 解析：解锁文件理解能力</h2>
<p>我的美国公司刚好注册下来了，我让它帮我存储公司的重要文件：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa5b324fcfc34aa583464820c5472356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=2n5aE2bfmII7qHAdsVlSELv7MtA%3D" alt="" loading="lazy"/></p>
<p>结果它告诉我看不了 PDF。行吧，那就让它自己装一个 PDF 解析的 skill：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fsteipete%2Fmarkdown-converter%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/steipete/markdown-converter/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1cdc54c4fa6497d8b8e13d9b4c6d1b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=PHswbhLb8gUhBPF2K7mkjDUoNkM%3D" alt="" loading="lazy"/></p>
<p>装完之后，英文的公司注册文件、税务文件它都能直接读取和理解，省得自己一页页啃英文了。</p>
<h2 data-id="heading-4">04 每日回顾 &amp; 定时提醒</h2>
<p><strong>每日回顾</strong>这个 skill 我觉得挺有意思，每天自动生成一张回顾卡片：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fdbhurley%2Fdaily-recap%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/dbhurley/daily-recap/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b42059447b1e4a5ebcda739257d3b5b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=wpHGFlaVV1a%2Fo4r%2B%2BV27g3YWw7k%3D" alt="" loading="lazy"/></p>
<p>因为它依赖图片生成能力，所以又顺带装了 Nano Banana Pro：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fsteipete%2Fnano-banana-pro%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/steipete/nano-banana-pro/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p>最终效果如下，还是很不错的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5171cb7edfc5496fade68696a0f6aed6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=KoYpkxYNLrwqzAp%2Fuk%2FVFcZ5Y%2Fk%3D" alt="" loading="lazy"/></p>
<p>另外还装了邮件晨报和定时提醒，让它每天主动给我推关键信息：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fam-will%2Fmorning-email-rollup%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/am-will/morning-email-rollup/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fjulianengel%2Fremind-me%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/julianengel/remind-me/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15b8ed74c05941b6b1b6337c71753b96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=UvdfD%2F%2FkxIvp%2FEBLVd87iDcLqGg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">05 社交媒体：Twitter 阅读</h2>
<p>装了 Bird 这个 skill，可以直接读取我 Twitter 上的信息流：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fsteipete%2Fbird%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/steipete/bird/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac5d2551f35b4706bb0d78621521b31a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=0JDrbes5lXOmXaglD715XdWzrBc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">06 去 AI 味儿</h2>
<p>这两个 skill 我觉得特别实用——<strong>专门用来消除 AI 生成文本的痕迹：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fitsflow%2Fde-ai-ify%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/itsflow/de-ai-ify/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fbiostartechnology%2Fhumanizer%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/biostartechnology/humanizer/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64143b5e17a74bc7a2c1daa373c7285f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=L0kJiyvYSbfM2J94trMzoY7N26s%3D" alt="" loading="lazy"/></p>
<p>写公众号、写邮件的时候特别好用，让 AI 帮你写初稿，再用这俩 skill 把"AI 味儿"去掉。</p>
<h2 data-id="heading-7">07 个人成长类</h2>
<p>这几个 skill 是我个人比较喜欢的：</p>
<p>• 芒格观察者：用查理·芒格的多元思维模型来审视你的决策</p>
<p>• 自信与自爱：帮你记录小成就、建立正向反馈</p>
<p>• 心理疏导模式：CBT、ACT 等专业心理框架</p>
<p>• 每周复盘：自动生成一周的工作与思考总结</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fjdrhyne%2Fmunger-observer%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/jdrhyne/munger-observer/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fjhillin8%2Fself-love-confidence%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/jhillin8/self-love-confidence/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fthesethrose%2Ftherapy-mode%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/thesethrose/therapy-mode/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fitsflow%2Fweekly-synthesis%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/itsflow/weekly-synthesis/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfce92fde6b449439e436c8f4475f0ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=afg1crTpxADcqVx0FkANMUrB1oY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">08 YouTube 视频理解</h2>
<p>装了两个 YouTube 相关的 skill，可以直接读取视频字幕和内容：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fsteipete%2Fvideo-transcript-downloader%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/steipete/video-transcript-downloader/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fmichaelgathara%2Fyoutube-watcher%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/michaelgathara/youtube-watcher/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f3f75822cc2429383e74e100a7d16bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=22LKRhXbPo8gtugJvzaRZpYLl1Y%3D" alt="" loading="lazy"/></p>
<p>以后看到好的英文技术视频，直接丢链接给它，几秒钟就能拿到完整的内容摘要。</p>
<h2 data-id="heading-9">09 流程图绘制</h2>
<p>发现了一个画流程图的 skill，基于 Excalidraw，直接用文字描述就能生成专业的流程图：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fswiftlysingh%2Fexcalidraw-flowchart%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/swiftlysingh/excalidraw-flowchart/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8835bb84fe74b6eae538d06b3a69ef9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=f8yHo%2BogXawmXS7tE0K5ta9fdw4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">10 营销专家：做出海产品必备</h2>
<p>这个 skill 我强烈推荐给所有做海外产品的朋友——<strong>营销专家模块</strong>，里面包含 23 个子模块，覆盖 SEO、文案、转化率优化、付费投放、定价策略等等：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fjchopard69%2Fmarketing-skills%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/jchopard69/marketing-skills/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Fblob%2Fmain%2Fskills%2Fthesethrose%2Fmarketing-mode%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/blob/main/skills/thesethrose/marketing-mode/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10d55526ff284412ba5562ac5251ab5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=2Imc7xtj4H3VndHIQTCqNDirzVo%3D" alt="" loading="lazy"/></p>
<p>做出海的同学应该知道，SEO、SEM、Affiliate 这些东西零零散散的，有个系统化的营销顾问在旁边随时能问，太香了。</p>
<h2 data-id="heading-11">11 Todo 管理</h2>
<p>最后装了一个 Todo 管理的 skill：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fskills%2Ftree%2Fmain%2Fskills%2Fjdrhyne%2Ftodo-tracker%2FSKILL.md" target="_blank" title="https://github.com/moltbot/skills/tree/main/skills/jdrhyne/todo-tracker/SKILL.md" ref="nofollow noopener noreferrer">github.com/moltbot/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03820d8b0ba14d3a9d9bec2b7d0e9a1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770289295&amp;x-signature=ahczh7yJwqmhpzEkrN4M3WvnCJs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">写在最后</h2>
<p>以上就是我配置的所有 skill 了。装完之后，我觉得我的 ChatGPT 完全可以丢掉了。</p>
<p>有朋友问我：<strong>Clawdbot 到底比</strong> <strong>ChatGPT</strong> <strong>强在哪？</strong></p>
<p>我的回答是：</p>
<ol>
<li>
<p><strong>记忆真正可控。</strong> ChatGPT 的记忆功能很有限，而且你控制不了它记住什么、忘掉什么。Clawdbot 的长期记忆是文件化的，每天都会记录，你想召回随时都可以。</p>
</li>
<li>
<p><strong>能力自由装配。</strong> 通过 skill 系统，你可以按需安装各种能力——邮件、营销、YouTube、流程图、心理疏导……ChatGPT 做不到这种深度定制。</p>
</li>
<li>
<p><strong>可操控范围大得多。</strong> 它能存你的 token、读你的文件、连接你的各种服务。你的重要文件都可以让它存着当备份，随时召回，而且它还能理解文件内容。</p>
</li>
<li>
<p><strong>本质区别：</strong> ChatGPT 是一个对话工具，而 <strong>Clawdbot 更像是一个真正的私人助理</strong>——你甚至可以把它当做一个人来看待。</p>
</li>
</ol>
<p><strong>如果你也想拥有一个这样的助理，可以直接去试试。</strong></p>
<hr/>
<p>🚀 想要与更多AI爱好者交流，共同成长吗？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ4k_5_waWJbRRo5lZBZmog" target="_blank" title="https://mp.weixin.qq.com/s/Z4k_5_waWJbRRo5lZBZmog" ref="nofollow noopener noreferrer">和一群志同道合的人，持续精进 AI 的每一天</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（三）：状态管理 - 从原理到实践]]></title>    <link>https://juejin.cn/post/7600663744192069668</link>    <guid>https://juejin.cn/post/7600663744192069668</guid>    <pubDate>2026-01-29T11:34:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600663744192069668" data-draft-id="7600562816458653738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（三）：状态管理 - 从原理到实践"/> <meta itemprop="keywords" content="Kotlin,JetBrains,Android"/> <meta itemprop="datePublished" content="2026-01-29T11:34:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（三）：状态管理 - 从原理到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T11:34:11.000Z" title="Thu Jan 29 2026 11:34:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入理解 Compose 的状态系统：Slot Table 机制、重组原理、状态提升设计模式，以及企业级状态管理最佳实践。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>在前两篇中，我们掌握了 Compose 的布局系统。但一个完整的应用离不开状态管理：用户的点击、网络请求的结果、页面的切换...这些都需要状态来驱动 UI 更新。</p>
<p>Compose 的状态系统与传统 View 系统完全不同，它采用了<strong>响应式编程</strong>的思想：状态变化自动触发 UI 更新。这听起来很神奇，但背后有着精妙的设计。</p>
<p>本篇文章将带你深入理解：</p>
<ul>
<li>Compose 如何追踪状态变化？</li>
<li>重组（Recomposition）到底是什么？</li>
<li>为什么有时候状态更新了 UI 却没刷新？</li>
<li>如何设计优雅的状态管理架构？</li>
</ul>
<p>让我们开始这场深入源码的探索之旅！</p>
<hr/>
<h2 data-id="heading-1">一、状态与重组机制深度解析</h2>
<h3 data-id="heading-2">1.1 响应式编程的本质</h3>
<p>Compose 的核心理念是<strong>状态驱动 UI</strong>。当状态变化时，UI 会自动更新。这背后的关键机制就是<strong>重组（Recomposition）</strong>。</p>
<p><strong>传统 View 系统（命令式）</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 手动更新 UI</span>
button.setOnClickListener {
    count++
    textView.text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>  <span class="hljs-comment">// 手动设置新值</span>
}
</code></pre>
<p><strong>Compose（声明式）</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)  <span class="hljs-comment">// 自动更新</span>
    }
}
</code></pre>
<p><strong>关键区别</strong>：Compose 会自动追踪 <code>count</code> 的变化，当 <code>count</code> 改变时，自动重新执行 <code>Counter</code> 函数，更新 UI。</p>
<h3 data-id="heading-3">1.2 Slot Table：Compose 的"记忆"系统</h3>
<p>Compose 如何知道哪些 Composable 需要重组？答案就是 <strong>Slot Table</strong>。</p>
<h4 data-id="heading-4">1.2.1 为什么需要 Slot Table？</h4>
<p>想象这样一个场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p>当用户点击按钮，<code>count</code> 从 0 变成 1。此时 Compose 需要：</p>
<ol>
<li>知道 <code>count</code> 的新值是 1</li>
<li>知道哪些 Composable 读取了 <code>count</code></li>
<li>只更新那些 Composable</li>
</ol>
<p><strong>Slot Table 就是解决这个问题的核心机制</strong>。</p>
<h4 data-id="heading-5">1.2.2 Slot Table 是什么？</h4>
<p>Slot Table 是 Compose 运行时维护的一个<strong>线性数组</strong>，用于存储 Composable 函数的执行结果。你可以把它理解为 Compose 的"记忆系统"。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">┌─────────────────────────────────────────────────────────────────┐
│                      Slot Table 结构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  索引    类型          内容                                      │
│  ─────────────────────────────────────────────────────────────  │
│   <span class="hljs-number">0</span>      <span class="hljs-keyword">Group</span>        Counter (Composable 组)                   │
│   <span class="hljs-number">1</span>      Int          <span class="hljs-number">0</span> (remember 的 <span class="hljs-keyword">key</span>)                       │
│   <span class="hljs-number">2</span>      State        MutableState(value=<span class="hljs-number">0</span>)                     │
│   <span class="hljs-number">3</span>      <span class="hljs-keyword">Group</span>        Button                                    │
│   <span class="hljs-number">4</span>      Lambda       onClick = { count++ }                     │
│   <span class="hljs-number">5</span>      <span class="hljs-keyword">Group</span>        <span class="hljs-keyword">Text</span>                                      │
│   <span class="hljs-number">6</span>      <span class="hljs-type">String</span>       <span class="hljs-string">"Count: 0"</span>                                │
│   <span class="hljs-number">7</span>      EndGroup     <span class="hljs-keyword">Text</span> 结束                                 │
│   <span class="hljs-number">8</span>      EndGroup     Button 结束                               │
│   <span class="hljs-number">9</span>      EndGroup     Counter 结束                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Slot Table 的三大作用</strong>：</p>
<ol>
<li><strong>记忆状态</strong>：保存 <code>remember</code>、<code>mutableStateOf</code> 等的状态，重组时不丢失</li>
<li><strong>追踪结构</strong>：记录 Composable 树的结构，知道哪个组件在哪里</li>
<li><strong>支持重组</strong>：通过对比新旧 Slot Table，确定哪些部分需要更新</li>
</ol>
<h4 data-id="heading-6">1.2.3 Slot Table 的源码实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SlotTable 简化版源码（位于 androidx.compose.runtime 包）</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SlotTable</span> {
    <span class="hljs-comment">// 存储数据的数组，所有状态和对象都存在这里</span>
    <span class="hljs-keyword">val</span> slots = Array&lt;Any?&gt;(<span class="hljs-number">64</span>) { <span class="hljs-literal">null</span> }
    
    <span class="hljs-comment">// 当前写入位置</span>
    <span class="hljs-keyword">var</span> currentSlot = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 组（Group）的栈，用于追踪嵌套的 Composable</span>
    <span class="hljs-keyword">val</span> groups = IntArray(<span class="hljs-number">64</span>)
    <span class="hljs-keyword">var</span> currentGroup = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 写入数据到当前位置，然后移动到下一个</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">write</span><span class="hljs-params">(value: <span class="hljs-type">Any</span>?)</span></span> {
        slots[currentSlot++] = value
    }
    
    <span class="hljs-comment">// 读取当前位置的数据，然后移动到下一个</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span>: Any? = slots[currentSlot++]
    
    <span class="hljs-comment">// 开始一个组（Composable）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startGroup</span><span class="hljs-params">(key: <span class="hljs-type">Int</span>)</span></span> {
        groups[currentGroup++] = currentSlot
        write(key)
    }
    
    <span class="hljs-comment">// 结束一个组</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endGroup</span><span class="hljs-params">()</span></span> {
        currentGroup--
    }
}
</code></pre>
<h4 data-id="heading-7">1.2.4 Slot Table 如何工作？</h4>
<p>让我们通过一个完整例子理解：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p><strong>首次组合时</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 开始 Counter 组
   SlotTable<span class="hljs-selector-class">.startGroup</span>("Counter".hashCode())
   
<span class="hljs-number">2</span>. 执行 remember { <span class="hljs-built_in">mutableStateOf</span>(<span class="hljs-number">0</span>) }
   - 创建 MutableState 对象
   - 写入 SlotTable: <span class="hljs-built_in">write</span>(<span class="hljs-built_in">MutableState</span>(<span class="hljs-number">0</span>))
   
<span class="hljs-number">3</span>. 开始 Button 组
   SlotTable.<span class="hljs-built_in">startGroup</span>(<span class="hljs-string">"Button"</span>.<span class="hljs-built_in">hashCode</span>())
   
<span class="hljs-number">4</span>. 执行 <span class="hljs-built_in">Text</span>(<span class="hljs-string">"Count: $count"</span>)
   - 读取 count 的值: <span class="hljs-number">0</span>
   - 写入 SlotTable: <span class="hljs-built_in">write</span>(<span class="hljs-string">"Count: 0"</span>)
   
<span class="hljs-number">5</span>. 结束所有组
</code></pre>
<p><strong>重组时</strong>（用户点击后，count 变成 1）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 开始 Counter 组
<span class="hljs-bullet">   -</span> 发现这个组已经存在
<span class="hljs-bullet">   -</span> 跳过已存在的内容，只对比变化
   
<span class="hljs-bullet">2.</span> 执行 remember
<span class="hljs-bullet">   -</span> 发现 remember 已经存在
<span class="hljs-bullet">   -</span> 直接返回缓存的 MutableState
   
<span class="hljs-bullet">3.</span> 执行 Text("Count: $count")
<span class="hljs-bullet">   -</span> 发现之前的值是 "Count: 0"
<span class="hljs-bullet">   -</span> 新的值是 "Count: 1"
<span class="hljs-bullet">   -</span> 值不同！需要更新
   
<span class="hljs-bullet">4.</span> 只更新 Text 组件
</code></pre>
<h3 data-id="heading-8">1.3 Composition 的生命周期</h3>
<p>Compose 的渲染过程分为三个阶段：</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────────┐
│                   Composition 生命周期                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   初始组合 (<span class="hljs-keyword">Initial</span> Composition)                                │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1.</span> 执行 Composable 函数                                  │  │
│   │ <span class="hljs-number">2.</span> 填充 Slot <span class="hljs-keyword">Table</span>                                       │  │
│   │ <span class="hljs-number">3.</span> 创建 LayoutNode 树                                    │  │
│   │ <span class="hljs-number">4.</span> 测量、布局、绘制                                       │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   状态变化                                                      │
│                              ↓                                  │
│   重组 (Recomposition)                                          │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1.</span> 检测到 State 变化                                     │  │
│   │ <span class="hljs-number">2.</span> 标记受影响的 Composable 为"过期"                      │  │
│   │ <span class="hljs-number">3.</span> 重新执行过期的 Composable                             │  │
│   │ <span class="hljs-number">4.</span> 对比新旧 Slot <span class="hljs-keyword">Table</span>                                   │  │
│   │ <span class="hljs-number">5.</span> 只更新变化的部分                                      │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   布局与绘制 (Layout <span class="hljs-operator">&amp;</span> Draw)                                    │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1.</span> 测量受影响的节点                                       │  │
│   │ <span class="hljs-number">2.</span> 布局受影响的节点                                       │  │
│   │ <span class="hljs-number">3.</span> 绘制受影响的区域                                       │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-9">1.4 重组的触发机制</h3>
<h4 data-id="heading-10">1.4.1 State 变化如何触发重组？</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// mutableStateOf 的简化实现</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">mutableStateOf</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span>: MutableState&lt;T&gt; =
    SnapshotMutableStateImpl(value)

<span class="hljs-comment">// SnapshotMutableStateImpl 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SnapshotMutableStateImpl</span>&lt;<span class="hljs-type">T</span>&gt;(initial: T) : MutableState&lt;T&gt; {
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> value: T
        <span class="hljs-keyword">get</span>() = next.readable(<span class="hljs-keyword">this</span>).value
        <span class="hljs-keyword">set</span>(value) = next.withCurrent {
            <span class="hljs-keyword">if</span> (it.value != value) {
                <span class="hljs-comment">// 1. 创建新的 State 记录</span>
                next = it.newStateRecord(value)
                <span class="hljs-comment">// 2. 通知观察者</span>
                notifyObservers()
            }
        }
}
</code></pre>
<p><strong>触发流程</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">1. 用户点击按钮
        ↓
2. count++ 执行
        ↓
<span class="hljs-attr">3. MutableState.value</span> = newValue
        ↓
4. 创建新的 Snapshot 记录
        ↓
5. 通知所有读取过该 State 的 Composable
        ↓
6. 将这些 Composable 标记为"需要重组"
        ↓
7. 在下一帧，执行重组
</code></pre>
<h4 data-id="heading-11">1.4.2 重组的范围控制</h4>
<p>Compose 会尽量缩小重组的范围：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Parent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Column {
        <span class="hljs-comment">// 这个 Text 会重组，因为它读取了 count</span>
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
        
        <span class="hljs-comment">// 这个 Button 不会重组，因为它没有读取 count</span>
        Button(onClick = { count++ }) {
            Text(<span class="hljs-string">"Increment"</span>)
        }
        
        <span class="hljs-comment">// Child 会重组吗？取决于它是否读取了 count</span>
        Child(count)
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Child</span><span class="hljs-params">(count: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-comment">// 如果这里使用了 count，就会重组</span>
    Text(<span class="hljs-string">"Child: <span class="hljs-variable">$count</span>"</span>)
}
</code></pre>
<p><strong>重组范围规则</strong>：</p>
<ul>
<li>只有<strong>读取了变化 State</strong> 的 Composable 才会重组</li>
<li>重组会<strong>向下传播</strong>到所有子 Composable</li>
<li>可以通过<strong>参数传递</strong>控制重组范围</li>
</ul>
<h3 data-id="heading-12">1.5 重组的优化策略</h3>
<h4 data-id="heading-13">1.5.1 @Stable 与 @Immutable</h4>
<p>Compose 使用 <strong>稳定性（Stability）</strong> 来判断对象变化时是否需要重组：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不稳定类 - 任何变化都会触发重组</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UnstableUser</span> {
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
}

<span class="hljs-comment">// 稳定类 - 只有属性变化时触发重组</span>
<span class="hljs-meta">@Stable</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StableUser</span> {
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
}

<span class="hljs-comment">// 不可变类 - 实例替换时触发重组</span>
<span class="hljs-meta">@Immutable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmutableUser</span>(
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>
)
</code></pre>
<p><strong>稳定性对比</strong>：</p>

























<table><thead><tr><th>注解</th><th>说明</th><th>触发重组条件</th></tr></thead><tbody><tr><td>无</td><td>不稳定</td><td>任何情况都可能重组</td></tr><tr><td>@Stable</td><td>稳定</td><td>属性变化时重组</td></tr><tr><td>@Immutable</td><td>不可变</td><td>实例替换时重组</td></tr></tbody></table>
<h4 data-id="heading-14">1.5.2 remember 的妙用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ExpensiveCalculation</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span> {
    <span class="hljs-comment">// ❌ 错误：每次重组都重新计算</span>
    <span class="hljs-keyword">val</span> sum = <span class="hljs-keyword">data</span>.sum()
    
    <span class="hljs-comment">// ✅ 正确：只在 data 变化时计算</span>
    <span class="hljs-keyword">val</span> sum = remember(<span class="hljs-keyword">data</span>) { <span class="hljs-keyword">data</span>.sum() }
    
    Text(<span class="hljs-string">"Sum: <span class="hljs-variable">$sum</span>"</span>)
}
</code></pre>
<h4 data-id="heading-15">1.5.3 derivedStateOf：派生状态</h4>
<p>当状态变化频繁，但 UI 不需要每次都更新时，使用 <code>derivedStateOf</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchList</span><span class="hljs-params">(query: <span class="hljs-type">String</span>, items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Item</span>&gt;)</span></span> {
    <span class="hljs-comment">// ❌ 错误：每次 query 变化都过滤整个列表</span>
    <span class="hljs-keyword">val</span> filtered = items.filter { it.name.contains(query) }
    
    <span class="hljs-comment">// ✅ 正确：只在必要时更新</span>
    <span class="hljs-keyword">val</span> filtered <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            items.filter { it.name.contains(query) }
        }
    }
    
    LazyColumn {
        items(filtered) { item -&gt;
            ItemRow(item)
        }
    }
}
</code></pre>
<p><strong>derivedStateOf 的原理</strong>：</p>
<ul>
<li>内部维护一个缓存值</li>
<li>只有读取时才会重新计算</li>
<li>计算结果变化时才通知观察者</li>
</ul>
<hr/>
<h2 data-id="heading-16">二、remember 与 mutableStateOf 源码解析</h2>
<h3 data-id="heading-17">2.1 remember 的原理</h3>
<p><code>remember</code> 是 Compose 中用于<strong>缓存计算结果</strong>的函数。它的核心作用是：在重组时保持状态不变。</p>
<h4 data-id="heading-18">2.1.1 为什么需要 remember？</h4>
<p>看一个例子：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>  <span class="hljs-comment">// ❌ 错误：每次重组都会重置为 0</span>
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p>每次用户点击按钮，触发重组，<code>count</code> 都会被重新初始化为 0。这是因为我们没有"记住"这个值。</p>
<p><strong>remember 的作用</strong>：在首次组合时计算值，并在后续重组时返回缓存的值。</p>
<h4 data-id="heading-19">2.1.2 remember 的源码实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// remember 的简化实现</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">remember</span><span class="hljs-params">(
    <span class="hljs-keyword">vararg</span> keys: <span class="hljs-type">Any</span>?,  <span class="hljs-comment">// 缓存的 key</span>
    calculation: () -&gt; <span class="hljs-type">T</span>  <span class="hljs-comment">// 计算函数</span>
)</span></span>: T {
    <span class="hljs-comment">// 获取当前 Composer</span>
    <span class="hljs-keyword">val</span> composer = currentComposer
    
    <span class="hljs-comment">// 在 Slot Table 中查找缓存</span>
    <span class="hljs-keyword">val</span> slot = composer.nextSlot()
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (slot === Composer.Empty || 
               keys.any { it != composer.rememberedValue() }) {
        <span class="hljs-comment">// 缓存不存在或 key 变化，重新计算</span>
        <span class="hljs-keyword">val</span> value = calculation()
        composer.updateRememberedValue(value)
        value
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 使用缓存</span>
        <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
        slot <span class="hljs-keyword">as</span> T
    }
}
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────┐
│                      remember 执行流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  第一次组合                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. 读取 Slot <span class="hljs-selector-tag">Table</span> → 得到 Composer<span class="hljs-selector-class">.Empty</span>               │   │
│  │ <span class="hljs-number">2</span>. 执行 calculation()                                   │   │
│  │ <span class="hljs-number">3</span>. 将结果写入 Slot <span class="hljs-selector-tag">Table</span>                                │   │
│  │ <span class="hljs-number">4</span>. 返回结果                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  重组（key 未变化）                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. 读取 Slot <span class="hljs-selector-tag">Table</span> → 得到缓存值                         │   │
│  │ <span class="hljs-number">2</span>. 对比 keys → 没有变化                                 │   │
│  │ <span class="hljs-number">3</span>. 直接返回缓存值（跳过了 calculation）                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  重组（key 变化）                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. 读取 Slot <span class="hljs-selector-tag">Table</span> → 得到缓存值                         │   │
│  │ <span class="hljs-number">2</span>. 对比 keys → 有变化                                   │   │
│  │ <span class="hljs-number">3</span>. 执行 calculation()                                   │   │
│  │ <span class="hljs-number">4</span>. 更新 Slot <span class="hljs-selector-tag">Table</span>                                      │   │
│  │ <span class="hljs-number">5</span>. 返回新结果                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-20">2.1.3 remember 的多种用法</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 无 key - 永远使用缓存</span>
<span class="hljs-keyword">val</span> value = remember { expensiveCalculation() }

<span class="hljs-comment">// 2. 有 key - key 变化时重新计算</span>
<span class="hljs-keyword">val</span> value = remember(userId) { loadUser(userId) }

<span class="hljs-comment">// 3. 多个 key - 任一 key 变化都重新计算</span>
<span class="hljs-keyword">val</span> value = remember(userId, refreshFlag) { loadUser(userId) }

<span class="hljs-comment">// 4. rememberSaveable - 配置变更后恢复</span>
<span class="hljs-keyword">val</span> value = rememberSaveable { mutableStateOf(<span class="hljs-number">0</span>) }
</code></pre>
<h3 data-id="heading-21">2.2 mutableStateOf 的原理</h3>
<p><code>mutableStateOf</code> 创建了一个<strong>可观察的状态对象</strong>，当值变化时会自动触发重组。</p>
<h4 data-id="heading-22">2.2.1 mutableStateOf 的源码实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// mutableStateOf 实现</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">mutableStateOf</span><span class="hljs-params">(
    value: <span class="hljs-type">T</span>,
    policy: <span class="hljs-type">SnapshotMutationPolicy</span>&lt;<span class="hljs-type">T</span>&gt; = structuralEqualityPolicy()</span></span>
): MutableState&lt;T&gt; = createSnapshotMutableState(value, policy)

<span class="hljs-comment">// SnapshotMutableStateImpl 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SnapshotMutableStateImpl</span>&lt;<span class="hljs-type">T</span>&gt;(
    initial: T,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> policy: SnapshotMutationPolicy&lt;T&gt;
) : MutableState&lt;T&gt; {
    
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> value: T
        <span class="hljs-keyword">get</span>() = next.readable(<span class="hljs-keyword">this</span>).value
        <span class="hljs-keyword">set</span>(value) = next.withCurrent {
            <span class="hljs-comment">// 使用 policy 判断是否相等</span>
            <span class="hljs-keyword">if</span> (!policy.equivalent(it.value, value)) {
                <span class="hljs-comment">// 创建新的 State 记录</span>
                next = it.newStateRecord(value)
            }
        }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">component1</span><span class="hljs-params">()</span></span>: T = value
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">component2</span><span class="hljs-params">()</span></span>: (T) -&gt; <span class="hljs-built_in">Unit</span> = { value = it }
}
</code></pre>
<h4 data-id="heading-23">2.2.2 Snapshot 机制</h4>
<p>Compose 的 State 基于 <strong>Snapshot（快照）</strong> 机制实现：</p>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────────┐
│                      Snapshot 机制                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Snapshot 1 (当前)                                             │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  StateRecord 1: <span class="hljs-attr">value</span> = <span class="hljs-string">"A"</span>                             │  │
│   │  StateRecord 2: <span class="hljs-attr">value</span> = <span class="hljs-string">"B"</span>  ← 当前值                   │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   <span class="hljs-attr">value</span> = <span class="hljs-string">"C"</span> (修改)                                            │
│                              ↓                                  │
│   Snapshot 2 (新快照)                                           │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  StateRecord 1: <span class="hljs-attr">value</span> = <span class="hljs-string">"A"</span>                             │  │
│   │  StateRecord 2: <span class="hljs-attr">value</span> = <span class="hljs-string">"B"</span>                             │  │
│   │  StateRecord 3: <span class="hljs-attr">value</span> = <span class="hljs-string">"C"</span>  ← 新记录                   │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   通知观察者：值从 "B" 变为 "C"                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Snapshot 的优势</strong>：</p>
<ul>
<li><strong>原子性</strong>：多个 State 的修改要么全部生效，要么全部不生效</li>
<li><strong>一致性</strong>：读取时看到的是一致的快照</li>
<li><strong>可回滚</strong>：可以丢弃未提交的修改</li>
</ul>
<h4 data-id="heading-24">2.2.3 状态比较策略</h4>
<p><code>mutableStateOf</code> 支持三种比较策略：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 结构相等（默认）- 使用 == 比较</span>
<span class="hljs-keyword">val</span> state = mutableStateOf(listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>))
state.value = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)  <span class="hljs-comment">// 不会触发重组，因为内容相等</span>

<span class="hljs-comment">// 2. 引用相等 - 使用 === 比较</span>
<span class="hljs-keyword">val</span> state = mutableStateOf(listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>), policy = referentialEqualityPolicy())
state.value = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)  <span class="hljs-comment">// 会触发重组，因为是新对象</span>

<span class="hljs-comment">// 3. 永不比较 - 总是认为不同</span>
<span class="hljs-keyword">val</span> state = mutableStateOf(<span class="hljs-number">0</span>, policy = neverEqualPolicy())
state.value = <span class="hljs-number">0</span>  <span class="hljs-comment">// 会触发重组</span>
</code></pre>
<h3 data-id="heading-25">2.3 rememberSaveable 的原理</h3>
<p><code>rememberSaveable</code> 可以在<strong>配置变更</strong>（如屏幕旋转）后恢复状态。</p>
<h4 data-id="heading-26">2.3.1 为什么需要 rememberSaveable？</h4>
<p>看一个场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FormScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    <span class="hljs-keyword">var</span> email <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    <span class="hljs-comment">// 用户填写了表单...</span>
    
    <span class="hljs-comment">// 旋转屏幕后，name 和 email 都变成空字符串了！</span>
    <span class="hljs-comment">// 因为 Activity 重建，remember 的缓存丢失了</span>
}
</code></pre>
<p><strong>rememberSaveable 的作用</strong>：将状态保存到 Bundle，配置变更后自动恢复。</p>
<h4 data-id="heading-27">2.3.2 实现原理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> <span class="hljs-title">rememberSaveable</span><span class="hljs-params">(
    <span class="hljs-keyword">vararg</span> inputs: <span class="hljs-type">Any</span>?,
    saver: <span class="hljs-type">Saver</span>&lt;<span class="hljs-type">T</span>, <span class="hljs-keyword">out</span> Any&gt; = autoSaver()</span></span>,
    key: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">init</span>: () -&gt; T
): T {
    <span class="hljs-comment">// 组合本地提供的 SaveableStateRegistry</span>
    <span class="hljs-keyword">val</span> registry = LocalSaveableStateRegistry.current
    
    <span class="hljs-comment">// 生成唯一 key</span>
    <span class="hljs-keyword">val</span> finalKey = key ?: rememberSaveableKey()
    
    <span class="hljs-comment">// 尝试从 Bundle 恢复</span>
    <span class="hljs-keyword">val</span> restored = registry?.consumeRestored(finalKey)
    
    <span class="hljs-comment">// 创建或恢复状态</span>
    <span class="hljs-keyword">val</span> value = remember(*inputs) {
        restored?.let { saver.restore(it) } ?: <span class="hljs-keyword">init</span>()
    }
    
    <span class="hljs-comment">// 注册保存回调</span>
    <span class="hljs-keyword">if</span> (registry != <span class="hljs-literal">null</span>) {
        DisposableEffect(registry, finalKey, saver) {
            <span class="hljs-keyword">val</span> entry = registry.registerProvider(finalKey) {
                saver.save(value)
            }
            onDispose { entry.unregister() }
        }
    }
    
    <span class="hljs-keyword">return</span> value
}
</code></pre>
<p><strong>保存与恢复流程</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                  rememberSaveable 流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   首次创建                                                       │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. 检查 Bundle 中没有该 key 的保存值                     │  │
│   │ <span class="hljs-number">2</span>. 执行 <span class="hljs-built_in">init</span>() 创建初始值                               │  │
│   │ <span class="hljs-number">3</span>. 注册保存回调到 SaveableStateRegistry                 │  │
│   │ <span class="hljs-number">4</span>. 返回初始值                                           │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   配置变更（如旋转屏幕）                                         │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. Activity 被销毁，触发 onSaveInstanceState            │  │
│   │ <span class="hljs-number">2</span>. SaveableStateRegistry 调用所有注册的保存回调          │  │
│   │ <span class="hljs-number">3</span>. 将值序列化保存到 Bundle                               │  │
│   │ <span class="hljs-number">4</span>. Activity 重建                                         │  │
│   │ <span class="hljs-number">5</span>. 从 Bundle 恢复值                                      │  │
│   │ <span class="hljs-number">6</span>. rememberSaveable 读取恢复的值                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-28">2.3.3 自定义 Saver</h4>
<p><strong>什么是 Saver？</strong></p>
<p>Saver 是 rememberSaveable 用来<strong>序列化和反序列化状态</strong>的工具。因为 Bundle 只能存储特定类型的数据，我们需要告诉 Compose 如何将自定义对象转换为 Bundle 可存储的格式。</p>
<p><strong>为什么需要自定义 Saver？</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 假设我们有一个自定义类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String
)

<span class="hljs-comment">// ❌ 错误：直接 rememberSaveable 会崩溃</span>
<span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> rememberSaveable { mutableStateOf(User(<span class="hljs-number">1</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"zhangsan@example.com"</span>)) }
<span class="hljs-comment">// 崩溃原因：User 类不知道如何保存到 Bundle</span>
</code></pre>
<p><strong>自定义 Saver 示例</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为自定义类创建 Saver</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> email: String)

<span class="hljs-keyword">val</span> UserSaver = Saver&lt;User, Bundle&gt;(
    <span class="hljs-comment">// save: 将 User 转换为 Bundle</span>
    save = { user -&gt;
        Bundle().apply {
            putInt(<span class="hljs-string">"id"</span>, user.id)
            putString(<span class="hljs-string">"name"</span>, user.name)
            putString(<span class="hljs-string">"email"</span>, user.email)
        }
    },
    <span class="hljs-comment">// restore: 从 Bundle 恢复 User</span>
    restore = { bundle -&gt;
        User(
            id = bundle.getInt(<span class="hljs-string">"id"</span>),
            name = bundle.getString(<span class="hljs-string">"name"</span>) ?: <span class="hljs-string">""</span>,
            email = bundle.getString(<span class="hljs-string">"email"</span>) ?: <span class="hljs-string">""</span>
        )
    }
)

<span class="hljs-comment">// 使用自定义 Saver</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> rememberSaveable(saver = UserSaver) {
        mutableStateOf(User(<span class="hljs-number">1</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"zhangsan@example.com"</span>))
    }
    
    <span class="hljs-comment">// 现在旋转屏幕后，user 的值会被正确恢复</span>
    Text(<span class="hljs-string">"Name: <span class="hljs-subst">${user.name}</span>"</span>)
}
</code></pre>
<p><strong>Saver 生效机制</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                    Saver 生效流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  保存时                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. rememberSaveable 检测到配置变更                       │   │
│  │ <span class="hljs-number">2</span>. 调用 Saver<span class="hljs-selector-class">.save</span>(value)                                │   │
│  │ <span class="hljs-number">3</span>. 返回 Bundle/Parcelable/List 等可序列化类型            │   │
│  │ <span class="hljs-number">4</span>. 系统自动保存到 Activity 的 Bundle                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  恢复时                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. Activity 重建，从 Bundle 读取保存的数据               │   │
│  │ <span class="hljs-number">2</span>. rememberSaveable 调用 Saver<span class="hljs-selector-class">.restore</span>(savedData)        │   │
│  │ <span class="hljs-number">3</span>. 返回恢复后的对象                                        │   │
│  │ <span class="hljs-number">4</span>. 赋值给状态变量                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>适合使用自定义 Saver 的场景</strong>：</p>
<ol>
<li><strong>表单数据</strong>：用户填写的表单，旋转屏幕后需要保留</li>
<li><strong>滚动位置</strong>：列表的滚动位置</li>
<li><strong>用户偏好</strong>：当前选中的选项、开关状态</li>
<li><strong>临时数据</strong>：未提交的编辑内容</li>
</ol>
<p><strong>不适合使用 Saver 的场景</strong>：</p>
<ol>
<li><strong>大量数据</strong>：Bundle 有大小限制（约 1MB）</li>
<li><strong>敏感数据</strong>：Bundle 数据可以被读取</li>
<li><strong>不需要持久化的数据</strong>：如网络请求结果</li>
</ol>
<hr/>
<h2 data-id="heading-29">三、状态提升（State Hoisting）设计模式</h2>
<h3 data-id="heading-30">3.1 什么是状态提升？</h3>
<p><strong>状态提升</strong>是 Compose 推荐的状态管理模式：将状态从子组件"提升"到父组件，子组件通过参数接收状态，通过回调通知状态变化。</p>
<p><strong>为什么叫"提升"？</strong></p>
<p>想象一个组件树：</p>
<pre><code class="hljs">Parent
├── ChildA
│   └── GrandChild
└── ChildB
</code></pre>
<p>如果 <code>GrandChild</code> 需要修改状态，而这个状态需要影响 <code>ChildB</code>，那么状态就需要"提升"到它们的共同祖先 <code>Parent</code>。</p>
<h3 data-id="heading-31">3.2 状态提升的设计原则</h3>
<p><strong>单一数据源</strong>：状态只在一个地方定义
<strong>状态向下流动</strong>：通过参数传递给子组件
<strong>事件向上传递</strong>：通过回调通知父组件修改状态</p>
<h3 data-id="heading-32">3.3 状态提升的示例</h3>
<h4 data-id="heading-33">3.3.1 无状态提升（问题代码）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：状态分散在各个组件中</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CounterScreen</span><span class="hljs-params">()</span></span> {
    Column {
        Counter()  <span class="hljs-comment">// 每个 Counter 有自己的状态</span>
        Counter()
        Counter()
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }  <span class="hljs-comment">// 状态在子组件中</span>
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>无法同步多个 Counter 的状态</li>
<li>父组件无法获取/修改子组件的状态</li>
<li>状态分散，难以管理</li>
</ul>
<h4 data-id="heading-34">3.3.2 有状态提升（正确代码）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：状态提升到父组件</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CounterScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> counts <span class="hljs-keyword">by</span> remember { mutableStateOf(List(<span class="hljs-number">3</span>) { <span class="hljs-number">0</span> }) }
    
    Column {
        counts.forEachIndexed { index, count -&gt;
            Counter(
                count = count,
                onIncrement = {
                    counts = counts.toMutableList().apply {
                        <span class="hljs-keyword">this</span>[index]++
                    }
                }
            )
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">(
    count: <span class="hljs-type">Int</span>,                    <span class="hljs-comment">// 状态通过参数传入</span>
    onIncrement: () -&gt; <span class="hljs-type">Unit</span>        <span class="hljs-comment">// 事件通过回调传出</span>
)</span></span> {
    Button(onClick = onIncrement) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>状态集中管理</li>
<li>子组件可复用</li>
<li>易于测试</li>
</ul>
<h3 data-id="heading-35">3.4 状态提升的设计模式</h3>
<h4 data-id="heading-36">3.4.1 状态容器模式</h4>
<p>对于复杂的状态，可以创建专门的状态容器类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 状态容器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterState</span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> mutableStateOf(<span class="hljs-number">0</span>)
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        count++
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">decrement</span><span class="hljs-params">()</span></span> {
        count--
    }
}

<span class="hljs-comment">// 使用 remember 创建状态容器</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberCounterState</span><span class="hljs-params">()</span></span> = remember { CounterState() }

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CounterScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> state = rememberCounterState()
    
    Counter(
        count = state.count,
        onIncrement = { state.increment() }
    )
}
</code></pre>
<h4 data-id="heading-37">3.4.2 屏幕级状态管理</h4>
<p>对于整个屏幕的状态，可以在屏幕级 Composable 中统一管理：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfileScreen</span><span class="hljs-params">(
    userId: <span class="hljs-type">String</span>,
    viewModel: <span class="hljs-type">UserProfileViewModel</span> = hiltViewModel()</span></span>
) {
    <span class="hljs-comment">// 收集 ViewModel 的状态</span>
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> viewModel.uiState.collectAsState()
    
    <span class="hljs-comment">// 屏幕级状态管理</span>
    <span class="hljs-keyword">var</span> isEditing <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    <span class="hljs-keyword">var</span> editedName <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    <span class="hljs-keyword">when</span> (<span class="hljs-keyword">val</span> state = uiState) {
        <span class="hljs-keyword">is</span> UiState.Loading -&gt; LoadingScreen()
        <span class="hljs-keyword">is</span> UiState.Error -&gt; ErrorScreen(state.message)
        <span class="hljs-keyword">is</span> UiState.Success -&gt; {
            UserProfileContent(
                user = state.<span class="hljs-keyword">data</span>,
                isEditing = isEditing,
                editedName = editedName,
                onEditClick = { 
                    isEditing = <span class="hljs-literal">true</span>
                    editedName = state.<span class="hljs-keyword">data</span>.name
                },
                onNameChange = { editedName = it },
                onSaveClick = {
                    viewModel.updateName(editedName)
                    isEditing = <span class="hljs-literal">false</span>
                }
            )
        }
    }
}
</code></pre>
<h3 data-id="heading-38">3.5 状态提升的边界</h3>
<p>不是所有状态都需要提升，需要根据场景判断：</p>





















<table><thead><tr><th>状态位置</th><th>适用场景</th></tr></thead><tbody><tr><td>子组件内部</td><td>纯 UI 状态（如动画状态、滚动位置）</td></tr><tr><td>父组件</td><td>需要共享的状态、需要持久化的状态</td></tr><tr><td>ViewModel</td><td>业务逻辑状态、需要跨屏幕共享的状态</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-39">四、ViewModel 与 Compose 最佳实践</h2>
<h3 data-id="heading-40">4.1 ViewModel 的作用</h3>
<p>ViewModel 是 Android 架构组件，用于：</p>
<ul>
<li><strong>保存配置变更后的状态</strong></li>
<li><strong>管理业务逻辑</strong></li>
<li><strong>作为 UI 层和数据层的桥梁</strong></li>
</ul>
<h3 data-id="heading-41">4.2 ViewModel 与 Compose 的集成</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ViewModel 定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userRepository: UserRepository
) : ViewModel() {
    
    <span class="hljs-comment">// 使用 StateFlow 管理状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow&lt;UiState&lt;User&gt;&gt;(UiState.Loading)
    <span class="hljs-keyword">val</span> uiState: StateFlow&lt;UiState&lt;User&gt;&gt; = _uiState.asStateFlow()
    
    <span class="hljs-keyword">init</span> {
        loadUser()
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            _uiState.value = UiState.Loading
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> user = userRepository.getUser()
                _uiState.value = UiState.Success(user)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _uiState.value = UiState.Error(e.message ?: <span class="hljs-string">"Unknown error"</span>)
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span></span> {
        loadUser()
    }
}

<span class="hljs-comment">// Composable 中使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserScreen</span><span class="hljs-params">(
    viewModel: <span class="hljs-type">UserViewModel</span> = hiltViewModel()</span></span>
) {
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> viewModel.uiState.collectAsState()
    
    <span class="hljs-keyword">when</span> (<span class="hljs-keyword">val</span> state = uiState) {
        <span class="hljs-keyword">is</span> UiState.Loading -&gt; LoadingScreen()
        <span class="hljs-keyword">is</span> UiState.Error -&gt; ErrorScreen(
            message = state.message,
            onRetry = { viewModel.refresh() }
        )
        <span class="hljs-keyword">is</span> UiState.Success -&gt; UserContent(user = state.<span class="hljs-keyword">data</span>)
    }
}
</code></pre>
<h3 data-id="heading-42">4.3 StateFlow vs LiveData</h3>
<p>在 Compose 中，推荐使用 <strong>StateFlow</strong>：</p>






























<table><thead><tr><th>特性</th><th>StateFlow</th><th>LiveData</th></tr></thead><tbody><tr><td>生命周期感知</td><td>需要配合 <code>collectAsState</code></td><td>自动感知</td></tr><tr><td>初始值</td><td>必须有</td><td>可以没有</td></tr><tr><td>线程安全</td><td>是</td><td>是</td></tr><tr><td>与 Compose 集成</td><td>更自然</td><td>需要额外转换</td></tr></tbody></table>
<h3 data-id="heading-43">4.4 UI 状态设计最佳实践</h3>
<h4 data-id="heading-44">4.4.1 单一状态类</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 推荐：使用单一状态类</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserUiState</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : UserUiState
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> user: User) : UserUiState
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : UserUiState
}

<span class="hljs-comment">// ❌ 不推荐：分散的状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">val</span> isLoading = MutableStateFlow(<span class="hljs-literal">false</span>)
    <span class="hljs-keyword">val</span> user = MutableStateFlow&lt;User?&gt;(<span class="hljs-literal">null</span>)
    <span class="hljs-keyword">val</span> error = MutableStateFlow&lt;String?&gt;(<span class="hljs-literal">null</span>)
}
</code></pre>
<h4 data-id="heading-45">4.4.2 不可变状态</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 推荐：状态不可变，通过 copy 更新</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserUiState</span>(
    <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">val</span> user: User? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>
)

<span class="hljs-comment">// ViewModel 中</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow(UserUiState())
<span class="hljs-keyword">val</span> uiState = _uiState.asStateFlow()

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    _uiState.update { it.copy(user = user, isLoading = <span class="hljs-literal">false</span>) }
}
</code></pre>
<h3 data-id="heading-46">4.5 ViewModel 的生命周期</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                    ViewModel 生命周期                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Activity/Fragment 创建                                        │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. ViewModel 创建                                       │  │
│   │ <span class="hljs-number">2</span>. 执行 init 块                                         │  │
│   │ <span class="hljs-number">3</span>. 开始收集数据                                          │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   配置变更（旋转屏幕）                                           │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. Activity 销毁                                        │  │
│   │ <span class="hljs-number">2</span>. ViewModel 保留（不销毁）                              │  │
│   │ <span class="hljs-number">3</span>. 新的 Activity 创建                                    │  │
│   │ <span class="hljs-number">4</span>. 获取相同的 ViewModel 实例                             │  │
│   │ <span class="hljs-number">5</span>. 状态保持不变                                          │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   Activity/Fragment 真正销毁                                     │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. <span class="hljs-built_in">onCleared</span>() 被调用                                    │  │
│   │ <span class="hljs-number">2</span>. ViewModel 销毁                                        │  │
│   │ <span class="hljs-number">3</span>. 协程作用域取消                                        │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-47">五、CompositionLocal 深度解析</h2>
<h3 data-id="heading-48">5.1 什么是 CompositionLocal？</h3>
<p><strong>CompositionLocal</strong> 是一种<strong>隐式传参</strong>机制，允许在 Composable 树中向下传递数据，而不需要通过每一层的参数。</p>
<p><strong>为什么需要 CompositionLocal？</strong></p>
<p>想象这样一个场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不使用 CompositionLocal - 需要层层传递</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">App</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"admin"</span>)
    ScreenA(user = user)
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ScreenA</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Header(user = user)
    Content(user = user)
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Header</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Avatar(user = user)
    UserName(user = user)
}

<span class="hljs-comment">// 每一层都需要传递 user 参数，即使中间层不使用它</span>
</code></pre>
<p>使用 CompositionLocal：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 CompositionLocal - 隐式传递</span>
<span class="hljs-keyword">val</span> LocalUser = compositionLocalOf&lt;User&gt; { error(<span class="hljs-string">"No user provided"</span>) }

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">App</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"admin"</span>)
    CompositionLocalProvider(LocalUser provides user) {
        ScreenA()  <span class="hljs-comment">// 不需要传递 user</span>
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ScreenA</span><span class="hljs-params">()</span></span> {
    Header()   <span class="hljs-comment">// 不需要传递 user</span>
    Content()  <span class="hljs-comment">// 不需要传递 user</span>
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Header</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = LocalUser.current  <span class="hljs-comment">// 在需要的地方获取</span>
    Avatar(user = user)
    UserName(user = user)
}
</code></pre>
<h3 data-id="heading-49">5.2 CompositionLocal 的原理</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                  CompositionLocal 原理                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Composable 树                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-built_in">CompositionLocalProvider</span>(LocalColor provides Color.Red) │  │
│   │ ┌─────────────────────────────────────────────────────┐ │  │
│   │ │  <span class="hljs-built_in">Child1</span>()                                          │ │  │
│   │ │   ┌─────────────────────────────────────────────┐  │ │  │
│   │ │   │  <span class="hljs-built_in">Child2</span>()                                  │  │ │  │
│   │ │   │   ┌─────────────────────────────────────┐  │  │ │  │
│   │ │   │   │  LocalColor<span class="hljs-selector-class">.current</span>  <span class="hljs-comment">// 返回 Red   │  │  │ │  │</span>
│   │ │   │   └─────────────────────────────────────┘  │  │ │  │
│   │ │   └─────────────────────────────────────────────┘  │ │  │
│   │ └─────────────────────────────────────────────────────┘ │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   查找规则：                                                      │
│   <span class="hljs-number">1</span>. 从当前节点向上查找                                           │
│   <span class="hljs-number">2</span>. 找到最近的 CompositionLocalProvider                          │
│   <span class="hljs-number">3</span>. 返回对应的值                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-50">5.3 创建与使用 CompositionLocal</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 创建 CompositionLocal</span>
<span class="hljs-keyword">val</span> LocalUser = compositionLocalOf&lt;User&gt; { error(<span class="hljs-string">"No user provided"</span>) }

<span class="hljs-comment">// 2. 提供值</span>
CompositionLocalProvider(LocalUser provides currentUser) {
    UserProfile()  <span class="hljs-comment">// 及其子组件都可以通过 LocalUser.current 获取</span>
}

<span class="hljs-comment">// 3. 使用值</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = LocalUser.current
    Text(<span class="hljs-string">"Hello, <span class="hljs-subst">${user.name}</span>"</span>)
}
</code></pre>
<h3 data-id="heading-51">5.4 compositionLocalOf vs staticCompositionLocalOf</h3>




















<table><thead><tr><th>函数</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><code>compositionLocalOf</code></td><td>值变化时，只重组读取该值的组件</td><td>频繁变化的值</td></tr><tr><td><code>staticCompositionLocalOf</code></td><td>值变化时，重组整个子树</td><td>很少变化的值</td></tr></tbody></table>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 主题颜色 - 很少变化</span>
<span class="hljs-keyword">val</span> LocalColors = staticCompositionLocalOf { LightColorScheme }

<span class="hljs-comment">// 滚动状态 - 频繁变化</span>
<span class="hljs-keyword">val</span> LocalScrollState = compositionLocalOf { ScrollState(<span class="hljs-number">0</span>) }
</code></pre>
<h3 data-id="heading-52">5.5 MaterialTheme 的实现</h3>
<p>MaterialTheme 就是基于 CompositionLocal 实现的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MaterialTheme</span><span class="hljs-params">(
    colorScheme: <span class="hljs-type">ColorScheme</span> = MaterialTheme.colorScheme,
    typography: <span class="hljs-type">Typography</span> = MaterialTheme.typography,
    shapes: <span class="hljs-type">Shapes</span> = MaterialTheme.shapes,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">val</span> rememberedColorScheme = remember { colorScheme }
    <span class="hljs-keyword">val</span> rememberedTypography = remember { typography }
    <span class="hljs-keyword">val</span> rememberedShapes = remember { shapes }
    
    CompositionLocalProvider(
        LocalColorScheme provides rememberedColorScheme,
        LocalTypography provides rememberedTypography,
        LocalShapes provides rememberedShapes
    ) {
        content()
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyComponent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> colorScheme = MaterialTheme.colorScheme
    <span class="hljs-keyword">val</span> typography = MaterialTheme.typography
    
    Text(
        text = <span class="hljs-string">"Hello"</span>,
        color = colorScheme.primary,
        style = typography.bodyLarge
    )
}
</code></pre>
<h3 data-id="heading-53">5.6 CompositionLocal 的最佳实践</h3>
<h4 data-id="heading-54">✅ 推荐使用</h4>
<ul>
<li>主题配置（颜色、字体、形状）</li>
<li>上下文信息（屏幕类型、权限状态）</li>
<li>全局服务（Navigator、Analytics）</li>
</ul>
<h4 data-id="heading-55">❌ 避免使用</h4>
<ul>
<li>频繁变化的数据（使用参数传递）</li>
<li>业务逻辑状态（使用 ViewModel）</li>
<li>可能导致隐式依赖，降低代码可读性</li>
</ul>
<hr/>
<h2 data-id="heading-56">六、副作用 API 详解</h2>
<h3 data-id="heading-57">6.1 什么是副作用？</h3>
<p><strong>副作用</strong>是指 Composable 函数对外部世界的影响，如：</p>
<ul>
<li>网络请求</li>
<li>数据库操作</li>
<li>订阅事件</li>
<li>修改共享状态</li>
</ul>
<p>Compose 是纯函数式的，Composable 不应该有副作用。但应用开发离不开副作用，因此 Compose 提供了专门的 API 来处理副作用。</p>
<h3 data-id="heading-58">6.2 LaunchedEffect：在组合中启动协程</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;User?&gt;(<span class="hljs-literal">null</span>) }
    
    <span class="hljs-comment">// 在组合时启动协程</span>
    LaunchedEffect(userId) {
        <span class="hljs-comment">// 这里的代码在协程中执行</span>
        user = api.getUser(userId)
    }
    
    user?.let {
        Text(<span class="hljs-string">"Name: <span class="hljs-subst">${it.name}</span>"</span>)
    }
}
</code></pre>
<p><strong>LaunchedEffect 的特点</strong>：</p>
<ul>
<li>在组合时启动协程</li>
<li>key 变化时，取消旧协程，启动新协程</li>
<li>重组时不会重新启动</li>
</ul>
<pre><code class="hljs language-vbnet" lang="vbnet">┌─────────────────────────────────────────────────────────────────┐
│                   LaunchedEffect 生命周期                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   首次组合                                                       │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. LaunchedEffect 进入组合                              │  │
│   │ <span class="hljs-number">2</span>. 启动协程，执行副作用代码                              │  │
│   │ <span class="hljs-number">3</span>. 协程持续运行...                                       │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   重组（<span class="hljs-keyword">key</span> 未变化）                                             │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. LaunchedEffect 重组                                  │  │
│   │ <span class="hljs-number">2</span>. <span class="hljs-keyword">key</span> 相同，协程继续运行                                │  │
│   │ <span class="hljs-number">3</span>. 不执行副作用代码                                      │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   重组（<span class="hljs-keyword">key</span> 变化）                                               │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. 取消旧协程                                           │  │
│   │ <span class="hljs-number">2</span>. 启动新协程                                           │  │
│   │ <span class="hljs-number">3</span>. 执行新的副作用代码                                    │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   退出组合                                                       │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. LaunchedEffect 退出组合                              │  │
│   │ <span class="hljs-number">2</span>. 取消协程                                             │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-59">6.3 SideEffect：每次重组都执行</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AnalyticsScreen</span><span class="hljs-params">(screenName: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 每次重组都执行</span>
    SideEffect {
        analytics.logScreenView(screenName)
    }
    
    <span class="hljs-comment">// UI 内容</span>
    Text(<span class="hljs-string">"Screen: <span class="hljs-variable">$screenName</span>"</span>)
}
</code></pre>
<p><strong>使用场景</strong>：需要确保副作用在每次成功重组后都执行。</p>
<h3 data-id="heading-60">6.4 DisposableEffect：需要清理的副作用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BackHandler</span><span class="hljs-params">(onBack: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> dispatcher = LocalOnBackPressedDispatcherOwner.current?.onBackPressedDispatcher
    
    DisposableEffect(dispatcher) {
        <span class="hljs-comment">// 设置回调</span>
        <span class="hljs-keyword">val</span> callback = <span class="hljs-keyword">object</span> : OnBackPressedCallback(<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOnBackPressed</span><span class="hljs-params">()</span></span> {
                onBack()
            }
        }
        dispatcher?.addCallback(callback)
        
        <span class="hljs-comment">// 返回清理函数</span>
        onDispose {
            callback.remove()
        }
    }
}
</code></pre>
<p><strong>DisposableEffect 的特点</strong>：</p>
<ul>
<li>key 变化时，先执行 onDispose，再执行新的副作用</li>
<li>退出组合时，执行 onDispose</li>
</ul>
<h3 data-id="heading-61">6.5 rememberCoroutineScope：在回调中启动协程</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserList</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">var</span> users <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;List&lt;User&gt;&gt;(emptyList()) }
    
    Button(onClick = {
        <span class="hljs-comment">// 在回调中启动协程</span>
        scope.launch {
            users = api.getUsers()
        }
    }) {
        Text(<span class="hljs-string">"Load Users"</span>)
    }
    
    <span class="hljs-comment">// 显示用户列表</span>
    LazyColumn {
        items(users) { user -&gt;
            Text(user.name)
        }
    }
}
</code></pre>
<p><strong>与 LaunchedEffect 的区别</strong>：</p>
<ul>
<li><code>LaunchedEffect</code>：在组合时自动启动</li>
<li><code>rememberCoroutineScope</code>：提供 CoroutineScope，在回调中手动启动</li>
</ul>
<h3 data-id="heading-62">6.6 rememberUpdatedState：获取最新值</h3>
<p>当需要在长时间运行的副作用中获取最新状态时，使用 <code>rememberUpdatedState</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Timer</span><span class="hljs-params">(
    onTick: () -&gt; <span class="hljs-type">Unit</span>,
    interval: <span class="hljs-type">Long</span> = <span class="hljs-number">1000</span>L
)</span></span> {
    <span class="hljs-comment">// 使用 rememberUpdatedState 获取最新的 onTick</span>
    <span class="hljs-keyword">val</span> currentOnTick <span class="hljs-keyword">by</span> rememberUpdatedState(onTick)
    
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            delay(interval)
            currentOnTick()  <span class="hljs-comment">// 总是调用最新的 onTick</span>
        }
    }
}
</code></pre>
<p><strong>为什么需要 rememberUpdatedState？</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：LaunchedEffect 捕获的是旧的 onTick</span>
LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        delay(<span class="hljs-number">1000</span>)
        onTick()  <span class="hljs-comment">// 总是调用第一次传入的 onTick</span>
    }
}

<span class="hljs-comment">// ✅ 正确：使用 rememberUpdatedState</span>
<span class="hljs-keyword">val</span> currentOnTick <span class="hljs-keyword">by</span> rememberUpdatedState(onTick)
LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        delay(<span class="hljs-number">1000</span>)
        currentOnTick()  <span class="hljs-comment">// 总是调用最新的 onTick</span>
    }
}
</code></pre>
<h3 data-id="heading-63">6.7 DerivedState：派生状态</h3>
<p>当需要基于其他状态计算派生状态时，使用 <code>derivedStateOf</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchResults</span><span class="hljs-params">(query: <span class="hljs-type">String</span>, items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Item</span>&gt;)</span></span> {
    <span class="hljs-comment">// 只在必要时重新计算</span>
    <span class="hljs-keyword">val</span> filteredItems <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            items.filter { it.name.contains(query, ignoreCase = <span class="hljs-literal">true</span>) }
        }
    }
    
    LazyColumn {
        items(filteredItems) { item -&gt;
            ItemRow(item)
        }
    }
}
</code></pre>
<p><strong>derivedStateOf vs remember</strong>：</p>




















<table><thead><tr><th>特性</th><th>derivedStateOf</th><th>remember</th></tr></thead><tbody><tr><td>触发条件</td><td>读取时</td><td>依赖变化时</td></tr><tr><td>适用场景</td><td>频繁读取、计算成本高</td><td>一次性计算</td></tr></tbody></table>
<h3 data-id="heading-64">6.8 produceState：将非 Compose 状态转换为 State</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: State&lt;User?&gt; {
    <span class="hljs-keyword">return</span> produceState&lt;User?&gt;(initialValue = <span class="hljs-literal">null</span>, userId) {
        value = api.getUser(userId)
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> user <span class="hljs-keyword">by</span> loadUser(userId)
    
    user?.let {
        Text(<span class="hljs-string">"Name: <span class="hljs-subst">${it.name}</span>"</span>)
    }
}
</code></pre>
<h3 data-id="heading-65">6.9 snapshotFlow：将 State 转换为 Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> query <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    <span class="hljs-comment">// 将 State 转换为 Flow</span>
    <span class="hljs-keyword">val</span> searchResults <span class="hljs-keyword">by</span> remember {
        snapshotFlow { query }
            .debounce(<span class="hljs-number">300</span>)  <span class="hljs-comment">// 防抖</span>
            .flatMapLatest { api.search(it) }
            .collectAsState(initial = emptyList())
    }
    
    Column {
        TextField(
            value = query,
            onValueChange = { query = it }
        )
        
        LazyColumn {
            items(searchResults) { result -&gt;
                Text(result.name)
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-66">七、状态管理架构设计</h2>
<h3 data-id="heading-67">7.1 分层架构</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                      UI Layer (Composable)                      │
│  - 显示数据                                                      │
│  - 处理用户交互                                                  │
│  - 调用 ViewModel 方法                                           │
├─────────────────────────────────────────────────────────────────┤
│                   ViewModel Layer                               │
│  - 管理 UI 状态                                                  │
│  - 处理业务逻辑                                                  │
│  - 调用 Repository 方法                                          │
├─────────────────────────────────────────────────────────────────┤
│                  Repository Layer                               │
│  - 数据聚合                                                      │
│  - 业务规则                                                      │
│  - 选择数据源                                                    │
├─────────────────────────────────────────────────────────────────┤
│                   Data Source Layer                             │
│  - 网络 API (Retrofit)                                          │
│  - 本地数据库 (Room)                                            │
│  - 本地缓存 (DataStore)                                         │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-68">7.2 完整实战：用户列表页面</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ============ Data Layer ============</span>

<span class="hljs-comment">// 数据模型</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String,
    <span class="hljs-keyword">val</span> avatar: String
)

<span class="hljs-comment">// Repository</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUsers</span><span class="hljs-params">()</span></span>: List&lt;User&gt;
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">searchUsers</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span>: List&lt;User&gt;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepositoryImpl</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> api: UserApi
) : UserRepository {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUsers</span><span class="hljs-params">()</span></span>: List&lt;User&gt; = api.getUsers()
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">searchUsers</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span>: List&lt;User&gt; = api.searchUsers(query)
}

<span class="hljs-comment">// ============ ViewModel Layer ============</span>

<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UsersUiState</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : UsersUiState
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> users: List&lt;User&gt;) : UsersUiState
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : UsersUiState
}

<span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UsersViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository
) : ViewModel() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow&lt;UsersUiState&gt;(UsersUiState.Loading)
    <span class="hljs-keyword">val</span> uiState: StateFlow&lt;UsersUiState&gt; = _uiState.asStateFlow()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _searchQuery = MutableStateFlow(<span class="hljs-string">""</span>)
    <span class="hljs-keyword">val</span> searchQuery: StateFlow&lt;String&gt; = _searchQuery.asStateFlow()
    
    <span class="hljs-comment">// 搜索结果的派生状态</span>
    <span class="hljs-keyword">val</span> searchResults: StateFlow&lt;UsersUiState&gt; = _searchQuery
        .debounce(<span class="hljs-number">300</span>)
        .flatMapLatest { query -&gt;
            <span class="hljs-keyword">if</span> (query.isEmpty()) {
                flowOf(UsersUiState.Success(emptyList()))
            } <span class="hljs-keyword">else</span> {
                flow {
                    emit(UsersUiState.Loading)
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">val</span> users = repository.searchUsers(query)
                        emit(UsersUiState.Success(users))
                    } <span class="hljs-keyword">catch</span> (e: Exception) {
                        emit(UsersUiState.Error(e.message ?: <span class="hljs-string">"Unknown error"</span>))
                    }
                }
            }
        }
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
            initialValue = UsersUiState.Success(emptyList())
        )
    
    <span class="hljs-keyword">init</span> {
        loadUsers()
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUsers</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            _uiState.value = UsersUiState.Loading
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> users = repository.getUsers()
                _uiState.value = UsersUiState.Success(users)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _uiState.value = UsersUiState.Error(e.message ?: <span class="hljs-string">"Unknown error"</span>)
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSearchQueryChange</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        _searchQuery.value = query
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span></span> {
        loadUsers()
    }
}

<span class="hljs-comment">// ============ UI Layer ============</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UsersScreen</span><span class="hljs-params">(
    viewModel: <span class="hljs-type">UsersViewModel</span> = hiltViewModel()</span></span>
) {
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> viewModel.uiState.collectAsState()
    <span class="hljs-keyword">val</span> searchQuery <span class="hljs-keyword">by</span> viewModel.searchQuery.collectAsState()
    <span class="hljs-keyword">val</span> searchResults <span class="hljs-keyword">by</span> viewModel.searchResults.collectAsState()
    
    <span class="hljs-keyword">val</span> isSearching = searchQuery.isNotEmpty()
    <span class="hljs-keyword">val</span> currentState = <span class="hljs-keyword">if</span> (isSearching) searchResults <span class="hljs-keyword">else</span> uiState
    
    UsersContent(
        uiState = currentState,
        searchQuery = searchQuery,
        onSearchQueryChange = viewModel::onSearchQueryChange,
        onRefresh = viewModel::refresh
    )
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UsersContent</span><span class="hljs-params">(
    uiState: <span class="hljs-type">UsersUiState</span>,
    searchQuery: <span class="hljs-type">String</span>,
    onSearchQueryChange: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>,
    onRefresh: () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Column(modifier = Modifier.fillMaxSize()) {
        <span class="hljs-comment">// 搜索框</span>
        SearchBar(
            query = searchQuery,
            onQueryChange = onSearchQueryChange
        )
        
        <span class="hljs-comment">// 内容区域</span>
        <span class="hljs-keyword">when</span> (<span class="hljs-keyword">val</span> state = uiState) {
            <span class="hljs-keyword">is</span> UsersUiState.Loading -&gt; LoadingScreen()
            <span class="hljs-keyword">is</span> UsersUiState.Error -&gt; ErrorScreen(
                message = state.message,
                onRetry = onRefresh
            )
            <span class="hljs-keyword">is</span> UsersUiState.Success -&gt; {
                <span class="hljs-keyword">if</span> (state.users.isEmpty()) {
                    EmptyScreen()
                } <span class="hljs-keyword">else</span> {
                    UserList(users = state.users)
                }
            }
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserList</span><span class="hljs-params">(users: <span class="hljs-type">List</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> {
    LazyColumn {
        items(users, key = { it.id }) { user -&gt;
            UserItem(user = user)
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserItem</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = <span class="hljs-number">16.</span>dp, vertical = <span class="hljs-number">8.</span>dp)
    ) {
        Row(
            modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            AsyncImage(
                model = user.avatar,
                contentDescription = <span class="hljs-literal">null</span>,
                modifier = Modifier
                    .size(<span class="hljs-number">48.</span>dp)
                    .clip(CircleShape)
            )
            
            Spacer(modifier = Modifier.width(<span class="hljs-number">16.</span>dp))
            
            Column {
                Text(
                    text = user.name,
                    style = MaterialTheme.typography.titleMedium
                )
                Text(
                    text = user.email,
                    style = MaterialTheme.typography.bodyMedium,
                    color = Color.Gray
                )
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-69">八、本篇小结</h2>
<p>今天我们深入探讨了 Compose 的状态管理系统：</p>
<h3 data-id="heading-70">状态与重组机制</h3>
<ul>
<li>理解了 Slot Table 的数据结构和作用</li>
<li>掌握了重组的触发机制和优化策略</li>
<li>学会了使用 @Stable 和 @Immutable 控制重组</li>
</ul>
<h3 data-id="heading-71">remember 与 mutableStateOf</h3>
<ul>
<li>深入理解了 remember 的缓存原理</li>
<li>掌握了 mutableStateOf 的 Snapshot 机制</li>
<li>学会了 rememberSaveable 的保存与恢复</li>
</ul>
<h3 data-id="heading-72">状态提升</h3>
<ul>
<li>理解了状态提升的设计哲学</li>
<li>掌握了状态容器模式和屏幕级状态管理</li>
</ul>
<h3 data-id="heading-73">ViewModel 与 Compose</h3>
<ul>
<li>学会了 StateFlow 与 Compose 的集成</li>
<li>掌握了 UI 状态设计的最佳实践</li>
</ul>
<h3 data-id="heading-74">CompositionLocal</h3>
<ul>
<li>理解了隐式传参的原理</li>
<li>学会了创建和使用 CompositionLocal</li>
</ul>
<h3 data-id="heading-75">副作用 API</h3>
<ul>
<li>掌握了 LaunchedEffect、DisposableEffect 等副作用 API</li>
<li>理解了不同场景下的选择策略</li>
</ul>
<hr/>
<h2 data-id="heading-76">下篇预告</h2>
<p><strong>第四篇：Material 组件与主题</strong> 将深入讲解：</p>
<ul>
<li>Material Design 3 组件大全</li>
<li>自定义主题与颜色系统</li>
<li>深色模式与动态主题适配</li>
<li>自定义组件的设计思路</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-77">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate" target="_blank" title="https://developer.android.com/jetpack/compose/state" ref="nofollow noopener noreferrer">Compose 状态官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fside-effects" target="_blank" title="https://developer.android.com/jetpack/compose/side-effects" ref="nofollow noopener noreferrer">Compose 副作用官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fframeworks%2Fsupport%2F%2B%2Fandroidx-main%2Fcompose%2F" target="_blank" title="https://android.googlesource.com/platform/frameworks/support/+/androidx-main/compose/" ref="nofollow noopener noreferrer">Compose 源码</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose ✅</li>
<li>第二篇：核心基石 ✅</li>
<li>第三篇：状态管理（当前）✅</li>
<li>第四篇：Material 组件与主题</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言。</p>
<p><del>Generated by Kimi K2.5 Agent</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（71）如何在大数据环境中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600628279215046682</link>    <guid>https://juejin.cn/post/7600628279215046682</guid>    <pubDate>2026-01-29T11:53:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600628279215046682" data-draft-id="7600601482690543662" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（71）如何在大数据环境中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T11:53:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（71）如何在大数据环境中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T11:53:09.000Z" title="Thu Jan 29 2026 11:53:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大数据环境中使用Hibernate时，需要处理大量数据和复杂查询，确保性能和可扩展性。尽管Hibernate是一个功能强大的ORM框架，但在处理大规模数据时，可能需要采取一些策略，如批量处理、分页、缓存和分布式处理等。</p>
<p>下面是详细步骤和代码示例，展示如何在大数据环境中使用Hibernate。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- EHCache for Second Level Cache --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-ehcache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.32.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源和Hibernate属性</h3>
<p>在<code>application.properties</code>中配置数据源和Hibernate属性：</p>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect

# Enable Second Level Cache
spring.jpa.properties.hibernate.cache.use_second_level_cache=true
spring.jpa.properties.hibernate.cache.region.factory_class=org.hibernate.cache.ehcache.EhCacheRegionFactory
</code></pre>
<h3 data-id="heading-2">3. 配置EhCache</h3>
<p>在类路径下创建一个<code>ehcache.xml</code>文件来配置缓存。</p>
<h4 data-id="heading-3"><code>ehcache.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ehcache</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">defaultCache</span>
        <span class="hljs-attr">maxEntriesLocalHeap</span>=<span class="hljs-string">"10000"</span>
        <span class="hljs-attr">eternal</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">timeToIdleSeconds</span>=<span class="hljs-string">"120"</span>
        <span class="hljs-attr">timeToLiveSeconds</span>=<span class="hljs-string">"120"</span>
        <span class="hljs-attr">overflowToDisk</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">statistics</span>=<span class="hljs-string">"true"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.entity.BigDataEntity"</span>
        <span class="hljs-attr">maxEntriesLocalHeap</span>=<span class="hljs-string">"10000"</span>
        <span class="hljs-attr">eternal</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">timeToIdleSeconds</span>=<span class="hljs-string">"120"</span>
        <span class="hljs-attr">timeToLiveSeconds</span>=<span class="hljs-string">"120"</span>
        <span class="hljs-attr">overflowToDisk</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">statistics</span>=<span class="hljs-string">"true"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ehcache</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">4. 定义实体类和DAO层</h3>
<h4 data-id="heading-5"><code>BigDataEntity.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "big_data")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDataEntity</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String dataField;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDataField</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> dataField;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDataField</span><span class="hljs-params">(String dataField)</span> {
        <span class="hljs-built_in">this</span>.dataField = dataField;
    }
}
</code></pre>
<h4 data-id="heading-6"><code>BigDataRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BigDataRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;BigDataEntity, Long&gt; {
}
</code></pre>
<h3 data-id="heading-7">5. 批量处理和分页</h3>
<h4 data-id="heading-8"><code>BigDataService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Page;
<span class="hljs-keyword">import</span> org.springframework.data.domain.PageRequest;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Pageable;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDataService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BigDataRepository bigDataRepository;

    <span class="hljs-comment">// 批量插入数据</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveAll</span><span class="hljs-params">(List&lt;BigDataEntity&gt; entities)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; entities.size(); i += batchSize) {
            List&lt;BigDataEntity&gt; batchList = entities.subList(i, Math.min(i + batchSize, entities.size()));
            bigDataRepository.saveAll(batchList);
            bigDataRepository.flush();
        }
    }

    <span class="hljs-comment">// 分页查询大数据</span>
    <span class="hljs-keyword">public</span> Page&lt;BigDataEntity&gt; <span class="hljs-title function_">findPaginated</span><span class="hljs-params">(<span class="hljs-type">int</span> page, <span class="hljs-type">int</span> size)</span> {
        <span class="hljs-type">Pageable</span> <span class="hljs-variable">pageable</span> <span class="hljs-operator">=</span> PageRequest.of(page, size);
        <span class="hljs-keyword">return</span> bigDataRepository.findAll(pageable);
    }
}
</code></pre>
<h3 data-id="heading-9">6. 使用缓存</h3>
<h4 data-id="heading-10">在实体类上启用缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.annotations.Cache;
<span class="hljs-keyword">import</span> org.hibernate.annotations.CacheConcurrencyStrategy;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "big_data")</span>
<span class="hljs-meta">@Cache(usage = CacheConcurrencyStrategy.READ_WRITE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDataEntity</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String dataField;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<h3 data-id="heading-11">7. 使用服务层</h3>
<p>编写控制器来使用服务层进行批量处理和分页查询。</p>
<h4 data-id="heading-12"><code>BigDataController.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.data.domain.Page;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/bigdata")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDataController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BigDataService bigDataService;

    <span class="hljs-meta">@PostMapping("/saveall")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">saveAll</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;BigDataEntity&gt; entities)</span> {
        bigDataService.saveAll(entities);
        <span class="hljs-keyword">return</span> ResponseEntity.ok().build();
    }

    <span class="hljs-meta">@GetMapping("/page/{page}/{size}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Page&lt;BigDataEntity&gt;&gt; <span class="hljs-title function_">findPaginated</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> <span class="hljs-type">int</span> page, <span class="hljs-meta">@PathVariable</span> <span class="hljs-type">int</span> size)</span> {
        Page&lt;BigDataEntity&gt; result = bigDataService.findPaginated(page, size);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(result);
    }
}
</code></pre>
<h3 data-id="heading-13">8. 批量处理</h3>
<h4 data-id="heading-14">批量插入数据示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.boot.CommandLineRunner;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BigDataService bigDataService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DataLoader</span><span class="hljs-params">(BigDataService bigDataService)</span> {
        <span class="hljs-built_in">this</span>.bigDataService = bigDataService;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;BigDataEntity&gt; entities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-type">BigDataEntity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDataEntity</span>();
            entity.setDataField(<span class="hljs-string">"Data "</span> + i);
            entities.add(entity);
        }
        bigDataService.saveAll(entities);
    }
}
</code></pre>
<h3 data-id="heading-15">9. 分页查询</h3>
<h4 data-id="heading-16">分页查询数据示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.boot.CommandLineRunner;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataLoader</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BigDataService bigDataService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DataLoader</span><span class="hljs-params">(BigDataService bigDataService)</span> {
        <span class="hljs-built_in">this</span>.bigDataService = bigDataService;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">int</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            Page&lt;BigDataEntity&gt; result = bigDataService.findPaginated(page, size);
            <span class="hljs-keyword">if</span> (result.isEmpty()) {
                <span class="hljs-keyword">break</span>;
            }
            result.forEach(entity -&gt; System.out.println(entity.getDataField()));
            page++;
        }
    }
}
</code></pre>
<h3 data-id="heading-17">总结</h3>
<p>通过上述步骤，我们展示了如何在大数据环境中使用Hibernate，包括配置数据源和Hibernate属性、配置缓存、定义实体和DAO层、批量处理、分页查询以及使用缓存。在大数据环境中，采用批量处理、分页、缓存等策略可以有效提高性能和可扩展性。这样，应用程序可以在处理大规模数据时高效运行，并利用Hibernate进行数据库操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（72）如何在NoSQL数据库中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600616270002864166</link>    <guid>https://juejin.cn/post/7600616270002864166</guid>    <pubDate>2026-01-29T11:54:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600616270002864166" data-draft-id="7600616270002847782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（72）如何在NoSQL数据库中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T11:54:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（72）如何在NoSQL数据库中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T11:54:11.000Z" title="Thu Jan 29 2026 11:54:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在NoSQL数据库中使用Hibernate，可以使用Hibernate OGM（Object/Grid Mapper）。Hibernate OGM是Hibernate ORM的扩展，旨在为NoSQL数据库提供对象映射和持久化功能。它支持多种NoSQL数据库，包括MongoDB、CouchDB、Neo4j等。</p>
<p>下面是详细步骤和代码示例，展示如何在MongoDB（一种常见的NoSQL数据库）中使用Hibernate OGM。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MongoDB Driver --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mongodb-driver-sync<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Hibernate OGM Core --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate.ogm<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-ogm-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.1.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Hibernate OGM MongoDB --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate.ogm<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-ogm-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.1.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置Hibernate OGM</h3>
<p>创建一个配置类来配置Hibernate OGM。</p>
<h4 data-id="heading-2"><code>OgmConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OgmConfig</span> {

    <span class="hljs-meta">@Value("${spring.data.mongodb.host}")</span>
    <span class="hljs-keyword">private</span> String mongoHost;

    <span class="hljs-meta">@Value("${spring.data.mongodb.port}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mongoPort;

    <span class="hljs-meta">@Value("${spring.data.mongodb.database}")</span>
    <span class="hljs-keyword">private</span> String mongoDatabase;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">entityManagerFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        
        Map&lt;String, Object&gt; properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.provider"</span>, <span class="hljs-string">"mongodb"</span>);
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.create_database"</span>, <span class="hljs-literal">true</span>);
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.database"</span>, mongoDatabase);
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.host"</span>, mongoHost);
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.port"</span>, mongoPort);
        
        em.setJpaPropertyMap(properties);
        
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> JpaTransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">(EntityManagerFactory emf)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(emf);
    }
}
</code></pre>
<p>在<code>application.properties</code>中配置MongoDB参数：</p>
<pre><code class="hljs language-properties" lang="properties">spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=mydatabase
</code></pre>
<h3 data-id="heading-3">3. 定义实体类和DAO层</h3>
<h4 data-id="heading-4"><code>Person.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.annotations.GenericGenerator;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(generator = "UUID")</span>
    <span class="hljs-meta">@GenericGenerator(
        name = "UUID",
        strategy = "org.hibernate.id.UUIDGenerator"
    )</span>
    <span class="hljs-keyword">private</span> String id;

    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h4 data-id="heading-5"><code>PersonRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PersonRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Person, String&gt; {
}
</code></pre>
<h3 data-id="heading-6">4. 创建服务层</h3>
<h4 data-id="heading-7"><code>PersonService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PersonRepository personRepository;

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">createPerson</span><span class="hljs-params">(Person person)</span> {
        <span class="hljs-keyword">return</span> personRepository.save(person);
    }

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">getPersonById</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-keyword">return</span> personRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;Person&gt; <span class="hljs-title function_">getAllPersons</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> personRepository.findAll();
    }

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">updatePerson</span><span class="hljs-params">(Person person)</span> {
        <span class="hljs-keyword">return</span> personRepository.save(person);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deletePerson</span><span class="hljs-params">(String id)</span> {
        personRepository.deleteById(id);
    }
}
</code></pre>
<h3 data-id="heading-8">5. 创建控制器</h3>
<h4 data-id="heading-9"><code>PersonController.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/persons")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PersonService personService;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Person&gt; <span class="hljs-title function_">createPerson</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Person person)</span> {
        <span class="hljs-type">Person</span> <span class="hljs-variable">createdPerson</span> <span class="hljs-operator">=</span> personService.createPerson(person);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdPerson);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Person&gt; <span class="hljs-title function_">getPersonById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> personService.getPersonById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(person);
    }

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;Person&gt;&gt; <span class="hljs-title function_">getAllPersons</span><span class="hljs-params">()</span> {
        List&lt;Person&gt; persons = personService.getAllPersons();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(persons);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Person&gt; <span class="hljs-title function_">updatePerson</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id, <span class="hljs-meta">@RequestBody</span> Person person)</span> {
        person.setId(id); <span class="hljs-comment">// Ensure the person ID is set correctly</span>
        <span class="hljs-type">Person</span> <span class="hljs-variable">updatedPerson</span> <span class="hljs-operator">=</span> personService.updatePerson(person);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedPerson);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deletePerson</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        personService.deletePerson(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h3 data-id="heading-10">6. 运行应用</h3>
<ol>
<li><strong>启动MongoDB</strong>：确保你的MongoDB数据库运行在<code>localhost:27017</code>。</li>
<li><strong>启动Spring Boot应用</strong>：运行Spring Boot应用程序。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-11">7. 访问API</h3>
<p>通过以下API访问<code>Person</code>数据：</p>
<ul>
<li><code>POST /persons</code>：创建Person。</li>
<li><code>GET /persons/{id}</code>：按ID获取Person。</li>
<li><code>GET /persons</code>：获取所有Persons。</li>
<li><code>PUT /persons/{id}</code>：更新Person。</li>
<li><code>DELETE /persons/{id}</code>：删除Person。</li>
</ul>
<h3 data-id="heading-12">总结</h3>
<p>通过上述步骤，我们展示了如何在NoSQL数据库（如MongoDB）中使用Hibernate OGM，包括配置Hibernate OGM、定义实体和DAO层、创建服务层和控制器以及如何运行和访问API。在大数据和NoSQL环境中，Hibernate OGM提供了一种基于对象的方式来处理复杂的数据持久化需求，使得开发人员可以更方便地进行数据操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 框架探秘：拆解 OpenHands（4）--- 服务]]></title>    <link>https://juejin.cn/post/7600601482690560046</link>    <guid>https://juejin.cn/post/7600601482690560046</guid>    <pubDate>2026-01-29T12:02:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600601482690560046" data-draft-id="7600597995768496137" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 框架探秘：拆解 OpenHands（4）--- 服务"/> <meta itemprop="keywords" content="算法,人工智能,深度学习"/> <meta itemprop="datePublished" content="2026-01-29T12:02:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 框架探秘：拆解 OpenHands（4）--- 服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T12:02:06.000Z" title="Thu Jan 29 2026 12:02:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI Agent 框架探秘：拆解 OpenHands（4）--- 服务</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 概述</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 服务</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 API 模式</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 服务器组件</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.3 服务工作流程描述</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.4 listen_socket.py</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 概述</h3>
<p>本篇结合官方文档进行解读OpenHands的服务器，这是OpenHands系统的立身基础。</p>
<p>因为本系列借鉴的文章过多，可能在参考文献中有遗漏的文章，如果有，还请大家指出。</p>
<h3 data-id="heading-2">0x01 服务</h3>
<p>OpenHands提供了WebSocket服务器。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/534926d42ee84a37bb6b27a9119b96bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770292925&amp;x-signature=WXxYFrjXBhQjzC48wE6PKwl5MWs%3D" alt="openhands-server" loading="lazy"/></p>
<p>openhands-server</p>
<h4 data-id="heading-3">1.1 API 模式</h4>
<p>可以发送或从服务器接收两种类型的消息：</p>
<ul>
<li>Actions</li>
<li>Observations</li>
</ul>
<h5 data-id="heading-4">1.1.1 Actions</h5>
<p>一个action 包含三个部分：</p>
<ul>
<li><code>action</code>：要采取的动作</li>
<li><code>args</code>：动作的参数</li>
<li><code>message</code>：可以放在聊天记录中的友好消息</li>
</ul>
<p>有几种action 。它们的参数列在下面。 随着时间的推移，这个列表可能会增长。</p>
<ul>
<li>
<p><code>initialize</code> - 初始化代理。仅由客户端发送。</p>
<ul>
<li><code>model</code> - 要使用的模型名称</li>
<li><code>directory</code> - 工作空间的路径</li>
<li><code>agent_cls</code> - 要使用的代理类</li>
</ul>
</li>
<li>
<p><code>start</code> - 开始一个新的开发任务。仅由客户端发送。</p>
<ul>
<li><code>task</code> - 要开始的任务</li>
</ul>
</li>
<li>
<p><code>read</code> - 读取文件内容。</p>
<ul>
<li><code>path</code> - 要读取的文件路径</li>
</ul>
</li>
<li>
<p><code>write</code> - 写入内容到文件。</p>
<ul>
<li><code>path</code> - 要写入的文件路径</li>
<li><code>content</code> - 写入文件的内容</li>
</ul>
</li>
<li>
<p><code>run</code> - 运行命令。</p>
<ul>
<li><code>command</code> - 要运行的命令</li>
</ul>
</li>
</ul>

<ul>
<li>
<p><code>browse</code> - 打开网页。</p>
<ul>
<li><code>url</code> - 要打开的URL</li>
</ul>
</li>
<li>
<p><code>think</code> - 允许代理制定计划、设定目标或记录想法</p>
<ul>
<li><code>thought</code> - 要记录的想法</li>
</ul>
</li>
<li>
<p><code>finish</code> - 代理发出任务完成的信号</p>
</li>
</ul>
<h5 data-id="heading-5">1.1.2 observation</h5>
<p>一个observation 包含四个部分：</p>
<ul>
<li><code>observation</code>：观察类型</li>
<li><code>content</code>：表示观察数据的字符串</li>
<li><code>extras</code>：额外的结构化数据</li>
<li><code>message</code>：可以放在聊天记录中的友好消息</li>
</ul>
<p>有几种observation 。它们的额外信息列在下面。 随着时间的推移，这个列表可能会增长。</p>
<ul>
<li>
<p><code>read</code> - 文件内容</p>
<ul>
<li><code>path</code> - 读取的文件路径</li>
</ul>
</li>
<li>
<p><code>browse</code> - URL的HTML内容</p>
<ul>
<li><code>url</code> - 打开的URL</li>
</ul>
</li>
<li>
<p><code>run</code> - 命令的输出</p>
<ul>
<li><code>command</code> - 运行的命令</li>
<li><code>exit_code</code> - 命令的退出代码</li>
</ul>
</li>
<li>
<p><code>chat</code> - 用户的消息</p>
</li>
</ul>
<h4 data-id="heading-6">1.2 服务器组件</h4>
<p>以下部分描述了OpenHands项目的服务器端组件。</p>
<h5 data-id="heading-7">session.py</h5>
<p><code>session.py</code> 文件定义了<code>Session</code>类，它代表与客户端的WebSocket会话。关键特性包括：</p>
<ul>
<li>处理WebSocket连接和断开</li>
<li>初始化和管理代理会话</li>
<li>在客户端和代理之间分发事件</li>
<li>向客户端发送消息和错误</li>
</ul>
<h5 data-id="heading-8">session/agent_session.py</h5>
<p><code>agent_session.py</code> 文件包含<code>AgentSession</code>类，它管理会话内代理的生命周期。关键特性包括：</p>
<ul>
<li>创建和管理运行时环境</li>
<li>初始化代理控制器</li>
<li>处理安全分析</li>
<li>管理事件流</li>
</ul>
<h5 data-id="heading-9">session/conversation_manager/conversation_manager.py</h5>
<p><code>conversation_manager.py</code> 文件定义了<code>ConversationManager</code>类，它负责管理多个客户端会话。关键特性包括：</p>
<ul>
<li>添加和重启会话</li>
<li>向特定会话发送消息</li>
<li>清理非活动会话</li>
</ul>
<h5 data-id="heading-10">listen.py</h5>
<p><code>listen.py</code> 文件是主服务器文件，它设置FastAPI应用程序并定义各种API端点。关键特性包括：</p>
<ul>
<li>设置CORS中间件</li>
<li>处理WebSocket连接</li>
<li>管理文件上传</li>
<li>提供代理交互、文件操作和安全分析的API端点</li>
<li>为前端提供静态文件服务</li>
</ul>
<p>该脚本定义了服务接口，主要分为两个部分：</p>
<ul>
<li>一部分是通过<code>FastAPI</code>库实现的HTTP接口，其具体实现位于<code>openhands/server/routes</code>目录中；</li>
<li>另一部分是利用<code>socketio</code>库实现的WebSocket接口，其代码实现在<code>openhands/server/listen_socket.py</code>文件中。用户与代理的交互通过WebSocket进行，连接初始化时会触发<code>connect</code>事件，用户发送消息时会触发<code>oh_user_action</code>事件，连接断开时会触发<code>disconnect</code>事件。因此，梳理代理交互逻辑的核心在于对这三个事件的处理流程进行整理。</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socketio

<span class="hljs-keyword">from</span> openhands.server.app <span class="hljs-keyword">import</span> app <span class="hljs-keyword">as</span> base_app
<span class="hljs-keyword">from</span> openhands.server.listen_socket <span class="hljs-keyword">import</span> sio
<span class="hljs-keyword">from</span> openhands.server.middleware <span class="hljs-keyword">import</span> (
    CacheControlMiddleware,
    InMemoryRateLimiter,
    LocalhostCORSMiddleware,
    RateLimitMiddleware,
)
<span class="hljs-keyword">from</span> openhands.server.static <span class="hljs-keyword">import</span> SPAStaticFiles

<span class="hljs-keyword">if</span> os.getenv(<span class="hljs-string">'SERVE_FRONTEND'</span>, <span class="hljs-string">'true'</span>).lower() == <span class="hljs-string">'true'</span>:
    base_app.mount(
        <span class="hljs-string">'/'</span>, SPAStaticFiles(directory=<span class="hljs-string">'./frontend/build'</span>, html=<span class="hljs-literal">True</span>), name=<span class="hljs-string">'dist'</span>
    )

base_app.add_middleware(LocalhostCORSMiddleware)
base_app.add_middleware(CacheControlMiddleware)
base_app.add_middleware(
    RateLimitMiddleware,
    rate_limiter=InMemoryRateLimiter(requests=<span class="hljs-number">10</span>, seconds=<span class="hljs-number">1</span>),
)

app = socketio.ASGIApp(sio, other_asgi_app=base_app)
</code></pre>
<h4 data-id="heading-11">1.3 服务工作流程描述</h4>
<p>服务的工作流程如下：</p>
<ol>
<li>
<p><strong>服务器初始化</strong>：</p>
<ul>
<li>FastAPI应用程序在<code>listen.py</code>中创建和配置。</li>
<li>设置CORS中间件和静态文件服务。</li>
<li>初始化<code>ConversationManager</code>。</li>
</ul>
</li>
<li>
<p><strong>客户端连接</strong>：</p>
<ul>
<li>当客户端通过WebSocket连接时，创建新的<code>Session</code>或重启现有一个。</li>
<li><code>Session</code>初始化<code>AgentSession</code>，设置运行时环境和代理控制器。</li>
</ul>
</li>
<li>
<p><strong>代理初始化</strong>：</p>
<ul>
<li>客户端发送初始化请求。</li>
<li>服务器根据提供的参数创建和配置代理。</li>
<li>设置运行时环境，初始化代理控制器。</li>
</ul>
</li>
<li>
<p><strong>事件处理</strong>：</p>
<ul>
<li><code>Session</code>管理客户端和代理之间的事件流。</li>
<li>客户端的事件分发到代理。</li>
<li>代理的观察结果发送回客户端。</li>
</ul>
</li>
<li>
<p><strong>文件操作</strong>：</p>
<ul>
<li>服务器处理文件上传，确保它们符合大小和类型限制。</li>
<li>通过运行时环境执行文件读取和写入操作。</li>
</ul>
</li>
<li>
<p><strong>安全分析</strong>：</p>
<ul>
<li>如果配置了，每个会话初始化安全分析器。</li>
<li>安全相关的API请求转发到安全分析器。</li>
</ul>
</li>
<li>
<p><strong>会话管理</strong>：</p>
<ul>
<li><code>ConversationManager</code>定期清理非活动会话。</li>
<li>它还在需要时处理向特定会话发送消息。</li>
</ul>
</li>
<li>
<p><strong>API端点</strong>：</p>
<ul>
<li>提供各种API端点，用于代理交互、文件操作和获取配置默认值。</li>
</ul>
</li>
</ol>
<p>这种服务器架构允许管理多个客户端会话，每个会话都有自己的代理实例、运行时环境和安全分析器。事件驱动设计促进了客户端和代理之间的实时通信，而模块化结构允许轻松扩展和维护不同组件。</p>
<h4 data-id="heading-12">1.4 listen_socket.py</h4>
<p>listen_socket.py是 OpenHands 服务器端的 Socket.IO 事件监听器，负责处理客户端和服务器之间的实时双向通信，包括连接建立、事件回放、用户行动转发和连接断开四大核心场景，是客户端与后端会话、代理系统交互的桥梁。</p>
<h5 data-id="heading-13">1.4.1 核心特色</h5>
<p>listen_socket.py的核心特色如下：</p>
<ol>
<li>断点续传的事件回放：支持通过 <code>latest_event_id</code> 参数实现事件断点续传，客户端重连时仅回放未接收的事件，避免重复数据传输，提升连接效率。</li>
<li>严格的身份与权限校验：连接建立时校验会话 ID、API 密钥、用户身份（通过 Cookie 和 Authorization 头），确保会话安全性，防止未授权访问。</li>
<li>向后兼容的事件处理：保留 <code>oh_action</code> 处理器兼容旧版客户端，同时提供 <code>oh_user_action</code> 新版接口，平滑过渡不中断服务。</li>
<li>有序的事件推送逻辑：代理状态变更事件（<code>AgentStateChangedObservation</code>）最后发送，确保客户端先接收历史事件，再同步最新状态，避免状态不一致。</li>
<li>异步高效的事件处理：基于异步 IO（<code>async/await</code>）实现事件回放和转发，支持高并发连接，不阻塞主线程，提升系统吞吐量。</li>
<li>完善的错误处理：连接失败时主动断开无效连接，记录详细日志，便于问题排查；过滤无效事件（如 <code>NullAction</code>），减少不必要的网络传输。</li>
</ol>
<h5 data-id="heading-14">1.4.2 具体功能</h5>
<p>listen_socket.py的具体功能如下：</p>
<ul>
<li>
<p>连接管理（connect 事件）</p>
<ul>
<li>身份验证：验证连接参数中的 conversation_id 和 API 密钥</li>
<li>用户认证：通过 conversation_validator 验证用户身份</li>
<li>会话恢复：为已存在的会话重放事件流历史</li>
<li>事件重播：向新连接的客户端发送历史事件，包括过滤特定事件类型</li>
<li>会话加入：将客户端连接加入到对应的会话中</li>
</ul>
</li>
<li>
<p>动作处理（oh_user_action 和 oh_action 事件）</p>
<ul>
<li>用户动作接收：处理来自客户端的用户操作请求</li>
<li>事件转发：将用户动作转发到会话管理器进行处理</li>
<li>向后兼容：同时支持 oh_user_action 和 oh_action 事件处理（后者为兼容旧客户端保留）</li>
</ul>
</li>
<li>
<p>断开连接处理（disconnect 事件）</p>
<ul>
<li>连接清理：当客户端断开连接时，清理相关会话资源</li>
<li>状态管理：通知会话管理器客户端已断开连接</li>
</ul>
</li>
</ul>
<p>listen_socket.py的核心工作流程为：</p>
<ul>
<li>
<p>连接建立：</p>
<ul>
<li>解析查询参数（会话 ID、最新事件 ID等）</li>
<li>验证会话和用户身份</li>
<li>创建事件存储实例</li>
</ul>
</li>
<li>
<p>事件历史重播：</p>
<ul>
<li>为客户端重放会话历史事件</li>
<li>过滤掉 NullAction、NullObservation、RecallAction 等特定事件</li>
<li>确保 AgentStateChangedObservation 事件最后发送</li>
</ul>
</li>
<li>
<p>会话加入：</p>
<ul>
<li>将连接 ID 与会话关联</li>
<li>初始化会话设置</li>
</ul>
</li>
<li>
<p>安全机制</p>
<ul>
<li>API密钥验证：检查 SESSION_API_KEY 环境变量与查询参数中的密钥是否匹配</li>
<li>会话权限控制：通过 conversation_validator 验证用户是否有权访问定会话</li>
</ul>
</li>
<li>
<p>错误处理</p>
<ul>
<li>连接拒绝：在验证失败或出现错误时拒绝连接</li>
<li>异常传播：使用ConnectionRefusedError处理连接错误</li>
<li>异步清理：在连接被拒绝后异步断开连接</li>
</ul>
</li>
</ul>
<p>listen_socket.py 与其他组件关系</p>
<ul>
<li>与EventStream紧密配合，负责事件的传输和分发</li>
<li>通过 connection_manager 管理会话状态</li>
<li>使用 event_to_dict 进行事件序列化以便通过网络传输</li>
</ul>
<h5 data-id="heading-15">1.4.3 流程图</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/268213b2cf444fc4a4dc162b50d04b93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770292925&amp;x-signature=8VyQJHw6BXja3XK2J5%2Bwgxw9%2Ba0%3D" alt="Openhands-服务" loading="lazy"/></p>
<p>Openhands-服务</p>
<h5 data-id="heading-16">1.4.4 会话连接</h5>
<p>此处关键一步为与会话管理器 ConversationManager 建立连接。</p>
<pre><code class="hljs language-ini" lang="ini">        <span class="hljs-attr">conversation_init_data</span> = await setup_init_conversation_settings(
            user_id, conversation_id, providers_set
        )

        <span class="hljs-attr">agent_loop_info</span> = await conversation_manager.join_conversation(
            conversation_id,
            connection_id,
            conversation_init_data,
            user_id,
        )
</code></pre>
<h5 data-id="heading-17">1.4.5 代码</h5>
<p>listen_socket.py的代码举例如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@sio.event</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params">connection_id: <span class="hljs-built_in">str</span>, environ: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""
    SocketIO连接事件处理器：客户端建立连接时触发，完成会话验证、事件回放、会话加入等初始化流程。
    
    参数：
        connection_id: 客户端连接唯一标识（SocketIO分配）
        environ: WSGI环境变量字典，包含请求头、查询参数等信息
    """</span>
    <span class="hljs-keyword">try</span>:
        logger.info(<span class="hljs-string">f"SocketIO连接建立：connection_id=<span class="hljs-subst">{connection_id}</span>"</span>)
        
        <span class="hljs-comment"># 解析查询参数（从WSGI环境变量中提取QUERY_STRING）</span>
        query_params = parse_qs(environ.get(<span class="hljs-string">'QUERY_STRING'</span>, <span class="hljs-string">''</span>))
        
        <span class="hljs-comment"># 解析最新事件ID（用于断点续传，默认-1表示从最开始回放）</span>
        latest_event_id_str = query_params.get(<span class="hljs-string">'latest_event_id'</span>, [-<span class="hljs-number">1</span>])[<span class="hljs-number">0</span>]
        <span class="hljs-keyword">try</span>:
            latest_event_id = <span class="hljs-built_in">int</span>(latest_event_id_str)
        <span class="hljs-keyword">except</span> ValueError:
            logger.debug(<span class="hljs-string">f"无效的latest_event_id值：<span class="hljs-subst">{latest_event_id_str}</span>，默认设为-1"</span>)
            latest_event_id = -<span class="hljs-number">1</span>
        
        <span class="hljs-comment"># 解析会话ID（必需参数，用于关联特定对话）</span>
        conversation_id = query_params.get(<span class="hljs-string">'conversation_id'</span>, [<span class="hljs-literal">None</span>])[<span class="hljs-number">0</span>]
        logger.info(<span class="hljs-string">f"会话连接请求：conversation_id=<span class="hljs-subst">{conversation_id}</span>, connection_id=<span class="hljs-subst">{connection_id}</span>"</span>)
        
        <span class="hljs-comment"># 解析提供者集合（如支持的LLM提供商列表，用于限制可用资源）</span>
        raw_list = query_params.get(<span class="hljs-string">'providers_set'</span>, [])
        providers_list = []
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> raw_list:
            <span class="hljs-comment"># 拆分逗号分隔的提供者名称，过滤空值</span>
            providers_list.extend(item.split(<span class="hljs-string">','</span>) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(item, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">else</span> [])
        providers_list = [p <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> providers_list <span class="hljs-keyword">if</span> p]
        providers_set = [ProviderType(p) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> providers_list]  <span class="hljs-comment"># 转换为ProviderType枚举类型</span>

        <span class="hljs-comment"># 校验会话ID是否存在</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> conversation_id:
            logger.error(<span class="hljs-string">"查询参数中缺少conversation_id"</span>)
            <span class="hljs-keyword">raise</span> ConnectionRefusedError(<span class="hljs-string">"缺少会话ID（conversation_id）"</span>)

        <span class="hljs-comment"># 校验会话API密钥是否有效</span>
        <span class="hljs-keyword">if</span> _invalid_session_api_key(query_params):
            <span class="hljs-keyword">raise</span> ConnectionRefusedError(<span class="hljs-string">"无效的会话API密钥"</span>)

        <span class="hljs-comment"># 提取请求中的Cookie和Authorization头（用于用户身份验证）</span>
        cookies_str = environ.get(<span class="hljs-string">'HTTP_COOKIE'</span>, <span class="hljs-string">''</span>)
        <span class="hljs-comment"># WSGI环境中，HTTP头会转为"HTTP_前缀+下划线替换短横线"格式</span>
        authorization_header = environ.get(<span class="hljs-string">'HTTP_AUTHORIZATION'</span>, <span class="hljs-literal">None</span>)
        
        <span class="hljs-comment"># 创建会话验证器，校验用户身份（关联会话ID、Cookie、授权头）</span>
        conversation_validator = create_conversation_validator()
        user_id = <span class="hljs-keyword">await</span> conversation_validator.validate(
            conversation_id, cookies_str, authorization_header
        )
        
        <span class="hljs-comment"># 创建事件存储实例（用于读取会话历史事件）</span>
        <span class="hljs-keyword">try</span>:
            event_store = EventStore(
                conversation_id, conversation_manager.file_store, user_id
            )
        <span class="hljs-keyword">except</span> FileNotFoundError <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"创建会话事件存储失败：conversation_id=<span class="hljs-subst">{conversation_id}</span>, 错误=<span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span> ConnectionRefusedError(<span class="hljs-string">f"无法访问会话事件：<span class="hljs-subst">{e}</span>"</span>)

        agent_state_changed = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 存储代理状态变更事件（最后单独发送）</span>

        <span class="hljs-comment"># 创建异步事件存储包装器，从latest_event_id+1开始回放事件（避免重复）</span>
        async_store = AsyncEventStoreWrapper(event_store, latest_event_id + <span class="hljs-number">1</span>)

        <span class="hljs-comment"># 异步回放历史事件（向客户端推送未接收过的事件）</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> async_store:
            logger.debug(<span class="hljs-string">f"回放事件：<span class="hljs-subst">{event.__class__.__name__}</span>"</span>)

            <span class="hljs-comment"># 跳过无效/召回类事件（无需推送给客户端）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(
                event,
                (NullAction, NullObservation, RecallAction),
            ):
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 暂存代理状态变更事件（最后发送，确保客户端状态同步）</span>
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(event, AgentStateChangedObservation):
                agent_state_changed = event
            <span class="hljs-comment"># 其他事件直接推送给客户端</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">await</span> sio.emit(<span class="hljs-string">'oh_event'</span>, event_to_dict(event), to=connection_id)

        <span class="hljs-comment"># 最后发送代理状态变更事件（确保客户端获取最新状态）</span>
        <span class="hljs-keyword">if</span> agent_state_changed:
            <span class="hljs-keyword">await</span> sio.emit(
                <span class="hljs-string">'oh_event'</span>, event_to_dict(agent_state_changed), to=connection_id
            )

        logger.info(<span class="hljs-string">f"会话事件回放完成：conversation_id=<span class="hljs-subst">{conversation_id}</span>"</span>)

        <span class="hljs-comment"># 初始化会话设置（用户偏好、提供者配置等）</span>
        conversation_init_data = <span class="hljs-keyword">await</span> setup_init_conversation_settings(
            user_id, conversation_id, providers_set
        )

        <span class="hljs-comment"># 加入会话：关联connection_id与会话，启动代理循环</span>
        agent_loop_info = <span class="hljs-keyword">await</span> conversation_manager.join_conversation(
            conversation_id,
            connection_id,
            conversation_init_data,
            user_id,
        )

        <span class="hljs-comment"># 校验会话加入结果</span>
        <span class="hljs-keyword">if</span> agent_loop_info <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> ConnectionRefusedError(<span class="hljs-string">"加入会话失败"</span>)

        logger.info(<span class="hljs-string">f"会话加入成功：conversation_id=<span class="hljs-subst">{conversation_id}</span>, connection_id=<span class="hljs-subst">{connection_id}</span>"</span>)
        
    <span class="hljs-keyword">except</span> ConnectionRefusedError:
        <span class="hljs-comment"># 发送错误后断开无效连接</span>
        asyncio.create_task(sio.disconnect(connection_id))
        <span class="hljs-keyword">raise</span>


<span class="hljs-meta">@sio.event</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">oh_user_action</span>(<span class="hljs-params">connection_id: <span class="hljs-built_in">str</span>, data: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""
    处理客户端发送的用户行动事件（如用户输入、操作指令）。
    
    参数：
        connection_id: 客户端连接ID
        data: 用户行动数据（字典格式，包含行动类型、内容等）
    """</span>
    <span class="hljs-comment"># 将用户行动转发到事件流，由会话管理器处理</span>
    <span class="hljs-keyword">await</span> conversation_manager.send_to_event_stream(connection_id, data)


<span class="hljs-meta">@sio.event</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">oh_action</span>(<span class="hljs-params">connection_id: <span class="hljs-built_in">str</span>, data: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""
    兼容旧版客户端的行动事件处理器（保留用于向后兼容）。
    
    注意：待所有客户端升级为使用oh_user_action后，可移除该处理器
    目前用于支持正在进行中的旧会话，避免中断服务
    """</span>
    <span class="hljs-keyword">await</span> conversation_manager.send_to_event_stream(connection_id, data)


<span class="hljs-meta">@sio.event</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">disconnect</span>(<span class="hljs-params">connection_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""
    SocketIO断开连接事件处理器：客户端断开连接时触发。
    
    参数：
        connection_id: 断开连接的客户端ID
    """</span>
    logger.info(<span class="hljs-string">f"SocketIO连接断开：connection_id=<span class="hljs-subst">{connection_id}</span>"</span>)
    <span class="hljs-comment"># 通知会话管理器，断开该连接与会话的关联</span>
    <span class="hljs-keyword">await</span> conversation_manager.disconnect_from_session(connection_id)
</code></pre>
<h3 data-id="heading-18">0xFF 参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.all-hands.dev%2Fopenhands%2Fusage%2Farchitecture%2Fbackend" target="_blank" title="https://docs.all-hands.dev/openhands/usage/architecture/backend" ref="nofollow noopener noreferrer">docs.all-hands.dev/openhands/u…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1936485868761257658" target="_blank" title="https://zhuanlan.zhihu.com/p/1936485868761257658" ref="nofollow noopener noreferrer">当AI Agent从“玩具”走向“工具”，我们该关注什么？Openhands架构解析【第二篇：Agent 相关核心概念】</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fpeople%2Fdreamrenderx" target="_blank" title="https://www.zhihu.com/people/dreamrenderx" ref="nofollow noopener noreferrer">克里</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1936175201323825087" target="_blank" title="https://zhuanlan.zhihu.com/p/1936175201323825087" ref="nofollow noopener noreferrer">当AI Agent从“玩具”走向“工具”，我们该关注什么？Openhands架构解析【第一篇：系列导读】</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fpeople%2Fdreamrenderx" target="_blank" title="https://www.zhihu.com/people/dreamrenderx" ref="nofollow noopener noreferrer">克里</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1940436682949244630" target="_blank" title="https://zhuanlan.zhihu.com/p/1940436682949244630" ref="nofollow noopener noreferrer">Coding Agent之Openhands解析(含代码)</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fpeople%2Fwu-long-ming-cha-56" target="_blank" title="https://www.zhihu.com/people/wu-long-ming-cha-56" ref="nofollow noopener noreferrer">Arrow</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1940824548485347192" target="_blank" title="https://zhuanlan.zhihu.com/p/1940824548485347192" ref="nofollow noopener noreferrer">OpenHands 源码解读</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fpeople%2Fxiao-hui-66-72" target="_blank" title="https://www.zhihu.com/people/xiao-hui-66-72" ref="nofollow noopener noreferrer">一力辉</a></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dart - 全面认识Stream]]></title>    <link>https://juejin.cn/post/7600628279214456858</link>    <guid>https://juejin.cn/post/7600628279214456858</guid>    <pubDate>2026-01-29T09:26:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600628279214456858" data-draft-id="7600414546189713418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dart - 全面认识Stream"/> <meta itemprop="keywords" content="Flutter,Dart"/> <meta itemprop="datePublished" content="2026-01-29T09:26:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浩辉"/> <meta itemprop="url" content="https://juejin.cn/user/1134351728786711"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dart - 全面认识Stream
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1134351728786711/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浩辉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:26:32.000Z" title="Thu Jan 29 2026 09:26:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一章：Flutter 进阶——为什么你需要 Stream？从 Future 到流的思维跃迁</h2>
<p>在 Flutter 和 Dart 的异步编程世界里，大多数开发者都是从 <code>Future</code> 开始入门的。我们习惯了 <code>await</code> 一个网络请求，然后等待结果返回。</p>
<p>但是，当你试图实现一个“倒计时”、“文件下载进度条”或者“实时聊天室”时，你会发现 <code>Future</code> 变得力不从心。这时候，你就需要升级你的武器库，引入一个更强大的概念 —— <strong>Stream (流)</strong>。</p>
<p>本章我们将不再仅仅罗列 API，而是从内存和执行原理的角度，解剖 Stream 到底是什么，以及它为什么被称为“异步数据的生命之河”。</p>
<h3 data-id="heading-1">一、 Future 的“一锤子买卖”</h3>
<p>先来看一段我们最熟悉的 <code>Future</code> 代码：</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-built_in">String</span>&gt; fetchUser() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>));
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Jason"</span>; <span class="hljs-comment">// 任务结束，返回结果</span>
}

</code></pre>
<p><code>Future</code> 的设计哲学非常简单：<strong>一次请求，一次响应。</strong></p>
<p>它就像是网购。你下个单（调用函数），过几天快递员给你<strong>一个</strong>包裹（返回值）。交易完成后，你和快递员的关系就结束了。</p>
<p>在底层内存模型中，当你执行 <code>return "Jason"</code> 的那一瞬间，发生了两件事：</p>
<ol>
<li><strong>结果交付</strong>：数据被发送给了等待者。</li>
<li><strong>现场销毁</strong>：<code>fetchUser</code> 函数的<strong>栈帧 (Stack Frame)</strong> 被弹出、销毁。这个函数“死”了，它的生命周期彻底结束。</li>
</ol>
<p><strong>痛点来了：</strong>
如果你想要的是“连续的数据”呢？
比如，你不仅想知道“文件下载完了没有”，还想知道“现在下载了百分之几”。</p>
<ul>
<li>如果你用 <code>Future</code>，你只能得到一张下载完成时的<strong>截图</strong>。</li>
<li>但你真正想要的是一段<strong>录像</strong>。</li>
</ul>
<p>这时候，我们需要一个能“活着”并在时间轴上源源不断吐出数据的机制。</p>
<h3 data-id="heading-2">二、 Stream：时间轴上的传送带</h3>
<p>如果说 <code>Future</code> 是静态的<strong>点</strong>，那么 <code>Stream</code> 就是动态的<strong>线</strong>。</p>
<p>你可以把 <code>Stream</code> 想象成回转寿司店里的一条<strong>自动传送带</strong>。</p>
<p>在这个模型里，有三个核心角色：</p>
<ol>
<li><strong>Sink (入口/厨师)</strong>：这是生产端。厨师（生成器）把一盘盘寿司（数据）按顺序放上传送带。</li>
<li><strong>Stream (管道)</strong>：这是传送带本身。它负责搬运数据，它不关心谁吃，只负责转动。</li>
<li><strong>Listener (出口/食客)</strong>：这是消费端。你坐在传送带末端，<strong>监听 (Listen)</strong> 着它。来一盘，你吃一盘。</li>
</ol>
<p>与 <code>Future</code> 不同，<code>Stream</code> 是一种 <strong>异步的 Iterable (Asynchronous Iterable)</strong>。它代表的不是“一个值”，而是“可能随时间推移而到达的一系列值”。</p>
<h3 data-id="heading-3">三、 语法上的“基因突变”：async* 与 yield</h3>
<p>为了支持这种“源源不断”的特性，Dart 在语法层面做了一个极具深意的设计。</p>
<p>我们要重点关注两个关键字：<code>async*</code> 和 <code>yield</code>。</p>
<h4 data-id="heading-4">1. 那个神秘的星号 (*)</h4>
<p>你可能注意到了，Stream 函数的定义后面必须带一个 <code>*</code>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Future: 单数</span>
Future&lt;<span class="hljs-built_in">int</span>&gt; getScore() <span class="hljs-keyword">async</span> { ... }

<span class="hljs-comment">// Stream: 复数（生成器）</span>
Stream&lt;<span class="hljs-built_in">int</span>&gt; getScores() <span class="hljs-keyword">async</span>* { ... }

</code></pre>
<p>这个星号 <code>*</code> 代表 <strong>Generator (生成器)</strong>。在计算机科学中，它暗示着“多”和“生产能力”。它告诉编译器：<strong>“嗨，这个函数有点特殊，它不会跑一遍就死掉，它是一个状态机。”</strong></p>
<h4 data-id="heading-5">2. yield vs return：暂停与销毁</h4>
<p>这是理解 Stream 底层原理最关键的一步。请看这段代码：</p>
<pre><code class="hljs language-dart" lang="dart">Stream&lt;<span class="hljs-built_in">int</span>&gt; countDown() <span class="hljs-keyword">async</span>* {
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">5</span>; i &gt; <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
    <span class="hljs-keyword">yield</span> i; <span class="hljs-comment">// &lt;--- 关键看这里！</span>
  }
}

</code></pre>
<ul>
<li><strong><code>return</code> (辞职)</strong>：
当普通函数执行 <code>return</code> 时，它是<strong>彻底退出</strong>。它的栈帧被销毁，局部变量全部清空。下次再调用，一切从头开始。</li>
<li><strong><code>yield</code> (停薪留职/暂停)</strong>：
当生成器函数执行 <code>yield i</code> 时，它做的是 <strong>“交出数据，原地暂停”</strong>。</li>
<li><strong>交出数据</strong>：把 <code>i</code> 扔进事件循环，发给监听者。</li>
<li><strong>保留现场</strong>：<strong>关键点！</strong> 此时函数的栈帧<strong>并没有被销毁</strong>！当前的局部变量 <code>i</code> 的值、代码执行到了第几行，通通被“冻结”在内存里。</li>
<li><strong>恢复执行</strong>：当函数再次被唤醒时，它会从 <code>yield</code> 的<strong>下一行</strong>继续执行，仿佛从未中断过。</li>
</ul>
<p>正是因为有了 <code>yield</code> 这种**“保留状态”**的能力，Stream 才能做到记住了循环到了哪里，从而源源不断地产生数据。</p>
<h3 data-id="heading-6">四、 为什么我们需要 Stream？</h3>
<p>既然 <code>Future</code> 简单好用，为什么还要折腾 <code>Stream</code>？</p>
<p><strong>1. 解决“过程”问题</strong>
现实世界的交互往往是连续的。</p>
<ul>
<li><strong>倒计时</strong>：5, 4, 3, 2, 1...</li>
<li><strong>搜索联想</strong>：你输一个字母，推荐列表变一次。</li>
<li><strong>WebSocket</strong>：服务器随时可能推一条新消息过来。
这些场景，用 <code>Future</code> 这种“一次性承诺”是无法优雅实现的，必须用 <code>Stream</code>。</li>
</ul>
<p><strong>2. 变“主动轮询”为“被动响应”</strong></p>
<ul>
<li><strong>传统方式 (Pull)</strong>：你不停地问服务器“好了没？好了没？”（轮询），浪费资源。</li>
<li><strong>Stream 方式 (Push)</strong>：你注册一个监听器 <code>listen()</code>，然后去干别的事。一旦有数据，Stream 会<strong>主动</strong>推给你。这也就是现在流行的 <strong>响应式编程 (Reactive Programming)</strong> 的核心思想。</li>
</ul>
<h3 data-id="heading-7">小结</h3>



































<table><thead><tr><th>特性</th><th>Future (未来)</th><th>Stream (流)</th></tr></thead><tbody><tr><td><strong>数据量</strong></td><td>单个值 (Single)</td><td>多个值 (Multiple)</td></tr><tr><td><strong>生命周期</strong></td><td>一次性 (One-shot)</td><td>持续的时间轴 (Continuous)</td></tr><tr><td><strong>结束动作</strong></td><td>Return (销毁)</td><td>Stream Done (关闭)</td></tr><tr><td><strong>核心机制</strong></td><td>栈帧销毁</td><td><strong>栈帧暂停 (yield)</strong></td></tr><tr><td><strong>生活类比</strong></td><td>拍一张照片</td><td>录一段视频</td></tr></tbody></table>
<p>理解了 Stream 的<strong>传送带模型</strong>和 <strong><code>yield</code> 的暂停机制</strong>，你就已经迈过了异步编程最难的一道坎。</p>
<p>但是，现在的传送带还很简陋。如果我想让多个人同时看一条传送带（多订阅）？或者我想在传送带中间加一个滤网，只过滤出我想要的寿司（操作符）？</p>
<p>下一章，我们将深入探讨 Stream 的两种形态：<strong>单订阅 (Single-subscription)</strong> 与 <strong>广播 (Broadcast)</strong>。</p>
<hr/>
<h2 data-id="heading-8">第二章：Flutter 进阶——Stream 的两种形态与掌控权</h2>
<p>在上一章中，我们用 <code>async*</code> 函数轻松创建了一条传送带。
但是，当你试图在代码中对同一个 Stream 调用两次 <code>listen</code> 时，程序会毫不留情地抛出一个异常：
<code>Bad state: Stream has already been listened to.</code></p>
<p>这并不是 Bug，这是 Dart Stream 设计哲学的核心：<strong>根据消费场景的不同，Stream 分为两种截然不同的形态。</strong></p>
<p>本章我们将深入探讨 <strong>单订阅 (Single-subscription)</strong> 与 <strong>广播 (Broadcast)</strong> 的区别，并解锁 Stream 的手动挡模式 —— <strong>StreamController</strong>。</p>
<h3 data-id="heading-9">一、 私密对话 vs 公共广播</h3>
<p>在内存世界里，数据的流动方式决定了 Stream 的类型。</p>
<h4 data-id="heading-10">1. 单订阅 Stream (Single-subscription) —— “我的汉堡”</h4>
<p>这是 Stream 的<strong>默认形态</strong>。当你使用 <code>async*</code> 或者 <code>File.openRead()</code> 创建流时，它就是单订阅的。</p>
<ul>
<li><strong>特点</strong>：<strong>一对一</strong>。这条传送带是为你专门铺设的。</li>
<li><strong>形象比喻</strong>：<strong>“在餐厅点餐”</strong>。
厨师为你做了一份炒饭。这份炒饭（数据）只能被你一个人吃（消费）。如果你的朋友也想吃，他必须重新下一单（创建一个新的 Stream ），厨师会重新做一份。</li>
<li><strong>底层逻辑</strong>：
数据是为了保证<strong>完整性</strong>和<strong>顺序性</strong>。比如读取文件，你绝不希望两个人在同时读一个文件流，导致你读一半，他读一半，数据全乱套了。</li>
<li><strong>致命限制</strong>：<strong>只能监听一次！</strong> 即使第一个监听者取消了订阅 (cancel)，这条 Stream 也废了，不能再被监听。</li>
</ul>
<h4 data-id="heading-11">2. 广播 Stream (Broadcast) —— “村口大喇叭”</h4>
<p>这是 Stream 的另一种形态。通常用于事件总线、鼠标点击、系统通知等场景。</p>
<ul>
<li><strong>特点</strong>：<strong>一对多</strong>。</li>
<li><strong>形象比喻</strong>：<strong>“听收音机”</strong>。
电台（数据源）在不停地播放。你听，或者隔壁老王听，甚至一百个人同时听，互不影响。</li>
<li><strong>关键差异</strong>：</li>
<li><strong>过时不候</strong>：广播流通常是 <strong>"Hot" (热)</strong> 的。如果你 10:00 打开收音机，你听不到 9:50 播放的新闻。数据发出去没人听，就直接丢弃了。</li>
<li><strong>随时监听</strong>：你可以随时加入，也可以随时退出，支持多个监听者同时存在。</li>
</ul>
<h4 data-id="heading-12">3. 代码实战：如何转换？</h4>
<p>如果我非要让那盘“炒饭”大家一起吃怎么办？Dart 提供了 <code>asBroadcastStream()</code> 方法。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 1. 创建一个普通的单订阅流</span>
Stream&lt;<span class="hljs-built_in">int</span>&gt; stream = getScoreStream();

<span class="hljs-comment">// 2. 强行变成广播流</span>
Stream&lt;<span class="hljs-built_in">int</span>&gt; broadcastStream = stream.asBroadcastStream();

<span class="hljs-comment">// 3. 现在可以多次监听了</span>
broadcastStream.listen((v) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">"老王听到了: <span class="hljs-subst">$v</span>"</span>));
broadcastStream.listen((v) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">"小李听到了: <span class="hljs-subst">$v</span>"</span>));

</code></pre>
<hr/>
<h3 data-id="heading-13">二、 手动挡：StreamController</h3>
<p>到目前为止，我们都是通过 <code>async*</code> 函数来**“自动”**生成 Stream。这种方式很简单，但它是被动的——必须等到函数里的 <code>yield</code> 执行时才有数据。</p>
<p>如果我们想在一个按钮点击事件里发送数据？或者在网络请求回调里发送数据？
这时候，我们需要 <strong>StreamController (流控制器)</strong>。</p>
<p>如果说 <code>async*</code> 是设定好程序的<strong>自动流水线</strong>，那 <code>StreamController</code> 就是一个<strong>万能遥控器</strong>。</p>
<h4 data-id="heading-14">1. 结构解剖</h4>
<p><code>StreamController</code> 把 Stream 的结构拆解得清清楚楚：</p>
<ul>
<li><strong>入口 (Sink)</strong>：你可以随时随地调用 <code>sink.add(data)</code> 往里面扔数据。</li>
<li><strong>出口 (Stream)</strong>：就是我们熟悉的那个 Stream，给别人去 <code>listen</code> 的。</li>
<li><strong>控制器 (Controller)</strong>：管理开关、暂停、以及流的状态。</li>
</ul>
<h4 data-id="heading-15">2. 极简代码示范</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:async'</span>;

<span class="hljs-keyword">void</span> main() {
  <span class="hljs-comment">// 1. 创建控制器 (买了一个遥控器)</span>
  <span class="hljs-comment">// 如果想做广播流，就用 StreamController.broadcast();</span>
  <span class="hljs-keyword">final</span> controller = StreamController&lt;<span class="hljs-built_in">String</span>&gt;();

  <span class="hljs-comment">// 2. 拿到出口 (给别人听的)</span>
  controller.stream.listen(
    (data) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">"收到推流: <span class="hljs-subst">$data</span>"</span>),
    onError: (err) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">"发生错误: <span class="hljs-subst">$err</span>"</span>),
    onDone: () =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">"直播结束"</span>),
  );

  <span class="hljs-comment">// 3. 拿到入口 (自己在任意地方控制)</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">"准备发射数据..."</span>);
  controller.sink.add(<span class="hljs-string">"第一条消息"</span>); <span class="hljs-comment">// 像不像 EventBus？</span>
  controller.sink.add(<span class="hljs-string">"第二条消息"</span>);
  
  <span class="hljs-comment">// 4. 模拟发生错误</span>
  controller.addError(<span class="hljs-string">"信号丢失！"</span>);

  <span class="hljs-comment">// 5. 关流 (非常重要！！！)</span>
  <span class="hljs-comment">// 不关流会导致内存泄漏，因为监听者会一直干等着</span>
  controller.close();
}

</code></pre>
<h4 data-id="heading-16">3. 为什么它在 Flutter 中如此重要？</h4>
<p>几乎所有 Flutter 的状态管理库（BLoC, Provider, Riverpod 等）的底层，或多或少都用到了 <code>StreamController</code> 的思想。</p>
<ul>
<li><strong>UI 层</strong>：只管 <code>add</code> 事件（比如点击按钮）。</li>
<li><strong>逻辑层</strong>：通过 <code>Controller</code> 处理业务。</li>
<li><strong>UI 层</strong>：<code>StreamBuilder</code> 监听 <code>Controller.stream</code> 并刷新界面。</li>
</ul>
<p>这就是 <strong>“输入与输出分离”</strong> 的架构雏形。</p>
<hr/>
<h3 data-id="heading-17">三、 避坑指南：内存泄漏的隐患</h3>
<p>在使用 <code>StreamController</code> 时，有一个新手最容易犯的错误：<strong>忘了关流 (Close)</strong>。</p>
<ul>
<li><strong>原理</strong>：<code>StreamController</code> 在底层会持有监听者的引用。如果你的页面销毁了，但 Controller 没关闭，这个 Stream 依然认为“有人在听”，它不会释放资源，导致 <strong>内存泄漏 (Memory Leak)</strong>。</li>
<li><strong>铁律</strong>：在 Flutter 的 <code>dispose()</code> 方法中，一定要调用 <code>controller.close()</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-18">小结</h3>
<p>这一章我们完成了从“使用者”到“掌控者”的转变：</p>
<ol>
<li><strong>分清形态</strong>：</li>
</ol>
<ul>
<li><strong>单订阅</strong>（默认）：数据完整，一对一，错过即毁。</li>
<li><strong>广播</strong>（Broadcast）：实时性强，一对多，过时不候。</li>
</ul>
<ol>
<li><strong>掌握控制</strong>：</li>
</ol>
<ul>
<li>使用 <strong><code>StreamController</code></strong> 可以让我们在代码的任何地方主动地“推”数据，它是连接命令式代码（普通函数）和响应式代码（Stream）的桥梁。</li>
</ul>
<p>了解了形态和控制，下一章我们将进入 Stream 最强大的领域 —— <strong>数学般的魔法</strong>。
我们将探索如何像操作数组一样操作时间流：<code>map</code>、<code>where</code>、<code>debounce</code>（防抖）以及 <code>distinct</code>。这些操作符将彻底改变你写业务逻辑的方式。</p>
<h2 data-id="heading-19">第三章：流上建造流水线</h2>
<p>在上一章，我们学会了用 <code>StreamController</code> 制造传送带。但在真实开发中，原始数据往往是“脏”的或者“不符合 UI 胃口”的。</p>
<ul>
<li><strong>后端</strong>：推给你一堆 JSON 字符串。</li>
<li><strong>UI层</strong>：想要的是一个转换好的 <code>User</code> 对象。</li>
<li><strong>用户</strong>：手抖，一秒钟点了 5 次按钮。</li>
<li><strong>逻辑层</strong>：只希望处理最后一次点击。</li>
</ul>
<p>如果把这些逻辑都写在 <code>listen</code> 的回调里，代码会变成一坨乱麻。
Dart Stream 赋予了我们一种能力：<strong>在数据到达监听者之前，先在传送带上架设一排“机器手臂”，对数据进行全自动加工。</strong></p>
<p>这就是 <strong>操作符 (Operators)</strong>。</p>
<h3 data-id="heading-20">一、 熟悉的配方：从 List 到 Stream</h3>
<p>Dart 最优雅的设计之一，就是它让操作 Stream (时间流) 就像操作 List (静态数组) 一样简单。</p>
<p>如果你会用 <code>List</code> 的方法，你已经学会了 90% 的 Stream 操作。</p>
<h4 data-id="heading-21">1. 过滤与转换 (Where &amp; Map)</h4>
<p>想象传送带上流过来的是一堆数字 <code>1, 2, 3, 4, 5...</code>。</p>
<ul>
<li><strong>需求</strong>：我只想要偶数，而且要把它放大 10 倍。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">Stream&lt;<span class="hljs-built_in">int</span>&gt; rawStream = Stream.fromIterable([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]);

rawStream
    .where((event) =&gt; event % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) <span class="hljs-comment">// 机器手臂1：过滤。只放行偶数。</span>
    .map((event) =&gt; event * <span class="hljs-number">10</span>)       <span class="hljs-comment">// 机器手臂2：加工。变成原来的10倍。</span>
    .listen((data) {
      <span class="hljs-built_in">print</span>(data); <span class="hljs-comment">// 输出：20, 40</span>
    });

</code></pre>
<p><strong>底层原理</strong>：
每个操作符（<code>.where</code>, <code>.map</code>）本质上都返回了一个<strong>新的 Stream</strong>。
这就像接水管一样，我们把一节节短管子（操作符）拧在一起，构成了一条长长的处理管道。原始数据从一头进，经过层层净化，最后流出来的就是我们想要的纯净水。</p>
<h3 data-id="heading-22">二、 解决现实痛点：那些 Stream 独有的神技</h3>
<p>除了通用的 <code>map/where</code>，Stream 还有一些专门处理“时间轴”问题的神技。</p>
<h4 data-id="heading-23">1. 去重神技：<code>distinct</code></h4>
<ul>
<li><strong>场景</strong>：你要实现一个搜索框。用户想搜 "Flutter"，但他输入 "F", "Fl", "Flu"...</li>
<li><strong>痛点</strong>：如果用户输入了 "Flu"，停了一下，删掉 "u"，又输了一次 "u"。输入内容还是 "Flu"。如果不处理，你会发两次完全一样的网络请求。</li>
<li><strong>解法</strong>：</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">inputStream
    .distinct() <span class="hljs-comment">// 只有当新数据和上一次数据不一样时，才放行</span>
    .listen((text) =&gt; search(text));

</code></pre>
<p>它就像一个极其严格的质检员，拿着上一个通过的产品做对比，一样的直接扔掉。</p>
<h4 data-id="heading-24">2. 扁平化神技：<code>expand</code> 与 <code>asyncExpand</code></h4>
<p>这是一个高级但必用的操作符。</p>
<ul>
<li><strong>场景</strong>：Stream 里流过来的是“文件夹”，但监听者想要的是“文件”。
即：Stream 发出的每个数据，本身又包含了一组数据（Stream of List）。</li>
<li><strong>解法</strong>：<code>expand</code> 会把“流过来的每一个元素”炸开，变成一堆元素，然后重新铺平在传送带上。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 假设流过来的是：[1, 2], [3, 4]</span>
stream
  .expand((element) =&gt; element) 
  .listen(<span class="hljs-built_in">print</span>); 
<span class="hljs-comment">// 输出：1, 2, 3, 4 (变成了扁平的流)</span>

</code></pre>
<h3 data-id="heading-25">三、 终极武器：StreamTransformer</h3>
<p>有时候，官方提供的 <code>map</code>、<code>where</code> 不够用了。
比如，Socket 连接发过来的是<strong>字节流 (List&lt;int&gt;)</strong>，但你想按**“换行符”<strong>切分成一行行的</strong>文本流 (String)**。</p>
<p>这时候，你需要自定义一个“变压器” —— <strong>StreamTransformer</strong>。</p>
<p>它是 <code>stream.transform()</code> 方法的参数。Dart 官方贴心地在 <code>dart:convert</code> 库里内置了一些最常用的变压器：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:convert'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:io'</span>;

<span class="hljs-keyword">void</span> readFile() {
  File(<span class="hljs-string">'log.txt'</span>)
    .openRead() <span class="hljs-comment">// 原始流：一堆二进制字节</span>
    .transform(utf8.decoder) <span class="hljs-comment">// 变压器1：字节 -&gt; 字符串</span>
    .transform(<span class="hljs-keyword">const</span> LineSplitter()) <span class="hljs-comment">// 变压器2：一整块字符串 -&gt; 按换行符切开的一行行字符串</span>
    .listen((line) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">"读取到一行日志: <span class="hljs-subst">$line</span>"</span>);
    });
}

</code></pre>
<p><strong>底层逻辑</strong>：
<code>transform</code> 是将流的控制权完全交给你。你可以控制输入什么，缓存多少，什么时候输出，甚至可以把一个数据变成两个，或者把两个数据合并成一个。</p>
<h3 data-id="heading-26">四、 降维打击：RxDart 的防抖与节流</h3>
<p>讲到 Stream 操作符，如果不提 <strong>RxDart</strong>，那就是耍流氓。
虽然 Dart 原生库很强，但在处理复杂的交互事件时，RxDart 提供了“外挂”级别的操作符。</p>
<p>Flutter 面试必问的两大杀手锏：</p>
<ol>
<li><strong>防抖 (Debounce)</strong>：</li>
</ol>
<ul>
<li><strong>比喻</strong>：电梯关门。如果一直有人进电梯（事件一直来），电梯门就一直不关。只有当大家都不动了（间隔超过一定时间），电梯门才会关上（执行逻辑）。</li>
<li><strong>用途</strong>：搜索框联想。打字停顿 500ms 后再请求 API。</li>
</ul>
<ol>
<li><strong>节流 (Throttle)</strong>：</li>
</ol>
<ul>
<li><strong>比喻</strong>：机关枪射速限制。不管你扣扳机的手速有多快，子弹最快只能每秒发 10 发。</li>
<li><strong>用途</strong>：防止按钮连点。</li>
</ul>
<p><em>(注：RxDart 本质上就是把 StreamTransformer 封装好了给你用。)</em></p>
<h3 data-id="heading-27">小结</h3>
<p>这一章我们把 Stream 从“传输工具”升级成了“处理工具”。</p>
<ol>
<li><strong>管道思维</strong>：用 <code>map</code>、<code>where</code> 像搭积木一样处理数据。</li>
<li><strong>独有技能</strong>：用 <code>distinct</code> 过滤重复信号。</li>
<li><strong>高级定制</strong>：用 <code>transform</code> 处理复杂的数据转换（如二进制转文本）。</li>
</ol>
<p>现在，我们有了数据源（Controller），有了处理逻辑（Operators），有了监听者（Listen）。
<strong>但是，在 Flutter 的 UI 代码里写 <code>listen</code> 和 <code>setState</code> 依然很痛苦，很容易忘掉 <code>cancel</code> 导致内存泄漏。</strong></p>
<p>有没有一种 Widget，能直接把 Stream 插上去，它自己就会根据数据变来变去，还自动管理内存？</p>
<p>下一章，我们将介绍 Flutter 官方提供的终极组件 —— <strong>StreamBuilder</strong>，它是连接逻辑层与 UI 层的跨海大桥。</p>
<hr/>
<h2 data-id="heading-28">第四章：Flutter 实战——告别 setState，拥抱 StreamBuilder</h2>
<p>在前面的章节中，我们在纯 Dart 环境下把 Stream 玩出了花。但当我们回到 Flutter 的 Widget 世界时，会遇到一个尴尬的现实。</p>
<p><strong>痛点：手动管理的“地狱”</strong></p>
<p>如果你不用专门的工具，想在界面上显示一个 Stream 的数据，你需要写大量的模版代码：</p>
<ol>
<li>必须用 <code>StatefulWidget</code>。</li>
<li>在 <code>initState</code> 里手动 <code>listen</code>。</li>
<li>在回调里手动 <code>setState</code> 触发刷新。</li>
<li><strong>最要命的</strong>：必须在 <code>dispose</code> 里手动 <code>subscription.cancel()</code>。哪怕忘写一次，你的 App 就会在后台默默发生内存泄漏，直到崩溃。</li>
</ol>
<p>为了把开发者从这种重复劳动中解救出来，Flutter 提供了一个终极组件 —— <strong>StreamBuilder</strong>。</p>
<h3 data-id="heading-29">一、 什么是 StreamBuilder？</h3>
<p><code>StreamBuilder</code> 是一个 Widget，但它不画任何东西。它的唯一工作就是 <strong>“自动帮你看传送带”</strong>。</p>
<ul>
<li><strong>自动化</strong>：它负责 <code>listen</code>，它负责 <code>setState</code>，它负责 <code>dispose</code>。你完全不用管。</li>
<li><strong>响应式</strong>：传送带上每过来一个新数据，它就自动调用一次 <code>builder</code> 方法，重新画一遍子组件。</li>
</ul>
<h3 data-id="heading-30">二、 代码实战：一个最简单的电子表</h3>
<p>我们来做一个每秒更新时间的电子表。</p>
<p><strong>1. 准备 Stream（数据源）</strong></p>
<pre><code class="hljs language-dart" lang="dart">Stream&lt;<span class="hljs-built_in">String</span>&gt; getTimerStream() <span class="hljs-keyword">async</span>* {
  <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
    <span class="hljs-keyword">yield</span> <span class="hljs-built_in">DateTime</span>.now().toString().substring(<span class="hljs-number">11</span>, <span class="hljs-number">19</span>); <span class="hljs-comment">// 返回 "12:00:01"</span>
  }
}

</code></pre>
<p><strong>2. 使用 StreamBuilder（UI 构建）</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyClock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{ <span class="hljs-comment">// 注意：可以用 StatelessWidget 了！</span>
  <span class="hljs-keyword">final</span> Stream&lt;<span class="hljs-built_in">String</span>&gt; _timerStream = getTimerStream();

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      body: Center(
        child: StreamBuilder&lt;<span class="hljs-built_in">String</span>&gt;(
          stream: _timerStream, <span class="hljs-comment">// 1. 插上网线</span>
          builder: (context, snapshot) { <span class="hljs-comment">// 2. 根据快照画图</span>
            <span class="hljs-comment">// snapshot 包含了当前时刻 Stream 的所有信息</span>
            <span class="hljs-keyword">if</span> (snapshot.connectionState == ConnectionState.waiting) {
              <span class="hljs-keyword">return</span> CircularProgressIndicator(); <span class="hljs-comment">// 还没数据时显示转圈</span>
            }
            
            <span class="hljs-keyword">if</span> (snapshot.hasError) {
              <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'出错了: <span class="hljs-subst">${snapshot.error}</span>'</span>);
            }

            <span class="hljs-comment">// 有数据了！</span>
            <span class="hljs-keyword">return</span> Text(
              snapshot.data ?? <span class="hljs-string">'无数据'</span>,
              style: TextStyle(fontSize: <span class="hljs-number">30</span>),
            );
          },
        ),
      ),
    );
  }
}

</code></pre>
<p>看，我们甚至不需要 <code>StatefulWidget</code>！所有的状态变化都封装在了 <code>StreamBuilder</code> 内部。</p>
<h3 data-id="heading-31">三、 解剖核心：AsyncSnapshot (快照)</h3>
<p><code>builder</code> 回调函数里那个 <code>snapshot</code> 参数，是理解 <code>StreamBuilder</code> 的关键。</p>
<p>你可以把它想象成 <strong>“Stream 在这一瞬间的体检报告”</strong>。它包含三个核心指标：</p>
<ol>
<li><strong>ConnectionState (连接状态)</strong>：</li>
</ol>
<ul>
<li><code>none</code>: 没插网线（stream 为 null）。</li>
<li><code>waiting</code>: 插了网线，但第一个数据还没来（通常显示 Loading）。</li>
<li><code>active</code>: 数据正在源源不断地来（最主要的状态）。</li>
<li><code>done</code>: 传送带停了（Stream 关闭）。</li>
</ul>
<ol>
<li><strong>data (数据)</strong>：</li>
</ol>
<ul>
<li>如果不为 null，说明这就是最新拿到的数据。</li>
</ul>
<ol>
<li><strong>error (错误)</strong>：</li>
</ol>
<ul>
<li>如果不为 null，说明刚才流里传来了一个错误事件。</li>
</ul>
<p><strong>最佳实践写法</strong>：
不要只写一个 <code>return Text(...)</code>，一定要养成习惯处理三种状态：<strong>加载中、错误、正常显示</strong>。</p>
<pre><code class="hljs language-dart" lang="dart">builder: (context, snapshot) {
  <span class="hljs-keyword">if</span> (snapshot.hasError) <span class="hljs-keyword">return</span> ErrorWidget();
  <span class="hljs-keyword">switch</span> (snapshot.connectionState) {
    <span class="hljs-keyword">case</span> ConnectionState.waiting: <span class="hljs-keyword">return</span> LoadingWidget();
    <span class="hljs-keyword">case</span> ConnectionState.active:
    <span class="hljs-keyword">case</span> ConnectionState.done:
      <span class="hljs-keyword">return</span> DataWidget(snapshot.data);
    <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> SizedBox();
  }
}

</code></pre>
<h3 data-id="heading-32">四、 新手必踩的超级大坑</h3>
<p>在使用 <code>StreamBuilder</code> 时，90% 的新手会犯同一个错误：<strong>在 build 方法里创建 Stream</strong>。</p>
<p><strong>❌ 错误示范：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> StreamBuilder(
    <span class="hljs-comment">// 错！每次父组件刷新，build 都会跑一遍</span>
    <span class="hljs-comment">// 这一行就会创建一个全新的 Stream！</span>
    stream: createMyStream(), 
    builder: ...
  );
}

</code></pre>
<p><strong>💥 后果：</strong>
每次你的界面刷新（比如键盘弹起、父组件 setState），<code>createMyStream()</code> 就会重新执行。
这就意味着：<strong>原本的连接断开了，一个新的连接建立了。</strong>
你会看到 Loading 转圈圈无限闪烁，或者倒计时明明走到 5 了，突然又变回 10 重新开始。</p>
<p><strong>✅ 正确姿势：</strong>
Stream 实例的创建必须在 <code>build</code> 方法<strong>之外</strong>。</p>
<ol>
<li>如果是 <code>StatefulWidget</code>，在 <code>initState</code> 里创建。</li>
<li>如果是 BLoC/Provider 模式，Stream 应该由业务逻辑类提供，UI 只负责引用。</li>
</ol>
<h3 data-id="heading-33">小结</h3>
<p>这一章我们见证了 Stream 与 Flutter UI 的完美融合。</p>
<ul>
<li><strong>StreamBuilder</strong> 是连接逻辑层与 UI 层的<strong>万能适配器</strong>。</li>
<li><strong>AsyncSnapshot</strong> 是携带数据的<strong>快递盒</strong>，我们要学会检查盒子的状态（Waiting/Active/Error）。</li>
<li><strong>铁律</strong>：永远不要在 <code>build</code> 方法里创建 Stream，那是“一次性筷子”，用完就丢，会导致状态重置。</li>
</ul>
<p>到这里，关于 Stream 的基础、进阶和 UI 实战我们都讲完了。</p>
<p>但是，如果你正在开发一个中大型 APP，你会发现光有 Stream 还是不够。你需要一种架构模式，把 Stream 组织起来，让代码井井有条。
这就是 Flutter 官方推荐的 —— <strong>BLoC (Business Logic Component) 模式</strong>。</p>
<hr/>
<h2 data-id="heading-34">第五章：Flutter 实战——BLoC 模式，给你的代码定规矩</h2>
<p>经过前四章的学习，你手中已经握有了强大的武器：Stream，并且学会了 Stream 的所有招式（创建、变形、消费），是时候把它们组合成一套绝世武功了。</p>
<p>但你可能会发现一个新的问题：<strong>武器太灵活了，容易误伤自己。</strong></p>
<p>如果你在 UI Widget 里随便创建 Controller，在 <code>build</code> 方法里随意处理数据，很快你的代码就会变成一碗“意大利面”——逻辑和 UI 纠缠不清，难以维护，难以测试。</p>
<p>为了解决这个问题，Flutter 社区诞生了一种基于 Stream 的架构模式：<strong>BLoC (Business Logic Component)</strong>。</p>
<p>它的核心思想只有一句话：<strong>让 UI 只是 UI，让逻辑只是逻辑，两者通过 Stream 对话。</strong></p>
<h3 data-id="heading-35">一、 BLoC 的“黑盒模型”</h3>
<p>把 BLoC 想象成一台<strong>自动售货机</strong>。</p>
<ol>
<li><strong>输入 (Input)</strong>：你按下一个按钮（比如“购买可乐”）。这在 BLoC 里叫 <strong>Event (事件)</strong>。</li>
<li><strong>黑盒 (Processing)</strong>：机器内部听到指令，检查库存，扣除余额，驱动机械臂。这就是 <strong>Business Logic (业务逻辑)</strong>。</li>
<li><strong>输出 (Output)</strong>：机器吐出一听可乐，或者显示“余额不足”。这在 BLoC 里叫 <strong>State (状态)</strong>。</li>
</ol>
<p><strong>关键规则：</strong></p>
<ul>
<li>UI 组件（Widget）<strong>绝对不允许</strong>直接修改数据。</li>
<li>UI 只能做一件事：<strong>往 BLoC 的 Sink 里扔事件</strong>。</li>
<li>UI 只能听一件事：<strong>听 BLoC 的 Stream 里流出来的状态</strong>。</li>
</ul>
<h3 data-id="heading-36">二、 手写一个纯粹的 BLoC</h3>
<p>在引入第三方库之前，我们先用原生 Dart 代码写一个 BLoC，你会发现它本质上就是我们第二章学的 <code>StreamController</code> 的封装。</p>
<p>我们来重构之前的“电子表”或“计数器”。</p>
<p><strong>1. 定义 BLoC 类 (逻辑层)</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:async'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterBloc</span> </span>{
  <span class="hljs-comment">// 1. 状态流控制器 (Output)：告诉 UI 当前是几</span>
  <span class="hljs-comment">// 使用广播流，允许多个页面同时监听</span>
  <span class="hljs-keyword">final</span> _stateController = StreamController&lt;<span class="hljs-built_in">int</span>&gt;.broadcast();
  <span class="hljs-built_in">int</span> _count = <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 2. 暴露给外部的 Stream (只读)</span>
  Stream&lt;<span class="hljs-built_in">int</span>&gt; <span class="hljs-keyword">get</span> stream =&gt; _stateController.stream;

  <span class="hljs-comment">// 3. 事件入口 (Input)：UI 只能调这个方法</span>
  <span class="hljs-keyword">void</span> increment() {
    _count++;
    <span class="hljs-comment">// 逻辑处理完，把新状态推出去</span>
    _stateController.sink.add(_count); 
  }

  <span class="hljs-comment">// 4. 资源释放</span>
  <span class="hljs-keyword">void</span> dispose() {
    _stateController.close();
  }
}

</code></pre>
<p><strong>2. 在 UI 中使用 (视图层)</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CounterPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _CounterPageState createState() =&gt; _CounterPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CounterPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CounterPage</span>&gt; </span>{
  <span class="hljs-keyword">final</span> bloc = CounterBloc(); <span class="hljs-comment">// 创建 BLoC</span>

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    bloc.dispose(); <span class="hljs-comment">// 记得关流</span>
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">"BLoC 模式"</span>)),
      body: Center(
        <span class="hljs-comment">// 使用 StreamBuilder 监听 BLoC 的输出</span>
        child: StreamBuilder&lt;<span class="hljs-built_in">int</span>&gt;(
          stream: bloc.stream,
          initialData: <span class="hljs-number">0</span>,
          builder: (context, snapshot) {
            <span class="hljs-keyword">return</span> Text(
              <span class="hljs-string">'<span class="hljs-subst">${snapshot.data}</span>'</span>, 
              style: TextStyle(fontSize: <span class="hljs-number">40</span>)
            );
          },
        ),
      ),
      floatingActionButton: FloatingActionButton(
        <span class="hljs-comment">// UI 只负责触发动作</span>
        onPressed: () =&gt; bloc.increment(),
        child: Icon(Icons.add),
      ),
    );
  }
}

</code></pre>
<p><strong>看，代码清爽多了！</strong></p>
<ul>
<li><code>build</code> 方法里没有任何 <code>_count++</code> 这样的逻辑。</li>
<li>逻辑代码全在 <code>CounterBloc</code> 里，你可以不依赖 Flutter UI 直接对 <code>CounterBloc</code> 写单元测试。</li>
</ul>
<h3 data-id="heading-37">三、 进阶：为什么要用 <code>flutter_bloc</code> 库？</h3>
<p>虽然手写 BLoC 帮我们理清了原理，但实际开发中，手动管理 <code>StreamController</code> 的关闭、手动定义 Sink 和 Stream 还是太繁琐了。</p>
<p>于是，大神 <strong>Felix Angelov</strong> 开源了 <code>flutter_bloc</code> 库，它把这套流程标准化了。</p>
<p>在 <code>flutter_bloc</code> 库中：</p>
<ol>
<li><strong>不再需要手动写 Controller</strong>：库帮你封装好了。</li>
<li><strong>强制的 Event/State 定义</strong>：你必须先定义好所有的“动作”和“结果”，强制代码规范。</li>
<li><strong>BlocBuilder</strong>：它就是 <code>StreamBuilder</code> 的亲儿子，专门用来简化 BLoC 的监听。</li>
</ol>
<h3 data-id="heading-38">四、 BLoC 的哲学意义</h3>
<p>学习 BLoC，实际上是在学习一种 <strong>“单向数据流” (Unidirectional Data Flow)</strong> 的思想。</p>
<ul>
<li><strong>没有 BLoC 时</strong>：数据满天飞，A 组件改了 B 的数据，C 组件又回调了 A 的方法。出了 Bug 根本找不到源头。</li>
<li><strong>有了 BLoC 后</strong>：</li>
<li>数据永远是 <strong>从上往下流</strong> (Stream)。</li>
<li>事件永远是 <strong>从下往上发</strong> (Sink)。</li>
<li>形成了一个完美的闭环。</li>
</ul>
<h3 data-id="heading-39">五、 全剧终：Stream 学习之路</h3>
<p>恭喜你！从第一章的 <code>Future</code> 单次请求，到 <code>Stream</code> 的传送带模型，再到 <code>StreamController</code> 的手动控制，最后上升到 <code>BLoC</code> 的架构模式。</p>
<p>你已经走完了 Dart 异步编程最核心的旅程。</p>
<p><strong>回顾一下我们的成就：</strong></p>
<ol>
<li><strong>底层原理</strong>：你懂了 <code>yield</code> 暂停机制，知道了异步不是魔法，是状态机的切换。</li>
<li><strong>内存模型</strong>：你分清了单订阅和广播，知道如何避免内存泄漏。</li>
<li><strong>工具箱</strong>：你掌握了 <code>map</code>, <code>where</code>, <code>debounce</code> 等操作符，能像做手术一样处理数据。</li>
<li><strong>架构思维</strong>：你学会了用 Stream 将 UI 和逻辑彻底分离。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[专业指南：从核心概念到3D动效实现]]></title>    <link>https://juejin.cn/post/7600489282839871498</link>    <guid>https://juejin.cn/post/7600489282839871498</guid>    <pubDate>2026-01-29T10:03:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282839871498" data-draft-id="7600616270002602022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="专业指南：从核心概念到3D动效实现"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-01-29T10:03:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lee川"/> <meta itemprop="url" content="https://juejin.cn/user/2402874087453658"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            专业指南：从核心概念到3D动效实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2402874087453658/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lee川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:03:00.000Z" title="Thu Jan 29 2026 10:03:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS3 专业指南：从核心概念到3D动效实现</h2>
<h3 data-id="heading-1">引言：CSS3的演进与现代化布局体系</h3>
<p>CSS3不仅是CSS2.1的简单扩展，而是Web样式设计的一次革命性升级。自2011年开始逐步标准化，CSS3引入了模块化设计理念，将样式规范拆分为独立模块，每个模块可以独立演进。这种设计使得Flexbox、Grid、动画、变换等现代特性得以快速发展，彻底改变了前端开发者的工作方式。</p>
<h3 data-id="heading-2">一、CSS3核心模块架构</h3>
<h4 data-id="heading-3">1.1 选择器模块：精准元素定位</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 属性选择器 - 精准匹配 */</span>
<span class="hljs-selector-tag">input</span><span class="hljs-selector-attr">[type=<span class="hljs-string">"email"</span>]</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#3498db</span>;
}

<span class="hljs-comment">/* 结构伪类选择器 */</span>
<span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>n) { <span class="hljs-comment">/* 偶数项 */</span>
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f8f9fa</span>;
}

<span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:nth-child</span>(odd) { <span class="hljs-comment">/* 奇数项 */</span>
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e9ecef</span>;
}

<span class="hljs-comment">/* 目标伪类 */</span>
<span class="hljs-selector-tag">section</span><span class="hljs-selector-pseudo">:target</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff3cd</span>;
  <span class="hljs-attribute">animation</span>: highlight <span class="hljs-number">1s</span> ease;
}

<span class="hljs-comment">/* 否定伪类 */</span>
<span class="hljs-selector-tag">div</span><span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-class">.exclude</span>) {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span>;
}

<span class="hljs-comment">/* 状态伪类 */</span>
<span class="hljs-selector-tag">input</span><span class="hljs-selector-pseudo">:focus</span>-within {
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">52</span>, <span class="hljs-number">152</span>, <span class="hljs-number">219</span>, <span class="hljs-number">0.3</span>);
}
</code></pre>
<h4 data-id="heading-4">1.2 盒模型增强：多列布局实践</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 经典多列布局 */</span>
<span class="hljs-selector-class">.article-content</span> {
  <span class="hljs-attribute">column-count</span>: <span class="hljs-number">3</span>;
  <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">2em</span>;
  <span class="hljs-attribute">column-rule</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#dee2e6</span>;
  <span class="hljs-attribute">column-width</span>: <span class="hljs-number">300px</span>;
  
  <span class="hljs-comment">/* 避免元素跨列断开 */</span>
  <span class="hljs-attribute">break-inside</span>: avoid;
}

<span class="hljs-comment">/* 列间平衡优化 */</span>
<span class="hljs-selector-class">.balanced-columns</span> {
  <span class="hljs-attribute">column-count</span>: <span class="hljs-number">3</span>;
  <span class="hljs-attribute">column-fill</span>: balance; <span class="hljs-comment">/* 列高尽量平衡 */</span>
}

<span class="hljs-comment">/* 响应式多列 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.article-content</span> {
    <span class="hljs-attribute">column-count</span>: <span class="hljs-number">2</span>;
  }
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">480px</span>) {
  <span class="hljs-selector-class">.article-content</span> {
    <span class="hljs-attribute">column-count</span>: <span class="hljs-number">1</span>;
  }
}
</code></pre>
<h3 data-id="heading-5">二、Flexbox：一维布局的革命</h3>
<h4 data-id="heading-6">2.1 Flex容器与项目的基础配置</h4>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-attribute">flex</span>-container"&gt;
  &lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-attribute">flex</span>-item"&gt;项目<span class="hljs-number">1</span>&lt;/<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-attribute">flex</span>-item"&gt;项目<span class="hljs-number">2</span>&lt;/<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-attribute">flex</span>-item"&gt;项目<span class="hljs-number">3</span>&lt;/<span class="hljs-selector-tag">div</span>&gt;
&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.flex-container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: row; <span class="hljs-comment">/* 主轴方向: row | row-reverse | column | column-reverse */</span>
  <span class="hljs-attribute">flex-wrap</span>: wrap; <span class="hljs-comment">/* 换行: nowrap | wrap | wrap-reverse */</span>
  <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/* 主轴对齐 */</span>
  <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* 交叉轴对齐 */</span>
  <span class="hljs-attribute">align-content</span>: stretch; <span class="hljs-comment">/* 多行对齐 */</span>
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>; <span class="hljs-comment">/* 项目间距 */</span>
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.flex-item</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-number">200px</span>; <span class="hljs-comment">/* grow | shrink | basis */</span>
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.9</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">font-weight</span>: bold;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.flex-item</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}
</code></pre>
<h4 data-id="heading-7">2.2 Flex项目的高级控制</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 项目排序控制 */</span>
<span class="hljs-selector-class">.flex-item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) { <span class="hljs-attribute">order</span>: <span class="hljs-number">3</span>; }
<span class="hljs-selector-class">.flex-item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) { <span class="hljs-attribute">order</span>: <span class="hljs-number">1</span>; }
<span class="hljs-selector-class">.flex-item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) { <span class="hljs-attribute">order</span>: <span class="hljs-number">2</span>; }

<span class="hljs-comment">/* 项目对齐覆盖 */</span>
<span class="hljs-selector-class">.flex-item</span><span class="hljs-selector-class">.special</span> {
  <span class="hljs-attribute">align-self</span>: flex-start; <span class="hljs-comment">/* 覆盖容器align-items */</span>
  <span class="hljs-attribute">flex-grow</span>: <span class="hljs-number">2</span>; <span class="hljs-comment">/* 比其他项目多占空间 */</span>
}

<span class="hljs-comment">/* 响应式Flex调整 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.flex-container</span> {
    <span class="hljs-attribute">flex-direction</span>: column;
  }
  
  <span class="hljs-selector-class">.flex-item</span> {
    <span class="hljs-attribute">flex-basis</span>: auto;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  }
}
</code></pre>
<h3 data-id="heading-8">三、CSS Grid：二维布局的终极解决方案</h3>
<h4 data-id="heading-9">3.1 网格系统基础架构</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fit, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">250px</span>, <span class="hljs-number">1</span>fr));
  <span class="hljs-attribute">grid-template-rows</span>: auto;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">1.5rem</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fa</span>;
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">400px</span>;
}

<span class="hljs-selector-class">.grid-item</span> {
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1.5rem</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">6px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">1</span>);
}

<span class="hljs-comment">/* 显式网格定位 */</span>
<span class="hljs-selector-class">.grid-item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">1</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">/* 跨越两列 */</span>
  <span class="hljs-attribute">grid-row</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-selector-class">.grid-item</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) {
  <span class="hljs-attribute">grid-column</span>: <span class="hljs-number">3</span>;
  <span class="hljs-attribute">grid-row</span>: <span class="hljs-number">1</span> / <span class="hljs-number">3</span>; <span class="hljs-comment">/* 跨越两行 */</span>
}

<span class="hljs-comment">/* 隐式网格行为 */</span>
<span class="hljs-selector-class">.grid-container</span> {
  <span class="hljs-attribute">grid-auto-flow</span>: dense; <span class="hljs-comment">/* 自动填充空白 */</span>
  <span class="hljs-attribute">grid-auto-rows</span>: <span class="hljs-built_in">minmax</span>(<span class="hljs-number">150px</span>, auto); <span class="hljs-comment">/* 隐式行高 */</span>
}
</code></pre>
<h4 data-id="heading-10">3.2 高级网格布局模式</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 杂志式布局 */</span>
<span class="hljs-selector-class">.magazine-layout</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-areas</span>:
    <span class="hljs-string">"header header header"</span>
    <span class="hljs-string">"sidebar content ads"</span>
    <span class="hljs-string">"footer footer footer"</span>;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">200px</span> <span class="hljs-number">1</span>fr <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">grid-template-rows</span>: auto <span class="hljs-number">1</span>fr auto;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
}

<span class="hljs-selector-class">.header</span> { <span class="hljs-attribute">grid-area</span>: header; <span class="hljs-attribute">background</span>: <span class="hljs-number">#2c3e50</span>; <span class="hljs-attribute">color</span>: white; }
<span class="hljs-selector-class">.sidebar</span> { <span class="hljs-attribute">grid-area</span>: sidebar; <span class="hljs-attribute">background</span>: <span class="hljs-number">#ecf0f1</span>; }
<span class="hljs-selector-class">.content</span> { <span class="hljs-attribute">grid-area</span>: content; <span class="hljs-attribute">background</span>: white; }
<span class="hljs-selector-class">.ads</span> { <span class="hljs-attribute">grid-area</span>: ads; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f1c40f</span>; }
<span class="hljs-selector-class">.footer</span> { <span class="hljs-attribute">grid-area</span>: footer; <span class="hljs-attribute">background</span>: <span class="hljs-number">#34495e</span>; <span class="hljs-attribute">color</span>: white; }

<span class="hljs-comment">/* 响应式网格调整 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">1024px</span>) {
  <span class="hljs-selector-class">.magazine-layout</span> {
    <span class="hljs-attribute">grid-template-areas</span>:
      <span class="hljs-string">"header"</span>
      <span class="hljs-string">"sidebar"</span>
      <span class="hljs-string">"content"</span>
      <span class="hljs-string">"ads"</span>
      <span class="hljs-string">"footer"</span>;
    <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr;
    <span class="hljs-attribute">grid-template-rows</span>: auto;
  }
}
</code></pre>
<h3 data-id="heading-11">四、水平垂直居中：全方位解决方案</h3>
<h4 data-id="heading-12">4.1 传统居中方案</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 方案1：绝对定位 + transform */</span>
<span class="hljs-selector-class">.centered-1</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3498db</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-comment">/* 方案2：表格单元格 */</span>
<span class="hljs-selector-class">.parent-table</span> {
  <span class="hljs-attribute">display</span>: table;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#ecf0f1</span>;
}

<span class="hljs-selector-class">.child-table</span> {
  <span class="hljs-attribute">display</span>: table-cell;
  <span class="hljs-attribute">vertical-align</span>: middle;
  <span class="hljs-attribute">text-align</span>: center;
}
</code></pre>
<h4 data-id="heading-13">4.2 现代居中方案</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 方案3：Flexbox居中 */</span>
<span class="hljs-selector-class">.parent-flex</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">45deg</span>, <span class="hljs-number">#ff9a9e</span>, <span class="hljs-number">#fad0c4</span>);
}

<span class="hljs-selector-class">.child-flex</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">40px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}

<span class="hljs-comment">/* 方案4：Grid居中 */</span>
<span class="hljs-selector-class">.parent-grid</span> {
  <span class="hljs-attribute">display</span>: grid;
  place-items: center; <span class="hljs-comment">/* 一行代码实现居中 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
}

<span class="hljs-comment">/* 方案5：Margin auto (块级元素) */</span>
<span class="hljs-selector-class">.block-centered</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">50px</span> auto;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#2ecc71</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
}
</code></pre>
<h4 data-id="heading-14">4.3 文本居中与行内元素</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 文本水平居中 */</span>
<span class="hljs-selector-class">.text-center</span> {
  <span class="hljs-attribute">text-align</span>: center;
}

<span class="hljs-comment">/* 行内元素居中 */</span>
<span class="hljs-selector-class">.inline-parent</span> {
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* 单行文本垂直居中 */</span>
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fa</span>;
}

<span class="hljs-comment">/* 多行文本垂直居中 */</span>
<span class="hljs-selector-class">.multiline-center</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff3cd</span>;
}
</code></pre>
<h3 data-id="heading-15">五、CSS3变换与过渡：交互动效基础</h3>
<h4 data-id="heading-16">5.1 2D变换系统</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.transform-demo</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">45deg</span>, <span class="hljs-number">#ff6b6b</span>, <span class="hljs-number">#4ecdc4</span>);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.68</span>, -<span class="hljs-number">0.55</span>, <span class="hljs-number">0.265</span>, <span class="hljs-number">1.55</span>);
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">font-weight</span>: bold;
}

<span class="hljs-comment">/* 旋转变换 */</span>
<span class="hljs-selector-class">.transform-demo</span><span class="hljs-selector-class">.rotate</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">45deg</span>);
}

<span class="hljs-comment">/* 缩放变换 */</span>
<span class="hljs-selector-class">.transform-demo</span><span class="hljs-selector-class">.scale</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.2</span>);
}

<span class="hljs-comment">/* 倾斜变换 */</span>
<span class="hljs-selector-class">.transform-demo</span><span class="hljs-selector-class">.skew</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">skew</span>(<span class="hljs-number">15deg</span>, <span class="hljs-number">15deg</span>);
}

<span class="hljs-comment">/* 多重变换 */</span>
<span class="hljs-selector-class">.transform-demo</span><span class="hljs-selector-class">.multiple</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">15deg</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.1</span>) <span class="hljs-built_in">translateX</span>(<span class="hljs-number">20px</span>);
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">40px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);
}

<span class="hljs-comment">/* 变换原点控制 */</span>
<span class="hljs-selector-class">.transform-demo</span><span class="hljs-selector-class">.origin</span> {
  <span class="hljs-attribute">transform-origin</span>: top left; <span class="hljs-comment">/* 左上角为变换原点 */</span>
}
</code></pre>
<h4 data-id="heading-17">5.2 过渡动画高级应用</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 复杂过渡效果 */</span>
<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.6s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.175</span>, <span class="hljs-number">0.885</span>, <span class="hljs-number">0.32</span>, <span class="hljs-number">1.275</span>);
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">15px</span> <span class="hljs-number">35px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}

<span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">20px</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.05</span>);
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">30px</span> <span class="hljs-number">60px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);
}

<span class="hljs-selector-class">.card-content</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">50px</span>);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span> ease <span class="hljs-number">0.2s</span>; <span class="hljs-comment">/* 延迟触发 */</span>
}

<span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-class">.card-content</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>);
}

<span class="hljs-comment">/* 过渡性能优化 */</span>
<span class="hljs-selector-class">.optimized-transition</span> {
  <span class="hljs-comment">/* 使用transform和opacity以获得GPU加速 */</span>
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease, opacity <span class="hljs-number">0.3s</span> ease;
  
  <span class="hljs-comment">/* 避免动画布局抖动 */</span>
  <span class="hljs-attribute">will-change</span>: transform, opacity;
}
</code></pre>
<h3 data-id="heading-18">六、CSS3 3D变换：深度与空间感</h3>
<h4 data-id="heading-19">6.1 3D变换基础</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"scene"</span>&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"cube"</span>&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"face front"</span>&gt;前面&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"face back"</span>&gt;后面&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"face right"</span>&gt;右面&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"face left"</span>&gt;左面&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"face top"</span>&gt;上面&lt;/div&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"face bottom"</span>&gt;下面&lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 3D场景设置 */</span>
<span class="hljs-selector-class">.scene</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">perspective</span>: <span class="hljs-number">1000px</span>; <span class="hljs-comment">/* 透视距离，值越小3D效果越强 */</span>
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">100px</span> auto;
}

<span class="hljs-comment">/* 3D容器 */</span>
<span class="hljs-selector-class">.cube</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">transform-style</span>: preserve-<span class="hljs-number">3</span>d; <span class="hljs-comment">/* 保持3D空间 */</span>
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">1s</span> ease-in-out;
  <span class="hljs-attribute">animation</span>: rotateCube <span class="hljs-number">10s</span> infinite linear;
}

<span class="hljs-comment">/* 立方体面 */</span>
<span class="hljs-selector-class">.face</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">52</span>, <span class="hljs-number">152</span>, <span class="hljs-number">219</span>, <span class="hljs-number">0.8</span>);
  <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> solid white;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5rem</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">font-weight</span>: bold;
  <span class="hljs-attribute">backface-visibility</span>: visible;
}

<span class="hljs-comment">/* 各面定位 */</span>
<span class="hljs-selector-class">.front</span>  { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">0deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>); }
<span class="hljs-selector-class">.back</span>   { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">180deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>); }
<span class="hljs-selector-class">.right</span>  { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">90deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>); }
<span class="hljs-selector-class">.left</span>   { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(-<span class="hljs-number">90deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>); }
<span class="hljs-selector-class">.top</span>    { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">90deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>); }
<span class="hljs-selector-class">.bottom</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(-<span class="hljs-number">90deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>); }

<span class="hljs-comment">/* 立方体旋转动画 */</span>
<span class="hljs-keyword">@keyframes</span> rotateCube {
  <span class="hljs-number">0%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">rotateZ</span>(<span class="hljs-number">0</span>); }
  <span class="hljs-number">25%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">90deg</span>) <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">180deg</span>); }
  <span class="hljs-number">50%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">180deg</span>) <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">360deg</span>); }
  <span class="hljs-number">75%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">270deg</span>) <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">540deg</span>); }
  <span class="hljs-number">100%</span> { <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">360deg</span>) <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">720deg</span>); }
}

<span class="hljs-comment">/* 交互式旋转 */</span>
<span class="hljs-selector-class">.cube</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">animation-play-state</span>: paused;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">45deg</span>) <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">45deg</span>);
}
</code></pre>
<h4 data-id="heading-20">6.2 3D卡片翻转效果</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 3D卡片翻转 */</span>
<span class="hljs-selector-class">.flip-card</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">perspective</span>: <span class="hljs-number">1000px</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-class">.flip-card-inner</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.8s</span>;
  <span class="hljs-attribute">transform-style</span>: preserve-<span class="hljs-number">3</span>d;
}

<span class="hljs-selector-class">.flip-card</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-class">.flip-card-inner</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">180deg</span>);
}

<span class="hljs-selector-class">.flip-card-front</span>,
<span class="hljs-selector-class">.flip-card-back</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">backface-visibility</span>: hidden;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">15px</span> <span class="hljs-number">35px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
}

<span class="hljs-selector-class">.flip-card-front</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">45deg</span>, <span class="hljs-number">#ff6b6b</span>, <span class="hljs-number">#4ecdc4</span>);
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">2rem</span>;
}

<span class="hljs-selector-class">.flip-card-back</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">45deg</span>, <span class="hljs-number">#667eea</span>, <span class="hljs-number">#764ba2</span>);
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">180deg</span>);
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">2rem</span>;
  <span class="hljs-attribute">color</span>: white;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">justify-content</span>: center;
}
</code></pre>
<h3 data-id="heading-21">七、CSS动画系统：关键帧动画详解</h3>
<h4 data-id="heading-22">7.1 复杂关键帧动画</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 多阶段动画 */</span>
<span class="hljs-keyword">@keyframes</span> multiStep {
  <span class="hljs-number">0%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1</span>);
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff6b6b</span>;
  }
  <span class="hljs-number">25%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">100px</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.2</span>);
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#4ecdc4</span>;
  }
  <span class="hljs-number">50%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">200px</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1</span>);
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#45b7d1</span>;
  }
  <span class="hljs-number">75%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">100px</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.8</span>);
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#96ceb4</span>;
  }
  <span class="hljs-number">100%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1</span>);
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ff6b6b</span>;
  }
}

<span class="hljs-selector-class">.animated-box</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">animation</span>: multiStep <span class="hljs-number">4s</span> ease-in-out infinite;
  <span class="hljs-attribute">animation-fill-mode</span>: both;
}

<span class="hljs-comment">/* 动画控制 */</span>
<span class="hljs-selector-class">.paused</span> {
  <span class="hljs-attribute">animation-play-state</span>: paused;
}

<span class="hljs-selector-class">.slow</span> {
  <span class="hljs-attribute">animation-duration</span>: <span class="hljs-number">8s</span>;
  <span class="hljs-attribute">animation-timing-function</span>: ease-in;
}

<span class="hljs-selector-class">.alternate</span> {
  <span class="hljs-attribute">animation-direction</span>: alternate;
}
</code></pre>
<h4 data-id="heading-23">7.2 性能优化的动画实践</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* GPU加速动画 */</span>
<span class="hljs-selector-class">.gpu-animated</span> {
  <span class="hljs-comment">/* 使用transform和opacity触发GPU加速 */</span>
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0</span>);
  <span class="hljs-attribute">will-change</span>: transform, opacity;
  
  <span class="hljs-attribute">animation</span>: smoothSlide <span class="hljs-number">2s</span> ease-in-out infinite;
}

<span class="hljs-keyword">@keyframes</span> smoothSlide {
  <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0</span>);
  }
  <span class="hljs-number">50%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">100px</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0</span>);
  }
}

<span class="hljs-comment">/* 减少重绘的动画 */</span>
<span class="hljs-selector-class">.optimized-animation</span> {
  <span class="hljs-comment">/* 只动画transform和opacity属性 */</span>
  <span class="hljs-attribute">animation</span>: optimizedMove <span class="hljs-number">3s</span> infinite;
  
  <span class="hljs-comment">/* 创建独立的合成层 */</span>
  <span class="hljs-attribute">backface-visibility</span>: hidden;
  -webkit-<span class="hljs-attribute">font-smoothing</span>: subpixel-antialiased;
}

<span class="hljs-keyword">@keyframes</span> optimizedMove {
  <span class="hljs-number">0%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1</span>);
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
  }
  <span class="hljs-number">100%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">300px</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.5</span>);
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.8</span>;
  }
}
</code></pre>
<h3 data-id="heading-24">八、现代CSS特性与最佳实践</h3>
<h4 data-id="heading-25">8.1 CSS自定义属性（CSS变量）</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--primary-color</span>: <span class="hljs-number">#3498db</span>;
  <span class="hljs-attr">--secondary-color</span>: <span class="hljs-number">#2ecc71</span>;
  <span class="hljs-attr">--spacing-unit</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attr">--border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attr">--transition-speed</span>: <span class="hljs-number">0.3s</span>;
  <span class="hljs-attr">--box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">30px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
  <span class="hljs-attr">--gradient-bg</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-built_in">var</span>(--primary-color), <span class="hljs-built_in">var</span>(--secondary-color));
}

<span class="hljs-selector-class">.component</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--gradient-bg);
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--spacing-unit) * <span class="hljs-number">3</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">var</span>(--border-radius);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-built_in">var</span>(--transition-speed) ease;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-built_in">var</span>(--box-shadow);
}

<span class="hljs-selector-class">.component</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attr">--primary-color</span>: <span class="hljs-number">#2980b9</span>; <span class="hljs-comment">/* 动态修改变量 */</span>
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">40px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>);
}

<span class="hljs-comment">/* JS与CSS变量交互 */</span>
const element = document<span class="hljs-selector-class">.querySelector</span>('<span class="hljs-selector-class">.component</span>');
element<span class="hljs-selector-class">.style</span><span class="hljs-selector-class">.setProperty</span>('<span class="hljs-attr">--primary-color</span>', '<span class="hljs-selector-id">#e74c3c</span>');
</code></pre>
<h4 data-id="heading-26">8.2 现代布局技术整合</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 现代响应式布局系统 */</span>
<span class="hljs-selector-class">.modern-layout</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: 
    [full-start] <span class="hljs-built_in">minmax</span>(<span class="hljs-built_in">var</span>(--spacing-unit), <span class="hljs-number">1</span>fr) 
    [content-start] <span class="hljs-built_in">min</span>(<span class="hljs-number">100%</span> - <span class="hljs-number">2rem</span>, <span class="hljs-number">1200px</span>) 
    [content-end] <span class="hljs-built_in">minmax</span>(<span class="hljs-built_in">var</span>(--spacing-unit), <span class="hljs-number">1</span>fr) 
    [full-end];
  
  <span class="hljs-attribute">gap</span>: <span class="hljs-built_in">var</span>(--spacing-unit);
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">grid-column</span>: content;
  
  <span class="hljs-comment">/* 内部使用Flexbox */</span>
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-wrap</span>: wrap;
  <span class="hljs-attribute">gap</span>: <span class="hljs-built_in">var</span>(--spacing-unit);
}

<span class="hljs-comment">/* 子元素使用CSS Grid自动布局 */</span>
<span class="hljs-selector-class">.sub-item</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(auto-fill, <span class="hljs-built_in">minmax</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">1</span>fr));
  <span class="hljs-attribute">gap</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--spacing-unit) * <span class="hljs-number">2</span>);
}

<span class="hljs-comment">/* 容器查询（前沿特性） */</span>
<span class="hljs-keyword">@container</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">400px</span>) {
  <span class="hljs-selector-class">.card</span> {
    <span class="hljs-attribute">display</span>: grid;
    <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">2</span>fr;
  }
}
</code></pre>
<h3 data-id="heading-27">九、性能优化与最佳实践</h3>
<h4 data-id="heading-28">9.1 渲染性能优化</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 硬件加速技巧 */</span>
<span class="hljs-selector-class">.optimized-element</span> {
  <span class="hljs-comment">/* 触发GPU加速 */</span>
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0</span>);
  <span class="hljs-attribute">backface-visibility</span>: hidden;
  <span class="hljs-attribute">perspective</span>: <span class="hljs-number">1000px</span>;
  
  <span class="hljs-comment">/* 减少布局抖动 */</span>
  <span class="hljs-attribute">will-change</span>: transform, opacity;
  
  <span class="hljs-comment">/* 优化动画性能 */</span>
  <span class="hljs-attribute">animation</span>: optimizedAnimation <span class="hljs-number">0.3s</span> ease forwards;
}

<span class="hljs-keyword">@keyframes</span> optimizedAnimation {
  <span class="hljs-selector-tag">from</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">20px</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">0.95</span>);
  }
  <span class="hljs-selector-tag">to</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1</span>);
  }
}

<span class="hljs-comment">/* 减少重排和重绘 */</span>
<span class="hljs-selector-class">.stable-layout</span> {
  <span class="hljs-comment">/* 避免频繁修改会引起重排的属性 */</span>
  <span class="hljs-attribute">position</span>: fixed; <span class="hljs-comment">/* 脱离文档流 */</span>
  
  <span class="hljs-comment">/* 使用transform代替top/left */</span>
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-comment">/* 使用content-visibility优化渲染 */</span>
<span class="hljs-selector-class">.large-list</span> {
  <span class="hljs-attribute">content-visibility</span>: auto;
  <span class="hljs-attribute">contain</span>-intrinsic-size: <span class="hljs-number">0</span> <span class="hljs-number">500px</span>; <span class="hljs-comment">/* 预估高度 */</span>
}
</code></pre>
<h4 data-id="heading-29">9.2 现代CSS工作流程</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/* 层叠层管理 */</span>
<span class="hljs-variable">@layer</span> base, components, utilities;

<span class="hljs-variable">@layer</span> base {
  <span class="hljs-comment">/* 重置样式和基础样式 */</span>
  * { <span class="hljs-attribute">box-sizing</span>: border-box; }
  body { <span class="hljs-attribute">font-family</span>: system-ui, sans-serif; }
}

<span class="hljs-variable">@layer</span> components {
  <span class="hljs-comment">/* 组件样式 */</span>
  <span class="hljs-selector-class">.card</span> { <span class="hljs-comment">/* 卡片组件样式 */</span> }
  .button { <span class="hljs-comment">/* 按钮组件样式 */</span> }
}

<span class="hljs-variable">@layer</span> utilities {
  <span class="hljs-comment">/* 工具类 */</span>
  <span class="hljs-selector-class">.text-center</span> { <span class="hljs-attribute">text-align</span>: center; }
  .flex-center { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">justify-content</span>: center; }
}

<span class="hljs-comment">/* 容器查询支持 */</span>
<span class="hljs-variable">@container</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">400px</span>) {
  <span class="hljs-selector-class">.responsive-card</span> {
    <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">2</span>fr;
  }
}

<span class="hljs-comment">/* 媒体查询的现代写法 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">width</span> &gt;= <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.responsive-element</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.125rem</span>;
  }
}
</code></pre>
<h3 data-id="heading-30">结论：CSS3的演进与未来趋势</h3>
<p>CSS3的发展已经从简单的样式描述语言演变为功能强大的布局和动画引擎。通过掌握Flexbox和Grid，我们可以构建响应式、灵活的布局系统；通过transform、transition和animation，我们可以创建流畅的交互动效；通过3D变换，我们可以为Web应用增加深度和空间感。</p>
<p><strong>关键要点总结：</strong></p>
<ol>
<li><strong>布局选择</strong>：Flexbox用于一维布局，Grid用于二维布局</li>
<li><strong>居中策略</strong>：根据上下文选择最合适的居中方案</li>
<li><strong>动画优化</strong>：优先使用transform和opacity，减少布局抖动</li>
<li><strong>性能优先</strong>：合理使用GPU加速，避免强制同步布局</li>
<li><strong>渐进增强</strong>：使用特性检测，为不支持的环境提供降级方案</li>
</ol>
<p>随着CSS Container Queries、Subgrid、CSS Nesting等新特性的逐步落地，CSS的能力边界还在不断扩展。作为前端开发者，持续学习并掌握这些现代CSS特性，是构建高性能、高用户体验Web应用的关键所在。</p>
<p><strong>学习路径建议：</strong></p>
<ol>
<li>掌握基础选择器和盒模型</li>
<li>深入学习Flexbox和Grid布局</li>
<li>实践变换和过渡效果</li>
<li>探索关键帧动画和3D变换</li>
<li>学习性能优化和现代工作流程</li>
</ol>
<p>通过不断实践和探索，你将能够利用CSS3的强大功能，创造出既美观又高性能的现代Web界面。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JAVA基础之集合框架详解]]></title>    <link>https://juejin.cn/post/7600606150732103723</link>    <guid>https://juejin.cn/post/7600606150732103723</guid>    <pubDate>2026-01-29T10:03:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600606150732103723" data-draft-id="7600602502633242665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JAVA基础之集合框架详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T10:03:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JAVA基础之集合框架详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:03:38.000Z" title="Thu Jan 29 2026 10:03:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>参考文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fxiaoxi%2Fp%2F6089984.html" target="_blank" title="https://www.cnblogs.com/xiaoxi/p/6089984.html" ref="nofollow noopener noreferrer">www.cnblogs.com/xiaoxi/p/60…</a></p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.importnew.com%2F16658.html" target="_blank" title="http://www.importnew.com/16658.html" ref="nofollow noopener noreferrer">www.importnew.com/16658.html</a></p>
<h2 data-id="heading-0">1.集合框架图</h2>
<h4 data-id="heading-1">Java的集合类主要由两个接口派生而出：Collection和Map，Collection和Map是Java集合框架的根接口，这两个接口又包含了一些子接口或实现类。</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/697c837ae9cf450ca74064612d25ed19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=ktZDBq44rLzl07tuBB2pgPKl8CU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">2.Collection接口（Collection包含了List和Set两大分支。）</h2>
<h4 data-id="heading-3">2.1 List接口的实现类（ArrayList，Vector，LinkedList，Stack）</h4>
<h6 data-id="heading-4">(1).ArrayList</h6>
<p>ArrayList是一个动态数组,它允许任何符合规则的元素插入甚至包括null,每一个ArrayList都有一个初始容量（10）,随着容器中的元素不断增加，容器的大小也会随着增加。在每次向容器中增加元素的同时都会进行容量检查，当快溢出时，就会进行扩容操作。所以如果我们明确所插入元素的多少，最好指定一个初始容量值，避免过多的进行扩容操作而浪费时间、效率。</p>
<h6 data-id="heading-5">注意：  ArrayList擅长于随机访问。同时ArrayList是非同步的。</h6>
<h6 data-id="heading-6">(2).Vector</h6>
<p>与ArrayList相似，但是Vector是同步的。所以说Vector是线程安全的动态数组。它的操作与ArrayList几乎一样。</p>
<h6 data-id="heading-7">(3).LinkedList</h6>
<p>同样实现List接口的LinkedList与ArrayList不同，ArrayList是一个动态数组，而LinkedList是一个双向链表,
由于实现的方式不同，LinkedList不能随机访问，它所有的操作都是要按照双重链表的需要执行。在列表中索引的操作将从开头或结尾遍历列表（从靠近指定索引的一端）。这样做的好处就是可以通过较低的代价在List中进行插入和删除操作。
与ArrayList一样，LinkedList也是非同步的。如果多个线程同时访问一个List，则必须自己实现访问同步。</p>
<h6 data-id="heading-8">注意：创建List时构造一个同步的List：List list = Collections.synchronizedList(new LinkedList(...));</h6>
<p>######(4).Stack
Stack继承自Vector，实现一个后进先出的堆栈。Stack提供5个额外的方法使得Vector得以被当作堆栈使用。基本的push和pop 方法，还有peek方法得到栈顶的元素，empty方法测试堆栈是否为空，search方法检测一个元素在堆栈中的位置。Stack刚创建后是空栈。</p>
<pre><code class="hljs language-csharp" lang="csharp">   <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testStack</span>()</span> {
        <span class="hljs-comment">/***
         * 栈是一种只能在一端进行插入或删除操作的线性表
         * 特性：先进后出
         */</span>
        Stack&lt;String&gt; stack=<span class="hljs-keyword">new</span> Stack&lt;&gt;();
        <span class="hljs-comment">//进栈push()</span>
        stack.push(<span class="hljs-string">"1"</span>);
        stack.push(<span class="hljs-string">"2"</span>);
        stack.push(<span class="hljs-string">"3"</span>);
        stack.push(<span class="hljs-string">"4"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"statck data:"</span>+stack.toString());
        <span class="hljs-comment">// 取栈顶值（不出栈）</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"stack top:"</span>+stack.peek());
        <span class="hljs-comment">//出栈</span>
        <span class="hljs-comment">//  stack.pop();</span>
        <span class="hljs-comment">// stack.pop();</span>
        <span class="hljs-comment">//stack.pop();</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"stack data:"</span>+stack.toString());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"stack is empty:"</span>+stack.empty());
        <span class="hljs-built_in">int</span> index=stack.search(<span class="hljs-string">"3"</span>);<span class="hljs-comment">//计数从顶部开始</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"stack search index:"</span>+index);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"stack search result:"</span>+ stack.<span class="hljs-keyword">get</span>(<span class="hljs-number">0</span>));

        List&lt;String&gt; list=<span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">"1"</span>);
        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">"2"</span>);
        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">"3"</span>);
        list.<span class="hljs-keyword">add</span>(<span class="hljs-string">"4"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"list is empty:"</span>+list.<span class="hljs-keyword">get</span>(<span class="hljs-number">3</span>));
        Iterator&lt;String&gt; iterator=list.iterator();
        <span class="hljs-keyword">while</span> (iterator.hasNext()){
            System.<span class="hljs-keyword">out</span>.println(iterator.next());
        }
    }

</code></pre>
<h4 data-id="heading-9">2.2 Set接口的实现类（HashSet，LinkedHashSet，TreeSet）</h4>
<h6 data-id="heading-10">(1)HashSet</h6>
<p>HashSet 是一个没有重复元素的集合。它是由HashMap实现的，不保证元素的顺序(这里所说的没有顺序是指：元素插入的顺序与输出的顺序不一致)，而且HashSet允许使用null 元素。HashSet是非同步的，如果多个线程同时访问一个哈希set，而其中至少一个线程修改了该set，那么它必须保持外部同步。 HashSet按Hash算法来存储集合的元素，因此具有很好的存取和查找性能。</p>
<h6 data-id="heading-11">注意：HashSet是由HashMap实现，不保证元素的插入顺序，可以存放null值，仅仅能够存入一个null值。</h6>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHashSet</span>()</span> {
        <span class="hljs-comment">/****
         * 元素不重复
         */</span>
        Set&lt;String&gt; hashSet=<span class="hljs-keyword">new</span> HashSet&lt;&gt;();
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"javabbb"</span>);
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java01"</span>);
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java01"</span>);
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java03"</span>);
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java02"</span>);
        Set&lt;String&gt;  hashSet1=<span class="hljs-keyword">new</span> HashSet&lt;&gt;();
        hashSet1.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java05"</span>);
        hashSet1.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java04"</span>);
        hashSet1.<span class="hljs-keyword">add</span>(<span class="hljs-string">"javaaaa"</span>);
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-literal">null</span>);<span class="hljs-comment">//可以插入null</span>
        hashSet.<span class="hljs-keyword">add</span>(<span class="hljs-literal">null</span>);
        hashSet.addAll(hashSet1);
        boolean isEmpty=hashSet.isEmpty();
        <span class="hljs-comment">//遍历</span>
        Iterator&lt;String&gt; iterator= hashSet.iterator();
        <span class="hljs-keyword">while</span> (iterator.hasNext()){
            System.<span class="hljs-keyword">out</span>.println(iterator.next());
        }
    }
</code></pre>
<p>输出结果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2ca37f2546648ffac63ed06ed514299~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=cewG4WbE%2FfcaXQXtmcKExgrcdj4%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-12">(2)LinkedHashSet</h6>
<p>LinkedHashSet继承自HashSet，其底层是基于LinkedHashMap来实现的，有序，非同步。LinkedHashSet集合同样是根据元素的hashCode值来决定元素的存储位置，但是它同时使用链表维护元素的次序。这样使得元素看起来像是以插入顺序保存的，也就是说，当遍历该集合时候，LinkedHashSet将会以元素的添加顺序访问集合的元素。</p>
<h6 data-id="heading-13">注意：LinkedHashSet底层是基于LinkedHashMap来实现</h6>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testLinkedHashSet</span>()</span> {
        <span class="hljs-comment">/****
         * 因为是链表，所以有序输出
         * 元素不重复
         */</span>
        Set&lt;String&gt; linkedHashSet=<span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
        linkedHashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java01"</span>);
        linkedHashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java01"</span>);
        linkedHashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java02"</span>);
        linkedHashSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java03"</span>);
        Set&lt;String&gt; linkedHashSet1=<span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
        linkedHashSet1.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java04"</span>);
        linkedHashSet1.<span class="hljs-keyword">add</span>(<span class="hljs-string">"java05"</span>);
        linkedHashSet1.<span class="hljs-keyword">add</span>(<span class="hljs-literal">null</span>);
        linkedHashSet1.<span class="hljs-keyword">add</span>(<span class="hljs-literal">null</span>);
        linkedHashSet.addAll(linkedHashSet1);
        <span class="hljs-comment">//遍历</span>
        Iterator&lt;String&gt; iterator= linkedHashSet.iterator();
        <span class="hljs-keyword">while</span> (iterator.hasNext()){
            System.<span class="hljs-keyword">out</span>.println(iterator.next());
        }

    }
</code></pre>
<p>输出结果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4728e6efbc3a44b49cb555efe6ba0568~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=Fh8kYPMdzRqc9FcV8MZkfWSzMaE%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-14">(3)TreeSet</h6>
<p>TreeSet是一个有序集合，其底层是基于TreeMap实现的，非线程安全。TreeSet可以确保集合元素处于排序状态。TreeSet支持两种排序方式，自然排序和定制排序，其中自然排序为默认的排序方式。当我们构造TreeSet时，若使用不带参数的构造函数，则TreeSet的使用自然比较器；若用户需要使用自定义的比较器，则需要使用带比较器的参数。</p>
<h6 data-id="heading-15">注意：TreeSet底层是基于TreeMap来实现，Set集合都是非线程安全的</h6>
<pre><code class="hljs language-csharp" lang="csharp">
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testIntegerSort</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Integer对象自然排序："</span>);
        TreeSet&lt;Integer&gt; treeSetFirst = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-number">2</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-number">1</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-number">4</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-number">3</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-number">5</span>);
        Iterator&lt;Integer&gt; iterator=treeSetFirst.iterator();
        <span class="hljs-keyword">while</span> (iterator.hasNext()){
                System.<span class="hljs-keyword">out</span>.println(iterator.next());
        }
    }
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testDictionarySort</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Dictionary对象自然排序："</span>);
        TreeSet&lt;String&gt; treeSetFirst = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-string">"Baidu"</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-string">"Tecent"</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-string">"Ali"</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-string">"WanDa"</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-string">"HengDa"</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-string">"12"</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-string">"23a#"</span>);
        treeSetFirst.<span class="hljs-keyword">add</span>(<span class="hljs-string">"#"</span>);
        Iterator&lt;String&gt; iterator=treeSetFirst.iterator();
        <span class="hljs-keyword">while</span> (iterator.hasNext()){
            System.<span class="hljs-keyword">out</span>.println(iterator.next());
        }
    }


    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCompatorSort</span>()</span> {
        Set&lt;Student&gt; treeSet=<span class="hljs-keyword">new</span> TreeSet&lt;&gt;();
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"tecent"</span>,<span class="hljs-number">2</span>));
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"JD"</span>,<span class="hljs-number">1</span>));
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"wanda"</span>,<span class="hljs-number">3</span>));
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"baidu"</span>,<span class="hljs-number">2</span>));
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"ali"</span>,<span class="hljs-number">2</span>));
        treeSet.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Student(<span class="hljs-string">"tecent"</span>,<span class="hljs-number">2</span>));<span class="hljs-comment">//重复的元素被剔除了</span>
        System.<span class="hljs-keyword">out</span>.println(treeSet);
        Iterator itTSet = treeSet.iterator();<span class="hljs-comment">//遍历输出</span>
        <span class="hljs-keyword">while</span>(itTSet.hasNext()){
            System.<span class="hljs-keyword">out</span>.print(itTSet.next() + <span class="hljs-string">"\n"</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSubHeadTailSet</span>()</span> {
        TreeSet nums = <span class="hljs-keyword">new</span> TreeSet();
        nums.<span class="hljs-keyword">add</span>(<span class="hljs-number">5</span>);
        nums.<span class="hljs-keyword">add</span>(<span class="hljs-number">2</span>);
        nums.<span class="hljs-keyword">add</span>(<span class="hljs-number">3</span>);
        nums.<span class="hljs-keyword">add</span>(<span class="hljs-number">8</span>);
        nums.<span class="hljs-keyword">add</span>(<span class="hljs-number">8</span>);
        <span class="hljs-comment">//输出集合元素，可以看到集合元素已经处于排序状态，输出【2，3，5，8】</span>
        System.<span class="hljs-keyword">out</span>.println(nums);
        <span class="hljs-comment">//输出排序后集合里的第一个元素2</span>
        System.<span class="hljs-keyword">out</span>.println(nums.first());
        <span class="hljs-comment">//输出排序后集合里最后一个元素</span>
        System.<span class="hljs-keyword">out</span>.println(nums.last());
        <span class="hljs-comment">//输出小于4的集合，不包含4，输出【2，3】</span>
        System.<span class="hljs-keyword">out</span>.println(nums.headSet(<span class="hljs-number">4</span>));
        <span class="hljs-comment">//输出大于5的集合，如果set集合中有5，子集中还应该有5，输出【5，8】</span>
        System.<span class="hljs-keyword">out</span>.println(nums.tailSet(<span class="hljs-number">5</span>));
        <span class="hljs-comment">//输出大于2，小于5的子集，包括2，不包括5，输出集合【2，3】</span>
        System.<span class="hljs-keyword">out</span>.println(nums.subSet(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>));
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> <span class="hljs-title">implements</span> <span class="hljs-title">Comparable</span> {
        <span class="hljs-built_in">int</span> num;
        String name;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Student</span>(<span class="hljs-params"> String name,<span class="hljs-built_in">int</span> num</span>)</span> {
            <span class="hljs-keyword">this</span>.num = num;
            <span class="hljs-keyword">this</span>.name = name;
        }

        @Override
        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span>()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"StudentNo:"</span> + num + <span class="hljs-string">" ,StudentName:"</span> + name      ;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getNum</span>()</span> {
            <span class="hljs-keyword">return</span> num;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNum</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> num</span>)</span> {
            <span class="hljs-keyword">this</span>.num = num;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span>()</span> {
            <span class="hljs-keyword">return</span> name;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span>(<span class="hljs-params">String name</span>)</span> {
            <span class="hljs-keyword">this</span>.name = name;
        }

        @Override
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">compareTo</span>(<span class="hljs-params">Object o</span>)</span> {
            Student student= (Student) o;
            <span class="hljs-keyword">if</span>(num&lt;student.getNum()){<span class="hljs-comment">//升序排列</span>
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(num==student.getNum()){
                <span class="hljs-keyword">return</span> name.compareTo(student.getName());
            }<span class="hljs-keyword">else</span>{
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            }

        }
    }

</code></pre>
<p>输出结果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/693896ec086d4db6b161e32da2ee1994~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=XC3c%2F18pBYAk%2B1evY5ipTZNm9Rs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-16">3.Map接口</h2>
<p>Map与List、Set接口不同，它是由一系列键值对组成的集合，提供了key到Value的映射。同时它也没有继承Collection。在Map中它保证了key与value之间的一一对应关系。也就是说一个key对应一个value，所以它不能存在相同的key值，当然value值可以相同。
####(1).HashMap
HashMap可以通过调用Collections的静态方法Collections.synchronizedMap(Map map)进行同步,最多只允许一条记录的键为Null,不支持线程的同步，无序</p>
<pre><code class="hljs language-arduino" lang="arduino">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">testHashMap</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">/***
         * hashmap的key和value都可以为null
         */</span>
        Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">3</span>; i++) {
            map.<span class="hljs-built_in">put</span>(<span class="hljs-string">"key"</span> + i, <span class="hljs-string">"value"</span> + i);
        }
        map.<span class="hljs-built_in">put</span>(null,<span class="hljs-string">"value4"</span>);
        map.<span class="hljs-built_in">put</span>(null,<span class="hljs-string">"value5"</span>);
        map.<span class="hljs-built_in">put</span>(<span class="hljs-string">"key6"</span>,null);
        map.<span class="hljs-built_in">put</span>(<span class="hljs-string">"key7"</span>,null);
        map.<span class="hljs-built_in">get</span>(<span class="hljs-string">"key"</span> + <span class="hljs-number">5</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">String</span> key : map.<span class="hljs-built_in">keySet</span>()) {
            System.out.<span class="hljs-built_in">println</span>(map.<span class="hljs-built_in">get</span>(key));
        }
    }
</code></pre>
<p>输出结果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fb84ae31ab24f44ace52344f988ac56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=Zfg8yqrOrPAllRjo9yXH6%2BFP5ts%3D" alt="image.png" loading="lazy"/></p>
<p>输出结果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5cc50c06d543cc95967cedd0dadf13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=p7XSOLsA15EyCbk%2Fb0fO0bn22KM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-17">(2).LinkedHashMap</h4>
<p>LinkedHashMap是HashMap的一个子类，它保留插入的顺序，如果需要输出的顺序和输入时的相同，那么就选用LinkedHashMap。允许使用null值和null键</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">testLinkHashMap</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">//linkedhashmap  extends hashmap 比hashmap功能更强大</span>
        Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; map = <span class="hljs-keyword">new</span> LinkedHashMap&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">3</span>; i++) {
            map.<span class="hljs-built_in">put</span>(<span class="hljs-string">"key"</span> + i, <span class="hljs-string">"value"</span> + i);
        }
        map.<span class="hljs-built_in">put</span>(null,<span class="hljs-string">"value4"</span>);
        map.<span class="hljs-built_in">put</span>(null,<span class="hljs-string">"value5"</span>);
        map.<span class="hljs-built_in">put</span>(<span class="hljs-string">"key6"</span>,null);
        map.<span class="hljs-built_in">put</span>(<span class="hljs-string">"key7"</span>,null);
        map.<span class="hljs-built_in">get</span>(<span class="hljs-string">"key"</span> + <span class="hljs-number">5</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">String</span> key : map.<span class="hljs-built_in">keySet</span>()) {
            System.out.<span class="hljs-built_in">println</span>(map.<span class="hljs-built_in">get</span>(key));
        }
    }
</code></pre>
<p>输出结果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1290c9d37a64010aca5e26701f5e507~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=fAMEPpPaD5i%2BP88ezwOkK%2FVSYfs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-18">(2).Hashtable</h4>
<p>线程同步，同时key，value都不可以为null,无序的</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> void testHashtable() {
        /***
         * 线程同步的，同时<span class="hljs-keyword">key</span>，value都不可以为null，无序的
         */
        Hashtable&lt;<span class="hljs-type">String</span>,<span class="hljs-type">Object</span>&gt; hashtable = <span class="hljs-built_in">new</span> Hashtable();
        hashtable.put(<span class="hljs-string">"baidu"</span>,<span class="hljs-string">"101"</span>);
        hashtable.put(<span class="hljs-string">"ali"</span>,<span class="hljs-string">"102"</span>);
        hashtable.put(<span class="hljs-string">"tencent"</span>,<span class="hljs-string">"103"</span>);
        hashtable.put(<span class="hljs-string">"wanda"</span>,<span class="hljs-string">"105"</span>);
        hashtable.put(<span class="hljs-string">"pingan"</span>,<span class="hljs-string">"107"</span>);
        hashtable.put(<span class="hljs-string">"hengda"</span>,<span class="hljs-string">"106"</span>);
        hashtable.put(<span class="hljs-string">"transsion"</span>,<span class="hljs-string">"104"</span>);
        // hashtable.put(null,<span class="hljs-string">"2"</span>);//java.lang.NullPointerException
        //  hashtable.put(<span class="hljs-string">"wanke"</span>,null);//java.lang.NullPointerException
        <span class="hljs-keyword">for</span>(<span class="hljs-type">String</span> <span class="hljs-keyword">key</span>:hashtable.keySet()){
            System.out.println(<span class="hljs-keyword">key</span>+<span class="hljs-string">"="</span>+hashtable.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">key</span>));
        }
    }
</code></pre>
<h4 data-id="heading-19">(4).ConCurrentHashMap</h4>
<p>ConcurrentHashMap和HashTable都是线程安全的，无序的，key和value都不能为null,性能上要比Hashtable要强，是一个加强版本的Hashtable。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> void testConcurrentHashMap() {
        /***
         * ConcurrentHashMap和HashTable都是线程安全的，可以在多线程中进行，
         * <span class="hljs-keyword">key</span>和value都不能为null,性能上要比Hashtable要强
         * 线程同步的，同时<span class="hljs-keyword">key</span>，value都不可以为null
         */
        ConcurrentHashMap&lt;<span class="hljs-type">String</span>,<span class="hljs-type">Object</span>&gt; concurrentHashMap = <span class="hljs-built_in">new</span> ConcurrentHashMap();
        concurrentHashMap.put(<span class="hljs-string">"baidu"</span>,<span class="hljs-string">"101"</span>);
        concurrentHashMap.put(<span class="hljs-string">"ali"</span>,<span class="hljs-string">"102"</span>);
        concurrentHashMap.put(<span class="hljs-string">"tencent"</span>,<span class="hljs-string">"103"</span>);
        concurrentHashMap.put(<span class="hljs-string">"wanda"</span>,<span class="hljs-string">"105"</span>);
        concurrentHashMap.put(<span class="hljs-string">"pingan"</span>,<span class="hljs-string">"107"</span>);
        concurrentHashMap.put(<span class="hljs-string">"hengda"</span>,<span class="hljs-string">"106"</span>);
        concurrentHashMap.put(<span class="hljs-string">"transsion"</span>,<span class="hljs-string">"104"</span>);
        // concurrentHashMap.put(null,<span class="hljs-string">"2"</span>);//java.lang.NullPointerException
        // concurrentHashMap.put(<span class="hljs-string">"wanke"</span>,null);//java.lang.NullPointerException
        <span class="hljs-keyword">for</span>(<span class="hljs-type">String</span> <span class="hljs-keyword">key</span>:concurrentHashMap.keySet()){
            System.out.println(<span class="hljs-keyword">key</span>+<span class="hljs-string">"="</span>+concurrentHashMap.<span class="hljs-keyword">get</span>(<span class="hljs-keyword">key</span>));
        }
    }
</code></pre>
<p>输出结果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6257b9ca767c49429aae3df72f3c1340~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=LvHSde58JcxQm%2FlmmP2KZOCyT9I%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-20">(5).TreeMap</h4>
<p>TreeMap 是一个有序的key-value集合，非同步，基于红黑树（Red-Black tree）实现，每一个key-value节点作为红黑树的一个节点。TreeMap存储时会进行排序的，会根据key来对key-value键值对进行排序，其中排序方式也是分为两种，一种是自然排序，一种是定制排序，具体取决于使用的构造方法。
######注意：key不能为null,value可以为null</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">//自然排序顺序：</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">naturalSort</span>()</span>{
        <span class="hljs-comment">//第一种情况：Integer对象</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Integer对象自然排序："</span>);
        TreeMap&lt;Integer,String&gt; treeMapFirst = <span class="hljs-keyword">new</span> TreeMap&lt;Integer, String&gt;();
        treeMapFirst.put(<span class="hljs-number">1</span>,<span class="hljs-string">"jiaboyan"</span>);
        treeMapFirst.put(<span class="hljs-number">6</span>,<span class="hljs-string">"jiaboyan"</span>);
        treeMapFirst.put(<span class="hljs-number">3</span>,<span class="hljs-string">"jiaboyan"</span>);
        treeMapFirst.put(<span class="hljs-number">10</span>,<span class="hljs-string">"jiaboyan"</span>);
        treeMapFirst.put(<span class="hljs-number">7</span>,<span class="hljs-string">"jiaboyan"</span>);
        treeMapFirst.put(<span class="hljs-number">13</span>,<span class="hljs-string">"jiaboyan"</span>);
        <span class="hljs-comment">//treeMapFirst.put(null,"jiaboyan");java.lang.NullPointerException</span>
        treeMapFirst.put(<span class="hljs-number">14</span>,<span class="hljs-literal">null</span>);<span class="hljs-comment">//可以运行</span>
        System.<span class="hljs-keyword">out</span>.println(treeMapFirst.toString());

        <span class="hljs-comment">//第二种情况:SortedTest对象</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"SortedTest对象排序一："</span>);
        TreeMap&lt;SortedTest,String&gt; treeMapSecond = <span class="hljs-keyword">new</span> TreeMap&lt;SortedTest, String&gt;();
        treeMapSecond.put(<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">10</span>),<span class="hljs-string">"jiaboyan"</span>);
        treeMapSecond.put(<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">1</span>),<span class="hljs-string">"jiaboyan"</span>);
        treeMapSecond.put(<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">13</span>),<span class="hljs-string">"jiaboyan"</span>);
        treeMapSecond.put(<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">4</span>),<span class="hljs-string">"jiaboyan"</span>);
        treeMapSecond.put(<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">0</span>),<span class="hljs-string">"jiaboyan"</span>);
        treeMapSecond.put(<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">9</span>),<span class="hljs-string">"jiaboyan"</span>);
        System.<span class="hljs-keyword">out</span>.println(treeMapSecond.toString());
        <span class="hljs-comment">//默认是根据key的自然排序来组织（比如integer的大小，String的字典排序）</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"integer和字典对象排序二："</span>);
        TreeMap&lt;String,SortedTest&gt; treeMapThree = <span class="hljs-keyword">new</span> TreeMap&lt;String,SortedTest &gt;();
        treeMapThree.put(<span class="hljs-string">"2key1"</span>,<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">10</span>));
        treeMapThree.put(<span class="hljs-string">"1key2"</span>,<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">1</span>));
        treeMapThree.put(<span class="hljs-string">"bey3"</span>,<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">13</span>));
        treeMapThree.put(<span class="hljs-string">"key6"</span>,<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">4</span>));
        treeMapThree.put(<span class="hljs-string">"key5"</span>,<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">0</span>));
        treeMapThree.put(<span class="hljs-string">"key4"</span>,<span class="hljs-keyword">new</span> SortedTest(<span class="hljs-number">9</span>));
        System.<span class="hljs-keyword">out</span>.println(treeMapThree.toString());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SortedTest</span> <span class="hljs-title">implements</span> <span class="hljs-title">Comparable</span>&lt;<span class="hljs-title">SortedTest</span>&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> age;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SortedTest</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> age</span>)</span>{
            <span class="hljs-keyword">this</span>.age = age;
        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getAge</span>()</span> {
            <span class="hljs-keyword">return</span> age;
        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> age</span>)</span> {
            <span class="hljs-keyword">this</span>.age = age;
        }

        @Override
        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span>()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"age:"</span>+age;
        }

        <span class="hljs-comment">//自定义对象，实现compareTo(T o)方法：</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">compareTo</span>(<span class="hljs-params">SortedTest sortedTest</span>)</span> {
            <span class="hljs-built_in">int</span> num = <span class="hljs-keyword">this</span>.age - sortedTest.getAge();
            <span class="hljs-comment">//为0时候，两者相同：</span>
            <span class="hljs-keyword">if</span>(num==<span class="hljs-number">0</span>){
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                <span class="hljs-comment">//大于0时，传入的参数小：</span>
            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(num&gt;<span class="hljs-number">0</span>){
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
                <span class="hljs-comment">//小于0时，传入的参数大：</span>
            }<span class="hljs-keyword">else</span>{
                <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
            }
        }
    }

</code></pre>
<p>输出结果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/889d1235fe2e4b318bacc06d26a6a810~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770285817&amp;x-signature=uWiXGqqzZFWQmpJgPse5ZUi%2B%2F7E%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[node 全栈(三)：使用 React 构建最小可用的身体指标网站]]></title>    <link>https://juejin.cn/post/7600603245396000808</link>    <guid>https://juejin.cn/post/7600603245396000808</guid>    <pubDate>2026-01-29T09:48:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600603245396000808" data-draft-id="7599922362998882350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="node 全栈(三)：使用 React 构建最小可用的身体指标网站"/> <meta itemprop="keywords" content="React.js,Jenkins,Node.js"/> <meta itemprop="datePublished" content="2026-01-29T09:48:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="淮桑榆"/> <meta itemprop="url" content="https://juejin.cn/user/3397929986176872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            node 全栈(三)：使用 React 构建最小可用的身体指标网站
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3397929986176872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    淮桑榆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:48:38.000Z" title="Thu Jan 29 2026 09:48:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">文章前言</h2>
<p><strong>永远把别人对你的批评记在心里，别人的表扬，就把它忘了。Hello 大家好～！我是淮桑榆</strong></p>
<p>由于之前在阿里云上购买的域名已经完成了ICP备案，但还未做公安联网备案，所以本文主要是记录使用React构建最小可用的身体指标网站，该网站将用于公安联网备案，特地记录下与诸位分享，如有阐述不对的地方欢迎在评论区指正。</p>
<p>观看到文章最后的话，如果觉得不错，可以点个关注或者点个赞哦！感谢～❤️</p>
<h2 data-id="heading-1">前系文章</h2>
<p><a href="https://juejin.cn/post/7596926832912252991" target="_blank" title="https://juejin.cn/post/7596926832912252991">node全栈(一)：在阿里云 Ubuntu 上部署 Jenkins（Docker 方式）实战指南</a></p>
<p><a href="https://juejin.cn/post/7597900782910144531" target="_blank" title="https://juejin.cn/post/7597900782910144531">node全栈(二)：Express 接口自动化部署实战 —— Jenkins + PM2 上线指南</a></p>
<h2 data-id="heading-2">文章主体</h2>
<p>感谢各位观者的耐心观看，<em>使用React构建最小可用的身体指标网站</em>的正片即将开始，且听淮桑榆娓娓道来</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c369a1777c0d49ae9f6c99fbec74d6a0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=941&amp;h=515&amp;s=533990&amp;e=png&amp;b=c5d9e6" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">本地开发身体指标网站</h3>
<h4 data-id="heading-4">创建项目</h4>
<pre><code class="hljs language-sql" lang="sql">npm <span class="hljs-keyword">create</span> vite<span class="hljs-variable">@latest</span> body<span class="hljs-operator">-</span>metrics<span class="hljs-operator">-</span>web <span class="hljs-comment">-- --template react</span>

cd body<span class="hljs-operator">-</span>metrics<span class="hljs-operator">-</span>web

npm install
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/382a0a5b4a41453c9abd6f91e738741f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5reu5qGR5qaG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284918&amp;x-signature=YNFs52F0SAZ755lKuiuCe921FXE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">安装 Ant Design</h4>
<pre><code class="hljs">npm install antd
</code></pre>
<h4 data-id="heading-6">安装多语言工具包</h4>
<pre><code class="hljs">npm install nangongmoyan-i18n-toolkit i18next react-i18next
</code></pre>
<h4 data-id="heading-7">添加<code>i18n.config.json</code>配置文件</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIzaSyACst8BV863yziXZoyWuV8q3EdALygZqgY"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outputDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src/i18n"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"spreadsheetId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1TZ_11zne_0PVgr0cQu0sdWp9DZFE8KAOAElVlPEwvZw"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tableIndex"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"langues"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"zh-CN"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"en-US"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"socksProxy"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"socks5://127.0.0.1:7980"</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-8">在package.json中的scripts中添加</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"intl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nangongmoyan-i18n-toolkit"</span>
</code></pre>
<h4 data-id="heading-9">命令行执行npm run intl</h4>
<p>这里会将对应语言的json文件下载下来</p>
<pre><code class="hljs language-arduino" lang="arduino">npm run intl
</code></pre>
<h4 data-id="heading-10">调整入口文件</h4>
<p>添加多语言资源引入和初始化</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StrictMode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.jsx'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'antd/dist/reset.css'</span>;
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'./i18n/zh-CN.json'</span>;
<span class="hljs-keyword">import</span> enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'./i18n/en-US.json'</span>;
<span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">'i18next'</span>;
<span class="hljs-keyword">import</span> { initReactI18next } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-i18next'</span>;

<span class="hljs-keyword">const</span> resources = {
  <span class="hljs-attr">zh_CN</span>: {
    <span class="hljs-attr">common</span>: zhCN,
  },
  <span class="hljs-attr">en_US</span>: {
    <span class="hljs-attr">common</span>: enUS,
  },
};


i18n
  .<span class="hljs-title function_">use</span>(initReactI18next)
  .<span class="hljs-title function_">init</span>({
    resources,
    <span class="hljs-attr">ns</span>: [<span class="hljs-string">'common'</span>],
    <span class="hljs-attr">fallbackLng</span>: <span class="hljs-string">'zh_CN'</span>,
    <span class="hljs-attr">compatibilityJSON</span>: <span class="hljs-string">'v3'</span>,

  });

<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)).<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>,
)

</code></pre>
<h4 data-id="heading-11">编辑网站首页</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">React</span> <span class="hljs-selector-tag">from</span> '<span class="hljs-selector-tag">react</span>';
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">Layout</span>, <span class="hljs-selector-tag">Typography</span>, <span class="hljs-selector-tag">Breadcrumb</span>, <span class="hljs-selector-tag">Button</span>, <span class="hljs-selector-tag">Timeline</span>, <span class="hljs-selector-tag">message</span> } <span class="hljs-selector-tag">from</span> '<span class="hljs-selector-tag">antd</span>';
<span class="hljs-selector-tag">const</span> { <span class="hljs-selector-tag">Header</span>, <span class="hljs-selector-tag">Content</span>, <span class="hljs-selector-tag">Footer</span> } = <span class="hljs-selector-tag">Layout</span>;
<span class="hljs-selector-tag">const</span> { <span class="hljs-selector-tag">Text</span> } = <span class="hljs-selector-tag">Typography</span>;
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">useController</span> } <span class="hljs-selector-tag">from</span> './<span class="hljs-selector-tag">controller</span>';
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">banner</span> <span class="hljs-selector-tag">from</span> '../../<span class="hljs-selector-tag">assets</span>/<span class="hljs-selector-tag">home-banner</span><span class="hljs-selector-class">.png</span>';
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">useTranslation</span> } <span class="hljs-selector-tag">from</span> '<span class="hljs-selector-tag">react-i18next</span>';

<span class="hljs-selector-tag">export</span> <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">Home</span>() {
  <span class="hljs-selector-tag">const</span> { <span class="hljs-selector-tag">t</span> } = <span class="hljs-selector-tag">useTranslation</span>()
  <span class="hljs-selector-tag">const</span> { <span class="hljs-selector-tag">breadcrumbs</span>, <span class="hljs-selector-tag">timelineItems</span>, <span class="hljs-selector-tag">lang</span>, <span class="hljs-selector-tag">changeLanguage</span>, <span class="hljs-selector-tag">handleLoginClick</span> } = <span class="hljs-selector-tag">useController</span>();

  <span class="hljs-selector-tag">return</span> (
    &lt;Layout
      style={{
        <span class="hljs-attribute">width</span>: <span class="hljs-string">'100vw'</span>,
        <span class="hljs-attribute">minHeight</span>: <span class="hljs-string">'100vh'</span>,
        <span class="hljs-attribute">backgroundColor</span>: <span class="hljs-string">'#fff'</span>,
        <span class="hljs-attribute">overflowX</span>: <span class="hljs-string">'hidden'</span>,
      }}
    &gt;
      &lt;Header
        style={{
          <span class="hljs-attribute">position</span>: <span class="hljs-string">'fixed'</span>,
          <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>,
          <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>,
          <span class="hljs-attribute">width</span>: <span class="hljs-string">'100%'</span>,
          <span class="hljs-attribute">zIndex</span>: <span class="hljs-number">100</span>,
          <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>,
          <span class="hljs-attribute">justifyContent</span>: <span class="hljs-string">'space-between'</span>,
          <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span>,
          <span class="hljs-attribute">backgroundColor</span>: <span class="hljs-string">'#fff'</span>,
          <span class="hljs-attribute">padding</span>: <span class="hljs-string">'0 40px'</span>,
          <span class="hljs-attribute">boxShadow</span>: <span class="hljs-string">'0 1px 4px rgba(0,0,0,0.1)'</span>,
        }}
      &gt;
        &lt;div style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-number">24</span> }}&gt;
          &lt;Text strong style={{ fontSize: 18 }}&gt;
            Metrics
          &lt;/Text&gt;
          &lt;Breadcrumb
            items={<span class="hljs-selector-tag">breadcrumbs</span>}
            <span class="hljs-selector-tag">itemRender</span>={(<span class="hljs-selector-tag">route</span>) =&gt; (
              &lt;span style={{ fontSize: 16, fontWeight: 600, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#000'</span> }}&gt;
                {<span class="hljs-selector-tag">route</span><span class="hljs-selector-class">.title</span>}
              &lt;/<span class="hljs-selector-tag">span</span>&gt;
            )}
          /&gt;
        &lt;/<span class="hljs-selector-tag">div</span>&gt;

        &lt;<span class="hljs-selector-tag">div</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'flex'</span>, <span class="hljs-attribute">alignItems</span>: <span class="hljs-string">'center'</span>, <span class="hljs-attribute">gap</span>: <span class="hljs-number">16</span> }}&gt;
          &lt;span
            style={{
              <span class="hljs-attribute">cursor</span>: <span class="hljs-string">'pointer'</span>,
              <span class="hljs-attribute">fontSize</span>: <span class="hljs-number">14</span>,
              <span class="hljs-attribute">fontWeight</span>: <span class="hljs-number">600</span>,
              <span class="hljs-attribute">color</span>: lang === <span class="hljs-string">'zh_CN'</span> ? <span class="hljs-string">'#4F4165'</span> : <span class="hljs-string">'#999'</span>,
            }}
            onClick={<span class="hljs-selector-tag">changeLanguage</span>}
          &gt;
            中文
          &lt;/<span class="hljs-selector-tag">span</span>&gt;
          &lt;<span class="hljs-selector-tag">span</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">color</span>: <span class="hljs-string">'#999'</span> }}&gt;|&lt;/span&gt;
          &lt;span
            style={{
              <span class="hljs-attribute">cursor</span>: <span class="hljs-string">'pointer'</span>,
              <span class="hljs-attribute">fontSize</span>: <span class="hljs-number">14</span>,
              <span class="hljs-attribute">fontWeight</span>: <span class="hljs-number">600</span>,
              <span class="hljs-attribute">color</span>: lang === <span class="hljs-string">'en_US'</span> ? <span class="hljs-string">'#4F4165'</span> : <span class="hljs-string">'#999'</span>,
            }}
            onClick={<span class="hljs-selector-tag">changeLanguage</span>}
          &gt;
            <span class="hljs-selector-tag">EN</span>
          &lt;/<span class="hljs-selector-tag">span</span>&gt;

          &lt;<span class="hljs-selector-tag">Button</span>
            <span class="hljs-selector-tag">type</span>="<span class="hljs-selector-tag">primary</span>"
            <span class="hljs-selector-tag">style</span>={{
              backgroundColor: '#4F4165',
              borderColor: '#4F4165',
              <span class="hljs-attribute">outline</span>: <span class="hljs-string">'none'</span>,    
              <span class="hljs-attribute">boxShadow</span>: <span class="hljs-string">'none'</span>,    
            }}
            onClick={<span class="hljs-selector-tag">handleLoginClick</span>}
          &gt;
            {<span class="hljs-selector-tag">t</span>(<span class="hljs-string">'db1730ea5d370986ed9ad745fa8ad320'</span>)}
          &lt;/<span class="hljs-selector-tag">Button</span>&gt;
        &lt;/<span class="hljs-selector-tag">div</span>&gt;
      &lt;/<span class="hljs-selector-tag">Header</span>&gt;

      &lt;<span class="hljs-selector-tag">Content</span>
        <span class="hljs-selector-tag">style</span>={{
          backgroundColor: '#fff',
          <span class="hljs-attribute">padding</span>: <span class="hljs-string">'100px 40px 40px 40px'</span>,
          <span class="hljs-attribute">minHeight</span>: <span class="hljs-string">'calc(100vh - 64px)'</span>,
        }}
      &gt;
        &lt;div style={{ textAlign: 'center', marginBottom: 48, marginTop: 320 }}&gt;
          &lt;img
            src={<span class="hljs-selector-tag">banner</span>}
            <span class="hljs-selector-tag">alt</span>="<span class="hljs-selector-tag">Home</span> <span class="hljs-selector-tag">Banner</span>"
            <span class="hljs-selector-tag">style</span>={{
              <span class="hljs-attribute">width</span>: <span class="hljs-string">'100%'</span>,
              <span class="hljs-attribute">maxWidth</span>: <span class="hljs-number">1860</span>,
              <span class="hljs-attribute">height</span>: <span class="hljs-string">'auto'</span>,
              <span class="hljs-attribute">borderRadius</span>: <span class="hljs-number">8</span>,
            }}
          /&gt;
        &lt;/div&gt;

        &lt;Timeline
          mode=<span class="hljs-string">"alternate"</span>
          items={<span class="hljs-selector-tag">timelineItems</span><span class="hljs-selector-class">.map</span>((item, index) =&gt; ({
            <span class="hljs-attribute">key</span>: index,
            <span class="hljs-attribute">color</span>: <span class="hljs-string">'blue'</span>,
            <span class="hljs-attribute">content</span>: (
              &lt;div&gt;
                &lt;div style={{ <span class="hljs-attribute">fontSize</span>: <span class="hljs-number">16</span>, <span class="hljs-attribute">fontWeight</span>: <span class="hljs-number">600</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#4F4165'</span> }}&gt;
                  {item.title}
                &lt;/div&gt;
                &lt;div style={{ <span class="hljs-attribute">fontSize</span>: <span class="hljs-number">14</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#000'</span>, <span class="hljs-attribute">marginTop</span>: <span class="hljs-number">4</span> }}&gt;
                  {item.content}
                &lt;/div&gt;
              &lt;/div&gt;
            ),
          }))}
        /&gt;
      &lt;/<span class="hljs-selector-tag">Content</span>&gt;

      &lt;<span class="hljs-selector-tag">Footer</span> <span class="hljs-selector-tag">style</span>={{ textAlign: 'center', <span class="hljs-attribute">padding</span>: <span class="hljs-string">'20px 0'</span> }}&gt;
        &lt;div&gt;
          &lt;Text style={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'block'</span>, <span class="hljs-attribute">marginBottom</span>: <span class="hljs-number">8</span> }}&gt;
            {<span class="hljs-selector-tag">t</span>(<span class="hljs-string">'488984465088887b5175f44cbc280c1b'</span>)}
          &lt;/<span class="hljs-selector-tag">Text</span>&gt;
          &lt;<span class="hljs-selector-tag">Text</span> <span class="hljs-selector-tag">style</span>={{ <span class="hljs-attribute">display</span>: <span class="hljs-string">'block'</span> }}&gt;
            © <span class="hljs-number">2026</span> Body Metrics ｜ ICP备案号：
            &lt;a
              href=<span class="hljs-string">"https://beian.miit.gov.cn/"</span>
              target=<span class="hljs-string">"_blank"</span>
              rel=<span class="hljs-string">"noreferrer"</span>
              style={{ marginLeft: 4 }}
            &gt;
              闽ICP备<span class="hljs-number">2026002759</span>号-<span class="hljs-number">1</span>
            &lt;/a&gt;
          &lt;/Text&gt;
        &lt;/div&gt;
      &lt;/Footer&gt;
    &lt;/Layout&gt;
  );
}
</code></pre>
<h4 data-id="heading-12">编辑网站首页控制器</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useCallback, useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">import</span> { useTranslation } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-i18next"</span>;
<span class="hljs-keyword">import</span> i18n <span class="hljs-keyword">from</span> <span class="hljs-string">'i18next'</span>;
<span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useController</span> = (<span class="hljs-params"/>) =&gt; {

    <span class="hljs-keyword">const</span> { t } = <span class="hljs-title function_">useTranslation</span>();
    
    <span class="hljs-keyword">const</span> [lang, setLang] = useState&lt;<span class="hljs-string">'zh_CN'</span> | <span class="hljs-string">'en_US'</span>&gt;(<span class="hljs-string">'zh_CN'</span>)

    <span class="hljs-keyword">const</span> breadcrumbs = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> [
        {
          <span class="hljs-attr">path</span>: <span class="hljs-string">'/index'</span>,
          <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'52840060f8254e27aa3b9b2b0b9d656f'</span>)
        },
      ], [t]);


    <span class="hljs-keyword">const</span> timelineItems = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">()=&gt;</span>[
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'ebbbf81b34583e7f9de5c6fa48b816ab'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'9c802be674a11ad45a6631d90abb5504'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'37bfbd5c693f8adb5299907449f3f4ea'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'1710acdc565dc7f9a9fe96a4611d28bf'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'99f6f78d920c4947c890074d6b269db8'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'80f1452ac632ff01f20f58d805151f04'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'87aa3b7167958c5e4a8a00fbaef36d37'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'76b219fa9200611dc4c59bac7f2bc26b'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'e168d0e3489c09a75a68b5b3733f544a'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'42117fcc4369a571a801d41431c15c0c'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'b69c259e2bfae5dd199edf6c5ce399e6'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'00700332fc6bd6238a458d67c52aa95d'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'314a4858bcf31c67cae2466026c6cd13'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'e1e1ab8de1667f6b9ce9d0810560c7a6'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'49e667da352288dc57ed938c67a96ce8'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'64289b7952c9f8e75240ffd317839f17'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'d6d7cf111600c05862f042b172873acc'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'876d800b93cbe8f670e8949c954bc87c'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'8848d29ab8604dd39d8823440e754113'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'139c1b55b9606936c38d522ceb49b1dc'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'daedccdcc67c28e3533627a2ae385b2c'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'13ede0bee19f6015b31dbcff57b76e67'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'92ed46d181b9812f07a616ea48c75731'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'673d1adb866512b70df13f38e68d1634'</span>)
        },
        {
            <span class="hljs-attr">title</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'463debc2c12e179cfb050c797f27cbcc'</span>),
            <span class="hljs-attr">content</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'dc9950665e7ba954760e1678afc2af98'</span>)
        },
    ],[t])


    <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeLanguage</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-title function_">setLang</span>(lang === <span class="hljs-string">'en_US'</span> ? <span class="hljs-string">'zh_CN'</span> : <span class="hljs-string">'en_US'</span>)
    }
      
    <span class="hljs-keyword">const</span> handleLoginClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">()=&gt;</span>{
        message.<span class="hljs-title function_">info</span>(<span class="hljs-title function_">t</span>(<span class="hljs-string">'983928f5ae498edc03884b979f1c3274'</span>));
    },[t])
    
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        i18n.<span class="hljs-title function_">changeLanguage</span>(lang);
      }, [lang])

    <span class="hljs-keyword">return</span> { breadcrumbs, timelineItems, lang, changeLanguage, handleLoginClick }
}
</code></pre>
<h4 data-id="heading-13">本地调试运行</h4>
<p>调试完成后，将代码推送至远程仓库</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4298d75c12e0460696993f7b8659fe19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5reu5qGR5qaG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284918&amp;x-signature=ADqfNlCQzl4xvSAsuU0yGHV97pY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">创建项目dist仓库</h4>
<p>由于购置的服务器低配，所以打算采用本地构建，然后将构建后的产物推到远程，然后在服务器上部署远程仓库的构建产物，在项目根目录执行：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 进入 dist 目录</span>

cd dist

<span class="hljs-meta"># 初始化临时 Git 仓库</span>

git <span class="hljs-keyword">init</span>

git remote <span class="hljs-keyword">add</span> origin git@github.com:huaisangyu/body-metrics-web-dist.git

<span class="hljs-meta"># 添加所有文件并提交</span>

git <span class="hljs-keyword">add</span> .

git commit -m <span class="hljs-string">"chore: deploy build dist"</span>


<span class="hljs-meta"># 强制推送到 deploy 分支（每次覆盖）</span>

git branch -M deploy

git push -f origin deploy
</code></pre>
<h4 data-id="heading-15">在宿主机上创建metrics文件夹</h4>
<p>metrics文件主要用于存放构建的产物</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /var/www/metrics

<span class="hljs-built_in">chown</span> -R www-data:www-data /var/www
<span class="hljs-built_in">chmod</span> -R 755 /var/www
</code></pre>
<p>阿里云 Ubuntu 默认 nginx 用户是 www-data</p>
<h4 data-id="heading-16">给metrics子域名建一个Nginx的配置文件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">'EOF'</span> &gt; /etc/nginx/conf.d/metrics.conf
server {
    listen 80;
    server_name metrics.huaisangyu.top;
    <span class="hljs-built_in">return</span> 301 https://$host<span class="hljs-variable">$request_uri</span>;
}

server {
    listen 443 ssl;
    server_name metrics.huaisangyu.top;

    ssl_certificate /etc/letsencrypt/live/metrics.huaisangyu.top/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/metrics.huaisangyu.top/privkey.pem;

    root /var/www/metrics;
    index index.html;

    add_header Content-Security-Policy <span class="hljs-string">"upgrade-insecure-requests"</span>;

    location / {
        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;
    }
}
EOF
</code></pre>
<p>启动这个配置</p>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">ln</span> -s /etc/nginx/sites-available/metrics /etc/nginx/sites-enabled/metrics
</code></pre>
<p>重载Nginx</p>
<pre><code class="hljs">sudo systemctl reload nginx
</code></pre>
<h4 data-id="heading-17">新建Jenkins任务</h4>
<ul>
<li>Jenkins Dashboard → 新建Item(New Item)</li>
<li>名称：<code>body-metrics-web-dist</code></li>
<li>类型：流水线(Pipeline)</li>
</ul>
<h5 data-id="heading-18">Pipeline Script</h5>
<pre><code class="hljs language-bash" lang="bash">pipeline {
    agent any

    environment {
        DeployHost = <span class="hljs-string">"公网IP"</span>
        DeployUser = <span class="hljs-string">"root"</span>
        DeployPath = <span class="hljs-string">"/var/www/metrics"</span>
        LocalDir   = <span class="hljs-string">"/var/project/body-metrics-web-dist"</span>
        SshKey     = <span class="hljs-string">"/var/jenkins_home/.ssh/id_ed25519"</span>
    }

    parameters {
        gitParameter(
            name: <span class="hljs-string">'Branch'</span>,
            <span class="hljs-built_in">type</span>: <span class="hljs-string">'PT_BRANCH'</span>,
            defaultValue: <span class="hljs-string">'deploy'</span>,
            description: <span class="hljs-string">'选择要部署的分支'</span>,
            branchFilter: <span class="hljs-string">'origin/(.*)'</span>,
            selectedValue: <span class="hljs-string">'DEFAULT'</span>,
            sortMode: <span class="hljs-string">'NONE'</span>,
            quickFilterEnabled: <span class="hljs-literal">true</span>
        )

        string(
            name: <span class="hljs-string">'Repository'</span>,
            defaultValue: <span class="hljs-string">'git@github.com:huaisangyu/body-metrics-web-dist.git'</span>,
            description: <span class="hljs-string">'dist 仓库地址'</span>
        )

        credentials(
            name: <span class="hljs-string">'Credential'</span>,
            defaultValue: <span class="hljs-string">'github-ssh'</span>,
            description: <span class="hljs-string">'Git SSH 凭据'</span>
        )
    }

    stages {

        stage(<span class="hljs-string">'准备参数'</span>) {
            steps {
                script {
                    repo = params.Repository.trim()
                    branch = params.Branch
                    cred = params.Credential

                    <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用仓库：<span class="hljs-variable">${repo}</span>"</span>
                    <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用分支：<span class="hljs-variable">${branch}</span>"</span>
                    <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用凭据：<span class="hljs-variable">${cred}</span>"</span>
                }
            }
        }

        // ✅ 关键：和 node-api 一模一样的“占位 git step”
        stage(<span class="hljs-string">'刷新 Git 分支信息'</span>) {
            steps {
                git changelog: <span class="hljs-literal">false</span>,
                    branch: <span class="hljs-string">"<span class="hljs-variable">${branch}</span>"</span>,
                    url: <span class="hljs-string">"<span class="hljs-variable">${repo}</span>"</span>,
                    credentialsId: <span class="hljs-string">"<span class="hljs-variable">${cred}</span>"</span>
            }
        }

        stage(<span class="hljs-string">'宿主机拉取 / 更新 dist'</span>) {
            steps {
                sh <span class="hljs-string">""</span><span class="hljs-string">"
                    ssh -i <span class="hljs-variable">${SshKey}</span> -o StrictHostKeyChecking=yes <span class="hljs-variable">${DeployUser}</span>@<span class="hljs-variable">${DeployHost}</span> '
                        if [ ! -d <span class="hljs-variable">${LocalDir}</span> ]; then
                            git clone -b <span class="hljs-variable">${branch}</span> <span class="hljs-variable">${repo}</span> <span class="hljs-variable">${LocalDir}</span>
                        else
                            cd <span class="hljs-variable">${LocalDir}</span>
                            git fetch --all
                            git checkout <span class="hljs-variable">${branch}</span>
                            git reset --hard origin/<span class="hljs-variable">${branch}</span>
                        fi
                    '
                "</span><span class="hljs-string">""</span>
            }
        }

        stage(<span class="hljs-string">'发布到 Nginx'</span>) {
            steps {
                sh <span class="hljs-string">""</span><span class="hljs-string">"
                    ssh -i <span class="hljs-variable">${SshKey}</span> -o StrictHostKeyChecking=yes <span class="hljs-variable">${DeployUser}</span>@<span class="hljs-variable">${DeployHost}</span> '
                        mkdir -p <span class="hljs-variable">${DeployPath}</span>
                        rm -rf <span class="hljs-variable">${DeployPath}</span>/*
                        cp -r <span class="hljs-variable">${LocalDir}</span>/* <span class="hljs-variable">${DeployPath}</span>/
                    '
                "</span><span class="hljs-string">""</span>
            }
        }

        stage(<span class="hljs-string">'Reload Nginx'</span>) {
            steps {
                sh <span class="hljs-string">""</span><span class="hljs-string">"
                    ssh -i <span class="hljs-variable">${SshKey}</span> -o StrictHostKeyChecking=yes <span class="hljs-variable">${DeployUser}</span>@<span class="hljs-variable">${DeployHost}</span> '
                        nginx -t &amp;&amp; nginx -s reload
                    '
                "</span><span class="hljs-string">""</span>
            }
        }
    }

    post {
        success {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ Web dist 部署成功：<span class="hljs-variable">${branch}</span>"</span>
        }
        failure {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ Web dist 部署失败"</span>
        }
    }
}
</code></pre>
<h5 data-id="heading-19">Jenkins控制台输出</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92ba06f259fd4b489325fbc512ca415e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5reu5qGR5qaG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284918&amp;x-signature=Uep3TlhTJuWBkzuEQY2EcOYVYoY%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-20">网页访问</h5>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmetrics.huaisangyu.top%2F" target="_blank" title="https://metrics.huaisangyu.top/" ref="nofollow noopener noreferrer">metrics.huaisangyu.top/</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cc0f97b1e654519b62bf4c4bbef237a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5reu5qGR5qaG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284918&amp;x-signature=c44CnIA11nYfrB31WIT8LgPKU1A%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-21">结尾营业</h2>
<p><strong>看官都看到这了，如果觉得不错，可不可以不吝啬你的小手手帮忙点个关注或者点个赞</strong></p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3731781bef4b43bc81c3b2824c91b6a3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=220&amp;h=220&amp;s=83473&amp;e=gif&amp;f=9&amp;b=fcf7f6" alt="711115f2517eae5e.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Prometheus告警规则编写：你必须知道的7个注意事项]]></title>    <link>https://juejin.cn/post/7600426046425579555</link>    <guid>https://juejin.cn/post/7600426046425579555</guid>    <pubDate>2026-01-29T09:45:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600426046425579555" data-draft-id="7600355625475522612" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Prometheus告警规则编写：你必须知道的7个注意事项"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2026-01-29T09:45:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpsEye"/> <meta itemprop="url" content="https://juejin.cn/user/2613979161324443"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Prometheus告警规则编写：你必须知道的7个注意事项
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2613979161324443/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpsEye
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:45:29.000Z" title="Thu Jan 29 2026 09:45:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为云原生监控的事实标准，Prometheus的告警规则编写直接影响监控系统的有效性和可靠性。本文将深入探讨在编写Prometheus告警规则时的关键注意事项，帮助您构建更加健壮的监控告警体系。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11e9b67258bd482697a59820da41ae61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BzRXll:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284728&amp;x-signature=tKNiBBrBBJG4hZvTmpgOYcCGUTg%3D" alt="640 (10).webp" loading="lazy"/></p>
<h2 data-id="heading-0">一、理解告警规则的基本结构</h2>
<p>在开始编写告警规则前，必须清楚告警规则的基本组成：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">groups:</span>
 <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">example</span>
  <span class="hljs-attr">rules:</span>
 <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighErrorRate</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">job:request_error_rate:ratio5m{job="myjob"}</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">0.5</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">10m</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
    <span class="hljs-attr">annotations:</span>
      <span class="hljs-attr">summary:</span> <span class="hljs-string">"High error rate on <span class="hljs-template-variable">{{ $labels.instance }}</span>"</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">"Error rate is <span class="hljs-template-variable">{{ $value }}</span>"</span>
</code></pre>
<p>每个告警规则包含：</p>
<ul>
<li><strong>alert</strong>  : 告警名称</li>
<li><strong>exp</strong>r  : PromQL表达式</li>
<li><strong>for</strong>  : 持续时间（可选）</li>
<li><strong>labels</strong>  : 附加标签</li>
<li><strong>annotations</strong>  : 告警详情注解</li>
</ul>
<h2 data-id="heading-1">二、合理设置告警持续时间（for）</h2>
<p><strong>for</strong>字段决定了触发条件持续多长时间才会真正触发告警。设置不当会导致：</p>
<ul>
<li>设置过短：产生大量短暂、无意义的告警（告警风暴）</li>
<li>设置过长：真正的问题可能被延迟发现</li>
</ul>
<p><strong>最佳实践：</strong></p>
<ul>
<li>对于关键业务指标：2-5分钟</li>
<li>对于资源类指标（CPU、内存等）：10-15分钟</li>
<li>对于需要长期观察的趋势性指标：30分钟以上</li>
</ul>
<h2 data-id="heading-2">三、编写高效的PromSQL表达式</h2>
<p>告警规则的核心是PromQL表达式，编写时应注意：
<strong>避免的问题：</strong></p>
<ul>
<li>使用高基数标签（如IP、ID等）导致查询性能下降</li>
<li>过于复杂的join操作增加计算负担</li>
<li>缺少必要的聚合导致告警过于具体</li>
</ul>
<p><strong>优化建议：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#不推荐 - 高基数</span>
<span class="hljs-built_in">expr</span>: rate(http_requests_total{status=~<span class="hljs-string">"5.."</span>}[5m]) &gt; 0.1
<span class="hljs-comment">#推荐 - 按job聚合</span>
<span class="hljs-built_in">expr</span>: <span class="hljs-built_in">sum</span> by(job) (rate(http_requests_total{status=~<span class="hljs-string">"5.."</span>}[5m])) / <span class="hljs-built_in">sum</span> by(job) (rate(http_requests_total[5m])) &gt; 0.1
</code></pre>
<h2 data-id="heading-3">四、合理使用标签和注解</h2>
<p><strong>labels使用原则：</strong></p>
<ul>
<li>用于告警路由（如severity=critical/warning）</li>
<li>用于告警分组（如region, cluster等）</li>
<li>避免使用可能频繁变化的值作为标签</li>
</ul>
<p><strong>annotations使用原则：</strong></p>
<ul>
<li>summary应简洁明了</li>
<li>description可包含详细信息和建议操作</li>
<li>使用模板变量（如{{ $labels.instance }}）使告警信息动态化</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">annotations:</span>
  <span class="hljs-attr">summary:</span> <span class="hljs-string">"High CPU usage on <span class="hljs-template-variable">{{ $labels.instance }}</span> (<span class="hljs-template-variable">{{ $value }}</span>%)"</span>
  <span class="hljs-attr">description:</span> <span class="hljs-string">"Instance <span class="hljs-template-variable">{{ $labels.instance }}</span> has been over 80% CPU usage for 10 minutes. Please check the process list."</span>
  <span class="hljs-attr">runbook:</span> <span class="hljs-string">"https://wiki.example.com/runbook/high-cpu"</span>
</code></pre>
<h2 data-id="heading-4">五、避免告警疲劳的关键策略</h2>
<p>告警疲劳是运维团队的大敌，可通过以下方式缓解：</p>
<p><strong>(1)分级告警：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">labels:</span>
  <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>  <span class="hljs-comment"># 或critical/page</span>
</code></pre>
<p><strong>(2)设置合理的告警阈值：</strong></p>
<ul>
<li>基于历史数据设置动态基线</li>
<li>区分工作日和节假日模式</li>
<li/>
</ul>
<p><strong>(3)抑制规则（inhibit_rules）：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">inhibit_rules:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">source_match:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">'critical'</span>
  <span class="hljs-attr">target_match:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">'warning'</span>
  <span class="hljs-attr">equal:</span> [<span class="hljs-string">'alertname'</span>, <span class="hljs-string">'instance'</span>]
</code></pre>
<h2 data-id="heading-5">六、测试与验证告警规则</h2>
<p>编写告警规则后必须进行验证：</p>
<p><strong>(1)使用promtool检查语法：</strong></p>
<pre><code class="hljs language-bash" lang="bash">promtool check rules /path/to/alert.rules
</code></pre>
<p><strong>(2)在测试环境触发模拟告警</strong></p>
<p><strong>(3)验证Alertmanager的接收和处理</strong></p>
<p><strong>(4)定期评审告警规则的有效性</strong></p>
<h2 data-id="heading-6">七、告警规则维护与文档化</h2>
<p>随着系统演进，告警规则需要持续维护：</p>
<p><strong>(1)为每个告警添加注释说明：</strong></p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 监控API服务的5xx错误率</span>
<span class="hljs-comment"># 阈值设置为1%是基于SLA 99.9%的要求</span>
<span class="hljs-comment"># 负责人：<span class="hljs-doctag">@team</span>-api</span>
</code></pre>
<p><strong>(2)使用版本控制系统管理规则文件</strong></p>
<p><strong>(3)定期清理不再使用的告警规则</strong></p>
<h2 data-id="heading-7">总结</h2>
<p>优秀的 Prometheus 告警规则，应当是 “在正确的时间，以正确的方式，告诉正确的人正确的问题”。希望本文所述的注意事项，可以帮助你避开常见的 “告警陷阱”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MedGemma 1.5：支持高维医学影像、解剖定位等多种功能；Patient Churn Prediction：面向医疗保健领域的分类数据集]]></title>    <link>https://juejin.cn/post/7600597995768217609</link>    <guid>https://juejin.cn/post/7600597995768217609</guid>    <pubDate>2026-01-29T10:09:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600597995768217609" data-draft-id="7600414546189893642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MedGemma 1.5：支持高维医学影像、解剖定位等多种功能；Patient Churn Prediction：面向医疗保健领域的分类数据集"/> <meta itemprop="keywords" content="深度学习,人工智能,机器学习"/> <meta itemprop="datePublished" content="2026-01-29T10:09:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenBayes贝式计算"/> <meta itemprop="url" content="https://juejin.cn/user/2793222200375607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MedGemma 1.5：支持高维医学影像、解剖定位等多种功能；Patient Churn Prediction：面向医疗保健领域的分类数据集
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2793222200375607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenBayes贝式计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:09:44.000Z" title="Thu Jan 29 2026 10:09:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>公共资源速递</strong></p>
<p><strong>5 个公共数据集：</strong></p>
<ul>
<li>
<p>CCTV Incident 跌倒检测数据集</p>
</li>
<li>
<p>Patient Segmentation 患者分类数据集</p>
</li>
<li>
<p>Hand Gestures Labbled 手势汽车游戏数据集</p>
</li>
<li>
<p>RealTimeFaceSwap-10k 视频通话伪造数据集</p>
</li>
<li>
<p>Patient Churn Prediction 患者流失预测数据集</p>
</li>
</ul>
<p><strong>8 个公共教程：</strong></p>
<ul>
<li>Triton 编译器教程</li>
</ul>
<p>* DiagGym 诊断智能体</p>
<ul>
<li>
<p>TRELLIS.2 3D 生成 Demo</p>
</li>
<li>
<p>WeDLM 高效大语言模型解码框架</p>
</li>
<li>
<p>MedGemma 1.5 多模态 AI 医疗模型</p>
</li>
</ul>
<p>* FLUX.2-klein-4B：极速图像生成模型</p>
<ul>
<li>Pocket-TTS：高质量轻量级流式 TTS 系统</li>
</ul>
<p>* vLLM+Open WebUI 部署 Nemotron-3 Nano</p>
<p><strong>访问官网立即使用：</strong> <em><strong>openbayes.com</strong></em></p>
<p><strong>公共数据集</strong></p>
<p><strong>1. CCTV Incident 跌倒检测数据集</strong></p>
<p>CCTV Incident 是一个开放式合成数据集，专门用于计算机视觉任务中的跌倒检测、姿态估计和事故监控，旨在从 CCTV 俯视视角进行分析，支持模型理解人类姿态，并准确区分站立和跌倒的个体。</p>
<p>在线使用：</p>
<p>***<strong><strong><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2Fm4WXY" target="_blank" title="https://go.openbayes.com/m4WXY" ref="nofollow noopener noreferrer">go.openbayes.com/m4WXY</a></strong></strong></strong></p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aaf2834606254942bd52bf2705aac2ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286187&amp;x-signature=IFL4FctowYG0mW8f5zpAeqKmQHI%3D" alt="图片" loading="lazy"/></p>
<p align="center">数据集示例</p>
<p><strong>2. Patient Segmentation 患者分类数据集</strong></p>
<p>Patient Segmentation 是一个面向医疗分析与营销的患者分类数据集。数据集包含 2,000 个患者记录，包括人口统计信息、健康指标、医疗使用情况、保险与参与情况，旨在通过分析患者信息，将患者分成有意义的群体，以提高个性化护理和营销的效果。</p>
<p>在线使用：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2Fr4IsF" target="_blank" title="https://go.openbayes.com/r4IsF" ref="nofollow noopener noreferrer">go.openbayes.com/r4IsF</a></strong></em></p>
<p><strong>3. Hand Gestures Labbled 手势汽车游戏数据集</strong></p>
<p>该数据集共包含 330 张手势图像，覆盖 4 类手势动作，各类别样本数量分别为 left（123 张）、mvefrd（137 张）、right（174 张）、stop（176 张）。</p>
<p>在线使用：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2FqdOE4" target="_blank" title="https://go.openbayes.com/qdOE4" ref="nofollow noopener noreferrer">go.openbayes.com/qdOE4</a></strong></em></p>
<p><strong>4. RealTimeFaceSwap-10k 视频通话伪造数据集</strong></p>
<p>该数据集包含 1,636 个目标视频片段，2,000 张用于人脸交换的来源照片和 9,772 个使用人脸交换模型生成的深度伪造视频，旨在为视频伪造检测提供基础数据支持。</p>
<p>在线使用：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2F9QTWO" target="_blank" title="https://go.openbayes.com/9QTWO" ref="nofollow noopener noreferrer">go.openbayes.com/9QTWO</a></strong></em></p>
<p><strong>5. Patient Churn Prediction 患者流失预测数据集</strong></p>
<p>该数据集包含 2,000 条患者记录，覆盖患者的人口统计信息，服务利用率指标，患者满意度指标，财务及参与因素，旨在帮助识别有流失风险的患者，以便于提前采取保留措施。</p>
<p>在线使用：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2F7pBpv" target="_blank" title="https://go.openbayes.com/7pBpv" ref="nofollow noopener noreferrer">go.openbayes.com/7pBpv</a></strong></em></p>
<p><strong>公共教程</strong></p>
<p><strong>1.</strong> <strong>Triton 编译器教程</strong></p>
<p>Triton 是一种用于并行编程的语言和编译器，旨在提供一个基于 Python 的编程环境，以高效编写自定义 DNN 计算内核，并能够在 GPU 硬件上以最大吞吐量运行。本项目是一套完整的 Triton 学习教程，涵盖了从基础到高级的各个方面，包括向量操作、矩阵运算、层标准化、注意力机制、以及 FP8 矩阵乘法等内容。</p>
<p>在线运行：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2Flw3JM" target="_blank" title="https://go.openbayes.com/lw3JM" ref="nofollow noopener noreferrer">go.openbayes.com/lw3JM</a></strong></em></p>
<p><strong>2.</strong> <strong>DiagGym 诊断智能体</strong></p>
<p>DiagAgent 是由上海交通大学和上海人工智能实验室的 AI4Med 团队发布的诊断智能体，能够主动管理诊断轨迹：选择最具信息量的检查、决定何时停止检查并给出准确的最终诊断。与传统医学大模型仅提供一次性答案不同，DiagAgent 可以推荐相关检查并在多轮对话中自适应更新诊断，只有在获得足够信息时才给出最终诊断。</p>
<p>在线运行：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2F7YQLf" target="_blank" title="https://go.openbayes.com/7YQLf" ref="nofollow noopener noreferrer">go.openbayes.com/7YQLf</a></strong></em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e00ab3f103c474e82c11e910b1eef34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286187&amp;x-signature=gTTZNopIrQ24IJwqcXoy4lrttAc%3D" alt="图片" loading="lazy"/></p>
<p align="center">项目示例</p>
<hr/>
<p><strong>3. TRELLIS.2 3D 生成 Demo</strong></p>
<p>TRELLIS.2 由 Microsoft 团队开源发布，面向单张图像生成高质量 3D 资产与纹理化任务。项目提供从输入图像到 3D 形状与材质的端到端流程，并配套可交互的 Web Demo，便于快速体验与导出资产。聚焦提升几何细节与纹理一致性，支持多种分辨率与级联推理配置，适用于 3D 内容生产、快速原型与创意探索等场景。</p>
<p>在线运行：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2FGPDWb" target="_blank" title="https://go.openbayes.com/GPDWb" ref="nofollow noopener noreferrer">go.openbayes.com/GPDWb</a></strong></em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23121f1713494a6799c1edc54d964635~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286187&amp;x-signature=03pMC9XN0r9wDLiKh%2FOsGGztXwM%3D" alt="图片" loading="lazy"/></p>
<p align="center">项目示例</p>
<p><strong>4. WeDLM 高效大语言模型解码框架</strong></p>
<p>WeDLM是由腾讯推出的高效大语言模型解码框架，旨在为下一代 AI 对话系统提供极速、智能且高度自适应的语言生成体验。该框架采用了创新的窗口并行解码架构，在保持高质量文本生成的同时，实现了显著的速度提升。其核心技术突破在于通过熵阈值决策与位置惩罚机制的结合，彻底解决了传统自回归解码在长序列生成中的速度瓶颈。</p>
<p>在线运行：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2FNGzhi" target="_blank" title="https://go.openbayes.com/NGzhi" ref="nofollow noopener noreferrer">go.openbayes.com/NGzhi</a></strong></em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/933c42d9367240cf8080bfa706ca15bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286187&amp;x-signature=avwzUUNbGC7B6EQ588ZlolyWnlg%3D" alt="图片" loading="lazy"/></p>
<p align="center">项目示例</p>
<p><strong>5. MedGemma 1.5 多模态 AI 医疗模型</strong></p>
<p>MedGemma 1.5 是由谷歌开源的多模态 AI 医学模型，专为处理医学影像和文本数据设计。模型支持高维医学影像（如 CT 和 MRI）、全切片病理影像、纵向影像分析、解剖定位、医学文档理解和电子健康记录（EHR）解读等功能。模型基于 SigLIP 图像编码器和强大的语言模型，使用多种医学数据进行预训练，包括影像、文本和实验室报告。</p>
<p>在线运行：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2F8ufT5" target="_blank" title="https://go.openbayes.com/8ufT5" ref="nofollow noopener noreferrer">go.openbayes.com/8ufT5</a></strong></em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdef8d8ed23342569f9ad16930d4d52e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286187&amp;x-signature=NztfyNk68EPiAIOixaPkWgd%2Bthk%3D" alt="图片" loading="lazy"/></p>
<p align="center">项目示例</p>
<p><strong>6. FLUX.2-klein-4B：极速图像生成模型</strong></p>
<p>FLUX.2-klein-4B 是由 Black Forest Labs (BFL) 推出的最新一代极速图像生成模型。作为 FLUX.2 系列中速度最快的蒸馏模型，它在一个紧凑的架构中统一了生成和编辑功能，拥有 40 亿参数（4B），能够在消费级显卡（约 13GB 显存）上运行。该模型采用 Rectified Flow Transformer 架构，实现了亚秒级（Sub-second）的端到端推理速度，专为需要实时生成且不牺牲质量的应用场景设计。</p>
<p>在线运行：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2FKOkFI" target="_blank" title="https://go.openbayes.com/KOkFI" ref="nofollow noopener noreferrer">go.openbayes.com/KOkFI</a></strong></em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7efc9eac6b65444ca01841f2991c7f05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286187&amp;x-signature=rfwyZaFoeXDP6eYXCk4V%2BMh%2FhOo%3D" alt="图片" loading="lazy"/></p>
<p align="center">项目示例</p>
<p><strong>7. Pocket-TTS：高质量轻量级流式 TTS 系统</strong></p>
<p>Pocket-TTS 是由 Kyutai 实验室发布的极轻量化语音合成模型。该模型专注于低延迟和流式输出，旨在为资源受限的环境或需要实时交互的场景（如 AI 助手）提供高质量的语音生成能力。采用了端到端的优化架构，在保证音质的同时，极大地提升了推理速度。相比传统的庞大 TTS 系统，它不仅体积更小，且支持实时流式推理，特别适合在高性能算力容器上进行快速部署与交互式应用。</p>
<p>在线运行：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2FZzj00" target="_blank" title="https://go.openbayes.com/Zzj00" ref="nofollow noopener noreferrer">go.openbayes.com/Zzj00</a></strong></em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f3986454bee43b88ec78e4b52cd442d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286187&amp;x-signature=gABErJPrjVoPzZKHcm0i%2BqLo33g%3D" alt="图片" loading="lazy"/></p>
<p align="center">项目示例</p>
<p><strong>8. vLLM+Open WebUI 部署 Nemotron-3 Nano</strong></p>
<p>Nemotron-3-Nano-30B-A3B-BF16 是 NVIDIA 从零开始训练的大型语言模型 (LLM)，旨在成为一个统一的模型，同时适用于推理和非推理任务。由 NVIDIA Corporation 发布的。Nemotron-3-Nano-30B-A3B-BF16 适用于开发人员设计 AI 代理系统、聊天机器人、RAG 系统和其他 AI 应用。</p>
<p>在线运行：</p>
<p><em><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.openbayes.com%2FLUA9Q" target="_blank" title="https://go.openbayes.com/LUA9Q" ref="nofollow noopener noreferrer">go.openbayes.com/LUA9Q</a></strong></em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef1b212b91004c26ac9c4f297c6ffa0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlbkJheWVz6LSd5byP6K6h566X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286187&amp;x-signature=bKXWABvFTNUHxrzbi44nA2u48cs%3D" alt="图片" loading="lazy"/></p>
<p align="center">项目示例</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native新架构之iOS端初始化源码分析]]></title>    <link>https://juejin.cn/post/7600223321041879046</link>    <guid>https://juejin.cn/post/7600223321041879046</guid>    <pubDate>2026-01-28T13:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600223321041879046" data-draft-id="7594000527509274665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native新架构之iOS端初始化源码分析"/> <meta itemprop="keywords" content="React Native,iOS,源码阅读"/> <meta itemprop="datePublished" content="2026-01-28T13:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="编程之路从0到1"/> <meta itemprop="url" content="https://juejin.cn/user/4125023359744296"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native新架构之iOS端初始化源码分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023359744296/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    编程之路从0到1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T13:41:51.000Z" title="Wed Jan 28 2026 13:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Native新架构之iOS端初始化源码分析</h2>
<h3 data-id="heading-1">前言</h3>
<p>注意，本文是基于<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact-native%2Ftree%2Fv0.83.0" target="_blank" title="https://github.com/facebook/react-native/tree/v0.83.0" ref="nofollow noopener noreferrer">React Native</a> 0.83版本源码进行分析。有了前面几篇Android端分析文章打基础，再来理解iOS端就易如反掌了。总的来说，iOS端的实现要比Android端简单太多了，这是因为Android端的Java/Kotlin 都是运行在Java的虚拟机环境中，其与C++通信要经过JNI，并不如OC与C++互调那么简单直接。此外，RN基于Android的Gradle构建机制，也使问题更加复杂。</p>
<h3 data-id="heading-2">初始化流程</h3>
<p>React Native的iOS端相比于安卓端要简单很多。现在我们基于Swift入口来分析一下初始化流程。首先找到RN源码工程中的测试工程，打开源码<code>react-native/private/helloworld/ios/HelloWorld/AppDelegate.swift</code>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> React                          <span class="hljs-comment">// React Native 核心模块</span>
<span class="hljs-keyword">import</span> ReactAppDependencyProvider     <span class="hljs-comment">// Codegen 生成的依赖提供者</span>
<span class="hljs-keyword">import</span> React_RCTAppDelegate           <span class="hljs-comment">// AppDelegate 相关类</span>
<span class="hljs-keyword">import</span> UIKit

<span class="hljs-keyword">@main</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {
  <span class="hljs-keyword">var</span> window: <span class="hljs-type">UIWindow</span>?

  <span class="hljs-keyword">var</span> reactNativeDelegate: <span class="hljs-type">ReactNativeDelegate</span>?
  <span class="hljs-keyword">var</span> reactNativeFactory: <span class="hljs-type">RCTReactNativeFactory</span>?

  <span class="hljs-keyword">func</span> <span class="hljs-title function_">application</span>(
    <span class="hljs-keyword">_</span> <span class="hljs-params">application</span>: <span class="hljs-type">UIApplication</span>,
    <span class="hljs-params">didFinishLaunchingWithOptions</span> <span class="hljs-params">launchOptions</span>: [<span class="hljs-type">UIApplication</span>.<span class="hljs-params">LaunchOptionsKey</span>: <span class="hljs-keyword">Any</span>]<span class="hljs-operator">?</span> <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
  ) -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-comment">// 1: 创建 ReactNativeDelegate</span>
    <span class="hljs-keyword">let</span> delegate <span class="hljs-operator">=</span> <span class="hljs-type">ReactNativeDelegate</span>()
    <span class="hljs-comment">// 2: 创建 RCTReactNativeFactory</span>
    <span class="hljs-keyword">let</span> factory <span class="hljs-operator">=</span> <span class="hljs-type">RCTReactNativeFactory</span>(delegate: delegate)
    <span class="hljs-comment">// 3: 配置依赖提供者（Codegen 生成的模块）</span>
    delegate.dependencyProvider <span class="hljs-operator">=</span> <span class="hljs-type">RCTAppDependencyProvider</span>()

    <span class="hljs-comment">// 保持强引用</span>
    reactNativeDelegate <span class="hljs-operator">=</span> delegate
    reactNativeFactory <span class="hljs-operator">=</span> factory

    <span class="hljs-comment">// 4: 配置开发菜单（仅 DEBUG 模式）</span>
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-keyword">let</span> devMenuConfiguration <span class="hljs-operator">=</span> <span class="hljs-type">RCTDevMenuConfiguration</span>(
      devMenuEnabled: <span class="hljs-literal">true</span>,
      shakeGestureEnabled: <span class="hljs-literal">true</span>,
      keyboardShortcutsEnabled: <span class="hljs-literal">true</span>
    )
    reactNativeFactory<span class="hljs-operator">?</span>.devMenuConfiguration <span class="hljs-operator">=</span> devMenuConfiguration
    <span class="hljs-keyword">#endif</span>

    <span class="hljs-comment">// 5: 创建主窗口</span>
    window <span class="hljs-operator">=</span> <span class="hljs-type">UIWindow</span>(frame: <span class="hljs-type">UIScreen</span>.main.bounds)

    <span class="hljs-comment">// 6: 启动 React Native</span>
    factory.startReactNative(
      withModuleName: <span class="hljs-string">"HelloWorld"</span>,
      in: window,
      launchOptions: launchOptions
    )

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactNativeDelegate</span>: <span class="hljs-title class_">RCTDefaultReactNativeFactoryDelegate</span> {
  <span class="hljs-comment">// 旧架构兼容（新架构中会调用 bundleURL）</span>
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">sourceURL</span>(<span class="hljs-params">for</span> <span class="hljs-params">bridge</span>: <span class="hljs-type">RCTBridge</span>) -&gt; <span class="hljs-type">URL</span>? {
    <span class="hljs-keyword">self</span>.bundleURL()
  }

  <span class="hljs-comment">// 提供 JS Bundle 的 URL</span>
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">bundleURL</span>() -&gt; <span class="hljs-type">URL</span>? {
    <span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
    <span class="hljs-comment">// 开发模式：从 Metro 开发服务器加载</span>
    <span class="hljs-type">RCTBundleURLProvider</span>.sharedSettings().jsBundleURL(forBundleRoot: <span class="hljs-string">"index"</span>)
    <span class="hljs-keyword">#else</span>
    <span class="hljs-comment">// 生产模式：从 App Bundle 加载</span>
    <span class="hljs-type">Bundle</span>.main.url(forResource: <span class="hljs-string">"main"</span>, withExtension: <span class="hljs-string">"jsbundle"</span>)
    <span class="hljs-keyword">#endif</span>
  }
}
</code></pre>
<p>Swift 新架构使用 <code>@main</code> 注解作为应用入口，无需 <code>main.m</code> 或 <code>main.swift</code> 文件。<code>ReactNativeDelegate</code> 继承自 <code>RCTDefaultReactNativeFactoryDelegate</code>，负责提供 Bundle URL 和自定义配置。</p>
<p>这里<code>RCTAppDependencyProvider</code>是Objective-C++代码，这是为了方便与C++互调。源码<code>tcode/react-native/packages/react-native/Libraries/AppDelegate/RCTReactNativeFactory.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">RCTReactNativeFactory</span> () &lt;</span>
    RCTComponentViewFactoryComponentProvider, <span class="hljs-comment">// Fabric 组件提供者</span>
    RCTHostDelegate,                          <span class="hljs-comment">// RCTHost 代理</span>
    RCTJSRuntimeConfiguratorProtocol,         <span class="hljs-comment">// JS Runtime 配置</span>
    RCTTurboModuleManagerDelegate&gt;            <span class="hljs-comment">// TurboModule 管理器代理</span>
<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RCTReactNativeFactory</span></span>

- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTReactNativeFactoryDelegate&gt;)delegate
{
  <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> initWithDelegate:delegate releaseLevel:Stable];
}

- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTReactNativeFactoryDelegate&gt;)delegate releaseLevel:(RCTReleaseLevel)releaseLevel
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) {
    <span class="hljs-keyword">self</span>.delegate = delegate;
    [<span class="hljs-keyword">self</span> _setUpFeatureFlags:releaseLevel];
    <span class="hljs-comment">// 设置默认颜色空间</span>
    [RCTColorSpaceUtils applyDefaultColorSpace:[<span class="hljs-keyword">self</span> defaultColorSpace]];
    RCTEnableTurboModule(<span class="hljs-literal">YES</span>);

    <span class="hljs-comment">// 创建 RCTRootViewFactory</span>
    <span class="hljs-keyword">self</span>.rootViewFactory = [<span class="hljs-keyword">self</span> createRCTRootViewFactory];
    <span class="hljs-comment">// 设置第三方 Fabric 组件提供者</span>
    [RCTComponentViewFactory currentComponentViewFactory].thirdPartyFabricComponentsProvider = <span class="hljs-keyword">self</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}
</code></pre>
<p>可以看到RCTReactNativeFactory的构造逻辑非常简单，但它实现了四个关键协议，这使得它可以作为多个子系统的代理。</p>
<p>先重点看一下<code>createRCTRootViewFactory</code>方法的实现，这是一个关键方法，同时设置了大量的回调 Block 来桥接代理模式：</p>
<pre><code class="hljs language-objc" lang="objc">- (RCTRootViewFactory *)createRCTRootViewFactory
{
  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 1. 创建 Bundle URL 提供者 Block</span>
  RCTBundleURLBlock bundleUrlBlock = ^{
    auto *strongSelf = weakSelf;
    <span class="hljs-keyword">return</span> strongSelf.bundleURL;
  };

  <span class="hljs-comment">// 2. 创建配置对象（新架构默认全部启用）</span>
  RCTRootViewFactoryConfiguration *configuration =
      [[RCTRootViewFactoryConfiguration alloc] initWithBundleURLBlock:bundleUrlBlock
                                                       newArchEnabled:<span class="hljs-literal">YES</span>
                                                   turboModuleEnabled:<span class="hljs-literal">YES</span>
                                                    bridgelessEnabled:<span class="hljs-literal">YES</span>];

  <span class="hljs-comment">// 省略旧架构代码......</span>

  <span class="hljs-comment">// 3.配置根视图自定义回调</span>
  configuration.customizeRootView = ^(<span class="hljs-built_in">UIView</span> *_Nonnull rootView) {
    [weakSelf.delegate customizeRootView:(RCTRootView *)rootView];
  };

  <span class="hljs-comment">// 4.配置 Bundle URL 获取回调</span>
  configuration.sourceURLForBridge = ^<span class="hljs-built_in">NSURL</span> *_Nullable(RCTBridge *_Nonnull bridge)
  {
    <span class="hljs-comment">// 新架构：直接使用 bundleURL，不再依赖 bridge</span>
    <span class="hljs-keyword">return</span> [weakSelf.delegate bundleURL];
  };

  <span class="hljs-comment">// 5.配置 Bundle 加载回调（支持进度）</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(loadSourceForBridge:onProgress:onComplete:)]) {
    configuration.loadSourceForBridgeWithProgress =
        ^(RCTBridge *_Nonnull bridge,
          RCTSourceLoadProgressBlock _Nonnull onProgress,
          RCTSourceLoadBlock _Nonnull loadCallback) {
          <span class="hljs-comment">// 新架构：使用 loadBundleAtURL 替代旧的 loadSourceForBridge</span>
          [weakSelf.delegate loadBundleAtURL:<span class="hljs-keyword">self</span>.bundleURL onProgress:onProgress onComplete:loadCallback];
        };
  }

  <span class="hljs-comment">// 6.配置无进度的 Bundle 加载回调</span>
  <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(loadSourceForBridge:withBlock:)]) {
    configuration.loadSourceForBridge = ^(RCTBridge *_Nonnull bridge, RCTSourceLoadBlock _Nonnull loadCallback) {
      <span class="hljs-comment">// 新架构：使用 loadBundleAtURL，进度回调为空</span>
      [weakSelf.delegate loadBundleAtURL:<span class="hljs-keyword">self</span>.bundleURL
                              onProgress:^(RCTLoadingProgress *progressData) {
                              }
                              onComplete:loadCallback];
    };
  }

  <span class="hljs-comment">// 7.设置 JS Runtime 代理</span>
  configuration.jsRuntimeConfiguratorDelegate = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 8.创建并返回 RCTRootViewFactory</span>
  <span class="hljs-keyword">return</span> [[RCTRootViewFactory alloc] initWithTurboModuleDelegate:<span class="hljs-keyword">self</span> hostDelegate:<span class="hljs-keyword">self</span> configuration:configuration];
}
</code></pre>
<p>这里的大概流程是非常清楚的，主要就是设置了四个协议的代理。我们将流程绘制成一个关系图：</p>
<pre><code class="hljs language-lua" lang="lua">┌─────────────────────────────────────────────────────────────────────────┐
│                        RCTReactNativeFactory                             │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 实现协议:                                                          │  │
│  │  • RCTTurboModuleManagerDelegate    → TurboModule 类/实例查找      │  │
│  │  • RCTHostDelegate                  → Host 生命周期 + Bundle 加载  │  │
│  │  • RCTJSRuntimeConfiguratorProtocol → JS Runtime 工厂创建         │  │
│  │  • RCTComponentViewFactoryComponentProvider → Fabric 组件注册     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ createRCTRootViewFactory() 中设置:                                 │  │
│  │  • initWithTurboModuleDelegate: <span class="hljs-built_in">self</span>  ← RCTTurboModuleManagerDelegate│
│  │  • hostDelegate: <span class="hljs-built_in">self</span>                 ← RCTHostDelegate              │
│  │  • jsRuntimeConfiguratorDelegate: <span class="hljs-built_in">self</span> ← RCTJSRuntimeConfiguratorProtocol│
│  └───────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 初始化时设置:                                                       │  │
│  │  • thirdPartyFabricComponentsProvider = <span class="hljs-built_in">self</span>                       │  │
│  │    ← RCTComponentViewFactoryComponentProvider                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-3">RCTTurboModuleManagerDelegate</h4>
<p>主要负责 TurboModule 的类查找和实例创建，源码<code>react-native/packages/react-native/ReactCommon/react/nativemodule/core/platform/ios/ReactCommon/RCTTurboModuleManager.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTBridgeProxy</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTTurboModuleManager</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTDevMenuConfigurationDecorator</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTTurboModuleManagerDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>

<span class="hljs-comment">/**
 * 给定模块名称，返回其实际类。如果返回 nil，则执行基本的 ObjC 类查找
 */</span>
- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name;

<span class="hljs-comment">/**
 * 给定一个模块类，为其提供一个实例。如果返回值为 nil，则使用默认初始化器
 */</span>
- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass;

<span class="hljs-keyword">@optional</span>

<span class="hljs-comment">/**
 * 此方法用于获取一个工厂对象，该对象可以创建 `facebook::react::TurboModule` 实例。
 * 实现 `RCTTurboModuleProvider` 接口的类必须是 Objective-C 类，以便我们可以使用代码生成工具对其进行动态初始化。
 */</span>
- (<span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name;

<span class="hljs-comment">/**
 * 创建一个 TurboModule 实例，而无需依赖任何 ObjC++ 模块实例
 */</span>
- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:
                                                          (std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker;

- (<span class="hljs-type">void</span>)installJSBindings:(facebook::jsi::Runtime &amp;)runtime;

- (<span class="hljs-type">void</span>)invalidate;

<span class="hljs-keyword">@end</span>
</code></pre>
<p>再来看看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTTurboModuleManagerDelegate</span>

- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DISABLE_OSS_PLUGIN_HEADER</span>
  <span class="hljs-keyword">return</span> RCTTurboModulePluginClassProvider(name);
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-comment">// 先尝试从 delegate 获取</span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleClassFromName:)]) {
    Class moduleClass = [_delegate getModuleClassFromName:name];
    <span class="hljs-keyword">if</span> (moduleClass != <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> moduleClass;
    }
  }
  <span class="hljs-keyword">return</span> RCTCoreModulesClassProvider(name);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleProvider:)]) {
    <span class="hljs-keyword">return</span> [_delegate getModuleProvider:name];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}

<span class="hljs-comment">// 创建纯 C++ TurboModule</span>
- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:(std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getTurboModule:jsInvoker:)]) {
    <span class="hljs-keyword">return</span> [_delegate getTurboModule:name jsInvoker:jsInvoker];
  }

  <span class="hljs-keyword">return</span> facebook::react::DefaultTurboModules::getTurboModule(name, jsInvoker);
}

- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_OSS_CODEGEN</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.delegate.dependencyProvider == <span class="hljs-literal">nil</span>) {
    [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"ReactNativeFactoryDelegate dependencyProvider is nil"</span>
                format:<span class="hljs-string">@"Delegate must provide a valid dependencyProvider"</span>];
  }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(getModuleInstanceFromClass:)]) {
    <span class="hljs-type">id</span>&lt;RCTTurboModule&gt; moduleInstance = [_delegate getModuleInstanceFromClass:moduleClass];
    <span class="hljs-keyword">if</span> (moduleInstance != <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> moduleInstance;
    }
  }
  <span class="hljs-comment">// 使用默认方式创建（通过 dependencyProvider）</span>
  <span class="hljs-keyword">return</span> RCTAppSetupDefaultModuleFromClass(moduleClass, <span class="hljs-keyword">self</span>.delegate.dependencyProvider);
}
</code></pre>
<h4 data-id="heading-4">RCTHostDelegate</h4>
<p>主要负责 RCTHost 的生命周期和 Bundle 加载。源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTHost.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span>

<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTFabricSurface</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTHost</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTModuleRegistry</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">@class</span> <span class="hljs-title">RCTDevMenuConfiguration</span>;</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTTurboModuleManagerDelegate</span>;</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-built_in">NSURL</span> *_Nullable (^RCTHostBundleURLProvider)(<span class="hljs-type">void</span>);

<span class="hljs-comment">// Runtime API</span>

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTHostDelegate</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>
<span class="hljs-comment">// Host 启动完成通知</span>
- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host;

<span class="hljs-keyword">@optional</span>
<span class="hljs-comment">// 需要在主线程初始化的模块列表</span>
- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup;

<span class="hljs-comment">// 加载 Bundle（支持进度回调）</span>
- (<span class="hljs-type">void</span>)loadBundleAtURL:(<span class="hljs-built_in">NSURL</span> *)sourceURL
             onProgress:(RCTSourceLoadProgressBlock)onProgress
             onComplete:(RCTSourceLoadBlock)loadCallback;

<span class="hljs-keyword">@end</span>


<span class="hljs-built_in">NS_ASSUME_NONNULL_END</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTHostDelegate</span>

- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host
{
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(hostDidStart:)]) {
    [_delegate hostDidStart:host];
  }
}

- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RN_DISABLE_OSS_PLUGIN_HEADER</span>
  <span class="hljs-keyword">return</span> RCTTurboModulePluginUnstableModulesRequiringMainQueueSetup();
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.delegate.dependencyProvider
      ? RCTAppSetupUnstableModulesRequiringMainQueueSetup(<span class="hljs-keyword">self</span>.delegate.dependencyProvider)
      : @[];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}
</code></pre>
<h4 data-id="heading-5">RCTJSRuntimeConfiguratorProtocol</h4>
<p>主要负责创建 JS Runtime 工厂，源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTJSRuntimeConfiguratorProtocol.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-built_in">NS_ASSUME_NONNULL_BEGIN</span>

<span class="hljs-comment">// Forward declarations for umbrella headers.</span>
<span class="hljs-comment">// In implementations, import `&lt;react/runtime/JSRuntimeFactoryCAPI.h&gt;` to obtain the actual type.</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-type">void</span> *JSRuntimeFactoryRef;

<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTJSRuntimeConfiguratorProtocol</span></span>

<span class="hljs-comment">// 创建 JS Runtime 工厂（通常返回 Hermes）</span>
- (JSRuntimeFactoryRef)createJSRuntimeFactory;

<span class="hljs-keyword">@end</span>

<span class="hljs-built_in">NS_ASSUME_NONNULL_END</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTJSRuntimeConfiguratorProtocol</span>

- (JSRuntimeFactoryRef)createJSRuntimeFactory
{
  <span class="hljs-comment">// 委托给用户的 delegate</span>
  <span class="hljs-keyword">return</span> [_delegate createJSRuntimeFactory];
}
</code></pre>
<h4 data-id="heading-6">RCTComponentViewFactoryComponentProvider</h4>
<p>主要负责提供第三方 Fabric 组件，源码<code>react-native/packages/react-native/React/Fabric/Mounting/RCTComponentViewFactory.h</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">/**
 * 可用于向 Fabric 提供第三方组件的协议。
 * Fabric 将检查此映射表，以确定是否存在需要注册的组件。
 */</span>
<span class="hljs-class"><span class="hljs-keyword">@protocol</span> <span class="hljs-title">RCTComponentViewFactoryComponentProvider</span> &lt;<span class="hljs-title">NSObject</span>&gt;</span>

<span class="hljs-comment">/**
 * 返回一个第三方组件字典，其中 `key` 是组件处理程序，`value` 是一个符合 `RCTComponentViewProtocol` 协议的类
 */</span>
- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents;

<span class="hljs-keyword">@end</span>
</code></pre>
<p>查看<strong>RCTReactNativeFactory</strong> 中的实现：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTComponentViewFactoryComponentProvider</span>

- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents
{
  <span class="hljs-comment">// 先尝试从 delegate 获取</span>
  <span class="hljs-keyword">if</span> ([_delegate respondsToSelector:<span class="hljs-keyword">@selector</span>(thirdPartyFabricComponents)]) {
    <span class="hljs-keyword">return</span> _delegate.thirdPartyFabricComponents;
  }
  <span class="hljs-comment">// 回退到 dependencyProvider（Codegen 生成）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.delegate.dependencyProvider ? <span class="hljs-keyword">self</span>.delegate.dependencyProvider.thirdPartyFabricComponents : @{};
}
</code></pre>
<h4 data-id="heading-7">RCTDefaultReactNativeFactoryDelegate</h4>
<p>以上协的很多方法的实现，其实也是代理给<strong>RCTReactNativeFactory</strong> 中的<code>delegate</code>对象。此<code>delegate</code>也就是我们最开始自定义的<code>ReactNativeDelegate</code>实例。其也是继承自<code>RCTDefaultReactNativeFactoryDelegate</code>，现在分析一下此类的实现，源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTDefaultReactNativeFactoryDelegate.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">RCTDefaultReactNativeFactoryDelegate</span></span>

<span class="hljs-keyword">@synthesize</span> dependencyProvider;
<span class="hljs-comment">// 抽象方法：子类必须实现</span>
- (<span class="hljs-built_in">NSURL</span> *_Nullable)sourceURLForBridge:(<span class="hljs-keyword">nonnull</span> RCTBridge *)bridge
{
  [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"RCTBridgeDelegate::sourceURLForBridge not implemented"</span>
              format:<span class="hljs-string">@"Subclasses must implement a valid sourceURLForBridge method"</span>];
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
}

- (<span class="hljs-built_in">UIViewController</span> *)createRootViewController
{
  <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIViewController</span> new];
}

- (<span class="hljs-type">void</span>)setRootView:(<span class="hljs-built_in">UIView</span> *)rootView toRootViewController:(<span class="hljs-built_in">UIViewController</span> *)rootViewController
{
  rootViewController.view = rootView;
}

- (JSRuntimeFactoryRef)createJSRuntimeFactory
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> USE_THIRD_PARTY_JSC != 1</span>
  <span class="hljs-keyword">return</span> jsrt_create_hermes_factory();
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

- (<span class="hljs-type">void</span>)customizeRootView:(RCTRootView *)rootView
{
  <span class="hljs-comment">// Override point for customization after application launch.</span>
}

- (RCTColorSpace)defaultColorSpace
{
  <span class="hljs-keyword">return</span> RCTColorSpaceSRGB;
}

- (<span class="hljs-built_in">NSURL</span> *_Nullable)bundleURL
{
  [<span class="hljs-built_in">NSException</span> raise:<span class="hljs-string">@"RCTAppDelegate::bundleURL not implemented"</span>
              format:<span class="hljs-string">@"Subclasses must implement a valid getBundleURL method"</span>];
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">NSString</span> *, Class&lt;RCTComponentViewProtocol&gt;&gt; *)thirdPartyFabricComponents
{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr) ? <span class="hljs-keyword">self</span>.dependencyProvider.thirdPartyFabricComponents : @{};
}

- (<span class="hljs-type">void</span>)hostDidStart:(RCTHost *)host
{
}

- (<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *)unstableModulesRequiringMainQueueSetup
{
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr)
      ? RCTAppSetupUnstableModulesRequiringMainQueueSetup(<span class="hljs-keyword">self</span>.dependencyProvider)
      : @[];
}

- (<span class="hljs-keyword">nullable</span> <span class="hljs-type">id</span>&lt;RCTModuleProvider&gt;)getModuleProvider:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-built_in">NSString</span> *providerName = [<span class="hljs-built_in">NSString</span> stringWithCString:name encoding:<span class="hljs-built_in">NSUTF8StringEncoding</span>];
  <span class="hljs-keyword">return</span> (<span class="hljs-keyword">self</span>.dependencyProvider != nullptr) ? <span class="hljs-keyword">self</span>.dependencyProvider.moduleProviders[providerName] : nullptr;
}

- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:(<span class="hljs-keyword">const</span> std::string &amp;)name
                                                      jsInvoker:(std::shared_ptr&lt;facebook::react::CallInvoker&gt;)jsInvoker
{
  <span class="hljs-keyword">return</span> facebook::react::DefaultTurboModules::getTurboModule(name, jsInvoker);
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> mark - RCTArchConfiguratorProtocol</span>

- (<span class="hljs-type">BOOL</span>)newArchEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)bridgelessEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)fabricEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">BOOL</span>)turboModuleEnabled
{
  <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (Class)getModuleClassFromName:(<span class="hljs-keyword">const</span> <span class="hljs-type">char</span> *)name
{
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-type">id</span>&lt;RCTTurboModule&gt;)getModuleInstanceFromClass:(Class)moduleClass
{
  <span class="hljs-keyword">return</span> nullptr;
}

- (<span class="hljs-type">void</span>)loadSourceForBridge:(RCTBridge *)bridge
                 onProgress:(RCTSourceLoadProgressBlock)onProgress
                 onComplete:(RCTSourceLoadBlock)loadCallback
{
  [RCTJavaScriptLoader loadBundleAtURL:[<span class="hljs-keyword">self</span> sourceURLForBridge:bridge] onProgress:onProgress onComplete:loadCallback];
}

<span class="hljs-keyword">@end</span>
</code></pre>
<h4 data-id="heading-8">React Native 启动</h4>
<p>对于以上四个协议以及代理，我们已经有了大概认识，现在应该把视线拉回<strong>AppDelegate</strong>中的初始化流程，继续分析<code>startReactNative</code>方法的实现，它对应的OC方法名应该是<code>startReactNativeWithModuleName</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)startReactNativeWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                              inWindow:(<span class="hljs-built_in">UIWindow</span> *_Nullable)window
                         launchOptions:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)launchOptions
{
  [<span class="hljs-keyword">self</span> startReactNativeWithModuleName:moduleName inWindow:window initialProperties:<span class="hljs-literal">nil</span> launchOptions:launchOptions];
}

- (<span class="hljs-type">void</span>)startReactNativeWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                              inWindow:(<span class="hljs-built_in">UIWindow</span> *_Nullable)window
                     initialProperties:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)initialProperties
                         launchOptions:(<span class="hljs-built_in">NSDictionary</span> *_Nullable)launchOptions
{
  <span class="hljs-comment">// 1. 通过 RootViewFactory 创建根视图</span>
  <span class="hljs-built_in">UIView</span> *rootView = [<span class="hljs-keyword">self</span>.rootViewFactory viewWithModuleName:moduleName
                                            initialProperties:initialProperties
                                                launchOptions:launchOptions
                                         devMenuConfiguration:<span class="hljs-keyword">self</span>.devMenuConfiguration];
  <span class="hljs-comment">// 2. 创建 RootViewController</span>
  <span class="hljs-built_in">UIViewController</span> *rootViewController = [_delegate createRootViewController];
  <span class="hljs-comment">// 3. 设置根视图</span>
  [_delegate setRootView:rootView toRootViewController:rootViewController];
  <span class="hljs-comment">// 4. 配置窗口并显示</span>
  window.rootViewController = rootViewController;
  [window makeKeyAndVisible];
}
</code></pre>
<p>可以看到，流程十分清楚，我们继续跟踪<code>viewWithModuleName</code>方法实现。</p>
<h5 data-id="heading-9">RCTHost  (ReactHost)初始化</h5>
<p>查看源码<code>react-native/packages/react-native/Libraries/AppDelegate/RCTRootViewFactory.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-built_in">UIView</span> *)viewWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
             initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)initProps
                 launchOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
          devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-comment">// 1. 初始化 ReactHost</span>
  [<span class="hljs-keyword">self</span> initializeReactHostWithLaunchOptions:launchOptions devMenuConfiguration:devMenuConfiguration];

  <span class="hljs-comment">// 2. 创建 Fabric Surface</span>
  RCTFabricSurface *surface = [<span class="hljs-keyword">self</span>.reactHost createSurfaceWithModuleName:moduleName
                                                        initialProperties:initProps ? initProps : @{}];
   <span class="hljs-comment">// 3. 创建 SurfaceHostingProxyRootView</span>
  RCTSurfaceHostingProxyRootView *surfaceHostingProxyRootView =
      [[RCTSurfaceHostingProxyRootView alloc] initWithSurface:surface];

  surfaceHostingProxyRootView.backgroundColor = [<span class="hljs-built_in">UIColor</span> systemBackgroundColor];
  <span class="hljs-keyword">if</span> (_configuration.customizeRootView != <span class="hljs-literal">nil</span>) {
    <span class="hljs-comment">// 4. 自定义根视图</span>
    _configuration.customizeRootView(surfaceHostingProxyRootView);
  }
  <span class="hljs-keyword">return</span> surfaceHostingProxyRootView;
}


- (<span class="hljs-type">void</span>)initializeReactHostWithLaunchOptions:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
                        devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-comment">// Enable TurboModule interop by default in Bridgeless mode</span>
  RCTEnableTurboModuleInterop(<span class="hljs-literal">YES</span>);
  RCTEnableTurboModuleInteropBridgeProxy(<span class="hljs-literal">YES</span>);

  [<span class="hljs-keyword">self</span> createReactHostIfNeeded:launchOptions devMenuConfiguration:devMenuConfiguration];
  <span class="hljs-keyword">return</span>;
}

- (<span class="hljs-type">void</span>)createReactHostIfNeeded:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
           devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.reactHost) {
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">self</span>.reactHost = [<span class="hljs-keyword">self</span> createReactHost:launchOptions devMenuConfiguration:devMenuConfiguration];
}


- (RCTHost *)createReactHost:(<span class="hljs-built_in">NSDictionary</span> *)launchOptions
        devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  RCTHost *reactHost =
      [[RCTHost alloc] initWithBundleURLProvider:<span class="hljs-keyword">self</span>-&gt;_configuration.bundleURLBlock
                                    hostDelegate:_hostDelegate
                      turboModuleManagerDelegate:_turboModuleManagerDelegate
                                jsEngineProvider:^std::shared_ptr&lt;facebook::react::JSRuntimeFactory&gt;() {
                                  <span class="hljs-keyword">return</span> [weakSelf createJSRuntimeFactory];
                                }
                                   launchOptions:launchOptions
                            devMenuConfiguration:devMenuConfiguration];
  <span class="hljs-comment">// 设置 Bundle URL 提供者</span>
  [reactHost setBundleURLProvider:^<span class="hljs-built_in">NSURL</span> *() {
    <span class="hljs-keyword">return</span> [weakSelf bundleURL];
  }];
  <span class="hljs-comment">// 启动 ReactHost</span>
  [reactHost start];
  <span class="hljs-keyword">return</span> reactHost;
}
</code></pre>
<h5 data-id="heading-10">RCTInstance 初始化</h5>
<p>继续跟踪<code>RCTHost</code>的<code>start</code>方法。源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTHost.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)start
{
  <span class="hljs-comment">// 1. 设置 Bundle URL</span>
  <span class="hljs-keyword">if</span> (_bundleURLProvider) {
    [<span class="hljs-keyword">self</span> _setBundleURL:_bundleURLProvider()];
  }

  <span class="hljs-comment">// 2. 设置 Inspector Target（用于调试）</span>
  auto &amp;inspectorFlags = jsinspector_modern::InspectorFlags::getInstance();
  <span class="hljs-keyword">if</span> (inspectorFlags.getFuseboxEnabled() &amp;&amp; !_inspectorPageId.has_value()) {
    _inspectorTarget =
        facebook::react::jsinspector_modern::HostTarget::create(*_inspectorHostDelegate, [](auto callback) {
          RCTExecuteOnMainQueue(^{
            callback();
          });
        });
    __<span class="hljs-keyword">weak</span> RCTHost *weakSelf = <span class="hljs-keyword">self</span>;
    _inspectorPageId = facebook::react::jsinspector_modern::getInspectorInstance().addPage(
        <span class="hljs-string">"React Native Bridgeless"</span>,
        <span class="hljs-comment">/* vm */</span> <span class="hljs-string">""</span>,
        [weakSelf](std::unique_ptr&lt;facebook::react::jsinspector_modern::IRemoteConnection&gt; remote)
            -&gt; std::unique_ptr&lt;facebook::react::jsinspector_modern::ILocalConnection&gt; {
          RCTHost *strongSelf = weakSelf;
          <span class="hljs-keyword">if</span> (!strongSelf) {
            <span class="hljs-comment">// This can happen if we're about to be dealloc'd. Reject the connection.</span>
            <span class="hljs-keyword">return</span> nullptr;
          }
          <span class="hljs-keyword">return</span> strongSelf-&gt;_inspectorTarget-&gt;connect(std::move(remote));
        },
        {.nativePageReloads = <span class="hljs-literal">true</span>, .prefersFuseboxFrontend = <span class="hljs-literal">true</span>});
  }
  <span class="hljs-keyword">if</span> (_instance) {
    RCTLogWarn(
        <span class="hljs-string">@"RCTHost should not be creating a new instance if one already exists. This implies there is a bug with how/when this method is being called."</span>);
    [_instance invalidate];
  }

  <span class="hljs-comment">// 3. 创建 RCTInstance</span>
  _instance = [[RCTInstance alloc] initWithDelegate:<span class="hljs-keyword">self</span>
                                   jsRuntimeFactory:[<span class="hljs-keyword">self</span> _provideJSEngine]
                                      bundleManager:_bundleManager
                         turboModuleManagerDelegate:_turboModuleManagerDelegate
                                     moduleRegistry:_moduleRegistry
                              parentInspectorTarget:_inspectorTarget.get()
                                      launchOptions:_launchOptions
                               devMenuConfiguration:_devMenuConfiguration];
  <span class="hljs-comment">// 4. 通知代理 Host 已启动</span>
  [_hostDelegate hostDidStart:<span class="hljs-keyword">self</span>];
}
</code></pre>
<p>继续查看<code>RCTInstance</code>的构造实现，源码<code>react-native/packages/react-native/ReactCommon/react/runtime/platform/ios/ReactCommon/RCTInstance.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-keyword">instancetype</span>)initWithDelegate:(<span class="hljs-type">id</span>&lt;RCTInstanceDelegate&gt;)delegate
                jsRuntimeFactory:(std::shared_ptr&lt;facebook::react::JSRuntimeFactory&gt;)jsRuntimeFactory
                   bundleManager:(RCTBundleManager *)bundleManager
      turboModuleManagerDelegate:(<span class="hljs-type">id</span>&lt;RCTTurboModuleManagerDelegate&gt;)tmmDelegate
                  moduleRegistry:(RCTModuleRegistry *)moduleRegistry
           parentInspectorTarget:(jsinspector_modern::HostTarget *)parentInspectorTarget
                   launchOptions:(<span class="hljs-keyword">nullable</span> <span class="hljs-built_in">NSDictionary</span> *)launchOptions
            devMenuConfiguration:(RCTDevMenuConfiguration *)devMenuConfiguration
{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> init]) {
    <span class="hljs-comment">// 性能监控初始化</span>
    _performanceLogger = [RCTPerformanceLogger new];
    registerPerformanceLoggerHooks(_performanceLogger);
    [_performanceLogger markStartForTag:RCTPLReactInstanceInit];

    <span class="hljs-comment">// 保存外部传入的关键依赖</span>
    _delegate = delegate;
    _jsRuntimeFactory = jsRuntimeFactory;
    _appTMMDelegate = tmmDelegate;
    _jsThreadManager = [RCTJSThreadManager new];

    <span class="hljs-comment">// 开发菜单配置</span>
    _devMenuConfigurationDecorator =
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU</span>
        [[RCTDevMenuConfigurationDecorator alloc] initWithDevMenuConfiguration:devMenuConfiguration];
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
        <span class="hljs-literal">nil</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    _parentInspectorTarget = parentInspectorTarget;

    <span class="hljs-comment">// JS 模块调用器配置(设置 Bridgeless 模式下的 JS 模块方法调用器)</span>
    {
      __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
      [_bridgeModuleDecorator.callableJSModules
          setBridgelessJSModuleMethodInvoker:^(
              <span class="hljs-built_in">NSString</span> *moduleName, <span class="hljs-built_in">NSString</span> *methodName, <span class="hljs-built_in">NSArray</span> *args, dispatch_block_t onComplete) {
            [weakSelf callFunctionOnJSModule:moduleName method:methodName args:args];
            <span class="hljs-keyword">if</span> (onComplete) {
              [weakSelf
                  callFunctionOnBufferedRuntimeExecutor:[onComplete](facebook::jsi::Runtime &amp;_) { onComplete(); }];
            }
          }];
    }
    _launchOptions = launchOptions;

    <span class="hljs-comment">// 内存警告监听</span>
    [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="hljs-keyword">self</span>
                                             selector:<span class="hljs-keyword">@selector</span>(_handleMemoryWarning)
                                                 name:<span class="hljs-built_in">UIApplicationDidReceiveMemoryWarningNotification</span>
                                               object:<span class="hljs-literal">nil</span>];
    <span class="hljs-comment">// 启动核心初始化</span>
    [<span class="hljs-keyword">self</span> _start];
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;
}
</code></pre>
<p>接下来，我们来看整个初始化过程的核心方法<code>_start</code>实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)_start
{
  <span class="hljs-comment">// 1.设置定时器系统</span>
  auto objCTimerRegistry = std::make_unique&lt;ObjCTimerRegistry&gt;();
  auto timing = objCTimerRegistry-&gt;timing;
  auto *objCTimerRegistryRawPtr = objCTimerRegistry.get();

  auto timerManager = std::make_shared&lt;TimerManager&gt;(std::move(objCTimerRegistry));
  objCTimerRegistryRawPtr-&gt;setTimerManager(timerManager);

  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  auto onJsError = [=](jsi::Runtime &amp;runtime, <span class="hljs-keyword">const</span> JsErrorHandler::ProcessedError &amp;error) {
    [weakSelf _handleJSError:error withRuntime:runtime];
  };

  <span class="hljs-comment">// 2.创建 ReactInstance (C++ 层)</span>
  _reactInstance = std::make_unique&lt;ReactInstance&gt;(
      _jsRuntimeFactory-&gt;createJSRuntime(_jsThreadManager.jsMessageThread),
      _jsThreadManager.jsMessageThread,
      timerManager,
      onJsError,
      _parentInspectorTarget);
  _valid = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 3.设置 RuntimeExecutor</span>
  RuntimeExecutor bufferedRuntimeExecutor = _reactInstance-&gt;getBufferedRuntimeExecutor();
  timerManager-&gt;setRuntimeExecutor(bufferedRuntimeExecutor);

  auto jsCallInvoker = make_shared&lt;RuntimeSchedulerCallInvoker&gt;(_reactInstance-&gt;getRuntimeScheduler());
  <span class="hljs-comment">// 省略旧架构......</span>

  <span class="hljs-comment">// 4.创建 TurboModuleManager</span>
  _turboModuleManager = [[RCTTurboModuleManager alloc] initWithBridgeProxy:bridgeProxy
                                                     bridgeModuleDecorator:_bridgeModuleDecorator
                                                                  delegate:<span class="hljs-keyword">self</span>
                                                                 jsInvoker:jsCallInvoker
                                             devMenuConfigurationDecorator:_devMenuConfigurationDecorator];

<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV</span>
  <span class="hljs-comment">/**
    * 实例化 DevMenu 会产生副作用，即通过 RCTDevMenu 注册
    * CMD + d、CMD + i 和 CMD + n 的快捷键。 
    * 因此，启用 TurboModules 时，我们必须手动创建此NativeModule。
   */</span>
  [_turboModuleManager moduleForName:<span class="hljs-string">"RCTDevMenu"</span>];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// end RCT_DEV</span></span>

  <span class="hljs-comment">// 初始化 RCTModuleRegistry，以便 TurboModules 可以引用其他 TurboModules</span>
  [_bridgeModuleDecorator.moduleRegistry setTurboModuleRegistry:_turboModuleManager];

  <span class="hljs-keyword">if</span> (ReactNativeFeatureFlags::enableEagerMainQueueModulesOnIOS()) {
    <span class="hljs-comment">/**
     * 某些原生模块需要在主线程上捕获 UIKit 对象。
     * 因此，请在此处的主队列上开始初始化这些模块。JavaScript 线程将等待这些模块初始化完成后，才会执行 JavaScript 代码包。
     */</span>
    <span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-built_in">NSString</span> *&gt; *modulesRequiringMainQueueSetup = [_delegate unstableModulesRequiringMainQueueSetup];

    std::shared_ptr&lt;std::mutex&gt; mutex = std::make_shared&lt;std::mutex&gt;();
    std::shared_ptr&lt;std::condition_variable&gt; cv = std::make_shared&lt;std::condition_variable&gt;();
    std::shared_ptr&lt;<span class="hljs-type">bool</span>&gt; isReady = std::make_shared&lt;<span class="hljs-type">bool</span>&gt;(<span class="hljs-literal">false</span>);

    _waitUntilModuleSetupComplete = ^{
      std::unique_lock&lt;std::mutex&gt; lock(*mutex);
      cv-&gt;wait(lock, [isReady] { <span class="hljs-keyword">return</span> *isReady; });
    };

    <span class="hljs-comment">// TODO(T218039767): 将性能日志记录功能集成到主队列模块初始化过程中</span>
    RCTExecuteOnMainQueue(^{
      <span class="hljs-keyword">for</span> (<span class="hljs-built_in">NSString</span> *moduleName <span class="hljs-keyword">in</span> modulesRequiringMainQueueSetup) {
        [<span class="hljs-keyword">self</span>-&gt;_bridgeModuleDecorator.moduleRegistry moduleForName:[moduleName UTF8String]];
      }

      RCTScreenSize();
      RCTScreenScale();
      RCTSwitchSize();

      std::lock_guard&lt;std::mutex&gt; lock(*mutex);
      *isReady = <span class="hljs-literal">true</span>;
      cv-&gt;notify_all();
    });
  }

  RCTLogSetBridgelessModuleRegistry(_bridgeModuleDecorator.moduleRegistry);
  RCTLogSetBridgelessCallableJSModules(_bridgeModuleDecorator.callableJSModules);

  <span class="hljs-comment">// 5.创建 ContextContainer</span>
  auto contextContainer = std::make_shared&lt;ContextContainer&gt;();
  [_delegate didCreateContextContainer:contextContainer];
  <span class="hljs-comment">// 插入核心模块</span>
  contextContainer-&gt;insert(
      <span class="hljs-string">"RCTImageLoader"</span>, facebook::react::wrapManagedObject([_turboModuleManager moduleForName:<span class="hljs-string">"RCTImageLoader"</span>]));
  contextContainer-&gt;insert(
      <span class="hljs-string">"RCTEventDispatcher"</span>,
      facebook::react::wrapManagedObject([_turboModuleManager moduleForName:<span class="hljs-string">"RCTEventDispatcher"</span>]));
  contextContainer-&gt;insert(<span class="hljs-string">"RCTBridgeModuleDecorator"</span>, facebook::react::wrapManagedObject(_bridgeModuleDecorator));
  contextContainer-&gt;insert(RuntimeSchedulerKey, std::weak_ptr&lt;RuntimeScheduler&gt;(_reactInstance-&gt;getRuntimeScheduler()));
  contextContainer-&gt;insert(<span class="hljs-string">"RCTBridgeProxy"</span>, facebook::react::wrapManagedObject(bridgeProxy));

  <span class="hljs-comment">// 6.创建 SurfacePresenter</span>
  _surfacePresenter = [[RCTSurfacePresenter alloc]
        initWithContextContainer:contextContainer
                 runtimeExecutor:bufferedRuntimeExecutor
      bridgelessBindingsExecutor:std::optional(_reactInstance-&gt;getUnbufferedRuntimeExecutor())];

  <span class="hljs-comment">// 这使得模块中的 RCTViewRegistry 能够通过其 viewForReactTag 方法返回 UIView 对象</span>
  __<span class="hljs-keyword">weak</span> RCTSurfacePresenter *weakSurfacePresenter = _surfacePresenter;
  [_bridgeModuleDecorator.viewRegistry_DEPRECATED setBridgelessComponentViewProvider:^<span class="hljs-built_in">UIView</span> *(<span class="hljs-built_in">NSNumber</span> *reactTag) {
    RCTSurfacePresenter *strongSurfacePresenter = weakSurfacePresenter;
    <span class="hljs-keyword">if</span> (strongSurfacePresenter == <span class="hljs-literal">nil</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;
    }

    <span class="hljs-keyword">return</span> [strongSurfacePresenter findComponentViewWithTag_DO_NOT_USE_DEPRECATED:reactTag.integerValue];
  }];

  <span class="hljs-comment">// 7.创建DisplayLink （用于调用计时器回调函数）</span>
  _displayLink = [RCTDisplayLink new];

  auto &amp;inspectorFlags = jsinspector_modern::InspectorFlags::getInstance();

  ReactInstance::JSRuntimeFlags options = {
      .isProfiling = inspectorFlags.getIsProfilingBuild(),
      .runtimeDiagnosticFlags = [RCTInstanceRuntimeDiagnosticFlags() UTF8String]};

  <span class="hljs-comment">// 8.初始化 JS Runtime 并加载 Bundle</span>
  _reactInstance-&gt;initializeRuntime(options, [=](jsi::Runtime &amp;runtime) {
    __<span class="hljs-keyword">strong</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
    <span class="hljs-keyword">if</span> (!strongSelf) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 安装 TurboModule JS 绑定</span>
    [strongSelf-&gt;_turboModuleManager installJSBindings:runtime];
    <span class="hljs-comment">// 绑定 Native Logger</span>
    facebook::react::bindNativeLogger(runtime, [](<span class="hljs-keyword">const</span> std::string &amp;message, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> logLevel) {
      _RCTLogJavaScriptInternal(static_cast&lt;RCTLogLevel&gt;(logLevel), [<span class="hljs-built_in">NSString</span> stringWithUTF8String:message.c_str()]);
    });

    <span class="hljs-comment">// 安装 Native Component Registry 绑定</span>
    RCTInstallNativeComponentRegistryBinding(runtime);

    <span class="hljs-comment">// 通知代理 Runtime 已初始化</span>
    [strongSelf-&gt;_delegate instance:strongSelf didInitializeRuntime:runtime];

    <span class="hljs-comment">// 设置 DisplayLink</span>
    <span class="hljs-type">id</span>&lt;RCTDisplayLinkModuleHolder&gt; moduleHolder = [[RCTBridgelessDisplayLinkModuleHolder alloc] initWithModule:timing];
    [strongSelf-&gt;_displayLink registerModuleForFrameUpdates:timing withModuleHolder:moduleHolder];
    [strongSelf-&gt;_displayLink addToRunLoop:[<span class="hljs-built_in">NSRunLoop</span> currentRunLoop]];

    <span class="hljs-comment">// 尝试同步加载bundle包，如果失败则回退到异步加载。</span>
    [strongSelf-&gt;_performanceLogger markStartForTag:RCTPLScriptDownload];
    [strongSelf _loadJSBundle:[strongSelf-&gt;_bridgeModuleDecorator.bundleManager bundleURL]];
  });

  [_performanceLogger markStopForTag:RCTPLReactInstanceInit];
}
</code></pre>
<h5 data-id="heading-11">JS Bundle 加载</h5>
<p>继续查看<code>_loadJSBundle</code>方法的实现：</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">void</span>)_loadJSBundle:(<span class="hljs-built_in">NSURL</span> *)sourceURL
{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU &amp;&amp; __has_include(<span class="hljs-string">&lt;React/RCTDevLoadingViewProtocol.h&gt;)</span></span>
  {
    <span class="hljs-comment">// 显示加载视图</span>
    <span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt; loadingView =
        (<span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt;)[_turboModuleManager moduleForName:<span class="hljs-string">"DevLoadingView"</span>];
    [loadingView showWithURL:sourceURL];
  }
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

  __<span class="hljs-keyword">weak</span> __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) weakSelf = <span class="hljs-keyword">self</span>;
  <span class="hljs-comment">// 通过代理加载 Bundle</span>
  [_delegate loadBundleAtURL:sourceURL
      onProgress:^(RCTLoadingProgress *progressData) {
        __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
        <span class="hljs-keyword">if</span> (!strongSelf) {
          <span class="hljs-keyword">return</span>;
        }

<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV_MENU &amp;&amp; __has_include(<span class="hljs-string">&lt;React/RCTDevLoadingViewProtocol.h&gt;)</span></span>
        <span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt; loadingView =
            (<span class="hljs-type">id</span>&lt;RCTDevLoadingViewProtocol&gt;)[strongSelf-&gt;_turboModuleManager moduleForName:<span class="hljs-string">"DevLoadingView"</span>];
        [loadingView updateProgress:progressData];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
      }
      onComplete:^(<span class="hljs-built_in">NSError</span> *error, RCTSource *source) {
        __<span class="hljs-keyword">typeof</span>(<span class="hljs-keyword">self</span>) strongSelf = weakSelf;
        <span class="hljs-keyword">if</span> (!strongSelf) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (error) {
          [strongSelf handleBundleLoadingError:error];
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// _loadScriptFromSource 函数的回调函数需要 DevSettings 模块，因此需要提前进行初始化。</span>
        RCTDevSettings *<span class="hljs-keyword">const</span> devSettings =
            (RCTDevSettings *)[strongSelf-&gt;_turboModuleManager moduleForName:<span class="hljs-string">"DevSettings"</span>];

        <span class="hljs-comment">// 加载脚本</span>
        [strongSelf _loadScriptFromSource:source];
        <span class="hljs-comment">// 仅在开发环境中启用热模块重载功能。</span>
        [strongSelf-&gt;_performanceLogger markStopForTag:RCTPLScriptDownload];
        [devSettings setupHMRClientWithBundleURL:sourceURL];
<span class="hljs-meta">#<span class="hljs-keyword">if</span> RCT_DEV</span>
        [strongSelf _logOldArchitectureWarnings];
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
      }];
}


- (<span class="hljs-type">void</span>)_loadScriptFromSource:(RCTSource *)source
{
  std::lock_guard&lt;std::mutex&gt; lock(_invalidationMutex);
  <span class="hljs-keyword">if</span> (!_valid) {
    <span class="hljs-keyword">return</span>;
  }

  auto script = std::make_unique&lt;<span class="hljs-built_in">NSDataBigString</span>&gt;(source.data);
  <span class="hljs-keyword">const</span> auto *url = deriveSourceURL(source.url).UTF8String;

  auto beforeLoad = [waitUntilModuleSetupComplete = <span class="hljs-keyword">self</span>-&gt;_waitUntilModuleSetupComplete](jsi::Runtime &amp;_) {
    <span class="hljs-keyword">if</span> (waitUntilModuleSetupComplete) {
      waitUntilModuleSetupComplete();
    }
  };
  auto afterLoad = [](jsi::Runtime &amp;_) {
    [[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:<span class="hljs-string">@"RCTInstanceDidLoadBundle"</span> object:<span class="hljs-literal">nil</span>];
  };
  <span class="hljs-comment">// 在 ReactInstance 中执行脚本</span>
  _reactInstance-&gt;loadScript(std::move(script), url, beforeLoad, afterLoad);
}
</code></pre>
<h5 data-id="heading-12">Surface 创建与启动</h5>
<p>现在，我们把视线拉回<code>viewWithModuleName</code>方法中，继续分析后面的<code>createSurfaceWithModuleName</code>方法的实现。源码<code>RCTHost.mm</code>：</p>
<pre><code class="hljs language-objc" lang="objc">- (RCTFabricSurface *)createSurfaceWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)properties
{
  <span class="hljs-keyword">return</span> [<span class="hljs-keyword">self</span> createSurfaceWithModuleName:moduleName mode:DisplayMode::Visible initialProperties:properties];
}

- (RCTFabricSurface *)createSurfaceWithModuleName:(<span class="hljs-built_in">NSString</span> *)moduleName
                                             mode:(DisplayMode)displayMode
                                initialProperties:(<span class="hljs-built_in">NSDictionary</span> *)properties
{
  <span class="hljs-comment">// 1. 创建 FabricSurface</span>
  RCTFabricSurface *surface = [[RCTFabricSurface alloc] initWithSurfacePresenter:<span class="hljs-keyword">self</span>.surfacePresenter
                                                                      moduleName:moduleName
                                                               initialProperties:properties];
  <span class="hljs-comment">// 2. 设置显示模式</span>
  surface.surfaceHandler.setDisplayMode(displayMode);

  <span class="hljs-comment">// 3. 附加 Surface</span>
  [<span class="hljs-keyword">self</span> _attachSurface:surface];

  __<span class="hljs-keyword">weak</span> RCTFabricSurface *weakSurface = surface;
  <span class="hljs-comment">// 在 JS Bundle 执行完成后，使用BufferedRuntimeExecutor启动Surface</span>
  [_instance callFunctionOnBufferedRuntimeExecutor:[weakSurface](facebook::jsi::Runtime &amp;_) { [weakSurface start]; }];
  <span class="hljs-keyword">return</span> surface;
}
</code></pre>
<h3 data-id="heading-13">总结</h3>
<p>初始化的大概流程：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">Swift</span> <span class="hljs-string">应用层</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">AppDelegate</span>                                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactNativeDelegate:</span> <span class="hljs-string">ReactNativeDelegate</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-attr">reactNativeFactory:</span> <span class="hljs-string">RCTReactNativeFactory</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-attr">ReactNativeDelegate :</span> <span class="hljs-string">RCTDefaultReactNativeFactoryDelegate</span>  <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">bundleURL()</span> <span class="hljs-string">→</span> <span class="hljs-string">URL?</span>                                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-attr">dependencyProvider:</span> <span class="hljs-string">RCTAppDependencyProvider</span>          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">Factory</span> <span class="hljs-string">层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTReactNativeFactory</span>                                       <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">delegate:</span> <span class="hljs-string">RCTReactNativeFactoryDelegate</span>               <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">rootViewFactory:</span> <span class="hljs-string">RCTRootViewFactory</span>                   <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">startReactNative(withModuleName:in:)</span>                  <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTRootViewFactory</span>                                          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactHost:</span> <span class="hljs-string">RCTHost</span>                                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">view(withModuleName:)</span> <span class="hljs-string">→</span> <span class="hljs-string">UIView</span>                        <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">createReactHost()</span> <span class="hljs-string">→</span> <span class="hljs-string">RCTHost</span>                           <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                         <span class="hljs-string">Host</span> <span class="hljs-string">层</span>                                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTHost</span>                                                     <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">instance:</span> <span class="hljs-string">RCTInstance</span>                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">bundleManager:</span> <span class="hljs-string">RCTBundleManager</span>                       <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">start()</span>                                               <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">createSurface(withModuleName:)</span> <span class="hljs-string">→</span> <span class="hljs-string">RCTFabricSurface</span>     <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                       <span class="hljs-string">Instance</span> <span class="hljs-string">层</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">RCTInstance</span>                                                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">reactInstance:</span> <span class="hljs-string">ReactInstance</span> <span class="hljs-string">(C++)</span>                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">turboModuleManager:</span> <span class="hljs-string">RCTTurboModuleManager</span>             <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">surfacePresenter:</span> <span class="hljs-string">RCTSurfacePresenter</span>                 <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">displayLink:</span> <span class="hljs-string">RCTDisplayLink</span>                           <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">_start()</span>                                              <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
                               <span class="hljs-string">│</span>
                               <span class="hljs-string">▼</span>
<span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">C++</span> <span class="hljs-string">Runtime</span> <span class="hljs-string">层</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌─────────────────────────────────────────────────────────────┐│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">ReactInstance</span> <span class="hljs-string">(C++)</span>                                         <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">jsRuntime:</span> <span class="hljs-string">jsi::Runtime</span> <span class="hljs-string">(Hermes)</span>                      <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">runtimeScheduler:</span> <span class="hljs-string">RuntimeScheduler</span>                    <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-attr">timerManager:</span> <span class="hljs-string">TimerManager</span>                            <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">├──</span> <span class="hljs-string">initializeRuntime()</span>                                   <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>    <span class="hljs-string">└──</span> <span class="hljs-string">loadScript()</span>                                          <span class="hljs-string">││</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─────────────────────────────────────────────────────────────┘│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？]]></title>    <link>https://juejin.cn/post/7600032104248934463</link>    <guid>https://juejin.cn/post/7600032104248934463</guid>    <pubDate>2026-01-28T10:25:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600032104248934463" data-draft-id="7600032104248819775" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-28T10:25:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建开放智能体生态：AgentScope 如何用 A2A 协议与 Nacos 打通协作壁垒？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:25:43.000Z" title="Wed Jan 28 2026 10:25:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：恰橙、席翁、濯光</p>
<blockquote>
<p>AgentScope 基于 A2A 协议与 Nacos Agent Registry，实现智能体的统一发现、治理与跨生态协作。</p>
</blockquote>
<p>随着企业逐步落地 AI 应用架构，从原来测试 POC workflow/简单 Agent 开始逐步构建生产级可用 Agent，真正解决线上问题，构建 Agent 在企业是面相全员提升效率的路径，不再是简单业务流程面临问题更加复杂，可能企业就会遇到如下挑战：</p>
<ul>
<li><strong>语言栈多样化</strong>：企业内核心业务团队可能是 Java/Golang，算法团队使用 Python，面临 Agent 架构选型多语言栈怎么做无缝协作？</li>
<li><strong>Agent 框架割裂</strong>：LangChain、AutoGPT、AgentScope 等不同框架以及 Agent 各自为政，如何实现跨框架调用？</li>
<li><strong>多团队Agent协同</strong>：Agent 如果有一个团队做，不懂业务做不深，Agent 分布在不同的服务、团队、项目中，内部选型会有 Dify、n8n 低代码和高代码平台选型，如何统一发现和管理？</li>
<li><strong>协议不统一</strong>：REST、gRPC、自定义协议...每个 Agent 都有自己的接口规范，集成成本高、维护困难。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/376420a5e7234943a8b420a4c5ebc5a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=EtB756VezetQw0R%2FDPjke0NiyIY%3D" alt="图片" loading="lazy"/></p>
<p><strong>A2A（Agent-to-Agent）协议正是为解决这些问题而生。</strong> 它是 Google 提出一套面向分布式多 Agent 互联互通的开放标准，定义了统一的消息结构和能力描述，让不同语言、不同框架、不同运行时上的 Agent 都能被发现、被调用、被编排。基于 A2A，Agent 之间可以在不共享代码、不耦合底层实现的前提下，完成文本对话、thinking、多模态内容、工具调用等丰富交互，真正实现“一次定义，处处可用”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5d6ffbdf9d84fc4ad46cff42863637b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=0eSFVMxugMlNgcY20hEK%2BzJcBcs%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">Agent 跨语言、跨框架调用最佳实践</h2>
<p><strong>AgentScope</strong> 是阿里巴巴推出的一款以开发者为核心，专注于<strong>多智能体开发的开源框架</strong>。它的核心目标是解决智能体在构建、运行和管理中的难题，提供一套覆盖“开发、部署、监控”全生命周期的生产级解决方案。</p>
<p>在 <strong>AgentScope</strong> 最新版本中，我们<strong>全面支持 A2A 协议，并集成 Nacos 作为 A2A Registry 的默认实现</strong>，构建了一套从开发到部署的完整分布式多智能体协作体系，让智能体协作从“单打独斗”走向“开放互联”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/657e92a0770a4995a8740d46b5d23798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=MbLAkSX5FeYd0o6CYydVBoSb0oY%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>告别“Agent 孤岛”</strong>：通过 A2A 协议，AgentScope 的 Agent 可以与任何实现 A2A 的 Agent 无缝互操作，不论由谁开发、用何种技术栈构建，都能在统一的协作框架下高效协同，打破技术壁垒，共同构建跨语言、跨框架的开放生态。</li>
<li><strong>统一开发体验，告别适配烦恼</strong>：在 AgentScope 中，调用本地 Agent 和调用远端 A2A Agent 使用同一套 API。框架自动处理协议转换、错误重试和路由选择，我们可以专注业务，不必为适配不同 Agent 编写冗余代码，从而提升效率与可维护性。</li>
<li><strong>生产级治理，开箱即用</strong>：基于 Nacos 3.0 智能体注册中心，AgentScope 应用具备服务发现、健康检查、命名空间隔离等成熟能力。选择 Nacos 作为默认 A2A Registry，不仅因为它经过大规模生产验证，也因为它与企业现有运维体系兼容，让智能体治理无需重复造轮子，加速规模化落地。</li>
</ul>
<h2 data-id="heading-1">在 AgentScope 中使用 A2A</h2>
<h3 data-id="heading-2">1. AgentScope：连接外部 A2A 网络，像调用本地 Agent 一样简单</h3>
<p>AgentScope 提供统一的 A2A 对接能力，我们可以像调用本地工具一样自然地调用远端 A2A Agent，实现跨语言、跨框架的协同，告别繁琐的协议适配工作：</p>
<ul>
<li><strong>双向消息转换：</strong> 实现框架内部消息格式与 A2A <code>Message</code> 的双向转换，支持文本、thinking、多模态、工具调用等 Block 类型，保留必要元信息，确保语义一致。</li>
<li><strong>统一交互范式：</strong> 支持直接调用和 <code>observe()</code> 两种方式。直接调用 <code>agent(msg)</code> 可立即拿到结果；<code>observe()</code> 先累积上下文，后续再连同当前输入一起发送，适合长会话、多轮协作场景。</li>
<li><strong>任务与中断管理：</strong> 内建长任务状态管理与 Artifact 处理机制，支持长时间任务的平滑中断，覆盖超时与取消场景。</li>
<li><strong>统一的服务发现能力：</strong> 通过 <code>AgentCardResolver</code> 扩展点标准化“发现”能力，任何实现该接口的组件，例如：<code>FixedAgentCardResolver</code>、<code>FileAgentCardResolver</code>、<code>WellKnownAgentCardResolver</code>、<code>NacosAgentCardResolver</code> 等都可按需加载，轻松适配不同基础设施。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d8e0d47b294113bc3d963862ae4d8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=bNZ2KwwXE0rwaadMaQ%2FHrtShx%2Fg%3D" alt="图片" loading="lazy"/></p>
<p>通过 <code>A2AAgent</code> 以及 <code>AgentCardResolver</code>，我们可以按名称、分组或标签从 A2A Registry 中发现并调用其他 Agent，实现跨团队、跨项目甚至跨语言的智能体复用。基于 A2A Registry，智能体拥有统一的服务发现与治理能力，可与现有配置中心、网关、熔断限流及安全体系协同，为大规模分布式智能体应用打好底座。</p>
<p>以下示例展示如何使用 <code>NacosAgentCardResolver</code> 从 Nacos Registry 中发现并调用 Agent：</p>
<p><em>注意在对应版本以上使用 demo，</em> <em><strong>Python</strong></em> <em>（AgentScope</em> <em><strong>v1.0.11</strong></em> <em>、AgentScope Runtime</em> <em><strong>v1.0.4</strong></em> *）和 * <em><strong>Java</strong></em> <em>（AgentScope</em> <em><strong>v1.0.6</strong></em> <em>，AgentScope Runtime</em> <em><strong>v1.0.0</strong></em> <em>）</em></p>
<h4 data-id="heading-3">Python 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2Fzh_CN%2Ftutorial%2Ftask_a2a.html" target="_blank" title="https://doc.agentscope.io/zh_CN/tutorial/task_a2a.html" ref="nofollow noopener noreferrer">doc.agentscope.io/zh_CN/tutor…</a></strong></p>
<pre><code class="hljs language-ini" lang="ini">from agentscope.agent import A2AAgent
from agentscope.a2a import NacosAgentCardResolver
from agentscope.message import Msg
<span class="hljs-comment"># Python AgentScope v1.0.11以上</span>
<span class="hljs-comment"># 创建 Nacos AgentCard Resolver</span>
<span class="hljs-attr">nacos_resolver</span> = NacosAgentCardResolver(
    <span class="hljs-attr">remote_agent_name</span>=<span class="hljs-string">"my-remote-agent"</span>,  <span class="hljs-comment"># Nacos 中注册的智能体名称</span>
    <span class="hljs-attr">nacos_client_config</span>=ClientConfig(
        <span class="hljs-attr">server_addresses</span>=<span class="hljs-string">"http://localhost:8848"</span>,  <span class="hljs-comment"># Nacos 服务器地址</span>
        <span class="hljs-comment"># 其他可选配置项</span>
    ),
)
<span class="hljs-comment"># 使用 Resolver 创建 A2AAgent，通过名称从 Nacos 发现 Agent</span>
<span class="hljs-attr">agent</span> = A2AAgent(
    <span class="hljs-attr">agent_card</span>=await nacos_resolver.get_agent_card()
)
</code></pre>
<h4 data-id="heading-4">Java 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fzh%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/zh/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/zh/task/a2a…</a></strong></p>
<p>使用 <code>NacosAgentCardResolver</code> 从 Nacos Registry 中发现 Agent：</p>
<pre><code class="hljs language-ini" lang="ini">import io.agentscope.agent.A2AAgent<span class="hljs-comment">;</span>
import io.agentscope.extensions.a2a.nacos.NacosAgentCardResolver<span class="hljs-comment">;</span>
import java.util.Properties<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.PropertyKeyConst<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.ai.AiFactory<span class="hljs-comment">;</span>
import com.alibaba.nacos.api.ai.AiService<span class="hljs-comment">;</span>
Properties <span class="hljs-attr">properties</span> = new Properties()<span class="hljs-comment">;</span>
properties.put(PropertyKeyConst.SERVER_ADDR, "localhost:8848")<span class="hljs-comment">;</span>
// 其他可选配置项
AiService <span class="hljs-attr">aiService</span> = AiFactory.createAiService(properties)<span class="hljs-comment">;</span>
NacosAgentCardResolver <span class="hljs-attr">agentCardResolver</span> = new NacosAgentCardResolver(aiService)<span class="hljs-comment">;</span>
A2AAgent <span class="hljs-attr">agent</span> = A2AAgent.builder()
        .name("MyAgent")
        .agentCardResolver(agentCardResolver)
        .build()<span class="hljs-comment">;</span>
</code></pre>
<p>Nacos 3.0 作为智能体注册中心，其在生产环境中久经验证的服务发现与配置管理能力，能够助力企业构建统一的智能体服务治理平台。</p>
<h3 data-id="heading-5">2. AgentScope Runtime：暴露 A2A Agent 服务，启动即注册</h3>
<p>AgentScope Runtime 提供统一的 A2A 服务暴露能力，帮助我们把本地 Agent 应用包装成符合 A2A 规范的服务端点。通过 A2A 协议适配器，应用在启动时会自动完成：</p>
<ul>
<li><strong>结构化配置体系</strong>：通过 A2A 扩展配置 <code>a2a_config</code> 灵活定义 AgentCard（name、description、version、skills、default_input_modes/default_output_modes 等）、传输层配置（host、port、path 等）、Registry 参数和任务超时等。</li>
<li><strong>自动服务包装</strong>：启动时由 A2A 协议适配器将 Agent 应用封装成符合 A2A 规范的服务端点，自动处理协议转换、消息路由等底层细节。</li>
<li><strong>生产级部署支持</strong>：与主流框架无缝集成，Python 侧支持 <code>AgentApp</code> 配置体系，Java 侧支持 <code>Spring Boot Starter</code>，让智能体服务自然融入现有基础设施。</li>
<li><strong>自动服务注册与治理</strong>：通过 <code>A2ARegistry</code> 抽象接口，Python 与 Java 都能开箱即用地集成 Nacos Agent Registry。Agent 能力描述（AgentCard）和网络端点会自动注册到 Registry，让其他 Agent 可发现、可调用。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55dd73181c2940148036fccb9ad74158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770200743&amp;x-signature=42WC7sFaCCxRJDKPaI72ZBYy6qE%3D" alt="图片" loading="lazy"/></p>
<p>以下示例展示如何在 Runtime 层使用 Nacos Registry 进行服务注册：</p>
<h4 data-id="heading-6">Python 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fruntime.agentscope.io%2Fzh%2Fa2a_registry.html" target="_blank" title="https://runtime.agentscope.io/zh/a2a_registry.html" ref="nofollow noopener noreferrer">runtime.agentscope.io/zh/a2a_regi…</a></strong></p>
<p><strong>方式一：参数配置</strong></p>
<p>在构造 AgentApp 时，通过 A2A 配置扩展字段 a2a_config 参数的 registry 字段指定 Registry 实例或列表：</p>
<pre><code class="hljs language-ini" lang="ini">from agentscope_runtime.engine.app import AgentApp
from agentscope_runtime.engine.deployers.adapter.a2a import (
    AgentCardWithRuntimeConfig,
)
from agentscope_runtime.engine.deployers.adapter.a2a.nacos_a2a_registry import (
    NacosRegistry,
)
from v2.nacos import ClientConfigBuilder
<span class="hljs-comment"># 创建 Nacos Registry 实例</span>
<span class="hljs-attr">registry</span> = NacosRegistry(
    <span class="hljs-attr">nacos_client_config</span>=ClientConfigBuilder()
        .server_address("nacos-server:8848")
        <span class="hljs-comment"># 其他可选配置项</span>
        .build()
)
<span class="hljs-attr">app</span> = AgentApp(
    <span class="hljs-attr">app_name</span>=<span class="hljs-string">"TestAgent"</span>,
    <span class="hljs-attr">app_description</span>=<span class="hljs-string">"TestAgent"</span>,
    <span class="hljs-comment"># 在 a2a_config 中配置 registry</span>
    <span class="hljs-attr">a2a_config</span>=AgentCardWithRuntimeConfig(registry=registry),
)
</code></pre>
<p><strong>方式二：使用环境变量配置</strong></p>
<p>环境变量可以通过 .env 文件或系统环境变量设置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .env 文件示例</span>
<span class="hljs-attr">A2A_REGISTRY_ENABLED</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">A2A_REGISTRY_TYPE</span>=nacos
<span class="hljs-attr">NACOS_SERVER_ADDR</span>=localhost:<span class="hljs-number">8848</span>
<span class="hljs-comment"># 其他可选配置项</span>
</code></pre>
<h4 data-id="heading-7">Java 代码示例</h4>
<p><strong>查看详细文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fzh%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/zh/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/zh/task/a2a…</a></strong></p>
<p>在最新版本的 Java AgentScope 中，应用可以直接暴露 A2A 服务，只有在需要使用 Sandbox 时，才需要使用 Runtime。</p>
<p>对于非最新版本，Java 开发者可以将 AgentScope Agent 无缝融入现有的 Spring Boot 基础设施体系。通过引入 <code>spring-boot-starter-agentscope-runtime-a2a-nacos</code> 依赖，应用在启动时会自动暴露 A2A 服务并注册到 Nacos Registry。</p>
<p><strong>Maven 依赖配置</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.agentscope<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-agentscope-runtime-a2a-nacos<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>application.yaml 配置</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">agentscope:</span>
  <span class="hljs-attr">a2a:</span>
    <span class="hljs-attr">server:</span>
      <span class="hljs-attr">card:</span>
        <span class="hljs-string">description:</span> <span class="hljs-string">"基于 A2A 协议的 Java 智能体"</span>
        <span class="hljs-attr">provider:</span>
          <span class="hljs-attr">organization:</span> <span class="hljs-string">您的组织名称</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">https://your-organization.com</span>
      <span class="hljs-attr">nacos:</span>
        <span class="hljs-string">server-addr:</span> <span class="hljs-string">${NACOS_SERVER_ADDRESS:127.0.0.1:8848}</span>
        <span class="hljs-comment"># 其他可选配置项</span>
</code></pre>
<p>通过上述配置，Spring Boot 应用在启动时会自动：</p>
<ul>
<li>暴露符合 A2A 规范的 JSONRPC 服务端点（默认路径：<code>/a2a/jsonrpc</code>）。</li>
<li>暴露 AgentCard 的 Well-Known 端点（默认路径：<code>/.well-known/agent-card.json</code>），用于其他 Agent 发现和了解当前 Agent 的能力。</li>
<li>自动处理 A2A 协议的消息转换和路由，将 A2A 消息格式转换为应用内部的消息处理逻辑。</li>
<li>支持任务超时、中断等 A2A 协议规定的运行时特性。</li>
<li>将 Agent 的能力描述（AgentCard）注册到 Nacos，基于 Nacos 3.0 智能体注册中心进行统一治理。</li>
</ul>
<p>得益于这一机制，AgentScope 应用启动即完成在 Nacos 的 A2A Agent 注册，为后续的发现、路由、灰度与监控奠定基础。对于已经大规模采用 Java 技术栈的团队，这意味着智能体服务能自然长在同一套基础设施上，大幅降低引入成本与运维负担。</p>
<h2 data-id="heading-8">总结</h2>
<p><strong>AgentScope 全面支持 A2A 协议和 Nacos Agent Registry</strong>，标志着智能体从“单点能力”迈向“开放互联生态”的关键一步，为企业构建统一的智能体管理平台，助力大规模 Agent 化落地：</p>
<ul>
<li><strong>AgentScope 层：借助</strong> A2AAgent 与 AgentCardResolver，我们提供统一的 A2A 对接能力和灵活的发现策略，默认集成 Nacos，支持动态 Agent 发现与调用。</li>
<li><strong>AgentScope Runtime 层：通过 A2A 协议适配器和</strong> A2ARegistry 抽象接口，提供统一的 A2A 服务暴露能力，支持自动服务注册与治理，与 Python AgentApp 和 Java Spring Boot Starter 无缝集成。</li>
</ul>
<p>未来，我们会继续围绕 A2A 与 Registry 深耕，在发现与路由、版本与灰度、安全与访问控制等方向迭代，让面向生产的智能体应用更稳、更易用。</p>
<p><strong>扩展链接</strong>：</p>
<p>AgentScope：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2F" target="_blank" title="https://doc.agentscope.io/" ref="nofollow noopener noreferrer">doc.agentscope.io/</a></p>
<p>AgentScope Python A2A 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.agentscope.io%2Ftutorial%2Ftask_a2a.htmlAgentScope" target="_blank" title="https://doc.agentscope.io/tutorial/task_a2a.htmlAgentScope" ref="nofollow noopener noreferrer">doc.agentscope.io/tutorial/ta…</a></p>
<p>Java：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2FAgentScope" target="_blank" title="https://java.agentscope.io/AgentScope" ref="nofollow noopener noreferrer">java.agentscope.io/AgentScope</a></p>
<p>Java A2A 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjava.agentscope.io%2Fen%2Ftask%2Fa2a.html" target="_blank" title="https://java.agentscope.io/en/task/a2a.html" ref="nofollow noopener noreferrer">java.agentscope.io/en/task/a2a…</a></p>
<p>Nacos：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnacos.io%2Fdocs%2Flatest%2Fmanual%2Fuser%2Fai%2Fagent-registry" target="_blank" title="https://nacos.io/docs/latest/manual/user/ai/agent-registry" ref="nofollow noopener noreferrer">nacos.io/docs/latest…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架]]></title>    <link>https://juejin.cn/post/7600068892988866570</link>    <guid>https://juejin.cn/post/7600068892988866570</guid>    <pubDate>2026-01-28T10:43:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600068892988866570" data-draft-id="7600234310965051430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-28T10:43:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东零售技术"/> <meta itemprop="url" content="https://juejin.cn/user/4233576972293643"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            突破传统限制：OxygenREC--一个基于指令跟随的“快慢思考“电商生成式推荐框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4233576972293643/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东零售技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T10:43:58.000Z" title="Wed Jan 28 2026 10:43:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在电商推荐系统中，推荐模型长期面临着两个核心矛盾：一方面，传统的多阶段级联推荐系统存在目标不一致和误差累积的问题；另一方面，直接引入大型语言模型LLM虽然能带来强大的推理能力，但其高昂的延迟和计算成本在工业级应用中难以承受。更重要的是，现有的生成式推荐方法在多场景扩展性上面临巨大瓶颈--每个场景都需要独立训练和部署，导致资源利用率低下、维护成本高昂。</p>
<p>京东零售OxygenREC团队在论文《OxygenREC: An Instruction-Following Generative Framework for E-commerce Recommendation》中提出了一种全新的解决方案：OxygenREC。这是一个基于“快慢思考”的指令跟随生成式推荐框架，不仅解决了推理能力与延迟之间的矛盾，更实现了“一次训练，多处部署”的多场景统一高效解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7df8c0078784d2cbbe21c6175c19f8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=two5r0QHfN4%2FFUGKXeu2hm4CgCA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、关键挑战</h2>
<p>OxygenREC 旨在解决当前推荐系统，特别是生成式推荐范式下的三大核心难题：</p>
<p>1.有限的演绎推理能力：现有的生成式推荐方法主要从用户海量行为中进行归纳学习，但在需要结合现实世界知识进行深度演绎推理的场景下表现不佳。比如下边两个例子：</p>
<p>当推荐的时空背景和用户画像是“成都冬至时的年轻宝妈”时，传统模型可能只是推荐“冬季外套”这样的商品，而无法深度推理出此时成都是“冷湿环境”，这位年轻母亲潜在的需求可能是“婴儿排汗睡衣”。</p>
<p>有个户外运动vlogger在购物行为中反复对比华为Mate 70和iPhone 16 Pro两款手机，传统系统因为用户频繁的交互历史，只会不断加强重复推荐这两款商品进行比价，而无法推理出其真正诉求可能是“高质量的移动影像”，从而模型未能精准推荐‘华为Pura’系列这一真正符合用户诉求的目标商品。</p>
<p>2.多场景适应与资源效率的矛盾：大部分推荐平台拥有首页、频道流、购物车、搜索等多种推荐场景。现有生成式推荐模型如果为每个场景训练独立模型，会带来巨大的运营和计算成本，而使用简单的统一模型又会面临“负迁移”问题--不同场景间的知识相互干扰，导致性能下降。</p>
<p>3.工业级部署的工程挑战：将LLM的深度推理能力与推荐系统的大规模稀疏特征、严格延迟要求相结合，是一个巨大的系统工程挑战。它需要同时处理推荐系统典型的TB级稀疏嵌入和LLM典型的十亿级稠密参数，这对训练框架和推理引擎都提出了极高要求。</p>
<h2 data-id="heading-1">二、核心贡献</h2>
<p>面对这些挑战，京东零售OxygenREC团队提出了一个基于指令跟随的生成式推荐框架-OxygenREC，首次把LLM中的“快慢思考”模式引入到生成式推荐中来。在OxygenREC框架中，通过基于Transformer 的Encoder-Decoder 作为骨干网络，能够根据特定指令生成语义化物品序列，来执行推荐场景的”快思考"方式。在“慢思考”模式中，引入上下文推理指令--由近线LLM pipeline 生成，将用户行为与上下文合成为可解释的指令。同时多场景对齐中，通过场景指令与基于强化学习的对齐机制，实现“一次训练，多场景部署”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa6943c39aa3452a9461937c41dd99dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=LmqwDZ2L1J1VK%2Bt5K2HP7NHVzh0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">1. “快慢思考”架构：知识注入与低延迟的平衡</h4>
<p>这是整个OxygenREC的基础，其核心思想是将复杂的推理过程“离线化”，保证在线服务的低延迟。</p>
<p>慢思考：一个近线的LLM pipeline，综合分析用户的时空上下文、个性化特征和历史行为，生成高质量的“上下文推理指令”。这个过程融合了世界知识，能进行深度演绎推理，但因其是近线批量处理，不增加在线请求的延迟。</p>
<p>快思考：一个高效的编码器-解码器骨干网络。它接收“慢思考”生成的指令，结合实时用户信号，在严格的延迟限制下生成推荐序列。该骨干网络本身轻量、高效，专为实时推理优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52361b6fcf74385b289ca2312ddf96f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=bA49vQ0BcffsL8hXQ0E7YjbIW3c%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. 语义对齐的指令控制机制：让指令真正发挥作用</h4>
<p>仅仅生成指令是不够的，还必须确保模型能够准确理解并遵循指令。OxygenREC通过两项关键技术实现精准指令控制：</p>
<p>查询到物品的对齐损失：在训练阶段，通过一个辅助的Query-to-Item (Q2I) 损失函数，将指令嵌入与目标物品嵌入在同一个语义空间中对齐。这使得指令能够“理解”物品，并用于检索：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456be53a34c64881b332f3ca1234ea54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=EgBT2a2bhxSYsCifMziQZyH8olM%3D" alt="image.png" loading="lazy"/></p>
<p>指令引导检索(IGR)：在生成推荐时，利用对齐后的指令作为查询，从用户长期历史行为中检索出最相关的部分，过滤掉无关的噪声。这确保了模型生成时专注在与当前指令意图最相关的历史信息上，大大提升了可控性和准确性。</p>
<h4 data-id="heading-4">3. 基于指令与强化学习的多场景统一对齐：Train-Once-Deploy-Everywhere</h4>
<p>这是解决多场景扩展性的关键。OxygenREC摒弃了为每个场景独立建模的思路。</p>
<p>场景指令化：将不同的场景信息（如首页、购物车）和可选的触发物品（如用户点击的入口商品）统一编码为“场景指令”，作为模型的条件输入。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab5da81d461544c99f265ffc6ade2b3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=VslxIpTc5Wu94KlcDUmKJ6yaJPo%3D" alt="image.png" loading="lazy"/></p>
<p>统一奖励映射与策略优化：设计了一个统一的奖励映射服务，将不同场景、不同业务目标（如GMV，转化率，合法性，多样性）的奖励信号归一化。在此基础上，提出了Soft Adaptive Group Clip Policy Optimization (SA-GCPO)算法进行强化学习训练:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/691bbb2d3c5a41c2852e5fbb621b3974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=yY6qltu7fFGDbHF4fNPqt0K11xA%3D" alt="image.png" loading="lazy"/></p>
<p>该算法用自适应门控函数替代传统基于GRPO的硬截断方式(hard clip):</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7861e3ae0a14bb1a39f295b3d2a84db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=%2Fs27rs%2FTM4r9PTCMj%2Fp7qedGfwI%3D" alt="image.png" loading="lazy"/></p>
<p>并以基于用户真实反馈的奖励分数作为阈值区分正负advantage样本，显著提升了多任务、多场景下策略学习的稳定性和效率：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f6df5ad12294ba9a15a4f7cea575b7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=%2BSaOUEO6bJ44eb9RFxAu8lQvGoI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">4. 大规模生产级系统实现</h4>
<p>为了支撑以上创新，团队构建了完整的工程体系：</p>
<p>统一训练框架：基于PyTorch，深度融合了工业级稀疏嵌入引擎和LLM稠密训练引擎，在128张H800 GPU集群上实现了40%的模型FLOPs利用率。﻿</p>
<p>高性能推理引擎xLLM：针对生成式推荐长上下文、大候选集的特点，定制开发了xLLM推理框架，通过xSchedule（系统调度）、xAttention（算子优化）、xBeam（束搜索优化）三级优化，满足线上严格的服务级别目标。</p>
<p>近线指令服务：推理指令通过近线服务批量生成并存入KV数据库，线上推荐模型直接读取，实现了零在线LLM调用，兼顾了语义丰富性和低延迟。</p>
<h2 data-id="heading-6">三、实验成果</h2>
<p>OxygenREC在京东几个核心场景的大量离线实验和在线A/B测试中取得了显著效果，证明OxygenREC 基于生成式推荐的方法在大规模工业级推荐系统中的有效性。</p>
<h4 data-id="heading-7">1. 基于快慢思考的生成式框架有效性验证</h4>
<p>语义ID：通过多源对比学习（文本、图像、行为关联）构建的层次化语义ID，在保持高类别纯度（92.8%）的同时，实现了极低的ID碰撞，证明了其强大的表达和区分能力。</p>
<p>指令跟随：消融实验证明，在BOS右侧插入指令的方式为最佳；融合了场景ID和触发物品ID的指令效果显著优于单一组件；IGR和Q2I对齐机制共同作用带来了显著的性能提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f9dd59be950429da8a3a310fee5dd44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=k7XxVwhntSYUlnbyqc2KEKNeAp0%3D" alt="image.png" loading="lazy"/></p>
<p>统一模型 vs. 独立模型：在六个核心场景的对比中，统一的OxygenREC模型全面超越了为每个场景独立微调的基线模型，验证了OxygenREC框架在场景间正向迁移的有效性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0b1466804884746b3ad44efb6446e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=5U4ZnhK%2BL0RXvSOAoBNetYjdpys%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">2. 基于SA-GCPO后训练的有效性验证</h4>
<p>在后续训练阶段，提出的SA-GCPO算法在合成数据比例变化时表现更稳定，且性能显著优于传统的GRPO及其变体GSPO。例如，在33%合成数据比例下，SA-GCPO在HR@1和HR@10上有显著提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0087405b804745ceb529b71b5855817f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=08vEU0crdzoLzVVmQvE5fvAen60%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">3. 电商场景在线A/B测试的商业效果</h4>
<p>OxygenREC已在京东App上形成覆盖用户购物全链路的部署闭环：首页导流（场景1、2）-&gt; 频道浏览（场景3、4）-&gt; 商品结算转化（场景5、6）。在线测试结果表明，该模型在所有关键业务指标上均带来显著提升：</p>
<p>首页场景：GMV提升4.52%-8.40%。</p>
<p>频道流场景：其中一个场景的订单量提升了8.03%，显示出模型精准匹配购买意图的能力。</p>
<p>结算路径场景：在用户强购买意图下，GMV提升高达11.80%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d67fbbf584e49edbe176cf9f1fc028f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=23bAzHEgiBYmFlb9avNIhDNPaPE%3D" alt="image.png" loading="lazy"/></p>
<p>与行业上其他生成式推荐方式对比:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/582dc6a123c741c381fd9891479fc4fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770201838&amp;x-signature=oGNN%2BnJdtBnYTm1V4W1iZ9rLWnM%3D" alt="image.png" loading="lazy"/></p>
<p>OxygenREC 在几个关键维度上进行了生成式推荐的范式革新：</p>
<p>架构上，用“快慢思考”破解了推理与延迟的死结。</p>
<p>效率上，用“统一指令模型”破解了多场景训练的困局。</p>
<p>控制上，用“语义对齐与引导检索”构建了生成式推荐模型的指令跟随能力。</p>
<p>优化上，用“SA-GCPO”和全栈系统优化，确保了技术在工业巨量流量下的可行性、稳定性和卓越性能。</p>
<h2 data-id="heading-10">四、总结与展望</h2>
<p>OxygenREC的成功，标志着生成式推荐在工业落地上迈出了关键一步。它通过“快慢思考”巧妙平衡了深度推理与低延迟，通过“指令跟随”实现了对推荐过程的精准可控，并通过统一的奖励与策略学习破解了多场景扩展的难题，真正实现了“一次训练，多场景部署”的pipeline。</p>
<p>未来，京东零售OxygenREC团队计划从两个方向继续探索：</p>
<p>一是向基于语言扩散模型的非自回归生成范式演进，从根本上突破序列生成延迟与列表长度的线性关系，满足更高吞吐需求；</p>
<p>二是开展跨场景用户轨迹建模，从用户在首页、搜索、购物车、结算等多场景的连贯行为中挖掘更深层的用户意图，实现更长周期的价值推荐。</p>
<p>OxygenREC不仅是一个高效的推荐系统，更为工业级生成式AI应用的大模型设计提供了宝贵范式--如何将大模型的“脑”与小模型的“身手”结合，如何在复杂多目标任务中实现稳定高效的学习，这其中的思想值得广泛借鉴。</p>
<p>论文原文：OxygenREC: An Instruction-Following Generative Framework for E-commerce Recommendation</p>
<p>训练框架： Oxygen 9N-LLM生成式推荐训练</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万字长文！带你一口气搞懂分布式系统数据一致性模型和逻辑时钟]]></title>    <link>https://juejin.cn/post/7599970244787667007</link>    <guid>https://juejin.cn/post/7599970244787667007</guid>    <pubDate>2026-01-28T07:21:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599970244787667007" data-draft-id="7598699872553025572" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万字长文！带你一口气搞懂分布式系统数据一致性模型和逻辑时钟"/> <meta itemprop="keywords" content="分布式,面试,架构"/> <meta itemprop="datePublished" content="2026-01-28T07:21:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凉凉的知识库"/> <meta itemprop="url" content="https://juejin.cn/user/3280598428311326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万字长文！带你一口气搞懂分布式系统数据一致性模型和逻辑时钟
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3280598428311326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凉凉的知识库
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T07:21:14.000Z" title="Wed Jan 28 2026 07:21:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74d799411e4f4ce18e53458626fffdf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=V8ikmQjgeejq%2Bw4AEVGs6Zuf2nE%3D" alt="" loading="lazy"/></p>

























<table><thead><tr><th>等级</th><th>具体细分等级</th></tr></thead><tbody><tr><td>强一致性</td><td>线性一致性(Linearizability consistency)</td></tr><tr><td>强一致性</td><td>顺序一致性(Sequential consistency)</td></tr><tr><td>弱一致性</td><td>因果一致性 (Causal consistency)</td></tr><tr><td>弱一致性</td><td>最终一致性 (Eventual consistency)</td></tr></tbody></table>
<h2 data-id="heading-0">线性一致性（Linearizable Consistency）</h2>
<p>线性一致性（Linearizability），又称原子一致性（Atomic Consistency）、严格一致性（Strict Consistency）或强一致性（Strong Consistency），是并发系统和分布式系统中关于单个对象操作正确性的核心模型。</p>
<p>其核心目标是让一个多副本的分布式系统，在外部观察起来，表现得就像只有一个数据副本一样，且每个操作都是操作都必须是 “瞬时” 生效且 “原子” 的（存在可线性化点），系统中所有进程看到的全局操作顺序和真实世界的发生时间顺序一致。</p>
<blockquote>
<p>可线性化点（Linearization Point）：指的是一个操作在其调用开始和响应返回之间的某个时间点“瞬间生效”。在这个点之前，操作的效果对系统其他部分不可见；在这个点之后，操作的效果对所有后续操作立即可见。可以将其想象为操作被提交到全局时间线上的一个不可分割的点</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a991f64a94747ab8678292a472c1849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=LPhlOk6uSUx%2B0jpwjjadJHTAx2c%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">实现路径</h3>
<ul>
<li>单主复制：从主节点或者同步更新的从节点上读取，可能满足</li>
<li>共识算法 ：如 Raft, Paxos。在介绍完顺序一致性后，我们会同时详细介绍共识</li>
<li>基于时钟的协议：Google Spanner 利用具有有界误差的全局时钟（TrueTime API）为事务分配时间戳，并通过等待误差时间（Commit Wait）来保证操作的全局顺序</li>
</ul>
<h2 data-id="heading-2">顺序一致性（Sequential Consistency）</h2>
<p>顺序一致性是 Lamport（1979）在解决多处理器系统共享存储器时首次提出来的</p>
<ol>
<li>任何一次读写操作都是按照某种特定的顺序</li>
<li>所有进程看到的读写操作顺序都保持一致</li>
</ol>
<p>那么线性一致性和顺序一致性的区别在哪里呢？顺序一致性虽然通过逻辑时钟保证所有进程保持一致的读写操作顺序，但这些读写操作的顺序跟实际上发生的顺序并不一定一致。而线性一致性是严格保证跟实际发生的顺序一致的。</p>
<h3 data-id="heading-3">偏序和全序</h3>
<p>简单的说，偏序的意思是说集合中的元素是部分有序的，而全序的意思是集合中任意一对元素都是可以相互比较的，可以完全排序。下面是一些例子 ：</p>
<ul>
<li>自然数的集合是全序</li>
<li>整数的集合是全序</li>
<li>复数的集合是偏序，1和100i是无法比较的，没有意义</li>
</ul>
<h3 data-id="heading-4">Lamport 逻辑时钟</h3>
<p>既然物理时钟不可靠，那就人为构造一个递增的序列来为事件排序，这就是Lamport逻辑时钟的基本思想。</p>
<p><strong>Happens-Before 关系：</strong></p>
<p>Lamport逻辑时钟的基石是 “happens-before”关系（记为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>），它定义了事件的偏序关系，其规则如下 ：</p>
<ul>
<li>同一进程内部：如果事件a和b在同一个进程内发生，且a在b之前执行，则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex"> a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
<li>跨进程消息传递：如果事件a是进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>发送一条消息的事件，而事件b是另一个进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>接收这条消息的事件，则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex"> a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></li>
<li>传递性：如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span> 且 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>→</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">b → c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span>，那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">a → c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span></li>
</ul>
<p>如果两个事件之间无法根据以上规则建立 happens-before 关系，则称这两个事件是并发的（concurrent）</p>
<p><strong>逻辑时钟的更新规则：</strong></p>
<p>分布式系统中每个进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>保存一个本地逻辑时钟值<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C_i(a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span> 表示进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>发生事件a时的逻辑时钟值，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的更新算法如下：</p>
<ol>
<li>进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>每发生一次事件，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>加1。</li>
<li>进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>给进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>发送消息，本地执行一个事件（将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 加 1），将这个新的时间戳包含在消息中一起发送出去</li>
<li>进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>接收消息，更新<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">C_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><msub><mi>C</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">max(C_i, C_j) + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f1a53ec05e6443781372562f4db386d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=plXO5L%2FcrKP5RSDetn3el9d75gE%3D" alt="" loading="lazy"/></p>
<p>从以上算法可以很容易地得出下面两个结论：</p>
<ol>
<li>同一个进程内的两个事件a和b，如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C_i(a)&lt;C_i(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></li>
<li>a是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>进程的消息发送事件，b是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>进程该消息的接收事件，那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C_i(a)&lt;C_j(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></li>
</ol>
<p>所以：<strong>对于任意两个事件a和b，如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></strong></p>
<p>但反过来<strong>如果<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>，由于并发的存在，并不能说明<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，反向的推论并不成立。也就是说<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span> 的必要不充分条件</strong></p>
<blockquote>
<p>Lamport逻辑时钟</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ea4e0be074a429091f3468cc3cb6bef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=nfJxsLaX%2BDo9J18ROfaLns9vv18%3D" alt="" loading="lazy"/></p>
<p>整个事件集合中只有因果关系（蓝色部分）可以比较大小、并发关系（红色部分）的大小无意义，所以我们说Lamport逻辑时钟构造的是偏序关系</p>
<p>对于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>来说<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>，也就是蓝色部分全部都是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>。但<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>可能是因果关系（蓝色部分）也有可能是并发关系（红色部分），所以我们说<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>的必要条件</p>
</blockquote>
<h4 data-id="heading-5"><strong>全序事件集</strong></h4>
<p>Lamport逻辑时钟算法构造的整个事件集合 (happened before →) 是一种偏序关系，我们加入另外一个条件也就是判断两个进程号的大小，把Lamport逻辑时钟中不能比较大小的事件变成可以比较大小，从而使整个事件集合变成一种全序关系</p>
<p>定义全序关系 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⇒</mo></mrow><annotation encoding="application/x-tex">⇒</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">⇒</span></span></span></span></span> 如下：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>进程的事件a和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>进程的事件b如果满足下面两个关系中的任何一个，则称 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇒</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a ⇒ b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>。</p>
<ol>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C_i (a) &lt; C_j (b) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>（事件a的Lamport时间戳小于事件b的）</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C_i (a) = C_j (b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span> 并且 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub><mo>&lt;</mo><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_i &lt; P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></li>
</ol>
<p>全序关系 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⇒</mo></mrow><annotation encoding="application/x-tex">⇒</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">⇒</span></span></span></span></span> 把偏序关系 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">→</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 变成了任何两个元素都可比较的全序关系，而且有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex"> a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇒</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a ⇒ b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eea18eae6acf4fe294e77a3cdca05ca7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=5AxXlE880FbLXNlk5mAATcB6WUE%3D" alt="" loading="lazy"/></p>
<p>这个全序关系的关键在于，它为系统中任何两个事件都定义了一个明确的先后顺序，即使它们是并发的</p>
<ul>
<li>与偏序关系兼容：这个全序关系“扩展”了原有的偏序关系。如果事件a在偏序上“happened before”事件b（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex"> a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>），那么在全序中a也一定在b之前（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇒</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a ⇒ b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>）。它不会破坏已有的因果关系</li>
<li>顺序的任意性：物理时间上真正先发生的事件，在全序中可能会被排在后发生的事件之后。这可能导致<strong>不公平</strong>但正确的结果</li>
</ul>
<p>再次强调：注意全序关系只是明确了先后顺序，是不能描述事件的因果关系的，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>不能推导出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex"> a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>（只能推导出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>⇒</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a⇒b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>），即使知道了两个逻辑时钟值，也无法区分因果事件和并发事件，因为全序关系可能将本无因果的并发事件强制排序。</p>
<h3 data-id="heading-6">全序关系广播</h3>
<p>抛开Lamport时钟来聊一个更高级别的抽象：全序关系广播</p>
<p>全序关系广播，也被称为原子广播（Atomic Broadcast），在分布式系统中，如果多个节点需要达成一致，仅仅保证消息发到了是不够的，最难的是保证所有节点接收消息的顺序一模一样</p>
<p>全序广播必须满足两个核心性质：</p>
<ol>
<li>可靠传递： 如果消息被发给了一个节点，它最终必须被所有正常的节点接收</li>
<li>全序属性： 如果节点 A 先处理消息 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">m_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 再处理 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">m_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，那么系统中任何其他节点也必须先处理 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">m_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 再处理 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">m_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
</ol>
<p>全序广播保证了所有节点以相同的顺序接收消息，这直接导致了顺序一致性。</p>
<p>在全序广播的基础上，再加上「读操作必须能看到最新的写」这一约束（例如读也走一次共识，或者通过 Leader 租约确认），升级到了线性一致性</p>
<h4 data-id="heading-7">如何实现全序广播？</h4>
<p>实现全序广播主要有以下几种常见策略：</p>
<p>A. 令牌传递 (Token Passing)。 谁拿到令牌，谁就有权决定下一个共识值。节点收到带序号的消息后，直接按序投递。工程挑战：令牌丢失， 如果持有令牌的节点突然宕机，令牌就消失了。节点加入/退出， 逻辑环的维护非常复杂。早期有一些基于令牌的容错协议（如 Totem），通过极其复杂的重组机制来找回丢失的令牌，但在现代大规模集群中几乎见不到了</p>
<p>B. 基于通信历史/逻辑时钟 (Communication History / Logical Clocks)。不需要 Leader，每个节点根据自己的逻辑时钟给提案打分，通过两轮交互取最大值作为最终序号</p>
<p>C. 基于定序器 (Sequencer-based)。简单来说就是由Leader 给每个消息分配一个全局递增的序列号。优点： 简单，延迟低。工程挑战： Leader是单点故障，所以如果 Leader 挂了，需要复杂的选举机制来选新 Leader 并恢复数据。这也是Raft/Paxos的实现策略</p>
<p>虽然在分布式理论课上，Lamport 时钟经常被用来演示如何实现全序，但在高性能的工业级分布式协调系统中，它们被认为太弱或太重了。工程上更偏爱基于定序器的共识。ZooKeeper和etcd使用了更强力、更直接的机制：基于领导者的定序器（Leader-based Sequencer），配合逻辑序列号来实现全序，在定序器的基础上增加了选举逻辑和日志恢复逻辑</p>
<h4 data-id="heading-8">共识</h4>
<p>在分布式理论中，全序广播和共识(Consensus) 是等价的问题。任何能实现全序广播的机制，在数学上都能推导出共识。</p>
<ul>
<li>共识是让节点就“某一个值”达成一致</li>
<li>全序关系广播可以看作是一系列的共识实例：节点们需要对“第1条消息是什么”、“第2条消息是什么”……达成一致</li>
</ul>
<p>如果你解决了一个问题，你就自动解决了另一个问题。现代的许多共识算法（如 Paxos, Raft, ZAB）本质上就是在实现全序广播（通常通过复制日志 Log Replication 的形式）</p>
<p>ZooKeeper和etcd通过各自的共识协议的实现了线性一致性的写操作。共识协议保证所有节点最终都会按相同的顺序达到相同的状态，但由于网络延迟，Follower可能还没收到最新的日志，客户端读取到旧数据，所以系统只保证了顺序一致性读。为了达到线性一致性读，etcd 和 ZooKeeper 必须采取特殊手段：</p>
<ol>
<li>Read Index / Lease Read (etcd/Raft)：读请求必须询问 Leader。Leader 会确认自己是否还是合法的领导者，并确保读到的数据不早于当前的 Commit Index</li>
<li>Sync + Read (ZooKeeper)：ZooKeeper 默认提供的是“单调写”和“顺序读”。但如果你在读之前调用 <code>sync()</code> 接口，它会强制同步进度，从而逼近线性一致性</li>
</ol>
<h2 data-id="heading-9">因果一致性（Causal Consistency）</h2>
<p>因果一致性是一种弱化的顺序一致性模型，它旨在保证操作之间因果关系的正确顺序，同时允许无因果关系的并发操作以不同顺序被观察到，从而在强一致性的严格性和最终一致性的宽松性之间取得了良好的平衡</p>
<p>因果一致性的条件包括：</p>
<ol>
<li>所有进程必须以相同的顺序看到具有因果关系的读写操作</li>
<li>不同进程可以以不同的顺序看到并发的读写操作</li>
</ol>
<p>顺序一致性虽然不保证事件发生的顺序跟实际发生的保持一致，但是它能够保证所有进程看到的读写操作顺序是一样的。而因果一致性更进一步弱化了顺序一致性中对读写操作顺序的约束，仅保证有因果关系的读写操作有序，没有因果关系的读写操作（并发事件）则不做保证。也就是说如果是无因果关系的数据操作不同进程看到的值是有可能是不一样，而有因果关系的数据操作不同进程看到的值保证是一样的。</p>
<h3 data-id="heading-10">向量时钟</h3>
<p>实现因果一致性的核心技术是向量时钟 (Vector Clock)。向量时钟是1988年由Colin Fidge和Friedemann Mattern提出的，比Lamport提出逻辑时钟晚了刚好十年。</p>
<p>Lamport逻辑时钟存在的问题是不能描述事件的因果关系，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">C(a) &lt; C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>不能推导出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex"> a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，这样导致即使知道了两个逻辑时钟值，但却不能确定这两个事件的因果关系。</p>
<p>向量时钟可以解决这两个问题，它的思想是进程间通信的时候，不光同步本进程的时钟值，还同步自己知道的其他进程的时钟值。</p>






























<table><thead><tr><th>特性</th><th>向量时钟</th><th>Lamport 逻辑时钟</th></tr></thead><tbody><tr><td>核心思想</td><td>每个节点维护一个向量，记录所有节点已知的事件计数</td><td>每个节点维护一个单一的、全局递增的计数器</td></tr><tr><td>时序信息</td><td>多维向量，记录部分时序信息</td><td>单一时钟值，建立全序关系</td></tr><tr><td>因果关系判断</td><td>充分必要条件：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi><mo>⇔</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">a→b ⇔ VC(a)&lt;VC(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇔</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></td><td>必要条件：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi><mo>⇒</mo><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">a→b \Rightarrow C(a)&lt;C(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></td></tr><tr><td>并发事件识别</td><td>可以精确识别。如果两个向量时钟不可比较，则事件并发</td><td>无法准确识别。时钟值大小不能确定事件是因果还是并发</td></tr></tbody></table>
<h4 data-id="heading-11">向量时钟算法</h4>
<p>分布式系统中每个进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>保存一个本地逻辑时钟向量值<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">VC_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，向量的长度是分布式系统中进程的总个数。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_i [k]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span></span></span></span></span> 表示进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>知道的进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">P_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的本地逻辑时钟值，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">VC_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的更新算法如下：</p>
<ol>
<li>
<p>初始化：初始化<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">VC_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的值全为0：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_i = [0, … , 0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">]</span></span></span></span></span>。例如，对于节点 A、B、C：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>A</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_A = [0,0,0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">]</span></span></span></span></span>，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>B</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_B = [0,0,0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">]</span></span></span></span></span>， <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>C</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_C = [0,0,0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></p>
</li>
<li>
<p>本地事件发生：进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>每发生一次事件，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_i[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span>加1。例如，A发生事件，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>A</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_A = [1,0,0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></p>
</li>
<li>
<p>发送消息：进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>给进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>发送消息，它首先会执行上一步（递增自己的分量），然后将自己的整个向量时钟<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">VC_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>附加到消息中一并发送出去。例如，A发送消息给B，先加自己的向量[2,0,0]，然后发送出去</p>
</li>
<li>
<p>进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>接收消息，需要做两步操作</p>
<p>4.1 对于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>向量中的每个值<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_j[k]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span></span></span></span></span>，更新为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC_j[k] = max(VC_j[k], VC_i[k])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">])</span></span></span></span></span>，这一步是为了获取进程<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>目前所知的所有进程的最新事件计数。所以<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>B</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mn>2</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_B = [2,0,0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></p>
<p>4.2 将<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>中自己对应的时钟值加1，即<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_j[j]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span></span></span>加1，表示处理了一次接收事件。此时<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>B</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mn>2</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">VC_B = [2,1,0]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">]</span></span></span></span></span></p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/004c7c4ce93a457aa5727a92817f9a9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=sfIBsN9Oz2wlBks9T2ksYOaL5G4%3D" alt="" loading="lazy"/></p>
<p>定义向量时钟之间的大小关系</p>
<ul>
<li>如果所有分量都相等定义为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo>=</mo><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_i = VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></li>
<li>如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">VC_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 中每一个分量都小于或等于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>中对应的分量，并且至少有一个分量是严格小于的，则认为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo>&lt;</mo><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_i &lt; VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></li>
<li>如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 中每一个分量都大于或等于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 中对应的分量，并且至少有一个分量是严格大于的，则认为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo>&gt;</mo><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_i &gt; VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></li>
<li>如果两个向量中存在一些分量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 大，另一些分量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 大（即无法用上述大小关系比较）。这表示这两个事件是并发的，记作<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo>∥</mo><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">VC_i \parallel VC_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>我们可以得出这样的结论：</p>
<ul>
<li>
<p>向量时钟之间的大小关系是一种偏序关系</p>
</li>
<li>
<p>向量有序，则事件有序（充要）:<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo><mo>⇔</mo><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">VC(a)&lt;VC(b)⇔a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇔</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
</li>
<li>
<p>向量平行，则事件并发（充要）:<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>∥</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo><mo>⇔</mo><mi>a</mi><mo>∥</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">VC(a) \parallel VC(b)⇔a \parallel b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇔</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∥</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
</li>
</ul>
<blockquote>
<p>以下是向量有序是事件有序得充分必要条件证明过程</p>
<p>证明1: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi><mo>⇒</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">a→b \Rightarrow VC(a)&lt;VC(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></p>
<ol>
<li>同一个进程内的两个事件a和b，如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a → b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC_i (a) &lt; VC_i (b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></li>
<li>a是Pi进程的消息发送事件，b是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">P_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>进程的消息接收事件，那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><msub><mi>C</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><msub><mi>C</mi><mi>j</mi></msub><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC_i(a)&lt;VC_j(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></li>
</ol>
<p>所以对于任意两个事件a和b，如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC(a)&lt;VC(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></p>
<p>证明2: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo><mo>⇒</mo><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">VC(a)&lt;VC(b)⇒a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⇒</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
<ol>
<li>
<p>如果 a和b两个事件处在同一个进程中，显而易见 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
</li>
<li>
<p>如果 a和b两个事件处在两个进程中，一定只能是以下几种情况，全部都是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2e25bc3e666488aa3c0d180b2ac6174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=XgXFuWVywD83DZ3Kxpw1k43lVyA%3D" alt="" loading="lazy"/></p>
</blockquote>
<blockquote>
<p>向量时钟</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71adfd4a57bd42d39143beea84282575~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=Cx%2FSU1ZULYZ9eW19QJpmAhqSnnw%3D" alt="" loading="lazy"/></p>
<p>整个事件集合中只有因果关系（蓝色部分）可以比较大小、并发关系（红色部分）的大小无法比较，所以我们说向量时钟构造的是偏序关系</p>
<p>对于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>来说<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC(a)&lt;VC(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC(a)&lt;VC(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span> 一定<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，即<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC(a)&lt;VC(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>只位于蓝色部分，红色部分的大小无法比较。所以我们说<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>a</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC(a)&lt;VC(b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span>是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo>→</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">a→b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>的充分必要条件</p>
</blockquote>
<h4 data-id="heading-12">向量时钟的应用</h4>
<p>微信朋友圈不同地域的用户可能在不同的服务器上，微信朋友圈的跨地域数据同步就借鉴了因果一致性的思想，以确保评论和回复能以正确的顺序呈现在全球所有用户面前</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da3d71d11a404d618ec7d30377a293ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=BpJwt1riiFaSRsTZQ7uCrGZblA0%3D" alt="" loading="lazy"/></p>
<p>上海小王发了一个风景图片到朋友圈，香港Mary看到后评论了问“这是哪”，上海小王回复评论“梅里雪山”。由于网络原因，对评论的回复先同步到了加拿大的服务器，评论后到，导致加拿大Kate先看到回答“梅里雪山”，后看到提问“这是哪”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cd4ca1cc6a54b2b8e9d6b6fd8c19468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YeJ5YeJ55qE55-l6K-G5bqT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770189679&amp;x-signature=i7pFgjDd%2FtFmlVQ%2BME3jJtUiYyQ%3D" alt="" loading="lazy"/></p>
<p>使用向量时钟，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>V</mi><mi>C</mi><mo stretchy="false">(</mo><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">VC(c) &lt; VC(e)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mclose">)</span></span></span></span></span>，因此 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>→</mo><mi>e</mi></mrow><annotation encoding="application/x-tex">c → e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">e</span></span></span></span></span>，加拿大的服务器知道c发生在e前面，可以对评论和回复正确排序后显示。</p>
<h4 data-id="heading-13">向量时钟的不足</h4>
<ol>
<li>
<p>只考虑了固定数量的节点，没有考虑节点的动态添加和销毁。</p>
<p>现代解决方案： 区间树时钟 - Interval Tree Clocks</p>
</li>
<li>
<p>假设节点数量是N ，那么每个节点需要维护的空间复杂度是 𝑂(𝑁)。 通信的信息量的复杂度也是 𝑂(𝑁)</p>
<p>2019年新鲜出炉的一个寻求优化时钟空间的算法，布隆时钟 - Bloom Clocks</p>
</li>
</ol>
<h3 data-id="heading-14">混合逻辑时钟</h3>
<p>混合逻辑时钟（Hybrid Logical Clock, HLC）是一种巧妙融合物理时钟和逻辑时钟优势的算法，旨在为分布式系统中的事件提供既能反映因果关系、又与物理时间保持接近的时间戳。它由 Sandeep Kulkarni 等人在2014年的论文《Logical Physical Clocks and Consistent Snapshots in Globally Distributed Databases》中提出</p>
<h4 data-id="heading-15">HLC的算法</h4>
<p>在 HLC 中，每一个节点（或进程）<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 维护一个时间戳状态，这个状态由两部分组成：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>L</mi><mi>C</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mo stretchy="false">(</mo><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo separator="true">,</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">HLC.j = (l.j, c.j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">l.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>  ：逻辑物理时间。代表当前节点已知的最大物理时钟值（不一定来自本地）</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">c.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>  ：逻辑计数器。当多个事件的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span></span> 部分相同时，用于在逻辑上区分其先后顺序</li>
</ul>
<p>此外，我们还有一个本地的物理时钟源：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">pt.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">pt</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>：节点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 当前的系统物理时间</li>
</ul>
<p>其核心算法在于如何在不同操作下更新这个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo separator="true">,</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(l.j, c.j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span> 对</p>
<p><strong>发送事件或本地事件</strong></p>
<p>当发生一个本地事件或准备发送消息时，它需要生成一个新的时间戳。算法的核心思想是：尽可能使用当前的物理时间，除非物理时间发生了回退或落后于之前的逻辑时间</p>
<ol>
<li>获取当前物理时间 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">pt.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">pt</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span></li>
<li>更新 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo separator="true">,</mo><mi>p</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l.j = max(l.j, pt.j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">pt</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span>。这一步确保 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span></span> 部分总能跟踪到最新的物理时间。</li>
<li>更新 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>c</mi></mrow><annotation encoding="application/x-tex">l.c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal">c</span></span></span></span></span>
<ul>
<li>如果新的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">l.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 等于之前的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">l.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>（即物理时间没有超越），则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c.j = c.j + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 。这表示在同一个物理时间片内发生了新事件</li>
<li>如果新的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">l.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 大于之前的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">l.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> （即物理时间发生了跃升），则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">c.j = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span> 。这表示物理时间已经推进，逻辑计数器可以重置</li>
</ul>
</li>
</ol>
<p><strong>接收事件（处理消息 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>）</strong></p>
<p>当节点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 收到一条消息 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>，该消息携带的时间戳为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>l</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo separator="true">,</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(l.m, c.m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span></span>。节点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 需要更新自己的时钟，以满足因果关系（即自己的时间必须晚于消息的时间）</p>
<ol>
<li>获取当前当前 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">l.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>，消息的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">l.m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal">m</span></span></span></span></span>、当前物理时间 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">pt.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">pt</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span></li>
<li>更新 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>l</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo separator="true">,</mo><mi>l</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo separator="true">,</mo><mi>p</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l'.j = \max(l.j, l.m, pt.j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">max</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">pt</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span></span></span></span></span>。这一步确保本地的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span></span> 部分能感知到来自其他节点的最新物理时间。</li>
<li>根据 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>l</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">l'.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 是由谁决定的，来更新计数器 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">c'.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>
<ul>
<li>如果三者中相等：增加逻辑时钟部分 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo separator="true">,</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo stretchy="false">)</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c'.j = max(c.j, c.m) + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></li>
<li>如果是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">l.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 赢了（本地HLC时间最大）：延续本地计数，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>j</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c'.j = c.j + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></li>
<li>如果是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi mathvariant="normal">.</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">l.m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord">.</span><span class="mord mathnormal">m</span></span></span></span></span> 赢了（消息时间最大）：跟随消息计数，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mi>c</mi><mi mathvariant="normal">.</mi><mi>m</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">c'.j = c.m + 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">c</span><span class="mord">.</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span></li>
<li>如果是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>t</mi><mi mathvariant="normal">.</mi><mi>j</mi></mrow><annotation encoding="application/x-tex">pt.j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">pt</span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 赢了（本地物理时间最大）：重置计数，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">.</mi><mi>j</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">c'.j = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">.</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></li>
</ul>
</li>
</ol>
<h4 data-id="heading-16">HLC的应用</h4>
<p>1、因果一致性</p>
<p>这是 HLC 最本质的数学属性。HLC 旨在捕捉分布式系统中事件的“发生先于”（Happens-Before, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span>）关系。如果事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi></mrow><annotation encoding="application/x-tex">e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">e</span></span></span></span></span> 发生在事件 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span> 之前（即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mo>→</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">e \rightarrow f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span>），那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mi>L</mi><mi>C</mi><mo stretchy="false">(</mo><mi>e</mi><mo stretchy="false">)</mo><mo>&lt;</mo><mi>H</mi><mi>L</mi><mi>C</mi><mo stretchy="false">(</mo><mi>f</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">HLC(e) &lt; HLC(f)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mclose">)</span></span></span></span></span> 一定成立</p>
<p>2、快照隔离/一致性快照</p>
<p>这是 HLC 在工程实践中（如 CockRoachDB、HBase）最主要的应用目标</p>
<h2 data-id="heading-17">最终一致性（Eventual Consistency）</h2>
<p>最终一致性是更加弱化的一致性模型，因果一致性起码还保证了有因果关系的数据不同进程读取到的值保证是一样的，而最终一致性只保证所有副本的数据最终在某个时刻会保持一致，但不保证中间状态的顺序。理论上，可能出现非常混乱的中间状态</p>
<p>由于最终一致性对数据一致性的要求比较低，在对性能要求高的场景中是经常使用的一致性模型</p>
<p><strong>为什么说MySQL的异步复制 (默认)是最终一致性？</strong></p>

































<table><thead><tr><th><strong>方案</strong></th><th><strong>机制</strong></th><th><strong>一致性类型</strong></th><th><strong>优点</strong></th><th><strong>缺点</strong></th></tr></thead><tbody><tr><td>异步复制 (默认)</td><td>Master 写完 Binlog 即返回，不管 Slave</td><td>最终一致性</td><td>性能最高，主库不被拖累。</td><td>读从库可能有延迟；Master 宕机可能丢数据。</td></tr><tr><td>半同步复制 (Semi-Sync)</td><td>Master 至少等待一个 Slave 收到 Binlog (写入 Relay Log) 才返回</td><td>增强的最终一致性</td><td>数据安全性更高，不易丢数据。</td><td>性能有损耗；Slave 依然可能存在回放延迟（读仍可能不一致）。</td></tr><tr><td>全同步/组复制 (MGR)</td><td>所有节点协商一致才提交</td><td>强一致性 (接近)</td><td>数据一致性极高。</td><td>性能最差，受限于最慢的节点，架构复杂。</td></tr></tbody></table>
<p>首先对比ZooKeeper，Zookeeper中针对同一个Follower A提交的写请求R1，R2，某些Follower可能读取到旧数据。既然数据同步需要时间，Follower 上的数据会滞后（Stale），那不就是「最终」才一致吗？但ZooKeeper文档中写明它是顺序一致性读</p>
<p>之所以会产生最终一致性的错觉，是因为ZooKeeper的一致性模型中存在实时性（Timeliness）的缺失</p>
<ul>
<li>线性一致性： 写入成功后，所有节得都读到最新值</li>
<li>ZK 的读： ZK 默认读不满足线性一致性，因为允许部分客户端读 Follower 读到旧数据。官方称之为“Sync-Linearizable”，即如果你需要读到最新数据，需要先发一个 <code>sync()</code> 命令</li>
</ul>
<p>因为允许读到旧数据（滞后），所以给人的感觉是“最终才会一致”。但在分布式理论中，滞后（Lag） 和 乱序（Out of order） 是两个完全不同的性质</p>
<ul>
<li>允许滞后 + 严格有序 = 顺序一致性 (Sequential)</li>
<li>允许滞后 + 允许乱序 = 最终一致性 (Eventual)</li>
</ul>
<p>顺序一致性的定义非常严格，它要求系统满足两个条件：</p>
<ol>
<li>内部有序： 单个处理器的操作顺序符合程序顺序</li>
<li>全局单一视图： 所有客户端看到的操作执行顺序必须是一致的</li>
</ol>
<p>ZooKeeper 的顺序一致性保证了什么： ZooKeeper 保证了“客户端视角的全局有序”，注意是客户端视角</p>
<ul>
<li>内部有序： 即使 Follower 滞后，它也必须严格按照 Leader 的 zxid（事务ID）顺序来应用日志。如果 Leader 发出 R1然后 R2，Follower 决不可能先应用 R2。它要么停在 R0（旧数据），要么更新到 R1，要么更新到 R2。滞后是可以的，但乱序是不行的</li>
<li>全局单一视图： ZK 保证单一客户端的单调读（Monotonic Reads）。如果你在 Follower A 读到了版本R1的数据，当你切到 Follower B 时，ZK的机制确保你不会读到版本R1的数据（如果 Follower B 还没同步到R2，客户端的请求会被阻塞或需要处理，具体取决于实现细节，但逻辑视图上不会回退）</li>
</ul>
<p>ZK 保证了： 只要你看见过新世界，我就绝不让你再退回旧世界</p>
<blockquote>
<p>ZooKeeper 如何做到的？ZooKeeper 在客户端会话（Session）层面做了手脚：</p>
<ul>
<li>ZXID 检查机制： 当 Client 连上 ZK 的 Follower A 时，Follower A 会告诉 Client：“我现在的数据版本是 ZXID=100”。Client 会在本地记下“我看过 ZXID 100 了”。</li>
<li>拒绝“时光倒流”： 如果 Client 断开，重连到滞后的 Follower B（ZXID=80）。Follower B 会检查 Client 的握手包，发现 Client 见过 100，而自己只有 80。</li>
<li>处理结果： Follower B 要么拒绝服务，要么阻塞直到自己追上 100，要么 Client 被路由到其他节点。</li>
</ul>
</blockquote>
<p>MySQL无法满足全局单一视图。MySQL的异步复制确实保证了内部操作顺序，但它缺乏防止“客户端视角的全局有序”的机制，因此只能算最终一致性</p>
<p>假设架构是：1 Master + 2 Slaves (Slave A 快, Slave B 慢)。 初始值 <code>x = 0</code>。</p>
<ol>
<li>Master 写入 <code>x = 1</code>。</li>
<li>Slave A 同步完成，变更为 <code>x = 1</code>。</li>
<li>Slave B 延迟了，还是 <code>x = 0</code>。</li>
</ol>
<p>如果是顺序一致性（如 ZK），系统必须保证： 一旦客户端（比如 Client 1）读到了 <code>x = 1</code>，那么客户端Client 1以后即使切换了Follower都不会再读到 <code>x = 0</code></p>
<p>但在 MySQL 异步复制中发生了什么？</p>
<ul>
<li>时刻 T1： Client 1 连上 Slave A，读到 <code>x = 1</code>（用户觉得：哦，数据更新了）</li>
<li>时刻 T2： Client 1 刷新页面，负载均衡将请求切到了 Slave B</li>
<li>时刻 T3： Client 1 读到 <code>x = 0</code></li>
</ul>
<p>在多节点切换访问时，对于 Client 1 来说，他先看到了新数据，后看到了旧数据。数据的版本发生了回退。 这种情况破坏了单调读（Monotonic Reads），也破坏了顺序一致性要求的全局单一视图。在客户端看来，这个系统的行为是混乱的，而不是顺序的，因此只能算最终一致性</p>
<hr/>
<p>✨ 微信公众号【<strong>凉凉的知识库</strong>】同步更新，欢迎关注获取最新最有用的知识 ✨</p>
<h2 data-id="heading-18">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F693187" target="_blank" title="https://developer.aliyun.com/article/693187" ref="nofollow noopener noreferrer">分布式系统：一致性模型</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhit9.dev%2Fpost%2Flogical-clocks%23%25E5%2590%2591%25E9%2587%258F%25E6%2597%25B6%25E9%2592%259F-vector-clocks" target="_blank" title="https://hit9.dev/post/logical-clocks#%E5%90%91%E9%87%8F%E6%97%B6%E9%92%9F-vector-clocks" ref="nofollow noopener noreferrer">逻辑时钟 - 如何刻画分布式中的事件顺序</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fyang.observer%2F2020%2F07%2F26%2Ftime-lamport-logical-time%2F" target="_blank" title="https://yang.observer/2020/07/26/time-lamport-logical-time/" ref="nofollow noopener noreferrer">计算机的时钟（二）：Lamport逻辑时钟</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F56146800" target="_blank" title="https://zhuanlan.zhihu.com/p/56146800" ref="nofollow noopener noreferrer">分布式系统：Lamport 逻辑时钟</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fyang.observer%2F2020%2F09%2F12%2Fvector-clock%2F" target="_blank" title="https://yang.observer/2020/09/12/vector-clock/" ref="nofollow noopener noreferrer">计算机的时钟（三）：向量时钟</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F56886156" target="_blank" title="https://zhuanlan.zhihu.com/p/56886156" ref="nofollow noopener noreferrer">分布式系统：向量时钟</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.meituan.com%2F2022%2F08%2F25%2Freplication-in-meituan-02.html" target="_blank" title="https://tech.meituan.com/2022/08/25/replication-in-meituan-02.html" ref="nofollow noopener noreferrer">Replication（下）：事务，一致性与共识</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析]]></title>    <link>https://juejin.cn/post/7600060691350405162</link>    <guid>https://juejin.cn/post/7600060691350405162</guid>    <pubDate>2026-01-28T12:20:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350405162" data-draft-id="7600219080046002219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析"/> <meta itemprop="keywords" content="Android,源码阅读,性能优化"/> <meta itemprop="datePublished" content="2026-01-28T12:20:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15网络子系统深度解析（一）：ConnectivityService与网络管理框架全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T12:20:27.000Z" title="Wed Jan 28 2026 12:20:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>网络连接是现代移动设备最核心的功能之一。从打开网页、收发消息，到视频通话、在线游戏，每一个网络操作背后，都有Android网络子系统在默默工作。而<strong>ConnectivityService</strong>，正是这个庞大系统的"中枢大脑"。</p>
<p>在本系列的第一篇文章中，我们将深入探索：</p>
<h3 data-id="heading-1">为什么ConnectivityService如此重要？</h3>
<p>想象这样一个场景：你正在用WiFi观看高清视频，突然WiFi信号变弱。Android系统需要在1秒内完成以下复杂操作：</p>
<ol>
<li><strong>监测WiFi质量下降</strong> - NetworkMonitor持续验证网络</li>
<li><strong>评估切换时机</strong> - NetworkRanker对比WiFi和移动网络得分</li>
<li><strong>准备移动网络</strong> - TelephonyNetworkFactory激活移动数据</li>
<li><strong>无缝切换</strong> - 在不中断视频的情况下迁移连接</li>
<li><strong>通知应用</strong> - 通过NetworkCallback告知网络变更</li>
</ol>
<p>这一切，都由ConnectivityService协调完成。它就像交通指挥中心，管理着设备上所有网络的"交通"。</p>
<h3 data-id="heading-2">本文内容概览</h3>
<ol>
<li>
<p><strong>ConnectivityService架构总览</strong></p>
<ul>
<li>核心职责与设计理念</li>
<li>与其他系统服务的关系</li>
<li>Android 15的架构演进</li>
</ul>
</li>
<li>
<p><strong>NetworkAgent机制深度解析</strong></p>
<ul>
<li>NetworkAgent生命周期</li>
<li>网络状态上报流程</li>
<li>WiFi/Cellular的Agent实现</li>
</ul>
</li>
<li>
<p><strong>NetworkFactory工作原理</strong></p>
<ul>
<li>网络请求匹配机制</li>
<li>Factory评分与竞争</li>
<li>按需网络激活</li>
</ul>
</li>
<li>
<p><strong>网络状态管理</strong></p>
<ul>
<li>9种网络状态详解</li>
<li>状态机转换流程</li>
<li>Linger机制</li>
</ul>
</li>
<li>
<p><strong>WiFi与移动网络切换</strong></p>
<ul>
<li>切换决策算法</li>
<li>NetworkRanker评分机制</li>
<li>无缝切换实现</li>
</ul>
</li>
<li>
<p><strong>实战：网络问题诊断</strong></p>
<ul>
<li>WiFi连接失败排查</li>
<li>网络切换异常定位</li>
<li>性能优化技巧</li>
</ul>
</li>
</ol>
<p>让我们开始这段深入Android网络核心的旅程！</p>
<hr/>
<h2 data-id="heading-3">一、ConnectivityService架构总览</h2>
<h3 data-id="heading-4">1.1 ConnectivityService的核心职责</h3>
<p>ConnectivityService是Android网络栈的"总管家"，负责：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">┌────────────────────────────────────────┐
│      ConnectivityService核心职责        │
├────────────────────────────────────────┤
│ <span class="hljs-number">1.</span> 网络生命周期管理                     │
│    - 创建/销毁网络                      │
│    - 监控网络状态                       │
│    - 处理网络切换                       │
│                                        │
│ <span class="hljs-number">2.</span> 网络请求调度                         │
│    - 接收NetworkRequest                │
│    - 分发到对应NetworkFactory          │
│    - 管理请求优先级                     │
│                                        │
│ <span class="hljs-number">3.</span> 网络能力管理                         │
│    - NetworkCapabilities匹配           │
│    - 网络评分(NetworkScore)            │
│    - 默认网络选择                       │
│                                        │
│ <span class="hljs-number">4.</span> 网络验证                            │
│    - 触发NetworkMonitor验证            │
│    - 处理Captive Portal               │
│    - 管理部分连接状态                   │
│                                        │
│ <span class="hljs-number">5.</span> 应用网络权限                         │
│    - <span class="hljs-built_in">UID</span>网络访问控制                    │
│    - 后台数据限制                       │
│    - VPN隧道管理                       │
└────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-5">1.2 整体架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/424ee010e395475da12c022ee30aad87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770207627&amp;x-signature=tjXJzYy5buG2mXRro1kDAt7b2co%3D" alt="07-01-connectivityservice-architecture.png" loading="lazy"/></p>
<p><strong>架构分层说明</strong>：</p>
<h4 data-id="heading-6"><strong>应用层（Application Layer）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用使用ConnectivityManager API</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> (ConnectivityManager)
    context.getSystemService(Context.CONNECTIVITY_SERVICE);

<span class="hljs-comment">// 请求网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET)
    .addTransportType(NetworkCapabilities.TRANSPORT_WIFI)
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络可用</span>
    }
});
</code></pre>
<h4 data-id="heading-7"><strong>Framework层（ConnectivityService核心）</strong></h4>
<p>ConnectivityService源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Connectivity/service/src/com/android/server/ConnectivityService.java
</code></pre>
<p><strong>核心数据结构</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/.../ConnectivityService.java (精简版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectivityService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IConnectivityManager</span>.Stub {

    <span class="hljs-comment">// 所有NetworkAgent的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HashMap&lt;Messenger, NetworkAgentInfo&gt; mNetworkAgentInfos =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 所有NetworkRequest的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SparseArray&lt;NetworkRequestInfo&gt; mNetworkRequests =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparseArray</span>&lt;&gt;();

    <span class="hljs-comment">// 所有NetworkFactory的集合</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ArrayList&lt;NetworkFactoryInfo&gt; mNetworkFactoryInfos =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">// 当前默认网络</span>
    <span class="hljs-keyword">private</span> NetworkAgentInfo mDefaultNetwork;

    <span class="hljs-comment">// 网络评分器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetworkRanker mNetworkRanker;

    <span class="hljs-comment">// 权限监控</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PermissionMonitor mPermissionMonitor;

    <span class="hljs-comment">// 核心方法：注册NetworkAgent</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerNetworkAgent</span><span class="hljs-params">(Messenger messenger,
                                     NetworkInfo networkInfo,
                                     LinkProperties linkProperties,
                                     NetworkCapabilities networkCapabilities,
                                     <span class="hljs-type">int</span> currentScore,
                                     NetworkAgentConfig networkAgentConfig,
                                     <span class="hljs-type">int</span> factorySerialNumber)</span> {

        <span class="hljs-comment">// 1. 创建NetworkAgentInfo</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">nai</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentInfo</span>(
            messenger, <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncChannel</span>(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Network</span>(mNextNetworkId++),
            networkInfo, linkProperties,
            networkCapabilities, currentScore,
            mContext, mHandler,
            networkAgentConfig, <span class="hljs-built_in">this</span>,
            mNetd, mDnsResolver,
            mNMS, factorySerialNumber);

        <span class="hljs-comment">// 2. 分配NetId</span>
        <span class="hljs-keyword">try</span> {
            mNetd.networkCreate(nai.network.netId,
                               NativeNetworkType.PHYSICAL);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            loge(<span class="hljs-string">"Error creating network "</span> + nai.network.netId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 添加到管理列表</span>
        mNetworkAgentInfos.put(messenger, nai);

        <span class="hljs-comment">// 4. 通知NetworkMonitor开始验证</span>
        nai.networkMonitor.start();

        <span class="hljs-comment">// 5. 匹配NetworkRequest</span>
        rematchNetworkAndRequests(nai, ReapUnvalidatedNetworks.DONT_REAP);
    }

    <span class="hljs-comment">// 核心方法：处理NetworkRequest</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestNetwork</span><span class="hljs-params">(NetworkCapabilities nc,
                               Messenger messenger,
                               <span class="hljs-type">int</span> timeoutMs,
                               IBinder binder,
                               <span class="hljs-type">int</span> legacyType,
                               <span class="hljs-meta">@CallbackFlags</span> <span class="hljs-type">int</span> callbackFlags)</span> {

        <span class="hljs-comment">// 1. 权限检查</span>
        enforceAccessPermission();

        <span class="hljs-comment">// 2. 创建NetworkRequestInfo</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkRequestInfo</span> <span class="hljs-variable">nri</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequestInfo</span>(
            messenger, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>(nc, legacyType,
            nextNetworkRequestId(), NetworkRequest.Type.REQUEST),
            binder);

        <span class="hljs-comment">// 3. 保存请求</span>
        mNetworkRequests.put(nri.request.requestId, nri);

        <span class="hljs-comment">// 4. 发送给所有NetworkFactory</span>
        <span class="hljs-keyword">for</span> (NetworkFactoryInfo nfi : mNetworkFactoryInfos) {
            nfi.asyncChannel.sendMessage(
                android.net.NetworkFactory.CMD_REQUEST_NETWORK,
                nri.request);
        }

        <span class="hljs-comment">// 5. 尝试匹配现有网络</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">bestNetwork</span> <span class="hljs-operator">=</span>
            getBestNetwork(nri.request, <span class="hljs-literal">null</span>);
        <span class="hljs-keyword">if</span> (bestNetwork != <span class="hljs-literal">null</span>) {
            callCallbackForRequest(nri, bestNetwork,
                                  ConnectivityManager.CALLBACK_AVAILABLE);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">1.3 与其他系统服务的关系</h3>
<pre><code class="hljs language-arduino" lang="arduino">┌──────────────────────────────────────────────┐
│           ConnectivityService                │
│              (核心协调者)                      │
└─────────────┬────────────────────────────────┘
              │
    ┌─────────┼─────────┬──────────┬──────────┐
    │         │         │          │          │
    ▼         ▼         ▼          ▼          ▼
┌────────┐ ┌──────┐ ┌────────┐ ┌──────┐ ┌────────┐
│NetworkStack│Netd │ │Telephony│ <span class="hljs-built_in">WiFi</span> │ │VpnManager
│        │ │      │ │Service │ |Service│ │        │
│验证网络  │ │路由  │ │蜂窝网络 │ |无线   │  │VPN隧道  │
│        │ │配置   │ │        │|      │  │        │
└────────┘ └──────┘ └────────┘ └──────┘ └────────┘
</code></pre>
<p><strong>关键交互</strong>：</p>
<ol>
<li><strong>与NetworkStack交互</strong> - 网络验证</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService触发验证</span>
nai.networkMonitor.notifyNetworkConnected(
    nai.linkProperties, nai.networkCapabilities);

<span class="hljs-comment">// NetworkStack执行HTTP探测</span>
<span class="hljs-comment">// 返回验证结果(VALID/PORTAL/INVALID)</span>
</code></pre>
<ol start="2">
<li><strong>与Netd交互</strong> - 路由配置</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置默认网络</span>
mNetd.networkSetDefault(nai.network.netId);

<span class="hljs-comment">// 添加路由规则</span>
mNetd.networkAddRoute(netId, ifname, destination, nexthop);
</code></pre>
<ol start="3">
<li><strong>与TelephonyService交互</strong> - 移动网络</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求移动数据连接</span>
telephonyNetworkFactory.needNetworkFor(request);

<span class="hljs-comment">// 接收数据连接状态变化</span>
onDataConnectionStateChanged(state, networkType);
</code></pre>
<h3 data-id="heading-9">1.4 Android 15的架构改进</h3>
<h4 data-id="heading-10"><strong>改进1：模块化NetworkStack</strong></h4>
<p>Android 10开始，NetworkStack从system_server独立为单独进程：</p>
<pre><code class="hljs language-markdown" lang="markdown">Android 9及之前:
┌────────────────────────┐
│    system<span class="hljs-emphasis">_server       │
│  ┌──────────────────┐  │
│  │ConnectivityService│  │
│  │  + NetworkMonitor │  │ ← 验证逻辑耦合
│  └──────────────────┘  │
└────────────────────────┘

Android 10+:
┌────────────────────────┐     ┌──────────────┐
│    system_</span>server       │     │NetworkStack  │
│  ┌──────────────────┐  │     │  进程         │
│  │ConnectivityService│◄─────►│┌────────────┐│
│  └──────────────────┘  │ AIDL││NetworkMonitor│
└────────────────────────┘     │└────────────┘│
<span class="hljs-code">                              └──────────────┘
                              ↑ 可独立更新
</span></code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>NetworkStack可通过APK更新，无需OTA</li>
<li>隔离故障，NetworkStack崩溃不影响system_server</li>
<li>更好的安全边界</li>
</ul>
<h4 data-id="heading-11"><strong>改进2：eBPF网络策略</strong></h4>
<p>Android 15使用eBPF替代iptables：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel BPF程序 - 快速数据包过滤</span>
SEC(<span class="hljs-string">"cgroup/sock"</span>)
<span class="hljs-type">int</span> <span class="hljs-title function_">bpf_cgroup_sock_filter</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> bpf_sock *sk)</span> {
    __u32 uid = bpf_get_current_uid_gid();

    <span class="hljs-comment">// 查询UID是否允许访问网络</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uid_permission_value</span> *<span class="hljs-title">value</span> =</span>
        bpf_map_lookup_elem(&amp;uid_permission_map, &amp;uid);

    <span class="hljs-keyword">if</span> (value &amp;&amp; value-&gt;permission == PERMISSION_DENIED)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 拒绝连接</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// 允许连接</span>
}
</code></pre>
<p><strong>性能提升</strong>：</p>
<ul>
<li>iptables规则匹配：O(n)</li>
<li>eBPF哈希查找：O(1)</li>
<li>延迟降低：~100μs → ~10μs</li>
</ul>
<h4 data-id="heading-12"><strong>改进3：Multi-Network API增强</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 15新增：网络切片(Network Slicing)支持</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_ENTERPRISE)  <span class="hljs-comment">// 企业专网</span>
    .setEnterpriseId(NET_ENTERPRISE_ID_1)      <span class="hljs-comment">// 切片ID</span>
    .build();

<span class="hljs-comment">// 5G网络切片可以为不同业务提供差异化QoS</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">二、NetworkAgent机制深度解析</h2>
<h3 data-id="heading-14">2.1 NetworkAgent是什么？</h3>
<p><strong>NetworkAgent</strong>是网络提供者（如WiFi、Cellular、Ethernet、VPN）与ConnectivityService之间的"信使"。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">WiFi</span>底层驱动
    ↓
<span class="hljs-built_in">WiFiNetworkAgent</span> (继承NetworkAgent)
    ↓ Messenger通信
ConnectivityService
</code></pre>
<h3 data-id="heading-15">2.2 NetworkAgent生命周期</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7e77cfb92d4126a7313de48768dae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770207627&amp;x-signature=gKkU%2FnrZvJp7TwzFeV%2B%2FRB9HLPU%3D" alt="07-02-network-state-machine.png" loading="lazy"/></p>
<p><strong>9种核心状态详解</strong>：</p>
<h4 data-id="heading-16"><strong>1. DISCONNECTED（断开）</strong></h4>
<ul>
<li>初始状态，NetworkAgent尚未创建</li>
<li>或网络已完全销毁</li>
</ul>
<h4 data-id="heading-17"><strong>2. CONNECTING（连接中）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// WiFiNetworkAgent创建时</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WiFiNetworkAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkAgent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WiFiNetworkAgent</span><span class="hljs-params">(Context context, ...)</span> {
        <span class="hljs-built_in">super</span>(context, looper, TAG,
              networkInfo,        <span class="hljs-comment">// 初始状态：CONNECTING</span>
              networkCapabilities,
              linkProperties,
              networkScore,
              config);
    }
}
</code></pre>
<h4 data-id="heading-18"><strong>3. CONNECTED（已连接）</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 物理连接建立后，Agent上报</span>
sendLinkProperties(linkProperties);
sendNetworkCapabilities(networkCapabilities);
sendNetworkScore(score);

<span class="hljs-comment">// ConnectivityService收到后更新状态 → CONNECTED</span>
</code></pre>
<h4 data-id="heading-19"><strong>4. VALIDATING（验证中）</strong></h4>
<p>ConnectivityService自动触发NetworkMonitor：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/NetworkStack/.../NetworkMonitor.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyNetworkConnected</span><span class="hljs-params">(LinkProperties lp,
                                   NetworkCapabilities nc)</span> {
    <span class="hljs-comment">// 1. HTTP探测</span>
    <span class="hljs-type">ValidationProbeEvent</span> <span class="hljs-variable">probeResult</span> <span class="hljs-operator">=</span>
        isCaptivePortal(mCleartextDnsNetwork);

    <span class="hljs-comment">// 2. HTTPS探测</span>
    probeResult = httpsProbe();

    <span class="hljs-comment">// 3. DNS探测</span>
    probeResult = sendDnsProbe(mPrivateDnsProviderHostname);

    <span class="hljs-comment">// 4. 返回验证结果</span>
    <span class="hljs-keyword">if</span> (allProbesSucceeded) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationResult</span>(
            NetworkValidationResult.VALID, ...);
    }
}
</code></pre>
<p><strong>验证URL（可配置）</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># HTTP</span>
http://connectivitycheck.gstatic.com/generate_204

<span class="hljs-comment"># HTTPS</span>
https://www.google.com/generate_204

<span class="hljs-comment"># 返回HTTP 204表示验证通过</span>
</code></pre>
<h4 data-id="heading-20"><strong>5. VALIDATED（已验证）</strong></h4>
<p>验证通过后，网络成为"候选默认网络"：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateNetworkInfo</span><span class="hljs-params">(NetworkAgentInfo nai, NetworkInfo info)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">oldScore</span> <span class="hljs-operator">=</span> nai.getCurrentScore();

    <span class="hljs-keyword">if</span> (info.getDetailedState() == NetworkInfo.DetailedState.CONNECTED) {
        <span class="hljs-comment">// 网络验证通过，提升评分</span>
        nai.setScore(oldScore + <span class="hljs-number">10</span>);

        <span class="hljs-comment">// 重新评估默认网络</span>
        rematchAllNetworksAndRequests();
    }
}
</code></pre>
<h4 data-id="heading-21"><strong>6. CAPTIVE_PORTAL（强制门户）</strong></h4>
<p>检测到需要网页登录（如公共WiFi）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor检测到HTTP 302重定向</span>
<span class="hljs-keyword">if</span> (probeResult.isPortal()) {
    <span class="hljs-comment">// 显示登录通知</span>
    showSignInNotification(nai);

    <span class="hljs-comment">// 等待用户登录后重新验证</span>
    scheduleReevaluation(REEVALUATION_DELAY_MS);
}
</code></pre>
<p>用户体验：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 连接WiFi
<span class="hljs-bullet">2.</span> 系统检测到强制门户
<span class="hljs-bullet">3.</span> 弹出通知："需要登录WiFi网络"
<span class="hljs-bullet">4.</span> 点击通知打开登录页面
<span class="hljs-bullet">5.</span> 登录成功后自动重新验证
<span class="hljs-bullet">6.</span> 状态变为VALIDATED
</code></pre>
<h4 data-id="heading-22"><strong>7. LOSING（即将丢失）</strong></h4>
<p>Linger机制 - 给应用迁移时间：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../ConnectivityService.java</span>

<span class="hljs-comment">// 当更好的网络出现时</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLingerComplete</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-comment">// Linger倒计时开始（默认30秒）</span>
    nai.lingerExpiryMs = SystemClock.elapsedRealtime()
                        + mLingerDelayMs;

    <span class="hljs-comment">// 通知应用网络即将失去</span>
    <span class="hljs-keyword">for</span> (NetworkRequestInfo nri : nai.networkRequests) {
        callCallbackForRequest(nri, nai,
            ConnectivityManager.CALLBACK_LOSING,
            mLingerDelayMs);
    }
}
</code></pre>
<p>应用可以：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用收到CALLBACK_LOSING</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLosing</span><span class="hljs-params">(Network network, <span class="hljs-type">int</span> maxMsToLive)</span> {
    <span class="hljs-comment">// 还有maxMsToLive毫秒，快速迁移连接</span>
    <span class="hljs-keyword">if</span> (maxMsToLive &gt; <span class="hljs-number">0</span> &amp;&amp; maxMsToLive &lt; <span class="hljs-number">30000</span>) {
        <span class="hljs-comment">// 将TCP连接迁移到新网络</span>
        migrateConnectionsToNewNetwork();
    }
}
</code></pre>
<h4 data-id="heading-23"><strong>8. SUSPENDED（暂停）</strong></h4>
<p>网络物理可用但逻辑暂停（如飞行模式）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 进入飞行模式</span>
when (Intent.ACTION_AIRPLANE_MODE_CHANGED) {
    <span class="hljs-keyword">if</span> (isAirplaneModeOn) {
        <span class="hljs-comment">// 暂停所有网络（除了local-only）</span>
        <span class="hljs-keyword">for</span> (NetworkAgentInfo nai : mNetworkAgentInfos.values()) {
            <span class="hljs-keyword">if</span> (!nai.isLocalNetwork()) {
                nai.networkInfo.setDetailedState(
                    NetworkInfo.DetailedState.SUSPENDED,
                    <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-24"><strong>9. DISCONNECTING（断开中）</strong></h4>
<p>主动或被动断开：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 主动断开</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">disconnect</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// Agent通知ConnectivityService</span>
    mAsyncChannel.sendMessage(CMD_NETWORK_DISCONNECT);
}

<span class="hljs-comment">// ConnectivityService处理</span>
<span class="hljs-keyword">case</span> CMD_NETWORK_DISCONNECT:
    <span class="hljs-comment">// 1. 移除路由</span>
    mNetd.networkDestroy(nai.network.netId);

    <span class="hljs-comment">// 2. 通知应用</span>
    callCallbackForRequest(nri, nai, CALLBACK_LOST);

    <span class="hljs-comment">// 3. 清理Agent</span>
    mNetworkAgentInfos.remove(nai.messenger);
    <span class="hljs-keyword">break</span>;
</code></pre>
<h3 data-id="heading-25">2.3 NetworkAgent实现示例：WiFiNetworkAgent</h3>
<p>源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/Wifi/service/java/com/android/server/wifi/WifiNetworkAgent.java
</code></pre>
<p><strong>创建过程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// frameworks/.../WifiNetworkAgent.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WifiNetworkAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkAgent</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WifiInfo mWifiInfo;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WifiNetworkAgent</span><span class="hljs-params">(Context context, Looper looper,
                           WifiInfo wifiInfo,
                           NetworkCapabilities nc,
                           LinkProperties lp,
                           NetworkScore score)</span> {
        <span class="hljs-built_in">super</span>(context, looper, <span class="hljs-string">"WifiNetworkAgent"</span>,
              nc, lp, score, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkAgentConfig</span>.Builder().build(),
              NetworkProvider.ID_WIFI);

        mWifiInfo = wifiInfo;
        register();  <span class="hljs-comment">// 向ConnectivityService注册</span>
    }

    <span class="hljs-comment">// 当WiFi连接信息变化时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNetworkCapabilities</span><span class="hljs-params">(NetworkCapabilities nc)</span> {
        <span class="hljs-comment">// 更新WiFi特定能力</span>
        nc.setSignalStrength(mWifiInfo.getRssi());
        nc.setLinkUpstreamBandwidthKbps(
            mWifiInfo.getLinkSpeed() * <span class="hljs-number">1000</span>);

        <span class="hljs-built_in">super</span>.sendNetworkCapabilities(nc);
    }

    <span class="hljs-comment">// 当IP配置完成时</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendLinkProperties</span><span class="hljs-params">(LinkProperties lp)</span> {
        <span class="hljs-comment">// WiFi接口名</span>
        lp.setInterfaceName(mWifiInfo.getInterfaceName());

        <span class="hljs-comment">// IP地址</span>
        lp.addLinkAddress(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkAddress</span>(ipAddress, prefixLength));

        <span class="hljs-comment">// DNS服务器</span>
        <span class="hljs-keyword">for</span> (InetAddress dns : dnsServers) {
            lp.addDnsServer(dns);
        }

        <span class="hljs-comment">// 路由</span>
        lp.addRoute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RouteInfo</span>(destination, gateway, ifname));

        <span class="hljs-built_in">super</span>.sendLinkProperties(lp);
    }
}
</code></pre>
<p><strong>状态上报流程</strong>：</p>
<pre><code class="hljs language-css" lang="css">WiFi驱动: DHCP成功获取IP
    ↓
WifiStateMachine: 解析IP配置
    ↓
WifiNetworkAgent.<span class="hljs-built_in">sendLinkProperties</span>(lp)
    ↓
NetworkAgent.<span class="hljs-built_in">sendMessage</span>(EVENT_NETWORK_PROPERTIES_CHANGED, lp)
    ↓
ConnectivityService收到消息
    ↓
<span class="hljs-built_in">updateLinkProperties</span>(nai, lp)
    ↓
触发NetworkMonitor验证
    ↓
<span class="hljs-built_in">notifyNetworkCallbacks</span>(CALLBACK_IP_CHANGED)
    ↓
应用收到<span class="hljs-built_in">onLinkPropertiesChanged</span>()回调
</code></pre>
<hr/>
<h2 data-id="heading-26">三、NetworkFactory工作原理</h2>
<h3 data-id="heading-27">3.1 NetworkFactory的角色</h3>
<p><strong>NetworkFactory</strong>是"网络工厂"，负责按需创建网络连接。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">应用请求：<span class="hljs-string">"我需要WiFi网络"</span>
    ↓
<span class="hljs-symbol">ConnectivityService:</span> <span class="hljs-string">"哪个Factory能提供WiFi?"</span>
    ↓
<span class="hljs-symbol">WiFiNetworkFactory:</span> <span class="hljs-string">"我可以！"</span>
    ↓
WiFiNetworkFactory激活WiFi连接
    ↓
创建WifiNetworkAgent并注册
</code></pre>
<h3 data-id="heading-28">3.2 Factory注册与评分</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Wifi/.../WifiNetworkFactory.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WifiNetworkFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">NetworkFactory</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WifiNetworkFactory</span><span class="hljs-params">(Looper looper, Context context, ...)</span> {
        <span class="hljs-built_in">super</span>(looper, context, <span class="hljs-string">"WifiNetworkFactory"</span>,
              <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCapabilities</span>.Builder()
                  .addTransportType(TRANSPORT_WIFI)
                  .addCapability(NET_CAPABILITY_INTERNET)
                  .addCapability(NET_CAPABILITY_NOT_RESTRICTED)
                  .build());

        <span class="hljs-comment">// 注册到ConnectivityService</span>
        register();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">needNetworkFor</span><span class="hljs-params">(NetworkRequest request)</span> {
        <span class="hljs-comment">// 收到ConnectivityService的网络请求</span>

        <span class="hljs-comment">// 1. 检查是否能满足请求</span>
        <span class="hljs-keyword">if</span> (!request.hasCapability(NET_CAPABILITY_INTERNET)) {
            <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 不处理</span>
        }

        <span class="hljs-comment">// 2. 启动WiFi扫描</span>
        mWifiManager.startScan();

        <span class="hljs-comment">// 3. 连接最佳AP</span>
        <span class="hljs-type">WifiConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> selectBestNetwork(scanResults);
        mWifiManager.connect(config, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseNetworkFor</span><span class="hljs-params">(NetworkRequest request)</span> {
        <span class="hljs-comment">// NetworkRequest被取消，可以断开WiFi</span>
        <span class="hljs-keyword">if</span> (noMoreRequests()) {
            mWifiManager.disconnect();
        }
    }
}
</code></pre>
<h3 data-id="heading-29">3.3 NetworkRequest匹配机制</h3>
<p><strong>NetworkCapabilities匹配规则</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkCapabilities.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">satisfiedByNetworkCapabilities</span><span class="hljs-params">(NetworkCapabilities nc)</span> {
    <span class="hljs-comment">// 1. Transport类型必须匹配</span>
    <span class="hljs-keyword">if</span> ((mTransportTypes &amp; nc.mTransportTypes) != mTransportTypes) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 2. 必须的Capability都要有</span>
    <span class="hljs-keyword">if</span> ((mNetworkCapabilities &amp; nc.mNetworkCapabilities)
        != mNetworkCapabilities) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 3. 禁止的Capability不能有</span>
    <span class="hljs-keyword">if</span> ((mUnwantedNetworkCapabilities &amp; nc.mNetworkCapabilities) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 4. 链路上下行带宽满足要求</span>
    <span class="hljs-keyword">if</span> (getLinkDownstreamBandwidthKbps() &gt;
        nc.getLinkDownstreamBandwidthKbps()) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>示例：复杂NetworkRequest</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用请求：高速、非计费、WiFi直连网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_INTERNET)
    .addCapability(NET_CAPABILITY_NOT_METERED)  <span class="hljs-comment">// 非计费</span>
    .addTransportType(TRANSPORT_WIFI)           <span class="hljs-comment">// 必须WiFi</span>
    .setLinkDownstreamBandwidthKbps(<span class="hljs-number">10000</span>)      <span class="hljs-comment">// 至少10Mbps</span>
    .setNetworkSpecifier(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WifiNetworkSpecifier</span>.Builder()
        .setSsid(<span class="hljs-string">"MyNetwork"</span>)                   <span class="hljs-comment">// 指定SSID</span>
        .build())
    .build();

cm.requestNetwork(request, callback);
</code></pre>
<p><strong>ConnectivityService匹配过程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendUpdatedScoreToFactories</span><span class="hljs-params">(NetworkRequest request)</span> {
    <span class="hljs-comment">// 遍历所有Factory</span>
    <span class="hljs-keyword">for</span> (NetworkFactoryInfo nfi : mNetworkFactoryInfos) {

        <span class="hljs-comment">// 计算该Factory对这个Request的匹配得分</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> nfi.networkCapabilities
            .calculateScore(request.networkCapabilities);

        <span class="hljs-comment">// 发送REQUEST_NETWORK消息，附带分数</span>
        nfi.asyncChannel.sendMessage(CMD_REQUEST_NETWORK,
                                     score, <span class="hljs-number">0</span>, request);
    }
}
</code></pre>
<h3 data-id="heading-30">3.4 Factory竞争机制</h3>
<p>当多个Factory都能满足请求时，通过评分竞争：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkFactory.java</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-keyword">switch</span> (msg.what) {
        <span class="hljs-keyword">case</span> CMD_REQUEST_NETWORK:
            <span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (NetworkRequest) msg.obj;
            <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> msg.arg1;

            <span class="hljs-comment">// 如果分数为0，说明不匹配，释放网络</span>
            <span class="hljs-keyword">if</span> (score == <span class="hljs-number">0</span>) {
                releaseNetworkFor(request);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 分数越高，越应该积极响应</span>
                <span class="hljs-keyword">if</span> (score &gt; mCurrentScore) {
                    needNetworkFor(request);
                }
            }
            <span class="hljs-keyword">break</span>;
    }
}
</code></pre>
<p><strong>实际场景</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">用户请求：联网但不指定类型

WiFiNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">60</span> (WiFi已连接)
  - 无需操作，WiFi已激活

TelephonyNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">50</span> (移动数据可用但未连接)
  - score &lt; WiFi，不激活移动数据

VpnNetworkFactory收到:
  - <span class="hljs-attr">score</span> = <span class="hljs-number">0</span> (VPN无法满足普通请求)
  - 释放VPN请求(如果有)

最终：使用WiFi网络
</code></pre>
<hr/>
<h2 data-id="heading-31">四、WiFi与移动网络切换</h2>
<h3 data-id="heading-32">4.1 切换触发条件</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rematchAllNetworksAndRequests</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 重新评估所有网络</span>
    <span class="hljs-keyword">for</span> (NetworkAgentInfo nai : mNetworkAgentInfos.values()) {
        updateNetworkScore(nai);
    }

    <span class="hljs-comment">// 2. 重新选择最佳网络</span>
    <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">newDefault</span> <span class="hljs-operator">=</span> getBestNetwork();

    <span class="hljs-comment">// 3. 如果默认网络变化</span>
    <span class="hljs-keyword">if</span> (newDefault != mDefaultNetwork) {
        <span class="hljs-comment">// 触发切换</span>
        makeDefault(newDefault);
    }
}
</code></pre>
<p><strong>常见触发场景</strong>：</p>



































<table><thead><tr><th align="left">场景</th><th align="left">触发条件</th><th align="left">切换方向</th></tr></thead><tbody><tr><td align="left">WiFi信号变弱</td><td align="left">RSSI &lt; -75dBm</td><td align="left">WiFi → 移动网络</td></tr><tr><td align="left">WiFi验证失败</td><td align="left">HTTP探测失败</td><td align="left">WiFi → 移动网络</td></tr><tr><td align="left">移动数据打开</td><td align="left">用户手动启用</td><td align="left">无 → 移动网络</td></tr><tr><td align="left">连接到更好的WiFi</td><td align="left">新WiFi RSSI更高</td><td align="left">移动网络 → WiFi</td></tr><tr><td align="left">移出WiFi覆盖</td><td align="left">WiFi断开</td><td align="left">WiFi → 移动网络</td></tr></tbody></table>
<h3 data-id="heading-33">4.2 NetworkRanker评分算法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// packages/modules/Connectivity/.../NetworkRanker.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkRanker</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">rankNetwork</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-comment">// 1. 基础分数（Transport类型）</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_WIFI)) {
            score += <span class="hljs-number">60</span>;  <span class="hljs-comment">// WiFi基础分60</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_CELLULAR)) {
            score += <span class="hljs-number">50</span>;  <span class="hljs-comment">// 移动网络基础分50</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_ETHERNET)) {
            score += <span class="hljs-number">70</span>;  <span class="hljs-comment">// 以太网基础分70</span>
        }

        <span class="hljs-comment">// 2. 验证状态加分</span>
        <span class="hljs-keyword">if</span> (nai.everValidated) {
            score += <span class="hljs-number">10</span>;  <span class="hljs-comment">// 曾经验证通过+10分</span>
        }
        <span class="hljs-keyword">if</span> (nai.lastValidated) {
            score += <span class="hljs-number">20</span>;  <span class="hljs-comment">// 最近验证通过+20分</span>
        }

        <span class="hljs-comment">// 3. 网络能力加分</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasCapability(
            NET_CAPABILITY_NOT_METERED)) {
            score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 非计费网络+5分</span>
        }
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasCapability(
            NET_CAPABILITY_NOT_ROAMING)) {
            score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 非漫游+5分</span>
        }

        <span class="hljs-comment">// 4. 信号强度影响(WiFi)</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_WIFI)) {
            <span class="hljs-type">int</span> <span class="hljs-variable">rssi</span> <span class="hljs-operator">=</span> nai.networkCapabilities.getSignalStrength();
            <span class="hljs-keyword">if</span> (rssi &gt; -<span class="hljs-number">60</span>) score += <span class="hljs-number">10</span>;      <span class="hljs-comment">// 优秀信号</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rssi &gt; -<span class="hljs-number">70</span>) score += <span class="hljs-number">5</span>;  <span class="hljs-comment">// 良好信号</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rssi &lt; -<span class="hljs-number">80</span>) score -= <span class="hljs-number">10</span>; <span class="hljs-comment">// 差信号扣分</span>
        }

        <span class="hljs-comment">// 5. 链路速度影响</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">linkSpeed</span> <span class="hljs-operator">=</span> nai.networkCapabilities
            .getLinkDownstreamBandwidthKbps();
        <span class="hljs-keyword">if</span> (linkSpeed &gt; <span class="hljs-number">100000</span>) score += <span class="hljs-number">10</span>;  <span class="hljs-comment">// &gt;100Mbps</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (linkSpeed &gt; <span class="hljs-number">10000</span>) score += <span class="hljs-number">5</span>; <span class="hljs-comment">// &gt;10Mbps</span>

        <span class="hljs-comment">// 6. VPN特殊处理</span>
        <span class="hljs-keyword">if</span> (nai.networkCapabilities.hasTransport(TRANSPORT_VPN)) {
            score += <span class="hljs-number">101</span>;  <span class="hljs-comment">// VPN总是优先</span>
        }

        <span class="hljs-keyword">return</span> score;
    }
}
</code></pre>
<p><strong>示例计算</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">场景：<span class="hljs-built_in">WiFi</span>和LTE同时可用

<span class="hljs-built_in">WiFi</span>网络:
  基础分: <span class="hljs-number">60</span>
  验证通过: +<span class="hljs-number">20</span>
  非计费: +<span class="hljs-number">5</span>
  信号强度(<span class="hljs-number">-65</span>dBm): +<span class="hljs-number">5</span>
  速度(<span class="hljs-number">50</span>Mbps): +<span class="hljs-number">5</span>
  总分: <span class="hljs-number">95</span>

LTE网络:
  基础分: <span class="hljs-number">50</span>
  验证通过: +<span class="hljs-number">20</span>
  漫游: <span class="hljs-number">0</span>
  总分: <span class="hljs-number">70</span>

结果：<span class="hljs-built_in">WiFi</span>得分更高，成为默认网络
</code></pre>
<h3 data-id="heading-34">4.3 无缝切换实现</h3>
<p><strong>第一阶段：准备新网络</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ConnectivityService.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeDefault</span><span class="hljs-params">(NetworkAgentInfo newDefault)</span> {
    <span class="hljs-type">NetworkAgentInfo</span> <span class="hljs-variable">oldDefault</span> <span class="hljs-operator">=</span> mDefaultNetwork;

    <span class="hljs-keyword">if</span> (oldDefault == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 首次建立默认网络</span>
        setDefaultNetwork(newDefault);
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 1. 配置新网络路由（但不设为默认）</span>
    mNetd.networkAddRoute(newDefault.network.netId,
                         newDefault.linkProperties.getInterfaceName(),
                         <span class="hljs-string">"0.0.0.0/0"</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 2. 通知应用新网络可用</span>
    callCallbackForRequest(nri, newDefault, CALLBACK_AVAILABLE);

    <span class="hljs-comment">// 3. 给旧网络30秒Linger时间</span>
    handleLingerComplete(oldDefault);
}
</code></pre>
<p><strong>第二阶段：迁移连接</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用收到onAvailable回调</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
    <span class="hljs-comment">// 主动将Socket绑定到新网络</span>
    network.bindSocket(mySocket);

    <span class="hljs-comment">// 或使用Network.openConnection</span>
    <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection)
        network.openConnection(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">"https://example.com"</span>));
}
</code></pre>
<p><strong>第三阶段：切换默认网络</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Linger超时后，切换默认路由</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLingered</span><span class="hljs-params">(NetworkAgentInfo nai)</span> {
    <span class="hljs-comment">// 1. 移除旧网络默认路由</span>
    mNetd.networkClearDefault();

    <span class="hljs-comment">// 2. 设置新网络为默认</span>
    mNetd.networkSetDefault(mDefaultNetwork.network.netId);

    <span class="hljs-comment">// 3. 通知应用旧网络已丢失</span>
    callCallbackForRequest(nri, nai, CALLBACK_LOST);

    <span class="hljs-comment">// 4. 销毁旧NetworkAgent</span>
    nai.networkMonitor.stop();
    mNetworkAgentInfos.remove(nai.messenger);
}
</code></pre>
<p><strong>用户体验</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">时刻<span class="hljs-number">0</span>s: <span class="hljs-built_in">WiFi</span>信号变弱
  → NetworkMonitor检测到验证失败
  → NetworkRanker重新评分
  → LTE得分超过<span class="hljs-built_in">WiFi</span>

时刻<span class="hljs-number">0.1</span>s: 准备LTE网络
  → TelephonyNetworkFactory激活数据连接
  → <span class="hljs-number">3</span><span class="hljs-number">-5</span>秒后LTE连接建立

时刻<span class="hljs-number">5</span>s: 通知应用
  → 发送<span class="hljs-built_in">CALLBACK_AVAILABLE</span>(LTE)
  → 应用开始迁移连接

时刻<span class="hljs-number">5</span><span class="hljs-number">-35</span>s: Linger期
  → <span class="hljs-built_in">WiFi</span>和LTE并存
  → 新连接使用LTE
  → 旧连接仍用<span class="hljs-built_in">WiFi</span>

时刻<span class="hljs-number">35</span>s: 完成切换
  → <span class="hljs-built_in">WiFi</span>成为默认网络
  → 发送<span class="hljs-built_in">CALLBACK_LOST</span>(<span class="hljs-built_in">WiFi</span>)
  → <span class="hljs-built_in">WiFi</span>断开

用户感知：几乎无感知切换
</code></pre>
<h3 data-id="heading-35">4.4 避免频繁切换</h3>
<p><strong>问题</strong>：WiFi信号在临界值附近波动导致频繁切换</p>
<p><strong>解决方案：Hysteresis（滞后）机制</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkRanker.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldSwitchToNewNetwork</span><span class="hljs-params">(NetworkAgentInfo oldNai,
                                        NetworkAgentInfo newNai)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">oldScore</span> <span class="hljs-operator">=</span> rankNetwork(oldNai);
    <span class="hljs-type">int</span> <span class="hljs-variable">newScore</span> <span class="hljs-operator">=</span> rankNetwork(newNai);

    <span class="hljs-comment">// 新网络必须显著优于旧网络才切换</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HYSTERESIS</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;  <span class="hljs-comment">// 滞后阈值</span>

    <span class="hljs-keyword">if</span> (newScore &gt; oldScore + HYSTERESIS) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 新网络显著更好</span>
    }

    <span class="hljs-comment">// 避免抖动：仅当新网络远优于旧网络时才切换</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p><strong>效果</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">不使用滞后:
时间  <span class="hljs-built_in">WiFi</span> RSSI  分数  默认网络
<span class="hljs-number">0</span>s    <span class="hljs-number">-71</span>dBm    <span class="hljs-number">65</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">1</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">2</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    → 切换到LTE
<span class="hljs-number">3</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    → 切换到<span class="hljs-built_in">WiFi</span>
<span class="hljs-number">4</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    → 切换到<span class="hljs-built_in">LTE</span>  (频繁抖动)

使用滞后(阈值<span class="hljs-number">10</span>):
<span class="hljs-number">0</span>s    <span class="hljs-number">-71</span>dBm    <span class="hljs-number">65</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">1</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">WiFi</span>
<span class="hljs-number">2</span>s    <span class="hljs-number">-75</span>dBm    <span class="hljs-number">60</span>    <span class="hljs-built_in">WiFi</span>  (<span class="hljs-number">60</span> vs <span class="hljs-number">50</span>+<span class="hljs-number">10</span>=<span class="hljs-number">60</span>, 不切换)
<span class="hljs-number">3</span>s    <span class="hljs-number">-77</span>dBm    <span class="hljs-number">55</span>    → 切换到<span class="hljs-built_in">LTE</span> (<span class="hljs-number">55</span> &lt; <span class="hljs-number">50</span>+<span class="hljs-number">10</span>)
<span class="hljs-number">4</span>s    <span class="hljs-number">-73</span>dBm    <span class="hljs-number">63</span>    <span class="hljs-built_in">LTE</span>   (<span class="hljs-number">63</span> &lt; <span class="hljs-number">50</span>+<span class="hljs-number">10</span>, 仍用LTE)
</code></pre>
<hr/>
<h2 data-id="heading-36">五、网络验证与Captive Portal处理</h2>
<h3 data-id="heading-37">5.1 NetworkMonitor验证流程</h3>
<p>源码位置：</p>
<pre><code class="hljs language-bash" lang="bash">packages/modules/NetworkStack/src/android/net/captiveportal/CaptivePortalProbeResult.java
packages/modules/NetworkStack/src/android/net/NetworkMonitor.java
</code></pre>
<p><strong>完整验证流程</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor.java (简化版)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkMonitor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StateMachine</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_HTTP_URL</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"http://connectivitycheck.gstatic.com/generate_204"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_HTTPS_URL</span> <span class="hljs-operator">=</span>
        <span class="hljs-string">"https://www.google.com/generate_204"</span>;

    <span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">isCaptivePortal</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 1. HTTP探测</span>
        <span class="hljs-type">CaptivePortalProbeResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sendHttpProbe(
            mCleartextDnsNetwork, VALIDATION_TYPE_HTTP);

        <span class="hljs-keyword">if</span> (result.isSuccessful()) {
            <span class="hljs-comment">// HTTP 204返回，说明可以访问互联网</span>
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">if</span> (result.isPortal()) {
            <span class="hljs-comment">// HTTP重定向，说明是Captive Portal</span>
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// 2. HTTPS探测（更可靠）</span>
        result = sendHttpProbe(
            mCleartextDnsNetwork, VALIDATION_TYPE_HTTPS);

        <span class="hljs-keyword">if</span> (result.isSuccessful()) {
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// 3. DNS探测（检查DNS是否被劫持）</span>
        result = sendDnsProbe(mPrivateDnsProviderHostname);

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">sendHttpProbe</span><span class="hljs-params">(
            Network network, <span class="hljs-type">int</span> validationType)</span> {

        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> (validationType == VALIDATION_TYPE_HTTPS)
                ? mHttpsUrl : mHttpUrl;

        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            conn = (HttpURLConnection) network.openConnection(url);
            conn.setInstanceFollowRedirects(<span class="hljs-literal">false</span>);
            conn.setConnectTimeout(SOCKET_TIMEOUT_MS);
            conn.setReadTimeout(SOCKET_TIMEOUT_MS);
            conn.setUseCaches(<span class="hljs-literal">false</span>);
            conn.addRequestProperty(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"close"</span>);

            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime();
            conn.getInputStream();
            <span class="hljs-type">long</span> <span class="hljs-variable">latency</span> <span class="hljs-operator">=</span> SystemClock.elapsedRealtime() - start;

            <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();
            <span class="hljs-type">String</span> <span class="hljs-variable">location</span> <span class="hljs-operator">=</span> conn.getHeaderField(<span class="hljs-string">"Location"</span>);

            <span class="hljs-comment">// HTTP 204 = 验证通过</span>
            <span class="hljs-keyword">if</span> (responseCode == <span class="hljs-number">204</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                    CaptivePortalProbeResult.SUCCESS, latency);
            }

            <span class="hljs-comment">// HTTP 200 = 可能是Captive Portal</span>
            <span class="hljs-keyword">if</span> (responseCode &gt;= <span class="hljs-number">200</span> &amp;&amp; responseCode &lt;= <span class="hljs-number">399</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                    CaptivePortalProbeResult.PORTAL,
                    location, latency);
            }

            <span class="hljs-comment">// 其他 = 验证失败</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, latency);

        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, <span class="hljs-number">0</span>);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) conn.disconnect();
        }
    }
}
</code></pre>
<h3 data-id="heading-38">5.2 Captive Portal登录流程</h3>
<p><strong>场景：连接星巴克WiFi</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Step 1:</span> <span class="hljs-string">物理连接</span>
  <span class="hljs-string">用户:</span> <span class="hljs-string">选择"Starbucks</span> <span class="hljs-string">WiFi"</span>
  <span class="hljs-attr">WiFi:</span> <span class="hljs-string">DHCP获取IP</span> <span class="hljs-string">(192.168.1.100)</span>
  <span class="hljs-attr">WiFiNetworkAgent:</span> <span class="hljs-string">上报CONNECTED状态</span>

<span class="hljs-attr">Step 2:</span> <span class="hljs-string">NetworkMonitor验证</span>
  <span class="hljs-string">HTTP探测</span> <span class="hljs-string">→</span> <span class="hljs-string">http://connectivitycheck.gstatic.com/generate_204</span>
  <span class="hljs-string">服务器返回:</span> <span class="hljs-string">HTTP</span> <span class="hljs-number">302</span> <span class="hljs-string">Redirect</span>
  <span class="hljs-attr">Location:</span> <span class="hljs-string">http://星巴克登录页面.com/login</span>

  <span class="hljs-string">结论:</span> <span class="hljs-string">检测到Captive</span> <span class="hljs-string">Portal</span>

<span class="hljs-attr">Step 3:</span> <span class="hljs-string">通知用户</span>
  <span class="hljs-string">系统通知:</span> <span class="hljs-string">"需要登录WiFi网络"</span>
  <span class="hljs-string">点击后打开:</span> <span class="hljs-string">CaptivePortalLoginActivity</span>

<span class="hljs-attr">Step 4:</span> <span class="hljs-string">用户登录</span>
  <span class="hljs-string">WebView加载登录页</span>
  <span class="hljs-string">用户输入信息</span> <span class="hljs-string">/</span> <span class="hljs-string">同意条款</span>
  <span class="hljs-string">登录成功</span>

<span class="hljs-attr">Step 5:</span> <span class="hljs-string">重新验证</span>
  <span class="hljs-attr">NetworkMonitor:</span> <span class="hljs-string">再次发送HTTP探测</span>
  <span class="hljs-string">服务器返回:</span> <span class="hljs-string">HTTP</span> <span class="hljs-number">204</span> <span class="hljs-string">(验证通过)</span>
  <span class="hljs-string">状态:</span> <span class="hljs-string">CAPTIVE_PORTAL</span> <span class="hljs-string">→</span> <span class="hljs-string">VALIDATED</span>
</code></pre>
<p><strong>代码实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CaptivePortalLoginActivity.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaptivePortalLoginActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> {

    <span class="hljs-keyword">private</span> WebView mWebView;
    <span class="hljs-keyword">private</span> Network mNetwork;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);

        <span class="hljs-comment">// 获取要验证的网络</span>
        mNetwork = getIntent().getParcelableExtra(
            ConnectivityManager.EXTRA_NETWORK);

        <span class="hljs-comment">// 设置WebView使用该网络</span>
        mWebView = findViewById(R.id.webview);
        mWebView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PortalWebViewClient</span>());

        <span class="hljs-comment">// 加载登录页面</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> getIntent().getStringExtra(
            ConnectivityManager.EXTRA_CAPTIVE_PORTAL_URL);
        mWebView.loadUrl(url);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PortalWebViewClient</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WebViewClient</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, String url)</span> {
            <span class="hljs-comment">// 检查是否登录成功</span>
            <span class="hljs-keyword">if</span> (isSuccessUrl(url)) {
                <span class="hljs-comment">// 通知系统重新验证</span>
                notifyPortalLoginSuccess();
                finish();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyPortalLoginSuccess</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> getSystemService(
            ConnectivityManager.class);
        cm.reportNetworkConnectivity(mNetwork, <span class="hljs-literal">true</span>);
    }
}
</code></pre>
<h3 data-id="heading-39">5.3 Android 15 Private DNS支持</h3>
<p><strong>DoT (DNS over TLS)</strong> - 加密DNS查询：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NetworkMonitor.java - Android 15新增</span>
<span class="hljs-keyword">private</span> CaptivePortalProbeResult <span class="hljs-title function_">sendDnsProbe</span><span class="hljs-params">(String hostname)</span> {
    <span class="hljs-keyword">if</span> (isPrivateDnsValidationRequired()) {
        <span class="hljs-comment">// 使用TLS加密的DNS查询</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SSLSocket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> (SSLSocket)
                SSLSocketFactory.getDefault()
                    .createSocket(mPrivateDnsServerIp, <span class="hljs-number">853</span>);

            socket.startHandshake();

            <span class="hljs-comment">// 发送DNS查询</span>
            <span class="hljs-type">DnsPacket</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> DnsPacket.createQuery(
                hostname, TYPE_A);
            socket.getOutputStream().write(query.getBytes());

            <span class="hljs-comment">// 接收响应</span>
            <span class="hljs-type">DnsPacket</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> DnsPacket.parse(
                socket.getInputStream());

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.SUCCESS, <span class="hljs-number">0</span>);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaptivePortalProbeResult</span>(
                CaptivePortalProbeResult.FAILED, <span class="hljs-number">0</span>);
        }
    }
}
</code></pre>
<p><strong>配置Private DNS</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 → 网络和互联网 → 私人DNS</span>
adb shell settings put global private_dns_mode hostname
adb shell settings put global private_dns_specifier dns.google

<span class="hljs-comment"># 验证</span>
adb shell getprop net.dns1
<span class="hljs-comment"># 输出: 8.8.8.8 (使用Google Public DNS)</span>
</code></pre>
<hr/>
<h2 data-id="heading-40">六、实战：网络问题诊断</h2>
<h3 data-id="heading-41">6.1 WiFi连接失败排查</h3>
<p><strong>症状</strong>：WiFi显示"已连接"但无法上网</p>
<p><strong>诊断步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 1: 检查网络状态</span>
adb shell dumpsys connectivity | grep -A 30 <span class="hljs-string">"Active networks"</span>

<span class="hljs-comment"># 输出示例:</span>
<span class="hljs-comment"># NetworkAgentInfo{ ni{[WIFI () - 100]}</span>
<span class="hljs-comment">#   network{151}  handle{151}</span>
<span class="hljs-comment">#   lp{{InterfaceName: wlan0</span>
<span class="hljs-comment">#       LinkAddresses: [ 192.168.1.100/24 ]</span>
<span class="hljs-comment">#       DnsAddresses: [ 192.168.1.1 ]</span>
<span class="hljs-comment">#       Routes: [ 0.0.0.0/0 -&gt; 192.168.1.1 wlan0 ]}}</span>
<span class="hljs-comment">#   nc{[ Transports: WIFI</span>
<span class="hljs-comment">#        Capabilities: NOT_METERED</span>
<span class="hljs-comment">#        NOT_ROAMING INTERNET NOT_SUSPENDED VALIDATED]}  ← 注意这里</span>
<span class="hljs-comment">#   Score{current=60 validated=true}}</span>

<span class="hljs-comment"># 关键字段:</span>
<span class="hljs-comment"># - VALIDATED: 网络已验证 (如果没有此字段，说明验证失败)</span>
<span class="hljs-comment"># - DnsAddresses: DNS服务器 (检查是否正确)</span>
<span class="hljs-comment"># - LinkAddresses: 本机IP (检查是否在合理范围)</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 2: 检查网络验证结果</span>
adb shell dumpsys network_stack | grep -i <span class="hljs-string">"validation"</span>

<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># ValidationProbeEvent{latency=234 result=204 ...}  ← HTTP 204表示通过</span>
<span class="hljs-comment"># 或</span>
<span class="hljs-comment"># ValidationProbeEvent{latency=5000 result=timeout ...}  ← 超时</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 3: 手动测试连通性</span>
adb shell

<span class="hljs-comment"># Ping网关</span>
ping -c 4 192.168.1.1
<span class="hljs-comment"># 如果不通，说明局域网问题</span>

<span class="hljs-comment"># Ping DNS</span>
ping -c 4 8.8.8.8
<span class="hljs-comment"># 如果不通，说明路由问题</span>

<span class="hljs-comment"># Ping域名</span>
ping -c 4 www.google.com
<span class="hljs-comment"># 如果不通，说明DNS问题</span>

<span class="hljs-comment"># HTTP测试</span>
curl -I http://connectivitycheck.gstatic.com/generate_204
<span class="hljs-comment"># 应该返回 HTTP/1.1 204 No Content</span>
</code></pre>
<p><strong>常见原因与解决方案</strong>：</p>



































<table><thead><tr><th align="left">现象</th><th align="left">原因</th><th align="left">解决方案</th></tr></thead><tbody><tr><td align="left">Ping网关不通</td><td align="left">WiFi驱动/硬件问题</td><td align="left">重启WiFi，检查驱动日志</td></tr><tr><td align="left">Ping DNS不通</td><td align="left">路由器未设置默认网关</td><td align="left">检查DHCP配置</td></tr><tr><td align="left">Ping域名不通</td><td align="left">DNS服务器故障</td><td align="left">手动设置DNS为8.8.8.8</td></tr><tr><td align="left">HTTP返回302</td><td align="left">Captive Portal</td><td align="left">打开浏览器完成登录</td></tr><tr><td align="left">HTTP超时</td><td align="left">防火墙拦截</td><td align="left">检查iptables规则</td></tr></tbody></table>
<h3 data-id="heading-42">6.2 网络切换异常定位</h3>
<p><strong>症状</strong>：从WiFi切换到移动网络后，应用无法联网</p>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看当前默认网络</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active default"</span>
<span class="hljs-comment"># 输出: Active default network: 151</span>

<span class="hljs-comment"># 2. 查看该网络详情</span>
adb shell dumpsys connectivity networks 151
<span class="hljs-comment"># 确认是否是期望的网络(WiFi/LTE)</span>

<span class="hljs-comment"># 3. 检查应用是否绑定了旧网络</span>
adb shell dumpsys connectivity requests | grep <span class="hljs-string">"YOUR_PACKAGE"</span>
<span class="hljs-comment"># 输出会显示应用的NetworkRequest和绑定的Network</span>

<span class="hljs-comment"># 4. 抓取网络切换日志</span>
adb logcat -b all | grep -E <span class="hljs-string">"ConnectivityService|NetworkAgent"</span>
</code></pre>
<p><strong>典型日志分析</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"># 正常切换日志:
<span class="hljs-symbol">ConnectivityService:</span> NetworkAgentInfo [WIFI] validation passed
<span class="hljs-symbol">ConnectivityService:</span> Setting <span class="hljs-keyword">default</span> network <span class="hljs-keyword">to</span> <span class="hljs-number">151</span> (WIFI)
<span class="hljs-symbol">ConnectivityService:</span> Lingering network <span class="hljs-number">149</span> (MOBILE)
... (<span class="hljs-number">30</span>秒后)
<span class="hljs-symbol">ConnectivityService:</span> Tearing down network <span class="hljs-number">149</span>

# 异常切换日志:
<span class="hljs-symbol">ConnectivityService:</span> NetworkAgentInfo [MOBILE] validation failed
<span class="hljs-symbol">ConnectivityService:</span> <span class="hljs-built_in">Not</span> setting <span class="hljs-keyword">default</span> <span class="hljs-keyword">to</span> unvalidated network
← 移动网络验证失败，未切换
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用代码修复：使用ConnectivityManager.NetworkCallback</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> ...;
<span class="hljs-type">NetworkCallback</span> <span class="hljs-variable">callback</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络可用时，将Socket绑定到新网络</span>
        <span class="hljs-keyword">try</span> {
            network.bindSocket(mySocket);
            <span class="hljs-comment">// 或重新创建连接</span>
            recreateConnection(network);
        } <span class="hljs-keyword">catch</span> (IOException e) {
            Log.e(TAG, <span class="hljs-string">"Failed to bind socket"</span>, e);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLost</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 网络丢失时，清理资源</span>
        closeConnection();
    }
};

<span class="hljs-comment">// 注册监听</span>
cm.registerDefaultNetworkCallback(callback);
</code></pre>
<h3 data-id="heading-43">6.3 性能优化：减少网络切换延迟</h3>
<p><strong>问题</strong>：WiFi→LTE切换需要5-8秒</p>
<p><strong>优化方案</strong>：</p>
<h4 data-id="heading-44"><strong>方案1：预连接移动网络</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 12引入的MultiPath API</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> ...;

<span class="hljs-comment">// 请求同时使用WiFi和LTE</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_INTERNET)
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 保持LTE连接处于激活状态</span>
        <span class="hljs-comment">// 当WiFi断开时，可立即切换</span>
    }
}, MULTI_PATH_PREFERENCE_PERFORMANCE);
</code></pre>
<h4 data-id="heading-45"><strong>方案2：快速失败检测</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 缩短验证超时时间</span>
adb shell settings put global captive_portal_http_url_timeout_ms <span class="hljs-number">3000</span>

<span class="hljs-comment">// 默认值：10000ms (10秒)</span>
<span class="hljs-comment">// 优化后：3000ms (3秒)</span>
</code></pre>
<h4 data-id="heading-46"><strong>方案3：应用层优化 - Happy Eyeballs</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RFC 8305: 同时尝试IPv4和IPv6，使用最快响应的</span>
<span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">connectWithHappyEyeballs</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> {
    List&lt;InetAddress&gt; addresses =
        InetAddress.getAllByName(host);  <span class="hljs-comment">// 获取所有IP</span>

    List&lt;Future&lt;Socket&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();

    <span class="hljs-comment">// 并发连接所有地址</span>
    <span class="hljs-keyword">for</span> (InetAddress addr : addresses) {
        futures.add(executor.submit(() -&gt; {
            <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();
            socket.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(addr, port), <span class="hljs-number">1000</span>);
            <span class="hljs-keyword">return</span> socket;
        }));
    }

    <span class="hljs-comment">// 返回第一个成功的连接</span>
    <span class="hljs-keyword">for</span> (Future&lt;Socket&gt; future : futures) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> future.get(<span class="hljs-number">2</span>, TimeUnit.SECONDS);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 继续尝试下一个</span>
        }
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">"All connection attempts failed"</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-47">七、Android 15新特性</h2>
<h3 data-id="heading-48">7.1 Satellite Connectivity（卫星连接）</h3>
<p>Android 15新增卫星网络支持：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检测卫星网络可用性</span>
<span class="hljs-type">NetworkCapabilities</span> <span class="hljs-variable">nc</span> <span class="hljs-operator">=</span> cm.getNetworkCapabilities(network);

<span class="hljs-keyword">if</span> (nc.hasTransport(NetworkCapabilities.TRANSPORT_SATELLITE)) {
    <span class="hljs-comment">// 这是卫星连接</span>
    <span class="hljs-comment">// 特点：高延迟(500-800ms)、低带宽(几Kbps)、高成本</span>

    <span class="hljs-comment">// 应用应该:</span>
    <span class="hljs-comment">// 1. 使用文本通信而非语音/视频</span>
    <span class="hljs-comment">// 2. 压缩数据</span>
    <span class="hljs-comment">// 3. 减少请求频率</span>
}
</code></pre>
<h3 data-id="heading-49">7.2 Network Slicing (5G网络切片)</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求特定的5G切片</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addCapability(NET_CAPABILITY_ENTERPRISE)
    .setEnterpriseId(NET_ENTERPRISE_ID_1)  <span class="hljs-comment">// 企业专网切片</span>
    .build();

cm.requestNetwork(request, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onAvailable</span><span class="hljs-params">(Network network)</span> {
        <span class="hljs-comment">// 使用企业专网，享受:</span>
        <span class="hljs-comment">// - 更低延迟 (&lt;10ms)</span>
        <span class="hljs-comment">// - 更高带宽保证</span>
        <span class="hljs-comment">// - 更好的QoS</span>
    }
});
</code></pre>
<h3 data-id="heading-50">7.3 Thread Network Support</h3>
<p>Android 15支持Thread协议（用于智能家居）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 连接Thread网络</span>
<span class="hljs-type">NetworkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkRequest</span>.Builder()
    .addTransportType(NetworkCapabilities.TRANSPORT_THREAD)
    .build();

<span class="hljs-comment">// Thread特点:</span>
<span class="hljs-comment">// - 低功耗</span>
<span class="hljs-comment">// - Mesh网络</span>
<span class="hljs-comment">// - IPv6 only</span>
<span class="hljs-comment">// - 用于IoT设备</span>
</code></pre>
<hr/>
<h2 data-id="heading-51">八、总结与展望</h2>
<h3 data-id="heading-52">8.1 核心要点回顾</h3>
<ol>
<li>
<p><strong>ConnectivityService架构</strong></p>
<ul>
<li>系统网络管理中枢</li>
<li>协调NetworkAgent和NetworkFactory</li>
<li>管理网络生命周期</li>
</ul>
</li>
<li>
<p><strong>NetworkAgent机制</strong></p>
<ul>
<li>9种网络状态</li>
<li>状态机驱动</li>
<li>基于Messenger通信</li>
</ul>
</li>
<li>
<p><strong>NetworkFactory工作原理</strong></p>
<ul>
<li>按需激活网络</li>
<li>Capability匹配</li>
<li>评分竞争机制</li>
</ul>
</li>
<li>
<p><strong>网络切换</strong></p>
<ul>
<li>NetworkRanker评分算法</li>
<li>Linger优雅断开</li>
<li>Hysteresis防抖动</li>
</ul>
</li>
<li>
<p><strong>网络验证</strong></p>
<ul>
<li>HTTP/HTTPS探测</li>
<li>Captive Portal处理</li>
<li>Private DNS支持</li>
</ul>
</li>
</ol>
<h3 data-id="heading-53">8.2 ConnectivityService演进史</h3>













































<table><thead><tr><th align="left">版本</th><th align="left">关键变化</th><th align="left">影响</th></tr></thead><tbody><tr><td align="left">Android 5.0</td><td align="left">引入NetworkRequest/NetworkCallback</td><td align="left">应用可主动请求网络</td></tr><tr><td align="left">Android 7.0</td><td align="left">MultiNetwork API</td><td align="left">应用可同时使用多个网络</td></tr><tr><td align="left">Android 9.0</td><td align="left">强制使用HTTPS</td><td align="left">安全性提升</td></tr><tr><td align="left">Android 10.0</td><td align="left">NetworkStack模块化</td><td align="left">可独立更新</td></tr><tr><td align="left">Android 11.0</td><td align="left">eBPF网络策略</td><td align="left">性能大幅提升</td></tr><tr><td align="left">Android 12.0</td><td align="left">Network Slicing</td><td align="left">5G网络切片支持</td></tr><tr><td align="left">Android 15.0</td><td align="left">Satellite + Thread</td><td align="left">扩展连接场景</td></tr></tbody></table>
<h3 data-id="heading-54">8.3 未来展望</h3>
<p><strong>趋势1：AI驱动的网络管理</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 未来可能的实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AINetworkRanker</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.model = load_ml_model(<span class="hljs-string">"network_predictor.tflite"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_network_quality</span>(<span class="hljs-params">self, nai</span>):
        features = extract_features(nai)  <span class="hljs-comment"># RSSI, 速度, 延迟等</span>
        score = self.model.predict(features)
        <span class="hljs-keyword">return</span> score
</code></pre>
<p><strong>趋势2：Seamless Multi-Path</strong></p>
<ul>
<li>同时使用WiFi+5G，自动负载均衡</li>
<li>关键数据走5G（低延迟），大数据走WiFi（省流量）</li>
</ul>
<p><strong>趋势3：边缘计算集成</strong></p>
<ul>
<li>ConnectivityService感知MEC(多接入边缘计算)节点</li>
<li>自动将流量路由到最近的边缘服务器</li>
</ul>
<hr/>
<h2 data-id="heading-55">九、参考资源</h2>
<h3 data-id="heading-56">9.1 源码路径</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ConnectivityService核心</span>
packages/modules/Connectivity/service/src/com/android/server/
├── ConnectivityService.java          <span class="hljs-comment"># 核心服务</span>
├── NetworkAgentInfo.java             <span class="hljs-comment"># Agent信息</span>
├── NetworkRequestInfo.java           <span class="hljs-comment"># 请求信息</span>
└── connectivity/
    ├── NetworkRanker.java            <span class="hljs-comment"># 网络排名</span>
    └── PermissionMonitor.java        <span class="hljs-comment"># 权限监控</span>

<span class="hljs-comment"># NetworkStack</span>
packages/modules/NetworkStack/src/
├── android/net/NetworkMonitor.java    <span class="hljs-comment"># 网络验证</span>
├── android/net/apf/                   <span class="hljs-comment"># APF包过滤</span>
└── android/net/ip/IpClient.java       <span class="hljs-comment"># IP配置</span>

<span class="hljs-comment"># NetworkAgent实现</span>
packages/modules/Wifi/service/java/com/android/server/wifi/
└── WifiNetworkAgent.java              <span class="hljs-comment"># WiFi Agent</span>

frameworks/opt/telephony/src/java/com/android/internal/telephony/
└── dataconnection/DcNetworkAgent.java <span class="hljs-comment"># Cellular Agent</span>
</code></pre>
<h3 data-id="heading-57">9.2 调试命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有网络</span>
adb shell dumpsys connectivity networks

<span class="hljs-comment"># 查看默认网络</span>
adb shell dumpsys connectivity | grep <span class="hljs-string">"Active default"</span>

<span class="hljs-comment"># 查看NetworkRequest</span>
adb shell dumpsys connectivity requests

<span class="hljs-comment"># 查看NetworkFactory</span>
adb shell dumpsys connectivity factories

<span class="hljs-comment"># 触发网络验证</span>
adb shell cmd connectivity force-network-validation &lt;netId&gt;

<span class="hljs-comment"># 模拟网络切换</span>
adb shell svc wifi <span class="hljs-built_in">disable</span> &amp;&amp; <span class="hljs-built_in">sleep</span> 2 &amp;&amp; adb shell svc wifi <span class="hljs-built_in">enable</span>

<span class="hljs-comment"># 查看eBPF统计</span>
adb shell dumpsys connectivity trafficcontroller
</code></pre>
<h3 data-id="heading-58">9.3 官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fcore%2Fconnect" target="_blank" title="https://source.android.com/docs/core/connect" ref="nofollow noopener noreferrer">Connectivity Overview</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fnet%2FConnectivityManager" target="_blank" title="https://developer.android.com/reference/android/net/ConnectivityManager" ref="nofollow noopener noreferrer">ConnectivityManager API</a></li>
</ul>
<h3 data-id="heading-59">9.4 相关RFC</h3>
<ul>
<li>RFC 3093: DHCP</li>
<li>RFC 8305: Happy Eyeballs v2</li>
<li>RFC 7858: DNS over TLS</li>
<li>RFC 8910: Captive Portal API</li>
</ul>
<hr/>
<h2 data-id="heading-60">后记</h2>
<p>ConnectivityService是Android系统中最复杂的服务之一，管理着设备与外界的所有网络连接。从简单的WiFi连接，到复杂的多网络并发、VPN隧道、5G切片，ConnectivityService都能游刃有余地处理。</p>
<h3 data-id="heading-61">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7599330434427158579" target="_blank" title="https://juejin.cn/post/7599330434427158579">上一篇：Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDK有哪些垃圾回收器]]></title>    <link>https://juejin.cn/post/7599924721007444031</link>    <guid>https://juejin.cn/post/7599924721007444031</guid>    <pubDate>2026-01-28T06:25:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599924721007444031" data-draft-id="7599983917664911403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDK有哪些垃圾回收器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T06:25:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDK有哪些垃圾回收器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T06:25:36.000Z" title="Wed Jan 28 2026 06:25:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>JDK的垃圾回收器（GC）随着版本迭代不断演进，旨在平衡<strong>吞吐量</strong>（用户代码运行时间占比）、<strong>延迟</strong>（STW停顿时间）和<strong>内存占用</strong>三大核心指标。以下是JDK各版本支持的主要垃圾回收器及其特点、适用场景，按<strong>经典→现代</strong>的顺序展开：</p>
<h3 data-id="heading-0"><strong>一、经典垃圾回收器（JDK 8及之前）</strong></h3>
<p>经典回收器基于<strong>分代假设</strong>（年轻代“朝生夕灭”、老年代“长期存活”），分为<strong>年轻代</strong>、<strong>老年代</strong>和<strong>整堆</strong>三类，适用于传统单体应用或中小堆场景。</p>
<h4 data-id="heading-1"><strong>1. 年轻代回收器（Young Generation）</strong></h4>
<p>年轻代回收器负责回收<strong>Eden区</strong>和<strong>Survivor区</strong>（S0/S1）的短生命周期对象，通常采用<strong>复制算法</strong>（无碎片、效率高）。</p>
<h5 data-id="heading-2"><strong>（1）Serial收集器</strong>​</h5>
<ul>
<li><strong>特点</strong>：单线程、STW（Stop-The-World，暂停所有应用线程），采用复制算法。</li>
<li><strong>适用场景</strong>：客户端应用（如桌面程序）、单核CPU环境或资源受限的嵌入式设备。</li>
<li><strong>优势</strong>：简单高效，无线程交互开销，单线程下吞吐量最高。</li>
<li><strong>配置参数</strong>：<code>-XX:+UseSerialGC</code>（启用Serial年轻代+Serial Old老年代组合）。</li>
</ul>
<h5 data-id="heading-3"><strong>（2）ParNew收集器</strong>​</h5>
<ul>
<li><strong>特点</strong>：Serial的<strong>多线程并行版本</strong>，同样采用复制算法，STW。</li>
<li><strong>适用场景</strong>：多核服务器，需与<strong>CMS老年代收集器</strong>配合使用（ParNew是CMS的唯一年轻代搭档）。</li>
<li><strong>优势</strong>：多线程并行回收，缩短年轻代STW时间，适合高并发场景。</li>
<li><strong>配置参数</strong>：<code>-XX:+UseParNewGC</code>（显式启用ParNew）。</li>
</ul>
<h5 data-id="heading-4"><strong>（3）Parallel Scavenge收集器</strong>​</h5>
<ul>
<li><strong>特点</strong>：多线程并行、复制算法，STW，<strong>关注吞吐量</strong>（吞吐量=用户代码时间/(用户代码时间+GC时间)）。</li>
<li><strong>适用场景</strong>：后台运算（如批处理、科学计算）、不需要频繁交互的服务端应用。</li>
<li><strong>优势</strong>：通过<code>-XX:MaxGCPauseMillis</code>（最大停顿时间）、<code>-XX:GCTimeRatio</code>（吞吐量目标）等参数，可实现<strong>自适应调节</strong>（自动调整堆大小、分代比例）。</li>
<li><strong>配置参数</strong>：<code>-XX:+UseParallelGC</code>（启用Parallel Scavenge年轻代+Parallel Old老年代组合，JDK 8默认）。</li>
</ul>
<h4 data-id="heading-5"><strong>2. 老年代回收器（Old Generation）</strong></h4>
<p>老年代回收器负责回收<strong>老年代</strong>的长生命周期对象，通常采用<strong>标记-清除</strong>（CMS）或<strong>标记-整理</strong>（Serial Old、Parallel Old）算法。</p>
<h5 data-id="heading-6"><strong>（1）Serial Old收集器</strong>​</h5>
<ul>
<li><strong>特点</strong>：Serial的老年代版本，单线程、STW，采用<strong>标记-整理算法</strong>（解决内存碎片）。</li>
<li><strong>适用场景</strong>：客户端应用（默认老年代收集器）、作为CMS的后备方案（当CMS并发收集失败时， fallback到Serial Old）。</li>
<li><strong>配置参数</strong>：与Serial组合使用（<code>-XX:+UseSerialGC</code>）。</li>
</ul>
<h5 data-id="heading-7"><strong>（2）Parallel Old收集器</strong>​</h5>
<ul>
<li><strong>特点</strong>：Parallel Scavenge的老年代版本，多线程并行、STW，采用<strong>标记-整理算法</strong>。</li>
<li><strong>适用场景</strong>：与Parallel Scavenge配合，构成<strong>吞吐量优先</strong>的完整收集器组合（JDK 8默认）。</li>
<li><strong>优势</strong>：多线程并行回收，提升老年代吞吐量，适合高吞吐需求的服务器端应用。</li>
<li><strong>配置参数</strong>：<code>-XX:+UseParallelOldGC</code>（显式启用，JDK 8默认包含）。</li>
</ul>
<h5 data-id="heading-8"><strong>（3）CMS（Concurrent Mark Sweep）收集器</strong>​</h5>
<ul>
<li>
<p><strong>特点</strong>：<strong>并发收集</strong>（大部分阶段与应用线程同时运行）、<strong>低延迟</strong>（STW时间短），采用<strong>标记-清除算法</strong>（无整理，易产生碎片）。</p>
</li>
<li>
<p><strong>工作流程</strong>：</p>
<ol>
<li><strong>初始标记</strong>（STW）：标记GC Roots直接关联的对象（速度快）；</li>
<li><strong>并发标记</strong>（与应用线程并行）：遍历对象图，标记存活对象；</li>
<li><strong>重新标记</strong>（STW）：修正并发标记期间的变动（比初始标记略长）；</li>
<li><strong>并发清除</strong>（与应用线程并行）：回收未标记的对象。</li>
</ol>
</li>
<li>
<p><strong>适用场景</strong>：延迟敏感的应用（如Web服务、电商交易系统），需快速响应用户请求。</p>
</li>
<li>
<p><strong>缺点</strong>：</p>
<ul>
<li>对CPU资源敏感（并发阶段占用线程，导致应用吞吐量下降）；</li>
<li>无法处理<strong>浮动垃圾</strong>（并发清除阶段产生的新垃圾，需下次GC处理）；</li>
<li>标记-清除算法易导致<strong>内存碎片</strong>（需通过<code>-XX:+UseCMSCompactAtFullCollection</code>定期整理）。</li>
</ul>
</li>
<li>
<p><strong>配置参数</strong>：<code>-XX:+UseConcMarkSweepGC</code>（启用CMS，JDK 8及之前常用）。</p>
</li>
<li>
<p><strong>注意</strong>：CMS在<strong>JDK 14</strong>中被移除（JEP 363），因其在大堆场景下延迟不稳定。</p>
</li>
</ul>
<h4 data-id="heading-9"><strong>3. 整堆回收器（Whole Heap）</strong></h4>
<p>整堆回收器打破<strong>年轻代/老年代</strong>的物理划分，将堆划分为多个<strong>Region</strong>（区域），实现更灵活的内存管理，兼顾吞吐量与延迟。</p>
<h5 data-id="heading-10"><strong>（1）G1（Garbage-First）收集器</strong>​</h5>
<ul>
<li>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>区域化分代</strong>：将堆划分为多个大小相等的Region（默认1MB-32MB），每个Region可扮演Eden、Survivor或老年代；</li>
<li><strong>可预测停顿</strong>：通过<code>-XX:MaxGCPauseMillis</code>（默认200ms）设置最大停顿时间，优先回收“垃圾最多”的Region（Garbage-First）；</li>
<li><strong>并发标记</strong>：与应用线程并行标记存活对象，减少STW时间；</li>
<li><strong>标记-整理</strong>：回收时采用复制算法（将存活对象复制到新Region），避免内存碎片。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：大堆内存（如16GB以上）、延迟敏感的服务端应用（如微服务、大数据处理）。</p>
</li>
<li>
<p><strong>优势</strong>：兼顾吞吐量（并行回收）与延迟（可预测停顿），是JDK 9至JDK 20的<strong>默认收集器</strong>。</p>
</li>
<li>
<p><strong>配置参数</strong>：<code>-XX:+UseG1GC</code>（显式启用）。</p>
</li>
</ul>
<h3 data-id="heading-11"><strong>二、现代垃圾回收器（JDK 11及之后）</strong></h3>
<p>随着云原生、大堆内存（TB级）应用的普及，经典回收器的<strong>延迟瓶颈</strong>（如G1的STW时间随堆增大而增加）日益凸显。现代回收器通过<strong>全堆并发</strong>（几乎所有阶段与应用线程并行）、<strong>分代优化</strong>（如Generational ZGC）等技术，实现<strong>超低延迟</strong>（&lt;1ms）与<strong>大堆支持</strong>（TB级）。</p>
<h4 data-id="heading-12"><strong>1. ZGC（Z Garbage Collector）</strong> ​</h4>
<ul>
<li>
<p><strong>引入版本</strong>：JDK 11（实验性）、JDK 15（生产级稳定，JEP 377）。</p>
</li>
<li>
<p><strong>核心目标</strong>：</p>
<ul>
<li><strong>超低延迟</strong>：最大STW停顿时间&lt;1ms（与堆大小无关）；</li>
<li><strong>大堆支持</strong>：支持8MB至16TB的堆内存（适合云原生、大数据场景）；</li>
<li><strong>全堆并发</strong>：几乎所有阶段（标记、转移、重映射）与应用线程并行。</li>
</ul>
</li>
<li>
<p><strong>关键技术</strong>：</p>
<ul>
<li><strong>着色指针（Colored Pointers）</strong> ：在64位对象地址中编码GC状态（如Marked0、Marked1、Remapped），实现并发标记与转移；</li>
<li><strong>读屏障（Load Barrier）</strong> ：应用线程读取对象时，检查指针状态，修正并发转移后的对象地址（确保数据一致性）；</li>
<li><strong>Regionless结构</strong>：无固定大小的Region，根据对象大小动态分配（小型Region 2MB、中型32MB、大型Region 4MB以上），避免碎片。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：延迟敏感的超大堆应用（如广告系统、游戏后端、在线服务网关）、云原生容器环境（如K8s）。</p>
</li>
<li>
<p><strong>配置参数</strong>：<code>-XX:+UseZGC</code>（JDK 15+无需解锁实验性参数）。</p>
</li>
<li>
<p><strong>演进</strong>：JDK 21引入<strong>Generational ZGC</strong>（分代ZGC），结合分代假设与ZGC的超低延迟，进一步提升吞吐量（如年轻代采用复制算法，老年代采用并发转移）。</p>
</li>
</ul>
<h4 data-id="heading-13"><strong>2. Shenandoah GC</strong>​</h4>
<ul>
<li>
<p><strong>引入版本</strong>：JDK 12（实验性）、JDK 17（生产级稳定）。</p>
</li>
<li>
<p><strong>核心目标</strong>：<strong>低延迟</strong>（STW停顿时间&lt;10ms）、<strong>全堆并发</strong>（与ZGC类似）。</p>
</li>
<li>
<p><strong>关键技术</strong>：</p>
<ul>
<li><strong>Brooks指针</strong>：在对象头中存储转发地址（Forwarding Address），实现并发转移（避免读屏障的性能开销）；</li>
<li><strong>读写屏障结合</strong>：通过读屏障（修正对象地址）和写屏障（跟踪对象引用变动），确保并发标记的准确性。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：与ZGC类似，适合延迟敏感的大堆应用（如金融交易系统、实时数据处理）。</p>
</li>
<li>
<p><strong>优势</strong>：RedHat主导开发，社区活跃，对<strong>大对象</strong>（如缓存数据）的处理更高效。</p>
</li>
</ul>
<h4 data-id="heading-14"><strong>3. Epsilon GC（JDK 21+）</strong> ​</h4>
<ul>
<li><strong>特点</strong>：<strong>无操作收集器</strong>（No-Op GC），仅分配内存，不回收垃圾（应用退出时由操作系统释放内存）。</li>
<li><strong>适用场景</strong>：<strong>性能测试</strong>（如评估应用的内存分配速率、排除GC干扰）、短期运行的工具（如脚本）。</li>
<li><strong>配置参数</strong>：<code>-XX:+UseEpsilonGC</code>（显式启用）。</li>
</ul>
<h3 data-id="heading-15"><strong>三、各JDK版本的默认垃圾回收器</strong></h3>

























<table><thead><tr><th>JDK版本</th><th>默认垃圾回收器</th><th>说明</th></tr></thead><tbody><tr><td>JDK 8</td><td>Parallel Scavenge + Parallel Old</td><td>吞吐量优先，适合传统服务端应用</td></tr><tr><td>JDK 9-20</td><td>G1</td><td>兼顾吞吐量与延迟，适合大堆内存</td></tr><tr><td>JDK 21+</td><td>ZGC（若支持）</td><td>超低延迟、大堆支持，适合云原生、延迟敏感应用（否则 fallback到G1）</td></tr></tbody></table>
<h3 data-id="heading-16"><strong>四、垃圾回收器选型建议</strong></h3>
<p>选择垃圾回收器的核心依据是<strong>应用需求</strong>（延迟、吞吐量、堆大小），以下是常见场景的选型指南：</p>



































<table><thead><tr><th>场景类型</th><th>推荐收集器</th><th>理由</th></tr></thead><tbody><tr><td>客户端应用（桌面程序）</td><td>Serial + Serial Old</td><td>简单高效，无线程开销</td></tr><tr><td>高吞吐后台运算（批处理）</td><td>Parallel Scavenge + Parallel Old</td><td>吞吐量优先，适合不需要交互的场景</td></tr><tr><td>延迟敏感Web服务</td><td>G1（JDK 8-20）/ ZGC（JDK 21+）</td><td>G1的可预测停顿适合中小堆，ZGC的超低延迟适合大堆</td></tr><tr><td>超大堆（TB级）应用</td><td>ZGC / Shenandoah</td><td>支持TB级堆，全堆并发，延迟&lt;1ms</td></tr><tr><td>性能测试</td><td>Epsilon GC</td><td>排除GC干扰，评估应用本身性能</td></tr></tbody></table>
<h3 data-id="heading-17"><strong>五、总结</strong></h3>
<p>JDK的垃圾回收器经历了从<strong>经典分代</strong>（Serial、Parallel、CMS、G1）到<strong>现代全堆并发</strong>（ZGC、Shenandoah）的演进，核心目标是<strong>降低延迟</strong>（STW时间）与<strong>支持大堆</strong>（TB级）。选型时需结合<strong>应用场景</strong>（延迟/吞吐量需求）、<strong>堆大小</strong>（中小堆/超大堆）和<strong>JDK版本</strong>（如JDK 21+默认ZGC），选择最适合的收集器。</p>
<p>如需进一步优化，可通过<strong>JVM参数</strong>（如<code>-XX:MaxGCPauseMillis</code>、<code>-XX:G1HeapRegionSize</code>、<code>-XX:ZUncommitDelay</code>）调整收集器行为，或使用<strong>监控工具</strong>（如VisualVM、GCEasy）分析GC日志，定位性能瓶颈。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ从实战到源码：SpringBoot整合RocketMQ]]></title>    <link>https://juejin.cn/post/7600060691350470698</link>    <guid>https://juejin.cn/post/7600060691350470698</guid>    <pubDate>2026-01-28T14:18:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600060691350470698" data-draft-id="7600240045366591542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ从实战到源码：SpringBoot整合RocketMQ"/> <meta itemprop="keywords" content="后端,RocketMQ"/> <meta itemprop="datePublished" content="2026-01-28T14:18:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怒放吧德德"/> <meta itemprop="url" content="https://juejin.cn/user/2502950820787672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ从实战到源码：SpringBoot整合RocketMQ
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2502950820787672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怒放吧德德
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T14:18:42.000Z" title="Wed Jan 28 2026 14:18:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RocketMQ从实战到源码：SpringBoot整合RocketMQ</h2>
<blockquote>
<p>😄生命不息，写作不止</p>
<p>🔥 继续踏上学习之路，学之分享笔记</p>
<p>👊 总有一天我也能像各位大佬一样</p>
<p>🏆 <a href="https://juejin.cn/user/2502950820787672" target="_blank" title="https://juejin.cn/user/2502950820787672">博客首页</a>   <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flyd-code%2F" target="_blank" title="https://www.cnblogs.com/lyd-code/" ref="nofollow noopener noreferrer">@怒放吧德德</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Flydandtry.github.io%2F" target="_blank" title="https://lydandtry.github.io/" ref="nofollow noopener noreferrer">To记录领地</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43843951%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/qq_43843951?type=blog" ref="nofollow noopener noreferrer">@一个有梦有戏的人</a></p>
<p>🌝分享学习心得，欢迎指正，大家一起学习成长！</p>
</blockquote>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德(掘金) @一个有梦有戏的人(CSDN)</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c33ed4ee428469db4621f0d3f673b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770214722&amp;x-signature=GbDQMs9j51WT9%2BOtBqvLxwFWMVI%3D" alt="rocketmq封面.png" loading="lazy"/></p>
<h3 data-id="heading-1">前言</h3>
<p>在微服务架构中，消息中间件是实现服务解耦、削峰填谷、异步通信的核心组件，而 RocketMQ 作为阿里开源的高性能、高可靠分布式消息中间件，凭借高吞吐量、低延迟、强一致性等特性，广泛应用于各类分布式系统。SpringBoot 则以“约定大于配置”的理念，极大简化了第三方组件的整合成本。本文将从实操角度出发，详细讲解 RocketMQ 与 SpringBoot 的完整整合流程，包含环境准备、依赖配置、生产者/消费者实现、测试验证，以及常见问题排查，适合新手快速上手，也可作为开发参考手册。</p>
<h3 data-id="heading-2">1 整合 SpringBoot</h3>
<h4 data-id="heading-3">1.1 环境</h4>
<p>rocketmq: 2.2.3 RocketMQ 与 SpringBoot 的整合依赖官方提供的 starter 组件，版本适配至关重要，否则会出现自动配置失效、Bean 注入失败等问题。本文选用业内稳定兼容版本组合（新手直接照搬即可），版本对应关系参考 Apache RocketMQ 官方兼容性矩阵：</p>
<ul>
<li>JDK：17（需要 1.8+，RocketMQ 对 JDK 11+ 兼容性一般，生产环境优先选用 JDK 8，避免踩坑）</li>
<li>SpringBoot：2.7.x（稳定版，避免使用 3.x 版本，与 RocketMQ starter 存在兼容断点）</li>
<li>RocketMQ：4.9.7（稳定版，社区长期维护，适配 SpringBoot 2.7.x）</li>
<li>RocketMQ SpringBoot Starter：2.2.3（如果使用 2.3 的版本，jdk 需要 17，并且 springboot 需要 3.0 以上）</li>
<li>Maven：3.6+（项目构建工具）</li>
</ul>
<h4 data-id="heading-4">1.2 引入依赖</h4>
<p>创建 SpringBoot 项目，引入 RocketMQ 整合依赖，核心是 RocketMQ 官方提供的 spring-boot-starter，无需手动引入原生 RocketMQ 客户端依赖，starter 会自动完成依赖管理和自动配置。</p>
<pre><code class="hljs language-java" lang="java">&lt;!-- RocketMQ 依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;
    &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;<span class="hljs-number">2.2</span><span class="hljs-number">.3</span>&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h4 data-id="heading-5">1.3 配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># rocketmq 配置项，对应 RocketMQProperties 配置类</span>
<span class="hljs-attr">rocketmq:</span>
  <span class="hljs-attr">name-server:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.109</span><span class="hljs-number">.134</span><span class="hljs-string">:9876</span> <span class="hljs-comment"># RocketMQ Namesrv</span>
  <span class="hljs-comment"># Producer 配置项 （只有配置了生产者，才会初始化RocketMQTemplate）</span>
  <span class="hljs-attr">producer:</span>
    <span class="hljs-attr">group:</span> <span class="hljs-string">demo-spring-group</span> <span class="hljs-comment"># 生产者分组(自定义)</span>
    <span class="hljs-attr">send-message-timeout:</span> <span class="hljs-number">3000</span> <span class="hljs-comment"># 发送消息超时时间，单位：毫秒。默认为 3000 。</span>
    <span class="hljs-attr">compress-message-body-threshold:</span> <span class="hljs-number">4096</span> <span class="hljs-comment"># 消息压缩阀值，当消息体的大小超过该阀值后，进行消息压缩。默认为 4 * 1024B</span>
    <span class="hljs-attr">max-message-size:</span> <span class="hljs-number">4194304</span> <span class="hljs-comment"># 消息体的最大允许大小。。默认为 4 * 1024 * 1024B</span>
    <span class="hljs-attr">retry-times-when-send-failed:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 同步发送消息时，失败重试次数。默认为 2 次。</span>
    <span class="hljs-attr">retry-times-when-send-async-failed:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 异步发送消息时，失败重试次数。默认为 2 次。</span>
    <span class="hljs-attr">retry-next-server:</span> <span class="hljs-literal">false</span> <span class="hljs-comment"># 发送消息给 Broker 时，如果发送失败，是否重试另外一台 Broker 。默认为 false</span>
    <span class="hljs-attr">access-key:</span> <span class="hljs-comment"># Access Key ，可阅读 https://github.com/apache/rocketmq/blob/master/docs/cn/acl/user_guide.md 文档</span>
    <span class="hljs-attr">secret-key:</span> <span class="hljs-comment"># Secret Key</span>
    <span class="hljs-attr">enable-msg-trace:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 是否开启消息轨迹功能。默认为 true 开启。可阅读 https://github.com/apache/rocketmq/blob/master/docs/cn/msg_trace/user_guide.md 文档</span>
    <span class="hljs-attr">customized-trace-topic:</span> <span class="hljs-string">RMQ_SYS_TRACE_TOPIC</span> <span class="hljs-comment"># 自定义消息轨迹的 Topic 。默认为 RMQ_SYS_TRACE_TOPIC 。</span>
  <span class="hljs-comment"># Consumer 配置项 (可以不在这里配置，不在这里配置需要在注解中配置)</span>

</code></pre>
<p>启动类不需要配置，就跟使用 redis 一样。</p>
<h4 data-id="heading-6">1.4 代码</h4>
<p>简单进行操作，做个简单的消费者和生产者进行测试。</p>
<p>构建一个消息类，实际开发中常发送对象消息（如订单信息、用户信息），需创建实体类并实现 Serializable 接口（避免序列化失败）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Demo01Message</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SPRING-DEMO-01"</span>;
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Demo01Message{"</span> +
        <span class="hljs-string">"id="</span> + id +
        <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<p>生产者代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;

    <span class="hljs-comment">/**
     * 同步
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> SendResult <span class="hljs-title function_">syncSend</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        <span class="hljs-comment">// 同步发送消息</span>
        <span class="hljs-keyword">return</span> rocketMQTemplate.syncSend(Demo01Message.TOPIC, message);
    }

    <span class="hljs-comment">/**
     * 异步
     * <span class="hljs-doctag">@param</span> id
     * <span class="hljs-doctag">@param</span> callback 回调
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncSend</span><span class="hljs-params">(Integer id, SendCallback callback)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        rocketMQTemplate.asyncSend(Demo01Message.TOPIC, message, callback);
    }

    <span class="hljs-comment">/**
     * 单向发送
     * <span class="hljs-doctag">@param</span> id
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onewaySend</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-comment">// 创建 Demo01Message 消息</span>
        <span class="hljs-type">Demo01Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Demo01Message</span>();
        message.setId(id);
        rocketMQTemplate.sendOneWay(Demo01Message.TOPIC, message);
    }

}
</code></pre>
<p>通过使用 <code>RocketMQTemplate</code>进行发送消息，以上案例测试了 3 种消息发送方式（同步、异步、单向）。</p>
<p>消费者代码</p>
<p>:::info
SpringBoot 整合 RocketMQ 后，消费者无需手动启动监听，只需创建一个监听类，实现 RocketMQListener 接口，并用 @RocketMQMessageListener 注解指定订阅的主题和消费者组，Spring 会自动扫描并启动监听。</p>
<p>:::</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(topic = Demo01Message.TOPIC,
        consumerGroup = "GROUP-" + Demo01Message.TOPIC)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsumerDemo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;Demo01Message&gt; {
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        log.info(<span class="hljs-string">"消费者监听已启动..."</span>);
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Demo01Message messageExt)</span> {
        log.info(<span class="hljs-string">"[消费者][线程号:{} 监听到消息：{}]"</span>, Thread.currentThread().getId(), messageExt);
    }
}
</code></pre>
<blockquote>
<p>注：这个 onMessage 的类型 Demo01Message 可以放原来的类 MessageExt</p>
</blockquote>
<p>消费者的声明的所有属性通过@RocketMQMessageListener注解声明，实现 RocketMQListener 接口。</p>
<p>我们构建一个测试类进行擦看测试结果</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RocketProducerTest</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Producer producer;

    <span class="hljs-comment">/**
     * 测试同步发送
     */</span>
    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSyncSend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);
        <span class="hljs-type">SendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> producer.syncSend(id);
        log.info(<span class="hljs-string">"[测试同步发送][发送编号：[{}] 发送结果：[{}]]"</span>, id, result);

        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAsyncSend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);
        producer.asyncSend(id, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult sendResult)</span> {
                log.info(<span class="hljs-string">"[测试异步发送][发送编号：[{}] 发送成功，结果为：[{}]]"</span>, id, sendResult);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable throwable)</span> {
                log.info(<span class="hljs-string">"[testASyncSend][发送编号：[{}] 发送异常]]"</span>, id, throwable);
            }
        });


        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOnewaySend</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (System.currentTimeMillis() / <span class="hljs-number">1000</span>);

        producer.onewaySend(id);
        log.info(<span class="hljs-string">"[测试异步发送][发送编号：[{}] 发送成功, 不关心是否被消费！"</span>, id);
        <span class="hljs-comment">// 阻塞等待，保证消费</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>).await();
    }

}
</code></pre>
<p>运行结果</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3dd8b8eab8b4270bcaee5d0eb36d0e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770214722&amp;x-signature=PSumvrNM84PaFXFGvRDE7kGcMIk%3D" alt="" loading="lazy"/></p>
<p>更多案例查看 gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fliyongde%2Fjava-trial%2Ftree%2Fmaster%2FTrial1-RocketMQ%2FTrial1-RocketMQ-Demo1" target="_blank" title="https://gitee.com/liyongde/java-trial/tree/master/Trial1-RocketMQ/Trial1-RocketMQ-Demo1" ref="nofollow noopener noreferrer">rocketmq-demo</a></p>
<h3 data-id="heading-7">2 相关配置</h3>
<p>结合前文配置文件，补充 RocketMQ 与 SpringBoot 整合的核心配置说明（对应 application.yml），帮助大家根据业务场景灵活调整，避免盲目配置：</p>















































<table><thead><tr><th><strong>配置项</strong></th><th><strong>含义</strong></th><th><strong>默认值</strong></th><th><strong>使用场景</strong></th></tr></thead><tbody><tr><td>rocketmq.name-server</td><td>NameServer 地址，生产者/消费者通过该地址找到 Broker</td><td>无（必配）</td><td>单机/集群部署均需配置，集群用分号分隔多个地址</td></tr><tr><td>rocketmq.producer.group</td><td>生产者组名称，同类生产者归为一组</td><td>无（必配）</td><td>用于容错和负载均衡，不可与消费者组重名</td></tr><tr><td>rocketmq.consumer.group</td><td>消费者组名称，同类消费者归为一组</td><td>无（必配）</td><td>集群模式下分摊消费，广播模式下仅用于标识</td></tr><tr><td>rocketmq.consumer.message-model</td><td>消费模式，CLUSTERING（集群）/BROADCASTING（广播）</td><td>CLUSTERING</td><td>集群模式：一条消息仅被组内一个消费者消费；广播模式：组内所有消费者都能收到</td></tr><tr><td>rocketmq.producer.retry-times-when-send-failed</td><td>同步发送失败重试次数（不含第一次发送）</td><td>2</td><td>网络波动、Broker 繁忙时，提高消息发送成功率</td></tr><tr><td>rocketmq.consumer.consume-message-batch-max-size</td><td>每次批量消费的消息数量</td><td>1</td><td>消息量大时，调大该值提高消费效率（不宜过大，避免内存溢出）</td></tr></tbody></table>
<h3 data-id="heading-8">3 常见问题与注意事项（避坑重点）</h3>
<p>整合过程中，新手容易遇到各类问题，以下是高频问题及解决方案，结合参考资料中的兼容问题和实操踩坑经验整理：</p>
<h4 data-id="heading-9">3.1 常见问题及解决方案</h4>
<ul>
<li>问题1：项目启动失败，提示“Could not autowire. No beans of 'RocketMQTemplate' type found” 解决方案：检查 RocketMQ starter 依赖是否引入，版本是否与 SpringBoot 适配（SpringBoot 2.7.x 对应 starter 2.2.3+）；检查配置文件中 rocketmq.name-server 是否配置正确。</li>
<li>问题2：消息发送成功，但消费者收不到消息 解决方案：① 检查生产者和消费者的 topic 是否一致；② 检查消费者组名称是否与 application.yml 中配置的一致；③ 检查消费模式是否正确，集群模式下若多个消费者实例，消息会分摊消费，可关闭其他实例重试；④ 检查 RocketMQ 服务是否正常运行，NameServer 与 Broker 连接是否正常。</li>
<li>问题3：发送对象消息时，消费者接收失败，提示“序列化失败” 解决方案：实体类必须实现 Serializable 接口；确保生产者和消费者的实体类全路径一致（包名、类名完全相同）；避免实体类中存在不可序列化的字段（如 transient 修饰的字段）。</li>
<li>问题4：项目启动失败，提示“ApplicationContext 初始化失败” 解决方案：大概率是版本不兼容，SpringBoot 2.7.x 不可使用低于 2.2.3 版本的 RocketMQ starter；避免混合使用不同版本的 Spring 相关依赖。</li>
<li>问题5：消息消费失败，无法触发重试 解决方案：消费方法中若出现异常，需手动抛出 RuntimeException（不可捕获后不抛出），Spring 会感知异常并触发重试；检查重试次数配置（默认16次），重试达到上限后消息会进入死信队列。</li>
</ul>
<h4 data-id="heading-10">3.2 注意事项</h4>
<ul>
<li>版本适配是关键：严格按照本文推荐的版本组合配置，避免因版本不兼容导致各类异常，具体可参考 Apache RocketMQ 官方兼容性矩阵。</li>
<li>组名称规范：生产者组和消费者组不可重名，同一业务场景的生产者/消费者归为同一组，不同业务场景使用不同的组名称。</li>
<li>生产环境配置：生产环境中，需关闭 Broker 的 autoCreateTopicEnable 配置，提前手动创建主题和队列；消息发送失败需做降级处理（如存入数据库，后续补偿发送），避免消息丢失。</li>
<li>消息重试与死信队列：消费失败会触发重试，重试达到上限后消息进入死信队列（DLQ），需手动处理死信队列中的消息，避免数据丢失。</li>
<li>配置文件规范：尽量避免硬编码，消费者组、主题等可通过配置文件读取，方便后续环境切换（开发/测试/生产）。</li>
</ul>
<blockquote>
<p>整合 springboot 是很简单的，使用方法跟 redis 类似，主要是需要了解在什么场景用什么消息发送机制，以及消息发送机制可能会影响的效率。</p>
</blockquote>
<h3 data-id="heading-11">4 总结</h3>
<p>本文详细讲解了 RocketMQ 与 SpringBoot 的完整整合流程，从环境准备、依赖配置、生产者/消费者实现，到测试验证和避坑指南，全程贴合开发实际场景，突出实操性。核心亮点是利用 SpringBoot 的自动配置特性，通过 RocketMQTemplate 和 @RocketMQMessageListener 注解，摒弃了原生 API 繁琐的实例创建和配置，让开发者能够快速实现消息的发送与接收。</p>
<p>整合的核心要点的是“版本适配”和“配置规范”，只要严格遵循本文的版本组合和配置要求，就能顺利完成整合。后续可基于本文的基础，扩展 RocketMQ 的高级功能，如事务消息、延迟消息、消息过滤等，适配更复杂的业务场景（如分布式事务、定时任务通知等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（70）如何在多数据库环境中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600234310965198886</link>    <guid>https://juejin.cn/post/7600234310965198886</guid>    <pubDate>2026-01-28T11:43:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600234310965198886" data-draft-id="7600245693997137930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（70）如何在多数据库环境中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T11:43:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（70）如何在多数据库环境中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T11:43:43.000Z" title="Wed Jan 28 2026 11:43:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在多数据库环境中使用Hibernate，需要配置多个数据源（DataSource）和多个实体管理器（EntityManager）。通常情况下，你可能需要在Spring Boot项目中使用Hibernate来连接多个数据库。下面是详细步骤和代码示例，展示如何在Spring Boot项目中配置和使用多个数据库。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置多个数据源</h3>
<p>需要在<code>application.properties</code>或<code>application.yml</code>文件中配置多个数据源。</p>
<h4 data-id="heading-2"><code>application.properties</code></h4>
<pre><code class="hljs language-properties" lang="properties"># Primary DataSource
spring.datasource.primary.url=jdbc:mysql://localhost:3306/primarydb
spring.datasource.primary.username=root
spring.datasource.primary.password=rootpassword
spring.datasource.primary.driver-class-name=com.mysql.cj.jdbc.Driver

# Secondary DataSource
spring.datasource.secondary.url=jdbc:mysql://localhost:3306/secondarydb
spring.datasource.secondary.username=root
spring.datasource.secondary.password=rootpassword
spring.datasource.secondary.driver-class-name=com.mysql.cj.jdbc.Driver

# Hibernate properties
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
</code></pre>
<h3 data-id="heading-3">3. 配置多数据源与实体管理器</h3>
<p>需要创建配置类来配置多个数据源与对应的实体管理器。</p>
<h4 data-id="heading-4"><code>PrimaryDataSourceConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
<span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = "com.example.primary",
        entityManagerFactoryRef = "primaryEntityManagerFactory",
        transactionManagerRef = "primaryTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "primaryDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.primary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">primaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean(name = "primaryEntityManagerFactory")</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">primaryEntityManagerFactory</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("primaryDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setDataSource(dataSource);
        em.setPackagesToScan(<span class="hljs-string">"com.example.primary"</span>);
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean(name = "primaryTransactionManager")</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">primaryTransactionManager</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("primaryEntityManagerFactory")</span> EntityManagerFactory entityManagerFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h4 data-id="heading-5"><code>SecondaryDataSourceConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.boot.jdbc.DataSourceBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.config.EnableJpaRepositories;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;
<span class="hljs-keyword">import</span> org.springframework.transaction.PlatformTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-meta">@EnableJpaRepositories(
        basePackages = "com.example.secondary",
        entityManagerFactoryRef = "secondaryEntityManagerFactory",
        transactionManagerRef = "secondaryTransactionManager"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecondaryDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "secondaryDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.secondary")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">secondaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().build();
    }

    <span class="hljs-meta">@Bean(name = "secondaryEntityManagerFactory")</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">secondaryEntityManagerFactory</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("secondaryDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setDataSource(dataSource);
        em.setPackagesToScan(<span class="hljs-string">"com.example.secondary"</span>);
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean(name = "secondaryTransactionManager")</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">secondaryTransactionManager</span><span class="hljs-params">(
            <span class="hljs-meta">@Qualifier("secondaryEntityManagerFactory")</span> EntityManagerFactory entityManagerFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(entityManagerFactory);
    }
}
</code></pre>
<h3 data-id="heading-6">4. 定义实体类和DAO层</h3>
<p>根据不同的数据源，将实体类和DAO层放在不同的包中。</p>
<h4 data-id="heading-7">主数据源实体类和DAO层</h4>
<h5 data-id="heading-8"><code>com.example.primary.entity.User.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.entity;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h5 data-id="heading-9"><code>com.example.primary.repository.UserRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.repository;

<span class="hljs-keyword">import</span> com.example.primary.entity.User;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h4 data-id="heading-10">次数据源实体类和DAO层</h4>
<h5 data-id="heading-11"><code>com.example.secondary.entity.Order.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.entity;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String orderNumber;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getOrderNumber</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderNumber;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderNumber</span><span class="hljs-params">(String orderNumber)</span> {
        <span class="hljs-built_in">this</span>.orderNumber = orderNumber;
    }
}
</code></pre>
<h5 data-id="heading-12"><code>com.example.secondary.repository.OrderRepository.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.repository;

<span class="hljs-keyword">import</span> com.example.secondary.entity.Order;
<span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Order, Long&gt; {
    Order <span class="hljs-title function_">findByOrderNumber</span><span class="hljs-params">(String orderNumber)</span>;
}
</code></pre>
<h3 data-id="heading-13">5. 创建服务层</h3>
<h4 data-id="heading-14">主数据源服务层</h4>
<h5 data-id="heading-15"><code>com.example.primary.service.UserService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.primary.service;

<span class="hljs-keyword">import</span> com.example.primary.entity.User;
<span class="hljs-keyword">import</span> com.example.primary.repository.UserRepository;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h4 data-id="heading-16">次数据源服务层</h4>
<h5 data-id="heading-17"><code>com.example.secondary.service.OrderService.java</code></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.secondary.service;

<span class="hljs-keyword">import</span> com.example.secondary.entity.Order;
<span class="hljs-keyword">import</span> com.example.secondary.repository.OrderRepository;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderRepository orderRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(OrderRepository orderRepository)</span> {
        <span class="hljs-built_in">this</span>.orderRepository = orderRepository;
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> orderRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">getAllOrders</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderRepository.findAll();
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">updateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteOrder</span><span class="hljs-params">(Long id)</span> {
        orderRepository.deleteById(id);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”]]></title>    <link>https://juejin.cn/post/7600248718361083946</link>    <guid>https://juejin.cn/post/7600248718361083946</guid>    <pubDate>2026-01-28T15:57:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600248718361083946" data-draft-id="7600223321041862662" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”"/> <meta itemprop="keywords" content="前端,JavaScript,设计模式"/> <meta itemprop="datePublished" content="2026-01-28T15:57:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vilan_微澜"/> <meta itemprop="url" content="https://juejin.cn/user/2225067267199320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥别再用递归了！WeakMap 的影子索引“让树不再是树！”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067267199320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vilan_微澜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T15:57:10.000Z" title="Wed Jan 28 2026 15:57:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">一、前言</h2>
<p>大家好，我是微澜。今天来分享一个基于 <strong>WeakMap</strong> 实现的<strong>快速对树形结构数据进行增删改查操作</strong>的<code>useTree hook</code>函数，它是基于<code>JavaScript</code> 的 <code>WeakMap</code> 特性，在不改动原始数据的前提下，实现了一套 <strong>O(1)</strong> 查找的<strong>影子索引结构</strong>，这个<strong>影子</strong>其实就是对象的<strong>引用地址</strong>，让树形数据操作像操作数组一样简单！</p>
<h2 data-id="heading-1">二、为什么选择 WeakMap？</h2>
<h3 data-id="heading-2">1. 非侵入性 (Non-invasive)</h3>
<p>通过 <code>WeakMap</code> 在内存中构建了一套 <code>Node -&gt; Parent</code> 的映射。原始数据对象保持纯净，没有任何多余属性，完美支持序列化。</p>
<h3 data-id="heading-3">2. 内存安全 (Memory Safety)</h3>
<p>这是最关键的一点。<code>WeakMap</code> 对键（对象）是<strong>弱引用</strong>的。</p>
<ul>
<li>
<p>如果你删除了原始树中的某个节点，且没有其他地方引用它，垃圾回收器（GC）会自动清理索引表中的对应项。</p>
</li>
<li>
<p>这种特性非常适合处理大型动态树，完全不用担心手动维护索引带来的内存泄漏。</p>
</li>
</ul>
<h3 data-id="heading-4">3、不同实现方案对比</h3>
<p>在开始之前，我们先看看为什么选择 <strong>WeakMap</strong>。我们可以通过一个综合对比来看看<strong>操作树形数据</strong>不同方案的差异：</p>






















































<table><thead><tr><th align="left"><strong>维度 / 方案</strong></th><th align="left"><strong>传统递归遍历</strong></th><th align="left"><strong>节点注入 parent</strong></th><th align="left"><strong>Map 缓存方案</strong></th><th align="left"><strong>WeakMap 优化方案 (本项目)</strong></th></tr></thead><tbody><tr><td align="left"><strong>初始化复杂度</strong></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> (双层循环)</td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span> (单次递归)</strong></td></tr><tr><td align="left"><strong>溯源时间复杂度</strong></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span></span></td><td align="left"><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>D</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(D)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mclose">)</span></span></span></span></span> (D为深度，极快)</strong></td></tr><tr><td align="left"><strong>数据污染</strong></td><td align="left">无</td><td align="left">高（直接修改对象）</td><td align="left">无</td><td align="left"><strong>无（外部映射，保持纯净）</strong></td></tr><tr><td align="left"><strong>内存管理</strong></td><td align="left">差</td><td align="left">一般</td><td align="left">一般 (强引用，需手动清理)</td><td align="left"><strong>优秀（弱引用自动 GC）</strong></td></tr><tr><td align="left"><strong>序列化友好度</strong></td><td align="left">友好</td><td align="left">极差（循环引用）</td><td align="left">友好</td><td align="left"><strong>友好</strong></td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">极小数据量</td><td align="left">中等数据量</td><td align="left">中等数据量</td><td align="left"><strong>大规模数据、高频转换</strong></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">三、核心实现原理</h2>
<h3 data-id="heading-6">1. 整体架构图</h3>
<p>我们通过一个外部的 <code>WeakMap</code> 来存储<strong>节点与其父级的对应关系</strong>。这种设计最大的好处是：“不改变原始树结构，不产生循环引用，且能实现 O(1) 的溯源。”</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[原始树形数据] --&gt; B{useTree Hook}
    B -- "1. 递归扫描" --&gt; C[WeakMap 存储库]

    subgraph "WeakMap 存储策略"
    C -- "Key: 根节点" --&gt; D["Value: 整个 Tree 数组 (方便删除)"]
    C -- "Key: 子节点" --&gt; E["Value: 直接父节点对象 (实现溯源)"]
    end

    F[业务请求: 查找/删除] --&gt; C
    C -- "返回父级引用" --&gt; G[完成操作]
</code></pre>
<h3 data-id="heading-7">2. 数据映射图解 (核心逻辑)</h3>
<p>为了让大家更直观地看到 <code>WeakMap</code> 里到底存了什么，我们看下面这个例子：</p>
<p><strong>示例数据：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> list = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'掘金'</span>,
    <span class="hljs-attr">children</span>: [ { <span class="hljs-attr">id</span>: <span class="hljs-number">11</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'前端组'</span> } ]
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'社区'</span>,
    <span class="hljs-attr">children</span>: []
  }
];
</code></pre>
<p><strong>WeakMap 内部映射关系：</strong></p>





























<table><thead><tr><th align="left">节点 (Key)</th><th align="left">映射值 (Value)</th><th align="left">Value类型</th><th align="left">存储逻辑说明</th></tr></thead><tbody><tr><td align="left"><code>{ id: 11, name: '前端组' }</code></td><td align="left"><code>{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }</code></td><td align="left"><strong>Object (父节点)</strong></td><td align="left"><strong>非根节点</strong>：指向它的直接父对象</td></tr><tr><td align="left"><code>{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }</code></td><td align="left"><code>[{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }, { id: 2, name: '社区', children: [] }]</code></td><td align="left"><strong>Array (根数组)</strong></td><td align="left"><strong>根节点</strong>：指向它所属的整棵树数组</td></tr><tr><td align="left"><code>{ id: 2, name: '社区', children: [] }</code></td><td align="left"><code>[{ id: 1, name: '掘金', children: [{ id: 11, name: '前端组' }] }, { id: 2, name: '社区', children: [] }]</code></td><td align="left"><strong>Array (根数组)</strong></td><td align="left"><strong>根节点</strong>：指向它所属的整棵树数组</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>核心秘诀</strong>：
以上设计了一套巧妙的判断规则：如果节点是<strong>根节点</strong>，其映射值就是<strong>数组</strong>；如果节点是<strong>子节点</strong>，其映射值就是<strong>父对象</strong>。
这样在执行 <code>removeChild</code> 时，我们只需要判断 <code>Array.isArray(parent)</code>，就能自动切换“从数组中删除”<strong>根节点</strong>或“从 <code>children</code> 属性中删除”<strong>子节点</strong>的逻辑，极其优雅！</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、useTree()实现方法逐一拆解</h2>
<p>接下来，我们看看 <code>useTree</code> 内部每个方法的具体实现原理。</p>
<h3 data-id="heading-9">1. <code>initTree</code> - 初始化索引</h3>
<p><strong>功能</strong>：递归遍历整棵树，建立 <code>WeakMap</code> 映射。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 数据索引对象</span>
<span class="hljs-keyword">const</span> _treeWeakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-title class_">TreeNode</span>, <span class="hljs-title class_">TreeNode</span> | <span class="hljs-title class_">TreeNode</span>[]&gt;();

<span class="hljs-keyword">const</span> useTree = (
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">Props</span> = {
    <span class="hljs-comment">// 外部数据对象字段映射</span>
    <span class="hljs-attr">treeNodeProp</span>: {
      <span class="hljs-attr">value</span>: <span class="hljs-string">'value'</span>,
      <span class="hljs-attr">label</span>: <span class="hljs-string">'label'</span>,
      <span class="hljs-attr">children</span>: <span class="hljs-string">'children'</span>,
    }
  }
){
    <span class="hljs-comment">// 初始化树结构索引</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list, parent</span>){...}
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 初始化树结构索引</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list: TreeNode[], parent?: TreeNode</span>) {
    list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-comment">// 根节点的父级为完整的树数据，在删除根节点时需要通过完整的数组删除</span>
      _treeWeakMap.<span class="hljs-title function_">set</span>(item, parent || list);
      <span class="hljs-keyword">if</span> (item[treeNodeProp.<span class="hljs-property">children</span>]) {
        <span class="hljs-comment">// 删除子节点只需要通过对应子节点的children数组删除</span>
        <span class="hljs-title function_">initTree</span>(item[treeNodeProp.<span class="hljs-property">children</span>], item);
      }
    });
  }
</code></pre>
<p><strong>原理</strong>：在组件挂载或数据更新时调用。通过这种“差异化映射”，我们让每个节点都拥有了一个指向其“归属集合”的指针，也就是指向了<strong>父级的引用地址</strong>。</p>
<p>以上文的表格列出的示例数据为例，调用<code>initTree</code>方法初始化后，可以得到以下对应关系：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph Keys [节点对象 - Key]
        K11("前端组 (id:11)")
        K1("掘金 (id:1)")
        K2("社区 (id:2)")
    end

    subgraph Values [映射值 - Value]
        V_Obj1["父节点对象 (id:1)"]
        V_Arr["根数据数组 [Tree]"]
    end

    K11 -- "指向直接父级" --&gt; V_Obj1
    K1 -- "指向所属根数组" --&gt; V_Arr
    K2 -- "指向所属根数组" --&gt; V_Arr

    style K11 fill:#f9f,stroke:#333
    style K1 fill:#bbf,stroke:#333
    style K2 fill:#bbf,stroke:#333
    style V_Arr fill:#dfd,stroke:#333
    style V_Obj1 fill:#fff,stroke:#333
</code></pre>
<h3 data-id="heading-10">2. <code>_setParent</code> - 节点索引设置</h3>
<p><strong>功能</strong>：建立节点与其所属容器（父节点对象或根数组）的映射关系。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 设置节点的父节点映射。为防止用户错误使用，不向外暴露，内部使用</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_setParent</span>(<span class="hljs-params">node: TreeNode, parent: TreeNode | TreeNode[]</span>) {
    _treeWeakMap.<span class="hljs-title function_">set</span>(node, parent);
  }
</code></pre>
<p><strong>原理</strong>：这是对 <code>WeakMap.set</code> 的一层简单封装。通过这种方式，我们将节点对象引用作为 <code>Key</code>，其父级引用作为 <code>Value</code> 存入索引库。通过<code>_</code>前缀标记为<strong>私有</strong>是为了防止外部直接篡改映射关系，保证索引的单一可靠性。</p>
<h3 data-id="heading-11">3. <code>getParent</code> - 获取父节点</h3>
<p><strong>功能</strong>：获取指定节点的直接父节点。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 获取节点的父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParent</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-keyword">return</span> _treeWeakMap.<span class="hljs-title function_">get</span>(node);
  }
</code></pre>
<ul>
<li><strong>原理</strong>：利用 <code>WeakMap.get</code> 直接获取。时间复杂度为 <strong>O(1)</strong>。</li>
</ul>
<h3 data-id="heading-12">4. <code>getParents</code> - 获取全路径父节点</h3>
<p><strong>功能</strong>：递归向上检索父级，获取从当前节点到根部的所有父节点数组。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 获取节点的所有父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParents</span>(<span class="hljs-params">item: TreeNode, parentList: (TreeNode | <span class="hljs-built_in">string</span>)[] = [], key?: <span class="hljs-built_in">string</span></span>): (<span class="hljs-title class_">TreeNode</span> | <span class="hljs-built_in">string</span>)[] {
    <span class="hljs-keyword">const</span> parent = _treeWeakMap.<span class="hljs-title function_">get</span>(item);
    <span class="hljs-comment">// 递归到根节点数组时停止</span>
    <span class="hljs-keyword">if</span> (parent &amp;&amp; !<span class="hljs-title function_">_isRootNode</span>(parent)) {
      parentList.<span class="hljs-title function_">push</span>(key ? parent[key] : parent);
      <span class="hljs-title function_">getParents</span>(parent, parentList, key);
    }
    <span class="hljs-keyword">return</span> parentList;
  }
  
  <span class="hljs-comment">// 判断是否根节点，下文都用这个方法判断是否根节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_isRootNode</span>(<span class="hljs-params">node: TreeNode | TreeNode[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(node);
  }
</code></pre>
<p><strong>原理</strong>：通过节点自身的引用地址在<code>WeakMap</code>中查找父级。相比于<code>DFS</code>(深度优先遍历)全树，这种<strong>垂直爬升</strong>的方式效率极高。
什么是<strong>垂直爬升</strong>？</p>
<p><strong>类似于：</strong></p>
<blockquote>
<p><code>show code is me.parent.parent.  ......</code></p>
</blockquote>
<p>就这样，连祖宗十八代都能给你扒出来！</p>
<h3 data-id="heading-13">5. <code>addChild</code> - 动态添加节点</h3>
<p><strong>功能</strong>：向指定节点添加子节点，并自动更新索引。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 添加子节点或根节点，节点不存在.children时，代表添加到根节点数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">addChild</span>(<span class="hljs-params">node: TreeNode, child: TreeNode</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(node)) {
      <span class="hljs-comment">// 根节点数组直接添加</span>
      <span class="hljs-keyword">const</span> i = node.<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">/**
       * 为新增加的子节点构建一个WeakMap索引，指向父节点
       * 注意：注册为key的引用地址是经过proxy处理后的节点
       */</span>
      node[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node[i], node);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 非根节点，添加到children数组</span>
      <span class="hljs-keyword">if</span> (!node[treeNodeProp.<span class="hljs-property">children</span>]) {
        node[treeNodeProp.<span class="hljs-property">children</span>] = [];
      }
      <span class="hljs-keyword">const</span> i = node[treeNodeProp.<span class="hljs-property">children</span>].<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">// 和上面设置根节点同理</span>
      node.<span class="hljs-property">children</span>[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node.<span class="hljs-property">children</span>[i], node);
    }
  }
</code></pre>
<p><strong>原理</strong>：在操作原始数据的同时，同步更新 <code>WeakMap</code>索引。也就是为新增的对象建立父级索引。</p>
<p><strong>注意</strong>：这里不能把新添加的<code>child</code>对象当做<code>WeakMap</code>的<code>Key</code>，因为<code>child</code>只是一个外部传入的一个<strong>临时变量</strong>，还没有和整棵树建立联系，需要在添加到树当中后，获取<strong>树当中的对象地址</strong>作为<code>Key</code>建立索引。</p>
<h3 data-id="heading-14">6. <code>removeChild</code> - 删除指定节点</h3>
<p><strong>功能</strong>：无痛删除任意节点，无需手动遍历查找。</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// 删除指定子节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeChild</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-comment">// 找到父节点，通过父节点删除</span>
    <span class="hljs-keyword">const</span> parent = <span class="hljs-title function_">getParent</span>(node);
    <span class="hljs-keyword">if</span>(!parent) {
      <span class="hljs-comment">// 没有找到父级节点，抛出错误</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到父级节点！'</span>);
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(parent)) {
      <span class="hljs-comment">// 删除根节点</span>
      <span class="hljs-keyword">const</span> index = parent.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item === node);
      <span class="hljs-keyword">if</span>(index &gt;= <span class="hljs-number">0</span>) {
        parent.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有找到要删除的根节点，抛出错误</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到要删除的根节点！'</span>);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 通过找到父级删除自己</span>
      parent.<span class="hljs-property">children</span> = parent.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item !== node);
    }
  }
</code></pre>
<p><strong>原理</strong>：这是该方案最精妙的地方！通过 <code>initTree</code> 建立的差异化映射，我们只需要简单的 <code>Array.isArray</code> 判断，就能准确找到节点所在的“容器”，实现秒删。</p>
<hr/>
<h2 data-id="heading-15">五、完整代码实现</h2>
<p>代码不多，却能<strong>快速~</strong>实现对树形数据的增删改查操作。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// useTree.ts</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
  <span class="hljs-comment">// 树形数据字段名映射类型</span>
  <span class="hljs-attr">treeNodeProp</span>: <span class="hljs-title class_">TreeNodeProp</span>
}

<span class="hljs-comment">// 树节点属性映射类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TreeNodeProp</span> = {
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">children</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 数节点</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">TreeNode</span> = <span class="hljs-built_in">any</span>

<span class="hljs-comment">/**
 * 树结构索引数据
 * key为节点本身，value为父节点或根节点数组(即整棵树)
 * 如果value为Array，代表根节点数组
 * 如果value为Object，代表子节点
 */</span>
<span class="hljs-keyword">const</span> _treeWeakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-title class_">TreeNode</span>, <span class="hljs-title class_">TreeNode</span> | <span class="hljs-title class_">TreeNode</span>[]&gt;();

<span class="hljs-comment">// 使用weakmap构建树形数据数据索引</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTree</span> = (<span class="hljs-params">
  props: Props = {
    // 外部数据对象字段映射
    treeNodeProp: {
      value: <span class="hljs-string">'value'</span>,
      label: <span class="hljs-string">'label'</span>,
      children: <span class="hljs-string">'children'</span>,
    }
  }
</span>) =&gt; {
  <span class="hljs-keyword">const</span> { treeNodeProp } = props;

  <span class="hljs-comment">// 设置节点的父节点映射。为防止用户错误使用，不向外暴露，内部使用</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_setParent</span>(<span class="hljs-params">node: TreeNode, parent: TreeNode | TreeNode[]</span>) {
    _treeWeakMap.<span class="hljs-title function_">set</span>(node, parent);
  }

  <span class="hljs-comment">// 判断是否根节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">_isRootNode</span>(<span class="hljs-params">node: TreeNode | TreeNode[]</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(node);
  }

  <span class="hljs-comment">// 初始化树结构索引</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">initTree</span>(<span class="hljs-params">list: TreeNode[], parent?: TreeNode</span>) {
    list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-comment">// 根节点的父级为完整的树数据，在删除根节点时需要通过完整的数组删除</span>
      _treeWeakMap.<span class="hljs-title function_">set</span>(item, parent || list);
      <span class="hljs-keyword">if</span> (item[treeNodeProp.<span class="hljs-property">children</span>]) {
        <span class="hljs-comment">// 删除子节点只需要通过对应子节点的children数组删除</span>
        <span class="hljs-title function_">initTree</span>(item[treeNodeProp.<span class="hljs-property">children</span>], item);
      }
    });
  }

  <span class="hljs-comment">// 添加子节点或根节点，节点不存在.children时，代表添加到根节点数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">addChild</span>(<span class="hljs-params">node: TreeNode, child: TreeNode</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(node)) {
      <span class="hljs-comment">// 根节点数组直接添加</span>
      <span class="hljs-keyword">const</span> i = node.<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">/**
       * 为新增加的子节点构建一个WeakMap索引，指向父节点
       * 注意：注册为key的引用地址是经过proxy处理后的节点
       */</span>
      node[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node[i], node);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 非根节点，添加到children数组</span>
      <span class="hljs-keyword">if</span> (!node[treeNodeProp.<span class="hljs-property">children</span>]) {
        node[treeNodeProp.<span class="hljs-property">children</span>] = [];
      }
      <span class="hljs-keyword">const</span> i = node[treeNodeProp.<span class="hljs-property">children</span>].<span class="hljs-title function_">push</span>(child) - <span class="hljs-number">1</span>;
      <span class="hljs-comment">// 和上面设置根节点同理</span>
      node.<span class="hljs-property">children</span>[i] &amp;&amp; <span class="hljs-title function_">_setParent</span>(node.<span class="hljs-property">children</span>[i], node);
    }
  }

  <span class="hljs-comment">// 删除指定子节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">removeChild</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-comment">// 找到父节点，通过父节点删除</span>
    <span class="hljs-keyword">const</span> parent = <span class="hljs-title function_">getParent</span>(node);
    <span class="hljs-keyword">if</span>(!parent) {
      <span class="hljs-comment">// 没有找到父级节点，抛出错误</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到父级节点！'</span>);
    }
    <span class="hljs-keyword">if</span>(<span class="hljs-title function_">_isRootNode</span>(parent)) {
      <span class="hljs-comment">// 删除根节点</span>
      <span class="hljs-keyword">const</span> index = parent.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item === node);
      <span class="hljs-keyword">if</span>(index &gt;= <span class="hljs-number">0</span>) {
        parent.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有找到要删除的根节点，抛出错误</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'没有找到要删除的根节点！'</span>);
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 通过找到父级删除自己</span>
      parent.<span class="hljs-property">children</span> = parent.<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item: TreeNode</span>) =&gt;</span> item !== node);
    }
  }

  <span class="hljs-comment">// 获取节点的父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParent</span>(<span class="hljs-params">node: TreeNode</span>) {
    <span class="hljs-keyword">return</span> _treeWeakMap.<span class="hljs-title function_">get</span>(node);
  }

  <span class="hljs-comment">// 获取节点的所有父节点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParents</span>(<span class="hljs-params">item: TreeNode, parentList: (TreeNode | <span class="hljs-built_in">string</span>)[] = [], key?: <span class="hljs-built_in">string</span></span>): (<span class="hljs-title class_">TreeNode</span> | <span class="hljs-built_in">string</span>)[] {
    <span class="hljs-keyword">const</span> parent = _treeWeakMap.<span class="hljs-title function_">get</span>(item);
    <span class="hljs-comment">// 递归到根节点数组时停止</span>
    <span class="hljs-keyword">if</span> (parent &amp;&amp; !<span class="hljs-title function_">_isRootNode</span>(parent)) {
      parentList.<span class="hljs-title function_">push</span>(key ? parent[key] : parent);
      <span class="hljs-title function_">getParents</span>(parent, parentList, key);
    }
    <span class="hljs-keyword">return</span> parentList;
  }

  <span class="hljs-comment">// 获取节点的所有父节点label数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParentLabels</span>(<span class="hljs-params">item: TreeNode, labelList: <span class="hljs-built_in">string</span>[] = []</span>): <span class="hljs-built_in">string</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getParents</span>(item, labelList, treeNodeProp.<span class="hljs-property">label</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[];
  }

  <span class="hljs-comment">// 获取节点的所有父节点value数组</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getParentValues</span>(<span class="hljs-params">item: TreeNode, valueList: <span class="hljs-built_in">string</span>[] = []</span>): <span class="hljs-built_in">string</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">getParents</span>(item, valueList, treeNodeProp.<span class="hljs-property">value</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[];
  }

  <span class="hljs-keyword">return</span> {
    getParents,
    getParentLabels,
    getParentValues,
    getParent,
    initTree,
    addChild,
    removeChild,
  };
};

</code></pre>
<h2 data-id="heading-16">六、总结</h2>
<p>通过 <code>WeakMap</code> 实现的 <code>useTree</code>，核心优势在于<strong>解耦</strong>。它将“业务数据”与“层级关系”分离开来，既保证了数据的纯净，又获得了极高的查找性能。</p>
<p><code>WeakMap</code> 作为一个<strong>容易被忽视</strong>的原生特性，在处理这类关联<strong>关系映射</strong>时有着天然的优势。</p>
<p>如果你也在为<strong>复杂树结构</strong>的管理发愁，不妨尝试下这种“<strong>影子索引</strong>”的思路。</p>
<p>如有不足或可优化的地方，欢迎在评论区交流讨论，如果觉得有用，点个👍也挺好的！👏</p>
<p><strong>如果你在处理大型树形表格或复杂的组织架构，这个 Hook 绝对是你的提效神器！</strong></p>
<h2 data-id="heading-17">七、预览和源码地址</h2>
<h4 data-id="heading-18">多场景演示 (Demo)</h4>
<ul>
<li>
<p><strong>项目预览总入口</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2F" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>原生 HTML 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Fhtml%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/html/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>Vue 3 + Element+ 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Fvue%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/vue/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
<li>
<p><strong>React + AntD 版本</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fjava6688.github.io%2FTree_By_WeakMap%2Freact%2Findex.html" target="_blank" title="https://java6688.github.io/Tree_By_WeakMap/react/index.html" ref="nofollow noopener noreferrer">java6688.github.io/Tree_By_Wea…</a></p>
</li>
</ul>
<h4 data-id="heading-19">项目源码地址</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjava6688%2FTree_By_WeakMap" target="_blank" title="https://github.com/java6688/Tree_By_WeakMap" ref="nofollow noopener noreferrer">github：https://github.com/java6688/Tree_By_WeakMap</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【配置化 CRUD 01】搜索重置组件：封装与复用]]></title>    <link>https://juejin.cn/post/7600560664407900223</link>    <guid>https://juejin.cn/post/7600560664407900223</guid>    <pubDate>2026-01-29T10:03:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600560664407900223" data-draft-id="7600581247020007433" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【配置化 CRUD 01】搜索重置组件：封装与复用"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2026-01-29T10:03:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大杯咖啡"/> <meta itemprop="url" content="https://juejin.cn/user/2553545740787959"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【配置化 CRUD 01】搜索重置组件：封装与复用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2553545740787959/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大杯咖啡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:03:06.000Z" title="Thu Jan 29 2026 10:03:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    30
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一：前言</h2>
<p>在后台管理系统的配置化 CRUD 开发中，搜索+重置是高频组合场景，几乎所有列表页都需要通过搜索筛选数据、通过重置恢复初始查询状态等等...。基于此，本文将详细讲解「搜索重置组件」的封装思路及使用方法，该组件基于Vue3 +  Element Plus 开发，支持<strong>配置化扩展、响应式联动</strong>，可直接集成到<strong>配置化 CRUD 体系</strong>中，提升开发效率与代码一致性。</p>
<h2 data-id="heading-1">二：解决问题</h2>
<p>封装搜索重置组件主要为了解决以下几个问题：</p>
<p>1.代码冗余 ： 每个列表页都要重复编写表单结构、搜索按钮、重置按钮，以及对应的点击事件、数据校验逻辑；</p>
<p>2.风格不统一：不同开发人员编写的搜索表单，在布局、按钮尺寸、标签宽度、间距等细节上可能存在差异；</p>
<p>3.维护成本高：当需要修改搜索表单的布局、按钮样式，需要逐个页面排查修改；</p>
<p>...</p>
<h2 data-id="heading-2">三：具体实现</h2>
<p>在开始之前，请先阅读一下本专栏的第一篇文章，<strong>动态表单</strong>的实现是搜索重置组件的基础：</p>
<p><a href="https://juejin.cn/post/7579460553614819379" target="_blank" title="https://juejin.cn/post/7579460553614819379">juejin.cn/post/757946…</a> ；</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdf2470950bb4ea5b1edfcaf071b3d24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5p2v5ZKW5ZWh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288618&amp;x-signature=KKU2NR9ZuAAOeEbo2dcs6BBylac%3D" alt="image.png" loading="lazy"/></p>
<p>接下来我们可以思考一下一个通用的搜索重置组件具备的<strong>基本功能</strong>：</p>
<p>1.搜索项的展示</p>
<p>2.搜索项默认展示搜索初始值</p>
<p>3.搜素与重置按钮功能</p>
<p>...</p>
<p><strong>扩展功能：</strong></p>
<p>1.搜索表单项的联动</p>
<p>2.搜索表单项的校验</p>
<p>...</p>
<p>接下来我们一步一步来实现：</p>
<h3 data-id="heading-3">3.1 基础功能实现</h3>
<p>先完成最简单的部分 ： 展示搜索项和搜索重置按钮、以及基本样式统一处理</p>
<p>组件基础实现：</p>
<pre><code class="hljs language-vue" lang="vue">
type SearchPrams = {
  schema?: FormOptions[] // 配置表
  search?: () =&gt; void  // 搜索回调
  reset?: () =&gt; void   // 重置回调
  labelWidth?: string,
  flex?: number
}
const props = withDefaults(defineProps&lt;SearchPrams&gt;(), {
  schema: {},
  labelWidth:'140px',
  flex:5
})

const codeFormRef = ref(null)

//搜索
const search = async () =&gt; {
  const data = await codeFormRef?.value?.getData()
  emits('search', data)
}

//重置
const reset = () =&gt; {
  codeFormRef?.value?.resetFields('')
  emits('reset', {})
}

 &lt;div class="sea-box"&gt;
    &lt;CodeForm
      class="form-box"
      :style="{ flex: props?.flex || 5 }"
      layoutType="cell"
      ref="codeFormRef"
      :schema="schema"
      :labelWidth="props.labelWidth"
    &gt;
    &lt;/CodeForm&gt;
    &lt;div class="sea-btn-box"&gt;
      &lt;div&gt;
        &lt;ElButton
          type="primary"
          :style="{ width: '80px' }"
          @click="search"
          &gt;{{ $t('Search') }}&lt;/ElButton
        &gt;
        &lt;ElButton
          :style="{ width: '80px', marginLeft: '15px' }"
          @click="reset"
          &gt;{{ $t('Reset') }}&lt;/ElButton
        &gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  
 &lt;style scoped&gt;
    .sea-btn-box {
      flex: 1;
      display: flex;
      justify-content: flex-end;
    }
    .form-box {
      flex: 5;
    }
    .sea-box {
      display: flex;
      padding: 20px;
      padding-bottom: 0;
      padding-top: 0;
    }
&lt;/style&gt;

</code></pre>
<p>外部定义配置表：</p>
<pre><code class="hljs language-yaml" lang="yaml">  <span class="hljs-string">const</span> <span class="hljs-string">searchColumn</span> <span class="hljs-string">=</span> [
      {
        <span class="hljs-attr">label:</span> <span class="hljs-string">'姓名'</span>,
        <span class="hljs-attr">prop:</span> <span class="hljs-string">'name'</span>,
        <span class="hljs-attr">component:</span> <span class="hljs-string">'Input'</span>,
      },
      {
        <span class="hljs-attr">label:</span> <span class="hljs-string">'年龄'</span>,
        <span class="hljs-attr">prop:</span> <span class="hljs-string">'age'</span>,
        <span class="hljs-attr">component:</span> <span class="hljs-string">'Input'</span>,
      },
      {
        <span class="hljs-attr">label:</span> <span class="hljs-string">'上学阶段'</span>,
        <span class="hljs-attr">prop:</span> <span class="hljs-string">'jieduan'</span>,
        <span class="hljs-attr">component:</span> <span class="hljs-string">'Select'</span>,
        <span class="hljs-attr">componentProps:</span> {
            <span class="hljs-attr">options:</span> [
              {
                <span class="hljs-attr">label:</span> <span class="hljs-string">'幼儿园'</span>,
                <span class="hljs-attr">value:</span> <span class="hljs-number">1</span>
              },
              {
                <span class="hljs-attr">label:</span> <span class="hljs-string">'其他阶段'</span>,
                <span class="hljs-attr">value:</span> <span class="hljs-number">2</span>
              }
            ]
          }
      },
]
</code></pre>
<p>引入组件使用：</p>
<pre><code class="hljs language-ini" lang="ini"> &lt;Search
    :<span class="hljs-attr">schema</span>=<span class="hljs-string">"allshema.searchcolumns"</span>
    @<span class="hljs-attr">search</span>=<span class="hljs-string">"(params) =&gt; console.log('点击查询:',{params})"</span>
    @<span class="hljs-attr">reset</span>=<span class="hljs-string">"() =&gt; setSearchParams({}, true, true)"</span>
   &gt;
&lt;/Search&gt;

</code></pre>
<p>运行截图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f96da8cf59134f5a9c1949dd7572d1e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5p2v5ZKW5ZWh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288618&amp;x-signature=Br6cmZ7DfiyU4eHytlqTk798QhU%3D" alt="image.png" loading="lazy"/></p>
<p>到这一步我们就已经实现了基本功能：<strong>展示表单、统一风格、查询重置</strong>。</p>
<p>当然我们可能会想要某些表单项具有初始值，或者不展示重置按钮，只要组件内部稍加改造一下就行：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">type</span> <span class="hljs-title class_">SearchPrams</span> = {
  showSearch?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 展示搜索按钮</span>
  showReset?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 展示重置按钮</span>
  schema?: <span class="hljs-built_in">any</span> <span class="hljs-comment">// 配置表</span>
  search?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">any</span>
  reset?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">any</span>
  labelWidth?: <span class="hljs-built_in">string</span>,
  flex?: <span class="hljs-built_in">number</span>
}

 &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"sea-btn-box"</span>&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ElButton</span>
          <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showSearch"</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
          <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ width: '80px' }"</span>
          @<span class="hljs-attr">click</span>=<span class="hljs-string">"search"</span>
          &gt;</span>{{ $t('Search') }}&lt;/ElButton
        &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">ElButton</span>
          <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showReset"</span>
          <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ width: '80px', marginLeft: '15px' }"</span>
          @<span class="hljs-attr">click</span>=<span class="hljs-string">"reset"</span>
          &gt;</span>{{ $t('Reset') }}&lt;/ElButton
        &gt;
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

</span></code></pre>
<p>外部引入：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">searchColumn</span> = [
      {
        label: <span class="hljs-string">'姓名'</span>,
        prop: <span class="hljs-string">'name'</span>,
        initValue: <span class="hljs-string">'初始化名字'</span>,
        component: <span class="hljs-string">'Input'</span>,
      },
      ...
  ]
  &lt;Search
     :<span class="hljs-attr">schema</span>=<span class="hljs-string">"searchColumn"</span>
     @<span class="hljs-attr">search</span>=<span class="hljs-string">"(params) =&gt; console.log('点击查询:',{params})"</span>
     :<span class="hljs-attr">showReset</span>=<span class="hljs-string">"false"</span>
    &gt;
 &lt;/Search&gt;
 
</code></pre>
<p>运行截图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16f6d66577894dd2b9c8e71d795b024d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5p2v5ZKW5ZWh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288618&amp;x-signature=lUkRk5xsqBRJxNKZkd25FNKntjg%3D" alt="image.png" loading="lazy"/></p>
<p>这样就实现了按钮的展示与隐藏以及初始化默认值。</p>
<h3 data-id="heading-4">3.2 扩展功能实现</h3>
<p>接下来我们继续实现一下扩展功能：</p>
<p><strong>1.表单项的联动</strong></p>
<p>利用动态表单组件内置的 setValues、setSchemas方法，</p>
<p>组件内部增加方法定义及暴露：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">const</span> setValues = (<span class="hljs-keyword">data</span>: any) =&gt; {
  codeFormRef?.value?.setValues(<span class="hljs-keyword">data</span>)
}

<span class="hljs-keyword">const</span> setSchemas = (<span class="hljs-keyword">data</span>: any) =&gt; {
  codeFormRef?.value?.setSchemas(<span class="hljs-keyword">data</span>)
}

defineExpose({
  getData,
  setValues,
  setSchemas
})

</code></pre>
<p>外部增加搜索组件的ref引用：</p>
<pre><code class="hljs language-ini" lang="ini">const searchRef: <span class="hljs-attr">any</span> = ref(null)

const <span class="hljs-attr">searchColumn</span> = [
  {
    label: <span class="hljs-string">'姓名'</span>,
    prop: <span class="hljs-string">'name'</span>,
    initValue: <span class="hljs-string">'初始化名字'</span>,
    component: <span class="hljs-string">'Input'</span>,
    componentProps: {
      <span class="hljs-literal">on</span>Input: (e: any) =&gt; {
         console.log(<span class="hljs-string">'姓名输入框输入事件'</span>, e)
         searchRef.value?.setSchemas([
             {
                prop: <span class="hljs-string">'age'</span>,
                path: <span class="hljs-string">'componentProps.placeholder'</span>,
                value: `请输入<span class="hljs-variable">${e}</span>的年龄`
            }
         ])
      }
    }
  },
  {
    label: <span class="hljs-string">'年龄'</span>,
    prop: <span class="hljs-string">'age'</span>,
    component: <span class="hljs-string">'Input'</span>,
  },
  ...
]

&lt;Search
   <span class="hljs-attr">ref</span>=<span class="hljs-string">"searchRef"</span>
   :<span class="hljs-attr">schema</span>=<span class="hljs-string">"allshema.searchcolumns"</span>
   @<span class="hljs-attr">search</span>=<span class="hljs-string">"setSearchParams"</span>
   @<span class="hljs-attr">reset</span>=<span class="hljs-string">"() =&gt; setSearchParams({}, true, true)"</span>
  &gt;
&lt;/Search&gt;
</code></pre>
<p>运行截图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e459d92c6f4d74b2c568adc2015dde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5p2v5ZKW5ZWh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288618&amp;x-signature=MvbiR6okgv0o5hJG1e%2FmoKDRP%2Fg%3D" alt="image.png" loading="lazy"/></p>
<p>这样就实现了搜索表单项之间的联动。</p>
<p><strong>2.表单项的校验</strong></p>
<p>组件内部改动：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">SearchPrams</span> = {
  showSearch?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 展示搜索</span>
  showReset?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 展示重置按钮</span>
  isVaildSearch?: <span class="hljs-built_in">boolean</span> <span class="hljs-comment">// 是否校验搜索</span>
  schema?: <span class="hljs-built_in">any</span> <span class="hljs-comment">// 配置表</span>
  search?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">any</span>
  reset?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">any</span>
  labelWidth?: <span class="hljs-built_in">string</span>,
  flex?: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">withDefaults</span>(defineProps&lt;<span class="hljs-title class_">SearchPrams</span>&gt;(), {
  <span class="hljs-attr">showSearch</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">showReset</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">isVaildSearch</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">schema</span>: {}, <span class="hljs-comment">// 表单配置</span>
  <span class="hljs-attr">labelWidth</span>:<span class="hljs-string">'140px'</span>,
  <span class="hljs-attr">flex</span>:<span class="hljs-number">5</span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">search</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span>(props.<span class="hljs-property">isVaildSearch</span>) {
    <span class="hljs-keyword">const</span> valid = <span class="hljs-keyword">await</span> codeFormRef?.<span class="hljs-property">value</span>?.<span class="hljs-title function_">validate</span>();
    <span class="hljs-keyword">if</span>(!valid) <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> codeFormRef?.<span class="hljs-property">value</span>?.<span class="hljs-title function_">getData</span>()
  <span class="hljs-title function_">emits</span>(<span class="hljs-string">'search'</span>, data)
}

</code></pre>
<p>外部引入使用：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">searchColumn</span> = [
    ...,
    {
       label: <span class="hljs-string">'年龄'</span>,
       prop: <span class="hljs-string">'age'</span>,
       component: <span class="hljs-string">'Input'</span>,
       formItemProps: {
         rules:[
             {
               required: <span class="hljs-literal">true</span>,
               message: <span class="hljs-string">'请输入年龄'</span>,
               trigger: <span class="hljs-string">'blur'</span>
             }
          ]
       }
    },
    ...
]

&lt;Search
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"searchRef"</span>
    :<span class="hljs-attr">schema</span>=<span class="hljs-string">"searchColumn"</span>
    @<span class="hljs-attr">search</span>=<span class="hljs-string">"(params) =&gt; console.log('点击查询:',{params})"</span>
    :<span class="hljs-attr">showReset</span>=<span class="hljs-string">"false"</span>
    :<span class="hljs-attr">isVaildSearch</span>=<span class="hljs-string">"true"</span>
   &gt;
&lt;/Search&gt;
</code></pre>
<p>运行截图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67d1e812aace4c9d915901e4ca2c441a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5p2v5ZKW5ZWh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288618&amp;x-signature=UO%2F8hIqmaWdfEyxjv2KZx5Nvb5g%3D" alt="image.png" loading="lazy"/></p>
<p>这样就实现了搜索表单项的表单校验。</p>
<p>以上就是搜索重置组件的核心实现步骤~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅谈常用的设计模式]]></title>    <link>https://juejin.cn/post/7600587732991623210</link>    <guid>https://juejin.cn/post/7600587732991623210</guid>    <pubDate>2026-01-29T10:12:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600587732991623210" data-draft-id="7600606150732120107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅谈常用的设计模式"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T10:12:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅谈常用的设计模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:12:33.000Z" title="Thu Jan 29 2026 10:12:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>######参考文章:</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fhellojava%2Fp%2F3615502.html" target="_blank" title="https://www.cnblogs.com/hellojava/p/3615502.html" ref="nofollow noopener noreferrer">单例模式 </a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fluohanguo%2Fp%2F7825656.html" target="_blank" title="https://www.cnblogs.com/luohanguo/p/7825656.html" ref="nofollow noopener noreferrer">观察者模式</a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fz4909801%2Farticle%2Fdetails%2F59059263" target="_blank" title="https://blog.csdn.net/z4909801/article/details/59059263" ref="nofollow noopener noreferrer">装饰模式</a></p>
<h3 data-id="heading-0">1.单例模式</h3>
<p>(1)：懒汉（线程不安全，在多线程中无法正常工作）</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTon</span> {
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTon</span>()</span>{}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SingleTon instance;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SingleTon <span class="hljs-title">getInstance</span>()</span>{
        <span class="hljs-keyword">if</span>(instance==<span class="hljs-literal">null</span>){
            instance=<span class="hljs-keyword">new</span> SingleTon();
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<p>(2)：懒汉（线程··安全  synchronized同步静态方法，实际锁住了class类，效率低下，无论instance有没有被实例化，每次调用该方法都要检查锁是否释放，耗费资源，所以（3）的这种双重校验锁的方式就是优化方式）</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTon</span> {
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTon</span>()</span>{}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SingleTon instance;
  <span class="hljs-comment">//synchronized给静态方法加锁，实际上锁住的是SingleTon 这个class类，意味着其他现在在执行这个</span>
<span class="hljs-comment">// getInstance()静态方法时，必须等待class类锁被释放。</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> synchronized SingleTon <span class="hljs-title">getInstance</span>()</span>{
        <span class="hljs-keyword">if</span>(instance==<span class="hljs-literal">null</span>){ 
            instance=<span class="hljs-keyword">new</span> SingleTon();
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<p>(3)：懒汉（线程··安全  synchronized同步代码块，双重校验锁，synchronized关键字内外都加了一层 if 条件判断）</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTon</span> {
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTon</span>()</span>{}
    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">volatile</span>  <span class="hljs-keyword">static</span>  SingleTon instance;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  SingleTon <span class="hljs-title">getInstance</span>()</span>{
        <span class="hljs-keyword">if</span>(instance==<span class="hljs-literal">null</span>){ 
            synchronized (SingleTon.<span class="hljs-keyword">class</span>){ <span class="hljs-comment">//和静态方法一样，也是锁住的class类</span>
                <span class="hljs-keyword">if</span>(instance==<span class="hljs-literal">null</span>){
                      <span class="hljs-comment">//1.在堆上分配内存空间存储SingleTon对象&gt;&gt;2.实例化instance引用对象&gt;&gt;3.内存空间返回的地 </span>
                    <span class="hljs-comment">//址赋 值给instance引用.</span>
                    instance=<span class="hljs-keyword">new</span> SingleTon(); <span class="hljs-comment">//volatile修饰Instance,禁止指令重排,防止报错</span>
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<p>(4).懒汉(静态内部类，这种方式的好处是即使SingleTon被装载了，instance也不会立马实例化)</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTon</span> {
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTon</span>()</span>{}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTonHolder</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SingleTon instance=<span class="hljs-keyword">new</span> SingleTon();
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  SingleTon <span class="hljs-title">getInstance</span>()</span>{
        <span class="hljs-keyword">return</span> SingleTonHolder.instance;
    }
}
</code></pre>
<p>(5).饿汉（一旦SingleTon 被装载了，instance会立马实例化）</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTon</span> {
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTon</span>()</span>{}
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SingleTon instance=<span class="hljs-keyword">new</span> SingleTon();
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span>  SingleTon <span class="hljs-title">getInstance</span>()</span>{
        <span class="hljs-keyword">return</span> instance;
    }
}
</code></pre>
<p>（6）饿汉（静态代码块）</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SingleTonSeven</span> {
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">SingleTonSeven</span>()</span> {
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SingleTonSeven singleTonSeven;
    <span class="hljs-keyword">static</span> {
        singleTonSeven=<span class="hljs-keyword">new</span> SingleTonSeven();
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span>   <span class="hljs-keyword">static</span> SingleTonSeven <span class="hljs-title">getInstance</span>()</span>{
        <span class="hljs-keyword">return</span>  singleTonSeven;
    }
}
</code></pre>
<p>（7）枚举</p>
<pre><code class="hljs language-ini" lang="ini">// 单例
public enum  SingleTonSix {
    Instance<span class="hljs-comment">;</span>
    SingleTonSix() {
        System.out.println("init")<span class="hljs-comment">;</span>
    }
    public void print(){
        System.out.println("ffffffffffff")<span class="hljs-comment">;</span>
    }
}

//测试
public static void main(String<span class="hljs-section">[]</span> args) {

      //　系统内存中该类只存在一个对象，节省了系统资源，对于一些需要频繁创建销毁的对象，使用单例模式可以提高系统能。
        SingleTonSix <span class="hljs-attr">singleTonSix1</span>=SingleTonSix.Instance<span class="hljs-comment">;</span>
        singleTonSix1.print()<span class="hljs-comment">;</span>
        SingleTonSix <span class="hljs-attr">singleTonSix2</span>=SingleTonSix.Instance<span class="hljs-comment">;</span>
        singleTonSix2.print()<span class="hljs-comment">;</span>
        SingleTonSix <span class="hljs-attr">singleTonSix3</span>=SingleTonSix.Instance<span class="hljs-comment">;</span>
        singleTonSix3.print()<span class="hljs-comment">;</span>
        SingleTonSix <span class="hljs-attr">singleTonSix4</span>=SingleTonSix.Instance<span class="hljs-comment">;</span>
        singleTonSix4.print()<span class="hljs-comment">;</span>
    }

</code></pre>
<pre><code class="hljs">执行效率上：
饿汉式没有加任何的锁，因此执行效率比较高。
懒汉式一般使用都会加同步锁，效率比饿汉式差。

性能上：
饿汉式在类加载的时候就初始化，不管你是否使用，它都实例化了，
所以会占据空间，浪费内存。
懒汉式什么时候需要什么时候实例化，相对来说不浪费内存。
</code></pre>
<h3 data-id="heading-1">2.工厂模式</h3>
<p>(1).普通工厂模式</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Sender</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">send</span>();
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MailSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Sender</span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"this is mail sender"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsSender</span> <span class="hljs-keyword">implements</span>  <span class="hljs-title class_">Sender</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"this is sms sender"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendFactoryOne</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Sender</span> <span class="hljs-title function_">produce</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> <span class="hljs-keyword">type</span></span>){
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">type</span>.<span class="hljs-title function_">equals</span>(<span class="hljs-string">"mail"</span>)){
            <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MailSender</span>();
        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">type</span>.<span class="hljs-title function_">equals</span>(<span class="hljs-string">"sms"</span>)){
            <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsSender</span>();
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
}

</code></pre>
<p>(2).工厂方法模式</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SendFactoryTwo</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span>  Sender <span class="hljs-title">produceMail</span>()</span>{
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MailSender();
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span>  Sender <span class="hljs-title">produceSms</span>()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SmsSender();
    }
}
</code></pre>
<p>(3).静态工厂方法模式</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SendFactoryThree</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Sender <span class="hljs-title">produceMail</span>()</span>{
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> MailSender();
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Sender <span class="hljs-title">produceSms</span>()</span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SmsSender();
    }
}

</code></pre>
<p>(4).抽象工程模式</p>
<h5 data-id="heading-2">注意：工程方法模式有个问题，类的创建和扩展必须修改工厂类，这违背了闭包原则，所有用到抽象工厂模式，创建多个工厂类，这样一来，直接增加工厂类就可以了，不需要修改之前的代码。</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Provider</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Sender</span> <span class="hljs-title function_">produce</span>();
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendMailFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Provider</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Sender</span> <span class="hljs-title function_">produce</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MailSender</span>();
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendSmsFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Provider</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Sender</span> <span class="hljs-title function_">produce</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsSender</span>();
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>){
        <span class="hljs-title class_">SendFactoryOne</span> sendFactoryOne=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SendFactoryOne</span>();
        sendFactoryOne.<span class="hljs-title function_">produce</span>(<span class="hljs-string">"mail"</span>);
        sendFactoryOne.<span class="hljs-title function_">produce</span>(<span class="hljs-string">"sms"</span>);

         <span class="hljs-title class_">SendFactoryTwo</span> sendFactoryTwo=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SendFactoryTwo</span>();
         sendFactoryTwo.<span class="hljs-title function_">produceMail</span>();
         sendFactoryTwo.<span class="hljs-title function_">produceSms</span>();

         <span class="hljs-title class_">SendFactoryThree</span>.<span class="hljs-title function_">produceMail</span>();
         <span class="hljs-title class_">SendFactoryThree</span>.<span class="hljs-title function_">produceSms</span>();
         
         <span class="hljs-title class_">Provider</span> provider=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SendMailFactory</span>();
         <span class="hljs-title class_">Sender</span> sender=provider.<span class="hljs-title function_">produce</span>();
         sender.<span class="hljs-title function_">send</span>();

         <span class="hljs-title class_">Provider</span> provider1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SendSmsFactory</span>();
         <span class="hljs-title class_">Sender</span> sender1=provider1.<span class="hljs-title function_">produce</span>();
         sender1.<span class="hljs-title function_">send</span>();
    }
}
</code></pre>
<h3 data-id="heading-3">3.观察者模式</h3>
<p>类似于邮件订阅，当我们浏览一些博客或者wiki时，当你订阅了改文章，如果后续有更新，会及时通知你，是一种一对多的关系。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fluohanguo%2Fp%2F7825656.html%25EF%25BC%2589" target="_blank" title="https://www.cnblogs.com/luohanguo/p/7825656.html%EF%BC%89" ref="nofollow noopener noreferrer">www.cnblogs.com/luohanguo/p…</a></p>
<p>(1) 、定义一个抽象观察者接口</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Observer</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span>()</span>;
}
</code></pre>
<p>(2)、定义一个抽象被观察者接口</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Observerable</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerObserver</span>(<span class="hljs-params">Observer observer</span>)</span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">removeObserver</span>(<span class="hljs-params">Observer observer</span>)</span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">notifyObservers</span>()</span>;
}
</code></pre>
<p>(3).定义被观察者，实现了Observerable接口，对Observerable接口的三个方法进行了具体实现，同时有一个List集合，用以保存注册的观察者，等需要通知观察者时，遍历该集合即可,通知新增一个operation()用于通知所有的观察者。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeChatServer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Observerable</span> {

   <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Observer</span>&gt;  list=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<span class="hljs-comment">//面向接口编程</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">registerObserver</span>(<span class="hljs-params">Observer observer</span>) {
        list.<span class="hljs-title function_">add</span>(observer);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">removeObserver</span>(<span class="hljs-params">Observer observer</span>) {
        <span class="hljs-keyword">if</span>(!list.<span class="hljs-title function_">isEmpty</span>()){
            list.<span class="hljs-title function_">remove</span>(observer);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">notifyObservers</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">for</span>(int i=<span class="hljs-number">0</span>;i&lt;list.<span class="hljs-title function_">size</span>();i++){
            list.<span class="hljs-title function_">get</span>(i).<span class="hljs-title function_">update</span>();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">operation</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">notifyObservers</span>();
    }
}
</code></pre>
<p>(4)、定义具体观察者，微信公众号的具体观察者为用户User1,User2</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">User1</span> <span class="hljs-title">implements</span> <span class="hljs-title">Observer</span> {
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(User1.<span class="hljs-keyword">class</span>.toString() +<span class="hljs-string">"has received the push message!"</span>);
    }
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">User2</span> <span class="hljs-title">implements</span> <span class="hljs-title">Observer</span> {
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(User2.<span class="hljs-keyword">class</span>.toString() +<span class="hljs-string">"has received the push message!"</span>);
    }
}

</code></pre>
<p>(5)、编写一个测试类</p>
<pre><code class="hljs language-ini" lang="ini">public class MainTest {
    public static void main(String<span class="hljs-section">[]</span> args){
        WeChatServer <span class="hljs-attr">server</span>=new WeChatServer()<span class="hljs-comment">;</span>
        User1 <span class="hljs-attr">user1</span>=new User1()<span class="hljs-comment">;</span>
        User2 <span class="hljs-attr">user2</span>=new User2()<span class="hljs-comment">;</span>
        server.registerObserver(user1)<span class="hljs-comment">;</span>
        server.registerObserver(user2)<span class="hljs-comment">;</span>
        server.operation()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5c3fed54aca4c4ea14b07e3d30366fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286353&amp;x-signature=1g6TEYiIln5nUveB4pkga1EiYhA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">4.装饰模式</h3>
<p>装饰模式就是给一个对象增加一些新的功能，而且是动态的，要求装饰对象和被装饰对象实现统一接口或者继承同一个父类，装饰对象持有被装饰对象的实例。</p>
<p>(1).Food类，让其他所有食物都来继承这个类</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Food</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> food_name;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Food</span><span class="hljs-params">()</span></span>{

    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Food</span><span class="hljs-params">(<span class="hljs-type">String</span> food_name)</span> </span>{
        <span class="hljs-keyword">this</span>.food_name = food_name;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">make</span><span class="hljs-params">()</span></span>{
        <span class="hljs-keyword">return</span>  food_name;
    }
}
</code></pre>
<p>(2).Bread类，Cream类，Vegetable类</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Food</span></span>{
    <span class="hljs-keyword">private</span> <span class="hljs-type">Food</span> basic_food;
    public <span class="hljs-type">Bread</span>(<span class="hljs-type">Food</span> basic_food){
          <span class="hljs-keyword">this</span>.basic_food=basic_food;
    }
    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">String</span> make() {
        <span class="hljs-keyword">return</span> basic_food.make()+<span class="hljs-string">"+面包"</span>;
    }
}

public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cream</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Food</span> </span>{
    <span class="hljs-keyword">private</span>  <span class="hljs-type">Food</span> basic_food;

    public <span class="hljs-type">Cream</span>(<span class="hljs-type">Food</span> basic_food) {
        <span class="hljs-keyword">this</span>.basic_food = basic_food;
    }

    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">String</span> make() {
        <span class="hljs-keyword">return</span> basic_food.make()+<span class="hljs-string">"+奶油"</span>;
    }
}

public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Vegetable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Food</span> </span>{
    <span class="hljs-keyword">private</span> <span class="hljs-type">Food</span> basic_food;

    public <span class="hljs-type">Vegetable</span>(<span class="hljs-type">Food</span> basic_food) {
        <span class="hljs-keyword">this</span>.basic_food = basic_food;
    }

    <span class="hljs-meta">@Override</span>
    public <span class="hljs-type">String</span> make() {
        <span class="hljs-keyword">return</span> basic_food.make()+<span class="hljs-string">"+蔬菜"</span>;
    }
}

</code></pre>
<p>(3).编写一个测试类</p>
<pre><code class="hljs language-ini" lang="ini">public class MainTest {

    public static void main(String<span class="hljs-section">[]</span> args){
        Food <span class="hljs-attr">food</span>=new Food(<span class="hljs-string">"香肠"</span>)<span class="hljs-comment">;</span>
        Bread <span class="hljs-attr">bread</span>=new Bread(food)<span class="hljs-comment">;</span>
        Cream <span class="hljs-attr">cream</span>=new Cream(bread)<span class="hljs-comment">;</span>
        Vegetable <span class="hljs-attr">vegetable</span>=new Vegetable(cream)<span class="hljs-comment">;</span>
        System.out.print("运行结果："+vegetable.make()+"\n")<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fa0f99c7b794b29ae7be10b175126ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286353&amp;x-signature=UgjTcuE4L0R415ZrsOr3G6RW8%2BQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">5.适配器模式</h3>
<h6 data-id="heading-6">(1).类适配器模式（通过继承来实现适配器功能）</h6>
<p>我们以ps2与usb的转接为例：
Ps2接口：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Ps2</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">isPs2</span>()</span>;
}
</code></pre>
<p>Usb接口:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Usb</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">isUsb</span>()</span>;
}
</code></pre>
<p>Usb接口实现类：Usber</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Usber</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Usb</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">isUsb</span>(<span class="hljs-params"/>) {

    }
}
</code></pre>
<p>适配器：AdapterOne</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdapterOne</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Usber</span> <span class="hljs-title">implements</span> <span class="hljs-title">Ps2</span></span>{
    <span class="hljs-meta">@Override</span>
    public void isPs2() {
           isUsb();
    }
}
</code></pre>
<p>测试方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>){
        <span class="hljs-comment">//1.类适配，通过继承类适配</span>
        <span class="hljs-title class_">Ps2</span> p=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AdapterOne</span>();
        p.<span class="hljs-title function_">isPs2</span>();
    }
</code></pre>
<h6 data-id="heading-7">(2).对象适配器模式（通过组合来实现适配器的功能）</h6>
<p>适配器：AdapterTwo</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdapterTwo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ps2</span>{
    <span class="hljs-keyword">private</span> Usber usber;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AdapterTwo</span><span class="hljs-params">(Usber usber)</span> {
        <span class="hljs-built_in">this</span>.usber = usber;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isPs2</span><span class="hljs-params">()</span> {
        usber.isUsb();
    }
}
</code></pre>
<p>测试方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>){
        <span class="hljs-comment">//2.对象适配，通过组合实现</span>
        <span class="hljs-title class_">Ps2</span> p=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AdapterTwo</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Usber</span>());
        p.<span class="hljs-title function_">isPs2</span>();
    }
}
</code></pre>
<h6 data-id="heading-8">注意：类适配和对象适配模式中所有的adapter均需要实现Ps2接口</h6>
<h6 data-id="heading-9">(3).接口适配器模式（通过抽象类来实现）</h6>
<p>目标接口A:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">A</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">a</span>()</span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">b</span>()</span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">c</span>()</span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">d</span>()</span>;
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">e</span>()</span>;
}
</code></pre>
<p>A的实现类：Adapter</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">Adapter</span> <span class="hljs-selector-tag">implements</span> <span class="hljs-selector-tag">A</span> {
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">a</span>() {

    }

    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">b</span>() {

    }

    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">c</span>() {

    }

    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">d</span>() {

    }

    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">e</span>() {

    }
}

</code></pre>
<p>继承自Adapter的MyAdapter：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Adapter</span> </span>{

    <span class="hljs-meta">@Override</span>
    public void a() {
        <span class="hljs-keyword">super</span>.a();
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"实现A方法"</span>);
    }

    <span class="hljs-meta">@Override</span>
    public void b() {
        <span class="hljs-keyword">super</span>.b();
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"实现B方法"</span>);
    }
}
</code></pre>
<p>测试方法：</p>
<pre><code class="hljs language-typescript" lang="typescript">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>){
        <span class="hljs-comment">//3.接口适配，通过抽象类实现</span>
        A aRealize=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAdapter</span>();
        aRealize.<span class="hljs-title function_">a</span>();
        aRealize.<span class="hljs-title function_">b</span>();

    }
</code></pre>
<h3 data-id="heading-10">6.策略模式（一个人走楼梯上楼或者走电梯上楼）</h3>
<p>这里以加减算法为例：
(1).定义抽象策略角色接口：Strategy</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Strategy</span> {
     <span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">calc</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> num1,<span class="hljs-built_in">int</span> num2</span>)</span>;
}
</code></pre>
<p>(2).定义加法策略：AddStrategy</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Strategy</span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calc</span><span class="hljs-params">(<span class="hljs-type">int</span> num1, <span class="hljs-type">int</span> num2)</span> {
        <span class="hljs-keyword">return</span> num1+num2;
    }
}
</code></pre>
<p>(3).定义减法策略：SubStrategy</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Strategy</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calc</span><span class="hljs-params">(<span class="hljs-type">int</span> num1, <span class="hljs-type">int</span> num2)</span> {
        <span class="hljs-keyword">return</span> num1-num2;
    }
}
</code></pre>
<p>(4).环境角色：Environment</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Environment</span> {
    <span class="hljs-keyword">private</span> Strategy strategy;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Environment</span><span class="hljs-params">(Strategy strategy)</span> </span>{
        <span class="hljs-keyword">this</span>.strategy = strategy;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">calc</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span></span>{
        <span class="hljs-keyword">return</span> strategy.<span class="hljs-built_in">calc</span>(a,b);
    }
}
</code></pre>
<p>测试方法：</p>
<pre><code class="hljs language-ini" lang="ini"> public static void main(String<span class="hljs-section">[]</span> args){
        Strategy <span class="hljs-attr">addStrage</span>=new AddStrategy()<span class="hljs-comment">;</span>
        Environment <span class="hljs-attr">environment</span>=new Environment(addStrage)<span class="hljs-comment">;</span>
        int <span class="hljs-attr">sum1</span>=environment.calc(<span class="hljs-number">10</span>,<span class="hljs-number">10</span>)<span class="hljs-comment">;</span>
        System.out.println("Result1:"+sum1)<span class="hljs-comment">;</span>
        Strategy <span class="hljs-attr">subStrage</span>=new SubStrategy()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">sum2</span>=subStrage.calc(<span class="hljs-number">20</span>,<span class="hljs-number">10</span>)<span class="hljs-comment">;</span>
        System.out.println("Result2:"+sum2)<span class="hljs-comment">;</span>
    }
</code></pre>
<h3 data-id="heading-11">7.Builder模式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Request</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String reason;
    <span class="hljs-keyword">private</span> String days;
    <span class="hljs-keyword">private</span> String groupLeaderInfo;
    <span class="hljs-keyword">private</span> String managerInfo;
    <span class="hljs-keyword">private</span> String departmentHeaderInfo;
    <span class="hljs-keyword">private</span> String customInfo;
    <span class="hljs-keyword">public</span> Request(Builder builder){
         <span class="hljs-comment">// super();</span>
          <span class="hljs-keyword">this</span>.name=builder.name;
          <span class="hljs-keyword">this</span>.reason=builder.reason;
          <span class="hljs-keyword">this</span>.days=builder.days;
          <span class="hljs-keyword">this</span>.groupLeaderInfo=builder.groupLeaderInfo;
          <span class="hljs-keyword">this</span>.managerInfo=builder.managerInfo;
          <span class="hljs-keyword">this</span>.departmentHeaderInfo=builder.departmentHeaderInfo;
          <span class="hljs-keyword">this</span>.customInfo=builder.customInfo;

    }


    <span class="hljs-keyword">public</span> static <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span>{
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> String reason;
        <span class="hljs-keyword">private</span> String days;
        <span class="hljs-keyword">private</span> String groupLeaderInfo;
        <span class="hljs-keyword">private</span> String managerInfo;
        <span class="hljs-keyword">private</span> String departmentHeaderInfo;
        <span class="hljs-keyword">private</span> String customInfo;

        <span class="hljs-keyword">public</span> Builder setName(String name) {
            <span class="hljs-keyword">this</span>.name = name;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">public</span> Builder setReason(String reason) {
            <span class="hljs-keyword">this</span>.reason = reason;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">public</span> Builder setDays(String days) {
            <span class="hljs-keyword">this</span>.days = days;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">public</span> Builder setGroupLeaderInfo(String groupLeaderInfo) {
            <span class="hljs-keyword">this</span>.groupLeaderInfo = groupLeaderInfo;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">public</span> Builder setManagerInfo(String managerInfo) {
            <span class="hljs-keyword">this</span>.managerInfo = managerInfo;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">public</span> Builder setDepartmentHeaderInfo(String departmentHeaderInfo) {
            <span class="hljs-keyword">this</span>.departmentHeaderInfo = departmentHeaderInfo;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">public</span> Builder setCustomInfo(String customInfo) {
            <span class="hljs-keyword">this</span>.customInfo = customInfo;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }
        <span class="hljs-keyword">public</span> Builder newRequest(Request request){
            <span class="hljs-keyword">this</span>.name=request.name;
            <span class="hljs-keyword">this</span>.days=request.days;
            <span class="hljs-keyword">this</span>.reason=request.reason;
            <span class="hljs-keyword">if</span>(request.getGroupLeaderInfo()!=<span class="hljs-literal">null</span>&amp;&amp;!request.getGroupLeaderInfo().equals(<span class="hljs-string">""</span>)){
                <span class="hljs-keyword">this</span>.groupLeaderInfo=request.groupLeaderInfo;
            }
            <span class="hljs-keyword">if</span>(request.getManagerInfo()!=<span class="hljs-literal">null</span>&amp;&amp;!request.getManagerInfo().equals(<span class="hljs-string">""</span>)){
                <span class="hljs-keyword">this</span>.managerInfo=request.managerInfo;
            }
            <span class="hljs-keyword">if</span>(request.getDepartmentHeaderInfo()!=<span class="hljs-literal">null</span>&amp;&amp;!request.getDepartmentHeaderInfo().equals(<span class="hljs-string">""</span>)){
                <span class="hljs-keyword">this</span>.departmentHeaderInfo=request.getDepartmentHeaderInfo();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
        }

        <span class="hljs-keyword">public</span> Request build(){
            <span class="hljs-keyword">return</span> new Request(<span class="hljs-keyword">this</span>);
        }
    }

    <span class="hljs-keyword">public</span> String getName() {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> String getReason() {
        <span class="hljs-keyword">return</span> reason;
    }

    <span class="hljs-keyword">public</span> String getDays() {
        <span class="hljs-keyword">return</span> days;
    }

    <span class="hljs-keyword">public</span> String getGroupLeaderInfo() {
        <span class="hljs-keyword">return</span> groupLeaderInfo;
    }

    <span class="hljs-keyword">public</span> String getManagerInfo() {
        <span class="hljs-keyword">return</span> managerInfo;
    }

    <span class="hljs-keyword">public</span> String getDepartmentHeaderInfo() {
        <span class="hljs-keyword">return</span> departmentHeaderInfo;
    }

    <span class="hljs-keyword">public</span> String getCustomInfo() {
        <span class="hljs-keyword">return</span> customInfo;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String toString() {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Request{"</span> +
                <span class="hljs-string">"name='"</span> + name + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", reason='"</span> + reason + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", days='"</span> + days + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", groupLeaderInfo='"</span> + groupLeaderInfo + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", managerInfo='"</span> + managerInfo + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", departmentHeaderInfo='"</span> + departmentHeaderInfo + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">", customInfo='"</span> + customInfo + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<p>测试方法：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">  <span class="hljs-keyword">public</span> static void main(String[] args){
       <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder()
               .setName(<span class="hljs-string">"shuijian"</span>)
               .setReason(<span class="hljs-string">"GoHome"</span>)
               .setDays(<span class="hljs-string">"2days"</span>)
               .build();
       System.out.println(<span class="hljs-built_in">request</span>.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());
    }
</code></pre>
<h3 data-id="heading-12">8.责任链模式</h3>
<p>实例场景
    在公司内部员工请假一般情况是这样的：员工在OA系统中提交一封请假邮件，该邮件会自动转发到你的直接上级领导邮箱里，如果你的请假的情况特殊的话，该邮件也会转发到你上级的上级的邮箱，根据请假的情况天数多少，系统会自动转发相应的责任人的邮箱。我们就以这样一种场景为例完成一个责任链模式的代码。为了更清晰的描述这种场景我们规定如下：
    ① GroupLeader（组长 ）：他能批准的假期为2天，如果请假天数超过2天就将请假邮件自动转发到组长和经理邮箱。
    ② Manager（经理）：他能批准的假期为4天以内，如果请假天数大于4天将该邮件转发到自动转发到组长、经理和部门领导的邮箱。
    ③ DepartmentHeader（部门领导）：他能批准的假期为7天以内，如果大于7天就只批准7天。</p>
<h6 data-id="heading-13">(1).构造Request对象，如：Builder模式中的Request</h6>
<h6 data-id="heading-14">(2).构造批准结果对象Result</h6>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> isRality;
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span>  info;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Result</span>(<span class="hljs-built_in">boolean</span> isRality, <span class="hljs-title class_">String</span> info) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRality</span> = isRality;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span> = info;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isRality</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> isRality;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setRality</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> rality</span>) {
        isRality = rality;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getInfo</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> info;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setInfo</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> info</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">info</span> = info;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Result{"</span> +
                <span class="hljs-string">"isRality="</span> + isRality +
                <span class="hljs-string">", info='"</span> + info + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<h6 data-id="heading-15">(3).定义一个接口，这个接口用于处理Request和获取请求结果Result</h6>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Ratify</span> {
    <span class="hljs-comment">//处理请求</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">deal</span>(<span class="hljs-params">Chain chain</span>)</span>;
    <span class="hljs-comment">//对request和result封装，用来转发</span>
    <span class="hljs-keyword">interface</span> <span class="hljs-title">Chain</span>{
        <span class="hljs-comment">//获取当前的request</span>
        <span class="hljs-function">Request <span class="hljs-title">request</span>()</span>;
        <span class="hljs-comment">//转发Request</span>
        <span class="hljs-function">Result <span class="hljs-title">proceed</span>(<span class="hljs-params">Request request</span>)</span>;
    }
}
</code></pre>
<p>看到上面的接口，可能会有人迷惑：在接口Ratify中为什么又定义一个Chain接口呢？其实这个接口是单独定义还是内部接口没有太大关系，但是考虑到Chain接口与Ratify接口的关系为提高内聚性就定义为内部接口了。定义Ratify接口是为了处理Request那为什么还要定义Chain接口呢？这正是责任链接口的精髓之处：转发功能及可动态扩展“责任人”，这个接口中定义了两个方法一个是request（）就是为了获取request，如果当前Ratify的实现类获取到request之后发现自己不能处理或者说自己只能处理部分请求，那么他将自己的那部分能处理的就处理掉，然后重新构建一个或者直接转发Request给下一个责任人。可能这点说的不容易理解，我举个例子，在Android与后台交互中如果使用了Http协议，当然我们可能使用各种Http框架如HttpClient、OKHttp等，我们只需要发送要请求的参数就直接等待结果了，这个过程中你可能并没有构建请求头，那么框架帮你把这部分工作给做了，它做的工程中如果使用了责任链模式的话，它肯定会将Request进行包装（也就是添加请求头）成新的Request，我们姑且加他为Request1，如果你又希望Http做本地缓存，那么Request1又会被转发到并且重新进一步包装为Request2。总之Chain这个接口就是起到对Request进行重新包装的并将包装后的Request进行下一步转发的作用。如果还不是很明白也没关系，本实例会演示这一功能机制。</p>
<h6 data-id="heading-16">(4).实现Chain接口的的真正的包装Request和转发功能</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealChain</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Ratify</span>.Chain {
    <span class="hljs-keyword">public</span> Request request;
    <span class="hljs-keyword">public</span> List&lt;Ratify&gt; ratifyList;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> index;
    <span class="hljs-comment">/**
     * 构造方法
     *
     * <span class="hljs-doctag">@param</span> ratifyList
     *            Ratify接口的实现类集合
     * <span class="hljs-doctag">@param</span> request
     *            具体的请求Request实例
     * <span class="hljs-doctag">@param</span> index
     *            已经处理过该request的责任人数量
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RealChain</span><span class="hljs-params">(List&lt;Ratify&gt; ratifyList, Request request,<span class="hljs-type">int</span> index)</span> {
        <span class="hljs-built_in">this</span>.request = request;
        <span class="hljs-built_in">this</span>.ratifyList = ratifyList;
        <span class="hljs-built_in">this</span>.index = index;
    }
    <span class="hljs-comment">/**
     * 方法描述：具体转发功能
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">proceed</span><span class="hljs-params">(Request request)</span> {
        Result proceed=<span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span>(ratifyList.size()&gt;index){
          RealChain realChain=<span class="hljs-keyword">new</span> <span class="hljs-title class_">RealChain</span>(ratifyList,request,index+<span class="hljs-number">1</span>);
          Ratify ratify=ratifyList.get(index);
          proceed=ratify.deal(realChain);
        }
        <span class="hljs-keyword">return</span> proceed;
    }

    <span class="hljs-comment">/***
     * 方法描述：返回当前Request对象或者返回当前进行包装后的Request对象
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Request <span class="hljs-title function_">request</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> request;
    }
}
</code></pre>
<h6 data-id="heading-17">(5).GroupLeader、Manager和DepartmentHeader，并让他们实现Ratify接口</h6>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> GroupLeader implements Ratify {
    @Override
    <span class="hljs-keyword">public</span> Result deal(Chain chain) {
        <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span>=chain.<span class="hljs-built_in">request</span>();
        System.out.println(<span class="hljs-string">"GroupLeader====&gt;request:"</span>+<span class="hljs-built_in">request</span>.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());
        <span class="hljs-keyword">if</span>(Integer.parse<span class="hljs-built_in">Int</span>(<span class="hljs-built_in">request</span>.getDays())&gt;<span class="hljs-number">1</span>){
            //包装新的<span class="hljs-built_in">Request</span>对象
            <span class="hljs-built_in">Request</span> newRequest=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().newRequest(<span class="hljs-built_in">request</span>).setGroupLeaderInfo(<span class="hljs-built_in">request</span>.getName()+<span class="hljs-string">"平时表现不错,而且现在项目不忙"</span>).build();
            return chain.proceed(newRequest);
        }
        return <span class="hljs-keyword">new</span> Result(<span class="hljs-literal">true</span>,<span class="hljs-string">"GroupLeader:早去早回"</span>);
    }
}
</code></pre>

<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> Manager implements Ratify {
    @Override
    <span class="hljs-keyword">public</span> Result deal(Chain chain) {
        <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span>=chain.<span class="hljs-built_in">request</span>();
        System.out.println(<span class="hljs-string">"Manager====&gt;request:"</span>+<span class="hljs-built_in">request</span>.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());
        <span class="hljs-keyword">if</span>(Integer.parse<span class="hljs-built_in">Int</span>(<span class="hljs-built_in">request</span>.getDays())&gt;<span class="hljs-number">3</span>){
            //构建新的<span class="hljs-built_in">Request</span>
            <span class="hljs-built_in">Request</span> newRequest=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().newRequest(<span class="hljs-built_in">request</span>).setManagerInfo(<span class="hljs-built_in">request</span>.getName()+<span class="hljs-string">"每月的KPI考核还不错,可以批准"</span>).build();
            return chain.proceed(newRequest);

        }
        return <span class="hljs-keyword">new</span> Result(<span class="hljs-literal">true</span>,<span class="hljs-string">"Manager:早点把事情办完，项目离不开你"</span>);
    }
}
</code></pre>

<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> DepartmentHeader implements Ratify {
    @Override
    <span class="hljs-keyword">public</span> Result deal(Chain chain) {
        <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span>=chain.<span class="hljs-built_in">request</span>();
        System.out.println(<span class="hljs-string">"DepartmentHeader=====&gt;request:"</span>+<span class="hljs-built_in">request</span>.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());
        <span class="hljs-keyword">if</span>(Integer.parse<span class="hljs-built_in">Int</span>(<span class="hljs-built_in">request</span>.getDays())&gt;<span class="hljs-number">7</span>){
              return  <span class="hljs-keyword">new</span> Result(<span class="hljs-literal">false</span>,<span class="hljs-string">"DepartmentHeader:你这个时间太长,不能批准"</span>);
        }
        return <span class="hljs-keyword">new</span> Result(<span class="hljs-literal">true</span>,<span class="hljs-string">"DepartmentHeader:不要着急，把事情处理完在回来!"</span>);
    }
}
</code></pre>

<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> CustomInterceptor implements Ratify {
    @Override
    <span class="hljs-keyword">public</span> Result deal(Chain chain) {
        <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span>=chain.<span class="hljs-built_in">request</span>();
        System.out.println(<span class="hljs-string">"CustomInterceptor====&gt;"</span>+<span class="hljs-built_in">request</span>.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());
        String reason=<span class="hljs-built_in">request</span>.getReason();
        <span class="hljs-keyword">if</span>(reason!=<span class="hljs-literal">null</span>&amp;&amp;reason.equals(<span class="hljs-string">"事假"</span>)){
              <span class="hljs-built_in">Request</span> newRequest=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().newRequest(<span class="hljs-built_in">request</span>).setCustomInfo(<span class="hljs-built_in">request</span>.getName()+<span class="hljs-string">"请的是事假，而且很着急，请领导重视一下"</span>).build();
              System.out.println(<span class="hljs-string">"CustomInterceptor====&gt;转发请求"</span>);
              return chain.proceed(newRequest);
        }
        return <span class="hljs-keyword">new</span> Result(<span class="hljs-literal">true</span>,<span class="hljs-string">"同意请假"</span>);
    }
}
</code></pre>
<h6 data-id="heading-18">(6).责任链模式工具类</h6>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ChainOfResponsibilityClient</span> {
    <span class="hljs-keyword">private</span> ArrayList&lt;Ratify&gt; ratifies;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ChainOfResponsibilityClient</span>()</span> {
        ratifies=<span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    }

    <span class="hljs-comment">/**
     * 为了展示“责任链模式”的真正的迷人之处（可扩展性），在这里构造该方法以便添加自定义的“责任人”
     * @param ratify
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addRatifys</span>(<span class="hljs-params">Ratify ratify</span>)</span>{
        ratifies.<span class="hljs-keyword">add</span>(ratify);
    }

    <span class="hljs-comment">/***
     *
     * 方法描述：执行请求
     * @param request
     * @return
     */</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> Result <span class="hljs-title">execute</span>(<span class="hljs-params">Request request</span>)</span>{
        ArrayList&lt;Ratify&gt; arrayList=<span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        arrayList.addAll(ratifies);
        arrayList.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> GroupLeader());
        arrayList.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Manager());
        arrayList.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> DepartmentHeader());
        RealChain realChain=<span class="hljs-keyword">new</span> RealChain(arrayList,request,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">return</span> realChain.proceed(request);
    }
}
</code></pre>
<h6 data-id="heading-19">(6).测试方法</h6>
<pre><code class="hljs language-vbscript" lang="vbscript"> <span class="hljs-keyword">public</span> static void main(String[] args){
        //写法一
        <span class="hljs-built_in">Request</span>.Builder builder=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder();//通过静态内部类构建builder对象
        builder.setName(<span class="hljs-string">"zhangsan"</span>);
        builder.setDays(<span class="hljs-string">"5"</span>);
        builder.setReason(<span class="hljs-string">"事假"</span>);
        <span class="hljs-built_in">Request</span> <span class="hljs-built_in">request</span>=builder.build();//build方法返回<span class="hljs-built_in">request</span>对象
        //写法二
        <span class="hljs-built_in">Request</span> request1=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Request</span>.Builder().setName(<span class="hljs-string">"lisi"</span>).setDays(<span class="hljs-string">"7"</span>).setReason(<span class="hljs-string">"事假"</span>).build();
        //System.out.pr<span class="hljs-built_in">int</span>(<span class="hljs-string">"结果："</span>+<span class="hljs-built_in">request</span>.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());

        ChainOfResponsibilityClient client=<span class="hljs-keyword">new</span> ChainOfResponsibilityClient();
        //添加自定义的拦截器到责任人列表顶端
        client.addRatifys(<span class="hljs-keyword">new</span> CustomInterceptor());
        Result result=client.<span class="hljs-keyword">execute</span>(<span class="hljs-built_in">request</span>);
        System.out.println(<span class="hljs-string">"结果:"</span>+result.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>());

    }
</code></pre>
<h3 data-id="heading-20">9.享元模式</h3>
<p>(1).定义一个接口作为享元角色</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IBike</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ride</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> hours</span>)</span>;
}
</code></pre>
<p>(2).实现IBike接口，作为具体的享元角色</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShareBike</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBike</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> price=<span class="hljs-number">2</span> ;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ride</span><span class="hljs-params">(<span class="hljs-type">int</span> hours)</span> {
        <span class="hljs-type">int</span> total=<span class="hljs-number">2</span>*hours;
        System.out.println(<span class="hljs-string">"ride bike total spend "</span>+total+<span class="hljs-string">" RMB"</span>);

    }
}
</code></pre>
<p>(3).创建享元工厂</p>
<pre><code class="hljs language-ini" lang="ini">public class ShareBikeFactory {
    Map&lt;String,IBike&gt; <span class="hljs-attr">pool</span>=new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
    public  IBike getBike(String name){
        IBike <span class="hljs-attr">iBike</span>=null<span class="hljs-comment">;</span>
        if(!pool.containsKey(name)){
            <span class="hljs-attr">iBike</span>=new ShareBike()<span class="hljs-comment">;</span>
            pool.put(name,iBike)<span class="hljs-comment">;</span>
            System.out.println("交了199元押金，可以用车:"+name)<span class="hljs-comment">;</span>
        }else{
            <span class="hljs-attr">iBike</span>=pool.get(name)<span class="hljs-comment">;</span>
            System.out.println("押金已交，直接用车:"+name)<span class="hljs-comment">;</span>
        }
        return iBike<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>(4).测试类</p>
<pre><code class="hljs language-ini" lang="ini"> public static void main(String<span class="hljs-section">[]</span> args) {
        ShareBikeFactory <span class="hljs-attr">shareBikeFactory</span>=new ShareBikeFactory()<span class="hljs-comment">;</span>
        //第一次骑ofo，交押金
        IBike <span class="hljs-attr">ofo1</span>=shareBikeFactory.getBike(<span class="hljs-string">"ofo"</span>)<span class="hljs-comment">;</span>
        ofo1.ride(2)<span class="hljs-comment">;</span>
        //第一次骑mobike，交押金
        IBike <span class="hljs-attr">mobike</span>=shareBikeFactory.getBike(<span class="hljs-string">"mobike"</span>)<span class="hljs-comment">;</span>
        mobike.ride(3)<span class="hljs-comment">;</span>
        //第二次骑mobike，不交押金
        IBike <span class="hljs-attr">ofo2</span>=shareBikeFactory.getBike(<span class="hljs-string">"ofo"</span>)<span class="hljs-comment">;</span>
        ofo2.ride(4)<span class="hljs-comment">;</span>
    }
</code></pre>
<h3 data-id="heading-21">10.模板方法模式</h3>
<p>(1).创建抽象类，定义算法框架</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Postman</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> final <span class="hljs-keyword">void</span> <span class="hljs-title">post</span>()</span>{<span class="hljs-comment">//这里声明为final，不希望子类覆盖这个方法，防止更改流程</span>
        prepare();
        call();
        <span class="hljs-keyword">if</span>(isSign()){
            sign();
        }<span class="hljs-keyword">else</span>{
            refuse();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refuse</span>()</span> {
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sign</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"派送完毕,客户已经签收！"</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> boolean <span class="hljs-title">isSign</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">call</span>()</span>;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepare</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"快递已经到达，准备派送..."</span>);
    }
}
</code></pre>
<p>需要注意的是上面的抽象类（Postman）包含了三种类型的方法：抽象方法、具体方法和钩子方法。
抽象方法：需要子类去实现。如上面的call()。
具体方法：抽象父类中直接实现。如上面的prepare()和sign()。
钩子方法：有两种，第一种，它是一个空实现的方法，子类可以视情况来决定是否要覆盖它，如上面的refuse()；第二种，它的返回类型通常是boolean类型的，一般用于对某个条件进行判断，如果条件满足则执行某一步骤，否则将不执行，如上面的isSign()。
(2).创建具体实现类，定义算法框架
PostmanA:</p>
<pre><code class="hljs language-scala" lang="scala">public  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostmanA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Postman</span></span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void call() {
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"联系收货人A,准备派送..."</span>);
    }
}
</code></pre>
<p>PostmanB:</p>
<pre><code class="hljs language-scala" lang="scala">public  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PostmanB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Postman</span></span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void call() {
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"联系收货人B,准备派送..."</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> boolean isSign() {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void refuse() {
        <span class="hljs-keyword">super</span>.refuse();
        <span class="hljs-type">System</span>.out.println(<span class="hljs-string">"商品与实物不符，拒绝签收!"</span>);
    }
}
</code></pre>
<p>(3).测试类</p>
<pre><code class="hljs language-scss" lang="scss"> public static void <span class="hljs-selector-tag">main</span>(String[] args){
        <span class="hljs-comment">//A收货人正常签收</span>
        Postman postmanA=new <span class="hljs-built_in">PostmanA</span>();
        postmanA<span class="hljs-selector-class">.post</span>();
        <span class="hljs-comment">//B收货人拒绝签收</span>
        Postman postmanB=new <span class="hljs-built_in">PostmanB</span>();
        postmanB<span class="hljs-selector-class">.post</span>();
    }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d095712c6ae849da8bf905d1cbe156a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286353&amp;x-signature=1B%2Bog5v8EsnaFCfsMschnueXpMY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-22">11.备忘录模式</h3>
<p>以游戏存档为例:
(1).创建发起人角色：Game</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Game</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> mLevel=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> mIcon=<span class="hljs-number">0</span>;

    <span class="hljs-comment">/***
     * 开始游戏
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">paly</span>()</span>{
        System.<span class="hljs-keyword">out</span>.print(<span class="hljs-string">"升级了"</span>);
        mLevel++;
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"当前等级为："</span>+mLevel);
        mIcon+=<span class="hljs-number">32</span>;
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"获得金币："</span>+mIcon);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"当前金币数量为:"</span>+mIcon);
    }

    <span class="hljs-comment">/***
     * 退出游戏
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exit</span>()</span>{
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"退出游戏，属性为：等级="</span>+mLevel+<span class="hljs-string">",金币="</span>+mIcon);
    }

    <span class="hljs-comment">//创建备忘录</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Memo <span class="hljs-title">createMemo</span>()</span>{
        Memo memo=<span class="hljs-keyword">new</span> Memo();
        memo.setmLevel(mLevel);
        memo.setmIcon(mIcon);
        <span class="hljs-keyword">return</span> memo;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMemo</span>(<span class="hljs-params">Memo memo</span>)</span>{
        mLevel=memo.getmLevel();
        mIcon=memo.getmIcon();
    }

}
</code></pre>
<p>(2).创建备忘录角色：Memo</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Memo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> mLevel;<span class="hljs-comment">//等级</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> mIcon;<span class="hljs-comment">//金币数量</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getmLevel</span>()</span> {
        <span class="hljs-keyword">return</span> mLevel;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setmLevel</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> mLevel</span>)</span> {
        <span class="hljs-keyword">this</span>.mLevel = mLevel;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getmIcon</span>()</span> {
        <span class="hljs-keyword">return</span> mIcon;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setmIcon</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> mIcon</span>)</span> {
        <span class="hljs-keyword">this</span>.mIcon = mIcon;
    }
}
</code></pre>
<p>(3).创建负责人角色：CreateMemo</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateMemo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Memo</span> memo;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Memo</span> <span class="hljs-title function_">getMemo</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> memo;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setMemo</span>(<span class="hljs-params">Memo memo</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">memo</span> = memo;
    }
}
</code></pre>
<p>(4).测试类</p>
<pre><code class="hljs language-scss" lang="scss">public static void <span class="hljs-selector-tag">main</span>(String[] args){
        Game game=new <span class="hljs-built_in">Game</span>();
        game<span class="hljs-selector-class">.paly</span>();
        CreateMemo createMemo=new <span class="hljs-built_in">CreateMemo</span>();
        createMemo<span class="hljs-selector-class">.setMemo</span>(game.createMemo());<span class="hljs-comment">//游戏存档</span>
        game<span class="hljs-selector-class">.exit</span>();
        <span class="hljs-comment">//第二次进入游戏</span>
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("第二次进入游戏");
        Game secondGame=new <span class="hljs-built_in">Game</span>();
        secondGame<span class="hljs-selector-class">.setMemo</span>(createMemo.getMemo());<span class="hljs-comment">//取出之前备忘录中的数据</span>
        secondGame<span class="hljs-selector-class">.paly</span>();
        secondGame<span class="hljs-selector-class">.exit</span>();
    }
</code></pre>
<h3 data-id="heading-23">12.原型模式</h3>
<p>(1).创建具体原型类
实现Cloneable接口：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Card</span> <span class="hljs-title">implements</span> <span class="hljs-title">Cloneable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> num;<span class="hljs-comment">//卡号</span>
    <span class="hljs-keyword">private</span> Spec spec=<span class="hljs-keyword">new</span> Spec();
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Card</span>()</span>{
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"Card 执行构造函数"</span>);
    }

    @Override
    <span class="hljs-function"><span class="hljs-keyword">protected</span> Card <span class="hljs-title">clone</span>() throws CloneNotSupportedException</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"clone时不执行构造函数"</span>);
        Card card= (Card) super.clone();
        card.spec=spec.clone();<span class="hljs-comment">//对Spce对象也调用clone,实现深拷贝</span>
        <span class="hljs-keyword">return</span> card;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getNum</span>()</span> {
        <span class="hljs-keyword">return</span> num;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setNum</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> num</span>)</span> {
        <span class="hljs-keyword">this</span>.num = num;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Spec <span class="hljs-title">getSpec</span>()</span> {
        <span class="hljs-keyword">return</span> spec;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSpec</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> width,<span class="hljs-built_in">int</span>  length</span>)</span> {
        spec.width=width;
        spec.length=length;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Spec</span> <span class="hljs-title">implements</span> <span class="hljs-title">Cloneable</span>{
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> width;
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> length;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getWidth</span>()</span> {
            <span class="hljs-keyword">return</span> width;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setWidth</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> width</span>)</span> {
            <span class="hljs-keyword">this</span>.width = width;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getLength</span>()</span> {
            <span class="hljs-keyword">return</span> length;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setLength</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> length</span>)</span> {
            <span class="hljs-keyword">this</span>.length = length;
        }

        @Override
        <span class="hljs-function"><span class="hljs-keyword">protected</span> Spec <span class="hljs-title">clone</span>() throws CloneNotSupportedException</span> {
            <span class="hljs-keyword">return</span> (Spec) super.clone();
        }
    }

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Card{"</span> +
                <span class="hljs-string">"num="</span> + num +
                <span class="hljs-string">", spec="</span> +<span class="hljs-string">"{width="</span>+spec.getWidth()+<span class="hljs-string">",length="</span>+spec.getLength()+
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<p>(2).测试类</p>
<pre><code class="hljs language-scss" lang="scss"> public static void <span class="hljs-selector-tag">main</span>(String[] args) throws CloneNotSupportedException {
        Card card1=new <span class="hljs-built_in">Card</span>();
        card1<span class="hljs-selector-class">.setNum</span>(<span class="hljs-number">111</span>);
        card1<span class="hljs-selector-class">.setSpec</span>(<span class="hljs-number">66</span>,<span class="hljs-number">67</span>);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(card1.toString());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("---------------------");
        <span class="hljs-comment">//拷贝</span>
        Card card2=card1<span class="hljs-selector-class">.clone</span>();
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(card2.toString());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("---------------------");
        <span class="hljs-comment">//拷贝之后，card2对num进行重新赋值</span>
        card2<span class="hljs-selector-class">.setNum</span>(<span class="hljs-number">222</span>);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(card1.toString());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(card2.toString());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("---------------------");
        <span class="hljs-comment">//拷贝之后，card2对Spec进行重新赋值之后，连card1也跟着改变了，这种就是浅拷贝</span>
        card2<span class="hljs-selector-class">.setSpec</span>(<span class="hljs-number">76</span>,<span class="hljs-number">77</span>);
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(card1.toString());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(card2.toString());
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("---------------------");
    }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c95d2957990148c8a634e99328b0ce1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286353&amp;x-signature=yxF97%2Fb3xpcuojB7ivD3SCeijAs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-24">13.命令模式</h3>
<p>(1).创建命令接口Command</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Command</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">execute</span>()</span>;
}
</code></pre>
<p>(2).创建命令接口实现类：ShutDownCommand</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ShutDownCommand</span> <span class="hljs-title">implements</span> <span class="hljs-title">Command</span> {
    Receiver receiver;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ShutDownCommand</span>(<span class="hljs-params">Receiver receiver</span>)</span> {
        <span class="hljs-keyword">this</span>.receiver = receiver;
    }

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">execute</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"命令角色执行关机命令"</span>);
        receiver.action();
    }
}
</code></pre>
<p>(3).创建命令执行者Receiver</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Receiver</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">action</span>()</span>{
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"接收者执行具体的操作"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"开始执行关机命令"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"退出所有程序"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"关机..."</span>);
    }
}
</code></pre>
<p>(4).创建调用者Invoker</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Invoker</span> {
    <span class="hljs-keyword">private</span>  Command command;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Invoker</span>(<span class="hljs-params">Command command</span>)</span> {
        <span class="hljs-keyword">this</span>.command = command;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">action</span>()</span>{
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"调用者执行命令"</span>);
        command.execute();
    }
}
</code></pre>
<p>测试方法：</p>
<pre><code class="hljs language-scss" lang="scss">public static void <span class="hljs-selector-tag">main</span>(String[] args){
       Receiver receiver=new <span class="hljs-built_in">Receiver</span>();<span class="hljs-comment">//创建命令接收者</span>
       Command command=new <span class="hljs-built_in">ShutDownCommand</span>(receiver);<span class="hljs-comment">//创建一个命令的具体实现对象，并指定命令接收者</span>
       Invoker invoke=new <span class="hljs-built_in">Invoker</span>(command);<span class="hljs-comment">//创建一个命令调用者，并指定具体命令</span>
       invoke<span class="hljs-selector-class">.action</span>();
    }
</code></pre>
<h6 data-id="heading-25">注意：此处调用者与接受者之间的解藕。易于扩展，扩展命令只需新增具体命令类即可，符合开放封闭原则。</h6>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d12bf100cb904d14ad8f4353552453c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286353&amp;x-signature=qCyQ36co%2FNtwkdoYoH4GXCikDQU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-26">14.代理模式</h3>
<p>(1).静态代理
IBuy接口</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IBuy</span> {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">buy</span>()</span>;
}
</code></pre>
<p>IBuy接口实现类：Home,OverSea</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IBuy</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"国内要买一个包"</span>);
    }
}
</code></pre>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Oversea</span> <span class="hljs-title">implements</span> <span class="hljs-title">IBuy</span> {
    IBuy buyer;
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Oversea</span>(<span class="hljs-params">IBuy buyer</span>)</span> {
        <span class="hljs-keyword">this</span>.buyer=buyer;
    }

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">buy</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"我是海外代购"</span>);
        buyer.buy();
    }
}
</code></pre>
<p>测试方法：</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span></span>{
        <span class="hljs-comment">//静态代理</span>
        IBuy home=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Home</span>();
        IBuy oversea=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Oversea</span>(home);
        oversea.<span class="hljs-built_in">buy</span>();
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"----------------------------------------"</span>);
        
    }

</code></pre>
<p>(2).动态代理(代理类在程序运行时动态生成)
动态代理类：DynamicProxy</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Object</span> obj;<span class="hljs-comment">//被代理的对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DynamicProxy</span>(<span class="hljs-title class_">Object</span> obj) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>=obj;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-title class_">Object</span> proxy, <span class="hljs-title class_">Method</span> method, <span class="hljs-title class_">Object</span>[] args) throws <span class="hljs-title class_">Throwable</span> {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"海外动态代理调用方法:"</span>+method.<span class="hljs-title function_">getName</span>());
        <span class="hljs-title class_">Object</span> result=method.<span class="hljs-title function_">invoke</span>(obj,args);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>测试方法：</p>
<pre><code class="hljs language-scss" lang="scss">  public static void <span class="hljs-selector-tag">main</span>(String[] args){
        <span class="hljs-comment">//动态代理</span>
        IBuy home=new <span class="hljs-built_in">Home</span>();<span class="hljs-comment">//被代理类</span>
        ClassLoader classLoader=demestics<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getClassLoader</span>();<span class="hljs-comment">//获取classloader</span>
        Class<span class="hljs-selector-attr">[]</span> classes=new Class<span class="hljs-selector-attr">[]</span>{IBuy<span class="hljs-selector-class">.class</span>};<span class="hljs-comment">//接口类的class数组</span>
        DynamicProxy dynamicProxy=new <span class="hljs-built_in">DynamicProxy</span>(home);<span class="hljs-comment">//创建动态代理</span>
        IBuy oversea1= (IBuy) Proxy<span class="hljs-selector-class">.newProxyInstance</span>(classLoader,classes,dynamicProxy);
        oversea1<span class="hljs-selector-class">.buy</span>();<span class="hljs-comment">//调用海外代购的buy,此处实际上是调用dynamicProxy.invoke()方法</span>
        System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>("----------------------------------------");

    }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b828889f964f447ca84cb5b412f43a33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286353&amp;x-signature=g4nH%2FOl8KbuBqST5yt8keSjgVOo%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[线程池的类型和原理]]></title>    <link>https://juejin.cn/post/7600587732991655978</link>    <guid>https://juejin.cn/post/7600587732991655978</guid>    <pubDate>2026-01-29T10:22:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600587732991655978" data-draft-id="7600602502633357353" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="线程池的类型和原理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T10:22:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Asmewill"/> <meta itemprop="url" content="https://juejin.cn/user/3139860938370557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            线程池的类型和原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860938370557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Asmewill
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:22:13.000Z" title="Thu Jan 29 2026 10:22:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>参考文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flanseyitai1224%2Fp%2F7895652.html" target="_blank" title="https://www.cnblogs.com/lanseyitai1224/p/7895652.html" ref="nofollow noopener noreferrer">Java线程池的四种创建方式 - 绝不妥协绝不低头 - 博客园 (cnblogs.com)</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fdongguacai%2Fp%2F6030187.html" target="_blank" title="https://www.cnblogs.com/dongguacai/p/6030187.html" ref="nofollow noopener noreferrer">JAVA线程池原理详解一 - 冬瓜蔡 - 博客园 (cnblogs.com)</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fstar95%2Fp%2F17714057.html" target="_blank" title="https://www.cnblogs.com/star95/p/17714057.html" ref="nofollow noopener noreferrer">深度解读Java线程池</a></p>
<h3 data-id="heading-0">1.线程池创建之使用线程池工厂</h3>
<h5 data-id="heading-1">1.1.定长线程池</h5>
<p>Executors.newFixedThreadPool(2)，核心线程和线程总数一样，使用LinkedBlockingQueue队列(链表，容量Integer.Max)</p>
<pre><code class="hljs language-java" lang="java">       <span class="hljs-comment">//1.步骤一</span>
       ExecutorService newFixedThreadPool=Executors.newFixedThreadPool(<span class="hljs-number">2</span>);
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">4</span>;j++){
            <span class="hljs-keyword">final</span>  <span class="hljs-type">int</span> index=j;
            newFixedThreadPool.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(index));
        }
       <span class="hljs-comment">//2.步骤二   LinkedBlockingQueue队列的容量为Integer.Max</span>
       <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> nThreads)</span> {
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(nThreads, nThreads,
                                      <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,
                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());
      }
     <span class="hljs-comment">//3.步骤三 Integer.MAX_VALUE</span>
     <span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,
                              <span class="hljs-type">int</span> maximumPoolSize,
                              <span class="hljs-type">long</span> keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue)</span> {
        <span class="hljs-built_in">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
             Executors.defaultThreadFactory(), defaultHandler);
    }
   <span class="hljs-comment">//4.步骤四  defaultHandler实现了</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RejectedExecutionHandler</span> <span class="hljs-variable">defaultHandler</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortPolicy</span>();
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbortPolicy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RejectedExecutionHandler</span> {
        <span class="hljs-comment">/**
         * Creates an {<span class="hljs-doctag">@code</span> AbortPolicy}.
         */</span>
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbortPolicy</span><span class="hljs-params">()</span> { }

        <span class="hljs-comment">/**
         * Always throws RejectedExecutionException.
         *
         * <span class="hljs-doctag">@param</span> r the runnable task requested to be executed
         * <span class="hljs-doctag">@param</span> e the executor attempting to execute this task
         * <span class="hljs-doctag">@throws</span> RejectedExecutionException always
         */</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejectedExecution</span><span class="hljs-params">(Runnable r, ThreadPoolExecutor e)</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RejectedExecutionException</span>(<span class="hljs-string">"Task "</span> + r.toString() +
                                                 <span class="hljs-string">" rejected from "</span> +
                                                 e.toString());
        }
    }
</code></pre>
<h5 data-id="heading-2">1.2.周期性程池，支持周期性或者定时任务。</h5>
<p>Executors.newScheduleThreadPool
核心线程是固定的，线程总数是Integer.Max_value，使用DelayedWorkQueue队列（最小堆，容量16）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//1.步骤一</span>
 ScheduledExecutorService newScheduleThreadPool= Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;k&lt;<span class="hljs-number">4</span>;k++){
           <span class="hljs-keyword">final</span>  <span class="hljs-type">int</span> index=k;
            <span class="hljs-comment">//执行结果：延迟三秒之后执行，除了延迟执行之外和newFixedThreadPool基本相同</span>
            newScheduleThreadPool.schedule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(index),<span class="hljs-number">3</span>, TimeUnit.SECONDS);
        }
  <span class="hljs-comment">// 2.步骤二</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ScheduledExecutorService <span class="hljs-title function_">newScheduledThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledThreadPoolExecutor</span>(corePoolSize);
    }
  <span class="hljs-comment">//3.步骤三</span>
   <span class="hljs-keyword">public</span> <span class="hljs-title function_">ScheduledThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> {
        <span class="hljs-built_in">super</span>(corePoolSize, Integer.MAX_VALUE,
              DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,
              <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedWorkQueue</span>());
    }
   <span class="hljs-comment">//步骤四</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,
                              <span class="hljs-type">int</span> maximumPoolSize,
                              <span class="hljs-type">long</span> keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue)</span> {
        <span class="hljs-built_in">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
             Executors.defaultThreadFactory(), defaultHandler);
    }


</code></pre>
<h5 data-id="heading-3">1.3.可缓存线程池</h5>
<p>Executors.newCachedThreadPool
核心线程数为0，线程总数为Integer.Max，使用SynchronousQueue同步队列（双向链表,容量0）
特点：SynchronousQueue没有容量，可以确保任务立即被处理，而不是排队等待。</p>
<pre><code class="hljs language-java" lang="java">   <span class="hljs-comment">//1.步骤一</span>
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">newCachedThreadPool</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">4</span>;i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> index=i;
            newCachedThreadPool.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyRunnable</span>(index));
     }
 <span class="hljs-comment">//2.步骤二</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newCachedThreadPool</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">0</span>, Integer.MAX_VALUE,
                                      <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
                                      <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;Runnable&gt;());
    }
<span class="hljs-comment">//3.步骤三</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize,
                              <span class="hljs-type">int</span> maximumPoolSize,
                              <span class="hljs-type">long</span> keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue)</span> {
        <span class="hljs-built_in">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
             Executors.defaultThreadFactory(), defaultHandler);
    }
  
</code></pre>
<h5 data-id="heading-4">1.4.单线程池</h5>
<p>Executors.newSingleThreadExecutor
核心线程数和线程总数都是1，使用的LinkedBlockingQueue队列（链表实现，容量默认Integer.Max）</p>
<pre><code class="hljs language-csharp" lang="csharp">  <span class="hljs-comment">//1.步骤一</span>
  ExecutorService newSingleThreadExtutor=Executors.newSingleThreadExecutor();
        <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> l=<span class="hljs-number">0</span>;l&lt;<span class="hljs-number">4</span>;l++){
            final <span class="hljs-built_in">int</span> index=l;
            <span class="hljs-comment">//执行结果：只存在一个线程，顺序执行</span>
            newSingleThreadExtutor.execute(<span class="hljs-keyword">new</span> MyRunnable(index));
  }
<span class="hljs-comment">//2.步骤二</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title">newSingleThreadExecutor</span>()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> FinalizableDelegatedExecutorService
            (<span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>,
                                    <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,
                                    <span class="hljs-keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));
    }
<span class="hljs-comment">//步骤三</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadPoolExecutor</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> corePoolSize,
                              <span class="hljs-built_in">int</span> maximumPoolSize,
                              <span class="hljs-built_in">long</span> keepAliveTime,
                              TimeUnit unit,
                              BlockingQueue&lt;Runnable&gt; workQueue</span>)</span> {
        <span class="hljs-keyword">this</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue,
             Executors.defaultThreadFactory(), defaultHandler);
    }


</code></pre>
<h3 data-id="heading-5">2.线程池创建之使用ThreadPoolExecutor构造方法自定义线程池</h3>
<ul>
<li>int corePoolSize 核心线程数</li>
<li>int maximumPoolSize  线程总数</li>
<li>long keepAliveTime 非核心空闲线程存活时间</li>
<li>TimeUnit  unit  非核心空闲线程存活时间单位</li>
<li>BlockingQueue workQueue 任务队列</li>
<li>ThreadFactory 线程工厂类 (工厂模式的方式创建线程)（接口，实现了newThread方法）【默认实现】</li>
<li>RejectedExecutionHandler 拒绝策略 (接口，实现了RejectedExecution方法) 【默认实现】
#####2.1.自定义线程池
注意：如果想要自定线程工程，或者自定义拒绝策略都可以.</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">LinkedBlockingQueue  <span class="hljs-attr">queue</span>=new LinkedBlockingQueue()<span class="hljs-comment">;</span>
ThreadPoolExecutor   <span class="hljs-attr">theadPool</span>=new ThreadPoolExecutor(
2,4,10,
TimeUnit.SECONDS,queue,
Executors.defaultTheadFactory,
defaultHandler )<span class="hljs-comment">;</span>

</code></pre>
<h5 data-id="heading-6">2.2.系统默认的线程工工厂和拒绝策略</h5>
<p>//线程工厂，用于批量创建线程</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ThreadFactory</span> {
    Thread <span class="hljs-title function_">newThread</span><span class="hljs-params">(Runnable r)</span>;
}
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ThreadFactory <span class="hljs-title function_">defaultThreadFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultThreadFactory</span>();
}
<span class="hljs-comment">//拒绝策略，默认为抛出异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RejectedExecutionHandler</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">rejectedExecution</span><span class="hljs-params">(Runnable r, ThreadPoolExecutor executor)</span>;
}
 <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RejectedExecutionHandler</span> <span class="hljs-variable">defaultHandler</span> <span class="hljs-operator">=</span><span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortPolicy</span>();

</code></pre>
<h5 data-id="heading-7">2.3.默认的线程池工厂实现类</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultThreadFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ThreadFactory</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">poolNumber</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadGroup group;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">threadNumber</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String namePrefix;

        DefaultThreadFactory() {
            <span class="hljs-type">SecurityManager</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> System.getSecurityManager();
            group = (s != <span class="hljs-literal">null</span>) ? s.getThreadGroup() :
                                  Thread.currentThread().getThreadGroup();
            namePrefix = <span class="hljs-string">"pool-"</span> +
                          poolNumber.getAndIncrement() +
                         <span class="hljs-string">"-thread-"</span>;
        }

        <span class="hljs-keyword">public</span> Thread <span class="hljs-title function_">newThread</span><span class="hljs-params">(Runnable r)</span> {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(group, r,
                                  namePrefix + threadNumber.getAndIncrement(),
                                  <span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (t.isDaemon())
                t.setDaemon(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)
                t.setPriority(Thread.NORM_PRIORITY);
            <span class="hljs-keyword">return</span> t;
        }
    }
</code></pre>
<h5 data-id="heading-8">2.4.拒绝策略【A-C-D-D】 （在阻塞队列达到最大值，而且线程数也达到最大值了，线程池无法再处理新提交过来的任务，此时使用拒绝策略）</h5>
<ul>
<li>AbortPolicy   默认策略，抛出异常，终止任务</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AbortPolicy</span> <span class="hljs-title">implements</span> <span class="hljs-title">RejectedExecutionHandler</span> {
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbortPolicy</span>()</span> { }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rejectedExecution</span>(<span class="hljs-params">Runnable r, ThreadPoolExecutor e</span>)</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RejectedExecutionException(<span class="hljs-string">"Task "</span> + r.toString() +
                                                 <span class="hljs-string">" rejected from "</span> +
                                                 e.toString());
        }
    }
</code></pre>
<ul>
<li>CallerRunsPolicy  是使用当前提交任务的线程来执行任务</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CallerRunsPolicy</span> <span class="hljs-title">implements</span> <span class="hljs-title">RejectedExecutionHandler</span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CallerRunsPolicy</span>()</span>{ }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rejectedExecution</span>(<span class="hljs-params">Runnable r , ThreadPoolExecutor e</span>)</span>{
         <span class="hljs-keyword">if</span>(!e.shutdown()){
             r.run();<span class="hljs-comment">//当前提交任务的线程来执行任务</span>
        }
    }
}
</code></pre>
<ul>
<li>DiscardPolicy  什么都不做，直接丢弃任务</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DiscardPolicy</span> <span class="hljs-title">implements</span> <span class="hljs-title">RejectExecutionHandler</span>{
       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DiscardPolicy</span>()</span>{}
       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rejectExecution</span>(<span class="hljs-params">Runnable r, ThreadPoolExecutor e</span>)</span>{ <span class="hljs-comment">//do nothing</span>
       }
  }
</code></pre>
<ul>
<li>DiscardOldestPolicy 丢弃最先放入队列的任务，然后将当前任务提交到线程池</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">public static class DiscardOldestPolicy implements RejectExecutionHandler{
       public <span class="hljs-built_in">DiscardOldestPolicy</span>(){}
       public void <span class="hljs-built_in">rejectExecution</span>(Runnable r, ThreadPoolExecutor e){
                 <span class="hljs-built_in">if</span>(!e.isShutdown()){
                     e<span class="hljs-selector-class">.getQueue</span>()<span class="hljs-selector-class">.poll</span>();
                     e<span class="hljs-selector-class">.execute</span>(r);
                  }
       }
}
</code></pre>
<h3 data-id="heading-9">3.线程池源码解析</h3>
<h5 data-id="heading-10">3.1.创建的线程池具体配置为：核心线程数量为5个；全部线程数量为10个；工作队列的长度为5。</h5>
<h5 data-id="heading-11">3.2.我们通过queue.size()的方法来获取工作队列中的任务数。</h5>
<h5 data-id="heading-12">3.3.线程池原理分析.</h5>
<p>当向线程池提交一个任务时，首先判断当前正在工作的线程数是否&gt;=核心线程数，如果小于核心线程数，那么创建新的线程，达到核心线程数量5个后，新的任务进来后不再创建新的线程，而是将任务加入工作队列，任务队列到达上线5个后，新的任务又会创建新的普通线程，直到达到线程池最大的线程数量10个，后面的任务则根据配置的饱和策略来处理。我们这里没有具体配置，使用的是默认的配置AbortPolicy:直接抛出异常。当然，为了达到我需要的效果，上述线程处理的任务都是利用休眠导致线程没有释放！！！
#####3.4.线程池的核心线程会被回收吗？
默认情况下，线程池的核心线程是不会被回收的，即使他们处于空闲状态。这样可以避免频繁的创建线程，节省系统开销。当设置allowCoreThreadTimeCount(true)，核心线程在空闲时超过keepAliveTime时，会被回收.</p>
<h5 data-id="heading-13">3.5.线程池源码分析</h5>
<h5 data-id="heading-14">3.5.1.核心接口和类</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/838db2c371e74480b7e1edb44dd6cc97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXNtZXdpbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770286933&amp;x-signature=O2YIYp3%2FYgHfEVh2sXFk%2Fxvw%2F6Y%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-15">Executor</h5>
<p>Executor接口只是定义了一个基础的execute方法.</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">Executor</span>{
     <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">execute</span>(<span class="hljs-params">Runnable</span>)</span>;
}
</code></pre>
<h5 data-id="heading-16">ExecutorService</h5>
<p>ExecutorService接口定义了线程池的一些常用操作.</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ExecutorService</span> <span class="hljs-title">extends</span> <span class="hljs-title">Executor</span>{

     <span class="hljs-comment">// 终止线程池，不再接受新任务，会将任务队列的任务执行完成</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">shutdown</span>()</span>;
    <span class="hljs-comment">//立即终止线程池，任务队列的任务不在执行，返回未执行任务集合.</span>
    <span class="hljs-function">List&lt;Runnable&gt; <span class="hljs-title">shutdownNow</span>()</span>;
   <span class="hljs-comment">//判断线程池是否停掉，只要线程池不是RUNNING状态，都会返回true</span>
   <span class="hljs-function">boolean <span class="hljs-title">isShutdown</span>()</span>;
   <span class="hljs-comment">//判断线程池是否完成终止，状态是TERMINATED</span>
   <span class="hljs-function">boolean <span class="hljs-title">isTerminated</span>()</span>;
  <span class="hljs-comment">//提交Runnable任务，返回Future,Future的get方法返回值就是result参数.//get方法会阻塞当前线程</span>
  &lt;T&gt; <span class="hljs-function">Future&lt;T&gt; <span class="hljs-title">submit</span>(<span class="hljs-params">Runnable task,T result</span>)</span>;
 <span class="hljs-comment">//提交Rennable任务，返回Future,Future的get方法返回值就是null.//get方法会阻塞当前线程</span>
  Future&lt;?&gt; submit(Runnable task);

}
</code></pre>
<h5 data-id="heading-17">AbstractExecutorService</h5>
<p>AbstractExecutorService是一个抽象类，实现了接口的一些方法，未实现的方法继续留给子类实现.</p>
<pre><code class="hljs language-scss" lang="scss">public abstract class AbstractExecutorService implement  ExecutorService{
         <span class="hljs-comment">//提交Runnalbe任务，返回Future,Future的get方法返回值是null//get方法会阻塞当前线程</span>
        public Future&lt;?&gt; <span class="hljs-built_in">submit</span>(Runnable task) {
                if (task == null) {
                    throw new <span class="hljs-built_in">NullPointerException</span>();
               }
              RunnableFuture&lt;Void&gt; ftask = <span class="hljs-built_in">newTaskFor</span>(task, null);
              <span class="hljs-built_in">execute</span>(ftask);<span class="hljs-comment">//真正执行任务的是子类实现的execute方法</span>
              return ftask;
       }
       <span class="hljs-comment">//提交Runnable任务，返回Future，Future的get方法返回值是result参数.//get方法会阻塞当前线程</span>
      public &lt;T&gt; Future&lt;T&gt; <span class="hljs-built_in">submit</span>(Runnable task, T result) {
           if (task == null) throw new <span class="hljs-built_in">NullPointerException</span>();
           RunnableFuture&lt;T&gt; ftask = <span class="hljs-built_in">newTaskFor</span>(task, result);
           <span class="hljs-built_in">execute</span>(ftask);<span class="hljs-comment">//真正执行任务的是子类实现的execute方法</span>
           return ftask;
      }
 
}
</code></pre>
<h5 data-id="heading-18">任务执行</h5>
<pre><code class="hljs language-scss" lang="scss">public class ThreadPoolExecutor extends AbstractExecutorService {
      public void <span class="hljs-built_in">execute</span>(Runnable command) {
        if (command == null)
            throw new <span class="hljs-built_in">NullPointerException</span>();
   
        int c = ctl<span class="hljs-selector-class">.get</span>();
      <span class="hljs-comment">//1.判断工作线程数是否核心线程数</span>
        if (workerCountOf(c) &lt; corePoolSize) {
            <span class="hljs-comment">//2.添加工作线程执行任务</span>
            if (addWorker(command, true))
                return;
            c = ctl<span class="hljs-selector-class">.get</span>();
        }
         <span class="hljs-comment">//3.线程池为Running状态且任务添加到阻塞队列成功</span>
        if (isRunning(c) &amp;&amp; workQueue<span class="hljs-selector-class">.offer</span>(command)) {
            int recheck = ctl<span class="hljs-selector-class">.get</span>();
            if (! isRunning(recheck) &amp;&amp; <span class="hljs-built_in">remove</span>(command))
                <span class="hljs-built_in">reject</span>(command);
            else if (workerCountOf(recheck) == <span class="hljs-number">0</span>)
                <span class="hljs-built_in">addWorker</span>(null, false);<span class="hljs-comment">//添加工作线程执行任务</span>
        }
        <span class="hljs-comment">//4.队列满了，达到最大线程数之后，就会走拒绝策略，addWorker()返回值就是false</span>
        else if (!addWorker(command, false))
            <span class="hljs-built_in">reject</span>(command);
    }
}
</code></pre>
<h5 data-id="heading-19">添加工作线程</h5>
<ul>
<li>第一阶段：设置ctl的线程数+1，主要是判断线程池状态以及线程数是否超限，然后对ctrl的线程数加1。</li>
<li>第二阶段：创建一个线程并启动执行，将创建的工作线程类Worker放入线程池工作线程集合里并启动，另外，如果出现异常情况，就走finally{}，移除工作线程Worker，并执行ctl的线程数减1.</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"> private final HashSet&lt;Worker&gt; <span class="hljs-attr">workers</span> = new HashSet&lt;&gt;()<span class="hljs-comment">; //线程池工作线程集合</span>
private boolean addWorker(Runnable firstTask, boolean core) {
        retry:
        for (int <span class="hljs-attr">c</span> = ctl.get()<span class="hljs-comment">;;) {</span>
  
            for (<span class="hljs-comment">;;) {</span>
                //如果是核心线程 ，线程池中工作线程总数&gt;=corePoolSize，返回false
              //如果是非核心线程 ，线程池中工作线程总数&gt;=maximumPoolSize，返回false
                if (workerCountOf(c)&gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK))
                    return false<span class="hljs-comment">;</span>
                //设置ctl的线程数+1，跳出整个for循环
                if (compareAndIncrementWorkerCount(c))
                    break retry<span class="hljs-comment">; //跳出retry  for循环</span>
            }
        }
       //以上只是将ctl的线程数+1了，以下是真正的创建一个工作线程
        boolean <span class="hljs-attr">workerStarted</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        boolean <span class="hljs-attr">workerAdded</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        Worker <span class="hljs-attr">w</span> = null<span class="hljs-comment">;</span>
        try {
           //Worker构造方法中会使用ThreadFactory创建一个新线程
            <span class="hljs-attr">w</span> = new Worker(firstTask)<span class="hljs-comment">; </span>
            final Thread <span class="hljs-attr">t</span> = w.thread<span class="hljs-comment">;</span>
            if (t != null) {
                // 创建工作线程时，需要加锁，防止其他线程并发操作。
                final ReentrantLock <span class="hljs-attr">mainLock</span> = this.mainLock<span class="hljs-comment">;</span>
                mainLock.lock()<span class="hljs-comment">;</span>
                try {
                    int <span class="hljs-attr">c</span> = ctl.get()<span class="hljs-comment">;</span>
                    if (isRunning(c) ||
                        (runStateLessThan(c, STOP) &amp;&amp; <span class="hljs-attr">firstTask</span> == null)) {
                        if (t.getState() != Thread.State.NEW)
                            throw new IllegalThreadStateException()<span class="hljs-comment">;</span>
                        workers.add(w)<span class="hljs-comment">; //并将Worker放入工作线程集合里</span>
                        <span class="hljs-attr">workerAdded</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                        int <span class="hljs-attr">s</span> = workers.size()<span class="hljs-comment">;</span>
                       // 这里就是标记线程池里创建线程的最大值，这个值最大也不会超过maximumPoolSize。
                        if (s &gt; largestPoolSize)
                            <span class="hljs-attr">largestPoolSize</span> = s<span class="hljs-comment">;</span>
                    }
                } finally {
                    mainLock.unlock()<span class="hljs-comment">;//释放锁</span>
                }
                if (workerAdded) {
                    t.start()<span class="hljs-comment">; //启动工作线程&gt;&gt;Worker.run()&gt;&gt;runWorker()&gt;&gt;firstTask.run()</span>
                    <span class="hljs-attr">workerStarted</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                }
            }
        } finally {
            if (! workerStarted)
                addWorkerFailed(w)<span class="hljs-comment">;</span>
        }
        return workerStarted<span class="hljs-comment">;</span>
 }

//如果添加子线程工作流程失败，
private void addWorkerFailed(Worker w) {
    final ReentrantLock <span class="hljs-attr">mainLock</span> = this.mainLock<span class="hljs-comment">;</span>
	// 涉及工作线程的相关操作都需要加锁
    mainLock.lock()<span class="hljs-comment">;</span>
    try {
        // 从工作线程集合里移除worker
        if (w != null)
            workers.remove(w)<span class="hljs-comment">;</span>
        // cas操作ctl线程数减1
        decrementWorkerCount()<span class="hljs-comment">;</span>
        // 判断是否需要终止线程池
        tryTerminate()<span class="hljs-comment">;</span>
    } finally {
        mainLock.unlock()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-20">工作线程类Worker</h5>
<p>Worker类是具体的工作线程类，持有一个Thread线程和一个Runnable任务实例，并实现了Runnable接口.</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractQueuedSynchronizer</span> <span class="hljs-title">implements</span> <span class="hljs-title">Runnable</span> </span>{
   <span class="hljs-comment">// Worker的Thread属性，其实干活的就是这个线程</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Thread</span> thread;
    <span class="hljs-comment">// 任务</span>
    <span class="hljs-type">Runnable</span> firstTask;
    <span class="hljs-comment">// 线程已经执行完成的任务总数</span>
    volatile long completedTasks;
	
   <span class="hljs-comment">// 构造方法</span>
    <span class="hljs-type">Worker</span>(<span class="hljs-type">Runnable</span> firstTask) {
        setState(<span class="hljs-number">-1</span>); <span class="hljs-comment">// inhibit interrupts until runWorker</span>
        <span class="hljs-keyword">this</span>.firstTask = firstTask;
        <span class="hljs-comment">// 线程执行时调用的就是Worker.run() &gt;&gt;runWorker()&gt;&gt;firstTask.run()</span>
         <span class="hljs-comment">//使用线程工程批量创建线程.</span>
        <span class="hljs-keyword">this</span>.thread = getThreadFactory().newThread(<span class="hljs-keyword">this</span>);
    }
    <span class="hljs-comment">// run方法执行任务，调用的是外部ThreadPoolExecutor的runWorker方法</span>
    public void run() {
        runWorker(<span class="hljs-keyword">this</span>);
    }
}
</code></pre>
<h5 data-id="heading-21">执行任务runWorker</h5>
<pre><code class="hljs language-ini" lang="ini">  final void runWorker(Worker w) {
        Thread <span class="hljs-attr">wt</span> = Thread.currentThread()<span class="hljs-comment">;</span>
        Runnable <span class="hljs-attr">task</span> = w.firstTask<span class="hljs-comment">;</span>
        <span class="hljs-attr">w.firstTask</span> = null<span class="hljs-comment">;</span>
        w.unlock()<span class="hljs-comment">; // allow interrupts</span>
        boolean <span class="hljs-attr">completedAbruptly</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        try {
            while (task != null || (<span class="hljs-attr">task</span> = getTask()) != null) {
                w.lock()<span class="hljs-comment">;</span>
                if ((runStateAtLeast(ctl.get(), STOP) ||
                     (Thread.interrupted() &amp;&amp;
                      runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                    !wt.isInterrupted())
                    wt.interrupt()<span class="hljs-comment">;</span>
                try {
                    beforeExecute(wt, task)<span class="hljs-comment">;</span>
                    try {
                        task.run()<span class="hljs-comment">; //执行任务</span>
                        afterExecute(task, null)<span class="hljs-comment">;</span>
                    } catch (Throwable ex) {
                        afterExecute(task, ex)<span class="hljs-comment">;</span>
                        throw ex<span class="hljs-comment">;</span>
                    }
                } finally {
                    <span class="hljs-attr">task</span> = null<span class="hljs-comment">;</span>
                    w.completedTasks++<span class="hljs-comment">;</span>
                    w.unlock()<span class="hljs-comment">;</span>
                }
            }
            <span class="hljs-attr">completedAbruptly</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        } finally {
            processWorkerExit(w, completedAbruptly)<span class="hljs-comment">;</span>
        }
    }

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RBAC 权限系统实战（一）：页面级访问控制全解析]]></title>    <link>https://juejin.cn/post/7600600904094842914</link>    <guid>https://juejin.cn/post/7600600904094842914</guid>    <pubDate>2026-01-29T10:56:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600600904094842914" data-draft-id="7600600904094826530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RBAC 权限系统实战（一）：页面级访问控制全解析"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-29T10:56:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="十五丶"/> <meta itemprop="url" content="https://juejin.cn/user/343495027727229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RBAC 权限系统实战（一）：页面级访问控制全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/343495027727229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    十五丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:56:23.000Z" title="Thu Jan 29 2026 10:56:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本篇文章主要讲解 RBAC 权限方案在中后台管理系统的实现</p>
<p>在公司内部写过好几个后台系统，都需要实现权限控制，在职时工作繁多，没有系统性的来总结一下相关经验，现在人已离职，就把自己的经验总结一下，希望能帮助到你</p>
<blockquote>
<p>本文是<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2FBlog%3Ftab%3Dreadme-ov-file%23%25E9%2580%259A%25E4%25BF%2597%25E6%2598%2593%25E6%2587%2582%25E7%259A%2584%25E4%25B8%25AD%25E5%2590%258E%25E5%258F%25B0%25E7%25B3%25BB%25E7%25BB%259F%25E5%25BB%25BA%25E8%25AE%25BE%25E6%258C%2587%25E5%258D%2597%25E4%25B8%2593%25E6%25A0%258F" target="_blank" title="https://github.com/bryqiu/Blog?tab=readme-ov-file#%E9%80%9A%E4%BF%97%E6%98%93%E6%87%82%E7%9A%84%E4%B8%AD%E5%90%8E%E5%8F%B0%E7%B3%BB%E7%BB%9F%E5%BB%BA%E8%AE%BE%E6%8C%87%E5%8D%97%E4%B8%93%E6%A0%8F" ref="nofollow noopener noreferrer">《通俗易懂的中后台系统建设指南》</a>系列的第九篇文章，该系列旨在告诉你如何来构建一个优秀的中后台管理系统</p>
</blockquote>
<h2 data-id="heading-1">权限模型有哪些？</h2>
<p>主流的权限模型主要分为以下五种：</p>
<ul>
<li>ACL模型：访问控制列表</li>
<li>DAC模型：自主访问控制</li>
<li>MAC模型：强制访问控制</li>
<li>ABAC模型：基于属性的访问控制</li>
<li>RBAC模型：基于角色的权限访问控制</li>
</ul>
<p>这里不介绍全部的权限模型，有兴趣你可以看看这篇文章：<a href="https://juejin.cn/post/7121977695197970463" target="_blank" title="https://juejin.cn/post/7121977695197970463">权限系统就该这么设计，yyds</a></p>
<p>如果你看过、用过市面上一些开源后台系统及权限设计，你会发现它们主要都是基于 RBAC 模型来实现的</p>
<h2 data-id="heading-2">为什么是 RBAC 权限模型？</h2>
<p>好问题！我帮你问了下 AI</p>



































<table><thead><tr><th align="left">对比维度</th><th align="left">ACL (访问控制列表)</th><th align="left">RBAC (基于角色)</th><th align="left">ABAC (基于属性)</th></tr></thead><tbody><tr><td align="left"><strong>核心逻辑</strong></td><td align="left"><strong>用户 ↔ 权限</strong><br/>直接点对点绑定，无中间层</td><td align="left"><strong>用户 ↔ 角色 ↔ 权限</strong><br/>引入“角色”解耦，权限归于角色</td><td align="left"><strong>属性 + 规则 = 权限</strong><br/>动态计算 (Who, When, Where)</td></tr><tr><td align="left"><strong>优点</strong></td><td align="left">模型极简，开发速度快，适合初期 MVP</td><td align="left">结构清晰，<strong>复用性高</strong>，符合企业组织架构，维护成本低</td><td align="left">极度灵活，支持细粒度控制<br/>(如：只能在工作日访问)</td></tr><tr><td align="left"><strong>缺点</strong></td><td align="left">用户量大时维护工作呈指数级增长，极易出错</td><td align="left"><strong>角色爆炸</strong>：若特例过多，可能导致定义成百上千个角色</td><td align="left">开发复杂度极高，规则引擎难设计，有一定的性能消耗</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">个人博客、小型内部工具</td><td align="left"><strong>中大型后台系统、SaaS 平台 (行业标准)</strong></td><td align="left">银行风控、AWS IAM、国家安全级系统</td></tr></tbody></table>
<p>总结来说，在后台系统的场景下，RBAC 模型在灵活性（对比ACL）和复杂性（对比ABAC）上取得了一个很好的平衡</p>
<h2 data-id="heading-3">RBAC 概念理解</h2>
<p>RBAC 权限模型，全称 Role-Based Access Control，基于角色的权限访问控制</p>
<p>模型有三要素：</p>
<ul>
<li>用户（User）：系统主体，即操作系统的具体人员或账号</li>
<li>角色（Role）：角色是一组权限的集合，代表了用户在组织中的职能或身份</li>
<li>权限（Permission）：用户可以对系统资源进行的访问或操作能力</li>
</ul>
<p>RBAC 的设计是将角色绑定权限，用户绑定角色，从而实现权限控制</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/477cc8185d0244aaa6a073d8313920c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=6fTTIUFMJOrZGOxj7nfS%2BhqLnJg%3D" alt="image.png" loading="lazy"/></p>
<p>并且，它们之间的逻辑关系通常是多对多的：</p>
<p><strong>用户 - 角色 (User-Role)：</strong> 一个用户可以拥有多个角色（例如：某人既是“项目经理”又是“技术委员会成员”）</p>
<p><strong>角色 - 权限(Role-Permission)：</strong> 一个角色包含多个权限（例如：“人事经理”角色拥有“查看员工”、“编辑薪资”等权限）</p>
<h2 data-id="heading-4">主导权限控制的前端、后端方案</h2>
<p>市面上这些开源 Admin 的权限控制中，存在两种主要的权限主导方案：前端主导的权限方案和后端主导的权限方案</p>
<h3 data-id="heading-5">前端主导的权限方案</h3>
<p>前端主导的权限方案，一个主要的特征是菜单数据由前端维护，而不是存在数据库中</p>
<p>后端只需要在登录后给到用户信息，这个信息中会包含用户的角色，根据这个角色信息，前端可以筛选出具有权限的菜单、按钮</p>
<p>这种方案的主要逻辑放在前端，而不是后端数据库，所以安全性没保障，灵活性也较差，要更新权限，就需要改动前端代码并重新打包上线，无法支持“动态配置权限”</p>
<p>适合一些小型、简单系统</p>
<h3 data-id="heading-6">后端主导的权限方案</h3>
<p>后端控制方案，即登录后在返回用户信息时，还会给到此用户对应的菜单数据和按钮权限码等</p>
<p>菜单数据、按钮权限码等都存在数据库，这样一来，安全性、灵活性更高，要更新权限数据或用户权限控制，提供相应接口即可修改</p>
<blockquote>
<p>倒也不是说前端完全不用管菜单数据，而是前端只需要维护一些静态菜单数据，比如登录页、异常页(404、403...)</p>
</blockquote>
<p>在企业级后台系统中，后端主导的权限方案是比较常用的，本文只介绍后端主导的权限方案</p>
<h2 data-id="heading-7">权限方案整体流程</h2>
<p>在开始写代码之前，要清晰知道整体实现流程，我画了一张图来直观展示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24d25fc5a24b446eb3b46d1109e688ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=X8GZE0WmhkV99y%2BwVUpesaS5Fmc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">后台系统中的 RBAC 权限实战</h2>
<h3 data-id="heading-9">权限菜单类型定义</h3>
<p>首先，在前后端人员配合中，我们最好约定一套菜单数据的结构，比如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteMeta</span>, <span class="hljs-title class_">RouteRecordRaw</span>, <span class="hljs-title class_">RouteRecordRedirectOption</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">DefineComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'#/type'</span>;

<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomRouteRecordRaw</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">RouteRecordRaw</span>, 'meta'&gt; {
    <span class="hljs-comment">/**
     * 路由地址
     */</span>
    path?: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 路由名称
     */</span>
    name?: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 重定向路径
     */</span>
    redirect?: <span class="hljs-title class_">RouteRecordRedirectOption</span>;
    <span class="hljs-comment">/**
     * 组件
     */</span>
    component?: <span class="hljs-title class_">Component</span> | <span class="hljs-title class_">DefineComponent</span> | (<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">unknown</span>&gt;);
    <span class="hljs-comment">/**
     * 子路由信息
     */</span>
    children?: <span class="hljs-title class_">CustomRouteRecordRaw</span>[];
    <span class="hljs-comment">/**
     * 路由类型
     */</span>
    <span class="hljs-keyword">type</span>?: <span class="hljs-title class_">RouteType</span>;
    <span class="hljs-comment">/**
     * 元信息
     */</span>
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-comment">/**
       * 菜单标题
       */</span>
      <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-comment">/**
       * 菜单图标
       */</span>
      menuIcon?: <span class="hljs-built_in">string</span>;
      <span class="hljs-comment">/**
       * 排序
       */</span>
      sort?: <span class="hljs-built_in">number</span>;
      <span class="hljs-comment">/**
       * 是否在侧边栏菜单中隐藏
       * <span class="hljs-doctag">@default</span> <span class="hljs-variable">false</span>
       */</span>
      hideMenu?: <span class="hljs-built_in">boolean</span>;
      <span class="hljs-comment">/**
       * 是否在面包屑中隐藏
       * <span class="hljs-doctag">@default</span> <span class="hljs-variable">false</span>
       */</span>
      hideBreadcrumb?: <span class="hljs-built_in">boolean</span>;
      <span class="hljs-comment">/**
       * 当只有一个子菜单时，是否隐藏父级菜单直接显示子菜单内容
       * <span class="hljs-doctag">@default</span> <span class="hljs-variable">false</span>
       */</span>
      hideParentIfSingleChild?: <span class="hljs-built_in">boolean</span>;
    };
  }

  <span class="hljs-comment">/**
   * 后端返回的权限路由类型定义
   */</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">PermissionRoute</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">CustomRouteRecordRaw</span>, <span class="hljs-string">'component'</span> | <span class="hljs-string">'children'</span> | <span class="hljs-string">'type'</span>&gt; &amp; {
    <span class="hljs-comment">/**
     * 路由ID
     */</span>
    id?: <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">/**
     * 路由父ID
     */</span>
    parentId?: <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">/**
     * 组件路径（后端返回时为字符串，前端处理后为组件）
     */</span>
    <span class="hljs-attr">component</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 子路由信息
     */</span>
    children?: <span class="hljs-title class_">PermissionRoute</span>[];
    <span class="hljs-comment">/**
     * 路由类型
     */</span>
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">RouteType</span>;
  };
}

</code></pre>
<blockquote>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Ftypings%2Frouter.d.ts" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/typings/router.d.ts" ref="nofollow noopener noreferrer">router.d.ts</a> 找到类型文件</p>
</blockquote>
<p>以上面的类型定义为例，我们约定 <code>PermissionRoute</code> 类型是后端返回的权限路由类型：</p>
<p>我这里使用 ApiFox 来 Mock 权限路由数据，数据是这样的：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fclean-admin.apifox.cn%2F" target="_blank" title="https://clean-admin.apifox.cn/" ref="nofollow noopener noreferrer">clean-admin ApiFox 文档在线地址</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d472ebe0289417aab9114ab52c82a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=533qsuaKRIxS%2Bvb0FxFeUHlz7Mo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">从登录页到路由守卫</h3>
<p>权限方案的第一步，是登录并拿到用户信息</p>
<p>假设我们现在用 Element Plus 搭建起了一个登录页面，当用户点击登录时，我们需要做这几件事：</p>
<ol>
<li>调用登录接口，将账号、密码发送给后端进行验证，验证通过则返回 JWT 信息</li>
<li>将返回的 JWT 信息保存到本地，后续每次请求都携带 Token 来识别用户身份并决定你能拿到的权限路由数据</li>
<li>触发路由守卫拦截</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d1195e632f74c2aa508c623555734ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=f%2FsehCMd98KQLSHYFgN9fuwg2Qg%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Fviews%2Fauth%2Fpage%2Faccount-login.vue" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/views/auth/page/account-login.vue" ref="nofollow noopener noreferrer">account-login.vue</a> 找到全部代码</p>
</blockquote>
<h3 data-id="heading-11">基本 Vue Router 配置</h3>
<p>登录完成后，我们就可以触发路由守卫了，但在写路由守卫之前，我们先来配置一下基本的 Vue Router</p>
<p>在整个权限系统中，我们将路由数据分为两种：</p>
<ol>
<li>静态路由：系统固定的路由，比如登录页、异常页(404、403...)</li>
<li>动态路由：由后端接口返回的用户角色对应的菜单路由数据</li>
</ol>
<p>静态路由是直接由前端定义，不会从后端接口返回、不会根据用户角色动态变化，所以这部分路由我们直接写好然后注册到 Vue Router 中即可</p>
<p>Vue Router 配置：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteRecordRaw</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">App</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ImportGlobRoutes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./typing'</span>;
<span class="hljs-keyword">import</span> { extractRoutes } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helpers'</span>;
<span class="hljs-keyword">import</span> { afterEachGuard, beforeEachGuard } <span class="hljs-keyword">from</span> <span class="hljs-string">'./guards'</span>;

<span class="hljs-comment">/** 静态路由 */</span>
<span class="hljs-keyword">const</span> staticRoutes = <span class="hljs-title function_">extractRoutes</span>(
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">glob</span>&lt;<span class="hljs-title class_">ImportGlobRoutes</span>&gt;([<span class="hljs-string">'./modules/constant-routes/**/*.ts'</span>], {
    <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span>,
  }),
);

<span class="hljs-comment">/** 系统路由 */</span>
<span class="hljs-keyword">const</span> systemRoutes = <span class="hljs-title function_">extractRoutes</span>(
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">glob</span>&lt;<span class="hljs-title class_">ImportGlobRoutes</span>&gt;([<span class="hljs-string">'./modules/system-routes/**/*.ts'</span>], {
    <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span>,
  }),
);

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(),
  <span class="hljs-attr">routes</span>: [...staticRoutes, ...systemRoutes] <span class="hljs-keyword">as</span> <span class="hljs-title class_">RouteRecordRaw</span>[],
  <span class="hljs-attr">strict</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">scrollBehavior</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">0</span> }),
});

<span class="hljs-title function_">beforeEachGuard</span>(router);
<span class="hljs-title function_">afterEachGuard</span>(router);

<span class="hljs-comment">/** 初始化路由 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initRouter</span>(<span class="hljs-params">app: App&lt;Element&gt;</span>) {
  app.<span class="hljs-title function_">use</span>(router);
}

<span class="hljs-keyword">export</span> { router, initRouter, staticRoutes };

</code></pre>
<blockquote>
<p>图中的静态路由和系统路由是同一类路由数据，即静态路由</p>
</blockquote>
<p>这个配置文件可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Frouter%2Findex.ts" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/router/index.ts" ref="nofollow noopener noreferrer">router/index.ts</a> 找到</p>
<p>这个基本的 Vue Router 配置，做了这么几件事：</p>
<ol>
<li>导入 <code>modules</code> 文件夹下的静态路由进行注册</li>
<li>路由初始化配置 <code>initRouter</code> ，在 <code>main.ts</code> 中调用</li>
<li>注册全局前置守卫 <code>beforeEach</code>、全局后置守卫 <code>afterEach</code></li>
</ol>
<p>我们实现动态路由注册的逻辑就写在 <code>beforeEach</code> 中</p>
<p>值得一提的是，使用了 <code>import.meta.glob</code> 来动态导入指定路径下的文件模块，这是 <code>Vite</code> 提供的一种导入方式，参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vite.dev%2Fguide%2Ffeatures%23glob-import" target="_blank" title="https://cn.vite.dev/guide/features#glob-import" ref="nofollow noopener noreferrer">Vite Glob 导入</a></p>
<h3 data-id="heading-12">路由守卫与动态注册</h3>
<p>路由守卫是 Vue Router 提供的一种机制，主要用来通过跳转或取消的方式守卫导航：<a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fguide%2Fadvanced%2Fnavigation-guards.html" target="_blank" title="https://router.vuejs.org/zh/guide/advanced/navigation-guards.html" ref="nofollow noopener noreferrer">Vue Router 路由守卫</a></p>
<p>重头戏在全局前置守卫 <code>router.beforeEach</code> 中实现，来看看我们做哪些事：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">ROUTE_NAMES</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../config'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteRecordNameGeneric</span>, <span class="hljs-title class_">RouteRecordRaw</span>, <span class="hljs-title class_">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> { getLocalAccessToken } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/permission'</span>;
<span class="hljs-keyword">import</span> { userService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/services/api'</span>;
<span class="hljs-keyword">import</span> { nprogress } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helpers'</span>;
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-comment">/** 登录认证页面：账号登录页、短信登录页、二维码登录页、忘记密码页、注册页... */</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">authPages</span>: <span class="hljs-title class_">RouteRecordNameGeneric</span>[] = [
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">AUTH</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">ACCOUNT_LOGIN</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">SMS_LOGIN</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">QR_LOGIN</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">FORGOT_PASSWORD</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">REGISTER</span>,
];

<span class="hljs-comment">/** 页面白名单：不需要登录也能访问的页面 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">pageWhiteList</span>: <span class="hljs-title class_">RouteRecordNameGeneric</span>[] = [...authPages];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">beforeEachGuard</span>(<span class="hljs-params">router: Router</span>) {
  router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> (to) =&gt; {
    <span class="hljs-comment">/** 进度条：开始 */</span>
    nprogress.<span class="hljs-title function_">start</span>();

    <span class="hljs-keyword">const</span> { <span class="hljs-attr">name</span>: <span class="hljs-title class_">RouteName</span> } = to;

    <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();
    <span class="hljs-keyword">const</span> { getAccessToken, getRoutesAddStatus, registerRoutes } = <span class="hljs-title function_">storeToRefs</span>(userStore);
    <span class="hljs-keyword">const</span> { setRoutesAddStatus, setUserInfo, logout } = userStore;

    <span class="hljs-comment">/** 访问令牌 */</span>
    <span class="hljs-keyword">const</span> accessToken = getAccessToken.<span class="hljs-property">value</span> || <span class="hljs-title function_">getLocalAccessToken</span>();

    <span class="hljs-comment">// 1.用户未登录（无 Token）</span>
    <span class="hljs-keyword">if</span> (!accessToken) {
      <span class="hljs-keyword">const</span> isWhitePage = pageWhiteList.<span class="hljs-title function_">includes</span>(<span class="hljs-title class_">RouteName</span>);
      <span class="hljs-comment">// 1.1 未登录，如果访问的是白名单中的页面，直接放行</span>
      <span class="hljs-keyword">if</span> (isWhitePage) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

      nprogress.<span class="hljs-title function_">done</span>();

      <span class="hljs-comment">// 1.2 未登录又不在白名单，则拦截并重定向到登录页</span>
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">ACCOUNT_LOGIN</span> };
    }

    <span class="hljs-comment">// 如果已登录用户试图访问登录页，避免重复登录，要强制重定向到首页</span>
    <span class="hljs-keyword">if</span> (authPages.<span class="hljs-title function_">includes</span>(<span class="hljs-title class_">RouteName</span>)) {
      nprogress.<span class="hljs-title function_">done</span>();
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">ROOT</span> };
    }

    <span class="hljs-comment">// 判断是否需要动态加载路由的操作</span>
    <span class="hljs-keyword">if</span> (!getRoutesAddStatus.<span class="hljs-property">value</span>) {
      <span class="hljs-comment">// isRoutesAdded 默认为 false（未持久化），在已经动态注册过时会设置为true，在页面刷新时会重置为 false</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1.拉取用户信息</span>
        <span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> userService.<span class="hljs-title function_">getUserInfo</span>();

        <span class="hljs-comment">// 2.将用户信息存入 Store</span>
        <span class="hljs-title function_">setUserInfo</span>(userInfo);

        <span class="hljs-comment">// 3.动态注册路由，registerRoutes 是处理后的路由表</span>
        registerRoutes.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> {
          router.<span class="hljs-title function_">addRoute</span>(route <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">RouteRecordRaw</span>);
        });

        <span class="hljs-comment">// 4.标记路由已添加</span>
        <span class="hljs-title function_">setRoutesAddStatus</span>(<span class="hljs-literal">true</span>);

        <span class="hljs-comment">// 5.中断当前导航，重新进入守卫</span>
        <span class="hljs-keyword">return</span> { ...to, <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> };
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 获取用户信息失败（如 Token 过期失效、网络异常）</span>
        <span class="hljs-title function_">logout</span>();
        nprogress.<span class="hljs-title function_">done</span>();
        <span class="hljs-comment">// 重定向回登录页，让用户重新登录</span>
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">ACCOUNT_LOGIN</span> };
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
}

</code></pre>
<blockquote>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Frouter%2Fguards%2Fbefore-each-guard.ts" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/router/guards/before-each-guard.ts" ref="nofollow noopener noreferrer">before-each-guard.ts</a> 找到全部代码</p>
</blockquote>
<p>上面的代码已经给出了很详细的注释，从整体角度来讲，我们做了两件事：</p>
<ol>
<li>处理一些情况，比如用户未登录、登录后访问登录页、白名单等情况</li>
<li>拉取用户信息，动态注册路由</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52a61b13fbbd43698183f2e65dee3b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=bEbJ33PHj4SjT%2BBG4X%2BVC942%2BOA%3D" alt="image.png" loading="lazy"/></p>
<p>在路由守卫中“拉取用户信息”，一般来说，除了返回用户本身的信息外，还会给到权限路由信息、权限码信息，这里的数据结构可以跟后端进行约定</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e69f7c3abe341d4b51f2033820b757e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=ciXyPsIRKCJK%2BwXwvHogFOQlqBg%3D" alt="image.png" loading="lazy"/></p>
<p>比如在 vue-clean-admin 中，返回的数据结构是这样的：</p>
<blockquote>
<p>在 ApiFox 文档可以找到用户接口说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclean-admin.apifox.cn%2F336121333e0" target="_blank" title="https://clean-admin.apifox.cn/336121333e0" ref="nofollow noopener noreferrer">ApiFox 文档 - 用户信息</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a1983f04833498ca8738fd8e027677c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=TEQWMgkv5Yb42BKazc%2BroN1epGE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">后端路由结构的转化</h3>
<p>在通过“拉取用户信息”拿到路由数据后，并不是直接注册到 Vue Router，而是需要进行处理转化，才能符合 Vue Router 定义的路由表结构，<code>registerRoutes</code> 就是处理后的路由表，处理后的类型定义可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Ftypings%2Frouter.d.ts%23L7-L64" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/typings/router.d.ts#L7-L64" ref="nofollow noopener noreferrer"><code>CustomRouteRecordRaw</code></a></p>
<p>处理什么内容呢？</p>
<p>比如，接口拿到的路由数据字段 <code>component</code> 是一个字符串路径，这是一个映射路径，映射到前端项目下的真实组件路径</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e45648c28a1842d989038a603c9d8fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=3pupbwBxPl8RwEVJMSVXNGpW8Ws%3D" alt="image.png" loading="lazy"/></p>
<p>实现路由结构转换的代码，我写在了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Frouter%2Fhelpers.ts" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/router/helpers.ts" ref="nofollow noopener noreferrer">router/helpers.ts</a>，最主要逻辑是 <code>generateRoutes</code> 函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 生成符合 Vue Router 定义的路由表
 * <span class="hljs-doctag">@param</span> routes 未转化的路由数据
 * <span class="hljs-doctag">@returns</span> 符合结构的路由表
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateRoutes</span>(<span class="hljs-params">routes: PermissionRoute[]</span>): <span class="hljs-title class_">CustomRouteRecordRaw</span>[] {
  <span class="hljs-keyword">if</span> (!routes.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> [];
  <span class="hljs-keyword">return</span> routes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { path, name, redirect, <span class="hljs-keyword">type</span>, meta } = route;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">baseRoute</span>: <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">CustomRouteRecordRaw</span>, <span class="hljs-string">'children'</span>&gt; = {
      path,
      name,
      redirect,
      <span class="hljs-keyword">type</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title function_">loadComponent</span>(route),
      <span class="hljs-attr">meta</span>: {
        ...meta,
        <span class="hljs-comment">// 是否在侧边栏菜单中隐藏</span>
        <span class="hljs-attr">hideMenu</span>: route.<span class="hljs-property">meta</span>?.<span class="hljs-property">hideMenu</span> || <span class="hljs-literal">false</span>,
        <span class="hljs-comment">// 是否在面包屑中隐藏</span>
        <span class="hljs-attr">hideBreadcrumb</span>: route.<span class="hljs-property">meta</span>?.<span class="hljs-property">hideBreadcrumb</span> || <span class="hljs-literal">false</span>,
        <span class="hljs-comment">// 当只有一个子菜单时，是否隐藏父级菜单直接显示子菜单内容</span>
        <span class="hljs-attr">hideParentIfSingleChild</span>: route.<span class="hljs-property">meta</span>?.<span class="hljs-property">hideParentIfSingleChild</span> || <span class="hljs-literal">false</span>,
      },
    };

    <span class="hljs-comment">// 是目录数据，设置重定向路径</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-title class_">PermissionRouteTypeEnum</span>.<span class="hljs-property">DIR</span>) {
      baseRoute.<span class="hljs-property">redirect</span> = redirect || <span class="hljs-title function_">getRedirectPath</span>(route);
    }
    <span class="hljs-comment">// 递归处理子路由</span>
    <span class="hljs-keyword">const</span> processedChildren =
      route.<span class="hljs-property">children</span> &amp;&amp; route.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> ? <span class="hljs-title function_">generateRoutes</span>(route.<span class="hljs-property">children</span>) : <span class="hljs-literal">undefined</span>;

    <span class="hljs-keyword">return</span> {
      ...baseRoute,
      ...(processedChildren ? { <span class="hljs-attr">children</span>: processedChildren } : {}),
    };
  });
}
</code></pre>
<p>经过 <code>generateRoutes</code> 处理的路由表，再 <code>addRoute</code> 到 Vue Router 中</p>
<h3 data-id="heading-14">侧边栏菜单的渲染</h3>
<p>当路由守卫的逻辑走完后，就进入到首页，在首页中，我们会根据路由表（转换过的）来渲染侧边栏菜单</p>
<p>侧边栏菜单是拿 Element Plus 的 <code>el-menu</code> 组件来做的，我们封装了一个菜单组件，除了渲染路由数据外，也更方便自定义配置菜单属性（<code>meta</code>）来实现一些功能</p>
<p>封装不难，就是拿处理后的路由表循环渲染 <code>menu-item</code>，根据 <code>meta</code> 配置项来实现"是否隐藏菜单"，"当只有一个子菜单时，是否隐藏父级菜单直接显示子菜单内容"等</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc22c2cff5504c7da9f622501542575d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=N30nuLBJhKAnO0gn1RD1N8kky4E%3D" alt="image.png" loading="lazy"/></p>
<p>菜单组件的封装代码在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Ftree%2Fmain%2Fsrc%2Flayout%2Fcomponents%2Fbasic-menu" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/tree/main/src/layout/components/basic-menu" ref="nofollow noopener noreferrer">basic-menu</a> 文件夹中</p>
<p>到这一步，已经实现了动态权限路由及侧边栏菜单的渲染，但还不算完</p>
<p>因为我们还不能自由定义菜单信息、角色信息、用户信息来实现权限控制，在下一篇文章来聊聊管理模块</p>
<h2 data-id="heading-15">了解更多</h2>
<p>系列专栏地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2FBlog" target="_blank" title="https://github.com/bryqiu/Blog" ref="nofollow noopener noreferrer">GitHub 博客</a> | <a href="https://juejin.cn/column/7437267529330901026" target="_blank" title="https://juejin.cn/column/7437267529330901026">掘金专栏</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fblog%2Fadmin_guide" target="_blank" title="https://segmentfault.com/blog/admin_guide" ref="nofollow noopener noreferrer">思否专栏</a></p>
<p>实战项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin" target="_blank" title="https://github.com/bryqiu/vue-clean-admin" ref="nofollow noopener noreferrer">vue-clean-admin</a></p>
<h2 data-id="heading-16">交流讨论</h2>
<p>文章如有错误或需要改进之处，欢迎指正</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第三章使用 mergeMap 实现并发请求]]></title>    <link>https://juejin.cn/post/7600560664407523391</link>    <guid>https://juejin.cn/post/7600560664407523391</guid>    <pubDate>2026-01-29T09:01:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600560664407523391" data-draft-id="7600469605476958250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第三章使用 mergeMap 实现并发请求"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:01:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第三章使用 mergeMap 实现并发请求
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:01:40.000Z" title="Thu Jan 29 2026 09:01:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 mergeMap 实现并发请求</h2>
<h3 data-id="heading-1">概述</h3>
<p>在实际开发中，我们经常需要并发执行多个请求。虽然 <code>forkJoin</code> 也可以实现并发，但它要求等待所有请求完成。而 <code>mergeMap</code> 提供了更灵活的并发控制，可以实时处理每个请求的结果。本章将详细介绍如何使用 <code>mergeMap</code> 实现并发请求。</p>
<h3 data-id="heading-2">mergeMap 操作符简介</h3>
<p><code>mergeMap</code>（也称为 <code>flatMap</code>）是 RxJS 中最常用的操作符之一。它会将源 Observable 的每个值映射为一个新的 Observable，然后合并这些 Observable 的输出。</p>
<h4 data-id="heading-3">基本语法</h4>
<pre><code class="hljs language-typescript" lang="typescript">source$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title function_">createObservable</span>(value))
)
</code></pre>
<h4 data-id="heading-4">关键特性</h4>
<ol>
<li><strong>并发执行</strong>：默认情况下，<code>mergeMap</code> 会并发执行所有内部 Observable</li>
<li><strong>实时输出</strong>：每个内部 Observable 完成后立即输出结果，不等待其他 Observable</li>
<li><strong>顺序不保证</strong>：结果的顺序可能与输入顺序不同（按完成时间排序）</li>
<li><strong>并发控制</strong>：可以通过第二个参数限制并发数</li>
</ol>
<h3 data-id="heading-5">实战场景：并发请求多个接口</h3>
<p>假设我们需要并发请求 10 个接口（delay1、delay2、delay3 循环），并实时显示每个请求的结果。</p>
<h4 data-id="heading-6">实现思路</h4>
<ol>
<li>使用 <code>from</code> 将接口 URL 数组转换为 Observable</li>
<li>使用 <code>mergeMap</code> 并发执行每个请求</li>
<li>使用 <code>catchError</code> 处理单个请求的错误</li>
<li>使用 <code>toArray</code> 收集所有结果（可选，如果需要等待全部完成）</li>
</ol>
<h4 data-id="heading-7">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> apiUrls = [
  <span class="hljs-string">'/api/delay1'</span>,
  <span class="hljs-string">'/api/delay2'</span>,
  <span class="hljs-string">'/api/delay3'</span>,
  <span class="hljs-string">'/api/delay1'</span>,
  <span class="hljs-string">'/api/delay2'</span>,
  <span class="hljs-string">'/api/delay3'</span>,
  <span class="hljs-string">'/api/delay1'</span>,
  <span class="hljs-string">'/api/delay2'</span>,
  <span class="hljs-string">'/api/delay3'</span>,
  <span class="hljs-string">'/api/delay1'</span>
];

<span class="hljs-title function_">from</span>(apiUrls)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function">(<span class="hljs-params">url, index</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> apiName = url.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'/api/'</span>, <span class="hljs-string">''</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">DelayApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span><span class="hljs-subst">${url}</span>`</span>)
        .<span class="hljs-title function_">pipe</span>(
          <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
            <span class="hljs-comment">// 捕获单个请求错误，返回错误响应</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`请求 <span class="hljs-subst">${url}</span> 失败:`</span>, err);
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>({
              <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
              <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>,
              <span class="hljs-attr">data</span>: {
                <span class="hljs-attr">delay</span>: <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>,
                <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
                <span class="hljs-attr">info</span>: <span class="hljs-string">'请求失败'</span>
              }
            } <span class="hljs-keyword">as</span> <span class="hljs-title class_">DelayApiResponse</span>);
          }),
          <span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
            <span class="hljs-comment">// 将响应包装为包含接口名称的对象</span>
            <span class="hljs-keyword">const</span> <span class="hljs-attr">result</span>: <span class="hljs-title class_">RequestResult</span> = {
              apiName,
              <span class="hljs-attr">apiUrl</span>: url,
              response,
              index
            };
            <span class="hljs-keyword">return</span> result;
          })
        );
    }),
    <span class="hljs-title function_">toArray</span>() <span class="hljs-comment">// 收集所有结果</span>
  )
  .<span class="hljs-title function_">subscribe</span>({
    <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">results: RequestResult[]</span>) =&gt;</span> {
      <span class="hljs-comment">// 所有请求完成（按完成顺序，不是原始顺序）</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">results</span> = results;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有请求完成:'</span>, results);
    }
  });
</code></pre>
<h3 data-id="heading-8">关键点解析</h3>
<h4 data-id="heading-9">1. 并发执行机制</h4>
<p><code>mergeMap</code> 默认并发数为 <code>Infinity</code>，意味着理论上所有请求都会并发执行。但实际并发数可能受以下因素限制：</p>
<ul>
<li><strong>浏览器并发连接限制</strong>：同一域名通常最多 6 个并发连接</li>
<li><strong>HTTP 客户端限制</strong>：某些 HTTP 客户端可能有自己的并发限制</li>
<li><strong>服务器限制</strong>：服务器可能限制同一客户端的并发连接数</li>
</ul>
<h4 data-id="heading-10">2. 结果顺序</h4>
<p><code>mergeMap</code> 输出的结果顺序是按照完成时间排序的，而不是输入顺序。如果需要保持原始顺序，可以使用 <code>concatMap</code> 或 <code>toArray()</code> 后再排序。</p>
<h4 data-id="heading-11">3. 错误处理</h4>
<p>使用 <code>catchError</code> 可以捕获单个请求的错误，避免整个流中断。这样即使某个请求失败，其他请求仍能继续执行。</p>
<h4 data-id="heading-12">4. 并发数控制</h4>
<p>如果需要限制并发数，可以在 <code>mergeMap</code> 的第二个参数中指定：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">mergeMap</span>(<span class="hljs-function">(<span class="hljs-params">url, index</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(url);
}, <span class="hljs-number">3</span>) <span class="hljs-comment">// 最多同时 3 个请求</span>
</code></pre>
<h3 data-id="heading-13">与 forkJoin 的对比</h3>






























<table><thead><tr><th>特性</th><th>mergeMap</th><th>forkJoin</th></tr></thead><tbody><tr><td>执行方式</td><td>并发，实时输出</td><td>并发，等待全部完成</td></tr><tr><td>结果顺序</td><td>按完成时间</td><td>按输入顺序</td></tr><tr><td>错误处理</td><td>可单独处理</td><td>任一失败整体失败</td></tr><tr><td>适用场景</td><td>需要实时处理结果</td><td>需要等待全部完成</td></tr></tbody></table>
<h3 data-id="heading-14">实际应用场景</h3>
<h4 data-id="heading-15">1. 批量数据验证</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 并发验证多个用户ID是否存在</span>
<span class="hljs-title function_">from</span>(userIds)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">userId</span> =&gt;</span> 
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">${userId}</span>`</span>).<span class="hljs-title function_">pipe</span>(
        <span class="hljs-title function_">catchError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>))
      )
    )
  )
  .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
    <span class="hljs-comment">// 实时处理每个验证结果</span>
    <span class="hljs-keyword">if</span> (result) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户存在:'</span>, result);
    }
  });
</code></pre>
<h4 data-id="heading-16">2. 文件上传进度</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 并发上传多个文件，实时显示进度</span>
<span class="hljs-title function_">from</span>(files)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> 
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">uploadFile</span>(file).<span class="hljs-title function_">pipe</span>(
        <span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">progress</span> =&gt;</span> ({ file, progress }))
      )
    )
  )
  .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">{ file, progress }</span>) =&gt;</span> {
    <span class="hljs-comment">// 实时更新每个文件的上传进度</span>
    <span class="hljs-title function_">updateFileProgress</span>(file, progress);
  });
</code></pre>
<h4 data-id="heading-17">3. 数据采集</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 从多个数据源并发采集数据</span>
<span class="hljs-title function_">from</span>(dataSources)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">source</span> =&gt;</span> 
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchData</span>(source).<span class="hljs-title function_">pipe</span>(
        <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`数据源 <span class="hljs-subst">${source}</span> 失败:`</span>, err);
          <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">EMPTY</span>;
        })
      )
    )
  )
  .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-comment">// 实时处理采集到的数据</span>
    <span class="hljs-title function_">processData</span>(data);
  });
</code></pre>
<h3 data-id="heading-18">性能优化建议</h3>
<h4 data-id="heading-19">1. 限制并发数</h4>
<p>如果请求数量很大，建议限制并发数，避免服务器压力过大：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(url), <span class="hljs-number">5</span>) <span class="hljs-comment">// 最多 5 个并发</span>
</code></pre>
<h4 data-id="heading-20">2. 使用 exhaustMap 避免重复请求</h4>
<p>如果同一个请求可能被触发多次，可以使用 <code>exhaustMap</code> 忽略后续请求：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(url))
</code></pre>
<h4 data-id="heading-21">3. 添加重试机制</h4>
<p>对于可能失败的请求，可以添加重试：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> 
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(url).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">retry</span>(<span class="hljs-number">3</span>), <span class="hljs-comment">// 失败后重试 3 次</span>
    <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>))
  )
)
</code></pre>
<h3 data-id="heading-22">注意事项</h3>
<ol>
<li><strong>内存占用</strong>：如果请求数量非常大，需要注意内存占用</li>
<li><strong>服务器压力</strong>：并发请求会给服务器带来压力，需要合理控制并发数</li>
<li><strong>错误处理</strong>：确保每个请求都有适当的错误处理，避免整个流中断</li>
<li><strong>结果顺序</strong>：如果需要保持顺序，考虑使用 <code>concatMap</code> 或 <code>toArray()</code> 后排序</li>
</ol>
<h3 data-id="heading-23">总结</h3>
<p><code>mergeMap</code> 是实现并发请求的强大工具，它提供了灵活的并发控制和实时结果处理能力。在实际项目中，根据具体需求选择合适的策略：</p>
<ul>
<li><strong>需要实时处理结果</strong> → 使用 <code>mergeMap</code></li>
<li><strong>需要等待全部完成</strong> → 使用 <code>forkJoin</code></li>
<li><strong>需要保证顺序</strong> → 使用 <code>concatMap</code></li>
<li><strong>需要限制并发</strong> → 使用 <code>mergeMap</code> 配合并发数参数</li>
</ul>
<p>通过合理使用 <code>mergeMap</code>，我们可以构建高效、响应迅速的异步数据流处理系统。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第五章使用 switchMap 处理标签页切换]]></title>    <link>https://juejin.cn/post/7600602502632767529</link>    <guid>https://juejin.cn/post/7600602502632767529</guid>    <pubDate>2026-01-29T09:03:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600602502632767529" data-draft-id="7600587732991164458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第五章使用 switchMap 处理标签页切换"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:03:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第五章使用 switchMap 处理标签页切换
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:03:39.000Z" title="Thu Jan 29 2026 09:03:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 switchMap 处理标签页切换</h2>
<h3 data-id="heading-1">概述</h3>
<p>在标签页（Tab）组件中，用户快速切换标签时，每个标签页都可能发起数据请求。如果不做处理，可能会导致：</p>
<ol>
<li>多个请求同时进行，浪费资源</li>
<li>旧标签页的请求完成后覆盖新标签页的数据</li>
<li>用户体验差，数据混乱</li>
</ol>
<p>本章将介绍如何使用 <code>switchMap</code> 在标签页切换时自动取消之前的请求，确保只显示当前标签页的数据。</p>
<h3 data-id="heading-2">问题场景</h3>
<p>假设我们有一个标签页组件，包含 3 个标签页，每个标签页需要加载不同的数据：</p>
<ul>
<li><strong>标签页 1</strong>：调用 <code>/api/delay1</code>（延迟 1 秒）</li>
<li><strong>标签页 2</strong>：调用 <code>/api/delay2</code>（延迟 2 秒）</li>
<li><strong>标签页 3</strong>：调用 <code>/api/delay3</code>（延迟 3 秒）</li>
</ul>
<p>如果用户快速切换标签页，可能会出现以下问题：</p>
<ol>
<li>用户点击"标签页 1" → 发起请求 A（1 秒）</li>
<li>用户立即点击"标签页 2" → 发起请求 B（2 秒）</li>
<li>用户立即点击"标签页 3" → 发起请求 C（3 秒）</li>
<li>请求 A 先完成 → 显示标签页 1 的数据（错误！）</li>
<li>请求 B 完成 → 显示标签页 2 的数据（错误！）</li>
<li>请求 C 完成 → 显示标签页 3 的数据（正确，但已经晚了）</li>
</ol>
<h3 data-id="heading-3">switchMap 解决方案</h3>
<p>使用 <code>switchMap</code> 可以完美解决这个问题：当切换标签页时，自动取消之前未完成的请求，只处理最新标签页的请求。</p>
<h4 data-id="heading-4">实现思路</h4>
<ol>
<li>使用 <code>Subject</code> 作为标签页切换触发器</li>
<li>使用 <code>switchMap</code> 处理标签页切换，自动取消之前的请求</li>
<li>记录请求历史，展示哪些请求被取消了</li>
<li>在组件销毁时取消所有订阅</li>
</ol>
<h4 data-id="heading-5">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 标签页列表</span>
<span class="hljs-attr">tabs</span>: <span class="hljs-title class_">Tab</span>[] = [
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'tab1'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'标签页 1'</span>, <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'/api/delay1'</span>, <span class="hljs-attr">apiName</span>: <span class="hljs-string">'delay1'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'tab2'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'标签页 2'</span>, <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'/api/delay2'</span>, <span class="hljs-attr">apiName</span>: <span class="hljs-string">'delay2'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'tab3'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'标签页 3'</span>, <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'/api/delay3'</span>, <span class="hljs-attr">apiName</span>: <span class="hljs-string">'delay3'</span> }
];

<span class="hljs-comment">// 当前激活的标签页</span>
<span class="hljs-attr">activeTabId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabs</span>[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>;

<span class="hljs-comment">// 标签页切换 Subject</span>
<span class="hljs-keyword">private</span> tabSwitch$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">string</span>&gt;();

<span class="hljs-comment">// 销毁 Subject</span>
<span class="hljs-keyword">private</span> destroy$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();

<span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 使用 switchMap 处理标签页切换时的请求取消</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabSwitch$</span>
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">(<span class="hljs-params">tabId</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> tab = <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> === tabId);
        <span class="hljs-keyword">if</span> (!tab) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>);
        }
        
        <span class="hljs-comment">// 创建请求记录</span>
        <span class="hljs-keyword">const</span> recordId = ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestCounter</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-attr">record</span>: <span class="hljs-title class_">RequestRecord</span> = {
          <span class="hljs-attr">id</span>: recordId,
          <span class="hljs-attr">tabId</span>: tab.<span class="hljs-property">id</span>,
          <span class="hljs-attr">tabName</span>: tab.<span class="hljs-property">name</span>,
          <span class="hljs-attr">apiName</span>: tab.<span class="hljs-property">apiName</span>,
          <span class="hljs-attr">apiUrl</span>: tab.<span class="hljs-property">apiUrl</span>,
          <span class="hljs-attr">startTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
          <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span>
        };
        
        <span class="hljs-comment">// 将之前的 pending 请求标记为 cancelled（切换标签时取消）</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (r.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
            r.<span class="hljs-property">status</span> = <span class="hljs-string">'cancelled'</span>;
            r.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          }
        });
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">unshift</span>(record);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentResult</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">DelayApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span><span class="hljs-subst">${tab.apiUrl}</span>`</span>)
          .<span class="hljs-title function_">pipe</span>(
            <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
              <span class="hljs-comment">// 捕获错误</span>
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`请求 <span class="hljs-subst">${tab.apiUrl}</span> 失败:`</span>, err);
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>({
                <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>,
                <span class="hljs-attr">data</span>: {
                  <span class="hljs-attr">delay</span>: <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>,
                  <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
                  <span class="hljs-attr">info</span>: <span class="hljs-string">'请求失败'</span>
                }
              } <span class="hljs-keyword">as</span> <span class="hljs-title class_">DelayApiResponse</span>);
            })
          );
      }),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroy$</span>) <span class="hljs-comment">// 路由切换时取消所有订阅</span>
    )
    .<span class="hljs-title function_">subscribe</span>({
      <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!response) {
          <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 找到最新的 pending 请求记录</span>
        <span class="hljs-keyword">const</span> latestRecord = <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>);
        <span class="hljs-keyword">if</span> (latestRecord) {
          latestRecord.<span class="hljs-property">status</span> = <span class="hljs-string">'completed'</span>;
          latestRecord.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          latestRecord.<span class="hljs-property">response</span> = response;
        }
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentResult</span> = response;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
      },
      <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理错误</span>
        <span class="hljs-keyword">const</span> latestRecord = <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>);
        <span class="hljs-keyword">if</span> (latestRecord) {
          latestRecord.<span class="hljs-property">status</span> = <span class="hljs-string">'completed'</span>;
          latestRecord.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          latestRecord.<span class="hljs-property">error</span> = err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>;
        }
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
      }
    });
  
  <span class="hljs-comment">// 初始化时加载第一个标签页的数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">switchTab</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">activeTabId</span>);
}

<span class="hljs-comment">// 切换标签页</span>
<span class="hljs-title function_">switchTab</span>(<span class="hljs-attr">tabId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeTabId</span> = tabId;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabSwitch$</span>.<span class="hljs-title function_">next</span>(tabId);
}

<span class="hljs-title function_">ngOnDestroy</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 路由切换时，取消所有订阅和请求</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">destroy$</span>.<span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">destroy$</span>.<span class="hljs-title function_">complete</span>();
  
  <span class="hljs-comment">// 将未完成的请求标记为 cancelled</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (r.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
      r.<span class="hljs-property">status</span> = <span class="hljs-string">'cancelled'</span>;
      r.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    }
  });
}
</code></pre>
<h3 data-id="heading-6">关键点解析</h3>
<h4 data-id="heading-7">1. switchMap 的自动取消机制</h4>
<p>当 <code>tabSwitch$</code> 发出新的标签页 ID 时：</p>
<ol>
<li><code>switchMap</code> 自动取消之前未完成的 HTTP 请求</li>
<li>开始新的请求</li>
<li>只处理最新标签页的响应</li>
</ol>
<h4 data-id="heading-8">2. 请求记录管理</h4>
<p>通过维护请求记录列表，我们可以：</p>
<ul>
<li>追踪每个请求的状态（pending、completed、cancelled）</li>
<li>展示请求历史，帮助调试</li>
<li>分析哪些请求被取消了</li>
</ul>
<h4 data-id="heading-9">3. 组件销毁时的清理</h4>
<p>在 <code>ngOnDestroy</code> 中：</p>
<ol>
<li>使用 <code>destroy$</code> 取消所有订阅</li>
<li>将未完成的请求标记为 cancelled</li>
<li>防止内存泄漏</li>
</ol>
<h4 data-id="heading-10">4. 初始化加载</h4>
<p>在 <code>ngOnInit</code> 中调用 <code>switchTab</code>，确保第一个标签页的数据会被加载。</p>
<h3 data-id="heading-11">执行流程示例</h3>
<p>假设用户的操作序列如下：</p>
<ol>
<li>
<p><strong>初始化</strong>：加载标签页 1 的数据</p>
<ul>
<li>发起请求 A（delay1，1 秒）</li>
<li>状态：pending</li>
</ul>
</li>
<li>
<p><strong>用户点击标签页 2</strong>（请求 A 还未完成）</p>
<ul>
<li><code>switchMap</code> 取消请求 A</li>
<li>请求 A 状态变为：cancelled</li>
<li>发起请求 B（delay2，2 秒）</li>
<li>状态：pending</li>
</ul>
</li>
<li>
<p><strong>用户点击标签页 3</strong>（请求 B 还未完成）</p>
<ul>
<li><code>switchMap</code> 取消请求 B</li>
<li>请求 B 状态变为：cancelled</li>
<li>发起请求 C（delay3，3 秒）</li>
<li>状态：pending</li>
</ul>
</li>
<li>
<p><strong>请求 C 完成</strong></p>
<ul>
<li>请求 C 状态变为：completed</li>
<li>显示标签页 3 的数据 ✅</li>
</ul>
</li>
</ol>
<p>最终结果：只显示标签页 3 的数据，请求 A 和 B 都被取消了。</p>
<h3 data-id="heading-12">与其他方案的对比</h3>
<h4 data-id="heading-13">方案 1：不使用 switchMap（有问题）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误示例：多个请求可能同时完成，导致数据混乱</span>
<span class="hljs-title function_">switchTab</span>(<span class="hljs-attr">tabId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeTabId</span> = tabId;
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTabData</span>(tabId).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentResult</span> = data; <span class="hljs-comment">// 可能显示旧标签页的数据</span>
  });
}
</code></pre>
<h4 data-id="heading-14">方案 2：手动取消订阅（复杂）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ⚠️ 可行但复杂：需要手动管理订阅</span>
<span class="hljs-keyword">private</span> currentSubscription?: <span class="hljs-title class_">Subscription</span>;

<span class="hljs-title function_">switchTab</span>(<span class="hljs-attr">tabId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 取消之前的订阅</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubscription</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubscription</span>.<span class="hljs-title function_">unsubscribe</span>();
  }
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">activeTabId</span> = tabId;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSubscription</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTabData</span>(tabId).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentResult</span> = data;
  });
}
</code></pre>
<h4 data-id="heading-15">方案 3：使用 switchMap（推荐）✅</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 推荐：简洁、自动管理</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabSwitch$</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">tabId</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTabData</span>(tabId))
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentResult</span> = data; <span class="hljs-comment">// 只显示最新标签页的数据</span>
});
</code></pre>
<h3 data-id="heading-16">实际应用场景</h3>
<h4 data-id="heading-17">1. 多标签页数据加载</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 标签页组件</span>
tabs = [<span class="hljs-string">'用户'</span>, <span class="hljs-string">'订单'</span>, <span class="hljs-string">'商品'</span>];
activeTab = <span class="hljs-string">'用户'</span>;

tabChange$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">tab</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTabData</span>(tab))
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabData</span> = data;
});
</code></pre>
<h4 data-id="heading-18">2. 路由参数变化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 路由参数变化时，取消之前的数据请求</span>
route.<span class="hljs-property">params</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">params</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadData</span>(params.<span class="hljs-property">id</span>))
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;
});
</code></pre>
<h4 data-id="heading-19">3. 模态框内容加载</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 打开不同模态框时，取消之前的内容加载</span>
modalOpen$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">modalType</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadModalContent</span>(modalType))
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">content</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">modalContent</span> = content;
});
</code></pre>
<h3 data-id="heading-20">性能优化建议</h3>
<h4 data-id="heading-21">1. 添加缓存机制</h4>
<p>对于不经常变化的数据，可以添加缓存：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> tabDataCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;();

<span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">tabId</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabDataCache</span>.<span class="hljs-title function_">has</span>(tabId)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabDataCache</span>.<span class="hljs-title function_">get</span>(tabId));
  }
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTabData</span>(tabId).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">tap</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabDataCache</span>.<span class="hljs-title function_">set</span>(tabId, data))
  );
})
</code></pre>
<h4 data-id="heading-22">2. 预加载相邻标签页</h4>
<p>可以在用户切换到某个标签页时，预加载相邻标签页的数据：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">switchTab</span>(<span class="hljs-attr">tabId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tabSwitch$</span>.<span class="hljs-title function_">next</span>(tabId);
  <span class="hljs-comment">// 预加载相邻标签页</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">preloadAdjacentTabs</span>(tabId);
}
</code></pre>
<h4 data-id="heading-23">3. 添加加载状态</h4>
<p>通过维护加载状态，给用户更好的反馈：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">tabId</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTabData</span>(tabId).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">finalize</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>)
  );
})
</code></pre>
<h3 data-id="heading-24">注意事项</h3>
<ol>
<li><strong>副作用处理</strong>：如果请求有副作用（如创建资源），需要谨慎使用 <code>switchMap</code></li>
<li><strong>用户体验</strong>：频繁取消请求可能会让用户困惑，需要适当的 UI 反馈</li>
<li><strong>错误处理</strong>：确保每个请求都有适当的错误处理</li>
<li><strong>内存泄漏</strong>：确保在组件销毁时取消所有订阅</li>
</ol>
<h3 data-id="heading-25">总结</h3>
<p>使用 <code>switchMap</code> 处理标签页切换是一个优雅的解决方案，它通过自动取消之前的请求来确保：</p>
<ul>
<li><strong>数据一致性</strong>：只显示当前标签页的数据</li>
<li><strong>资源节约</strong>：取消不必要的请求，减少服务器压力</li>
<li><strong>代码简洁</strong>：不需要手动管理订阅和取消逻辑</li>
<li><strong>用户体验</strong>：避免数据混乱，提供流畅的交互体验</li>
</ul>
<p>记住：当你需要在切换时取消之前的操作时，使用 <code>switchMap</code> 是最佳选择。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第六章防抖（debounce）与节流（throttle）的应用]]></title>    <link>https://juejin.cn/post/7600560664407539775</link>    <guid>https://juejin.cn/post/7600560664407539775</guid>    <pubDate>2026-01-29T09:04:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600560664407539775" data-draft-id="7600587732991197226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第六章防抖（debounce）与节流（throttle）的应用"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:04:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第六章防抖（debounce）与节流（throttle）的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:04:24.000Z" title="Thu Jan 29 2026 09:04:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：防抖（debounce）与节流（throttle）的应用</h2>
<h3 data-id="heading-1">概述</h3>
<p>在用户交互频繁的场景中，比如搜索输入框、滚动事件、窗口调整等，如果不做处理，可能会触发大量不必要的请求或计算。防抖（debounce）和节流（throttle）是两种常用的优化技术，可以有效地控制事件触发的频率。本章将详细介绍如何在 RxJS 中使用 <code>debounceTime</code> 和 <code>throttleTime</code> 操作符。</p>
<h3 data-id="heading-2">防抖（Debounce）vs 节流（Throttle）</h3>
<h4 data-id="heading-3">防抖（Debounce）</h4>
<p><strong>定义</strong>：在事件被触发后，等待一定时间（如 500ms），如果在这段时间内没有再次触发事件，才执行操作。如果在等待期间又触发了事件，则重新计时。</p>
<p><strong>形象比喻</strong>：就像电梯门，当有人进入时，电梯门会等待一段时间，如果在这段时间内又有人进入，则重新计时。只有当等待时间内没有人进入时，电梯门才关闭。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>搜索输入框：用户停止输入后才发起搜索请求</li>
<li>窗口调整：用户停止调整窗口大小后才重新计算布局</li>
<li>表单验证：用户停止输入后才进行验证</li>
</ul>
<h4 data-id="heading-4">节流（Throttle）</h4>
<p><strong>定义</strong>：在指定时间间隔内，无论事件触发多少次，只执行一次操作。</p>
<p><strong>形象比喻</strong>：就像水龙头，无论你拧多少次，水流的频率是固定的（比如每秒流一次）。</p>
<p><strong>适用场景</strong>：</p>
<ul>
<li>滚动事件：滚动时每 100ms 更新一次位置</li>
<li>鼠标移动：鼠标移动时每 50ms 更新一次坐标</li>
<li>按钮点击：防止用户快速重复点击</li>
</ul>
<h3 data-id="heading-5">debounceTime 操作符</h3>
<p><code>debounceTime</code> 会延迟值的发出，直到源 Observable 在指定时间内没有发出新值。</p>
<h4 data-id="heading-6">基本语法</h4>
<pre><code class="hljs language-typescript" lang="typescript">source$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">500</span>) <span class="hljs-comment">// 500ms 内没有新值才发出</span>
)
</code></pre>
<h4 data-id="heading-7">实战场景：搜索输入框</h4>
<p>假设我们有一个搜索输入框，用户输入时会触发搜索请求。使用 <code>debounceTime</code> 可以确保只在用户停止输入后才发起请求。</p>
<h4 data-id="heading-8">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 防抖输入框</span>
debounceInput = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormControl</span>(<span class="hljs-string">''</span>);

<span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 防抖输入框：使用 debounceTime，停止输入 500ms 后发起请求</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceInput</span>.<span class="hljs-property">valueChanges</span>
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">distinctUntilChanged</span>(), <span class="hljs-comment">// 只有值真正改变时才触发</span>
      <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">500</span>), <span class="hljs-comment">// 防抖：停止输入 500ms 后才触发</span>
      <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">(<span class="hljs-params">query</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!query || query.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">''</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>);
        }
        
        <span class="hljs-keyword">const</span> recordId = ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestCounter</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-attr">record</span>: <span class="hljs-title class_">RequestRecord</span> = {
          <span class="hljs-attr">id</span>: recordId,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'debounce'</span>,
          <span class="hljs-attr">query</span>: query.<span class="hljs-title function_">trim</span>(),
          <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
        };
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceRecords</span>.<span class="hljs-title function_">unshift</span>(record);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceLoading</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        
        <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpParams</span>().<span class="hljs-title function_">set</span>(<span class="hljs-string">'q'</span>, query.<span class="hljs-title function_">trim</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">SearchApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span>/api/search`</span>, { params })
          .<span class="hljs-title function_">pipe</span>(
            <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'防抖请求失败:'</span>, err);
              record.<span class="hljs-property">error</span> = err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>;
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>({
                <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>,
                <span class="hljs-attr">data</span>: {
                  <span class="hljs-attr">query</span>: query.<span class="hljs-title function_">trim</span>(),
                  <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
                  <span class="hljs-attr">results</span>: []
                }
              } <span class="hljs-keyword">as</span> <span class="hljs-title class_">SearchApiResponse</span>);
            })
          );
      }),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroySubject$</span>)
    )
    .<span class="hljs-title function_">subscribe</span>({
      <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (response === <span class="hljs-literal">null</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceLoading</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
          <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-keyword">const</span> latestRecord = <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceRecords</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> !r.<span class="hljs-property">response</span> &amp;&amp; !r.<span class="hljs-property">error</span>);
        <span class="hljs-keyword">if</span> (latestRecord) {
          latestRecord.<span class="hljs-property">response</span> = response;
        }
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceCurrentResult</span> = response;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">debounceLoading</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
      }
    });
}
</code></pre>
<h4 data-id="heading-9">执行流程示例</h4>
<p>假设用户输入 "rxjs"：</p>
<ol>
<li>用户输入 "r" → 等待 500ms</li>
<li>用户输入 "x"（在 500ms 内）→ 重新计时，等待 500ms</li>
<li>用户输入 "j"（在 500ms 内）→ 重新计时，等待 500ms</li>
<li>用户输入 "s"（在 500ms 内）→ 重新计时，等待 500ms</li>
<li>用户停止输入 → 500ms 后发起搜索请求 ✅</li>
</ol>
<p><strong>结果</strong>：只发起 1 次请求，搜索 "rxjs"</p>
<h3 data-id="heading-10">throttleTime 操作符</h3>
<p><code>throttleTime</code> 会在指定时间间隔内，只发出第一个值，忽略后续的值。</p>
<h4 data-id="heading-11">基本语法</h4>
<pre><code class="hljs language-typescript" lang="typescript">source$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">500</span>) <span class="hljs-comment">// 每 500ms 最多发出一次</span>
)
</code></pre>
<h4 data-id="heading-12">实战场景：搜索输入框（节流版本）</h4>
<p>使用 <code>throttleTime</code> 可以确保在指定时间间隔内最多发起一次请求。</p>
<h4 data-id="heading-13">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 节流输入框</span>
throttleInput = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormControl</span>(<span class="hljs-string">''</span>);

<span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 节流输入框：使用 throttleTime，每 500ms 最多触发一次</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleInput</span>.<span class="hljs-property">valueChanges</span>
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">distinctUntilChanged</span>(), <span class="hljs-comment">// 只有值真正改变时才触发</span>
      <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">500</span>), <span class="hljs-comment">// 节流：每 500ms 最多触发一次</span>
      <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">(<span class="hljs-params">query</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!query || query.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">''</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>);
        }
        
        <span class="hljs-keyword">const</span> recordId = ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestCounter</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-attr">record</span>: <span class="hljs-title class_">RequestRecord</span> = {
          <span class="hljs-attr">id</span>: recordId,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'throttle'</span>,
          <span class="hljs-attr">query</span>: query.<span class="hljs-title function_">trim</span>(),
          <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
        };
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleRecords</span>.<span class="hljs-title function_">unshift</span>(record);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">throttleLoading</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        
        <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpParams</span>().<span class="hljs-title function_">set</span>(<span class="hljs-string">'q'</span>, query.<span class="hljs-title function_">trim</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">SearchApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span>/api/search`</span>, { params })
          .<span class="hljs-title function_">pipe</span>(
            <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'节流请求失败:'</span>, err);
              record.<span class="hljs-property">error</span> = err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>;
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>({
                <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>,
                <span class="hljs-attr">data</span>: {
                  <span class="hljs-attr">query</span>: query.<span class="hljs-title function_">trim</span>(),
                  <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
                  <span class="hljs-attr">results</span>: []
                }
              } <span class="hljs-keyword">as</span> <span class="hljs-title class_">SearchApiResponse</span>);
            })
          );
      }),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroySubject$</span>)
    )
    .<span class="hljs-title function_">subscribe</span>({
      <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理响应...</span>
      }
    });
}
</code></pre>
<h4 data-id="heading-14">执行流程示例</h4>
<p>假设用户快速输入 "rxjs"（每个字符间隔 100ms）：</p>
<ol>
<li>用户输入 "r" → 立即发起请求，搜索 "r"</li>
<li>用户输入 "x"（100ms 后）→ 被忽略（在 500ms 内）</li>
<li>用户输入 "j"（200ms 后）→ 被忽略（在 500ms 内）</li>
<li>用户输入 "s"（300ms 后）→ 被忽略（在 500ms 内）</li>
<li>500ms 后 → 可以发起新请求</li>
<li>用户输入其他字符 → 立即发起请求</li>
</ol>
<p><strong>结果</strong>：可能发起多次请求，但每 500ms 最多一次</p>
<h3 data-id="heading-15">对比总结</h3>






























<table><thead><tr><th>特性</th><th>debounceTime</th><th>throttleTime</th></tr></thead><tbody><tr><td><strong>触发时机</strong></td><td>停止触发后等待一段时间</td><td>固定时间间隔内触发一次</td></tr><tr><td><strong>请求次数</strong></td><td>通常更少（只在停止后触发）</td><td>可能更多（固定间隔触发）</td></tr><tr><td><strong>适用场景</strong></td><td>搜索输入框、窗口调整</td><td>滚动事件、鼠标移动</td></tr><tr><td><strong>用户体验</strong></td><td>等待用户完成操作</td><td>实时反馈但有限制</td></tr></tbody></table>
<h3 data-id="heading-16">实际应用场景</h3>
<h4 data-id="heading-17">1. 搜索输入框（推荐防抖）</h4>
<pre><code class="hljs language-typescript" lang="typescript">searchInput.<span class="hljs-property">valueChanges</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>),
  <span class="hljs-title function_">distinctUntilChanged</span>(),
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">query</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">searchService</span>.<span class="hljs-title function_">search</span>(query))
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">searchResults</span> = results;
});
</code></pre>
<h4 data-id="heading-18">2. 滚动事件（推荐节流）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">fromEvent</span>(<span class="hljs-variable language_">window</span>, <span class="hljs-string">'scroll'</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">100</span>)
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateScrollPosition</span>();
});
</code></pre>
<h4 data-id="heading-19">3. 窗口调整（推荐防抖）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">fromEvent</span>(<span class="hljs-variable language_">window</span>, <span class="hljs-string">'resize'</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>)
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recalculateLayout</span>();
});
</code></pre>
<h4 data-id="heading-20">4. 按钮点击（推荐节流）</h4>
<pre><code class="hljs language-typescript" lang="typescript">buttonClick$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 1 秒内最多点击一次</span>
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">submitForm</span>();
});
</code></pre>
<h3 data-id="heading-21">组合使用</h3>
<h4 data-id="heading-22">防抖 + switchMap</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 搜索输入框：防抖 + 取消之前的请求</span>
searchInput.<span class="hljs-property">valueChanges</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>),
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">query</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">search</span>(query))
)
</code></pre>
<h4 data-id="heading-23">节流 + distinctUntilChanged</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 滚动事件：节流 + 去重</span>
scroll$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">100</span>),
  <span class="hljs-title function_">distinctUntilChanged</span>()
)
</code></pre>
<h3 data-id="heading-24">性能优化建议</h3>
<h4 data-id="heading-25">1. 合理设置时间间隔</h4>
<ul>
<li><strong>搜索输入框</strong>：300-500ms（给用户足够的输入时间）</li>
<li><strong>滚动事件</strong>：50-100ms（保持流畅性）</li>
<li><strong>窗口调整</strong>：300-500ms（避免频繁计算）</li>
</ul>
<h4 data-id="heading-26">2. 结合 distinctUntilChanged</h4>
<p>使用 <code>distinctUntilChanged</code> 可以避免相同值的重复处理：</p>
<pre><code class="hljs language-typescript" lang="typescript">input$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">distinctUntilChanged</span>(),
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>)
)
</code></pre>
<h4 data-id="heading-27">3. 结合 switchMap</h4>
<p>使用 <code>switchMap</code> 可以取消之前的请求：</p>
<pre><code class="hljs language-typescript" lang="typescript">input$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>),
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">query</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">search</span>(query))
)
</code></pre>
<h3 data-id="heading-28">注意事项</h3>
<ol>
<li><strong>时间间隔选择</strong>：根据具体场景选择合适的间隔时间</li>
<li><strong>用户体验</strong>：防抖可能会让用户感觉响应慢，需要适当的加载提示</li>
<li><strong>错误处理</strong>：确保每个请求都有适当的错误处理</li>
<li><strong>内存泄漏</strong>：确保在组件销毁时取消订阅</li>
</ol>
<h3 data-id="heading-29">总结</h3>
<p>防抖和节流是优化用户交互的重要技术：</p>
<ul>
<li><strong>防抖（debounceTime）</strong>：适合"等待用户完成操作"的场景，如搜索输入框</li>
<li><strong>节流（throttleTime）</strong>：适合"需要实时反馈但有限制"的场景，如滚动事件</li>
</ul>
<p>在实际项目中，根据具体需求选择合适的策略，有时候也可以组合使用多个操作符来达到最佳效果。记住：<strong>防抖是等待，节流是限制频率</strong>。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第四章使用 switchMap 处理请求竞态条件]]></title>    <link>https://juejin.cn/post/7600602502632718377</link>    <guid>https://juejin.cn/post/7600602502632718377</guid>    <pubDate>2026-01-29T09:02:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600602502632718377" data-draft-id="7600562816458407978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第四章使用 switchMap 处理请求竞态条件"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:02:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第四章使用 switchMap 处理请求竞态条件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:02:37.000Z" title="Thu Jan 29 2026 09:02:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 switchMap 处理请求竞态条件</h2>
<h3 data-id="heading-1">概述</h3>
<p>在用户交互频繁的应用中，经常会遇到竞态条件（Race Condition）问题。比如用户快速点击按钮，或者输入框快速输入，可能会触发多个请求，而这些请求的响应顺序是不确定的。本章将介绍如何使用 RxJS 的 <code>switchMap</code> 操作符来优雅地解决这个问题。</p>
<h3 data-id="heading-2">什么是竞态条件？</h3>
<p>竞态条件是指多个异步操作同时进行，但它们的完成顺序不确定，导致最终结果可能不是我们期望的。在 Web 开发中，常见的竞态条件场景包括：</p>
<ol>
<li><strong>快速点击按钮</strong>：用户快速点击"搜索"按钮，触发多个搜索请求</li>
<li><strong>输入框输入</strong>：用户快速输入，每次输入都触发请求</li>
<li><strong>标签页切换</strong>：用户快速切换标签页，每个标签页都发起数据请求</li>
</ol>
<h3 data-id="heading-3">switchMap 操作符简介</h3>
<p><code>switchMap</code> 是 RxJS 中处理竞态条件的利器。它的特点是：<strong>当新的值到达时，会自动取消之前未完成的内部 Observable</strong>。</p>
<h4 data-id="heading-4">基本语法</h4>
<pre><code class="hljs language-typescript" lang="typescript">source$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title function_">createObservable</span>(value))
)
</code></pre>
<h4 data-id="heading-5">关键特性</h4>
<ol>
<li><strong>自动取消</strong>：新的值到达时，自动取消之前的 Observable</li>
<li><strong>只保留最新</strong>：只处理最新的请求，忽略之前的请求</li>
<li><strong>避免竞态</strong>：确保最终结果对应最新的操作</li>
</ol>
<h3 data-id="heading-6">实战场景：处理快速点击请求</h3>
<p>假设我们有一个按钮，点击后会随机调用不同的 API（delay1、delay2、delay3）。如果用户快速点击，我们希望只处理最后一次点击的请求。</p>
<h4 data-id="heading-7">实现思路</h4>
<ol>
<li>使用 <code>Subject</code> 作为请求触发器</li>
<li>使用 <code>switchMap</code> 处理请求，自动取消之前的请求</li>
<li>记录请求历史，展示哪些请求被取消了</li>
</ol>
<h4 data-id="heading-8">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 请求触发 Subject</span>
<span class="hljs-keyword">private</span> requestTrigger$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">string</span>&gt;();

<span class="hljs-comment">// 销毁 Subject</span>
<span class="hljs-keyword">private</span> destroy$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();

<span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 使用 switchMap 处理请求竞态条件</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestTrigger$</span>
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">(<span class="hljs-params">apiUrl</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> api = <span class="hljs-variable language_">this</span>.<span class="hljs-property">apis</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">url</span> === apiUrl);
        <span class="hljs-keyword">const</span> apiName = api?.<span class="hljs-property">name</span> || <span class="hljs-string">'unknown'</span>;
        
        <span class="hljs-comment">// 创建请求记录</span>
        <span class="hljs-keyword">const</span> recordId = ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestCounter</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-attr">record</span>: <span class="hljs-title class_">RequestRecord</span> = {
          <span class="hljs-attr">id</span>: recordId,
          apiName,
          apiUrl,
          <span class="hljs-attr">startTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
          <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span>
        };
        
        <span class="hljs-comment">// 将之前的 pending 请求标记为 cancelled</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (r.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>) {
            r.<span class="hljs-property">status</span> = <span class="hljs-string">'cancelled'</span>;
            r.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          }
        });
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">unshift</span>(record);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentApiName</span> = apiName;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">DelayApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span><span class="hljs-subst">${apiUrl}</span>`</span>)
          .<span class="hljs-title function_">pipe</span>(
            <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
              <span class="hljs-comment">// 捕获错误</span>
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`请求 <span class="hljs-subst">${apiUrl}</span> 失败:`</span>, err);
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>({
                <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
                <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>,
                <span class="hljs-attr">data</span>: {
                  <span class="hljs-attr">delay</span>: <span class="hljs-literal">null</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>,
                  <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
                  <span class="hljs-attr">info</span>: <span class="hljs-string">'请求失败'</span>
                }
              } <span class="hljs-keyword">as</span> <span class="hljs-title class_">DelayApiResponse</span>);
            })
          );
      }),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroy$</span>)
    )
    .<span class="hljs-title function_">subscribe</span>({
      <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-comment">// 找到最新的 pending 请求记录</span>
        <span class="hljs-keyword">const</span> latestRecord = <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>);
        <span class="hljs-keyword">if</span> (latestRecord) {
          latestRecord.<span class="hljs-property">status</span> = <span class="hljs-string">'completed'</span>;
          latestRecord.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          latestRecord.<span class="hljs-property">response</span> = response;
        }
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentResult</span> = response;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
      },
      <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理错误</span>
        <span class="hljs-keyword">const</span> latestRecord = <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestRecords</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">status</span> === <span class="hljs-string">'pending'</span>);
        <span class="hljs-keyword">if</span> (latestRecord) {
          latestRecord.<span class="hljs-property">status</span> = <span class="hljs-string">'completed'</span>;
          latestRecord.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
          latestRecord.<span class="hljs-property">error</span> = err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>;
        }
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
      }
    });
}

<span class="hljs-comment">// 触发请求</span>
<span class="hljs-title function_">triggerRequest</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> randomApi = <span class="hljs-variable language_">this</span>.<span class="hljs-property">apis</span>[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">apis</span>.<span class="hljs-property">length</span>)];
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestTrigger$</span>.<span class="hljs-title function_">next</span>(randomApi.<span class="hljs-property">url</span>);
}
</code></pre>
<h3 data-id="heading-9">关键点解析</h3>
<h4 data-id="heading-10">1. switchMap 的取消机制</h4>
<p>当 <code>requestTrigger$</code> 发出新值时，<code>switchMap</code> 会：</p>
<ol>
<li>取消之前未完成的 HTTP 请求（如果可能）</li>
<li>开始新的请求</li>
<li>只处理最新请求的响应</li>
</ol>
<h4 data-id="heading-11">2. 请求记录管理</h4>
<p>通过维护请求记录列表，我们可以：</p>
<ul>
<li>追踪每个请求的状态（pending、completed、cancelled）</li>
<li>展示请求历史</li>
<li>分析哪些请求被取消了</li>
</ul>
<h4 data-id="heading-12">3. 错误处理</h4>
<p>使用 <code>catchError</code> 确保单个请求的错误不会中断整个流，而是返回一个错误响应对象。</p>
<h3 data-id="heading-13">与其他操作符的对比</h3>
<h4 data-id="heading-14">switchMap vs mergeMap</h4>

























<table><thead><tr><th>特性</th><th>switchMap</th><th>mergeMap</th></tr></thead><tbody><tr><td>行为</td><td>取消之前的请求</td><td>并发执行所有请求</td></tr><tr><td>适用场景</td><td>只需要最新结果</td><td>需要所有结果</td></tr><tr><td>资源占用</td><td>低（只保留一个请求）</td><td>高（可能多个请求）</td></tr></tbody></table>
<h4 data-id="heading-15">switchMap vs concatMap</h4>

























<table><thead><tr><th>特性</th><th>switchMap</th><th>concatMap</th></tr></thead><tbody><tr><td>行为</td><td>取消之前的请求</td><td>按顺序执行</td></tr><tr><td>适用场景</td><td>只需要最新结果</td><td>需要保证顺序</td></tr><tr><td>执行方式</td><td>中断之前的请求</td><td>等待之前的请求完成</td></tr></tbody></table>
<h3 data-id="heading-16">实际应用场景</h3>
<h4 data-id="heading-17">1. 搜索输入框</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户输入时，只处理最新的搜索请求</span>
searchInput.<span class="hljs-property">valueChanges</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>), <span class="hljs-comment">// 防抖</span>
  <span class="hljs-title function_">distinctUntilChanged</span>(), <span class="hljs-comment">// 去重</span>
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">query</span> =&gt;</span> 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">searchService</span>.<span class="hljs-title function_">search</span>(query)
  )
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
  <span class="hljs-comment">// 只显示最新搜索的结果</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">searchResults</span> = results;
});
</code></pre>
<h4 data-id="heading-18">2. 标签页切换</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 切换标签时，取消之前标签的数据请求</span>
tabSwitch$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">tabId</span> =&gt;</span> 
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadTabData</span>(tabId)
  )
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-comment">// 只显示当前标签的数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTabData</span> = data;
});
</code></pre>
<h4 data-id="heading-19">3. 路由参数变化</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 路由参数变化时，取消之前的数据请求</span>
route.<span class="hljs-property">params</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">params</span> =&gt;</span> 
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadData</span>(params.<span class="hljs-property">id</span>)
  )
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-comment">// 只显示最新路由的数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;
});
</code></pre>
<h3 data-id="heading-20">性能优化建议</h3>
<h4 data-id="heading-21">1. 结合防抖使用</h4>
<p>对于输入框场景，可以结合 <code>debounceTime</code> 使用：</p>
<pre><code class="hljs language-typescript" lang="typescript">input$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>),
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(value))
)
</code></pre>
<h4 data-id="heading-22">2. 添加加载状态</h4>
<p>通过维护加载状态，可以给用户更好的反馈：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">apiUrl</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(apiUrl).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">finalize</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>)
  );
})
</code></pre>
<h4 data-id="heading-23">3. 错误重试</h4>
<p>对于可能失败的请求，可以添加重试：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">apiUrl</span> =&gt;</span> 
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(apiUrl).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">retry</span>(<span class="hljs-number">2</span>),
    <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>))
  )
)
</code></pre>
<h3 data-id="heading-24">注意事项</h3>
<ol>
<li><strong>取消请求的限制</strong>：HTTP 请求的取消取决于浏览器和 HTTP 客户端的支持</li>
<li><strong>副作用处理</strong>：如果请求有副作用（如创建资源），需要谨慎使用 <code>switchMap</code></li>
<li><strong>用户体验</strong>：频繁取消请求可能会让用户困惑，需要适当的 UI 反馈</li>
</ol>
<h3 data-id="heading-25">总结</h3>
<p><code>switchMap</code> 是处理竞态条件的强大工具，它通过自动取消之前的请求来确保只处理最新的操作。在实际项目中，合理使用 <code>switchMap</code> 可以：</p>
<ul>
<li><strong>避免竞态条件</strong>：确保结果对应最新的操作</li>
<li><strong>节省资源</strong>：取消不必要的请求，减少服务器压力</li>
<li><strong>提升用户体验</strong>：只显示最新的结果，避免混乱</li>
</ul>
<p>记住：当你只需要最新结果时，使用 <code>switchMap</code>；当你需要所有结果时，使用 <code>mergeMap</code> 或 <code>forkJoin</code>。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第七章使用 shareReplay 实现 Token 刷新的并发控制]]></title>    <link>https://juejin.cn/post/7600587732991262762</link>    <guid>https://juejin.cn/post/7600587732991262762</guid>    <pubDate>2026-01-29T09:05:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600587732991262762" data-draft-id="7600562816458440746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第七章使用 shareReplay 实现 Token 刷新的并发控制"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:05:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第七章使用 shareReplay 实现 Token 刷新的并发控制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:05:16.000Z" title="Thu Jan 29 2026 09:05:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 shareReplay 实现 Token 刷新的并发控制</h2>
<h3 data-id="heading-1">概述</h3>
<p>在需要身份验证的 Web 应用中，Token 过期是一个常见问题。当多个请求同时发起，且 Token 都已过期时，如果每个请求都独立刷新 Token，会导致：</p>
<ol>
<li>多个重复的 Token 刷新请求</li>
<li>资源浪费</li>
<li>可能的竞态条件</li>
</ol>
<p>本章将介绍如何使用 RxJS 的 <code>shareReplay</code> 操作符来实现 Token 刷新的并发控制，确保多个请求共享同一个 Token 刷新请求。</p>
<h3 data-id="heading-2">问题场景</h3>
<p>假设我们有 3 个 API 请求同时发起，且 Token 都已过期：</p>
<ol>
<li><strong>请求 A</strong>：检测到 Token 过期 → 发起 Token 刷新请求 1</li>
<li><strong>请求 B</strong>：检测到 Token 过期 → 发起 Token 刷新请求 2</li>
<li><strong>请求 C</strong>：检测到 Token 过期 → 发起 Token 刷新请求 3</li>
</ol>
<p><strong>问题</strong>：3 个请求都独立刷新 Token，导致重复请求和资源浪费。</p>
<p><strong>期望</strong>：3 个请求共享同一个 Token 刷新请求，只刷新一次。</p>
<h3 data-id="heading-3">shareReplay 操作符简介</h3>
<p><code>shareReplay</code> 是 RxJS 中用于共享 Observable 结果的操作符。它会：</p>
<ol>
<li><strong>共享订阅</strong>：多个订阅者共享同一个源 Observable</li>
<li><strong>缓存结果</strong>：缓存指定数量的最新值</li>
<li><strong>避免重复执行</strong>：源 Observable 只执行一次</li>
</ol>
<h4 data-id="heading-4">基本语法</h4>
<pre><code class="hljs language-typescript" lang="typescript">source$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">shareReplay</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// 缓存最新的 1 个值</span>
)
</code></pre>
<h3 data-id="heading-5">解决方案：使用 shareReplay 共享 Token 刷新</h3>
<h4 data-id="heading-6">实现思路</h4>
<ol>
<li>创建一个 Token 刷新 Observable，使用 <code>shareReplay</code> 共享</li>
<li>当请求检测到 Token 过期时，订阅共享的 Token 刷新 Observable</li>
<li>Token 刷新完成后，所有等待的请求都使用新的 Token 重试</li>
</ol>
<h4 data-id="heading-7">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 当前token（初始为过期token）</span>
<span class="hljs-keyword">private</span> currentToken = <span class="hljs-string">'expired_token'</span>;

<span class="hljs-comment">// token刷新Observable（使用shareReplay确保只有一个请求）</span>
<span class="hljs-keyword">private</span> <span class="hljs-attr">tokenRefresh$</span>: <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">TokenResponse</span>&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 刷新token（使用shareReplay确保并发请求时只有一个token刷新请求）</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">refreshToken</span>(): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">TokenResponse</span>&gt; {
  <span class="hljs-comment">// 如果已经有正在进行的token刷新请求，直接返回该Observable</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenRefresh$</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenRefresh$</span>;
  }
  
  <span class="hljs-comment">// 标记正在刷新token</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshingToken</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
  
  <span class="hljs-comment">// 创建新的token刷新请求，使用shareReplay确保多个订阅者共享同一个请求</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenRefresh$</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">post</span>&lt;<span class="hljs-title class_">TokenResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span>/api/refresh-token`</span>, {})
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">shareReplay</span>(<span class="hljs-number">1</span>), <span class="hljs-comment">// 关键：使用shareReplay确保只有一个请求，所有订阅者共享结果</span>
      <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Token刷新失败:'</span>, error);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenRefresh$</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 重置，允许重试</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshingToken</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> error);
      }),
      <span class="hljs-title function_">finalize</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 请求完成后重置tokenRefresh$，允许下次刷新</span>
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenRefresh$</span> = <span class="hljs-literal">null</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshingToken</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        }, <span class="hljs-number">100</span>);
      })
    );
  
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenRefresh$</span>;
}

<span class="hljs-comment">// 发起带token的请求（自动处理token刷新）</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">makeRequestWithToken</span>(<span class="hljs-attr">apiName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">apiUrl</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">ApiResponse</span>&gt; {
  <span class="hljs-comment">// 先尝试使用当前token请求</span>
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">ApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span><span class="hljs-subst">${apiUrl}</span>`</span>, {
    <span class="hljs-attr">headers</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHeaders</span>({
      <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentToken}</span>`</span>
    })
  }).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">catchError</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-comment">// 如果token过期（401错误）</span>
      <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; error.<span class="hljs-property">error</span>?.<span class="hljs-property">code</span> === <span class="hljs-string">'TOKEN_EXPIRED'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${apiName}</span> token过期，等待token刷新...`</span>);
        
        <span class="hljs-comment">// 刷新token（如果已经有正在进行的刷新请求，会复用）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshToken</span>().<span class="hljs-title function_">pipe</span>(
          <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">(<span class="hljs-params">tokenResponse</span>) =&gt;</span> {
            <span class="hljs-comment">// token刷新成功，更新当前token</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentToken</span> = tokenResponse.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTokenDisplay</span> = tokenResponse.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${apiName}</span> token刷新成功，使用新token重试请求`</span>);
            
            <span class="hljs-comment">// 使用新token重试请求</span>
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">ApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span><span class="hljs-subst">${apiUrl}</span>`</span>, {
              <span class="hljs-attr">headers</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpHeaders</span>({
                <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentToken}</span>`</span>
              })
            });
          }),
          <span class="hljs-title function_">catchError</span>(<span class="hljs-function">(<span class="hljs-params">refreshError</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${apiName}</span> token刷新失败:`</span>, refreshError);
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> refreshError);
          })
        );
      }
      
      <span class="hljs-comment">// 其他错误直接抛出</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> error);
    })
  );
}
</code></pre>
<h3 data-id="heading-8">关键点解析</h3>
<h4 data-id="heading-9">1. shareReplay 的共享机制</h4>
<p>当多个请求同时检测到 Token 过期时：</p>
<ol>
<li><strong>第一个请求</strong>：调用 <code>refreshToken()</code>，创建新的 Token 刷新 Observable，并订阅它（发起 HTTP 请求）</li>
<li><strong>第二个请求</strong>：调用 <code>refreshToken()</code>，发现 <code>tokenRefresh$</code> 已存在，直接返回共享的 Observable，并订阅它</li>
<li><strong>第三个请求</strong>：调用 <code>refreshToken()</code>，发现 <code>tokenRefresh$</code> 已存在，直接返回共享的 Observable，并订阅它</li>
</ol>
<p><strong>等待机制</strong>：</p>
<ul>
<li>第二个、第三个请求通过<strong>订阅同一个 Observable</strong>（<code>tokenRefresh$</code>）来实现等待</li>
<li>当它们调用 <code>this.refreshToken().pipe(switchMap(...))</code> 时，<code>switchMap</code> 会<strong>等待</strong>上游 Observable（<code>tokenRefresh$</code>）发出值</li>
<li>由于使用了 <code>shareReplay</code>，多个订阅者会<strong>共享同一个底层的 Observable 执行</strong></li>
<li>当第一个订阅者已经发起 HTTP 请求时，后续的订阅者会"加入"这个正在进行的执行</li>
<li>当 HTTP 请求完成并发出 Token 值时，<strong>所有订阅者都会同时收到这个值</strong></li>
<li>然后 <code>switchMap</code> 才会执行下游的操作（使用新 token 重试请求）</li>
</ul>
<p><strong>结果</strong>：3 个请求共享同一个 Token 刷新请求，只刷新一次，并且都会等待 Token 刷新完成后才继续。</p>
<h4 data-id="heading-10">2. 缓存机制</h4>
<p><code>shareReplay(1)</code> 会缓存最新的 1 个值。这意味着：</p>
<ul>
<li>如果 Token 刷新已完成，后续订阅者会立即收到缓存的结果</li>
<li>不需要重新发起请求</li>
</ul>
<h4 data-id="heading-11">3. 错误处理</h4>
<p>如果 Token 刷新失败：</p>
<ol>
<li>重置 <code>tokenRefresh$</code> 为 <code>null</code>，允许重试</li>
<li>抛出错误，让调用者处理</li>
</ol>
<h4 data-id="heading-12">4. 清理机制</h4>
<p>在 <code>finalize</code> 中重置 <code>tokenRefresh$</code>，确保下次 Token 过期时可以重新刷新。</p>
<h3 data-id="heading-13">执行流程示例</h3>
<p>假设 3 个请求同时发起，且 Token 都已过期：</p>
<ol>
<li>
<p><strong>请求 A</strong>：检测到 Token 过期</p>
<ul>
<li>调用 <code>refreshToken()</code>，创建 Token 刷新 Observable（使用 <code>shareReplay</code>）</li>
<li>调用 <code>this.refreshToken().pipe(switchMap(...))</code>，<strong>订阅</strong> <code>tokenRefresh$</code></li>
<li>由于是第一个订阅者，开始执行底层 Observable，发起 HTTP 请求（Token 刷新）</li>
</ul>
</li>
<li>
<p><strong>请求 B</strong>：检测到 Token 过期（在请求 A 的 Token 刷新完成前，例如 1 秒后）</p>
<ul>
<li>调用 <code>refreshToken()</code>，发现 <code>tokenRefresh$</code> 已存在，返回同一个 Observable</li>
<li>调用 <code>this.refreshToken().pipe(switchMap(...))</code>，<strong>订阅</strong>同一个 <code>tokenRefresh$</code></li>
<li>由于使用了 <code>shareReplay</code>，<strong>加入</strong>正在进行的 HTTP 请求执行（不发起新请求）</li>
<li><code>switchMap</code> <strong>等待</strong>上游 Observable（<code>tokenRefresh$</code>）发出值</li>
</ul>
</li>
<li>
<p><strong>请求 C</strong>：检测到 Token 过期（在请求 A 的 Token 刷新完成前，例如 2 秒后）</p>
<ul>
<li>调用 <code>refreshToken()</code>，发现 <code>tokenRefresh$</code> 已存在，返回同一个 Observable</li>
<li>调用 <code>this.refreshToken().pipe(switchMap(...))</code>，<strong>订阅</strong>同一个 <code>tokenRefresh$</code></li>
<li>由于使用了 <code>shareReplay</code>，<strong>加入</strong>正在进行的 HTTP 请求执行（不发起新请求）</li>
<li><code>switchMap</code> <strong>等待</strong>上游 Observable（<code>tokenRefresh$</code>）发出值</li>
</ul>
</li>
<li>
<p><strong>Token 刷新完成</strong>（例如 3 秒后）</p>
<ul>
<li>HTTP 请求返回新的 Token</li>
<li><code>tokenRefresh$</code> Observable 发出值（新的 Token）</li>
<li><strong>所有订阅者（请求 A、B、C）同时收到</strong>新的 Token</li>
<li>所有请求的 <code>switchMap</code> 同时执行，使用新 Token 重试各自的请求</li>
</ul>
</li>
</ol>
<p><strong>关键点</strong>：</p>
<ul>
<li>第二个、第三个请求通过<strong>订阅同一个 Observable</strong> 来实现等待</li>
<li><code>switchMap</code> 会<strong>阻塞等待</strong>上游 Observable 发出值，然后才执行下游操作</li>
<li><code>shareReplay</code> 确保多个订阅者共享同一个底层的 HTTP 请求执行</li>
</ul>
<p><strong>结果</strong>：只发起 1 次 Token 刷新请求，3 个请求共享结果，并且都会等待 Token 刷新完成后才继续 ✅</p>
<h3 data-id="heading-14">与其他方案的对比</h3>
<h4 data-id="heading-15">方案 1：不使用 shareReplay（有问题）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误示例：每个请求都独立刷新 Token</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">refreshToken</span>(): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">TokenResponse</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/refresh-token'</span>, {}); <span class="hljs-comment">// 可能发起多次请求</span>
}
</code></pre>
<h4 data-id="heading-16">方案 2：使用标志位（复杂）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ⚠️ 可行但复杂：需要手动管理标志位和 Promise</span>
<span class="hljs-keyword">private</span> isRefreshing = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">private</span> refreshPromise?: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TokenResponse</span>&gt;;

<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">refreshToken</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TokenResponse</span>&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRefreshing</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshPromise</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshPromise</span>; <span class="hljs-comment">// 等待正在进行的刷新</span>
  }
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRefreshing</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">refreshPromise</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/refresh-token'</span>, {}).<span class="hljs-title function_">toPromise</span>();
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-17">方案 3：使用 shareReplay（推荐）✅</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 推荐：简洁、自动管理</span>
<span class="hljs-keyword">private</span> tokenRefresh$ = <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/refresh-token'</span>, {}).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">shareReplay</span>(<span class="hljs-number">1</span>)
);
</code></pre>
<h3 data-id="heading-18">实际应用场景</h3>
<h4 data-id="heading-19">1. HTTP 拦截器中的 Token 刷新</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// HTTP 拦截器</span>
<span class="hljs-title function_">intercept</span>(<span class="hljs-attr">req</span>: <span class="hljs-title class_">HttpRequest</span>&lt;<span class="hljs-built_in">any</span>&gt;, <span class="hljs-attr">next</span>: <span class="hljs-title class_">HttpHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">HttpEvent</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt; {
  <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>(req).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshToken</span>().<span class="hljs-title function_">pipe</span>(
          <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">token</span> =&gt;</span> {
            <span class="hljs-comment">// 使用新 Token 重试请求</span>
            <span class="hljs-keyword">const</span> cloned = req.<span class="hljs-title function_">clone</span>({
              <span class="hljs-attr">setHeaders</span>: { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span> }
            });
            <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>(cloned);
          })
        );
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> error);
    })
  );
}
</code></pre>
<h4 data-id="heading-20">2. 多个 API 请求的 Token 刷新</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 同时发起多个请求</span>
<span class="hljs-title function_">forkJoin</span>({
  <span class="hljs-attr">user</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUser</span>(),
  <span class="hljs-attr">orders</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOrders</span>(),
  <span class="hljs-attr">products</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getProducts</span>()
}).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> {
  <span class="hljs-comment">// 所有请求共享同一个 Token 刷新请求</span>
});
</code></pre>
<h3 data-id="heading-21">性能优化建议</h3>
<h4 data-id="heading-22">1. 添加 Token 过期时间检查</h4>
<p>在刷新 Token 前，检查 Token 是否真的过期：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">isTokenExpired</span>(): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-comment">// 检查 Token 是否过期</span>
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tokenExpiryTime</span> &lt; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
}

<span class="hljs-keyword">private</span> <span class="hljs-title function_">refreshToken</span>(): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">TokenResponse</span>&gt; {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isTokenExpired</span>()) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>({ <span class="hljs-attr">token</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentToken</span> }); <span class="hljs-comment">// Token 未过期，直接返回</span>
  }
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-23">2. 添加重试机制</h4>
<p>对于 Token 刷新失败的情况，可以添加重试：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/refresh-token'</span>, {}).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">retry</span>(<span class="hljs-number">2</span>), <span class="hljs-comment">// 失败后重试 2 次</span>
  <span class="hljs-title function_">shareReplay</span>(<span class="hljs-number">1</span>)
)
</code></pre>
<h4 data-id="heading-24">3. 添加超时处理</h4>
<p>为 Token 刷新添加超时处理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/refresh-token'</span>, {}).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">timeout</span>(<span class="hljs-number">5000</span>), <span class="hljs-comment">// 5 秒超时</span>
  <span class="hljs-title function_">shareReplay</span>(<span class="hljs-number">1</span>)
)
</code></pre>
<h3 data-id="heading-25">注意事项</h3>
<ol>
<li><strong>内存泄漏</strong>：确保在组件销毁时取消订阅</li>
<li><strong>错误处理</strong>：确保 Token 刷新失败时有适当的错误处理</li>
<li><strong>并发控制</strong>：<code>shareReplay</code> 确保只有一个请求，但需要正确管理状态</li>
<li><strong>Token 存储</strong>：刷新后的 Token 需要正确存储和更新</li>
</ol>
<h3 data-id="heading-26">总结</h3>
<p>使用 <code>shareReplay</code> 实现 Token 刷新的并发控制是一个优雅的解决方案，它通过共享 Observable 来确保：</p>
<ul>
<li><strong>避免重复请求</strong>：多个请求共享同一个 Token 刷新请求</li>
<li><strong>资源节约</strong>：减少不必要的网络请求</li>
<li><strong>代码简洁</strong>：不需要手动管理标志位和 Promise</li>
<li><strong>自动管理</strong>：RxJS 自动处理订阅和取消</li>
</ul>
<p>记住：当你需要多个订阅者共享同一个 Observable 结果时，使用 <code>shareReplay</code> 是最佳选择。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第八章使用 retryWhen 实现失败重试机制]]></title>    <link>https://juejin.cn/post/7600602502632800297</link>    <guid>https://juejin.cn/post/7600602502632800297</guid>    <pubDate>2026-01-29T09:05:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600602502632800297" data-draft-id="7600587732991279146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第八章使用 retryWhen 实现失败重试机制"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:05:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第八章使用 retryWhen 实现失败重试机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:05:47.000Z" title="Thu Jan 29 2026 09:05:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 retryWhen 实现失败重试机制</h2>
<h3 data-id="heading-1">概述</h3>
<p>在网络请求中，由于网络波动、服务器临时故障等原因，请求可能会失败。简单的重试机制（如 <code>retry</code> 操作符）可能不够灵活，无法满足复杂的需求。本章将介绍如何使用 <code>retryWhen</code> 操作符实现更灵活的重试机制，比如延迟重试、限制重试次数等。</p>
<h3 data-id="heading-2">retry 操作符的局限性</h3>
<p>RxJS 提供了 <code>retry</code> 操作符，可以简单地重试指定次数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">retry</span>(<span class="hljs-number">3</span>) <span class="hljs-comment">// 失败后立即重试 3 次</span>
)
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>立即重试，可能服务器还没恢复</li>
<li>无法自定义重试逻辑（如延迟重试）</li>
<li>无法根据错误类型决定是否重试</li>
</ul>
<h3 data-id="heading-3">retryWhen 操作符简介</h3>
<p><code>retryWhen</code> 提供了更灵活的重试机制，它允许我们：</p>
<ol>
<li><strong>自定义重试逻辑</strong>：根据错误类型决定是否重试</li>
<li><strong>延迟重试</strong>：在重试前等待一段时间</li>
<li><strong>限制重试次数</strong>：使用 <code>take</code> 或 <code>scan</code> 限制重试次数</li>
<li><strong>指数退避</strong>：每次重试的延迟时间递增</li>
</ol>
<h4 data-id="heading-4">基本语法</h4>
<pre><code class="hljs language-typescript" lang="typescript">source$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span> 
    errors.<span class="hljs-title function_">pipe</span>(
      <span class="hljs-comment">// 自定义重试逻辑</span>
    )
  )
)
</code></pre>
<h3 data-id="heading-5">实战场景：延迟重试失败请求</h3>
<p>假设我们有一个可能失败的 API，失败后需要等待 3 秒再重试，最多重试 3 次。</p>
<h4 data-id="heading-6">实现思路</h4>
<ol>
<li>使用 <code>retryWhen</code> 捕获错误</li>
<li>使用 <code>scan</code> 计数重试次数</li>
<li>使用 <code>delay</code> 延迟重试</li>
<li>使用 <code>take</code> 限制重试次数</li>
</ol>
<h4 data-id="heading-7">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 最大重试次数</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> maxRetries = <span class="hljs-number">3</span>;

<span class="hljs-comment">// 发起请求（带重试逻辑）</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">makeRequestWithRetry</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 重置状态</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span> = {
    <span class="hljs-attr">status</span>: <span class="hljs-string">'requesting'</span>,
    <span class="hljs-attr">retryCount</span>: <span class="hljs-number">0</span>
  };
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">ApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span>/api/fail`</span>)
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-comment">// 使用 retryWhen 实现失败后 3 秒重试</span>
      <span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span> 
        errors.<span class="hljs-title function_">pipe</span>(
          <span class="hljs-comment">// 使用 scan 来计数重试次数</span>
          <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">retryCount, error</span>) =&gt;</span> {
            <span class="hljs-comment">// 更新重试次数</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">retryCount</span> = retryCount + <span class="hljs-number">1</span>;
            
            <span class="hljs-comment">// 如果还没超过最大重试次数，更新状态为重试中</span>
            <span class="hljs-keyword">if</span> (retryCount &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxRetries</span>) {
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'retrying'</span>;
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
            }
            
            <span class="hljs-keyword">return</span> retryCount + <span class="hljs-number">1</span>;
          }, <span class="hljs-number">0</span>),
          <span class="hljs-comment">// 延迟 3 秒后重试</span>
          <span class="hljs-title function_">delay</span>(<span class="hljs-number">3000</span>),
          <span class="hljs-comment">// 最多重试 maxRetries 次</span>
          <span class="hljs-title function_">take</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxRetries</span>)
        )
      ),
      <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
        <span class="hljs-comment">// 如果最终失败，返回错误</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'failed'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">error</span> = err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败，已达到最大重试次数'</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>);
      })
    )
    .<span class="hljs-title function_">subscribe</span>({
      <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (response) {
          <span class="hljs-comment">// 请求成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'success'</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">response</span> = response;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        }
      },
      <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理错误（虽然已经在 catchError 中处理了）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'failed'</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'failed'</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestStatus</span>.<span class="hljs-property">error</span> = err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        }
      }
    });
}
</code></pre>
<h3 data-id="heading-8">关键点解析</h3>
<h4 data-id="heading-9">1. retryWhen 的工作机制</h4>
<p><code>retryWhen</code> 接收一个函数，该函数接收一个 Observable（错误流），返回一个 Observable。当返回的 Observable 发出值时，会重试源 Observable。</p>
<h4 data-id="heading-10">2. scan 操作符计数</h4>
<p><code>scan</code> 操作符用于累积值，这里用来计数重试次数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">retryCount, error</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> retryCount + <span class="hljs-number">1</span>; <span class="hljs-comment">// 每次错误时递增</span>
}, <span class="hljs-number">0</span>) <span class="hljs-comment">// 初始值为 0</span>
</code></pre>
<h4 data-id="heading-11">3. delay 延迟重试</h4>
<p><code>delay(3000)</code> 会在重试前等待 3 秒，给服务器恢复的时间。</p>
<h4 data-id="heading-12">4. take 限制重试次数</h4>
<p><code>take(this.maxRetries)</code> 确保最多重试 3 次，超过后不再重试。</p>
<h4 data-id="heading-13">5. 执行流程</h4>
<ol>
<li><strong>第一次请求</strong>：失败 → 进入 <code>retryWhen</code></li>
<li><strong>第一次重试</strong>：等待 3 秒 → 重试 → 如果失败，继续</li>
<li><strong>第二次重试</strong>：等待 3 秒 → 重试 → 如果失败，继续</li>
<li><strong>第三次重试</strong>：等待 3 秒 → 重试 → 如果失败，不再重试</li>
<li><strong>最终结果</strong>：成功或失败</li>
</ol>
<h3 data-id="heading-14">高级用法</h3>
<h4 data-id="heading-15">1. 指数退避（Exponential Backoff）</h4>
<p>每次重试的延迟时间递增：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
  errors.<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">retryCount, error</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> delay = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1000</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, retryCount), <span class="hljs-number">10000</span>); <span class="hljs-comment">// 指数递增，最多 10 秒</span>
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">retryCount</span>: retryCount + <span class="hljs-number">1</span>, delay };
    }, { <span class="hljs-attr">retryCount</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">delay</span>: <span class="hljs-number">1000</span> }),
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function">(<span class="hljs-params">{ delay }</span>) =&gt;</span> <span class="hljs-title function_">timer</span>(delay)), <span class="hljs-comment">// 使用动态延迟</span>
    <span class="hljs-title function_">take</span>(<span class="hljs-number">5</span>)
  )
)
</code></pre>
<h4 data-id="heading-16">2. 根据错误类型决定是否重试</h4>
<p>只对特定错误重试：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
  errors.<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function">(<span class="hljs-params">error, index</span>) =&gt;</span> {
      <span class="hljs-comment">// 只对 500 错误重试</span>
      <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">500</span> &amp;&amp; index &lt; <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">timer</span>(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 延迟 3 秒后重试</span>
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> error); <span class="hljs-comment">// 其他错误不重试</span>
    })
  )
)
</code></pre>
<h4 data-id="heading-17">3. 重试前执行操作</h4>
<p>在重试前执行一些操作（如刷新 Token）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
  errors.<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function">(<span class="hljs-params">error, index</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; index &lt; <span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 刷新 Token 后再重试</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">refreshToken</span>().<span class="hljs-title function_">pipe</span>(
          <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">timer</span>(<span class="hljs-number">1000</span>)) <span class="hljs-comment">// 延迟 1 秒后重试</span>
        );
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> error);
    })
  )
)
</code></pre>
<h3 data-id="heading-18">与其他方案的对比</h3>
<h4 data-id="heading-19">方案 1：使用 retry（简单但不灵活）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ⚠️ 立即重试，无法延迟</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">retry</span>(<span class="hljs-number">3</span>)
)
</code></pre>
<h4 data-id="heading-20">方案 2：手动实现（复杂）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ⚠️ 需要手动管理状态和循环</span>
<span class="hljs-keyword">let</span> retryCount = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> maxRetries = <span class="hljs-number">3</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">makeRequest</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (retryCount &lt; maxRetries) {
        retryCount++;
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">timer</span>(<span class="hljs-number">3000</span>).<span class="hljs-title function_">pipe</span>(
          <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">makeRequest</span>())
        );
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> error);
    })
  );
}
</code></pre>
<h4 data-id="heading-21">方案 3：使用 retryWhen（推荐）✅</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 简洁、灵活</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
    errors.<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">count</span>) =&gt;</span> count + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
      <span class="hljs-title function_">delay</span>(<span class="hljs-number">3000</span>),
      <span class="hljs-title function_">take</span>(<span class="hljs-number">3</span>)
    )
  )
)
</code></pre>
<h3 data-id="heading-22">实际应用场景</h3>
<h4 data-id="heading-23">1. API 请求重试</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 网络请求失败后重试</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
    errors.<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">count</span>) =&gt;</span> count + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
      <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">3</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'重试次数过多'</span>));
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">timer</span>(<span class="hljs-number">1000</span> * count); <span class="hljs-comment">// 延迟时间递增</span>
      })
    )
  )
)
</code></pre>
<h4 data-id="heading-24">2. WebSocket 连接重试</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// WebSocket 连接失败后重试</span>
<span class="hljs-title function_">connectWebSocket</span>().<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
    errors.<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">count</span>) =&gt;</span> count + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
      <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">5</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'连接失败'</span>));
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">timer</span>(<span class="hljs-number">2000</span> * count); <span class="hljs-comment">// 延迟时间递增</span>
      })
    )
  )
)
</code></pre>
<h4 data-id="heading-25">3. 文件上传重试</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 文件上传失败后重试</span>
<span class="hljs-title function_">uploadFile</span>(file).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
    errors.<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">count</span>) =&gt;</span> count + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
      <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">2</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'上传失败'</span>));
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">timer</span>(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 固定延迟 3 秒</span>
      })
    )
  )
)
</code></pre>
<h3 data-id="heading-26">性能优化建议</h3>
<h4 data-id="heading-27">1. 合理设置重试次数</h4>
<p>根据业务需求设置合理的重试次数：</p>
<ul>
<li><strong>关键操作</strong>：3-5 次</li>
<li><strong>非关键操作</strong>：1-2 次</li>
<li><strong>实时性要求高</strong>：1 次或不重试</li>
</ul>
<h4 data-id="heading-28">2. 使用指数退避</h4>
<p>对于可能长时间故障的服务，使用指数退避：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
  errors.<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">count</span>) =&gt;</span> count + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">count</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> delay = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1000</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, count), <span class="hljs-number">30000</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">timer</span>(delay);
    }),
    <span class="hljs-title function_">take</span>(<span class="hljs-number">5</span>)
  )
)
</code></pre>
<h4 data-id="heading-29">3. 根据错误类型决定是否重试</h4>
<p>只对可恢复的错误重试：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">retryWhen</span>(<span class="hljs-function"><span class="hljs-params">errors</span> =&gt;</span>
  errors.<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function">(<span class="hljs-params">error, index</span>) =&gt;</span> {
      <span class="hljs-comment">// 只对网络错误和 5xx 错误重试</span>
      <span class="hljs-keyword">if</span> ((error.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">500</span> || !error.<span class="hljs-property">status</span>) &amp;&amp; index &lt; <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">timer</span>(<span class="hljs-number">3000</span>);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-function">() =&gt;</span> error);
    })
  )
)
</code></pre>
<h3 data-id="heading-30">注意事项</h3>
<ol>
<li><strong>无限重试</strong>：确保使用 <code>take</code> 限制重试次数，避免无限重试</li>
<li><strong>资源占用</strong>：重试会占用资源，需要合理设置重试次数和延迟</li>
<li><strong>用户体验</strong>：给用户适当的反馈，告知正在重试</li>
<li><strong>错误处理</strong>：确保最终失败时有适当的错误处理</li>
</ol>
<h3 data-id="heading-31">总结</h3>
<p><code>retryWhen</code> 是实现灵活重试机制的强大工具，它允许我们：</p>
<ul>
<li><strong>自定义重试逻辑</strong>：根据错误类型和次数决定是否重试</li>
<li><strong>延迟重试</strong>：在重试前等待，给服务器恢复的时间</li>
<li><strong>限制重试次数</strong>：避免无限重试</li>
<li><strong>指数退避</strong>：延迟时间递增，减少服务器压力</li>
</ul>
<p>在实际项目中，根据具体需求选择合适的重试策略，既能提高请求的成功率，又能避免过度重试带来的资源浪费。</p>
<p>记住：<strong>重试是一种容错机制，但不是万能的。对于关键操作，还需要考虑其他容错方案，如降级、缓存等</strong>。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第九章使用 exhaustMap 实现轮询机制]]></title>    <link>https://juejin.cn/post/7600560664407556159</link>    <guid>https://juejin.cn/post/7600560664407556159</guid>    <pubDate>2026-01-29T09:06:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600560664407556159" data-draft-id="7600469605477023786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第九章使用 exhaustMap 实现轮询机制"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:06:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第九章使用 exhaustMap 实现轮询机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:06:15.000Z" title="Thu Jan 29 2026 09:06:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 exhaustMap 实现轮询机制</h2>
<h3 data-id="heading-1">概述</h3>
<p>轮询（Polling）是一种定期检查数据更新的技术，常用于实时性要求不高的场景，比如检查任务状态、获取最新数据等。本章将介绍如何使用 RxJS 的 <code>timer</code> 和 <code>exhaustMap</code> 操作符实现优雅的轮询机制。</p>
<h3 data-id="heading-2">轮询的基本概念</h3>
<p>轮询是指定期（如每 3 秒）发起请求，检查数据是否有更新。常见的轮询场景包括：</p>
<ul>
<li><strong>任务状态检查</strong>：定期检查后台任务是否完成</li>
<li><strong>数据同步</strong>：定期从服务器获取最新数据</li>
<li><strong>消息通知</strong>：定期检查是否有新消息</li>
</ul>
<h3 data-id="heading-3">为什么使用 exhaustMap？</h3>
<p>在轮询场景中，如果前一个请求还没完成，新的轮询周期又到了，我们通常希望：</p>
<ul>
<li><strong>忽略新的请求</strong>：等待前一个请求完成</li>
<li><strong>避免请求堆积</strong>：防止多个请求同时进行</li>
</ul>
<p><code>exhaustMap</code> 正是为此设计的：它会忽略新的值，直到当前的内部 Observable 完成。</p>
<h4 data-id="heading-4">exhaustMap vs 其他操作符</h4>






























<table><thead><tr><th>操作符</th><th>行为</th><th>适用场景</th></tr></thead><tbody><tr><td><code>mergeMap</code></td><td>并发执行所有请求</td><td>需要所有请求的结果</td></tr><tr><td><code>concatMap</code></td><td>按顺序执行请求</td><td>需要保证顺序</td></tr><tr><td><code>switchMap</code></td><td>取消之前的请求</td><td>只需要最新结果</td></tr><tr><td><code>exhaustMap</code></td><td>忽略新的请求</td><td>避免请求堆积（轮询）</td></tr></tbody></table>
<h3 data-id="heading-5">实战场景：定期轮询 API</h3>
<p>假设我们需要每 3 秒轮询一次 API，获取最新数据。如果前一个请求还没完成，应该忽略新的轮询周期。</p>
<h4 data-id="heading-6">实现思路</h4>
<ol>
<li>使用 <code>timer(0, 3000)</code> 创建定时器（立即执行第一次，然后每 3 秒执行一次）</li>
<li>使用 <code>exhaustMap</code> 确保前一个请求完成后再执行下一个</li>
<li>使用 <code>catchError</code> 处理单个请求的错误</li>
<li>记录每次轮询的结果</li>
</ol>
<h4 data-id="heading-7">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 轮询间隔（毫秒）</span>
<span class="hljs-keyword">readonly</span> pollInterval = <span class="hljs-number">3000</span>; <span class="hljs-comment">// 3秒</span>

<span class="hljs-comment">// 轮询订阅</span>
<span class="hljs-keyword">private</span> pollSubscription?: <span class="hljs-title class_">Subscription</span>;

<span class="hljs-comment">// 轮询状态</span>
isPolling = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 开始轮询</span>
<span class="hljs-title function_">startPolling</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 如果已经在轮询，先停止</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isPolling</span>) {
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPolling</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-comment">// 使用 timer(0, 3000) 立即执行第一次请求，然后每3秒执行一次</span>
  <span class="hljs-comment">// 使用 exhaustMap 确保前一个请求完成后再执行下一个，避免请求堆积</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollSubscription</span> = <span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollInterval</span>)
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> recordId = ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">recordCounter</span>;
        <span class="hljs-keyword">const</span> startTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>();
        
        <span class="hljs-comment">// 创建记录（先标记为 pending，实际在响应中更新）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">PollApiResponse</span>&gt;(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.apiBaseUrl}</span><span class="hljs-subst">${<span class="hljs-variable language_">this</span>.pollApiUrl}</span>`</span>)
          .<span class="hljs-title function_">pipe</span>(
            <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
              <span class="hljs-comment">// 错误处理</span>
              <span class="hljs-keyword">const</span> <span class="hljs-attr">errorRecord</span>: <span class="hljs-title class_">PollRecord</span> = {
                <span class="hljs-attr">id</span>: recordId,
                <span class="hljs-attr">timestamp</span>: startTime,
                <span class="hljs-attr">status</span>: <span class="hljs-string">'error'</span>,
                <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>
              };
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span>.<span class="hljs-title function_">unshift</span>(errorRecord);
              <span class="hljs-comment">// 限制记录数量，最多保留50条</span>
              <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">50</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>);
              }
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>);
            })
          );
      })
    )
    .<span class="hljs-title function_">subscribe</span>({
      <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (response) {
          <span class="hljs-keyword">const</span> <span class="hljs-attr">record</span>: <span class="hljs-title class_">PollRecord</span> = {
            <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">recordCounter</span>,
            <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
            response,
            <span class="hljs-attr">status</span>: response.<span class="hljs-property">success</span> ? <span class="hljs-string">'success'</span> : <span class="hljs-string">'error'</span>
          };
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span>.<span class="hljs-title function_">unshift</span>(record);
          <span class="hljs-comment">// 限制记录数量，最多保留50条</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">50</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>);
          }
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        }
      },
      <span class="hljs-attr">error</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'轮询错误:'</span>, error);
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopPolling</span>();
      }
    });
}

<span class="hljs-comment">// 停止轮询</span>
<span class="hljs-title function_">stopPolling</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pollSubscription</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollSubscription</span>.<span class="hljs-title function_">unsubscribe</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollSubscription</span> = <span class="hljs-literal">undefined</span>;
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPolling</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
}
</code></pre>
<h3 data-id="heading-8">关键点解析</h3>
<h4 data-id="heading-9">1. timer 操作符</h4>
<p><code>timer(0, 3000)</code> 的含义：</p>
<ul>
<li><strong>第一个参数（0）</strong>：延迟时间，0 表示立即执行第一次</li>
<li><strong>第二个参数（3000）</strong>：间隔时间，每 3000 毫秒（3 秒）执行一次</li>
</ul>
<h4 data-id="heading-10">2. exhaustMap 的作用</h4>
<p><code>exhaustMap</code> 确保：</p>
<ul>
<li>如果前一个请求还在进行，忽略新的轮询周期</li>
<li>只有当前一个请求完成后，才会处理下一个轮询周期</li>
<li>避免请求堆积，减少服务器压力</li>
</ul>
<h4 data-id="heading-11">3. 执行流程示例</h4>
<p>假设 API 响应时间为 2 秒：</p>
<ol>
<li><strong>0 秒</strong>：timer 发出第一个值 → exhaustMap 发起请求 A（2 秒）</li>
<li><strong>3 秒</strong>：timer 发出第二个值 → exhaustMap 忽略（请求 A 还在进行）</li>
<li><strong>4 秒</strong>：请求 A 完成 → 可以处理下一个值</li>
<li><strong>6 秒</strong>：timer 发出第三个值 → exhaustMap 发起请求 B（2 秒）</li>
<li><strong>8 秒</strong>：请求 B 完成</li>
</ol>
<p><strong>结果</strong>：每 3-4 秒执行一次请求，不会堆积。</p>
<h4 data-id="heading-12">4. 错误处理</h4>
<p>使用 <code>catchError</code> 确保单个请求的错误不会中断整个轮询流程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
  <span class="hljs-comment">// 记录错误，但继续轮询</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleError</span>(error);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>);
})
</code></pre>
<h3 data-id="heading-13">与其他方案的对比</h3>
<h4 data-id="heading-14">方案 1：使用 setInterval（不推荐）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不推荐：无法优雅地取消，容易导致内存泄漏</span>
<span class="hljs-keyword">const</span> interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">subscribe</span>();
}, <span class="hljs-number">3000</span>);

<span class="hljs-comment">// 需要手动清理</span>
<span class="hljs-built_in">clearInterval</span>(interval);
</code></pre>
<h4 data-id="heading-15">方案 2：使用 mergeMap（有问题）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ⚠️ 问题：可能同时发起多个请求</span>
<span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3000</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>))
)
</code></pre>
<h4 data-id="heading-16">方案 3：使用 exhaustMap（推荐）✅</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 推荐：避免请求堆积</span>
<span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3000</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>))
)
</code></pre>
<h3 data-id="heading-17">高级用法</h3>
<h4 data-id="heading-18">1. 条件轮询</h4>
<p>根据条件决定是否继续轮询：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3000</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/task-status'</span>)),
  <span class="hljs-title function_">takeWhile</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-property">status</span> !== <span class="hljs-string">'completed'</span>), <span class="hljs-comment">// 任务完成时停止轮询</span>
  <span class="hljs-title function_">finalize</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'轮询结束'</span>))
)
</code></pre>
<h4 data-id="heading-19">2. 动态调整轮询间隔</h4>
<p>根据响应结果动态调整轮询间隔：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> pollInterval = <span class="hljs-number">3000</span>;

<span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, pollInterval).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>)),
  <span class="hljs-title function_">tap</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-comment">// 根据响应调整轮询间隔</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">hasUpdate</span>) {
      pollInterval = <span class="hljs-number">1000</span>; <span class="hljs-comment">// 有更新时加快轮询</span>
    } <span class="hljs-keyword">else</span> {
      pollInterval = <span class="hljs-number">5000</span>; <span class="hljs-comment">// 无更新时减慢轮询</span>
    }
  })
)
</code></pre>
<h4 data-id="heading-20">3. 指数退避轮询</h4>
<p>如果请求失败，逐渐增加轮询间隔：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> pollInterval = <span class="hljs-number">3000</span>;
<span class="hljs-keyword">let</span> consecutiveErrors = <span class="hljs-number">0</span>;

<span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, pollInterval).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function">() =&gt;</span> 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">tap</span>(<span class="hljs-function">() =&gt;</span> {
        consecutiveErrors = <span class="hljs-number">0</span>; <span class="hljs-comment">// 成功时重置错误计数</span>
        pollInterval = <span class="hljs-number">3000</span>; <span class="hljs-comment">// 重置间隔</span>
      }),
      <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        consecutiveErrors++;
        pollInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">3000</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, consecutiveErrors), <span class="hljs-number">30000</span>); <span class="hljs-comment">// 指数退避</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>);
      })
    )
  )
)
</code></pre>
<h3 data-id="heading-21">实际应用场景</h3>
<h4 data-id="heading-22">1. 任务状态检查</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检查后台任务是否完成</span>
<span class="hljs-title function_">startPollingTaskStatus</span>(<span class="hljs-attr">taskId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2000</span>).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTaskStatus</span>(taskId)),
    <span class="hljs-title function_">takeWhile</span>(<span class="hljs-function"><span class="hljs-params">status</span> =&gt;</span> status !== <span class="hljs-string">'completed'</span> &amp;&amp; status !== <span class="hljs-string">'failed'</span>),
    <span class="hljs-title function_">finalize</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 任务完成，停止轮询</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onTaskComplete</span>();
    })
  ).<span class="hljs-title function_">subscribe</span>();
}
</code></pre>
<h4 data-id="heading-23">2. 数据同步</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定期同步数据</span>
<span class="hljs-title function_">startDataSync</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5000</span>).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">syncData</span>()),
    <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'同步失败:'</span>, error);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 继续轮询</span>
    })
  ).<span class="hljs-title function_">subscribe</span>();
}
</code></pre>
<h4 data-id="heading-24">3. 消息通知</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定期检查新消息</span>
<span class="hljs-title function_">startMessagePolling</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">timer</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3000</span>).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">exhaustMap</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkNewMessages</span>()),
    <span class="hljs-title function_">tap</span>(<span class="hljs-function"><span class="hljs-params">messages</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (messages.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showNotifications</span>(messages);
      }
    })
  ).<span class="hljs-title function_">subscribe</span>();
}
</code></pre>
<h3 data-id="heading-25">性能优化建议</h3>
<h4 data-id="heading-26">1. 合理设置轮询间隔</h4>
<p>根据业务需求设置合理的轮询间隔：</p>
<ul>
<li><strong>实时性要求高</strong>：1-3 秒</li>
<li><strong>一般场景</strong>：3-5 秒</li>
<li><strong>实时性要求低</strong>：10-30 秒</li>
</ul>
<h4 data-id="heading-27">2. 限制记录数量</h4>
<p>对于轮询结果，限制记录数量，避免内存占用过大：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">50</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pollRecords</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>);
}
</code></pre>
<h4 data-id="heading-28">3. 在页面不可见时暂停轮询</h4>
<p>使用 Page Visibility API 在页面不可见时暂停轮询：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">fromEvent</span>(<span class="hljs-variable language_">document</span>, <span class="hljs-string">'visibilitychange'</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">hidden</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopPolling</span>();
      <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">EMPTY</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startPolling</span>();
      <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">EMPTY</span>;
    }
  })
).<span class="hljs-title function_">subscribe</span>();
</code></pre>
<h3 data-id="heading-29">注意事项</h3>
<ol>
<li><strong>内存泄漏</strong>：确保在组件销毁时取消订阅</li>
<li><strong>服务器压力</strong>：合理设置轮询间隔，避免给服务器造成过大压力</li>
<li><strong>网络消耗</strong>：轮询会持续消耗网络资源，考虑使用 WebSocket 替代</li>
<li><strong>用户体验</strong>：给用户适当的反馈，告知正在轮询</li>
</ol>
<h3 data-id="heading-30">总结</h3>
<p>使用 <code>exhaustMap</code> 实现轮询机制是一个优雅的解决方案，它通过忽略新的请求来确保：</p>
<ul>
<li><strong>避免请求堆积</strong>：前一个请求完成后再执行下一个</li>
<li><strong>资源节约</strong>：不会同时发起多个请求</li>
<li><strong>代码简洁</strong>：使用 RxJS 操作符，代码清晰易读</li>
<li><strong>易于管理</strong>：可以轻松启动和停止轮询</li>
</ul>
<p>记住：<strong>轮询是一种简单但有效的实时数据获取方式，但对于实时性要求高的场景，考虑使用 WebSocket 或 Server-Sent Events</strong>。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战：基于 LangChain + Multimodal RAG 构建视频知识库（数据清洗全流程）]]></title>    <link>https://juejin.cn/post/7600489282839609354</link>    <guid>https://juejin.cn/post/7600489282839609354</guid>    <pubDate>2026-01-29T09:06:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282839609354" data-draft-id="7600601482689855534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战：基于 LangChain + Multimodal RAG 构建视频知识库（数据清洗全流程）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T09:06:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FT542"/> <meta itemprop="url" content="https://juejin.cn/user/3423222479199755"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战：基于 LangChain + Multimodal RAG 构建视频知识库（数据清洗全流程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3423222479199755/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FT542
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:06:03.000Z" title="Thu Jan 29 2026 09:06:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在训练垂直领域的 Video-Text 模型时，我们通常遵循 <code>Data Ingestion -&gt; Cleaning -&gt; Chunking -&gt; Embedding</code> 的标准链路。</p>
<p>痛点在于 <strong>Cleaning</strong> 环节。传统的 <code>OpenCV In-painting</code> 方法推理成本过高（处理 1000 小时视频需要数千 GPU 时），且容易产生伪影。在工程实践中，最优解是<strong>溯源</strong>——直接获取 CDN 分发端的原始 MP4 流。</p>
<h4 data-id="heading-0">1. Pipeline 架构设计</h4>
<p>我们不造轮子，而是组合工具。</p>
<ul>
<li><strong>Orchestration</strong>: LangChain</li>
<li><strong>Parser Middleware</strong>: No-Code 解析器（如香蕉一键去水印）</li>
<li><strong>Vector DB</strong>: Milvus / Pinecone</li>
</ul>
<h4 data-id="heading-1">2. 核心代码实现 (Python)</h4>
<p>以下是一个标准的数据清洗类 <code>VideoCorpusCleaner</code>。注意 <code>_fetch_clean_stream</code> 方法的设计思路：我们将复杂的逆向签名逻辑（Reverse Engineering）外包给稳定的解析工具，确保 Pipeline 的健壮性。</p>
<p>Python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>
<span class="hljs-keyword">from</span> langchain.document_loaders <span class="hljs-keyword">import</span> UnstructuredFileLoader

<span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoCorpusCleaner</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, raw_metadata: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]</span>):
        self.metadata = raw_metadata
        self.output_dir = <span class="hljs-string">"./clean_corpus/video"</span>
        os.makedirs(self.output_dir, exist_ok=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_fetch_clean_stream</span>(<span class="hljs-params">self, share_url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        核心逻辑：通过解析层获取无水印直链 (Clean Stream URL)
        
        Engineering Note:
        维护各平台的 JS 逆向签名成本极高（Time Consuming）。
        生产环境建议接入 '香蕉一键去水印' 这类小程序作为 Parser Middleware。
        输入 Share URL -&gt; 输出 Origin MP4 URL (无水印/1080P)。
        """</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[*] Parsing Deep Link: <span class="hljs-subst">{share_url}</span>"</span>)
        
        <span class="hljs-comment"># 模拟调用解析接口或手动获取</span>
        <span class="hljs-comment"># 实际部署时，这里通常是一个 API Call</span>
        <span class="hljs-comment"># 优势：直接获取 Ground Truth 级别的原始素材，无需 CV 后处理</span>
        clean_url = <span class="hljs-string">"https://cdn.platform.com/origin_stream_example.mp4"</span> 
        <span class="hljs-keyword">return</span> clean_url

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_and_validate</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span>, file_id: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""下载流并校验完整性"""</span>
        clean_url = self._fetch_clean_stream(url)
        save_path = os.path.join(self.output_dir, <span class="hljs-string">f"<span class="hljs-subst">{file_id}</span>.mp4"</span>)
        
        <span class="hljs-comment"># 使用 curl 进行高并发下载</span>
        cmd = <span class="hljs-string">f"curl -L -o <span class="hljs-subst">{save_path}</span> '<span class="hljs-subst">{clean_url}</span>'"</span>
        subprocess.run(cmd, shell=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span>)
        
        <span class="hljs-keyword">if</span> self._check_integrity(save_path):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[+] Asset <span class="hljs-subst">{file_id}</span> sanitized and saved."</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[-] Asset <span class="hljs-subst">{file_id}</span> corrupted."</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_check_integrity</span>(<span class="hljs-params">self, path</span>):
        <span class="hljs-keyword">return</span> os.path.getsize(path) &gt; <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment"># Simple check</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_process</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.metadata:
            <span class="hljs-comment"># 针对图文数据集(Gallery)和视频(Video)分别处理</span>
            self.download_and_validate(item[<span class="hljs-string">'url'</span>], item[<span class="hljs-string">'id'</span>])

<span class="hljs-comment"># Usage Example</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 模拟数据源：通常来自爬虫库</span>
    sample_data = [
        {<span class="hljs-string">"id"</span>: <span class="hljs-string">"v001"</span>, <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://v.douyin.com/xyz/"</span>},
        {<span class="hljs-string">"id"</span>: <span class="hljs-string">"v002"</span>, <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://xhslink.com/abc/"</span>}
    ]
    
    cleaner = VideoCorpusCleaner(sample_data)
    cleaner.batch_process()
</code></pre>
<h4 data-id="heading-2">3. 向量化与入库</h4>
<p>拿到 Clean Data 后，我们可以直接抽取关键帧（Keyframes）进行 CLIP 编码，此时的向量空间分布将不再受平台 Logo 的干扰。</p>
<p>Python</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Pseudo-code for Embedding</span>
from transformers import CLIPProcessor, CLIPModel

<span class="hljs-attr">model</span> = CLIPModel.from_pretrained(<span class="hljs-string">"openai/clip-vit-base-patch32"</span>)
<span class="hljs-attr">processor</span> = CLIPProcessor.from_pretrained(<span class="hljs-string">"openai/clip-vit-base-patch32"</span>)

<span class="hljs-comment"># 由于在上一步通过 Parser 获取了无水印原片，</span>
<span class="hljs-comment"># 这里的 image_inputs 不需要再做 crop 或 mask 操作，直接输入全图</span>
<span class="hljs-attr">image_inputs</span> = processor(images=cleaned_frames, return_tensors=<span class="hljs-string">"pt"</span>)
<span class="hljs-attr">image_features</span> = model.get_image_features(**image_inputs)
</code></pre>
<hr/>
<p><strong>⚙️ Tech Stack &amp; QA (工程化工具栈)</strong></p>






























<table><thead><tr><th><strong>Layer</strong></th><th><strong>Tool Name</strong></th><th><strong>Role in Pipeline</strong></th></tr></thead><tbody><tr><td><strong>Model</strong></td><td>OpenAI CLIP</td><td>多模态特征对齐与编码</td></tr><tr><td><strong>Framework</strong></td><td>LangChain</td><td>编排数据处理流程</td></tr><tr><td><strong>Asset Parser</strong></td><td><strong>香蕉一键去水印</strong></td><td><strong>[ETL 清洗]</strong> 替代 OpenCV，作为无代码解析器提取<strong>无水印 MP4</strong> 和 <strong>图集原图</strong> (Ground Truth)。</td></tr><tr><td><strong>Storage</strong></td><td>Milvus (Lite)</td><td>向量数据持久化存储</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第十章使用 RxJS 实现大文件分片上传]]></title>    <link>https://juejin.cn/post/7600469605477056554</link>    <guid>https://juejin.cn/post/7600469605477056554</guid>    <pubDate>2026-01-29T09:06:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600469605477056554" data-draft-id="7600562816458506282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第十章使用 RxJS 实现大文件分片上传"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:06:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第十章使用 RxJS 实现大文件分片上传
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:06:50.000Z" title="Thu Jan 29 2026 09:06:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 RxJS 实现大文件分片上传</h2>
<h3 data-id="heading-1">概述</h3>
<p>大文件上传是 Web 开发中的常见需求。直接上传大文件可能会遇到以下问题：</p>
<ol>
<li><strong>超时</strong>：文件太大，上传时间过长，导致请求超时</li>
<li><strong>内存占用</strong>：大文件占用大量内存</li>
<li><strong>网络中断</strong>：网络不稳定时，需要重新上传整个文件</li>
<li><strong>用户体验差</strong>：无法显示上传进度，用户不知道上传状态</li>
</ol>
<p>分片上传（Chunk Upload）是解决这些问题的有效方案。本章将介绍如何使用 RxJS 实现大文件分片上传，包括断点续传、进度显示、并发控制等功能。</p>
<h3 data-id="heading-2">分片上传的基本概念</h3>
<p>分片上传是指将大文件分割成多个小片段（Chunk），逐个上传，最后在服务器端合并。主要优势包括：</p>
<ol>
<li><strong>避免超时</strong>：每个分片较小，上传时间短</li>
<li><strong>断点续传</strong>：网络中断后，只需上传未完成的分片</li>
<li><strong>进度显示</strong>：可以显示每个分片和整体的上传进度</li>
<li><strong>并发控制</strong>：可以控制同时上传的分片数量</li>
</ol>
<h3 data-id="heading-3">实现思路</h3>
<h4 data-id="heading-4">1. 文件分片</h4>
<p>将文件按照指定大小（如 2MB）分割成多个分片：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">createChunks</span>(<span class="hljs-attr">file</span>: <span class="hljs-title class_">File</span>): <span class="hljs-title class_">ChunkInfo</span>[] {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">chunks</span>: <span class="hljs-title class_">ChunkInfo</span>[] = [];
  <span class="hljs-keyword">const</span> totalChunks = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(file.<span class="hljs-property">size</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">CHUNK_SIZE</span>);
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; totalChunks; i++) {
    <span class="hljs-keyword">const</span> start = i * <span class="hljs-variable language_">this</span>.<span class="hljs-property">CHUNK_SIZE</span>;
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + <span class="hljs-variable language_">this</span>.<span class="hljs-property">CHUNK_SIZE</span>, file.<span class="hljs-property">size</span>);
    <span class="hljs-keyword">const</span> blob = file.<span class="hljs-title function_">slice</span>(start, end);
    
    chunks.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">index</span>: i,
      start,
      end,
      blob,
      <span class="hljs-attr">uploaded</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span>
    });
  }
  
  <span class="hljs-keyword">return</span> chunks;
}
</code></pre>
<h4 data-id="heading-5">2. 上传单个分片</h4>
<p>使用 <code>HttpRequest</code> 的 <code>reportProgress</code> 选项来跟踪上传进度：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">uploadChunk</span>(<span class="hljs-attr">chunk</span>: <span class="hljs-title class_">ChunkInfo</span>, <span class="hljs-attr">fileId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">file</span>: <span class="hljs-title class_">File</span>): <span class="hljs-title class_">Observable</span>&lt;{ <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">progress</span>: <span class="hljs-built_in">number</span> }&gt; {
  <span class="hljs-comment">// 如果已经上传，直接返回</span>
  <span class="hljs-keyword">if</span> (chunk.<span class="hljs-property">uploaded</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>({ <span class="hljs-attr">index</span>: chunk.<span class="hljs-property">index</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">100</span> });
  }
  
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, chunk.<span class="hljs-property">blob</span>);
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'chunkIndex'</span>, chunk.<span class="hljs-property">index</span>.<span class="hljs-title function_">toString</span>());
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'fileId'</span>, fileId);
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'fileName'</span>, file.<span class="hljs-property">name</span>);
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'totalChunks'</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(file.<span class="hljs-property">size</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">CHUNK_SIZE</span>).<span class="hljs-title function_">toString</span>());
  
  <span class="hljs-keyword">const</span> req = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequest</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.API_BASE_URL}</span>/api/upload/chunk`</span>, formData, {
    <span class="hljs-attr">reportProgress</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 启用进度报告</span>
  });
  
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">request</span>(req).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">event: HttpEvent&lt;<span class="hljs-built_in">any</span>&gt;</span>) =&gt;</span> {
      <span class="hljs-keyword">switch</span> (event.<span class="hljs-property">type</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">HttpEventType</span>.<span class="hljs-property">UploadProgress</span>:
          <span class="hljs-keyword">if</span> (event.<span class="hljs-property">total</span>) {
            <span class="hljs-keyword">const</span> progress = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((<span class="hljs-number">100</span> * event.<span class="hljs-property">loaded</span>) / event.<span class="hljs-property">total</span>);
            <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: chunk.<span class="hljs-property">index</span>, progress };
          }
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: chunk.<span class="hljs-property">index</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span> };
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">HttpEventType</span>.<span class="hljs-property">Response</span>:
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: chunk.<span class="hljs-property">index</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">100</span> };
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">index</span>: chunk.<span class="hljs-property">index</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span> };
      }
    }),
    <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`分片 <span class="hljs-subst">${chunk.index}</span> 上传失败:`</span>, error);
      <span class="hljs-keyword">throw</span> { <span class="hljs-attr">index</span>: chunk.<span class="hljs-property">index</span>, error };
    })
  );
}
</code></pre>
<h4 data-id="heading-6">3. 并发上传多个分片</h4>
<p>使用 <code>mergeMap</code> 并发上传多个分片，并通过第二个参数限制并发数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 获取未上传的分片</span>
<span class="hljs-keyword">const</span> pendingChunks = chunks.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> !c.<span class="hljs-property">uploaded</span>);

<span class="hljs-comment">// 创建分片上传流</span>
<span class="hljs-keyword">const</span> chunkStreams$ = <span class="hljs-title function_">from</span>(pendingChunks).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">chunk</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">uploadChunk</span>(chunk, fileId, file).<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUploadCancel$</span>),
      <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-comment">// 处理错误，继续上传其他分片</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`分片 <span class="hljs-subst">${chunk.index}</span> 上传失败:`</span>, error);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>) {
          <span class="hljs-keyword">const</span> chunkToUpdate = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">index</span> === chunk.<span class="hljs-property">index</span>);
          <span class="hljs-keyword">if</span> (chunkToUpdate) {
            chunkToUpdate.<span class="hljs-property">progress</span> = <span class="hljs-number">0</span>;
          }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">EMPTY</span>;
      })
    );
  }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">CONCURRENT_LIMIT</span>), <span class="hljs-comment">// 并发限制：最多同时上传 3 个分片</span>
  <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroy$</span>)
);
</code></pre>
<h4 data-id="heading-7">4. 聚合进度</h4>
<p>使用 <code>scan</code> 操作符聚合所有分片的上传进度：</p>
<pre><code class="hljs language-typescript" lang="typescript">chunkStreams$.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc, chunkProgress</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>) {
      <span class="hljs-keyword">return</span> acc;
    }
    
    <span class="hljs-keyword">const</span> chunk = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">index</span> === chunkProgress.<span class="hljs-property">index</span>);
    <span class="hljs-keyword">if</span> (chunk) {
      chunk.<span class="hljs-property">progress</span> = chunkProgress.<span class="hljs-property">progress</span>;
      <span class="hljs-keyword">if</span> (chunkProgress.<span class="hljs-property">progress</span> === <span class="hljs-number">100</span>) {
        chunk.<span class="hljs-property">uploaded</span> = <span class="hljs-literal">true</span>;
      }
    }
    
    <span class="hljs-comment">// 计算总进度</span>
    <span class="hljs-keyword">const</span> uploadedSize = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, c</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (c.<span class="hljs-property">uploaded</span>) {
        <span class="hljs-keyword">return</span> sum + c.<span class="hljs-property">blob</span>.<span class="hljs-property">size</span>;
      }
      <span class="hljs-keyword">return</span> sum + (c.<span class="hljs-property">blob</span>.<span class="hljs-property">size</span> * c.<span class="hljs-property">progress</span> / <span class="hljs-number">100</span>);
    }, <span class="hljs-number">0</span>);
    
    <span class="hljs-keyword">const</span> uploadedChunks = <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">uploaded</span>).<span class="hljs-property">length</span>;
    
    <span class="hljs-keyword">const</span> progress = {
      <span class="hljs-attr">loaded</span>: uploadedSize,
      <span class="hljs-attr">total</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">file</span>.<span class="hljs-property">size</span>,
      <span class="hljs-attr">percentage</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((uploadedSize / <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">file</span>.<span class="hljs-property">size</span>) * <span class="hljs-number">100</span>),
      uploadedChunks,
      <span class="hljs-attr">totalChunks</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">chunks</span>.<span class="hljs-property">length</span>
    };
    
    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'uploading'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">progress</span> = progress;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveUploadProgress</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>); <span class="hljs-comment">// 保存进度到 localStorage</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
    }
    
    <span class="hljs-keyword">return</span> progress;
  }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">progress</span>)
)
</code></pre>
<h4 data-id="heading-8">5. 断点续传</h4>
<p>使用 <code>localStorage</code> 保存上传进度，支持断点续传：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 保存上传进度</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">saveUploadProgress</span>(<span class="hljs-attr">state</span>: <span class="hljs-title class_">UploadState</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> dataToSave = {
      <span class="hljs-attr">fileId</span>: state.<span class="hljs-property">fileId</span>,
      <span class="hljs-attr">chunks</span>: state.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> ({
        <span class="hljs-attr">index</span>: c.<span class="hljs-property">index</span>,
        <span class="hljs-attr">uploaded</span>: c.<span class="hljs-property">uploaded</span>,
        <span class="hljs-attr">progress</span>: c.<span class="hljs-property">progress</span>
      })),
      <span class="hljs-attr">progress</span>: state.<span class="hljs-property">progress</span>,
      <span class="hljs-attr">status</span>: state.<span class="hljs-property">status</span>
    };
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">`<span class="hljs-subst">${STORAGE_KEY_PREFIX}</span><span class="hljs-subst">${state.fileId}</span>`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(dataToSave));
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'保存上传进度失败:'</span>, e);
  }
}

<span class="hljs-comment">// 加载上传进度</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">loadUploadProgress</span>(<span class="hljs-attr">fileId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">UploadState</span>&gt; | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">const</span> stored = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">`<span class="hljs-subst">${STORAGE_KEY_PREFIX}</span><span class="hljs-subst">${fileId}</span>`</span>);
  <span class="hljs-keyword">if</span> (stored) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(stored);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'解析上传进度失败:'</span>, e);
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h4 data-id="heading-9">6. 合并分片</h4>
<p>所有分片上传完成后，调用合并接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 合并所有分片</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">mergeChunks</span>(<span class="hljs-attr">fileId</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">fileName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">totalChunks</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpParams</span>()
    .<span class="hljs-title function_">set</span>(<span class="hljs-string">'fileId'</span>, fileId)
    .<span class="hljs-title function_">set</span>(<span class="hljs-string">'fileName'</span>, fileName)
    .<span class="hljs-title function_">set</span>(<span class="hljs-string">'totalChunks'</span>, totalChunks.<span class="hljs-title function_">toString</span>());
  
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">http</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.API_BASE_URL}</span>/api/upload/merge`</span>, <span class="hljs-literal">null</span>, { params }).<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'合并分片失败:'</span>, error);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">of</span>({ <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'合并成功（模拟）'</span> });
    })
  );
}
</code></pre>
<h3 data-id="heading-10">完整流程</h3>
<h4 data-id="heading-11">1. 开始上传</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">startUpload</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> file = <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedFile</span>;
  <span class="hljs-keyword">const</span> fileId = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateFileId</span>(file);
  
  <span class="hljs-comment">// 创建分片</span>
  <span class="hljs-keyword">let</span> chunks = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createChunks</span>(file);
  
  <span class="hljs-comment">// 尝试从 localStorage 恢复进度</span>
  <span class="hljs-keyword">const</span> savedProgress = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadUploadProgress</span>(fileId);
  <span class="hljs-keyword">if</span> (savedProgress &amp;&amp; savedProgress.<span class="hljs-property">chunks</span>) {
    <span class="hljs-comment">// 恢复已上传的分片信息</span>
    chunks = chunks.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">chunk</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> saved = savedProgress.<span class="hljs-property">chunks</span>?.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">index</span> === chunk.<span class="hljs-property">index</span>);
      <span class="hljs-keyword">if</span> (saved) {
        <span class="hljs-keyword">return</span> {
          ...chunk,
          <span class="hljs-attr">uploaded</span>: saved.<span class="hljs-property">uploaded</span> || <span class="hljs-literal">false</span>,
          <span class="hljs-attr">progress</span>: saved.<span class="hljs-property">progress</span> || <span class="hljs-number">0</span>
        };
      }
      <span class="hljs-keyword">return</span> chunk;
    });
  }
  
  <span class="hljs-comment">// 初始化上传状态</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span> = {
    file,
    fileId,
    chunks,
    <span class="hljs-attr">progress</span>: { <span class="hljs-comment">/* ... */</span> },
    <span class="hljs-attr">status</span>: <span class="hljs-string">'uploading'</span>
  };
  
  <span class="hljs-comment">// 开始上传未完成的分片</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-12">2. 暂停上传</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">pauseUpload</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'uploading'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUploadCancel$</span>.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 取消当前上传</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUploadCancel$</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;(); <span class="hljs-comment">// 创建新的取消 Subject</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">status</span> = <span class="hljs-string">'paused'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveUploadProgress</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>); <span class="hljs-comment">// 保存进度</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
  }
}
</code></pre>
<h4 data-id="heading-13">3. 继续上传</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">resumeUpload</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">uploadState</span>.<span class="hljs-property">status</span> === <span class="hljs-string">'paused'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startUpload</span>(); <span class="hljs-comment">// 从暂停处继续</span>
  }
}
</code></pre>
<h3 data-id="heading-14">关键点解析</h3>
<h4 data-id="heading-15">1. 并发控制</h4>
<p>使用 <code>mergeMap</code> 的第二个参数限制并发数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">chunk</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">uploadChunk</span>(chunk), <span class="hljs-number">3</span>) <span class="hljs-comment">// 最多同时上传 3 个分片</span>
</code></pre>
<h4 data-id="heading-16">2. 进度计算</h4>
<p>总进度 = 所有分片的已上传大小 / 文件总大小</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> uploadedSize = chunks.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, c</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (c.<span class="hljs-property">uploaded</span>) {
    <span class="hljs-keyword">return</span> sum + c.<span class="hljs-property">blob</span>.<span class="hljs-property">size</span>; <span class="hljs-comment">// 已上传的分片，使用完整大小</span>
  }
  <span class="hljs-keyword">return</span> sum + (c.<span class="hljs-property">blob</span>.<span class="hljs-property">size</span> * c.<span class="hljs-property">progress</span> / <span class="hljs-number">100</span>); <span class="hljs-comment">// 正在上传的分片，按进度计算</span>
}, <span class="hljs-number">0</span>);
</code></pre>
<h4 data-id="heading-17">3. 错误处理</h4>
<p>单个分片上传失败不影响其他分片：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
  <span class="hljs-comment">// 记录错误，继续上传其他分片</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`分片 <span class="hljs-subst">${chunk.index}</span> 上传失败:`</span>, error);
  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">EMPTY</span>; <span class="hljs-comment">// 不中断流</span>
})
</code></pre>
<h4 data-id="heading-18">4. 取消上传</h4>
<p>使用 <code>Subject</code> 实现取消功能：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> currentUploadCancel$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();

<span class="hljs-comment">// 上传时使用 takeUntil</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">uploadChunk</span>(chunk).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUploadCancel$</span>)
)

<span class="hljs-comment">// 取消时发出信号</span>
<span class="hljs-title function_">cancelUpload</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentUploadCancel$</span>.<span class="hljs-title function_">next</span>();
}
</code></pre>
<h3 data-id="heading-19">实际应用场景</h3>
<h4 data-id="heading-20">1. 大文件上传</h4>
<p>适用于上传视频、大型文档等大文件。</p>
<h4 data-id="heading-21">2. 断点续传</h4>
<p>网络中断后，可以从上次中断的地方继续上传。</p>
<h4 data-id="heading-22">3. 进度显示</h4>
<p>实时显示上传进度，提升用户体验。</p>
<h4 data-id="heading-23">4. 并发优化</h4>
<p>通过控制并发数，平衡上传速度和服务器压力。</p>
<h3 data-id="heading-24">性能优化建议</h3>
<h4 data-id="heading-25">1. 合理设置分片大小</h4>
<p>根据网络环境和文件大小设置合理的分片大小：</p>
<ul>
<li><strong>网络好</strong>：2-5MB</li>
<li><strong>网络一般</strong>：1-2MB</li>
<li><strong>网络差</strong>：500KB-1MB</li>
</ul>
<h4 data-id="heading-26">2. 合理设置并发数</h4>
<p>根据服务器性能设置合理的并发数：</p>
<ul>
<li><strong>服务器性能好</strong>：3-5 个</li>
<li><strong>服务器性能一般</strong>：2-3 个</li>
<li><strong>服务器性能差</strong>：1-2 个</li>
</ul>
<h4 data-id="heading-27">3. 压缩文件</h4>
<p>对于可以压缩的文件（如图片），先压缩再上传。</p>
<h4 data-id="heading-28">4. 使用 Web Workers</h4>
<p>对于大文件的分片处理，可以使用 Web Workers 避免阻塞主线程。</p>
<h3 data-id="heading-29">注意事项</h3>
<ol>
<li><strong>localStorage 限制</strong>：localStorage 有大小限制（通常 5-10MB），大文件的进度信息可能无法完全保存</li>
<li><strong>服务器支持</strong>：需要服务器支持分片上传和合并接口</li>
<li><strong>文件完整性</strong>：合并后需要验证文件完整性（如 MD5）</li>
<li><strong>内存占用</strong>：大文件分片仍会占用内存，需要注意</li>
</ol>
<h3 data-id="heading-30">总结</h3>
<p>使用 RxJS 实现大文件分片上传是一个完整的解决方案，它提供了：</p>
<ul>
<li><strong>分片上传</strong>：将大文件分割成小片段上传</li>
<li><strong>断点续传</strong>：支持从上次中断处继续上传</li>
<li><strong>进度显示</strong>：实时显示上传进度</li>
<li><strong>并发控制</strong>：控制同时上传的分片数量</li>
<li><strong>错误处理</strong>：单个分片失败不影响其他分片</li>
</ul>
<p>通过合理使用 RxJS 操作符（<code>mergeMap</code>、<code>scan</code>、<code>takeUntil</code> 等），我们可以构建一个功能完整、性能优良的大文件上传系统。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第十二章使用 throttleTime 实现弹幕系统]]></title>    <link>https://juejin.cn/post/7600587732991311914</link>    <guid>https://juejin.cn/post/7600587732991311914</guid>    <pubDate>2026-01-29T09:07:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600587732991311914" data-draft-id="7600560664407621695" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第十二章使用 throttleTime 实现弹幕系统"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:07:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第十二章使用 throttleTime 实现弹幕系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:07:50.000Z" title="Thu Jan 29 2026 09:07:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 throttleTime 实现弹幕系统</h2>
<h3 data-id="heading-1">概述</h3>
<p>弹幕（Danmaku）是一种在视频或直播中实时显示用户评论的功能。在实现弹幕系统时，我们需要处理：</p>
<ol>
<li><strong>点击节流</strong>：用户快速点击时，限制弹幕创建频率</li>
<li><strong>动画管理</strong>：管理弹幕的创建、动画和销毁</li>
<li><strong>位置随机</strong>：弹幕在随机位置出现</li>
<li><strong>性能优化</strong>：避免创建过多弹幕导致性能问题</li>
</ol>
<p>本章将介绍如何使用 RxJS 的 <code>throttleTime</code> 操作符实现弹幕系统，并处理点击事件的节流。</p>
<h3 data-id="heading-2">弹幕系统的基本需求</h3>
<ol>
<li><strong>输入框发送</strong>：用户输入文字后发送弹幕</li>
<li><strong>点击触发</strong>：用户点击区域时创建随机弹幕</li>
<li><strong>动画效果</strong>：弹幕从右到左移动</li>
<li><strong>自动清理</strong>：弹幕动画结束后自动移除</li>
</ol>
<h3 data-id="heading-3">实现思路</h3>
<h4 data-id="heading-4">1. 弹幕数据结构</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 弹幕项接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DanmakuItem</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">top</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 弹幕的垂直位置（百分比）</span>
  <span class="hljs-attr">color</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 弹幕颜色</span>
  <span class="hljs-attr">speed</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 弹幕速度（秒）</span>
}
</code></pre>
<h4 data-id="heading-5">2. 点击节流</h4>
<p>使用 <code>throttleTime</code> 限制点击事件的触发频率：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 点击节流 Subject</span>
<span class="hljs-keyword">private</span> clickSubject$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-title class_">MouseEvent</span>&gt;();

<span class="hljs-comment">// 销毁 Subject</span>
<span class="hljs-keyword">private</span> destroySubject$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();

<span class="hljs-title function_">ngOnInit</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 设置点击节流：每 300ms 最多触发一次</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">clickSubject$</span>
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">300</span>), <span class="hljs-comment">// 节流：每 300ms 最多触发一次</span>
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroySubject$</span>)
    )
    .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmakuFromClick</span>(event);
    });
}

<span class="hljs-comment">// 点击区域触发弹幕（带节流）</span>
<span class="hljs-title function_">onDanmakuAreaClick</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">MouseEvent</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">clickSubject$</span>.<span class="hljs-title function_">next</span>(event);
}
</code></pre>
<h4 data-id="heading-6">3. 创建弹幕</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 弹幕颜色池</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> colors = [
  <span class="hljs-string">'#ffffff'</span>,
  <span class="hljs-string">'#ff6b6b'</span>,
  <span class="hljs-string">'#4ecdc4'</span>,
  <span class="hljs-string">'#45b7d1'</span>,
  <span class="hljs-string">'#f9ca24'</span>,
  <span class="hljs-string">'#6c5ce7'</span>,
  <span class="hljs-string">'#a29bfe'</span>,
  <span class="hljs-string">'#fd79a8'</span>,
  <span class="hljs-string">'#00b894'</span>,
  <span class="hljs-string">'#e17055'</span>,
];

<span class="hljs-comment">// 创建弹幕</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">createDanmaku</span>(<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">danmaku</span>: <span class="hljs-title class_">DanmakuItem</span> = {
    <span class="hljs-attr">id</span>: ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuIdCounter</span>,
    text,
    <span class="hljs-attr">top</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">80</span> + <span class="hljs-number">10</span>, <span class="hljs-comment">// 10% - 90% 之间的随机位置</span>
    <span class="hljs-attr">color</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span>.<span class="hljs-property">length</span>)],
    <span class="hljs-attr">speed</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">3</span> + <span class="hljs-number">5</span>, <span class="hljs-comment">// 5-8 秒之间随机速度</span>
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuList</span>.<span class="hljs-title function_">push</span>(danmaku);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();

  <span class="hljs-comment">// 弹幕动画结束后移除（速度 + 0.5秒缓冲）</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuList</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">id</span> === danmaku.<span class="hljs-property">id</span>);
    <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuList</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
    }
  }, (danmaku.<span class="hljs-property">speed</span> + <span class="hljs-number">0.5</span>) * <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 从点击事件创建弹幕</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">createDanmakuFromClick</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">MouseEvent</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> clickTexts = [
    <span class="hljs-string">'666'</span>,
    <span class="hljs-string">'太棒了！'</span>,
    <span class="hljs-string">'厉害！'</span>,
    <span class="hljs-string">'赞！'</span>,
    <span class="hljs-string">'好！'</span>,
    <span class="hljs-string">'不错！'</span>,
    <span class="hljs-string">'支持！'</span>,
    <span class="hljs-string">'加油！'</span>,
    <span class="hljs-string">'很棒！'</span>,
    <span class="hljs-string">'优秀！'</span>,
  ];
  <span class="hljs-keyword">const</span> randomText = clickTexts[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * clickTexts.<span class="hljs-property">length</span>)];
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmaku</span>(randomText);
}
</code></pre>
<h4 data-id="heading-7">4. 输入框发送</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 弹幕输入文字</span>
danmakuText = <span class="hljs-string">''</span>;

<span class="hljs-comment">// 发送弹幕（从输入框）</span>
<span class="hljs-title function_">sendDanmaku</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuText</span>.<span class="hljs-title function_">trim</span>()) {
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmaku</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuText</span>.<span class="hljs-title function_">trim</span>());
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuText</span> = <span class="hljs-string">''</span>; <span class="hljs-comment">// 清空输入框</span>
}

<span class="hljs-comment">// 回车键发送弹幕</span>
<span class="hljs-title function_">onKeyDown</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">KeyboardEvent</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span> &amp;&amp; !event.<span class="hljs-property">shiftKey</span>) {
    event.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendDanmaku</span>();
  }
}
</code></pre>
<h3 data-id="heading-8">CSS 动画实现</h3>
<p>弹幕的移动动画通过 CSS 实现：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.danmaku-item</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">white-space</span>: nowrap;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">font-weight</span>: bold;
  <span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">2px</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">animation</span>: danmaku-move linear;
  <span class="hljs-attribute">pointer-events</span>: none;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}

<span class="hljs-keyword">@keyframes</span> danmaku-move {
  <span class="hljs-selector-tag">from</span> {
    <span class="hljs-attribute">left</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>);
  }
  <span class="hljs-selector-tag">to</span> {
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">100%</span>);
  }
}
</code></pre>
<h3 data-id="heading-9">关键点解析</h3>
<h4 data-id="heading-10">1. throttleTime 的作用</h4>
<p>使用 <code>throttleTime(300)</code> 可以：</p>
<ul>
<li>限制点击事件的触发频率</li>
<li>避免用户快速点击时创建过多弹幕</li>
<li>提升性能和用户体验</li>
</ul>
<h4 data-id="heading-11">2. 弹幕位置随机</h4>
<p>通过 <code>Math.random() * 80 + 10</code> 生成 10% - 90% 之间的随机位置，避免弹幕重叠。</p>
<h4 data-id="heading-12">3. 弹幕速度随机</h4>
<p>通过 <code>Math.random() * 3 + 5</code> 生成 5-8 秒之间的随机速度，让弹幕移动更自然。</p>
<h4 data-id="heading-13">4. 自动清理</h4>
<p>使用 <code>setTimeout</code> 在弹幕动画结束后自动移除，避免内存泄漏。</p>
<h3 data-id="heading-14">执行流程示例</h3>
<p>假设用户快速点击弹幕区域：</p>
<ol>
<li><strong>0ms</strong>：用户点击 → <code>clickSubject$</code> 发出事件</li>
<li><strong>0ms</strong>：<code>throttleTime</code> 立即处理 → 创建弹幕 A</li>
<li><strong>100ms</strong>：用户再次点击 → <code>clickSubject$</code> 发出事件</li>
<li><strong>100ms</strong>：<code>throttleTime</code> 忽略（在 300ms 内）</li>
<li><strong>200ms</strong>：用户再次点击 → <code>clickSubject$</code> 发出事件</li>
<li><strong>200ms</strong>：<code>throttleTime</code> 忽略（在 300ms 内）</li>
<li><strong>400ms</strong>：用户再次点击 → <code>clickSubject$</code> 发出事件</li>
<li><strong>400ms</strong>：<code>throttleTime</code> 处理（已超过 300ms）→ 创建弹幕 B</li>
</ol>
<p><strong>结果</strong>：300ms 内只创建 1 个弹幕，避免过多弹幕。</p>
<h3 data-id="heading-15">与其他方案的对比</h3>
<h4 data-id="heading-16">方案 1：不使用节流（有问题）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误示例：快速点击会创建过多弹幕</span>
<span class="hljs-title function_">onDanmakuAreaClick</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">MouseEvent</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmakuFromClick</span>(event); <span class="hljs-comment">// 每次点击都创建</span>
}
</code></pre>
<h4 data-id="heading-17">方案 2：使用防抖（不适合）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ⚠️ 不适合：防抖会等待用户停止点击，但弹幕需要即时反馈</span>
<span class="hljs-title function_">onDanmakuAreaClick</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">MouseEvent</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmakuFromClick</span>(event);
  });
}
</code></pre>
<h4 data-id="heading-18">方案 3：使用节流（推荐）✅</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 推荐：限制频率但保持即时反馈</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">clickSubject$</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">300</span>)
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmakuFromClick</span>(event);
});
</code></pre>
<h3 data-id="heading-19">实际应用场景</h3>
<h4 data-id="heading-20">1. 视频弹幕</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 视频播放时显示弹幕</span>
<span class="hljs-title function_">playVideo</span>().<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">() =&gt;</span> 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuService</span>.<span class="hljs-title function_">getDanmakus</span>(videoId).<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">mergeMap</span>(<span class="hljs-function"><span class="hljs-params">danmaku</span> =&gt;</span> {
        <span class="hljs-comment">// 根据视频时间显示弹幕</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">timer</span>(danmaku.<span class="hljs-property">time</span> * <span class="hljs-number">1000</span>).<span class="hljs-title function_">pipe</span>(
          <span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> danmaku)
        );
      })
    )
  )
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">danmaku</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmaku</span>(danmaku.<span class="hljs-property">text</span>);
});
</code></pre>
<h4 data-id="heading-21">2. 直播弹幕</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 接收直播弹幕</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">websocketService</span>.<span class="hljs-title function_">onMessage</span>(<span class="hljs-string">'danmaku'</span>).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">100</span>) <span class="hljs-comment">// 限制弹幕创建频率</span>
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">danmaku</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmaku</span>(danmaku.<span class="hljs-property">text</span>);
});
</code></pre>
<h4 data-id="heading-22">3. 互动游戏</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 游戏中的弹幕效果</span>
<span class="hljs-title function_">onPlayerAction</span>(<span class="hljs-attr">action</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">actionSubject$</span>.<span class="hljs-title function_">next</span>(action);
}

<span class="hljs-variable language_">this</span>.<span class="hljs-property">actionSubject$</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">throttleTime</span>(<span class="hljs-number">500</span>) <span class="hljs-comment">// 限制动作触发频率</span>
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createDanmaku</span>(action);
});
</code></pre>
<h3 data-id="heading-23">性能优化建议</h3>
<h4 data-id="heading-24">1. 限制弹幕数量</h4>
<p>限制同时显示的弹幕数量，避免性能问题：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 限制弹幕数量</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-variable constant_">MAX_DANMAKU</span> = <span class="hljs-number">50</span>;

<span class="hljs-keyword">private</span> <span class="hljs-title function_">createDanmaku</span>(<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 如果弹幕数量超过限制，移除最旧的</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuList</span>.<span class="hljs-property">length</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">MAX_DANMAKU</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuList</span>.<span class="hljs-title function_">shift</span>();
  }
  
  <span class="hljs-comment">// 创建新弹幕</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-25">2. 使用虚拟滚动</h4>
<p>对于大量弹幕，可以使用虚拟滚动技术：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 只渲染可见区域的弹幕</span>
<span class="hljs-title function_">getVisibleDanmakus</span>(): <span class="hljs-title class_">DanmakuItem</span>[] {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuList</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">danmaku</span> =&gt;</span> {
    <span class="hljs-comment">// 判断弹幕是否在可见区域</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isDanmakuVisible</span>(danmaku);
  });
}
</code></pre>
<h4 data-id="heading-26">3. 使用 CSS 动画</h4>
<p>使用 CSS 动画而不是 JavaScript 动画，性能更好：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.danmaku-item</span> {
  <span class="hljs-attribute">animation</span>: danmaku-move linear;
  <span class="hljs-attribute">will-change</span>: transform; <span class="hljs-comment">/* 优化性能 */</span>
}
</code></pre>
<h4 data-id="heading-27">4. 防抖输入框</h4>
<p>对于输入框发送，可以结合防抖：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">danmakuInput</span>.<span class="hljs-property">valueChanges</span>.<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">debounceTime</span>(<span class="hljs-number">300</span>),
  <span class="hljs-title function_">distinctUntilChanged</span>()
).<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
  <span class="hljs-comment">// 输入框变化处理</span>
});
</code></pre>
<h3 data-id="heading-28">注意事项</h3>
<ol>
<li><strong>内存泄漏</strong>：确保弹幕动画结束后及时移除</li>
<li><strong>性能问题</strong>：限制同时显示的弹幕数量</li>
<li><strong>用户体验</strong>：合理设置节流时间，既限制频率又保持响应</li>
<li><strong>动画流畅</strong>：使用 CSS 动画和 <code>will-change</code> 优化性能</li>
</ol>
<h3 data-id="heading-29">总结</h3>
<p>使用 <code>throttleTime</code> 实现弹幕系统是一个优雅的解决方案，它通过限制点击事件的触发频率来确保：</p>
<ul>
<li><strong>性能优化</strong>：避免创建过多弹幕导致性能问题</li>
<li><strong>用户体验</strong>：保持即时反馈，但限制频率</li>
<li><strong>代码简洁</strong>：使用 RxJS 操作符，代码清晰易读</li>
<li><strong>易于扩展</strong>：可以轻松添加更多功能（如弹幕过滤、弹幕样式等）</li>
</ul>
<p>通过合理使用 RxJS 操作符（<code>throttleTime</code>、<code>takeUntil</code> 等），我们可以构建一个流畅、高效的弹幕系统。</p>
<p>记住：<strong>节流适合需要即时反馈但需要限制频率的场景，而防抖适合等待用户完成操作的场景</strong>。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么程序员不自己开发一个小程序赚钱]]></title>    <link>https://juejin.cn/post/7600489282839625738</link>    <guid>https://juejin.cn/post/7600489282839625738</guid>    <pubDate>2026-01-29T09:06:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282839625738" data-draft-id="7600414546189516810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么程序员不自己开发一个小程序赚钱"/> <meta itemprop="keywords" content="前端,后端,GitHub"/> <meta itemprop="datePublished" content="2026-01-29T09:06:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员凌览"/> <meta itemprop="url" content="https://juejin.cn/user/3350967174565198"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么程序员不自己开发一个小程序赚钱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3350967174565198/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员凌览
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:06:48.000Z" title="Thu Jan 29 2026 09:06:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是凌览。</p>
<ul>
<li>个人网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.code24.top%2F" target="_blank" title="https://blog.code24.top/" ref="nofollow noopener noreferrer">blog.code24.top</a></li>
<li>去水印下载鸭：<a href="https://link.juejin.cn?target=http%3A%2F%2Fnologo.code24.top%2F" target="_blank" title="http://nologo.code24.top/" ref="nofollow noopener noreferrer">nologo.code24.top</a></li>
</ul>
<p>如果本文能给你提供启发或帮助，欢迎动动小手指，一键三连（<code>点赞</code>、<code>评论</code>、<code>转发</code>），给我一些支持和鼓励谢谢。</p>
<hr/>
<p>刷到一个挺扎心的话题：程序员为什么不自己做产品赚钱。</p>
<p>身边还真有不少人问过类似的话："你天天写代码这么厉害，怎么不自己搞个App、做个小程序？随便弄弄不就发财了？"</p>
<p>每次听到这种问题，我都不知道该从哪儿开始解释。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7617ab656e6e488da8d4640c21070318~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5YeM6KeI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770282641&amp;x-signature=WiLDjWxOTjGW4i2rdd03B9n6K%2FI%3D" alt="image.png" loading="lazy"/></p>
<p>最近在 X 乎上看到同行的回答，看完只能说：太真实了。</p>
<h2 data-id="heading-0">理想很丰满、现实很<strong>骨感</strong></h2>
<p>首先，假装我们是程序员，某天深夜加班回家，瘫在沙发上刷手机，突然一个念头炸开——"我去，这个功能市面上根本没有！我要是做一个，肯定爆火！”。</p>
<p>脑子里的画面瞬间清晰：产品上线、用户疯涨、投资人排队、财务自由...，满脑子都是"老子不干了，要创业"。</p>
<p>说干就干，流程走起来：</p>
<p>第一步：注册账号结果发现邮箱早就被自己多年前注册过，还冻结了。解冻、换邮箱，折腾一圈。</p>
<p>第二步：想名字绞尽脑汁想了个好名字，一搜，已被占用。再想想想，终于通过。</p>
<p>第三步：开发前端后端一把抓，不会前端？没事，Ai结伴编程一把梭。uniapp启动，一套代码多端运行，微信、QQ、抖音、快手平台全都要上。</p>
<p>第四步：买服务器，阿里云一核两G，一年600块，付款的时候手还没抖。</p>
<p>第五步：搞域名，随便挑一个，一年30块，便宜。</p>
<p>第六步：备案到这里，噩梦开始了。拍照、填表、等审核，来来回回折腾。好不容易过了，提交小程序审核——"该项目类型个人不支持，需要企业认证。"</p>
<p>卒。亏损-630元。</p>
<p>但程序员嘛，头铁。不信邪，继续：</p>
<p>第七步：注册公司个体户要经营场所，干脆直接注册公司。准备材料、开对公账户、刻公章，又是一顿操作。</p>
<p>第八步：重新认证企业认证要的材料堆成山，干脆重新注册个小程序。又是想名字（原来的还要等两天才能释放）、填资料、承诺书、盖章...</p>
<p>终于，小程序上线了。</p>
<p>上线只是开始，赚钱才是难题。</p>
<p>每天努力宣传、引流，结果广告收益长这样：昨日收入0.65元。</p>
<p>对，你没看错，六毛五。折线图上的曲线在0.3元到1.8元之间反复横跳，月收入6.72元。服务器钱还没赚回来，先赔进去几百块。</p>
<h2 data-id="heading-1">什么会这样？</h2>
<ul>
<li>个人开发者不能收费，只能通过挂广告，而广告收入低到离谱。激励广告单价居然只有4.29元/千次展示，Banner广告更惨，几块钱千次展示。算笔账：日访问量要达到2万，才能日入500。2万UV什么概念？很多小公司的官网一天都没这么多人。</li>
<li>推广难，小程序是个封闭生态，你不能诱导分享，否则直接封号。只能从其他平台往微信导流，但用户路径一长，流失率奇高。要开通流量主还得先引流500人，这第一道门槛就卡死不少人。</li>
<li>审核机制让人头大，页面上文字一多，就说你涉及"内容资讯"，不给过。个人开发者经营类目受限，动不动就踩红线。</li>
</ul>
<h2 data-id="heading-2">不是技术问题，是商业问题</h2>
<p>程序员不做小程序赚钱，不是因为不会写代码，而是因为写代码只是万里长征第一步。</p>
<p>做一个能赚钱的小程序，需要：</p>
<ul>
<li>产品能力：做什么？解决谁的什么问题？凭什么用你的？</li>
<li>运营能力：流量从哪来？怎么留存？怎么变现？</li>
<li>商业资质：公司、对公账户、各种许可证，合规成本不低；</li>
<li>时间和精力：白天上班，晚上搞副业，服务器半夜挂了还得爬起来修。</li>
</ul>
<p>而大多数程序员，只是喜欢写代码而已。让他们去搞流量、谈商务、处理工商税务，比写一万行代码还痛苦。</p>
<p>更扎心的是，就算你愿意干这些，小程序的红利期也早过了。2017年刚出来那会儿，确实有人靠简单工具类小程序赚到第一桶金。现在？各大平台库存量几百万个，用户注意力被某音、被红书切得稀碎，新入局者基本就是炮灰。</p>
<h2 data-id="heading-3">成功案例</h2>
<p>网上经常能看到"做小程序月入过万"的帖子，但仔细看会发现，要么是卖课的，要么是有特殊资源的（比如手里有公众号矩阵导流），要么是早期入局者吃到了红利。
对于普通程序员来说，接个外包项目，按时薪算可能比折腾三个月小程序赚得还多，还省心。</p>
<p>技术只是工具，商业才是战场。会拿锤子的不一定会盖房子，会写代码的不一定能做出赚钱的产品。这不是技术问题，这是两个完全不同的赛道。</p>
<h2 data-id="heading-4">最后</h2>
<p>所以，开发一个小程序到底能不能赚钱？</p>
<p>能，但跟你关系不大。</p>
<p>要么你有现成的流量池，比如几十万粉丝的公众号、抖音号，小程序只是变现工具；要么你有特殊资源，比如独家数据、行业资质；再要么你踩中了某个极小概率的风口，比如当年疫情期间的健康码周边工具。否则，个人开发者大概率是炮灰。</p>
<p><strong>写代码是确定性的事，输入逻辑输出结果；做生意是概率性的事，投入不一定有回报。</strong> 大多数人适合前者，却误以为自己能驾驭后者。</p>
<p>你呢？有没有过"做个产品改变世界"的冲动？最后成了吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20个例子掌握RxJS——第十三章使用 interval 和 scan 实现定时器]]></title>    <link>https://juejin.cn/post/7600560664407638079</link>    <guid>https://juejin.cn/post/7600560664407638079</guid>    <pubDate>2026-01-29T09:08:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600560664407638079" data-draft-id="7600587732991328298" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20个例子掌握RxJS——第十三章使用 interval 和 scan 实现定时器"/> <meta itemprop="keywords" content="Angular.js,RxJS"/> <meta itemprop="datePublished" content="2026-01-29T09:08:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeeYaMaster"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565583085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20个例子掌握RxJS——第十三章使用 interval 和 scan 实现定时器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565583085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeeYaMaster
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:08:22.000Z" title="Thu Jan 29 2026 09:08:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RxJS 实战：使用 interval 和 scan 实现定时器</h2>
<h3 data-id="heading-1">概述</h3>
<p>定时器是一个常见的功能，用于测量经过的时间。在 Web 开发中，我们经常需要实现秒表、倒计时等功能。本章将介绍如何使用 RxJS 的 <code>interval</code>、<code>scan</code> 和 <code>takeUntil</code> 操作符实现一个功能完整的定时器。</p>
<h3 data-id="heading-2">定时器的基本概念</h3>
<p>定时器用于测量从某个时间点开始经过的时间。常见的定时器场景包括：</p>
<ul>
<li><strong>秒表功能</strong>：测量经过的时间</li>
<li><strong>倒计时器</strong>：从指定时间倒计时到 0</li>
<li><strong>任务计时</strong>：记录任务执行时间</li>
<li><strong>游戏计时</strong>：游戏中的计时功能</li>
</ul>
<h3 data-id="heading-3">为什么使用 RxJS？</h3>
<p>使用 RxJS 实现定时器有以下优势：</p>
<ol>
<li><strong>响应式编程</strong>：使用 Observable 流处理时间，代码更清晰</li>
<li><strong>易于控制</strong>：可以轻松实现开始、暂停、重置等功能</li>
<li><strong>自动清理</strong>：使用 <code>takeUntil</code> 可以优雅地取消订阅</li>
<li><strong>组合性强</strong>：可以轻松与其他 RxJS 操作符组合</li>
</ol>
<h3 data-id="heading-4">核心操作符</h3>
<h4 data-id="heading-5">1. interval</h4>
<p><code>interval</code> 创建一个按固定时间间隔发出递增数字的 Observable。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 每秒发出一个值：0, 1, 2, 3...</span>
</code></pre>
<h4 data-id="heading-6">2. scan</h4>
<p><code>scan</code> 类似数组的 <code>reduce</code>，但会发出每次累加的结果。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc, value</span>) =&gt;</span> acc + value, <span class="hljs-number">0</span>)
<span class="hljs-comment">// 输入：0, 1, 2, 3...</span>
<span class="hljs-comment">// 输出：0, 1, 3, 6, 10...</span>
</code></pre>
<h4 data-id="heading-7">3. startWith</h4>
<p><code>startWith</code> 在 Observable 开始前发出指定的值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>).<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>))
<span class="hljs-comment">// 立即发出 0，然后每秒发出 1, 2, 3...</span>
</code></pre>
<h4 data-id="heading-8">4. takeUntil</h4>
<p><code>takeUntil</code> 当另一个 Observable 发出值时，完成当前 Observable。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>).<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">takeUntil</span>(stop$))
<span class="hljs-comment">// 当 stop$ 发出值时，停止发出值</span>
</code></pre>
<h3 data-id="heading-9">实战场景：实现一个秒表</h3>
<p>假设我们需要实现一个秒表，具有开始、暂停、重置功能。</p>
<h4 data-id="heading-10">实现思路</h4>
<ol>
<li>使用 <code>interval(1000)</code> 每秒发出一个值</li>
<li>使用 <code>startWith(0)</code> 立即开始</li>
<li>使用 <code>scan</code> 累加时间</li>
<li>使用 <code>takeUntil</code> 控制停止、暂停和重置</li>
</ol>
<h4 data-id="heading-11">核心代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定时器状态</span>
isRunning = <span class="hljs-literal">false</span>;
currentTime = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 销毁 Subject</span>
<span class="hljs-keyword">private</span> destroySubject$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();

<span class="hljs-comment">// 暂停/继续控制 Subject</span>
<span class="hljs-keyword">private</span> pauseSubject$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();

<span class="hljs-comment">// 重置控制 Subject</span>
<span class="hljs-keyword">private</span> resetSubject$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();

<span class="hljs-comment">// 开始定时器</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">startTimer</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span>) {
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-comment">// 使用 interval(1000) 每秒发出一个值</span>
  <span class="hljs-comment">// 使用 scan 累加时间</span>
  <span class="hljs-comment">// 使用 startWith 从当前时间开始</span>
  <span class="hljs-comment">// 使用 takeUntil 控制停止</span>
  <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>),
      <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc</span>) =&gt;</span> acc + <span class="hljs-number">1</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span>),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroySubject$</span>),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span>),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">resetSubject$</span>)
    )
    .<span class="hljs-title function_">subscribe</span>({
      <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">time</span>) =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = time;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
      },
      <span class="hljs-attr">complete</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 如果是暂停，保持状态</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span>.<span class="hljs-property">closed</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
        }
      }
    });
}

<span class="hljs-comment">// 暂停定时器</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">pauseTimer</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span>) {
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span>.<span class="hljs-title function_">next</span>();
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
}

<span class="hljs-comment">// 重置定时器</span>
<span class="hljs-title function_">resetTimer</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 如果正在运行，先停止</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span>.<span class="hljs-title function_">next</span>();
  }
  
  <span class="hljs-comment">// 重置时间</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = <span class="hljs-number">0</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
  
  <span class="hljs-comment">// 创建新的 pauseSubject 和 resetSubject</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">resetSubject$</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();
  
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>();
}
</code></pre>
<h3 data-id="heading-12">关键点解析</h3>
<h4 data-id="heading-13">1. interval 的使用</h4>
<p><code>interval(1000)</code> 每秒发出一个值，从 0 开始：</p>
<ul>
<li>0 秒：发出 0</li>
<li>1 秒：发出 1</li>
<li>2 秒：发出 2</li>
<li>...</li>
</ul>
<h4 data-id="heading-14">2. scan 累加时间</h4>
<p><code>scan((acc) =&gt; acc + 1, this.currentTime)</code> 的作用：</p>
<ul>
<li>从 <code>this.currentTime</code> 开始累加</li>
<li>每次收到新值，累加 1</li>
<li>如果从 10 秒开始，会输出：10, 11, 12, 13...</li>
</ul>
<h4 data-id="heading-15">3. startWith 的作用</h4>
<p><code>startWith(0)</code> 确保：</p>
<ul>
<li>立即发出初始值，不等待第一个 interval</li>
<li>定时器可以立即开始计时</li>
</ul>
<h4 data-id="heading-16">4. takeUntil 的多重控制</h4>
<p>使用多个 <code>takeUntil</code> 可以灵活控制定时器的停止：</p>
<ul>
<li><code>takeUntil(this.destroySubject$)</code>：组件销毁时停止</li>
<li><code>takeUntil(this.pauseSubject$)</code>：暂停时停止</li>
<li><code>takeUntil(this.resetSubject$)</code>：重置时停止</li>
</ul>
<h4 data-id="heading-17">5. 暂停和重置的实现</h4>
<p>暂停和重置需要创建新的 Subject，确保可以重新启动：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 暂停后，创建新的 Subject</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();

<span class="hljs-comment">// 重置后，创建新的 Subject</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">resetSubject$</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>&lt;<span class="hljs-built_in">void</span>&gt;();
</code></pre>
<h3 data-id="heading-18">时间格式化</h3>
<p>定时器通常需要将秒数格式化为 <code>HH:MM:SS</code> 格式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">formatTime</span>(<span class="hljs-attr">seconds</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> hours = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(seconds / <span class="hljs-number">3600</span>);
  <span class="hljs-keyword">const</span> minutes = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((seconds % <span class="hljs-number">3600</span>) / <span class="hljs-number">60</span>);
  <span class="hljs-keyword">const</span> secs = seconds % <span class="hljs-number">60</span>;
  
  <span class="hljs-keyword">return</span> [
    hours.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>),
    minutes.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>),
    secs.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)
  ].<span class="hljs-title function_">join</span>(<span class="hljs-string">':'</span>);
}
</code></pre>
<h3 data-id="heading-19">与其他方案的对比</h3>
<h4 data-id="heading-20">方案 1：使用 setInterval（不推荐）</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不推荐：难以控制，容易导致内存泄漏</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">interval</span>: <span class="hljs-built_in">any</span>;
<span class="hljs-keyword">let</span> currentTime = <span class="hljs-number">0</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">startTimer</span>(<span class="hljs-params"/>) {
  interval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    currentTime++;
    <span class="hljs-title function_">updateDisplay</span>();
  }, <span class="hljs-number">1000</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">pauseTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">clearInterval</span>(interval);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">resetTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">clearInterval</span>(interval);
  currentTime = <span class="hljs-number">0</span>;
  <span class="hljs-title function_">updateDisplay</span>();
}
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>需要手动管理 interval ID</li>
<li>容易忘记清理，导致内存泄漏</li>
<li>代码不够优雅</li>
</ul>
<h4 data-id="heading-21">方案 2：使用 RxJS（推荐）✅</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 推荐：响应式编程，易于控制</span>
<span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>),
    <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc</span>) =&gt;</span> acc + <span class="hljs-number">1</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span>),
    <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span>)
  )
  .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = time;
  });
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>响应式编程，代码清晰</li>
<li>自动管理订阅，避免内存泄漏</li>
<li>易于扩展和维护</li>
</ul>
<h3 data-id="heading-22">高级用法</h3>
<h4 data-id="heading-23">1. 倒计时器</h4>
<p>实现从指定时间倒计时到 0：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> initialTime = <span class="hljs-number">60</span>; <span class="hljs-comment">// 60秒倒计时</span>

<span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>),
    <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc</span>) =&gt;</span> acc - <span class="hljs-number">1</span>, initialTime),
    <span class="hljs-title function_">takeWhile</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> time &gt;= <span class="hljs-number">0</span>),
    <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroySubject$</span>)
  )
  .<span class="hljs-title function_">subscribe</span>({
    <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">time</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = time;
      <span class="hljs-keyword">if</span> (time === <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onCountdownComplete</span>();
      }
    }
  });
</code></pre>
<h4 data-id="heading-24">2. 多段计时</h4>
<p>记录多个时间段：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">TimeSegment</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span>;
  endTime?: <span class="hljs-built_in">number</span>;
  duration?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">private</span> <span class="hljs-attr">segments</span>: <span class="hljs-title class_">TimeSegment</span>[] = [];
<span class="hljs-keyword">private</span> currentSegmentId = <span class="hljs-number">0</span>;

<span class="hljs-title function_">startSegment</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">segment</span>: <span class="hljs-title class_">TimeSegment</span> = {
    <span class="hljs-attr">id</span>: ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentSegmentId</span>,
    <span class="hljs-attr">startTime</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span>
  };
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">segments</span>.<span class="hljs-title function_">push</span>(segment);
}

<span class="hljs-title function_">endSegment</span>(<span class="hljs-attr">segmentId</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> segment = <span class="hljs-variable language_">this</span>.<span class="hljs-property">segments</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-property">id</span> === segmentId);
  <span class="hljs-keyword">if</span> (segment) {
    segment.<span class="hljs-property">endTime</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span>;
    segment.<span class="hljs-property">duration</span> = segment.<span class="hljs-property">endTime</span> - segment.<span class="hljs-property">startTime</span>;
  }
}
</code></pre>
<h4 data-id="heading-25">3. 精确计时</h4>
<p>使用更小的间隔实现更精确的计时：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 每 100 毫秒更新一次（精确到 0.1 秒）</span>
<span class="hljs-title function_">interval</span>(<span class="hljs-number">100</span>)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>),
    <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc</span>) =&gt;</span> acc + <span class="hljs-number">0.1</span>, <span class="hljs-number">0</span>),
    <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span>)
  )
  .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(time * <span class="hljs-number">10</span>) / <span class="hljs-number">10</span>; <span class="hljs-comment">// 保留一位小数</span>
  });
</code></pre>
<h4 data-id="heading-26">4. 条件停止</h4>
<p>根据条件自动停止：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>),
    <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc</span>) =&gt;</span> acc + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
    <span class="hljs-title function_">takeWhile</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> time &lt; <span class="hljs-number">60</span>), <span class="hljs-comment">// 60秒后自动停止</span>
    <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">destroySubject$</span>)
  )
  .<span class="hljs-title function_">subscribe</span>({
    <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">time</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = time;
    },
    <span class="hljs-attr">complete</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onTimerComplete</span>();
    }
  });
</code></pre>
<h3 data-id="heading-27">实际应用场景</h3>
<h4 data-id="heading-28">1. 秒表功能</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 测量经过的时间</span>
<span class="hljs-title function_">startStopwatch</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>),
      <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc</span>) =&gt;</span> acc + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pauseSubject$</span>)
    )
    .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">elapsedTime</span> = time;
    });
}
</code></pre>
<h4 data-id="heading-29">2. 任务计时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 记录任务执行时间</span>
<span class="hljs-title function_">startTaskTimer</span>(<span class="hljs-attr">taskId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  
  <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime) / <span class="hljs-number">1000</span>)),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskComplete$</span>)
    )
    .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskTimes</span>[taskId] = time;
    });
}
</code></pre>
<h4 data-id="heading-30">3. 游戏计时</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 游戏中的计时功能</span>
<span class="hljs-title function_">startGameTimer</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-title function_">interval</span>(<span class="hljs-number">1000</span>)
    .<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>),
      <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc</span>) =&gt;</span> acc + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
      <span class="hljs-title function_">takeUntil</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">gameOver$</span>)
    )
    .<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">time</span> =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gameTime</span> = time;
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateGameUI</span>();
    });
}
</code></pre>
<h3 data-id="heading-31">性能优化建议</h3>
<h4 data-id="heading-32">1. 使用 ChangeDetectorRef</h4>
<p>在 Angular 中，使用 <code>ChangeDetectorRef</code> 手动触发变更检测，避免不必要的检查：</p>
<pre><code class="hljs language-typescript" lang="typescript">.<span class="hljs-title function_">subscribe</span>({
  <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">time</span>) =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = time;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cdr</span>.<span class="hljs-title function_">detectChanges</span>(); <span class="hljs-comment">// 手动触发变更检测</span>
  }
});
</code></pre>
<h4 data-id="heading-33">2. 限制更新频率</h4>
<p>如果不需要每秒更新，可以降低更新频率：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 每 5 秒更新一次</span>
<span class="hljs-title function_">interval</span>(<span class="hljs-number">5000</span>)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">startWith</span>(<span class="hljs-number">0</span>),
    <span class="hljs-title function_">scan</span>(<span class="hljs-function">(<span class="hljs-params">acc</span>) =&gt;</span> acc + <span class="hljs-number">5</span>, <span class="hljs-number">0</span>)
  )
</code></pre>
<h4 data-id="heading-34">3. 在页面不可见时暂停</h4>
<p>使用 Page Visibility API 在页面不可见时暂停定时器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">fromEvent</span>(<span class="hljs-variable language_">document</span>, <span class="hljs-string">'visibilitychange'</span>)
  .<span class="hljs-title function_">pipe</span>(
    <span class="hljs-title function_">switchMap</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">hidden</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pauseTimer</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">EMPTY</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 页面可见时可以选择恢复</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">EMPTY</span>;
      }
    })
  )
  .<span class="hljs-title function_">subscribe</span>();
</code></pre>
<h3 data-id="heading-35">注意事项</h3>
<ol>
<li><strong>内存泄漏</strong>：确保在组件销毁时取消订阅</li>
<li><strong>变更检测</strong>：在 Angular 中，可能需要手动触发变更检测</li>
<li><strong>浏览器环境</strong>：使用 <code>isPlatformBrowser</code> 检查，避免 SSR 问题</li>
<li><strong>暂停和重置</strong>：需要创建新的 Subject，确保可以重新启动</li>
<li><strong>精度问题</strong>：<code>interval</code> 不是完全精确的，可能受到浏览器性能影响</li>
</ol>
<h3 data-id="heading-36">总结</h3>
<p>使用 RxJS 实现定时器是一个优雅的解决方案，它通过响应式编程的方式：</p>
<ul>
<li><strong>代码清晰</strong>：使用 Observable 流处理时间，逻辑清晰</li>
<li><strong>易于控制</strong>：可以轻松实现开始、暂停、重置等功能</li>
<li><strong>自动清理</strong>：使用 <code>takeUntil</code> 可以优雅地取消订阅</li>
<li><strong>组合性强</strong>：可以轻松与其他 RxJS 操作符组合</li>
</ul>
<p>记住：<strong>定时器是响应式编程的典型应用场景，使用 RxJS 可以让代码更加优雅和可维护</strong>。</p>
<p>码云地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleeyamaster%2Frxjs-examples" target="_blank" title="https://gitee.com/leeyamaster/rxjs-examples" ref="nofollow noopener noreferrer">gitee.com/leeyamaster…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apifox 1 月更新｜MCP 调试、测试套件、测试报告重构、网络信息查看、Hoppscotch 导入]]></title>    <link>https://juejin.cn/post/7600489282839658506</link>    <guid>https://juejin.cn/post/7600489282839658506</guid>    <pubDate>2026-01-29T09:13:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282839658506" data-draft-id="7600508556124405811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apifox 1 月更新｜MCP 调试、测试套件、测试报告重构、网络信息查看、Hoppscotch 导入"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2026-01-29T09:13:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Apifox"/> <meta itemprop="url" content="https://juejin.cn/user/2766843870448222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apifox 1 月更新｜MCP 调试、测试套件、测试报告重构、网络信息查看、Hoppscotch 导入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2766843870448222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Apifox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:13:40.000Z" title="Thu Jan 29 2026 09:13:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Apifox 新版本上线啦！</p>
<p>看看本次版本更新主要涵盖的重点内容，有没有你所关注的功能特性：</p>
<ul>
<li><strong>支持创建 MCP Client 以调试 MCP Server</strong></li>
<li><strong>支持创建「测试套件」</strong></li>
<li><strong>测试报告全面重构，支持结构化展示</strong></li>
<li><strong>调试能力持续升级</strong>
<ul>
<li>支持查看 HTTP 版本、TLS 协议等网络信息</li>
<li>array 类型参数的子元素支持直接选择枚举值</li>
<li>调试 SSE 接口时，支持 <code>\r\n</code> 换行符</li>
</ul>
</li>
<li><strong>支持导入 Hoppscotch 的 Collection</strong></li>
<li><strong>优化邀请他人加入项目的流程</strong></li>
<li><strong>用户反馈优化</strong>
<ul>
<li>解决 MongoDB 数据库的密码包含特殊字符 <code>%</code> 时无法连接成功的问题</li>
<li>解决绑定了手机号的用户无法通过“忘记密码”功能重置密码的问题</li>
</ul>
</li>
</ul>
<p><strong>将 Apifox 更新至最新版，一起开启全新体验吧！</strong></p>
<h2 data-id="heading-0">支持创建 MCP Client 以调试 MCP Server</h2>
<p>Apifox 升级后，支持创建 MCP Client，开发者可以像调试 API 一样，直接调试 MCP Server 的<strong>Tools</strong>、<strong>Resources</strong>和 <strong>Prompts</strong>。同时支持<strong>STDIO</strong>和 <strong>Streamable HTTP</strong> 协议，并可<strong>自动配置 OAuth 2.0 认证流程</strong>，极大简化连接与认证流程，全面提升 AI Agent 的开发与调试效率。</p>
<p><em>更多关于 MCP 的内容，可以前往</em> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fmcp" target="_blank" title="https://docs.apifox.com/mcp" ref="nofollow noopener noreferrer"><em>帮助文档</em> </a><em>查看。</em></p>
<p><img src="https://cdn.apifox.cn/uploads/help/202601291401195.gif" alt="支持创建 MCP Client 以调试 MCP Server" loading="lazy"/></p>
<h2 data-id="heading-1">支持创建「测试套件」</h2>
<p>Apifox 推出了「测试套件」功能，支持添加单接口用例和场景用例，并可在「静态」与「动态」两种模式间切换：</p>
<ul>
<li>静态模式用于精确指定需要执行的测试项，内容不会变动，且支持灵活调整测试步骤的顺序。</li>
<li>动态模式可<strong>通过规则自动筛选</strong>需执行的测试项。每次运行时，系统会实时扫描项目，将所有符合条件的最新用例纳入执行。此模式下，仅可整体删除或修改过滤条件，无法单独删除组内的某个动态项。</li>
</ul>
<p>场景用例侧重于测试流程的编排，测试套件则聚焦于灵活高效的测试执行，两者并非互相替代，而是分层协作，面向不同的使用场景，结合使用可以满足自动化测试的多样化需求。</p>
<p><em>更多关于测试套件的具体教程，可以查看往期内容《</em> <a href="https://link.juejin.cn?target=https%3A%2F%2Fapifox.com%2Fblog%2Ftest-suites%2F" target="_blank" title="https://apifox.com/blog/test-suites/" ref="nofollow noopener noreferrer"><em>测试用例越堆越多？用 Apifox 测试套件让自动化回归更易维护</em> </a><em>》。</em></p>
<p><img src="https://cdn.apifox.cn/uploads/help/202601291401636.gif" alt="支持创建「测试套件」" loading="lazy"/></p>
<h2 data-id="heading-2">测试报告全面重构，支持结构化展示</h2>
<p>最新版本的 Apifox 对测试报告界面进行了全面重构，新版测试报告支持结构化展示所有测试步骤，让测试结果的层次关系更加清晰明了。用户可以快速定位每个测试步骤的执行情况和结果，从而更高效地分析测试问题，提升测试结果的可读性和分析效率。</p>
<p><img src="https://cdn.apifox.cn/uploads/help/202601291403059.png" alt="测试报告全面重构，支持结构化展示" loading="lazy"/></p>
<h2 data-id="heading-3">调试能力持续升级</h2>
<h3 data-id="heading-4">支持查看 HTTP 版本、TLS 协议等网络信息</h3>
<p>更新 Apifox 后，开发者在调试接口时可直接查看 HTTP 版本、TLS 协议等详细网络信息，从而快速掌握接口请求的通信细节，有助于进行更精确的问题定位和性能分析。</p>
<p>同时，支持查看更详细的响应大小信息，包括 Body 和 Header 的大小，以及压缩前后的 Body 大小，便于判断 gzip 等压缩功能是否正常工作。</p>
<p><img src="https://cdn.apifox.cn/uploads/help/202601291404605.png" alt="支持查看 HTTP 版本、TLS 协议等网络信息" loading="lazy"/></p>
<h3 data-id="heading-5">array 类型参数的子元素支持直接选择枚举值</h3>
<p>调试接口时，如果 array 类型参数的子元素包含枚举值，用户可直接从列表中选择，无需手动输入，简化了配置流程，提升参数配置的便捷性与准确性，使接口调试更加高效流畅。</p>
<p><img src="https://cdn.apifox.cn/uploads/help/202601291405954.png" alt="array 类型参数的子元素支持直接选择枚举值" loading="lazy"/></p>
<h3 data-id="heading-6">调试 SSE 接口时，支持 <code>\r\n</code> 换行符</h3>
<p>Apifox 优化了 SSE 接口的调试体验。SSE 规范采用 <code>\n\n</code> 作为标准换行符，但一些实际业务中常用 <code>\r\n</code> <em>（Windows 换行符）</em> 进行分隔。Apifox 现已兼容并正确解析 <code>\r\n</code> 换行符，确保 SSE 流式数据能够以标准或非标准格式都能正确显示，帮助开发者更高效、准确地调试和验证 SSE 接口响应内容。</p>
<h2 data-id="heading-7">支持导入 Hoppscotch 的 Collection</h2>
<p>Apifox 现已支持导入 Hoppscotch Collection 数据，帮助团队更便捷地将 Hoppscotch 项目迁移到 Apifox，进一步扩展了数据迁移的兼容性，降低迁移成本，提升团队协作的灵活性。</p>
<p><img src="https://cdn.apifox.cn/uploads/help/202601291405365.png" alt="支持导入 Hoppscotch 的 Collection" loading="lazy"/></p>
<h2 data-id="heading-8">优化邀请他人加入项目的流程</h2>
<p>Apifox 对项目成员邀请流程进行了优化，除了链接邀请和邮箱邀请外，还支持直接从团队成员列表中选择成员加入项目，并可在邀请时同步设置项目权限，大幅简化了成员管理流程，让团队协作配置更加便捷高效。</p>
<p><img src="https://cdn.apifox.cn/uploads/help/202601291405341.png" alt="优化邀请他人加入项目的流程" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>用户反馈优化</strong></h2>
<h3 data-id="heading-10">解决 MongoDB 数据库的密码包含特殊字符<code>%</code>时无法连接成功的问题</h3>
<p>根据用户反馈，我们已修复 MongoDB 数据库连接中存在的问题：当数据库密码包含特殊字符 <code>%</code> 时，Apifox 现能正确处理并成功建立连接，进一步提升了数据库连接功能的稳定性和兼容性。</p>
<h3 data-id="heading-11">解决绑定了手机号的用户无法通过“忘记密码”功能重置密码的问题</h3>
<p>现在通过"忘记密码"功能可以正常重置密码，确保用户在需要时能顺利找回账号访问权限，提升账户安全管理功能的完整性与可用性。</p>
<h2 data-id="heading-12"><strong>了解更多</strong></h2>
<p>当然，Apifox 产品团队为大家带来的新功能远不止以上这些：</p>
<ul>
<li>优化了前后置操作的界面</li>
<li>优化了测试报告列表，支持结构化展示、筛选</li>
<li>支持复制测试套件的分享链接</li>
<li>支持调整测试套件静态步骤内资源的顺序</li>
<li>导入 OpenAPI/Swagger 数据时，支持 Query 类型的 HTTP 方法和 additionalOperation</li>
<li>优化了变量预览弹窗的触发时间，让其有一个合理的延迟</li>
<li>在付费页进行续费时，逻辑更合理与友好</li>
<li>解决在接口返回的响应数据上点击右键，没有 Copy JSONPath 等功能的问题</li>
<li>解决当根目录的可见性为内部时，WebSocket 接口仍被发布到公开在线文档的问题</li>
<li>解决未绑定支付方式的团队无法被正确转入组织的问题</li>
</ul>
<p>除了新增功能，我们也对产品细节和使用体验进行了优化，<strong>具体修改内容可点击「阅读原文」前往 Apifox 更新日志查看</strong>，有任何问题欢迎在<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fdoc-5751209%23%25E7%2594%25A8%25E6%2588%25B7%25E7%25BE%25A4%2F" target="_blank" title="https://docs.apifox.com/doc-5751209#%E7%94%A8%E6%88%B7%E7%BE%A4/" ref="nofollow noopener noreferrer"> Apifox 用户群</a>与我们交流沟通。</p>
<p>同时，Apifox 提供<a href="https://link.juejin.cn?target=https%3A%2F%2Fapifox.com%2Fsiyouhua%3Futm_source%3Dself%26utm_medium%3Dwx0129" target="_blank" title="https://apifox.com/siyouhua?utm_source=self&amp;utm_medium=wx0129" ref="nofollow noopener noreferrer">企业私有化部署</a>版本，通过本地化部署、客制化服务，协助企业进一步提升研发团队效能。</p>
<p>欢迎各位用户对 Apifox 继续提出使用反馈和优化意见，我们会持续优化更新，致力于为用户提供更优秀的产品功能和更极致的使用体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git Commit 规范化实践 - 告别手动输入表情符号]]></title>    <link>https://juejin.cn/post/7600597995768021001</link>    <guid>https://juejin.cn/post/7600597995768021001</guid>    <pubDate>2026-01-29T09:32:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600597995768021001" data-draft-id="7600581247020384265" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git Commit 规范化实践 - 告别手动输入表情符号"/> <meta itemprop="keywords" content="Git,GitHub"/> <meta itemprop="datePublished" content="2026-01-29T09:32:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没多少逻辑"/> <meta itemprop="url" content="https://juejin.cn/user/2717648475395325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git Commit 规范化实践 - 告别手动输入表情符号
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648475395325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没多少逻辑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:32:53.000Z" title="Thu Jan 29 2026 09:32:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>之前我一直手动在 commit 信息前加表情符号，比如 <code>✨ feat: xxx</code>、<code>🐛 fix: xxx</code>，每次都要去找对应的 emoji，有时候还会遗漏，挺麻烦的。最近发现了 commitizen + cz-git 这套方案，可以通过交互式界面自动生成规范的提交信息，分享给大家。</p>
<p>顺便推荐一下我在维护的开源项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgocronx-team%2Fgocron" target="_blank" title="https://github.com/gocronx-team/gocron" ref="nofollow noopener noreferrer">gocron</a> - 一个 Go 写的分布式定时任务管理系统，用来替代 Linux crontab 的，支持 Web 界面、秒级精度、任务依赖等功能。欢迎 Star ⭐️</p>
<h2 data-id="heading-1">对比效果</h2>
<p><strong>之前手动输入：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">✨</span> <span class="hljs-attr">feat:</span> <span class="hljs-string">add</span> <span class="hljs-string">task</span> <span class="hljs-string">dependency</span> <span class="hljs-string">feature</span>  <span class="hljs-comment"># 每次都要复制粘贴 emoji</span>
<span class="hljs-string">🐛</span> <span class="hljs-attr">fix:</span> <span class="hljs-string">fix</span> <span class="hljs-string">status</span> <span class="hljs-string">update</span> <span class="hljs-string">issue</span>
</code></pre>
<p><strong>现在交互式选择：</strong></p>
<pre><code class="hljs language-bash" lang="bash">pnpm run commit
<span class="hljs-comment"># 选择类型、范围、填写描述，自动生成带 emoji 的规范提交</span>
</code></pre>
<h2 data-id="heading-2">在gocron项目中使用案例</h2>
<p>gocron 项目已经配置好了，直接使用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> gocron
pnpm install
pnpm run prepare

<span class="hljs-comment"># 提交代码</span>
git add .
pnpm run commit
</code></pre>
<h2 data-id="heading-3">在自己项目中配置</h2>
<h3 data-id="heading-4">1. 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D @commitlint/cli @commitlint/config-conventional commitizen cz-git husky
</code></pre>
<h3 data-id="heading-5">2. 创建配置文件</h3>
<p>创建 <code>commitlint.config.cjs</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">extends</span>: [<span class="hljs-string">'@commitlint/config-conventional'</span>],
  <span class="hljs-attr">prompt</span>: {
    <span class="hljs-attr">types</span>: [
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"✨ feat"</span>,     <span class="hljs-attr">name</span>: <span class="hljs-string">"feat:     ✨ 新增功能"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"🐛 fix"</span>,      <span class="hljs-attr">name</span>: <span class="hljs-string">"fix:      🐛 修复缺陷"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"� docs"</span>,     <span class="hljs-attr">name</span>: <span class="hljs-string">"docs:     📝 文档变更"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"�💄 style"</span>,    <span class="hljs-attr">name</span>: <span class="hljs-string">"style:    💄 代码格式"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"♻️ refactor"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"refactor: ♻️ 代码重构"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"⚡️ perf"</span>,     <span class="hljs-attr">name</span>: <span class="hljs-string">"perf:     ⚡️ 性能优化"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"✅ test"</span>,     <span class="hljs-attr">name</span>: <span class="hljs-string">"test:     ✅ 添加测试"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"📦️ build"</span>,    <span class="hljs-attr">name</span>: <span class="hljs-string">"build:    📦️ 构建变更"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"🎡 ci"</span>,       <span class="hljs-attr">name</span>: <span class="hljs-string">"ci:       🎡 CI 配置"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"⏪️ revert"</span>,   <span class="hljs-attr">name</span>: <span class="hljs-string">"revert:   ⏪️ 回滚"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"🔨 chore"</span>,    <span class="hljs-attr">name</span>: <span class="hljs-string">"chore:    🔨 其他修改"</span> }
    ],
    <span class="hljs-attr">skipQuestions</span>: [<span class="hljs-string">'breaking'</span>, <span class="hljs-string">'footerPrefix'</span>, <span class="hljs-string">'footer'</span>]
  }
}
</code></pre>
<h3 data-id="heading-6">3. 修改 package.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"husky"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"commit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git-cz"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"commitizen"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node_modules/cz-git"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-7">4. 初始化 husky</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm run prepare
<span class="hljs-built_in">echo</span> <span class="hljs-string">"npx --no -- commitlint --edit \$1"</span> &gt; .husky/commit-msg
</code></pre>
<h2 data-id="heading-8">使用</h2>
<pre><code class="hljs language-bash" lang="bash">git add .
pnpm run commit
</code></pre>
<p>按提示操作：</p>
<ol>
<li>选择提交类型（自动带 emoji）</li>
<li>选择影响范围（可选）</li>
<li>填写简短描述</li>
<li>确认提交</li>
</ol>
<h2 data-id="heading-9">提交类型说明</h2>

































































<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>feat</td><td>新功能</td><td><code>✨ feat(task): 添加任务依赖配置</code></td></tr><tr><td>fix</td><td>Bug 修复</td><td><code>🐛 fix(api): 修复状态更新异常</code></td></tr><tr><td>docs</td><td>文档</td><td><code>📝 docs: 更新 API 文档</code></td></tr><tr><td>style</td><td>代码格式</td><td><code>💄 style: 统一代码缩进</code></td></tr><tr><td>refactor</td><td>重构</td><td><code>♻️ refactor: 重构任务调度逻辑</code></td></tr><tr><td>perf</td><td>性能优化</td><td><code>⚡️ perf: 优化查询性能</code></td></tr><tr><td>test</td><td>测试</td><td><code>✅ test: 添加单元测试</code></td></tr><tr><td>build</td><td>构建</td><td><code>📦️ build: 升级依赖</code></td></tr><tr><td>ci</td><td>CI 配置</td><td><code>🎡 ci: 添加 GitHub Actions</code></td></tr><tr><td>revert</td><td>回滚</td><td><code>⏪️ revert: 回滚某功能</code></td></tr><tr><td>chore</td><td>其他</td><td><code>🔨 chore: 更新 .gitignore</code></td></tr></tbody></table>
<h2 data-id="heading-10">相关链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgocronx-team%2Fgocron" target="_blank" title="https://github.com/gocronx-team/gocron" ref="nofollow noopener noreferrer">GoCron 项目</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgocron-docs.pages.dev" target="_blank" title="https://gocron-docs.pages.dev" ref="nofollow noopener noreferrer">GoCron 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcz-git.qbb.sh%2Fzh%2F" target="_blank" title="https://cz-git.qbb.sh/zh/" ref="nofollow noopener noreferrer">cz-git 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcommitlint.js.org%2F" target="_blank" title="https://commitlint.js.org/" ref="nofollow noopener noreferrer">Commitlint 文档</a></li>
</ul>
<hr/>
<p>如果觉得有用，欢迎给 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgocronx-team%2Fgocron" target="_blank" title="https://github.com/gocronx-team/gocron" ref="nofollow noopener noreferrer">gocron</a> 点个 Star ⭐️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vercel 团队 10 年 React 性能优化经验：10 大核心策略让性能提升 300%]]></title>    <link>https://juejin.cn/post/7600587732991492138</link>    <guid>https://juejin.cn/post/7600587732991492138</guid>    <pubDate>2026-01-29T09:33:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600587732991492138" data-draft-id="7600587732991475754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vercel 团队 10 年 React 性能优化经验：10 大核心策略让性能提升 300%"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-29T09:33:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vercel 团队 10 年 React 性能优化经验：10 大核心策略让性能提升 300%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:33:55.000Z" title="Thu Jan 29 2026 09:33:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Vercel 最近发布了 React 最佳实践库，将<strong>十余年来积累的 React 和 Next.js</strong> 优化经验整合到了一个指南中。</p>
<p>其中一共包含<strong>8 个类别、40 多条规则</strong>。</p>
<p>这些原则并不是纸上谈兵，而是 Vercel 团队在 10 余年从无数生产代码库中总结出的经验之谈。它们已经被无数成功案例验证，能切实改善用户体验和业务指标。</p>
<p>以下将是对你的 React 和 Next.js 项目影响最大的 10 大实践。</p>
<h2 data-id="heading-0">1. 将独立的异步操作并行</h2>
<p>请求瀑布流是 React 应用性能的头号杀手。</p>
<p>每次顺序执行 await 都会增加网络延迟，消除它们可以带来最大的性能提升。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
  <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPosts</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Dashboard</span> <span class="hljs-attr">user</span>=<span class="hljs-string">{user}</span> <span class="hljs-attr">posts</span>=<span class="hljs-string">{posts}</span> /&gt;</span></span>;
}
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, posts] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">fetchUser</span>(), <span class="hljs-title function_">fetchPosts</span>()]);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Dashboard</span> <span class="hljs-attr">user</span>=<span class="hljs-string">{user}</span> <span class="hljs-attr">posts</span>=<span class="hljs-string">{posts}</span> /&gt;</span></span>;
}
</code></pre>
<p>当处理多个数据源时，这个简单的改变可以将页面加载时间减少数百毫秒。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fd0761460354780b5a7c2b663153458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284035&amp;x-signature=yjIIcSkHja31%2F3clblBo4IYsSqE%3D" alt="策略1：并行异步操作" loading="lazy"/></p>
<h2 data-id="heading-1">2. 避免桶文件导入</h2>
<p>从桶文件导入会强制打包程序解析整个库，即使你只需要其中一个组件。</p>
<p>这就像把整个衣柜都搬走，只为了穿一件衣服。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Check</span>, X, <span class="hljs-title class_">Menu</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"lucide-react"</span>;
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Check</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"lucide-react/dist/esm/icons/check"</span>;
<span class="hljs-keyword">import</span> X <span class="hljs-keyword">from</span> <span class="hljs-string">"lucide-react/dist/esm/icons/x"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Menu</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"lucide-react/dist/esm/icons/menu"</span>;
</code></pre>
<p><strong>更好的方式（使用 Next.js 配置）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// next.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">experimental</span>: {
    <span class="hljs-attr">optimizePackageImports</span>: [<span class="hljs-string">"lucide-react"</span>, <span class="hljs-string">"@mui/material"</span>],
  },
};

<span class="hljs-comment">// 然后保持简洁的导入方式</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Check</span>, X, <span class="hljs-title class_">Menu</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"lucide-react"</span>;
</code></pre>
<p>直接导入可将启动速度提高 15-70%，构建难度降低 28%，冷启动速度提高 40%，HMR 速度显著提高。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f389ae11eb1345abb64dbe31b9aa8c48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284035&amp;x-signature=Qre2hz1PW564x40agjqlED8%2B6gI%3D" alt="策略2：避免桶文件导入" loading="lazy"/></p>
<h2 data-id="heading-2">3. 使用延迟状态初始化</h2>
<p>当初始化状态需要进行耗时的计算时，将初始化程序包装在一个函数中，确保它只运行一次。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [config, setConfig] = <span class="hljs-title function_">useState</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">"config"</span>)));
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{config.theme}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [config, setConfig] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">"config"</span>)));
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{config.theme}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>组件每次渲染都会从 localStorage 解析 JSON 配置，但其实它只需要在初始化的时候读取一次，将其封装在回调函数中可以消除这种浪费。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd76a17381a3489c9d21f94e55f4cadf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284035&amp;x-signature=OwIuHEVGU9A76kju5d4suY2%2BDVA%3D" alt="策略3：延迟状态初始化" loading="lazy"/></p>
<h2 data-id="heading-3">4. 最小化 RSC 边界的数据传递</h2>
<p>React <strong>服务端/客户端</strong>边界会将所有对象属性序列化为字符串并嵌入到 HTML 响应中，这会直接影响页面大小和加载时间。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(); <span class="hljs-comment">// 50 fields</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> <span class="hljs-attr">user</span>=<span class="hljs-string">{user}</span> /&gt;</span></span>;
}

(<span class="hljs-string">"use client"</span>);
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params">{ user }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>; <span class="hljs-comment">// uses 1 field</span>
}
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{user.name}</span> /&gt;</span></span>;
}

(<span class="hljs-string">"use client"</span>);
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params">{ name }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>只传递客户端组件实际需要的数据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f43e688d0af544d7b0a2a735758ae08f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284035&amp;x-signature=kvqOLctC1Lbx8iomFfizWsYRuKQ%3D" alt="策略4：最小化RSC边界" loading="lazy"/></p>
<h2 data-id="heading-4">5. 动态导入大型组件</h2>
<p>仅在功能激活时加载大型库，减少初始包体积。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AnimationPlayer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./heavy-animation-lib"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [enabled, setEnabled] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">return</span> enabled ? <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AnimationPlayer</span> /&gt;</span></span> : <span class="hljs-literal">null</span>;
}
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AnimationPlayer</span>(<span class="hljs-params">{ enabled, setEnabled }</span>) {
  <span class="hljs-keyword">const</span> [frames, setFrames] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (enabled &amp;&amp; !frames &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span>) {
      <span class="hljs-keyword">import</span>(<span class="hljs-string">"./animation-frames.js"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">mod</span>) =&gt;</span> <span class="hljs-title function_">setFrames</span>(mod.<span class="hljs-property">frames</span>)).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setEnabled</span>(<span class="hljs-literal">false</span>));
    }
  }, [enabled, frames, setEnabled]);

  <span class="hljs-keyword">if</span> (!frames) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Skeleton</span> /&gt;</span></span>;
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Canvas</span> <span class="hljs-attr">frames</span>=<span class="hljs-string">{frames}</span> /&gt;</span></span>;
}
</code></pre>
<p><code>typeof window</code> 可以防止将此模块打包用于 <strong>SSR，优化</strong>服务端包体积和构建速度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cc3b7710569482bab2577744e55da7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284035&amp;x-signature=1sP01Gz6tBP1hITfz4%2BJr6mwOvg%3D" alt="策略5：动态导入组件" loading="lazy"/></p>
<h2 data-id="heading-5">6. 延迟加载第三方脚本</h2>
<p>分析和跟踪脚本不要阻塞用户交互。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">initAnalytics</span>();
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Analytics</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@vercel/analytics/react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        {children}
        <span class="hljs-tag">&lt;<span class="hljs-name">Analytics</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p>在水合后加载分析脚本，优先处理交互内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f39210c94c17483ea6b13db5174b71c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284035&amp;x-signature=%2BFPfJTS3B4iRfUdGwQ5QLHMsqQ0%3D" alt="策略6：延迟加载脚本" loading="lazy"/></p>
<h2 data-id="heading-6">7. 使用 React.cache() 进行请求去重</h2>
<p>防止服务端在同一渲染周期内重复请求。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Sidebar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(); <span class="hljs-comment">// 重复请求</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>;
}
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { cache } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> getUser = <span class="hljs-title function_">cache</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>();
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Sidebar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>(); <span class="hljs-comment">// 已缓存，无重复请求</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99c6bef06a2f462882bfd72a922c1426~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284035&amp;x-signature=jvbjdqYaD%2BHmgiwikZ9u2Xj6g8k%3D" alt="策略7-8：缓存去重" loading="lazy"/></p>
<h2 data-id="heading-7">8. 实现跨请求数据的 LRU 缓存</h2>
<p>React.cache() 仅在单个请求内有效，因此对于跨连续请求共享的数据，使用 LRU 缓存。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LRUCache</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"lru-cache"</span>;

<span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LRUCache</span>({
  <span class="hljs-attr">max</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attr">ttl</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 5 分钟</span>
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">const</span> cached = cache.<span class="hljs-title function_">get</span>(id);
  <span class="hljs-keyword">if</span> (cached) <span class="hljs-keyword">return</span> cached;

  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> db.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({ <span class="hljs-attr">where</span>: { id } });
  cache.<span class="hljs-title function_">set</span>(id, user);
  <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p>这在 Vercel 的 Fluid Compute 中特别有效，多个并发请求共享同一个函数实例。</p>
<h2 data-id="heading-8">9. 通过组件组合实现并行化</h2>
<p>React 服务端组件在树状结构中按顺序执行，因此需要使用组合对组件树进行重构以实现并行化数据获取：</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPageData</span>();
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Sidebar</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Sidebar</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Sidebar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPageData</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{data.content}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>这样一来，页眉和侧边栏就可以并行获取数据了。</p>
<h2 data-id="heading-9">10. 使用 SWR 进行客户端请求去重</h2>
<p>当客户端上的多个组件请求相同的数据时，SWR 会自动对请求进行去重。</p>
<p>❌ 错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/user"</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(setUser);
  }, []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user?.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserAvatar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/user"</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(setUser);
  }, []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{user?.avatar}</span> /&gt;</span></span>;
}
</code></pre>
<p>✅ 正确：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> useSWR <span class="hljs-keyword">from</span> <span class="hljs-string">"swr"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">fetcher</span> = (<span class="hljs-params">url</span>) =&gt; <span class="hljs-title function_">fetch</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-title function_">json</span>());

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = <span class="hljs-title function_">useSWR</span>(<span class="hljs-string">"/api/user"</span>, fetcher);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user?.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserAvatar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: user } = <span class="hljs-title function_">useSWR</span>(<span class="hljs-string">"/api/user"</span>, fetcher);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{user?.avatar}</span> /&gt;</span></span>;
}
</code></pre>
<p>SWR 只发出一个请求，并将结果在两个组件之间共享。</p>
<h2 data-id="heading-10">11. 总结</h2>
<p>这些最佳实践的美妙之处在于：<strong>它们不是复杂的架构变更</strong>。大多数都是简单的代码修改，却能产生显著的性能改进。</p>
<p>一个 600ms 的瀑布等待时间，会影响<strong>每一位用户</strong>，直到被修复。</p>
<p>一个桶文件导入造成的包膨胀，会减慢<strong>每一次构建和每一次页面加载</strong>。</p>
<p><strong>所以越早采用这些实践，就能避免积累越来越多的性能债务。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6edbff7a052f4a3fa9e71edc26c12d43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770284035&amp;x-signature=Ys0c5ZZ6YfMytP3B5%2BnIx%2Bs5yWE%3D" alt="总结：立即行动" loading="lazy"/></p>
<p>现在开始应用这些技巧，让你的 React 应用快如闪电吧！</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Crawbot一夜爆红！是AI新风口还是赛博爬虫？实测揭秘真相]]></title>    <link>https://juejin.cn/post/7600414546189680650</link>    <guid>https://juejin.cn/post/7600414546189680650</guid>    <pubDate>2026-01-29T09:22:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600414546189680650" data-draft-id="7600581247020531721" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Crawbot一夜爆红！是AI新风口还是赛博爬虫？实测揭秘真相"/> <meta itemprop="keywords" content="前端,掘金技术征文"/> <meta itemprop="datePublished" content="2026-01-29T09:22:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GeekSavvy"/> <meta itemprop="url" content="https://juejin.cn/user/629365724166398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Crawbot一夜爆红！是AI新风口还是赛博爬虫？实测揭秘真相
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/629365724166398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GeekSavvy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:22:20.000Z" title="Thu Jan 29 2026 09:22:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一夜爆红的Crawbot，是AI新风口还是“赛博爬虫”？</h2>
<blockquote>
<p>当你的浏览器开始自己思考，事情就变得有趣了。</p>
</blockquote>
<p>最近我的技术圈和自媒体群聊，被一个词刷屏了：<strong>Crawbot</strong>。</p>
<p>不是Chatbot，不是Agent，是<strong>Crawbot</strong>。这玩意儿像一阵风，突然就刮起来了。有人说它是“网页自动化神器”，有人称它为“RPA的终结者”，更有人直接把它捧为“下一代AI交互的雏形”。</p>
<p><img src="https://01editor.oss-cn-hangzhou.aliyuncs.com/aiarticle/images/20260129171948_e59e8c43.jpg" alt="图片来源：6.4万Chat bot 免版税图片、库存照片和图像| Shutterstock" loading="lazy"/></p>
<p>作为一个常年混迹在AI和自动化一线的老司机，我第一反应是：又来一个炒概念的？但架不住好奇心，我决定亲自下场，扒一扒这个<strong>Crawbot</strong>的底裤，看看它到底是真材实料的“当红炸子鸡”，还是又一个包装精美的“技术泡沫”。</p>
<h3 data-id="heading-1">一、开箱实测：当AI学会“看”网页</h3>
<p>拿到一个Crawbot工具（为了避免广告嫌疑，这里就不点名了），我的测试方法很简单粗暴：<strong>给它一个我完全没接触过的、信息结构复杂的官网，让它帮我找出“2025年开发者大会的报名截止日期和票价”。</strong></p>
<p>传统爬虫怎么做？你得写XPath、CSS选择器，研究页面结构，处理JavaScript渲染，一不小心就触发反爬。RPA工具呢？你得录制操作，定位元素，流程僵硬得像在做广播体操。</p>
<p>而Crawbot，我只输入了那句人话指令和网址链接。</p>
<p>接下来的几分钟，有点魔幻。我看到浏览器的光标自己在页面上移动、点击、滚动、悬停。它没有走预设的导航菜单，而是像一个人一样，先快速扫视首页，然后点进了“活动”板块，在几个分页里翻找，最后在一个折叠的“常见问题”区域，精准地揪出了我要的信息。</p>
<p><img src="https://01editor.oss-cn-hangzhou.aliyuncs.com/svgs/0313184663729557.svg" alt="图片来源：01Editor" loading="lazy"/></p>
<p><strong>整个过程，没有一行代码，没有一个元素定位。</strong> 它靠的是对网页视觉元素的“理解”和基于目标的“推理”。</p>
<p><img src="https://01editor.oss-cn-hangzhou.aliyuncs.com/aiarticle/images/20260129171745_63f7d47a.jpeg" alt="图片来源：AI生成" loading="lazy"/></p>
<p>这感觉，就像你雇了一个眼神好、脑子快、还特别听话的实习生，你只需要告诉他“去那个网站，把XX信息找出来”，他就能给你办妥。</p>
<p><strong>金句来了：当工具从“执行固定脚本”进化到“理解并完成任务”，生产力的解放就不再是线性增长，而是指数级爆炸。</strong></p>
<h3 data-id="heading-2">二、技术底牌：CV + LLM，给浏览器装上“眼睛”和“大脑”</h3>
<p>Crawbot为什么能这么“聪明”？拆开来看，它的核心技术栈其实很清晰：</p>
<ul>
<li>
<p><strong>计算机视觉（CV）作为“眼睛”</strong>：它不再依赖脆弱的DOM树或元素ID，而是直接“看”网页的截图或像素流。按钮、输入框、链接、表格，在它眼里都是屏幕上的视觉元素。这招直接绕开了大量前端框架动态渲染带来的传统爬取难题。</p>
</li>
<li>
<p><strong>大语言模型（LLM）作为“大脑”</strong>：这是灵魂。LLM负责理解你的<strong>自然语言指令</strong>，并将其分解成一系列可执行的子任务和操作逻辑（比如：“先找到导航栏，点击‘产品’，在列表页筛选价格低于1000的商品……”）。同时，LLM还能理解它“看到”的网页内容，判断当前状态，决定下一步点击哪里。</p>
</li>
<li>
<p><strong>强化学习（RL）作为“小脑”</strong>：通过大量的人机交互数据训练，Crawbot能学习到在不同网页情境下的最优操作路径，形成一种“手感”或“直觉”，减少无效点击，提高任务成功率。</p>
</li>
</ul>
<p>当然，这也会带来新的问题：信息过载的权限交给了AI，我们如何验证结果的准确性？当数据抓取变得如此简单，网络数据的公平使用和隐私边界又在哪里？</p>
<h3 data-id="heading-3">四、未来展望：Crawbot之后，是什么？</h3>
<p>玩了一周Crawbot，我最大的感触不是技术多牛，而是它揭示了一个明确的趋势：<strong>AI正在从“对话型”向“执行型”深度演进。</strong></p>
<p>ChatGPT让我们习惯了与AI聊天，但聊天终归是聊天。而Crawbot这类智能体，开始<strong>将语言理解转化为实实在在的行动，在数字世界里留下痕迹</strong>。这是从“智库”到“手足”的关键一步。</p>
<p>下一步会是什么？我猜：</p>
<ul>
<li>
<p><strong>多模态能力融合</strong>：未来的Crawbot不仅能“看”网页，还能“听”会议录音自动生成纪要，“理解”PDF图表提取数据，真正打通所有数字信息孤岛。</p>
</li>
<li>
<p><strong>操作系统级入口</strong>：它可能不再是一个浏览器插件或独立应用，而是成为操作系统底层的一部分。你可以像召唤Siri一样，在任何地方用语音或文字吩咐它去完成跨应用、跨平台的复杂工作流。</p>
</li>
<li>
<p><strong>群体智能与协作</strong>：一个Crawbot帮你订机票，另一个同步帮你查目的地天气和攻略，再一个帮你生成行李清单并下单缺少的物品。<strong>多个智能体分工协作，为你打理整个数字生活。</strong></p>
</li>
</ul>
<p><strong>最后，说点实在的。</strong> 作为普通用户或开发者，现在有必要去追这个热点吗？</p>
<p><strong>对于大多数只想提高效率的用户：</strong> 可以保持关注，但不必焦虑。目前成熟的Crawbot产品还不多，使用门槛和成本不低。不妨等生态更成熟、价格更亲民时再入手。</p>
<p><strong>对于开发者和创业者：</strong> 这是一个值得All in观察的赛道。它的技术范式（CV+LLM+RL的智能体架构）具有极强的扩展性，应用场景绝不止于爬虫。想想如何将这种“能看会干”的能力，应用到你的专业领域（比如自动设计审查、智能软件测试、游戏自动化等），可能就能挖到第一桶金。</p>
<p>每一次技术浪潮，最先被改变的不是世界，而是我们看待和解决问题的工具与思维。 Crawbot或许只是这波AI Agent浪潮中的一朵浪花，但它让我们清晰地看到，那个用自然语言指挥数字世界、让机器像人一样思考和操作的时代，已经叩响了门铃。</p>
<p>门后是怎样的新世界？我充满期待，也保持警惕。你呢？</p>
<p>本文部分图片来源于网络，版权归原作者所有，如有疑问请联系删除。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次线上事故引发的思考]]></title>    <link>https://juejin.cn/post/7600628279214407706</link>    <guid>https://juejin.cn/post/7600628279214407706</guid>    <pubDate>2026-01-29T09:24:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600628279214407706" data-draft-id="7600489282839740426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次线上事故引发的思考"/> <meta itemprop="keywords" content="后端,Java,架构"/> <meta itemprop="datePublished" content="2026-01-29T09:24:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="点我设置昵称"/> <meta itemprop="url" content="https://juejin.cn/user/2386363528256733"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次线上事故引发的思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2386363528256733/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    点我设置昵称
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:24:03.000Z" title="Thu Jan 29 2026 09:24:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚨 一次线上事故引发的思考：为什么 GET URL 过长会导致 400？以及正确的接口设计姿势</h2>
<h3 data-id="heading-1">一、事故背景</h3>
<p>在一次微服务调用中，我遇到了一个非常诡异的问题：</p>
<pre><code class="hljs language-xml" lang="xml">远程调用失败：
HTTP 400 Bad Request
<span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>....
</code></pre>
<p>排查日志发现，请求是这样发出的：</p>
<pre><code class="hljs language-ini" lang="ini">GET /dataTagEntityRelation/tagInfoByEntityId
?<span class="hljs-attr">tagType</span>=Table
&amp;<span class="hljs-attr">entityIds</span>=<span class="hljs-number">1</span>
&amp;<span class="hljs-attr">entityIds</span>=<span class="hljs-number">2</span>
&amp;<span class="hljs-attr">entityIds</span>=<span class="hljs-number">3</span>
&amp;<span class="hljs-attr">entityIds</span>=<span class="hljs-number">4</span>
...
&amp;<span class="hljs-attr">entityIds</span>=<span class="hljs-number">1000</span>+
</code></pre>
<p>参数是一个 <code>List&lt;String&gt; entityIds</code>，通过 Feign 的 <code>@SpringQueryMap</code> 自动展开成 URL 参数。</p>
<p>👉 结果：<strong>请求直接 400，Controller 根本没进</strong></p>
<hr/>
<h3 data-id="heading-2">二、问题现象</h3>
<h4 data-id="heading-3">代码结构（问题版本）</h4>
<h4 data-id="heading-4">Feign 接口</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/dataTagEntityRelation/tagInfoByEntityId"</span>)
R&lt;TagInfoByEntityIdVO&gt; <span class="hljs-built_in">tagInfoByEntityId</span>(<span class="hljs-variable">@SpringQueryMap</span> TagInfoByEntityIdDTO dto);
</code></pre>
<h4 data-id="heading-5">DTO</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TagInfoByEntityIdDTO</span> {
    List&lt;<span class="hljs-type">String</span>&gt; entityIds;
    <span class="hljs-type">String</span> tagType;
}
</code></pre>
<h4 data-id="heading-6">实际请求</h4>
<pre><code class="hljs language-ini" lang="ini">GET /tagInfoByEntityId?<span class="hljs-attr">entityIds</span>=<span class="hljs-number">1</span>&amp;entityIds=<span class="hljs-number">2</span>&amp;entityIds=<span class="hljs-number">3</span>&amp;...entityIds=<span class="hljs-number">1000</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">三、为什么会 400？（本质原理）</h3>
<h4 data-id="heading-8">1️⃣ HTTP 协议本身没有规定 URL 最大长度</h4>
<p>👉 但服务器实现有！</p>
<hr/>
<h4 data-id="heading-9">2️⃣ 真正限制 URL 长度的是服务器组件</h4>
<h5 data-id="heading-10">Tomcat（默认）</h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">maxHttpHeaderSize</span> = <span class="hljs-number">8</span>KB
</code></pre>
<h5 data-id="heading-11">Nginx（默认）</h5>
<pre><code class="hljs language-ini" lang="ini">large_client_header_buffers 4 8k<span class="hljs-comment">;</span>
</code></pre>
<h5 data-id="heading-12">API 网关 / 负载均衡</h5>
<ul>
<li>Spring Cloud Gateway</li>
<li>Zuul</li>
<li>Kong</li>
<li>SLB / ELB<br/>
👉 通常限制 8KB ~ 16KB</li>
</ul>
<hr/>
<h4 data-id="heading-13">3️⃣ HTTP 报文结构决定了问题</h4>
<h5 data-id="heading-14">GET 请求结构：</h5>
<pre><code class="hljs language-ini" lang="ini">GET /xxx?<span class="hljs-attr">entityIds</span>=<span class="hljs-number">1</span>&amp;entityIds=<span class="hljs-number">2</span>&amp;... HTTP/<span class="hljs-number">1.1</span>
Host: xxx
User-Agent: xxx
</code></pre>
<p>👉 URL 属于 <strong>请求行（request line）</strong><br/>
👉 请求行属于 <strong>HTTP Header</strong><br/>
👉 Header 有大小限制<br/>
👉 超限直接拒绝请求<br/>
👉 返回 <code>400 Bad Request</code></p>
<hr/>
<h4 data-id="heading-15">4️⃣ 请求甚至没进入 Spring</h4>
<p>流程是这样的：</p>
<pre><code class="hljs language-markdown" lang="markdown">网关 / Tomcat Connector 层
<span class="hljs-code">    ↓
URL 长度检测
    ↓
超限
    ↓
直接返回 400
    ↓
SpringMVC / Controller 完全没机会执行
</span></code></pre>
<p>所以你看到的是 HTML 400 页面，而不是业务异常 JSON。</p>
<hr/>
<h3 data-id="heading-16">四、为什么不是 414 URI Too Long？</h3>
<p>理论上语义正确的是：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-number">414</span> URI Too <span class="hljs-built_in">Long</span>
</code></pre>
<p>但现实是：</p>





















<table><thead><tr><th>组件</th><th>返回</th></tr></thead><tbody><tr><td>Tomcat</td><td>400</td></tr><tr><td>Nginx</td><td>400</td></tr><tr><td>网关</td><td>400</td></tr></tbody></table>
<p>👉 实现层通常统一返回 400（Bad Request）</p>
<hr/>
<h3 data-id="heading-17">五、根本原因总结一句话</h3>
<blockquote>
<p>GET 的参数在 URL 里<br/>
URL 属于 HTTP Header<br/>
Header 有长度限制<br/>
超限 = 协议层拒绝请求 = 400</p>
</blockquote>
<hr/>
<h3 data-id="heading-18">六、正确设计方式（架构级修复方案）</h3>
<h4 data-id="heading-19">❌ 错误设计</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">GET</span> <span class="hljs-operator">+</span> List 参数
<span class="hljs-keyword">GET</span> <span class="hljs-operator">+</span> DTO
<span class="hljs-keyword">GET</span> <span class="hljs-operator">+</span> 批量 ID
<span class="hljs-keyword">GET</span> <span class="hljs-operator">+</span> SpringQueryMap
</code></pre>
<h4 data-id="heading-20">✅ 正确设计</h4>
<pre><code class="hljs language-css" lang="css">POST + JSON <span class="hljs-selector-tag">Body</span>
DTO 承载 List
批量查询统一 POST
</code></pre>
<hr/>
<h3 data-id="heading-21">七、正确实现方式</h3>
<h4 data-id="heading-22">DTO</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TagInfoByEntityIdDTO</span> {
    <span class="hljs-keyword">private</span> String tagType;
    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">Long</span>&gt; entityIds;
}
</code></pre>
<hr/>
<h4 data-id="heading-23">Feign 接口</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/dataTagEntityRelation/tagInfoByEntityId"</span>)
R&lt;TagInfoByEntityIdVO&gt; <span class="hljs-built_in">tagInfoByEntityId</span>(<span class="hljs-variable">@RequestBody</span> TagInfoByEntityIdDTO dto);
</code></pre>
<hr/>
<h4 data-id="heading-24">Controller</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/tagInfoByEntityId"</span>)
public R&lt;TagInfoByEntityIdVO&gt; <span class="hljs-built_in">tagInfoByEntityId</span>(<span class="hljs-variable">@RequestBody</span> TagInfoByEntityIdDTO dto) {
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">R</span><span class="hljs-selector-class">.ok</span>(service.<span class="hljs-built_in">tagInfoByEntityId</span>(dto));
}
</code></pre>
<hr/>
<h4 data-id="heading-25">请求格式</h4>
<pre><code class="hljs language-bash" lang="bash">POST /tagInfoByEntityId
Content-Type: application/json

{
  <span class="hljs-string">"tagType"</span>: <span class="hljs-string">"Table"</span>,
  <span class="hljs-string">"entityIds"</span>: [1,2,3,4,5,6,7,...]
}
</code></pre>
<hr/>
<h3 data-id="heading-26">八、对比效果</h3>
<h4 data-id="heading-27">❌ GET（必炸）</h4>
<pre><code class="hljs language-ini" lang="ini">GET /tagInfoByEntityId?<span class="hljs-attr">entityIds</span>=<span class="hljs-number">1</span>&amp;entityIds=<span class="hljs-number">2</span>&amp;...entityIds=<span class="hljs-number">1000</span>
</code></pre>
<h4 data-id="heading-28">✅ POST（稳定）</h4>
<pre><code class="hljs language-bash" lang="bash">POST /tagInfoByEntityId
Body: JSON
</code></pre>
<hr/>
<h3 data-id="heading-29">九、接口设计规范总结（工程级经验）</h3>
<h4 data-id="heading-30">🚫 禁止设计</h4>
<ul>
<li>GET + 批量 ID</li>
<li>GET + DTO</li>
<li>GET + List</li>
<li>GET + SpringQueryMap</li>
</ul>
<h4 data-id="heading-31">✅ 推荐规范</h4>
<ul>
<li>查询小参数 → GET</li>
<li>批量查询 → POST</li>
<li>DTO 传输 → POST</li>
<li>List 参数 → POST</li>
<li>复杂对象 → POST</li>
</ul>
<hr/>
<h3 data-id="heading-32">十、核心认知升级</h3>
<blockquote>
<p>GET 是“定位资源”的协议<br/>
POST 是“运输数据”的协议</p>
</blockquote>
<p><strong>不要用 GET 运大数据</strong></p>
<hr/>
<h3 data-id="heading-33">十一、一句话总结（掘金金句版）</h3>
<blockquote>
<p>❗ GET URL 超长导致 400，不是 Spring 的锅<br/>
❗ 不是 Feign 的锅<br/>
❗ 不是业务逻辑的锅</p>
<p>👉 是 HTTP 报文结构 + 服务器实现限制</p>
<p>✅ 批量数据 = POST<br/>
✅ DTO = POST<br/>
✅ List = POST</p>
<p><strong>接口设计错了，后面全是灾难</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-34">十二、工程实践建议</h3>
<h4 data-id="heading-35">接口设计红线：</h4>
<pre><code class="hljs language-ini" lang="ini">看到 GET + List 参数 = 架构风险
看到 GET + <span class="hljs-attr">DTO</span> = 架构风险
看到 GET + 批量 <span class="hljs-attr">ID</span> = 架构风险
</code></pre>
<hr/>
<h3 data-id="heading-36">十三、结语</h3>
<p>这类问题<strong>不是代码 bug</strong>，是<strong>协议认知问题</strong>。<br/>
一旦理解 HTTP 报文结构和服务器实现机制，这类坑以后基本不会再踩。</p>
<p><strong>系统越大，越要遵守协议设计规范，而不是“能跑就行”。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI全栈筑基：React Router DOM 路由配置]]></title>    <link>https://juejin.cn/post/7600600904094515234</link>    <guid>https://juejin.cn/post/7600600904094515234</guid>    <pubDate>2026-01-29T09:37:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600600904094515234" data-draft-id="7600341731048161315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI全栈筑基：React Router DOM 路由配置"/> <meta itemprop="keywords" content="前端框架,React.js,前端"/> <meta itemprop="datePublished" content="2026-01-29T09:37:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秃头敲码小姐姐"/> <meta itemprop="url" content="https://juejin.cn/user/24668014656249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI全栈筑基：React Router DOM 路由配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/24668014656249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秃头敲码小姐姐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:37:10.000Z" title="Thu Jan 29 2026 09:37:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在AI全栈项目的开发征途中，路由配置往往是前端“骨架”搭建完成的标志性节点。当我们敲下最后一行路由代码，看着项目目录从混沌走向清晰，这不仅仅是功能的实现，更是架构思维的落地。</p>
<p>最近在搭建一个基于 <code>React + NestJS + AI</code> 的全栈项目时，我对前端路由有了更深层次的思考。路由不仅仅是URL的映射，它是连接用户与功能的桥梁，更是决定应用性能与可维护性的核心。</p>
<p>本文将结合我在项目中的实际配置，深入探讨 React Router DOM 在企业级应用中的核心应用、易错点以及与全栈架构的协同。</p>
<h3 data-id="heading-0">🚦 1. 路由模式的选择：History 与 Hash 的博弈</h3>
<p>在项目初始化阶段，选择合适的路由模式是至关重要的决策。</p>
<p>现代 React 应用普遍倾向于使用 <code>BrowserRouter</code>（History 模式）。它利用 HTML5 History API 提供了干净、美观的 URL 结构（如 <code>/home</code>），符合 RESTful 规范，对 SEO 友好。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/App.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span>
      {/* 路由内容 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>💡 架构思考：</strong><br/>
虽然 <code>BrowserRouter</code> 看起来很“温柔”，但它背后隐藏着锋利的一面：<strong>它要求服务器端必须配置“兜底”策略</strong>。<br/>
如果你的应用部署在 Nginx 或 Node 服务上，必须确保所有非 API 请求都重定向到 <code>index.html</code>。否则，当用户直接访问 <code>/user/123</code> 时，后端会因为找不到该路径而返回 404。这标志着在前后端分离架构中，前端不再是孤立的，而是需要与后端部署策略紧密配合。</p>
<h3 data-id="heading-1">🏗️ 2. 路由形态的深度解析：从嵌套到鉴权</h3>
<p>在构建复杂应用时，单一的路由模式显然不够用。我们需要构建一套层次分明的路由体系。</p>
<h4 data-id="heading-2">2.1 嵌套路由：保持布局一致性</h4>
<p>在项目中，我为产品模块配置了嵌套路由。父组件 <code>Product</code> 负责承载公共的导航栏或侧边栏，而子组件（详情页、新增页）通过 <code>&lt;Outlet&gt;</code> 渲染在指定位置。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/router/index.jsx</span>
{
  <span class="hljs-attr">path</span>: <span class="hljs-string">"/product"</span>,
  <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Product</span> /&gt;</span></span>, <span class="hljs-comment">// 父级布局</span>
  <span class="hljs-attr">children</span>: [
    { <span class="hljs-attr">path</span>: <span class="hljs-string">":productId"</span>, <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductDetail</span> /&gt;</span></span> }, <span class="hljs-comment">// 子路由</span>
    { <span class="hljs-attr">path</span>: <span class="hljs-string">"new"</span>, <span class="hljs-attr">element</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">NewProduct</span> /&gt;</span></span> },           <span class="hljs-comment">// 子路由</span>
  ],
}
</code></pre>
<p>这种模式避免了在每个子页面中重复编写相同的布局代码，极大地提升了用户体验的连贯性。</p>
<h4 data-id="heading-3">2.2 鉴权路由：路由守卫的实现</h4>
<p>对于支付等敏感页面，直接暴露是危险的。我在路由配置中引入了 <code>ProtectRoute</code> 组件。</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">path</span>: <span class="hljs-string">"/pay"</span>,
  <span class="hljs-attr">element</span>: (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProtectRoute</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Pay</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ProtectRoute</span>&gt;</span></span>
  ),
}
</code></pre>
<p><strong>💡 核心逻辑：</strong><br/>
<code>ProtectRoute</code> 本质上是一个高阶组件（HOC）。它在渲染 <code>props.children</code>（即 Pay 组件）之前，会先检查用户的登录状态（如检查 Token）。如果未通过校验，直接重定向到登录页；如果通过，则放行。这种将横切关注点（Cross-Cutting Concerns）剥离的方式，是企业级应用的必备手段。</p>
<h3 data-id="heading-4">⚡ 3. 性能优化：懒加载与用户体验</h3>
<p>单页应用（SPA）的一大痛点是首屏体积过大。为了解决这个问题，我采用了<strong>路由级代码分割（Code Splitting）</strong> 。</p>
<h4 data-id="heading-5">3.1 React.lazy 与 Suspense</h4>
<p>利用 Webpack 的动态导入功能，我将不同页面的代码拆分成独立的 Chunk。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Home</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../pages/Home'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">About</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../pages/About'</span>));

<span class="hljs-comment">// 在渲染层</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LoadingFallback</span> /&gt;</span>}&gt;
  <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>{/* 路由配置 */}<span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
</code></pre>
<p>只有当用户访问 <code>/about</code> 路径时，<code>About</code> 组件的代码才会被动态加载。这显著减小了首包体积，提升了首屏渲染速度。</p>
<h4 data-id="heading-6">3.2 加载状态的优雅处理</h4>
<p><code>React.lazy</code> 的动态导入是异步的，网络延迟不可避免。如果直接展示白屏，用户体验极差。</p>
<p>因此，<code>&lt;Suspense fallback={&lt;LoadingFallback /&gt;}&gt;</code> 的作用至关重要。<code>LoadingFallback</code> 组件（如骨架屏或加载动画）作为“占位符”，在组件加载完成前提供视觉反馈。这是提升用户体验的微小但关键的细节。</p>
<h3 data-id="heading-7">🚨 4. 容错与边界处理：NotFound 的自动化</h3>
<p>对于无效的 URL，我们需要一个“守门员”。我配置了通配符路由 <code>*</code> 来捕获所有未匹配的请求。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// NotFound.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">NotFound</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">let</span> navigate = <span class="hljs-title function_">useNavigate</span>();
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 6秒后自动跳回首页，防止用户迷失</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-title function_">navigate</span>(<span class="hljs-string">'/'</span>) }, <span class="hljs-number">6000</span>)
  }, []);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span> 404 Not Found <span class="hljs-tag">&lt;/&gt;</span></span>
}
</code></pre>
<p>这种自动化的跳转策略，比单纯展示一个死板的 404 页面更加人性化，能有效挽留因误操作而流失的用户。</p>
<h3 data-id="heading-8">🔮 5. 结语：全栈视角下的路由未来</h3>
<p>路由配置的完成，标志着前端骨架的搭建完毕。从 <code>BrowserRouter</code> 的部署考量，到 <code>ProtectRoute</code> 的逻辑复用，再到 <code>React.lazy</code> 的性能优化，每一个细节都体现了工程化的思维。</p>
<p>站在这个基石上，我们已经可以看到后端 NestJS 框架的轮廓，以及 AI 模型接入的无限可能。未来的路由或许不仅仅是页面的跳转，它可能结合 AI 能力，根据用户的意图动态生成内容或调整导航路径。</p>
<p>全栈之路，始于足下，路由为引，未来可期。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter学习笔记——第二章：Flutter 状态管理入门]]></title>    <link>https://juejin.cn/post/7600491179499257910</link>    <guid>https://juejin.cn/post/7600491179499257910</guid>    <pubDate>2026-01-29T05:58:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600491179499257910" data-draft-id="7599511763987103798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter学习笔记——第二章：Flutter 状态管理入门"/> <meta itemprop="keywords" content="Android,Flutter"/> <meta itemprop="datePublished" content="2026-01-29T05:58:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="参宿四南河三"/> <meta itemprop="url" content="https://juejin.cn/user/3479267728427543"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter学习笔记——第二章：Flutter 状态管理入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3479267728427543/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    参宿四南河三
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:58:35.000Z" title="Thu Jan 29 2026 05:58:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>已经学习Flutter一段时间内，可能大家都已经遇到过这些困惑：</p>
<ul>
<li>这个变量该写在哪个 Widget 里？</li>
<li>为什么改了数据，UI 没刷新？</li>
<li>setState 越写越乱，页面越来越大</li>
<li>别人说要用 Provider / Riverpod，但我根本不知道为啥</li>
</ul>
<p><strong>这篇文章只干一件事：</strong> 把「状态管理」这件事，用尽可能通俗的语言讲清楚</p>
<h2 data-id="heading-0">一、什么是状态（State）？</h2>
<h3 data-id="heading-1">一句话定义</h3>
<blockquote>
<p><strong>状态 = 会影响 UI 显示、并且可能发生变化的数据</strong></p>
</blockquote>
<h3 data-id="heading-2">常见状态举例</h3>
<ul>
<li>计数器里的 <code>count</code></li>
<li>是否 loading</li>
<li>列表数据</li>
<li>是否登录</li>
<li>Tab 当前选中项</li>
<li>表单输入内容</li>
</ul>
<p><strong>一句话判断：</strong></p>
<blockquote>
<p>👉 改了这个变量，UI 要不要跟着变？<br/>
👉 要 → 它就是状态</p>
</blockquote>
<p><strong>补充两点说明：</strong></p>
<ul>
<li>有些“不会变”的数据也会影响 UI（比如静态配置），但通常我们不把它们叫“状态”，而是把“会变化”的那部分抽出来作为状态。</li>
<li>状态不仅可以是简单变量，也可以是一整个对象（比如 <code>User</code>、<code>Cart</code>）甚至一个列表、Map。</li>
</ul>
<h2 data-id="heading-3">二、为什么 Flutter 一定要“管理状态”？</h2>
<p>Flutter 是<strong>声明式 UI</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">UI</span> = f(state)
</code></pre>
<p>意思是：</p>
<ul>
<li>UI <strong>完全由状态决定（这里排除系统主题、语言切换、屏幕尺寸变化）</strong></li>
<li>状态一变 → UI 重新描述（build）</li>
</ul>
<p>👉 <strong>Flutter 不关心你怎么改状态，只关心你有没有告诉它：我变了</strong></p>
<hr/>
<h2 data-id="heading-4">三、最基础的状态管理：setState</h2>
<h3 data-id="heading-5">1️⃣ 最简单的计数器</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  const <span class="hljs-type">Counter</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">Counter</span>&gt; createState() =&gt; _CounterState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CounterState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;Counter&gt;</span> </span>{
  int count = <span class="hljs-number">0</span>;

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        <span class="hljs-type">Text</span>('当前值：$count'),
        <span class="hljs-type">ElevatedButton</span>(
          onPressed: () {
            setState(() {
              count++;
            });
          },
          child: const <span class="hljs-type">Text</span>('加 <span class="hljs-number">1</span>'),
        ),
      ],
    );
  }
}
</code></pre>
<p>但真实项目的问题是：</p>
<blockquote>
<p>👉 这个 <code>count</code> 应该放在这里吗？</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、状态到底该放哪？（核心问题）</h2>
<h3 data-id="heading-7">记住这一条基本原则（非常重要）</h3>
<blockquote>
<p><strong>状态应该放在“最小但足够”的 Widget 里</strong></p>
</blockquote>
<p>我们来看两个例子</p>
<h3 data-id="heading-8">错误示例 1：状态放太高（新手最常犯）</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  const <span class="hljs-type">HomePage</span>({<span class="hljs-keyword">super</span>.key});
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">HomePage</span>&gt; createState() =&gt; _HomePageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_HomePageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;HomePage&gt;</span> </span>{
  int count = <span class="hljs-number">0</span>;

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        <span class="hljs-type">Header</span>(),
        <span class="hljs-type">Text</span>('count: $count'),
        <span class="hljs-type">Footer</span>(
          onAdd: () {
            setState(() {
              count++;
            });
          },
        ),
      ],
    );
  }
}
</code></pre>
<p>❌ 问题：</p>
<ul>
<li>Header、Footer 明明不关心 <code>count</code>，却跟着一起重建（没必要）。</li>
<li>页面逻辑和状态都堆在最顶层，越写越难维护。</li>
<li>在复杂页面里，这种“状态放太高”的写法，可能带来不必要的重建和性能开销（本例比较简单，性能差距极小）。</li>
</ul>
<hr/>
<h3 data-id="heading-9">解决方案：把状态交给真正需要它的组件，状态下沉（局部 Stateful）</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  const <span class="hljs-type">Counter</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">Counter</span>&gt; createState() =&gt; _CounterState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CounterState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;Counter&gt;</span> </span>{
  int count = <span class="hljs-number">0</span>;

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Row</span>(
      children: [
        <span class="hljs-type">Text</span>('$count'),
        <span class="hljs-type">IconButton</span>(
          icon: const <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.add),
          onPressed: () {
            setState(() {
              count++;
            });
          },
        ),
      ],
    );
  }
}
</code></pre>
<p>然后在页面中：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Column</span>(
  children: const [
    Header(),
    <span class="hljs-built_in">Counter</span>(),
    <span class="hljs-selector-tag">Footer</span>(),
  ],
)
</code></pre>
<p>👉 <strong>谁用状态，状态就放谁那</strong></p>
<hr/>
<h3 data-id="heading-10">问题来了：多个 Widget 要用同一个状态怎么办？</h3>
<p>场景：商品数量 + 总价</p>
<pre><code class="hljs language-css" lang="css">商品数量   <span class="hljs-selector-attr">[+  -]</span>
总价：¥ <span class="hljs-number">300</span>
</code></pre>
<p>👉 数量和总价 <strong>都依赖 count</strong></p>
<h3 data-id="heading-11">状态提升（State Lifting）—— 非常重要的思想</h3>
<p>核心思想</p>
<blockquote>
<p><strong>多个子组件共享状态 → 状态提升到它们的最近公共父组件</strong></p>
</blockquote>
<h3 data-id="heading-12">示例</h3>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CartPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">CartPage</span>&gt; createState() =&gt; _CartPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CartPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;CartPage&gt;</span> </span>{
  int count = <span class="hljs-number">1</span>;

  void increment() {
    setState(() {
      count++;
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Column</span>(
      children: [
        <span class="hljs-type">Counter</span>(count: count, onAdd: increment),
        <span class="hljs-type">TotalPrice</span>(count: count),
      ],
    );
  }
}
</code></pre>
<p>子组件变成 <strong>纯展示组件</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> int count;
  <span class="hljs-keyword">final</span> <span class="hljs-type">VoidCallback</span> onAdd;

  const <span class="hljs-type">Counter</span>({
    <span class="hljs-keyword">super</span>.key,
    required <span class="hljs-keyword">this</span>.count,
    required <span class="hljs-keyword">this</span>.onAdd,
  });

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> <span class="hljs-type">Row</span>(
      children: [
        <span class="hljs-type">Text</span>('$count'),
        <span class="hljs-type">IconButton</span>(onPressed: onAdd, icon: <span class="hljs-type">Icon</span>(<span class="hljs-type">Icons</span>.add)),
      ],
    );
  }
}
</code></pre>
<p>👉 <strong>父管状态，子管展示</strong></p>
<hr/>
<h2 data-id="heading-13">五、什么时候 setState 开始不够用了？</h2>
<h3 data-id="heading-14">出现这些信号，就该警惕了：</h3>
<ul>
<li>状态在多个页面用</li>
<li>需要跨路由访问状态</li>
<li>参数一层一层往下传（props drilling）</li>
<li>一个页面几十个 setState</li>
</ul>
<pre><code class="hljs language-css" lang="css">Home
 └─ <span class="hljs-selector-tag">A</span>
    └─ <span class="hljs-selector-tag">B</span>
       └─ C
          └─ D（要用状态）
</code></pre>
<p>👉 你会开始觉得 <strong>“传参数好烦”</strong>，这个问题肯定困扰我等小白，别着急，接着看。</p>
<hr/>
<h2 data-id="heading-15">六、状态的三种常见层级（一定要分清）</h2>
<h3 data-id="heading-16">1️⃣ UI 状态（最简单）</h3>
<ul>
<li>通常指“只跟某个小部件相关的、短生命周期”的状态，</li>
<li>比如：
<ul>
<li>列表展开/收起、</li>
<li>当前选中的 tab index、</li>
<li>一个按钮的 loading 状态。</li>
<li>切换按钮</li>
</ul>
</li>
</ul>
<p>👉 <strong>setState 足够</strong></p>
<hr/>
<h3 data-id="heading-17">2️⃣ 页面状态</h3>
<p>如果只是这个页面自己用，放在这个页面的 <code>State</code> 里就够了。 如果页面比较复杂，可以把状态和逻辑抽到一个 <code>ChangeNotifier</code> 或独立的类里，再通过 Provider 等方式提供给这个页面。</p>
<ul>
<li>列表数据</li>
<li>请求结果</li>
<li>表单内容</li>
</ul>
<p>👉 <strong>setState / FutureBuilder / ValueNotifier</strong></p>
<hr/>
<h3 data-id="heading-18">3️⃣ 全局状态</h3>
<ul>
<li>登录用户信息</li>
<li>主题模式</li>
<li>购物车数量</li>
</ul>
<p>👉 <strong>状态管理库登场</strong></p>
<hr/>

























<table><thead><tr><th><strong>状态类型</strong></th><th><strong>举例</strong></th><th><strong>处理策略</strong></th></tr></thead><tbody><tr><td><strong>UI 状态</strong></td><td>加载中（Loading）、错误提示</td><td>留在当前 Widget 内部处理。</td></tr><tr><td><strong>页面状态</strong></td><td>详情页数据、列表数据、表单内容</td><td>放在 <code>StatefulWidget</code> 或<code>ChangeNotifier</code>中。</td></tr><tr><td><strong>全局状态</strong></td><td>用户登录信息、主题、语言</td><td>放在顶层，通过 <code>InheritedWidget</code> 共享。或各种第三方状态库</td></tr></tbody></table>
<h2 data-id="heading-19">七、一个“中间态”的好工具：ValueNotifier</h2>
<p>在你还没用 Provider 之前，<strong>它非常好用</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">final <span class="hljs-attr">counter</span> = ValueNotifier&lt;int&gt;(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-dart" lang="dart">ValueListenableBuilder&lt;<span class="hljs-built_in">int</span>&gt;(
  valueListenable: counter,
  builder: (context, value, child) {
    <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'<span class="hljs-subst">$value</span>'</span>);
  },
);
</code></pre>
<p>更新：</p>
<pre><code class="hljs language-ini" lang="ini">counter.value++<span class="hljs-comment">;</span>
</code></pre>
<p>👉 特点：</p>
<ul>
<li>不用 setState</li>
<li>自动局部刷新</li>
<li>非常轻量</li>
</ul>
<p>👉 使用场景：</p>
<ul>
<li>简单计数器、开关（switch）、当前 index 等；</li>
<li>在不想引入整个状态管理库时，做<strong>局部响应式更新</strong>；</li>
<li>常见于 <code>TextEditingController</code> 内部就是用 <code>ValueNotifier</code> 实现的。</li>
</ul>
<hr/>
<h2 data-id="heading-20">八、 什么时候你需要 Provider / Riverpod？</h2>
<p>很多人一上手就用 Provider，其实并不一定理解它解决了什么。
它提供了两个核心能力：</p>
<ol>
<li><strong>依赖注入（DI）</strong> ：让任何子节点都能通过 <code>context.read&lt;T&gt;()</code> 拿到数据，不用一层层传参数。</li>
<li><strong>精准通知</strong>：只有监听了特定数据的组件才会刷新，性能更优。</li>
</ol>
<blockquote>
<p><strong>它们解决的是“状态的存放位置”和“访问方式”问题</strong></p>
</blockquote>
<h3 data-id="heading-21">那setState 解决不了什么？</h3>
<ol>
<li><strong>跨页面同步</strong>：你在个人中心Tab页改了头像，返回首页Tab页发现头像没变。</li>
<li><strong>深层嵌套（Prop Drilling）</strong> ：如果你想把一个数据传给第 10 层子组件，你不得不像接力棒一样穿透中间 9 层组件。</li>
<li><strong>逻辑与 UI 耦合</strong>：业务逻辑全堆在 <code>State</code> 类里，难以写单元测试。</li>
<li><strong>内存管理</strong>：<code>setState</code> 的数据随 Widget 销毁而消失，有时我们需要状态在页面关闭后依然存活（单例思维）。</li>
</ol>
<h3 data-id="heading-22">简单理解</h3>
<ul>
<li><code>setState</code>：适合<strong>局部、短生命周期</strong>的 UI 状态管理；</li>
<li><code>Provider / Riverpod</code>：适合<strong>跨页面、复杂业务、解耦和测试</strong>场景。</li>
</ul>
<h3 data-id="heading-23">当你遇到以下问题时，就应该考虑状态管理库了：</h3>
<ul>
<li><strong>多页面共享数据</strong>（如购物车、登录页共享一份数据，需要同步刷新UI）。</li>
<li><strong>传递层级太深（需要解耦）</strong>：当你的 <code>StatefulWidget</code> 超过 500 行，且逻辑复杂时。</li>
<li><strong>性能优化（StatefulWidget 臃肿）</strong>：通过 <code>Consumer</code> 实现真正的局部刷新，避免父组件重建带动子组件。</li>
</ul>
<p>不管用不用状态库，底层都是在「某个状态变化时，触发特定 Widget 重建」。<br/>
<code>setState</code> 是手动标记自己变脏；<br/>
Provider / Riverpod 则是更智能地帮你做“谁需要被通知、如何找到那棵子树”的事情。</p>
<p>后面的文章，我将学习“Provider/Riverpod”状态库，更加添加中大型项目的实战。</p>
<h2 data-id="heading-24">九、你现在应该怎么选？（实用建议）</h2>

























<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>单个 Widget</td><td>setState</td></tr><tr><td>父子通信</td><td>状态提升</td></tr><tr><td>局部响应</td><td>ValueNotifier</td></tr><tr><td>跨页面 / 全局</td><td>Provider / Riverpod</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-25">十、记忆点总结（重点）</h2>
<ul>
<li>状态 = 会影响 UI 的数据</li>
<li>谁用状态，状态放谁</li>
<li>多个 Widget 用 → 状态提升</li>
<li>setState 不可怕，乱用才可怕</li>
<li>先搞清“放哪”，再选“用啥库”</li>
</ul>
<h2 data-id="heading-26">十一、写在最后</h2>
<p>“状态管理”是 Flutter 中最容易让人一开始焦虑的部分，但绝大多数 App 的发展过程都是：<br/>
<code>setState → 状态提升 → 抽逻辑类 → 简单状态库 → 复杂状态库</code><br/>
你不需要一上来就完全搞懂所有库，只要先写清楚“状态放哪”，再慢慢学会“怎么让它更好维护”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[BSBacktraceLogger源码解析]]></title>    <link>https://juejin.cn/post/7600342201794297871</link>    <guid>https://juejin.cn/post/7600342201794297871</guid>    <pubDate>2026-01-29T06:55:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600342201794297871" data-draft-id="7600345782173532194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="BSBacktraceLogger源码解析"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2026-01-29T06:55:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS在入门"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426627758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            BSBacktraceLogger源码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426627758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS在入门
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:55:13.000Z" title="Thu Jan 29 2026 06:55:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>借助AI辅助。</p>
</blockquote>
<h2 data-id="heading-0">源码地址</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbestswifter%2FBSBacktraceLogger" target="_blank" title="https://github.com/bestswifter/BSBacktraceLogger" ref="nofollow noopener noreferrer">github.com/bestswifter…</a></p>
<h2 data-id="heading-1">逐行注释</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">//</span>
<span class="hljs-comment">//  BSBacktraceLogger.m</span>
<span class="hljs-comment">//  BSBacktraceLogger</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//  Created by 张星宇 on 16/8/27.</span>
<span class="hljs-comment">//  Copyright © 2016年 bestswifter. All rights reserved.</span>
<span class="hljs-comment">//</span>

<span class="hljs-comment">// 导入自定义头文件</span>
<span class="hljs-meta">#import <span class="hljs-string">"BSBacktraceLogger.h"</span></span>
<span class="hljs-comment">// 导入Mach内核相关头文件，用于线程操作</span>
<span class="hljs-meta">#import <span class="hljs-string">&lt;mach/mach.h&gt;</span></span>
<span class="hljs-comment">// 动态链接库相关函数，用于符号解析</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span></span>
<span class="hljs-comment">// POSIX线程库</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>
<span class="hljs-comment">// 系统类型定义</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-comment">// 限制值定义（如ULONG_MAX等）</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits.h&gt;</span></span>
<span class="hljs-comment">// 字符串操作函数</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-comment">// 动态链接器相关，用于获取镜像信息</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mach-o/dyld.h&gt;</span></span>
<span class="hljs-comment">// Mach-O符号表结构定义</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mach-o/nlist.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark DEFINE MACRO FOR DIFFERENT CPU ARCHITECTURE</span>
<span class="hljs-comment">// 针对不同CPU架构定义相应的宏，以适配不同硬件平台</span>

<span class="hljs-comment">// ARM64架构（64位ARM，如iPhone 5s及以后的设备）</span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__arm64__)</span>
<span class="hljs-comment">// 去除指令地址的标签位（ARM64中低2位可能被用作标签）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DETAG_INSTRUCTION_ADDRESS(A) ((A) &amp; ~(3UL))</span>
<span class="hljs-comment">// 线程状态结构体的大小</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_THREAD_STATE_COUNT ARM_THREAD_STATE64_COUNT</span>
<span class="hljs-comment">// 线程状态类型</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_THREAD_STATE ARM_THREAD_STATE64</span>
<span class="hljs-comment">// 帧指针寄存器（Frame Pointer）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_FRAME_POINTER __fp</span>
<span class="hljs-comment">// 栈指针寄存器（Stack Pointer）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_STACK_POINTER __sp</span>
<span class="hljs-comment">// 程序计数器/指令指针寄存器（Program Counter）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_INSTRUCTION_ADDRESS __pc</span>

<span class="hljs-comment">// ARM32架构（32位ARM，旧设备）</span>
<span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(__arm__)</span>
<span class="hljs-comment">// 去除指令地址的标签位（ARM32中低1位可能表示Thumb模式）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DETAG_INSTRUCTION_ADDRESS(A) ((A) &amp; ~(1UL))</span>
<span class="hljs-comment">// 线程状态结构体的大小</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_THREAD_STATE_COUNT ARM_THREAD_STATE_COUNT</span>
<span class="hljs-comment">// 线程状态类型</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_THREAD_STATE ARM_THREAD_STATE</span>
<span class="hljs-comment">// 帧指针寄存器（r7寄存器）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_FRAME_POINTER __r[7]</span>
<span class="hljs-comment">// 栈指针寄存器</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_STACK_POINTER __sp</span>
<span class="hljs-comment">// 程序计数器寄存器</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_INSTRUCTION_ADDRESS __pc</span>

<span class="hljs-comment">// x86_64架构（64位Intel，模拟器或Mac）</span>
<span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(__x86_64__)</span>
<span class="hljs-comment">// x86架构不需要去标签，直接返回地址</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DETAG_INSTRUCTION_ADDRESS(A) (A)</span>
<span class="hljs-comment">// 线程状态结构体的大小</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_THREAD_STATE_COUNT x86_THREAD_STATE64_COUNT</span>
<span class="hljs-comment">// 线程状态类型</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_THREAD_STATE x86_THREAD_STATE64</span>
<span class="hljs-comment">// 帧指针寄存器（Base Pointer）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_FRAME_POINTER __rbp</span>
<span class="hljs-comment">// 栈指针寄存器</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_STACK_POINTER __rsp</span>
<span class="hljs-comment">// 指令指针寄存器（Instruction Pointer）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_INSTRUCTION_ADDRESS __rip</span>

<span class="hljs-comment">// i386架构（32位Intel，旧模拟器）</span>
<span class="hljs-meta">#<span class="hljs-keyword">elif</span> defined(__i386__)</span>
<span class="hljs-comment">// x86架构不需要去标签</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> DETAG_INSTRUCTION_ADDRESS(A) (A)</span>
<span class="hljs-comment">// 线程状态结构体的大小</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_THREAD_STATE_COUNT x86_THREAD_STATE32_COUNT</span>
<span class="hljs-comment">// 线程状态类型</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_THREAD_STATE x86_THREAD_STATE32</span>
<span class="hljs-comment">// 帧指针寄存器</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_FRAME_POINTER __ebp</span>
<span class="hljs-comment">// 栈指针寄存器</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_STACK_POINTER __esp</span>
<span class="hljs-comment">// 指令指针寄存器</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_INSTRUCTION_ADDRESS __eip</span>

<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-comment">// 从返回地址计算调用指令地址（返回地址-1即为调用指令）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> CALL_INSTRUCTION_FROM_RETURN_ADDRESS(A) (DETAG_INSTRUCTION_ADDRESS((A)) - 1)</span>

<span class="hljs-comment">// 根据指针大小（32位或64位）定义不同的格式化字符串</span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__LP64__)</span>
<span class="hljs-comment">// 64位系统的格式定义</span>
<span class="hljs-comment">// 堆栈跟踪条目格式：序号(4位) 模块名(31位) 地址(16位十六进制) 符号名 + 偏移量</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TRACE_FMT         <span class="hljs-string">"%-4d%-31s 0x%016lx %s + %lu"</span></span>
<span class="hljs-comment">// 指针完整格式（16位十六进制）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> POINTER_FMT       <span class="hljs-string">"0x%016lx"</span></span>
<span class="hljs-comment">// 指针短格式</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> POINTER_SHORT_FMT <span class="hljs-string">"0x%lx"</span></span>
<span class="hljs-comment">// 符号表结构体类型（64位）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_NLIST struct nlist_64</span>
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
<span class="hljs-comment">// 32位系统的格式定义</span>
<span class="hljs-comment">// 堆栈跟踪条目格式：序号(4位) 模块名(31位) 地址(8位十六进制) 符号名 + 偏移量</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TRACE_FMT         <span class="hljs-string">"%-4d%-31s 0x%08lx %s + %lu"</span></span>
<span class="hljs-comment">// 指针完整格式（8位十六进制）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> POINTER_FMT       <span class="hljs-string">"0x%08lx"</span></span>
<span class="hljs-comment">// 指针短格式</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> POINTER_SHORT_FMT <span class="hljs-string">"0x%lx"</span></span>
<span class="hljs-comment">// 符号表结构体类型（32位）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BS_NLIST struct nlist</span>
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-comment">// 定义栈帧结构体，用于遍历函数调用栈</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BSStackFrameEntry</span>{</span>
    <span class="hljs-comment">// 指向前一个栈帧的指针（形成链表结构）</span>
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">BSStackFrameEntry</span> *<span class="hljs-title">const</span> <span class="hljs-title">previous</span>;</span>
    <span class="hljs-comment">// 当前栈帧的返回地址（即调用者的下一条指令地址）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> return_address;
} BSStackFrameEntry;

<span class="hljs-comment">// 静态全局变量，保存主线程的Mach端口ID</span>
<span class="hljs-type">static</span> <span class="hljs-type">mach_port_t</span> main_thread_id;

@implementation BSBacktraceLogger

<span class="hljs-comment">// +load方法在类加载时自动调用，早于main函数执行</span>
+ (<span class="hljs-type">void</span>)load {
    <span class="hljs-comment">// 保存主线程的Mach线程ID，用于后续识别主线程</span>
    main_thread_id = mach_thread_self();
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark Implementation of interface</span>
<span class="hljs-comment">// 公共接口实现部分</span>

<span class="hljs-comment">// 获取指定NSThread的调用栈回溯信息</span>
+ (NSString *)bs_backtraceOfNSThread:(NSThread *)thread {
    <span class="hljs-comment">// 将NSThread转换为Mach线程，然后获取其回溯信息</span>
    <span class="hljs-keyword">return</span> _bs_backtraceOfThread(bs_machThreadFromNSThread(thread));
}

<span class="hljs-comment">// 获取当前线程的调用栈回溯信息</span>
+ (NSString *)bs_backtraceOfCurrentThread {
    <span class="hljs-comment">// 获取当前线程对象并调用通用方法</span>
    <span class="hljs-keyword">return</span> [self bs_backtraceOfNSThread:[NSThread currentThread]];
}

<span class="hljs-comment">// 获取主线程的调用栈回溯信息</span>
+ (NSString *)bs_backtraceOfMainThread {
    <span class="hljs-comment">// 获取主线程对象并调用通用方法</span>
    <span class="hljs-keyword">return</span> [self bs_backtraceOfNSThread:[NSThread mainThread]];
}

<span class="hljs-comment">// 获取所有线程的调用栈回溯信息</span>
+ (NSString *)bs_backtraceOfAllThread {
    <span class="hljs-comment">// 用于存储线程列表的数组</span>
    <span class="hljs-type">thread_act_array_t</span> threads;
    <span class="hljs-comment">// 线程数量</span>
    <span class="hljs-type">mach_msg_type_number_t</span> thread_count = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 获取当前任务（进程）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">task_t</span> this_task = mach_task_self();
    
    <span class="hljs-comment">// 获取当前任务的所有线程列表</span>
    <span class="hljs-type">kern_return_t</span> kr = task_threads(this_task, &amp;threads, &amp;thread_count);
    <span class="hljs-comment">// 如果获取失败，返回错误信息</span>
    <span class="hljs-keyword">if</span>(kr != KERN_SUCCESS) {
        <span class="hljs-keyword">return</span> @<span class="hljs-string">"Fail to get information of all threads"</span>;
    }
    
    <span class="hljs-comment">// 创建可变字符串，用于拼接所有线程的回溯信息</span>
    NSMutableString *resultString = [NSMutableString stringWithFormat:@<span class="hljs-string">"Call Backtrace of %u threads:\n"</span>, thread_count];
    <span class="hljs-comment">// 遍历所有线程</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; thread_count; i++) {
        <span class="hljs-comment">// 获取每个线程的回溯信息并追加到结果字符串</span>
        [resultString appendString:_bs_backtraceOfThread(threads[i])];
    }
    <span class="hljs-comment">// 返回不可变副本</span>
    <span class="hljs-keyword">return</span> [resultString copy];
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark Get call backtrace of a mach_thread</span>
<span class="hljs-comment">// 获取指定Mach线程的调用栈回溯（核心函数）</span>
NSString *_bs_backtraceOfThread(<span class="hljs-type">thread_t</span> thread) {
    <span class="hljs-comment">// 创建缓冲区，最多存储50层函数调用栈</span>
    <span class="hljs-type">uintptr_t</span> backtraceBuffer[<span class="hljs-number">50</span>];
    <span class="hljs-comment">// 当前栈帧索引</span>
    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 创建可变字符串用于存储回溯信息</span>
    NSMutableString *resultString = [[NSMutableString alloc] initWithFormat:@<span class="hljs-string">"Backtrace of Thread %u:\n"</span>, thread];
    
    <span class="hljs-comment">// 机器上下文结构体，用于存储线程的寄存器状态</span>
    _STRUCT_MCONTEXT machineContext;
    <span class="hljs-comment">// 获取线程的机器上下文（寄存器状态）</span>
    <span class="hljs-keyword">if</span>(!bs_fillThreadStateIntoMachineContext(thread, &amp;machineContext)) {
        <span class="hljs-comment">// 如果获取失败，返回错误信息</span>
        <span class="hljs-keyword">return</span> [NSString stringWithFormat:@<span class="hljs-string">"Fail to get information about thread: %u"</span>, thread];
    }
    
    <span class="hljs-comment">// 获取当前指令地址（PC寄存器的值）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> instructionAddress = bs_mach_instructionAddress(&amp;machineContext);
    <span class="hljs-comment">// 将指令地址作为第一个回溯地址</span>
    backtraceBuffer[i] = instructionAddress;
    <span class="hljs-comment">// 索引递增</span>
    ++i;
    
    <span class="hljs-comment">// 获取链接寄存器的值（ARM架构特有，保存函数返回地址）</span>
    <span class="hljs-type">uintptr_t</span> linkRegister = bs_mach_linkRegister(&amp;machineContext);
    <span class="hljs-comment">// 如果链接寄存器有值（非x86架构）</span>
    <span class="hljs-keyword">if</span> (linkRegister) {
        <span class="hljs-comment">// 将链接寄存器的值作为第二个回溯地址</span>
        backtraceBuffer[i] = linkRegister;
        <span class="hljs-comment">// 索引递增</span>
        i++;
    }
    
    <span class="hljs-comment">// 如果指令地址为0，说明获取失败</span>
    <span class="hljs-keyword">if</span>(instructionAddress == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> @<span class="hljs-string">"Fail to get instruction address"</span>;
    }
    
    <span class="hljs-comment">// 初始化栈帧结构体</span>
    BSStackFrameEntry frame = {<span class="hljs-number">0</span>};
    <span class="hljs-comment">// 获取帧指针（FP寄存器的值，指向当前栈帧）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> framePtr = bs_mach_framePointer(&amp;machineContext);
    <span class="hljs-comment">// 如果帧指针为0，或者无法从该地址读取栈帧数据</span>
    <span class="hljs-keyword">if</span>(framePtr == <span class="hljs-number">0</span> ||
       bs_mach_copyMem((<span class="hljs-type">void</span> *)framePtr, &amp;frame, <span class="hljs-keyword">sizeof</span>(frame)) != KERN_SUCCESS) {
        <span class="hljs-comment">// 返回错误信息</span>
        <span class="hljs-keyword">return</span> @<span class="hljs-string">"Fail to get frame pointer"</span>;
    }
    
    <span class="hljs-comment">// 遍历栈帧链表，最多50层</span>
    <span class="hljs-keyword">for</span>(; i &lt; <span class="hljs-number">50</span>; i++) {
        <span class="hljs-comment">// 保存当前栈帧的返回地址</span>
        backtraceBuffer[i] = frame.return_address;
        <span class="hljs-comment">// 如果返回地址为0，或者前一个栈帧指针为0，或者无法读取前一个栈帧</span>
        <span class="hljs-keyword">if</span>(backtraceBuffer[i] == <span class="hljs-number">0</span> ||
           frame.previous == <span class="hljs-number">0</span> ||
           bs_mach_copyMem(frame.previous, &amp;frame, <span class="hljs-keyword">sizeof</span>(frame)) != KERN_SUCCESS) {
            <span class="hljs-comment">// 跳出循环，栈帧遍历结束</span>
            <span class="hljs-keyword">break</span>;
        }
    }
    
    <span class="hljs-comment">// 记录实际获取的回溯层数</span>
    <span class="hljs-type">int</span> backtraceLength = i;
    <span class="hljs-comment">// 创建符号信息数组，用于存储每个地址对应的符号信息</span>
    Dl_info symbolicated[backtraceLength];
    <span class="hljs-comment">// 对回溯地址进行符号化（将地址转换为函数名、模块名等）</span>
    bs_symbolicate(backtraceBuffer, symbolicated, backtraceLength, <span class="hljs-number">0</span>);
    <span class="hljs-comment">// 遍历所有回溯地址</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; backtraceLength; ++i) {
        <span class="hljs-comment">// 格式化每一条回溯信息并追加到结果字符串</span>
        [resultString appendFormat:@<span class="hljs-string">"%@"</span>, bs_logBacktraceEntry(i, backtraceBuffer[i], &amp;symbolicated[i])];
    }
    <span class="hljs-comment">// 追加换行符</span>
    [resultString appendFormat:@<span class="hljs-string">"\n"</span>];
    <span class="hljs-comment">// 返回不可变副本</span>
    <span class="hljs-keyword">return</span> [resultString copy];
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark Convert NSThread to Mach thread</span>
<span class="hljs-comment">// 将NSThread对象转换为Mach线程ID</span>
<span class="hljs-comment">// 这个函数通过临时修改线程名称来匹配NSThread和Mach线程</span>
<span class="hljs-type">thread_t</span> <span class="hljs-title function_">bs_machThreadFromNSThread</span><span class="hljs-params">(NSThread *nsthread)</span> {
    <span class="hljs-comment">// 用于存储线程名称的缓冲区</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">256</span>];
    <span class="hljs-comment">// 线程数量</span>
    <span class="hljs-type">mach_msg_type_number_t</span> count;
    <span class="hljs-comment">// 线程列表数组</span>
    <span class="hljs-type">thread_act_array_t</span> <span class="hljs-built_in">list</span>;
    <span class="hljs-comment">// 获取当前任务的所有线程</span>
    task_threads(mach_task_self(), &amp;<span class="hljs-built_in">list</span>, &amp;count);
    
    <span class="hljs-comment">// 获取当前时间戳，用作临时线程名称（确保唯一性）</span>
    NSTimeInterval currentTimestamp = [[NSDate date] timeIntervalSince1970];
    <span class="hljs-comment">// 保存原始线程名称</span>
    NSString *originName = [nsthread name];
    <span class="hljs-comment">// 将线程名称临时设置为时间戳字符串</span>
    [nsthread setName:[NSString stringWithFormat:@<span class="hljs-string">"%f"</span>, currentTimestamp]];
    
    <span class="hljs-comment">// 如果是主线程，直接返回保存的主线程ID</span>
    <span class="hljs-keyword">if</span> ([nsthread isMainThread]) {
        <span class="hljs-keyword">return</span> (<span class="hljs-type">thread_t</span>)main_thread_id;
    }
    
    <span class="hljs-comment">// 遍历所有Mach线程</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; count; ++i) {
        <span class="hljs-comment">// 将Mach线程转换为POSIX线程（pthread）</span>
        <span class="hljs-type">pthread_t</span> pt = pthread_from_mach_thread_np(<span class="hljs-built_in">list</span>[i]);
        <span class="hljs-comment">// 再次检查是否为主线程（冗余检查，实际上这个条件永远不会满足）</span>
        <span class="hljs-keyword">if</span> ([nsthread isMainThread]) {
            <span class="hljs-comment">// 如果Mach线程ID匹配主线程ID</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">list</span>[i] == main_thread_id) {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>[i];
            }
        }
        <span class="hljs-comment">// 如果pthread转换成功</span>
        <span class="hljs-keyword">if</span> (pt) {
            <span class="hljs-comment">// 清空名称缓冲区</span>
            name[<span class="hljs-number">0</span>] = <span class="hljs-string">'\0'</span>;
            <span class="hljs-comment">// 获取pthread的线程名称</span>
            pthread_getname_np(pt, name, <span class="hljs-keyword">sizeof</span> name);
            <span class="hljs-comment">// 比较线程名称是否匹配（即是否为我们临时设置的时间戳）</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(name, [nsthread name].UTF8String)) {
                <span class="hljs-comment">// 恢复原始线程名称</span>
                [nsthread setName:originName];
                <span class="hljs-comment">// 返回匹配的Mach线程ID</span>
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>[i];
            }
        }
    }
    
    <span class="hljs-comment">// 如果没有找到匹配的线程，恢复原始名称</span>
    [nsthread setName:originName];
    <span class="hljs-comment">// 返回当前线程ID（作为后备方案）</span>
    <span class="hljs-keyword">return</span> mach_thread_self();
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark GenerateBacbsrackEnrty</span>
<span class="hljs-comment">// 生成单条回溯日志条目</span>
<span class="hljs-comment">// 参数：条目序号、地址、符号信息</span>
NSString* <span class="hljs-title function_">bs_logBacktraceEntry</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">int</span> entryNum,
                               <span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> address,
                               <span class="hljs-type">const</span> Dl_info* <span class="hljs-type">const</span> dlInfo)</span> {
    <span class="hljs-comment">// 文件地址缓冲区（当文件名为空时用于存储地址）</span>
    <span class="hljs-type">char</span> faddrBuff[<span class="hljs-number">20</span>];
    <span class="hljs-comment">// 符号地址缓冲区（当符号名为空时用于存储地址）</span>
    <span class="hljs-type">char</span> saddrBuff[<span class="hljs-number">20</span>];
    
    <span class="hljs-comment">// 从完整路径中提取文件名（只保留最后一段）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* fname = bs_lastPathEntry(dlInfo-&gt;dli_fname);
    <span class="hljs-comment">// 如果文件名为空（未找到符号信息）</span>
    <span class="hljs-keyword">if</span>(fname == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">// 将文件基地址格式化为字符串</span>
        <span class="hljs-built_in">sprintf</span>(faddrBuff, POINTER_FMT, (<span class="hljs-type">uintptr_t</span>)dlInfo-&gt;dli_fbase);
        <span class="hljs-comment">// 使用地址作为文件名</span>
        fname = faddrBuff;
    }
    
    <span class="hljs-comment">// 计算地址相对于符号地址的偏移量</span>
    <span class="hljs-type">uintptr_t</span> offset = address - (<span class="hljs-type">uintptr_t</span>)dlInfo-&gt;dli_saddr;
    <span class="hljs-comment">// 获取符号名称（函数名）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>* sname = dlInfo-&gt;dli_sname;
    <span class="hljs-comment">// 如果符号名称为空</span>
    <span class="hljs-keyword">if</span>(sname == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-comment">// 将文件基地址格式化为字符串</span>
        <span class="hljs-built_in">sprintf</span>(saddrBuff, POINTER_SHORT_FMT, (<span class="hljs-type">uintptr_t</span>)dlInfo-&gt;dli_fbase);
        <span class="hljs-comment">// 使用地址作为符号名</span>
        sname = saddrBuff;
        <span class="hljs-comment">// 重新计算偏移量（相对于文件基地址）</span>
        offset = address - (<span class="hljs-type">uintptr_t</span>)dlInfo-&gt;dli_fbase;
    }
    <span class="hljs-comment">// 格式化输出：模块名(30位对齐) 地址 符号名 + 偏移量</span>
    <span class="hljs-keyword">return</span> [NSString stringWithFormat:@<span class="hljs-string">"%-30s  0x%08"</span> PRIxPTR <span class="hljs-string">" %s + %lu\n"</span> ,fname, (<span class="hljs-type">uintptr_t</span>)address, sname, offset];
}

<span class="hljs-comment">// 从完整路径中提取最后一部分（文件名）</span>
<span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title function_">bs_lastPathEntry</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-type">const</span> path)</span> {
    <span class="hljs-comment">// 如果路径为空，返回NULL</span>
    <span class="hljs-keyword">if</span>(path == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    }
    
    <span class="hljs-comment">// 查找最后一个'/'字符的位置</span>
    <span class="hljs-type">char</span>* lastFile = <span class="hljs-built_in">strrchr</span>(path, <span class="hljs-string">'/'</span>);
    <span class="hljs-comment">// 如果没有找到'/'，说明path本身就是文件名；否则返回'/'后面的部分</span>
    <span class="hljs-keyword">return</span> lastFile == <span class="hljs-literal">NULL</span> ? path : lastFile + <span class="hljs-number">1</span>;
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark HandleMachineContext</span>
<span class="hljs-comment">// 机器上下文处理相关函数</span>

<span class="hljs-comment">// 获取线程状态并填充到机器上下文结构体中</span>
<span class="hljs-type">bool</span> <span class="hljs-title function_">bs_fillThreadStateIntoMachineContext</span><span class="hljs-params">(<span class="hljs-type">thread_t</span> thread, _STRUCT_MCONTEXT *machineContext)</span> {
    <span class="hljs-comment">// 状态结构体的大小（不同架构大小不同）</span>
    <span class="hljs-type">mach_msg_type_number_t</span> state_count = BS_THREAD_STATE_COUNT;
    <span class="hljs-comment">// 调用内核函数获取线程状态（寄存器快照）</span>
    <span class="hljs-type">kern_return_t</span> kr = thread_get_state(thread, BS_THREAD_STATE, (<span class="hljs-type">thread_state_t</span>)&amp;machineContext-&gt;__ss, &amp;state_count);
    <span class="hljs-comment">// 返回是否成功获取</span>
    <span class="hljs-keyword">return</span> (kr == KERN_SUCCESS);
}

<span class="hljs-comment">// 从机器上下文中提取帧指针寄存器的值</span>
<span class="hljs-type">uintptr_t</span> <span class="hljs-title function_">bs_mach_framePointer</span><span class="hljs-params">(<span class="hljs-type">mcontext_t</span> <span class="hljs-type">const</span> machineContext)</span>{
    <span class="hljs-comment">// 通过宏定义访问对应架构的帧指针寄存器</span>
    <span class="hljs-keyword">return</span> machineContext-&gt;__ss.BS_FRAME_POINTER;
}

<span class="hljs-comment">// 从机器上下文中提取栈指针寄存器的值</span>
<span class="hljs-type">uintptr_t</span> <span class="hljs-title function_">bs_mach_stackPointer</span><span class="hljs-params">(<span class="hljs-type">mcontext_t</span> <span class="hljs-type">const</span> machineContext)</span>{
    <span class="hljs-comment">// 通过宏定义访问对应架构的栈指针寄存器</span>
    <span class="hljs-keyword">return</span> machineContext-&gt;__ss.BS_STACK_POINTER;
}

<span class="hljs-comment">// 从机器上下文中提取指令指针/程序计数器的值</span>
<span class="hljs-type">uintptr_t</span> <span class="hljs-title function_">bs_mach_instructionAddress</span><span class="hljs-params">(<span class="hljs-type">mcontext_t</span> <span class="hljs-type">const</span> machineContext)</span>{
    <span class="hljs-comment">// 通过宏定义访问对应架构的指令地址寄存器</span>
    <span class="hljs-keyword">return</span> machineContext-&gt;__ss.BS_INSTRUCTION_ADDRESS;
}

<span class="hljs-comment">// 从机器上下文中提取链接寄存器的值（仅ARM架构有效）</span>
<span class="hljs-type">uintptr_t</span> <span class="hljs-title function_">bs_mach_linkRegister</span><span class="hljs-params">(<span class="hljs-type">mcontext_t</span> <span class="hljs-type">const</span> machineContext)</span>{
<span class="hljs-meta">#<span class="hljs-keyword">if</span> defined(__i386__) || defined(__x86_64__)</span>
    <span class="hljs-comment">// x86架构没有链接寄存器，返回0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
    <span class="hljs-comment">// ARM架构返回LR寄存器的值</span>
    <span class="hljs-keyword">return</span> machineContext-&gt;__ss.__lr;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}

<span class="hljs-comment">// 从指定内存地址复制数据到目标地址</span>
<span class="hljs-comment">// 使用vm_read_overwrite确保可以安全读取其他线程的内存</span>
<span class="hljs-type">kern_return_t</span> <span class="hljs-title function_">bs_mach_copyMem</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *<span class="hljs-type">const</span> src, <span class="hljs-type">void</span> *<span class="hljs-type">const</span> dst, <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> numBytes)</span>{
    <span class="hljs-comment">// 实际复制的字节数</span>
    <span class="hljs-type">vm_size_t</span> bytesCopied = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 使用虚拟内存读取覆写函数，可以跨线程读取内存</span>
    <span class="hljs-keyword">return</span> vm_read_overwrite(mach_task_self(), (<span class="hljs-type">vm_address_t</span>)src, (<span class="hljs-type">vm_size_t</span>)numBytes, (<span class="hljs-type">vm_address_t</span>)dst, &amp;bytesCopied);
}

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> -mark Symbolicate</span>
<span class="hljs-comment">// 符号化相关函数：将内存地址转换为可读的符号信息</span>

<span class="hljs-comment">// 对回溯地址数组进行符号化处理</span>
<span class="hljs-comment">// 参数：回溯地址缓冲区、符号信息缓冲区、条目数量、跳过的条目数</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">bs_symbolicate</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span>* <span class="hljs-type">const</span> backtraceBuffer,
                    Dl_info* <span class="hljs-type">const</span> symbolsBuffer,
                    <span class="hljs-type">const</span> <span class="hljs-type">int</span> numEntries,
                    <span class="hljs-type">const</span> <span class="hljs-type">int</span> skippedEntries)</span>{
    <span class="hljs-comment">// 当前处理的索引</span>
    <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 如果没有跳过条目，且索引在有效范围内</span>
    <span class="hljs-keyword">if</span>(!skippedEntries &amp;&amp; i &lt; numEntries) {
        <span class="hljs-comment">// 第一个条目（当前指令地址）直接符号化，不需要调整</span>
        bs_dladdr(backtraceBuffer[i], &amp;symbolsBuffer[i]);
        <span class="hljs-comment">// 索引递增</span>
        i++;
    }
    
    <span class="hljs-comment">// 处理剩余的返回地址</span>
    <span class="hljs-keyword">for</span>(; i &lt; numEntries; i++) {
        <span class="hljs-comment">// 返回地址需要减1才能得到调用指令的地址，然后进行符号化</span>
        <span class="hljs-comment">// 因为返回地址指向的是调用后的下一条指令</span>
        bs_dladdr(CALL_INSTRUCTION_FROM_RETURN_ADDRESS(backtraceBuffer[i]), &amp;symbolsBuffer[i]);
    }
}

<span class="hljs-comment">// 自定义实现的dladdr函数，用于将地址转换为符号信息</span>
<span class="hljs-comment">// 这是一个手动解析Mach-O文件的符号表来查找符号的过程</span>
<span class="hljs-type">bool</span> <span class="hljs-title function_">bs_dladdr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> address, Dl_info* <span class="hljs-type">const</span> info)</span> {
    <span class="hljs-comment">// 初始化符号信息结构体的所有字段为NULL</span>
    info-&gt;dli_fname = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 文件名</span>
    info-&gt;dli_fbase = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 文件基地址</span>
    info-&gt;dli_sname = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 符号名</span>
    info-&gt;dli_saddr = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 符号地址</span>
    
    <span class="hljs-comment">// 查找包含该地址的镜像索引</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> idx = bs_imageIndexContainingAddress(address);
    <span class="hljs-comment">// 如果没找到对应的镜像，返回false</span>
    <span class="hljs-keyword">if</span>(idx == UINT_MAX) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-comment">// 获取镜像的Mach-O头部</span>
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mach_header</span>* <span class="hljs-title">header</span> =</span> _dyld_get_image_header(idx);
    <span class="hljs-comment">// 获取镜像的虚拟内存地址偏移（ASLR地址随机化偏移）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> imageVMAddrSlide = (<span class="hljs-type">uintptr_t</span>)_dyld_get_image_vmaddr_slide(idx);
    <span class="hljs-comment">// 计算去除偏移后的地址（文件中的原始地址）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> addressWithSlide = address - imageVMAddrSlide;
    <span class="hljs-comment">// 获取段基地址（用于定位符号表在内存中的位置）</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> segmentBase = bs_segmentBaseOfImageIndex(idx) + imageVMAddrSlide;
    <span class="hljs-comment">// 如果段基地址为0，返回false</span>
    <span class="hljs-keyword">if</span>(segmentBase == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 填充文件名和基地址信息</span>
    info-&gt;dli_fname = _dyld_get_image_name(idx);
    info-&gt;dli_fbase = (<span class="hljs-type">void</span>*)header;
    
    <span class="hljs-comment">// 查找符号表并获取最接近该地址的符号</span>
    <span class="hljs-comment">// 最佳匹配的符号表项</span>
    <span class="hljs-type">const</span> BS_NLIST* bestMatch = <span class="hljs-literal">NULL</span>;
    <span class="hljs-comment">// 最小距离初始化为最大值</span>
    <span class="hljs-type">uintptr_t</span> bestDistance = ULONG_MAX;
    <span class="hljs-comment">// 获取Mach-O头部后的第一个加载命令地址</span>
    <span class="hljs-type">uintptr_t</span> cmdPtr = bs_firstCmdAfterHeader(header);
    <span class="hljs-comment">// 如果命令指针为0，说明头部损坏</span>
    <span class="hljs-keyword">if</span>(cmdPtr == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-comment">// 遍历所有加载命令</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">uint32_t</span> iCmd = <span class="hljs-number">0</span>; iCmd &lt; header-&gt;ncmds; iCmd++) {
        <span class="hljs-comment">// 当前加载命令</span>
        <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">load_command</span>* <span class="hljs-title">loadCmd</span> =</span> (<span class="hljs-keyword">struct</span> load_command*)cmdPtr;
        <span class="hljs-comment">// 如果是符号表命令</span>
        <span class="hljs-keyword">if</span>(loadCmd-&gt;cmd == LC_SYMTAB) {
            <span class="hljs-comment">// 转换为符号表命令结构体</span>
            <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">symtab_command</span>* <span class="hljs-title">symtabCmd</span> =</span> (<span class="hljs-keyword">struct</span> symtab_command*)cmdPtr;
            <span class="hljs-comment">// 计算符号表在内存中的地址</span>
            <span class="hljs-type">const</span> BS_NLIST* symbolTable = (BS_NLIST*)(segmentBase + symtabCmd-&gt;symoff);
            <span class="hljs-comment">// 计算字符串表在内存中的地址</span>
            <span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> stringTable = segmentBase + symtabCmd-&gt;stroff;
            
            <span class="hljs-comment">// 遍历符号表中的所有符号</span>
            <span class="hljs-keyword">for</span>(<span class="hljs-type">uint32_t</span> iSym = <span class="hljs-number">0</span>; iSym &lt; symtabCmd-&gt;nsyms; iSym++) {
                <span class="hljs-comment">// 如果n_value为0，说明该符号引用外部对象，跳过</span>
                <span class="hljs-keyword">if</span>(symbolTable[iSym].n_value != <span class="hljs-number">0</span>) {
                    <span class="hljs-comment">// 符号的基地址</span>
                    <span class="hljs-type">uintptr_t</span> symbolBase = symbolTable[iSym].n_value;
                    <span class="hljs-comment">// 计算地址与符号基地址的距离</span>
                    <span class="hljs-type">uintptr_t</span> currentDistance = addressWithSlide - symbolBase;
                    <span class="hljs-comment">// 如果地址大于等于符号基地址，且距离小于等于当前最佳距离</span>
                    <span class="hljs-keyword">if</span>((addressWithSlide &gt;= symbolBase) &amp;&amp;
                       (currentDistance &lt;= bestDistance)) {
                        <span class="hljs-comment">// 更新最佳匹配</span>
                        bestMatch = symbolTable + iSym;
                        <span class="hljs-comment">// 更新最小距离</span>
                        bestDistance = currentDistance;
                    }
                }
            }
            <span class="hljs-comment">// 如果找到了匹配的符号</span>
            <span class="hljs-keyword">if</span>(bestMatch != <span class="hljs-literal">NULL</span>) {
                <span class="hljs-comment">// 填充符号地址（需要加上ASLR偏移）</span>
                info-&gt;dli_saddr = (<span class="hljs-type">void</span>*)(bestMatch-&gt;n_value + imageVMAddrSlide);
                <span class="hljs-comment">// 从字符串表中获取符号名称</span>
                info-&gt;dli_sname = (<span class="hljs-type">char</span>*)((<span class="hljs-type">intptr_t</span>)stringTable + (<span class="hljs-type">intptr_t</span>)bestMatch-&gt;n_un.n_strx);
                <span class="hljs-comment">// 如果符号名以下划线开头（C/C++符号的命名约定），跳过下划线</span>
                <span class="hljs-keyword">if</span>(*info-&gt;dli_sname == <span class="hljs-string">'_'</span>) {
                    info-&gt;dli_sname++;
                }
                <span class="hljs-comment">// 如果符号地址等于文件基地址且类型为3，说明符号已被剥离</span>
                <span class="hljs-keyword">if</span>(info-&gt;dli_saddr == info-&gt;dli_fbase &amp;&amp; bestMatch-&gt;n_type == <span class="hljs-number">3</span>) {
                    info-&gt;dli_sname = <span class="hljs-literal">NULL</span>;
                }
                <span class="hljs-comment">// 找到符号后跳出循环</span>
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-comment">// 移动到下一个加载命令</span>
        cmdPtr += loadCmd-&gt;cmdsize;
    }
    <span class="hljs-comment">// 返回成功</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 获取Mach-O头部后的第一个加载命令地址</span>
<span class="hljs-type">uintptr_t</span> <span class="hljs-title function_">bs_firstCmdAfterHeader</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> mach_header* <span class="hljs-type">const</span> header)</span> {
    <span class="hljs-comment">// 根据魔数判断Mach-O文件的类型和字节序</span>
    <span class="hljs-keyword">switch</span>(header-&gt;magic) {
        <span class="hljs-keyword">case</span> MH_MAGIC:    <span class="hljs-comment">// 32位小端序</span>
        <span class="hljs-keyword">case</span> MH_CIGAM:    <span class="hljs-comment">// 32位大端序</span>
            <span class="hljs-comment">// 32位头部后直接跟加载命令（头部大小为mach_header）</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-type">uintptr_t</span>)(header + <span class="hljs-number">1</span>);
        <span class="hljs-keyword">case</span> MH_MAGIC_64: <span class="hljs-comment">// 64位小端序</span>
        <span class="hljs-keyword">case</span> MH_CIGAM_64: <span class="hljs-comment">// 64位大端序</span>
            <span class="hljs-comment">// 64位头部后直接跟加载命令（头部大小为mach_header_64）</span>
            <span class="hljs-keyword">return</span> (<span class="hljs-type">uintptr_t</span>)(((<span class="hljs-keyword">struct</span> mach_header_64*)header) + <span class="hljs-number">1</span>);
        <span class="hljs-keyword">default</span>:
            <span class="hljs-comment">// 未知魔数，头部损坏</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// Header is corrupt</span>
    }
}

<span class="hljs-comment">// 查找包含指定地址的镜像索引</span>
<span class="hljs-comment">// 遍历所有已加载的动态库，找到包含该地址的那一个</span>
<span class="hljs-type">uint32_t</span> <span class="hljs-title function_">bs_imageIndexContainingAddress</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uintptr_t</span> address)</span> {
    <span class="hljs-comment">// 获取当前进程加载的镜像（动态库/可执行文件）数量</span>
    <span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> imageCount = _dyld_image_count();
    <span class="hljs-comment">// Mach-O头部指针</span>
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mach_header</span>* <span class="hljs-title">header</span> =</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 遍历所有镜像</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">uint32_t</span> iImg = <span class="hljs-number">0</span>; iImg &lt; imageCount; iImg++) {
        <span class="hljs-comment">// 获取镜像的头部</span>
        header = _dyld_get_image_header(iImg);
        <span class="hljs-comment">// 如果头部有效</span>
        <span class="hljs-keyword">if</span>(header != <span class="hljs-literal">NULL</span>) {
            <span class="hljs-comment">// 查找包含该地址的段命令</span>
            <span class="hljs-comment">// 计算去除ASLR偏移后的地址</span>
            <span class="hljs-type">uintptr_t</span> addressWSlide = address - (<span class="hljs-type">uintptr_t</span>)_dyld_get_image_vmaddr_slide(iImg);
            <span class="hljs-comment">// 获取第一个加载命令的地址</span>
            <span class="hljs-type">uintptr_t</span> cmdPtr = bs_firstCmdAfterHeader(header);
            <span class="hljs-comment">// 如果命令指针无效，跳过这个镜像</span>
            <span class="hljs-keyword">if</span>(cmdPtr == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">continue</span>;
            }
            <span class="hljs-comment">// 遍历该镜像的所有加载命令</span>
            <span class="hljs-keyword">for</span>(<span class="hljs-type">uint32_t</span> iCmd = <span class="hljs-number">0</span>; iCmd &lt; header-&gt;ncmds; iCmd++) {
                <span class="hljs-comment">// 当前加载命令</span>
                <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">load_command</span>* <span class="hljs-title">loadCmd</span> =</span> (<span class="hljs-keyword">struct</span> load_command*)cmdPtr;
                <span class="hljs-comment">// 如果是32位段命令</span>
                <span class="hljs-keyword">if</span>(loadCmd-&gt;cmd == LC_SEGMENT) {
                    <span class="hljs-comment">// 转换为32位段命令结构体</span>
                    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">segment_command</span>* <span class="hljs-title">segCmd</span> =</span> (<span class="hljs-keyword">struct</span> segment_command*)cmdPtr;
                    <span class="hljs-comment">// 检查地址是否在该段的虚拟地址范围内</span>
                    <span class="hljs-keyword">if</span>(addressWSlide &gt;= segCmd-&gt;vmaddr &amp;&amp;
                       addressWSlide &lt; segCmd-&gt;vmaddr + segCmd-&gt;vmsize) {
                        <span class="hljs-comment">// 找到了，返回镜像索引</span>
                        <span class="hljs-keyword">return</span> iImg;
                    }
                }
                <span class="hljs-comment">// 如果是64位段命令</span>
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(loadCmd-&gt;cmd == LC_SEGMENT_64) {
                    <span class="hljs-comment">// 转换为64位段命令结构体</span>
                    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> segment_command_64* segCmd = (<span class="hljs-keyword">struct</span> segment_command_64*)cmdPtr;
                    <span class="hljs-comment">// 检查地址是否在该段的虚拟地址范围内</span>
                    <span class="hljs-keyword">if</span>(addressWSlide &gt;= segCmd-&gt;vmaddr &amp;&amp;
                       addressWSlide &lt; segCmd-&gt;vmaddr + segCmd-&gt;vmsize) {
                        <span class="hljs-comment">// 找到了，返回镜像索引</span>
                        <span class="hljs-keyword">return</span> iImg;
                    }
                }
                <span class="hljs-comment">// 移动到下一个加载命令</span>
                cmdPtr += loadCmd-&gt;cmdsize;
            }
        }
    }
    <span class="hljs-comment">// 没有找到包含该地址的镜像，返回UINT_MAX表示失败</span>
    <span class="hljs-keyword">return</span> UINT_MAX;
}

<span class="hljs-comment">// 获取指定镜像索引的段基地址</span>
<span class="hljs-comment">// 通过查找__LINKEDIT段来计算文件在内存中的映射基地址</span>
<span class="hljs-type">uintptr_t</span> <span class="hljs-title function_">bs_segmentBaseOfImageIndex</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">uint32_t</span> idx)</span> {
    <span class="hljs-comment">// 获取镜像的Mach-O头部</span>
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mach_header</span>* <span class="hljs-title">header</span> =</span> _dyld_get_image_header(idx);
    
    <span class="hljs-comment">// 查找段命令并返回文件镜像地址</span>
    <span class="hljs-comment">// 获取第一个加载命令的地址</span>
    <span class="hljs-type">uintptr_t</span> cmdPtr = bs_firstCmdAfterHeader(header);
    <span class="hljs-comment">// 如果命令指针无效，返回0</span>
    <span class="hljs-keyword">if</span>(cmdPtr == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    <span class="hljs-comment">// 遍历所有加载命令</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>;i &lt; header-&gt;ncmds; i++) {
        <span class="hljs-comment">// 当前加载命令</span>
        <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">load_command</span>* <span class="hljs-title">loadCmd</span> =</span> (<span class="hljs-keyword">struct</span> load_command*)cmdPtr;
        <span class="hljs-comment">// 如果是32位段命令</span>
        <span class="hljs-keyword">if</span>(loadCmd-&gt;cmd == LC_SEGMENT) {
            <span class="hljs-comment">// 转换为32位段命令结构体</span>
            <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">segment_command</span>* <span class="hljs-title">segmentCmd</span> =</span> (<span class="hljs-keyword">struct</span> segment_command*)cmdPtr;
            <span class="hljs-comment">// 查找__LINKEDIT段（包含符号表、字符串表等链接信息）</span>
            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(segmentCmd-&gt;segname, SEG_LINKEDIT) == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 返回段基地址：虚拟内存地址 - 文件偏移</span>
                <span class="hljs-comment">// 这个值用于将文件偏移转换为虚拟内存地址</span>
                <span class="hljs-keyword">return</span> segmentCmd-&gt;vmaddr - segmentCmd-&gt;fileoff;
            }
        }
        <span class="hljs-comment">// 如果是64位段命令</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(loadCmd-&gt;cmd == LC_SEGMENT_64) {
            <span class="hljs-comment">// 转换为64位段命令结构体</span>
            <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> segment_command_64* segmentCmd = (<span class="hljs-keyword">struct</span> segment_command_64*)cmdPtr;
            <span class="hljs-comment">// 查找__LINKEDIT段</span>
            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(segmentCmd-&gt;segname, SEG_LINKEDIT) == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 返回段基地址：虚拟内存地址 - 文件偏移</span>
                <span class="hljs-keyword">return</span> (<span class="hljs-type">uintptr_t</span>)(segmentCmd-&gt;vmaddr - segmentCmd-&gt;fileoff);
            }
        }
        <span class="hljs-comment">// 移动到下一个加载命令</span>
        cmdPtr += loadCmd-&gt;cmdsize;
    }
    <span class="hljs-comment">// 没有找到__LINKEDIT段，返回0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

@end

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot 为什么突然刷爆硅谷？它不是下一个 ChatGPT，而是另一种可能]]></title>    <link>https://juejin.cn/post/7600318091831967771</link>    <guid>https://juejin.cn/post/7600318091831967771</guid>    <pubDate>2026-01-29T05:45:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600318091831967771" data-draft-id="7600489282822979634" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot 为什么突然刷爆硅谷？它不是下一个 ChatGPT，而是另一种可能"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-29T05:45:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IvanCodes"/> <meta itemprop="url" content="https://juejin.cn/user/2376493931447594"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot 为什么突然刷爆硅谷？它不是下一个 ChatGPT，而是另一种可能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2376493931447594/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IvanCodes
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:45:26.000Z" title="Thu Jan 29 2026 05:45:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><b>一、为何最近突然在技术圈刷屏？</b></h2>
<p>这两天我刷 <b>X</b> 和 <b>GitHub</b> 等主流平台的时候，有个名字出现得特别频繁，频繁到你想忽略都不行：<b>Clawdbot</b></p>
<p>更离谱的是，它还改名了。官方这两天把名字改成了 <b>Moltbot</b></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72f49c5de7e0402eb64d0bd27906a552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=qDqPNOMc0L%2BwCrYa86g6ylS6AaM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>它没有发布会，没有融资新闻，也没有那种铺天盖地的媒体通稿。它的传播路径非常简单粗暴：一群技术佬把它跑起来了，然后开始在平台上晒：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd89173973164cecad5c1791eddc1571~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=hajN7obmO0DMHa6fwaHZxZi0ii4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>它的热度增长非常明显，短时间内，Star数呈爆炸式增长。GitHub仓库里的star数，现已突破70k。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d15dfce1df84cf7b8ad0eb6ec1e7c57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=04%2BhbggoZviOQx4A0d7jAFiKXUU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2aa14012ae54947a7605d0f6fcad96b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=%2FOHSZI2DT2%2F7sylSRz0QknxzSEc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1"><b>二、它到底是什么？一句话讲透</b></h2>
<p>先放官网：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.bot%2F" target="_blank" title="https://clawd.bot/" ref="nofollow noopener noreferrer">clawd.bot/</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aab24ace6f444a90a864862fb956c6ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=UbGDhrLdU3kFdRRdyXjjAsl%2FHQs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>如果你问我它是什么，我会这样解释：</p>
<p>ChatGPT 的核心体验是 <b>你输入一句，它回你一段</b>。
而 Moltbot 的核心体验是 <b>你交代一句，它去把事情办了</b>。</p>
<p>注意，这不是表达方式的区别，这是定位的区别。</p>
<blockquote>
<p>它不是来陪你聊天的，它更像是一个住在后台的助理。
你不需要一直盯着它，它会挂在那儿，悄悄跑任务。</p>
</blockquote>
<p>最关键的一点是： <b>它不是更会说，而是更敢动。</b></p>
<p>它可以读取你的日历、控制你的浏览器、接入 Discord 群聊、甚至帮你发邮件。你会感觉它不像一个网页里的机器人，而像一个 <b>长在你系统里的工具人</b>。</p>
<h2 data-id="heading-2"><b>三、它为什么能火得这么快？</b></h2>
<p>我觉得它火得快，原因其实挺现实的。</p>
<p>以前我们用 AI，很多时候是在做表演。让它写段文案、生成张图、编个故事，看起来很厉害，但跟日常工作隔着一层。</p>
<p>而 Moltbot 走的是另一条路：它不表演，它直接参与流程。</p>
<p>你把它放在后台，它就能替你盯着群里有没有人在提上线、提发布、提 deadline；有人提了，它就记下来，甚至可以推送给你。</p>
<h2 data-id="heading-3"><b>四、保姆级安装教程</b></h2>
<p>很多人想试，但又怕。怕它把电脑搞坏、怕它权限太大、怕自己一个手滑就把主力机弄崩。</p>
<p>所以我给的建议只有一句：</p>
<p><b>别在主力机裸奔跑，放虚拟机里玩。</b></p>
<p>虚拟机的好处就是，出了问题你直接删了重装，干净利落。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/232ff9cd38e54a2e997ebaa8832e5c0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=Gy2kB%2FaZUaXTeKPeLS5reFqc9YM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>准备工作很简单：装 VMware Workstation，然后装一个 Ubuntu，确保能联网就行。</p>
<h3 data-id="heading-4"><b>第一步：把环境铺好</b></h3>
<p>Moltbot 依赖 <b>Node.js</b> 和 <b>Git</b>。新环境先把基础工具装齐。</p>
<p>1.更新源</p>
<pre><code class="hljs language-bash" lang="bash">apt update 
apt install -y nodejs
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e48c3413feeb40ffafa4d0b52a3c6aa2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=Up0DTsAnC2MdZoe4kNLyNBkyFHY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>等待安装完成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8c8820a4e174b2ab9997d107586c83e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=g00g%2BGAOLm0EbfSQR0R2ZEf6Czs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>2.检查版本，确认环境没问题</p>
<pre><code class="hljs language-bash" lang="bash">node -v
npm -v
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/260d243b440b487688e2a7d7804d75a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=ZbBjeflxNhs1uEulJkSx7u4Xdx8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-5"><b>第二步：一键安装 Moltbot</b></h3>
<p>环境准备好后，直接跑官方的一键安装脚本即可。</p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://clawd.bot/install.sh | bash
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/770ce453fd09456c92c1595f72d64b2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=l%2Bd%2BvuHTlw5034FNmqXCDuOmJS4%3D" alt="在这里插入图片描述" loading="lazy"/>
接着它会在屏幕上刷出一个巨大的字符画，写着 CLAWDBOT。</p>
<p>看到这张图，基本就说明你装对了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/906b15cd48e847b2bde8a59ed0f4e2fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=zt2C3ixarcXMyNVtTb2iWNZYFzA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-6"><b>第三步：安全警告别跳过</b></h3>
<p>后面会说能执行命令、能读写文件、能接入各种服务
一旦被诱导、被攻击、或者你自己操作不当，都可能造成风险</p>
<p>下面这张图就是它弹出的安全警告之一</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54a56eb10bdd4ab290a1a0cc4446a23f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=mWfJ2saUcqzCuu5omHnuxI7a73E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>如果你是在虚拟机里，这时候就很舒服了。
你可以放心输入 <b>Yes</b>，继续。</p>
<h3 data-id="heading-7"><b>第四步：配置模型和渠道</b></h3>
<p>安装完成后它会引导配置，并告诉你 Gateway 的端口是 <b>18789</b>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0ddda1c5552476581187c2e41e5fbe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=9JCZN2HkP%2B0aMdw5mmJho3GVjnY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>接下来是选模型。</p>
<p>它支持很多主流模型，为了国内访问稳定、中文好用、价格也不离谱，我这里选的是 <b>Moonshot AI（Kimi）</b>。</p>
<p>这张图就是模型选择页面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f22b2224ed19499f904b34f69d0ee0b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=DN10TdONsEZ5aRm7%2FsNkgVtP134%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>选完之后输入 API Key：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ec0278e42554f0b821df935edd4bfa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=et6%2FDtrWwsvxDiZVvImOyBMf24E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然后它会让你选接入渠道。这里我用 Discord 举例，因为最适合当机器人宿主。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c653b7af69644d5bafdb89cc0990dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=maKyb%2FIy78ZTyQgpNjc4ZIOYGyE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-8"><b>第五步：把 Discord 的机器人打通</b></h3>
<p>这一步是最容易卡人的，但其实流程很固定。</p>
<p>在 Discord Developer Portal，新建一个 Application，名字随便取。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c00cb79f0946638e5d731ae53f2a64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=mPzAzAzNf0IA9I8D21PjmILZ1NU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然后点 Bot，重置 Token 并复制。
这个 Token 很重要，它就是你机器人唯一的身份证。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0ccc3399e8b4a1c9b83a3d563a4af8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=hUEiNRogclyo%2B1FgaMRDrKhEDTQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>复制完回到虚拟机，把 Token 粘进去。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ef2b0e987e24e0d8be7a9c791667ec6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=ceRjryO2LvmyeZbHMyPPYY%2B2VRM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>这里我必须强调一句： <b>白名单一定要配。</b>
不然别人随便 @ 你的机器人，让它干点什么，你哭都来不及。</p>
<h3 data-id="heading-9"><b>第六步：装技能</b></h3>
<p>Moltbot 本体只是框架，它的能力来自 Skills。
比如读 Notion、操作日历、管理文件之类的，都要靠技能补齐。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76c242be9c884f22850671abd52c9f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=NFwAWez70kkS0%2BmKcAai3RwKuRM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>安装过程中可能会遇到一些报错提示，比如 hooks、systemd。
只要不是那种直接崩掉的致命错误，很多都可以跳过。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21b94555f5c84520ae7a564e12d634d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=U%2Fy2QVaC3rZcDbFnnraROnEDB%2Fs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-10"><b>第七步：启动并访问控制台</b></h3>
<p>启动命令如下：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot gateway --verbose --<span class="hljs-built_in">bind</span> lan --port 18789 --allow-unconfigured
</code></pre>
<p>当你看到下面这张图这种绿色日志，说明 gateway 已经监听成功了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50cd86160c6548df8bd92866798d4f51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=Z0xzpL1xnALH%2B0%2FDy78WMI0G6AY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>然后你打开浏览器访问虚拟机 <code>IP:18789</code>，会看到控制台界面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/738469116df14154a68f28a667865cd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSXZhbkNvZGVz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770270326&amp;x-signature=SWgCTdv8rC%2FspFaHrpFvhmcTpXs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-11"><b>五、它到底能干嘛？我将介绍两个场景</b></h2>
<p>别把它当成聊天机器人。<strong>我没有把它当人聊，而是把它当鬼用。</strong></p>
<h3 data-id="heading-12"><strong>场景一：把它拉进 Discord，当永远在线的群秘</strong></h3>
<p>我没有单独跟 Moltbot 聊天，而是直接把它拉进了一个 Discord 群。</p>
<p><strong>我的指令：</strong></p>
<blockquote>
<p>@clawdbot 以后这个群里，只要有人讨论到「发布」「上线」「deadline」，都帮我记下来。</p>
</blockquote>
<p><strong>效果：</strong>
半小时后，群里有人随口说了一句：“下周三之前得把这个功能发了。”
几分钟后，Moltbot 默默地给我发了一条私信：</p>
<blockquote>
<p>「已记录关键信息：功能发布 Deadline，下周三。」</p>
</blockquote>
<p>它就像一个永远不睡觉、在旁边默默听会的同事。</p>
<h3 data-id="heading-13"><strong>场景二：把碎语变成文档</strong></h3>
<p>你在 Discord 里跟人头脑风暴，想法很乱。
你对 Moltbot 说：</p>
<blockquote>
<p>把刚才我们讨论的内容，整理成一篇文档，标题叫「公众号选题草稿」，要分好段。</p>
</blockquote>
<p>你甚至不用打开笔记软件，它会在后台直接调用 API，在你指定的 Notion 或本地文件里生成好文档。这种感觉非常奇妙。</p>
<h2 data-id="heading-14"><b>六、争议：为什么它越火，越让人害怕？</b></h2>
<p>它越火，就越多人开始担心，这个担心也不是矫情。</p>
<p>因为 Moltbot 的强大来自它的权限。
权限越大，风险越大。</p>
<p>当一个 AI 能读你的邮件、动你的文件、执行你的终端命令，它就不只是助手了，它更像一个拿着你家钥匙的人。</p>
<p>更麻烦的是，大模型天生有提示词注入的问题。
你想象一下，有人在群里发一段诱导文本，让 Moltbot 执行危险命令。</p>
<p>这不是科幻，这是现实安全领域正在讨论的事。</p>
<p>所以我才反复强调： <b>虚拟机隔离是底线</b></p>
<hr/>
<h2 data-id="heading-15"><b>七、最后的话</b></h2>
<p>Moltbot 现在还早期，bug 多、配置麻烦、生态也不成熟。它不是那种装上就能爽用的产品。</p>
<p>但它确实把方向指得很清楚：</p>
<p><b>AI 不应该被困在聊天框里。</b></p>
<p>它应该进系统、进流程、进群聊、进后台，像空气一样存在。</p>
<p><b>它不完美，但它很危险，也很迷人。</b></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin flow的简单了解]]></title>    <link>https://juejin.cn/post/7600560664407425087</link>    <guid>https://juejin.cn/post/7600560664407425087</guid>    <pubDate>2026-01-29T08:44:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600560664407425087" data-draft-id="7600333405979852841" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin flow的简单了解"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-29T08:44:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yen"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426633214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin flow的简单了解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426633214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T08:44:41.000Z" title="Thu Jan 29 2026 08:44:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、简单用法</h2>
<h3 data-id="heading-1">1. Flow 概述</h3>
<p>Flow 是 Kotlin 协程库中用于处理异步数据流的 API，类似于 RxJava 的 Observable，但更轻量且与协程深度集成。</p>
<h4 data-id="heading-2">主要特点：</h4>
<ul>
<li><strong>冷流（Cold Stream）</strong> ：消费者触发时才执行</li>
<li><strong>基于协程</strong>：天然支持挂起函数</li>
<li><strong>响应式编程</strong>：支持函数式操作符</li>
<li><strong>结构化并发</strong>：自动取消和资源清理</li>
</ul>
<h3 data-id="heading-3">2. Flow 的创建</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. flow {} 构建器</span>
<span class="hljs-keyword">val</span> flow1 = flow {
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.3</span>) {
        delay(<span class="hljs-number">100</span>) <span class="hljs-comment">// 挂起函数</span>
        emit(i)    <span class="hljs-comment">// 发射值</span>
    }
}

<span class="hljs-comment">// 2. asFlow() 扩展函数</span>
<span class="hljs-keyword">val</span> flow2 = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>).asFlow()
<span class="hljs-keyword">val</span> flow3 = (<span class="hljs-number">1.</span><span class="hljs-number">.3</span>).asFlow()

<span class="hljs-comment">// 3. flowOf()</span>
<span class="hljs-keyword">val</span> flow4 = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)

<span class="hljs-comment">// 4. channelFlow - 支持复杂异步场景</span>
<span class="hljs-keyword">val</span> flow5 = channelFlow {
    send(<span class="hljs-number">1</span>)
    withContext(Dispatchers.IO) {
        send(<span class="hljs-number">2</span>)
    }
}
</code></pre>
<h3 data-id="heading-4">3. Flow 操作符</h3>
<h4 data-id="heading-5">中间操作符（Intermediate Operators）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 转换操作</span>
flow.map { it * <span class="hljs-number">2</span> }                    <span class="hljs-comment">// 映射</span>
flow.filter { it &gt; <span class="hljs-number">5</span> }                 <span class="hljs-comment">// 过滤</span>
flow.transform { value -&gt;
    emit(<span class="hljs-string">"Value: <span class="hljs-variable">$value</span>"</span>)
    emit(value * <span class="hljs-number">10</span>)
}

<span class="hljs-comment">// 限长操作</span>
flow.take(<span class="hljs-number">2</span>)                           <span class="hljs-comment">// 取前两个</span>
flow.takeWhile { it &lt; <span class="hljs-number">3</span> }              <span class="hljs-comment">// 条件取</span>

<span class="hljs-comment">// 组合操作</span>
<span class="hljs-keyword">val</span> flowA = flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
<span class="hljs-keyword">val</span> flowB = flowOf(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>)

flowA.zip(flowB) { a, b -&gt; <span class="hljs-string">"<span class="hljs-variable">$a</span> -&gt; <span class="hljs-variable">$b</span>"</span> } <span class="hljs-comment">// 压缩</span>
flowA.combine(flowB) { a, b -&gt; <span class="hljs-string">"<span class="hljs-variable">$a</span> - <span class="hljs-variable">$b</span>"</span> } <span class="hljs-comment">// 组合（最新值）</span>

<span class="hljs-comment">// 展平操作</span>
flow.flatMapConcat { value -&gt;          <span class="hljs-comment">// 顺序连接</span>
    flowOf(value, value * <span class="hljs-number">2</span>)
}
flow.flatMapMerge { value -&gt;           <span class="hljs-comment">// 并发合并</span>
    flow {
        delay(<span class="hljs-number">100</span>)
        emit(value)
    }
}
flow.flatMapLatest { value -&gt;          <span class="hljs-comment">// 最新值</span>
    flow {
        delay(<span class="hljs-number">100</span>)
        emit(value)
    }
}
</code></pre>
<h4 data-id="heading-6">终端操作符（Terminal Operators）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 收集值</span>
flow.collect { value -&gt;
    println(value)
}

<span class="hljs-comment">// 转换为集合</span>
<span class="hljs-keyword">val</span> list = flow.toList()
<span class="hljs-keyword">val</span> <span class="hljs-keyword">set</span> = flow.toSet()

<span class="hljs-comment">// 聚合操作</span>
<span class="hljs-keyword">val</span> sum = flow.reduce { acc, value -&gt; acc + value }
<span class="hljs-keyword">val</span> sum2 = flow.fold(<span class="hljs-number">0</span>) { acc, value -&gt; acc + value }

<span class="hljs-comment">// 获取单个值</span>
<span class="hljs-keyword">val</span> first = flow.first()
<span class="hljs-keyword">val</span> firstOrNull = flow.firstOrNull()
<span class="hljs-keyword">val</span> single = flow.single()  <span class="hljs-comment">// 确保只有一个值</span>

<span class="hljs-comment">// 计数</span>
<span class="hljs-keyword">val</span> count = flow.count()
</code></pre>
<h3 data-id="heading-7">4. 异常处理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// catch 操作符</span>
flow.<span class="hljs-keyword">catch</span> { cause -&gt;
    println(<span class="hljs-string">"Caught exception: <span class="hljs-variable">$cause</span>"</span>)
    emit(-<span class="hljs-number">1</span>)  <span class="hljs-comment">// 发射备用值</span>
}.collect { value -&gt;
    println(value)
}

<span class="hljs-comment">// 声明式异常处理</span>
flow.onCompletion { cause -&gt;
    cause?.let { println(<span class="hljs-string">"Flow completed exceptionally: <span class="hljs-variable">$it</span>"</span>) }
        ?: println(<span class="hljs-string">"Flow completed successfully"</span>)
}

<span class="hljs-comment">// 示例：多层捕获</span>
flow
    .map { it * <span class="hljs-number">2</span> }
    .<span class="hljs-keyword">catch</span> { emit(-<span class="hljs-number">1</span>) }  <span class="hljs-comment">// 只捕获上游异常</span>
    .collect { value -&gt;
        <span class="hljs-keyword">try</span> {
            println(value)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 处理收集端异常</span>
        }
    }
</code></pre>
<h3 data-id="heading-8">5. 上下文和线程切换</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// flowOn - 指定上游操作的上下文</span>
flow
    .map { it * <span class="hljs-number">2</span> }                    <span class="hljs-comment">// 在 IO 线程执行</span>
    .flowOn(Dispatchers.IO)
    .collect { value -&gt;                <span class="hljs-comment">// 在调用者上下文执行</span>
        println(value)
    }

<span class="hljs-comment">// 错误示例：不要在 flow 构建器中切换上下文</span>
<span class="hljs-keyword">val</span> wrongFlow = flow {
    withContext(Dispatchers.IO) {      <span class="hljs-comment">// ❌ 错误！</span>
        emit(<span class="hljs-number">1</span>)
    }
}

<span class="hljs-comment">// 正确做法：使用 channelFlow 或 flowOn</span>
<span class="hljs-keyword">val</span> correctFlow = flow {
    emit(<span class="hljs-number">1</span>)
}.flowOn(Dispatchers.IO)
</code></pre>
<h3 data-id="heading-9">6. 背压（Backpressure）处理</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 缓冲</span>
flow.buffer()                          <span class="hljs-comment">// 默认缓冲</span>
flow.buffer(<span class="hljs-number">10</span>)                        <span class="hljs-comment">// 指定缓冲大小</span>

<span class="hljs-comment">// 合并（跳过中间值）</span>
flow.conflate()                        <span class="hljs-comment">// 只处理最新值</span>

<span class="hljs-comment">// 收集最新值</span>
flow.collectLatest { value -&gt;
    <span class="hljs-comment">// 如果新值到达，取消当前处理</span>
    delay(<span class="hljs-number">300</span>)  <span class="hljs-comment">// 模拟耗时操作</span>
    println(value)
}
</code></pre>
<h3 data-id="heading-10">7. 热流（Hot Flow）</h3>
<h4 data-id="heading-11">SharedFlow</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建 SharedFlow</span>
<span class="hljs-keyword">val</span> sharedFlow = MutableSharedFlow&lt;<span class="hljs-built_in">Int</span>&gt;(
    replay = <span class="hljs-number">2</span>,          <span class="hljs-comment">// 新订阅者接收的历史值数量</span>
    extraBufferCapacity = <span class="hljs-number">10</span>  <span class="hljs-comment">// 额外缓冲</span>
)

<span class="hljs-comment">// 发射值</span>
viewModelScope.launch {
    sharedFlow.emit(<span class="hljs-number">1</span>)
}

<span class="hljs-comment">// 收集值</span>
sharedFlow.collect { value -&gt;
    println(<span class="hljs-string">"Collector 1: <span class="hljs-variable">$value</span>"</span>)
}

<span class="hljs-comment">// shareIn - 将冷流转为热流</span>
<span class="hljs-keyword">val</span> coldFlow = flow {
    repeat(<span class="hljs-number">10</span>) {
        emit(it)
        delay(<span class="hljs-number">100</span>)
    }
}

<span class="hljs-keyword">val</span> hotFlow = coldFlow.shareIn(
    scope = viewModelScope,
    started = SharingStarted.WhileSubscribed(),  <span class="hljs-comment">// 订阅时开始</span>
    replay = <span class="hljs-number">1</span>
)

<span class="hljs-comment">// started 参数选项：</span>
<span class="hljs-comment">// SharingStarted.Eagerly    - 立即开始</span>
<span class="hljs-comment">// SharingStarted.Lazily     - 第一个订阅者出现时开始</span>
<span class="hljs-comment">// SharingStarted.WhileSubscribed() - 有订阅者时开始</span>
</code></pre>
<h4 data-id="heading-12">StateFlow</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建 StateFlow</span>
<span class="hljs-keyword">val</span> stateFlow = MutableStateFlow(<span class="hljs-number">0</span>)  <span class="hljs-comment">// 需要初始值</span>

<span class="hljs-comment">// 更新值（自动去重）</span>
stateFlow.value = <span class="hljs-number">1</span>
stateFlow.tryEmit(<span class="hljs-number">2</span>)

<span class="hljs-comment">// 收集值（自动接收最新值和后续更新）</span>
stateFlow.collect { value -&gt;
    println(<span class="hljs-string">"Current state: <span class="hljs-variable">$value</span>"</span>)
}

<span class="hljs-comment">// stateIn - 将 Flow 转换为 StateFlow</span>
<span class="hljs-keyword">val</span> state = flow {
    emit(<span class="hljs-number">1</span>)
    delay(<span class="hljs-number">1000</span>)
    emit(<span class="hljs-number">2</span>)
}.stateIn(
    scope = viewModelScope,
    started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),  <span class="hljs-comment">// 5秒后无订阅者停止</span>
    initialValue = <span class="hljs-number">0</span>
)
</code></pre>
<h3 data-id="heading-13">8. Flow 生命周期</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">flow
    .onStart { 
        println(<span class="hljs-string">"Flow started"</span>) 
    }
    .onEach { value -&gt;
        println(<span class="hljs-string">"Emitted: <span class="hljs-variable">$value</span>"</span>)
    }
    .onCompletion { cause -&gt;
        cause?.let { println(<span class="hljs-string">"Completed with exception: <span class="hljs-variable">$it</span>"</span>) }
            ?: println(<span class="hljs-string">"Completed successfully"</span>)
    }
    .<span class="hljs-keyword">catch</span> { cause -&gt;
        println(<span class="hljs-string">"Caught: <span class="hljs-variable">$cause</span>"</span>)
    }
    .collect()
</code></pre>
<h3 data-id="heading-14">9. 实际应用示例</h3>
<h4 data-id="heading-15">示例 1：网络请求重试</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchDataWithRetry</span><span class="hljs-params">()</span></span>: Flow&lt;Result&gt; = flow {
    <span class="hljs-keyword">var</span> retryCount = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> result = api.fetchData()
            emit(Result.Success(result))
            <span class="hljs-keyword">break</span>
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            retryCount++
            <span class="hljs-keyword">if</span> (retryCount &gt; MAX_RETRIES) {
                emit(Result.Error(e))
                <span class="hljs-keyword">break</span>
            }
            delay(retryCount * <span class="hljs-number">1000L</span>)  <span class="hljs-comment">// 指数退避</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-16">示例 2：搜索防抖</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">search</span><span class="hljs-params">(queryFlow: <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>: Flow&lt;List&lt;Result&gt;&gt; = queryFlow
    .debounce(<span class="hljs-number">300</span>)                    <span class="hljs-comment">// 防抖 300ms</span>
    .distinctUntilChanged()           <span class="hljs-comment">// 去重</span>
    .filter { it.length &gt;= <span class="hljs-number">2</span> }        <span class="hljs-comment">// 最小长度</span>
    .flatMapLatest { query -&gt;         <span class="hljs-comment">// 取消前一个搜索</span>
        <span class="hljs-keyword">if</span> (query.isEmpty()) {
            flowOf(emptyList())
        } <span class="hljs-keyword">else</span> {
            flow {
                emit(emptyList&lt;Result&gt;())  <span class="hljs-comment">// 显示加载状态</span>
                <span class="hljs-keyword">val</span> results = api.search(query)
                emit(results)
            }.<span class="hljs-keyword">catch</span> { emit(emptyList()) }  <span class="hljs-comment">// 错误时返回空</span>
        }
    }
    .flowOn(Dispatchers.IO)
</code></pre>
<h4 data-id="heading-17">示例 3：组合多个数据源</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observeUserData</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: Flow&lt;UserData&gt; {
    <span class="hljs-keyword">val</span> localFlow = database.observeUser(userId)
    <span class="hljs-keyword">val</span> remoteFlow = api.getUserStream(userId)
    
    <span class="hljs-keyword">return</span> merge(localFlow, remoteFlow)
        .distinctUntilChanged()
        .onEach { user -&gt;
            database.saveUser(user)
        }
}
</code></pre>
<h3 data-id="heading-18">10. 性能优化技巧</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 避免不必要的中间操作</span>
flow
    .filter { it &gt; <span class="hljs-number">0</span> }     <span class="hljs-comment">// 尽早过滤减少后续操作</span>
    .map { it * <span class="hljs-number">2</span> }

<span class="hljs-comment">// 2. 合理使用 buffer</span>
flow
    .buffer()              <span class="hljs-comment">// 生产和消费并发执行</span>
    .collect { value -&gt;
        delay(<span class="hljs-number">100</span>)         <span class="hljs-comment">// 模拟耗时消费</span>
        println(value)
    }

<span class="hljs-comment">// 3. 使用 shareIn/stateIn 避免重复计算</span>
<span class="hljs-keyword">val</span> sharedData = expensiveFlow
    .shareIn(scope, SharingStarted.Lazily)

<span class="hljs-comment">// 4. 适时取消不必要的流</span>
scope.launch {
    withTimeout(<span class="hljs-number">5000</span>) {
        flow.collect { value -&gt;
            <span class="hljs-keyword">if</span> (value == TARGET) {
                <span class="hljs-keyword">return</span><span class="hljs-symbol">@withTimeout</span>  <span class="hljs-comment">// 找到目标后取消</span>
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-19">11. 常见陷阱和最佳实践</h3>
<h4 data-id="heading-20">陷阱：</h4>
<ul>
<li><strong>在 flow 构建器中使用 withContext</strong> ❌</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误</span>
flow { withContext(Dispatchers.IO) { emit(<span class="hljs-number">1</span>) } }

<span class="hljs-comment">// 正确</span>
flow { emit(<span class="hljs-number">1</span>) }.flowOn(Dispatchers.IO)
</code></pre>
<ul>
<li><strong>捕获异常位置不当</strong></li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// catch 只能捕获上游异常</span>
flow.<span class="hljs-keyword">catch</span> { <span class="hljs-comment">/* 捕获上游异常 */</span> }
    .collect { 
        <span class="hljs-keyword">try</span> { <span class="hljs-comment">/* 处理收集端逻辑 */</span> } 
        <span class="hljs-keyword">catch</span>(e: Exception) { <span class="hljs-comment">/* 捕获收集端异常 */</span> }
    }
</code></pre>
<ul>
<li><strong>忘记处理取消</strong></li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">flow {
    emit(<span class="hljs-number">1</span>)
    delay(<span class="hljs-number">1000</span>)
    emit(<span class="hljs-number">2</span>)  <span class="hljs-comment">// 如果 flow 被取消，这里不会执行</span>
}.cancellable()  <span class="hljs-comment">// 让 flow 可响应取消</span>
</code></pre>
<h4 data-id="heading-21">最佳实践：</h4>
<ul>
<li>使用 <code>flowOn</code> 进行线程切换</li>
<li>合理使用 <code>catch</code> 进行异常处理</li>
<li>使用 <code>shareIn</code>/<code>stateIn</code> 共享热流</li>
<li>为耗时操作添加缓冲</li>
<li>及时取消不再需要的流</li>
</ul>
<p>Flow 是 Kotlin 异步编程的强大工具，通过合理使用各种操作符和模式，可以构建出高效、可维护的异步数据流。</p>
<h2 data-id="heading-22">二、深入理解</h2>
<h3 data-id="heading-23">1. Flow 的整体架构</h3>
<h4 data-id="heading-24">1.1 Flow 接口体系</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Flow 核心接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Flow</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FlowCollector</span>&lt;<span class="hljs-type">in T</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">emit</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span>
}

<span class="hljs-comment">// Flow 构建器返回的 SafeFlow 实现</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeFlow</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> block: <span class="hljs-keyword">suspend</span> FlowCollector&lt;T&gt;.() -&gt; <span class="hljs-built_in">Unit</span>
) : Flow&lt;T&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
        <span class="hljs-keyword">val</span> safeCollector = SafeCollector(collector, coroutineContext)
        <span class="hljs-keyword">try</span> {
            block(safeCollector)
        } <span class="hljs-keyword">finally</span> {
            safeCollector.releaseIntercepted()
        }
    }
}
</code></pre>
<h4 data-id="heading-25">1.2 Flow 执行模型</h4>
<pre><code class="hljs language-text" lang="text">Flow 执行模型：
  生产者 (Producer) → 中间操作符 (Intermediate Operators) → 消费者 (Consumer)

实际调用链：
  collect() → 中间操作符1.collect() → 中间操作符2.collect() → ... → 源Flow.collect()
  
数据流向：
  源Flow.emit() → 中间操作符1.emit() → 中间操作符2.emit() → ... → 消费者处理
</code></pre>
<h3 data-id="heading-26">2. Flow 构建原理</h3>
<h4 data-id="heading-27">2.1 flow {} 构建器实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// flow {} 构建器的实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">flow</span><span class="hljs-params">(
    block: <span class="hljs-type">suspend</span> <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;.() -&gt; <span class="hljs-type">Unit</span>
)</span></span>: Flow&lt;T&gt; = SafeFlow(block)

<span class="hljs-comment">// 示例代码的字节码近似实现</span>
flow {
    emit(<span class="hljs-number">1</span>)
    emit(<span class="hljs-number">2</span>)
}

<span class="hljs-comment">// 实际被编译为（简化表示）：</span>
<span class="hljs-keyword">object</span> : Flow&lt;<span class="hljs-built_in">Int</span>&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span> {
        <span class="hljs-comment">// 构建器lambda被编译为一个内部类</span>
        collector.emit(<span class="hljs-number">1</span>)
        collector.emit(<span class="hljs-number">2</span>)
    }
}
</code></pre>
<h4 data-id="heading-28">2.2 SafeCollector 的关键作用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">internal</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeCollector</span>&lt;<span class="hljs-type">T</span>&gt; <span class="hljs-title">actual</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> collector: FlowCollector&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> collectContext: CoroutineContext
) : FlowCollector&lt;T&gt;, Continuation&lt;<span class="hljs-built_in">Unit</span>&gt; {
    
    <span class="hljs-comment">// 保存当前协程上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> lastEmissionContext: CoroutineContext? = <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// emit 方法的线程安全实现</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">emit</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span> {
        <span class="hljs-comment">// 1. 检查协程上下文是否发生变化（防止错误的线程切换）</span>
        checkContext(currentContext)
        
        <span class="hljs-comment">// 2. 保存发射上下文</span>
        lastEmissionContext = currentContext
        
        <span class="hljs-comment">// 3. 实际发射值</span>
        <span class="hljs-keyword">return</span> suspendCoroutineUninterceptedOrReturn { cont -&gt;
            <span class="hljs-comment">// 使用 Continuation 进行挂起恢复</span>
            with(collector) {
                emit(value)
            }
            <span class="hljs-comment">// 如果挂起，返回 COROUTINE_SUSPENDED</span>
            <span class="hljs-comment">// 否则返回 Unit</span>
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkContext</span><span class="hljs-params">(currentContext: <span class="hljs-type">CoroutineContext</span>)</span></span> {
        <span class="hljs-comment">// 确保 emit 调用在正确的上下文中</span>
        <span class="hljs-keyword">if</span> (lastEmissionContext != <span class="hljs-literal">null</span> &amp;&amp; lastEmissionContext != currentContext) {
            error(<span class="hljs-string">"Flow invariant is violated"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-29">3. 操作符实现原理</h3>
<h4 data-id="heading-30">3.1 中间操作符 - Map 实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// map 操作符的实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T, R&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">map</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> transform: <span class="hljs-type">suspend</span> (<span class="hljs-type">value</span>: <span class="hljs-type">T</span>) -&gt; <span class="hljs-type">R</span>
)</span></span>: Flow&lt;R&gt; = flow {  <span class="hljs-comment">// 创建一个新的 Flow</span>
    collect { value -&gt;  <span class="hljs-comment">// 收集上游 Flow 的值</span>
        <span class="hljs-comment">// 对每个值应用转换函数</span>
        <span class="hljs-keyword">val</span> transformed = transform(value)
        <span class="hljs-comment">// 向下游发射转换后的值</span>
        emit(transformed)
    }
}

<span class="hljs-comment">// 使用示例对应的调用链</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .map { it * <span class="hljs-number">2</span> }
    .collect { println(it) }

<span class="hljs-comment">// 调用链展开：</span>
<span class="hljs-comment">// 1. 调用 collect() 终端操作符</span>
<span class="hljs-comment">// 2. 触发 map 创建的 Flow 的 collect 方法</span>
<span class="hljs-comment">// 3. map Flow 的 collect 方法调用上游 flowOf 的 collect</span>
<span class="hljs-comment">// 4. flowOf 发射值 1 → map 接收并转换 → 向下游发射 2 → collect 打印 2</span>
<span class="hljs-comment">// 5. 重复步骤4</span>
</code></pre>
<h4 data-id="heading-31">3.2 终端操作符 - Collect 实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// collect 的实际工作流程</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">collect</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> action: <span class="hljs-type">suspend</span> (<span class="hljs-type">value</span>: <span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span>: <span class="hljs-built_in">Unit</span> = collect(<span class="hljs-keyword">object</span> : FlowCollector&lt;T&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">emit</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span> = action(value)
})

<span class="hljs-comment">// 更底层的实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
    <span class="hljs-comment">// 调用 Flow 接口的 collect 方法</span>
    <span class="hljs-keyword">return</span> collect(collector)
}
</code></pre>
<h3 data-id="heading-32">4. 异常处理原理</h3>
<h4 data-id="heading-33">4.1 catch 操作符实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">catch</span><span class="hljs-params">(
    action: <span class="hljs-type">suspend</span> <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;.(<span class="hljs-type">cause</span>: <span class="hljs-type">Throwable</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span>: Flow&lt;T&gt; = flow {
    <span class="hljs-comment">// 异常处理逻辑</span>
    <span class="hljs-keyword">val</span> exception = catchImpl(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">if</span> (exception != <span class="hljs-literal">null</span>) action(exception)
}

<span class="hljs-comment">// 实际的异常捕获实现</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">catchImpl</span><span class="hljs-params">(
    collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;
)</span></span>: Throwable? {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        collect(collector)
        <span class="hljs-literal">null</span>  <span class="hljs-comment">// 正常完成，返回 null</span>
    } <span class="hljs-keyword">catch</span> (e: Throwable) {
        <span class="hljs-comment">// 只捕获上游异常，不捕获下游异常</span>
        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">is</span> DownstreamExceptionElement) {
            <span class="hljs-keyword">throw</span> e  <span class="hljs-comment">// 下游异常重新抛出</span>
        }
        e  <span class="hljs-comment">// 返回上游异常</span>
    }
}
</code></pre>
<h3 data-id="heading-34">5. 上下文切换原理</h3>
<h4 data-id="heading-35">5.1 flowOn 实现机制</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">flowOn</span><span class="hljs-params">(context: <span class="hljs-type">CoroutineContext</span>)</span></span>: Flow&lt;T&gt; {
    <span class="hljs-comment">// 创建 ChannelFlow 来处理上下文切换</span>
    <span class="hljs-keyword">return</span> ChannelFlowOperatorImpl(<span class="hljs-keyword">this</span>, context = context)
}

<span class="hljs-comment">// ChannelFlowOperatorImpl 关键部分</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelFlowOperatorImpl</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> flow: Flow&lt;T&gt;,
    context: CoroutineContext
) : ChannelFlow&lt;T&gt;(context) {
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collectTo</span><span class="hljs-params">(scope: <span class="hljs-type">ProducerScope</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
        <span class="hljs-comment">// 在新的协程上下文中收集上游 Flow</span>
        coroutineScope {
            <span class="hljs-comment">// 使用新的上下文</span>
            withContext(context) {
                flow.collect { value -&gt;
                    <span class="hljs-comment">// 将值发送到 channel</span>
                    scope.send(value)
                }
            }
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
        <span class="hljs-comment">// 创建 channel 来处理背压</span>
        <span class="hljs-keyword">val</span> channel = produceIn(<span class="hljs-keyword">this</span>)
        <span class="hljs-comment">// 从 channel 中消费并发送给收集器</span>
        channel.consumeEach { value -&gt;
            collector.emit(value)
        }
    }
}
</code></pre>
<h4 data-id="heading-36">5.2 为什么不能在 flow {} 中直接切换上下文</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 错误的做法</span>
flow {
    withContext(Dispatchers.IO) {  <span class="hljs-comment">// ❌ 会破坏 Flow 不变性</span>
        emit(<span class="hljs-number">1</span>)
    }
}

<span class="hljs-comment">// 原理：SafeCollector 会检查发射上下文</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeCollector</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastEmissionContext: CoroutineContext? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">emit</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span> {
        <span class="hljs-keyword">val</span> currentContext = coroutineContext
        
        <span class="hljs-comment">// 检查：emit 调用的上下文必须一致</span>
        <span class="hljs-keyword">if</span> (lastEmissionContext != <span class="hljs-literal">null</span> &amp;&amp; lastEmissionContext != currentContext) {
            <span class="hljs-keyword">throw</span> IllegalStateException(<span class="hljs-string">"Flow invariant is violated"</span>)
        }
        
        lastEmissionContext = currentContext
        <span class="hljs-comment">// ... 发射逻辑</span>
    }
}
</code></pre>
<h3 data-id="heading-37">6. 背压处理原理</h3>
<h4 data-id="heading-38">6.1 buffer 操作符实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">buffer</span><span class="hljs-params">(
    capacity: <span class="hljs-type">Int</span> = Channel.BUFFERED,
    onBufferOverflow: <span class="hljs-type">BufferOverflow</span> = BufferOverflow.SUSPEND
)</span></span>: Flow&lt;T&gt; = <span class="hljs-keyword">when</span> (<span class="hljs-keyword">this</span>) {
    <span class="hljs-keyword">is</span> FusibleFlow -&gt; fuse(capacity = capacity, onBufferOverflow = onBufferOverflow)
    <span class="hljs-keyword">else</span> -&gt; ChannelFlowOperatorImpl(
        <span class="hljs-keyword">this</span>,
        capacity = capacity,
        onBufferOverflow = onBufferOverflow
    )
}

<span class="hljs-comment">// ChannelFlow 的背压处理</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelFlow</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">val</span> capacity: <span class="hljs-built_in">Int</span> = Channel.BUFFERED,
    <span class="hljs-keyword">val</span> onBufferOverflow: BufferOverflow = BufferOverflow.SUSPEND
) : Flow&lt;T&gt; {
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
        <span class="hljs-comment">// 创建具有缓冲能力的 channel</span>
        <span class="hljs-keyword">val</span> channel = Channel&lt;T&gt;(capacity, onBufferOverflow)
        
        <span class="hljs-comment">// 启动生产者协程</span>
        <span class="hljs-keyword">val</span> producer = launchProducer(channel)
        
        <span class="hljs-comment">// 消费者从 channel 接收</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (value <span class="hljs-keyword">in</span> channel) {
                collector.emit(value)
            }
        } <span class="hljs-keyword">finally</span> {
            producer.cancel()
        }
    }
}
</code></pre>
<h4 data-id="heading-39">6.2 conflate 操作符实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">conflate</span><span class="hljs-params">()</span></span>: Flow&lt;T&gt; = buffer(
    capacity = Channel.CONFLATED,
    onBufferOverflow = BufferOverflow.DROP_OLDEST
)

<span class="hljs-comment">// CONFLATED 的特殊处理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CONFLATED: <span class="hljs-built_in">Int</span> = -<span class="hljs-number">1</span>

<span class="hljs-comment">// Channel 实现中的 CONFLATED 处理</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConflatedChannel</span>&lt;<span class="hljs-type">E</span>&gt; : <span class="hljs-type">AbstractChannel</span>&lt;<span class="hljs-type">E</span>&gt;() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> value: Any? = NULL
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">send</span><span class="hljs-params">(element: <span class="hljs-type">E</span>)</span></span> {
        <span class="hljs-comment">// 如果有未消费的值，直接替换</span>
        <span class="hljs-keyword">if</span> (value !== NULL) {
            value = element
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 否则正常发送</span>
            <span class="hljs-keyword">super</span>.send(element)
        }
    }
}
</code></pre>
<h3 data-id="heading-40">7. SharedFlow 原理</h3>
<h4 data-id="heading-41">7.1 MutableSharedFlow 核心实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">MutableSharedFlow</span><span class="hljs-params">(
    replay: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span>,
    extraBufferCapacity: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span>,
    onBufferOverflow: <span class="hljs-type">BufferOverflow</span> = BufferOverflow.SUSPEND
)</span></span>: MutableSharedFlow&lt;T&gt; {
    <span class="hljs-keyword">return</span> SharedFlowImpl(replay, extraBufferCapacity, onBufferOverflow)
}

<span class="hljs-comment">// SharedFlowImpl 的关键数据结构</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedFlowImpl</span>&lt;<span class="hljs-type">T</span>&gt;(
    replay: <span class="hljs-built_in">Int</span>,
    bufferCapacity: <span class="hljs-built_in">Int</span>,
    onBufferOverflow: BufferOverflow
) : AbstractSharedFlow&lt;SharedFlowSlot&lt;T&gt;&gt;(), MutableSharedFlow&lt;T&gt; {
    
    <span class="hljs-comment">// 缓冲区数组（环形缓冲区）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> buffer: Array&lt;Any?&gt;? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> replayIndex = <span class="hljs-number">0L</span>   <span class="hljs-comment">// 重放起始索引</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> minCollectorIndex = <span class="hljs-number">0L</span>  <span class="hljs-comment">// 最小收集者索引</span>
    
    <span class="hljs-comment">// 发射值</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">emit</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span> {
        <span class="hljs-comment">// 尝试快速发射（无等待）</span>
        <span class="hljs-keyword">if</span> (tryEmit(value)) <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment">// 需要挂起等待</span>
        emitSuspend(value)
    }
    
    <span class="hljs-comment">// 收集值</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
        <span class="hljs-comment">// 为收集者分配一个槽</span>
        <span class="hljs-keyword">val</span> slot = allocateSlot()
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 收集循环</span>
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                <span class="hljs-comment">// 尝试从缓冲区获取值</span>
                <span class="hljs-keyword">val</span> value = slot.takeValue() ?: suspendAndWait()
                collector.emit(value <span class="hljs-keyword">as</span> T)
            }
        } <span class="hljs-keyword">finally</span> {
            freeSlot(slot)
        }
    }
}
</code></pre>
<h4 data-id="heading-42">7.2 SharedFlow 的订阅管理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SharedFlow 的订阅者管理</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractSharedFlow</span>&lt;<span class="hljs-type">S : AbstractSharedFlowSlot&lt;*</span>&gt;&gt; {
    
    <span class="hljs-comment">// 所有活跃的订阅者槽</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> slots: Array&lt;S?&gt;? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> nCollectors = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 分配槽给新的收集者</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">allocateSlot</span><span class="hljs-params">()</span></span>: S {
        <span class="hljs-keyword">val</span> slot = createSlot()
        synchronized(<span class="hljs-keyword">this</span>) {
            slots = slots.orEmpty().plus(slot)
            nCollectors++
            onNewCollector(slot)
        }
        <span class="hljs-keyword">return</span> slot
    }
    
    <span class="hljs-comment">// 释放槽</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">freeSlot</span><span class="hljs-params">(slot: <span class="hljs-type">S</span>)</span></span> {
        synchronized(<span class="hljs-keyword">this</span>) {
            slots = slots.orEmpty().filter { it !== slot }.toTypedArray()
            nCollectors--
        }
    }
}
</code></pre>
<h3 data-id="heading-43">8. StateFlow 原理</h3>
<h4 data-id="heading-44">8.1 StateFlow 的特殊性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StateFlow</span>&lt;<span class="hljs-type">out T</span>&gt; : <span class="hljs-type">SharedFlow</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> value: T
}

<span class="hljs-comment">// StateFlowImpl 实现</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StateFlowImpl</span>&lt;<span class="hljs-type">T</span>&gt;(
    initialState: T
) : AbstractSharedFlow&lt;StateFlowSlot&gt;(), StateFlow&lt;T&gt;, MutableStateFlow&lt;T&gt; {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _state: Any = initialState
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> sequence = <span class="hljs-number">0L</span>  <span class="hljs-comment">// 序列号，用于检测重复值</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> value: T
        <span class="hljs-keyword">get</span>() = _state <span class="hljs-keyword">as</span> T
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">emit</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span> {
        <span class="hljs-comment">// 如果值与当前状态相同，则忽略</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.value == value &amp;&amp; sequence != <span class="hljs-number">0L</span>) <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment">// 更新状态</span>
        _state = value
        sequence++
        
        <span class="hljs-comment">// 通知所有订阅者</span>
        forEachSlot { slot -&gt;
            slot.makePending()
        }
    }
}
</code></pre>
<h3 data-id="heading-45">9. Flow 的协程集成</h3>
<h4 data-id="heading-46">9.1 Flow 与协程 Continuation</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Flow 收集的协程 Continuation 转换</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span>: <span class="hljs-built_in">Unit</span> {
    <span class="hljs-comment">// 创建协程 Continuation</span>
    <span class="hljs-keyword">return</span> suspendCoroutineUninterceptedOrReturn { cont -&gt;
        <span class="hljs-comment">// 将 Flow 收集转换为协程挂起点</span>
        <span class="hljs-keyword">val</span> completion = <span class="hljs-keyword">object</span> : Continuation&lt;<span class="hljs-built_in">Unit</span>&gt; {
            <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> context: CoroutineContext = cont.context
            
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">resumeWith</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">Unit</span>&gt;)</span></span> {
                <span class="hljs-comment">// 将结果传递给原始 Continuation</span>
                cont.resumeWith(result)
            }
        }
        
        <span class="hljs-comment">// 启动 Flow 收集</span>
        startCollect(collector, completion)
    }
}
</code></pre>
<h4 data-id="heading-47">9.2 Flow 的取消机制</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Flow 的取消检查</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">collect</span><span class="hljs-params">(collector: <span class="hljs-type">FlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
    <span class="hljs-comment">// 包装收集器以支持取消</span>
    <span class="hljs-keyword">val</span> cancellableCollector = CancellableFlowCollector(collector)
    
    <span class="hljs-keyword">try</span> {
        collectSafely(cancellableCollector)
    } <span class="hljs-keyword">finally</span> {
        cancellableCollector.releaseCancellability()
    }
}

<span class="hljs-comment">// 可取消的收集器</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CancellableFlowCollector</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> collector: FlowCollector&lt;T&gt;
) : FlowCollector&lt;T&gt; {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cancellationCause: Throwable? = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">emit</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span> {
        <span class="hljs-comment">// 检查是否已取消</span>
        <span class="hljs-keyword">if</span> (cancellationCause != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> CancellationException()
        }
        
        <span class="hljs-comment">// 检查协程是否活跃</span>
        ensureActive()
        
        <span class="hljs-comment">// 实际发射</span>
        collector.emit(value)
    }
}
</code></pre>
<h3 data-id="heading-48">10. 性能优化细节</h3>
<h4 data-id="heading-49">10.1 Flow 的融合（Fusion）优化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Flow 操作符的融合优化</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FusibleFlow</span>&lt;<span class="hljs-type">T</span>&gt; : <span class="hljs-type">Flow</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fuse</span><span class="hljs-params">(
        context: <span class="hljs-type">CoroutineContext</span> = EmptyCoroutineContext,
        capacity: <span class="hljs-type">Int</span> = Channel.OPTIONAL_CHANNEL,
        onBufferOverflow: <span class="hljs-type">BufferOverflow</span> = BufferOverflow.SUSPEND
    )</span></span>: Flow&lt;T&gt;
}

<span class="hljs-comment">// 示例：连续 map 操作的融合</span>
flowOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
    .map { it * <span class="hljs-number">2</span> }    <span class="hljs-comment">// 这两个 map 可能被融合为</span>
    .map { it + <span class="hljs-number">1</span> }    <span class="hljs-comment">// 一个 map { (it * 2) + 1 }</span>
    .collect { ... }

<span class="hljs-comment">// 融合后的伪代码</span>
flow {
    collect { value -&gt;
        <span class="hljs-comment">// 融合后的转换</span>
        <span class="hljs-keyword">val</span> transformed = (value * <span class="hljs-number">2</span>) + <span class="hljs-number">1</span>
        emit(transformed)
    }
}
</code></pre>
<h4 data-id="heading-50">10.2 内联优化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 许多 Flow 操作符使用 inline 优化</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> Flow<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">filter</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> predicate: <span class="hljs-type">suspend</span> (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Boolean</span>
)</span></span>: Flow&lt;T&gt; = flow {  <span class="hljs-comment">// inline 函数，减少 lambda 对象创建</span>
    collect { value -&gt;
        <span class="hljs-keyword">if</span> (predicate(value)) emit(value)
    }
}

<span class="hljs-comment">// 未内联的情况（性能较差）：</span>
<span class="hljs-comment">// 1. 创建 lambda 对象</span>
<span class="hljs-comment">// 2. 创建新的 Flow 对象</span>
<span class="hljs-comment">// 3. 额外的函数调用开销</span>

<span class="hljs-comment">// 内联优化后：</span>
<span class="hljs-comment">// 1. 代码直接嵌入调用处</span>
<span class="hljs-comment">// 2. 减少对象创建</span>
<span class="hljs-comment">// 3. 更好的 JIT 优化机会</span>
</code></pre>
<h4 data-id="heading-51">11. 总结</h4>
<p>Kotlin Flow 的核心原理：</p>
<ol>
<li><strong>基于协程</strong>：利用挂起函数实现异步流处理</li>
<li><strong>冷流模型</strong>：每次收集都创建新的执行</li>
<li><strong>装饰器模式</strong>：操作符通过包装实现链式调用</li>
<li><strong>结构化并发</strong>：自动管理资源生命周期</li>
<li><strong>线程安全</strong>：通过 SafeCollector 确保上下文一致性</li>
<li><strong>背压处理</strong>：基于 Channel 的缓冲机制</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cordova Plugin File 的 File 对象设计缺陷]]></title>    <link>https://juejin.cn/post/7600588379104854068</link>    <guid>https://juejin.cn/post/7600588379104854068</guid>    <pubDate>2026-01-29T08:42:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600588379104854068" data-draft-id="7600345782174122018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cordova Plugin File 的 File 对象设计缺陷"/> <meta itemprop="keywords" content="Android,APP,客户端"/> <meta itemprop="datePublished" content="2026-01-29T08:42:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Gemini001"/> <meta itemprop="url" content="https://juejin.cn/user/2333635831676704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cordova Plugin File 的 File 对象设计缺陷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2333635831676704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Gemini001
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T08:42:05.000Z" title="Thu Jan 29 2026 08:42:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Cordova Plugin File 的 File 对象设计缺陷：一场 Web 标准的灾难</h2>
<h3 data-id="heading-1">🚨 问题概述</h3>
<p>Cordova 的 <code>cordova-plugin-file</code>插件覆盖了全局的 <code>File</code>构造函数，创造了一个<strong>四不像的文件对象</strong>：既不是真正的 Web File，也不是完整的文件系统接口，导致大量 H5 代码异常。
插件地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fcordova-plugin-file%2Fblob%2Fmaster%2Fwww%2FFile.js" target="_blank" title="https://github.com/apache/cordova-plugin-file/blob/master/www/File.js" ref="nofollow noopener noreferrer">github.com/apache/cord…</a></p>
<h3 data-id="heading-2">📊 核心特性对比：Cordova File vs 标准 Web File</h3>



























































<table><thead><tr><th>特性</th><th>Cordova File</th><th>标准 Web File</th><th>实际影响</th></tr></thead><tbody><tr><td><strong>EXIF 数据</strong>​</td><td>❌ 不包含</td><td>✅ 可能包含</td><td>无法读取照片拍摄信息</td></tr><tr><td><strong>IPTC 数据</strong>​</td><td>❌ 不包含</td><td>✅ 可能包含</td><td>无法读取图片元数据</td></tr><tr><td><strong>本地路径</strong>​</td><td>✅ localURL</td><td>❌ 无</td><td>Cordova 独有优势</td></tr><tr><td><strong>切片支持</strong>​</td><td>✅ start/end</td><td>✅ slice()</td><td>两者都支持，但 API 不同</td></tr><tr><td><strong>二进制读取</strong>​</td><td>✅ 通过 FileReader</td><td>✅ 通过 FileReader</td><td>基础功能一致</td></tr><tr><td><strong>构造函数</strong>​</td><td><code>File(name, localURL, type, lastModifiedDate, size)</code></td><td><code>File(fileBits, fileName, options)</code></td><td>完全不兼容</td></tr><tr><td><strong>instanceof File</strong>​</td><td>❌ false</td><td>✅ true</td><td>类型检测失效</td></tr><tr><td><strong>继承关系</strong>​</td><td>不继承 Blob</td><td>继承自 Blob</td><td>失去 Blob 能力</td></tr></tbody></table>
<h3 data-id="heading-3">💡 关键洞察</h3>
<h4 data-id="heading-4">Cordova File 的"伪优势"</h4>
<ul>
<li><strong>本地路径 (localURL)</strong> ：这是 Cordova File 独有的优势，可以直接访问设备文件系统</li>
<li><strong>内置切片 (start/end)</strong> ：提供了文件范围定位，适合大文件处理</li>
</ul>
<h4 data-id="heading-5">标准 Web File 的真正价值</h4>
<ul>
<li><strong>EXIF/IPTC 数据</strong>：对图片处理应用至关重要</li>
<li><strong>标准兼容性</strong>：与整个 Web 生态无缝集成</li>
<li><strong>Blob 继承</strong>：获得所有 Blob 方法（<code>slice()</code>, <code>stream()</code>, <code>text()</code>, <code>arrayBuffer()</code>）</li>
</ul>
<h3 data-id="heading-6">💥 实际开发中的痛点</h3>
<h4 data-id="heading-7">1. 图片应用崩溃</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 😱 想读取照片的 EXIF 信息？</span>
<span class="hljs-keyword">const</span> cordovaFile = <span class="hljs-title function_">getSelectedFile</span>(); <span class="hljs-comment">// Cordova File 对象</span>

<span class="hljs-comment">// 期望这样读取 EXIF</span>
<span class="hljs-variable constant_">EXIF</span>.<span class="hljs-title function_">getData</span>(cordovaFile, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> cameraModel = <span class="hljs-variable constant_">EXIF</span>.<span class="hljs-title function_">getTag</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'Model'</span>); <span class="hljs-comment">// undefined!</span>
});

<span class="hljs-comment">// 期望这样读取 IPTC  </span>
<span class="hljs-title function_">readIPTCData</span>(cordovaFile); <span class="hljs-comment">// 失败！没有原始图像数据</span>
</code></pre>
<h4 data-id="heading-8">2. 第三方库集体失效</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 📦 图片处理库全部懵逼</span>
<span class="hljs-keyword">import</span> imageOptimizer <span class="hljs-keyword">from</span> <span class="hljs-string">'image-optimizer'</span>;    <span class="hljs-comment">// ❌ 无法读取 EXIF</span>
<span class="hljs-keyword">import</span> watermarkAdder <span class="hljs-keyword">from</span> <span class="hljs-string">'watermark-js'</span>;       <span class="hljs-comment">// ❌ 无法正确处理</span>
<span class="hljs-keyword">import</span> exifReader <span class="hljs-keyword">from</span> <span class="hljs-string">'exif-reader'</span>;            <span class="hljs-comment">// ❌ 找不到 EXIF 数据</span>

<span class="hljs-comment">// 因为这些库都期望标准 File 对象</span>
</code></pre>
<h4 data-id="heading-9">3. 类型检测混乱</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processFile</span>(<span class="hljs-params">file</span>) {
    <span class="hljs-keyword">if</span> (file <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">File</span>) {
        <span class="hljs-comment">// 标准环境：进入这里 ✅</span>
        <span class="hljs-comment">// Cordova 环境：进不来 ❌</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'处理标准文件'</span>);
    }
    
    <span class="hljs-keyword">if</span> (file.<span class="hljs-property">localURL</span>) {
        <span class="hljs-comment">// 只有 Cordova File 有这个属性</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是 Cordova 文件，但我不认识它！'</span>);
    }
}
</code></pre>
<h3 data-id="heading-10">🔧 实用解决方案</h3>
<h4 data-id="heading-11">方案1：保留 Cordova 优势，修复标准兼容</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartFileBridge</span> {
    <span class="hljs-comment">// 检测文件类型</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">detectType</span>(<span class="hljs-params">file</span>) {
        <span class="hljs-keyword">if</span> (file.<span class="hljs-property">localURL</span> &amp;&amp; !file.<span class="hljs-property">slice</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'cordova'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (file <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">File</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'standard'</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">'unknown'</span>;
    }
    
    <span class="hljs-comment">// 转换为标准 File（保留 EXIF/IPTC 读取能力）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">toStandardFile</span>(<span class="hljs-params">cordovaFile</span>) {
        <span class="hljs-comment">// 关键：通过 FileReader 读取完整二进制数据</span>
        <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readAsArrayBuffer</span>(cordovaFile);
        
        <span class="hljs-comment">// 创建标准 File，这样就能读取 EXIF/IPTC 了</span>
        <span class="hljs-keyword">const</span> standardFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>([arrayBuffer], cordovaFile.<span class="hljs-property">name</span>, {
            <span class="hljs-attr">type</span>: cordovaFile.<span class="hljs-property">type</span>,
            <span class="hljs-attr">lastModified</span>: cordovaFile.<span class="hljs-property">lastModifiedDate</span>?.<span class="hljs-title function_">getTime</span>()
        });
        
        <span class="hljs-comment">// 保留 Cordova 的本地路径信息</span>
        standardFile.<span class="hljs-property">localURL</span> = cordovaFile.<span class="hljs-property">localURL</span>;
        standardFile.<span class="hljs-property">start</span> = cordovaFile.<span class="hljs-property">start</span>;
        standardFile.<span class="hljs-property">end</span> = cordovaFile.<span class="hljs-property">end</span>;
        
        <span class="hljs-keyword">return</span> standardFile;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">readAsArrayBuffer</span>(<span class="hljs-params">file</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();
            reader.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(reader.<span class="hljs-property">result</span>);
            reader.<span class="hljs-property">onerror</span> = reject;
            reader.<span class="hljs-title function_">readAsArrayBuffer</span>(file);
        });
    }
}
</code></pre>
<h4 data-id="heading-12">方案2：智能文件处理器</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">IntelligentFileProcessor</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">file</span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">type</span> = <span class="hljs-title class_">SmartFileBridge</span>.<span class="hljs-title function_">detectType</span>(file);
        
        <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">type</span>) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'cordova'</span>:
                <span class="hljs-comment">// Cordova 文件：转换为标准 File 以启用 EXIF/IPTC 读取</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title class_">SmartFileBridge</span>.<span class="hljs-title function_">toStandardFile</span>(file);
                
            <span class="hljs-keyword">case</span> <span class="hljs-string">'standard'</span>:
                <span class="hljs-comment">// 标准文件：直接使用</span>
                <span class="hljs-keyword">return</span> file;
                
            <span class="hljs-attr">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'未知文件类型'</span>);
        }
    }
    
    <span class="hljs-comment">// 专门处理图片文件的 EXIF</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">processImageWithExif</span>(<span class="hljs-params">file</span>) {
        <span class="hljs-keyword">const</span> processedFile = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">process</span>(file);
        
        <span class="hljs-comment">// 现在可以安全读取 EXIF 了</span>
        <span class="hljs-keyword">if</span> (processedFile.<span class="hljs-property">type</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'image/'</span>)) {
            <span class="hljs-keyword">const</span> exifData = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readExif</span>(processedFile);
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">file</span>: processedFile,
                <span class="hljs-attr">exif</span>: exifData,
                <span class="hljs-attr">localURL</span>: processedFile.<span class="hljs-property">localURL</span> <span class="hljs-comment">// 保留 Cordova 路径</span>
            };
        }
        
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">file</span>: processedFile };
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">readExif</span>(<span class="hljs-params">file</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
            <span class="hljs-variable constant_">EXIF</span>.<span class="hljs-title function_">getData</span>(file, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
                <span class="hljs-title function_">resolve</span>(<span class="hljs-variable constant_">EXIF</span>.<span class="hljs-title function_">getAllTags</span>(<span class="hljs-variable language_">this</span>));
            });
        });
    }
}
</code></pre>
<h4 data-id="heading-13">方案3：实战应用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">PhotoUploader</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePhotoSelect</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">cordovaFile</span>) =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 🚀 智能处理：自动转换并保留 Cordova 优势</span>
            <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">IntelligentFileProcessor</span>.<span class="hljs-title function_">processImageWithExif</span>(cordovaFile);
            
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文件信息:'</span>, {
                <span class="hljs-attr">name</span>: result.<span class="hljs-property">file</span>.<span class="hljs-property">name</span>,
                <span class="hljs-attr">type</span>: result.<span class="hljs-property">file</span>.<span class="hljs-property">type</span>,
                <span class="hljs-attr">size</span>: result.<span class="hljs-property">file</span>.<span class="hljs-property">size</span>,
                <span class="hljs-attr">localURL</span>: result.<span class="hljs-property">localURL</span>, <span class="hljs-comment">// Cordova 本地路径</span>
                <span class="hljs-attr">exif</span>: result.<span class="hljs-property">exif</span>          <span class="hljs-comment">// 现在可以读取 EXIF 了！</span>
            });
            
            <span class="hljs-comment">// 使用标准 File 进行后续处理（支持所有 Web API）</span>
            <span class="hljs-keyword">const</span> optimizedImage = <span class="hljs-keyword">await</span> <span class="hljs-title function_">optimizeImage</span>(result.<span class="hljs-property">file</span>);
            
            <span class="hljs-comment">// 需要时使用 Cordova 本地路径</span>
            <span class="hljs-keyword">if</span> (result.<span class="hljs-property">localURL</span>) {
                <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadViaCordovaPath</span>(result.<span class="hljs-property">localURL</span>);
            }
            
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'文件处理失败:'</span>, error);
        }
    };
    
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
            <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> 
            <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>
            <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> handlePhotoSelect(e.target.files[0])}
        /&gt;</span>
    );
}
</code></pre>
<h3 data-id="heading-14">🎯 最佳实践指南</h3>
<h4 data-id="heading-15">1. 根据使用场景选择策略</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 场景 A：只需要文件内容和 Cordova 路径</span>
<span class="hljs-function">function <span class="hljs-title">simpleFileHandler</span><span class="hljs-params">(cordovaFile)</span> </span>{
    <span class="hljs-keyword">return</span> {
        name: cordovaFile.name,
        localURL: cordovaFile.localURL, <span class="hljs-comment">// 直接使用 Cordova 路径</span>
        size: cordovaFile.size
        <span class="hljs-comment">// 不需要转换为标准 File</span>
    };
}

<span class="hljs-comment">// 场景 B：需要 EXIF/IPTC 或 Web API 兼容性</span>
<span class="hljs-function">async function <span class="hljs-title">advancedFileHandler</span><span class="hljs-params">(cordovaFile)</span> </span>{
    <span class="hljs-type">const</span> standardFile = await SmartFileBridge.<span class="hljs-built_in">toStandardFile</span>(cordovaFile);
    
    <span class="hljs-keyword">return</span> {
        file: standardFile,           <span class="hljs-comment">// 标准 File（支持 EXIF、Web API）</span>
        localURL: cordovaFile.localURL, <span class="hljs-comment">// 保留 Cordova 路径</span>
        start: cordovaFile.start,     <span class="hljs-comment">// 保留 Cordova 切片</span>
        end: cordovaFile.end
    };
}
</code></pre>
<h4 data-id="heading-16">2. 性能优化建议</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 🚀 按需转换：不要盲目转换所有文件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceAwareProcessor</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">processBatch</span>(<span class="hljs-params">files, options = {}</span>) {
        <span class="hljs-keyword">const</span> { needExif = <span class="hljs-literal">false</span>, needWebAPI = <span class="hljs-literal">false</span> } = options;
        
        <span class="hljs-keyword">const</span> results = [];
        
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) {
            <span class="hljs-comment">// 快速路径：不需要标准 File 功能</span>
            <span class="hljs-keyword">if</span> (!needExif &amp;&amp; !needWebAPI) {
                results.<span class="hljs-title function_">push</span>({
                    <span class="hljs-attr">file</span>: file, <span class="hljs-comment">// 保持原样</span>
                    <span class="hljs-attr">localURL</span>: file.<span class="hljs-property">localURL</span>
                });
                <span class="hljs-keyword">continue</span>;
            }
            
            <span class="hljs-comment">// 慢速路径：需要完整功能</span>
            <span class="hljs-keyword">const</span> converted = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SmartFileBridge</span>.<span class="hljs-title function_">toStandardFile</span>(file);
            results.<span class="hljs-title function_">push</span>({
                <span class="hljs-attr">file</span>: converted,
                <span class="hljs-attr">localURL</span>: file.<span class="hljs-property">localURL</span>
            });
        }
        
        <span class="hljs-keyword">return</span> results;
    }
}
</code></pre>
<h3 data-id="heading-17">🤔 设计哲学反思</h3>
<h4 data-id="heading-18">Cordova 的设计取舍</h4>
<ul>
<li><strong>得</strong>：获得了本地文件系统访问能力（localURL）</li>
<li><strong>失</strong>：失去了整个 Web 生态兼容性</li>
<li><strong>问题</strong>：没有提供平滑的迁移路径</li>
</ul>
<h4 data-id="heading-19">理想的解决方案应该是</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 💭 理想中的设计</span>
<span class="hljs-keyword">const</span> cordovaFile = <span class="hljs-keyword">await</span> cordovaFS.getFile(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> standardFile = <span class="hljs-keyword">await</span> cordovaFile.toStandardFile(); <span class="hljs-comment">// 显式转换</span>
<span class="hljs-keyword">const</span> withExif = <span class="hljs-keyword">await</span> standardFile.readExif(); <span class="hljs-comment">// 获得 EXIF 能力</span>
</code></pre>
<h3 data-id="heading-20">🏁 总结</h3>
<p>Cordova File 对象的核心矛盾在于：</p>
<ul>
<li><strong>想要 Cordova 的优势</strong>（localURL）→ 必须用 Cordova File</li>
<li><strong>想要 Web 生态</strong>（EXIF、标准 API）→ 必须转换为标准 File</li>
</ul>
<p><strong>实用建议</strong>：</p>
<ol>
<li><strong>明确需求</strong>：确定是否需要 EXIF/IPTC 或 Web API 兼容性</li>
<li><strong>按需转换</strong>：不要盲目转换，根据使用场景决定</li>
<li><strong>保留优势</strong>：转换时保留 Cordova 特有的 localURL 等属性</li>
<li><strong>渐进迁移</strong>：新项目优先考虑 Capacitor 等现代方案</li>
</ol>
<p>这场"灾难"的教训是：<strong>技术选型要在特殊需求和生态兼容性之间找到平衡</strong>。Cordova 给了我们本地文件系统的钥匙，但也关上了 Web 标准的大门。作为开发者，我们要学会同时拿着两把钥匙。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 属性包装器]]></title>    <link>https://juejin.cn/post/7600414546189467658</link>    <guid>https://juejin.cn/post/7600414546189467658</guid>    <pubDate>2026-01-29T08:49:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600414546189467658" data-draft-id="7600581247019106313" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 属性包装器"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2026-01-29T08:49:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户46810455724"/> <meta itemprop="url" content="https://juejin.cn/user/2367689856916010"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 属性包装器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2367689856916010/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户46810455724
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T08:49:40.000Z" title="Thu Jan 29 2026 08:49:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们来看 The Swift Programming Language (6.2.3) 中的例子。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@propertyWrapper</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">TwelveOrLess</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> number <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">var</span> wrappedValue: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> number }
        <span class="hljs-keyword">set</span> { number <span class="hljs-operator">=</span> <span class="hljs-built_in">min</span>(newValue, <span class="hljs-number">12</span>) }
    }
}
</code></pre>
<p>结构 TwelveOrLess 是属性包装器，属性包装器可以是 class、struct 和 enum。属性包装器需要有个属性 wrappedValue，表示被包装的值。TwelveOrLess 的 wrappedValue 属性是计算属性，读写私有的存储属性 number，其 setter 确保 number 小于或等于 12。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SmallRectangle</span> {
    <span class="hljs-meta">@TwelveOrLess</span> <span class="hljs-keyword">var</span> height: <span class="hljs-type">Int</span>
    <span class="hljs-meta">@TwelveOrLess</span> <span class="hljs-keyword">var</span> width: <span class="hljs-type">Int</span>
}
</code></pre>
<p>结构 SmallRectangle 应用包装器 TwelveOrLess 到属性 height 和 width，编译器重写代码为：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SmallRectangle</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _height <span class="hljs-operator">=</span> <span class="hljs-type">TwelveOrLess</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _width <span class="hljs-operator">=</span> <span class="hljs-type">TwelveOrLess</span>()
    <span class="hljs-keyword">var</span> height: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _height.wrappedValue }
        <span class="hljs-keyword">set</span> { _height.wrappedValue <span class="hljs-operator">=</span> newValue }
    }
    <span class="hljs-keyword">var</span> width: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _width.wrappedValue }
        <span class="hljs-keyword">set</span> { _width.wrappedValue <span class="hljs-operator">=</span> newValue }
    }
}
</code></pre>
<p>生成 _height 和 _width 存储属性，存储包装器 TwelveOrLess 的实例。height 和 width 成为计算属性，访问 _height 和 _width 的 wrappedValue。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f1b3195708c4f1181cd25b3806915fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY4MTA0NTU3MjQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770281383&amp;x-signature=vrGpv62QP6nrmqkWEIYwbibwQaM%3D" alt="v2-a712b4a4c7d80561227b6bc40f5c8608_1440w.png" loading="lazy"/></p>
<p>编译器还会为 SmallRectangle 生成 memberwise 初始化器，此时生成的初始化器为</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">init</span>(
    <span class="hljs-params">height</span>: <span class="hljs-type">TwelveOrLess</span> <span class="hljs-operator">=</span> <span class="hljs-type">TwelveOrLess</span>(),
    <span class="hljs-params">width</span>: <span class="hljs-type">TwelveOrLess</span> <span class="hljs-operator">=</span> <span class="hljs-type">TwelveOrLess</span>()
)
</code></pre>
<p>参数 height 和 width 的类型为包装器类型 TwelveOrLess，TwelveOrLess 的初始化器为默认初始化器 init()。
如果 TwelveOrLess 增加初始化器 init(wrappedValue: Int)，</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@propertyWrapper</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">TwelveOrLess</span> {   
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> number <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">wrappedValue</span>: <span class="hljs-type">Int</span>) {
        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> <span class="hljs-built_in">min</span>(wrappedValue, <span class="hljs-number">12</span>)
    }

    <span class="hljs-keyword">var</span> wrappedValue: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> number }
        <span class="hljs-keyword">set</span> { number <span class="hljs-operator">=</span> <span class="hljs-built_in">min</span>(newValue, <span class="hljs-number">12</span>) }
    }
}
</code></pre>
<p>则 SmallRectangle 的初始化器为</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">init</span>(
    <span class="hljs-params">height</span>: <span class="hljs-type">Int</span>,
    <span class="hljs-params">width</span>: <span class="hljs-type">Int</span>
)
</code></pre>
<p>参数 height 和 width 的类型为原始类型 Int。</p>
<p>如果 TwelveOrLess 增加初始化器 init()，</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@propertyWrapper</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">TwelveOrLess</span> {   
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> number <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">init</span>() {
        number  <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    }
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">wrappedValue</span>: <span class="hljs-type">Int</span>) {
        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> <span class="hljs-built_in">min</span>(wrappedValue, <span class="hljs-number">12</span>)
    }

    <span class="hljs-keyword">var</span> wrappedValue: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> number }
        <span class="hljs-keyword">set</span> { number <span class="hljs-operator">=</span> <span class="hljs-built_in">min</span>(newValue, <span class="hljs-number">12</span>) }
    }
}
</code></pre>
<p>则 SmallRectangle 的初始化器为</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">init</span>(
    <span class="hljs-params">height</span>: <span class="hljs-type">TwelveOrLess</span> <span class="hljs-operator">=</span> <span class="hljs-type">TwelveOrLess</span>(),
    <span class="hljs-params">width</span>: <span class="hljs-type">TwelveOrLess</span> <span class="hljs-operator">=</span> <span class="hljs-type">TwelveOrLess</span>()
)
</code></pre>
<p>此时想让 SmallRectangle 的 memberwise 初始化器参数类型为原始类型 Int，需要修改为</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SmallRectangle</span> {
    <span class="hljs-meta">@TwelveOrLess</span> <span class="hljs-keyword">var</span> height: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
    <span class="hljs-meta">@TwelveOrLess</span> <span class="hljs-keyword">var</span> width: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
}
</code></pre>
<p>编译器生成的代码为</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SmallRectangle</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _height <span class="hljs-operator">=</span> <span class="hljs-type">TwelveOrLess</span>(wrappedValue: <span class="hljs-number">1</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _width <span class="hljs-operator">=</span> <span class="hljs-type">TwelveOrLess</span>(wrappedValue: <span class="hljs-number">1</span>)
    <span class="hljs-keyword">var</span> height: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _height.wrappedValue }
        <span class="hljs-keyword">set</span> { _height.wrappedValue <span class="hljs-operator">=</span> newValue }
    }
    <span class="hljs-keyword">var</span> width: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> _width.wrappedValue }
        <span class="hljs-keyword">set</span> { _width.wrappedValue <span class="hljs-operator">=</span> newValue }
    }
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">height</span>: <span class="hljs-type">Int</span>, <span class="hljs-params">width</span>: <span class="hljs-type">Int</span>) {
        <span class="hljs-keyword">self</span>.height <span class="hljs-operator">=</span> height
        <span class="hljs-keyword">self</span>.width <span class="hljs-operator">=</span> width
    }
}
</code></pre>
<p>总结：对一个 struct 的某个属性应用包装器，要使 memberwise 初始化器对应参数类型为原始类型，需要如下条件之一，</p>
<ul>
<li>属性包装器有初始化器 init(wrappedValue:)，并且没有 init()</li>
<li>属性有初始值，像 @TwelveOrLess var height: Int = 1</li>
</ul>
<p>否则，memberwise 初始化器参数类型为包装器类型。</p>
<p>除了被包装的值，属性包装器可以通过定义一个 projected value 暴露额外的功能。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@propertyWrapper</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SmallNumber</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> number: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> projectedValue: <span class="hljs-type">Bool</span>
    
    <span class="hljs-keyword">var</span> wrappedValue: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">return</span> number }
        <span class="hljs-keyword">set</span> {
            <span class="hljs-keyword">if</span> newValue <span class="hljs-operator">&gt;</span> <span class="hljs-number">12</span> {
                number <span class="hljs-operator">=</span> <span class="hljs-number">12</span>
                projectedValue <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            } <span class="hljs-keyword">else</span> {
                number <span class="hljs-operator">=</span> newValue
                projectedValue <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
            }
        }
    }
    
    <span class="hljs-keyword">init</span>() {
        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">self</span>.projectedValue <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    }
}
</code></pre>
<p>上面代码中，SmallNumber 结构增加了一个属性 projectedValue，用来记录包装器是否调整了被包装的值。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SomeStructure</span> {
    <span class="hljs-meta">@SmallNumber</span> <span class="hljs-keyword">var</span> someNumber: <span class="hljs-type">Int</span>
}

<span class="hljs-keyword">var</span> someStructure <span class="hljs-operator">=</span> <span class="hljs-type">SomeStructure</span>()
<span class="hljs-built_in">print</span>(someStructure.<span class="hljs-variable">$someNumber</span>)
<span class="hljs-comment">// 打印 false</span>
someStructure.someNumber <span class="hljs-operator">=</span> <span class="hljs-number">55</span>
<span class="hljs-built_in">print</span>(someStructure.<span class="hljs-variable">$someNumber</span>)
<span class="hljs-comment">// 打印 true</span>
</code></pre>
<p>通过在被包装的属性名前增加 $ 来访问包装器的 projectedValue。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>