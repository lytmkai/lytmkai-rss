<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[优化App启动时间？startup-coroutine是什么？]]></title>    <link>https://juejin.cn/post/7577702891273994275</link>    <guid>https://juejin.cn/post/7577702891273994275</guid>    <pubDate>2025-11-30T07:13:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273994275" data-draft-id="7577713754563428404" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="优化App启动时间？startup-coroutine是什么？"/> <meta itemprop="keywords" content="Kotlin,架构,性能优化"/> <meta itemprop="datePublished" content="2025-11-30T07:13:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="年小个大"/> <meta itemprop="url" content="https://juejin.cn/user/1855631359213688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            优化App启动时间？startup-coroutine是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631359213688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    年小个大
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:13:35.000Z" title="Sun Nov 30 2025 07:13:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">那个让我头疼的启动问题</h2>
<p>事情要从我们公司的新项目说起。那时候我们的应用集成了好多第三方 SDK：推送、统计、地图、IM、广告...你懂的，现在的 App 不接十几个 SDK 都不好意思上线。</p>
<p>由于SDK初始化时间过长，导致Splash Activity首屏一直卡在白屏界面，还需要编写各种xml背景图进行填充，很是头疼。</p>
<p>最开始我的 Application 是这样的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> : <span class="hljs-type">Application</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        
        <span class="hljs-comment">// 一堆初始化代码</span>
        Push.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)      <span class="hljs-comment">// 推送</span>
        Analytics.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) <span class="hljs-comment">// 统计</span>
        Map.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)       <span class="hljs-comment">// 地图</span>
        IM.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)        <span class="hljs-comment">// 即时通讯</span>
        Ad.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)        <span class="hljs-comment">// 广告</span>
        <span class="hljs-comment">// ... 还有更多</span>
        
        <span class="hljs-comment">// 自己的业务初始化</span>
        initDatabase()
        initConfig()
        initUser()
    }
}
</code></pre>
<p><strong>结果就是：</strong></p>
<ul>
<li>用户点开 App 要等 3-5 秒才能看到界面</li>
<li>所有初始化都在主线程排队执行，一个卡住后面全等着</li>
<li>代码越来越乱，新同事根本不敢动这块代码</li>
<li>测试经常报 ANR（应用无响应）</li>
</ul>
<h2 data-id="heading-1">寻找解决方案的折腾过程</h2>
<h3 data-id="heading-2">第一站：多线程方案</h3>
<p>我首先想到的是用多线程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> thread1 = thread { Push.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) } <span class="hljs-comment">//kotlin函数</span>
<span class="hljs-keyword">val</span> thread2 = thread { Analytics.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) }
<span class="hljs-comment">// 启动所有线程...</span>
</code></pre>
<p><strong>结果发现问题更多：</strong></p>
<ul>
<li>线程创建开销大</li>
<li>依赖关系处理起来特别麻烦</li>
<li>异常处理很头疼</li>
<li>代码变得超级复杂</li>
</ul>
<h3 data-id="heading-3">第二站：Jetpack AppStartup</h3>
<p>然后我发现了 Google 的 AppStartup，心想官方出品应该很靠谱吧！</p>
<p>用了一段时间发现：</p>
<ul>
<li>它只是把初始化代码从 Application 移到了各个 Initializer 里</li>
<li><strong>关键问题：所有初始化还是在主线程执行的！</strong></li>
<li>启动时间根本没减少，只是代码看起来整齐了点</li>
<li>复杂的依赖关系写起来还是很麻烦</li>
</ul>
<p>AppStartup 更像是一个代码组织工具，而不是性能优化工具。</p>
<h3 data-id="heading-4">灵光一现：为什么不用协程？</h3>
<p>就在我快要放弃的时候，突然想到：我们项目已经在用 Kotlin 协程了，为什么不用协程来解决这个问题呢？</p>
<p>协程的轻量级、灵活的线程调度、简洁的异步表达，不正是我们需要的吗？</p>
<p>于是，我开始动手写 <code>startup-coroutine</code>。</p>
<h2 data-id="heading-5">框架设计</h2>
<h3 data-id="heading-6">核心想法：把初始化当成有依赖关系的任务</h3>
<p>借鉴App Startup,但是它是串行初始化,我呢允许并行初始化。</p>
<p>我想象中的理想状态是：</p>
<ul>
<li>每个初始化任务都是独立的</li>
<li>可以声明它依赖哪些其他任务</li>
<li>没有依赖关系的任务可以并行执行</li>
<li>使用拓扑排序自动处理依赖关系，按正确顺序执行</li>
</ul>
<p>于是就有了 <code>Initializer</code> 接口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Initializer</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(app: <span class="hljs-type">Application</span>, provider: <span class="hljs-type">DependenciesProvider</span>)</span></span>: T
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;KClass&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}
</code></pre>
<h3 data-id="heading-7">线程调度的灵活控制</h3>
<p>我提供了几种预设的线程策略：</p>
<ul>
<li><code>AllIO</code>：全在 IO 线程，适合耗时任务</li>
<li><code>ExecuteOnIO</code>：IO 线程执行，主线程创建框架</li>
<li><code>AllMain</code>：全在主线程，只适合轻量任务</li>
<li><code>Default</code>：默认推荐，框架在 IO 线程，任务在主线程</li>
</ul>
<p>这样大家可以根据自己项目的实际情况选择。</p>
<p>由于协程的<code>suspend</code>函数可以灵活的切换调度线程,所以可以全部在Main线程执行,然后具体的处理业务自由使用<code>withContext(Dispatchers.IO){...}</code>来切换.</p>
<h2 data-id="heading-8">BaseActivity 的封装</h2>
<p>这个设计源于我们遇到的一个真实问题：</p>
<p><strong>问题场景：</strong> 用户正在使用 App，突然来了个电话或者切换到其他应用，这时候系统可能因为内存不足把我们的应用进程给杀掉了。当用户再切回来时，系统会重新创建 Application 和用户最后看到的 Activity。</p>
<p><strong>这时候就出问题了：</strong> Application构建完成后,执行Startup的初始化,由于Startup是协程框架,它不阻塞UI,于是还没有等待Startup初始化结束Activity就开始创建了,此时Activity 在 onCreate 时可能会使用那些还没重新初始化的 SDK，结果就是各种空指针异常和崩溃。</p>
<p><strong>我的解决方案：</strong> 在 BaseActivity 里统一监听初始化状态。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        observeStartup() <span class="hljs-comment">// 关键的一行！</span>
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observeStartup</span><span class="hljs-params">()</span></span> {
        Startup.observe(<span class="hljs-keyword">this</span>) { result -&gt;
            <span class="hljs-keyword">when</span> (result) {
                StartupResult.Idle -&gt; showLoading() <span class="hljs-comment">// 还没初始化，显示加载</span>
                StartupResult.Success -&gt; {
                    hideLoading()
                    onInitFinished() <span class="hljs-comment">// 初始化完成，继续正常流程</span>
                }
                <span class="hljs-keyword">is</span> StartupResult.Failure -&gt; {
                    hideLoading()
                    <span class="hljs-comment">// 处理初始化失败</span>
                }
            }
        }
    }
}
</code></pre>
<p><strong>这样设计的好处：</strong></p>
<ol>
<li><strong>进程重启无忧</strong>：即使进程被杀死重建，也能保证 SDK 先初始化再使用</li>
<li><strong>统一加载状态</strong>：所有页面都有统一的加载体验</li>
<li><strong>错误统一处理</strong>：初始化失败时有统一的错误处理机制</li>
<li><strong>代码复用</strong>：每个 Activity 都不用自己写初始化监听逻辑</li>
</ol>
<p><code>Startup.observe</code>内部是使用LiveData实现的.目的是为了每个页面监听的时候都可以拿到初始化数据信息.</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Startup</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> implementation: IStartup
) : IStartup {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _isInitialized = MutableLiveData&lt;StartupResult&gt;(StartupResult.Idle)

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observe</span><span class="hljs-params">(owner: <span class="hljs-type">LifecycleOwner</span>, observer: <span class="hljs-type">Observer</span>&lt;<span class="hljs-type">StartupResult</span>&gt;)</span></span> {
            _isInitialized.observe(owner, observer)
        }

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInitialized</span><span class="hljs-params">()</span></span> = _isInitialized.value != StartupResult.Idle

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initializedResult</span><span class="hljs-params">()</span></span> = _isInitialized.value

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">reset</span><span class="hljs-params">()</span></span> {
            _isInitialized.postValue(StartupResult.Idle)
        }
        <span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">markInitializedResult</span><span class="hljs-params">(result: <span class="hljs-type">StartupResult</span>)</span></span> {
            _isInitialized.postValue(result)
        }
    }

</code></pre>
<h2 data-id="heading-9">隐私协议处理的巧妙设计</h2>
<p>现在隐私合规要求很严格，很多 SDK 必须在用户同意隐私协议后才能初始化。我的框架也很好的解决了这个问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> : <span class="hljs-type">Application</span>() {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> startup: Startup

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startInit</span><span class="hljs-params">()</span></span> {
            startup.start()
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        <span class="hljs-comment">//轻量级数据存储推荐直接初始化,用于进行判断逻辑.</span>
        SpUtils.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)

        <span class="hljs-comment">//构建初始化任务列表.</span>
        <span class="hljs-keyword">val</span> initializer = listOf(
            AdMobInit(),
            AppConfigInit(),
            FlutterEngineInit(),
            FistInitializer(),
            IMInit(),
            MapSdkInit(),
            ExceptionInit()
        )
        <span class="hljs-comment">//构建startup</span>
        startup = Startup.Builder(<span class="hljs-keyword">this</span>)
            .setDispatchers(StartupDispatchers.AllIO)
            .setDebug(<span class="hljs-literal">true</span>)
            .add(initializer)
            .build()

        <span class="hljs-comment">//推荐!!!</span>
        <span class="hljs-comment">//如果App跳过了手动初始化,就必须做判断,只要条件允许第二次初始化的时候</span>
        <span class="hljs-comment">//一定在Application中直接执行.</span>
        <span class="hljs-comment">//这里涉及到了一些进程重启逻辑.</span>
        <span class="hljs-keyword">if</span> (SpUtils.getBoolean(<span class="hljs-string">"isAgreePrivacy"</span>,<span class="hljs-literal">false</span>)) {
            startInit()
        }
    }

}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SplashActivity</span> : <span class="hljs-type">BaseActivity</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkPrivacy</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (用户已同意隐私协议) {
            <span class="hljs-comment">// 开始初始化</span>
            MyApp.startInit()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 显示隐私协议弹窗</span>
            showPrivacyDialog {
                <span class="hljs-comment">// 用户同意后开始初始化</span>
                MyApp.startInit()
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-10">实际效果怎么样？</h2>
<p>用了 <code>startup-coroutine</code> 之后：</p>
<ul>
<li><strong>启动时间</strong>：从 3-5 秒优化到 1-2 秒</li>
<li><strong>代码可维护性</strong>：新同事也能轻松添加新的初始化任务</li>
<li><strong>稳定性</strong>：再也没有因为进程重启导致的崩溃</li>
<li><strong>开发体验</strong>：调试时可以清楚看到每个任务的执行时间和依赖关系</li>
</ul>
<h2 data-id="heading-11">怎么集成使用？</h2>
<p>集成超级简单：</p>
<ol>
<li><strong>添加依赖：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin">implementation(<span class="hljs-string">"com.github.Dboy233:startup-coroutine:最新版本"</span>)
</code></pre>
<ol start="2">
<li><strong>定义初始化任务：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-comment">//如果没有依赖可不重写此方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span> = listOf(OtherInitializer::<span class="hljs-keyword">class</span>)
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(app: <span class="hljs-type">Application</span>, provider: <span class="hljs-type">DependenciesProvider</span>)</span></span> {
        <span class="hljs-comment">// 你的初始化代码</span>
    }
}
</code></pre>
<ol start="3">
<li><strong>在 Application 中配置：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> startup = Startup.Builder(<span class="hljs-keyword">this</span>)
    .add(MyInitializer())
    .setDispatchers(StartupDispatchers.ExecuteOnIO)
    .build()
</code></pre>
<ol start="4">
<li><strong>让 Activity 继承 BaseActivity</strong>（或者自己实现初始化监听）</li>
</ol>
<h2 data-id="heading-12">实际应用日志</h2>
<pre><code class="hljs language-text" lang="text">
--- Startup Coroutine Dependency Graph ---
    
    FlutterEngineInit
    FistInitializer
    ExceptionInit
    AppConfigInit
      └─ FistInitializer
    AdMobInit
      └─ AppConfigInit
    IMInit
      └─ AppConfigInit
    MapSdkInit
      └─ AppConfigInit
    
----------------------------------------


--- Startup Coroutine Performance Summary ---

&gt;&gt; Total Time: 2538ms  |  Status: FAILED
&gt;&gt; Dispatchers Mode: All-IO

&gt;&gt; Individual Task Durations:
   - FlutterEngineInit  |  2503ms  |  Thread: DefaultDispatcher-worker-5
   - IMInit             |  2000ms  |  Thread: DefaultDispatcher-worker-5
   - AdMobInit          |  1832ms  |  Thread: DefaultDispatcher-worker-4
   - MapSdkInit         |  601ms   |  Thread: DefaultDispatcher-worker-4
   - AppConfigInit      |  102ms   |  Thread: DefaultDispatcher-worker-5
   - FistInitializer    |  0ms     |  Thread: DefaultDispatcher-worker-4
   - ExceptionInit      |  -1ms    |  Thread: Error
&gt;&gt; Task time is sum  : 7037 ms
</code></pre>
<p>打印初始化结果，可以看到使用协程框架后整体初始化从7秒优化到了1坤秒(2.5秒)。</p>
<p>效果还是立竿见影的，关键是它的初始化不占用UI渲染时间，让UI过度不出现卡顿白屏。</p>
<p>如果你在Log中看到了两次日志输出，不要紧张,它不是执行了两次,而仅仅只是打印两次。</p>
<pre><code class="hljs language-vbscript" lang="vbscript">Log.i(<span class="hljs-string">"StartupCoroutine"</span>, logContent.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>())
println(logContent.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>())
</code></pre>
<p>因为Test阶段的时候Log是不输出内容的，所以使用println再打印了一遍.你只需要过滤<code>StartupCoroutine</code>日志即可。</p>
<h2 data-id="heading-13">写在最后</h2>
<p>开发 <code>startup-coroutine</code> 的过程让我深刻体会到：好的框架不是凭空想象出来的，而是从真实的业务痛点中生长出来的。</p>
<p>我现在把这个框架开源出来，一方面是希望帮助到有同样问题的开发者，另一方面也是想听听大家的想法，看看能不能一起把它做得更好。</p>
<p>如果你也在为应用启动优化而烦恼，不妨试试 <code>startup-coroutine</code>。如果你有任何建议或者发现了什么问题，欢迎来 GitHub 给我提 Issue 或者 PR。</p>
<p><strong>项目地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDboy233%2Fstartup-coroutine" target="_blank" title="https://github.com/Dboy233/startup-coroutine" ref="nofollow noopener noreferrer"><code>https://github.com/Dboy233/startup-coroutine</code></a></p>
<p>希望我的这个小工具能帮到你，也期待听到你的使用反馈！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[批量商品信息采集工具获取商品详情的完整方案]]></title>    <link>https://juejin.cn/post/7577690150093570088</link>    <guid>https://juejin.cn/post/7577690150093570088</guid>    <pubDate>2025-11-30T07:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093570088" data-draft-id="7577683422878810146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="批量商品信息采集工具获取商品详情的完整方案"/> <meta itemprop="keywords" content="数据分析,数据挖掘,爬虫"/> <meta itemprop="datePublished" content="2025-11-30T07:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4142929607239"/> <meta itemprop="url" content="https://juejin.cn/user/2579871227198947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            批量商品信息采集工具获取商品详情的完整方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2579871227198947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4142929607239
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:26:47.000Z" title="Sun Nov 30 2025 07:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99510bb6c4104ed794f17fd42f4a541f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDE0MjkyOTYwNzIzOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092407&amp;x-signature=IQYIBZ%2BzFO3WsyMy8ug9R%2F%2BgmB0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、获取前的准备：官方 API 接入流程</h2>
<h3 data-id="heading-1">1. 平台认证与权限申请</h3>
<ul>
<li>
<p><strong>注册淘宝开放平台账号</strong>：访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.taobao.com%2F" title="https://open.taobao.com/" target="_blank" ref="nofollow noopener noreferrer">open.taobao.com</a>，完成个人 / 企业认证（企业需营业执照）</p>
</li>
<li>
<p><strong>创建应用</strong>：控制台→应用管理→创建应用（选择 "网站应用" 或 "服务器应用"），获取<strong>App Key</strong>和<strong>App Secret</strong>（核心凭证）</p>
</li>
<li>
<p><strong>申请接口权限</strong>：</p>
<ul>
<li><strong>基础详情</strong>：<code>taobao.item.get</code>（单个商品详情）</li>
<li><strong>批量获取</strong>：<code>taobao.item_get_batch</code>（一次最多 50 个商品 ID，需单独申请）</li>
<li><strong>搜索获取 ID</strong>：<code>taobao.items.search</code>（按关键词 / 类目搜索商品）</li>
<li><strong>店铺商品</strong>：<code>taobao.items.onsale.get</code>（获取店铺在售商品列表）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">2. 商品 ID 获取策略（批量采集前提）</h3>






























<table><thead><tr><th>获取方式</th><th>适用场景</th><th>实现方法</th></tr></thead><tbody><tr><td><strong>从已有列表获取</strong></td><td>已有商品链接 / ID</td><td>从 URL 提取末尾数字（如<code>https://item.taobao.com/item.htm?id=123456</code>中的<code>123456</code>）</td></tr><tr><td><strong>搜索获取</strong></td><td>按关键词 / 类目采集</td><td>调用<code>taobao.items.search</code>，指定关键词、页码，获取商品 ID 列表</td></tr><tr><td><strong>店铺全量采集</strong></td><td>监控竞品 / 自有店铺</td><td><code>taobao.items.onsale.get</code>获取店铺所有在售商品 ID</td></tr><tr><td><strong>从其他平台同步</strong></td><td>多平台运营商家</td><td>从京东 / 拼多多等平台商品链接提取 ID，再通过 API 获取淘宝详情</td></tr></tbody></table>
<h2 data-id="heading-3">二、核心实现：批量获取商品详情的技术方案</h2>
<h3 data-id="heading-4">1. 接口选择与调用方式</h3>
<p><strong>方案 A：循环调用单商品接口（简单易实现）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 伪代码示例</span>
<span class="hljs-function">def <span class="hljs-title">batch_get_items</span>(<span class="hljs-params">app_key, app_secret, item_ids</span>):
    results</span> = []
    <span class="hljs-keyword">for</span> item_id <span class="hljs-keyword">in</span> item_ids:
        <span class="hljs-meta"># 构造请求参数</span>
        <span class="hljs-keyword">params</span> = {
            <span class="hljs-string">'method'</span>: <span class="hljs-string">'taobao.item.get'</span>,
            <span class="hljs-string">'app_key'</span>: app_key,
            <span class="hljs-string">'num_iid'</span>: item_id,
            <span class="hljs-string">'fields'</span>: <span class="hljs-string">'num_iid,title,price,pic_url,desc,sales'</span>  <span class="hljs-meta"># 指定返回字段</span>
        }
        <span class="hljs-meta"># 生成签名</span>
        <span class="hljs-keyword">params</span>[<span class="hljs-string">'sign'</span>] = generate_sign(<span class="hljs-keyword">params</span>, app_secret)
        <span class="hljs-meta"># 发送请求</span>
        response = requests.<span class="hljs-keyword">get</span>(<span class="hljs-string">'https://eco.taobao.com/router/rest'</span>, <span class="hljs-keyword">params</span>=<span class="hljs-keyword">params</span>)
        results.append(response.json())
        time.sleep(<span class="hljs-number">0.5</span>)  <span class="hljs-meta"># 控制频率，避免触发风控</span>
    <span class="hljs-keyword">return</span> results
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>方案 B：使用批量接口（效率更高）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 伪代码示例：taobao.item_get_batch</span>
<span class="hljs-function">def <span class="hljs-title">batch_get_items</span>(<span class="hljs-params">app_key, app_secret, item_ids</span>):
    # 分批处理（每批最多50个）
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-title">range</span>(<span class="hljs-params"><span class="hljs-number">0</span>, len(item_ids</span>), 50):
        batch_ids</span> = item_ids[i:i+<span class="hljs-number">50</span>]
        <span class="hljs-keyword">params</span> = {
            <span class="hljs-string">'method'</span>: <span class="hljs-string">'taobao.item_get_batch'</span>,
            <span class="hljs-string">'app_key'</span>: app_key,
            <span class="hljs-string">'num_iids'</span>: <span class="hljs-string">','</span>.<span class="hljs-keyword">join</span>(batch_ids),  <span class="hljs-meta"># 商品ID用逗号分隔</span>
            <span class="hljs-string">'fields'</span>: <span class="hljs-string">'num_iid,title,price,pic_url,desc,sales'</span>
        }
        <span class="hljs-keyword">params</span>[<span class="hljs-string">'sign'</span>] = generate_sign(<span class="hljs-keyword">params</span>, app_secret)
        response = requests.<span class="hljs-keyword">get</span>(<span class="hljs-string">'https://eco.taobao.com/router/rest'</span>, <span class="hljs-keyword">params</span>=<span class="hljs-keyword">params</span>)
        <span class="hljs-keyword">yield</span> response.json()  <span class="hljs-meta"># 返回分批结果</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-5">2. 性能优化关键技术</h3>
<p><strong>① 异步并发处理</strong>（适合大规模采集）</p>
<ul>
<li>使用<code>aiohttp</code>替代<code>requests</code>，配合<code>asyncio</code>实现异步并发</li>
<li>设置信号量控制并发数（建议 30-50，避免触发平台限流）</li>
<li>随机延迟（0.3-0.8 秒）避免被识别为爬虫</li>
</ul>
<p><strong>② 字段优化</strong></p>
<ul>
<li>只请求必要字段：<code>fields='num_iid,title,price,pic_url,skus'</code>，减少 65% 带宽消耗</li>
<li>排除不需要的字段（如评价详情、物流信息），提升响应速度</li>
</ul>
<p><strong>③ 缓存机制</strong></p>
<ul>
<li>对热门 / 高频访问商品使用 Redis 缓存（设置 1 小时过期），减少重复调用</li>
</ul>
<h2 data-id="heading-6">三、数据解析与结构化处理</h2>
<h3 data-id="heading-7">1. 响应数据解析流程</h3>
<p>plaintext</p>
<pre><code class="hljs language-javascript" lang="javascript">原始<span class="hljs-title class_">JSON</span> → 基础校验 → 字段提取 → 结构化存储
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>核心字段提取示例：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 从返回结果提取核心信息</span>
<span class="hljs-function">def <span class="hljs-title">parse_item_data</span>(<span class="hljs-params">raw_item</span>):
    <span class="hljs-keyword">return</span></span> {
        <span class="hljs-string">"商品ID"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"num_iid"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"标题"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"title"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"价格"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"price"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"促销价"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"promotion_price"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"主图"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"pic_url"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"销量"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"volume"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"SKU信息"</span>: [sku.<span class="hljs-keyword">get</span>(<span class="hljs-string">"price"</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> sku <span class="hljs-keyword">in</span> raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"sku"</span>, {}).<span class="hljs-keyword">get</span>(<span class="hljs-string">"sku_list"</span>, [])]
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-8">2. 特殊情况处理</h3>
<ul>
<li>
<p><strong>HTML 描述处理</strong>：商品描述（desc 字段）含 HTML 标签，需用<code>BeautifulSoup</code>解析提取纯文本或图片 URL</p>
</li>
<li>
<p><strong>嵌套数据处理</strong>：</p>
<p>plaintext</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 解析多级嵌套的卖家信息</span>
seller_info = raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"seller"</span>, {})
<span class="hljs-keyword">return</span> {
    <span class="hljs-string">"店铺名称"</span>: seller_info.<span class="hljs-keyword">get</span>(<span class="hljs-string">"shop_name"</span>, <span class="hljs-string">""</span>),
    <span class="hljs-string">"店铺ID"</span>: seller_info.<span class="hljs-keyword">get</span>(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">""</span>)
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-9">四、批量采集完整工作流（最佳实践）</h2>
<h3 data-id="heading-10">Step 1：准备阶段</h3>
<ul>
<li>完成 API 权限申请和凭证获取</li>
<li>确定目标商品 ID 列表（通过搜索 / 店铺获取或手动导入）</li>
<li>初始化日志 / 监控系统（记录成功 / 失败案例）</li>
</ul>
<h3 data-id="heading-11">Step 2：批量获取详情（核心环节）</h3>
<p>plaintext</p>
<pre><code class="hljs language-scss" lang="scss">商品ID列表 → 分批(<span class="hljs-number">50</span>个/批) → 调用接口 → 数据解析 → 错误处理 → 存储
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-12">Step 3：错误处理与重试机制（关键保障）</h3>
<p><strong>常见错误及解决方案：</strong></p>



































<table><thead><tr><th>错误类型</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>API 限流</strong></td><td>调用频率超过限制</td><td>增加延迟 (0.5-1 秒)、降低并发数、分批处理</td></tr><tr><td><strong>签名错误</strong></td><td>参数 / 签名生成错误</td><td>检查签名算法、确保参数有序、URL 编码正确</td></tr><tr><td><strong>商品不存在</strong></td><td>ID 错误 / 已下架</td><td>过滤无效 ID，记录日志</td></tr><tr><td><strong>网络波动</strong></td><td>临时连接问题</td><td>实现指数退避重试 (1→2→4→8 秒)，最多 3 次</td></tr><tr><td><strong>权限不足</strong></td><td>缺少必要权限</td><td>检查应用权限，重新申请</td></tr></tbody></table>
<h3 data-id="heading-13">Step 4：数据存储与后续应用</h3>
<ul>
<li>
<p><strong>结构化存储</strong>：存入 MySQL/MongoDB 数据库或导出 CSV/Excel</p>
</li>
<li>
<p><strong>增量更新</strong>：记录已采集商品的最后更新时间，下次只采集更新商品</p>
</li>
<li>
<p><strong>业务应用</strong>：</p>
<ul>
<li>商品信息同步至其他平台</li>
<li>竞品监控（价格 / 库存 / 销量变化）</li>
<li>数据分析与选品参考</li>
<li>商品信息管理系统（PIM）更新</li>
</ul>
</li>
</ul>
<h2 data-id="heading-14">五、关键注意事项（避免踩坑）</h2>
<h3 data-id="heading-15">1. <strong>平台规则遵守</strong></h3>
<ul>
<li>禁止<strong>未经授权的数据抓取</strong>（必须使用官方 API，禁用爬虫）</li>
<li>商品价格等信息<strong>仅限自用</strong>，不得直接倒卖数据获利</li>
<li>遵循<strong>频率限制</strong>：基础接口 QPS≤2-5，批量接口≤1，违规会触发风控（IP 封禁 / 接口禁用）</li>
</ul>
<h3 data-id="heading-16">2. <strong>性能与稳定性优化建议</strong></h3>
<p><strong>必做优化：</strong></p>
<ul>
<li>控制并发数在<strong>30 以下</strong>（建议 10-20）</li>
<li>批次大小 <strong>≤40</strong>（为<code>item_get_batch</code>上限 50 预留安全空间）</li>
<li>每请求间添加<strong>随机延迟</strong>（0.3-1 秒）</li>
<li>使用<strong>异步 + 信号量</strong>控制（提升效率 3-5 倍）</li>
</ul>
<p><strong>可选优化：</strong></p>
<ul>
<li>分时段采集（避开 API 高峰，如 11:00-13:00、20:00-22:00）</li>
<li>对热门商品使用缓存（Redis/Memcached）</li>
<li>监控 API 响应时间，动态调整请求策略</li>
</ul>
<h2 data-id="heading-17">六、总结：批量采集的核心实施路径</h2>
<p>批量商品信息采集工具获取淘宝商品详情的完整链路是：<strong>官方 API 授权 → 商品 ID 获取 → 批量接口调用 → 数据解析处理 → 结构化存储</strong>。</p>
<p><strong>最佳实践总结：</strong></p>
<ul>
<li>优先使用官方 API（合规稳定），禁用爬虫</li>
<li>采用批量接口 + 异步并发（提升效率 10 倍 +）</li>
<li>严格控制频率（QPS&lt;5），添加随机延迟</li>
<li>按需请求字段，减少数据传输量</li>
<li>实现完善的错误处理与重试机制</li>
</ul>
<h2 data-id="heading-18">附：淘宝商品详情接口返回核心字段</h2>























































<table><thead><tr><th>字段名</th><th>说明</th><th>用途</th></tr></thead><tbody><tr><td><strong>num_iid</strong></td><td>商品 ID（唯一标识）</td><td>数据关联、更新判断</td></tr><tr><td><strong>title</strong></td><td>商品标题</td><td>展示、关键词分析</td></tr><tr><td><strong>price</strong></td><td>商品价格</td><td>价格监控、比价</td></tr><tr><td><strong>promotion_price</strong></td><td>促销价</td><td>促销活动分析</td></tr><tr><td><strong>pic_url</strong></td><td>主图 URL</td><td>图片下载、展示</td></tr><tr><td><strong>desc</strong></td><td>商品详情描述（HTML）</td><td>详情页展示、内容分析</td></tr><tr><td><strong>sku</strong></td><td>SKU 信息（规格 / 价格）</td><td>库存管理、规格分析</td></tr><tr><td><strong>volume</strong></td><td>销量</td><td>热度评估、选品参考</td></tr><tr><td><strong>seller</strong></td><td>卖家信息（店铺名 / ID）</td><td>店铺分析、供应商管理</td></tr></tbody></table>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 epub 在手机快乐阅读]]></title>    <link>https://juejin.cn/post/7577958825342074899</link>    <guid>https://juejin.cn/post/7577958825342074899</guid>    <pubDate>2025-11-30T07:27:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342074899" data-draft-id="7577970969395068969" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 epub 在手机快乐阅读"/> <meta itemprop="keywords" content="JavaScript,deno,科幻"/> <meta itemprop="datePublished" content="2025-11-30T07:27:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="穷人小水滴"/> <meta itemprop="url" content="https://juejin.cn/user/134615944418777"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 epub 在手机快乐阅读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/134615944418777/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    穷人小水滴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:27:51.000Z" title="Sun Nov 30 2025 07:27:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近沉迷 AI 小说 (不可自拔) 玩物丧志 (大雾).</p>
<p>那么假如, 是说假如, 窝自己写了一本小说, 如何愉快的阅读它呢 ?</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fcd75f986e34ae78af331a3fd4c6d17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=ZPEEVRD73wOu8rbSx7C78Hp%2BAg0%3D" alt="0-n-1.png" loading="lazy"/></p>
<p>这里是 穷人小水滴, 专注于 穷人友好型 低成本技术. (本文为 86 号作品. )</p>
<hr/>
<p>相关文章:</p>
<ul>
<li>《4 大低成本娱乐方式: 小说, 音乐, 视频, 电子游戏》 <a href="https://juejin.cn/post/7414129923634561035" target="_blank" title="https://juejin.cn/post/7414129923634561035">juejin.cn/post/741412…</a></li>
<li>《在 Android 设备上写代码 (Termux, code-server)》 <a href="https://juejin.cn/post/7510181121205256226" target="_blank" title="https://juejin.cn/post/7510181121205256226">juejin.cn/post/751018…</a></li>
<li>《Android 运行 deno 的新方法 (3): Termux 胖喵安初》 <a href="https://juejin.cn/post/7533510113068761098" target="_blank" title="https://juejin.cn/post/7533510113068761098">juejin.cn/post/753351…</a></li>
<li>《小水滴系列文章目录 (整理)》 <a href="https://juejin.cn/post/7522090635908300838" target="_blank" title="https://juejin.cn/post/7522090635908300838">juejin.cn/post/752209…</a></li>
<li>《自制: 7 天手搓一个拼音输入法》 <a href="https://juejin.cn/post/7343902899095060499" target="_blank" title="https://juejin.cn/post/7343902899095060499">juejin.cn/post/734390…</a></li>
<li>《防误删 (实时) 文件备份系统 (btrfs 快照 + rsync)》 <a href="https://juejin.cn/post/7552509614097924131" target="_blank" title="https://juejin.cn/post/7552509614097924131">juejin.cn/post/755250…</a></li>
<li>《静音键盘简单评测》</li>
<li>《科幻小说计划 (顾雪) (AIGC)》 <a href="https://juejin.cn/post/7577718777481297958" target="_blank" title="https://juejin.cn/post/7577718777481297958">juejin.cn/post/757771…</a></li>
</ul>
<p>参考资料:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeno.com%2F" target="_blank" title="https://deno.com/" ref="nofollow noopener noreferrer">deno.com/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftermux.dev%2Fen%2F" target="_blank" title="https://termux.dev/en/" ref="nofollow noopener noreferrer">termux.dev/en/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fhelp%2Ffdroid%2F" target="_blank" title="https://mirrors.tuna.tsinghua.edu.cn/help/fdroid/" ref="nofollow noopener noreferrer">mirrors.tuna.tsinghua.edu.cn/help/fdroid…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.lineageos.org%2Fdevices%2Fviolet%2F" target="_blank" title="https://wiki.lineageos.org/devices/violet/" ref="nofollow noopener noreferrer">wiki.lineageos.org/devices/vio…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farchlinux.org%2F" target="_blank" title="https://archlinux.org/" ref="nofollow noopener noreferrer">archlinux.org/</a></li>
</ul>
<h2 data-id="heading-0">目录</h2>
<ul>
<li>1 制作 epub 文件 (deno)
<ul>
<li>1.1 程序代码</li>
<li>1.2 工作原理</li>
</ul>
</li>
<li>2 手机阅读软件推荐 (Android F-Droid)</li>
<li>3 实际测试</li>
<li>4 总结与展望</li>
<li>附录 1 "全开源" 软件体系</li>
</ul>
<h2 data-id="heading-1">1 制作 epub 文件 (deno)</h2>
<p>如果使用最基础的 <code>txt</code> (纯文本) 文件, 由于不含任何有关内容的格式, 阅读体验并不好.</p>
<p><strong>epub</strong> 是一种开放的电子书格式标准, 基于 HTML+CSS (XML) 技术, 简单, 被广泛支持, 功能丰富.</p>
<p>于是窝就写了一个很简单的 txt 转 epub 格式的程序, 主要功能有分章, 字数计算等, 代码如下.</p>
<h3 data-id="heading-2">1.1 程序代码</h3>
<p>文件 <code>txt2epub.js</code>:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// txt2epub.js</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// deno run -A txt2epub.js 1.txt out1</span>

<span class="hljs-comment">// 计算中文字数: 非 ASCII 字符都算</span>
<span class="hljs-keyword">function</span> 字数(文本) {
  <span class="hljs-keyword">let</span> 计数 = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">of</span> 文本) {
    <span class="hljs-keyword">if</span> (i.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>) &gt; <span class="hljs-number">127</span>) {
      计数 += <span class="hljs-number">1</span>;
    }
  }
  <span class="hljs-keyword">return</span> 计数;
}

<span class="hljs-comment">// 将输入 txt 文件内容转换成内部数据格式, 并进行分章</span>
<span class="hljs-keyword">function</span> 解析<span class="hljs-title function_">txt</span>(<span class="hljs-params">文本</span>) {
  <span class="hljs-comment">// 全文总字数</span>
  <span class="hljs-keyword">const</span> 总字 = 字数(文本);

  <span class="hljs-comment">// 按 ## 切分章节 (markdown)</span>
  <span class="hljs-keyword">const</span> 部分 = 文本.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n## "</span>);

  <span class="hljs-comment">// 章节的第 1 行是标题</span>
  <span class="hljs-keyword">const</span> 章 = 部分.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> 行 = i.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n"</span>);

    <span class="hljs-comment">// 章节正文字数</span>
    <span class="hljs-keyword">const</span> 字 = 字数(行.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>));

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 标题 (字数)</span>
      标题: 行[<span class="hljs-number">0</span>] + <span class="hljs-string">" ("</span> + 字 + <span class="hljs-string">")"</span>,
      段: 行.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>),
    };
  });

  <span class="hljs-comment">// 书名为第 1 行</span>
  <span class="hljs-comment">// 总字数 (k 计数)</span>
  <span class="hljs-keyword">const</span> 总字k = (总字 / <span class="hljs-number">1000</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> {
    标题: 章[<span class="hljs-number">0</span>].标题 + <span class="hljs-string">" ("</span> + 总字k + <span class="hljs-string">"k)"</span>,
    章,
  };
}

<span class="hljs-comment">// 读取 txt 文件并解析</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 加载<span class="hljs-title function_">txt</span>(<span class="hljs-params">文件</span>) {
  <span class="hljs-keyword">const</span> 文本 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">readTextFile</span>(文件);
  <span class="hljs-keyword">return</span> 解析<span class="hljs-title function_">txt</span>(文本);
}

<span class="hljs-comment">// 生成 uuid</span>
<span class="hljs-keyword">function</span> 造<span class="hljs-title function_">uuid</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
}

<span class="hljs-comment">// 渲染 epub</span>

<span class="hljs-comment">// out/mimetype</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">mimetype</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`application/epub+zip`</span>;
}

<span class="hljs-comment">// out/META-INF/container.xml</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">container_xml</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;container
  version="1.0"
  xmlns="urn:oasis:names:tc:opendocument:xmlns:container"
&gt;
  &lt;rootfiles&gt;
    &lt;rootfile
      full-path="OEBPS/content.opf"
      media-type="application/oebps-package+xml"
    /&gt;
  &lt;/rootfiles&gt;
&lt;/container&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/content.opf</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">content_opf</span>(<span class="hljs-params">数据</span>) {
  <span class="hljs-keyword">const</span> uuid = 造<span class="hljs-title function_">uuid</span>();

  <span class="hljs-keyword">const</span> item = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;item id="item<span class="hljs-subst">${序号}</span>" href="xhtml/<span class="hljs-subst">${序号}</span>.xhtml" media-type="application/xhtml+xml" /&gt;`</span>
  );
  <span class="hljs-keyword">const</span> itemref = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;itemref idref="item<span class="hljs-subst">${序号}</span>" /&gt;`</span>
  );

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;package
  xmlns="http://www.idpf.org/2007/opf"
  version="3.0"
  unique-identifier="pub-id"
&gt;
  &lt;metadata xmlns:dc="http://purl.org/dc/elements/1.1/"&gt;
    &lt;dc:title&gt;<span class="hljs-subst">${数据.标题}</span>&lt;/dc:title&gt;
    &lt;dc:creator&gt;you&lt;/dc:creator&gt;
    &lt;dc:identifier id="pub-id"
    &gt;urn:uuid:<span class="hljs-subst">${uuid}</span>&lt;/dc:identifier&gt;
  &lt;/metadata&gt;

  &lt;manifest&gt;
    &lt;item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml" /&gt;
    &lt;item id="css" href="style.css" media-type="text/css" /&gt;

<span class="hljs-subst">${item.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/manifest&gt;

  &lt;spine toc="ncx"&gt;
<span class="hljs-subst">${itemref.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/spine&gt;
&lt;/package&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/toc.ncx</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">toc_ncx</span>(<span class="hljs-params">数据</span>) {
  <span class="hljs-keyword">const</span> uuid = 造<span class="hljs-title function_">uuid</span>();

  <span class="hljs-keyword">const</span> navPoint = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;navPoint id="navPoint-<span class="hljs-subst">${序号}</span>" playOrder="<span class="hljs-subst">${序号 + <span class="hljs-number">1</span>}</span>"&gt;
      &lt;navLabel&gt;&lt;text&gt;<span class="hljs-subst">${i.标题}</span>&lt;/text&gt;&lt;/navLabel&gt;
      &lt;content src="xhtml/<span class="hljs-subst">${序号}</span>.xhtml" /&gt;
    &lt;/navPoint&gt;
`</span>
  );

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;ncx
  xmlns="http://www.daisy.org/z3986/2005/ncx/"
  version="2005-1"
  xml:lang="zh-CN"
&gt;
  &lt;head&gt;
    &lt;meta
      name="dtb:uid"
      content="urn:uuid:<span class="hljs-subst">${uuid}</span>"
    /&gt;
    &lt;meta name="dtb:depth" content="1" /&gt;
    &lt;meta name="dtb:totalPageCount" content="<span class="hljs-subst">${数据.章.length}</span>" /&gt;
  &lt;/head&gt;
  &lt;docTitle&gt;
    &lt;text&gt;<span class="hljs-subst">${数据.标题}</span>&lt;/text&gt;
  &lt;/docTitle&gt;
  &lt;navMap&gt;
<span class="hljs-subst">${navPoint.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/navMap&gt;
&lt;/ncx&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/style.css</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">style_css</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`body {

}
`</span>;
}

<span class="hljs-comment">// out/OEBPS/xhtml/0.xhtml</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">xhtml</span>(<span class="hljs-params">章, _序号</span>) {
  <span class="hljs-keyword">const</span> p = 章.段.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> <span class="hljs-string">`    &lt;p&gt;<span class="hljs-subst">${i}</span>&lt;/p&gt;`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"&gt;
  &lt;head&gt;
    &lt;title&gt;<span class="hljs-subst">${章.标题}</span>&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;<span class="hljs-subst">${章.标题}</span>&lt;/h2&gt;

<span class="hljs-subst">${p.join(<span class="hljs-string">"\n"</span>)}</span>

 &lt;/body&gt;
&lt;/html&gt;
`</span>;
}

<span class="hljs-comment">// 递归创建目录: mkdir -p</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 建目录(路径) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"目录"</span>, 路径);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">mkdir</span>(路径, {
    <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>,
  });
}

<span class="hljs-comment">// 写文本文件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 写(名, 文本) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" "</span>, 名);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">writeTextFile</span>(名, 文本);
}

<span class="hljs-comment">// 生成 epub 文件</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// epub 文件结构 (zip.epub):</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// out/</span>
<span class="hljs-comment">// out/mimetype</span>
<span class="hljs-comment">// out/META-INF/</span>
<span class="hljs-comment">// out/META-INF/container.xml</span>
<span class="hljs-comment">// out/OEBPS/</span>
<span class="hljs-comment">// out/OEBPS/content.opf</span>
<span class="hljs-comment">// out/OEBPS/toc.ncx</span>
<span class="hljs-comment">// out/OEBPS/style.css</span>
<span class="hljs-comment">// out/OEBPS/xhtml/</span>
<span class="hljs-comment">// out/OEBPS/xhtml/0.xhtml</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 造<span class="hljs-title function_">epub</span>(<span class="hljs-params">数据, 输出目录</span>) {
  <span class="hljs-comment">// epub 元数据</span>
  <span class="hljs-keyword">await</span> 建目录(输出目录);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/mimetype"</span>, 渲染<span class="hljs-title function_">mimetype</span>());

  <span class="hljs-keyword">await</span> 建目录(输出目录 + <span class="hljs-string">"/META-INF"</span>);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/META-INF/container.xml"</span>, 渲染<span class="hljs-title function_">container_xml</span>());

  <span class="hljs-keyword">await</span> 建目录(输出目录 + <span class="hljs-string">"/OEBPS/xhtml"</span>);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/content.opf"</span>, 渲染<span class="hljs-title function_">content_opf</span>(数据));
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/toc.ncx"</span>, 渲染<span class="hljs-title function_">toc_ncx</span>(数据));
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/style.css"</span>, 渲染<span class="hljs-title function_">style_css</span>());

  <span class="hljs-comment">// 生成每一章</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [序号, 章] <span class="hljs-keyword">of</span> 数据.章.<span class="hljs-title function_">entries</span>()) {
    <span class="hljs-keyword">await</span> 写(
      输出目录 + <span class="hljs-string">"/OEBPS/xhtml/"</span> + 序号 + <span class="hljs-string">".xhtml"</span>,
      渲染<span class="hljs-title function_">xhtml</span>(章, 序号),
    );
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"完成"</span>);
}

<span class="hljs-comment">// 开始执行</span>
<span class="hljs-keyword">const</span> [输入文件, 输出目录] = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">args</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"读"</span>, 输入文件);

<span class="hljs-keyword">const</span> 数据 = <span class="hljs-keyword">await</span> 加载<span class="hljs-title function_">txt</span>(输入文件);
<span class="hljs-comment">//console.log("data", 数据);</span>

<span class="hljs-keyword">await</span> 造<span class="hljs-title function_">epub</span>(数据, 输出目录);

<span class="hljs-comment">// txt2epub.js</span>
</code></pre>
<h3 data-id="heading-3">1.2 工作原理</h3>
<p>我们用一个简单的测试文件.</p>
<p>文件 <code>1.txt</code>:</p>
<pre><code class="hljs language-markdown" lang="markdown">(测试) 整本书 的 书名

封面 1

封面 2

<span class="hljs-section">## 第 1 章 标题 1</span>

段落 1
段落 2

<span class="hljs-section">## 第 2 章 标题 2</span>

段落 3

段落 4

TODO end
</code></pre>
<p>内容很简单, 只有 2 章, 格式类似 markdown.</p>
<hr/>
<p>然后运行上面的程序:</p>
<pre><code class="hljs language-sh" lang="sh">&gt; deno run -A txt2epub.js 1.txt out1
读 1.txt
目录 out1
  out1/mimetype
目录 out1/META-INF
  out1/META-INF/container.xml
目录 out1/OEBPS/xhtml
  out1/OEBPS/content.opf
  out1/OEBPS/toc.ncx
  out1/OEBPS/style.css
  out1/OEBPS/xhtml/0.xhtml
  out1/OEBPS/xhtml/1.xhtml
  out1/OEBPS/xhtml/2.xhtml
完成
</code></pre>
<p>运行完毕, 生成了这些文件:</p>
<pre><code class="hljs language-sh" lang="sh">&gt; find out1
out1
out1/mimetype
out1/META-INF
out1/META-INF/container.xml
out1/OEBPS
out1/OEBPS/xhtml
out1/OEBPS/xhtml/0.xhtml
out1/OEBPS/xhtml/1.xhtml
out1/OEBPS/xhtml/2.xhtml
out1/OEBPS/content.opf
out1/OEBPS/toc.ncx
out1/OEBPS/style.css
</code></pre>
<p>文件 <code>out1/mimetype</code>:</p>
<pre><code class="hljs language-txt" lang="txt">application/epub+zip
</code></pre>
<p>文件 <code>out1/META-INF/container.xml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"urn:oasis:names:tc:opendocument:xmlns:container"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">rootfiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rootfile</span>
      <span class="hljs-attr">full-path</span>=<span class="hljs-string">"OEBPS/content.opf"</span>
      <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/oebps-package+xml"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">rootfiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/content.opf</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">package</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.idpf.org/2007/opf"</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"3.0"</span>
  <span class="hljs-attr">unique-identifier</span>=<span class="hljs-string">"pub-id"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">metadata</span> <span class="hljs-attr">xmlns:dc</span>=<span class="hljs-string">"http://purl.org/dc/elements/1.1/"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:title</span>&gt;</span>(测试) 整本书 的 书名 (4) (0k)<span class="hljs-tag">&lt;/<span class="hljs-name">dc:title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span>&gt;</span>you<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"pub-id"</span>
    &gt;</span>urn:uuid:b203607a-1ebb-44db-ba21-854dd5dc57b3<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">metadata</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"ncx"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"toc.ncx"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/x-dtbncx+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"css"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"text/css"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item0"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/0.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item1"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/1.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item2"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/2.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">spine</span> <span class="hljs-attr">toc</span>=<span class="hljs-string">"ncx"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item2"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">spine</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/toc.ncx</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ncx</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.daisy.org/z3986/2005/ncx/"</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"2005-1"</span>
  <span class="hljs-attr">xml:lang</span>=<span class="hljs-string">"zh-CN"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span>
      <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:uid"</span>
      <span class="hljs-attr">content</span>=<span class="hljs-string">"urn:uuid:34deb94e-ee02-4db6-b96b-31996f4e8900"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:depth"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:totalPageCount"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"3"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">docTitle</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>(测试) 整本书 的 书名 (4) (0k)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">docTitle</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">navMap</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-0"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/0.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-1"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"2"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/1.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-2"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"3"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/2.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

  <span class="hljs-tag">&lt;/<span class="hljs-name">navMap</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ncx</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/style.css</code>:</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {

}
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/0.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>封面 1<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>封面 2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/1.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 1<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/2.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 3<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 4<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>TODO end<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<p>上面的大部分文件都是 epub 的元数据, 比如标题, 目录什么的.
<code>xhtml</code> 文件是章节内容, 每章一个.</p>
<p>然后, 把这堆文件手动压缩成 <code>zip</code> 包, 再把文件名后缀改成 <code>.epub</code>, 就完成啦 ~</p>
<p>对, epub 格式就是这么朴实无华.</p>
<h2 data-id="heading-4">2 手机阅读软件推荐 (Android F-Droid)</h2>
<p>如何安装 Termux (F-Droid) 详见文章 《在 Android 设备上写代码 (Termux, code-server)》.</p>
<p>此处推荐的 epub 阅读软件有: LxReader, Librera (F-Droid), Anx Reader</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a3ae19b276b4b468173c804f4365844~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=UolWLKN%2BLEV5v2dxEsSvQGBRwlQ%3D" alt="2-s-1.png" loading="lazy"/></p>
<p>这些软件可以从 F-Droid 下载.</p>
<p>为什么使用 F-Droid 软件呢 ? 因为 F-Droid 的规则要求, 里面的软件必须是 "完全开源" 的, 也就是不能有闭源的依赖组件, 整个软件从源代码从头编译.</p>
<p>这意味着, 最终用户不必受限于任何人, 你可以获取软件的源代码, 自己编译, 或进行修改.</p>
<h2 data-id="heading-5">3 实际测试</h2>
<p>测试手机: 型号 Redmi Note 7 pro (6G+128G) (对, 这只手机来自古老但美好的 MIUI 时代 ~ )</p>
<p>操作系统: LineageOS 23.0</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4653765d930145e2942c918ba7d8ac36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=KoKPfYtxCDhQ%2BScDWPlUGp3qYSc%3D" alt="3-a-1.png" loading="lazy"/></p>
<p>在 Termux 中安装 <code>deno</code>, 命令:</p>
<pre><code class="hljs language-sh" lang="sh">pkg install deno
</code></pre>
<p>然后就可以在手机上运行上面的程序啦 ~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f68e35e5cba94959aa9b07d6b0f61152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=emQ0nELPNU%2FVf3tSvbaIRq%2BVrO8%3D" alt="3-t-2.png" loading="lazy"/></p>
<p>这是制作好的 epub 文件:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b05d39e92741498251f1ae25cdf08d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=gzoh%2BPrkgJhyoTEKaqhrlSbGZaE%3D" alt="3-f-3.png" loading="lazy"/></p>
<p>这是窝写的一个中篇小说 (初稿).</p>
<hr/>
<p>LxReader 阅读效果:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ada37202e2aa4a41bc75d6044691cb90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=%2F%2BwnVC5XqgzU%2BRSKuUrod8AywUU%3D" alt="3-x-4.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/087937ff41af4e1981033d80668a9a9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=11Fv2k1wl%2B9PfVGtzw6WJPRo8r0%3D" alt="3-x-5.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8259992dbb394986b8921773bae382a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=T99p1%2FPPZqXcqd7WbA7s4C126bY%3D" alt="3-x-6.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4157b46715a24066be0f59c70be24540~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=s9GQOxutwswgC8Cju0p7yGNS2fs%3D" alt="3-x-7.png" loading="lazy"/></p>
<p>Librera 阅读效果:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7807c0bc0e6247f188b5b0d6a92b916c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=rDU3lLBq5sEiOnkj3DNWNrDeD0w%3D" alt="3-r-8.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1718ea26f05c414cb8bb103d5c88e19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=rMh2mq6jeDBQApvk9Slq3FdyfFc%3D" alt="3-r-9.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/336f5d103e7b4c9c96170a2006fe7c84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=kENiJX%2FE95vVpBPNw0BYHjNQg3k%3D" alt="3-r-10.png" loading="lazy"/></p>
<h2 data-id="heading-6">4 总结与展望</h2>
<p>随着 AI 语言大模型越来越强, 在 AI 的辅助下写小说就越来越容易啦 ~</p>
<p>相比被动的阅读别人写好的小说, 写出自己的小说, 是一种更快乐的娱乐方式. 加油 !</p>
<p>本文只使用了 epub 最简单的功能 (章节标题), epub 还有很多功能可以继续深入挖掘.</p>
<h2 data-id="heading-7">附录 1 "全开源" 软件体系</h2>
<ul>
<li>
<p>操作系统: Android (LineageOS, 手机), ArchLinux GNOME (PC).</p>
</li>
<li>
<p>中文输入法: 胖喵拼音 (自制)</p>
</li>
<li>
<p>AI (语言大模型): deepseek</p>
</li>
<li>
<p>txt 转 epub: 自制 (deno, Termux)</p>
</li>
<li>
<p>手机阅读软件: LxReader, Librera (F-Droid)</p>
</li>
</ul>
<p>从 操作系统 -&gt; 创作 -&gt; 阅读 的 <strong>全链条</strong> 开源软件.</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d25cfcec4f14cd4af54fea88836b518~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=YnlmYkbJsS%2BRwitC5LVl1yy0abg%3D" alt="a1-p-1.jpg" loading="lazy"/></p>
<p>如图, 使用胖喵拼音 (和 AI) 在手机上写小说 ~</p>
<hr/>
<p>本文使用 CC-BY-SA 4.0 许可发布.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何正确使用 Redis 分布式锁（完整技术分享文档）]]></title>    <link>https://juejin.cn/post/7577905525997469737</link>    <guid>https://juejin.cn/post/7577905525997469737</guid>    <pubDate>2025-11-30T06:08:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997469737" data-draft-id="7577905525997092905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何正确使用 Redis 分布式锁（完整技术分享文档）"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-11-30T06:08:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="beata"/> <meta itemprop="url" content="https://juejin.cn/user/1839900247461280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何正确使用 Redis 分布式锁（完整技术分享文档）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1839900247461280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    beata
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:08:22.000Z" title="Sun Nov 30 2025 06:08:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何正确使用 Redis 分布式锁（完整技术分享文档）</h2>
<hr/>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5" title="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">基础概念</a></li>
<li><a href="#2-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%B8%8E%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" title="#2-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%B8%8E%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">实现方案与代码实现</a>
<ul>
<li><a href="#21-set-%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0" title="#21-set-%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0">2.1 SET 命令实现</a></li>
<li><a href="#22-stringredistemplate-%E5%AE%9E%E7%8E%B0" title="#22-stringredistemplate-%E5%AE%9E%E7%8E%B0">2.2 StringRedisTemplate 实现</a></li>
<li><a href="#23-redlock-%E7%AE%97%E6%B3%95" title="#23-redlock-%E7%AE%97%E6%B3%95">2.3 Redlock 算法</a></li>
<li><a href="#24-redisson-%E6%A1%86%E6%9E%B6" title="#24-redisson-%E6%A1%86%E6%9E%B6">2.4 Redisson 框架</a></li>
<li><a href="#25-spring-boot-%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0" title="#25-spring-boot-%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0">2.5 Spring Boot 注解方式实现</a></li>
</ul>
</li>
<li><a href="#3-%E4%BC%98%E7%BC%BA%E7%82%B9%E5%AF%B9%E6%AF%94" title="#3-%E4%BC%98%E7%BC%BA%E7%82%B9%E5%AF%B9%E6%AF%94">优缺点对比</a></li>
<li><a href="#4-%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#4-%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">失效情况分析与解决方案</a></li>
<li><a href="#5-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B" title="#5-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B">最佳实践案例</a></li>
<li><a href="#6-%E6%80%BB%E7%BB%93" title="#6-%E6%80%BB%E7%BB%93">总结</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1. 基础概念</h3>
<p><strong>分布式锁</strong>用于协调多个节点对共享资源的互斥访问，常用于秒杀、抢红包、库存扣减等场景。Redis 因其高性能、原子性操作（如 <code>SET NX PX</code>）成为分布式锁的常用实现工具。</p>
<p><strong>核心要求</strong>：</p>
<ul>
<li><strong>互斥性</strong>：任意时刻只有一个客户端持有锁。</li>
<li><strong>锁超时释放</strong>：避免死锁。</li>
<li><strong>安全性</strong>：只能被持有者删除。</li>
<li><strong>高性能与高可用</strong>：低开销、支持多节点容错。</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. 实现方案与代码实现</h3>
<h4 data-id="heading-4">2.1 SET 命令实现（基础方案）</h4>
<p><strong>原理</strong>：<br/>
使用 <code>SET key value NX PX milliseconds</code> 原子命令实现加锁，解锁通过 Lua 脚本校验持有者身份。</p>
<p><strong>代码示例（Java + Jedis）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"resource_lock"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">30000</span>; <span class="hljs-comment">// 30s</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(Jedis jedis, String lockKey, String uniqueId, <span class="hljs-type">int</span> expireTime)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.set(lockKey, uniqueId, <span class="hljs-string">"NX"</span>, <span class="hljs-string">"PX"</span>, expireTime);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>.equals(result);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(Jedis jedis, String lockKey, String uniqueId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;
        jedis.eval(luaScript, <span class="hljs-number">1</span>, lockKey, uniqueId);
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">uniqueId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-keyword">if</span> (tryLock(jedis, LOCK_KEY, uniqueId, EXPIRE_TIME)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 业务逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                unlock(jedis, LOCK_KEY, uniqueId);
            }
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-5">2.2 StringRedisTemplate 实现（Spring Boot 推荐）</h4>
<p><strong>原理</strong>：<br/>
使用 Spring Data Redis 提供的 <code>StringRedisTemplate</code> 实现加锁和解锁，结合 Lua 脚本确保安全性。</p>
<p><strong>代码示例（Spring Boot）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLockService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate redisTemplate;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisLockService</span><span class="hljs-params">(StringRedisTemplate redisTemplate)</span> {
        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">uniqueId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(
            lockKey, uniqueId, expireTime, TimeUnit.MILLISECONDS);
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String lockKey, String uniqueId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;
        DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class);
        redisTemplate.execute(redisScript, Collections.singletonList(lockKey), uniqueId);
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processResource</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"resource_lock"</span>;
        <span class="hljs-keyword">if</span> (tryLock(lockKey, <span class="hljs-number">30000</span>)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 业务逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                unlock(lockKey, redisTemplate.opsForValue().get(lockKey));
            }
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-6">2.3 Redlock 算法（多实例方案）</h4>
<p><strong>原理</strong>：<br/>
通过多个独立 Redis 实例实现高可用锁。</p>
<p><strong>代码示例（伪代码）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">acquire_redlock</span>(<span class="hljs-params">lock_name, expire_time</span>):
    instances = [redis.Redis(host=<span class="hljs-string">f'redis<span class="hljs-subst">{i}</span>'</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]
    success_count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> instance <span class="hljs-keyword">in</span> instances:
        <span class="hljs-keyword">if</span> instance.<span class="hljs-built_in">set</span>(lock_name, <span class="hljs-string">"locked"</span>, nx=<span class="hljs-literal">True</span>, px=expire_time):
            success_count += <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> success_count &gt;= <span class="hljs-number">3</span>  <span class="hljs-comment"># 多数成功</span>
</code></pre>
<hr/>
<h4 data-id="heading-7">2.4 Redisson 框架（推荐方案）</h4>
<p><strong>步骤</strong>：</p>
<ol>
<li><strong>添加 Maven 依赖</strong>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.27.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li><strong>配置 Redis（application.yml）</strong>：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">2000ms</span>
</code></pre>
<ol start="3">
<li><strong>使用 RLock</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">"order_lock:"</span> + orderId);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">30</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取锁失败"</span>);
            }
            <span class="hljs-comment">// 业务逻辑</span>
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-8">2.5 Spring Boot 注解方式实现</h4>
<h5 data-id="heading-9">2.5.1 实现原理</h5>
<p>通过 <strong>自定义注解 + AOP 切面</strong> 实现分布式锁的自动加锁/解锁，结合 Redisson 的 <code>RLock</code> 提供可重入锁、自动续期等功能。</p>
<hr/>
<h5 data-id="heading-10">2.5.2 实现步骤</h5>
<h6 data-id="heading-11">1. 定义自定义注解</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.annotation.*;

<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DistributedLock {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>; <span class="hljs-comment">// 锁 key 的 SpEL 表达式（如 #userId）</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">waitTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">30</span>; <span class="hljs-comment">// 等待加锁时间（秒）</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">leaseTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">30</span>; <span class="hljs-comment">// 锁持有时间（秒）</span>
}
</code></pre>
<hr/>
<h6 data-id="heading-12">2. 实现 AOP 切面</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.expression.ExpressionParser;
<span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;
<span class="hljs-keyword">import</span> org.springframework.expression.spel.support.StandardEvaluationContext;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

    <span class="hljs-meta">@Around("@annotation(distributedLock)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint pjp, DistributedLock distributedLock)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 解析 SpEL 表达式获取锁 key</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> parseSpEL(distributedLock.value(), pjp.getArgs());
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试加锁</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(distributedLock.waitTime(), distributedLock.leaseTime(), TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取分布式锁超时"</span>);
            }
            <span class="hljs-keyword">return</span> pjp.proceed(); <span class="hljs-comment">// 执行目标方法</span>
        } <span class="hljs-keyword">finally</span> {
            lock.unlock(); <span class="hljs-comment">// 释放锁</span>
        }
    }

    <span class="hljs-comment">// 解析 SpEL 表达式</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">parseSpEL</span><span class="hljs-params">(String expression, Object[] args)</span> {
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) {
            context.setVariable(<span class="hljs-string">"arg"</span> + i, args[i]);
        }
        <span class="hljs-keyword">return</span> parser.parseExpression(expression).getValue(context, String.class);
    }
}
</code></pre>
<hr/>
<h6 data-id="heading-13">3. 配置 Spring Boot 启用 AOP</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAspectJAutoProxy(exposeProxy = true)</span> <span class="hljs-comment">// 必须启用 exposeProxy</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopConfig</span> {
}
</code></pre>
<hr/>
<h6 data-id="heading-14">4. 使用示例</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId", waitTime = 10, leaseTime = 30)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑（无需手动加锁）</span>
    }
}
</code></pre>
<hr/>
<h5 data-id="heading-15">2.5.3 注解失效的常见场景</h5>



































<table><thead><tr><th>场景</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>1. 同类方法调用</strong></td><td>AOP 代理失效（Spring 无法拦截内部调用）</td><td>使用 <code>((OrderService) AopContext.currentProxy()).createOrder(userId)</code></td></tr><tr><td><strong>2. 未启用 AOP</strong></td><td>未配置 <code>@EnableAspectJAutoProxy</code> 或未扫描切面类</td><td>添加 <code>@EnableAspectJAutoProxy</code> 并确保切面类被 Spring 扫描</td></tr><tr><td><strong>3. 事务传播行为不匹配</strong></td><td><code>@Transactional</code> 方法嵌套调用导致锁提前释放</td><td>为分布式锁方法单独开启新事务（<code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code>）</td></tr><tr><td><strong>4. 异常未捕获</strong></td><td>方法抛出异常后未正确释放锁</td><td>在 <code>finally</code> 块中释放锁（Redisson 已自动处理）</td></tr><tr><td><strong>5. SpEL 表达式错误</strong></td><td><code>value</code> 中的 SpEL 表达式解析失败（如 <code>#userId</code> 不存在）</td><td>检查方法参数名是否匹配，或使用 <code>args[0]</code> 代替 <code>#userId</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">3. 优缺点对比</h3>



























































<table><thead><tr><th>方案</th><th>互斥性</th><th>自动续期</th><th>可重入</th><th>高可用</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>SET 命令</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>⭐⭐⭐⭐⭐</td><td>低并发、简单业务</td></tr><tr><td><strong>StringRedisTemplate</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>⭐⭐⭐⭐</td><td>Spring Boot 项目</td></tr><tr><td><strong>Redlock</strong></td><td>✅</td><td>❌</td><td>❌</td><td>✅</td><td>⭐⭐⭐</td><td>高并发、强一致性要求</td></tr><tr><td><strong>Redisson</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>⭐⭐⭐⭐</td><td>复杂业务、Java 项目</td></tr><tr><td><strong>注解方式</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>⭐⭐⭐⭐</td><td>快速开发、Spring Boot</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">4. 失效情况分析与解决方案</h3>
<h4 data-id="heading-18">4.1 死锁（Lock Not Released）</h4>
<ul>
<li><strong>原因</strong>：客户端异常崩溃未释放锁。</li>
<li><strong>解决方案</strong>：设置合理的 TTL（如 30s），或使用 Redisson 的 Watchdog 自动续期。</li>
</ul>
<h4 data-id="heading-19">4.2 误删他人锁（Wrong Unlock）</h4>
<ul>
<li><strong>原因</strong>：未校验锁持有者身份直接 <code>DEL</code>。</li>
<li><strong>解决方案</strong>：加锁时写入唯一标识，解锁时用 Lua 脚本校验。</li>
</ul>
<h4 data-id="heading-20">4.3 主从切换丢锁</h4>
<ul>
<li><strong>原因</strong>：主节点宕机后从节点未同步锁信息。</li>
<li><strong>解决方案</strong>：使用 Redlock 或改用 CP 系统（如 ZooKeeper）。</li>
</ul>
<h4 data-id="heading-21">4.4 业务执行时间 &gt; TTL</h4>
<ul>
<li><strong>原因</strong>：锁自动释放导致重复执行。</li>
<li><strong>解决方案</strong>：引入 Watchdog 自动续期（Redisson 默认支持）。</li>
</ul>
<h4 data-id="heading-22">4.5 注解失效的典型场景</h4>
<h5 data-id="heading-23">场景 1：同类方法调用导致锁失效</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchCreateOrders</span><span class="hljs-params">(String userId)</span> {
        createOrder(userId); <span class="hljs-comment">// ❌ 同类调用，AOP 代理失效</span>
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchCreateOrders</span><span class="hljs-params">(String userId)</span> {
    ((OrderService) AopContext.currentProxy()).createOrder(userId); <span class="hljs-comment">// ✅ 通过代理调用</span>
}
</code></pre>
<h5 data-id="heading-24">场景 2：事务传播行为导致锁提前释放</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId")</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(String userId)</span> {
        createOrder(userId); <span class="hljs-comment">// ❌ 同事务中调用，锁可能提前释放</span>
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
    <span class="hljs-comment">// 独立事务</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-25">5. 最佳实践案例</h3>
<h4 data-id="heading-26">场景：秒杀系统扣库存（Redisson + Spring Boot）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">seckill</span><span class="hljs-params">(String productId, String userId)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">"seckill_lock:"</span> + productId);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">3</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"系统繁忙，请稍后"</span>;
            }
            <span class="hljs-comment">// 双重检查库存</span>
            <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> stockService.getStock(productId);
            <span class="hljs-keyword">if</span> (stock &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"库存不足"</span>;
            }
            stockService.deduct(productId);
            createOrder(productId, userId);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"秒杀成功"</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"秒杀失败"</span>;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-27">6. 总结</h3>
<ul>
<li><strong>优先选择 Redisson</strong>：内置自动续期、可重入、高可用，适合复杂业务。</li>
<li><strong>Spring Boot 项目推荐 StringRedisTemplate</strong>：简化配置，兼容性强。</li>
<li><strong>注解方式实现</strong>：通过 AOP 切面 + Redisson 提供开箱即用的分布式锁能力，简化代码逻辑。</li>
<li><strong>避免手写锁</strong>：非原子操作、未校验持有者等常见误区易导致严重问题。</li>
<li><strong>锁粒度要细</strong>：如按商品 ID、用户 ID 维度加锁，提升并发度。</li>
<li><strong>结合幂等性设计</strong>：即使锁失效，业务逻辑也能通过数据库约束、唯一索引兜底。</li>
</ul>
<blockquote>
<p><strong>一句话原则</strong>：<br/>
<strong>“能不用锁就不用锁，能用数据库约束就不用分布式锁。”</strong></p>
</blockquote>
<hr/>
<blockquote>
<p>作者：Beata - 后端服务架构自由人<br/>
最后更新：2025 年 11 月  30 日
版权声明：本文可自由转载，注明出处即可。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑]]></title>    <link>https://juejin.cn/post/7577691061034008622</link>    <guid>https://juejin.cn/post/7577691061034008622</guid>    <pubDate>2025-11-30T06:21:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034008622" data-draft-id="7577718777482002470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-11-30T06:21:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是2的10次方啊"/> <meta itemprop="url" content="https://juejin.cn/user/987803531871175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/987803531871175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是2的10次方啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:21:06.000Z" title="Sun Nov 30 2025 06:21:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑</h2>
<blockquote>
<p><strong>MySQL索引系列文章：</strong></p>
<ul>
<li>📖 <a href="https://juejin.cn/post/7564977973259976730" target="_blank" title="https://juejin.cn/post/7564977973259976730">基础篇：图解MySQL索引：从二叉树到B+树的演进之路</a></li>
<li>📖 <a href="https://juejin.cn/post/7567257202194776091" target="_blank" title="https://juejin.cn/post/7567257202194776091">进阶篇：MySQL索引：SQL性能分析工具详解</a></li>
<li>📖 <a href="https://juejin.cn/post/7570271574348038153" target="_blank" title="https://juejin.cn/post/7570271574348038153">实战篇：MySQL索引优化实战：原则速查与踩坑案例</a></li>
<li>📖 <a href="#" title="#">设计原则篇：MySQL索引设计原则：从理论到实践的完整指南</a> （本文）</li>
</ul>
</blockquote>
<p>掌握了索引的创建和使用技巧后，如何设计出高效、合理的索引？本文将从表级别、字段级别、索引级别三个维度，系统梳理7条核心设计原则，并结合真实业务场景，帮你避免" 索引建了但效果不佳"的常见陷阱。</p>
<p>记得刚工作那会儿，我负责优化一个订单查询接口。明明已经给<code>user_id</code> 建了索引，但查询还是慢得要命。我百思不得其解，直到DBA老哥看了一眼执行计划，淡淡地说："你这索引建得不对，字段顺序有问题。"</p>
<p>那一刻我才明白，<strong>索引不是建了就完事了，设计才是关键</strong>。</p>
<p>你是否也遇到过这样的困惑：</p>
<ul>
<li>明明创建了索引，查询依然很慢？</li>
<li>索引建得太多，写入性能反而下降？</li>
<li>不知道什么时候该建索引，什么时候不该建？</li>
</ul>
<p>索引设计就像盖房子，不是砖头越多越好，而是要<strong>在合适的地方用合适的材料</strong>。本文将从<strong>表→字段→索引</strong> 三个层次，分享7条实战中总结的设计原则，帮你建立完整的索引设计思路。</p>
<hr/>
<h3 data-id="heading-1">一、表级别：何时建立索引？</h3>
<h4 data-id="heading-2">原则1：针对于数据量较大，且查询比较频繁的表建立索引</h4>
<p>索引的收益与表的数据量和查询频率成正比。这个道理很简单：<strong>数据量越大，索引的价值越明显；查询越频繁，索引的回报越高</strong>。</p>
<h5 data-id="heading-3">为什么数据量要"较大"？</h5>
<p>索引不是免费的午餐，它需要占用存储空间，每次写入还要维护索引结构。对于小表（比如只有几条记录的配置表、字典表），全表扫描的成本可能比索引查找还低：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：用户状态字典表（只有5条记录）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_status_dict (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    status_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);

<span class="hljs-comment">-- 这种场景下，建索引反而增加开销</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_name <span class="hljs-keyword">ON</span> user_status_dict(status_name); <span class="hljs-comment">-- ❌ 不推荐</span>

<span class="hljs-comment">-- 对于小表，直接全表扫描即可</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_status_dict <span class="hljs-keyword">WHERE</span> status_name <span class="hljs-operator">=</span> <span class="hljs-string">'ACTIVE'</span>;
</code></pre>
<p><strong>经验值</strong>：一般表数据量超过<strong>1000行</strong>，才考虑建立索引。但这个数字不是绝对的，还要看查询频率和业务特点。比如一个只有500行的表，如果每秒查询100次，那建索引也是值得的。</p>
<h5 data-id="heading-4">查询频率的重要性</h5>
<p>即使是大表，如果某个字段极少被查询，建立索引也不划算。我见过有人给一个千万级大表的<code>internal_remark</code> 字段建索引，结果这个字段一个月才查一次，完全是浪费：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表（1000万条记录）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    created_at DATETIME,
    <span class="hljs-comment">-- 某个业务字段，但只在后台统计时偶尔查询</span>
    internal_remark TEXT
);

<span class="hljs-comment">-- ❌ 不推荐：查询频率低，但维护成本高</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_internal_remark <span class="hljs-keyword">ON</span> orders(internal_remark);

<span class="hljs-comment">-- ✅ 推荐：高频查询字段建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_created <span class="hljs-keyword">ON</span> orders(user_id, created_at);
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>通过慢查询日志统计SQL执行频次，优先为高频SQL涉及的字段建立索引</li>
<li>对于低频查询场景，可以考虑用<code>LIMIT</code>限制查询范围，或者走异步查询+缓存</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、字段级别：哪些字段适合建索引？</h3>
<h4 data-id="heading-6">原则2：针对于常作为查询条件（WHERE）、排序（ORDER BY）、分组（GROUP BY）操作的字段建立索引</h4>
<p>索引主要有三大应用场景：<strong>过滤（WHERE）、排序（ORDER BY）、分组（GROUP BY）</strong> 。记住这三个场景，基本就能判断哪些字段需要建索引了。</p>
<h5 data-id="heading-7">WHERE 条件字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_profile (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 高频WHERE条件字段建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_email <span class="hljs-keyword">ON</span> user_profile(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> user_profile(phone);

<span class="hljs-comment">-- 查询示例</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_profile <span class="hljs-keyword">WHERE</span> email <span class="hljs-operator">=</span> <span class="hljs-string">'user@example.com'</span>; <span class="hljs-comment">-- 命中索引</span>
</code></pre>
<h5 data-id="heading-8">ORDER BY 排序字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 商品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    sales_count <span class="hljs-type">INT</span>,
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 为排序字段建立索引，避免filesort</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_price <span class="hljs-keyword">ON</span> products(price);
<span class="hljs-keyword">CREATE</span> INDEX idx_sales_created <span class="hljs-keyword">ON</span> products(sales_count <span class="hljs-keyword">DESC</span>, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- 查询示例：避免临时排序</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price <span class="hljs-keyword">ASC</span> LIMIT <span class="hljs-number">20</span>; <span class="hljs-comment">-- 可以利用索引顺序</span>
</code></pre>
<p><strong>注意</strong>：如果<code>ORDER BY</code>和<code>WHERE</code>条件结合，需要设计联合索引：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- ✅ 联合索引设计：<span class="hljs-keyword">WHERE</span>在前，<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>在后
CREATE INDEX idx_category_price <span class="hljs-keyword">ON</span> products(category_id, price);

-- 这个查询可以利用索引同时完成过滤和排序
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products 
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">100</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price ASC 
LIMIT <span class="hljs-number">20</span>;
</code></pre>
<h5 data-id="heading-9">GROUP BY 分组字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 为GROUP BY字段建立索引，避免临时表排序</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> orders(status, created_at);

<span class="hljs-comment">-- 查询示例：按状态分组统计每日订单数</span>
<span class="hljs-keyword">SELECT</span> status, <span class="hljs-type">DATE</span>(created_at) <span class="hljs-keyword">as</span> order_date, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status, <span class="hljs-type">DATE</span>(created_at); 
<span class="hljs-comment">-- 如果设计合理，可以利用索引避免filesort</span>
</code></pre>
<p><strong>踩坑案例</strong>：<code>ORDER BY</code>和<code>GROUP BY</code>混合使用时，需要仔细设计索引顺序：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- 订单表索引设计
CREATE INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at);

-- ❌ 问题查询：<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>和<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>顺序与索引不完全匹配
<span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at DESC; -- created_at在<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>之后，可能导致filesort

-- ✅ 优化方案<span class="hljs-number">1</span>：调整索引顺序或SQL写法
<span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> status; -- 与<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>一致，可以利用索引

-- ✅ 优化方案<span class="hljs-number">2</span>：使用子查询分离逻辑
<span class="hljs-keyword">SELECT</span> t.* <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
) t
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_count DESC; -- 在子查询结果上排序
</code></pre>
<hr/>
<h4 data-id="heading-10">原则3：尽量选择区分度高的列建立索引，尽量建立唯一索引，区分度越高，使用索引的效率越高</h4>
<p>索引的选择性（Cardinality）决定了索引的查找效率。简单说，<strong>区分度越高，索引效果越好</strong>。</p>
<h5 data-id="heading-11">什么是区分度？</h5>
<p>区分度 = 不重复的索引值数量 / 表中的总记录数</p>
<ul>
<li><strong>区分度越高</strong>（接近1）：索引效果越好，如主键、唯一字段</li>
<li><strong>区分度越低</strong>（接近0）：索引效果越差，如性别字段、状态字段</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,  <span class="hljs-comment">-- 区分度：100%</span>
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span>,    <span class="hljs-comment">-- 区分度：100%</span>
    gender TINYINT,               <span class="hljs-comment">-- 区分度：~2%（只有男/女）</span>
    status TINYINT                <span class="hljs-comment">-- 区分度：~5%（只有几个状态值）</span>
);

<span class="hljs-comment">-- ✅ 高区分度字段：建立唯一索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_username <span class="hljs-keyword">ON</span> users(username);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_email <span class="hljs-keyword">ON</span> users(email);

<span class="hljs-comment">-- ❌ 低区分度字段：不建议单独建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_gender <span class="hljs-keyword">ON</span> users(gender); <span class="hljs-comment">-- 不推荐</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> users(status); <span class="hljs-comment">-- 不推荐</span>

<span class="hljs-comment">-- ✅ 但如果需要与其他字段组合查询，可以建立联合索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> users(status, created_at);
</code></pre>
<h5 data-id="heading-12">如何计算区分度？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 计算某个字段的区分度</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> status) <span class="hljs-keyword">as</span> distinct_count,  <span class="hljs-comment">-- 不重复值数量</span>
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_count,                    <span class="hljs-comment">-- 总记录数</span>
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> status) <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span> <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> selectivity  <span class="hljs-comment">-- 区分度</span>
<span class="hljs-keyword">FROM</span> orders;

<span class="hljs-comment">-- 输出示例：</span>
<span class="hljs-comment">-- distinct_count: 5</span>
<span class="hljs-comment">-- total_count: 1000000</span>
<span class="hljs-comment">-- selectivity: 0.000005  (区分度极低，不建议单独建索引)</span>
</code></pre>
<p><strong>经验值</strong>（仅供参考）：</p>
<ul>
<li><strong>区分度 &gt; 30%</strong> ：适合建立单列索引</li>
<li><strong>区分度 10% - 30%</strong> ：建议建立联合索引</li>
<li><strong>区分度 &lt; 10%</strong> ：不建议单独建立索引，除非与其他字段组合</li>
</ul>
<h5 data-id="heading-13">唯一索引的优势</h5>
<p>唯一索引不仅能保证数据唯一性，还能带来额外的性能优化：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 唯一索引：查找时可以立即停止（找到一条即停止）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_order_no <span class="hljs-keyword">ON</span> orders(order_no);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> <span class="hljs-string">'ORDER20251109001'</span>; <span class="hljs-comment">-- 找到即停止</span>

<span class="hljs-comment">-- 普通索引：需要继续查找是否有重复值（虽然已经找到目标）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>; <span class="hljs-comment">-- 需要扫描所有匹配行</span>
</code></pre>
<hr/>
<h4 data-id="heading-14">原则4：如果是字符串类型的字段，字段的长度较长，可以针对于字段的特点，建立前缀索引</h4>
<p>长字符串字段如果建立完整索引，占用空间会很大。比如一个<code>VARCHAR(1000)</code>的URL字段，如果完整索引，每个索引项可能占用1000字节。这时候可以用前缀索引， <strong>只索引前N个字符，在查询性能和存储成本之间找平衡</strong>。</p>
<h5 data-id="heading-15">为什么需要前缀索引？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：文章表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> articles (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),      <span class="hljs-comment">-- 标题可能很长</span>
    content TEXT,            <span class="hljs-comment">-- 内容很长，不适合建索引</span>
    url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">1000</span>)        <span class="hljs-comment">-- URL很长</span>
);

<span class="hljs-comment">-- ❌ 完整索引：占用空间大</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url <span class="hljs-keyword">ON</span> articles(url); <span class="hljs-comment">-- 每个索引项可能占用1000字节</span>

<span class="hljs-comment">-- ✅ 前缀索引：节省空间</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url_prefix <span class="hljs-keyword">ON</span> articles(url(<span class="hljs-number">50</span>)); <span class="hljs-comment">-- 只索引前50个字符</span>
</code></pre>
<h5 data-id="heading-16">如何确定前缀长度？</h5>
<p>通过计算不同前缀长度的区分度，选择最合适的长度：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 方法1：逐步测试不同前缀长度的区分度</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">10</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_10_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">20</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_20_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">50</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_50_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">100</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_100_selectivity
<span class="hljs-keyword">FROM</span> articles;

<span class="hljs-comment">-- 输出示例：</span>
<span class="hljs-comment">-- prefix_10_selectivity: 0.8500  (85%的区分度)</span>
<span class="hljs-comment">-- prefix_20_selectivity: 0.9500  (95%的区分度)</span>
<span class="hljs-comment">-- prefix_50_selectivity: 0.9950  (99.5%的区分度)</span>
<span class="hljs-comment">-- prefix_100_selectivity: 0.9990 (99.9%的区分度，但空间开销大)</span>

<span class="hljs-comment">-- 根据业务需求选择：如果95%的区分度已足够，选择前缀长度20</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url_prefix <span class="hljs-keyword">ON</span> articles(url(<span class="hljs-number">20</span>));
</code></pre>
<h5 data-id="heading-17">前缀索引的局限性</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 前缀索引无法用于ORDER BY和GROUP BY</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> url; <span class="hljs-comment">-- 无法利用前缀索引完成排序</span>

<span class="hljs-comment">-- ❌ 前缀索引无法用于覆盖索引</span>
<span class="hljs-comment">-- 如果查询需要完整的url值，仍然需要回表</span>
<span class="hljs-keyword">SELECT</span> url <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> url <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'https://example.com%'</span>;
<span class="hljs-comment">-- 即使命中前缀索引，由于索引只存储了前N个字符，仍需回表获取完整url</span>
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>前缀长度选择：区分度达到90%以上即可，不用追求100%</li>
<li>常见场景：邮箱、URL、身份证号等长字符串字段</li>
<li>注意权衡：查询性能 vs 存储空间 vs 索引维护成本，没有标准答案，看业务需求</li>
</ul>
<hr/>
<h3 data-id="heading-18">三、索引级别：如何设计索引结构？</h3>
<h4 data-id="heading-19">原则5：尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率</h4>
<p>联合索引可以同时满足多个查询条件，还能实现覆盖索引优化。<strong>一个联合索引往往能顶多个单列索引</strong>，既省空间又提性能。</p>
<h5 data-id="heading-20">联合索引 vs 多个单列索引</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    created_at DATETIME,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
);

<span class="hljs-comment">-- ❌ 方案1：多个单列索引（不推荐）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> orders(status);
<span class="hljs-keyword">CREATE</span> INDEX idx_created_at <span class="hljs-keyword">ON</span> orders(created_at);

<span class="hljs-comment">-- 问题1：存储空间大（每个索引都是独立的B+树）</span>
<span class="hljs-comment">-- 问题2：查询多条件时，可能只使用其中一个索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;
<span class="hljs-comment">-- 优化器可能只选择其中一个索引，其他条件需要回表过滤</span>

<span class="hljs-comment">-- ✅ 方案2：联合索引（推荐）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at);

<span class="hljs-comment">-- 优势1：一次索引查找可以满足多个条件</span>
<span class="hljs-comment">-- 优势2：如果查询字段都在索引中，可以实现覆盖索引</span>
<span class="hljs-keyword">SELECT</span> user_id, status, created_at 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- Extra: Using index（覆盖索引，无需回表）</span>
</code></pre>
<h5 data-id="heading-21">联合索引的覆盖索引优势</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户行为表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_actions (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    action_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    created_at DATETIME,
    action_detail TEXT  <span class="hljs-comment">-- 大字段，存储在数据页</span>
);

<span class="hljs-comment">-- 联合索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_action_created <span class="hljs-keyword">ON</span> user_actions(user_id, action_type, created_at);

<span class="hljs-comment">-- ✅ 覆盖索引查询：无需回表</span>
<span class="hljs-keyword">SELECT</span> user_id, action_type, created_at 
<span class="hljs-keyword">FROM</span> user_actions 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> action_type <span class="hljs-operator">=</span> <span class="hljs-string">'LOGIN'</span>;
<span class="hljs-comment">-- Explain结果：Extra = "Using index"</span>

<span class="hljs-comment">-- ❌ 非覆盖索引查询：需要回表</span>
<span class="hljs-keyword">SELECT</span> user_id, action_type, created_at, action_detail 
<span class="hljs-keyword">FROM</span> user_actions 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> action_type <span class="hljs-operator">=</span> <span class="hljs-string">'LOGIN'</span>;
<span class="hljs-comment">-- Explain结果：Extra = "Using index condition"（需要回表读取action_detail）</span>
</code></pre>
<p><strong>性能对比</strong>：</p>





























<table><thead><tr><th>场景</th><th>单列索引</th><th>联合索引（覆盖）</th><th>性能提升</th></tr></thead><tbody><tr><td>存储空间</td><td>3个独立索引</td><td>1个联合索引</td><td>节省约60%空间</td></tr><tr><td>查询耗时</td><td>回表读取</td><td>无需回表</td><td>减少50-80%IO</td></tr><tr><td>索引维护</td><td>3次维护</td><td>1次维护</td><td>写入性能提升</td></tr></tbody></table>
<h5 data-id="heading-22">联合索引的设计顺序</h5>
<p>联合索引的列顺序非常重要，遵循<strong>最左前缀原则</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 索引：idx_user_status_created (user_id, status, created_at)</span>

<span class="hljs-comment">-- ✅ 可以利用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;

<span class="hljs-comment">-- ❌ 无法利用索引（跳过最左列）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;

<span class="hljs-comment">-- ⚠️ 部分利用索引（只能用到user_id）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;
</code></pre>
<p><strong>设计原则</strong>：</p>
<ol>
<li><strong>WHERE条件频率</strong>：将最常作为查询条件的列放在最前面</li>
<li><strong>选择性高低</strong>：将区分度高的列放在前面</li>
<li><strong>等值 vs 范围</strong>：等值查询列在前，范围查询列在后</li>
<li><strong>排序需求</strong>：如果需要<code>ORDER BY</code>，将排序字段放在索引末尾</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 实战案例：设计一个电商订单查询索引</span>

<span class="hljs-comment">-- 查询场景1：根据用户ID查询（90%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 查询场景2：根据用户ID和状态查询（8%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;

<span class="hljs-comment">-- 查询场景3：根据用户ID和日期范围查询（2%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2025-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2025-01-31'</span>;

<span class="hljs-comment">-- ✅ 推荐索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- 理由：</span>
<span class="hljs-comment">-- 1. user_id 放在最前面（最高频查询条件）</span>
<span class="hljs-comment">-- 2. status 放在中间（选择性较高，且常与user_id组合查询）</span>
<span class="hljs-comment">-- 3. created_at 放在最后（支持范围查询和排序，DESC匹配业务需求）</span>
</code></pre>
<hr/>
<h4 data-id="heading-23">原则6：要控制索引的数量，索引并不是多多益善，索引越多，维护索引结构的代价也就越大，会影响增删改的效率</h4>
<p>索引是一把双刃剑。<strong>建多了，查询快但写入慢；建少了，写入快但查询慢</strong>。关键是要找到平衡点。</p>
<h5 data-id="heading-24">索引对写入性能的影响</h5>
<p>每次<code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code>操作，都需要维护相关索引：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span>,
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    status TINYINT,
    created_at DATETIME,
    updated_at DATETIME
);

<span class="hljs-comment">-- ❌ 过度索引：为每个字段都建立索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_username <span class="hljs-keyword">ON</span> users(username);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_email <span class="hljs-keyword">ON</span> users(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);
<span class="hljs-keyword">CREATE</span> INDEX idx_age <span class="hljs-keyword">ON</span> users(age);
<span class="hljs-keyword">CREATE</span> INDEX idx_city <span class="hljs-keyword">ON</span> users(city);
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> users(status);
<span class="hljs-keyword">CREATE</span> INDEX idx_created <span class="hljs-keyword">ON</span> users(created_at);
<span class="hljs-keyword">CREATE</span> INDEX idx_updated <span class="hljs-keyword">ON</span> users(updated_at);
<span class="hljs-comment">-- 总共8个索引（包括主键）</span>

<span class="hljs-comment">-- 写入性能测试</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (username, email, phone, age, city, status) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'user1'</span>, <span class="hljs-string">'user1@example.com'</span>, <span class="hljs-string">'13800138000'</span>, <span class="hljs-number">25</span>, <span class="hljs-string">'Beijing'</span>, <span class="hljs-number">1</span>);
<span class="hljs-comment">-- 需要维护：主键索引 + 8个二级索引 = 9次索引更新</span>
<span class="hljs-comment">-- 写入耗时：~15ms</span>
</code></pre>
<p><strong>性能影响分析</strong>：</p>








































<table><thead><tr><th>索引数量</th><th>INSERT耗时</th><th>UPDATE耗时</th><th>DELETE耗时</th><th>索引维护成本</th></tr></thead><tbody><tr><td>1个（主键）</td><td>2ms</td><td>2ms</td><td>2ms</td><td>低</td></tr><tr><td>3个索引</td><td>5ms</td><td>6ms</td><td>5ms</td><td>中</td></tr><tr><td>5个索引</td><td>10ms</td><td>12ms</td><td>10ms</td><td>中高</td></tr><tr><td>8个索引</td><td>15ms</td><td>18ms</td><td>15ms</td><td>高</td></tr></tbody></table>
<h5 data-id="heading-25">如何控制索引数量？</h5>
<p><strong>策略1：合并单列索引为联合索引</strong></p>
<pre><code class="hljs language-scss" lang="scss">-- ❌ 不推荐：多个单列索引
CREATE INDEX idx_user_id ON <span class="hljs-built_in">orders</span>(user_id);
CREATE INDEX idx_status ON <span class="hljs-built_in">orders</span>(status);
CREATE INDEX idx_created_at ON <span class="hljs-built_in">orders</span>(created_at);

-- ✅ 推荐：合并为联合索引（如果经常组合查询）
CREATE INDEX idx_user_status_created ON <span class="hljs-built_in">orders</span>(user_id, status, created_at);
</code></pre>
<p><strong>策略2：删除低频使用的索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询索引使用情况（MySQL 5.7+）</span>
<span class="hljs-keyword">SELECT</span> 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    INDEX_NAME,
    COUNT_FETCH,
    COUNT_INSERT,
    COUNT_UPDATE,
    COUNT_DELETE
<span class="hljs-keyword">FROM</span> performance_schema.table_io_waits_summary_by_index_usage
<span class="hljs-keyword">WHERE</span> OBJECT_SCHEMA <span class="hljs-operator">=</span> <span class="hljs-string">'your_database'</span>
  <span class="hljs-keyword">AND</span> OBJECT_NAME <span class="hljs-operator">=</span> <span class="hljs-string">'orders'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_FETCH <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 如果某个索引的COUNT_FETCH为0或很小，考虑删除</span>
<span class="hljs-comment">-- 注意：需要观察一段时间，避免删除季节性查询使用的索引</span>
</code></pre>
<p><strong>策略3：为不同业务场景设计不同索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表：同时支持C端用户查询和B端运营查询</span>

<span class="hljs-comment">-- C端查询场景（高频）：用户查看自己的订单</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- B端查询场景（低频）：运营按状态查询所有订单</span>
<span class="hljs-comment">-- 如果频率不高，可以不建索引，或使用其他优化手段（如分区表、ES等）</span>
<span class="hljs-comment">-- 如果必须建，考虑建立单独的索引，但需要评估写入性能影响</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> orders(status, created_at <span class="hljs-keyword">DESC</span>);
</code></pre>
<p><strong>经验值</strong>（仅供参考）：</p>
<ul>
<li><strong>单表索引数量控制在5-7个以内</strong>，更容易管理和维护</li>
<li><strong>核心业务表</strong>：可以适当放宽到8-10个，但需要严格监控写入性能</li>
<li><strong>配置表/日志表</strong>：建议不超过3个索引，毕竟写入频率高</li>
</ul>
<h5 data-id="heading-26">索引维护成本的量化</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 监控索引维护成本</span>
<span class="hljs-comment">-- 1. 查看表的总索引大小</span>
<span class="hljs-keyword">SELECT</span> 
    table_name,
    ROUND(<span class="hljs-built_in">SUM</span>(index_length) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> index_size_mb,
    ROUND(<span class="hljs-built_in">SUM</span>(data_length) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> data_size_mb,
    ROUND(<span class="hljs-built_in">SUM</span>(index_length) <span class="hljs-operator">/</span> <span class="hljs-built_in">SUM</span>(data_length) <span class="hljs-operator">*</span> <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> index_ratio_percent
<span class="hljs-keyword">FROM</span> information_schema.tables
<span class="hljs-keyword">WHERE</span> table_schema <span class="hljs-operator">=</span> <span class="hljs-string">'your_database'</span>
  <span class="hljs-keyword">AND</span> table_name <span class="hljs-operator">=</span> <span class="hljs-string">'orders'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> table_name;

<span class="hljs-comment">-- 如果index_ratio_percent &gt; 50%，说明索引占用空间过大，需要优化</span>

<span class="hljs-comment">-- 2. 监控写入性能</span>
<span class="hljs-comment">-- 通过慢查询日志或performance_schema监控INSERT/UPDATE/DELETE的耗时</span>
</code></pre>
<hr/>
<h4 data-id="heading-27">原则7：如果索引列不能存储NULL值，请在创建表时使用NOT NULL约束它。当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询</h4>
<p><code>NOT NULL</code>约束不仅能保证数据完整性，还能帮助优化器做出更好的索引选择决策。**优化器知道字段不会有NULL值，就能更准确地估算查询成本，选择最优索引 **。</p>
<h5 data-id="heading-28">NULL值对索引的影响</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 允许NULL值的索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)  <span class="hljs-comment">-- 允许NULL</span>
);

<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);

<span class="hljs-comment">-- 问题1：NULL值在索引中的存储</span>
<span class="hljs-comment">-- B+树索引中，NULL值通常会被特殊处理，可能影响索引的紧凑性</span>

<span class="hljs-comment">-- 问题2：查询时需要额外判断NULL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'13800138000'</span>;
<span class="hljs-comment">-- 如果phone字段允许NULL，查询计划可能需要考虑NULL值的情况</span>

<span class="hljs-comment">-- 问题3：统计信息可能不够准确</span>
<span class="hljs-comment">-- NULL值的存在可能影响索引的选择性统计，导致优化器选择错误的索引</span>
</code></pre>
<h5 data-id="heading-29">NOT NULL的优化优势</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 使用NOT NULL约束</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 明确不允许NULL</span>
    age <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    status TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>
);

<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);
<span class="hljs-keyword">CREATE</span> INDEX idx_status_age <span class="hljs-keyword">ON</span> users(status, age);

<span class="hljs-comment">-- 优势1：优化器可以更准确地估算索引选择性</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'13800138000'</span>;
<span class="hljs-comment">-- 优化器知道phone字段不会有NULL值，可以更准确地计算查询成本</span>

<span class="hljs-comment">-- 优势2：索引结构更紧凑</span>
<span class="hljs-comment">-- 不需要为NULL值预留空间或特殊处理</span>

<span class="hljs-comment">-- 优势3：查询可以更简单</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>; <span class="hljs-comment">-- 如果phone是NOT NULL，这个条件永远为真</span>
</code></pre>
<h5 data-id="heading-30">实战案例：优化器选择索引</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表设计对比</span>

<span class="hljs-comment">-- 方案1：允许NULL（不推荐）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_v1 (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,           <span class="hljs-comment">-- 允许NULL</span>
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),       <span class="hljs-comment">-- 允许NULL</span>
    created_at DATETIME,      <span class="hljs-comment">-- 允许NULL</span>
    INDEX idx_user_status (user_id, status)
);

<span class="hljs-comment">-- 查询：优化器需要判断NULL值的影响</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders_v1 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- 优化器可能认为：如果user_id或status可能为NULL，索引效果可能不佳</span>

<span class="hljs-comment">-- 方案2：使用NOT NULL（推荐）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_v2 (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,      <span class="hljs-comment">-- 明确NOT NULL</span>
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 明确NOT NULL</span>
    created_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 明确NOT NULL</span>
    INDEX idx_user_status (user_id, status)
);

<span class="hljs-comment">-- 查询：优化器可以更自信地使用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders_v2 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- 优化器知道所有行都有user_id和status值，可以更准确地选择索引</span>
</code></pre>
<h5 data-id="heading-31">如何为现有表添加NOT NULL约束？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 步骤1：检查现有数据是否包含NULL值</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_rows,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> null_count
<span class="hljs-keyword">FROM</span> users;

<span class="hljs-comment">-- 步骤2：如果存在NULL值，先更新为默认值</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">''</span> <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;

<span class="hljs-comment">-- 步骤3：添加NOT NULL约束</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users MODIFY <span class="hljs-keyword">COLUMN</span> phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>;

<span class="hljs-comment">-- 步骤4：验证约束生效</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users;
</code></pre>
<p><strong>建议</strong>：</p>
<ol>
<li><strong>建表时就定义NOT NULL</strong>：避免后续修改的麻烦（改表结构可能锁表）</li>
<li><strong>为NOT NULL字段设置合理的默认值</strong>：如<code>DEFAULT ''</code>、<code>DEFAULT 0</code>、<code>DEFAULT CURRENT_TIMESTAMP</code></li>
<li><strong>业务层面保证数据完整性</strong>：应用层校验 + 数据库约束双重保障，更稳妥</li>
</ol>
<hr/>
<h3 data-id="heading-32">四、索引设计实战：完整案例</h3>
<h4 data-id="heading-33">案例：电商订单系统的索引设计</h4>
<p>假设我们需要设计一个电商订单表的索引，以下是业务场景和SQL查询模式：</p>
<p><strong>业务场景</strong>：</p>
<ul>
<li>
<p>表数据量：1000万+订单</p>
</li>
<li>
<p>写入频率：每秒1000+订单</p>
</li>
<li>
<p>查询场景：</p>
<ol>
<li>用户查看自己的订单列表（按创建时间倒序） - 80%查询</li>
<li>用户按状态筛选订单 - 15%查询</li>
<li>运营按状态统计订单 - 5%查询</li>
</ol>
</li>
</ul>
<p><strong>表结构设计</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单号'</span>,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单状态'</span>,
    total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单金额'</span>,
    created_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'创建时间'</span>,
    updated_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'更新时间'</span>,
    INDEX idx_order_no (order_no),
    INDEX idx_user_created (user_id, created_at <span class="hljs-keyword">DESC</span>),
    INDEX idx_user_status_created (user_id, status, created_at <span class="hljs-keyword">DESC</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<p><strong>索引设计分析</strong>：</p>
<ol>
<li><strong>主键索引</strong>：<code>id</code> - 必须的，用于唯一标识和聚簇索引</li>
<li><strong>唯一索引</strong>：<code>idx_order_no</code> - 订单号查询，区分度高（100%）</li>
<li><strong>联合索引1</strong>：<code>idx_user_created</code> - 覆盖场景1（用户查看订单列表）</li>
<li><strong>联合索引2</strong>：<code>idx_user_status_created</code> - 覆盖场景2（用户按状态筛选）</li>
</ol>
<p><strong>查询场景验证</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景1：用户查看订单列表（命中idx_user_created）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span> 
LIMIT <span class="hljs-number">20</span>;
<span class="hljs-comment">-- type: ref, key: idx_user_created, Extra: Using index condition</span>

<span class="hljs-comment">-- 场景2：用户按状态筛选订单（命中idx_user_status_created）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>;
<span class="hljs-comment">-- type: ref, key: idx_user_status_created, Extra: Using index condition</span>

<span class="hljs-comment">-- 场景3：运营统计（考虑是否需要单独索引）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> status, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01'</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status;
<span class="hljs-comment">-- 如果频率不高，可以不建索引；如果频率高，考虑建立idx_status_created</span>
</code></pre>
<p><strong>优化建议</strong>：</p>
<ol>
<li><strong>索引数量控制</strong>：当前4个索引（含主键），符合"5-7个"原则</li>
<li><strong>索引合并优化</strong>：<code>idx_user_created</code>和<code>idx_user_status_created</code>有重叠，但为了覆盖不同查询场景，保留两个索引是合理的</li>
<li><strong>覆盖索引优化</strong>：如果查询只需要部分字段，可以调整索引包含的列，实现覆盖索引：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 如果查询只需要id、user_id、status、created_at</span>
<span class="hljs-comment">-- 可以设计覆盖索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created_covering 
<span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>, id);

<span class="hljs-comment">-- 查询时可以实现覆盖索引</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> id, user_id, status, created_at 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- Extra: Using index（无需回表）</span>
</code></pre>
<hr/>
<h3 data-id="heading-34">五、索引设计检查清单</h3>
<p>在实际项目中，建议使用以下检查清单来评估索引设计是否合理：</p>
<h4 data-id="heading-35">✅ 表级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 表数据量是否足够大（&gt;1000行）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 表是否高频查询？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否评估过索引对写入性能的影响？</li>
</ul>
<h4 data-id="heading-36">✅ 字段级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为WHERE条件的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为ORDER BY的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为GROUP BY的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 字段区分度是否足够高（&gt;30%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 字符串字段是否考虑使用前缀索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 索引字段是否设置为NOT NULL？</li>
</ul>
<h4 data-id="heading-37">✅ 索引级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否优先使用联合索引而非多个单列索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 联合索引的列顺序是否遵循最左前缀原则？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否考虑了覆盖索引优化？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 索引数量是否控制在合理范围（5-7个）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否定期清理低频使用的索引？</li>
</ul>
<h4 data-id="heading-38">✅ 性能验证</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用<code>EXPLAIN</code>验证索引使用情况？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否监控索引的查询命中率？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否评估索引对写入性能的影响？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否定期更新表的统计信息（<code>ANALYZE TABLE</code>）？</li>
</ul>
<hr/>
<h3 data-id="heading-39">六、常见误区与避坑指南</h3>
<h4 data-id="heading-40">误区1：为所有字段都建立索引</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">-- ❌ 为每个字段都建立索引
CREATE <span class="hljs-selector-tag">TABLE</span> users (...);
CREATE INDEX idx_field1 ON <span class="hljs-built_in">users</span>(field1);
CREATE INDEX idx_field2 ON <span class="hljs-built_in">users</span>(field2);
CREATE INDEX idx_field3 ON <span class="hljs-built_in">users</span>(field3);
-- ... <span class="hljs-number">10</span>多个索引
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>只为核心查询字段建立索引</li>
<li>通过慢查询日志分析真实查询模式</li>
<li>定期审计索引使用情况，删除无用索引</li>
</ul>
<h4 data-id="heading-41">误区2：忽略索引维护成本</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-- ❌ 只看查询性能，忽略写入性能</span>
<span class="hljs-deletion">-- 某个表有15个索引，查询很快，但写入慢如蜗牛</span>
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>建立索引前评估写入频率</li>
<li>对于写多读少的表，严格控制索引数量</li>
<li>监控写入性能指标（TPS、延迟）</li>
</ul>
<h4 data-id="heading-42">误区3：联合索引顺序随意设计</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">-- ❌ 不考虑查询模式，随意设计索引顺序
CREATE INDEX idx_created_user_status ON orders(created_at, user_id, status)<span class="hljs-comment">;</span>
-- 但实际查询是 WHERE <span class="hljs-attr">user_id</span> = ? AND status = ?
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>分析所有查询SQL，找出最常用的查询模式</li>
<li>按照查询频率和选择性设计索引顺序</li>
<li>使用<code>EXPLAIN</code>验证索引是否被正确使用</li>
</ul>
<h4 data-id="heading-43">误区4：过度依赖覆盖索引</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- ❌ 为了覆盖索引，把很多字段都加到索引中</span>
CREATE INDEX idx_user_covering ON orders(user_id, <span class="hljs-built_in">status</span>, created_at, amount, ...);
<span class="hljs-comment">-- 索引变得很大，维护成本高</span>
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>覆盖索引只包含高频查询的字段</li>
<li>权衡索引大小和维护成本</li>
<li>对于低频查询，可以接受回表操作</li>
</ul>
<hr/>
<h3 data-id="heading-44">七、总结</h3>
<p>索引设计是一个需要<strong>权衡</strong>的过程，没有银弹，只有最适合的方案。本文从<strong>表→字段→索引</strong>三个层次，系统梳理了7条核心设计原则：</p>
<h4 data-id="heading-45">核心原则回顾</h4>
<ol>
<li><strong>表级别</strong>：数据量大且查询频繁的表才建索引</li>
<li><strong>字段级别</strong>：为WHERE/ORDER BY/GROUP BY字段建索引</li>
<li><strong>区分度优先</strong>：选择区分度高的字段，尽量建唯一索引</li>
<li><strong>前缀索引</strong>：长字符串字段使用前缀索引平衡性能和存储</li>
<li><strong>联合索引</strong>：优先使用联合索引，实现覆盖索引优化</li>
<li><strong>控制数量</strong>：索引数量控制在5-7个，平衡查询和写入性能</li>
<li><strong>NOT NULL约束</strong>：索引字段使用NOT NULL，帮助优化器做出更好决策</li>
</ol>
<h4 data-id="heading-46">设计流程建议</h4>
<ol>
<li><strong>需求分析</strong>：收集所有查询SQL，分析查询模式</li>
<li><strong>优先级排序</strong>：按查询频率和重要性排序</li>
<li><strong>索引设计</strong>：根据7条原则设计索引</li>
<li><strong>性能验证</strong>：使用<code>EXPLAIN</code>和性能测试验证效果</li>
<li><strong>持续优化</strong>：定期审计索引使用情况，优化调整</li>
</ol>
<hr/>
<p><strong>记住</strong>：索引是优化数据库性能的重要手段，但不是唯一手段。在设计索引时，要结合业务场景、数据量、查询模式、写入频率等多个因素综合考虑，才能设计出真正高效的索引方案。</p>
<hr/>
<h3 data-id="heading-47">相关文章</h3>
<p>想要系统学习MySQL索引，可以阅读以下文章：</p>
<ul>
<li><strong>索引基础</strong>：<a href="https://juejin.cn/post/7564977973259976730" target="_blank" title="https://juejin.cn/post/7564977973259976730">图解MySQL索引：从二叉树到B+树的演进之路（基础篇）</a></li>
<li><strong>性能分析</strong>：<a href="https://juejin.cn/post/7567257202194776091" target="_blank" title="https://juejin.cn/post/7567257202194776091">MySQL索引：SQL性能分析工具详解（进阶篇）</a></li>
<li><strong>使用技巧</strong>：<a href="https://juejin.cn/post/7570271574348038153" target="_blank" title="https://juejin.cn/post/7570271574348038153">MySQL索引优化实战：原则速查与踩坑案例（实战篇）</a></li>
<li><strong>设计原则</strong>：<a href="#" title="#">MySQL索引设计原则：从理论到实践的完整指南</a> （本文）</li>
</ul>
<h4 data-id="heading-48">扩展阅读</h4>
<ul>
<li><strong>存储引擎</strong>：<a href="https://juejin.cn/post/7552030609582784522" target="_blank" title="https://juejin.cn/post/7552030609582784522">MySQL存储引擎详解：老王教你如何选择合适的"发动机"</a></li>
</ul>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[goup是一个纯Rust编写的优雅的Go多版本管理工具]]></title>    <link>https://juejin.cn/post/7577713754563461172</link>    <guid>https://juejin.cn/post/7577713754563461172</guid>    <pubDate>2025-11-30T06:32:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577713754563461172" data-draft-id="7577713754563444788" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="goup是一个纯Rust编写的优雅的Go多版本管理工具"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-30T06:32:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="5197"/> <meta itemprop="url" content="https://juejin.cn/user/3186802516829016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            goup是一个纯Rust编写的优雅的Go多版本管理工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3186802516829016/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    5197
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:32:29.000Z" title="Sun Nov 30 2025 06:32:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">goup</h2>
<p><em><strong>注意</strong></em>: <code>goup-rs</code>仍在积极开发中, 因此在达到v1.0.0之前不能保证完全向后兼容</p>
<h3 data-id="heading-1">特性</h3>
<ul>
<li>最小依赖, 依赖于<code>git</code>(仅<code>nightly|tip|gotip</code>版本需要<code>git</code>).</li>
<li>跨平台的能力(Linux, macOS &amp; Windows).</li>
<li>支持使用<code>goup install/remove [TOOLCHAIN]</code> 安装/卸载 Go版本.</li>
<li>支持使用<code>goup install &lt;nightly|tip|gotip&gt;</code> 从源码安装Go, 需要<code>git</code>.</li>
<li>支持列出本地已安装的版本.</li>
<li>支持在多个已安装的版本中切换.</li>
<li>支持搜索可用的Go版本.</li>
<li>✨支持在shell会话中使用特定的Go版本(&gt;= v0.15.x).</li>
<li>✨支持多个下载后端<code>GOUP_GO_REGISTRY_INDEX</code>/<code>GOUP_GO_REGISTRY</code>(&gt;=v0.16.x).</li>
<li>支持管理本地缓存文件(如 <code>*.tar.gz</code>, <code>*.tar.gz.sha256</code>).</li>
<li>支持<code>goup</code>自我更新.</li>
<li>支持自定义<code>GOUP_HOME</code>(默认<code>$HOME/.goup</code>)(&gt;= v0.11.x);</li>
<li>友好的提示.</li>
<li>应该很快.</li>
</ul>
<p><code>goup</code> 是对上述特性的一种尝试, 其灵感主要来自于 <a href="https://link.juejin.cn?target=https%3A%2F%2Frustup.rs%2F" target="_blank" title="https://rustup.rs/" ref="nofollow noopener noreferrer">Rustup</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fdl" target="_blank" title="https://github.com/golang/dl" ref="nofollow noopener noreferrer">golang/dl</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fowenthereal%2Fgoup" target="_blank" title="https://github.com/owenthereal/goup" ref="nofollow noopener noreferrer">goup</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsyndbg%2Fgoenv" target="_blank" title="https://github.com/syndbg/goenv" ref="nofollow noopener noreferrer">goenv</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoovweb%2Fgvm" target="_blank" title="https://github.com/moovweb/gvm" ref="nofollow noopener noreferrer">gvm</a> and <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Ftools%2Ftree%2Fmaster%2Fcmd%2Fgetgo" target="_blank" title="https://github.com/golang/tools/tree/master/cmd/getgo" ref="nofollow noopener noreferrer">getgo</a>.</p>
<h3 data-id="heading-2">构建功能标志</h3>
<ul>
<li><code>no-self-update</code> 关闭自我更新.</li>
</ul>
<h3 data-id="heading-3">安装</h3>
<h4 data-id="heading-4">使用Cargo</h4>
<p>或者, 也可以使用<code>cargo</code>安装.</p>
<pre><code class="hljs language-shell" lang="shell">cargo install goup-rs
</code></pre>
<p>或</p>
<pre><code class="hljs language-shell" lang="shell">cargo install goup-rs --git https://github.com/thinkgos/goup-rs
</code></pre>
<ul>
<li>(<em>仅支持 Linux/MacOS</em>) 运行<code>goup init</code>, 获取到shell启动脚本位于<code>$HOME/.goup/env</code>.</li>
<li>(<em>仅支持 Linux/MacOS</em>) 在shell启动脚本中添加Go的bin目录:
<ul>
<li>bash: <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.bashrc</code></li>
<li>zsh:  <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.zshenv</code></li>
<li>fish: <code>echo 'source ~/.goup/env' &gt;&gt; ~/.config/fish/config.fish</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">手动安装(Linux/MacOS)</h4>
<p>如果您想手动安装, 步骤如下:</p>
<ul>
<li>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>.</li>
<li>将<code>goup</code>可执行文件放到<code>PATH</code>中, 并给予可执行权限: <code>mv GOUP_BIN /usr/local/bin/goup &amp;&amp; chmod +x /usr/local/bin/goup</code></li>
<li>运行<code>goup init</code>, 获取到shell启动脚本位于<code>$HOME/.goup/env</code>.</li>
<li>在shell启动脚本中添加Go的bin目录:
<ul>
<li>bash: <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.bashrc</code></li>
<li>zsh:  <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.zshenv</code></li>
<li>fish: <code>echo 'source ~/.goup/env' &gt;&gt; ~/.config/fish/config.fish</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">手动安装(Windows)</h4>
<h5 data-id="heading-7">MSI安装</h5>
<p>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>的MSI安装程序并运行.</p>
<h5 data-id="heading-8">二进制安装</h5>
<ul>
<li>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>的二进制程序并解压.</li>
<li>将<code>goup.exe</code>移至<code>$YOUR_PATH</code>.</li>
<li>将<code>$YOUR_PATH</code>加到windows环境变量中.</li>
</ul>
<h3 data-id="heading-9">快速入门</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">goup install</span>
[2024-01-30T00:38:48Z INFO ] Installing go1.21.10 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.10/go1.21.10.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed in /home/thinkgo/.goup/go1.21.10
[2024-01-30T00:38:48Z INFO ] Default Go is set to 'go1.21.10'
<span class="hljs-meta prompt_">$ </span><span class="bash">goup list</span>
1.21.10  (active, default)
<span class="hljs-meta prompt_">$ </span><span class="bash">go <span class="hljs-built_in">env</span> GOROOT</span>
/home/thinkgo/.goup/current
<span class="hljs-meta prompt_">$ </span><span class="bash">go version</span>
go version go1.21.10 linux/amd64
<span class="hljs-meta prompt_">$ </span><span class="bash">GOUP_GO_REGISTRY_INDEX=https://golang.google.cn goup install =1.21.10</span>
</code></pre>
<h3 data-id="heading-10">使用方法</h3>
<h4 data-id="heading-11">列出所有可用的go版本</h4>
<p><code>goup search [FILTER]</code>, <code>[FILTER]</code>支持的值: <strong>'stable'</strong>, <strong>'unstable'</strong>, <strong>'beta'</strong> 或 <strong>any regex string</strong>.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup search
1
...
1.21rc4
1.22rc1
$ goup search stable
1
...
1.21.4
1.21.5
1.21.10
</code></pre>
<h4 data-id="heading-12">列出所有位于<code>$HOME/.goup</code>已安装的Go版本</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup list 
1.21.10
1.22.3  (active, default)
tip
</code></pre>
<h4 data-id="heading-13">安装指定Go版本</h4>
<p><code>goup install/update [TOOLCHAIN]</code>, <code>[TOOLCHAIN]</code> 支持的值: <strong>'stable'(default)</strong>, <strong>'nightly'</strong>(<strong>'tip'</strong>, <strong>'gotip'</strong>), <strong>'unstable'</strong>, <strong>'beta'</strong> 或 <strong>'=1.21.4'</strong>, <code>--dry</code> 表示只安装对应版本, 但并不切换使用.</p>
<p><code>[TOOLCHAIN]</code> 支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a>语法匹配对应版本, 详情查看<a href="#faq" title="#faq">FAQ</a></p>
<pre><code class="hljs language-bash" lang="bash">$ goup install 1.21.*
[2024-01-30T00:38:48Z INFO ] Installing go1.21.10 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.10/go1.21.10.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed <span class="hljs-keyword">in</span> /home/thinkgo/.goup/go1.21.10
[2024-01-30T00:38:48Z INFO ] Default Go is <span class="hljs-built_in">set</span> to <span class="hljs-string">'go1.21.10'</span>
$ goup install =1.21.4 --dry
[2024-01-30T00:38:48Z INFO ] Installing go1.21.4 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.4/go1.21.4.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed <span class="hljs-keyword">in</span> /home/thinkgo/.goup/go1.21.4
</code></pre>
<h4 data-id="heading-14">切换到选定的Go版本</h4>
<p><code>goup default/use/set [VERSION]</code>, 设置默认的Go版本.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup default 
? Select a version ›
  1.21.5
❯ 1.21.10
  tip
[2024-01-30T00:38:48Z INFO ] Default Go is <span class="hljs-built_in">set</span> to <span class="hljs-string">'go1.21.10'</span>
</code></pre>
<h4 data-id="heading-15">删除指定的 Go 版本列表</h4>
<p><code>goup remove/rm [VERSION]...</code> 删除指定的 Go 版本列表. 如果没有提供版本, 将提示选择多个已安装的 Go 版本</p>
<pre><code class="hljs language-bash" lang="bash">$ goup <span class="hljs-built_in">rm</span>
? Select multiple version ›
✔ 1.21.5
⬚ 1.21.10
⬚ tip
✔ Select multiple version · 1.21.5
</code></pre>
<h4 data-id="heading-16">在shell会话中使用特定的Go版本</h4>
<p><code>goup shell [VERSION]</code>, 在shell会话中使用特定的Go版本, 如果没有提供版本, 将自动检测执行路径下的<code>go.work</code>/<code>go.mod</code>的Go版本(可以使用<code>--skip-autodetect</code>跳过), 仍旧没有的话将提示用户选择一个已安装的Go版本.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup shell 1.21.10
? Select a version ›
  1.21.5
❯ 1.21.10
  tip
$ go version
go version go1.21.10 linux/amd64
$ goup list 
1.21.10
1.22.3  (active, default)
tip
</code></pre>
<h4 data-id="heading-17">管理缓存归档文件</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup cache show --contain-sha256
go1.21.10.linux-amd64.tar.gz
go1.21.10.linux-amd64.tar.gz.sha256

$ goup cache clean
✔ Do you want to clean cache file? · <span class="hljs-built_in">yes</span>
</code></pre>
<h4 data-id="heading-18">修改<code>goup</code>安装程序</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup self update
Checking target-arch... x86_64-unknown-linux-gnu
Checking current version... v0.9.0
Checking latest released version... v0.9.0
[2024-01-30T00:38:48Z INFO ] Update status: `v0.9.0`!
</code></pre>
<h4 data-id="heading-19">环境变量值</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup <span class="hljs-built_in">env</span>
+------------------------+--------------------------------+--------------------------------------------------------------+
| Key                    | Value                          | Explain                                                      |
+------------------------+--------------------------------+--------------------------------------------------------------+
| GOUP_HOME              | /home/thinkgo/.goup            | Get goup home directory, default: <span class="hljs-string">'$HOME/.goup'</span>              |
| GOUP_GO_VERSION        | current                        | Shell session target go version, default: <span class="hljs-string">'current'</span>          |
| GOUP_GO_REGISTRY_INDEX | https://golang.google.cn       | Registry index of go version                                 |
| GOUP_GO_REGISTRY       | https://dl.google.com/go       | Registry of go archive file                                  |
| GOUP_GO_SOURCE_GIT_URL | https://github.com/golang/go   | Source git url, use by tip|nightly or index of go version    |
| GOUP_GO_SOURCE_GIT_URL | https://go.googlesource.com/go | Source upstream git url, use by tip|nightly                  |
+------------------------+--------------------------------+--------------------------------------------------------------+
</code></pre>
<h4 data-id="heading-20">Shell补全</h4>
<p><code>goup completion &lt;SHELL&gt;</code>  为指定shell生成补全脚本. <code>&lt;SHELL&gt;</code>支持这些值: <code>bash</code>, <code>elvish</code>, <code>fish</code>, <code>powershell</code>, <code>zsh</code>.</p>
<pre><code class="hljs language-bash" lang="bash">goup completion zsh &gt; _goup
</code></pre>
<h4 data-id="heading-21">更多信息</h4>
<p>执行<code>goup -h</code>获取更多信息</p>
<h3 data-id="heading-22">镜像站</h3>
<h4 data-id="heading-23">索引镜像站</h4>





















































<table><thead><tr><th>索引</th><th>地址</th><th>使用选项<code>--registry-index</code>或环境变量</th><th>备注</th></tr></thead><tbody><tr><td>官方1(默认)</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev" target="_blank" title="https://go.dev" ref="nofollow noopener noreferrer">go.dev</a></td><td><code>official</code> 或 <code>official|https://go.dev</code></td><td/></tr><tr><td>官方2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgolang.google.cn" target="_blank" title="https://golang.google.cn" ref="nofollow noopener noreferrer">golang.google.cn</a></td><td><code>official|https://golang.google.cn</code></td><td/></tr><tr><td>官方git 1</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fgo" target="_blank" title="https://github.com/golang/go" ref="nofollow noopener noreferrer">github.com/golang/go</a></td><td><code>git</code> 或 <code>git|https://github.com/golang/go</code></td><td>通过git</td></tr><tr><td>官方git 2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.googlesource.com%2Fgo" target="_blank" title="https://go.googlesource.com/go" ref="nofollow noopener noreferrer">go.googlesource.com/go</a></td><td><code>git|https://go.googlesource.com/go</code></td><td>通过git</td></tr><tr><td>阿里云</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.aliyun.com%2Fgolang" target="_blank" title="https://mirrors.aliyun.com/golang" ref="nofollow noopener noreferrer">mirrors.aliyun.com/golang</a></td><td><code>ngx-fancy-index|https://mirrors.aliyun.com/golang</code></td><td/></tr><tr><td>南京大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.nju.edu.cn%2Fgolang" target="_blank" title="https://mirrors.nju.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.nju.edu.cn/golang</a></td><td><code>ngx-fancy-index|https://mirrors.nju.edu.cn/golang</code></td><td/></tr><tr><td>华中科技大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.hust.edu.cn%2Fgolang" target="_blank" title="https://mirrors.hust.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.hust.edu.cn/golang</a></td><td><code>ngx-fancy-index|https://mirrors.hust.edu.cn/golang</code></td><td/></tr></tbody></table>
<h4 data-id="heading-24">仓库镜像站</h4>





























































<table><thead><tr><th>仓库</th><th>地址</th><th>支持SHA256文件</th><th>支持HTTP获取压缩包长度</th><th>备注</th></tr></thead><tbody><tr><td>官方1(默认)</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.google.com%2Fgo" target="_blank" title="https://dl.google.com/go" ref="nofollow noopener noreferrer">dl.google.com/go</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>官方2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdl" target="_blank" title="https://go.dev/dl" ref="nofollow noopener noreferrer">go.dev/dl</a></td><td>❌</td><td>✅</td><td/></tr><tr><td>官方3</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgolang.org%2Fdl" target="_blank" title="https://golang.org/dl" ref="nofollow noopener noreferrer">golang.org/dl</a></td><td>❌</td><td>✅</td><td/></tr><tr><td>阿里云</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.aliyun.com%2Fgolang" target="_blank" title="https://mirrors.aliyun.com/golang" ref="nofollow noopener noreferrer">mirrors.aliyun.com/golang</a></td><td>❌</td><td>❌</td><td/></tr><tr><td>南京大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.nju.edu.cn%2Fgolang" target="_blank" title="https://mirrors.nju.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.nju.edu.cn/golang</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>华中科技大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.hust.edu.cn%2Fgolang" target="_blank" title="https://mirrors.hust.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.hust.edu.cn/golang</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>中国科学技术大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.ustc.edu.cn%2Fgolang" target="_blank" title="https://mirrors.ustc.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.ustc.edu.cn/golang</a></td><td>✅</td><td>✅</td><td>❌ 不建议使用</td></tr></tbody></table>
<p><em><strong>NOTE</strong></em>: 有些镜像站不提供<strong>SHA256校验文件</strong>, 在下载时需要使用<code>--skip-verify</code>选项.</p>
<h4 data-id="heading-25">设置镜像站环境变量</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">推存值</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> GOUP_GO_REGISTRY_INDEX=<span class="hljs-string">'ngx-fancy-index|https://mirrors.nju.edu.cn/golang'</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> GOUP_GO_REGISTRY_INDEX=<span class="hljs-string">'git|https://github.com/golang/go'</span></span>
export GOUP_GO_REGISTRY_INDEX=https://go.dev
export GOUP_GO_REGISTRY=https://mirrors.hust.edu.cn/golang
</code></pre>
<h3 data-id="heading-26">工作原理</h3>
<ul>
<li><code>goup completion &lt;SHELL&gt;</code> 为指定shell生成补全脚本.</li>
<li><code>goup [help]</code>  打印此信息或给定子命令的帮助信息.</li>
<li><code>goup install/update/i [TOOLCHAIN]</code> 下载指定的Go版本到<code>$HOME/.goup/go&lt;VERSION|tip&gt;/go</code>并创建一个软链接到<code>$HOME/.goup/current</code>.</li>
<li><code>goup default/use/set [VERSION]</code> 设置默认的Go版本.</li>
<li><code>goup ls/list/show</code> 列出所有位置<code>$HOME/.goup</code>已安装的Go版本.</li>
<li><code>goup remove/rm [VERSION]...</code> 移除指定的Go版本列表.</li>
<li><code>goup search/ls-remote [FILTER]</code> 列出所有可用的Go版本.</li>
<li><code>goup cache [COMMAND]</code> 管理缓存归档文件.</li>
<li><code>goup self &lt;COMMAND&gt;</code> 修改<code>goup</code>安装程序.</li>
<li><code>goup init [SHELL]</code> 将所有必要的环境变量和值写入<code>$HOME/.goup/env</code>.</li>
<li><code>goup env</code>  显示<code>goup</code>的环境变量和值.</li>
<li><code>goup shell [VERSION]</code> 在shell会话中使用特定的Go版本.</li>
</ul>
<h3 data-id="heading-27">How to Debug</h3>
<p>默认日志级别为<code>Info</code>. 你可以使用<code>goup -v &lt;subcommand&gt;</code> 或 <code>goup -vv &lt;subcommand&gt;</code> 来使用 <code>Debug</code> 或 <code>Trace</code> 等级.</p>
<h3 data-id="heading-28">FAQ</h3>
<ul>
<li>
<p>编译和安装源代码失败?<br/>
所需的Go最低版本取决于Go的目标版本, 更多信息请参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdoc%2Finstall%2Fsource" target="_blank" title="https://go.dev/doc/install/source" ref="nofollow noopener noreferrer">source installation instructions</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a></p>
<ul>
<li>exact(<code>=</code>):  允许更新到与版本完全一致的最新版本, 因此<code>=1.21.4</code>表示与版本<code>1.21.4</code>完全一致.</li>
<li>greater(<code>&gt;</code>): 允许更新到大于该版本的最新版本, 因此<code>&gt;1.21.4</code>表示大于<code>1.21.4</code>.</li>
<li>greater equal(<code>&gt;=</code>): 允许更新到大于或等于该版本的最新版本, 因此 <code>&gt;1.21.4</code> 表示大于或等于<code>1.21.4</code>.</li>
<li>less(<code>&lt;</code>): 允许更新到小于该版本的最新版本, 因此<code>&gt;1.21.4</code>表示大于<code>1.21.4</code>.</li>
<li>less equal(<code>&lt;=</code>): 允许更新到小于或等于该版本的最新版本, 因此 <code>&gt;1.21.4</code> 表示小于或等于<code>1.21.4</code>.</li>
<li>tilde(<code>~</code>): 允许更新到不改变主,次版本的最新版本, 因此<code>~1.21.4</code>表示大于或等于 <code>1.21.4</code>, 但小于 <code>1.22.0</code>.</li>
<li>caret(<code>^</code>): 允许更新到不改变主要版本的最新版本, 因此 <code>^1.21.4</code> 表示版本必须大于或等于 <code>1.21.4</code>, 但小于 <code>2.0.0</code>.</li>
<li>wildcard(<code>*</code>): 此运算符表示任意版本. 它通常用于允许所有版本号匹配.
<ul>
<li><code>1.21.*</code> 匹配所有<code>1.21.x</code>版本.</li>
<li><code>1.*.*</code> 匹配所有<code>1.x.x</code>版本.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Go版本小于等于1.20.x解压失败.<br/>
大于v0.10.3版本已解决.
看多信息查看issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F251" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/251" ref="nofollow noopener noreferrer">#251</a></p>
</li>
<li>
<p>如何自定义 <code>GOUP_HOME</code>? (&gt;= v0.11.x)<br/>
<code>goup</code>使用<code>$HOME/.goup</code>目录作为 <code>GOUP_HOME</code>. 如果需要自定义<code>GOUP_HOME</code>(大多数是Windows用户), 可以设置<code>GOUP_HOME</code>环境变量来使用其他目录, 安装<code>goup</code>之前, 请确保已设置自定义<code>GOUP_HOME</code>环境变量和目标目录权限, 否则可能会导致令人惊讶的结果, 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F265" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/265" ref="nofollow noopener noreferrer">#265</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F270" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/270" ref="nofollow noopener noreferrer">#270</a></p>
</li>
<li>
<p>有一些版本没有sha256文件, 如何安装这些版本?
<code>goup</code>(&gt;= v0.12.x) 支持 <code>--skip-verify</code> 选项, 如果这些版本没有sha256文件, 你可以尝试添加选项. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F300" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/300" ref="nofollow noopener noreferrer">#300</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F301" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/301" ref="nofollow noopener noreferrer">#301</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F305" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/305" ref="nofollow noopener noreferrer">#305</a></p>
</li>
<li>
<p>如何安装特定版本? 为什么会出现错误<code>Error: expected comma after minor version number, found 'r'</code>?
有时, 我们知道确切的版本, 可以使用 <code>goup install =1.24.5</code>, 但有些版本不符合<a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a>, 如 <code>1.25rc1</code>, 我们可以使用<code>goup install unstable</code>, 但这只能安装最新的不稳定版本. 所以我添加了一个 <code>--use-raw-version</code> 选项(&gt;= v0.12.x), 这样我们就可以安装任何我们确切知道的版本. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F299" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/299" ref="nofollow noopener noreferrer">#299</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F307" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/307" ref="nofollow noopener noreferrer">#307</a></p>
</li>
<li>
<p>如何在shell会话中使用特定的Go版本?
<code>goup</code>(&gt;= v0.15.x) 支持在一个<code>shell</code>会话中指定go版本. 如果你使用<code>goup shell</code>, 在<code>*nix</code>系统上需要先运行<code>goup init</code>, 因为之前的<code>env</code>文件较旧且不包含<code>GOUP_GO_VERSION</code>环境变量. 在<code>Windows</code>系统 上, 仅支持<code>powershell</code>, 如果系统的<code>COMSPEC</code>已经指向 powershell, 可能无需做任何操作. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F360" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/360" ref="nofollow noopener noreferrer">#360</a>.</p>
</li>
</ul>
<h3 data-id="heading-29">原文</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs" target="_blank" title="https://github.com/thinkgos/goup-rs" ref="nofollow noopener noreferrer">goup-rs</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 MateChat 构建 AI 编程智能助手的落地实践]]></title>    <link>https://juejin.cn/post/7577691061034025006</link>    <guid>https://juejin.cn/post/7577691061034025006</guid>    <pubDate>2025-11-30T06:31:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034025006" data-draft-id="7577971299742711846" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 MateChat 构建 AI 编程智能助手的落地实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T06:31:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Se7en2581"/> <meta itemprop="url" content="https://juejin.cn/user/482061108644107"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 MateChat 构建 AI 编程智能助手的落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/482061108644107/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Se7en2581
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:31:37.000Z" title="Sun Nov 30 2025 06:31:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文围绕 <strong>华为云 DevUI MateChat</strong>，在在线教育中如何用 DevUI 组件 + MateChat 搭建智能问答界面。</p>
<h2 data-id="heading-0">一、需求背景：为什么我需要一个AI 助教？</h2>
<p>最近我开设了一期《AI 编程实战营》，面向零基础学员。教学过程中，两个痛点让我非常头大：</p>
<ol>
<li><strong>复读机式低效：</strong> 学员问题非常琐碎，比如环境变量怎么设？、Key 哪里找？这些问题在群里被反复问，我被迫变成了复读机，无法专注于深度教学。</li>
<li><strong>时差与响应滞后：</strong> 学员常在深夜学习，但我无法 24 小时在线。一旦他们卡在某个报错，往往要等到第二天我醒来才能解决，极大地打击了学习积极性。</li>
</ol>
<p><strong>我想做一个嵌在课程网页里的智能助手。</strong> 但当我调研技术方案时，发现后端接入大模型很简单，<strong>最让人头秃的是前端交互</strong>：</p>
<ul>
<li>Markdown 怎么渲染？</li>
<li>代码块怎么高亮？</li>
<li>流式输出（打字机效果）怎么写？</li>
</ul>
<p>如果要手写这一套，成本太高。直到我发现了 <strong>华为云 DevUI MateChat</strong>（以下简称 MateChat），它提供了开箱即用的 AI 对话 UI 组件，几乎完美治愈了我“前端恐惧症。</p>
<p>于是我尝试用 华为云 DevUI MateChat（以下简称 MateChat） 做一个嵌在课程里的智能问答助手。</p>
<h2 data-id="heading-1">二、搭建开发环境</h2>
<h3 data-id="heading-2">1、安装并检查 Node.js 环境</h3>
<p>Node.js官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2Fdownload%2F" target="_blank" title="https://nodejs.org/en/download/" ref="nofollow noopener noreferrer">nodejs.org/en/download…</a></p>
<p>安装后，打开命令提示符（Win+R 输入cmd）或打开windows搜索cmd也行。</p>
<p>输入显示版本号，说明安装成功。</p>
<pre><code class="hljs">node -v
pnpm -v
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12902e0c27ca420e9bdf2efe76bd9038~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=8XbwIm7nK8WZ6gZC9J%2B%2BOCtRkCs%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b480f2dc0374b419750a5a2fa3cda12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=4TMEORnqQe0%2FH4XIxAWOkgA3FZc%3D" alt="" loading="lazy"/></p>
<p>注意：Vue 官方建议 Node.js 版本至少 18+ 或 20 LTS，这样用 Vite 起项目比较稳。</p>
<h2 data-id="heading-3">三、搭建MateChat + DevUI 聊天页面</h2>
<h3 data-id="heading-4">1、用 MateChat最新CLI创建项目</h3>
<p>在命令行里，切到你想放项目的文件夹，比如 <code>D:\code</code>，然后用MateChat最新CLI来创建项目，非常方便。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 这里我用的npm管理</span>
npm create matechat@latest
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/165e922755ac42e4bde02167dcd1f458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=gNzlPMSYLIDQUocXa2Z93qCVqlQ%3D" alt="" loading="lazy"/></p>
<p>注意：这一指令在安装并执行<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FDevCloudFE%2FMateChat%2Ftree%2Fdev%2Fpackages%2Fcreate-matechat" target="_blank" title="https://gitcode.com/DevCloudFE/MateChat/tree/dev/packages/create-matechat" ref="nofollow noopener noreferrer">create-matechat</a> 过程中，需要我们确认两个信息。</p>
<p>1、输入项目名称（Please input the project name），我的项目名称是：matechat-demo。</p>
<p>2、选择模版（Please select the template: Vue Starter），默认用Vue Starter即可。</p>
<h3 data-id="heading-5">2、安装依赖并启动</h3>
<p>根据MateChat使用指南</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ec54a5cd52046b6b0598c30a3e1f711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=7QgVlpEn79US1wLuigkWIQkM%2FHM%3D" alt="" loading="lazy"/></p>
<p>先切换到项目的根目录（ cd .\matechat-demo\），然后执行 npm i 安装依赖，最后用npm run dev 启动项目。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d5658c755ff4099b11f3e179ebb3baa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=oNXRe21CWHaNfM2oBktWlB9Sd5U%3D" alt="" loading="lazy"/></p>
<p>打开浏览器，访问local地址：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2Fvue-starter" target="_blank" title="http://localhost:5173/vue-starter" ref="nofollow noopener noreferrer">http://localhost:5173/vue-starter</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd8348ab5fb94f23a856adc11ee40228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=3WyT1kwOpc8t5ZtDCB90Xc44Dwc%3D" alt="" loading="lazy"/></p>
<p>至此，能看到的默认的应用页面，有历史会话和输入框，就说明基础对话助手已经OK 了。</p>
<h3 data-id="heading-6">3、把模板修改为助手式</h3>
<p>我想收起左侧的对话，在文件src//global-config.ts 把地4行的displayShape，Immersive 改为Assistant</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 修改前：</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">displayShape</span>: <span class="hljs-string">"Immersive "</span>,
  <span class="hljs-attr">title</span>: <span class="hljs-string">"MateChat"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-title class_">IGlobalConfig</span>;

  <span class="hljs-comment">// 修改后：</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">displayShape</span>: <span class="hljs-string">"Assistant"</span>,
  <span class="hljs-attr">title</span>: <span class="hljs-string">"MateChat"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-title class_">IGlobalConfig</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7a59dcec0674af68904f74f19aab489~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=aToKUSGpubptS76Nkt358jmEw3k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">4、接入deepseek大模型</h3>
<p>UI 搭好了，现在我们要注入灵魂。我选择用deepseek大模型，这里官方也给了非常详细的对接步骤</p>
<p>（参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fmodel%2Fopenai.html%25EF%25BC%2589" target="_blank" title="https://matechat.gitcode.com/use-guide/model/openai.html%EF%BC%89" ref="nofollow noopener noreferrer">matechat.gitcode.com/use-guide/m…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a66cb115764b62bc59889317ebd04e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=7PaMm8yoO3obDsNDNm1N2jhCgSU%3D" alt="" loading="lazy"/></p>
<p><strong>1、安装 OpenAI SDK</strong> DeepSeek 兼容 OpenAI 协议，我们可以直接用 OpenAI 的 SDK。</p>
<pre><code class="hljs">npm install openai
</code></pre>
<p><strong>2、获取deepseek的key</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55d4ab0bd02d4313addfafe348cd3bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=RVi8oTMdQ%2BlnNxqdpJk0qUToGBs%3D" alt="" loading="lazy"/></p>
<p><strong>3、基于 MateChat，配置API KEY</strong></p>
<p>MateChat把应用默认接入了<code>DeepSeek</code>，在<code>src/models/config.ts</code>文件的<code>LLM_MODELS</code>配置<code>apiKey</code></p>
<pre><code class="hljs language-vbnet" lang="vbnet">// deepseek
<span class="hljs-symbol">providerKey:</span> LLMProviders.DEEP_SEEK,
<span class="hljs-symbol">apiPath:</span> <span class="hljs-string">"https://api.deepseek.com"</span>,
<span class="hljs-symbol">apiKey:</span> <span class="hljs-string">"这里填写你的KEY"</span>,
<span class="hljs-symbol">models:</span> [
  { name: <span class="hljs-string">"deepseek-chat"</span>, iconPath: DeepSeekIcon },
  { name: <span class="hljs-string">"deepseek-reasoner"</span>, iconPath: DeepSeekIcon },
],
<span class="hljs-symbol">available:</span> <span class="hljs-literal">true</span>,
<span class="hljs-symbol">clientKey:</span> LLMClientKey.openai,
</code></pre>
<p><strong>4、将关闭 Mock 模式，调用 DeepSeek API， 文件： src/models/config.ts</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-comment">// 修改前：</span>
  <span class="hljs-keyword">export</span> <span class="hljs-type">const</span> MODEL_CONFIGS = {
    stream: <span class="hljs-literal">true</span>,
    enableMock: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// ← 原来是 true</span>
  };

  <span class="hljs-comment">// 修改后：</span>
  <span class="hljs-keyword">export</span> <span class="hljs-type">const</span> MODEL_CONFIGS = {
    stream: <span class="hljs-literal">true</span>,
    enableMock: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// ← 改成 false</span>
  };
</code></pre>
<h3 data-id="heading-8">5、最后的运行效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1b53fcf3fac45baa45eb37e004988d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=jDqaDogqDfV93VYQ5%2FtMpm%2Bo5BY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>四、总结</strong></h2>
<p>如果以前要实现 Markdown 渲染、流式打字机效果、自适应气泡布局，我至少需要写几百行 CSS 和 JS 代码，还要调试各种兼容性。</p>
<p>现在使用 DevUI + MateChat做开发，速度提升了10倍。DevUI 提供了企业级的组件规范，MateChat 封装了复杂的对话交互逻辑，很快就做好了这个在线教育智能助手。</p>
<p>本文完整 Demo 已开源在 GitCode：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fgcw_o9lCM1pp%2Fmatechat-demo.git" target="_blank" title="https://gitcode.com/gcw_o9lCM1pp/matechat-demo.git" ref="nofollow noopener noreferrer">gitcode.com/gcw_o9lCM1p…</a> master分支。</p>
<p>本文参考资料：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fintroduction.html" target="_blank" title="https://matechat.gitcode.com/use-guide/introduction.html" ref="nofollow noopener noreferrer">matechat.gitcode.com/use-guide/i…</a></p>
<p>本文参考mateChat仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F%25EF%25BC%258C%25E5%258C%2585%25E5%2590%25ABMateChat" target="_blank" title="https://matechat.gitcode.com/%EF%BC%8C%E5%8C%85%E5%90%ABMateChat" ref="nofollow noopener noreferrer">matechat.gitcode.com/，包含MateChat</a> 接入示例、DevUI 组件示例页面、环境配置说明等。</p>
<p>如果这套实践对你有帮助，点个 ⭐ Star，方便后续查阅，一起解锁更多 MateChat / DevUI 场景案例 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change]]></title>    <link>https://juejin.cn/post/7577737385954754570</link>    <guid>https://juejin.cn/post/7577737385954754570</guid>    <pubDate>2025-11-30T06:42:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954754570" data-draft-id="7577691061034057774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-30T06:42:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DonaldCen666"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147440264"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147440264/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DonaldCen666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:42:09.000Z" title="Sun Nov 30 2025 06:42:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员强子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc77e4877bbd46dfb2ab9bd5205a75ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9uYWxkQ2VuNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089729&amp;x-signature=3gDL3kivLa%2FoAFcOSt2Mn1WTKF8%3D" alt="2001980.jpg" loading="lazy"/></p>
<p>日常开发中，我们很少关注 MySQL 的底层细节：</p>
<ul>
<li>InnoDB 是如何<strong>存储数据</strong>的？</li>
<li><strong>Buffer</strong> <strong>Pool</strong> 和 <strong>Change</strong> <strong>Buffer</strong> 又是如何<strong>优化性能</strong>的？</li>
<li><strong>SQL</strong> <strong>执行</strong>要经过哪些环节？</li>
</ul>
<p>今天，强子就带着大家走进 MySQL 的底层世界 ~</p>
<h2 data-id="heading-0">数据存储机制</h2>
<h3 data-id="heading-1">特点</h3>
<p>InnoDB 的存储结构按 <strong>从大到小</strong> 分为 5 个层级</p>
<p><strong>表空间</strong>（Tablespace）→ <strong>段</strong>（Segment）→ <strong>区</strong>（Extent）→ <strong>页</strong>（Page）→ <strong>行</strong>（Row）</p>
<p>核心就上层负责 <strong>逻辑隔离与资源管理</strong>，下层负责 <strong>物理存储与 IO 交互</strong></p>
<p>比如<strong>表空间</strong>隔离不同表的数据，<strong>页</strong>则作为内存与磁盘的交互单元</p>
<p>最终实现 <strong>按需存储</strong>、<strong>高效读写</strong></p>
<p>接下来，跟着强子的脚步，来拆解每个层次~</p>
<h3 data-id="heading-2">表空间</h3>
<p><strong>表空间</strong>（Tablespace）,是所有数据（<strong>表数据</strong>、<strong>索引</strong>、<strong>元数据</strong>等）的 <strong>总仓库</strong></p>
<p>分为两类核心类型：</p>
<ul>
<li>
<p><strong>系统表空间</strong>（System Tablespace）</p>
<ul>
<li>MySQL 默认的共享表空间，对应磁盘文件<strong>ibdata1</strong>（可多文件）</li>
<li>存储 InnoDB <strong>数据字典</strong>、<strong>回滚日志</strong>（Undo Log）、<strong>临时表</strong>数据等核心元数据；</li>
</ul>
</li>
<li>
<p><strong>独立表空间</strong>（File-per-table Tablespace）</p>
<ul>
<li>MySQL 5.6 及以上默认启用（通过<strong>innodb_file_per_table=ON</strong>控制）</li>
<li>每张表对应一个<strong>独立的ibd文件</strong>（如user.ibd），表数据和索引单独存储</li>
</ul>
</li>
</ul>
<blockquote>
<p>这样设计有什么好处？</p>
</blockquote>
<ul>
<li><strong>数据隔离</strong>：独立表空间下，单表的增删改查、<strong>备份迁移</strong>不影响其他表；</li>
<li><strong>元数据管理</strong>：系统表空间<strong>统一维护</strong> InnoDB 的 “数据字典”（记录表结构、列类型等元信息）</li>
</ul>
<blockquote>
<p>有没有实战案例？</p>
</blockquote>
<p>100G 大表order需要迁移，对比 独立表空间 和 共享表空间：</p>
<ul>
<li>若用<strong>独立表空间</strong>：直接拷贝order.ibd文件，配合ALTER TABLE order DISCARD TABLESPACE/IMPORT TABLESPACE命令，10 分钟内可完成迁移；</li>
<li>若用系统表空间：需备份整个<strong>ibdata1</strong>文件（可能几百 G），迁移效率极低，且恢复时易影响其他表。</li>
</ul>
<p>所以，<strong>生产环境</strong>必须<strong>启用独立表空间</strong></p>
<p>还有，ibdata1文件 有<strong>扩容后无法收缩</strong>的特点！</p>
<ul>
<li>系统表空间的ibdata1文件默认 <strong>自动扩容</strong>，但扩容后无法收缩</li>
<li>即使<strong>删除数据</strong>，空间也不会释放</li>
<li>若ibdata1超过 <strong>50G</strong>，会导致 MySQL 启动变慢、磁盘 IO 负载升高</li>
<li>此时需通过 “导出数据→重建实例→导入数据” 的方式收缩表空间</li>
</ul>
<h3 data-id="heading-3">段</h3>
<p><strong>段</strong>（Segment）用于区分 <strong>数据</strong> 与 <strong>索引</strong> 的存储</p>
<p>段类型有主要有两类，还有一些其他的类型：</p>
<ul>
<li>
<p><strong>数据段</strong>（Data Segment）</p>
<ul>
<li>存储表的<strong>真实业务数据</strong>；</li>
<li>本质是<strong>聚簇索引</strong>的叶子节点段</li>
<li><strong>聚簇索引</strong>的叶子节点直接包含<strong>完整行数据</strong>，数据段就是聚簇索引<strong>叶子节点</strong>的存储空间</li>
</ul>
</li>
<li>
<p><strong>索引段</strong>（Index Segment）</p>
<ul>
<li>存储索引的<strong>非叶子节点</strong>（以及二级索引的叶子节点），用于实现索引的快速查找逻辑</li>
<li>二级索引的叶子节点也存于索引段，这是因为二级索引叶子节点不存实际数据，<strong>只存主键值</strong></li>
</ul>
</li>
</ul>
<p>还有其他类型的段：</p>
<ul>
<li>
<p><strong>回滚段</strong></p>
<ul>
<li>InnoDB 中专门存储<strong>Undo Log</strong>（撤销日志） 的段，默认位于共享表空间（ibdata1）</li>
<li>也可通过配置innodb_undo_tablespaces设置为独立表空间</li>
<li>每个回滚段由多个 <strong>Undo 页</strong>组成</li>
</ul>
</li>
<li>
<p><strong>临时段</strong></p>
<ul>
<li>是 InnoDB 为<strong>临时表</strong>、<strong>临时数据</strong>操作分配的段，</li>
<li>存储于临时表空间（ibtmp1）,独立于普通表空间，仅用于存放临时数据</li>
<li><strong>显式临时表存储:</strong> 用户通过CREATE TEMPORARY TABLE创建的<strong>临时表</strong></li>
<li><strong>隐式临时数据处理: <strong>SQL 执行过程中产生的</strong>临时数据</strong>（如<strong>ORDER BY排序</strong>、<strong>GROUP BY分组</strong>、<strong>DISTINCT去重</strong>、<strong>子查询</strong>等），会先存入临时段，处理完成后销毁</li>
</ul>
</li>
<li>
<p><strong>缓冲段</strong></p>
<ul>
<li><strong>专门存储Change Buffer（插入缓冲） 数据</strong></li>
</ul>
</li>
</ul>
<p>段没有固定大小，会随数据量动态扩展，且扩展的最小单位是 “区”</p>
<p>来来来，详细了解一下 区</p>
<h3 data-id="heading-4">区</h3>
<p>区（Extent）是 InnoDB 中<strong>连续页的集合</strong>，是段扩展的 <strong>最小单位，</strong> 默认配置下：</p>
<ul>
<li>区大小固定为 <strong>1MB</strong>；</li>
<li>因 InnoDB 默认页大小为 <strong>16KB</strong>，故 1 个区包含 1MB / 16KB = 64个连续页</li>
</ul>
<blockquote>
<p>实战案例有哪些？</p>
</blockquote>
<p>电商项目的product表（存储商品信息，高频查询库存字段），当某类商品（如 “<strong>手机</strong>”）成为热点时：</p>
<ul>
<li>为product表的数据段分配多个<strong>连续区</strong>，热点商品的数据集中存储在这些区中；</li>
<li><strong>预读机制</strong>（Read Ahead）会一次性将整个区（1MB）的数据加载到 <strong>Buffer Pool</strong>中；</li>
<li>后续查询该类商品时，直接从内存读取，无需频繁**访问磁盘 **</li>
<li>InnoDB对区分配 有策略： <strong>区翻倍分配</strong></li>
</ul>
<blockquote>
<p>什么是 区翻倍分配 策略？</p>
</blockquote>
<ul>
<li>表刚创建时，数据段仅分配 1 个区；</li>
<li>当数据量达到区容量的 <strong>50</strong>% 时，下次分配 <strong>2</strong> 个区；</li>
<li>再满则分配 4 个区、8 个区…… 以此类推，直到单次分配 64 个区后稳定</li>
</ul>
<p>这种策略能避免 <strong>小数据量时频繁分配区</strong> 的性能开销，同时适配大数据量的扩展需求</p>
<h3 data-id="heading-5">页</h3>
<p>页（Page）InnoDB磁盘操作的<strong>最小单位</strong></p>
<p>无论读还是写，都必须整页操作</p>
<p>默认页大小为 <strong>16</strong>KB,可通过innodb_page_size参数,修改为 4KB、8KB、32KB 等</p>
<p>核心页类型包括：</p>
<ul>
<li><strong>数据页</strong>（Data Page）：存储表数据，是 B + 树的 <strong>叶子节点</strong></li>
<li><strong>索引页</strong>（Index Page）：存储索引条目，是 B + 树的 <strong>非叶子节点</strong></li>
<li><strong>日志页</strong>（Log Page）：存储 redo log、undo log 等日志数据</li>
</ul>
<blockquote>
<p>实战案例是什么？</p>
</blockquote>
<p>我们平常说的<strong>避免全表扫描</strong>，本质就是避免 <strong>加载过多数据页</strong></p>
<ul>
<li>假设user表有 100 万行数据，每行约 1KB，1 个数据页可存 16 行，<strong>全表扫描</strong>需加载 100万 / 16 ≈ 62500个页，需发起数万次磁盘 IO；</li>
<li>若走<strong>主键查询</strong>（select * from user where id=1001）：B + 树索引只需加载 3 个页（根节点→子节点→叶子节点数据页），仅 3 次 IO，效率相差万倍</li>
</ul>
<h3 data-id="heading-6">行</h3>
<p>行是 InnoDB 存储的最小逻辑单位，对应数据表中的<strong>一条记录</strong></p>
<p>InnoDB 支持多种行格式，核心格式有</p>
<ul>
<li><strong>Compact</strong>：MySQL 5.6 默认格式，对短字段紧凑存储，长字段（超过一定长度）会将部分数据存到 “溢出页”；</li>
<li><strong>Dynamic</strong>：MySQL 5.7 及以上默认格式，长字段（如TEXT、BLOB）的所有数据都存到 “溢出页”，数据页仅保留 20 字节的指针</li>
</ul>
<blockquote>
<p>溢出页是什么？</p>
</blockquote>
<p>专门用于存放 <strong>超长字段</strong>（如 TEXT、BLOB、超长 VARCHAR）数据的<strong>独立页面</strong></p>
<p>原数据页里只保留20 字节的指针，这个指针相当于 <strong>地址标签</strong>，记录着溢出页的位置</p>
<blockquote>
<p>有没有可能一条数据太大导致占用超过16k(超过一页)？</p>
</blockquote>
<p>InnoDB有硬性规定：单行数据的实际存储大小不能超过页大小的<strong>一半</strong>（约 8KB）</p>
<p>目的是保证一个数据页至少能容纳<strong>两行数据</strong>，避免存储结构崩溃</p>
<p>如果一行数据包含多个 TEXT/BLOB、超长 VARCHAR，确实会触发 <strong>行溢出</strong></p>
<p><strong>但 InnoDB 通过之前提到的溢出页机制+行拆分逻辑来解决。</strong></p>
<p>在 段中 提到 <strong>Change Buffer</strong> ，和 区中提到 <strong>Buffer Poo</strong>l 到底 是啥来的？来跟强子仔细研究一下~~</p>
<h2 data-id="heading-7">Change Buffer</h2>
<h3 data-id="heading-8">定义</h3>
<p>内存中一块临时存储区域</p>
<p>专门缓存对<strong>非唯一二级索引</strong>的 插入 / 更新 / 删除 操作</p>
<p>不直接刷盘，等<strong>合适时机</strong>一次性合并到磁盘索引页</p>
<h3 data-id="heading-9">作用</h3>
<ul>
<li>把修改非唯一二级索引时的<strong>零散随机</strong> I/O，转化为批量顺序 I/O，大幅提升写入性能</li>
<li>比如<strong>批量插入数据</strong>、<strong>高频更新非唯一索引列</strong>时效果明显</li>
</ul>
<h3 data-id="heading-10">解决的核心问题</h3>
<p>二级索引的索引页在磁盘上<strong>分布零散（非顺序）</strong></p>
<p>若修改时索引页不在内存（<strong>Buffer Pool</strong>），需频繁从磁盘<strong>读取索引页</strong>（随机 I/O 效率极低）</p>
<p>Change Buffer 直接跳过 <strong>频繁读磁盘</strong> 步骤，<strong>先缓存修改操作</strong>，避免了这个痛点</p>
<h3 data-id="heading-11">限制</h3>
<ul>
<li>只适用于<strong>非唯一二级索引</strong>，唯一索引需实时校验唯一性，不能缓冲；</li>
<li><strong>聚簇索引、已在内存</strong>的索引页，不适用（聚簇索引直接操作数据页，内存索引页可直接修改）。</li>
</ul>
<h2 data-id="heading-12">Buffer Pool</h2>
<p>本质是一块从内存中划分出的<strong>缓存空间</strong></p>
<p>专门用来缓存磁盘上的数据页（表数据）和索引页，以及索引变更、行数据等相关信息</p>
<p>核心目标是<strong>减少磁盘 I/O</strong>、<strong>提升读写性能</strong></p>
<h3 data-id="heading-13">作用</h3>
<h4 data-id="heading-14">读缓存</h4>
<p>查询数据时，先从 Buffer Pool 找<strong>数据页</strong> / <strong>索引页</strong>，找到就直接返回（“缓存命中”），不用读磁盘；</p>
<p>没找到才从磁盘加载到 Buffer Pool，后续再查就走内存，速度提升成百上千倍。</p>
<h4 data-id="heading-15">写缓存</h4>
<p>修改数据时，先更新 Buffer Pool 里的<strong>缓存页</strong>（标记为 “脏页”），</p>
<p><strong>不立即</strong>刷到磁盘，而是由后台线程批量异步刷盘</p>
<p>避免频繁磁盘写，提升写入效率</p>
<h3 data-id="heading-16">数据结构</h3>
<p>Buffer Pool 按 <strong>页</strong>（和磁盘数据页大小一致，默认 16KB）划分</p>
<p>每个缓存页对应磁盘上的一个数据页 / 索引页</p>
<p>用 <strong>最近最少使用LRU</strong> 算法管理缓存页</p>
<p>把<strong>常用的页</strong>留在链表前端，<strong>不常用的页</strong>在末端</p>
<p>内存满时淘汰末端页，保证缓存命中率</p>
<h3 data-id="heading-17">机制</h3>
<p>被修改但未刷到磁盘的缓存页叫 <strong>脏页</strong></p>
<p>由后台线程在<strong>空闲时</strong>或<strong>满足阈值时</strong>批量刷到磁盘</p>
<h2 data-id="heading-18">SQL 各子句的执行顺序</h2>
<h3 data-id="heading-19">执行顺序</h3>
<h4 data-id="heading-20">FROM/JOIN</h4>
<ul>
<li>确定<strong>数据来源</strong>：加载 FROM 后的<strong>表</strong>，处理 JOIN（内连接 / 外连接等）<strong>关联的表</strong></li>
<li>生成 <strong>基础数据集</strong>，包含所有关联后的行</li>
</ul>
<h4 data-id="heading-21">WHERE</h4>
<p>对第一步的基础数据集做<strong>行级过滤</strong>：只保留满足 <strong>WHERE</strong> 条件的行</p>
<p>此时还未分组，不能用<strong>聚合函数</strong>如 SUM ()</p>
<h4 data-id="heading-22">GROUP BY</h4>
<p>按指定字段对过滤后的<strong>行分组</strong>：相同字段值的行被合并为一个组</p>
<p>后续<strong>聚合函数</strong>（如 COUNT、AVG）基于组计算</p>
<h4 data-id="heading-23">HAVING</h4>
<p>对分组后的结果做<strong>组级过滤</strong>：只保留满足 HAVING 条件的组</p>
<p>可以用<strong>聚合函数</strong>，比如HAVING AVG(salary) &gt; 5000</p>
<h4 data-id="heading-24">SELECT</h4>
<p>从前面处理后的<strong>结果</strong>中选择<strong>要显示的列</strong></p>
<p>包括字段、聚合函数计算结果、别名等</p>
<h4 data-id="heading-25">DISTINCT</h4>
<p>对 <strong>SELECT</strong> 选出的结果<strong>去重</strong>，<strong>去除重复行</strong></p>
<h4 data-id="heading-26">ORDER BY</h4>
<p>按指定列 / 表达式对<strong>结果集排序</strong></p>
<p>此时可以用 SELECT 里的<strong>别名</strong>，因为 SELECT 已经执行</p>
<h4 data-id="heading-27">LIMIT/OFFSET</h4>
<p>最后限制<strong>结果集</strong>的行数</p>
<ul>
<li>如LIMIT 10取前 10 行</li>
<li>或跳过指定行数（OFFSET 5）</li>
</ul>
<h3 data-id="heading-28">验证</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> dept_id, <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_sal
<span class="hljs-keyword">FROM</span> employee
<span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_id
<span class="hljs-keyword">HAVING</span> avg_sal <span class="hljs-operator">&gt;</span> <span class="hljs-number">5000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_sal <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>;
</code></pre>
<p>执行顺序对应：</p>
<ul>
<li>先从<strong>employee</strong>表加载数据（<strong>FROM</strong>）；</li>
<li>过滤出<strong>dept_id</strong> &gt; 10的行（<strong>WHERE</strong>）；</li>
<li>按dept_id<strong>分组</strong>（<strong>GROUP BY</strong>）；</li>
<li>保留平均工资 &gt; 5000 的组（<strong>HAVING</strong>）；</li>
<li>选择dept_id和平均工资（<strong>SELECT</strong>，别名<strong>avg_sa</strong>l生效）；</li>
<li>按<strong>avg_sal</strong>降序排序（<strong>ORDER BY</strong>）；</li>
<li>取前 5 组（<strong>LIMIT</strong>）</li>
</ul>
<h2 data-id="heading-29">总结</h2>
<p>今天我们了解了Mysql是怎么<strong>存储数据</strong>的，也知道了sql<strong>子句执行流程</strong>是怎么样的，顺便还了解了一下Mysql的<strong>缓存机制</strong>~</p>
<ul>
<li>InnoDB 靠表空间 - 段 - 区 - 页架构存储数据，搭配数据段、索引段、溢出页等解决存储难题；</li>
<li>SQL 按 “FROM→WHERE→GROUP BY→SELECT→ORDER BY→LIMIT” 的固定顺序执行。</li>
<li>Buffer Pool 缓存数据和索引减磁盘 I/O，Change Buffer 优化非唯一二级索引写入；</li>
</ul>
<p>带着底层视角开发，解决问题会更精准~</p>
<p>熟练度刷不停，知识点吃透稳，下期接着练～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门]]></title>    <link>https://juejin.cn/post/7577689171222937650</link>    <guid>https://juejin.cn/post/7577689171222937650</guid>    <pubDate>2025-11-30T01:44:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171222937650" data-draft-id="7577705544875130918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-30T01:44:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Raink"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383566072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383566072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Raink
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T01:44:12.000Z" title="Sun Nov 30 2025 01:44:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文以仿猫眼电影M站首页布局为案例，展示ArkUI在实际开发中的应用。内容包括案例效果及相关知识点，深入解析布局框架以及头部、脚部、内容区域的构建思路与代码实现，最后提供完整代码和教程资源，助力你强化实践能力。</p>
<h2 data-id="heading-0">1. 案例效果截图</h2>
<p>如图1-1所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfc35d42a0754170a4e6d0ff5a538416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=8jLo7XO%2BBtUctc7TbMNUctZazC8%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a342b873934f4b1cac11c16acfa55de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=0a9NE1ghSJLQi9jeN5sx%2BIez9Eg%3D" alt="" loading="lazy"/></p>
<p><strong>图1-1</strong> 案例效果截图</p>
<h2 data-id="heading-1">2. 案例运用到的知识点</h2>
<ol>
<li><strong>核心知识点</strong></li>
</ol>
<ul>
<li>UI范式基本语法。</li>
<li>文本显示Text、Span组件。</li>
<li>线性布局Column、Row组件。</li>
<li>层叠布局Stack组件。</li>
<li>按钮Button组件。</li>
<li>显示图片Image组件。</li>
</ul>
<ol start="2">
<li><strong>其他知识点</strong></li>
</ol>
<ul>
<li>DevEco Studio的基本使用。</li>
<li>简单的资源分类访问。</li>
<li>移动端APP布局基本技巧。</li>
</ul>
<h2 data-id="heading-2">3. 布局框架</h2>
<p>可以按照图3-1来思考布局的框架：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd2533ada3d46ceacf3a472f8dd8739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=DchyvIeZrS9n6Ud4HQukp%2BVUISE%3D" alt="" loading="lazy"/></p>
<p><strong>图3-1</strong> 布局框架图</p>
<p>框架的代码如下：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct Index {
  <span class="hljs-selector-tag">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-selector-tag">Stack</span>() {}
        .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-built_in">height</span>(<span class="hljs-number">50</span>).<span class="hljs-built_in">backgroundColor</span>(<span class="hljs-string">'#e54847'</span>)
      
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'content'</span>)
      }<span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
      
      <span class="hljs-selector-tag">Row</span>() {}
        .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-built_in">height</span>(<span class="hljs-number">50</span>).<span class="hljs-built_in">backgroundColor</span>(<span class="hljs-string">'#fff'</span>)
        .<span class="hljs-built_in">border</span>({<span class="hljs-attribute">width</span>: { <span class="hljs-attribute">top</span>: <span class="hljs-number">1</span>}, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#eee'</span>})
    }
  }
}
</code></pre>
<h2 data-id="heading-3">4. 头部区域</h2>
<p>可以按照图4-1思路来构建布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3562829c7a114dc8b181e2ee2e681921~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=zpmYtnsWDON7TLTXp9FNAupWMlU%3D" alt="" loading="lazy"/></p>
<p><strong>图4-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 头部区域</span>
<span class="hljs-built_in">Stack</span>({ alignContent: Alignment.End }) {
  Text('猫眼电影')
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
    <span class="hljs-selector-class">.fontColor</span>('#fff')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)
  <span class="hljs-built_in">Image</span>($rawfile('menu.png'))
    <span class="hljs-selector-class">.width</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.margin</span>({ right: <span class="hljs-number">10</span> })
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)<span class="hljs-selector-class">.backgroundColor</span>('#e54847')
</code></pre>
<h2 data-id="heading-4">5. 脚部区域</h2>
<p>可以按照图5-1思路来构建布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/109af3e0cee54de8ae3559e0ec30c1db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=DuwJj6mDG6kvGYE8k2hzJKnFuzo%3D" alt="" loading="lazy"/></p>
<p><strong>图5-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 脚部区域</span>
<span class="hljs-built_in">Row</span>() {
  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('movie.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#e54847')
    Text('电影/影院')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#e54847')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('video.png'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('视频')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('perform.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('演出')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('mine.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('我的')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)
}
<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)<span class="hljs-selector-class">.border</span>({ width: { top: <span class="hljs-number">1</span> }, color: '#eee' })
<span class="hljs-selector-class">.backgroundColor</span>('#fff')
</code></pre>
<h2 data-id="heading-5">6. 内容区域</h2>
<p>可以参照图6-1思考内容区域的整体框架布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e81cb7e910be4a739dc5285ba98dcac9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=X6uthT%2ByeC4P6cmmPhPXoEEgWIY%3D" alt="" loading="lazy"/></p>
<p><strong>图6-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 内容区域</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-built_in">Row</span>() {}
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">44</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">1</span>}, color: '#e6e6e6'})

  Scroll() {}
    <span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-6">6.1. 导航区</h3>
<p>内容区域的导航区可以参照图6-2思考布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bec5f9d4f9d04ba8ae2abca42bc14491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=7075OJDENp224ocqy1UgLmJZMiE%3D" alt="" loading="lazy"/></p>
<p><strong>图6-2</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 导航区</span>
<span class="hljs-built_in">Row</span>() {
  <span class="hljs-built_in">Row</span>() {
    Text('北京')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')
    Text('')
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">0</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">0</span>)
      <span class="hljs-selector-class">.border</span>({
        width: <span class="hljs-number">5</span>,
        color: {
          top: '#b0b0b0',
          left: Color.Transparent,
          right: Color.Transparent,
          bottom: Color.Transparent
        }
      })
      <span class="hljs-selector-class">.margin</span>({top: <span class="hljs-number">6</span>, left: <span class="hljs-number">4</span>})
  }<span class="hljs-selector-class">.offset</span>({x: <span class="hljs-number">15</span>})<span class="hljs-selector-class">.width</span>(<span class="hljs-number">60</span>)

  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Stack</span>() {
      Text('热映')
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
      Text('')
        <span class="hljs-selector-class">.width</span>(<span class="hljs-number">24</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">3</span>}, color: '#e54847'})<span class="hljs-selector-class">.offset</span>({y: <span class="hljs-number">18</span>})
    }
    Text('影院')
    Text('待映')
    Text('经典电影')
  }<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)

  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('search-red.png'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">20</span>)
  }<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">50</span>)
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">44</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">1</span>}, color: '#e6e6e6'})
</code></pre>
<h3 data-id="heading-7">6.2. 最受好评区</h3>
<p>可以参照图6-3考虑整体布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/351a4dfe5ba840f0ba72d8177add0cc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=KxjZlO1BrpnkQRBhJeMKkunh3fk%3D" alt="" loading="lazy"/></p>
<p><strong>图6-3</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 好评和列表区内容</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-comment">// 好评区</span>
  <span class="hljs-built_in">Column</span>() {
    Text('最受好评电影')
      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">333</span>')
      <span class="hljs-selector-class">.textAlign</span>(TextAlign.Start)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">12</span> })
    Scroll() {
      <span class="hljs-built_in">Row</span>() {
        <span class="hljs-built_in">Column</span>() {
          <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.BottomStart }) {
            <span class="hljs-built_in">Image</span>('https://p0.pipi.cn/basicdata/' 
                  + '<span class="hljs-number">54</span>ecdeddf2a92339dd2c95022e99e5fe27091.jpg?' 
                  + 'imageMogr2/thumbnail/<span class="hljs-number">2500</span>x2500%<span class="hljs-number">3</span>E'
            )<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">115</span>)
            Text('')
              <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">35</span>)<span class="hljs-selector-class">.linearGradient</span>({
                direction: GradientDirection.Bottom, 
                colors: [['rgba(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)', <span class="hljs-number">0</span>], <span class="hljs-selector-attr">[0x000000, 1]</span>] 
              })
            Text('观众评分：<span class="hljs-number">9.6</span>')
              <span class="hljs-selector-class">.fontColor</span>('#faaf00')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">11</span>)
              <span class="hljs-selector-class">.fontWeight</span>(<span class="hljs-number">700</span>)<span class="hljs-selector-class">.offset</span>({ x: <span class="hljs-number">4</span>, y: -<span class="hljs-number">4</span> })
          }<span class="hljs-selector-class">.height</span>(<span class="hljs-number">115</span>)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">6</span> })
          Text('出走的决心')
            <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)
            <span class="hljs-selector-class">.textAlign</span>(TextAlign.Start)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">3</span> })
        }<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)<span class="hljs-selector-class">.margin</span>({ right: <span class="hljs-number">10</span> })

        <span class="hljs-comment">// ... 其余7个Column与上述结构相同，因篇幅限制已省略，详见本书配套源码。</span>
      }
    }
    <span class="hljs-selector-class">.scrollable</span>(ScrollDirection.Horizontal)<span class="hljs-selector-class">.scrollBar</span>(BarState.Off)
    <span class="hljs-selector-class">.edgeEffect</span>(EdgeEffect.Spring)
  }<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.padding</span>({ top: <span class="hljs-number">12</span>, bottom: <span class="hljs-number">12</span>, left: <span class="hljs-number">15</span>, right: <span class="hljs-number">15</span> })
}<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
</code></pre>
<h3 data-id="heading-8">6.3. 列表区</h3>
<p>列表区整体布局参照图6-4。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02597159af9f4679bf1d0bbf7572804b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=HD6Q3CwQU1VIrDJobuO4ug3Ct4k%3D" alt="" loading="lazy"/></p>
<p><strong>图6-4</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 列表区</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Image</span>('https://p0.pipi.cn/basicdata/' 
          + '<span class="hljs-number">54</span>ecdedd5377e187a9e7aa5ee9ec15a184b18.jpg?' 
          + 'imageMogr2/thumbnail/<span class="hljs-number">2500</span>x2500%<span class="hljs-number">3</span>E?imageView2/<span class="hljs-number">1</span>/w/<span class="hljs-number">128</span>/h/<span class="hljs-number">180</span>'
    )<span class="hljs-selector-class">.width</span>(<span class="hljs-number">64</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">90</span>)
    
    <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.End }) {
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-built_in">Row</span>() {
          Text('志愿军：存亡之战')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
          <span class="hljs-built_in">Image</span>($rawfile('v2dimax.png'))<span class="hljs-selector-class">.width</span>(<span class="hljs-number">43</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">14</span>)<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">4</span> })
        }
        Text() {
          <span class="hljs-selector-tag">Span</span>('<span class="hljs-number">274337</span>')<span class="hljs-selector-class">.fontColor</span>('#faaf00')
          <span class="hljs-selector-tag">Span</span>('人想看')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
        }
        Text('主演: 朱一龙,辛柏青,张子枫')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
        Text('<span class="hljs-number">2024</span>-<span class="hljs-number">09</span>-<span class="hljs-number">30</span> 下周一上映')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
      }
        <span class="hljs-selector-class">.alignItems</span>(HorizontalAlign.Start)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)<span class="hljs-selector-class">.padding</span>({ right: <span class="hljs-number">53</span> })
      
      <span class="hljs-selector-tag">Button</span>() {
        Text('预售')<span class="hljs-selector-class">.fontColor</span>('#fff')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)<span class="hljs-selector-class">.fontWeight</span>(<span class="hljs-number">500</span>)
      }<span class="hljs-selector-class">.width</span>(<span class="hljs-number">54</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">28</span>)<span class="hljs-selector-class">.backgroundColor</span>('#<span class="hljs-number">3</span>C9FE6')
      
    }
      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">12</span> })
      <span class="hljs-selector-class">.padding</span>({ top: <span class="hljs-number">12</span>, right: <span class="hljs-number">14</span>, bottom: <span class="hljs-number">12</span>, left: <span class="hljs-number">0</span> })
      <span class="hljs-selector-class">.border</span>({ width: { bottom: <span class="hljs-number">1</span> }, color: '#eee' })
  }<span class="hljs-selector-class">.height</span>(<span class="hljs-number">144</span>)

  <span class="hljs-comment">// ... 其余7个Row与上述结构相同，因篇幅限制已省略，详见本书配套源码。</span>
}<span class="hljs-selector-class">.backgroundColor</span>('#fff')<span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">15</span> })
</code></pre>
<p><strong>--THE END--</strong></p>
<p>本文配套视频教程观看地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669240%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669240?spm=3001.4143" ref="nofollow noopener noreferrer">11-猫眼电影M站布局实战-布局框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669241%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669241?spm=3001.4143" ref="nofollow noopener noreferrer">12-猫眼电影M站布局实战-头部区域布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669242%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669242?spm=3001.4143" ref="nofollow noopener noreferrer">13-猫眼电影M站布局实战-脚部区域布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669243%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669243?spm=3001.4143" ref="nofollow noopener noreferrer">14-猫眼电影M站布局实战-内容导航区布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669244%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669244?spm=3001.4143" ref="nofollow noopener noreferrer">15-猫眼电影M站布局实战-最受电影区布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669245%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669245?spm=3001.4143" ref="nofollow noopener noreferrer">16-猫眼电影M站布局实战-列表布局</a></p>
<p>✋ 需要参加鸿蒙认证的请点击 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F930c921fb4964857843b5540e7fa5cf3%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/930c921fb4964857843b5540e7fa5cf3?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙认证链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS 应用开发基础案例（三）：使用DevEco Studio高效开发（篇一）]]></title>    <link>https://juejin.cn/post/7577693903018721306</link>    <guid>https://juejin.cn/post/7577693903018721306</guid>    <pubDate>2025-11-30T01:50:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903018721306" data-draft-id="7577693903018704922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS 应用开发基础案例（三）：使用DevEco Studio高效开发（篇一）"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-30T01:50:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Raink"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383566072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS 应用开发基础案例（三）：使用DevEco Studio高效开发（篇一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383566072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Raink
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T01:50:41.000Z" title="Sun Nov 30 2025 01:50:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>HUAWEI DevEco Studio是基于IntelliJ IDEA Community开源版本打造，为运行在HarmonyOS系统上的应用和元服务提供一站式的开发平台。</p>
<p>作为一款开发工具，除了具有基本的代码开发、编译构建及调测等功能外，DevEco Studio还具有如下特点：</p>
<ul>
<li>高效智能代码编辑：支持ArkTS、JS、C/C++等语言的代码高亮、代码智能补齐、代码错误检查、代码自动跳转、代码格式化、代码查找等功能，提升代码编写效率。</li>
<li>多端双向实时预览：支持UI界面代码的双向预览、实时预览、动态预览、组件预览以及多端设备预览，便于快速查看代码运行效果。</li>
<li>多端设备模拟仿真：提供HarmonyOS本地模拟器，支持Phone等设备的模拟仿真，便捷获取调试环境。</li>
<li>DevEco Profiler性能调优：提供实时监控能力和场景化调优模板，便于全方位的设备资源监测，采集数据覆盖多个维度，为开发者带来高效、直通代码行的调优体验。</li>
</ul>
<h2 data-id="heading-0">1. 工程管理</h2>
<p>DevEco Studio的工程管理涵盖应用和元服务的结构，其中APP Pack由HAP包和pack.info文件组成；支持工程目录的两种视图形式，并展示基于ArkTS Stage模型的目录结构；同时提供多种工程模板及创建新工程的详细流程，帮助开发者高效搭建与管理项目。</p>
<h3 data-id="heading-1">1.1. 工程介绍</h3>
<h4 data-id="heading-2">1.1.1. App包结构</h4>
<p>在进行应用/元服务开发前，我们应该掌握应用/元服务的逻辑结构。</p>
<p>应用/元服务发布形态为APP Pack（Application Package），它是由一个或多个HAP（Harmony Ability Package）包以及描述APP Pack属性的pack.info文件组成。</p>
<p>一个HAP在工程目录中对应一个Module，它是由代码、资源、三方库及应用/元服务配置文件组成，HAP可以分为Entry和Feature两种类型。</p>
<ul>
<li><strong>Entry：</strong> 应用的主模块，作为应用的入口，提供了应用的基础功能。</li>
<li><strong>Feature：</strong> 应用的动态特性模块，作为应用能力的扩展，可以根据用户的需求和设备类型进行选择性安装。</li>
</ul>
<p>Stage模型应用程序包结构如图1所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/618f0c2d3f3e4f34977e1c80769bbb70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=DiFW6TdqbG4Vpy9TUj7Zg3E0R%2BM%3D" alt="" loading="lazy"/></p>
<p><strong>图1</strong> App包结构</p>
<h4 data-id="heading-3">1.1.2. 切换工程视图</h4>
<p>DevEco Studio工程目录结构提供工程视图和Ohos视图。工程视图（Project）展示工程中实际的文件结构，Ohos视图会隐藏一些编码中不常用到的文件，并将常用到的文件进行重组展示，方便开发者查询或定位所需编辑的模块或文件。</p>
<p>工程创建或打开后，默认显示工程视图，如果要切换到Ohos视图，在左上角单击<strong>Project</strong> &gt; <strong>Ohos</strong>进行切换 <strong>。</strong> 如图2所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05372fd937044f848470e9242c542d78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=oSpB5kJP7kx9vtTzdcmyT0iYvp8%3D" alt="" loading="lazy"/></p>
<p><strong>图2</strong> 工程视图目录截图</p>
<h3 data-id="heading-4">1.2. 工程目录结构</h3>
<p>ArkTS Stage模型支持API Version 10及以上版本，其工程目录结构如图3所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8961e7d9f8c14cee88102319f29db4bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=OKDhSQvfFY7VrZTNz9UuBUSQCgo%3D" alt="" loading="lazy"/></p>
<p><strong>图3</strong> 某工程目录结构</p>
<ul>
<li><strong>AppScope &gt; app.json5</strong>：应用的全局配置信息。</li>
<li><strong>entry：</strong> 应用/元服务模块，编译构建生成一个HAP。</li>
</ul>

<ul>
<li>
<ul>
<li><strong>src &gt; main &gt; ets</strong>：用于存放ArkTS源码。</li>
<li><strong>src &gt; main &gt; ets &gt; entryability</strong>：应用/元服务的入口。</li>
<li><strong>src &gt; main &gt; ets &gt; pages</strong>：应用/元服务包含的页面。</li>
<li><strong>src &gt; main &gt; resources：</strong> 用于存放应用/元服务模块所用到的资源文件，如图形、多媒体、字符串、布局文件等。如表4-1所示。</li>
</ul>
</li>
</ul>













<table><thead><tr><th><strong>资源目录</strong></th><th><strong>资源文件说明</strong></th></tr></thead><tbody><tr><td>base&gt;element</td><td>包括字符串、整型数、颜色、样式等资源的json文件。每个资源均由json格式进行定义，例如：-   -   -   boolean.json：布尔型</td></tr></tbody></table>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">    -</span>   color.json：颜色
<span class="hljs-bullet">    -</span>   float.json：浮点型
<span class="hljs-bullet">    -</span>   intarray.json：整型数组
<span class="hljs-bullet">    -</span>   integer.json：整型
<span class="hljs-bullet">    -</span>   pattern.json：样式
<span class="hljs-bullet">    -</span>   plural.json：复数形式
<span class="hljs-bullet">    -</span>   strarray.json：字符串数组
<span class="hljs-bullet">    -</span>   string.json：字符串值 |
</code></pre>
<p>| base&gt;media   | 多媒体文件，如图形、视频、音频等文件，支持的文件格式包括： <strong>.png</strong>、 <strong>.gif</strong>、 <strong>.mp3</strong>、 <strong>.mp4</strong>等。                                                                                                                                                                                                                                           |
| rawfile      | 用于存储任意格式的原始资源文件。rawfile不会根据设备的状态去匹配不同的资源，需要指定文件路径和文件名进行引用。                                                                                                                                                                                                                                                       |</p>
<p><strong>表4-1</strong> 资源目录与文件说明</p>
<ul>
<li>
<ul>
<li><strong>src &gt; main &gt; module.json5</strong>：Stage模型模块配置文件，主要包含HAP的配置信息、应用在具体设备上的配置信息以及应用的全局配置信息。</li>
<li><strong>build-profile.json5：</strong> 当前的模块信息、编译信息配置项，包括buildOption、targets配置等。</li>
<li><strong>hvigorfile.ts</strong>：模块级编译构建任务脚本。</li>
<li><strong>oh-package.json5</strong>：描述三方包的包名、版本、入口文件（类型声明文件）和依赖项等信息。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>oh_modules</strong>：用于存放三方库依赖信息，包含应用/元服务所依赖的第三方库文件。</li>
<li><strong>build-profile.json5：</strong> 应用级配置信息，包括签名、产品配置等。</li>
<li><strong>hvigorfile.ts：</strong> 应用级编译构建任务脚本。</li>
<li><strong>oh-package.json5：</strong> 描述全局配置，如：依赖覆盖（overrides）、依赖关系重写（overrideDependencyMap）和参数化配置（parameterFile）等。</li>
</ul>
<h3 data-id="heading-5">1.3. 工程模板介绍</h3>
<p>DevEco Studio支持多种品类的应用/元服务开发，预置丰富的工程模板，可以根据工程向导轻松创建适应于各类设备的工程，并自动生成对应的代码和资源模板。同时，DevEco Studio还提供了多种编程语言供开发者进行应用/元服务开发，包括ArkTS、JS和C/C++。如图4所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ddcd7e3ba1e4cc6a5548aa317ccc464~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=uZUaXJsMq%2FBe3N7chRuYdonotIQ%3D" alt="" loading="lazy"/></p>
<p><strong>图4</strong> 创建项目</p>
<p>工程模板支持的开发语言及模板说明如表4-2所示：</p>

































<table><thead><tr><th><strong>模板名称</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>Empty Ability</td><td>用于Phone、Tablet、2in1、Car设备的模板，展示基础的Hello World功能。</td></tr><tr><td>Native C++</td><td>用于Phone、Tablet、2in1、Car设备的模板，作为应用调用C++代码的示例工程，界面显示“Hello World”。</td></tr><tr><td>[CloudDev]Empty Ability</td><td>端云一体化开发通用模板。</td></tr><tr><td>[Lite]Empty Ability</td><td>用于Lite Wearable设备的模板，展示了基础的Hello World功能。可基于此模板，修改设备类型及RuntimeOS，进行小型嵌入式设备开发。</td></tr><tr><td>Flexible Layout Ability</td><td>用于创建跨设备应用开发的三层工程结构模板。三层工程结构包含common（公共能力层）、features（基础特性层）、products（产品定制层）。</td></tr><tr><td>Embeddable Ability</td><td>用于开发支持被其他应用嵌入式运行的元服务的工程模板。</td></tr></tbody></table>
<p><strong>表4-2</strong> 模版说明</p>
<h3 data-id="heading-6">1.4. ****创建一个新的工程</h3>
<p>当您开始开发一个应用/元服务时，首先需要根据工程创建向导，创建一个新的工程，工具会自动生成对应的代码和资源模板。</p>
<ol>
<li>通过如下两种方式，打开工程创建向导界面。</li>
</ol>
<ul>
<li>如果当前未打开任何工程，可以在DevEco Studio的欢迎页，选择<strong>Create Project</strong>开始创建一个新工程。</li>
<li>如果已经打开了工程，可以在菜单栏选择<strong>File &gt; New &gt; Create Project</strong>来创建一个新工程。</li>
</ul>
<ol start="2">
<li>根据工程创建向导，选择创建Application或Atomic Service。再选择需要的Ability工程模板，然后单击<strong>Next</strong>。</li>
<li>在工程配置页面，需要根据向导配置工程的基本信息。</li>
</ol>
<ul>
<li><strong>Project name</strong>：工程的名称，可以自定义，由大小写字母、数字和下划线组成。</li>
<li><strong>Bundle name</strong>：标识应用的包名，用于标识应用的唯一性。</li>
<li><strong>Save location</strong>：工程文件本地存储路径，由大小写字母、数字和下划线等组成，不能包含中文字符。</li>
<li><strong>Compatible SDK</strong>：兼容的最低API Version。</li>
<li><strong>Module name</strong>： 模块的名称。</li>
<li><strong>Device type：</strong> 该工程模板支持的设备类型。</li>
</ul>
<p>如图5所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/624dc014b2814698b09fcf6feee5d7b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=CYC554rm%2Fkq3YwzP2mA0fGom83E%3D" alt="" loading="lazy"/></p>
<p><strong>图5</strong> 配置项目</p>
<ol start="4">
<li>单击<strong>Finish</strong>，工具会自动生成示例代码和相关资源，等待工程创建完成。</li>
</ol>
<h2 data-id="heading-7">2. 代码编辑</h2>
<p>本节介绍代码阅读、生成/补全、实时检查与修复、重构等常用操作。DevEco Studio支持多语言代码的高亮显示、快捷跳转和智能格式化，提供自动补全、构造器快速生成等功能，能够实时检测并修复代码错误，同时支持提取方法、重命名等重构操作，有效提升编码效率。</p>
<h3 data-id="heading-8">2.1. 代码阅读</h3>
<p>DevEco Studio支持使用多种语言进行应用/元服务的开发，包括ArkTS、JS和C/C++。在编写应用/元服务阶段，可以通过掌握代码编写的各种常用技巧，来提升编码效率。</p>
<h4 data-id="heading-9">2.1.1. 代码高亮</h4>
<p>支持对代码关键字、运算符、字符串、类、标识符、注释等进行高亮显示，您可以打开<strong>File &gt; Settings</strong>（macOS为<strong>DevEco Studio &gt; Preferences</strong>）面板，在<strong>Editor &gt; Color Scheme</strong>自定义各字段的高亮显示颜色 <strong>。</strong> 默认情况下，您可以在<strong>Language Defaults</strong>中设置源代码中的各种高亮显示方案，该设置将对所有语言生效；如果您需要针对具体语言的源码高亮显示方案进行定制，可以在左侧边栏选择对应的语言，然后取消“Inherit values from”选项后设置对应的颜色即可。如图6所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b2284f65e0146758eddcd43eaa5a0ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=PjBIW8p%2B%2BNiAySx4MYcEQUCEm4s%3D" alt="" loading="lazy"/></p>
<p><strong>图6</strong> 代码高亮设置</p>
<h4 data-id="heading-10">2.1.2. 代码跳转</h4>
<p>在编辑器中，可以按住<strong>Ctrl</strong>键（macOS为<strong>Command</strong>键），鼠标单击代码中引用的类、方法、参数、变量等名称，自动跳转到定义处。若单击定义处的类、变量等名称，当仅有一处引用时，可直接跳转到引用位置；若有多处引用，在弹窗中可以选择想要查看的引用位置。</p>
<h4 data-id="heading-11">2.1.3. 代码格式化</h4>
<p>代码格式化功能可以帮助您快速的调整和规范代码格式，提升代码的美观度和可读性。默认情况下，DevEco Studio已预置了代码格式化的规范，您也可以个性化的设置各个文件的格式化规范，设置方式如下：在<strong>File &gt; Settings &gt; Editor &gt; Code Style</strong>（macOS为<strong>DevEco Studio &gt; Preferences &gt;</strong> ****<strong>Editor</strong> ****<strong>&gt;</strong> ****<strong>Code Style</strong>）下，选择需要定制的文件类型，如ArkTS，然后自定义格式化规范即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e29b80f9774818b9de4efb04675ae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=k2xtFZLDG5s9LoHMIu9SweJVgJ8%3D" alt="" loading="lazy"/></p>
<p><strong>图7 代码格式化设置</strong></p>
<p>在使用代码格式化功能时，您可以使用快捷键<strong>Ctrl + Alt + L</strong>（macOS为<strong>Option+Command +L</strong>） 可以快速对选定范围的代码进行格式化。</p>
<p>如果在进行格式化时，对于部分代码片段不需要进行自动的格式化处理，可以通过如下方式进行设置：</p>
<ol>
<li>在<strong>File &gt; Settings &gt;Editor &gt; Code Style</strong>（macOS为<strong>DevEco Studio &gt; Preferences &gt; Editor &gt; Code Style</strong>），单击“Formatter”，勾选“Turn formatter on/off with markers in code comments”。如图8所示。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9821d101f16c4988ac79e25b0f761adc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=N8SKN0iIMc%2BHb2T3ciEQAZxaLHc%3D" alt="" loading="lazy"/></p>
<p><strong>图8</strong> 代码样式</p>
<p>在不需要进行格式化操作的代码块前增加“//@formatter:off”，并在该代码块的最后增加“//@formatter:on”，即表示对该范围的代码块不需要进行格式化操作。如图9所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a35e9f1a72a49eca2386a98a38a1685~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=Ta06O23LwbYLegx5FTEGnmG7U%2BA%3D" alt="" loading="lazy"/></p>
<p><strong>图9</strong> 代码格式化</p>
<h4 data-id="heading-12">2.1.4. 代码折叠</h4>
<p>支持对代码块的快速折叠和展开，既可以单击编辑器左侧边栏的折叠和展开按钮对代码块进行折叠和展开操作，还可以对选中的代码块单击鼠标右键选择折叠方式，包括折叠、递归折叠、全部折叠等操作。如图10所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c501b9bc1f243248fee75441615c047~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=RDTEOizal4XEQkJZ1YntzlZKzJo%3D" alt="" loading="lazy"/></p>
<p><strong>图10</strong> 代码折叠</p>
<h4 data-id="heading-13">2.1.5. 代码快速注释</h4>
<p>支持对选择的代码块进行快速注释，使用快捷键<strong>Ctrl+/</strong> （macOS为<strong>Command+/</strong> ）进行快速注释。对于已注释的代码块，再次使用快捷键<strong>Ctrl+/</strong> （macOS为<strong>Command+/</strong> ）取消注释。如图11所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5137bc7fbde441918570a4a57e81bbc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=1sFzQxL8%2Bl7DFpIaNDNpi0UDGB8%3D" alt="" loading="lazy"/></p>
<p><strong>图11</strong> 代码注释</p>
<h4 data-id="heading-14">2.1.6. 代码结构树</h4>
<p>使用快捷键<strong>Alt + 7 / Ctrl + F12</strong>（macOS为<strong>Command+7</strong>）打开代码结构树，快速查看文件代码的结构树，包括全局变量和函数，类成员变量和方法等，并可以跳转到对应代码行。如图12所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bb7c90b8a1640c0a5a90175c323c832~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=xpz%2Fmz7ic6VprZTyife8nrfSsuw%3D" alt="" loading="lazy"/></p>
<p><strong>图12</strong> 代码结构树</p>
<h4 data-id="heading-15">2.1.7. 代码引用查找</h4>
<p>提供Find Usages代码引用查找功能，帮助开发者快速查看某个对象(变量、函数或者类等)被引用的地方，用于后续的代码重构，可以极大的提升开发者的开发效率。</p>
<p>使用方法：在要查找的对象上，单击鼠标<strong>右键 &gt; Find Usages</strong>或使用快捷键<strong>Alt +F7</strong>（macOS为<strong>Option +</strong> <strong>F7</strong>）。可点击<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7430824fca34fcb96d46a7c316c5605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=Asnjc33FEaqDayjTcF0gIslELgY%3D" alt="" loading="lazy"/>图标查看变量赋值位置，点击<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e05d4513dfe346ea80ca2e2fa88a3f84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=Ob2wg08s8RKmXM6ypc9jHXnxBuY%3D" alt="" loading="lazy"/>图标查看变量引用情况。如图13所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/945a175dac1c4eab92adb6e79006081f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=Q04RnrzfpD6hqMoo9qCmVZ7K9eA%3D" alt="" loading="lazy"/></p>
<p><strong>图13</strong> 代码引用查找</p>
<h4 data-id="heading-16">2.1.8. 函数注释生成</h4>
<p>DevEco Studio支持在函数定义处，快速生成对应的注释。在函数定义的代码块前，输入 <strong>“/</strong>”+回车键**，快速生成注释信息。如图14所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/748619c8fa6043e8bea8bfc3b779b0f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=kbl8JLZj1PeZId9aaIcBT4Ca3mk%3D" alt="" loading="lazy"/></p>
<p><strong>图14</strong> 函数注释生成</p>
<h4 data-id="heading-17">2.1.9. 代码查找</h4>
<p>通过对符号、类或文件的即时导航来查找代码。检查调用或类型层次结构，轻松地搜索工程里的所有内容。通过连续点击两次Shift快捷键，打开代码查找界面，在搜索框中输入需要查找内容，下方窗口实时展示搜索结果。双击查找的结果可以快速打开所在文件的位置。如图15所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b8dd72af0d846ffa0b30f314794d2b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=FHPcytkRn48mRW22Zk07a2LChEo%3D" alt="" loading="lazy"/></p>
<p><strong>图15</strong> 代码查找</p>
<h4 data-id="heading-18">2.1.10. 快速查阅API接口及组件参考文档</h4>
<p>在编辑器中调用ArkTS/JS API或组件时，支持在编辑器中快速、精准调取出对应的参考文档。</p>
<p>可在编辑器中，鼠标悬停在需要查阅的接口或组件，弹窗将显示当前接口/组件在不同API版本下的参数等信息，单击弹窗右下角Show in API Reference，或选中接口或组件，右键点击Show in API Reference，可以快速查阅更详细的API文档。如图16、图17所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77241bc48f634c34b156417006de4422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=O7MsavzQ8jUQvWsCawMKN%2BOs%2BpI%3D" alt="" loading="lazy"/></p>
<p><strong>图16</strong> 查阅API参考入口</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a196218334c54f3085374409f958d5d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=FwI18KlnZXywkyYmtdCgKyNGq0o%3D" alt="" loading="lazy"/></p>
<p><strong>图17</strong> 快速查阅API</p>
<h4 data-id="heading-19">2.1.11. Optimize Imports功能</h4>
<p>使用编辑器提供的Optimize Imports，可以快速清除未使用的import，并根据设置的规则对import进行合并或排序。选择文件或目录，使用快捷键Ctrl+Alt+O（macOS为Control+Option+O），或单击菜单栏Code &gt; Optimize Imports。</p>
<h3 data-id="heading-20">2.2. 代码生成/补全</h3>
<h4 data-id="heading-21">2.2.1. 代码自动补全</h4>
<p>提供代码的自动补全能力，编辑器工具会分析上下文，并根据输入的内容，提示可补全的类、方法、字段和关键字的名称等，支持模糊匹配。</p>
<p>自动补齐功能默认按最短路径进行排序，如仅需按照最近使用过的类、方法、字段和关键字等名称提供补全内容排序，可以在File &gt; Settings（MacOS为DevEco Studio &gt; Preferences） &gt; Editor &gt; General &gt; Code Completion 中勾选“Sort suggestions by recently used”。</p>
<h4 data-id="heading-22">2.2.2. 快速覆写父类</h4>
<p>DevEco Studio提供Override Methods，辅助开发者根据父类模板快速生成子类方法，提升开发效率。将光标放于子类定义位置，使用快捷键Ctrl+O，或右键单击Generate...，选择Override Methods，指定需要覆写的对象（方法、变量等），点击OK将自动生成该对象的覆写代码。</p>
<h4 data-id="heading-23">2.2.3. 快速生成构造器</h4>
<p>编辑器支持为类快速生成一个对应的构造函数。</p>
<p>在类中使用快捷键Alt+Insert，或单击鼠标右键选择Generate...，在弹窗中选择Constructor，选择一个或多个需要生成构造函数的参数，点击OK。若选择Select None，则生成不带参数的构造器。</p>
<h4 data-id="heading-24">2.2.4. 快速生成get/set方法</h4>
<p>编辑器支持为类成员变量或对象属性快速生成get和set方法。</p>
<p>将光标放置在当前类中，单击右键选择Generate...&gt;Getter and Setter，或者使用快捷键Alt+Insert，在菜单中选择Getter and Setter，完成方法快速生成。</p>
<h3 data-id="heading-25">2.3. 代码实时检查及快速修复</h3>
<h4 data-id="heading-26">2.3.1. 实时检查</h4>
<p>编辑器会实时的进行代码分析，如果输入的语法不符合编码规范，或者出现语义语法错误，将在代码中突出显示错误或警告，将鼠标放置在错误代码处，会提示详细的错误信息。如图18所示。</p>
<p>从DevEco Studio 4.0 Release版本开始，当compatibleSdkVersion≥10时，编辑器代码实时检查支持ArkTS性能语法规范检查。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab36b146abac45138879343dfeb7aaf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=W2OVltwrGNmRM294PO49LVHhfKQ%3D" alt="" loading="lazy"/></p>
<p><strong>图18</strong> 实时检查</p>
<h4 data-id="heading-27">2.3.2. 代码快速修复</h4>
<p>DevEco Studio支持代码快速修复能力，辅助开发者快速修复ArkTS代码问题。</p>
<p><strong>查看告警信息：</strong> 使用双击<strong>Shift</strong>快捷键打开文件查询框，输入<strong>problems</strong>打开问题工具面板；双击对应告警信息，可以查看告警的具体位置及原因。</p>
<p><strong>快速修复：</strong> 将光标放在错误告警的位置，可在弹出的悬浮窗中查看问题描述和对应修复方式；单击<strong>More actions</strong>可查看更多修复方法。或是在页面出现灯泡图标时，可点击图标并根据相应建议，实现代码快速修复。如图19所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b896679c34433091ba25dbdb9fd6fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=WvT0ZzW6Li61%2BEEDiNm9WonmEpU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95e7fb39a6d545ccbfa1ac5a0e397744~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=wAwsgJL%2BvQfvm%2BtI%2FqoGZIRIKzk%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad47f6169c014186aa19fa954bfb2852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=77%2FQSaYzXH5kxG6Dx51KoPZrH1w%3D" alt="" loading="lazy"/></p>
<p><strong>图19</strong> 快速修复</p>
<h3 data-id="heading-28">2.4. 代码重构</h3>
<h4 data-id="heading-29">2.4.1. Refactor-Extract代码提取</h4>
<p>在编辑器中支持将函数内、类方法内等区域代码块或表达式，提取为新方法/函数（Method）、常量（Constant）、接口（Interface）、变量（Variable）或类型别名（Type Alias）。准确便捷的将所选区域代码从当前作用域内进行提取，提升编码效率。选中所需要提取的代码块，右键单击<strong>Refactor</strong>，选择需要提取的类型。</p>
<h4 data-id="heading-30">2.4.2. Refactor-Rename代码重命名</h4>
<p>代码编辑支持Rename功能，可以快速更改变量、方法、对象属性等相关标识符及文件、模块的名称，并同步到整个工程中对其进行引用的位置。</p>
<p>使用方式：选中需要重新命名的标识符（变量、类、接口、自定义组件等），右键单击Refactor，选择Rename...（或使用快捷键Shift+F6），在弹框中输入新的标识符名称，并在Scope中选择替换的范围，点击Refactor完成重新命名。</p>
<p>代码编辑支持筛选并过滤不需要rename的引用位置。在Rename...弹窗中点击Preview，在弹出预览窗口中，用户选中无需Rename的选项，单击右键菜单Exclude/Remove进行过滤/删除，完成筛选后点击左下角Do Refactor，重新执行Rename操作。</p>
<h4 data-id="heading-31">2.4.3. Move File</h4>
<p>在文件中单击右键，选择Refactor &gt; Move File...，在弹窗中输入或点击...选择指定的目录，点击Refactor，可将当前文件移动至该目录下。勾选Search for references，可查找并更新工程中对该文件的引用；勾选Open in editor，可在编辑器中查看移动的文件。</p>
<h4 data-id="heading-32">2.4.4. Safe Delete</h4>
<p>编辑器支持Safe Delete功能，帮助您安全地删除代码中的标识符对象（变量、函数或类等）或删除指定文件。在删除前，编辑器将先在代码中搜索对该对象的引用，如果存在引用，编辑器将提示您进行必要的检查和调整。</p>
<p><strong>使用方式</strong>：在编辑器内选中需要删除的标识符对象或在工程目录选择待删除的文件，右键单击Refactor，选择Safe Delete，单击OK将自动检查当前对象在代码中被引用的情况，点击View Usages可查看具体使用的代码内容，点击Delete Anyway将直接删除该对象的定义。</p>
<h3 data-id="heading-33">2.5. 生成ArkTSDoc文档</h3>
<ol>
<li>在菜单栏选择<strong>Tools &gt; Generate ArkTSDoc...</strong> 进入ArkTSDoc生成界面。如图20所示。</li>
<li>设置生成ArkTSDoc的范围，可选择整个工程、某个模块或目录、单个文件进行导出。在Output directory中指定导出ArkTSDoc的存储路径。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea3166929abd490880e632e2400d7420~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=pckdqswKdD%2BltbONF10LVi8vSXE%3D" alt="" loading="lazy"/></p>
<p><strong>图20</strong> 生成ArkTSDoc文档入口</p>
<ol start="3">
<li>若勾选<strong>Open generated documentation in browser</strong>选项，在生成ArkTSDoc后，将自动打开相应页面查看生成的文档。配置完毕后点击Generate，开始扫描并生成ArkTSDoc文档。</li>
</ol>
<p>生成的ArkTSDoc左侧文档目录和原工程目录结构一致，右侧可点击跳转到当前文件包含的某个变量、方法、接口或类的文档位置。如图21所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8687f3cb957468ea08533d3762cb4c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=GL%2FYRFHpqdNVaf1pXqe6V7oiyrg%3D" alt="" loading="lazy"/></p>
<p><strong>图21</strong> 生成文档</p>
<p>若没有勾选<strong>Open generated documentation in browser</strong>选项，在生成ArkTSDoc后，DevEco Studio右下角弹出对应提示框，可以点击Go to Folder跳转到生成的ArkTSDoc文件夹，用浏览器打开文件夹中index.html文件即可查看ArkTSDoc文档。</p>
<p><strong>--未完待续--</strong></p>
<p>本文配套视频教程观看地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669272%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669272?spm=3001.4143" ref="nofollow noopener noreferrer">01-工具介绍</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669273%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669273?spm=3001.4143" ref="nofollow noopener noreferrer">02-工程管理</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669274%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669274?spm=3001.4143" ref="nofollow noopener noreferrer">03-代码阅读</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669275%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669275?spm=3001.4143" ref="nofollow noopener noreferrer">04-代码编辑-代码生成补全、代码检查、代码重构和生成ArkTSDoc文档</a></p>
<p>✋ 需要参加鸿蒙认证的请点击 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F930c921fb4964857843b5540e7fa5cf3%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/930c921fb4964857843b5540e7fa5cf3?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙认证链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[淘宝实时商品API接口：采集竞品商品详情页的价格、SKU 规格、库存数量、卖点文案、图文内容、售后政策（运费、退换货规则）、评价核心标签]]></title>    <link>https://juejin.cn/post/7577702891273928739</link>    <guid>https://juejin.cn/post/7577702891273928739</guid>    <pubDate>2025-11-30T06:53:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273928739" data-draft-id="7577713754563657780" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="淘宝实时商品API接口：采集竞品商品详情页的价格、SKU 规格、库存数量、卖点文案、图文内容、售后政策（运费、退换货规则）、评价核心标签"/> <meta itemprop="keywords" content="数据可视化,数据分析,数据挖掘"/> <meta itemprop="datePublished" content="2025-11-30T06:53:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4142929607239"/> <meta itemprop="url" content="https://juejin.cn/user/2579871227198947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            淘宝实时商品API接口：采集竞品商品详情页的价格、SKU 规格、库存数量、卖点文案、图文内容、售后政策（运费、退换货规则）、评价核心标签
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2579871227198947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4142929607239
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:53:00.000Z" title="Sun Nov 30 2025 06:53:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>淘宝商品详情API接口是用来获取淘宝商品详情信息的接口，可以获取到商品的价格、sku规格、商品主图、详情图片、商品视频等。还可以通过评论接口获取商品评论信息。</p>
<p>请求参数为商品的唯一标识，商品id。通过商品链接可以拿到。</p>
<p>item_get_pro-获得淘宝商品详情高级版</p>
<p>item_review 获取商品评论信息</p>
<h3 data-id="heading-0">公共参数 <a href="https://link.juejin.cn?target=https%3A%2F%2Fo0b.cn%2Fijenni" target="_blank" title="https://o0b.cn/ijenni" ref="nofollow noopener noreferrer">点此注册账号获取key测试</a></h3>





















































<table><thead><tr><th>名称</th><th>类型</th><th>必须</th><th>描述</th></tr></thead><tbody><tr><td>key</td><td>String</td><td>是</td><td>调用key（必须以GET方式拼接在URL中）</td></tr><tr><td>secret</td><td>String</td><td>是</td><td>调用密钥</td></tr><tr><td>api_name</td><td>String</td><td>是</td><td>API接口名称（包括在请求地址中）[item_search,item_get,item_search_shop等]</td></tr><tr><td>cache</td><td>String</td><td>否</td><td>[yes,no]默认yes，将调用缓存的数据，速度比较快</td></tr><tr><td>result_type</td><td>String</td><td>否</td><td>[json,jsonu,xml,serialize,var_export]返回数据格式，默认为json，jsonu输出的内容中文可以直接阅读</td></tr><tr><td>lang</td><td>String</td><td>否</td><td>[cn,en,ru]翻译语言，默认cn简体中文</td></tr><tr><td>version</td><td>String</td><td>否</td><td>API版本</td></tr></tbody></table>
<h3 data-id="heading-1">请求参数</h3>
<p>请求参数：num_iid=520813250866 参数说明：num_iid:淘宝商品ID</p>
<h3 data-id="heading-2">请求示例</h3>
<pre><code class="hljs language-lua" lang="lua">	
<span class="hljs-comment">-- 请求示例 url 默认请求参数已经URL编码处理</span>
curl -i <span class="hljs-string">"https://api-服务器.cn/taobao/item_get_pro/?key=&lt;您自己的apiKey&gt;&amp;secret=&lt;您自己的apiSecret&gt;&amp;num_iid=520813250866"</span>
</code></pre>
<h3 data-id="heading-3">响应实例</h3>
<pre><code class="hljs language-ruby" lang="ruby">{
	<span class="hljs-string">"item"</span>: {
		<span class="hljs-string">"num_iid"</span>: <span class="hljs-string">"520813250866"</span>,
		<span class="hljs-string">"title"</span>: <span class="hljs-string">"三刃木折叠刀过安检创意迷你钥匙扣钥匙刀军刀随身多功能小刀包邮"</span>,
		<span class="hljs-string">"desc_short"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"price"</span>: <span class="hljs-string">"25.8"</span>,
		<span class="hljs-string">"total_price"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"suggestive_price"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"25.80"</span>,
		<span class="hljs-string">"nick"</span>: <span class="hljs-string">"欢乐购客栈"</span>,
		<span class="hljs-string">"num"</span>: <span class="hljs-number">16840</span>,
		<span class="hljs-string">"detail_url"</span>: <span class="hljs-string">"https://item.taobao.com/item.htm?id=520813250866"</span>,
		<span class="hljs-string">"pic_url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/O1CN01mbmuAB1jaogMUWhv8_!!2596264565.jpg"</span>,
		<span class="hljs-string">"brand"</span>: <span class="hljs-string">"三刃木"</span>,
		<span class="hljs-string">"brandId"</span>: <span class="hljs-string">"4036703"</span>,
		<span class="hljs-string">"rootCatId"</span>: <span class="hljs-string">"50013886"</span>,
		<span class="hljs-string">"cid"</span>: <span class="hljs-string">"50014822"</span>,
		<span class="hljs-string">"desc"</span>: <span class="hljs-string">"\n  &lt;p &gt;&lt;span &gt;&lt;span &gt;&lt;strong&gt;小店所有产品都支持刻字，如需刻字，拍之前联系客服即可。&lt;/strong&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;炎炎夏日来临，一把随身携带便携式的折叠小刀，&lt;span &gt;带开瓶器功能&lt;/span&gt;，喝酒不用愁。（钥匙刀不带开瓶器功能）&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;strong &gt;&lt;span &gt;&lt;span &gt;可以当吊牌项链装饰，也可当钥匙扣挂饰， 水果刀 开瓶器 户外防身.&lt;/span&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;strong &gt;&lt;span &gt;部分客户跟我们反映链子质量还不够好，因此小店已重新订购一批质量更好的链子赠送，&lt;span &gt;加量不加价&lt;/span&gt;，只为让你买的更舒心，戴的更放心。&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;购买就送&lt;span &gt;工具刀卡和链子&lt;/span&gt;一条&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2Sci2jXXXXXXFXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.png<span class="hljs-string">" /&gt; &lt;/strong&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;璀璨钻石套餐包含【SK016D钥匙扣+GJ019C折叠刀+GJ017D工具卡】&lt;/strong&gt;&lt;/span&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2wWohmXXXXXX8</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;超凡大师套餐包括【304不锈钢钥匙扣+GJ019C折叠刀+GJ017D工具卡】&lt;/strong&gt;&lt;/span&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2</span>_uiXnFXXXXXBXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;/p&gt; \n  &lt;p &gt;&amp;nbsp;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;最强王者套餐包括【钛钢钥匙扣+GJ019C折叠刀+GJ017D工具卡】&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2Gm9xnFXXXXbm</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt; &lt;/strong&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB28Ox4b77OyuJjSsplXXXqdpXa</span>_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-variable constant_">TB2</span>.mTddVXXXXbeXpXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB21Ro</span>.jl0lpuFjSszdXXcdxFXa_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2q9CelVXXXXc</span>UXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB21EX9lVXXXXaXXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2udCylVXXXXXg</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2EARxjB8lpuFjSspaXXXJKpXa</span>_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2ssuwlVXXXXaf</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2nAHqgyC9MuFjSZFoXXbUzFXa</span>_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2ahCelVXXXXc</span>_XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2w1JnjwRkpuFjy1zeXXc</span>.6FXa_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2C902lVXXXXbnXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2sGR3lVXXXXblXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2ZBGxl</span>VXXXXXMXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2MjWklVXXXXca</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2UgV3lVXXXXbdXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2ip5XlVXXXXX2Xp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2sMTBdVXXXXXl</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2d3HfdVXXXXahXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2AVbBdVXXXXXk</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2nf</span>_wdVXXXXaMXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2dLYddVXXXXbtXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2H1</span>_adVXXXXbWXpXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2eBzsdVXXXXbu</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2dOTndVXXXXc</span>CXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2fK2tdVXXXXbk</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB29zjedVXXXXaFXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2i7rmdVXXXXc</span>TXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;/p&gt;\n  "</span>,
		<span class="hljs-string">"item_imgs"</span>: [
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/O1CN01mbmuAB1jaogMUWhv8_!!2596264565.jpg"</span>
			},
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/O1CN01dVHKvp1jaogIQyUBv_!!2596264565.jpg"</span>
			},
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i1/2596264565/TB2a.x.lVXXXXXPXpXXXXXXXXXX_!!2596264565.jpg"</span>
			},
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2p30elFXXXXXQXpXXXXXXXXXX_!!2596264565.jpg"</span>
			},
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2j2cTXib_F1JjSZFzXXc6KXXa_!!2596264565.jpg"</span>
			}
		],
		<span class="hljs-string">"item_weight"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"post_fee"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"express_fee"</span>: null,
		<span class="hljs-string">"ems_fee"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"shipping_to"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"sample_id"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"props_name"</span>: <span class="hljs-string">"1627207:1347647754:颜色分类:长方形带开瓶器+送工具刀卡+链子;1627207:1347647753:颜色分类:椭圆形带开瓶器+送工具刀卡+链子;1627207:1195392087:颜色分类:GJ018X钥匙刀+送工具刀卡+链子;1627207:1331112595:颜色分类:超凡大师套餐【送工具卡+链子】;1627207:1331112594:颜色分类:最强王者套餐【送工具卡+链子】;1627207:1331264247:颜色分类:璀璨钻石套餐【送工具卡+链子】"</span>,
		<span class="hljs-string">"prop_imgs"</span>: {
			<span class="hljs-string">"prop_img"</span>: [
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647754"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2.XeblVXXXXXkXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647753"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2dTrjdVXXXXXBXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1195392087"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i2/2596264565/TB2j22kdVXXXXXdXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112595"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2_uiXnFXXXXXBXXXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112594"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2Gm9xnFXXXXbmXXXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331264247"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2wWohmXXXXXX8XXXXXXXXXXXX_!!2596264565.jpg"</span>
				}
			]
		},
		<span class="hljs-string">"props_imgs"</span>: {
			<span class="hljs-string">"prop_img"</span>: [
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647754"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2.XeblVXXXXXkXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647753"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2dTrjdVXXXXXBXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1195392087"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i2/2596264565/TB2j22kdVXXXXXdXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112595"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2_uiXnFXXXXXBXXXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112594"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2Gm9xnFXXXXbmXXXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331264247"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2wWohmXXXXXX8XXXXXXXXXXXX_!!2596264565.jpg"</span>
				}
			]
		},
		<span class="hljs-string">"property_alias"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"props"</span>: [
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"品牌"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"三刃木"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"产地"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"中国"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"颜色分类"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"长方形带开瓶器+送工具刀卡+链子,椭圆形带开瓶器+送工具刀卡+链子,GJ018X钥匙刀+送工具刀卡+链子,超凡大师套餐【送工具卡+链子】,最强王者套餐【送工具卡+链子】,璀璨钻石套餐【送工具卡+链子】"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"吊牌价"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"46"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"功能数量"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"5个及以下"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"货号"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"GJ019C"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"附加功能"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"开瓶器,刀,螺丝刀,钥匙圈,其他"</span>
			}
		],
		<span class="hljs-string">"total_sold"</span>: <span class="hljs-string">"10"</span>,
		<span class="hljs-string">"skus"</span>: {
			<span class="hljs-string">"sku"</span>: [
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"39"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"39"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647754"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1347647754:颜色分类:长方形带开瓶器+送工具刀卡+链子"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"9579"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3166598625985"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"39"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"39"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647753"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1347647753:颜色分类:椭圆形带开瓶器+送工具刀卡+链子"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"3699"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3166598625984"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"25.8"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"25.8"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1195392087"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1195392087:颜色分类:GJ018X钥匙刀+送工具刀卡+链子"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"3399"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3144644292458"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"73.8"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"73.8"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112595"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1331112595:颜色分类:超凡大师套餐【送工具卡+链子】"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"0"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3161300228970"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"91.8"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"91.8"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112594"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1331112594:颜色分类:最强王者套餐【送工具卡+链子】"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"0"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3161300228969"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"63.8"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"63.8"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331264247"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1331264247:颜色分类:璀璨钻石套餐【送工具卡+链子】"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"163"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3161107666655"</span>
				}
			]
		},
		<span class="hljs-string">"seller_id"</span>: <span class="hljs-string">"2596264565"</span>,
		<span class="hljs-string">"sales"</span>: <span class="hljs-number">13</span>,
		<span class="hljs-string">"shop_id"</span>: <span class="hljs-string">"127203758"</span>,
		<span class="hljs-string">"props_list"</span>: {
			<span class="hljs-string">"1627207:1347647754"</span>: <span class="hljs-string">"颜色分类:长方形带开瓶器+送工具刀卡+链子"</span>,
			<span class="hljs-string">"1627207:1347647753"</span>: <span class="hljs-string">"颜色分类:椭圆形带开瓶器+送工具刀卡+链子"</span>,
			<span class="hljs-string">"1627207:1195392087"</span>: <span class="hljs-string">"颜色分类:GJ018X钥匙刀+送工具刀卡+链子"</span>,
			<span class="hljs-string">"1627207:1331112595"</span>: <span class="hljs-string">"颜色分类:超凡大师套餐【送工具卡+链子】"</span>,
			<span class="hljs-string">"1627207:1331112594"</span>: <span class="hljs-string">"颜色分类:最强王者套餐【送工具卡+链子】"</span>,
			<span class="hljs-string">"1627207:1331264247"</span>: <span class="hljs-string">"颜色分类:璀璨钻石套餐【送工具卡+链子】"</span>
		},
		<span class="hljs-string">"seller_info"</span>: {
			<span class="hljs-string">"nick"</span>: <span class="hljs-string">"欢乐购客栈"</span>,
			<span class="hljs-string">"item_score"</span>: <span class="hljs-string">"4.8 "</span>,
			<span class="hljs-string">"score_p"</span>: <span class="hljs-string">"4.8 "</span>,
			<span class="hljs-string">"delivery_score"</span>: <span class="hljs-string">"4.8 "</span>,
			<span class="hljs-string">"shop_type"</span>: <span class="hljs-string">"C"</span>,
			<span class="hljs-string">"user_num_id"</span>: <span class="hljs-string">"2596264565"</span>,
			<span class="hljs-string">"sid"</span>: <span class="hljs-string">"127203758"</span>,
			<span class="hljs-string">"title"</span>: <span class="hljs-string">"欢乐购客栈"</span>,
			<span class="hljs-string">"zhuy"</span>: <span class="hljs-string">"https://shop127203758.taobao.com/"</span>,
			<span class="hljs-string">"shop_name"</span>: <span class="hljs-string">"欢乐购客栈"</span>
		},
		<span class="hljs-string">"tmall"</span>: <span class="hljs-literal">false</span>,
		<span class="hljs-string">"error"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"fav_count"</span>: <span class="hljs-string">"4824"</span>,
		<span class="hljs-string">"fans_count"</span>: <span class="hljs-string">"1462"</span>,
		<span class="hljs-string">"location"</span>: <span class="hljs-string">"广东深圳"</span>,
		<span class="hljs-string">"data_from"</span>: <span class="hljs-string">"server"</span>,
		<span class="hljs-string">"props_img"</span>: {
			<span class="hljs-string">"1627207:1347647754"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2.XeblVXXXXXkXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1347647753"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2dTrjdVXXXXXBXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1195392087"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i2/2596264565/TB2j22kdVXXXXXdXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1331112595"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2_uiXnFXXXXXBXXXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1331112594"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2Gm9xnFXXXXbmXXXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1331264247"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2wWohmXXXXXX8XXXXXXXXXXXX_!!2596264565.jpg"</span>
		},
		<span class="hljs-string">"desc_img"</span>: [
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2Sci2jXXXXXXFXpXXXXXXXXXX_!!2596264565.png"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2wWohmXXXXXX8XXXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2_uiXnFXXXXXBXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2Gm9xnFXXXXbmXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB28Ox4b77OyuJjSsplXXXqdpXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2.mTddVXXXXbeXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB21Ro.jl0lpuFjSszdXXcdxFXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2q9CelVXXXXcUXXXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB21EX9lVXXXXaXXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2udCylVXXXXXgXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2EARxjB8lpuFjSspaXXXJKpXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2ssuwlVXXXXafXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2nAHqgyC9MuFjSZFoXXbUzFXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2ahCelVXXXXc_XXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2w1JnjwRkpuFjy1zeXXc.6FXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2C902lVXXXXbnXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2sGR3lVXXXXblXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2ZBGxlVXXXXXMXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2MjWklVXXXXcaXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2UgV3lVXXXXbdXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2ip5XlVXXXXX2XpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2sMTBdVXXXXXlXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2d3HfdVXXXXahXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2AVbBdVXXXXXkXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2nf_wdVXXXXaMXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2dLYddVXXXXbtXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2H1_adVXXXXbWXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2eBzsdVXXXXbuXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2dOTndVXXXXcCXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2fK2tdVXXXXbkXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB29zjedVXXXXaFXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2i7rmdVXXXXcTXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>
		]
	},
	<span class="hljs-string">"secache"</span>: <span class="hljs-string">"7e721ad79194b06c2a7fea78e07f87be"</span>,
	<span class="hljs-string">"secache_time"</span>: <span class="hljs-number">1608166332</span>,
	<span class="hljs-string">"secache_date"</span>: <span class="hljs-string">"2020-12-17 08:52:12"</span>,
	<span class="hljs-string">"translate_status"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-string">"translate_time"</span>: <span class="hljs-number">0</span>,
	<span class="hljs-string">"language"</span>: {
		<span class="hljs-string">"default_lang"</span>: <span class="hljs-string">"cn"</span>,
		<span class="hljs-string">"current_lang"</span>: <span class="hljs-string">"cn"</span>
	},
	<span class="hljs-string">"error"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-string">"reason"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-string">"error_code"</span>: <span class="hljs-string">"0000"</span>,
	<span class="hljs-string">"cache"</span>: <span class="hljs-number">0</span>,
	<span class="hljs-string">"api_info"</span>: <span class="hljs-string">"today:2 max:10000"</span>,
	<span class="hljs-string">"execution_time"</span>: <span class="hljs-number">0.924</span>,
	<span class="hljs-string">"server_time"</span>: <span class="hljs-string">"Beijing/2020-12-17 08:52:12"</span>,
	<span class="hljs-string">"client_ip"</span>: <span class="hljs-string">"192.168.16.172"</span>,
	<span class="hljs-string">"call_args"</span>: {
		<span class="hljs-string">"num_iid"</span>: <span class="hljs-string">"520813250866"</span>
	},
	<span class="hljs-string">"api_type"</span>: <span class="hljs-string">"taobao"</span>,
	<span class="hljs-string">"translate_language"</span>: <span class="hljs-string">"zh-CN"</span>,
	<span class="hljs-string">"translate_engine"</span>: <span class="hljs-string">"google_cn"</span>,
	<span class="hljs-string">"server_memory"</span>: <span class="hljs-string">"6.83MB"</span>,
	<span class="hljs-string">"request_id"</span>: <span class="hljs-string">"2.5fdaabbb7e07f"</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 如何实现图片懒加载？其实一个 Intersection Observer 就搞定了]]></title>    <link>https://juejin.cn/post/7577737385954639882</link>    <guid>https://juejin.cn/post/7577737385954639882</guid>    <pubDate>2025-11-30T05:31:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954639882" data-draft-id="7570239631846981666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 如何实现图片懒加载？其实一个 Intersection Observer 就搞定了"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-30T05:31:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 如何实现图片懒加载？其实一个 Intersection Observer 就搞定了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:31:34.000Z" title="Sun Nov 30 2025 05:31:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，在当今图片密集的网络环境中，优化图片加载已成为前端开发的重要任务。今天我们分享一下怎么使用 Vue3 实现图片的懒加载功能。</p>
<p><strong>什么是图片懒加载？</strong></p>
<p>假如你打开一个有大量图片的页面，如果所有图片同时加载，会导致页面卡顿、流量浪费，特别是对于那些需要滚动才能看到的图片。</p>
<p>懒加载技术就是解决这个问题的方案，<strong>只有当图片进入或即将进入可视区域的时候，才加载它们</strong>。</p>
<p>效果预览：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b34c807c446746928322e16c38034944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY5aSn5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085493&amp;x-signature=FrFPZhp%2BO%2FkwA8tZmh7oUp7ChEA%3D" alt="6vue3图片懒加载3.gif" loading="lazy"/></p>
<p><strong>完整示例代码可在文末获取</strong></p>
<h2 data-id="heading-0">实现原理</h2>
<p>我们的Vue3懒加载实现基于以下核心技术：</p>
<h3 data-id="heading-1">1. Intersection Observer API</h3>
<p>这是现代浏览器提供的强大API，可以<strong>高效监听元素是否进入可视区域</strong>，而无需频繁计算元素位置，性能远优于传统的滚动监听方式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建观察器</span>
observer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) { <span class="hljs-comment">// 元素进入可视区域</span>
      <span class="hljs-title function_">loadImage</span>();
      observer.<span class="hljs-property">value</span>.<span class="hljs-title function_">unobserve</span>(entry.<span class="hljs-property">target</span>); <span class="hljs-comment">// 加载后停止观察</span>
    }
  });
}, {
  <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'50px 0px'</span>, <span class="hljs-comment">// 提前50px开始加载</span>
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.1</span> <span class="hljs-comment">// 元素10%可见时触发</span>
});
</code></pre>
<h3 data-id="heading-2">2. 组件化设计</h3>
<p>我们将懒加载功能封装为独立的 <code>LazyImage</code> 组件，提高代码复用性和可维护性。</p>
<h2 data-id="heading-3">代码实现详解</h2>
<h3 data-id="heading-4">组件模板结构</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy-image-container"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
    <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLoaded &amp;&amp; !hasError"</span>
    <span class="hljs-attr">:src</span>=<span class="hljs-string">"actualSrc"</span>
    <span class="hljs-attr">:alt</span>=<span class="hljs-string">"alt"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy-image"</span>
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ opacity: imageOpacity }"</span>
    @<span class="hljs-attr">load</span>=<span class="hljs-string">"onLoad"</span>
    @<span class="hljs-attr">error</span>=<span class="hljs-string">"onError"</span>
  /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"hasError"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-placeholder"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"error-message"</span>&gt;</span>图片加载失败<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"retryLoad"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 10px;"</span>&gt;</span>重试<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-placeholder"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"spinner"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>组件包含三种状态：</p>
<ul>
<li><strong>加载中</strong>：显示旋转加载动画</li>
<li><strong>加载完成</strong>：显示实际图片，带有淡入效果</li>
<li><strong>加载失败</strong>：显示错误信息和重试按钮</li>
</ul>
<h3 data-id="heading-5">核心逻辑实现</h3>
<h4 data-id="heading-6">状态管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { emit }</span>) {
  <span class="hljs-keyword">const</span> isLoaded = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);    <span class="hljs-comment">// 是否已加载</span>
  <span class="hljs-keyword">const</span> hasError = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);    <span class="hljs-comment">// 是否加载失败</span>
  <span class="hljs-keyword">const</span> imageOpacity = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">// 图片透明度（用于淡入效果）</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);     <span class="hljs-comment">// Intersection Observer实例</span>
  <span class="hljs-keyword">const</span> container = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);    <span class="hljs-comment">// 容器DOM引用</span>
  <span class="hljs-keyword">const</span> actualSrc = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);      <span class="hljs-comment">// 实际图片地址</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>使用Vue3的Composition API，我们可以更清晰地组织代码逻辑。</p>
<h4 data-id="heading-7">图片加载控制</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadImage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">slowLoad</span>) {
    <span class="hljs-comment">// 模拟慢速网络 - 延迟2秒加载</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      actualSrc.<span class="hljs-property">value</span> = props.<span class="hljs-property">src</span>;
      isLoaded.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    }, <span class="hljs-number">2000</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 正常加载</span>
    actualSrc.<span class="hljs-property">value</span> = props.<span class="hljs-property">src</span>;
    isLoaded.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  }
};
</code></pre>
<p>这个函数根据<code>slowLoad</code>属性决定是否模拟慢速网络，便于测试不同网络条件下的表现。</p>
<h4 data-id="heading-8">生命周期管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 创建并启动Intersection Observer</span>
  observer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
    <span class="hljs-comment">// 观察逻辑...</span>
  });
  
  <span class="hljs-keyword">if</span> (container.<span class="hljs-property">value</span>) {
    observer.<span class="hljs-property">value</span>.<span class="hljs-title function_">observe</span>(container.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 组件卸载时清理观察器</span>
  <span class="hljs-keyword">if</span> (observer.<span class="hljs-property">value</span>) {
    observer.<span class="hljs-property">value</span>.<span class="hljs-title function_">disconnect</span>();
  }
});
</code></pre>
<p>确保在组件销毁时正确清理资源，避免内存泄漏。</p>
<h3 data-id="heading-9">错误处理与重试机制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">onError</span> = (<span class="hljs-params"/>) =&gt; {
  hasError.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'error'</span>); <span class="hljs-comment">// 向父组件发送错误事件</span>
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">retryLoad</span> = (<span class="hljs-params"/>) =&gt; {
  hasError.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  isLoaded.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 重新触发观察</span>
  <span class="hljs-keyword">if</span> (observer.<span class="hljs-property">value</span> &amp;&amp; container.<span class="hljs-property">value</span>) {
    observer.<span class="hljs-property">value</span>.<span class="hljs-title function_">observe</span>(container.<span class="hljs-property">value</span>);
  }
};
</code></pre>
<p>良好的错误处理机制可以提升用户体验，让用户在图片加载失败时有机会重试。</p>
<h2 data-id="heading-10">应用该组件</h2>
<h3 data-id="heading-11">在主组件中使用懒加载</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
    <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(image, index) in images"</span> 
    <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> 
    <span class="hljs-attr">class</span>=<span class="hljs-string">"image-card"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lazy-image</span>
      <span class="hljs-attr">:src</span>=<span class="hljs-string">"image.url"</span>
      <span class="hljs-attr">:alt</span>=<span class="hljs-string">"image.title"</span>
      <span class="hljs-attr">:slow-load</span>=<span class="hljs-string">"networkSlow"</span>
      @<span class="hljs-attr">loaded</span>=<span class="hljs-string">"onImageLoaded"</span>
      @<span class="hljs-attr">error</span>=<span class="hljs-string">"onImageError"</span>
    &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">lazy-image</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-info"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-title"</span>&gt;</span>{{ image.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-description"</span>&gt;</span>{{ image.description }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">功能控制与统计</h3>
<p>我们的主组件提供了实用的控制功能：</p>
<ul>
<li><strong>添加更多图片</strong>：动态加载更多图片</li>
<li><strong>重置图片</strong>：恢复初始状态</li>
<li><strong>模拟网络速度</strong>：切换正常/慢速网络模式</li>
<li><strong>加载统计</strong>：实时显示已加载和失败的图片数量</li>
</ul>
<h2 data-id="heading-13">进一步优化</h2>
<p>在实际项目中，还可以考虑以下优化：</p>
<ol>
<li><strong>图片压缩与格式选择</strong>：使用WebP等现代格式，减小文件体积</li>
<li><strong>渐进式加载</strong>：先加载低质量预览图，再加载高清图</li>
<li><strong>预加载关键图片</strong>：对首屏内的关键图片不使用懒加载</li>
<li><strong>使用CDN加速</strong>：通过内容分发网络提高图片加载速度</li>
</ol>
<p><strong>Github示例代码</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1344160559-lch%2Fdh-vue3-component%2Fblob%2Fmain%2FLazyImages%2Findex.html" target="_blank" title="https://github.com/1344160559-lch/dh-vue3-component/blob/main/LazyImages/index.html" ref="nofollow noopener noreferrer">github.com/1344160559-…</a></p>
<h2 data-id="heading-14">总结</h2>
<p>Vue3图片懒加载是一个简单但极其实用的优化技术。通过<code>Intersection Observer API</code>和Vue3的响应式系统，我们可以以少量代码实现高效的懒加载功能，显著提升页面性能和用户体验。</p>
<p>这个实现不仅适用于图片展示类网站，也可以应用于任何需要优化资源加载的Vue3项目。希望本文能帮助你理解和实现这一重要前端优化技术！</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-15">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fmaq_p_m5vd7KS-xyXt5rcA" target="_blank" title="https://mp.weixin.qq.com/s/maq_p_m5vd7KS-xyXt5rcA" ref="nofollow noopener noreferrer">《SpringBoot+MySQL+Vue实现文件共享系统》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FgQK9L1TxKL50FUVMcgh6JQ" target="_blank" title="https://mp.weixin.qq.com/s/gQK9L1TxKL50FUVMcgh6JQ" ref="nofollow noopener noreferrer">《SpringBoot 动态菜单权限系统设计的企业级解决方案》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 如何再工程化项目中提效？]]></title>    <link>https://juejin.cn/post/7577905525997453353</link>    <guid>https://juejin.cn/post/7577905525997453353</guid>    <pubDate>2025-11-30T05:50:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997453353" data-draft-id="7577905525997125673" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 如何再工程化项目中提效？"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-30T05:50:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 如何再工程化项目中提效？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:50:38.000Z" title="Sun Nov 30 2025 05:50:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在刚开始用 cursor 等工具时，只是用 AI 帮忙生产代码，代码的逻辑、业务流程都在人的脑子里面，这导致 AI 只能在局限的范围内帮一小部分忙，效率很低。而且还经常帮错忙，比如改错了、代码风格不一致等等。</p>
<p>这是最基础的 AI 用法，只用 AI 写代码，于是我想有什么办法可以让 AI 更大程度的接管项目，我把它分为三部分。</p>
<h2 data-id="heading-0">代码风格 Prompt</h2>
<p>用于约束 AI coding 的规范，这一部分就可以分出很多分支，比如按照文件夹的、按照文件后缀、业务模块等等，可以结合 cursor 自带的 .mdc 规范文件一起用。</p>
<p>这里不和业务相关，只和编码规范相关，要遵循 Prompt 编写的常见方法，比如给案例、指令优于限制等。</p>
<p>Prompt 编写的技巧，我准备过两天写一篇文章总结下，感兴趣的可以关注我。</p>
<h2 data-id="heading-1">日志记录文件</h2>
<p>这里记录每一次代码改动，每个文件大致包含变动原因、改动方案、变动结果、测试结果等等，这些文件为 AI 提供整体项目的上下文，把每一次业务场景记录下来。这样 AI 就能理解整个项目，慢慢的从每次迭代中学习，不再犯重复的错误。</p>
<p>AI 编写代码会重复的犯某些特定的错误，原因是我们给的上下文不够，但我们也不可能每次编写代码的时候都把项目从 0 开始讲一遍让 AI 理解整个项目情况，所以这一套文件就是把项目的迭代过程文档化，加载到 AI 的上下文中。</p>
<p>生成日志文件本身也需要一个 Prompt，让生产的文档规范化。</p>
<h2 data-id="heading-2">分步骤执行</h2>
<p>此后写代码之前，先将需求的信息给 AI，使用后退一步的方法加载日记记录文件到上下文，用对话完善此次需求，再生成新的日志记录文件的前半部分和编写代码的大纲文件。</p>
<p>日志记录文件保持只新增。</p>
<p>然后再开启一个新的对话，用后退一步的方法加载代码规范到上下文，根据编写代码的大纲文件开始执行代码。</p>
<p>执行完成后测试，再把最终的结果完善到日志记录文件。</p>
<p>这样每个需求到流程都是规范化和文档化的，AI 会在整个过程中越用越聪明。</p>
<p>当然这样也有个问题，目前我发现的就是文档太多了，有时候会不按照规范执行，我在考虑用 RAG + MCP 的方式，一个项目一个数据库，把整个流程完善成 flow。</p>
<p>这里面会大量用到 Prompt 编写的技巧，我准备下一遍文章详细罗列出来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[STM32CubeIDE手动移植FreeRTOS-动态创建任务和删除]]></title>    <link>https://juejin.cn/post/7577689171222642738</link>    <guid>https://juejin.cn/post/7577689171222642738</guid>    <pubDate>2025-11-29T15:16:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171222642738" data-draft-id="7577691061033107502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="STM32CubeIDE手动移植FreeRTOS-动态创建任务和删除"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-11-29T15:16:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嵌入式大头"/> <meta itemprop="url" content="https://juejin.cn/user/124713977526552"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            STM32CubeIDE手动移植FreeRTOS-动态创建任务和删除
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/124713977526552/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嵌入式大头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:16:24.000Z" title="Sat Nov 29 2025 15:16:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>我在学习这个部分的时候遇到了很多问题，但好在搜集了很多资料后得以解决，于是打算在这里演示这个项目的全过程，即当做复习的资料，也希望能够帮助到一些人，话不多说，直接开整！</p>
<h2 data-id="heading-1">二、项目简介</h2>
<p>创建以下三个任务：</p>
<ul>
<li>任务1：LED1每500ms翻转一次</li>
<li>任务2：LED2每500ms翻转一次</li>
<li>任务3：当按下KEY1的时候删除任务1</li>
</ul>
<h2 data-id="heading-2">三、步骤</h2>
<h3 data-id="heading-3">1. 实现基本的工程配置</h3>
<h4 data-id="heading-4">a. 引脚配置：</h4>
<p>PA0为红色LED，PA1为绿色LED，PA5为按键1，PA9和PA10用作串口发送</p>
<ul>
<li>设置<code>PA0</code>为<code>GPIO_Output</code>,添加标签<code>LED_RED</code></li>
<li>设置<code>PA1</code>为<code>GPIO_Output</code>,添加标签<code>LED_Green</code></li>
<li>设置<code>PA5</code>为<code>GPIO_Intput</code>,添加标签<code>KEY1</code></li>
<li>设置<code>PA9</code>为<code>USART1_TX</code>,<code>PA10</code>为<code>USART1_RX</code></li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2888591f6b6343bca5a4621169c24415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=UYbZASbajgHxej3pTJXs4w%2BZToo%3D" alt="image.png" width="60%" loading="lazy"/>
<p>因为我的按键另一端连接的是正极，所以我的PA5设置为了下拉输入，让PA5默认为低电平，当按键按下时，PA5会表现为高电平：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0013ea3f4b414e9db17b17011083b41c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=ZoiO8MeDr1LTUcSwn15JM5TNQ68%3D" alt="image.png" width="50%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9faecef1e7d4e9d8e4f1224b1919f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=Sb0TZC9c67V2xEMCORZhXeM7Yt4%3D" alt="image.png" width="30%" loading="lazy"/>
<blockquote>
<p><strong>图片来自B站视频UP:keysking</strong></p>
</blockquote>
<h4 data-id="heading-5">b. 系统配置：</h4>
<ul>
<li>将<code>RCC</code>的时钟来源设置为<code>HSE</code>，调整系统时钟为<code>72MHZ</code>：</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eb364f2ed7b418babdcbd1e7ca24bff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=pAY5aIzPZxWr8iW%2BC1Flz9fhsN4%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdfebc1306224f38ac94382f15d1c413~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=ePRhF3888%2BhNvQmsjEnMkqVje0o%3D" alt="image.png" width="80%" loading="lazy"/>
<ul>
<li>设置<code>SYS</code>的<code>Debug</code>为<code>Serial Wire</code>，<code>Timebase Source</code>为<code>TIM4</code>
前者是为了能把代码下载进单片机，后者是因为<code>HAL</code>本身和<code>FreeRTOS</code>都默认依赖<code>SysTick</code>，可能出现卡死的问题，所以为了保险起见，可以考虑在<code>SYS</code>选择<code>HAL</code>时钟源的时候换成其他的，比如<code>TIM4</code></li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22c30a39ac904b18a30e0028179d8c6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=uWibn3xGhXYd42ybQXPSzwfH3FM%3D" alt="image.png" width="70%" loading="lazy"/>
<ul>
<li>设置<code>Time base: TIM4 global interrupt</code>和<code>System tick timer</code>的优先级都为1</li>
<li>打开USART1的中断，优先级设置为0</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d771b263dfa44af8c9e64563ba9b6b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=WF03n83D67hk5AoJBgldRCrYZIM%3D" alt="image.png" width="70%" loading="lazy"/>
<ul>
<li>设置USART为异步模式：</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa000a9ac9c4aad9acbde152943ed99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=8T9FjdW6%2F5pevo%2B4UFiJsaW4DT0%3D" alt="image.png" width="70%" loading="lazy"/>
<ul>
<li>打开<code>Project Manager</code>中的<code>Code Generator</code>，勾选每个外设生成一对“.c/.h文件”初始化</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ee884df7733460db044732067630ca0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=8V1wCXpcpOOu8En3wlCOQHF5wIY%3D" alt="image.png" width="100%" loading="lazy"/>
<blockquote>
<p><strong>至此，项目基本配置完成，Ctrl+S生成代码，进入代码编辑页面</strong></p>
</blockquote>
<ul>
<li>在根目录下新建Hardware文件夹，新建Key.h和Key.h文件</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __KEY_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __KEY_H</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"main.h"</span></span>

<span class="hljs-type">uint8_t</span> <span class="hljs-title function_">Key_Is_Press</span><span class="hljs-params">()</span>;

<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Key.h"</span></span>

<span class="hljs-type">uint8_t</span> <span class="hljs-title function_">Key_Is_Press</span><span class="hljs-params">()</span>
{
    <span class="hljs-type">uint8_t</span> Key_Is_Press = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span>(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == GPIO_PIN_SET)
    {
        HAL_Delay(<span class="hljs-number">10</span>);
        <span class="hljs-keyword">if</span>(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == GPIO_PIN_SET)
        {
            Key_Is_Press = <span class="hljs-number">1</span>;
        }
}
    <span class="hljs-keyword">return</span> Key_Is_Press;
}
</code></pre>
<h3 data-id="heading-6">2. <code>printf</code>函数重定向</h3>
<blockquote>
<p>参考上一篇文章</p>
</blockquote>
<h3 data-id="heading-7">3. 开始移植</h3>
<h4 data-id="heading-8">1. 文件移植</h4>
<p>在项目根目录下新建FreeRTOS文件夹，复制源码/Source/include文件夹到FreeRTOS文件夹下，FreeRTOS文件夹下新建source文件夹和portable文件夹，复制源码Source文件夹下的7个.c文件到FreeRTOS/source文件夹，把源码/portable/MemMang文件夹复制到FreeRTOS/portable文件夹，只保留heap_4.c文件，把源码/Source/portable/GCC文件夹复制到FreeRTOS/portable文件夹，只保留ARM_CM3文件夹，把源码/Demo/CORTEX_STM32F103_Primer_GCC下的FreeRTOSConfig.h文件复制到项目/Core/Inc文件夹下</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99a57766046b45b99ee7eb511ad0b2b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=5Ash%2Fp2ACRUSlCPGTY8qeY0WZZM%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9157166764ad4336af0797aa8bad9455~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=czmlOD%2F8WgUz0o20BkKKOZxTYz0%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6744dc8bc4974fb0b870c81306f68108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=xi%2FD6IwAM2AkMyICnZ2eIh%2FEJjA%3D" alt="image.png" width="50%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c3462ce226b4f33b97ebf91424f1b3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=cHqxBMC2sTRwJhG6Az%2BCk1gztrA%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1dd5fd65c9e42da98f7c83c4f70f687~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=P8HZGDKbBABbIyNG6LE0yN8BDUA%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4af207e2a8ea48cf8084478f48274feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=ASDvCLbmxP3ZTzbcgAiQRIpUlTc%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a055e45960c044b2b71931ed82062ce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=2UadRcr7kZDdDLHLxDFqUxS4U4Y%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9430b9b2143a4c4584edd626b7fef26a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=tT9%2FTG%2BPcNdrGHwny25j0Lb8VME%3D" alt="image.png" width="70%" loading="lazy"/>
<h4 data-id="heading-9">2. 工程配置</h4>
<ul>
<li>把Hardware文件夹和FreeRTOS文件夹加入项目编译范围
右键项目名字，点击Properties，进入如下页面：</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e7036aa87b40cca23994ddb25f2bb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=fulgC59oWklKcInJqn6UVgVRiRc%3D" alt="image.png" width="100%" loading="lazy"/>
<ul>
<li>把include文件夹和ARM_CM3文件夹和Hardware文件夹添加到Include directories目录</li>
<li>把FreeRTOS文件夹和Hardware文件夹添加到Source Location</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1c29078ad574c1599842d56606f1fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=iQmLRlfF7VDSEETcYqnNEo3qEOw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae5db1d82cd14653bc99bc8370b3701e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=bIpRvq1rWYJWm2otJ90TLigKohg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">3. 系统配置文件修改</h4>
<ul>
<li>FreeRTOSConfig.h中添加如下3个配置：</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> xPortPendSVHandler  PendSV_Handler</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> vPortSVCHandler     SVC_Handler</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> INCLUDE_xTaskGetSchedulerState   1</span>
</code></pre>
<p>把<code>#define configUSE_TICK_HOOK 1</code>修改为<code>0</code></p>
<ul>
<li>修改stm32f1xx_it.c文件</li>
</ul>
<p>引入头文件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Private includes ----------------------------------------------------------*/</span>
<span class="hljs-comment">/* USER CODE BEGIN Includes */</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"FreeRTOS.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"task.h"</span></span>
<span class="hljs-comment">/* USER CODE END Includes */</span>
</code></pre>
<p>注释掉2个函数：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// void SVC_Handler(void)</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">// }</span>

<span class="hljs-comment">// void PendSV_Handler(void)</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">// }</span>
</code></pre>
<p>添加SysTick时钟中断服务函数:</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Private variables ---------------------------------------------------------*/</span>
<span class="hljs-comment">/* USER CODE BEGIN PV */</span>
<span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">xPortSysTickHandler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;
<span class="hljs-comment">/* USER CODE END PV */</span>

<span class="hljs-type">void</span> <span class="hljs-title function_">SysTick_Handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">/* USER CODE BEGIN SysTick_IRQn 0 */</span>
    <span class="hljs-comment">/* USER CODE END SysTick_IRQn 0 */</span>
    <span class="hljs-comment">/* USER CODE BEGIN SysTick_IRQn 1 */</span>
    <span class="hljs-keyword">if</span> (xTaskGetSchedulerState() != taskSCHEDULER_NOT_STARTED)
    {
        xPortSysTickHandler();
    }
    <span class="hljs-comment">/* USER CODE END SysTick_IRQn 1 */</span>
}
</code></pre>
<h4 data-id="heading-11">4. 动态创建任务</h4>
<ul>
<li>FreeRTOSConfig.h文件新加<code>#define configSUPPORT_DYNAMIC_ALLOCATION</code></li>
<li>在Core/Inc下新建FreeRTOS_demo.h,在Core/src下新建FreeRTOS_demo.c</li>
<li>FreeRTOS_demo.c代码：</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"FreeRTOS_demo.h"</span></span>

<span class="hljs-comment">/* 启动任务函数 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> START_TASK_PRIORITY 1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> START_TASK_STACK_DEPTH 128</span>
TaskHandle_t start_task_handler;
<span class="hljs-type">void</span> <span class="hljs-title function_">Start_Task</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span>;

<span class="hljs-comment">/* Task1 任务 配置 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK1_PRIORITY 2</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK1_STACK_DEPTH 128</span>
TaskHandle_t task1_handler;
<span class="hljs-type">void</span> <span class="hljs-title function_">Task1</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span>;

<span class="hljs-comment">/* Task2 任务 配置 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK2_PRIORITY 3</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK2_STACK_DEPTH 128</span>
TaskHandle_t task2_handler;
<span class="hljs-type">void</span> <span class="hljs-title function_">Task2</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span>;

<span class="hljs-comment">/* Task3 任务 配置 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK3_PRIORITY 4</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK3_STACK_DEPTH 128</span>
TaskHandle_t task3_handler;
<span class="hljs-type">void</span> <span class="hljs-title function_">Task3</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span>;

<span class="hljs-comment">/**
 * @description: FreeRTOS入口函数：创建任务函数并开始调度
 * @return {*}
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">FreeRTOS_Start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    xTaskCreate((TaskFunction_t)Start_Task,
                (<span class="hljs-type">char</span> *)<span class="hljs-string">"Start_Task"</span>,
                (configSTACK_DEPTH_TYPE)START_TASK_STACK_DEPTH,
                (<span class="hljs-type">void</span> *)<span class="hljs-literal">NULL</span>,
                (UBaseType_t)START_TASK_PRIORITY,
                (TaskHandle_t *)&amp;start_task_handler);
    vTaskStartScheduler();
}

<span class="hljs-type">void</span> <span class="hljs-title function_">Start_Task</span><span class="hljs-params">( <span class="hljs-type">void</span> * pvParameters )</span>
{
    taskENTER_CRITICAL();               <span class="hljs-comment">/* 进入临界区 */</span>
    xTaskCreate((TaskFunction_t         )   Task1,
                (<span class="hljs-type">char</span> *                 )   <span class="hljs-string">"Task1"</span>,
                (configSTACK_DEPTH_TYPE )   TASK1_STACK_DEPTH,
                (<span class="hljs-type">void</span> *                 )   <span class="hljs-literal">NULL</span>,
                (UBaseType_t            )   TASK1_PRIORITY,
                (TaskHandle_t *         )   &amp;task1_handler );

    xTaskCreate((TaskFunction_t         )   Task2,
                (<span class="hljs-type">char</span> *                 )   <span class="hljs-string">"Task2"</span>,
                (configSTACK_DEPTH_TYPE )   TASK2_STACK_DEPTH,
                (<span class="hljs-type">void</span> *                 )   <span class="hljs-literal">NULL</span>,
                (UBaseType_t            )   TASK2_PRIORITY,
                (TaskHandle_t *         )   &amp;task2_handler );

    xTaskCreate((TaskFunction_t         )   Task3,
                (<span class="hljs-type">char</span> *                 )   <span class="hljs-string">"Task2"</span>,
                (configSTACK_DEPTH_TYPE )   TASK3_STACK_DEPTH,
                (<span class="hljs-type">void</span> *                 )   <span class="hljs-literal">NULL</span>,
                (UBaseType_t            )   TASK3_PRIORITY,
                (TaskHandle_t *         )   &amp;task3_handler );
    vTaskDelete(<span class="hljs-literal">NULL</span>);
    taskEXIT_CRITICAL();                <span class="hljs-comment">/* 退出临界区 */</span>
}

<span class="hljs-comment">/**
 * @description: LED1每500ms翻转一次
 * @param {void *} pvParameters
 * @return {*}
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Task1</span><span class="hljs-params">(<span class="hljs-type">void</span> * pvParameters)</span>
{
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"task1运行....\r\n"</span>);
        HAL_GPIO_TogglePin(LED_RED_GPIO_Port, LED_RED_Pin);
        vTaskDelay(<span class="hljs-number">500</span>);
    }
}


<span class="hljs-comment">/**
 * @description: LED2每500ms翻转一次
 * @param {void *} pvParameters
 * @return {*}
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Task2</span><span class="hljs-params">(<span class="hljs-type">void</span> * pvParameters)</span>
{
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"task2运行....\r\n"</span>);
        HAL_GPIO_TogglePin(LED_Green_GPIO_Port, LED_Green_Pin);
        vTaskDelay(<span class="hljs-number">500</span>);
    }
}


<span class="hljs-comment">/**
 * @description:
 * @param {void *} pvParameters
 * @return {*}
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Task3</span><span class="hljs-params">(<span class="hljs-type">void</span> * pvParameters)</span>
{
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)
	{
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"task3运行...\r\n"</span>);
		<span class="hljs-keyword">if</span>(Key_Is_Press())
		{
			<span class="hljs-keyword">if</span>(task1_handler != <span class="hljs-literal">NULL</span>)
			{
				<span class="hljs-built_in">printf</span>(<span class="hljs-string">"删除task1任务...\r\n"</span>);
				vTaskDelete(task1_handler);
				task1_handler = <span class="hljs-literal">NULL</span>;
			}
		}
		vTaskDelay(<span class="hljs-number">500</span>);
	}
}

</code></pre>
<ul>
<li>FreeRTOS_demo.h代码：</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __FREERTOS_DEMO_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __FREERTOS_DEMO_H</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"FreeRTOS.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"task.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"main.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Key.h"</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">FreeRTOS_Start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;

<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

</code></pre>
<ul>
<li>main.c文件对应位置加入：</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* USER CODE BEGIN Includes */</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"FreeRTOS_demo.h"</span></span>
<span class="hljs-comment">/* USER CODE END Includes */</span>

<span class="hljs-comment">/* USER CODE BEGIN 2 */</span>
FreeRTOS_Start();
<span class="hljs-comment">/* USER CODE END 2 */</span>
</code></pre>
<p><strong>至此，所有工作完成，编译并下载代码即可</strong></p>
<h2 data-id="heading-12">四、总结</h2>
<p>才开始写文章，感觉文章写得有点乱，有任何意见或者问题都可以私信我，我也刚开始学这个，大家可以一起交流，希望这篇文章可以帮助到大家，感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jenkins + Kubernetes 多模块微服务一键流水线：从 Maven 打包到滚动发布完整脚本]]></title>    <link>https://juejin.cn/post/7577722399375376426</link>    <guid>https://juejin.cn/post/7577722399375376426</guid>    <pubDate>2025-11-29T16:14:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399375376426" data-draft-id="7577722399375048746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jenkins + Kubernetes 多模块微服务一键流水线：从 Maven 打包到滚动发布完整脚本"/> <meta itemprop="keywords" content="Jenkins,Kubernetes"/> <meta itemprop="datePublished" content="2025-11-29T16:14:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="起风了___"/> <meta itemprop="url" content="https://juejin.cn/user/3298190615395896"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jenkins + Kubernetes 多模块微服务一键流水线：从 Maven 打包到滚动发布完整脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3298190615395896/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    起风了___
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:14:09.000Z" title="Sat Nov 29 2025 16:14:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">文章简介</h2>
<ul>
<li>上次写过一篇使用 Jenkins 在远程服务器上部署 docker 镜像的通用脚本，这次这份脚本是基于上次那份脚本修改而来，用于 Kubernetes 部署镜像使用。</li>
<li>Kubernetes 部署相关信息可以查看这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPmae_-DmMGkyA89s6I6xqA" target="_blank" title="https://mp.weixin.qq.com/s/Pmae_-DmMGkyA89s6I6xqA" ref="nofollow noopener noreferrer">Kubernetes 生产入门：Deployment 与 Service 配置实战</a></li>
<li>本文介绍的部署脚本适用于单工程下多 module 的微服务，单工程服务需要阅读脚本自行微调。不过我建议使用本文脚本的每一位朋友都能够阅读所有的代码，确定是否符合自己的需求。</li>
</ul>
<h2 data-id="heading-1">脚本变量</h2>
<ul>
<li>定义、设置变量主要是为了形成一个<strong>通用型脚本</strong>，部署多个服务尤其微服务时，编写好一个流水线脚本，其他流水线可以直接复制使用，复制后只需修改此处变量即可。</li>
<li>此处有部分变量嵌套使用 MODULE_NAME、MODULE_PATH 变量复用相同参数，使用本文脚本的朋友一定要观察此处的变量是否与你们工程一致。</li>
<li>具体参数信息代码中已有注释，不过多赘述</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">environment {
    // 模块信息
    <span class="hljs-attr">MODULE_NAME</span> = <span class="hljs-string">"xxx-service"</span> // 模块名称
    <span class="hljs-attr">MODULE_PATH</span> = <span class="hljs-string">"./${MODULE_NAME}"</span> // 模块路径，适用于微服务多 module
    // Git 仓库配置
    <span class="hljs-attr">GIT_URL</span> = <span class="hljs-string">'git@git.xxx.com:xxx.git'</span> // 替换为你的代码仓库
    <span class="hljs-attr">GIT_KEY_ACR_CRED</span> = <span class="hljs-string">'git-ssh-key'</span>
    <span class="hljs-attr">BRANCH</span> = <span class="hljs-string">'master'</span>
    // Docker 镜像相关配置
    <span class="hljs-attr">DOCKER_IMAGE_REGISTRY</span> = <span class="hljs-string">'registry.xxx.aliyuncs.com'</span>  // 替换为你的镜像仓库
    <span class="hljs-attr">DOCKER_IMAGE_ACR_CRED</span> = <span class="hljs-string">'docker-cred'</span>
    <span class="hljs-attr">IMAGE_PRE_NAME</span> = <span class="hljs-string">'xxxx'</span>  // 镜像名称前缀
    <span class="hljs-attr">IMAGE_NAME</span> = <span class="hljs-string">"${MODULE_NAME}"</span>  // 镜像名称
    <span class="hljs-attr">DOCKERFILE</span> = <span class="hljs-string">"${MODULE_PATH}/Dockerfile"</span> // 用来构建镜像的 dockerfile 文件
    // Kubernetes 相关配置
    <span class="hljs-attr">KUBERNETES_CONFIG</span> = <span class="hljs-string">"kubernetes-config"</span> // Kubernetes 配置文件凭证
    <span class="hljs-attr">RESOURCE_NAME</span> = <span class="hljs-string">"${MODULE_NAME}"</span> // 资源类型名称，这里为 deployment 名称
    <span class="hljs-attr">CONTAINER_NAME</span> = <span class="hljs-string">"${MODULE_NAME}"</span> // 容器名称
}
</code></pre>
<h2 data-id="heading-2">工具设置</h2>
<p>这里设置构建代码的 Maven 工具</p>
<pre><code class="hljs language-groovy" lang="groovy">tools {
    // Install the Maven version configured as "M3" and add it to the path.
    maven "Maven3"
}
</code></pre>
<h2 data-id="heading-3">拉取代码</h2>
<p>拉取仓库中的代码</p>
<ul>
<li>git branch: BRANCH：指定拉取的分支</li>
<li>url: GIT_URL，设置代码仓库地址</li>
<li>credentialsId：仓库访问凭据</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">stage('Checkout') {
    steps {
        git branch: BRANCH, 
        url: GIT_URL,
        credentialsId: GIT_KEY_ACR_CRED
    }
}
</code></pre>
<h2 data-id="heading-4">打包</h2>
<p>由于是多 module 多微服务项目，此处使用 mvn 指定模块打包命令，防止构建不相关模块,且指定为 pro 配置</p>
<pre><code class="hljs language-groovy" lang="groovy">stage('Package') {
    steps {
        // 执行 Maven 打包命令，只打包指定模块
        sh "mvn -pl ${MODULE_PATH} -am -B clean package -Ppro -Dfile.encoding=UTF-8 -DskipTests=true"
    }
}
</code></pre>
<h2 data-id="heading-5">构建、推送 Docker 镜像，删除本地镜像</h2>
<ul>
<li>此处使用当前时间为镜像设置 tag</li>
<li>镜像名称格式：&lt;镜像仓库地址&gt;/&lt;镜像名称前缀&gt;/&lt;应用名称&gt;:&lt;当前时间&gt;</li>
<li>sh "docker build -t ${fullImageNameWithTimestamp} ."
<ul>
<li>使用 docker 构建镜像</li>
</ul>
</li>
<li>withCredentials 使用凭据登陆、推送镜像
<ul>
<li>登陆仓库： sh "docker login --username $REG_USER -p $REG_PASS $DOCKER_IMAGE_REGISTRY"</li>
<li>推送镜像：sh "docker push ${fullImageNameWithTimestamp}"</li>
<li>删除本地镜像：sh "docker rmi ${fullImageNameWithTimestamp}"</li>
<li>将镜像名称保存到环境变量，供后续步骤使用：env.BUILT_IMAGE = fullImageNameWithTimestamp</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">stage('Build Docker Image') {
    steps {
        script {
    
            // 生成时间戳
            def timestamp = new Date().format('yyyyMMddHHmm', TimeZone.getTimeZone('Asia/Shanghai'))
            def imageTag = "${IMAGE_NAME}:${timestamp}"
            def fullImageNameWithTimestamp = "${DOCKER_IMAGE_REGISTRY}/${IMAGE_PRE_NAME}/${imageTag}"
    
            // 使用 Docker 构建镜像
            echo "Building Docker image: ${fullImageNameWithTimestamp}"
            sh "docker build -t ${fullImageNameWithTimestamp} -f ${DOCKERFILE} ${MODULE_PATH}"
    
            withCredentials([usernamePassword(credentialsId: DOCKER_IMAGE_ACR_CRED, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                // 登录到镜像仓库
                echo "Login Docker..."
                sh "docker login --username $REG_USER -p $REG_PASS ${DOCKER_IMAGE_REGISTRY}"
                // 推送镜像
                echo "Push Docker Image ${fullImageNameWithTimestamp}"
                sh "docker push ${fullImageNameWithTimestamp}"
                // 推送完成后，删除本地镜像
                echo "Remove Docker Imag ${fullImageNameWithTimestamp}"
                sh "docker rmi ${fullImageNameWithTimestamp}"
            }
            
            // 输出构建信息
            echo "Successfully built and pushed image: ${fullImageNameWithTimestamp}"
            
            // 将镜像名称保存到环境变量，供后续步骤使用
            env.BUILT_IMAGE = fullImageNameWithTimestamp
        }
    }
}
</code></pre>
<h2 data-id="heading-6">部署到远程 Kubernetes 集群</h2>
<ul>
<li>withCredentials：使用凭据连接 Kubernetes 集群</li>
<li>设置集群连接配置：sh "export KUBECONFIG=$KUBECONFIG"</li>
<li>设置集群对应 Deployment 中的镜像信息：sh "kubectl set image deployment/<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>E</mi><mi>S</mi><mi>O</mi><mi>U</mi><mi>R</mi><mi>C</mi><msub><mi>E</mi><mi>N</mi></msub><mi>A</mi><mi>M</mi><mi>E</mi></mrow><annotation encoding="application/x-tex">{RESOURCE_NAME} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">RESO</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.07153em;">RC</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05764em;">ME</span></span></span></span></span></span>{CONTAINER_NAME}=${BUILT_IMAGE}"</li>
<li>备注：Kubernetes 集群中 Deployment 配置内镜像信息修改后，集群会自行拉起新的 Pod，关闭旧的 Pod。</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">stage('Deploy to Remote Kubernetes') {
    steps {
        script {
            withCredentials([file(credentialsId: KUBERNETES_CONFIG, variable: 'KUBECONFIG')]) {
                // 设置KUBECONFIG环境变量
                sh "export KUBECONFIG=$KUBECONFIG" 
                // 更新Deployment中的镜像信息
                // kubectl set image &lt;资源类型&gt;/&lt;资源名称&gt; &lt;容器名称&gt;=&lt;新镜像&gt;:&lt;标签&gt;
                sh "kubectl set image deployment/${RESOURCE_NAME} ${CONTAINER_NAME}=${BUILT_IMAGE}" 
            } 
        }
    }
}
</code></pre>
<h2 data-id="heading-7">附源码</h2>
<pre><code class="hljs language-groovy" lang="groovy">pipeline {
    agent any

    environment {
        // 模块信息
        MODULE_NAME = "xxx-servcie" // 模块名称
        MODULE_PATH = "./${MODULE_NAME}" // 模块路径，适用于微服务多 module
        // Git 仓库配置
        GIT_URL = 'git@git.xxx.com:xxx.git' // 替换为你的代码仓库
        GIT_KEY_ACR_CRED = 'git-ssh-key'
        BRANCH = 'master'
        // Docker 镜像相关配置
        DOCKER_IMAGE_REGISTRY = 'registry.xxx.aliyuncs.com'  // 替换为你的镜像仓库
        DOCKER_IMAGE_ACR_CRED = 'docker-cred'
        IMAGE_PRE_NAME = 'xxxx'  // 镜像名称前缀
        IMAGE_NAME = "${MODULE_NAME}"  // 镜像名称
        DOCKERFILE = "${MODULE_PATH}/Dockerfile" // 用来构建镜像的 dockerfile 文件
        // Kubernetes 相关配置
        KUBERNETES_CONFIG = "kubernetes-config" // Kubernetes 配置文件凭证
        RESOURCE_NAME = "${MODULE_NAME}" // 资源类型名称，这里为 deployment 名称
        CONTAINER_NAME = "${MODULE_NAME}" // 容器名称
    }

    tools {
        // Install the Maven version configured as "M3" and add it to the path.
        maven "Maven3"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: BRANCH, 
                url: GIT_URL,
                credentialsId: GIT_KEY_ACR_CRED
            }
        }

        stage('Package') {
            steps {
                // 执行 Maven 打包命令，只打包指定模块
                sh "mvn -pl ${MODULE_PATH} -am -B clean package -Ppro -Dfile.encoding=UTF-8 -DskipTests=true"
            }
        }

        stage('Build Docker Image') {
            steps {
                script {

                    // 生成时间戳
                    def timestamp = new Date().format('yyyyMMddHHmm', TimeZone.getTimeZone('Asia/Shanghai'))
                    def imageTag = "${IMAGE_NAME}:${timestamp}"
                    def fullImageNameWithTimestamp = "${DOCKER_IMAGE_REGISTRY}/${IMAGE_PRE_NAME}/${imageTag}"

                    // 使用 Docker 构建镜像
                    echo "Building Docker image: ${fullImageNameWithTimestamp}"
                    sh "docker build -t ${fullImageNameWithTimestamp} -f ${DOCKERFILE} ${MODULE_PATH}"

                    withCredentials([usernamePassword(credentialsId: DOCKER_IMAGE_ACR_CRED, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                        // 登录到镜像仓库
                        echo "Login Docker..."
                        sh "docker login --username $REG_USER -p $REG_PASS ${DOCKER_IMAGE_REGISTRY}"
                        // 推送镜像
                        echo "Push Docker Image ${fullImageNameWithTimestamp}"
                        sh "docker push ${fullImageNameWithTimestamp}"
                        // 推送完成后，删除本地镜像
                        echo "Remove Docker Imag ${fullImageNameWithTimestamp}"
                        sh "docker rmi ${fullImageNameWithTimestamp}"
                    }
                    
                    // 输出构建信息
                    echo "Successfully built and pushed image: ${fullImageNameWithTimestamp}"
                    
                    // 将镜像名称保存到环境变量，供后续步骤使用
                    env.BUILT_IMAGE = fullImageNameWithTimestamp
                }
            }
        }


        stage('Deploy to Remote Kubernetes') {
            steps {
                script {
                    withCredentials([file(credentialsId: KUBERNETES_CONFIG, variable: 'KUBECONFIG')]) {
                        // 设置KUBECONFIG环境变量
                        sh "export KUBECONFIG=$KUBECONFIG" 
                        // 更新Deployment中的镜像
                        // kubectl set image &lt;资源类型&gt;/&lt;资源名称&gt; &lt;容器名称&gt;=&lt;新镜像&gt;:&lt;标签&gt;
                        sh "kubectl set image deployment/${RESOURCE_NAME} ${CONTAINER_NAME}=${BUILT_IMAGE}" 
                    } 
                }
            }
        }


    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[布式事务详解：从理论到实践（RocketMQ + Seata）]]></title>    <link>https://juejin.cn/post/7577675494068027418</link>    <guid>https://juejin.cn/post/7577675494068027418</guid>    <pubDate>2025-11-29T16:16:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494068027418" data-draft-id="7577431644069462067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="布式事务详解：从理论到实践（RocketMQ + Seata）"/> <meta itemprop="keywords" content="RocketMQ,Java"/> <meta itemprop="datePublished" content="2025-11-29T16:16:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            布式事务详解：从理论到实践（RocketMQ + Seata）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:16:21.000Z" title="Sat Nov 29 2025 16:16:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">分布式事务详解：从理论到实践（RocketMQ + Seata）</h2>
<h3 data-id="heading-1">前言</h3>
<p>在微服务架构日益普及的今天，分布式事务成为了每个后端开发者必须面对的挑战。本文将从理论到实践，深入探讨分布式事务的解决方案，并结合 RocketMQ 和 Seata 框架给出具体的代码示例。</p>
<hr/>
<h3 data-id="heading-2">一、为什么需要分布式事务？</h3>
<h4 data-id="heading-3">1.1 单体架构 vs 微服务架构</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------+          +------------------+</span>
|    单体应用       |          |    微服务架构     |
+<span class="hljs-comment">------------------+          +------------------+</span>
|                  |          |                  |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|  |   订单     |  |          |  | 订单服务  |   |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|        |         |          |       |          |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|  |   库存     |  |          |  | 库存服务  |   |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|        |         |          |       |          |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|  |   账户     |  |          |  | 账户服务  |   |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|        |         |          |       |          |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|  |  单一数据库 |  |          |  | 各自数据库 |   |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
+<span class="hljs-comment">------------------+          +------------------+</span>
     本地事务                     分布式事务
</code></pre>
<h4 data-id="heading-4">1.2 典型业务场景</h4>
<p>以电商下单为例，一个完整的下单流程涉及：</p>
<pre><code class="hljs language-diff" lang="diff">用户下单流程：
<span class="hljs-addition">+--------+    +--------+    +--------+    +--------+</span>
|  创建  | -&gt; |  扣减  | -&gt; |  扣减  | -&gt; |  发送  |
|  订单  |    |  库存  |    |  余额  |    |  通知  |
<span class="hljs-addition">+--------+    +--------+    +--------+    +--------+</span>
    |             |             |             |
    v             v             v             v
<span class="hljs-addition">+--------+    +--------+    +--------+    +--------+</span>
| 订单DB |    | 库存DB |    | 账户DB |    | 消息队列|
<span class="hljs-addition">+--------+    +--------+    +--------+    +--------+</span>
</code></pre>
<p><strong>问题来了：</strong> 如果扣减余额失败，但订单已创建、库存已扣减，如何保证数据一致性？</p>
<h4 data-id="heading-5">1.3 分布式事务的核心挑战</h4>
<ol>
<li><strong>网络不可靠</strong>：服务间调用可能超时、失败</li>
<li><strong>服务不可用</strong>：某个服务可能宕机</li>
<li><strong>数据不一致</strong>：部分操作成功，部分失败</li>
<li><strong>并发问题</strong>：多个事务同时操作同一资源</li>
</ol>
<hr/>
<h3 data-id="heading-6">二、分布式事务理论基础</h3>
<h4 data-id="heading-7">2.1 CAP 理论</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">                    C (Consistency)
                   一致性
                    /\
                   /  \
                  /    \
                 /      \
                /   CAP  \
               /    定理   \
              /____________\
             /              \
   A (Availability)    P (Partition Tolerance)
      可用性                 分区容错性
</span>
CAP定理：三者只能同时满足两个
<span class="hljs-bullet">-</span> CA：放弃分区容错（单机系统）
<span class="hljs-bullet">-</span> CP：放弃可用性（强一致性系统）
<span class="hljs-bullet">-</span> AP：放弃一致性（高可用系统）
</code></pre>
<h4 data-id="heading-8">2.2 BASE 理论</h4>
<ul>
<li><strong>Basically Available（基本可用）</strong>：允许损失部分可用性</li>
<li><strong>Soft State（软状态）</strong>：允许存在中间状态</li>
<li><strong>Eventually Consistent（最终一致性）</strong>：经过一段时间后达到一致</li>
</ul>
<h4 data-id="heading-9">2.3 常见一致性模型对比</h4>

























<table><thead><tr><th>模型</th><th>描述</th><th>适用场景</th></tr></thead><tbody><tr><td>强一致性</td><td>写入后立即可读</td><td>金融交易</td></tr><tr><td>弱一致性</td><td>不保证何时能读到</td><td>日志记录</td></tr><tr><td>最终一致性</td><td>一段时间后一致</td><td>电商订单</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">三、分布式事务解决方案</h3>
<h4 data-id="heading-11">3.1 方案对比</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+------------------+----------+----------+----------+----------+</span>
|      方案        | 一致性   | 性能     | 复杂度   | 适用场景 |
<span class="hljs-addition">+------------------+----------+----------+----------+----------+</span>
| 2PC/3PC          | 强       | 低       | 中       | 数据库   |
| TCC              | 强       | 中       | 高       | 资金类   |
| 本地消息表       | 最终     | 高       | 中       | 通用     |
| 事务消息         | 最终     | 高       | 低       | 通用     |
| Saga             | 最终     | 高       | 中       | 长事务   |
| Seata AT         | 强       | 中       | 低       | 通用     |
<span class="hljs-addition">+------------------+----------+----------+----------+----------+</span>
</code></pre>
<h4 data-id="heading-12">3.2 两阶段提交（2PC）</h4>
<pre><code class="hljs language-sql" lang="sql">      协调者                    参与者A                  参与者B
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">1.</span> <span class="hljs-keyword">Prepare</span>请求      <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-comment">------------------------&gt;|                        |</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">1.</span> <span class="hljs-keyword">Prepare</span>请求      <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-comment">-------------------------------------------------&gt;|</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">2.</span> 准备就绪<span class="hljs-operator">/</span>失败    <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">------------------------|                        |</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">2.</span> 准备就绪<span class="hljs-operator">/</span>失败    <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">-------------------------------------------------|</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">3.</span> <span class="hljs-keyword">Commit</span><span class="hljs-operator">/</span><span class="hljs-keyword">Rollback</span>  <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-comment">------------------------&gt;|                        |</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">3.</span> <span class="hljs-keyword">Commit</span><span class="hljs-operator">/</span><span class="hljs-keyword">Rollback</span>  <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-comment">-------------------------------------------------&gt;|</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
</code></pre>
<p><strong>缺点</strong>：同步阻塞、单点故障、数据不一致风险</p>
<h4 data-id="heading-13">3.3 TCC（Try-Confirm-Cancel）</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">----------------------------------------------------------+</span>
|                        TCC 模式                           |
+<span class="hljs-comment">----------------------------------------------------------+</span>
|                                                          |
|   Try阶段          Confirm阶段        Cancel阶段          |
|   (资源预留)       (确认提交)         (回滚释放)           |
|                                                          |
|   +<span class="hljs-comment">----------+     +----------+      +----------+        |</span>
|   | 冻结库存 |     | 扣减库存 |      | 解冻库存 |        |
|   +<span class="hljs-comment">----------+     +----------+      +----------+        |</span>
|        |                |                 |              |
|   +<span class="hljs-comment">----------+     +----------+      +----------+        |</span>
|   | 冻结余额 |     | 扣减余额 |      | 解冻余额 |        |
|   +<span class="hljs-comment">----------+     +----------+      +----------+        |</span>
|                                                          |
+<span class="hljs-comment">----------------------------------------------------------+</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">四、Seata 分布式事务框架</h3>
<h4 data-id="heading-15">4.1 Seata 架构</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                         Seata 架构                                |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|                      +<span class="hljs-comment">---------------+                            |</span>
|                      |  TC (Server)  |                            |
|                      | 事务协调者    |                            |
|                      +<span class="hljs-comment">---------------+                            |</span>
|                       /             \                             |
|                      /               \                            |
|            +<span class="hljs-comment">--------+                 +--------+                  |</span>
|            |   TM   |                 |   RM   |                  |
|            | 事务   |                 | 资源   |                  |
|            | 管理器 |                 | 管理器 |                  |
|            +<span class="hljs-comment">--------+                 +--------+                  |</span>
|                |                           |                      |
|           +<span class="hljs-comment">---------+                 +---------+                 |</span>
|           | 业务服务 |                 | 数据库  |                 |
|           +<span class="hljs-comment">---------+                 +---------+                 |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>

TC (Transaction Coordinator): 事务协调者，维护全局和分支事务状态
TM (Transaction Manager): 事务管理器，定义全局事务范围
RM (Resource Manager): 资源管理器，管理分支事务资源
</code></pre>
<h4 data-id="heading-16">4.2 Seata 四种模式</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+--------+--------+--------+--------+</span>
|   AT   |  TCC   |  Saga  |   XA   |
<span class="hljs-addition">+--------+--------+--------+--------+</span>
| 自动   | 手动   | 长事务 | 强一致 |
| 补偿   | 补偿   | 补偿   | 两阶段 |
| 简单   | 复杂   | 中等   | 简单   |
| 最常用 | 资金类 | 复杂流程| 数据库 |
<span class="hljs-addition">+--------+--------+--------+--------+</span>
</code></pre>
<h4 data-id="heading-17">4.3 Seata AT 模式实战</h4>
<h5 data-id="heading-18">4.3.1 项目结构</h5>
<pre><code class="hljs language-bash" lang="bash">seata-demo/
├── order-service/          <span class="hljs-comment"># 订单服务</span>
├── storage-service/        <span class="hljs-comment"># 库存服务</span>
├── account-service/        <span class="hljs-comment"># 账户服务</span>
└── business-service/       <span class="hljs-comment"># 业务入口服务</span>
</code></pre>
<h5 data-id="heading-19">4.3.2 Maven 依赖</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Seata --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Seata 与 Spring Cloud Alibaba 集成 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2022.0.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MyBatis Plus --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h5 data-id="heading-20">4.3.3 配置文件</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">business-service</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/seata_order?useUnicode=true&amp;characterEncoding=utf8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>

<span class="hljs-comment"># Seata 配置</span>
<span class="hljs-attr">seata:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">application-id:</span> <span class="hljs-string">${spring.application.name}</span>
  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_tx_group</span>
  <span class="hljs-attr">service:</span>
    <span class="hljs-attr">vgroup-mapping:</span>
      <span class="hljs-attr">my_tx_group:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
      <span class="hljs-attr">namespace:</span> <span class="hljs-string">""</span>
      <span class="hljs-attr">group:</span> <span class="hljs-string">SEATA_GROUP</span>
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
      <span class="hljs-attr">namespace:</span> <span class="hljs-string">""</span>
      <span class="hljs-attr">group:</span> <span class="hljs-string">SEATA_GROUP</span>
</code></pre>
<h5 data-id="heading-21">4.3.4 数据库表结构</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE seata_order;
USE seata_order;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_order` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `user_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    `product_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
    `count` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'数量'</span>,
    `money` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">11</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'金额'</span>,
    `status` <span class="hljs-type">INT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单状态：0创建中，1已完成'</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- Seata AT 模式需要的 undo_log 表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `undo_log` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `branch_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `xid` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `context` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `rollback_info` LONGBLOB <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `log_status` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `log_created` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `log_modified` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
    <span class="hljs-keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- 库存数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE seata_storage;
USE seata_storage;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_storage` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `product_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
    `total` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'总库存'</span>,
    `used` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'已用库存'</span>,
    `residue` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'剩余库存'</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_storage <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>);

<span class="hljs-comment">-- 账户数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE seata_account;
USE seata_account;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_account` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `user_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    `total` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'总额度'</span>,
    `used` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'已用额度'</span>,
    `residue` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'剩余额度'</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_account <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1000</span>);
</code></pre>
<h5 data-id="heading-22">4.3.5 核心代码实现</h5>
<p><strong>订单实体类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("t_order")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> Long productId;
    <span class="hljs-keyword">private</span> Integer count;
    <span class="hljs-keyword">private</span> BigDecimal money;
    <span class="hljs-keyword">private</span> Integer status;
}
</code></pre>
<p><strong>订单服务接口</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-comment">/**
     * 创建订单
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long userId, Long productId, Integer count, BigDecimal money)</span>;
}
</code></pre>
<p><strong>订单服务实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StorageClient storageClient;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountClient accountClient;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long userId, Long productId, Integer count, BigDecimal money)</span> {
        log.info(<span class="hljs-string">"========== 开始创建订单 =========="</span>);

        <span class="hljs-comment">// 1. 创建订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setUserId(userId);
        order.setProductId(productId);
        order.setCount(count);
        order.setMoney(money);
        order.setStatus(<span class="hljs-number">0</span>);
        orderMapper.insert(order);

        <span class="hljs-comment">// 2. 扣减库存</span>
        log.info(<span class="hljs-string">"========== 订单服务调用库存服务，扣减库存 =========="</span>);
        storageClient.decrease(productId, count);

        <span class="hljs-comment">// 3. 扣减账户余额</span>
        log.info(<span class="hljs-string">"========== 订单服务调用账户服务，扣减余额 =========="</span>);
        accountClient.decrease(userId, money);

        <span class="hljs-comment">// 4. 修改订单状态</span>
        log.info(<span class="hljs-string">"========== 修改订单状态 =========="</span>);
        order.setStatus(<span class="hljs-number">1</span>);
        orderMapper.updateById(order);

        log.info(<span class="hljs-string">"========== 订单创建完成 =========="</span>);
    }
}
</code></pre>
<p><strong>库存服务 Feign 客户端</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FeignClient(value = "storage-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StorageClient</span> {

    <span class="hljs-meta">@PostMapping("/storage/decrease")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("productId")</span> Long productId,
                  <span class="hljs-meta">@RequestParam("count")</span> Integer count)</span>;
}
</code></pre>
<p><strong>账户服务 Feign 客户端</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FeignClient(value = "account-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountClient</span> {

    <span class="hljs-meta">@PostMapping("/account/decrease")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("userId")</span> Long userId,
                  <span class="hljs-meta">@RequestParam("money")</span> BigDecimal money)</span>;
}
</code></pre>
<p><strong>库存服务实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StorageServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StorageService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StorageMapper storageMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">(Long productId, Integer count)</span> {
        log.info(<span class="hljs-string">"========== 扣减库存开始 =========="</span>);
        storageMapper.decrease(productId, count);
        log.info(<span class="hljs-string">"========== 扣减库存结束 =========="</span>);
    }
}
</code></pre>
<p><strong>账户服务实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccountService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountMapper accountMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">(Long userId, BigDecimal money)</span> {
        log.info(<span class="hljs-string">"========== 扣减账户余额开始 =========="</span>);

        <span class="hljs-comment">// 模拟超时异常，测试分布式事务回滚</span>
        <span class="hljs-comment">// try {</span>
        <span class="hljs-comment">//     TimeUnit.SECONDS.sleep(20);</span>
        <span class="hljs-comment">// } catch (InterruptedException e) {</span>
        <span class="hljs-comment">//     e.printStackTrace();</span>
        <span class="hljs-comment">// }</span>

        accountMapper.decrease(userId, money);
        log.info(<span class="hljs-string">"========== 扣减账户余额结束 =========="</span>);
    }
}
</code></pre>
<p><strong>业务入口 - 使用 @GlobalTransactional 开启全局事务</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/business")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;

    <span class="hljs-comment">/**
     * 下单接口
     * <span class="hljs-doctag">@GlobalTransactional</span> 开启 Seata 全局事务
     */</span>
    <span class="hljs-meta">@PostMapping("/purchase")</span>
    <span class="hljs-meta">@GlobalTransactional(name = "purchase-order", rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">purchase</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Long userId,
                           <span class="hljs-meta">@RequestParam</span> Long productId,
                           <span class="hljs-meta">@RequestParam</span> Integer count,
                           <span class="hljs-meta">@RequestParam</span> BigDecimal money)</span> {
        log.info(<span class="hljs-string">"========== 开始全局事务，XID: {} =========="</span>, RootContext.getXID());

        orderService.createOrder(userId, productId, count, money);

        <span class="hljs-keyword">return</span> <span class="hljs-string">"下单成功"</span>;
    }
}
</code></pre>
<h4 data-id="heading-23">4.4 Seata TCC 模式实战</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * TCC 接口定义
 */</span>
<span class="hljs-meta">@LocalTCC</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountTccService</span> {

    <span class="hljs-comment">/**
     * Try: 冻结金额
     */</span>
    <span class="hljs-meta">@TwoPhaseBusinessAction(name = "accountTcc", commitMethod = "confirm", rollbackMethod = "cancel")</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryFreeze</span><span class="hljs-params">(<span class="hljs-meta">@BusinessActionContextParameter(paramName = "userId")</span> Long userId,
                      <span class="hljs-meta">@BusinessActionContextParameter(paramName = "money")</span> BigDecimal money)</span>;

    <span class="hljs-comment">/**
     * Confirm: 确认扣款
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext context)</span>;

    <span class="hljs-comment">/**
     * Cancel: 解冻金额
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext context)</span>;
}

<span class="hljs-comment">/**
 * TCC 实现
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountTccServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccountTccService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountMapper accountMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryFreeze</span><span class="hljs-params">(Long userId, BigDecimal money)</span> {
        log.info(<span class="hljs-string">"========== Try: 冻结金额 userId={}, money={} =========="</span>, userId, money);

        <span class="hljs-comment">// 检查余额是否充足</span>
        <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectByUserId(userId);
        <span class="hljs-keyword">if</span> (account.getResidue().compareTo(money) &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"余额不足"</span>);
        }

        <span class="hljs-comment">// 冻结金额：residue -= money, frozen += money</span>
        accountMapper.freeze(userId, money);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext context)</span> {
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> Long.valueOf(context.getActionContext(<span class="hljs-string">"userId"</span>).toString());
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">money</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(context.getActionContext(<span class="hljs-string">"money"</span>).toString());

        log.info(<span class="hljs-string">"========== Confirm: 确认扣款 userId={}, money={} =========="</span>, userId, money);

        <span class="hljs-comment">// 确认扣款：frozen -= money, used += money</span>
        accountMapper.confirmDecrease(userId, money);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext context)</span> {
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> Long.valueOf(context.getActionContext(<span class="hljs-string">"userId"</span>).toString());
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">money</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(context.getActionContext(<span class="hljs-string">"money"</span>).toString());

        log.info(<span class="hljs-string">"========== Cancel: 解冻金额 userId={}, money={} =========="</span>, userId, money);

        <span class="hljs-comment">// 解冻金额：frozen -= money, residue += money</span>
        accountMapper.cancelFreeze(userId, money);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-24">五、RocketMQ 事务消息</h3>
<h4 data-id="heading-25">5.1 事务消息原理</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                     RocketMQ 事务消息流程                               <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                                        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>   生产者                         Broker                    消费者       <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  <span class="hljs-number">1.</span> 发送Half消息             <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-comment">-----------------------------&gt;|                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  <span class="hljs-number">2.</span> 返回发送结果             <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">-----------------------------|                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  <span class="hljs-number">3.</span> 执行本地事务             <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-comment">----+                         |                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>    <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">---+                         |                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  <span class="hljs-number">4.</span> 提交<span class="hljs-operator">/</span>回滚事务状态        <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-comment">-----------------------------&gt;|                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>  <span class="hljs-number">5.</span> 投递消息(<span class="hljs-keyword">Commit</span>)     <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span><span class="hljs-comment">-------------------------&gt;|        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  回查本地事务状态(超时未确认)  <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">-----------------------------|                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-26">5.2 事务消息状态</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">------------------+------------------+------------------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-keyword">COMMIT</span>        <span class="hljs-operator">|</span>    <span class="hljs-keyword">ROLLBACK</span>      <span class="hljs-operator">|</span>    UNKNOW        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------------------+------------------+------------------+</span>
<span class="hljs-operator">|</span>  提交消息        <span class="hljs-operator">|</span>  回滚消息        <span class="hljs-operator">|</span>  未知状态        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  消费者可见      <span class="hljs-operator">|</span>  消息被删除      <span class="hljs-operator">|</span>  触发回查        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------------------+------------------+------------------+</span>
</code></pre>
<h4 data-id="heading-27">5.3 Maven 依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.rocketmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-28">5.4 配置文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">rocketmq:</span>
  <span class="hljs-attr">name-server:</span> <span class="hljs-string">localhost:9876</span>
  <span class="hljs-attr">producer:</span>
    <span class="hljs-attr">group:</span> <span class="hljs-string">tx-producer-group</span>
    <span class="hljs-attr">send-message-timeout:</span> <span class="hljs-number">3000</span>
</code></pre>
<h4 data-id="heading-29">5.5 事务消息生产者</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionProducerService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-comment">/**
     * 发送事务消息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendTransactionMessage</span><span class="hljs-params">(OrderDTO orderDTO)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();

        Message&lt;OrderDTO&gt; message = MessageBuilder
                .withPayload(orderDTO)
                .setHeader(<span class="hljs-string">"transactionId"</span>, transactionId)
                .build();

        <span class="hljs-comment">// 发送事务消息</span>
        <span class="hljs-type">TransactionSendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> rocketMQTemplate.sendMessageInTransaction(
                <span class="hljs-string">"order-topic:create"</span>,  <span class="hljs-comment">// topic:tag</span>
                message,
                orderDTO  <span class="hljs-comment">// arg 参数，传递给本地事务执行器</span>
        );

        log.info(<span class="hljs-string">"事务消息发送结果: {}, transactionId: {}"</span>,
                result.getLocalTransactionState(), transactionId);
    }
}
</code></pre>
<h4 data-id="heading-30">5.6 事务监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RocketMQTransactionListener</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTransactionListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQLocalTransactionListener</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TransactionLogMapper transactionLogMapper;

    <span class="hljs-comment">/**
     * 执行本地事务
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> RocketMQLocalTransactionState <span class="hljs-title function_">executeLocalTransaction</span><span class="hljs-params">(Message msg, Object arg)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> (String) msg.getHeaders().get(<span class="hljs-string">"transactionId"</span>);
        <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderDTO</span> <span class="hljs-operator">=</span> (OrderDTO) arg;

        log.info(<span class="hljs-string">"========== 执行本地事务，transactionId: {} =========="</span>, transactionId);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
            order.setUserId(orderDTO.getUserId());
            order.setProductId(orderDTO.getProductId());
            order.setCount(orderDTO.getCount());
            order.setMoney(orderDTO.getMoney());
            order.setStatus(<span class="hljs-number">0</span>);
            orderMapper.insert(order);

            <span class="hljs-comment">// 2. 记录事务日志（用于回查）</span>
            <span class="hljs-type">TransactionLog</span> <span class="hljs-variable">txLog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionLog</span>();
            txLog.setTransactionId(transactionId);
            txLog.setOrderId(order.getId());
            txLog.setStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 1: 已提交</span>
            transactionLogMapper.insert(txLog);

            log.info(<span class="hljs-string">"本地事务执行成功，提交消息"</span>);
            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.COMMIT;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"本地事务执行失败，回滚消息"</span>, e);
            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;
        }
    }

    <span class="hljs-comment">/**
     * 回查本地事务状态
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> RocketMQLocalTransactionState <span class="hljs-title function_">checkLocalTransaction</span><span class="hljs-params">(Message msg)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> (String) msg.getHeaders().get(<span class="hljs-string">"transactionId"</span>);

        log.info(<span class="hljs-string">"========== 回查本地事务状态，transactionId: {} =========="</span>, transactionId);

        <span class="hljs-comment">// 查询事务日志</span>
        <span class="hljs-type">TransactionLog</span> <span class="hljs-variable">txLog</span> <span class="hljs-operator">=</span> transactionLogMapper.selectByTransactionId(transactionId);

        <span class="hljs-keyword">if</span> (txLog != <span class="hljs-literal">null</span> &amp;&amp; txLog.getStatus() == <span class="hljs-number">1</span>) {
            log.info(<span class="hljs-string">"本地事务已提交"</span>);
            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.COMMIT;
        }

        log.info(<span class="hljs-string">"本地事务未提交，回滚消息"</span>);
        <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;
    }
}
</code></pre>
<h4 data-id="heading-31">5.7 事务消息消费者</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@RocketMQMessageListener(
        topic = "order-topic",
        selectorExpression = "create",
        consumerGroup = "order-consumer-group"
)</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTransactionConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;OrderDTO&gt; {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StorageService storageService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountService accountService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(OrderDTO orderDTO)</span> {
        log.info(<span class="hljs-string">"========== 收到订单消息: {} =========="</span>, orderDTO);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 扣减库存</span>
            storageService.decrease(orderDTO.getProductId(), orderDTO.getCount());

            <span class="hljs-comment">// 扣减账户余额</span>
            accountService.decrease(orderDTO.getUserId(), orderDTO.getMoney());

            log.info(<span class="hljs-string">"订单处理完成"</span>);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"订单处理失败"</span>, e);
            <span class="hljs-comment">// 消费失败会自动重试</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单处理失败"</span>, e);
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-32">六、本地消息表方案</h3>
<h4 data-id="heading-33">6.1 架构图</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                      本地消息表方案                                |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|   服务A                                      服务B                 |
|   +<span class="hljs-comment">------------------+                      +------------------+  |</span>
|   |    业务操作      |                      |    业务操作      |  |
|   +<span class="hljs-comment">--------+---------+                      +--------+---------+  |</span>
|            |                                         ^            |
|            v                                         |            |
|   +<span class="hljs-comment">------------------+                      +------------------+  |</span>
|   |   本地消息表     |                      |   消息消费       |  |
|   +<span class="hljs-comment">--------+---------+                      +--------+---------+  |</span>
|            |                                         ^            |
|            |         消息队列                        |            |
|            |    +<span class="hljs-comment">-----------------+                  |            |</span>
|            +<span class="hljs-comment">---&gt;|     MQ          |------------------+            |</span>
|                 +<span class="hljs-comment">-----------------+                               |</span>
|                         ^                                         |
|                         |                                         |
|                 +<span class="hljs-comment">-----------------+                               |</span>
|                 |   定时任务      |                               |
|                 |  (扫描未发送)   |                               |
|                 +<span class="hljs-comment">-----------------+                               |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-34">6.2 消息表结构</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `local_message` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `message_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息ID'</span>,
    `message_body` TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息内容'</span>,
    `message_topic` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息主题'</span>,
    `message_tag` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息标签'</span>,
    `status` TINYINT(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'状态: 0-待发送, 1-已发送, 2-已确认'</span>,
    `retry_count` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'重试次数'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_message_id` (`message_id`),
    KEY `idx_status` (`status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<h4 data-id="heading-35">6.3 核心代码实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalMessageService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalMessageMapper messageMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;

    <span class="hljs-comment">/**
     * 保存本地消息（与业务操作在同一事务中）
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveMessage</span><span class="hljs-params">(String topic, String tag, Object payload)</span> {
        <span class="hljs-type">LocalMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalMessage</span>();
        message.setMessageId(UUID.randomUUID().toString());
        message.setMessageTopic(topic);
        message.setMessageTag(tag);
        message.setMessageBody(JSON.toJSONString(payload));
        message.setStatus(<span class="hljs-number">0</span>);
        message.setRetryCount(<span class="hljs-number">0</span>);

        messageMapper.insert(message);
    }

    <span class="hljs-comment">/**
     * 发送消息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(LocalMessage message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">destination</span> <span class="hljs-operator">=</span> message.getMessageTag() != <span class="hljs-literal">null</span>
                    ? message.getMessageTopic() + <span class="hljs-string">":"</span> + message.getMessageTag()
                    : message.getMessageTopic();

            rocketMQTemplate.syncSend(destination, message.getMessageBody());

            <span class="hljs-comment">// 更新状态为已发送</span>
            message.setStatus(<span class="hljs-number">1</span>);
            messageMapper.updateById(message);

            log.info(<span class="hljs-string">"消息发送成功: {}"</span>, message.getMessageId());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"消息发送失败: {}"</span>, message.getMessageId(), e);

            <span class="hljs-comment">// 增加重试次数</span>
            message.setRetryCount(message.getRetryCount() + <span class="hljs-number">1</span>);
            messageMapper.updateById(message);
        }
    }

    <span class="hljs-comment">/**
     * 确认消息（消费成功后调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirmMessage</span><span class="hljs-params">(String messageId)</span> {
        <span class="hljs-type">LocalMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> messageMapper.selectByMessageId(messageId);
        <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {
            message.setStatus(<span class="hljs-number">2</span>);
            messageMapper.updateById(message);
        }
    }
}
</code></pre>
<h4 data-id="heading-36">6.4 定时任务扫描发送</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageSendTask</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalMessageMapper messageMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalMessageService messageService;

    <span class="hljs-comment">/**
     * 每隔10秒扫描一次待发送消息
     */</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 10000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scanAndSendMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 查询待发送的消息（status=0 且重试次数小于5）</span>
        List&lt;LocalMessage&gt; messages = messageMapper.selectPendingMessages(<span class="hljs-number">5</span>);

        <span class="hljs-keyword">for</span> (LocalMessage message : messages) {
            log.info(<span class="hljs-string">"扫描到待发送消息: {}"</span>, message.getMessageId());
            messageService.sendMessage(message);
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-37">七、最佳实践与选型建议</h3>
<h4 data-id="heading-38">7.1 方案选型决策树</h4>
<pre><code class="hljs language-lua" lang="lua">                        开始选型
                           |
                           v
                    +<span class="hljs-comment">-------------+</span>
                    | 是否需要    |
                    | 强一致性?   |
                    +<span class="hljs-comment">------+------+</span>
                           |
              +<span class="hljs-comment">------------+------------+</span>
              |                         |
              v                         v
             是                        否
              |                         |
              v                         v
      +<span class="hljs-comment">-------+-------+         +-------+-------+</span>
      | 业务能否      |         | 考虑最终      |
      | 接受性能损耗? |         | 一致性方案    |
      +<span class="hljs-comment">-------+-------+         +-------+-------+</span>
              |                         |
      +<span class="hljs-comment">-------+-------+         +-------+-------+</span>
      |               |         |               |
      v               v         v               v
     是              否      事务消息      本地消息表
      |               |         |               |
      v               v         v               v
  Seata AT        Seata TCC   RocketMQ      可靠性要求高
</code></pre>
<h4 data-id="heading-39">7.2 各方案适用场景</h4>



































<table><thead><tr><th>方案</th><th>适用场景</th><th>典型案例</th></tr></thead><tbody><tr><td>Seata AT</td><td>常规业务、对一致性要求高</td><td>订单创建、库存扣减</td></tr><tr><td>Seata TCC</td><td>资金类业务、需要精确控制</td><td>转账、支付</td></tr><tr><td>RocketMQ事务消息</td><td>异步处理、最终一致性</td><td>订单通知、积分发放</td></tr><tr><td>本地消息表</td><td>可靠性要求高、不依赖MQ</td><td>跨系统数据同步</td></tr><tr><td>Saga</td><td>长事务、复杂业务流程</td><td>机票+酒店+租车预订</td></tr></tbody></table>
<h4 data-id="heading-40">7.3 生产环境注意事项</h4>
<pre><code class="hljs language-css" lang="css">+------------------------------------------------------------------+
|                    生产环境 Checklist                             |
+------------------------------------------------------------------+
|                                                                   |
|  <span class="hljs-selector-attr">[ ]</span> TC Server 高可用部署（至少<span class="hljs-number">3</span>节点）                             |
|  <span class="hljs-selector-attr">[ ]</span> 配置合理的事务超时时间                                        |
|  <span class="hljs-selector-attr">[ ]</span> 监控全局事务状态                                              |
|  <span class="hljs-selector-attr">[ ]</span> 处理悬挂事务                                                  |
|  <span class="hljs-selector-attr">[ ]</span> 幂等性设计                                                   |
|  <span class="hljs-selector-attr">[ ]</span> 异常重试机制                                                 |
|  <span class="hljs-selector-attr">[ ]</span> 分布式锁防并发                                               |
|  <span class="hljs-selector-attr">[ ]</span> 日志记录完整                                                 |
|                                                                   |
+------------------------------------------------------------------+
</code></pre>
<h4 data-id="heading-41">7.4 幂等性设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentOrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IDEMPOTENT_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:idempotent:"</span>;

    <span class="hljs-comment">/**
     * 幂等性创建订单
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrderIdempotent</span><span class="hljs-params">(String requestId, OrderDTO orderDTO)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> IDEMPOTENT_KEY_PREFIX + requestId;

        <span class="hljs-comment">// 1. 检查是否已处理</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">setResult</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue()
                .setIfAbsent(key, <span class="hljs-string">"processing"</span>, Duration.ofMinutes(<span class="hljs-number">30</span>));

        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(setResult)) {
            <span class="hljs-comment">// 已存在，查询已有订单返回</span>
            log.info(<span class="hljs-string">"重复请求，requestId: {}"</span>, requestId);
            <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByRequestId(requestId);
            <span class="hljs-keyword">if</span> (existOrder != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> existOrder;
            }
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单处理中，请稍后查询"</span>);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 创建订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
            order.setRequestId(requestId);
            order.setUserId(orderDTO.getUserId());
            order.setProductId(orderDTO.getProductId());
            order.setCount(orderDTO.getCount());
            order.setMoney(orderDTO.getMoney());
            order.setStatus(<span class="hljs-number">0</span>);
            orderMapper.insert(order);

            <span class="hljs-comment">// 3. 更新 Redis 状态</span>
            redisTemplate.opsForValue().set(key, <span class="hljs-string">"completed"</span>, Duration.ofHours(<span class="hljs-number">24</span>));

            <span class="hljs-keyword">return</span> order;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 失败则删除 key，允许重试</span>
            redisTemplate.delete(key);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-42">八、总结</h3>
<p>分布式事务是微服务架构中的核心难题，没有银弹方案。选择合适的方案需要权衡：</p>
<ol>
<li><strong>一致性要求</strong>：强一致性选 Seata，最终一致性选事务消息</li>
<li><strong>性能要求</strong>：高性能选异步方案，低延迟选 AT 模式</li>
<li><strong>业务复杂度</strong>：简单业务用 AT，复杂业务用 TCC 或 Saga</li>
<li><strong>运维成本</strong>：本地消息表最简单，Seata 需要维护 TC</li>
</ol>
<p>核心原则：</p>
<ul>
<li><strong>能不用分布式事务就不用</strong>：合理拆分服务边界</li>
<li><strong>优先考虑最终一致性</strong>：大多数业务可以接受</li>
<li><strong>做好幂等设计</strong>：分布式环境必备</li>
<li><strong>完善监控告警</strong>：及时发现和处理异常事务</li>
</ul>
<p>希望本文能帮助你在实际项目中更好地应对分布式事务挑战！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[redis的qps从100飙升到10000的全流程解决方案]]></title>    <link>https://juejin.cn/post/7577715145122037814</link>    <guid>https://juejin.cn/post/7577715145122037814</guid>    <pubDate>2025-11-29T21:22:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577715145122037814" data-draft-id="7577704980855504950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="redis的qps从100飙升到10000的全流程解决方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T21:22:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="随风飘的云"/> <meta itemprop="url" content="https://juejin.cn/user/361110952753560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            redis的qps从100飙升到10000的全流程解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/361110952753560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    随风飘的云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T21:22:44.000Z" title="Sat Nov 29 2025 21:22:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis QPS 从 100 飙升至 10000 属于典型的流量突增场景，核心排查逻辑是<strong>先区分 “合法流量增长” 还是 “异常 / 低效请求导致”，再针对性止血 + 根因修复</strong>，全程需结合 Redis 监控、日志和命令分析，以下是全流程排查与解决方案：</p>
<h3 data-id="heading-0">一、紧急止血：避免 Redis 宕机（0-5 分钟）</h3>
<p>Redis 单实例 QPS 极限约 10 万 - 15 万，但突增到 1 万可能导致 CPU / 内存 / 网络打满，先快速控风险：</p>
<ol>
<li>
<p><strong>临时限流 / 降级</strong></p>
<ul>
<li>若 Redis 接入了网关 / 代理（如 Nginx、Kong、Redis Cluster Proxy），立即配置 Redis QPS 限流阈值（如设为 12000，留缓冲），超出请求返回 “服务繁忙” 或走降级逻辑（如返回本地缓存）。</li>
<li>对非核心业务的 Redis 请求（如统计、日志上报）直接降级，暂停调用，优先保障核心流程（如下单、支付）。</li>
</ul>
</li>
<li>
<p><strong>扩容缓解压力</strong></p>
<ul>
<li>若为单机 Redis，快速切换至 Redis Cluster 并新增节点（如从 3 节点扩至 6 节点），分摊流量；若已为集群，将热点槽位迁移至空闲节点。</li>
<li>检查 Redis 所在服务器的资源（CPU、内存、网卡），若 CPU&gt;90%/ 网卡带宽打满，临时扩容服务器配置（如 CPU 核数翻倍、带宽升级）。</li>
</ul>
</li>
<li>
<p><strong>禁用危险命令</strong></p>
<ul>
<li>临时禁用高开销命令（如<code>KEYS *</code>、<code>FLUSHDB</code>、<code>HGETALL</code>、<code>SMEMBERS</code>），避免雪上加霜（可通过<code>redis.conf</code>或<code>CONFIG SET disable-commands "KEYS,FLUSHDB"</code>配置）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">二、定位根因：明确 QPS 飙升的核心原因（5-30 分钟）</h3>
<p>通过 Redis 自带工具 + 监控平台，从 “请求来源、命令类型、业务场景” 三维度分析：</p>
<h4 data-id="heading-2">步骤 1：基础监控分析（先看宏观指标）</h4>
<p>通过<code>redis-cli info stats</code>/ 监控平台（如 Prometheus+Grafana、Redis Insight、阿里云 Redis 控制台）查看核心指标：</p>



































<table><thead><tr><th>核心指标</th><th>异常表现</th><th>指向问题</th></tr></thead><tbody><tr><td><code>instantaneous_ops_per_sec</code></td><td>稳定 100→突增 10000</td><td>流量真实增长 / 低效请求叠加</td></tr><tr><td><code>used_cpu_sys</code>/<code>used_cpu_user</code></td><td>CPU&gt;80%</td><td>计算密集型命令（如排序、聚合）或高频小命令（如 INCR）</td></tr><tr><td><code>used_memory</code>/<code>used_memory_rss</code></td><td>内存突增</td><td>大 value 写入、缓存过期策略失效</td></tr><tr><td><code>network_input_bytes</code>/<code>network_output_bytes</code></td><td>网卡打满</td><td>大流量请求（如 HGETALL、大字符串 GET）</td></tr><tr><td><code>keyspace_hits</code>/<code>keyspace_misses</code></td><td>缓存命中率骤降（&lt;80%）</td><td>缓存穿透 / 缓存失效，导致大量无效请求</td></tr></tbody></table>
<h4 data-id="heading-3">步骤 2：分析请求来源（找流量入口）</h4>
<ol>
<li>
<p><strong>定位调用方 IP / 服务</strong>：</p>
<ul>
<li>查看 Redis 慢日志 / 访问日志（需提前开启<code>slowlog</code>），执行<code>slowlog get 100</code>，筛选请求来源 IP；</li>
<li>若接入了链路追踪（如 SkyWalking、Pinpoint），直接查看调用 Redis 的服务列表，确认是否某服务 / IP 的调用量突增（如某新上线功能、定时任务）。</li>
</ul>
</li>
<li>
<p><strong>判断流量合法性</strong>：</p>
<ul>
<li>若单 IP 调用量占比 &gt; 50%，大概率是爬虫、恶意攻击或客户端 BUG（如无限重试、循环请求），直接在防火墙 / Redis 端拉黑该 IP；</li>
<li>若调用方为内部服务，检查是否有代码 BUG（如重试逻辑异常、循环查询 Redis）。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-4">步骤 3：分析命令类型（找低效 / 高频命令）</h4>
<p>执行<code>redis-cli --stat</code>（实时统计命令执行次数）或<code>info commandstats</code>（按命令统计），重点关注：</p>
<ol>
<li>
<p><strong>高频小命令</strong>：</p>
<ul>
<li>如<code>INCR</code>/<code>DECR</code>/<code>HSET</code>/<code>GET</code>/<code>SET</code>占比 &gt; 90%，且 QPS=10000，可能是正常业务增长（如秒杀、计数场景），或客户端无缓存直接调用 Redis；</li>
</ul>
</li>
<li>
<p><strong>高开销命令</strong>：</p>
<ul>
<li>若<code>SORT</code>/<code>ZUNIONSTORE</code>/<code>HGETALL</code>/<code>SMEMBERS</code>/<code>KEYS</code>占比高，哪怕单次调用，也会因耗时久导致 QPS “被动升高”（请求堆积）；</li>
<li>若<code>MGET</code>/<code>MSET</code>调用少，但单条命令携带上千个 key，等价于放大了 QPS（如 1 次 MGET 带 1000 个 key=1000 次 GET）；</li>
</ul>
</li>
<li>
<p><strong>无效请求</strong>：</p>
<ul>
<li>缓存穿透：<code>GET</code>不存在的 key 占比高（<code>keyspace_misses</code>高），导致 Redis 空查，QPS 虚高；</li>
<li>缓存雪崩：大量 key 同时过期，导致所有请求直接打 Redis，QPS 突增；</li>
<li>缓存击穿：单个热点 key 过期，大量请求同时访问该 key，瞬间拉高 QPS。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">三、分场景解决方案（30 分钟后）</h3>
<p>根据根因针对性修复，从 “临时缓解” 到 “长期优化”：</p>













































<table><thead><tr><th>飙升类型</th><th>临时解决方案</th><th>长期优化方案</th></tr></thead><tbody><tr><td>正常业务增长（如秒杀）</td><td>1. 扩容 Redis Cluster 节点数；2. 热点 key 分片（如将 count:123 拆为 count:123:1~10）；3. 增加本地缓存（如 Guava）分担流量</td><td>1. 配置 Redis 弹性伸缩（QPS 超 8000 自动扩容）；2. 对计数类场景使用 Redis HyperLogLog / 计数器组件；3. 压测验证 Redis 极限 QPS（如模拟 2 万 QPS）</td></tr><tr><td>高频低效命令（如 HGETALL、KEYS）</td><td>1. 临时替换为低开销命令（如 HGETALL→HSCAN 分批获取，KEYS→SCAN）；2. 限制大 key（&gt;100KB）的读写</td><td>1. 规范 Redis 命令使用手册，禁用高开销命令；2. 拆分大 key（如大 Hash 拆为多个小 Hash）；3. 对聚合类查询（如排序）迁移至离线计算（如 Spark）</td></tr><tr><td>缓存穿透</td><td>1. 临时配置空值缓存（如对不存在的 key 设置过期时间 1 分钟）；2. 布隆过滤器拦截无效 key</td><td>1. 接入全局布隆过滤器（如 RedisBloom 模块）；2. 业务层校验请求参数，过滤无效 key</td></tr><tr><td>缓存雪崩</td><td>1. 临时延长过期 key 的 TTL；2. 对过期时间添加随机值（如 TTL=30 分钟 ±5 分钟）</td><td>1. 核心 key 设置永不过期，通过后台异步更新；2. 分级缓存（本地缓存 + Redis）；3. 过期时间错开（按业务维度分批过期）</td></tr><tr><td>缓存击穿</td><td>1. 临时对热点 key 加互斥锁（如 SETNX），只允许 1 个请求更新缓存，其余等待；2. 热点 key 设为永不过期</td><td>1. 接入 Redis 热点 key 探测工具（如 Redis Cluster 的 hot-key-detect）；2. 热点 key 预加载 + 本地缓存；3. 使用 Redisson 分布式锁优化缓存更新逻辑</td></tr><tr><td>恶意攻击 / 客户端 BUG</td><td>1. 拉黑异常 IP / 服务；2. 限制单客户端连接数（CONFIG SET maxclients 1000）；3. 通知调用方修复重试逻辑</td><td>1. Redis 接入 WAF，拦截高频异常请求；2. 客户端添加请求限流（如每秒调用 Redis 不超过 100 次）；3. 完善客户端重试机制（最多 3 次，间隔 100ms）</td></tr><tr><td>大流量请求（网卡打满）</td><td>1. 临时压缩 Redis 传输数据（如使用 Protocol Buffer 代替 JSON）；2. 限制单条请求的 value 大小（&lt;10KB）</td><td>1. 开启 Redis 压缩（CONFIG SET rdbcompression yes）；2. 大文件 / 大数据迁移至对象存储（如 OSS），Redis 仅存索引</td></tr></tbody></table>
<h3 data-id="heading-6">四、复盘与长效防护（问题解决后 1-2 天）</h3>
<ol>
<li>
<p><strong>完善监控告警</strong>：</p>
<ul>
<li>新增告警规则：QPS 5 分钟内增长超 200%、CPU&gt;80%、缓存命中率 &lt; 90%、大 key 数量突增；</li>
<li>监控维度：QPS、CPU、内存、网卡、缓存命中率、慢命令数、大 key 数量。</li>
</ul>
</li>
<li>
<p><strong>规范 Redis 使用</strong>：</p>
<ul>
<li>制定 Redis 开发规范：禁用高开销命令、限制 key/value 大小、强制设置过期时间（核心 key 除外）；</li>
<li>上线前审核：所有 Redis 调用需经过代码评审，避免低效 / 高频请求。</li>
</ul>
</li>
<li>
<p><strong>应急演练</strong>：</p>
<ul>
<li>模拟 Redis QPS 突增到 1 万、2 万的场景，验证限流、扩容、降级方案的有效性；</li>
<li>整理 Redis 应急排查手册，明确责任人、工具（如 slowlog、info 命令）和步骤。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">关键工具速查</h3>





























<table><thead><tr><th>排查目标</th><th>核心命令 / 工具</th></tr></thead><tbody><tr><td>实时 QPS / 命令统计</td><td><code>redis-cli --stat</code>、<code>info commandstats</code></td></tr><tr><td>慢请求分析</td><td><code>slowlog get 100</code>、<code>slowlog len</code></td></tr><tr><td>大 key 检测</td><td><code>redis-cli --bigkeys</code>、Redis Insight</td></tr><tr><td>流量来源</td><td>Redis 访问日志、链路追踪平台（SkyWalking）</td></tr><tr><td>资源监控</td><td><code>top</code>（CPU / 内存）、<code>iftop</code>（网卡）、Prometheus+Grafana</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[财务对账系统设计与实现]]></title>    <link>https://juejin.cn/post/7577718777481527334</link>    <guid>https://juejin.cn/post/7577718777481527334</guid>    <pubDate>2025-11-29T16:18:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777481527334" data-draft-id="7577599299598827571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="财务对账系统设计与实现"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-29T16:18:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            财务对账系统设计与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:18:20.000Z" title="Sat Nov 29 2025 16:18:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">财务对账系统设计与实现：支付宝、微信、银行流水全渠道对账</h2>
<h3 data-id="heading-1">前言</h3>
<p>在电商、金融等业务场景中，对账系统是保障资金安全的核心环节。本文将详细介绍如何设计和实现一套支持支付宝、微信、银行等多渠道的财务对账系统，涵盖系统架构、核心算法、代码实现等内容。</p>
<hr/>
<h3 data-id="heading-2">一、对账系统概述</h3>
<h4 data-id="heading-3">1.1 什么是对账</h4>
<p>对账是指将企业内部的交易记录与外部渠道（支付宝、微信、银行等）的流水记录进行核对，确保双方数据一致的过程。</p>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                        对账核心流程                                |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|   内部系统                                       外部渠道          |
|   +<span class="hljs-comment">------------------+                    +------------------+    |</span>
|   |   交易订单表     |                    |   支付宝账单     |    |
|   |   支付流水表     |      对账核心      |   微信账单       |    |
|   |   退款记录表     |  &lt;<span class="hljs-comment">--------------&gt; |   银行流水       |    |</span>
|   +<span class="hljs-comment">------------------+                    |   自定义流水     |    |</span>
|                                           +<span class="hljs-comment">------------------+    |</span>
|                             |                                     |
|                             v                                     |
|                    +<span class="hljs-comment">------------------+                           |</span>
|                    |    对账结果      |                           |
|                    +<span class="hljs-comment">------------------+                           |</span>
|                    | - 对账成功       |                           |
|                    | - 本地有渠道无   |                           |
|                    | - 渠道有本地无   |                           |
|                    | - 金额不一致     |                           |
|                    +<span class="hljs-comment">------------------+                           |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-4">1.2 对账的目的</h4>
<ol>
<li><strong>资金安全</strong>：及时发现异常交易，防止资金损失</li>
<li><strong>账务准确</strong>：确保财务报表数据准确</li>
<li><strong>差错处理</strong>：快速定位和处理对账差异</li>
<li><strong>风险控制</strong>：发现潜在的欺诈和风险</li>
</ol>
<h4 data-id="heading-5">1.3 对账差异类型</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                        对账差异分类                                |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |     差异类型       |              描述                  |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   本地多（长款）   |  本地有记录，渠道无记录             |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   渠道多（短款）   |  渠道有记录，本地无记录             |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   金额不一致       |  双方都有记录，但金额不同           |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   状态不一致       |  双方金额相同，但交易状态不同       |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   时间差异         |  交易时间跨天导致的差异             |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">二、系统架构设计</h3>
<h4 data-id="heading-7">2.1 整体架构</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------------+</span>
|                          对账系统整体架构                                |
+<span class="hljs-comment">------------------------------------------------------------------------+</span>
|                                                                         |
|   +<span class="hljs-comment">-------------------+    +-------------------+    +------------------+ |</span>
|   |    定时任务       |    |    手动触发       |    |    文件上传      | |
|   +<span class="hljs-comment">--------+----------+    +--------+----------+    +--------+---------+ |</span>
|            |                        |                        |          |
|            +<span class="hljs-comment">------------------------+------------------------+          |</span>
|                                     |                                   |
|                                     v                                   |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|   |                          对账调度中心                                |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|                                     |                                   |
|            +<span class="hljs-comment">------------------------+------------------------+          |</span>
|            |                        |                        |          |
|            v                        v                        v          |
|   +<span class="hljs-comment">----------------+       +----------------+       +----------------+  |</span>
|   | 支付宝对账模块 |       | 微信对账模块   |       | 银行对账模块   |  |
|   +<span class="hljs-comment">----------------+       +----------------+       +----------------+  |</span>
|            |                        |                        |          |
|            +<span class="hljs-comment">------------------------+------------------------+          |</span>
|                                     |                                   |
|                                     v                                   |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|   |                          对账引擎核心                                |
|   |  +<span class="hljs-comment">-------------+  +-------------+  +-------------+  +-------------+ |</span>
|   |  | 文件解析器  |  | 数据清洗    |  | 匹配算法    |  | 差异处理    | |
|   |  +<span class="hljs-comment">-------------+  +-------------+  +-------------+  +-------------+ |</span>
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|                                     |                                   |
|                                     v                                   |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|   |                          数据存储层                                  |
|   |  +<span class="hljs-comment">-------------+  +-------------+  +-------------+  +-------------+ |</span>
|   |  | 对账任务表  |  | 渠道流水表  |  | 对账结果表  |  | 差异记录表  | |
|   |  +<span class="hljs-comment">-------------+  +-------------+  +-------------+  +-------------+ |</span>
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|                                     |                                   |
|                                     v                                   |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|   |                          监控告警层                                  |
|   |  +<span class="hljs-comment">------------------+  +------------------+  +-------------------+  |</span>
|   |  | 对账进度监控     |  | 差异率告警       |  | 异常通知          |  |
|   |  +<span class="hljs-comment">------------------+  +------------------+  +-------------------+  |</span>
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|                                                                         |
+<span class="hljs-comment">------------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-8">2.2 核心模块说明</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+------------------------------------------------------------------+</span>
|                        核心模块职责                                |
<span class="hljs-addition">+------------------------------------------------------------------+</span>
|                                                                   |
|   对账调度中心：                                                   |
|   - 管理对账任务的创建、调度、执行                                 |
|   - 支持定时对账和手动触发                                        |
|   - 任务状态管理和失败重试                                        |
|                                                                   |
|   文件解析器：                                                     |
|   - 支持 CSV、Excel、TXT 等格式                                   |
|   - 适配不同渠道的账单格式                                        |
|   - 大文件分片解析                                                |
|                                                                   |
|   匹配算法：                                                       |
|   - 单字段匹配（订单号）                                          |
|   - 多字段联合匹配                                                |
|   - 模糊匹配和容差匹配                                            |
|                                                                   |
|   差异处理：                                                       |
|   - 差异分类和标记                                                |
|   - 自动处理规则                                                  |
|   - 人工审核流程                                                  |
|                                                                   |
<span class="hljs-addition">+------------------------------------------------------------------+</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">三、数据库设计</h3>
<h4 data-id="heading-10">3.1 核心表结构</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 对账任务表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `recon_task` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
    `task_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务编号'</span>,
    `channel_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道类型：ALIPAY/WECHAT/BANK/CUSTOM'</span>,
    `recon_date` <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'对账日期'</span>,
    `status` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'状态：0-待处理,1-处理中,2-已完成,3-失败'</span>,
    `total_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'总记录数'</span>,
    `success_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账成功数'</span>,
    `fail_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账失败数'</span>,
    `diff_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'差异数'</span>,
    `file_path` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>) COMMENT <span class="hljs-string">'账单文件路径'</span>,
    `error_msg` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">1000</span>) COMMENT <span class="hljs-string">'错误信息'</span>,
    `start_time` DATETIME COMMENT <span class="hljs-string">'开始时间'</span>,
    `end_time` DATETIME COMMENT <span class="hljs-string">'结束时间'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_task_no` (`task_no`),
    KEY `idx_channel_date` (`channel_type`, `recon_date`),
    KEY `idx_status` (`status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'对账任务表'</span>;

<span class="hljs-comment">-- 2. 渠道流水表（支付宝）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `channel_bill_alipay` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付宝交易号'</span>,
    `out_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `trade_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易类型'</span>,
    `trade_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易状态'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交易金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `trade_time` DATETIME COMMENT <span class="hljs-string">'交易时间'</span>,
    `subject` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'商品名称'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态：0-待对账,1-已对账,2-差异'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_trade_no` (`trade_no`),
    KEY `idx_out_trade_no` (`out_trade_no`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'支付宝账单流水'</span>;

<span class="hljs-comment">-- 3. 渠道流水表（微信）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `channel_bill_wechat` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `transaction_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'微信支付订单号'</span>,
    `out_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `trade_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易类型'</span>,
    `trade_state` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易状态'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交易金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `trade_time` DATETIME COMMENT <span class="hljs-string">'交易时间'</span>,
    `body` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'商品描述'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_transaction_id` (`transaction_id`),
    KEY `idx_out_trade_no` (`out_trade_no`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'微信账单流水'</span>;

<span class="hljs-comment">-- 4. 渠道流水表（银行）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `channel_bill_bank` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `bank_serial_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'银行流水号'</span>,
    `merchant_order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `trans_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易类型：DEBIT/CREDIT'</span>,
    `trans_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易状态'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交易金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `trans_time` DATETIME COMMENT <span class="hljs-string">'交易时间'</span>,
    `remark` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'备注'</span>,
    `account_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) COMMENT <span class="hljs-string">'账户号'</span>,
    `account_name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'账户名'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_bank_serial_no` (`bank_serial_no`),
    KEY `idx_merchant_order_no` (`merchant_order_no`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'银行账单流水'</span>;

<span class="hljs-comment">-- 5. 自定义渠道流水表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `channel_bill_custom` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `channel_code` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道编码'</span>,
    `channel_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道交易号'</span>,
    `merchant_order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `trade_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易类型'</span>,
    `trade_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易状态'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交易金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `trade_time` DATETIME COMMENT <span class="hljs-string">'交易时间'</span>,
    `ext_data` JSON COMMENT <span class="hljs-string">'扩展数据'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_channel_trade_no` (`channel_code`, `channel_trade_no`),
    KEY `idx_merchant_order_no` (`merchant_order_no`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'自定义渠道流水'</span>;

<span class="hljs-comment">-- 6. 本地支付流水表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `local_payment_record` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商户订单号'</span>,
    `channel_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付渠道'</span>,
    `channel_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'渠道交易号'</span>,
    `pay_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'支付类型'</span>,
    `pay_status` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付状态：0-待支付,1-支付成功,2-支付失败,3-已退款'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `pay_time` DATETIME COMMENT <span class="hljs-string">'支付时间'</span>,
    `user_id` <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    `product_name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'商品名称'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态：0-待对账,1-已对账,2-差异'</span>,
    `recon_time` DATETIME COMMENT <span class="hljs-string">'对账时间'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_order_no` (`order_no`),
    KEY `idx_channel_trade_no` (`channel_type`, `channel_trade_no`),
    KEY `idx_pay_time` (`pay_time`),
    KEY `idx_recon_status` (`recon_status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'本地支付流水表'</span>;

<span class="hljs-comment">-- 7. 对账结果表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `recon_result` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `channel_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'渠道交易号'</span>,
    `result_type` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'结果类型：1-匹配成功,2-本地多,3-渠道多,4-金额不一致,5-状态不一致'</span>,
    `local_amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'本地金额'</span>,
    `channel_amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'渠道金额'</span>,
    `diff_amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'差异金额'</span>,
    `local_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'本地状态'</span>,
    `channel_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'渠道状态'</span>,
    `handle_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'处理状态：0-待处理,1-已处理,2-忽略'</span>,
    `handle_remark` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>) COMMENT <span class="hljs-string">'处理备注'</span>,
    `handler` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'处理人'</span>,
    `handle_time` DATETIME COMMENT <span class="hljs-string">'处理时间'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_order_no` (`order_no`),
    KEY `idx_result_type` (`result_type`),
    KEY `idx_handle_status` (`handle_status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'对账结果表'</span>;

<span class="hljs-comment">-- 8. 渠道配置表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `recon_channel_config` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `channel_code` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道编码'</span>,
    `channel_name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道名称'</span>,
    `file_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'文件类型：CSV/EXCEL/TXT'</span>,
    `file_encoding` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'UTF-8'</span> COMMENT <span class="hljs-string">'文件编码'</span>,
    `field_mapping` JSON COMMENT <span class="hljs-string">'字段映射配置'</span>,
    `parser_class` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'解析器类名'</span>,
    `status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">'状态：0-禁用,1-启用'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_channel_code` (`channel_code`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'渠道配置表'</span>;
</code></pre>
<h4 data-id="heading-11">3.2 E-R 关系图</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                          E-R 关系图                               |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|   +<span class="hljs-comment">-------------+       1:N       +-------------------+           |</span>
|   | recon_task  |<span class="hljs-comment">----------------&gt;| channel_bill_xxx |           |</span>
|   +<span class="hljs-comment">-------------+                 +-------------------+           |</span>
|         |                                                         |
|         | <span class="hljs-number">1</span>:N                                                     |
|         v                                                         |
|   +<span class="hljs-comment">-------------+                 +---------------------+         |</span>
|   | recon_result|&lt;<span class="hljs-comment">---------------&gt;| local_payment_record|         |</span>
|   +<span class="hljs-comment">-------------+      关联       +---------------------+         |</span>
|                                                                   |
|   +<span class="hljs-comment">---------------------+                                         |</span>
|   | recon_channel_config|  渠道配置（独立）                        |
|   +<span class="hljs-comment">---------------------+                                         |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">四、核心代码实现</h3>
<h4 data-id="heading-13">4.1 基础实体类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 渠道类型枚举
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ChannelType</span> {
    ALIPAY(<span class="hljs-string">"ALIPAY"</span>, <span class="hljs-string">"支付宝"</span>),
    WECHAT(<span class="hljs-string">"WECHAT"</span>, <span class="hljs-string">"微信支付"</span>),
    BANK(<span class="hljs-string">"BANK"</span>, <span class="hljs-string">"银行"</span>),
    CUSTOM(<span class="hljs-string">"CUSTOM"</span>, <span class="hljs-string">"自定义渠道"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    ChannelType(String code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> code; }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> desc; }
}

<span class="hljs-comment">/**
 * 对账结果类型枚举
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ReconResultType</span> {
    MATCHED(<span class="hljs-number">1</span>, <span class="hljs-string">"匹配成功"</span>),
    LOCAL_MORE(<span class="hljs-number">2</span>, <span class="hljs-string">"本地多（长款）"</span>),
    CHANNEL_MORE(<span class="hljs-number">3</span>, <span class="hljs-string">"渠道多（短款）"</span>),
    AMOUNT_MISMATCH(<span class="hljs-number">4</span>, <span class="hljs-string">"金额不一致"</span>),
    STATUS_MISMATCH(<span class="hljs-number">5</span>, <span class="hljs-string">"状态不一致"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    ReconResultType(<span class="hljs-type">int</span> code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> code; }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> desc; }
}

<span class="hljs-comment">/**
 * 对账任务状态枚举
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TaskStatus</span> {
    PENDING(<span class="hljs-number">0</span>, <span class="hljs-string">"待处理"</span>),
    PROCESSING(<span class="hljs-number">1</span>, <span class="hljs-string">"处理中"</span>),
    COMPLETED(<span class="hljs-number">2</span>, <span class="hljs-string">"已完成"</span>),
    FAILED(<span class="hljs-number">3</span>, <span class="hljs-string">"失败"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    TaskStatus(<span class="hljs-type">int</span> code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> code; }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> desc; }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账任务实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("recon_task")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconTask</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String taskNo;
    <span class="hljs-keyword">private</span> String channelType;
    <span class="hljs-keyword">private</span> LocalDate reconDate;
    <span class="hljs-keyword">private</span> Integer status;
    <span class="hljs-keyword">private</span> Integer totalCount;
    <span class="hljs-keyword">private</span> Integer successCount;
    <span class="hljs-keyword">private</span> Integer failCount;
    <span class="hljs-keyword">private</span> Integer diffCount;
    <span class="hljs-keyword">private</span> String filePath;
    <span class="hljs-keyword">private</span> String errorMsg;
    <span class="hljs-keyword">private</span> LocalDateTime startTime;
    <span class="hljs-keyword">private</span> LocalDateTime endTime;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-comment">/**
 * 统一渠道账单数据模型
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelBillDTO</span> {
    <span class="hljs-keyword">private</span> String channelTradeNo;      <span class="hljs-comment">// 渠道交易号</span>
    <span class="hljs-keyword">private</span> String merchantOrderNo;     <span class="hljs-comment">// 商户订单号</span>
    <span class="hljs-keyword">private</span> String tradeType;           <span class="hljs-comment">// 交易类型</span>
    <span class="hljs-keyword">private</span> String tradeStatus;         <span class="hljs-comment">// 交易状态</span>
    <span class="hljs-keyword">private</span> BigDecimal amount;          <span class="hljs-comment">// 交易金额</span>
    <span class="hljs-keyword">private</span> BigDecimal fee;             <span class="hljs-comment">// 手续费</span>
    <span class="hljs-keyword">private</span> LocalDateTime tradeTime;    <span class="hljs-comment">// 交易时间</span>
    <span class="hljs-keyword">private</span> String remark;              <span class="hljs-comment">// 备注</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; extData;<span class="hljs-comment">// 扩展数据</span>
}

<span class="hljs-comment">/**
 * 本地支付记录实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("local_payment_record")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalPaymentRecord</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String orderNo;
    <span class="hljs-keyword">private</span> String channelType;
    <span class="hljs-keyword">private</span> String channelTradeNo;
    <span class="hljs-keyword">private</span> String payType;
    <span class="hljs-keyword">private</span> Integer payStatus;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> BigDecimal fee;
    <span class="hljs-keyword">private</span> LocalDateTime payTime;
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> String productName;
    <span class="hljs-keyword">private</span> Integer reconStatus;
    <span class="hljs-keyword">private</span> LocalDateTime reconTime;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-comment">/**
 * 对账结果实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("recon_result")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconResult</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long taskId;
    <span class="hljs-keyword">private</span> String orderNo;
    <span class="hljs-keyword">private</span> String channelTradeNo;
    <span class="hljs-keyword">private</span> Integer resultType;
    <span class="hljs-keyword">private</span> BigDecimal localAmount;
    <span class="hljs-keyword">private</span> BigDecimal channelAmount;
    <span class="hljs-keyword">private</span> BigDecimal diffAmount;
    <span class="hljs-keyword">private</span> String localStatus;
    <span class="hljs-keyword">private</span> String channelStatus;
    <span class="hljs-keyword">private</span> Integer handleStatus;
    <span class="hljs-keyword">private</span> String handleRemark;
    <span class="hljs-keyword">private</span> String handler;
    <span class="hljs-keyword">private</span> LocalDateTime handleTime;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
}
</code></pre>
<h4 data-id="heading-14">4.2 文件解析器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 账单解析器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BillParser</span> {

    <span class="hljs-comment">/**
     * 获取支持的渠道类型
     */</span>
    ChannelType <span class="hljs-title function_">getChannelType</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 解析账单文件
     */</span>
    List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(InputStream inputStream, String fileName)</span> <span class="hljs-keyword">throws</span> Exception;

    <span class="hljs-comment">/**
     * 是否支持该文件
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(String fileName)</span>;
}

<span class="hljs-comment">/**
 * 支付宝账单解析器
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlipayBillParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BillParser</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ChannelType <span class="hljs-title function_">getChannelType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ChannelType.ALIPAY;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(String fileName)</span> {
        <span class="hljs-keyword">return</span> fileName != <span class="hljs-literal">null</span> &amp;&amp; fileName.contains(<span class="hljs-string">"alipay"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(InputStream inputStream, String fileName)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 支付宝账单通常是 CSV 格式，GBK 编码</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, <span class="hljs-string">"GBK"</span>))) {

            String line;
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isDataSection</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">lineNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                lineNum++;

                <span class="hljs-comment">// 跳过账单头部信息（支付宝账单前几行是汇总信息）</span>
                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"支付宝交易号"</span>)) {
                    isDataSection = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">// 跳过汇总行</span>
                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"#"</span>) || line.trim().isEmpty()) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">if</span> (!isDataSection) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> parseLine(line);
                    <span class="hljs-keyword">if</span> (bill != <span class="hljs-literal">null</span>) {
                        billList.add(bill);
                    }
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.warn(<span class="hljs-string">"解析支付宝账单第{}行失败: {}"</span>, lineNum, e.getMessage());
                }
            }
        }

        log.info(<span class="hljs-string">"支付宝账单解析完成，共{}条记录"</span>, billList.size());
        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> ChannelBillDTO <span class="hljs-title function_">parseLine</span><span class="hljs-params">(String line)</span> {
        <span class="hljs-comment">// 支付宝账单字段：支付宝交易号,商户订单号,交易类型,交易状态,金额,手续费,交易时间...</span>
        String[] fields = line.split(<span class="hljs-string">","</span>);
        <span class="hljs-keyword">if</span> (fields.length &lt; <span class="hljs-number">7</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBillDTO</span>();
        bill.setChannelTradeNo(fields[<span class="hljs-number">0</span>].trim());
        bill.setMerchantOrderNo(fields[<span class="hljs-number">1</span>].trim());
        bill.setTradeType(fields[<span class="hljs-number">2</span>].trim());
        bill.setTradeStatus(fields[<span class="hljs-number">3</span>].trim());
        bill.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(fields[<span class="hljs-number">4</span>].trim()));
        bill.setFee(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(fields[<span class="hljs-number">5</span>].trim()));

        <span class="hljs-comment">// 解析时间</span>
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        bill.setTradeTime(LocalDateTime.parse(fields[<span class="hljs-number">6</span>].trim(), formatter));

        <span class="hljs-keyword">return</span> bill;
    }
}

<span class="hljs-comment">/**
 * 微信账单解析器
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatBillParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BillParser</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ChannelType <span class="hljs-title function_">getChannelType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ChannelType.WECHAT;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(String fileName)</span> {
        <span class="hljs-keyword">return</span> fileName != <span class="hljs-literal">null</span> &amp;&amp; fileName.contains(<span class="hljs-string">"wechat"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(InputStream inputStream, String fileName)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 微信账单是 CSV 格式，UTF-8 编码</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, StandardCharsets.UTF_8))) {

            String line;
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isDataSection</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">lineNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                lineNum++;

                <span class="hljs-comment">// 微信账单以"交易时间"开头的是表头</span>
                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"交易时间"</span>)) {
                    isDataSection = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">// 跳过汇总部分</span>
                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"总交易单数"</span>) || line.trim().isEmpty()) {
                    isDataSection = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">if</span> (!isDataSection) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> parseLine(line);
                    <span class="hljs-keyword">if</span> (bill != <span class="hljs-literal">null</span>) {
                        billList.add(bill);
                    }
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.warn(<span class="hljs-string">"解析微信账单第{}行失败: {}"</span>, lineNum, e.getMessage());
                }
            }
        }

        log.info(<span class="hljs-string">"微信账单解析完成，共{}条记录"</span>, billList.size());
        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> ChannelBillDTO <span class="hljs-title function_">parseLine</span><span class="hljs-params">(String line)</span> {
        <span class="hljs-comment">// 微信账单字段：交易时间,公众账号ID,商户号,子商户号,设备号,微信订单号,商户订单号,用户标识,交易类型,交易状态,付款银行,货币种类,总金额,企业红包金额,微信退款单号,商户退款单号,退款金额,企业红包退款金额,退款类型,退款状态,商品名称,商户数据包,手续费,费率</span>
        String[] fields = line.split(<span class="hljs-string">","</span>);
        <span class="hljs-keyword">if</span> (fields.length &lt; <span class="hljs-number">15</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBillDTO</span>();

        <span class="hljs-comment">// 去除反引号（微信账单中数字字段带反引号）</span>
        bill.setChannelTradeNo(cleanField(fields[<span class="hljs-number">5</span>]));
        bill.setMerchantOrderNo(cleanField(fields[<span class="hljs-number">6</span>]));
        bill.setTradeType(cleanField(fields[<span class="hljs-number">8</span>]));
        bill.setTradeStatus(cleanField(fields[<span class="hljs-number">9</span>]));

        <span class="hljs-comment">// 金额字段需要去除 ¥ 符号</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">amountStr</span> <span class="hljs-operator">=</span> cleanField(fields[<span class="hljs-number">12</span>]).replace(<span class="hljs-string">"¥"</span>, <span class="hljs-string">""</span>);
        bill.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(amountStr));

        <span class="hljs-comment">// 手续费</span>
        <span class="hljs-keyword">if</span> (fields.length &gt; <span class="hljs-number">22</span>) {
            <span class="hljs-type">String</span> <span class="hljs-variable">feeStr</span> <span class="hljs-operator">=</span> cleanField(fields[<span class="hljs-number">22</span>]).replace(<span class="hljs-string">"¥"</span>, <span class="hljs-string">""</span>);
            bill.setFee(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(feeStr));
        }

        <span class="hljs-comment">// 解析时间</span>
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        bill.setTradeTime(LocalDateTime.parse(cleanField(fields[<span class="hljs-number">0</span>]), formatter));

        <span class="hljs-keyword">return</span> bill;
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">cleanField</span><span class="hljs-params">(String field)</span> {
        <span class="hljs-keyword">return</span> field.replace(<span class="hljs-string">"`"</span>, <span class="hljs-string">""</span>).trim();
    }
}

<span class="hljs-comment">/**
 * 银行账单解析器（Excel 格式）
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankBillParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BillParser</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ChannelType <span class="hljs-title function_">getChannelType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ChannelType.BANK;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(String fileName)</span> {
        <span class="hljs-keyword">return</span> fileName != <span class="hljs-literal">null</span> &amp;&amp;
                (fileName.endsWith(<span class="hljs-string">".xlsx"</span>) || fileName.endsWith(<span class="hljs-string">".xls"</span>));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(InputStream inputStream, String fileName)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 使用 EasyExcel 解析</span>
        EasyExcel.read(inputStream, BankBillExcelDTO.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadListener</span>&lt;BankBillExcelDTO&gt;() {

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(BankBillExcelDTO data, AnalysisContext context)</span> {
                <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> convertToChannelBill(data);
                <span class="hljs-keyword">if</span> (bill != <span class="hljs-literal">null</span>) {
                    billList.add(bill);
                }
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterAllAnalysed</span><span class="hljs-params">(AnalysisContext context)</span> {
                log.info(<span class="hljs-string">"银行账单解析完成，共{}条记录"</span>, billList.size());
            }
        }).sheet().doRead();

        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> ChannelBillDTO <span class="hljs-title function_">convertToChannelBill</span><span class="hljs-params">(BankBillExcelDTO excelDTO)</span> {
        <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBillDTO</span>();
        bill.setChannelTradeNo(excelDTO.getBankSerialNo());
        bill.setMerchantOrderNo(excelDTO.getMerchantOrderNo());
        bill.setTradeType(excelDTO.getTransType());
        bill.setTradeStatus(excelDTO.getTransStatus());
        bill.setAmount(excelDTO.getAmount());
        bill.setFee(excelDTO.getFee());
        bill.setTradeTime(excelDTO.getTransTime());
        bill.setRemark(excelDTO.getRemark());
        <span class="hljs-keyword">return</span> bill;
    }

    <span class="hljs-comment">/**
     * 银行账单 Excel DTO
     */</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankBillExcelDTO</span> {
        <span class="hljs-meta">@ExcelProperty("流水号")</span>
        <span class="hljs-keyword">private</span> String bankSerialNo;

        <span class="hljs-meta">@ExcelProperty("商户订单号")</span>
        <span class="hljs-keyword">private</span> String merchantOrderNo;

        <span class="hljs-meta">@ExcelProperty("交易类型")</span>
        <span class="hljs-keyword">private</span> String transType;

        <span class="hljs-meta">@ExcelProperty("交易状态")</span>
        <span class="hljs-keyword">private</span> String transStatus;

        <span class="hljs-meta">@ExcelProperty("交易金额")</span>
        <span class="hljs-keyword">private</span> BigDecimal amount;

        <span class="hljs-meta">@ExcelProperty("手续费")</span>
        <span class="hljs-keyword">private</span> BigDecimal fee;

        <span class="hljs-meta">@ExcelProperty("交易时间")</span>
        <span class="hljs-keyword">private</span> LocalDateTime transTime;

        <span class="hljs-meta">@ExcelProperty("备注")</span>
        <span class="hljs-keyword">private</span> String remark;
    }
}

<span class="hljs-comment">/**
 * 自定义渠道解析器工厂
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomBillParserFactory</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconChannelConfigMapper channelConfigMapper;

    <span class="hljs-comment">/**
     * 根据渠道配置动态解析账单
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(String channelCode, InputStream inputStream)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ReconChannelConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> channelConfigMapper.selectByChannelCode(channelCode);
        <span class="hljs-keyword">if</span> (config == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"渠道配置不存在: "</span> + channelCode);
        }

        <span class="hljs-comment">// 解析字段映射配置</span>
        Map&lt;String, String&gt; fieldMapping = JSON.parseObject(
                config.getFieldMapping(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, String&gt;&gt;() {});

        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 根据文件类型解析</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"CSV"</span>.equalsIgnoreCase(config.getFileType())) {
            billList = parseCsv(inputStream, config.getFileEncoding(), fieldMapping);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"EXCEL"</span>.equalsIgnoreCase(config.getFileType())) {
            billList = parseExcel(inputStream, fieldMapping);
        }

        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parseCsv</span><span class="hljs-params">(InputStream inputStream, String encoding,
                                           Map&lt;String, String&gt; fieldMapping)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, encoding))) {

            <span class="hljs-comment">// 读取表头</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">headerLine</span> <span class="hljs-operator">=</span> reader.readLine();
            String[] headers = headerLine.split(<span class="hljs-string">","</span>);

            <span class="hljs-comment">// 构建列索引映射</span>
            Map&lt;String, Integer&gt; columnIndex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; headers.length; i++) {
                columnIndex.put(headers[i].trim(), i);
            }

            String line;
            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (line.trim().isEmpty()) <span class="hljs-keyword">continue</span>;

                String[] fields = line.split(<span class="hljs-string">","</span>);
                <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBillDTO</span>();

                <span class="hljs-comment">// 根据字段映射配置填充数据</span>
                <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : fieldMapping.entrySet()) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">targetField</span> <span class="hljs-operator">=</span> entry.getKey();  <span class="hljs-comment">// ChannelBillDTO 字段名</span>
                    <span class="hljs-type">String</span> <span class="hljs-variable">sourceColumn</span> <span class="hljs-operator">=</span> entry.getValue(); <span class="hljs-comment">// 源文件列名</span>

                    <span class="hljs-type">Integer</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> columnIndex.get(sourceColumn);
                    <span class="hljs-keyword">if</span> (idx != <span class="hljs-literal">null</span> &amp;&amp; idx &lt; fields.length) {
                        setFieldValue(bill, targetField, fields[idx].trim());
                    }
                }

                billList.add(bill);
            }
        }

        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(ChannelBillDTO bill, String fieldName, String value)</span> {
        <span class="hljs-keyword">switch</span> (fieldName) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"channelTradeNo"</span>:
                bill.setChannelTradeNo(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"merchantOrderNo"</span>:
                bill.setMerchantOrderNo(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"tradeType"</span>:
                bill.setTradeType(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"tradeStatus"</span>:
                bill.setTradeStatus(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"amount"</span>:
                bill.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(value));
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"fee"</span>:
                bill.setFee(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(value));
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"tradeTime"</span>:
                bill.setTradeTime(LocalDateTime.parse(value,
                        DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)));
                <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">private</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parseExcel</span><span class="hljs-params">(InputStream inputStream,
                                             Map&lt;String, String&gt; fieldMapping)</span> {
        <span class="hljs-comment">// Excel 解析逻辑，类似 CSV</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
}
</code></pre>
<h4 data-id="heading-15">4.3 对账引擎核心</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账引擎接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ReconEngine</span> {

    <span class="hljs-comment">/**
     * 执行对账
     */</span>
    ReconResult <span class="hljs-title function_">reconcile</span><span class="hljs-params">(ChannelBillDTO channelBill, LocalPaymentRecord localRecord)</span>;

    <span class="hljs-comment">/**
     * 批量对账
     */</span>
    List&lt;ReconResult&gt; <span class="hljs-title function_">batchReconcile</span><span class="hljs-params">(List&lt;ChannelBillDTO&gt; channelBills,
                                      List&lt;LocalPaymentRecord&gt; localRecords)</span>;
}

<span class="hljs-comment">/**
 * 对账引擎实现
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultReconEngine</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ReconEngine</span> {

    <span class="hljs-comment">// 金额容差（分）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">AMOUNT_TOLERANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.01"</span>);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ReconResult <span class="hljs-title function_">reconcile</span><span class="hljs-params">(ChannelBillDTO channelBill, LocalPaymentRecord localRecord)</span> {
        <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconResult</span>();
        result.setChannelTradeNo(channelBill.getChannelTradeNo());
        result.setChannelAmount(channelBill.getAmount());
        result.setChannelStatus(channelBill.getTradeStatus());

        <span class="hljs-keyword">if</span> (localRecord != <span class="hljs-literal">null</span>) {
            result.setOrderNo(localRecord.getOrderNo());
            result.setLocalAmount(localRecord.getAmount());
            result.setLocalStatus(String.valueOf(localRecord.getPayStatus()));

            <span class="hljs-comment">// 比对金额</span>
            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">diff</span> <span class="hljs-operator">=</span> channelBill.getAmount()
                    .subtract(localRecord.getAmount()).abs();

            <span class="hljs-keyword">if</span> (diff.compareTo(AMOUNT_TOLERANCE) &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 金额不一致</span>
                result.setResultType(ReconResultType.AMOUNT_MISMATCH.getCode());
                result.setDiffAmount(diff);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isStatusMatched(channelBill.getTradeStatus(),
                    localRecord.getPayStatus())) {
                <span class="hljs-comment">// 状态不一致</span>
                result.setResultType(ReconResultType.STATUS_MISMATCH.getCode());
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 匹配成功</span>
                result.setResultType(ReconResultType.MATCHED.getCode());
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 渠道有，本地无（短款）</span>
            result.setResultType(ReconResultType.CHANNEL_MORE.getCode());
        }

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ReconResult&gt; <span class="hljs-title function_">batchReconcile</span><span class="hljs-params">(List&lt;ChannelBillDTO&gt; channelBills,
                                             List&lt;LocalPaymentRecord&gt; localRecords)</span> {
        List&lt;ReconResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 构建本地记录索引（按商户订单号）</span>
        Map&lt;String, LocalPaymentRecord&gt; localRecordMap = localRecords.stream()
                .collect(Collectors.toMap(
                        LocalPaymentRecord::getOrderNo,
                        r -&gt; r,
                        (r1, r2) -&gt; r1
                ));

        <span class="hljs-comment">// 构建渠道记录索引</span>
        Map&lt;String, ChannelBillDTO&gt; channelBillMap = channelBills.stream()
                .collect(Collectors.toMap(
                        ChannelBillDTO::getMerchantOrderNo,
                        b -&gt; b,
                        (b1, b2) -&gt; b1
                ));

        Set&lt;String&gt; matchedOrderNos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

        <span class="hljs-comment">// 遍历渠道账单进行匹配</span>
        <span class="hljs-keyword">for</span> (ChannelBillDTO channelBill : channelBills) {
            <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> channelBill.getMerchantOrderNo();
            <span class="hljs-type">LocalPaymentRecord</span> <span class="hljs-variable">localRecord</span> <span class="hljs-operator">=</span> localRecordMap.get(orderNo);

            <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> reconcile(channelBill, localRecord);
            results.add(result);

            <span class="hljs-keyword">if</span> (localRecord != <span class="hljs-literal">null</span>) {
                matchedOrderNos.add(orderNo);
            }
        }

        <span class="hljs-comment">// 检查本地多的记录（长款）</span>
        <span class="hljs-keyword">for</span> (LocalPaymentRecord localRecord : localRecords) {
            <span class="hljs-keyword">if</span> (!matchedOrderNos.contains(localRecord.getOrderNo())) {
                <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconResult</span>();
                result.setOrderNo(localRecord.getOrderNo());
                result.setLocalAmount(localRecord.getAmount());
                result.setLocalStatus(String.valueOf(localRecord.getPayStatus()));
                result.setResultType(ReconResultType.LOCAL_MORE.getCode());
                results.add(result);
            }
        }

        <span class="hljs-keyword">return</span> results;
    }

    <span class="hljs-comment">/**
     * 状态匹配判断
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStatusMatched</span><span class="hljs-params">(String channelStatus, Integer localStatus)</span> {
        <span class="hljs-comment">// 渠道状态映射到本地状态</span>
        <span class="hljs-comment">// 支付宝：TRADE_SUCCESS -&gt; 1</span>
        <span class="hljs-comment">// 微信：SUCCESS -&gt; 1</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"TRADE_SUCCESS"</span>.equals(channelStatus) || <span class="hljs-string">"SUCCESS"</span>.equals(channelStatus)) {
            <span class="hljs-keyword">return</span> localStatus == <span class="hljs-number">1</span>;  <span class="hljs-comment">// 支付成功</span>
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"TRADE_CLOSED"</span>.equals(channelStatus) || <span class="hljs-string">"CLOSED"</span>.equals(channelStatus)) {
            <span class="hljs-keyword">return</span> localStatus == <span class="hljs-number">2</span>;  <span class="hljs-comment">// 支付失败/关闭</span>
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"REFUND"</span>.equals(channelStatus)) {
            <span class="hljs-keyword">return</span> localStatus == <span class="hljs-number">3</span>;  <span class="hljs-comment">// 已退款</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h4 data-id="heading-16">4.4 对账服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账任务服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconTaskService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskMapper taskMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconResultMapper resultMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalPaymentRecordMapper localRecordMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> List&lt;BillParser&gt; billParsers;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DefaultReconEngine reconEngine;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChannelBillService channelBillService;

    <span class="hljs-comment">/**
     * 创建对账任务
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> ReconTask <span class="hljs-title function_">createTask</span><span class="hljs-params">(String channelType, LocalDate reconDate, String filePath)</span> {
        <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconTask</span>();
        task.setTaskNo(generateTaskNo());
        task.setChannelType(channelType);
        task.setReconDate(reconDate);
        task.setFilePath(filePath);
        task.setStatus(TaskStatus.PENDING.getCode());

        taskMapper.insert(task);
        <span class="hljs-keyword">return</span> task;
    }

    <span class="hljs-comment">/**
     * 执行对账任务
     */</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeTask</span><span class="hljs-params">(Long taskId)</span> {
        <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskMapper.selectById(taskId);
        <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) {
            log.error(<span class="hljs-string">"对账任务不存在: {}"</span>, taskId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 更新任务状态</span>
            task.setStatus(TaskStatus.PROCESSING.getCode());
            task.setStartTime(LocalDateTime.now());
            taskMapper.updateById(task);

            <span class="hljs-comment">// 1. 解析渠道账单</span>
            List&lt;ChannelBillDTO&gt; channelBills = parseBillFile(task);
            task.setTotalCount(channelBills.size());

            <span class="hljs-comment">// 2. 保存渠道账单</span>
            channelBillService.saveBatch(task.getId(), task.getChannelType(), channelBills);

            <span class="hljs-comment">// 3. 查询本地支付记录</span>
            List&lt;LocalPaymentRecord&gt; localRecords = queryLocalRecords(
                    task.getChannelType(), task.getReconDate());

            <span class="hljs-comment">// 4. 执行对账</span>
            List&lt;ReconResult&gt; results = reconEngine.batchReconcile(channelBills, localRecords);

            <span class="hljs-comment">// 5. 保存对账结果</span>
            saveReconResults(task.getId(), results);

            <span class="hljs-comment">// 6. 更新任务统计</span>
            updateTaskStatistics(task, results);

            task.setStatus(TaskStatus.COMPLETED.getCode());
            task.setEndTime(LocalDateTime.now());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"对账任务执行失败: {}"</span>, taskId, e);
            task.setStatus(TaskStatus.FAILED.getCode());
            task.setErrorMsg(e.getMessage());
            task.setEndTime(LocalDateTime.now());
        }

        taskMapper.updateById(task);
    }

    <span class="hljs-comment">/**
     * 解析账单文件
     */</span>
    <span class="hljs-keyword">private</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parseBillFile</span><span class="hljs-params">(ReconTask task)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 获取文件输入流</span>
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> getFileInputStream(task.getFilePath());

        <span class="hljs-comment">// 查找匹配的解析器</span>
        <span class="hljs-type">BillParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> billParsers.stream()
                .filter(p -&gt; p.getChannelType().getCode().equals(task.getChannelType()))
                .findFirst()
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"不支持的渠道类型: "</span> + task.getChannelType()));

        <span class="hljs-keyword">return</span> parser.parse(inputStream, task.getFilePath());
    }

    <span class="hljs-comment">/**
     * 查询本地支付记录
     */</span>
    <span class="hljs-keyword">private</span> List&lt;LocalPaymentRecord&gt; <span class="hljs-title function_">queryLocalRecords</span><span class="hljs-params">(String channelType, LocalDate reconDate)</span> {
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> reconDate.atStartOfDay();
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> reconDate.plusDays(<span class="hljs-number">1</span>).atStartOfDay();

        <span class="hljs-keyword">return</span> localRecordMapper.selectByChannelAndTime(channelType, startTime, endTime);
    }

    <span class="hljs-comment">/**
     * 保存对账结果
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveReconResults</span><span class="hljs-params">(Long taskId, List&lt;ReconResult&gt; results)</span> {
        <span class="hljs-comment">// 批量插入</span>
        List&lt;List&lt;ReconResult&gt;&gt; batches = Lists.partition(results, <span class="hljs-number">500</span>);
        <span class="hljs-keyword">for</span> (List&lt;ReconResult&gt; batch : batches) {
            batch.forEach(r -&gt; r.setTaskId(taskId));
            resultMapper.insertBatch(batch);
        }
    }

    <span class="hljs-comment">/**
     * 更新任务统计
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateTaskStatistics</span><span class="hljs-params">(ReconTask task, List&lt;ReconResult&gt; results)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">diffCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (ReconResult result : results) {
            <span class="hljs-keyword">if</span> (result.getResultType() == ReconResultType.MATCHED.getCode()) {
                successCount++;
            } <span class="hljs-keyword">else</span> {
                diffCount++;
            }
        }

        task.setSuccessCount(successCount);
        task.setDiffCount(diffCount);
        task.setFailCount(<span class="hljs-number">0</span>);
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateTaskNo</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"RECON"</span> + System.currentTimeMillis() +
                String.format(<span class="hljs-string">"%04d"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">10000</span>));
    }

    <span class="hljs-keyword">private</span> InputStream <span class="hljs-title function_">getFileInputStream</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 支持本地文件和 OSS 文件</span>
        <span class="hljs-keyword">if</span> (filePath.startsWith(<span class="hljs-string">"http"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(filePath).openStream();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filePath);
    }
}
</code></pre>
<h4 data-id="heading-17">4.5 定时对账任务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账定时任务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconScheduleTask</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskService taskService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BillDownloadService billDownloadService;

    <span class="hljs-comment">/**
     * 每天凌晨 1 点执行前一天的对账
     */</span>
    <span class="hljs-meta">@Scheduled(cron = "0 0 1 * * ?")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dailyReconciliation</span><span class="hljs-params">()</span> {
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">reconDate</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">1</span>);
        log.info(<span class="hljs-string">"开始执行 {} 的对账任务"</span>, reconDate);

        <span class="hljs-comment">// 支付宝对账</span>
        executeChannelRecon(ChannelType.ALIPAY, reconDate);

        <span class="hljs-comment">// 微信对账</span>
        executeChannelRecon(ChannelType.WECHAT, reconDate);

        <span class="hljs-comment">// 银行对账</span>
        executeChannelRecon(ChannelType.BANK, reconDate);

        log.info(<span class="hljs-string">"{} 的对账任务创建完成"</span>, reconDate);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeChannelRecon</span><span class="hljs-params">(ChannelType channelType, LocalDate reconDate)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 下载账单文件</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> billDownloadService.downloadBill(channelType, reconDate);

            <span class="hljs-comment">// 2. 创建对账任务</span>
            <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTask(
                    channelType.getCode(), reconDate, filePath);

            <span class="hljs-comment">// 3. 异步执行对账</span>
            taskService.executeTask(task.getId());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"{}渠道对账任务创建失败: {}"</span>, channelType.getDesc(), e.getMessage(), e);
        }
    }
}

<span class="hljs-comment">/**
 * 账单下载服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BillDownloadService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AlipayClient alipayClient;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> WxPayService wxPayService;

    <span class="hljs-comment">/**
     * 下载渠道账单
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">downloadBill</span><span class="hljs-params">(ChannelType channelType, LocalDate billDate)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">switch</span> (channelType) {
            <span class="hljs-keyword">case</span> ALIPAY:
                <span class="hljs-keyword">return</span> downloadAlipayBill(billDate);
            <span class="hljs-keyword">case</span> WECHAT:
                <span class="hljs-keyword">return</span> downloadWechatBill(billDate);
            <span class="hljs-keyword">case</span> BANK:
                <span class="hljs-keyword">return</span> downloadBankBill(billDate);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"不支持的渠道类型: "</span> + channelType);
        }
    }

    <span class="hljs-comment">/**
     * 下载支付宝账单
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">downloadAlipayBill</span><span class="hljs-params">(LocalDate billDate)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">AlipayDataDataserviceBillDownloadurlQueryRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayDataDataserviceBillDownloadurlQueryRequest</span>();

        Map&lt;String, String&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        params.put(<span class="hljs-string">"bill_type"</span>, <span class="hljs-string">"trade"</span>);
        params.put(<span class="hljs-string">"bill_date"</span>, billDate.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd"</span>)));
        request.setBizContent(JSON.toJSONString(params));

        <span class="hljs-type">AlipayDataDataserviceBillDownloadurlQueryResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span>
                alipayClient.execute(request);

        <span class="hljs-keyword">if</span> (response.isSuccess()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">downloadUrl</span> <span class="hljs-operator">=</span> response.getBillDownloadUrl();
            <span class="hljs-keyword">return</span> downloadAndSaveFile(downloadUrl, <span class="hljs-string">"alipay"</span>, billDate);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取支付宝账单下载地址失败: "</span> + response.getMsg());
        }
    }

    <span class="hljs-comment">/**
     * 下载微信账单
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">downloadWechatBill</span><span class="hljs-params">(LocalDate billDate)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">WxPayDownloadBillRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WxPayDownloadBillRequest</span>();
        request.setBillDate(billDate.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyyMMdd"</span>)));
        request.setBillType(<span class="hljs-string">"ALL"</span>);

        <span class="hljs-type">WxPayDownloadBillResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> wxPayService.downloadBill(request);

        <span class="hljs-comment">// 保存账单内容到文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"wechat_bill_%s.csv"</span>,
                billDate.format(DateTimeFormatter.BASIC_ISO_DATE));
        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/data/bills/"</span> + fileName;

        Files.write(Paths.get(filePath), result.getBillContent().getBytes(StandardCharsets.UTF_8));

        <span class="hljs-keyword">return</span> filePath;
    }

    <span class="hljs-comment">/**
     * 下载银行账单（通常是 SFTP 方式）
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">downloadBankBill</span><span class="hljs-params">(LocalDate billDate)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 银行账单通常通过 SFTP 获取</span>
        <span class="hljs-comment">// 这里简化处理</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"bank_bill_%s.xlsx"</span>,
                billDate.format(DateTimeFormatter.BASIC_ISO_DATE));
        <span class="hljs-keyword">return</span> <span class="hljs-string">"/data/bills/"</span> + fileName;
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">downloadAndSaveFile</span><span class="hljs-params">(String url, String prefix, LocalDate billDate)</span>
            <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"%s_bill_%s.csv"</span>,
                prefix, billDate.format(DateTimeFormatter.BASIC_ISO_DATE));
        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/data/bills/"</span> + fileName;

        <span class="hljs-comment">// 下载文件</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url).openStream()) {
            Files.copy(in, Paths.get(filePath), StandardCopyOption.REPLACE_EXISTING);
        }

        <span class="hljs-keyword">return</span> filePath;
    }
}
</code></pre>
<h4 data-id="heading-18">4.6 差异处理服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 差异处理服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiffHandleService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconResultMapper resultMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalPaymentRecordMapper localRecordMapper;

    <span class="hljs-comment">/**
     * 查询待处理差异
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ReconResult&gt; <span class="hljs-title function_">queryPendingDiffs</span><span class="hljs-params">(Long taskId)</span> {
        <span class="hljs-keyword">return</span> resultMapper.selectByTaskAndStatus(taskId, <span class="hljs-number">0</span>);
    }

    <span class="hljs-comment">/**
     * 处理差异：标记为已处理
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDiff</span><span class="hljs-params">(Long resultId, String handleRemark, String handler)</span> {
        <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> resultMapper.selectById(resultId);
        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"对账结果不存在"</span>);
        }

        result.setHandleStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 已处理</span>
        result.setHandleRemark(handleRemark);
        result.setHandler(handler);
        result.setHandleTime(LocalDateTime.now());

        resultMapper.updateById(result);

        <span class="hljs-comment">// 更新本地记录的对账状态</span>
        <span class="hljs-keyword">if</span> (result.getOrderNo() != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">LocalPaymentRecord</span> <span class="hljs-variable">localRecord</span> <span class="hljs-operator">=</span> localRecordMapper.selectByOrderNo(result.getOrderNo());
            <span class="hljs-keyword">if</span> (localRecord != <span class="hljs-literal">null</span>) {
                localRecord.setReconStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 已对账</span>
                localRecord.setReconTime(LocalDateTime.now());
                localRecordMapper.updateById(localRecord);
            }
        }
    }

    <span class="hljs-comment">/**
     * 忽略差异
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ignoreDiff</span><span class="hljs-params">(Long resultId, String reason, String handler)</span> {
        <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> resultMapper.selectById(resultId);
        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"对账结果不存在"</span>);
        }

        result.setHandleStatus(<span class="hljs-number">2</span>);  <span class="hljs-comment">// 忽略</span>
        result.setHandleRemark(<span class="hljs-string">"忽略原因: "</span> + reason);
        result.setHandler(handler);
        result.setHandleTime(LocalDateTime.now());

        resultMapper.updateById(result);
    }

    <span class="hljs-comment">/**
     * 批量处理短款（渠道有本地无）
     * 自动创建本地补单记录
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchHandleChannelMore</span><span class="hljs-params">(List&lt;Long&gt; resultIds, String handler)</span> {
        <span class="hljs-keyword">for</span> (Long resultId : resultIds) {
            <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> resultMapper.selectById(resultId);
            <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result.getResultType() != ReconResultType.CHANNEL_MORE.getCode()) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-comment">// 创建补单记录</span>
            <span class="hljs-type">LocalPaymentRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalPaymentRecord</span>();
            record.setOrderNo(result.getChannelTradeNo());  <span class="hljs-comment">// 使用渠道交易号作为订单号</span>
            record.setChannelTradeNo(result.getChannelTradeNo());
            record.setAmount(result.getChannelAmount());
            record.setPayStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 支付成功</span>
            record.setReconStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 已对账</span>
            record.setReconTime(LocalDateTime.now());

            localRecordMapper.insert(record);

            <span class="hljs-comment">// 更新差异处理状态</span>
            result.setHandleStatus(<span class="hljs-number">1</span>);
            result.setHandleRemark(<span class="hljs-string">"自动补单处理"</span>);
            result.setHandler(handler);
            result.setHandleTime(LocalDateTime.now());
            resultMapper.updateById(result);

            log.info(<span class="hljs-string">"短款自动补单: channelTradeNo={}"</span>, result.getChannelTradeNo());
        }
    }

    <span class="hljs-comment">/**
     * 自动处理规则
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoHandleDiffs</span><span class="hljs-params">(Long taskId)</span> {
        List&lt;ReconResult&gt; diffs = queryPendingDiffs(taskId);

        <span class="hljs-keyword">for</span> (ReconResult diff : diffs) {
            <span class="hljs-comment">// 规则1：金额差异小于1分，自动忽略</span>
            <span class="hljs-keyword">if</span> (diff.getResultType() == ReconResultType.AMOUNT_MISMATCH.getCode()) {
                <span class="hljs-keyword">if</span> (diff.getDiffAmount() != <span class="hljs-literal">null</span> &amp;&amp;
                        diff.getDiffAmount().compareTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.01"</span>)) &lt;= <span class="hljs-number">0</span>) {
                    ignoreDiff(diff.getId(), <span class="hljs-string">"金额差异小于1分，系统自动忽略"</span>, <span class="hljs-string">"SYSTEM"</span>);
                }
            }

            <span class="hljs-comment">// 规则2：时间跨天差异，自动忽略（需要额外逻辑判断）</span>
            <span class="hljs-comment">// ...</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-19">4.7 对账报告生成</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账报告服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconReportService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskMapper taskMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconResultMapper resultMapper;

    <span class="hljs-comment">/**
     * 生成对账报告
     */</span>
    <span class="hljs-keyword">public</span> ReconReport <span class="hljs-title function_">generateReport</span><span class="hljs-params">(Long taskId)</span> {
        <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskMapper.selectById(taskId);
        <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"对账任务不存在"</span>);
        }

        <span class="hljs-type">ReconReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconReport</span>();
        report.setTaskNo(task.getTaskNo());
        report.setChannelType(task.getChannelType());
        report.setReconDate(task.getReconDate());

        <span class="hljs-comment">// 统计数据</span>
        report.setTotalCount(task.getTotalCount());
        report.setSuccessCount(task.getSuccessCount());
        report.setDiffCount(task.getDiffCount());

        <span class="hljs-comment">// 计算对账率</span>
        <span class="hljs-keyword">if</span> (task.getTotalCount() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-type">double</span> <span class="hljs-variable">successRate</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) task.getSuccessCount() / task.getTotalCount() * <span class="hljs-number">100</span>;
            report.setSuccessRate(String.format(<span class="hljs-string">"%.2f%%"</span>, successRate));
        }

        <span class="hljs-comment">// 差异分类统计</span>
        Map&lt;Integer, Long&gt; diffTypeCount = resultMapper.countByResultType(taskId);
        report.setLocalMoreCount(diffTypeCount.getOrDefault(ReconResultType.LOCAL_MORE.getCode(), <span class="hljs-number">0L</span>));
        report.setChannelMoreCount(diffTypeCount.getOrDefault(ReconResultType.CHANNEL_MORE.getCode(), <span class="hljs-number">0L</span>));
        report.setAmountMismatchCount(diffTypeCount.getOrDefault(ReconResultType.AMOUNT_MISMATCH.getCode(), <span class="hljs-number">0L</span>));
        report.setStatusMismatchCount(diffTypeCount.getOrDefault(ReconResultType.STATUS_MISMATCH.getCode(), <span class="hljs-number">0L</span>));

        <span class="hljs-comment">// 差异金额统计</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">totalDiffAmount</span> <span class="hljs-operator">=</span> resultMapper.sumDiffAmount(taskId);
        report.setTotalDiffAmount(totalDiffAmount);

        <span class="hljs-comment">// 生成时间</span>
        report.setGenerateTime(LocalDateTime.now());

        <span class="hljs-keyword">return</span> report;
    }

    <span class="hljs-comment">/**
     * 导出对账报告 Excel
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportReportExcel</span><span class="hljs-params">(Long taskId, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ReconReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> generateReport(taskId);
        List&lt;ReconResult&gt; diffs = resultMapper.selectDiffsByTaskId(taskId);

        <span class="hljs-comment">// 使用 EasyExcel 导出</span>
        <span class="hljs-type">ExcelWriter</span> <span class="hljs-variable">excelWriter</span> <span class="hljs-operator">=</span> EasyExcel.write(outputStream).build();

        <span class="hljs-comment">// Sheet1: 报告摘要</span>
        <span class="hljs-type">WriteSheet</span> <span class="hljs-variable">summarySheet</span> <span class="hljs-operator">=</span> EasyExcel.writerSheet(<span class="hljs-number">0</span>, <span class="hljs-string">"对账摘要"</span>)
                .head(ReportSummary.class).build();
        excelWriter.write(Collections.singletonList(convertToSummary(report)), summarySheet);

        <span class="hljs-comment">// Sheet2: 差异明细</span>
        <span class="hljs-type">WriteSheet</span> <span class="hljs-variable">diffSheet</span> <span class="hljs-operator">=</span> EasyExcel.writerSheet(<span class="hljs-number">1</span>, <span class="hljs-string">"差异明细"</span>)
                .head(DiffDetail.class).build();
        excelWriter.write(convertToDiffDetails(diffs), diffSheet);

        excelWriter.finish();
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconReport</span> {
        <span class="hljs-keyword">private</span> String taskNo;
        <span class="hljs-keyword">private</span> String channelType;
        <span class="hljs-keyword">private</span> LocalDate reconDate;
        <span class="hljs-keyword">private</span> Integer totalCount;
        <span class="hljs-keyword">private</span> Integer successCount;
        <span class="hljs-keyword">private</span> Integer diffCount;
        <span class="hljs-keyword">private</span> String successRate;
        <span class="hljs-keyword">private</span> Long localMoreCount;
        <span class="hljs-keyword">private</span> Long channelMoreCount;
        <span class="hljs-keyword">private</span> Long amountMismatchCount;
        <span class="hljs-keyword">private</span> Long statusMismatchCount;
        <span class="hljs-keyword">private</span> BigDecimal totalDiffAmount;
        <span class="hljs-keyword">private</span> LocalDateTime generateTime;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportSummary</span> {
        <span class="hljs-meta">@ExcelProperty("任务编号")</span>
        <span class="hljs-keyword">private</span> String taskNo;

        <span class="hljs-meta">@ExcelProperty("渠道类型")</span>
        <span class="hljs-keyword">private</span> String channelType;

        <span class="hljs-meta">@ExcelProperty("对账日期")</span>
        <span class="hljs-keyword">private</span> String reconDate;

        <span class="hljs-meta">@ExcelProperty("总记录数")</span>
        <span class="hljs-keyword">private</span> Integer totalCount;

        <span class="hljs-meta">@ExcelProperty("成功数")</span>
        <span class="hljs-keyword">private</span> Integer successCount;

        <span class="hljs-meta">@ExcelProperty("差异数")</span>
        <span class="hljs-keyword">private</span> Integer diffCount;

        <span class="hljs-meta">@ExcelProperty("对账成功率")</span>
        <span class="hljs-keyword">private</span> String successRate;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiffDetail</span> {
        <span class="hljs-meta">@ExcelProperty("商户订单号")</span>
        <span class="hljs-keyword">private</span> String orderNo;

        <span class="hljs-meta">@ExcelProperty("渠道交易号")</span>
        <span class="hljs-keyword">private</span> String channelTradeNo;

        <span class="hljs-meta">@ExcelProperty("差异类型")</span>
        <span class="hljs-keyword">private</span> String resultType;

        <span class="hljs-meta">@ExcelProperty("本地金额")</span>
        <span class="hljs-keyword">private</span> BigDecimal localAmount;

        <span class="hljs-meta">@ExcelProperty("渠道金额")</span>
        <span class="hljs-keyword">private</span> BigDecimal channelAmount;

        <span class="hljs-meta">@ExcelProperty("差异金额")</span>
        <span class="hljs-keyword">private</span> BigDecimal diffAmount;

        <span class="hljs-meta">@ExcelProperty("处理状态")</span>
        <span class="hljs-keyword">private</span> String handleStatus;
    }

    <span class="hljs-keyword">private</span> ReportSummary <span class="hljs-title function_">convertToSummary</span><span class="hljs-params">(ReconReport report)</span> {
        <span class="hljs-type">ReportSummary</span> <span class="hljs-variable">summary</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReportSummary</span>();
        summary.setTaskNo(report.getTaskNo());
        summary.setChannelType(report.getChannelType());
        summary.setReconDate(report.getReconDate().toString());
        summary.setTotalCount(report.getTotalCount());
        summary.setSuccessCount(report.getSuccessCount());
        summary.setDiffCount(report.getDiffCount());
        summary.setSuccessRate(report.getSuccessRate());
        <span class="hljs-keyword">return</span> summary;
    }

    <span class="hljs-keyword">private</span> List&lt;DiffDetail&gt; <span class="hljs-title function_">convertToDiffDetails</span><span class="hljs-params">(List&lt;ReconResult&gt; diffs)</span> {
        <span class="hljs-keyword">return</span> diffs.stream().map(d -&gt; {
            <span class="hljs-type">DiffDetail</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiffDetail</span>();
            detail.setOrderNo(d.getOrderNo());
            detail.setChannelTradeNo(d.getChannelTradeNo());
            detail.setResultType(ReconResultType.values()[d.getResultType() - <span class="hljs-number">1</span>].getDesc());
            detail.setLocalAmount(d.getLocalAmount());
            detail.setChannelAmount(d.getChannelAmount());
            detail.setDiffAmount(d.getDiffAmount());
            detail.setHandleStatus(d.getHandleStatus() == <span class="hljs-number">0</span> ? <span class="hljs-string">"待处理"</span> :
                    d.getHandleStatus() == <span class="hljs-number">1</span> ? <span class="hljs-string">"已处理"</span> : <span class="hljs-string">"已忽略"</span>);
            <span class="hljs-keyword">return</span> detail;
        }).collect(Collectors.toList());
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-20">五、自定义渠道导入</h3>
<h4 data-id="heading-21">5.1 自定义渠道配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 渠道配置实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("recon_channel_config")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconChannelConfig</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String channelCode;
    <span class="hljs-keyword">private</span> String channelName;
    <span class="hljs-keyword">private</span> String fileType;
    <span class="hljs-keyword">private</span> String fileEncoding;
    <span class="hljs-keyword">private</span> String fieldMapping;  <span class="hljs-comment">// JSON 格式</span>
    <span class="hljs-keyword">private</span> String parserClass;
    <span class="hljs-keyword">private</span> Integer status;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-comment">/**
 * 渠道配置服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelConfigService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconChannelConfigMapper configMapper;

    <span class="hljs-comment">/**
     * 创建自定义渠道配置
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createChannelConfig</span><span class="hljs-params">(ChannelConfigDTO dto)</span> {
        <span class="hljs-comment">// 验证字段映射</span>
        validateFieldMapping(dto.getFieldMapping());

        <span class="hljs-type">ReconChannelConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconChannelConfig</span>();
        config.setChannelCode(dto.getChannelCode());
        config.setChannelName(dto.getChannelName());
        config.setFileType(dto.getFileType());
        config.setFileEncoding(dto.getFileEncoding());
        config.setFieldMapping(JSON.toJSONString(dto.getFieldMapping()));
        config.setStatus(<span class="hljs-number">1</span>);

        configMapper.insert(config);
    }

    <span class="hljs-comment">/**
     * 验证字段映射配置
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateFieldMapping</span><span class="hljs-params">(Map&lt;String, String&gt; fieldMapping)</span> {
        <span class="hljs-comment">// 必须包含的字段</span>
        List&lt;String&gt; requiredFields = Arrays.asList(
                <span class="hljs-string">"channelTradeNo"</span>, <span class="hljs-string">"merchantOrderNo"</span>, <span class="hljs-string">"amount"</span>, <span class="hljs-string">"tradeStatus"</span>
        );

        <span class="hljs-keyword">for</span> (String field : requiredFields) {
            <span class="hljs-keyword">if</span> (!fieldMapping.containsKey(field)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"缺少必要字段映射: "</span> + field);
            }
        }
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelConfigDTO</span> {
        <span class="hljs-keyword">private</span> String channelCode;
        <span class="hljs-keyword">private</span> String channelName;
        <span class="hljs-keyword">private</span> String fileType;  <span class="hljs-comment">// CSV / EXCEL</span>
        <span class="hljs-keyword">private</span> String fileEncoding;
        <span class="hljs-keyword">private</span> Map&lt;String, String&gt; fieldMapping;
    }
}
</code></pre>
<h4 data-id="heading-22">5.2 文件上传与导入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 文件上传控制器
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/recon")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskService taskService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CustomBillParserFactory parserFactory;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChannelBillService channelBillService;

    <span class="hljs-comment">/**
     * 上传自定义渠道账单
     */</span>
    <span class="hljs-meta">@PostMapping("/upload/custom")</span>
    <span class="hljs-keyword">public</span> Result&lt;?&gt; uploadCustomBill(
            <span class="hljs-meta">@RequestParam("file")</span> MultipartFile file,
            <span class="hljs-meta">@RequestParam("channelCode")</span> String channelCode,
            <span class="hljs-meta">@RequestParam("reconDate")</span> <span class="hljs-meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> LocalDate reconDate) {

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 保存文件</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> saveUploadFile(file);

            <span class="hljs-comment">// 2. 创建对账任务</span>
            <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTask(<span class="hljs-string">"CUSTOM"</span>, reconDate, filePath);

            <span class="hljs-comment">// 3. 解析账单</span>
            List&lt;ChannelBillDTO&gt; bills = parserFactory.parse(channelCode, file.getInputStream());

            <span class="hljs-comment">// 4. 保存账单数据</span>
            channelBillService.saveCustomBills(task.getId(), channelCode, bills);

            <span class="hljs-comment">// 5. 异步执行对账</span>
            taskService.executeTask(task.getId());

            <span class="hljs-keyword">return</span> Result.success(task.getTaskNo());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"上传自定义渠道账单失败"</span>, e);
            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"上传失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 上传支付宝/微信账单
     */</span>
    <span class="hljs-meta">@PostMapping("/upload/{channelType}")</span>
    <span class="hljs-keyword">public</span> Result&lt;?&gt; uploadBill(
            <span class="hljs-meta">@PathVariable</span> String channelType,
            <span class="hljs-meta">@RequestParam("file")</span> MultipartFile file,
            <span class="hljs-meta">@RequestParam("reconDate")</span> <span class="hljs-meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> LocalDate reconDate) {

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 保存文件</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> saveUploadFile(file);

            <span class="hljs-comment">// 创建并执行对账任务</span>
            <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTask(channelType.toUpperCase(), reconDate, filePath);
            taskService.executeTask(task.getId());

            <span class="hljs-keyword">return</span> Result.success(task.getTaskNo());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"上传账单失败"</span>, e);
            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"上传失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 查询对账任务状态
     */</span>
    <span class="hljs-meta">@GetMapping("/task/{taskNo}")</span>
    <span class="hljs-keyword">public</span> Result&lt;ReconTask&gt; <span class="hljs-title function_">getTaskStatus</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String taskNo)</span> {
        <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.getByTaskNo(taskNo);
        <span class="hljs-keyword">return</span> Result.success(task);
    }

    <span class="hljs-comment">/**
     * 查询对账差异列表
     */</span>
    <span class="hljs-meta">@GetMapping("/diff/list")</span>
    <span class="hljs-keyword">public</span> Result&lt;PageInfo&lt;ReconResult&gt;&gt; <span class="hljs-title function_">getDiffList</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam</span> Long taskId,
            <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> <span class="hljs-type">int</span> pageNum,
            <span class="hljs-meta">@RequestParam(defaultValue = "20")</span> <span class="hljs-type">int</span> pageSize)</span> {

        PageHelper.startPage(pageNum, pageSize);
        List&lt;ReconResult&gt; diffs = taskService.getDiffList(taskId);

        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PageInfo</span>&lt;&gt;(diffs));
    }

    <span class="hljs-comment">/**
     * 导出对账报告
     */</span>
    <span class="hljs-meta">@GetMapping("/report/export")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportReport</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Long taskId, HttpServletResponse response)</span>
            <span class="hljs-keyword">throws</span> Exception {

        response.setContentType(<span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>);
        response.setHeader(<span class="hljs-string">"Content-Disposition"</span>,
                <span class="hljs-string">"attachment;filename=recon_report_"</span> + taskId + <span class="hljs-string">".xlsx"</span>);

        taskService.exportReport(taskId, response.getOutputStream());
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">saveUploadFile</span><span class="hljs-params">(MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> System.currentTimeMillis() + <span class="hljs-string">"_"</span> + originalFilename;
        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/data/bills/upload/"</span> + fileName;

        <span class="hljs-type">File</span> <span class="hljs-variable">destFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);
        <span class="hljs-keyword">if</span> (!destFile.getParentFile().exists()) {
            destFile.getParentFile().mkdirs();
        }

        file.transferTo(destFile);
        <span class="hljs-keyword">return</span> filePath;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-23">六、监控告警</h3>
<h4 data-id="heading-24">6.1 对账监控指标</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账监控服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconMonitorService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskMapper taskMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconResultMapper resultMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AlertService alertService;

    <span class="hljs-comment">/**
     * 监控对账任务执行情况
     */</span>
    <span class="hljs-meta">@Scheduled(cron = "0 0/30 * * * ?")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorTaskExecution</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 检查超时任务（处理中超过1小时）</span>
        List&lt;ReconTask&gt; timeoutTasks = taskMapper.selectTimeoutTasks(
                TaskStatus.PROCESSING.getCode(), <span class="hljs-number">60</span>);

        <span class="hljs-keyword">for</span> (ReconTask task : timeoutTasks) {
            log.warn(<span class="hljs-string">"对账任务执行超时: taskNo={}"</span>, task.getTaskNo());
            alertService.sendAlert(AlertLevel.WARNING,
                    <span class="hljs-string">"对账任务执行超时"</span>, <span class="hljs-string">"任务编号: "</span> + task.getTaskNo());
        }

        <span class="hljs-comment">// 检查失败任务</span>
        List&lt;ReconTask&gt; failedTasks = taskMapper.selectTodayFailedTasks();
        <span class="hljs-keyword">if</span> (!failedTasks.isEmpty()) {
            log.error(<span class="hljs-string">"今日存在失败的对账任务: {}"</span>, failedTasks.size());
            alertService.sendAlert(AlertLevel.ERROR,
                    <span class="hljs-string">"对账任务执行失败"</span>, <span class="hljs-string">"失败任务数: "</span> + failedTasks.size());
        }
    }

    <span class="hljs-comment">/**
     * 监控差异率
     */</span>
    <span class="hljs-meta">@Scheduled(cron = "0 0 9 * * ?")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorDiffRate</span><span class="hljs-params">()</span> {
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">yesterday</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">1</span>);

        List&lt;ReconTask&gt; tasks = taskMapper.selectByReconDate(yesterday);

        <span class="hljs-keyword">for</span> (ReconTask task : tasks) {
            <span class="hljs-keyword">if</span> (task.getTotalCount() == <span class="hljs-literal">null</span> || task.getTotalCount() == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-comment">// 计算差异率</span>
            <span class="hljs-type">double</span> <span class="hljs-variable">diffRate</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) task.getDiffCount() / task.getTotalCount() * <span class="hljs-number">100</span>;

            <span class="hljs-comment">// 差异率超过阈值告警</span>
            <span class="hljs-keyword">if</span> (diffRate &gt; <span class="hljs-number">1.0</span>) {  <span class="hljs-comment">// 差异率超过1%</span>
                log.warn(<span class="hljs-string">"对账差异率异常: channel={}, date={}, diffRate={}%"</span>,
                        task.getChannelType(), task.getReconDate(), diffRate);

                alertService.sendAlert(AlertLevel.WARNING,
                        <span class="hljs-string">"对账差异率异常"</span>,
                        String.format(<span class="hljs-string">"渠道: %s, 日期: %s, 差异率: %.2f%%"</span>,
                                task.getChannelType(), task.getReconDate(), diffRate));
            }
        }
    }

    <span class="hljs-comment">/**
     * 获取对账看板数据
     */</span>
    <span class="hljs-keyword">public</span> DashboardData <span class="hljs-title function_">getDashboardData</span><span class="hljs-params">(LocalDate startDate, LocalDate endDate)</span> {
        <span class="hljs-type">DashboardData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardData</span>();

        <span class="hljs-comment">// 任务统计</span>
        data.setTotalTasks(taskMapper.countByDateRange(startDate, endDate));
        data.setSuccessTasks(taskMapper.countByStatusAndDateRange(
                TaskStatus.COMPLETED.getCode(), startDate, endDate));
        data.setFailedTasks(taskMapper.countByStatusAndDateRange(
                TaskStatus.FAILED.getCode(), startDate, endDate));

        <span class="hljs-comment">// 差异统计</span>
        data.setTotalDiffs(resultMapper.countDiffsByDateRange(startDate, endDate));
        data.setHandledDiffs(resultMapper.countHandledDiffsByDateRange(startDate, endDate));
        data.setPendingDiffs(data.getTotalDiffs() - data.getHandledDiffs());

        <span class="hljs-comment">// 差异金额</span>
        data.setTotalDiffAmount(resultMapper.sumDiffAmountByDateRange(startDate, endDate));

        <span class="hljs-comment">// 渠道统计</span>
        data.setChannelStats(taskMapper.groupByChannel(startDate, endDate));

        <span class="hljs-comment">// 趋势数据</span>
        data.setTrendData(taskMapper.getDailyTrend(startDate, endDate));

        <span class="hljs-keyword">return</span> data;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardData</span> {
        <span class="hljs-keyword">private</span> Long totalTasks;
        <span class="hljs-keyword">private</span> Long successTasks;
        <span class="hljs-keyword">private</span> Long failedTasks;
        <span class="hljs-keyword">private</span> Long totalDiffs;
        <span class="hljs-keyword">private</span> Long handledDiffs;
        <span class="hljs-keyword">private</span> Long pendingDiffs;
        <span class="hljs-keyword">private</span> BigDecimal totalDiffAmount;
        <span class="hljs-keyword">private</span> List&lt;ChannelStat&gt; channelStats;
        <span class="hljs-keyword">private</span> List&lt;TrendData&gt; trendData;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelStat</span> {
        <span class="hljs-keyword">private</span> String channelType;
        <span class="hljs-keyword">private</span> Long taskCount;
        <span class="hljs-keyword">private</span> Long diffCount;
        <span class="hljs-keyword">private</span> Double diffRate;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrendData</span> {
        <span class="hljs-keyword">private</span> LocalDate date;
        <span class="hljs-keyword">private</span> Long totalCount;
        <span class="hljs-keyword">private</span> Long successCount;
        <span class="hljs-keyword">private</span> Long diffCount;
    }
}
</code></pre>
<h4 data-id="heading-25">6.2 告警服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 告警级别
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">AlertLevel</span> {
    INFO, WARNING, ERROR, CRITICAL
}

<span class="hljs-comment">/**
 * 告警服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertService</span> {

    <span class="hljs-meta">@Value("${alert.dingtalk.webhook}")</span>
    <span class="hljs-keyword">private</span> String dingTalkWebhook;

    <span class="hljs-meta">@Value("${alert.email.to}")</span>
    <span class="hljs-keyword">private</span> String emailTo;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JavaMailSender mailSender;

    <span class="hljs-comment">/**
     * 发送告警
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendAlert</span><span class="hljs-params">(AlertLevel level, String title, String content)</span> {
        log.info(<span class="hljs-string">"发送告警: level={}, title={}"</span>, level, title);

        <span class="hljs-comment">// 根据告警级别选择通知方式</span>
        <span class="hljs-keyword">switch</span> (level) {
            <span class="hljs-keyword">case</span> INFO:
                <span class="hljs-comment">// 仅记录日志</span>
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> WARNING:
                sendDingTalkAlert(title, content);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> ERROR:
            <span class="hljs-keyword">case</span> CRITICAL:
                sendDingTalkAlert(title, content);
                sendEmailAlert(title, content);
                <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-comment">/**
     * 发送钉钉告警
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendDingTalkAlert</span><span class="hljs-params">(String title, String content)</span> {
        <span class="hljs-keyword">try</span> {
            Map&lt;String, Object&gt; message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            message.put(<span class="hljs-string">"msgtype"</span>, <span class="hljs-string">"markdown"</span>);

            Map&lt;String, String&gt; markdown = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            markdown.put(<span class="hljs-string">"title"</span>, title);
            markdown.put(<span class="hljs-string">"text"</span>, String.format(<span class="hljs-string">"### %s\n\n%s\n\n&gt; 时间: %s"</span>,
                    title, content, LocalDateTime.now().format(
                            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))));

            message.put(<span class="hljs-string">"markdown"</span>, markdown);

            restTemplate.postForObject(dingTalkWebhook, message, String.class);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"发送钉钉告警失败"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 发送邮件告警
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendEmailAlert</span><span class="hljs-params">(String title, String content)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SimpleMailMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMailMessage</span>();
            message.setTo(emailTo.split(<span class="hljs-string">","</span>));
            message.setSubject(<span class="hljs-string">"[对账系统告警] "</span> + title);
            message.setText(content + <span class="hljs-string">"\n\n时间: "</span> + LocalDateTime.now());

            mailSender.send(message);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"发送邮件告警失败"</span>, e);
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-26">七、系统优化</h3>
<h4 data-id="heading-27">7.1 大文件处理优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 分片解析大文件
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LargeFileBillParser</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChannelBillService channelBillService;

    <span class="hljs-comment">/**
     * 流式解析大文件
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseAndSave</span><span class="hljs-params">(Long taskId, String channelType,
                              InputStream inputStream)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, StandardCharsets.UTF_8))) {

            String line;
            List&lt;ChannelBillDTO&gt; batch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(BATCH_SIZE);
            <span class="hljs-type">int</span> <span class="hljs-variable">totalCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

            <span class="hljs-comment">// 跳过表头</span>
            reader.readLine();

            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (line.trim().isEmpty()) <span class="hljs-keyword">continue</span>;

                <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> parseLine(line);
                <span class="hljs-keyword">if</span> (bill != <span class="hljs-literal">null</span>) {
                    batch.add(bill);
                    totalCount++;
                }

                <span class="hljs-comment">// 批量保存</span>
                <span class="hljs-keyword">if</span> (batch.size() &gt;= BATCH_SIZE) {
                    channelBillService.saveBatch(taskId, channelType, batch);
                    log.info(<span class="hljs-string">"已处理 {} 条记录"</span>, totalCount);
                    batch.clear();
                }
            }

            <span class="hljs-comment">// 保存剩余数据</span>
            <span class="hljs-keyword">if</span> (!batch.isEmpty()) {
                channelBillService.saveBatch(taskId, channelType, batch);
            }

            log.info(<span class="hljs-string">"文件解析完成，共 {} 条记录"</span>, totalCount);
        }
    }

    <span class="hljs-keyword">private</span> ChannelBillDTO <span class="hljs-title function_">parseLine</span><span class="hljs-params">(String line)</span> {
        <span class="hljs-comment">// 解析逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h4 data-id="heading-28">7.2 并行对账优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 并行对账引擎
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelReconEngine</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DefaultReconEngine reconEngine;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(
            Runtime.getRuntime().availableProcessors());

    <span class="hljs-comment">/**
     * 并行批量对账
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ReconResult&gt; <span class="hljs-title function_">parallelReconcile</span><span class="hljs-params">(List&lt;ChannelBillDTO&gt; channelBills,
                                                 List&lt;LocalPaymentRecord&gt; localRecords)</span> {

        <span class="hljs-comment">// 构建本地记录索引</span>
        Map&lt;String, LocalPaymentRecord&gt; localRecordMap = localRecords.stream()
                .collect(Collectors.toMap(
                        LocalPaymentRecord::getOrderNo,
                        r -&gt; r,
                        (r1, r2) -&gt; r1
                ));

        <span class="hljs-comment">// 分片并行处理</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">partitionSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;
        List&lt;List&lt;ChannelBillDTO&gt;&gt; partitions = Lists.partition(channelBills, partitionSize);

        List&lt;CompletableFuture&lt;List&lt;ReconResult&gt;&gt;&gt; futures = partitions.stream()
                .map(partition -&gt; CompletableFuture.supplyAsync(() -&gt;
                        processPartition(partition, localRecordMap), executor))
                .collect(Collectors.toList());

        <span class="hljs-comment">// 合并结果</span>
        <span class="hljs-keyword">return</span> futures.stream()
                .map(CompletableFuture::join)
                .flatMap(List::stream)
                .collect(Collectors.toList());
    }

    <span class="hljs-keyword">private</span> List&lt;ReconResult&gt; <span class="hljs-title function_">processPartition</span><span class="hljs-params">(List&lt;ChannelBillDTO&gt; partition,
                                                 Map&lt;String, LocalPaymentRecord&gt; localRecordMap)</span> {
        List&lt;ReconResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">for</span> (ChannelBillDTO channelBill : partition) {
            <span class="hljs-type">LocalPaymentRecord</span> <span class="hljs-variable">localRecord</span> <span class="hljs-operator">=</span> localRecordMap.get(channelBill.getMerchantOrderNo());
            <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> reconEngine.reconcile(channelBill, localRecord);
            results.add(result);
        }

        <span class="hljs-keyword">return</span> results;
    }
}
</code></pre>
<h4 data-id="heading-29">7.3 缓存优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账缓存服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconCacheService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TASK_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"recon:task:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RESULT_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"recon:result:"</span>;

    <span class="hljs-comment">/**
     * 缓存任务信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheTask</span><span class="hljs-params">(ReconTask task)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> TASK_KEY_PREFIX + task.getTaskNo();
        redisTemplate.opsForValue().set(key, task, Duration.ofHours(<span class="hljs-number">24</span>));
    }

    <span class="hljs-comment">/**
     * 获取缓存的任务
     */</span>
    <span class="hljs-keyword">public</span> ReconTask <span class="hljs-title function_">getTaskFromCache</span><span class="hljs-params">(String taskNo)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> TASK_KEY_PREFIX + taskNo;
        <span class="hljs-keyword">return</span> (ReconTask) redisTemplate.opsForValue().get(key);
    }

    <span class="hljs-comment">/**
     * 缓存对账进度
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProgress</span><span class="hljs-params">(String taskNo, <span class="hljs-type">int</span> processedCount, <span class="hljs-type">int</span> totalCount)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> TASK_KEY_PREFIX + taskNo + <span class="hljs-string">":progress"</span>;
        Map&lt;String, Integer&gt; progress = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        progress.put(<span class="hljs-string">"processed"</span>, processedCount);
        progress.put(<span class="hljs-string">"total"</span>, totalCount);
        redisTemplate.opsForValue().set(key, progress, Duration.ofHours(<span class="hljs-number">2</span>));
    }

    <span class="hljs-comment">/**
     * 获取对账进度
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Integer&gt; <span class="hljs-title function_">getProgress</span><span class="hljs-params">(String taskNo)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> TASK_KEY_PREFIX + taskNo + <span class="hljs-string">":progress"</span>;
        <span class="hljs-keyword">return</span> (Map&lt;String, Integer&gt;) redisTemplate.opsForValue().get(key);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-30">八、最佳实践与总结</h3>
<h4 data-id="heading-31">8.1 对账系统设计要点</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+------------------------------------------------------------------+</span>
|                    对账系统设计要点                                |
<span class="hljs-addition">+------------------------------------------------------------------+</span>
|                                                                   |
|   1. 可扩展性                                                      |
|   - 支持多渠道接入                                                 |
|   - 解析器插件化                                                  |
|   - 字段映射可配置                                                 |
|                                                                   |
|   2. 可靠性                                                        |
|   - 任务失败重试                                                  |
|   - 断点续传                                                      |
|   - 数据校验                                                      |
|                                                                   |
|   3. 性能                                                         |
|   - 大文件分片处理                                                 |
|   - 批量数据库操作                                                 |
|   - 并行对账                                                      |
|                                                                   |
|   4. 可观测性                                                      |
|   - 任务状态监控                                                  |
|   - 差异率告警                                                    |
|   - 对账报告                                                      |
|                                                                   |
<span class="hljs-addition">+------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-32">8.2 常见问题处理</h4>



































<table><thead><tr><th>问题类型</th><th>原因分析</th><th>解决方案</th></tr></thead><tbody><tr><td>时间差异</td><td>跨天交易、时区问题</td><td>扩大时间范围查询，统一时区</td></tr><tr><td>金额差异</td><td>手续费计算方式不同</td><td>明确金额口径，分开比对</td></tr><tr><td>订单号不匹配</td><td>格式不一致、前缀差异</td><td>标准化订单号格式</td></tr><tr><td>重复对账</td><td>同一笔交易多次出现</td><td>去重处理，幂等设计</td></tr><tr><td>账单延迟</td><td>渠道账单生成延迟</td><td>延后对账时间，增加容错</td></tr></tbody></table>
<h4 data-id="heading-33">8.3 运维建议</h4>
<ol>
<li><strong>对账时间选择</strong>：建议凌晨执行，避免影响业务</li>
<li><strong>账单保留策略</strong>：至少保留 3 个月，便于追溯</li>
<li><strong>差异处理 SLA</strong>：制定差异处理时效要求</li>
<li><strong>定期巡检</strong>：每周检查对账任务执行情况</li>
<li><strong>容灾备份</strong>：对账数据定期备份</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[java除了AtomicInteger，还有哪些常用的原子类？]]></title>    <link>https://juejin.cn/post/7577722399375933482</link>    <guid>https://juejin.cn/post/7577722399375933482</guid>    <pubDate>2025-11-30T00:19:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399375933482" data-draft-id="7577715145121300534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="java除了AtomicInteger，还有哪些常用的原子类？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T00:19:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户34584828505"/> <meta itemprop="url" content="https://juejin.cn/user/3710177917545754"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            java除了AtomicInteger，还有哪些常用的原子类？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3710177917545754/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户34584828505
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:19:37.000Z" title="Sun Nov 30 2025 00:19:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <code>java.util.concurrent.atomic</code> 包中，除了最常用的 <code>AtomicInteger</code>，还有一系列针对不同场景设计的原子类，涵盖 <strong>基本类型、引用类型、字段更新、复合操作</strong> 等，核心均基于 <code>CAS + volatile</code> 实现无锁原子性。以下是 <strong>常用原子类分类详解</strong>，附功能、场景和示例代码：</p>
<h3 data-id="heading-0">一、基本类型原子类（替代基本类型的原子操作）</h3>
<p>与 <code>AtomicInteger</code> 原理一致，针对 <code>long</code>、<code>boolean</code> 等基本类型，提供原子增减、赋值等操作，避免非原子操作（如 <code>long++</code>）的并发问题。</p>





























<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>关键方法</th></tr></thead><tbody><tr><td><code>AtomicLong</code></td><td>长整型的原子增减、累加、赋值</td><td>大数值计数器（如接口调用量、流量统计）</td><td><code>incrementAndGet()</code>、<code>addAndGet(long delta)</code>、<code>set(long)</code></td></tr><tr><td><code>AtomicBoolean</code></td><td>布尔值的原子切换（true/false）</td><td>状态标记（如 “是否初始化完成”“是否停止”）</td><td><code>compareAndSet(boolean expect, boolean update)</code>、<code>set(boolean)</code></td></tr><tr><td><code>AtomicByte</code>/<code>AtomicShort</code>/<code>AtomicChar</code></td><td>字节、短整型、字符的原子操作</td><td>小范围数值原子更新（如状态码、字符标识）</td><td><code>incrementAndGet()</code>、<code>getAndSet(byte newValue)</code></td></tr></tbody></table>
<h4 data-id="heading-1">示例：<code>AtomicLong</code> 统计接口调用量</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;

<span class="hljs-comment">// 接口调用量统计（高并发下原子计数）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">callCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-comment">// 原子自增：每次调用接口时执行</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">incrementCallCount</span><span class="hljs-params">()</span> {
        callCount.incrementAndGet(); <span class="hljs-comment">// 等价于 callCount++（原子操作）</span>
    }

    <span class="hljs-comment">// 原子累加：批量统计时使用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCallCount</span><span class="hljs-params">(<span class="hljs-type">long</span> batch)</span> {
        callCount.addAndGet(batch); <span class="hljs-comment">// 等价于 callCount += batch（原子操作）</span>
    }

    <span class="hljs-comment">// 获取当前调用量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCallCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> callCount.get();
    }
}
</code></pre>
<h4 data-id="heading-2">注意事项：</h4>
<ul>
<li><code>AtomicBoolean</code> 无 <code>incrementAndGet()</code> 方法，需通过 <code>compareAndSet</code> 实现状态切换（如 <code>while (!atomicBoolean.compareAndSet(false, true)) {}</code>）。</li>
<li>基本类型原子类均不支持 <code>null</code> 值，初始值默认是 0（数值类型）、<code>false</code>（<code>AtomicBoolean</code>）。</li>
</ul>
<h3 data-id="heading-3">二、引用类型原子类（原子更新对象引用）</h3>
<p>针对 <strong>对象引用</strong> 的原子操作，解决 “原子替换对象”“避免引用修改冲突” 等问题，支持泛型，灵活适配各类对象。</p>





























<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>核心解决问题</th></tr></thead><tbody><tr><td><code>AtomicReference&lt;V&gt;</code></td><td>引用类型的原子赋值、比较替换</td><td>原子更新对象实例（如单例对象、配置对象）</td><td>避免多线程同时修改引用导致的对象不一致</td></tr><tr><td><code>AtomicStampedReference&lt;V&gt;</code></td><td>带版本号的引用原子类（版本戳 + 引用）</td><td>避免 CAS 中的 ABA 问题（如链表操作、缓存更新）</td><td>解决 “值被修改后又改回原值” 导致的误判</td></tr><tr><td><code>AtomicMarkableReference&lt;V&gt;</code></td><td>带标记位的引用原子类（布尔标记 + 引用）</td><td>只需判断引用是否被修改过（无需版本号）</td><td>简化版 ABA 问题（仅需 “是否修改” 标记）</td></tr></tbody></table>
<h4 data-id="heading-4">1. <code>AtomicReference</code> 示例：原子更新配置对象</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicReference;

<span class="hljs-comment">// 原子更新配置对象（避免多线程修改配置时出现部分更新）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicConfig</span> {
    <span class="hljs-comment">// 配置对象（不可变类，修改时直接替换整个对象）</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> url;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> timeout;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Config</span><span class="hljs-params">(<span class="hljs-type">String</span> url, <span class="hljs-type">int</span> timeout)</span> </span>{
            <span class="hljs-keyword">this</span>.url = url;
            <span class="hljs-keyword">this</span>.timeout = timeout;
        }

        <span class="hljs-comment">// getter 方法（无 setter，保证不可变）</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getUrl</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> url; }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getTimeout</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> timeout; }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicReference&lt;Config&gt; configRef = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Config</span>(<span class="hljs-string">"http://default.com"</span>, <span class="hljs-number">5000</span>) <span class="hljs-comment">// 初始配置</span>
    );

    <span class="hljs-comment">// 原子更新配置（替换整个 Config 对象）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">updateConfig</span><span class="hljs-params">(<span class="hljs-type">String</span> newUrl, <span class="hljs-type">int</span> newTimeout)</span> </span>{
        configRef.<span class="hljs-built_in">set</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Config</span>(newUrl, newTimeout)); <span class="hljs-comment">// 原子赋值</span>
    }

    <span class="hljs-comment">// 比较并替换配置（仅当当前配置是预期值时才更新）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">compareAndUpdateConfig</span><span class="hljs-params">(Config expect, Config update)</span> </span>{
        <span class="hljs-keyword">return</span> configRef.<span class="hljs-built_in">compareAndSet</span>(expect, update);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Config <span class="hljs-title">getConfig</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> configRef.<span class="hljs-built_in">get</span>();
    }
}
</code></pre>
<h4 data-id="heading-5">2. <code>AtomicStampedReference</code> 示例：解决 ABA 问题</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.concurrent.atomic.AtomicStampedReference;

<span class="hljs-comment">// 用 AtomicStampedReference 避免 ABA 问题</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ABAExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// 初始值："A"，版本戳：0</span>
        AtomicStampedReference&lt;String&gt; stampedRef = <span class="hljs-keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="hljs-string">"A"</span>, <span class="hljs-number">0</span>);

        <span class="hljs-comment">// 线程1：尝试将 "A" 改为 "C"（预期版本 0）</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-built_in">int</span> stamp = stampedRef.getStamp(); <span class="hljs-comment">// 获取当前版本戳：0</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"线程1：当前值="</span> + stampedRef.getReference() + <span class="hljs-string">", 版本="</span> + stamp);

            <span class="hljs-comment">// 模拟延迟（让线程2先执行 ABA 操作）</span>
            <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}

            <span class="hljs-comment">// 比较并替换：预期值 "A"，预期版本 0，更新值 "C"，新版本 1</span>
            boolean success = stampedRef.compareAndSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"C"</span>, stamp, stamp + <span class="hljs-number">1</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"线程1：更新是否成功？"</span> + success); <span class="hljs-comment">// 输出 false（版本已变）</span>
        }).start();

        <span class="hljs-comment">// 线程2：执行 ABA 操作（A → B → A）</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-built_in">int</span> stamp = stampedRef.getStamp(); <span class="hljs-comment">// 版本 0</span>
            <span class="hljs-comment">// 1. A → B（版本 0 → 1）</span>
            stampedRef.compareAndSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, stamp, stamp + <span class="hljs-number">1</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"线程2：A → B，新版本="</span> + stampedRef.getStamp());

            <span class="hljs-comment">// 2. B → A（版本 1 → 2）</span>
            stamp = stampedRef.getStamp();
            stampedRef.compareAndSet(<span class="hljs-string">"B"</span>, <span class="hljs-string">"A"</span>, stamp, stamp + <span class="hljs-number">1</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"线程2：B → A，新版本="</span> + stampedRef.getStamp());
        }).start();
    }
}
</code></pre>
<ul>
<li>结果：线程 1 延迟后尝试更新时，版本戳已从 0 变为 2，<code>compareAndSet</code> 失败，避免了 ABA 漏洞。</li>
</ul>
<h4 data-id="heading-6">注意事项：</h4>
<ul>
<li><code>AtomicStampedReference</code> 的版本戳是 <code>int</code> 类型（可循环，但需避免频繁溢出），<code>AtomicMarkableReference</code> 的标记位是 <code>boolean</code>（仅需判断 “是否修改”）。</li>
<li>引用类型原子类更新的是 “引用本身”，而非对象内部的字段（若需更新对象字段，用字段更新器原子类）。</li>
</ul>
<h3 data-id="heading-7">三、字段更新器原子类（原子更新对象字段）</h3>
<p>无需修改原有类的代码（无需让字段成为 <code>volatile</code> 或原子类），通过 <strong>反射机制</strong> 原子更新对象的实例字段或静态字段，适用于 “无法修改原有类” 的场景（如第三方库类）。</p>





























<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>关键限制</th></tr></thead><tbody><tr><td><code>AtomicIntegerFieldUpdater</code></td><td>原子更新对象的 <code>int</code> 类型字段</td><td>第三方类的 <code>int</code> 字段原子增减</td><td>字段必须是 <code>volatile</code>（否则报错）、非 final</td></tr><tr><td><code>AtomicLongFieldUpdater</code></td><td>原子更新对象的 <code>long</code> 类型字段</td><td>第三方类的 <code>long</code> 字段原子累加</td><td>同上</td></tr><tr><td><code>AtomicReferenceFieldUpdater&lt;V, T&gt;</code></td><td>原子更新对象的引用类型字段</td><td>第三方类的引用字段原子替换</td><td>字段必须是 <code>volatile</code>、非 final、非 private</td></tr></tbody></table>
<h4 data-id="heading-8">示例：<code>AtomicIntegerFieldUpdater</code> 更新第三方类字段</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;

<span class="hljs-comment">// 第三方类（无法修改源码，字段是 volatile int）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">ThirdPartyClass</span> {
    <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">int</span> count; <span class="hljs-comment">// 必须是 volatile（否则更新器无法工作）</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThirdPartyClass</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> count</span>)</span> {
        <span class="hljs-keyword">this</span>.count = count;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getCount</span>()</span> {
        <span class="hljs-keyword">return</span> count;
    }
}

<span class="hljs-comment">// 用字段更新器原子操作第三方类的 count 字段</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FieldUpdaterExample</span> {
    <span class="hljs-comment">// 1. 创建字段更新器：指定目标类、字段名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final AtomicIntegerFieldUpdater&lt;ThirdPartyClass&gt; COUNT_UPDATER =
        AtomicIntegerFieldUpdater.newUpdater(ThirdPartyClass.<span class="hljs-keyword">class</span>, <span class="hljs-string">"count"</span>);

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        ThirdPartyClass obj = <span class="hljs-keyword">new</span> ThirdPartyClass(<span class="hljs-number">10</span>);

        <span class="hljs-comment">// 2. 原子自增（count = 10 → 11）</span>
        COUNT_UPDATER.incrementAndGet(obj);
        System.<span class="hljs-keyword">out</span>.println(obj.getCount()); <span class="hljs-comment">// 输出 11</span>

        <span class="hljs-comment">// 3. 原子累加（count = 11 → 14）</span>
        COUNT_UPDATER.addAndGet(obj, <span class="hljs-number">3</span>);
        System.<span class="hljs-keyword">out</span>.println(obj.getCount()); <span class="hljs-comment">// 输出 14</span>

        <span class="hljs-comment">// 4. 比较并替换（预期 14 → 更新为 20）</span>
        boolean success = COUNT_UPDATER.compareAndSet(obj, <span class="hljs-number">14</span>, <span class="hljs-number">20</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"替换是否成功？"</span> + success); <span class="hljs-comment">// 输出 true</span>
        System.<span class="hljs-keyword">out</span>.println(obj.getCount()); <span class="hljs-comment">// 输出 20</span>
    }
}
</code></pre>
<h4 data-id="heading-9">注意事项：</h4>
<ul>
<li>目标字段必须是 <code>volatile</code>（保证可见性，否则 JVM 会抛出 <code>IllegalArgumentException</code>）。</li>
<li>字段不能是 <code>final</code>（final 字段不可修改，更新器无法操作）。</li>
<li>字段访问权限：若字段是 <code>private</code>，更新器无法通过反射访问（需字段是 <code>public</code>、<code>protected</code> 或同一包下的默认访问权限）。</li>
</ul>
<h3 data-id="heading-10">四、数组类型原子类（原子更新数组元素）</h3>
<p>针对数组元素的原子操作，支持 <code>int</code>、<code>long</code>、<code>reference</code> 类型数组，避免多线程修改数组元素时的并发冲突。</p>





























<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>关键方法</th></tr></thead><tbody><tr><td><code>AtomicIntegerArray</code></td><td>原子更新 <code>int[]</code> 数组的元素</td><td>原子计数器数组、分布式 ID 生成器数组</td><td><code>getAndIncrement(int index)</code>、<code>compareAndSet(int index, int expect, int update)</code></td></tr><tr><td><code>AtomicLongArray</code></td><td>原子更新 <code>long[]</code> 数组的元素</td><td>大数据量统计数组（如分桶计数）</td><td>同上（参数为 long 类型）</td></tr><tr><td><code>AtomicReferenceArray&lt;V&gt;</code></td><td>原子更新引用类型数组的元素</td><td>原子更新对象数组（如缓存数组）</td><td><code>set(int index, V newValue)</code>、<code>compareAndSet(...)</code></td></tr></tbody></table>
<h4 data-id="heading-11">示例：<code>AtomicIntegerArray</code> 分桶原子计数</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicIntegerArray;

<span class="hljs-comment">// 分桶原子计数器（将统计对象按哈希分桶，提升并发性能）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicArrayCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicIntegerArray bucketCounts;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> bucketSize; <span class="hljs-comment">// 分桶数量</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AtomicArrayCounter</span><span class="hljs-params">(<span class="hljs-type">int</span> bucketSize)</span> {
        <span class="hljs-built_in">this</span>.bucketSize = bucketSize;
        <span class="hljs-built_in">this</span>.bucketCounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicIntegerArray</span>(bucketSize); <span class="hljs-comment">// 初始值全为 0</span>
    }

    <span class="hljs-comment">// 根据 key 的哈希值选择分桶，原子自增</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">bucketIndex</span> <span class="hljs-operator">=</span> Math.abs(key.hashCode()) % bucketSize;
        bucketCounts.getAndIncrement(bucketIndex); <span class="hljs-comment">// 原子自增对应桶的计数</span>
    }

    <span class="hljs-comment">// 统计所有桶的总计数</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTotalCount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; bucketSize; i++) {
            total += bucketCounts.get(i);
        }
        <span class="hljs-keyword">return</span> total;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AtomicArrayCounter</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicArrayCounter</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// 10个分桶</span>

        <span class="hljs-comment">// 多线程并发计数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; counter.increment(<span class="hljs-string">"key-"</span> + Math.random())).start();
        }

        <span class="hljs-comment">// 等待所有线程执行完成</span>
        <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}

        System.out.println(<span class="hljs-string">"总计数："</span> + counter.getTotalCount()); <span class="hljs-comment">// 输出约 1000（原子性保证准确）</span>
    }
}
</code></pre>
<h4 data-id="heading-12">注意事项：</h4>
<ul>
<li>数组长度固定（创建后无法扩容），需提前规划分桶数量（如根据并发量设置合理桶数，减少冲突）。</li>
<li>数组元素的原子操作仅针对 “单个索引”，多个索引的操作不保证原子性（如同时修改索引 0 和 1，需额外同步）。</li>
</ul>
<h3 data-id="heading-13">五、复合操作原子类（JDK 8+ 新增，支持复杂原子逻辑）</h3>
<p>JDK 8 引入的 <code>DoubleAccumulator</code>、<code>LongAccumulator</code> 等，支持 <strong>自定义复合原子操作</strong>（如累加、最大值计算、自定义函数），性能比 <code>AtomicLong</code> 更优（高并发下分散竞争）。</p>



































<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>核心优势</th></tr></thead><tbody><tr><td><code>LongAccumulator</code></td><td>基于函数的长整型原子累加 / 复合操作</td><td>复杂统计（如最大值、最小值、自定义聚合）</td><td>支持自定义 <code>LongBinaryOperator</code>，高并发下性能更优</td></tr><tr><td><code>DoubleAccumulator</code></td><td>基于函数的双精度浮点型原子复合操作</td><td>浮点型数据统计（如平均响应时间）</td><td>同上（支持 <code>DoubleBinaryOperator</code>）</td></tr><tr><td><code>LongAdder</code></td><td>长整型原子累加（<code>AtomicLong</code> 的高性能替代）</td><td>高并发计数器（如 QPS 统计）</td><td>内部分桶存储，减少 CAS 冲突，高并发下性能远超 <code>AtomicLong</code></td></tr><tr><td><code>DoubleAdder</code></td><td>双精度浮点型原子累加</td><td>浮点型计数器（如流量统计）</td><td>同上</td></tr></tbody></table>
<h4 data-id="heading-14">示例：<code>LongAdder</code> 高并发计数器（替代 <code>AtomicLong</code>）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.LongAdder;

<span class="hljs-comment">// 高并发计数器：LongAdder 性能优于 AtomicLong（分桶减少冲突）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HighConcurrencyCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">LongAdder</span> <span class="hljs-variable">adder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAdder</span>();

    <span class="hljs-comment">// 原子自增（内部分桶，高并发下冲突更少）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        adder.increment();
    }

    <span class="hljs-comment">// 原子累加</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">long</span> delta)</span> {
        adder.add(delta);
    }

    <span class="hljs-comment">// 获取总数（合并所有分桶的计数）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> adder.sum();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">HighConcurrencyCounter</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighConcurrencyCounter</span>();

        <span class="hljs-comment">// 1000 个线程，每个线程自增 1000 次</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) {
                    counter.increment();
                }
            }).start();
        }

        Thread.sleep(<span class="hljs-number">2000</span>);
        System.out.println(<span class="hljs-string">"总计数："</span> + counter.getCount()); <span class="hljs-comment">// 输出 1000000（准确）</span>
    }
}
</code></pre>
<h4 data-id="heading-15">示例：<code>LongAccumulator</code> 计算最大值</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.LongAccumulator;

<span class="hljs-comment">// 用 LongAccumulator 原子计算最大值</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MaxValueCalculator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 自定义函数：取两个数的最大值（LongBinaryOperator）</span>
        <span class="hljs-type">LongAccumulator</span> <span class="hljs-variable">maxAccumulator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAccumulator</span>(
            (x, y) -&gt; Math.max(x, y), <span class="hljs-comment">// 累加器函数</span>
            Long.MIN_VALUE <span class="hljs-comment">// 初始值</span>
        );

        <span class="hljs-comment">// 多线程并发更新最大值</span>
        <span class="hljs-type">long</span>[] values = {<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">5</span>, <span class="hljs-number">30</span>, <span class="hljs-number">15</span>};
        <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> val : values) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; maxAccumulator.accumulate(val)).start();
        }

        <span class="hljs-comment">// 等待所有线程执行完成</span>
        <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}

        System.out.println(<span class="hljs-string">"最大值："</span> + maxAccumulator.get()); <span class="hljs-comment">// 输出 30</span>
    }
}
</code></pre>
<h4 data-id="heading-16">注意事项：</h4>
<ul>
<li><code>LongAdder</code>/<code>DoubleAdder</code> 的 <code>sum()</code> 方法是 “最终一致性”（合并分桶时可能有短暂不一致），适合 “最终统计” 场景（如 QPS 统计），不适合 “实时精确读取”（如事务计数）。</li>
<li>复合操作原子类仅支持 “累加 / 聚合” 类逻辑，复杂复合操作（如 “先判断再更新”）仍需结合锁或其他工具。</li>
</ul>
<h3 data-id="heading-17">六、常用原子类选择总结</h3>













































<table><thead><tr><th>场景类型</th><th>推荐原子类</th><th>替代方案</th></tr></thead><tbody><tr><td>单变量 <code>int</code>/<code>long</code> 计数</td><td><code>AtomicInteger</code>/<code>AtomicLong</code></td><td>高并发用 <code>LongAdder</code>/<code>DoubleAdder</code></td></tr><tr><td>布尔状态标记</td><td><code>AtomicBoolean</code></td><td><code>AtomicReference&lt;Boolean&gt;</code></td></tr><tr><td>原子更新对象引用</td><td><code>AtomicReference</code></td><td>需避免 ABA 用 <code>AtomicStampedReference</code></td></tr><tr><td>第三方类字段原子更新</td><td><code>AtomicIntegerFieldUpdater</code> 等</td><td>无法修改字段时的唯一选择</td></tr><tr><td>数组元素原子操作</td><td><code>AtomicIntegerArray</code> 等</td><td>手动加锁（性能差）</td></tr><tr><td>复杂聚合操作（最大值 / 自定义）</td><td><code>LongAccumulator</code>/<code>DoubleAccumulator</code></td><td>锁 + 普通变量（代码繁琐）</td></tr><tr><td>高并发计数器（QPS / 流量）</td><td><code>LongAdder</code></td><td><code>AtomicLong</code>（低并发可用）</td></tr></tbody></table>
<p><strong>核心原则</strong>：</p>
<ol>
<li>简单计数 / 状态切换：优先用 <code>AtomicInteger</code>/<code>AtomicBoolean</code>（API 简洁，无学习成本）。</li>
<li>高并发计数：用 <code>LongAdder</code>（分桶减少冲突，性能最优）。</li>
<li>引用原子替换：用 <code>AtomicReference</code>（普通场景）或 <code>AtomicStampedReference</code>（ABA 问题）。</li>
<li>第三方类字段更新：用字段更新器原子类（无需修改源码）。</li>
<li>复杂聚合逻辑：用 <code>LongAccumulator</code>/<code>DoubleAccumulator</code>（自定义函数，灵活高效）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第29篇：99% 的量化新手死在挂单上：Freqtrade 隐藏技能揭秘]]></title>    <link>https://juejin.cn/post/7577797563853094948</link>    <guid>https://juejin.cn/post/7577797563853094948</guid>    <pubDate>2025-11-30T00:23:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577797563853094948" data-draft-id="7577722399375900714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第29篇：99% 的量化新手死在挂单上：Freqtrade 隐藏技能揭秘"/> <meta itemprop="keywords" content="Python,后端,GitHub"/> <meta itemprop="datePublished" content="2025-11-30T00:23:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端伪大叔"/> <meta itemprop="url" content="https://juejin.cn/user/3702810894146151"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第29篇：99% 的量化新手死在挂单上：Freqtrade 隐藏技能揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810894146151/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端伪大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:23:19.000Z" title="Sun Nov 30 2025 00:23:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第29篇：99% 的量化新手死在挂单上：Freqtrade 隐藏技能揭秘</h2>
<p>Freqtrade 在挂单模型中提供了两个关键功能：</p>
<ul>
<li><code>adjust_entry_price</code>：仅在新建订单（首次买入）时，用于修改挂单价格。</li>
<li><code>adjust_order_price</code>：用于控制 <strong>所有挂单</strong> 的价格，包括出场、加仓、减仓</li>
</ul>
<p>合理使用这些控制点，可以最大化降低滑点，控制分段进场，进而提升策略维度和强度。</p>
<h3 data-id="heading-1">🚀 想学量化交易？</h3>
<p>👉 <strong>点击访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitrade.icu%2F" target="_blank" title="https://itrade.icu/" ref="nofollow noopener noreferrer">itrade.icu</a></strong>
这里有 <strong>Freqtrade 基础教程</strong>、<strong>策略源码</strong>、<strong>指标解析</strong> 等丰富内容，助你轻松掌握量化交易技巧！</p>
<blockquote>
<p>挂单细节决定胜负：Freqtrade 自定义价格策略完全指南</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">🎯函数作用概览</h3>




















<table><thead><tr><th>函数名</th><th>作用描述</th><th>使用时机</th></tr></thead><tbody><tr><td><code>adjust_entry_price</code></td><td>修改首次建仓时挂单价格（只调用一次）</td><td>✅ <strong>首次买入</strong></td></tr><tr><td><code>adjust_order_price</code></td><td>对所有订单（买入、卖出）统一调整价格</td><td>✅ <strong>每次下单都调用</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">🧠 adjust_entry_price - 首次建仓专用</h3>
<p>该函数<strong>只在策略首次生成交易信号并准备下单建仓时被调用一次</strong>，你可以在这里动态调整挂单价格，例如控制滑点、下浮买入价等。</p>
<h4 data-id="heading-4">✅ 使用场景</h4>
<ul>
<li>想让首次买入价格更“谨慎”，例如：
<ul>
<li>向下压一点点再挂单（防止追涨）</li>
<li>基于盘口价做微调</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">🧪 示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_entry_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, order_type: <span class="hljs-built_in">str</span>, current_rate: <span class="hljs-built_in">float</span>, proposed_rate: <span class="hljs-built_in">float</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-comment"># 往下调整 0.5% 挂单价格</span>
    adjusted_price = proposed_rate * <span class="hljs-number">0.995</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[adjust_entry_price] 原始挂单价: <span class="hljs-subst">{proposed_rate}</span>，调整后: <span class="hljs-subst">{adjusted_price}</span>"</span>)
    <span class="hljs-keyword">return</span> adjusted_price
</code></pre>
<h4 data-id="heading-6">⚠️ 注意</h4>
<ul>
<li><strong>只在首次建仓时触发</strong>，不适用于加仓/减仓</li>
<li>返回的是你希望挂出的价格</li>
</ul>
<hr/>
<h3 data-id="heading-7">🛠 adjust_order_price - 全局挂单价格钩子</h3>
<p>这是一个更强大的挂单控制函数，<strong>无论是买入还是卖出，都会经过它</strong>。</p>
<h4 data-id="heading-8">✅ 使用场景</h4>
<ul>
<li>所有挂单统一加/减价格，例如：
<ul>
<li>所有买入挂低一点（滑点保护）</li>
<li>所有卖出挂高一点（套利空间）</li>
</ul>
</li>
<li>卖出时根据当前盘口价动态挂单</li>
</ul>
<h4 data-id="heading-9">🧪 示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_order_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, is_buy: <span class="hljs-built_in">bool</span>, current_price: <span class="hljs-built_in">float</span>, proposed_price: <span class="hljs-built_in">float</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-keyword">if</span> is_buy:
        <span class="hljs-comment"># 买入时往下压0.3%</span>
        <span class="hljs-keyword">return</span> proposed_price * <span class="hljs-number">0.997</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 卖出时往上抬0.3%</span>
        <span class="hljs-keyword">return</span> proposed_price * <span class="hljs-number">1.003</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">🔍 两个函数的区别与联系</h3>






























<table><thead><tr><th>比较项</th><th><code>adjust_entry_price</code></th><th><code>adjust_order_price</code></th></tr></thead><tbody><tr><td>被调用时机</td><td>仅首次建仓买入</td><td>所有订单（包括买入和卖出）</td></tr><tr><td>可控制方向</td><td>仅限买入</td><td>买入 + 卖出</td></tr><tr><td>控制范围</td><td>建仓价</td><td>全部订单价格</td></tr><tr><td>推荐组合使用方式</td><td>✔ 首次建仓时：用 <code>adjust_entry_price</code> 控制更细致的入场价格</td><td>✔ 所有订单：用 <code>adjust_order_price</code> 做统一价格控制</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">📌 补充说明：你可能以为能用，实际不能的地方</h3>

























<table><thead><tr><th>场景</th><th>是否会调用 <code>adjust_entry_price</code>？</th><th>推荐做法</th></tr></thead><tbody><tr><td>第一次买入建仓</td><td>✅ 会调用</td><td>用来调整初始挂单价</td></tr><tr><td>加仓（已有仓位再买）</td><td>❌ 不会调用</td><td>使用 <code>adjust_trade_position</code></td></tr><tr><td>卖出止盈/止损</td><td>❌ 不会调用</td><td>使用 <code>custom_exit_price</code> 或 <code>adjust_order_price</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-12">✅ 最佳实践建议</h3>
<ul>
<li><strong>用 <code>adjust_entry_price</code> 控制首次建仓挂单价</strong></li>
<li><strong>用 <code>adjust_order_price</code> 控制所有订单滑点保护</strong></li>
<li><strong>结合 <code>custom_exit_price</code> 精准控制卖出价格</strong></li>
<li><strong>不要试图在 <code>adjust_entry_price</code> 中实现加仓逻辑，Freqtrade 不会再调用它</strong></li>
</ul>
<h4 data-id="heading-13">📘 最简动量策略案例（适合入门）</h4>
<p>这是一个<strong>基于价格动量的入门策略</strong>，策略核心逻辑：</p>
<blockquote>
<p>📈 当前K线的收盘价高于前一根K线 → 生成买入信号<br/>
📉 当前K线的收盘价低于前一根K线 → 生成卖出信号</p>
</blockquote>
<p>同时结合了 Freqtrade 提供的订单价格控制功能：</p>
<ul>
<li><code>adjust_entry_price</code>：首次建仓时挂单价下调 0.5%</li>
<li><code>adjust_order_price</code>：统一滑点控制（买入 -0.3%，卖出 +0.3%）</li>
<li><code>custom_exit_price</code>：卖出挂比当前价格高 0.2%</li>
</ul>
<hr/>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> freqtrade.strategy.interface <span class="hljs-keyword">import</span> IStrategy
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> pandas <span class="hljs-keyword">import</span> DataFrame

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleStrategy</span>(<span class="hljs-title class_ inherited__">IStrategy</span>):
    <span class="hljs-string">"""
    示例策略：基于收盘价是否上涨来决定是否买入。
    """</span>
    timeframe = <span class="hljs-string">'5m'</span>

    order_types = {
        <span class="hljs-string">'entry'</span>: <span class="hljs-string">'limit'</span>,
        <span class="hljs-string">'exit'</span>: <span class="hljs-string">'limit'</span>,
        <span class="hljs-string">'stoploss'</span>: <span class="hljs-string">'market'</span>,
    }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">populate_indicators</span>(<span class="hljs-params">self, dataframe: DataFrame, metadata: <span class="hljs-built_in">dict</span></span>) -&gt; DataFrame:
        <span class="hljs-comment"># 没有使用额外指标</span>
        <span class="hljs-keyword">return</span> dataframe

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">populate_entry_trend</span>(<span class="hljs-params">self, dataframe: DataFrame, metadata: <span class="hljs-built_in">dict</span></span>) -&gt; DataFrame:
        <span class="hljs-string">"""
        当当前K线收盘价高于上一根K线 → 生成买入信号
        """</span>
        dataframe[<span class="hljs-string">'enter_long'</span>] = dataframe[<span class="hljs-string">'close'</span>] &gt; dataframe[<span class="hljs-string">'close'</span>].shift(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> dataframe

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">populate_exit_trend</span>(<span class="hljs-params">self, dataframe: DataFrame, metadata: <span class="hljs-built_in">dict</span></span>) -&gt; DataFrame:
        <span class="hljs-string">"""
        当当前K线收盘价低于上一根K线 → 生成卖出信号
        """</span>
        dataframe[<span class="hljs-string">'exit_long'</span>] = dataframe[<span class="hljs-string">'close'</span>] &lt; dataframe[<span class="hljs-string">'close'</span>].shift(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> dataframe

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_entry_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, order_type: <span class="hljs-built_in">str</span>, current_rate: <span class="hljs-built_in">float</span>,proposed_rate: <span class="hljs-built_in">float</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""
        首次建仓时，挂单价格下调 0.5%
        """</span>
        <span class="hljs-keyword">return</span> proposed_rate * <span class="hljs-number">0.995</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_order_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, is_buy: <span class="hljs-built_in">bool</span>, current_price: <span class="hljs-built_in">float</span>,proposed_price: <span class="hljs-built_in">float</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""
        所有订单统一滑点保护：买入 -0.3%，卖出 +0.3%
        """</span>
        <span class="hljs-keyword">return</span> proposed_price * (<span class="hljs-number">0.997</span> <span class="hljs-keyword">if</span> is_buy <span class="hljs-keyword">else</span> <span class="hljs-number">1.003</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">custom_exit_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, trade, current_time, current_rate, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""
        卖出挂单价格比当前价格高 0.2%
        """</span>
        <span class="hljs-keyword">return</span> current_rate * <span class="hljs-number">1.002</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">🧾 总结</h3>
<ul>
<li><code>adjust_entry_price</code> 和 <code>adjust_order_price</code> 是 Freqtrade 在限价挂单机制中最关键的两个控制钩子：
<ul>
<li><code>adjust_entry_price</code>：只会在首次建仓时调用一次，用于精细控制第一次买入挂单价。</li>
</ul>
</li>
</ul>
<ul>
<li><code>adjust_order_price</code>：每次下单都会调用，适用于买入、卖出、加仓、减仓、止盈、止损等所有订单。</li>
</ul>
<ul>
<li>通过合理组合使用这两个函数，你可以：
<ul>
<li>避免在高位追单、有效防止滑点；</li>
<li>动态挂单、让策略更智能；</li>
<li>精准控制卖出价，提升利润空间。</li>
</ul>
</li>
<li>📌 实战建议：
<ul>
<li>想控制首次入场更稳健：使用 <code>adjust_entry_price</code></li>
<li>想控制所有订单滑点：使用 adjust_order_price</li>
<li>想控制卖出时的目标价格：再配合 <code>custom_exit_price</code> 更完美</li>
<li>当你能熟练运用这三者组合，一个专业级的挂单策略就已具备雏形。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再瞎折腾 LangChain 了：从 0 到 1 搭建 RAG 知识库的架构决策实录]]></title>    <link>https://juejin.cn/post/7577737385954590730</link>    <guid>https://juejin.cn/post/7577737385954590730</guid>    <pubDate>2025-11-30T04:51:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954590730" data-draft-id="7577971299742531622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再瞎折腾 LangChain 了：从 0 到 1 搭建 RAG 知识库的架构决策实录"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T04:51:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再瞎折腾 LangChain 了：从 0 到 1 搭建 RAG 知识库的架构决策实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T04:51:39.000Z" title="Sun Nov 30 2025 04:51:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong>：最近在帮一家做医疗器械的客户落地企业级知识库（RAG）。项目初期，团队陷入了严重的“工具崇拜”——上来就想用 LangChain + Pinecone + OpenAI 的全家桶。
结果呢？开发两周，Demo 很酷炫，一上实战（私有化部署、数据合规、成本控制）直接崩盘。
这篇文章不聊那些虚头巴脑的概念，只复盘我们是如何在 <strong>TRAE SOLO</strong> 的辅助下，重新进行架构选型，并最终用极其精简的代码落地一套高可用 RAG 系统的。</p>
</blockquote>
<h2 data-id="heading-0">为什么你的 RAG 系统总是“听不懂人话”？</h2>
<p>做过知识库的同学应该都有过这种绝望时刻：
用户问：“我们公司去年的差旅报销标准是多少？”
你的 RAG 机器人自信地回答：“根据维基百科，差旅费是指...” 或者干脆一本正经地胡说八道。</p>
<p>这不是因为模型笨，而是<strong>架构选型出了大问题</strong>。</p>
<p>传统的 RAG 开发流通常是这样的：</p>
<ol>
<li>写一堆 Python 脚本切分文档（Chunking）。</li>
<li>调 OpenAI API 跑 Embedding。</li>
<li>存入向量数据库。</li>
<li>用 LangChain 拼凑检索链。</li>
</ol>
<p>这个流程最大的痛点在于<strong>割裂</strong>。你写代码的时候不知道文档切分得对不对，调优 Prompt 的时候不知道检索召回率是多少。整个过程像是在盲人摸象。</p>
<p>而在这次重构中，我们尝试引入了 <strong>TRAE SOLO</strong> 这种 AI 原生 IDE，它给我们的架构决策带来了全新的视角：<strong>可视化调试与上下文感知</strong>。</p>
<h2 data-id="heading-1">核心思路：让 IDE 成为你的“架构参谋”</h2>
<p>RAG 的本质其实就三步：<strong>切分（Indexing） -&gt; 检索（Retrieval） -&gt; 生成（Generation）</strong>。</p>
<p>但在企业级落地中，每一步都是坑：</p>
<ul>
<li><strong>切分</strong>：按字符切？按语义切？还是按 Markdown 结构切？</li>
<li><strong>检索</strong>：单纯的向量相似度（Cosine Similarity）够吗？要不要加关键词混合检索（Hybrid Search）？</li>
<li><strong>生成</strong>：Prompt 怎么写才能防止模型产生幻觉？</li>
</ul>
<p>与其我们拍脑袋决策，不如让工具帮我们做实验。我们利用 TRAE SOLO 的 <code>SOLO Coder</code> 模式，快速生成了不同技术方案的对比原型，并通过 <code>DiffView</code> 直观地看到不同切分策略对检索结果的影响。</p>
<p>这种“测试驱动架构”（TDA）的模式，让我们在代码还没写几行的时候，就排除了 80% 的错误路径。</p>
<h2 data-id="heading-2">实战演示：手撸一个极简 RAG 内核</h2>
<p>为了展示核心逻辑，我们抛弃笨重的框架，用纯 Python + ChromaDB + DeepSeek API 实现一个轻量级 RAG。</p>
<h3 data-id="heading-3">1. 环境依赖</h3>
<pre><code class="hljs language-bash" lang="bash">pip install chromadb openai jieba
</code></pre>
<h3 data-id="heading-4">2. 智能文档切分器</h3>
<p>不要迷信 LangChain 的 <code>CharacterTextSplitter</code>。对于中文企业文档，基于<strong>结构化</strong>的切分才是王道。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> re

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MarkdownSplitter</span>:
    <span class="hljs-string">"""
    针对企业 Wiki/文档 优化的 Markdown 切分器
    保留标题层级，防止上下文丢失
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, chunk_size=<span class="hljs-number">500</span></span>):
        self.chunk_size = chunk_size

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text</span>(<span class="hljs-params">self, text</span>):
        <span class="hljs-comment"># 使用正则表达式匹配 Markdown 标题 (##, ###)</span>
        headers = re.split(<span class="hljs-string">r'(^#+ .+$)'</span>, text, flags=re.MULTILINE)
        chunks = []
        current_chunk = <span class="hljs-string">""</span>
        
        <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> headers:
            <span class="hljs-comment"># 如果加上这一段超过了 chunk_size，就先切一刀</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(current_chunk) + <span class="hljs-built_in">len</span>(part) &gt; self.chunk_size:
                <span class="hljs-keyword">if</span> current_chunk:
                    chunks.append(current_chunk.strip())
                current_chunk = part
            <span class="hljs-keyword">else</span>:
                current_chunk += <span class="hljs-string">"\n"</span> + part
                
        <span class="hljs-keyword">if</span> current_chunk:
            chunks.append(current_chunk.strip())
            
        <span class="hljs-keyword">return</span> chunks

<span class="hljs-comment"># 模拟一段企业文档</span>
doc_content = <span class="hljs-string">"""
# 差旅报销制度
## 1. 适用范围
本制度适用于全职员工...
## 2. 报销标准
一线城市每日补贴 300 元，二线城市 200 元。
"""</span>

splitter = MarkdownSplitter()
chunks = splitter.split_text(doc_content)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 成功切分为 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunks)}</span> 个片段"</span>)
<span class="hljs-comment"># 此时 TRAE SOLO 的变量查看器能让你清晰看到每个 chunk 的内容，避免切断关键语义</span>
</code></pre>
<h3 data-id="heading-5">3. 向量检索与生成</h3>
<p>这里我们使用 <code>chromadb</code> 作为轻量级向量库，它无需 Docker 即可运行，非常适合中小型项目。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> chromadb
<span class="hljs-keyword">from</span> chromadb.utils <span class="hljs-keyword">import</span> embedding_functions

<span class="hljs-comment"># 初始化本地向量库</span>
client = chromadb.PersistentClient(path=<span class="hljs-string">"./knowledge_db"</span>)
<span class="hljs-comment"># 使用开源的 sentence-transformers 模型，免费且效果不错</span>
emb_fn = embedding_functions.SentenceTransformerEmbeddingFunction(
    model_name=<span class="hljs-string">"paraphrase-multilingual-MiniLM-L12-v2"</span>
)

collection = client.get_or_create_collection(
    name=<span class="hljs-string">"policy_docs"</span>,
    embedding_function=emb_fn
)

<span class="hljs-comment"># 1. 写入数据</span>
ids = [<span class="hljs-string">f"doc_<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chunks))]
collection.add(documents=chunks, ids=ids)

<span class="hljs-comment"># 2. 检索逻辑</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_knowledge_base</span>(<span class="hljs-params">question</span>):
    results = collection.query(
        query_texts=[question],
        n_results=<span class="hljs-number">2</span> <span class="hljs-comment"># 只取最相关的 2 条</span>
    )
    <span class="hljs-keyword">return</span> results[<span class="hljs-string">'documents'</span>][<span class="hljs-number">0</span>]

<span class="hljs-comment"># 3. 生成回答 (伪代码，对接 DeepSeek/OpenAI)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_answer</span>(<span class="hljs-params">question, context</span>):
    prompt = <span class="hljs-string">f"""
    你是一个专业的企业助手。请基于以下上下文回答问题。
    如果上下文中没有答案，请直接说“我不知道”。
    
    上下文：
    <span class="hljs-subst">{context}</span>
    
    问题：<span class="hljs-subst">{question}</span>
    """</span>
    <span class="hljs-comment"># return call_llm_api(prompt) </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"构建的 Prompt:"</span>, prompt)

<span class="hljs-comment"># --- 测试 ---</span>
q = <span class="hljs-string">"去上海出差每天补多少钱？"</span>
retrieved_docs = query_knowledge_base(q)
generate_answer(q, retrieved_docs)
</code></pre>
<h2 data-id="heading-6">避坑指南：架构师的血泪经验</h2>
<p>代码跑通很简单，但要上生产环境，这三个坑你必须得填：</p>
<h3 data-id="heading-7">1. 脏数据比烂模型更可怕</h3>
<p>很多开发者把精力花在微调模型上，却忽略了<strong>源数据的清洗</strong>。
我们在 TRAE SOLO 中对比发现，PDF 解析出来的乱码、页眉页脚的干扰字符，会让检索准确率下降 30% 以上。
<strong>建议</strong>：在 Embedding 之前，务必增加一个 ETL（Extract, Transform, Load）环节，专门处理换行符、去除无意义的特殊符号。</p>
<h3 data-id="heading-8">2. 警惕“上下文窗口爆炸”</h3>
<p>现在的模型支持 128k 甚至 1M 的 Context，很多人就懒了，直接把检索到的 100 个片段全塞进去。
这不仅费钱，还会导致“迷失中间”（Lost in the Middle）现象——模型记住了开头和结尾，却忘了中间的关键信息。
<strong>建议</strong>：严格控制 <code>n_results</code>，并引入 Re-rank（重排序）模型。先粗排检索 50 条，再用精排模型选出最相关的 5 条给 LLM。</p>
<h3 data-id="heading-9">3. 私有化部署的算力陷阱</h3>
<p>客户说要私有化，你推了 Llama-3-70B，结果客户服务器只有一张 T4 卡。
<strong>架构决策</strong>：在 TRAE SOLO 的辅助下，我们快速测试了 Qwen-7B-Int4 量化版本，发现对于 RAG 这种依赖上下文的任务，7B 模型配合高质量的知识库，效果完全不输 70B，但成本降低了 90%。</p>
<h2 data-id="heading-10">结语</h2>
<p>搭建 RAG 知识库，从来就不是一个纯代码问题，而是一个<strong>数据治理与架构权衡</strong>的艺术。</p>
<p>TRAE SOLO 在这个过程中，不再仅仅是一个代码编辑器，它更像是一个<strong>能够理解代码语义的架构助手</strong>。它帮我们快速验证想法、对比方案、排查隐患，让我们能把更多精力放在业务逻辑本身，而不是被繁琐的配置和 API 报错通过。</p>
<p><strong>不要做工具的奴隶，要做架构的主人。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openGauss在AI时代的向量数据库应用实践与技术演进深度解析]]></title>    <link>https://juejin.cn/post/7577704980855930934</link>    <guid>https://juejin.cn/post/7577704980855930934</guid>    <pubDate>2025-11-30T02:17:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577704980855930934" data-draft-id="7577958825341599763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openGauss在AI时代的向量数据库应用实践与技术演进深度解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T02:17:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="微学AI"/> <meta itemprop="url" content="https://juejin.cn/user/4258884716870988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openGauss在AI时代的向量数据库应用实践与技术演进深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4258884716870988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    微学AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:17:10.000Z" title="Sun Nov 30 2025 02:17:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>本文以openGauss开源数据库6.0 LTS及7.0版本为研究焦点，系统剖析其在AI原生架构、向量检索引擎与自治运维体系的技术突破。通过构建基于DataVec插件的RAG（检索增强生成）实战案例，结合TPC-H向量扩展测试与智能制造时序数据分析场景，首次完整呈现从SQL语法层到执行引擎的向量操作全链路实现。研究揭示了openGauss通过"AI4DB自治优化+DB4AI内建推理"双引擎架构，在混合负载场景下实现QPS提升37%、召回率保持在95%以上的技术路径，为自主研发数据库在生成式AI时代的演进提供范式参考。</p>
<hr/>
<h2 data-id="heading-1">1. 技术演进：从关系型到AI-Native的六次范式跃迁</h2>
<h3 data-id="heading-2">1.1 版本迭代矩阵与核心突破</h3>
<p>openGauss自2020年开源以来，已完成从传统HTAP数据库到AI-Native智能数据底座的质变。关键版本的技术演进呈现明显的"三阶段"特征：</p>



































<table><thead><tr><th>版本</th><th>发布时间</th><th>核心特性</th><th>性能提升指标</th></tr></thead><tbody><tr><td><strong>2.0.0</strong></td><td>2021-03-30</td><td>MOT内存引擎（Beta）、NUMA-Aware内核</td><td>TPMC从150万→350万，提升133%</td></tr><tr><td><strong>5.0.0</strong></td><td>2023-03-31</td><td>算子级优化、自治运维DBMind增强</td><td>TPC-H 100G场景端到端性能+37%</td></tr><tr><td><strong>6.0.0</strong></td><td>2024-03-01</td><td>DataVec向量插件、oGEngine原位更新引擎</td><td>TPCC性能提升20%，SM4算法性能+5%</td></tr><tr><td><strong>7.0.0</strong></td><td>2024-09-30</td><td>HNSW/IVFFLAT混合索引、SQL/PG双语法兼容</td><td>向量召回率95%场景QPS提升3.2倍</td></tr></tbody></table>
<h3 data-id="heading-3">1.2 6.0版本向量架构革新</h3>
<p>openGauss 6.0.0引入的**DataVec向量数据库插件**实现了三大技术突破：1.</p>
<ol>
<li>
<p><strong>原生向量类型系统</strong>：支持<code>VECTOR(n)</code>定长向量存储，内建L2/余弦/内积距离度量</p>
</li>
<li>
<p><strong>混合索引引擎</strong>：同时支持精确检索（Flat）与近似检索（HNSW、IVF-FLAT）</p>
</li>
</ol>

<ol start="3">
<li><strong>ACID事务保障</strong>：向量数据与普通关系数据在同一事务中实现强一致性</li>
</ol>
<p>该架构首次在关系型数据库中解决了"向量检索精度"与"事务隔离级别"的固有矛盾，通过MVCC机制为向量版本提供快照隔离。</p>
<hr/>
<h2 data-id="heading-4">2. 核心技术解码：AI4DB与DB4AI双轮驱动</h2>
<h3 data-id="heading-5">2.1 AI4DB自治运维体系</h3>
<p>基于DBMind框架的自治能力在5.0版本后形成完整闭环：</p>
<ul>
<li>
<p><strong>查询优化器植入</strong>：学习成本估算器（Learned Cost Estimator）替代传统CBO，计划枚举效率提升16倍</p>
</li>
<li>
<p><strong>慢SQL诊断</strong>：LSTM自编码器实时检测执行计划异常，诊断准确率92.3%</p>
</li>
<li>
<p><strong>参数调优</strong>：X-Tuner解决NP-hard问题，调优后性能提升15-40%</p>
</li>
</ul>
<p><strong>DBMind自治架构</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3106e924c93c42e5aa1423d4a37626d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=PGwozEe9S6xt6T3yQURnWmrNb2o%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.2 DB4AI内建推理引擎</h3>
<p>openGauss 6.0通过<code>CREATE MODEL</code>语法实现"库内训练-推理"一体化：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在数据库内直接训练故障预测模型</span>
<span class="hljs-keyword">CREATE</span> MODEL device_fault_predict 
<span class="hljs-keyword">USING</span> xgboost 
FEATURES temperature, vibration, pressure 
TARGET fault_type 
<span class="hljs-keyword">FROM</span> equipment_monitor 
<span class="hljs-keyword">WITH</span> (max_depth<span class="hljs-operator">=</span><span class="hljs-number">6</span>, n_estimators<span class="hljs-operator">=</span><span class="hljs-number">100</span>);

<span class="hljs-comment">-- 实时推理</span>
<span class="hljs-keyword">SELECT</span> device_id, PREDICT <span class="hljs-keyword">BY</span> device_fault_predict(temperature, vibration, pressure) 
<span class="hljs-keyword">FROM</span> sensor_stream;
</code></pre>
<p>该特性将数据移动成本降低99%，推理延迟从毫秒级降至微秒级。</p>
<hr/>
<h2 data-id="heading-7">3. 向量数据库实操：从SQL到索引的全链路实现</h2>
<h3 data-id="heading-8">3.1 环境准备与插件加载</h3>
<p><strong>步骤1：安装openGauss 6.0.0并启用DataVec</strong></p>
<p>下载6.0.0 LTS版本</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5220e4cc3d5419c89ef4b0f74007444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=or24pWnYhFBC2UCXHxzvk%2Fes3PE%3D" alt="" loading="lazy"/></p>
<p>解压并初始化</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7237c51a8d24210be855d7aac594d1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=ExoQeCDYnS66ICbPjGinX4t9oNc%3D" alt="" loading="lazy"/></p>
<p>创建用户并授权</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21062054281c4f3da47cc07cf55f1822~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=2DAhXybnEyyCChwj6Tgy37%2Bm23s%3D" alt="" loading="lazy"/></p>
<p>执行安装脚本（以最小化配置为例）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/177b22080c694ad2abbd5969301041c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=0czW9IE9B1QfLrtcA2qKLKdMlfY%3D" alt="" loading="lazy"/></p>
<p><strong>安装初始化成功</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb779442a484feba73b76f3adbd408d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=IklJW2VabnkGWZZGk7%2BsrJsBui4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3.2 创建向量表与数据插入</h3>
<p><strong>步骤2：连接数据库并创建测试表</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 连接数据库</span>
gsql -d postgres -U opengauss -W Enmo@123 -p 5432

<span class="hljs-comment"># 启用DataVec插件</span>
 postgres=<span class="hljs-comment"># CREATE EXTENSION datavec;</span>
CREATE EXTENSION
</code></pre>
<p><strong>步骤3：创建知识库向量表</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建支持混合检索的文档表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> knowledge_base (
    doc_id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    content TEXT,
    doc_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),  <span class="hljs-comment">-- 用于过滤的业务属性</span>
    create_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    embedding VECTOR(<span class="hljs-number">768</span>)  <span class="hljs-comment">-- 使用768维向量</span>
);

<span class="hljs-comment">-- 查看表结构确认向量列</span>
\d knowledge_base
</code></pre>
<p>查看表结构确认向量列：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e0c4359dcbc44368a4331ec1f1bf4ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=Fsga%2B3JAp2E3yXzFFedJDaWPAGM%3D" alt="" loading="lazy"/></p>
<p><strong>步骤4：批量插入向量数据</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用Python生成嵌入并批量插入</span>
<span class="hljs-comment"># 安装驱动: pip install psycopg2-binary langchain-openai</span>

<span class="hljs-keyword">import</span> psycopg2
<span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> OpenAIEmbeddings

<span class="hljs-comment"># 初始化嵌入模型</span>
embeddings = OpenAIEmbeddings(model=<span class="hljs-string">"text-embedding-ada-002"</span>)

<span class="hljs-comment"># 示例文档</span>
docs = [
    {<span class="hljs-string">"title"</span>: <span class="hljs-string">"openGauss安装指南"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"详细安装步骤..."</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tech_doc"</span>},
    {<span class="hljs-string">"title"</span>: <span class="hljs-string">"向量索引原理"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"HNSW算法详解..."</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"algorithm"</span>},
    <span class="hljs-comment"># ... 更多文档</span>
]

<span class="hljs-comment"># 连接数据库并插入</span>
conn = psycopg2.connect(database=<span class="hljs-string">"postgres"</span>, user=<span class="hljs-string">"opengauss"</span>, password=<span class="hljs-string">"Enmo@123"</span>, host=<span class="hljs-string">"localhost"</span>, port=<span class="hljs-string">"5432"</span>)
cur = conn.cursor()

<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
    <span class="hljs-comment"># 生成向量</span>
    vector = embeddings.embed_query(doc[<span class="hljs-string">"content"</span>])
    
    <span class="hljs-comment"># 插入数据</span>
    cur.execute(
        <span class="hljs-string">"INSERT INTO knowledge_base (title, content, doc_type, embedding) VALUES (%s, %s, %s, %s)"</span>,
        (doc[<span class="hljs-string">"title"</span>], doc[<span class="hljs-string">"content"</span>], doc[<span class="hljs-string">"type"</span>], vector)
    )

conn.commit()
cur.close()

<span class="hljs-comment"># 验证插入</span>
SELECT COUNT(*) FROM knowledge_base;
</code></pre>
<p><strong>终端输出：</strong></p>
<p>count</p>
<p>10500</p>
<p>(1 row)</p>
<h3 data-id="heading-10">3.3 构建混合向量索引</h3>
<p><strong>步骤5：创建HNSW索引加速检索</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建HNSW索引（适合高召回率场景）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_kb_hnsw 
<span class="hljs-keyword">ON</span> knowledge_base 
<span class="hljs-keyword">USING</span> vectors (embedding) 
<span class="hljs-keyword">WITH</span> (index_type <span class="hljs-operator">=</span> <span class="hljs-string">'hnsw'</span>, m <span class="hljs-operator">=</span> <span class="hljs-number">16</span>, ef_construction <span class="hljs-operator">=</span> <span class="hljs-number">200</span>);

<span class="hljs-comment">-- 创建IVF-FLAT索引（适合大规模数据）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_kb_ivf 
<span class="hljs-keyword">ON</span> knowledge_base 
<span class="hljs-keyword">USING</span> vectors (embedding) 
<span class="hljs-keyword">WITH</span> (index_type <span class="hljs-operator">=</span> <span class="hljs-string">'ivfflat'</span>, nlists <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>);

<span class="hljs-comment">-- 查看索引状态</span>
<span class="hljs-keyword">SELECT</span> indexname, indexdef <span class="hljs-keyword">FROM</span> pg_indexes <span class="hljs-keyword">WHERE</span> tablename <span class="hljs-operator">=</span> <span class="hljs-string">'knowledge_base'</span>;
</code></pre>
<p><strong>终端输出：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d58a275ba8842ddbbe862aec9f99f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=%2FQYvSuk1iZlddooisrVURyZz6xg%3D" alt="" loading="lazy"/></p>
<p><strong>索引创建过程与耗时截图</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe551a54830c4c72acf7a897c0541fb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=3dXF%2Bxr8UeFGoHvIF3v%2FHrOSyC8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">3.4 混合相似性搜索</h3>
<p><strong>步骤6：执行带元数据过滤的向量查询</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景：查找与"数据库性能优化"最相关的技术文档</span>
<span class="hljs-comment">-- 第一步：生成查询向量（假设已通过模型获得）</span>
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@query</span>_vec <span class="hljs-operator">=</span> <span class="hljs-string">'[0.12, -0.45, 0.78, ..., 0.33]'</span>;  <span class="hljs-comment">-- 768维</span>

<span class="hljs-comment">-- 第二步：执行相似度检索（余弦相似度）</span>
<span class="hljs-keyword">SELECT</span> 
    doc_id,
    title,
    doc_type,
    <span class="hljs-number">1</span> <span class="hljs-operator">-</span> (embedding <span class="hljs-operator">&lt;=&gt;</span> <span class="hljs-variable">@query</span>_vec::vector) <span class="hljs-keyword">AS</span> similarity,
    create_time
<span class="hljs-keyword">FROM</span> knowledge_base
<span class="hljs-keyword">WHERE</span> doc_type <span class="hljs-operator">=</span> <span class="hljs-string">'tech_doc'</span>  <span class="hljs-comment">-- 业务属性过滤</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;=&gt;</span> <span class="hljs-variable">@query</span>_vec::vector
LIMIT <span class="hljs-number">10</span>;

<span class="hljs-comment">-- 第三步：查看执行计划</span>
EXPLAIN (ANALYZE, BUFFERS) 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> knowledge_base <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;=&gt;</span> <span class="hljs-variable">@query</span>_vec::vector LIMIT <span class="hljs-number">5</span>;
</code></pre>
<p><strong>终端输出：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d79f126648043f193c12d6a4bca1b01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=rNs4T1g6JQkHn6bZ1qxQbi8NNyo%3D" alt="" loading="lazy"/></p>
<p><strong>执行计划分析输出：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf5016bf38c47978560e576fe51207d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=YiiV135XYvjs1b4saToPVo0RvbM%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-12">4. 性能基准测试与分析</h2>
<h3 data-id="heading-13">4.1 测试环境配置</h3>
<p>基于华为云ECS实例，规格如下：</p>
<ul>
<li>
<p><strong>CPU</strong>:  Kunpeng 920 @ 2.6GHz, 32 cores</p>
</li>
<li>
<p><strong>内存</strong>: 128GB DDR4</p>
</li>
<li>
<p><strong>存储</strong>: 3TB NVMe SSD</p>
</li>
<li>
<p><strong>OS</strong>: openEuler 22.03 LTS</p>
</li>
<li>
<p><strong>数据集</strong>: GIST-1M（960维向量）+ 10万条结构化元数据</p>
</li>
</ul>
<h3 data-id="heading-14">4.2 向量检索性能对比</h3>
<p><strong>表：不同索引类型性能基准</strong></p>













































<table><thead><tr><th>索引类型</th><th>构建时间</th><th>内存占用</th><th>P99延迟</th><th>QPS@95%Recall</th><th>召回率</th></tr></thead><tbody><tr><td>Flat (暴力检索)</td><td>-</td><td>3.6GB</td><td>850ms</td><td>1.2</td><td>100%</td></tr><tr><td>IVF-FLAT (nlist=1000)</td><td>45s</td><td>4.1GB</td><td>45ms</td><td>22.3</td><td>94.8%</td></tr><tr><td><strong>HNSW (m=16, ef=200)</strong></td><td><strong>234s</strong></td><td><strong>5.8GB</strong></td><td><strong>12ms</strong></td><td><strong>83.7</strong></td><td><strong>95.2%</strong></td></tr><tr><td>HNSW (m=32, ef=400)</td><td>478s</td><td>8.2GB</td><td>8ms</td><td>125.4</td><td>96.1%</td></tr></tbody></table>
<h3 data-id="heading-15">4.3 AI工作负载端到端测试</h3>
<p>在RAG场景下，完整链路（查询向量化+向量检索+LLM生成）性能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用benchmark工具测试</span>
./vector_rag_benchmark --queries 1000 --concurrency 32 --model gpt-3.5-turbo
</code></pre>
<p>测试结果摘要</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3a26c004dc44e1fba40a3acca837b0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=VyIBD4Qfq8UIFeh4JLPonlxpIqs%3D" alt="" loading="lazy"/></p>
<p>关键发现：<strong>向量检索占比仅5.3%</strong>，证明openGauss向量引擎不会成为RAG系统瓶颈。相比外置向量数据库（如Milvus）+PostgreSQL方案，端到端延迟降低22%，事务一致性保障提升显著[^329]。</p>
<hr/>
<h2 data-id="heading-16">5. 生态整合：与LangChain/Dify的深度融合</h2>
<h3 data-id="heading-17">5.1 LangChain集成方案</h3>
<p>openGauss通过<code>langchain-opengauss</code>包提供标准VectorStore接口[^61][^65]：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> OpenGauss
<span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> HuggingFaceEmbeddings

<span class="hljs-comment"># 初始化连接</span>
vector_store = OpenGauss(
    connection_string=<span class="hljs-string">"postgresql://opengauss:Enmo@123@localhost:5432/postgres"</span>,
    embedding_function=HuggingFaceEmbeddings(),
    collection_name=<span class="hljs-string">"enterprise_kb"</span>,
    vector_dimension=<span class="hljs-number">768</span>
)

<span class="hljs-comment"># 添加文档（自动完成向量化与事务写入）</span>
vector_store.add_texts(
    texts=[<span class="hljs-string">"openGauss支持向量检索"</span>, <span class="hljs-string">"DataVec插件提升AI效率"</span>],
    metadatas=[{<span class="hljs-string">"source"</span>: <span class="hljs-string">"tech_doc"</span>}, {<span class="hljs-string">"source"</span>: <span class="hljs-string">"blog"</span>}],
    batch_size=<span class="hljs-number">1000</span>
)

<span class="hljs-comment"># 带过滤的相似度查询</span>
results = vector_store.similarity_search_with_score(
    query=<span class="hljs-string">"如何优化向量索引"</span>,
    k=<span class="hljs-number">5</span>,
    <span class="hljs-built_in">filter</span>={<span class="hljs-string">"source"</span>: <span class="hljs-string">"tech_doc"</span>},
    distance_threshold=<span class="hljs-number">0.75</span>
)
</code></pre>
<h3 data-id="heading-18">5.2 Dify知识库对接</h3>
<p>在Dify平台配置openGauss作为向量存储后端：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.override.yml</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">api:</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">VECTOR_STORE:</span> <span class="hljs-string">opengauss</span>
      <span class="hljs-attr">OPENGAUSS_HOST:</span> <span class="hljs-string">db.opengauss.local</span>
      <span class="hljs-attr">OPENGAUSS_PORT:</span> <span class="hljs-number">5432</span>
      <span class="hljs-attr">OPENGAUSS_USER:</span> <span class="hljs-string">opengauss</span>
      <span class="hljs-attr">OPENGAUSS_PASSWORD:</span> <span class="hljs-string">${DB_PASSWORD}</span>
      <span class="hljs-attr">OPENGAUSS_DATABASE:</span> <span class="hljs-string">dify_kb</span>
</code></pre>
<p>此方案实现企业级权限管控与审计，满足金融级合规要求。</p>
<hr/>
<h2 data-id="heading-19">6. 用户案例研究：智能制造故障诊断</h2>
<h3 data-id="heading-20">6.1 问题背景</h3>
<p>某光伏制造企业面临设备故障定位耗时长的痛点：历史工单10万+，故障描述多为非结构化文本，传统关键词检索准确率低（&lt;60%），平均定位时间4.2小时。</p>
<h3 data-id="heading-21">6.2 系统架构</h3>
<p><strong>故障诊断RAG架构</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7616e170f7f4042b7aff8d13f979050~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=h9VxFEM7QOmlcyna2fBM04v41ds%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-22">6.3 数据规模与性能</h3>
<ul>
<li>
<p><strong>结构化数据</strong>：设备传感器数据5.2亿条，时序表分区1200+</p>
</li>
<li>
<p><strong>向量数据</strong>：工单文本embedding 10.5万条，768维</p>
</li>
<li>
<p><strong>查询负载</strong>：峰值QPS 350，P99延迟&lt;50ms</p>
</li>
<li>
<p><strong>性能结果</strong>：</p>
<ul>
<li>
<p>故障定位时间：4.2小时 → 18分钟（提升93%）</p>
</li>
<li>
<p>检索准确率：58% → 91.7%</p>
</li>
<li>
<p>知识库更新延迟：从T+1到准实时</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-23">6.4 关键技术实现</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建时序数据与向量关联视图</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> fault_diagnosis_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> 
    d.device_id,
    d.fault_time,
    d.sensor_data,
    k.doc_id <span class="hljs-keyword">AS</span> similar_case_id,
    k.title <span class="hljs-keyword">AS</span> case_title,
    <span class="hljs-number">1</span> <span class="hljs-operator">-</span> (k.embedding <span class="hljs-operator">&lt;=&gt;</span> d.fault_desc_vector) <span class="hljs-keyword">AS</span> similarity
<span class="hljs-keyword">FROM</span> device_fault d
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (
    <span class="hljs-keyword">SELECT</span> doc_id, title, embedding
    <span class="hljs-keyword">FROM</span> knowledge_base
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;=&gt;</span> d.fault_desc_vector
    LIMIT <span class="hljs-number">5</span>
) k
<span class="hljs-keyword">WHERE</span> d.fault_time <span class="hljs-operator">&gt;</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'24 hours'</span>;
</code></pre>
<hr/>
<h2 data-id="heading-24">7. 结论</h2>
<p>openGauss通过6.0版本DataVec插件与7.0版本向量引擎的深度优化，成功构建了**全栈AI-Native数据库能力**。实测表明，在RAG、智能制造等场景中，其混合检索性能达到专用向量数据库水平，同时提供 unparalleled 的事务一致性与企业级特性。自主研发数据库正从"追赶者"转变为"定义者"，在生成式AI时代开辟出一条融合创新之路。</p>
<h3 data-id="heading-25">7.1 关键价值总结</h3>



































<table><thead><tr><th>维度</th><th>传统方案</th><th>openGauss方案</th><th>提升</th></tr></thead><tbody><tr><td><strong>数据一致性</strong></td><td>最终一致性</td><td>快照隔离级别</td><td>100%</td></tr><tr><td><strong>运维复杂度</strong></td><td>多系统协同</td><td>单一数据库自治</td><td>-70%</td></tr><tr><td><strong>端到端延迟</strong></td><td>1200ms</td><td>847ms</td><td>-29%</td></tr><tr><td><strong>TCO成本</strong></td><td>高（多 license）</td><td>低（统一平台）</td><td>-45%</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Java泛型：给你的代码装上“快递分拣系统”，再也不会拆出一双鞋！》]]></title>    <link>https://juejin.cn/post/7577690150093193256</link>    <guid>https://juejin.cn/post/7577690150093193256</guid>    <pubDate>2025-11-30T02:56:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093193256" data-draft-id="7577713754563149876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Java泛型：给你的代码装上“快递分拣系统”，再也不会拆出一双鞋！》"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T02:56:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oouy"/> <meta itemprop="url" content="https://juejin.cn/user/402859440221980"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Java泛型：给你的代码装上“快递分拣系统”，再也不会拆出一双鞋！》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/402859440221980/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oouy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:56:04.000Z" title="Sun Nov 30 2025 02:56:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java泛型：让代码告别“混乱快递站”的神器 📦✨</h2>
<blockquote>
<p><strong>一句话总结</strong>：<br/>
泛型 = 给你的集合贴上“只装零食”的快递标签，再也不怕拆出一双鞋！</p>
</blockquote>
<p>如果你曾在 Java 代码里遭遇过 <code>ClassCastException</code>，那感觉就像——<br/>
你满怀期待地打开一个标注 <strong>“薯片”</strong> 的快递箱，结果掏出一双 <strong>运动鞋</strong> 👟。<br/>
不仅吃不上，还可能被鞋带绊倒 😭。</p>
<p>别慌！今天我们就用 <strong>“快递分拣”</strong> 的思路，把 Java 泛型讲得明明白白。<br/>
让你的代码从 <strong>野蛮快递堆</strong> 变成 <strong>顺丰级分拣中心</strong> ✈️📦！</p>
<hr/>
<h3 data-id="heading-1">🚫 一、没有泛型的“野蛮时代”：快递乱装乱发</h3>
<p>在 JDK 5 之前，Java 集合就像个 <strong>没人管的三不管快递站</strong>：<br/>
不管是文件、衣服、还是手机，统统塞进同一个标着 <strong><code>Object</code></strong> 的大箱子。</p>
<h4 data-id="heading-2">💥 离谱代码现场还原：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// “啥都能装”的万能快递箱</span>
<span class="hljs-type">ArrayList</span> <span class="hljs-variable">packageBox</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
packageBox.add(<span class="hljs-string">"薯片"</span>);      <span class="hljs-comment">// 零食</span>
packageBox.add(<span class="hljs-number">99</span>);          <span class="hljs-comment">// 价格标签？</span>
packageBox.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Phone</span>()); <span class="hljs-comment">// 手机？谁放的！</span>

<span class="hljs-comment">// 拆箱时刻：以为全是零食...</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; packageBox.size(); i++) {
    <span class="hljs-type">String</span> <span class="hljs-variable">snack</span> <span class="hljs-operator">=</span> (String) packageBox.get(i); <span class="hljs-comment">// BOOM! ClassCastException!</span>
    System.out.println(<span class="hljs-string">"拆到零食："</span> + snack);
}
</code></pre>
<blockquote>
<p>💡 <strong>编译时岁月静好，运行时当场爆炸</strong> —— 这就是没有泛型的痛！</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">✅ 二、泛型登场：给快递箱贴“专属标签”</h3>
<p>泛型的出现，相当于给每个集合贴上 <strong>精准分类标签</strong>：</p>
<blockquote>
<p>“此箱仅限 <code>String</code>（零食）！”<br/>
“此箱仅限 <code>Integer</code>（价格）！”</p>
</blockquote>
<p><strong>放错？编译器直接拒收！</strong></p>
<h4 data-id="heading-4">🌟 改造后代码（清爽如新）：</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 贴标签：零食专属箱 🍫</span>
ArrayList&lt;String&gt; snackBox = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
snackBox.<span class="hljs-keyword">add</span>(<span class="hljs-string">"薯片"</span>);
snackBox.<span class="hljs-keyword">add</span>(<span class="hljs-string">"巧克力"</span>);
<span class="hljs-comment">// snackBox.add(99);        // ❌ 编译报错！数字不是零食！</span>
<span class="hljs-comment">// snackBox.add(new Phone()); // ❌ 手机请走电子产品通道！</span>

<span class="hljs-keyword">for</span> (String snack : snackBox) {
    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"拆到零食："</span> + snack); <span class="hljs-comment">// 安全！舒心！无强转！</span>
}
</code></pre>
<blockquote>
<p>✅ <strong>核心价值</strong>：把 <strong>运行时的惊吓</strong>，变成 <strong>编译时的提醒</strong>，Bug 死在摇篮里！</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">🧩 三、泛型的“三大分身”：类、接口、方法</h3>
<p>泛型不是单一工具，而是一套 <strong>智能快递分拣系统</strong>：</p>

























<table><thead><tr><th>角色</th><th>比喻</th><th>作用</th></tr></thead><tbody><tr><td><strong>泛型类</strong></td><td>万能收纳盒</td><td>装什么由你定</td></tr><tr><td><strong>泛型接口</strong></td><td>配送规则</td><td>规定“送什么类型”</td></tr><tr><td><strong>泛型方法</strong></td><td>全能快递员</td><td>单点处理多类型</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-6">1️⃣ 泛型类：给类装个“类型调节旋钮” 🎛️</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StorageBox</span>&lt;<span class="hljs-title">T</span>&gt; {
    <span class="hljs-keyword">private</span> T item;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StorageBox</span>(<span class="hljs-params">T item</span>)</span> { <span class="hljs-keyword">this</span>.item = item; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">getItem</span>()</span> { <span class="hljs-keyword">return</span> item; }
}
</code></pre>
<blockquote>
<p><code>T</code> 就像收音机的调频旋钮——拧到哪，就收哪种信号！</p>
</blockquote>
<h5 data-id="heading-7">使用示例：</h5>
<pre><code class="hljs language-ini" lang="ini">StorageBox&lt;String&gt; <span class="hljs-attr">notebookBox</span> = new StorageBox&lt;&gt;(<span class="hljs-string">"笔记本"</span>)<span class="hljs-comment">;</span>
StorageBox&lt;Integer&gt; <span class="hljs-attr">jewelryBox</span> = new StorageBox&lt;&gt;(<span class="hljs-number">599</span>)<span class="hljs-comment">;</span>
StorageBox&lt;Cat&gt; <span class="hljs-attr">catBox</span> = new StorageBox&lt;&gt;(new Cat(<span class="hljs-string">"煤球"</span>))<span class="hljs-comment">;</span>

// 直接取，无需强转！类型安全拉满 ✅
</code></pre>
<blockquote>
<p>⚠️ 注意：不能用 <code>int</code>、<code>double</code> 等基本类型！要用 <code>Integer</code>、<code>Double</code> 包装类——<br/>
就像硬币得先装进信封才能寄（包装类 = 硬币袋）💰</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">2️⃣ 泛型接口：制定“通用配送规则” 📜</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">MessageSender</span>&lt;<span class="hljs-title">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send</span>(<span class="hljs-params">T message</span>)</span>;
}
</code></pre>
<h5 data-id="heading-9">两种实现方式：</h5>
<ul>
<li>
<p><strong>固定类型派</strong>（只发文字）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageSender</span>&lt;<span class="hljs-title class_">String</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> msg</span>) { <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"发文字："</span> + msg); }
}
</code></pre>
</li>
<li>
<p><strong>灵活接单派</strong>（啥都发）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AnySender</span>&lt;<span class="hljs-title">T</span>&gt; implements <span class="hljs-title">MessageSender</span>&lt;<span class="hljs-title">T</span>&gt;</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span>(<span class="hljs-params">T msg</span>)</span> { System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"发任意消息："</span> + msg); }
}

<span class="hljs-comment">// 客户要发图片？</span>
<span class="hljs-keyword">new</span> AnySender&lt;Image&gt;().send(<span class="hljs-keyword">new</span> Image(<span class="hljs-string">"风景照"</span>));
</code></pre>
</li>
</ul>
<hr/>
<h4 data-id="heading-10">3️⃣ 泛型方法：开个“快速通道” 🚀</h4>
<p>不需要整个类泛型？那就只给方法加！</p>
<pre><code class="hljs language-ini" lang="ini">public class ArrayHelper {
    public static &lt;T&gt; void swap(T<span class="hljs-section">[]</span> arr, int i, int j) {
        T <span class="hljs-attr">temp</span> = arr[i]<span class="hljs-comment">;</span>
        arr<span class="hljs-section">[i]</span> = arr<span class="hljs-section">[j]</span><span class="hljs-comment">;</span>
        arr<span class="hljs-section">[j]</span> = temp<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-11">万物皆可 swap：</h5>
<pre><code class="hljs language-ini" lang="ini">String<span class="hljs-section">[]</span> <span class="hljs-attr">fruits</span> = {<span class="hljs-string">"苹果"</span>, <span class="hljs-string">"香蕉"</span>}<span class="hljs-comment">;</span>
ArrayHelper.swap(fruits, 0, 1)<span class="hljs-comment">; // ✅</span>

Integer<span class="hljs-section">[]</span> <span class="hljs-attr">nums</span> = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}<span class="hljs-comment">;</span>
ArrayHelper.swap(nums, 0, 2)<span class="hljs-comment">;   // ✅</span>

Cat<span class="hljs-section">[]</span> <span class="hljs-attr">cats</span> = {new Cat(<span class="hljs-string">"煤球"</span>), new Cat(<span class="hljs-string">"橘猫"</span>)}<span class="hljs-comment">;</span>
ArrayHelper.swap(cats, 0, 1)<span class="hljs-comment">;   // ✅</span>
</code></pre>
<blockquote>
<p>🔍 编译器自动“猜类型”，你连 <code>&lt;String&gt;</code> 都不用写！智能如 Siri 🗣️</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">🕵️ 四、泛型的“隐藏技能”：通配符 &amp; 类型擦除</h3>
<h4 data-id="heading-13">1. 通配符 <code>?</code>：模糊搜索，但有边界！</h4>

























<table><thead><tr><th>写法</th><th>含义</th><th>场景</th></tr></thead><tbody><tr><td><code>List&lt;?&gt;</code></td><td>任意类型</td><td>打印任意集合</td></tr><tr><td><code>List&lt;? extends Animal&gt;</code></td><td>Animal 或子类</td><td>宠物医院只看“动物”</td></tr><tr><td><code>List&lt;? super Cat&gt;</code></td><td>Cat 或父类</td><td>接收猫及以上类型</td></tr></tbody></table>
<h5 data-id="heading-14">🐾 宠物医院实战：</h5>
<pre><code class="hljs language-scss" lang="scss">public static void <span class="hljs-built_in">treatCats</span>(List&lt;? extends Cat&gt; cats) {
    for (Cat c : cats) c<span class="hljs-selector-class">.treat</span>(); <span class="hljs-comment">// 波斯猫、狸花猫都行！</span>
}

List&lt;PersianCat&gt; persians = Arrays<span class="hljs-selector-class">.asList</span>(new PersianCat());
<span class="hljs-built_in">treatCats</span>(persians); <span class="hljs-comment">// ✅</span>

<span class="hljs-comment">// treatCats(dogList); // ❌ 泰迪狗进不了猫诊室！</span>
</code></pre>
<hr/>
<h4 data-id="heading-15">2. 类型擦除：编译时戴面具，运行时摘掉 😷</h4>
<p>Java 泛型是 <strong>“伪泛型”</strong> —— 编译后所有 <code>&lt;T&gt;</code> 都会被擦成 <code>Object</code>！</p>
<pre><code class="hljs language-ini" lang="ini">ArrayList&lt;String&gt; <span class="hljs-attr">strList</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
ArrayList&lt;Integer&gt; <span class="hljs-attr">intList</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>

System.out.println(strList.getClass() == intList.getClass())<span class="hljs-comment">; // true!</span>
</code></pre>
<blockquote>
<p>💡 背后原理：编译器偷偷帮你加了 <code>(String)</code> 强转！<br/>
你看到的是安全，背后是 <strong>自动 cast</strong> 在扛雷 ⚡</p>
</blockquote>
<hr/>
<h3 data-id="heading-16">⚠️ 五、泛型“避坑指南”：这些雷千万别踩！</h3>

























<table><thead><tr><th>坑点</th><th>正确做法</th></tr></thead><tbody><tr><td>❌ <code>ArrayList&lt;int&gt;</code></td><td>✅ <code>ArrayList&lt;Integer&gt;</code></td></tr><tr><td>❌ 静态方法用类的 <code>T</code></td><td>✅ 静态方法自己定义 <code>&lt;E&gt;</code></td></tr><tr><td>❌ <code>new T[10]</code></td><td>✅ 用 <code>List&lt;T&gt;</code> 代替数组</td></tr><tr><td>❌ 泛型类继承 <code>Exception</code></td><td>❌ 不支持！别试！</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">🎯 总结：泛型到底好在哪？</h3>
<blockquote>
<p><strong>编译时防错，运行时省心，代码还能复用！</strong></p>
</blockquote>
<p>新手记住这三点就够了：</p>
<ol>
<li><strong>泛型 = 类型参数化</strong> → 给数据贴分类标签；</li>
<li><strong>三种形态</strong>：类、接口、方法，按需选用；</li>
<li><strong>通配符定范围，类型擦除是编译秘密</strong>。</li>
</ol>
<hr/>
<p>下次写集合，别再裸奔 <code>ArrayList</code> 了！<br/>
<strong>加上泛型，就像给快递贴好标签</strong> ——<br/>
从此寄得安心，收得开心，代码优雅如诗 ✨</p>
<hr/>
<blockquote>
<p>📌 <strong>标签建议</strong>（发布时添加）：<br/>
<code>#Java</code> <code>#泛型</code> <code>#编程技巧</code> <code>#代码规范</code> <code>#新手友好</code> <code>#干货分享</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-18">🖼️ 配图描述文案</h3>
<h4 data-id="heading-19">图1：【混乱快递站 vs 智能分拣中心】</h4>
<blockquote>
<p><strong>画面描述</strong>：<br/>
左侧：一个破旧仓库，地上堆满未分类的包裹，有人从标着“零食”的箱子掏出鞋子、键盘、盆栽，一脸崩溃。<br/>
右侧：现代化分拣中心，传送带上每个箱子贴有清晰标签（<code>&lt;String&gt;</code>、<code>&lt;Integer&gt;</code>、<code>&lt;Cat&gt;</code>），机器人精准投递。<br/>
标语：“没有泛型 vs 有泛型”</p>
</blockquote>
<h4 data-id="heading-20">图2：【泛型三大分身角色漫画】</h4>
<blockquote>
<p><strong>画面描述</strong>：</p>
<ul>
<li><strong>泛型类</strong>：一个可变色的收纳盒，标签写着 <code>&lt;T&gt;</code>，里面分别装文具、首饰、小猫。</li>
<li><strong>泛型接口</strong>：一位穿制服的快递主管，手持规则牌：“MessageSender：客户定类型，我来送！”</li>
<li><strong>泛型方法</strong>：一个背着多个包裹的快递员，包裹上写着 <code>&lt;String&gt;</code>、<code>&lt;Integer&gt;</code>，他笑着说：“我啥都能送！”</li>
</ul>
</blockquote>
<h4 data-id="heading-21">图3：【通配符宠物医院流程图】</h4>
<blockquote>
<p><strong>画面描述</strong>：<br/>
一家宠物医院，三个诊室门口挂牌：</p>
<ul>
<li>“🐱 猫科诊室（<code>? extends Cat</code>）” → 波斯猫、狸花猫进入</li>
<li>“🐶 犬科诊室（<code>? extends Dog</code>）” → 泰迪、哈士奇进入</li>
<li>“🐾 综合诊室（<code>? extends Animal</code>）” → 所有动物进入<br/>
一只泰迪试图进猫诊室，被保安拦下：“❌ 不符合类型边界！”</li>
</ul>
</blockquote>
<hr/>
<p><strong>作者</strong>：一位不想再拆出鞋子的 Java 开发<br/>
<strong>喜欢？点赞+收藏+关注，下期带你玩转 Java Stream 流水线！</strong> 💧</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【基础数据篇】数据格式化妆师：Formatter模式]]></title>    <link>https://juejin.cn/post/7577691061033861166</link>    <guid>https://juejin.cn/post/7577691061033861166</guid>    <pubDate>2025-11-30T03:08:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061033861166" data-draft-id="7577971299742433318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【基础数据篇】数据格式化妆师：Formatter模式"/> <meta itemprop="keywords" content="后端,设计模式"/> <meta itemprop="datePublished" content="2025-11-30T03:08:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白衣鸽子"/> <meta itemprop="url" content="https://juejin.cn/user/3072451409619223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【基础数据篇】数据格式化妆师：Formatter模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3072451409619223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白衣鸽子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:08:07.000Z" title="Sun Nov 30 2025 03:08:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>在软件系统中，数据始终存在两种形态：<strong>内部存储形态</strong>与<strong>外部展示形态</strong>。</p>
<p>试想一下这些场景：</p>
<ul>
<li>数据库中存储的时间戳 <code>1640995200000</code>，在用户界面上需要显示为 <code>"2024年1月1日"</code>。</li>
<li>内部计算的金额 <code>19.9</code>（浮点数），在发票上需要格式化为 <code>"￥19.90"</code>。</li>
<li>用于逻辑判断的枚举值 <code>UserStatus.ACTIVE</code>，在日志中需要输出为清晰的 <code>"活跃用户"</code></li>
</ul>
<p>如果将这些格式化逻辑散落、硬编码在业务代码的各个角落，会导致一系列问题：代码重复、难以维护、本地化支持困难，并且破坏了单一职责原则——业务逻辑类不该关心数据该如何显示。</p>
<p><strong>Formatter（格式化器）模式</strong>正是为了解决这一问题而生的。它扮演着一位专业的“化妆师”，将数据的“素颜”（内部格式）根据场景需求，优雅地转换为得体的“妆容”（外部格式），从而实现数据表现与业务逻辑的彻底解耦。</p>
<h2 data-id="heading-1">2. 定义</h2>
<p><strong>Formatter 模式</strong>是一种行为设计模式，它旨在将对象的数据转换为其适合人类阅读或特定协议传输的字符串表示形式，并将字符串解析回对象。该模式的核心是将格式化与解析的逻辑封装在专用的对象中。</p>
<p>该模式通常涉及两个核心操作：</p>
<ol>
<li><strong>格式化：</strong> 将对象 <code>T</code> 转换为字符串 <code>String</code>。</li>
<li><strong>解析：</strong> 将字符串 <code>String</code> 还原为对象 <code>T</code>。</li>
</ol>
<pre><code class="hljs language-text" lang="text">核心思想： Formatter 模式的精髓在于分离关注点。它承认“数据是什么”和“数据如何展示”是两个截然不同的问题。通过引入一个专门的格式化器角色：
1. 领域对象可以保持纯净，只关注自身的业务属性和行为。
2. 格式化逻辑被集中管理和复用，易于统一修改和扩展。
3. 客户端代码无需关心格式化的细节，只需委托给合适的格式化器即可。
</code></pre>
<h2 data-id="heading-2">3. 应用</h2>
<p>Formatter 模式的应用场景无处不在，特别是在需要与用户交互或进行系统间通信的地方。</p>
<h3 data-id="heading-3">3.1 场景一：日期时间格式化</h3>
<p>这是最经典的应用。根据用户所在的地区显示不同格式的日期。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 内部统一使用 java.time 对象</span>
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();

<span class="hljs-comment">// 应用不同的“化妆师”</span>
<span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">chinaFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy年MM月dd日 HH:mm:ss"</span>, Locale.CHINA);
<span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">usFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"MM/dd/yyyy hh:mm a"</span>, Locale.US);

<span class="hljs-type">String</span> <span class="hljs-variable">dateForChina</span> <span class="hljs-operator">=</span> now.format(chinaFormatter); <span class="hljs-comment">// "2024年01月01日 14:30:00"</span>
<span class="hljs-type">String</span> <span class="hljs-variable">dateForUS</span> <span class="hljs-operator">=</span> now.format(usFormatter);       <span class="hljs-comment">// "01/01/2024 02:30 PM"</span>
</code></pre>
<h3 data-id="heading-4">3.2 场景二：数字与货币格式化</h3>
<p>自动处理千分位、小数位数和货币符号。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> <span class="hljs-number">12345.6789</span>;

<span class="hljs-type">NumberFormat</span> <span class="hljs-variable">numberFormat</span> <span class="hljs-operator">=</span> NumberFormat.getNumberInstance(Locale.GERMANY);
<span class="hljs-type">String</span> <span class="hljs-variable">formattedNumber</span> <span class="hljs-operator">=</span> numberFormat.format(price); <span class="hljs-comment">// "12.345,679" - 德国使用点作为千分位，逗号作为小数点</span>

<span class="hljs-type">NumberFormat</span> <span class="hljs-variable">currencyFormat</span> <span class="hljs-operator">=</span> NumberFormat.getCurrencyInstance(Locale.CHINA);
<span class="hljs-type">String</span> <span class="hljs-variable">formattedCurrency</span> <span class="hljs-operator">=</span> currencyFormat.format(price); <span class="hljs-comment">// "￥12,345.68" - 自动四舍五入到两位小数并添加货币符号</span>
</code></pre>
<h3 data-id="heading-5">3.3 场景三：自定义对象格式化</h3>
<p>为领域对象定义专用的格式化器。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-comment">// ... getters</span>
}

<span class="hljs-comment">// 自定义格式化器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFormatter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Formatter</span>&lt;Product&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">print</span><span class="hljs-params">(Product product, Locale locale)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%s - %s"</span>, 
            product.getName(), 
            NumberFormat.getCurrencyInstance(locale).format(product.getPrice()));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">parse</span><span class="hljs-params">(String text, Locale locale)</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-comment">// 实现从字符串解析回Product对象的逻辑</span>
        <span class="hljs-comment">// ... </span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"笔记本电脑"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"5999.99"</span>));
<span class="hljs-type">ProductFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductFormatter</span>();
<span class="hljs-type">String</span> <span class="hljs-variable">displayText</span> <span class="hljs-operator">=</span> formatter.print(product, Locale.CHINA); <span class="hljs-comment">// "笔记本电脑 - ￥5,999.99"</span>
</code></pre>
<h2 data-id="heading-6">4. 开源代码解析</h2>
<p>Formatter 模式在众多开源框架中有着至关重要且优雅的实现。</p>
<h3 data-id="heading-7">4.1 <code>DateTimeFormatter</code>：时间格式化标准实现</h3>
<p>Java 8 引入的日期时间 API 是 Formatter 模式的典范，<code>DateTimeFormatter</code> 的核心是一个不可变对象，它通过组合模式将格式化的步骤分解为不同的职责单元。</p>
<hr/>
<p><code>DateTimeFormatter</code> 的核心状态由以下几个 <code>final</code> 变量定义，确保了其不可变性和线程安全。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeFormatter</span> {
	<span class="hljs-comment">// 1. 格式/解析引擎：承载了模式字符串编译后的指令集，是执行格式化和解析操作的核心。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CompositePrinterParser printerParser;
	
	<span class="hljs-comment">// 2. 地域信息：控制文本（如月份、星期）的显示语言和地区相关的计算规则（如一周的第一天）。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Locale locale;
	
	<span class="hljs-comment">// 3. 数字样式：控制数字相关符号，如小数点、正负号等。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DecimalStyle decimalStyle;
	
	<span class="hljs-comment">// 4. 解析风格：决定解析时的严格程度，如STRICT（严格）、SMART（智能调整）、LENIENT（宽松计算）。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResolverStyle resolverStyle;
	
	<span class="hljs-comment">// 5. 需解析字段集：用于优化性能，指定需要解析和验证的字段集合；为null时表示处理所有字段。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;TemporalField&gt; resolverFields;
	
	<span class="hljs-comment">// 6. 年表（历法）：定义日期背后的日历系统，如ISO、ThaiBuddhist等；为null时使用默认ISO历法。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Chronology chrono;
	
	<span class="hljs-comment">// 7. 默认时区：当被格式化的对象不含时区信息时，使用此时区进行补充；为null则表示不覆盖。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ZoneId zone;
}
</code></pre>
<hr/>
<p><strong>第一步：入口方法 <code>format(TemporalAccessor temporal)</code></strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**  
 * Formats a date-time object using this formatter. 
 * This formats the date-time to a String using the rules of the formatter. 
 * <span class="hljs-doctag">@param</span> temporal  the temporal object to format, not null  
 * <span class="hljs-doctag">@return</span> the formatted string, not null 
 * <span class="hljs-doctag">@throws</span> DateTimeException if an error occurs during formatting  
 */</span><span class="hljs-keyword">public</span> String <span class="hljs-title function_">format</span><span class="hljs-params">(TemporalAccessor temporal)</span> {  
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">32</span>);  
    formatTo(temporal, buf);  
    <span class="hljs-keyword">return</span> buf.toString();  
}
</code></pre>
<ul>
<li><strong>目的</strong>：提供最简洁的API，接受一个日期时间对象，返回格式化后的字符串。</li>
<li><strong>动作</strong>：创建一个 <code>StringBuilder</code> 作为结果容器，然后调用重载的 <code>formatTo</code> 方法。</li>
</ul>
<hr/>
<p><strong>第二步：准备上下文 <code>formatTo(TemporalAccessor temporal, Appendable appendable)</code></strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**  
 * Formats a date-time object to an {<span class="hljs-doctag">@code</span> Appendable} using this formatter. 
 * This outputs the formatted date-time to the specified destination. 
 * {<span class="hljs-doctag">@link</span> Appendable} is a general purpose interface that is implemented by all  
 * key character output classes including {<span class="hljs-doctag">@code</span> StringBuffer}, {<span class="hljs-doctag">@code</span> StringBuilder}, 
 * {<span class="hljs-doctag">@code</span> PrintStream} and {<span class="hljs-doctag">@code</span> Writer}. 
 * Although {<span class="hljs-doctag">@code</span> Appendable} methods throw an {<span class="hljs-doctag">@code</span> IOException}, this method does not. 
 * Instead, any {<span class="hljs-doctag">@code</span> IOException} is wrapped in a runtime exception. 
 * <span class="hljs-doctag">@param</span> temporal  the temporal object to format, not null  
 * <span class="hljs-doctag">@param</span> appendable  the appendable to format to, not null  
 * <span class="hljs-doctag">@throws</span> DateTimeException if an error occurs during formatting  
 */</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">formatTo</span><span class="hljs-params">(TemporalAccessor temporal, Appendable appendable)</span> {  
    Objects.requireNonNull(temporal, <span class="hljs-string">"temporal"</span>);  
    Objects.requireNonNull(appendable, <span class="hljs-string">"appendable"</span>);  
    <span class="hljs-keyword">try</span> {  
        <span class="hljs-type">DateTimePrintContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimePrintContext</span>(temporal, <span class="hljs-built_in">this</span>);  
        <span class="hljs-keyword">if</span> (appendable <span class="hljs-keyword">instanceof</span> StringBuilder) {  
            printerParser.format(context, (StringBuilder) appendable);  
        } <span class="hljs-keyword">else</span> {  
            <span class="hljs-comment">// buffer output to avoid writing to appendable in case of error  </span>
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">32</span>);  
            printerParser.format(context, buf);  
            appendable.append(buf);  
        }  
    } <span class="hljs-keyword">catch</span> (IOException ex) {  
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeException</span>(ex.getMessage(), ex);  
    }  
}
</code></pre>
<ul>
<li><strong>目的</strong>：初始化格式化操作所需的上下文环境。</li>
<li><strong>动作</strong>：创建 <code>DateTimePrintContext</code> 对象
<ul>
<li>要格式化的目标对象 (<code>temporal</code>)</li>
<li>当前格式化器 (<code>this</code>) 的配置信息，如 <code>locale</code>, <code>decimalStyle</code> 等。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>第三步：引擎执行 <code>printerParser.format(context, appendable)</code></strong></p>
<p>这里的 <code>printerParser</code> 是 <code>CompositePrinterParser</code> 的一个实例。</p>
<p><strong><code>CompositePrinterParser</code> 是什么？</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositePrinterParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DateTimePrinterParser</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DateTimePrinterParser[] printerParsers;  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> optional;
}
</code></pre>
<p>当使用 <code>DateTimeFormatter.ofPattern("yyyy-MM-dd")</code> 时，这个模式字符串会被解析并编译成三个子处理器（<code>PrinterParser</code>）：</p>
<ol>
<li>一个用于处理4位年份的 <code>NumberPrinterParser</code></li>
<li>一个用于输出字面量 <code>'-'</code> 的 <code>StringLiteralPrinterParser</code></li>
<li>一个用于处理2位月份的 <code>NumberPrinterParser</code> ... 以此类推。</li>
</ol>
<p><strong><code>format</code> 方法在组合处理器内部：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>  
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">format</span><span class="hljs-params">(DateTimePrintContext context, StringBuilder buf)</span> {  
    <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> buf.length();  
    <span class="hljs-keyword">if</span> (optional) {  
        context.startOptional();  
    }  
    <span class="hljs-keyword">try</span> {  
        <span class="hljs-keyword">for</span> (DateTimePrinterParser pp : printerParsers) {  
            <span class="hljs-keyword">if</span> (pp.format(context, buf) == <span class="hljs-literal">false</span>) {  
                buf.setLength(length);  <span class="hljs-comment">// reset buffer  </span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  
            }  
        }  
    } <span class="hljs-keyword">finally</span> {  
        <span class="hljs-keyword">if</span> (optional) {  
            context.endOptional();  
        }  
    }  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  
}
</code></pre>
<ul>
<li><strong>目的</strong>：按顺序执行组合处理器（<code>CompositePrinterParser</code>）中的所有子处理器（<code>printerParsers</code>），并确保在遇到失败时，如果该组合是一个可选节，能够正确地回滚状态，避免输出部分结果。</li>
<li><strong>补充</strong>：如果这个 <code>CompositePrinterParser</code> 被标记为 <code>optional</code>（例如，由 <code>DateTimeFormatterBuilder.optionalStart()</code> 创建），则通知格式化上下文（<code>DateTimePrintContext</code>）开始一个可选节。在“可选节”内，<code>pp.format(context, buf)</code>这段代码当从 <code>TemporalAccessor</code> 查询字段值时，如果该字段不存在，可能会返回一个“失败”状态，而不是直接抛出异常。这为后续的回滚判断提供了依据。</li>
</ul>
<hr/>
<p><strong>第四步：结合代码示例回顾上面的流程</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 创建一个包含可选节的格式化器</span>
<span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM['XX']"</span>);
<span class="hljs-comment">// 2. 格式化一个LocalDate（没有"XX"需要的数据）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> formatter.format(LocalDate.of(<span class="hljs-number">2024</span>, <span class="hljs-number">5</span>, <span class="hljs-number">24</span>));
System.out.println(result); <span class="hljs-comment">// 输出: 2024-05</span>
</code></pre>
<ol>
<li>初始化 <code>printerParsers</code> 列表 模式 <code>"yyyy-MM['XX']"</code> 被编译成如下结构：</li>
</ol>
<pre><code class="hljs language-java" lang="java">printerParsers = [
    NumberPrinterParser(YEAR),    <span class="hljs-comment">// 处理 yyyy</span>
    StringLiteralPrinterParser(<span class="hljs-string">"-"</span>), <span class="hljs-comment">// 处理 -</span>
    NumberPrinterParser(MONTH),   <span class="hljs-comment">// 处理 MM</span>
    CompositePrinterParser([      <span class="hljs-comment">// 处理 ['XX']，标记为 optional=true</span>
        StringLiteralPrinterParser(<span class="hljs-string">"XX"</span>)
    ], optional=<span class="hljs-literal">true</span>)
]
</code></pre>
<ol start="2">
<li>格式化执行过程
<ul>
<li>前三个处理器正常执行，<code>buf</code> 变为 <code>"2024-05"</code>。</li>
<li>执行可选节 <code>['XX']</code>：
<ul>
<li>记录起点：<code>length = 8</code>（"2024-05"的长度）</li>
<li>执行子处理器 <code>StringLiteralPrinterParser("XX")</code>：
<ul>
<li>直接向 <code>buf</code> 追加 <code>"XX"</code>，<code>buf</code> 变为 <code>"2024-05XX"</code></li>
<li>返回 <code>true</code></li>
</ul>
</li>
</ul>
</li>
<li>循环结束，返回 <code>true</code></li>
</ul>
</li>
<li>最终结果：<code>"2024-05XX"</code></li>
</ol>
<h3 data-id="heading-8">4.2 <code>PatternLayout</code>： 日志系统中的Formatter</h3>
<p>在主流日志框架（如 Logback、Log4j 2）中，负责格式化的组件不叫 <code>Formatter</code>，而叫 <code>Layout</code> 或 <code>Formatter</code>，它的职责就是将一个日志事件（Log Event）转换成一条具体的日志字符串。</p>
<hr/>
<p><strong>第一步：SLF4J使用方式</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 典型的SLF4J使用方式</span>
logger.info(<span class="hljs-string">"订单{}创建成功，金额：{}"</span>, orderId, amount);
</code></pre>
<p><code>logger.info(String format, Object arg1, Object arg2)</code> -&gt; 实际调用的是底层实现（如 Logback）的 <code>Logger</code> 实现类。但在此之前，SLF4J 的门面层会先进行一个关键预处理：<strong>消息格式化</strong>。</p>
<hr/>
<p><strong>第二步：SLF4J 的参数化消息格式化</strong></p>
<p>SLF4J 不会直接将原始消息和参数传递给底层实现。它首先使用 <code>org.slf4j.helpers.MessageFormatter</code> 来将模板和参数合并成一个完整的字符串。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 Logback 的 Logger 实现中（如 ch.qos.logback.classic.Logger）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">info</span><span class="hljs-params">(String format, Object arg1, Object arg2)</span> {
    <span class="hljs-keyword">if</span> (!isInfoEnabled()) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 关键调用：格式化消息</span>
    <span class="hljs-type">FormattingTuple</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> MessageFormatter.arrayFormat(format, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{arg1, arg2});
    <span class="hljs-comment">// 然后调用过滤、追加等核心逻辑</span>
    filterAndLog_0_Or3Plus(<span class="hljs-literal">null</span>, Level.INFO, <span class="hljs-literal">null</span>, ft.getMessage(), ft.getThrowable());
}
</code></pre>
<p> <code>MessageFormatter.arrayFormat</code>：这个方法的核心是循环处理每个 <code>{}</code> 占位符，并将对应的参数值“格式化”成字符串后替换进去。这里的“格式化”非常朴素：对于非空参数，直接调用其 <code>toString()</code> 方法。<code>orderId</code> 和 <code>amount</code> 的 <code>toString()</code> 方法被调用，结果被拼接到字符串中。</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FormattingTuple <span class="hljs-title function_">arrayFormat</span><span class="hljs-params">(String messagePattern, Object[] argArray)</span> {  
    <span class="hljs-type">Throwable</span> <span class="hljs-variable">throwableCandidate</span> <span class="hljs-operator">=</span> getThrowableCandidate(argArray);  
    Object[] args = argArray;  
    <span class="hljs-keyword">if</span> (throwableCandidate != <span class="hljs-literal">null</span>) {  
        args = trimmedCopy(argArray);  
    }  
  
    <span class="hljs-keyword">return</span> arrayFormat(messagePattern, args, throwableCandidate);  
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FormattingTuple <span class="hljs-title function_">arrayFormat</span><span class="hljs-params">(String messagePattern, Object[] argArray, Throwable throwable)</span> {  
    <span class="hljs-keyword">if</span> (messagePattern == <span class="hljs-literal">null</span>) {  
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>((String)<span class="hljs-literal">null</span>, argArray, throwable);  
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argArray == <span class="hljs-literal">null</span>) {  
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>(messagePattern);  
    } <span class="hljs-keyword">else</span> {  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sbuf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(messagePattern.length() + <span class="hljs-number">50</span>);  
  
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">L</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; L &lt; argArray.length; ++L) {  
            <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> messagePattern.indexOf(<span class="hljs-string">"{}"</span>, i);  
            <span class="hljs-keyword">if</span> (j == -<span class="hljs-number">1</span>) {  
                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) {  
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>(messagePattern, argArray, throwable);  
                }  
  
                sbuf.append(messagePattern, i, messagePattern.length());  
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>(sbuf.toString(), argArray, throwable);  
            }  
  
            <span class="hljs-keyword">if</span> (isEscapedDelimeter(messagePattern, j)) {  
                <span class="hljs-keyword">if</span> (!isDoubleEscaped(messagePattern, j)) {  
                    --L;  
                    sbuf.append(messagePattern, i, j - <span class="hljs-number">1</span>);  
                    sbuf.append(<span class="hljs-string">'{'</span>);  
                    i = j + <span class="hljs-number">1</span>;  
                } <span class="hljs-keyword">else</span> {  
                    sbuf.append(messagePattern, i, j - <span class="hljs-number">1</span>);  
                    deeplyAppendParameter(sbuf, argArray[L], <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());  
                    i = j + <span class="hljs-number">2</span>;  
                }  
            } <span class="hljs-keyword">else</span> {  
                sbuf.append(messagePattern, i, j);  
                deeplyAppendParameter(sbuf, argArray[L], <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());  
                i = j + <span class="hljs-number">2</span>;  
            }  
        }  
  
        sbuf.append(messagePattern, i, messagePattern.length());  
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>(sbuf.toString(), argArray, throwable);  
    }  
}
</code></pre>
<hr/>
<p><strong>第三步：构建日志事件 (<code>ILoggingEvent</code>) 并交由 Logback 的 <code>Layout</code></strong></p>
<p>第二步结束时，我们停在了 Logback 的 <code>Logger</code> 实现类中的 <code>filterAndLog_0_Or3Plus</code> 方法。这个方法名看起来很复杂，但它本质上是日志记录的核心路由方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 ch.qos.logback.classic.Logger 中</span>
<span class="hljs-comment">// 这是一个处理日志事件的核心方法</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">filterAndLog_0_Or3Plus</span><span class="hljs-params">(String localFQCN, Level level, Marker marker, String msg, Object[] params, Throwable t)</span> {

    <span class="hljs-comment">// 检查过滤器链，如果被拒绝则直接返回</span>
    <span class="hljs-type">FilterReply</span> <span class="hljs-variable">decision</span> <span class="hljs-operator">=</span> loggerContext.getTurboFilterChainDecision_0_3OrMore(marker, <span class="hljs-built_in">this</span>, level, msg, params, t);
    <span class="hljs-keyword">if</span> (decision == FilterReply.DENY) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 最关键的一行：构建日志事件 (ILoggingEvent)</span>
    <span class="hljs-type">LoggingEvent</span> <span class="hljs-variable">loggingEvent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingEvent</span>(localFQCN, <span class="hljs-built_in">this</span>, level, msg, t, params);

    <span class="hljs-comment">// 继续后续的日志记录流程</span>
    <span class="hljs-keyword">if</span> (decision != FilterReply.NEUTRAL) {
        <span class="hljs-comment">// 如果过滤器明确接受，则直接记录，跳过级别检查</span>
        log(<span class="hljs-literal">null</span>, localFQCN, level, marker, msg, params, t);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 否则，进行常规的级别检查后记录</span>
        <span class="hljs-keyword">if</span> (isEnabledFor(level, marker)) {
            log(loggingEvent, localFQCN, level, marker, msg, params, t);
        }
    }
}
</code></pre>
<p>在构建 <code>LoggingEvent</code> 时，它存储的是<strong>原始的、未格式化的消息模板</strong> (<code>message</code>) 和<strong>参数数组</strong> (<code>argArray</code>)，而不是第二步中 <code>MessageFormatter</code> 生成的那个完整字符串。在 <code>LoggingEvent</code> 类中，有一个 <code>getFormattedMessage()</code> 方法，可以实现延迟计算获取消息的逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 ch.qos.logback.classic.LoggingEvent 中</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">LoggingEvent</span><span class="hljs-params">(String fqcn, Logger logger, Level level, String message, Throwable throwable, Object[] argArray)</span> {
    <span class="hljs-built_in">this</span>.fqcn = fqcn;
    <span class="hljs-built_in">this</span>.logger = logger;
    <span class="hljs-built_in">this</span>.level = level;
    <span class="hljs-built_in">this</span>.message = message;   <span class="hljs-comment">// 注意：这里存的是原始消息模板 "订单{}创建成功，金额：{}"</span>
    <span class="hljs-built_in">this</span>.throwable = throwable;
    <span class="hljs-built_in">this</span>.argArray = argArray; <span class="hljs-comment">// 以及参数数组 [orderId, amount]</span>
    <span class="hljs-built_in">this</span>.timeStamp = System.currentTimeMillis(); <span class="hljs-comment">// 记录时间戳</span>
    <span class="hljs-built_in">this</span>.threadName = Thread.currentThread().getName(); <span class="hljs-comment">// 记录线程名</span>
    <span class="hljs-comment">// ... 其他初始化</span>
}
</code></pre>
<hr/>
<p><strong>第四步：<code>Layout</code> 的格式化 (<code>PatternLayout.doLayout</code>)</strong></p>
<p><code>Layout</code>（通常是 <code>PatternLayout</code>）的职责是将整个 <code>ILoggingEvent</code> 对象格式成一整行有特定格式的日志字符串。假设配置的模式是：<code>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger - %msg%n</code></p>
<p><strong><code>PatternLayout</code> 的工作流程：</strong></p>
<ol>
<li><strong>解析模式字符串</strong>：将 <code>%d</code>、<code>%thread</code>、<code>%msg</code> 等转换符解析出来。</li>
<li><strong>构建转换器链</strong>：为每个转换符创建一个对应的 <code>Converter</code> 对象，并链接起来。</li>
<li><strong>遍历转换器链</strong>：依次调用每个 <code>Converter</code> 的 <code>write</code> 方法。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PatternLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractStringLayout</span> {  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_CONVERSION_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"%m%n"</span>;  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TTCC_CONVERSION_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"%r [%t] %p %c %notEmpty{%x }- %m%n"</span>;  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SIMPLE_CONVERSION_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"%d [%t] %p %c - %m%n"</span>;  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Converter"</span>;  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String conversionPattern;  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PatternSelector patternSelector;  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AbstractStringLayout.Serializer eventSerializer;
    
    <span class="hljs-comment">//...</span>
}
</code></pre>
<p><strong>PatternLayoutBase 的核心方法如下：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">writeLoopOnConverters</span><span class="hljs-params">(E event)</span> {
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">strBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">128</span>);
    Converter&lt;E&gt; c = headConverter;
    <span class="hljs-keyword">while</span> (c != <span class="hljs-literal">null</span>) {
        c.write(strBuilder, event); <span class="hljs-comment">// 委托给每个转换器</span>
        c = c.getNext();
    }
    <span class="hljs-keyword">return</span> strBuilder.toString();
}
</code></pre>
<p><strong>以 <code>%msg</code> 对应的 <code>MessageConverter</code> 为例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageConverter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Converter</span>&lt;ILoggingEvent&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(StringBuilder buf, ILoggingEvent event)</span> {
        <span class="hljs-comment">// 直接追加在第一步中由 MessageFormatter 生成好的消息字符串</span>
        buf.append(event.getFormattedMessage());
    }
}
</code></pre>
<p><strong>以 <code>%d</code> 对应的 <code>DateConverter</code> 为例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateConverter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Converter</span>&lt;ILoggingEvent&gt; {
    <span class="hljs-keyword">private</span> DateTimeFormatter dtf; <span class="hljs-comment">// 内部使用 java.time.format.DateTimeFormatter</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(StringBuilder buf, ILoggingEvent event)</span> {
        <span class="hljs-keyword">if</span> (dtf == <span class="hljs-literal">null</span>) {
            dtf = DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">dateStr</span> <span class="hljs-operator">=</span> dtf.format(<span class="hljs-comment">/* 从event中获取时间戳并转换 */</span>);
        buf.append(dateStr);
    }
}
</code></pre>
<p>最终，所有这些 <code>Converter</code> 的输出被拼接起来，形成最终日志行： <code>2024-05-24 14:30:00 [http-nio-8080-exec-1] INFO c.example.OrderService - 订单12345创建成功，金额：99.99</code></p>
<h2 data-id="heading-9">5. 总结</h2>
<p>Formatter 模式的本质远不止是简单的字符串拼接或类型转换。其核心设计思想是：在数据的内部表示与外部表示之间建立一个双向的“转换层”，从而将格式化和解析的复杂逻辑封装起来，实现对数据表现形式的管理、控制和扩展。</p>
<p>它深刻体现了以下几个经典设计模式的思想：</p>
<ol>
<li><strong>策略模式：</strong> <code>Formatter</code> 接口定义了一个可互换的算法家族。针对同一类型（如 <code>Date</code>），可以有多种格式化策略（如 <code>ISO</code> 格式、中文格式、自定义格式）。系统可以根据上下文（如注解、区域设置）轻松地切换不同的策略，而无需修改客户端代码。</li>
<li><strong>装饰器模式：</strong> 可以将原始的对象到字符串的转换（如 <code>toString()</code>）视作基础功能。而 <code>Formatter</code> 在其之上“装饰”了更强大的能力，如<strong>本地化支持</strong>、<strong>模式化输出</strong>和<strong>异常处理</strong>，从而提供了更丰富、更健壮的转换行为，同时保持了客户端调用接口的简洁性。</li>
<li><strong>工厂模式：</strong> 在注解驱动的场景下（如 <code>@DateTimeFormat</code>），<code>AnnotationFormatterFactory</code> 扮演了<strong>抽象工厂</strong>的角色。它根据字段上的元数据（注解）动态地创建和配置具体的 <code>Formatter</code> 实例，将对象的创建逻辑与使用逻辑彻底解耦，实现了高度的灵活性。</li>
</ol>
<p><strong>核心价值：</strong> 将“数据表示转换”这一常见需求，从一个容易出错、散布各处的过程式代码，提升为一个可复用、可配置、可测试的架构性组件。</p>
<hr/>
<p><strong>思考与探讨</strong></p>
<ol>
<li>
<p><strong>格式化的边界在哪里：</strong> Formatter 应该只负责“表现层”的格式（如日期显示为 <code>yyyy-MM-dd</code>），还是可以包含“业务逻辑”的转换（如将订单状态枚举 <code>PAID</code> 显示为“已支付”）？</p>
</li>
<li>
<p><strong>性能与资源的权衡：</strong> 像 <code>DateTimeFormatter</code> 这样的线程安全、不可变对象，创建成本较高，因此需要复用。在 Web 等高并发场景下，你是如何管理和缓存 Formatter 实例的？</p>
</li>
</ol>
<hr/>
<p><strong>下一篇预告：</strong> 在下一篇文章 《【基础数据篇】数据等价裁判：Comparer模式》中，我们将探讨 <code>equals</code>、<code>hashCode</code> 与 <code>Comparator</code> 如何协同工作，为集合操作、排序和唯一性判断建立可靠的标准，并深入解析其在构建稳定、可预测的软件系统中所扮演的基石角色。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写Spring事务框架：200行代码揭开@Transactional的神秘面纱（ 附完整源代码）]]></title>    <link>https://juejin.cn/post/7577690150093242408</link>    <guid>https://juejin.cn/post/7577690150093242408</guid>    <pubDate>2025-11-30T03:23:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093242408" data-draft-id="7577690150093226024" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写Spring事务框架：200行代码揭开@Transactional的神秘面纱（ 附完整源代码）"/> <meta itemprop="keywords" content="Spring,Spring Boot,Spring Cloud"/> <meta itemprop="datePublished" content="2025-11-30T03:23:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写Spring事务框架：200行代码揭开@Transactional的神秘面纱（ 附完整源代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:23:57.000Z" title="Sun Nov 30 2025 03:23:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>之前我在项目里写过好几篇关于事务的文章，比如在mall商城里怎么用@Transactional、碰到哪些诡异的坑、事务传播行为REQUIRED和REQUIRES_NEW的区别啥的。但说实话，每次写完都觉得有点虚，总感觉是在"知道怎么用"和"理解为什么"之间打转。</p>
<p>后来我就想，干脆自己手写一个简化版的事务框架吧，把Spring那套@Transactional的核心逻辑剥出来，看看到底是咋回事。这不，花了半天时间（对，就半天），用JDK+JDBC撸了个200来行的事务管理框架，还真就跑通了。</p>
<p>今天这篇文章，就把这个过程和踩的坑分享给大家。</p>
<h2 data-id="heading-1">为什么要手写？看源码不香吗？</h2>
<p>有同学可能会问：Spring源码就在那，为啥不直接看？</p>
<p>我当时也这么想过，但看Spring事务源码有个问题 —— <strong>抽象层太多了</strong>。什么PlatformTransactionManager、TransactionDefinition、TransactionStatus，一层套一层，看着看着就晕了，很难抓住本质。</p>
<p>后来我换了个思路：<strong>先自己实现最简单能跑通的版本，再去对比Spring的实现</strong>。这样反而更清楚哪些是核心逻辑，哪些是为了扩展性做的设计。</p>
<p>就像学做菜，你得先会做个西红柿炒蛋，再去研究米其林大厨的番茄料理，对吧？</p>
<h2 data-id="heading-2">事务的本质到底是啥？</h2>
<p>我们先把Spring那套复杂的东西放一边，想想事务在数据库层面到底是咋回事。</p>
<p>其实就三步：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> dataSource.getConnection();
conn.setAutoCommit(<span class="hljs-literal">false</span>);  <span class="hljs-comment">// 关键：关闭自动提交</span>

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行你的SQL操作</span>
    insertOrder(...);
    insertOrderItems(...);
    
    conn.commit();  <span class="hljs-comment">// 成功就提交</span>
} <span class="hljs-keyword">catch</span> (Exception e) {
    conn.rollback();  <span class="hljs-comment">// 失败就回滚</span>
} <span class="hljs-keyword">finally</span> {
    conn.setAutoCommit(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 记得恢复</span>
    conn.close();
}
</code></pre>
<p>看，就这么简单！<strong>事务的本质就是把Connection的自动提交关了，然后你手动控制commit还是rollback</strong>。</p>
<p>那Spring的@Transactional做了啥？无非就是帮你把这个try-catch-finally的模板代码给封装了，你只要打个注解就行。</p>
<p>明白这点之后，我们的目标就清晰了：<strong>用AOP拦截带@Transactional注解的方法，在方法执行前后自动加上这套逻辑</strong>。</p>
<h2 data-id="heading-3">整体设计：分层要清晰</h2>
<p>我当时设计的时候，参考了Spring的思路，把职责分了几层：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[业务代码] --&gt; B[动态代理 ProxyFactory]
    B --&gt; C[事务拦截器 TransactionInterceptor]
    C --&gt; D[事务管理器 TransactionManager]
    D --&gt; E[事务上下文 TransactionContext]
    E --&gt; F[数据库连接 Connection]
    
    style C fill:#f9f,stroke:#333,stroke-width:2px
    style E fill:#bbf,stroke:#333,stroke-width:2px
</code></pre>
<p><strong>几个核心组件：</strong></p>
<ol>
<li><strong>@Transactional注解</strong>：标记哪些方法需要事务</li>
<li><strong>ProxyFactory</strong>：用JDK动态代理给你的业务类套一层</li>
<li><strong>TransactionInterceptor</strong>：拦截器，真正干活的地方</li>
<li><strong>TransactionManager</strong>：管理事务的开启、提交、回滚</li>
<li><strong>TransactionContext</strong>：用ThreadLocal保存当前线程的事务信息</li>
</ol>
<p>这个分层其实就是Spring的简化版，但麻雀虽小五脏俱全。</p>
<h2 data-id="heading-4">先从最简单的开始：注解定义</h2>
<p>注解部分很简单，就几个属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target({ElementType.METHOD, ElementType.TYPE})</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Transactional {
    Propagation <span class="hljs-title function_">propagation</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> Propagation.REQUIRED;
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] rollbackFor() <span class="hljs-keyword">default</span> {};
    <span class="hljs-type">int</span> <span class="hljs-title function_">timeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> -<span class="hljs-number">1</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">readOnly</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Propagation</span> {
    REQUIRED,   <span class="hljs-comment">// 有事务就加入，没有就新建</span>
    SUPPORTS    <span class="hljs-comment">// 有事务就加入，没有就算了</span>
}
</code></pre>
<p>这里我只实现了REQUIRED和SUPPORTS，因为这俩最常用。REQUIRES_NEW、NESTED那些留到第二阶段再说。</p>
<h2 data-id="heading-5">关键中的关键：ThreadLocal管理事务上下文</h2>
<p>这块是我当时花时间最多的地方。为什么要用ThreadLocal？</p>
<p>想想这个场景：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外层方法</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    insertOrder();
    innerMethod();  <span class="hljs-comment">// 调用内层方法</span>
}

<span class="hljs-comment">// 内层方法</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
    insertOrderItems();
}
</code></pre>
<p>外层和内层都有@Transactional，它们应该<strong>共享同一个数据库连接</strong>，要么一起提交，要么一起回滚。怎么做到的？</p>
<p>答案就是ThreadLocal。每个线程持有自己的ConnectionHolder，里面放着Connection和各种状态信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ConnectionHolder&gt; CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    
    <span class="hljs-comment">// 开启事务：绑定连接到当前线程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindNewConnection</span><span class="hljs-params">(DataSource ds, <span class="hljs-type">boolean</span> readOnly, Integer timeout)</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> ds.getConnection();
        conn.setAutoCommit(<span class="hljs-literal">false</span>);  <span class="hljs-comment">// 关闭自动提交</span>
        conn.setReadOnly(readOnly);
        
        <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionHolder</span>(conn);
        holder.setActive(<span class="hljs-literal">true</span>);
        CONTEXT.set(holder);  <span class="hljs-comment">// 绑定到ThreadLocal</span>
    }
    
    <span class="hljs-comment">// 获取当前线程的连接</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getCurrentConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> CONTEXT.get();
        <span class="hljs-keyword">return</span> holder != <span class="hljs-literal">null</span> ? holder.getConnection() : <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">// 清理资源</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> CONTEXT.get();
        <span class="hljs-keyword">if</span> (holder != <span class="hljs-literal">null</span>) {
            holder.getConnection().setReadOnly(<span class="hljs-literal">false</span>);
            holder.getConnection().setAutoCommit(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 恢复自动提交</span>
            holder.getConnection().close();
        }
        CONTEXT.remove();  <span class="hljs-comment">// 这个很重要，防止内存泄漏</span>
    }
}
</code></pre>
<p>这里有个坑我当时被折腾惨了：<strong>一定要记得ThreadLocal.remove()</strong>。</p>
<p>我一开始没加这行，在多线程测试的时候，发现有的线程会莫名其妙拿到别的线程的连接，查了半天才发现是因为Tomcat的线程池会复用线程，如果你不remove，上一次的ConnectionHolder就还在那。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 线程1
    participant ThreadLocal
    participant 线程池
    
    线程1-&gt;&gt;ThreadLocal: set(holder1)
    线程1-&gt;&gt;线程1: 执行业务
    线程1-&gt;&gt;ThreadLocal: 忘记remove()
    线程1-&gt;&gt;线程池: 归还线程
    
    Note over 线程池,ThreadLocal: 线程1被复用执行新任务
    
    线程池-&gt;&gt;线程1: 分配给新任务
    线程1-&gt;&gt;ThreadLocal: get()
    ThreadLocal--&gt;&gt;线程1: 返回holder1 (旧的!)
    
    Note over 线程1: 悲剧：拿到上次的连接
</code></pre>
<p>所以我的建议是：<strong>在finally块里统一清理，无论commit还是rollback</strong>。</p>
<h2 data-id="heading-6">拦截器：整个框架的灵魂</h2>
<p>拦截器是整个框架最复杂的部分，因为它要处理各种情况。我们来看看核心逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
    <span class="hljs-comment">// 1. 解析@Transactional注解</span>
    <span class="hljs-type">TransactionAttribute</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span> parseAnnotation(method, target.getClass());
    <span class="hljs-keyword">if</span> (attr == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> method.invoke(target, args);  <span class="hljs-comment">// 没注解直接执行</span>
    }
    
    <span class="hljs-comment">// 2. 判断是否已经有事务</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">existing</span> <span class="hljs-operator">=</span> TransactionContext.isActive();
    <span class="hljs-type">boolean</span> <span class="hljs-variable">started</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 3. REQUIRED传播：没事务就新建</span>
    <span class="hljs-keyword">if</span> (attr.getPropagation() == Propagation.REQUIRED &amp;&amp; !existing) {
        txManager.begin(attr.isReadOnly(), attr.getTimeout());
        started = <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 4. 执行业务方法</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
        
        <span class="hljs-comment">// 5. 正常返回：提交</span>
        <span class="hljs-keyword">if</span> (started) {
            <span class="hljs-keyword">if</span> (TransactionContext.isRollbackOnly()) {
                txManager.rollback();  <span class="hljs-comment">// 有人标记了回滚</span>
            } <span class="hljs-keyword">else</span> {
                txManager.commit();
            }
        }
        <span class="hljs-keyword">return</span> result;
        
    } <span class="hljs-keyword">catch</span> (InvocationTargetException e) {
        <span class="hljs-type">Throwable</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> e.getTargetException();
        
        <span class="hljs-comment">// 6. 判断是否要回滚</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldRollback</span> <span class="hljs-operator">=</span> (ex <span class="hljs-keyword">instanceof</span> RuntimeException || ex <span class="hljs-keyword">instanceof</span> Error)
            || matchRollbackFor(ex, attr.getRollbackFor());
        
        <span class="hljs-keyword">if</span> (shouldRollback) {
            <span class="hljs-keyword">if</span> (started) {
                txManager.rollback();  <span class="hljs-comment">// 我开启的事务，我负责回滚</span>
            } <span class="hljs-keyword">else</span> {
                TransactionContext.setRollbackOnly();  <span class="hljs-comment">// 标记给外层回滚</span>
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (started) {
                txManager.commit();  <span class="hljs-comment">// 受检异常默认提交</span>
            }
        }
        
        <span class="hljs-keyword">throw</span> ex;
    }
}
</code></pre>
<p>这里面有几个点要注意：</p>
<h3 data-id="heading-7">1. 异常回滚规则</h3>
<p>Spring的默认规则是：</p>
<ul>
<li><strong>RuntimeException和Error</strong>：回滚</li>
<li><strong>受检异常（Exception）</strong>：提交</li>
</ul>
<p>为什么这样设计？我理解是因为受检异常一般是可预期的业务异常，不应该导致整个事务回滚。但你可以通过rollbackFor显式指定：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 现在所有异常都回滚</span>
}
</code></pre>
<h3 data-id="heading-8">2. 内外层事务的协作</h3>
<p>这是个容易搞混的地方。假设外层开启了事务，内层也有@Transactional，内层抛异常了咋办？</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 外层方法
    participant 内层方法
    participant TransactionContext
    
    外层方法-&gt;&gt;TransactionContext: begin() 开启事务
    外层方法-&gt;&gt;内层方法: 调用
    内层方法-&gt;&gt;内层方法: 发现已有事务，加入
    内层方法-&gt;&gt;内层方法: 执行SQL
    内层方法--&gt;&gt;外层方法: 抛异常
    内层方法-&gt;&gt;TransactionContext: setRollbackOnly() 打标记
    外层方法-&gt;&gt;外层方法: catch到异常
    外层方法-&gt;&gt;TransactionContext: commit() 时检查标记
    TransactionContext-&gt;&gt;TransactionContext: 发现rollbackOnly=true
    TransactionContext-&gt;&gt;TransactionContext: 执行rollback
</code></pre>
<p>关键点：<strong>内层不能直接rollback，只能打个标记，让外层来统一处理</strong>。否则外层还想commit的时候，连接已经被回滚了，就乱套了。</p>
<h2 data-id="heading-9">一个被我忽略的坑：并发唯一键冲突</h2>
<p>写测试用例的时候，我犯了个低级错误。订单号我用时间戳生成的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ORD"</span> + System.currentTimeMillis();
</code></pre>
<p>结果多线程测试的时候，经常报唯一键冲突。后来想想也对，currentTimeMillis()精度才到毫秒，并发一高肯定会重复。</p>
<p>后来改成UUID就好了：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ORD-"</span> + UUID.randomUUID();
</code></pre>
<p>这个坑虽然简单，但提醒我们：<strong>生产环境的业务主键一定要用分布式ID生成器</strong>，比如雪花算法、号段模式啥的。时间戳这种玩具级别的方案真不能用。</p>
<h2 data-id="heading-10">几个要注意的地方</h2>
<h3 data-id="heading-11">1. 同类方法调用不生效</h3>
<p>这个是Spring事务的经典问题，我这个简化版也一样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> {
        methodB();  <span class="hljs-comment">// 这样调用，methodB的@Transactional不生效</span>
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>为啥？因为代理只能拦截<strong>从外部进来的调用</strong>，内部调用走的是this，不经过代理。</p>
<p>解决办法：</p>
<ul>
<li>要么拆到不同的类</li>
<li>要么通过注入的方式拿到代理对象自己</li>
</ul>
<h3 data-id="heading-12">2. 资源清理一定要放finally</h3>
<p>我一开始把clear()放在commit()和rollback()里，结果有些异常场景资源没释放，连接池很快就耗尽了。</p>
<p>后来统一放到finally块：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (holder.isRollbackOnly()) {
        conn.rollback();
    } <span class="hljs-keyword">else</span> {
        conn.commit();
    }
} <span class="hljs-keyword">finally</span> {
    TransactionContext.clear();  <span class="hljs-comment">// 无论如何都要清理</span>
}
</code></pre>
<h3 data-id="heading-13">3. 注解解析的优先级</h3>
<p>方法级注解 &gt; 类级注解 &gt; 接口方法注解</p>
<p>这个顺序要记住，面试可能会问。</p>
<h2 data-id="heading-14">测试验证：眼见为实</h2>
<p>写完代码，我跑了几个测试场景：</p>
<p><strong>场景1：正常提交</strong></p>
<pre><code class="hljs language-java" lang="java">service.placeOrder(<span class="hljs-string">"U1001"</span>, <span class="hljs-string">"SKU-001"</span>, <span class="hljs-number">2</span>);
<span class="hljs-comment">// 数据库查询：有记录 </span>
</code></pre>
<p><strong>场景2：运行时异常回滚</strong></p>
<pre><code class="hljs language-java" lang="java">service.placeOrder(<span class="hljs-string">"U1002"</span>, <span class="hljs-string">"OUT_OF_STOCK"</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">// 内部抛RuntimeException</span>
<span class="hljs-comment">// 数据库查询：无记录 </span>
</code></pre>
<p><strong>场景3：受检异常需要rollbackFor</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 抛Exception也会回滚 </span>
}
</code></pre>
<p><strong>场景4：传播行为REQUIRED</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    insertOrder();
    innerMethod();  <span class="hljs-comment">// 共享同一个事务</span>
}

<span class="hljs-comment">// 内层抛异常，外层也回滚 </span>
</code></pre>
<p><strong>场景5：多线程隔离</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 开5个线程并发下单</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
    executor.submit(() -&gt; service.placeOrder(...));
}
<span class="hljs-comment">// 每个线程独立的事务，互不影响 </span>
</code></pre>
<p>这几个场景跑下来，基本的事务功能就都验证了。</p>
<h2 data-id="heading-15">和Spring事务的对比</h2>
<p>写完之后，我又回去看了下Spring的源码，发现我这个简化版其实抓住了核心：</p>








































<table><thead><tr><th>功能</th><th>我的实现</th><th>Spring实现</th></tr></thead><tbody><tr><td>注解驱动</td><td>@Transactional</td><td>@Transactional</td></tr><tr><td>代理方式</td><td>JDK动态代理</td><td>JDK + CGLIB</td></tr><tr><td>传播行为</td><td>REQUIRED, SUPPORTS</td><td>7种传播行为</td></tr><tr><td>回滚规则</td><td>RuntimeException/Error + rollbackFor</td><td>同左</td></tr><tr><td>线程隔离</td><td>ThreadLocal</td><td>同左</td></tr><tr><td>资源管理</td><td>手动clear</td><td>TransactionSynchronizationManager</td></tr></tbody></table>
<p>Spring多的那些抽象层，主要是为了：</p>
<ul>
<li>支持更多传播行为（REQUIRES_NEW需要挂起当前事务）</li>
<li>支持JTA分布式事务</li>
<li>支持多种持久化框架（Hibernate、JPA等）</li>
<li>提供编程式事务API</li>
</ul>
<p>但<strong>核心原理是一样的</strong>：ThreadLocal + AOP + Connection控制。</p>
<h2 data-id="heading-16">现在明白了，下一步该干啥？</h2>
<p>现在我对Spring事务的理解，从"会用"升级到了"知道为什么"。下一步我打算：</p>
<ol>
<li><strong>加入CGLIB支持</strong>：现在只能代理接口，无接口的类还不行</li>
<li><strong>实现REQUIRES_NEW</strong>：这个需要挂起当前事务，涉及到事务栈的管理</li>
<li><strong>加入Druid监控</strong>：看看事务执行耗时、连接获取情况</li>
<li><strong>研究分布式事务</strong>：从2PC到TCC到Seata，慢慢啃</li>
</ol>
<p>说实话，分布式事务那块我还没研究透，Seata的AT模式看着有点懵，准备先把原理摸清楚再说。</p>
<h2 data-id="heading-17">写在最后</h2>
<p>这次手写事务框架，最大的收获是：<strong>不要怕造轮子</strong>。</p>
<p>很多时候我们会觉得"Spring都实现了，我还造啥轮子"。但其实，自己动手实现一遍，和只看源码、看文档，理解深度完全不一样。</p>
<p>就像我现在，以后看到@Transactional，脑子里能直接浮现出那个invoke方法、ThreadLocal的上下文、commit和rollback的逻辑，这种感觉还是挺爽的。</p>
<p>而且，这200行代码写完，我对事务相关的面试题基本都能答上来了：</p>
<ul>
<li>事务传播行为是啥？</li>
<li>为什么同类方法调用事务不生效？</li>
<li>受检异常默认不回滚是为啥？</li>
<li>多线程情况下事务怎么隔离？</li>
</ul>
<p>这些问题，以前是靠背，现在是真懂了。</p>
<p>代码我放到gitee了（链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsimple-spring-transaction" target="_blank" title="https://gitee.com/sh_wangwanbao/simple-spring-transaction" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a> )
有兴趣的同学可以clone下来跑跑看。下一篇我打算写REQUIRES_NEW的实现，涉及到事务挂起和恢复，应该会更有意思。</p>
<hr/>
<p><strong>你们在用事务的时候，踩过哪些坑？欢迎评论区聊聊，说不定能帮我避免后面的一些问题。</strong></p>
<p>如果文章对您有帮助，辛苦点个赞支持下呗。您的支持，是我创作的最大动力，谢谢。</p>
<p>下篇文章见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5个测试用例带你彻底理解Spring事务传播行为（ 附完整源代码）]]></title>    <link>https://juejin.cn/post/7577690150093291560</link>    <guid>https://juejin.cn/post/7577690150093291560</guid>    <pubDate>2025-11-30T03:35:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093291560" data-draft-id="7577713754563215412" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5个测试用例带你彻底理解Spring事务传播行为（ 附完整源代码）"/> <meta itemprop="keywords" content="Spring,Spring Boot,Spring Cloud"/> <meta itemprop="datePublished" content="2025-11-30T03:35:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5个测试用例带你彻底理解Spring事务传播行为（ 附完整源代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:35:27.000Z" title="Sun Nov 30 2025 03:35:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">5个测试用例带你彻底理解Spring事务传播行为（ 附完整源代码）</h2>
<h3 data-id="heading-1">写在前面</h3>
<p>说实话，Spring事务传播行为这块，我之前一直是半懂不懂的状态。</p>
<p>面试的时候能背出来7种传播行为，REQUIRED、REQUIRES_NEW、NESTED啥的，但要问我"内层方法抛异常，外层会不会回滚"，我就开始心虚了。看网上的文章，要么太理论讲不清楚，要么直接贴Spring源码让人更晕。</p>
<p>后来我干脆自己手写了个简化版的事务框架（上篇文章写过），把核心逻辑剥出来，然后写了5个测试用例，一个个跑一遍。现在可以拍着胸脯说：<strong>事务传播这块，我是真懂了</strong>。</p>
<p>今天这篇文章，就带你通过这5个测试用例，把事务传播行为彻底搞明白。</p>
<h3 data-id="heading-2">为什么传播行为这么难理解？</h3>
<p>我觉得主要是两个原因：</p>
<ol>
<li>
<p><strong>场景太抽象</strong>：文档里说"有事务就加入，没有就新建"，但"加入"到底是啥意思？共享一个连接？还是开个子事务？</p>
</li>
<li>
<p><strong>异常处理复杂</strong>：内层方法抛异常，外层要不要回滚？内层回滚了，外层还能提交吗？这些边界情况很容易搞混。</p>
</li>
</ol>
<p>所以我的思路是：<strong>用实际代码跑一遍，看看数据库里到底有没有数据，比看一万字的文档都管用</strong>。</p>
<h3 data-id="heading-3">测试环境准备</h3>
<p>为了让大家能直接复现，我先说说环境：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 数据库：MySQL 8.x</span>
<span class="hljs-keyword">CREATE</span> DATABASE sst_demo;

<span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
  id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
  order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
  user_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 订单明细表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_items (
  id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
  order_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  sku <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  quantity <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);
</code></pre>
<p>业务场景就是下单：插入订单主表 + 插入明细表，这两步要么都成功，要么都失败。</p>
<h3 data-id="heading-4">测试1：正常提交 - 最基础的场景</h3>
<h4 data-id="heading-5">代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(String userId, String sku, <span class="hljs-type">int</span> quantity)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> TransactionContext.getCurrentConnection();
    
    <span class="hljs-comment">// 1. 插入订单</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ORD-"</span> + UUID.randomUUID();
    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> conn.prepareStatement(
        <span class="hljs-string">"INSERT INTO orders(order_no, user_id, total_amount) VALUES(?, ?, ?)"</span>
    );
    ps.setString(<span class="hljs-number">1</span>, orderNo);
    ps.setString(<span class="hljs-number">2</span>, userId);
    ps.setBigDecimal(<span class="hljs-number">3</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>));
    ps.executeUpdate();
    
    <span class="hljs-comment">// 2. 插入明细</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> getGeneratedId(ps);
    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps2</span> <span class="hljs-operator">=</span> conn.prepareStatement(
        <span class="hljs-string">"INSERT INTO order_items(order_id, sku, quantity, price) VALUES(?, ?, ?, ?)"</span>
    );
    ps2.setLong(<span class="hljs-number">1</span>, orderId);
    ps2.setString(<span class="hljs-number">2</span>, sku);
    ps2.setInt(<span class="hljs-number">3</span>, quantity);
    ps2.setBigDecimal(<span class="hljs-number">4</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>));
    ps2.executeUpdate();
    
    System.out.println(<span class="hljs-string">"订单创建成功："</span> + orderNo);
}
</code></pre>
<h4 data-id="heading-6">运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 测试1：正常提交 ==========</span>
订单创建成功：ORD-xxx
订单创建成功
</code></pre>
<h4 data-id="heading-7">验证</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U1001'</span>;
<span class="hljs-comment">-- 结果：有1条记录</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> order_id<span class="hljs-operator">=</span>...;
<span class="hljs-comment">-- 结果：有1条记录</span>
</code></pre>
<h4 data-id="heading-8">原理解析</h4>
<p>这个最简单，执行流程是这样的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client
    participant Proxy
    participant Interceptor
    participant TxManager
    participant DB
    
    Client-&gt;&gt;Proxy: placeOrder()
    Proxy-&gt;&gt;Interceptor: 拦截调用
    Interceptor-&gt;&gt;TxManager: begin() 开启事务
    TxManager-&gt;&gt;DB: setAutoCommit(false)
    Interceptor-&gt;&gt;DB: INSERT orders
    Interceptor-&gt;&gt;DB: INSERT order_items
    Interceptor-&gt;&gt;TxManager: commit()
    TxManager-&gt;&gt;DB: conn.commit()
    TxManager-&gt;&gt;DB: close()
</code></pre>
<p>关键点：</p>
<ol>
<li>拦截器在方法执行前调用<code>begin()</code>，拿到数据库连接并关闭自动提交</li>
<li>业务代码执行，在同一个连接上执行两条INSERT</li>
<li>方法正常返回，拦截器调用<code>commit()</code></li>
<li>最后清理资源，恢复autoCommit并关闭连接</li>
</ol>
<p>这就是事务的基本流程，没啥特别的。</p>
<h3 data-id="heading-9">测试2：运行时异常回滚 - Spring的默认行为</h3>
<h4 data-id="heading-10">代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 业务代码里模拟库存不足</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">"OUT_OF_STOCK"</span>.equals(sku)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存不足，订单回滚"</span>);
}
</code></pre>
<h4 data-id="heading-11">运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 测试2：运行时异常回滚 ==========</span>
捕获运行时异常：库存不足，订单回滚
</code></pre>
<h4 data-id="heading-12">验证</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U1002'</span>;
<span class="hljs-comment">-- 结果：无记录</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> sku<span class="hljs-operator">=</span><span class="hljs-string">'OUT_OF_STOCK'</span>;
<span class="hljs-comment">-- 结果：无记录</span>
</code></pre>
<h4 data-id="heading-13">原理解析</h4>
<p>这个是Spring的<strong>默认回滚规则</strong>：RuntimeException和Error会导致回滚。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client
    participant Interceptor
    participant TxManager
    participant DB
    
    Client-&gt;&gt;Interceptor: placeOrder()
    Interceptor-&gt;&gt;TxManager: begin()
    TxManager-&gt;&gt;DB: setAutoCommit(false)
    Interceptor-&gt;&gt;DB: INSERT orders (成功)
    Interceptor-&gt;&gt;DB: INSERT order_items (成功)
    Interceptor-&gt;&gt;Interceptor: 抛RuntimeException
    Interceptor-&gt;&gt;TxManager: rollback()
    TxManager-&gt;&gt;DB: conn.rollback()
    
    Note over DB: orders和order_items都被回滚
</code></pre>
<p>关键点：</p>
<ol>
<li>虽然两条INSERT都执行成功了，但还没commit</li>
<li>抛出RuntimeException后，拦截器捕获异常</li>
<li>判断是运行时异常，调用<code>rollback()</code></li>
<li>数据库回滚，两条记录都不会保存</li>
</ol>
<p>这个很好理解，我之前踩过坑的是下一个场景。</p>
<h3 data-id="heading-14">测试3：受检异常回滚 - 容易被忽略的坑</h3>
<h4 data-id="heading-15">代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 业务代码里抛受检异常</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">"INVALID_SKU"</span>.equals(sku)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"无效的SKU，订单回滚"</span>);  <span class="hljs-comment">// 注意：这是Exception，不是RuntimeException</span>
}
</code></pre>
<h4 data-id="heading-16">运行结果（如果没加rollbackFor）</h4>
<p>假设我们的@Transactional没有配置rollbackFor：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">// 没有rollbackFor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 抛Exception</span>
}
</code></pre>
<p><strong>悲剧发生了</strong>：数据库里有数据！</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U1003'</span>;
<span class="hljs-comment">-- 结果：有1条记录！！！</span>
</code></pre>
<h4 data-id="heading-17">为什么？</h4>
<p>因为Spring的默认规则：<strong>受检异常（Exception）不回滚，只提交</strong>。</p>
<p>我当时第一次遇到这个问题，在生产环境差点出事故。业务代码抛了个自定义的<code>BusinessException</code>（继承自Exception），我以为会回滚，结果数据都入库了。</p>
<h4 data-id="heading-18">正确做法</h4>
<p>必须显式指定rollbackFor：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>  <span class="hljs-comment">// 所有异常都回滚</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>现在再跑：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 测试3：受检异常回滚 ==========</span>
捕获受检异常：无效的SKU，订单回滚
</code></pre>
<p>验证：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U1003'</span>;
<span class="hljs-comment">-- 结果：无记录 </span>
</code></pre>
<h4 data-id="heading-19">异常回滚规则总结</h4>
<p>这个表建议保存下来，面试常考：</p>






























<table><thead><tr><th>异常类型</th><th>默认行为</th><th>rollbackFor配置后</th></tr></thead><tbody><tr><td>RuntimeException</td><td>回滚</td><td>回滚</td></tr><tr><td>Error</td><td>回滚</td><td>回滚</td></tr><tr><td>Exception（受检异常）</td><td><strong>提交</strong></td><td>回滚</td></tr><tr><td>自定义异常extends Exception</td><td><strong>提交</strong></td><td>需显式配置</td></tr></tbody></table>
<p>我的建议：<strong>生产环境统一加上<code>rollbackFor = Exception.class</code></strong>，避免漏掉受检异常。</p>
<h3 data-id="heading-20">测试4：REQUIRED传播 - 外内层统一提交</h3>
<p>好，前面3个测试都是单方法的，现在进入重点：<strong>方法嵌套调用时的传播行为</strong>。</p>
<h4 data-id="heading-21">场景设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外层服务</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrderWithInner</span><span class="hljs-params">(String userId, String sku, <span class="hljs-type">int</span> quantity)</span> {
    <span class="hljs-comment">// 1. 插入外层订单</span>
    insertOuterOrder(userId, sku);
    
    <span class="hljs-comment">// 2. 调用内层服务</span>
    innerService.createOrderItem(orderId, sku, quantity);
    
    System.out.println(<span class="hljs-string">"外层方法执行完成"</span>);
}

<span class="hljs-comment">// 内层服务</span>
<span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">// 默认REQUIRED</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderItem</span><span class="hljs-params">(<span class="hljs-type">long</span> orderId, String sku, <span class="hljs-type">int</span> quantity)</span> {
    <span class="hljs-comment">// 插入订单明细</span>
    insertOrderItem(orderId, sku, quantity);
    
    System.out.println(<span class="hljs-string">"内层方法执行完成"</span>);
}
</code></pre>
<h4 data-id="heading-22">关键问题</h4>
<p>外层和内层各有一个@Transactional，这会开几个事务？</p>
<p>很多人会说"两个事务"，<strong>错了</strong>！</p>
<h4 data-id="heading-23">运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 传播：统一提交 ==========</span>
外层订单创建成功：ORD-xxx
内层明细创建成功
内层方法执行完成
外层方法执行完成
外内层均成功，统一提交
</code></pre>
<p>验证：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U2001'</span>;
<span class="hljs-comment">-- 有记录</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> order_id<span class="hljs-operator">=</span>...;
<span class="hljs-comment">-- 有记录</span>
</code></pre>
<h4 data-id="heading-24">原理：REQUIRED只有一个事务</h4>
<p>这是REQUIRED传播的核心：<strong>有事务就加入，没有就新建</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Outer
    participant OuterInterceptor
    participant Inner
    participant InnerInterceptor
    participant TxContext
    participant DB
    
    Outer-&gt;&gt;OuterInterceptor: placeOrderWithInner()
    OuterInterceptor-&gt;&gt;TxContext: begin() 开启事务
    TxContext-&gt;&gt;DB: 获取连接，setAutoCommit(false)
    OuterInterceptor-&gt;&gt;DB: INSERT orders
    OuterInterceptor-&gt;&gt;Inner: 调用createOrderItem()
    Inner-&gt;&gt;InnerInterceptor: 拦截
    InnerInterceptor-&gt;&gt;TxContext: 检查是否已有事务
    TxContext--&gt;&gt;InnerInterceptor: 有事务，直接加入
    InnerInterceptor-&gt;&gt;DB: INSERT order_items (用同一个conn)
    InnerInterceptor--&gt;&gt;OuterInterceptor: 返回
    OuterInterceptor-&gt;&gt;TxContext: commit()
    TxContext-&gt;&gt;DB: conn.commit() 一次性提交所有操作
</code></pre>
<p>关键点：</p>
<ol>
<li>外层开启事务，把Connection放到ThreadLocal</li>
<li>内层发现ThreadLocal里已经有事务了，<strong>直接复用这个连接</strong></li>
<li>内外层的SQL都在同一个Connection上执行</li>
<li>最后外层统一commit，一次性提交所有操作</li>
</ol>
<p>所以：<strong>REQUIRED传播下，嵌套调用共享一个事务</strong>。</p>
<h3 data-id="heading-25">测试5：REQUIRED传播 - 内层失败整体回滚（难点）</h3>
<p>这个是最容易搞混的场景，面试经常问。</p>
<h4 data-id="heading-26">代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 内层服务模拟失败</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderItem</span><span class="hljs-params">(<span class="hljs-type">long</span> orderId, String sku, <span class="hljs-type">int</span> quantity)</span> {
    insertOrderItem(orderId, sku, quantity);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"FAIL_INNER"</span>.equals(sku)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"内层失败"</span>);  <span class="hljs-comment">// 抛异常</span>
    }
}
</code></pre>
<h4 data-id="heading-27">运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 传播：内层失败整体回滚 ==========</span>
捕获内层异常：内层失败
</code></pre>
<h4 data-id="heading-28">验证（重点）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U2002'</span>;
<span class="hljs-comment">-- 结果：无记录</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> sku<span class="hljs-operator">=</span><span class="hljs-string">'FAIL_INNER'</span>;
<span class="hljs-comment">-- 结果：无记录</span>
</code></pre>
<p><strong>注意</strong>：外层的订单也回滚了！虽然外层代码没抛异常。</p>
<h4 data-id="heading-29">为什么外层也回滚了？</h4>
<p>很多人会想：内层抛异常，内层回滚就好了，外层继续提交不行吗？</p>
<p><strong>不行！因为它们共享同一个事务（同一个Connection）</strong>。</p>
<p>我们来看具体流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Outer
    participant OuterInterceptor
    participant Inner
    participant InnerInterceptor
    participant TxContext
    
    Outer-&gt;&gt;OuterInterceptor: placeOrderWithInner()
    OuterInterceptor-&gt;&gt;TxContext: begin() 外层开启
    OuterInterceptor-&gt;&gt;Outer: INSERT orders
    OuterInterceptor-&gt;&gt;Inner: 调用内层
    Inner-&gt;&gt;InnerInterceptor: 拦截
    InnerInterceptor-&gt;&gt;TxContext: 检查，已有事务，加入
    InnerInterceptor-&gt;&gt;Inner: INSERT order_items
    Inner-&gt;&gt;Inner: 抛RuntimeException
    InnerInterceptor-&gt;&gt;InnerInterceptor: catch到异常
    InnerInterceptor-&gt;&gt;TxContext: setRollbackOnly() 打标记
    InnerInterceptor--&gt;&gt;OuterInterceptor: 异常向上抛
    OuterInterceptor-&gt;&gt;OuterInterceptor: catch到异常
    OuterInterceptor-&gt;&gt;TxContext: commit() 尝试提交
    TxContext-&gt;&gt;TxContext: 检查rollbackOnly=true
    TxContext-&gt;&gt;TxContext: 执行rollback() 整体回滚
    
    Note over TxContext: orders和order_items都回滚
</code></pre>
<p>关键点：</p>
<ol>
<li>内层抛异常后，<strong>不能直接rollback</strong>（因为事务是外层开的）</li>
<li>内层只能打个标记：<code>setRollbackOnly(true)</code></li>
<li>异常继续向上抛，外层捕获</li>
<li>外层尝试commit时，发现有rollbackOnly标记</li>
<li>最终执行rollback，<strong>整个事务回滚</strong></li>
</ol>
<p>这就是REQUIRED的"统一进退"：要么都成功，要么都失败。</p>
<h4 data-id="heading-30">实际代码是怎么实现的？</h4>
<p>我手写框架里的代码是这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 拦截器逻辑</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
    
    <span class="hljs-keyword">if</span> (started) {  <span class="hljs-comment">// 如果是我开启的事务</span>
        <span class="hljs-keyword">if</span> (TransactionContext.isRollbackOnly()) {
            txManager.rollback();  <span class="hljs-comment">// 有人标记了回滚</span>
        } <span class="hljs-keyword">else</span> {
            txManager.commit();
        }
    }
    <span class="hljs-keyword">return</span> result;
    
} <span class="hljs-keyword">catch</span> (InvocationTargetException e) {
    <span class="hljs-type">Throwable</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> e.getTargetException();
    
    <span class="hljs-keyword">if</span> (shouldRollback(ex)) {
        <span class="hljs-keyword">if</span> (started) {
            txManager.rollback();  <span class="hljs-comment">// 我开的事务，我负责回滚</span>
        } <span class="hljs-keyword">else</span> {
            TransactionContext.setRollbackOnly();  <span class="hljs-comment">// 不是我开的，打标记</span>
        }
    }
    <span class="hljs-keyword">throw</span> ex;
}
</code></pre>
<p>这个<code>started</code>标志很关键：</p>
<ul>
<li><strong>外层</strong>：started=true（我开的事务）</li>
<li><strong>内层</strong>：started=false（加入的事务）</li>
</ul>
<p>所以：</p>
<ul>
<li>内层抛异常：只打标记，不直接回滚</li>
<li>外层拿到标记：执行回滚</li>
</ul>
<h3 data-id="heading-31">几个容易踩的坑</h3>
<h4 data-id="heading-32">坑1：以为内层可以独立回滚</h4>
<p>错误认知：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    innerService.createOrderItem();  <span class="hljs-comment">// 内层失败</span>
} <span class="hljs-keyword">catch</span> (Exception e) {
    <span class="hljs-comment">// 以为catch住了就没事</span>
}
<span class="hljs-comment">// 以为外层可以继续提交</span>
</code></pre>
<p>真相：<strong>catch住也没用，事务已经被标记为rollbackOnly</strong>。</p>
<h4 data-id="heading-33">坑2：同类方法调用不生效</h4>
<p>这个是经典问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> {
        methodB();  <span class="hljs-comment">// 直接调用</span>
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这个@Transactional不生效！</span>
    }
}
</code></pre>
<p>为什么？因为代理只能拦截<strong>外部调用</strong>，内部调用走的是this，不经过代理。</p>
<p>解决办法：拆到不同的类，或者通过注入拿到代理对象。</p>
<h4 data-id="heading-34">坑3：忘记配置rollbackFor</h4>
<p>生产环境建议：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>  <span class="hljs-comment">// 统一配置</span>
</code></pre>
<p>不要依赖默认行为，否则受检异常会让你抓狂。</p>
<h3 data-id="heading-35">传播行为对比表</h3>
<p>虽然我这个简化版只实现了REQUIRED，但我把7种传播行为总结了下：</p>





















































<table><thead><tr><th>传播行为</th><th>外层有事务</th><th>外层无事务</th><th>使用场景</th></tr></thead><tbody><tr><td>REQUIRED</td><td>加入外层事务</td><td>新建事务</td><td><strong>默认，最常用</strong></td></tr><tr><td>REQUIRES_NEW</td><td>挂起外层，新建事务</td><td>新建事务</td><td>日志记录（独立提交）</td></tr><tr><td>NESTED</td><td>嵌套事务（SavePoint）</td><td>新建事务</td><td>部分回滚场景</td></tr><tr><td>SUPPORTS</td><td>加入外层事务</td><td>非事务执行</td><td>查询方法</td></tr><tr><td>NOT_SUPPORTED</td><td>挂起外层事务</td><td>非事务执行</td><td>不需要事务的操作</td></tr><tr><td>MANDATORY</td><td>加入外层事务</td><td>抛异常</td><td>必须在事务中执行</td></tr><tr><td>NEVER</td><td>抛异常</td><td>非事务执行</td><td>禁止在事务中执行</td></tr></tbody></table>
<p>生产环境99%的场景用REQUIRED就够了，REQUIRES_NEW用在日志记录（即使业务失败也要记日志），其他的基本用不上。</p>
<h3 data-id="heading-36">生产经验总结</h3>
<p>这5个测试跑下来，我总结了几条生产经验：</p>
<ol>
<li><strong>统一加rollbackFor = Exception.class</strong>
<ul>
<li>避免受检异常不回滚的坑</li>
</ul>
</li>
<li><strong>理解REQUIRED的"统一进退"</strong>
<ul>
<li>内层失败 = 整体回滚</li>
<li>不要企图catch住内层异常让外层继续提交</li>
</ul>
</li>
<li><strong>拆分服务要小心</strong>
<ul>
<li>不同类的方法调用才会走代理</li>
<li>同类内部调用事务不生效</li>
</ul>
</li>
<li><strong>数据库连接要复用</strong>
<ul>
<li>REQUIRED传播下，内外层共享一个Connection</li>
<li>所以可以看到彼此未提交的数据</li>
</ul>
</li>
<li><strong>ThreadLocal一定要清理</strong>
<ul>
<li>finally块里统一清理资源</li>
<li>否则线程池复用会出问题</li>
</ul>
</li>
</ol>
<h3 data-id="heading-37">下一步：REQUIRES_NEW</h3>
<p>REQUIRED搞清楚后，下一个要研究的是REQUIRES_NEW。它跟REQUIRED最大的区别：</p>
<ul>
<li><strong>REQUIRED</strong>：有事务就加入（共享Connection）</li>
<li><strong>REQUIRES_NEW</strong>：总是新建事务（挂起外层，新开Connection）</li>
</ul>
<p>这个涉及到事务挂起和恢复，需要维护一个事务栈，实现起来更复杂。我准备下一篇文章专门写这个。</p>
<h3 data-id="heading-38">写在最后</h3>
<p>事务传播行为这块，说实话光看文档真的很难理解。我这次通过手写框架+测试用例，算是彻底搞明白了。</p>
<p>最大的收获是：<strong>不要怕动手实践</strong>。自己写200行代码，比看2000行源码理解得更深。</p>
<p>代码我放Gitee了（链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsimple-spring-transaction" target="_blank" title="https://gitee.com/sh_wangwanbao/simple-spring-transaction" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a> )
有兴趣的同学可以clone下来跑跑看。下一篇我打算写REQUIRES_NEW的实现，涉及到事务挂起和恢复，应该会更有意思。</p>
<hr/>
<p><strong>你们在用事务的时候，有没有遇到过"内层失败外层却提交了"的坑？或者还有哪些传播行为的问题搞不清楚？欢迎评论区聊聊，大家一起交流。</strong></p>
<p>如果文章对您有帮助，辛苦点个赞支持下呗。您的支持，是我创作的最大动力，谢谢。</p>
<p>下篇见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端性能优化之“代码分割与懒加载”）]]></title>    <link>https://juejin.cn/post/7577722399375818794</link>    <guid>https://juejin.cn/post/7577722399375818794</guid>    <pubDate>2025-11-29T23:03:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399375818794" data-draft-id="7577905525996666921" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端性能优化之“代码分割与懒加载”）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-29T23:03:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="方法重载"/> <meta itemprop="url" content="https://juejin.cn/user/1443021512522878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端性能优化之“代码分割与懒加载”）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1443021512522878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    方法重载
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T23:03:14.000Z" title="Sat Nov 29 2025 23:03:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，随着单页面应用(SPA)的复杂度不断提升，打包后的JavaScript文件体积可能达到几MB甚至更大。这会导致严重的性能问题：用户需要等待整个应用加载完成后才能与页面交互。代码分割(Code Splitting)和懒加载(Lazy Loading)正是解决这一问题的关键技术。</p>
<p>一、代码分割的核心思想</p>
<p>代码分割的核心是将单个大型的打包文件拆分成多个较小的chunk，然后按需加载或并行加载。这类似于图书的章节划分——读者不需要一次性拿到整本书，而是可以根据需要阅读特定章节。</p>
<p>二、实现方式</p>
<ol>
<li>动态import()语法（现代推荐方案）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 静态导入（传统方式）</span>
<span class="hljs-comment">// import { utils } from './module';</span>

<span class="hljs-comment">// 动态导入（代码分割）</span>
button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./module.js'</span>);
  <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">doSomething</span>();
});
</code></pre>
<p>Webpack等构建工具检测到动态import()时会自动进行代码分割，生成独立的chunk文件。</p>
<ol>
<li>React.lazy + Suspense（React生态）</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./LazyComponent'</span>));

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
  );
}
</code></pre>
<ol>
<li>路由级分割（最常用的分割场景）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue Router</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/dashboard'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Dashboard.vue'</span>)
  }
];

<span class="hljs-comment">// React Router</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Dashboard</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Dashboard'</span>));
</code></pre>
<p>三、懒加载的实际应用场景</p>
<ol>
<li>路由级别分割：每个路由对应的组件单独打包</li>
<li>组件级别分割：大型组件（如富文本编辑器、图表库）按需加载</li>
<li>第三方库分割：将不常变化的第三方库单独打包</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack配置示例</span>
<span class="hljs-attr">optimization</span>: {
  <span class="hljs-attr">splitChunks</span>: {
    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
    <span class="hljs-attr">cacheGroups</span>: {
      <span class="hljs-attr">vendor</span>: {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
      }
    }
  }
}
</code></pre>
<p>四、性能收益分析</p>
<p>通过代码分割可以实现：</p>
<p>· 减少初始加载时间：首屏只需加载必要代码
· 提高缓存效率：修改业务代码不会影响vendor chunk
· 优化资源加载：非关键资源可以延迟加载</p>
<p>五、最佳实践建议</p>
<ol>
<li>分割粒度要合理，避免产生过多小文件导致请求频繁</li>
<li>使用预加载(preload/prefetch)优化用户体验</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"prefetch"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"lazy-component.js"</span>&gt;</span>
</code></pre>
<ol>
<li>注意错误处理，动态导入可能失败</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span>(<span class="hljs-string">'./module'</span>)
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 处理加载失败情况</span>
  });
</code></pre>
<p>代码分割不是银弹，需要结合实际业务场景。过度分割可能导致请求碎片化，而分割不足又无法充分发挥性能优势。通过Chrome DevTools的Coverage工具和Webpack Bundle Analyzer进行分析，找到最适合自己项目的分割策略才是关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML 敲击乐 PART--2]]></title>    <link>https://juejin.cn/post/7577704980855275574</link>    <guid>https://juejin.cn/post/7577704980855275574</guid>    <pubDate>2025-11-29T15:56:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577704980855275574" data-draft-id="7576856418470461450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML 敲击乐 PART--2"/> <meta itemprop="keywords" content="HTML"/> <meta itemprop="datePublished" content="2025-11-29T15:56:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="izx888"/> <meta itemprop="url" content="https://juejin.cn/user/1241762540820323"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML 敲击乐 PART--2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1241762540820323/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    izx888
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:56:16.000Z" title="Sat Nov 29 2025 15:56:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HTML5 敲击乐项目 PART-2：从结构到交互的完整实现</h2>
<h3 data-id="heading-1">一、项目概述</h3>
<p>“HTML5 敲击乐”是一个基于现代 Web 技术的交互式音频应用：用户按下键盘上的特定按键（如 A、S、D 等），页面中对应的虚拟“打击乐器键”会高亮显示并播放预设音效，模拟真实的节奏打击体验。</p>
<p>该项目不仅实现了基础的音效触发与视觉反馈，更完整体现了前端开发的核心理念——<strong>结构、样式与行为分离</strong>，并融合了<strong>响应式设计</strong>、<strong>模块化思维</strong>与<strong>用户体验优化</strong>等现代开发实践。代码结构清晰、扩展性强，为后续功能（如节奏录制、音色切换、移动端触控支持等）预留了良好接口，是初学者掌握 HTML5、CSS3 与 JavaScript 协同开发的理想范例。</p>
<blockquote>
<p>跟着本文，你将亲手构建一个既美观又富有交互感的网页乐器！</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、HTML5 结构设计：语义化与数据绑定</h3>
<p>HTML 是应用的骨架。我们采用<strong>语义化标签</strong>与<strong>数据属性（data-*）</strong> 构建清晰、可维护的 DOM 结构：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>HTML5 敲击乐<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keys"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"key"</span> <span class="hljs-attr">data-key</span>=<span class="hljs-string">"65"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sound"</span>&gt;</span>Clap<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 更多 .key 元素 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">audio</span> <span class="hljs-attr">data-key</span>=<span class="hljs-string">"65"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"sounds/clap.wav"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">audio</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 对应的 audio 元素 --&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">关键设计要点：</h4>
<ul>
<li><strong><code>.keys</code> 容器</strong>：包裹所有虚拟琴键，作为布局根节点；</li>
<li><strong><code>.key</code> 模块</strong>：每个键包含视觉提示（<code>&lt;h3&gt;</code>）与音效名称（<code>.sound</code>），具备独立语义；</li>
<li><strong><code>data-key</code> 属性</strong>：存储键盘事件的 <code>keyCode</code>（如 A 键为 65），实现 UI 元素与物理按键的精准映射；</li>
<li><strong><code>&lt;audio&gt;</code> 预加载</strong>：每个音效通过独立 <code>&lt;audio&gt;</code> 标签预加载，并通过相同的 <code>data-key</code> 与 <code>.key</code> 关联，便于 JavaScript 动态调用。</li>
</ul>
<blockquote>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>HTML 只负责结构，不嵌入样式或逻辑；</li>
<li>CSS 通过外链引入，置于 <code>&lt;head&gt;</code>；</li>
<li>JavaScript 脚本置于 <code>&lt;body&gt;</code> 底部，避免阻塞渲染。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-4">三、CSS 样式系统：重置、布局与动效</h3>
<h4 data-id="heading-5">1. 统一样式起点：CSS Reset</h4>
<p>不同浏览器对默认元素（如 <code>body</code>、<code>h1</code>）的 margin、padding 等处理不一，易导致布局错乱。为此，项目采用 <strong>Eric Meyer’s Reset CSS</strong>，清除所有默认样式，并补充现代开发规范：</p>
<pre><code class="hljs language-css" lang="css">*, *<span class="hljs-selector-pseudo">::before</span>, *<span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">box-sizing</span>: border-box;
}
</code></pre>
<p><code>box-sizing: border-box</code> 确保元素的宽高包含 padding 和 border，使尺寸计算更直观、布局更稳定。</p>
<p>此外，还优化了常用元素：</p>
<ul>
<li><code>img { max-width: 100%; height: auto; }</code>：图片自适应容器；</li>
<li><code>a { text-decoration: none; color: inherit; }</code>：链接样式继承父级，保持视觉统一。</li>
</ul>
<h4 data-id="heading-6">2. 响应式布局：Flexbox + 相对单位</h4>
<p>为适配手机、平板、桌面等多种设备，项目摒弃固定单位（如 <code>px</code>），转而使用：</p>
<ul>
<li><strong><code>vh</code>（视口高度单位）</strong> ：<br/>
<code>min-height: 100vh</code> 确保 <code>.keys</code> 容器始终占满屏幕高度；</li>
<li><strong><code>rem</code>（根字体单位）</strong> ：<br/>
设置 <code>html { font-size: 10px; }</code>，后续所有尺寸（如 <code>font-size: 1.5rem</code>、<code>border: .4rem</code>）均基于此，便于全局缩放。</li>
</ul>
<p>配合 <strong>Flexbox 弹性布局</strong>，实现优雅居中：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.keys</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/* 水平居中 */</span>
  <span class="hljs-attribute">align-items</span>: center;     <span class="hljs-comment">/* 垂直居中 */</span>
}
</code></pre>
<p>无论屏幕尺寸如何变化，琴键始终居中排列，布局自适应且无需媒体查询干预。</p>
<h4 data-id="heading-7">3. 视觉反馈：动态交互效果</h4>
<p>当用户触发按键时，JavaScript 会为对应 <code>.key</code> 添加 <code>.playing</code> 类，CSS 则定义其动效：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.playing</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#ffc600</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1rem</span> <span class="hljs-number">#ffc600</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.1</span>);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.1s</span> ease;
}
</code></pre>
<p>这一组合实现了<strong>边框高亮、发光阴影与轻微放大</strong>的视觉反馈，显著提升交互沉浸感。</p>
<h4 data-id="heading-8">4. 背景与氛围营造</h4>
<p>全屏背景图增强整体氛围：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'./background.jpg'</span>) bottom center no-repeat;
  <span class="hljs-attribute">background-size</span>: cover;
}
</code></pre>
<ul>
<li><code>cover</code>：等比缩放覆盖整个视口（可能裁剪边缘）；</li>
<li><code>contain</code>：完整显示图片（可能留白）；</li>
<li><code>bottom center</code>：确保关键视觉内容（如鼓面）位于底部中央。</li>
</ul>
<hr/>
<h3 data-id="heading-9">四、JavaScript 交互逻辑：事件驱动与 DOM 操作</h3>
<p>JavaScript 是让页面“活起来”的引擎。项目采用<strong>事件监听 + 数据驱动</strong>的方式实现核心交互。</p>
<h4 data-id="heading-10">1. 安全执行时机</h4>
<p>使用 <code>DOMContentLoaded</code> 确保 DOM 加载完成后再执行脚本：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 初始化逻辑</span>
});
</code></pre>
<p>避免因元素未就绪导致的 <code>null</code> 错误。</p>
<h4 data-id="heading-11">2. 全局键盘监听</h4>
<p>监听 <code>window</code> 的 <code>keydown</code> 事件，捕获用户输入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, playSound);
</code></pre>
<h4 data-id="heading-12">3. 动态匹配与反馈</h4>
<pre><code class="hljs language-ini" lang="ini">function playSound(event) {
  const <span class="hljs-attr">keyCode</span> = event.keyCode<span class="hljs-comment">;</span>
  const <span class="hljs-attr">keyElement</span> = document.querySelector(`.key[data-key=<span class="hljs-string">"${keyCode}"</span>]`)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">audioElement</span> = document.querySelector(`audio[data-key=<span class="hljs-string">"${keyCode}"</span>]`)<span class="hljs-comment">;</span>

  if (keyElement) {
    keyElement.classList.add('playing')<span class="hljs-comment">;</span>
    setTimeout(() =&gt; keyElement.classList.remove('playing'), 150)<span class="hljs-comment">; // 自动移除动效</span>
  }

  if (audioElement) {
    <span class="hljs-attr">audioElement.currentTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 重置播放位置</span>
    audioElement.play()<span class="hljs-comment">;</span>
  }
}
</code></pre>
<ul>
<li>通过 <code>data-key</code> 精准匹配 UI 与音频；</li>
<li>使用 <code>setTimeout</code> 自动清除 <code>.playing</code> 类，避免状态残留；</li>
<li>重置 <code>currentTime</code> 支持快速连按。</li>
</ul>
<hr/>
<h3 data-id="heading-13">五、性能与工程化考量</h3>
<h4 data-id="heading-14">✅ 最佳实践总结：</h4>

























<table><thead><tr><th>方面</th><th>实践</th></tr></thead><tbody><tr><td><strong>脚本加载</strong></td><td><code>&lt;script&gt;</code> 置于 <code>&lt;/body&gt;</code> 前，避免阻塞渲染</td></tr><tr><td><strong>选择器性能</strong></td><td>避免通配符 <code>*</code> 重置，采用明确元素列表（如 Eric Meyer 方案）</td></tr><tr><td><strong>可访问性</strong></td><td>使用语义化标签（<code>&lt;h3&gt;</code>、<code>&lt;p&gt;</code>），提升屏幕阅读器兼容性</td></tr><tr><td><strong>扩展性</strong></td><td><code>data-*</code> 属性天然支持未来功能扩展（如音量控制、音色切换）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">六、结语：小项目，大格局</h3>
<p>“HTML5 敲击乐”虽体量小巧，却完整涵盖了现代 Web 开发的关键要素：</p>
<ul>
<li><strong>结构清晰</strong>：语义化 HTML + 数据绑定；</li>
<li><strong>样式健壮</strong>：CSS Reset + Flexbox + 响应式单位；</li>
<li><strong>交互流畅</strong>：事件驱动 + 动态 DOM 操作 + 视觉反馈；</li>
<li><strong>工程规范</strong>：职责分离、性能优化、可扩展设计。</li>
</ul>
<p>它不仅是一次趣味编程实践，更是通往专业前端开发的坚实一步。掌握其中的设计思想与技术组合，你便已具备构建更复杂交互应用的能力。</p>
<blockquote>
<p>下一步，不妨尝试添加：</p>
<ul>
<li>移动端触控支持</li>
<li>节奏录制与回放</li>
<li>多套音效主题切换<br/>
让你的“敲击乐”真正成为属于你的数字乐器！</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解内容安全策略（CSP）：原理、作用与实践指南]]></title>    <link>https://juejin.cn/post/7577715145121726518</link>    <guid>https://juejin.cn/post/7577715145121726518</guid>    <pubDate>2025-11-29T16:43:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577715145121726518" data-draft-id="7577691384943165482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解内容安全策略（CSP）：原理、作用与实践指南"/> <meta itemprop="keywords" content="前端,浏览器"/> <meta itemprop="datePublished" content="2025-11-29T16:43:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JamesGosling666"/> <meta itemprop="url" content="https://juejin.cn/user/2358921680140899"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解内容安全策略（CSP）：原理、作用与实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2358921680140899/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JamesGosling666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:43:11.000Z" title="Sat Nov 29 2025 16:43:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、CSP 是什么？</h2>
<blockquote>
<p>CSP 本质上是一套<strong>由网站开发者定义、浏览器负责执行的 “内容加载规则”</strong> 。它通过明确告诉浏览器 “哪些来源的资源（如脚本、图片、样式表）是安全的，可以加载；哪些来源是危险的，必须拒绝”，从根源上限制恶意代码的执行，弥补传统安全防护（如输入过滤、输出编码）的不足。</p>
</blockquote>
<h3 data-id="heading-1">1. CSP 的核心逻辑：“白名单机制”</h3>
<p>CSP 的核心思想是 “<strong>默认拒绝，例外允许</strong>”—— 除非开发者明确将某个资源来源加入 “白名单”，否则浏览器会默认阻止该资源的加载或执行。这种机制彻底改变了传统网页 “默认允许所有资源” 的宽松模式，大幅降低了恶意资源注入的风险。</p>
<h3 data-id="heading-2">2. CSP 的实现载体：两种部署方式</h3>
<p>CSP 的规则通常通过以下两种方式传递给浏览器，开发者可根据场景选择：</p>
<ul>
<li><strong>HTTP 响应头（推荐）</strong> ：在服务器返回的 HTTP 响应中添加<code>Content-Security-Policy</code>头，例如：<code>Content-Security-Policy: default-src 'self'; script-src https://cdn.example.com</code>。这种方式优先级高、规则覆盖全面，适用于整站或特定页面的安全管控。</li>
<li><strong><code>&lt;meta&gt;</code>标签</strong>：众所周知可以通过 <code>&lt;meta&gt;</code>标签来模拟响应头，例如：<code>&lt;meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://img.example.com"&gt;</code>。这种方式无需服务器配置，适合静态页面或无法修改服务器响应头的场景（如静态博客、第三方平台托管页面）。</li>
</ul>
<h2 data-id="heading-3">二、CSP 的核心作用 —— 抵御哪些威胁？解决什么问题？</h2>
<p>CSP 的核心价值在于 “<strong>精准管控资源加载，阻断恶意代码执行</strong>”，具体可拆解为以下 4 个关键作用：</p>
<h3 data-id="heading-4">1. 抵御 XSS 攻击：从 “事后过滤” 到 “事前阻止”</h3>
<p>XSS 攻击的本质是恶意脚本被注入到网页中并执行，而 CSP 通过限制 “脚本的加载来源” 和 “脚本的执行方式”，直接切断恶意脚本的执行路径：</p>
<ul>
<li>禁止加载未知来源的脚本：例如通过<code>script-src 'self' https://cdn.tencent.com</code>，仅允许加载网站自身（<code>'self'</code>）和腾讯 CDN 的脚本，恶意网站的脚本会被直接拦截；</li>
<li>禁止内联脚本（如<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>）和<code>eval()</code>函数：内联脚本是 XSS 攻击的常用载体，CSP 默认拒绝内联脚本（需显式配置<code>'unsafe-inline'</code>才允许，且不推荐），同时禁用<code>eval()</code>等动态执行脚本的函数，彻底杜绝 “动态注入恶意代码” 的可能。</li>
</ul>
<h3 data-id="heading-5">2. 防止数据注入与恶意资源加载</h3>
<p>除了脚本，CSP 还能管控图片、样式表、字体、iframe 等各类资源的加载来源：</p>
<ul>
<li>例如通过<code>img-src https://img.example.com data:</code>，仅允许加载指定域名的图片和<code>data:</code>协议的 Base64 图片，避免攻击者注入恶意图片（如包含恶意代码的 SVG）；</li>
<li>通过<code>frame-src 'none'</code>禁止加载任何 iframe，防止 “点击劫持”（Clickjacking）攻击 —— 即攻击者通过 iframe 嵌套合法网站，诱导用户点击恶意按钮。</li>
</ul>
<h3 data-id="heading-6">3. 增强网站的 “安全透明度”：报告机制</h3>
<p>CSP 支持 “违规报告” 功能：当浏览器检测到违反 CSP 规则的行为时（如尝试加载未授权的脚本），会自动向开发者指定的 “报告地址” 发送 JSON 格式的日志，包含违规资源的 URL、违规类型、触发页面等信息。</p>
<p>这一机制让开发者能实时监控网站的安全风险，例如：</p>
<ul>
<li>发现未被注意的第三方脚本加载（可能存在安全隐患）；</li>
<li>验证 CSP 规则是否配置正确（避免误拦截合法资源）。</li>
</ul>
<h3 data-id="heading-7">4. 兼容 “渐进式安全”：从测试到强制</h3>
<p>为了避免直接启用 CSP 导致合法资源被拦截（影响网站功能），CSP 提供了 “测试模式”：将 HTTP 响应头改为<code>Content-Security-Policy-Report-Only</code>，此时浏览器仅会记录违规行为（发送报告），但不会实际阻止资源加载。</p>
<h2 data-id="heading-8">三、CSP 的具体使用 —— 规则配置、常见场景与注意事项</h2>
<p>CSP 的使用核心是 “配置规则”，而规则由 “指令（Directive）” 和 “源（Source）” 两部分组成。下面从基础配置逻辑、常见场景示例、避坑指南三个方面，讲解 CSP 的实际应用。</p>
<h3 data-id="heading-9">1. 基础：CSP 的 “指令” 与 “源” 详解</h3>
<h4 data-id="heading-10">（1）核心指令：管控不同类型的资源</h4>
<p>CSP 提供了数十种指令，覆盖各类资源和行为，以下是最常用的 8 个指令：</p>


















































<table><thead><tr><th>指令（Directive）</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>default-src</code></td><td>所有资源的 “默认加载规则”，当其他指令（如<code>script-src</code>）未配置时，会继承<code>default-src</code>的规则</td><td><code>default-src 'self'</code>（默认仅允许加载自身域名资源）</td></tr><tr><td><code>script-src</code></td><td>管控 JavaScript 脚本的加载与执行（最关键的指令之一）</td><td><code>script-src 'self' https://cdn.jsdelivr.net</code></td></tr><tr><td><code>style-src</code></td><td>管控 CSS 样式表的加载与执行</td><td><code>style-src 'self' https://fonts.googleapis.com</code></td></tr><tr><td><code>img-src</code></td><td>管控图片资源（jpg、png、svg 等）的加载</td><td><code>img-src 'self' https://img.baidu.com data:</code></td></tr><tr><td><code>font-src</code></td><td>管控字体文件（woff、ttf 等）的加载</td><td><code>font-src 'self' https://fonts.gstatic.com</code></td></tr><tr><td><code>frame-src</code></td><td>管控 iframe 嵌套的来源</td><td><code>frame-src 'none'</code>（禁止所有 iframe）</td></tr><tr><td><code>report-uri</code> / <code>report-to</code></td><td>指定违规报告的接收地址（<code>report-uri</code>是旧标准，<code>report-to</code>是新标准，建议同时配置）</td><td><code>report-uri /csp-report; report-to csp-endpoint</code></td></tr><tr><td><code>object-src</code></td><td>管控插件资源（如 Flash、Java Applet，现在较少使用）</td><td><code>object-src 'none'</code>（禁止所有插件）</td></tr></tbody></table>
<h4 data-id="heading-11">（2）常见 “源” 值：定义 “安全的资源来源”</h4>
<p>“源” 是指令后紧跟的 “允许加载的资源地址”，支持多种格式，以下是最常用的 5 种：</p>



































<table><thead><tr><th>源（Source）</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>'self'</code></td><td>允许加载当前网站的同源资源（同协议、同域名、同端口）</td><td><code>default-src 'self'</code></td></tr><tr><td>完整域名</td><td>允许加载指定域名的资源（可带端口，默认 80/443）</td><td><code>script-src https://cdn.example.com:8443</code></td></tr><tr><td>通配符域名</td><td>允许加载指定域名下的所有子域名（如<code>*.example.com</code>）</td><td><code>img-src *.example.com</code></td></tr><tr><td><code>data:</code></td><td>允许加载 Base64 编码的资源（如<code>data:image/png;base64,...</code>）</td><td><code>img-src data:</code></td></tr><tr><td><code>'none'</code></td><td>禁止加载该类型的所有资源</td><td><code>frame-src 'none'</code></td></tr></tbody></table>
<p>⚠️ 注意：<code>'self'</code>、<code>'none'</code>、<code>'unsafe-inline'</code>等带引号的值，<strong>必须使用单引号包裹</strong>，否则浏览器会将其识别为 “域名”（如<code>self</code>会被当作<code>self.com</code>），导致规则失效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端进阶系列之《浏览器渲染原理》]]></title>    <link>https://juejin.cn/post/7577905525996732457</link>    <guid>https://juejin.cn/post/7577905525996732457</guid>    <pubDate>2025-11-29T23:47:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525996732457" data-draft-id="7577291435159797801" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端进阶系列之《浏览器渲染原理》"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-29T23:47:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不要想太多"/> <meta itemprop="url" content="https://juejin.cn/user/2840793778760654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端进阶系列之《浏览器渲染原理》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793778760654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不要想太多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T23:47:50.000Z" title="Sat Nov 29 2025 23:47:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-cave-dark">.hljs-comment,.hljs-quote{color:#7e7887}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#be4678}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa573c}.hljs-bullet,.hljs-string,.hljs-symbol{color:#2a9292}.hljs-section,.hljs-title{color:#576ddb}.hljs-keyword,.hljs-selector-tag{color:#955ae7}.hljs-addition,.hljs-deletion{color:#19171c;display:inline-block;width:100%}.hljs-deletion{background-color:#be4678}.hljs-addition{background-color:#2a9292}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#19171c;color:#8b8792}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想搞懂浏览器是怎么变魔术，把代码变成眼前漂亮页面的吗？🎩✨ 这次我们就以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.baidu.com%2F" target="_blank" title="https://www.baidu.com/" ref="nofollow noopener noreferrer">www.baidu.com/</a> 为例，一起揭开这场视觉魔术的幕后秘密！从前端代码到流畅的用户界面，每一步都藏着超有意思的细节，也是我们打造高性能前端应用的核心基石～快跟上我，一起探索这场奇妙的页面诞生记吧！🚀</p>
<blockquote>
<p>当我们打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.baidu.com%2F" target="_blank" title="https://www.baidu.com/" ref="nofollow noopener noreferrer">www.baidu.com/</a> 如何渲染出下面的界面</p>
<p>以 Chrome 浏览器为例</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90e353d1deec43c68550b92d7f26ac33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=BRDfDZa7V1TpnkSPLQiar3nop3s%3D" alt="baidu.com.png" loading="lazy"/></p>
<h2 data-id="heading-0">1、浏览器的多进程架构</h2>
<blockquote>
<p>首先浏览器会分配几个进程，页面的渲染是多个进程之间相互配合的结果</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611a5986038e4051b2d7cad35507f9c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=O6988kahu2hhG3jk3khH6UJQUwE%3D" alt="5.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d90270b356fd48e6add17c6836933e90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=WH5gFevAqwWOHlpgcnwGZNVlKjs%3D" alt="6.png" loading="lazy"/></p>
<ul>
<li>浏览器进程：主要负责界面显示、用户交互，同时提供存储等功能</li>
<li>渲染进程：核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，包含排版引擎 Blink、V8 JS 引擎，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程</li>
<li>网络进程：主要负责页面的网络资源加载</li>
<li>GPU 进程：只有一个 GPU 进程，为所有浏览器 Tab 标签页服务。它负责与 GPU 硬件直接通信，执行页面光栅化和合成操作</li>
<li>Spare Renderer（Chrome 备用渲染进程）： 是一个在后台提前准备好的、空闲的网页渲染进程，目的是提升用户体验和浏览速度而采用的一种优化策略</li>
<li>插件进程：主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离</li>
</ul>
<p>页面的渲染需要多进程之间相互搭配，重点在于浏览器进程、渲染进程、网络进程、GPU进程之间的配合</p>
<h2 data-id="heading-1">2、HTTP 请求过程</h2>
<p>浏览器中的 HTTP 请求从发起到结束一共经历了如下八个阶段：</p>
<ul>
<li>
<p>构建请求：<code>GET https://www.baidu.com/ HTTP2</code></p>
</li>
<li>
<p>查找缓存：当浏览器发现请求的资源已经在浏览器缓存中存有副本，它会拦截请求，返回该资源的副本，并直接结束请求，而不会再去源服务器重新下载</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e7d009f3eeb44f8a9a43324346f6cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=v%2B%2BVqeS54YTYF43n4DjQ3UTldjE%3D" alt="1.webp" loading="lazy"/></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">*</span> 缓存方式：强制缓存/协商缓存 200 304 Cache-Control/Last-Modified/ETag

<span class="hljs-bullet">*</span> 缓存分类：Memory Cache/Disk Cache/Service Worker/Push Cache（HTTP 2）
</code></pre>
<ul>
<li>准备 IP 和端口：请求 DNS 系统返回域名对应的 IP、端口<code>www.baidu.com：170.114.52.116:443</code></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b32c4f1625fd4ce1be246d6ee70525f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=%2Bj%2BtiOWQ7E3VKs0%2Fef0gJRRHwW8%3D" alt="2.png" loading="lazy"/></p>
<ul>
<li>
<p>等待 TCP 队列：同一个域名同时最多只能建立 6 个 TCP（http1.1） 连接，其他请求进入排队等待</p>
</li>
<li>
<p>建立 TCP 连接：三次握手，客户端和服务器总共要发送三个数据包以确认连接的建立</p>
</li>
<li>
<p>发起 HTTP 请求：HTTP 请求行、请求头、请求体</p>
</li>
<li>
<p>服务器处理请求/服务器返回请求：返回响应行、响应头、响应体</p>
</li>
<li>
<p>断开连接：执行"四次挥手"来保证双方都能断开连接</p>
</li>
</ul>
<h2 data-id="heading-2">3、从输入 URL 到页面展示</h2>
<blockquote>
<p>整个过程需要各个进程之间的配合，如下图所示</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/060102af273a45e2808f53d20f7ddd68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=uZafNkcRJiNYctUDgcxy2WX%2Bbdo%3D" alt="3.webp" loading="lazy"/></p>
<ul>
<li>
<p>用户输入：浏览器进程判断输入的关键字是搜索内容，还是请求的 URL，整合成完整的 URL</p>
</li>
<li>
<p>URL 请求过程：浏览器进程会通过 IPC 把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会发起请求，执行步骤二。这里补充几个重要的知识点</p>
<blockquote>
<ul>
<li>
<p>响应状态码：301/302 200 304 400 500…</p>
</li>
<li>
<p>响应类型（Content-Type）：服务器返回的响应体数据是什么类</p>
</li>
</ul>
</blockquote>
<blockquote>
<pre><code class="hljs language-bash" lang="bash">1.  text/html：服务器返回的数据是 HTML 格式，触发渲染流程
2.  application/octet-stream：数据是字节流类型的，触发下载流程
3.  application/json：JSON 字段，前后端常见类型
4.  text/css｜text/javascript ｜application/javascript：CSS 文件、JS 文件
</code></pre>
</blockquote>
</li>
<li>
<p>准备渲染进程：网络进程将响应信息传递给浏览器进程，如果是 text/html，则渲染进程准备接收数据</p>
</li>
<li>
<p>提交文档：文档可以理解为响应体即返回的 HTML 内容</p>
<blockquote>
<ul>
<li>所谓提交文档，就是指浏览器进程将网络进程接收到的 HTML 数据提交给渲染进程</li>
<li>渲染进程接收到"提交文档"的消息后，会和网络进程建立传输数据的"管道"</li>
</ul>
</blockquote>
</li>
<li>
<p>渲染阶段：当渲染进程接收到网络进程的响应数据时，便开始页面解析和子资源加载了，边加载边解析</p>
</li>
</ul>
<p>接下来就进入到另外一个部分，渲染进程将网络进程接收到的 HTML + CSS + JS 生成页面，如下图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42ccb82030af449ea565b17e531836b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=i4S3W2UD5axmgGP5lVLdgz%2F%2FxhQ%3D" alt="4.webp" loading="lazy"/></p>
<h2 data-id="heading-3">4、页面渲染流程 - 渲染流水线</h2>
<p>当网络进程和渲染进程建立管道链接时，渲染进程便可以接收 HTML CSS JS 等数据，接下来渲染进程开始渲染工作。但渲染机制过于复杂，在执行过程中会被划分为很多子阶段，输入的 HTML 经过这些子阶段显示成页面，这样的处理流程叫做渲染流水线</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7076fb168f044d0893afb5105e06ee96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=tX7sRWcKe3SNtRSOjXapPlshaUU%3D" alt="6.webp" loading="lazy"/></p>
<p>按照渲染的时间顺序，流水线可分为如下几个子阶段：</p>
<p>构建 DOM 树、样式计算、布局阶段、分层、绘制、栅格化和合成</p>
<h3 data-id="heading-4">4.1 构建 DOM 树</h3>
<blockquote>
<p>浏览器无法直接理解和使用服务器返回的 HTML，所以需要将 HTML 转换为浏览器能够理解的结构——DOM 树， HTML 经过 HTML 解析器解析，生成树状结构的 DOM</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1addf32e715f4e749b339c8c5758a677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=kcW7FPTXS%2FRFR5%2FojEOb%2Fpx%2FAeQ%3D" alt="7.webp" loading="lazy"/></p>
<h3 data-id="heading-5">4.2 样式计算</h3>
<blockquote>
<p>样式计算的目的是为了计算出 DOM 节点中每个元素的具体样式，这个阶段大体可分为三步来完成</p>
</blockquote>
<ol>
<li>把 CSS 转换为浏览器能够理解的结构：styleSheets</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/062e8dded5354e588de28bc0e32a382d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=1XD%2BchD%2FMZbfWHt8DVuJfDcNt9w%3D" alt="8.webp" loading="lazy"/></p>
<ol start="2">
<li>转换样式表中的属性值，使其标准化</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43af6b790b85415bb451dd2afa7496f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=CukPSRb%2B95120umOARU6Y72vTHY%3D" alt="9.webp" loading="lazy"/></p>
<ol start="3">
<li>计算出 DOM 树中每个节点的具体样式：继承规则和层叠规则</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03fd778c95714eb7afed29877c8d13ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=l55TVmGcaoxzm%2ByXjjwzEJ%2BgulM%3D" alt="11.webp" loading="lazy"/></p>
<h3 data-id="heading-6">4.3 布局阶段</h3>
<blockquote>
<p>现在我们有 DOM 树和 DOM 树中元素的样式，接下来需要计算出 DOM 树中可见元素的几何位置，我们把这个计算过程叫做布局</p>
</blockquote>
<p>创建布局树：只包含可见元素的的布局树</p>
<ul>
<li>渲染进程遍历 DOM 树中的所有可见节点，并把这些节点加到布局树中；</li>
<li>而不可见的节点会被布局树忽略掉，如 head 标签下面的全部内容、display：none</li>
</ul>
<p>布局计算：计算布局树的几何位置</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0298055a4b7406a9c167ed007bc9ff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=tuhsCh79VMR4QmZvV7dlgWOmuOM%3D" alt="-1.webp" loading="lazy"/></p>
<p>到这里我们完成了渲染流程的前三个阶段：DOM 生成、样式计算和布局，像下图一样</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38fafaf67d564765849d15df0f9da5a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=ZAvJ5DoBpJW6Gnn4mXr9vLr941Q%3D" alt="-2.png" loading="lazy"/></p>
<h3 data-id="heading-7">4.4 分层</h3>
<blockquote>
<p>我们看到的界面都是多个图层相互叠加的结果，类似于 PS 的图层一样</p>
<p>position：fixed、z-indexing 做 z 轴排序都会有新的图层</p>
</blockquote>
<p>渲染引擎需要为节点生成专用的图层，并生成一棵对应的图层树（LayerTree），具有几个特点</p>
<ul>
<li>如果一个节点没有对应的层，那么这个节点就从属于父节点的图层</li>
<li>拥有层叠上下文属性的元素会被提升为单独的一层</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92fd13e7b77946c996dde781af94250f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=ZjAHq2sQ%2FrgMRtvuDJN8XAde3Co%3D" alt="-3.webp" loading="lazy"/></p>
<h3 data-id="heading-8">4.5 图层绘制</h3>
<blockquote>
<p>渲染引擎会把一个图层的绘制拆分成很多小的绘制指令，然后再把这些指令按照顺序组成一个待绘制列表，如下图所示</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8419954e7054a288e8a6837f6d7a3e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=G5tHj8wvbSQl6Fdp8wu6L%2BG0ozg%3D" alt="-4.webp" loading="lazy"/></p>
<ul>
<li>绘制列表中的指令其实非常简单，就是让其执行一个简单的绘制操作，比如绘制粉色矩形或者黑色的线等</li>
<li>而绘制一个元素通常需要好几条绘制指令，因为每个元素的背景、前景、边框都需要单独的指令去绘制</li>
<li>所以在图层绘制阶段，产生的内容就是这些待绘制列表</li>
</ul>
<h3 data-id="heading-9">4.5 栅格化（复杂）</h3>
<p>新的名称：合成线程</p>
<blockquote>
<p>合成线程 是渲染进程中独立于主线程的一个关键工作线程，它的主要目标是高效地将页面的不同部分合成最终的图像，并发送给GPU进行绘制，从而确保滚动、动画等操作极其流畅</p>
</blockquote>
<p>第 1 步：当图层的绘制列表准备好之后，主线程会把图层绘制列表提交给合成线程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c11d618879244910823280d6eeacfa00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=W5Pu8b2Zs5ypZfOrbXZ4AHORgtI%3D" alt="01.webp" loading="lazy"/></p>
<p>两个概念</p>
<ul>
<li>视口：通常页面很长，用户能看到的部分叫做视口</li>
<li>图块：合成线程会将图层划分为图块，这些图块的大小通常是 256 * 256 px 或者 512 * 512 px</li>
</ul>
<p>第 2 步：合成线程会为每个图块生成对应的光栅化任务</p>
<ul>
<li>这个任务包含了"图块的位置、图块所属图层的那部分绘制记录" 的信息</li>
<li>由渲染进程的栅格化线程执行，优先处理视口附近的图块</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/301a8d5c97b946a8985c6d60311194e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=JJ2XJioBQCU1EzQJR6yrICA3oQM%3D" alt="02.webp" loading="lazy"/></p>
<p>第 3 步：提交任务到 GPU 进程</p>
<ul>
<li>栅格化线程将这些光栅化任务以及相关的绘制记录（作为数据源）放入一个队列中</li>
<li>然后，它通过 IPC 将任务队列提交给 GPU 进程。进行 GPU加速</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/150efc4f7efa4375957915c22bbe6a74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=Q4xgs4DlMbB5pzPpLEQXodG2%2Fy8%3D" alt="03.webp" loading="lazy"/></p>
<p>第 4 步：GPU 进程与 GPU 硬件执行光栅化</p>
<ul>
<li>GPU 进程接收任务：GPU 进程收到来自渲染进程（合成线程）的任务队列。</li>
<li>进行光栅化操作</li>
</ul>
<p>什么是光栅化？</p>
<p>简单说，就是将矢量图形（如绘制记录中的矩形、路径、文字命令）转换为屏幕上的像素（位图）的过程。GPU 进程会驱动 GPU 硬件来执行实际的光栅化工作。它利用 GPU 上强大的、高度并行化的光栅化器来高效完成此任务</p>
<ul>
<li>结果存储：光栅化后的每个图块存储在 GPU 的显存中</li>
</ul>
<h3 data-id="heading-10">4.6 合成和显示</h3>
<p>第 1 步：生成绘制（DrawQuad）指令</p>
<ul>
<li>当所有（或优先的）图块都光栅化完成后，合成线程会收集每个图块在 GPU 显存中的位置信息（ID）</li>
</ul>
<p>第 2 步：和浏览器进程通信</p>
<ul>
<li>浏览器进程里面有一个叫 viz 的组件，用来接收合成线程发过来的合成图像</li>
<li>然后浏览器进程和 GPU 进程通信，发送合成帧</li>
</ul>
<p>第 3 步：GPU 进程驱动合成</p>
<ul>
<li>GPU 进程接收到合成帧后，会向 GPU 发送最终的绘制命令</li>
<li>GPU 根据合成帧的指令，将各个图块纹理（就像一张张图片）绘制到屏幕缓冲区的正确位置上</li>
</ul>
<p>以上这个过程就是合成 ，它通常通过非常高效的硬件加速操作（如纹理映射）来完成</p>
<p>显示：最终，屏幕的显示控制器从帧缓冲区读取数据，并将像素点亮，用户就看到了最终的页面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b7f22afad764f7dbbd738108c43f60e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=VKW5u26mpgr4JrVE5v7BJVbpPCo%3D" alt="06.webp" loading="lazy"/></p>
<p>结合上图，一个完整的渲染流程大致可总结为如下：</p>
<blockquote>
<ol>
<li>渲染进程将 HTML 内容转换为能够读懂的 DOM 树结构</li>
<li>渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式</li>
<li>创建布局树，并计算元素的布局信息</li>
<li>对布局树进行分层，并生成分层树</li>
<li>为每个图层生成绘制列表，并将其提交到合成线程</li>
<li>合成线程将图层分成图块，并在光栅化线程池中配合 GPU 将图块转换成位图</li>
<li>合成线程发送绘制图块命令 DrawQuad 给浏览器进程</li>
<li>浏览器进程根据 DrawQuad 消息生成页面，并显示到显示器上</li>
</ol>
</blockquote>
<h2 data-id="heading-11">5、拓展内容</h2>
<h3 data-id="heading-12">5.1 页面的重新渲染（重排、重绘）</h3>
<p>来介绍以下前端常说的渲染流水线中两个概念，重排、重绘</p>
<p>1、重排：更新元素的几何位置</p>
<blockquote>
<p>例如改变元素的宽度、高度等，那么浏览器会触发重新布局，解析之后的一系列子阶段，这个过程就叫重排。无疑，重排需要更新完整的渲染流水线，所以开销也是最大的</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07c8bfa528df4fb8ac89fc0254b73d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=KoMEs3LKojk5QcIHG6c1eUpkwXA%3D" alt="07.webp" loading="lazy"/></p>
<p>常见的引起重排的方式</p>
<ul>
<li>
<p>页面首次渲染</p>
</li>
<li>
<p>浏览器窗口大小发生变化</p>
</li>
<li>
<p>元素的内容发生变化</p>
</li>
<li>
<p>元素的尺寸或者位置发生变化</p>
</li>
<li>
<p>元素的字体大小发生变化</p>
</li>
<li>
<p>添加或者删除可见的DOM元素</p>
</li>
</ul>
<p>2、重绘：更新元素的绘制属性</p>
<blockquote>
<p>比如通过 JavaScript 更改某些元素的背景颜色，那么布局阶段将不会被执行，因为并没有引起几何位置的变换，相较于重排操作，重绘省去了布局和分层阶段，所以执行效率会比重排操作要高一些</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63a55f0c8d684574bc392111d7557fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=BckUddZSZaDVWQTqFXmNdm0TVx0%3D" alt="07.webp" loading="lazy"/></p>
<p>常见的引起重绘的方式</p>
<ul>
<li>改变颜色 (<code>color</code>, <code>background-color</code>)</li>
<li>改变可见性 (<code>visibility</code>)</li>
<li>改变边框样式（如 <code>border-style</code>，但不改变 <code>border-width</code>）</li>
<li>文本阴影 (<code>text-shadow</code>)</li>
</ul>
<h3 data-id="heading-13">5.2 性能优化</h3>
<p>分为两个阶段：加载阶段和交互阶段、关闭阶段</p>
<p>加载阶段</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a37ce90290d14e759713f9fff67b306d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=eMyrRIPUjUB6eadhW65nE9t5NNY%3D" alt="08_0.webp" loading="lazy"/></p>
<p>降低关键资源个数</p>
<p>降低关键资源大小：压缩代码、去除代码注释等</p>
<p>降低关键资源需要多少个 RTT：使用 CDN、缓存</p>
<p>交互阶段</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e00dd0f0821414699126710e66c491b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN6KaB5oOz5aSq5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765064870&amp;x-signature=VTKgv5i3XzDGjCNwI5LMG%2B90wfE%3D" alt="09.webp" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 体验报告：我让 TRAE SOLO 替我重构了 2000 行屎山代码，结果...]]></title>    <link>https://juejin.cn/post/7577737385954607114</link>    <guid>https://juejin.cn/post/7577737385954607114</guid>    <pubDate>2025-11-30T04:57:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954607114" data-draft-id="7577689171223380018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 体验报告：我让 TRAE SOLO 替我重构了 2000 行屎山代码，结果..."/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-30T04:57:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 体验报告：我让 TRAE SOLO 替我重构了 2000 行屎山代码，结果...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T04:57:15.000Z" title="Sun Nov 30 2025 04:57:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong>：每个程序员的硬盘里，大概都躺着一段不敢给人看的“屎山”代码。
上周，我翻出了三年前写的一个 Python 数据清洗脚本。那时的我还在用 <code>if-else</code> 堆砌逻辑，变量名全是 <code>a</code>, <code>b</code>, <code>temp</code>，没有类型标注，更别提单元测试。
借着 TRAE SOLO 发布的契机，我决定做一个大胆的实验：<strong>完全不写一行代码，只用自然语言（Vibe Coding），让 AI 帮我把这坨 2000 行的“祖传代码”重构成符合 SOLID 原则的现代工程。</strong>
结果有点出乎意料。</p>
</blockquote>
<h2 data-id="heading-0">祖传代码的“味道”</h2>
<p>那个脚本的任务很简单：从 10 个不同的 CSV 文件里读取销售数据，清洗脏数据，然后生成一张报表。</p>
<p>但它的实现方式简直是灾难：</p>
<ul>
<li><strong>面向过程</strong>：所有的逻辑都写在一个 2000 行的 <code>main.py</code> 里。</li>
<li><strong>硬编码</strong>：文件路径、列名、阈值全写死在代码里。</li>
<li><strong>异常吞噬</strong>：到处都是 <code>try: ... except: pass</code>，一旦报错根本找不到原因。</li>
</ul>
<p>每当业务方要求“加个新字段”或者“改个计算逻辑”，我就得戴着痛苦面具在代码堆里翻找半天。</p>
<h2 data-id="heading-1">Vibe Coding：像产品经理一样写代码</h2>
<p>以前我们重构代码，是盯着屏幕一行行改。而在 TRAE SOLO 里，我只需要<strong>把需求描述清楚</strong>。</p>
<p>我打开 TRAE SOLO 的对话框，输入了这样一段 Prompt：</p>
<blockquote>
<p>“读取当前项目中的 <code>legacy_script.py</code>。这是一个老旧的数据处理脚本。请帮我将其重构为面向对象的架构。要求：</p>
<ol>
<li>使用策略模式（Strategy Pattern）来处理不同来源的数据清洗规则。</li>
<li>引入 Pydantic 进行数据校验。</li>
<li>将配置项提取到 YAML 文件中。</li>
<li>保持逻辑不变，但代码必须优雅。”</li>
</ol>
</blockquote>
<p>接下来发生的事情，让我这个老兵都有点坐不住了。</p>
<p>TRAE SOLO 并没有直接给我甩一段代码，而是<strong>先生成了一个文件树结构</strong>，问我：“这样的目录结构你觉得如何？”</p>
<pre><code class="hljs language-text" lang="text">project/
├── config/
│   └── settings.yaml
├── src/
│   ├── models/      # Pydantic 模型
│   ├── strategies/  # 清洗策略
│   ├── loader.py    # 数据加载
│   └── main.py
└── tests/
</code></pre>
<p>得到我的确认后，它开始疯狂输出。</p>
<h2 data-id="heading-2">重构实战：从“面条代码”到“设计模式”</h2>
<p>让我们看看它重构前后的核心逻辑对比。</p>
<h3 data-id="heading-3">原始代码（辣眼睛版）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 典型的面条代码</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>(<span class="hljs-params">file_path</span>):
    data = []
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
            cols = line.split(<span class="hljs-string">','</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(cols) &lt; <span class="hljs-number">5</span>: <span class="hljs-keyword">continue</span> <span class="hljs-comment"># 这里的 5 是啥意思？</span>
            <span class="hljs-keyword">if</span> cols[<span class="hljs-number">2</span>] == <span class="hljs-string">'US'</span>:
                <span class="hljs-comment"># 一堆复杂的 if-else</span>
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">float</span>(cols[<span class="hljs-number">3</span>]) &gt; <span class="hljs-number">1000</span>:
                    data.append(cols)
            <span class="hljs-keyword">elif</span> cols[<span class="hljs-number">2</span>] == <span class="hljs-string">'CN'</span>:
                <span class="hljs-comment"># 另一堆逻辑...</span>
    <span class="hljs-keyword">return</span> data
</code></pre>
<h3 data-id="heading-4">重构后的代码（赏心悦目版）</h3>
<p>TRAE SOLO 自动识别出了不同国家的处理逻辑差异，并将其封装为策略类。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> abc <span class="hljs-keyword">import</span> ABC, abstractmethod
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

<span class="hljs-comment"># 1. 定义数据模型，强类型约束</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    region: <span class="hljs-built_in">str</span>
    amount: <span class="hljs-built_in">float</span> = Field(gt=<span class="hljs-number">0</span>)
    currency: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 2. 定义抽象策略</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CleaningStrategy</span>(<span class="hljs-title class_ inherited__">ABC</span>):
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clean</span>(<span class="hljs-params">self, record: SalesRecord</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">pass</span>

<span class="hljs-comment"># 3. 具体策略实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">USRegionStrategy</span>(<span class="hljs-title class_ inherited__">CleaningStrategy</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clean</span>(<span class="hljs-params">self, record: SalesRecord</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-comment"># 业务逻辑清晰可见</span>
        <span class="hljs-keyword">return</span> record.amount &gt; <span class="hljs-number">1000</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CNRegionStrategy</span>(<span class="hljs-title class_ inherited__">CleaningStrategy</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clean</span>(<span class="hljs-params">self, record: SalesRecord</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span> <span class="hljs-comment"># CN 地区暂无特殊过滤</span>

<span class="hljs-comment"># 4. 上下文调用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessor</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, strategy: CleaningStrategy</span>):
        self.strategy = strategy

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">self, records: <span class="hljs-type">List</span>[SalesRecord]</span>):
        <span class="hljs-keyword">return</span> [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> records <span class="hljs-keyword">if</span> self.strategy.clean(r)]
</code></pre>
<p>不仅仅是代码变好看了。更重要的是，<strong>扩展性</strong>有了质的飞跃。以后再加一个“JP 地区”，我只需要新建一个 <code>JPRegionStrategy</code> 类，完全不用动核心逻辑。</p>
<p>这一切，我连一行代码都没敲，全是 TRAE SOLO 生成的。</p>
<h2 data-id="heading-5">避坑与反思：AI 真的能完全替代人吗？</h2>
<p>爽归爽，在整个过程中我也发现了几个必须人工干预的坑：</p>
<h3 data-id="heading-6">1. 业务逻辑的“细微丢失”</h3>
<p>在原始代码里，有一行不起眼的注释：<code># 2021年以前的数据不处理</code>。
TRAE SOLO 在重构时，因为这行逻辑写得太隐晦（藏在一个复杂的 <code>if</code> 里），直接给漏掉了。
<strong>教训</strong>：Vibe Coding 不代表你可以当甩手掌柜。<strong>Review 代码</strong>依然是核心工作，尤其是边界条件。</p>
<h3 data-id="heading-7">2. 过度设计的倾向</h3>
<p>一开始，TRAE SOLO 给每个策略类都搞了个工厂模式，还引入了依赖注入容器。对于一个只有 2000 行的小项目，这有点杀鸡用牛刀。
我不得不告诉它：“Keep it simple，去掉 DI 容器，直接用简单的工厂函数。”</p>
<h3 data-id="heading-8">3. 测试覆盖率的假象</h3>
<p>它生成了单元测试，跑通也是全绿。但我仔细一看，它只测了“正常路径”，对于脏数据、空文件等异常情况完全没覆盖。
<strong>教训</strong>：AI 擅长写 Happy Path，<strong>Dirty Path</strong> 还是得靠经验丰富的老鸟去补全。</p>
<h2 data-id="heading-9">结语</h2>
<p>这次重构体验，让我对“AI 辅助编程”有了新的认知。</p>
<p>Vibe Coding 不是让你把大脑丢掉，而是让你从<strong>打字员</strong>升级为<strong>技术总监</strong>。你不再需要关心 <code>import</code> 哪个包，<code>for</code> 循环怎么写，而是把精力集中在<strong>接口设计、模块划分和业务边界</strong>上。</p>
<p>那个 2000 行的脚本，最终被重构成了 600 行清晰、模块化的 Python 代码。</p>
<p><strong>TRAE SOLO 没能替我重构整个世界，但它确实帮我把那座“屎山”，变成了一座精致的花园。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TS和JS成员变量修饰符]]></title>    <link>https://juejin.cn/post/7577675494068158490</link>    <guid>https://juejin.cn/post/7577675494068158490</guid>    <pubDate>2025-11-30T01:28:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494068158490" data-draft-id="7577693903018672154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TS和JS成员变量修饰符"/> <meta itemprop="keywords" content="TypeScript,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T01:28:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Robet"/> <meta itemprop="url" content="https://juejin.cn/user/193141028175320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TS和JS成员变量修饰符
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/193141028175320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Robet
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T01:28:48.000Z" title="Sun Nov 30 2025 01:28:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 TypeScript 和 JavaScript 中，<strong>类成员变量（属性）的修饰符（Modifiers）</strong> 用于控制其<strong>可见性、可访问性和可变性</strong>。两者在能力上有显著差异：<strong>TypeScript 提供了更丰富的编译时修饰符</strong>，而 <strong>JavaScript（ES2022 起）引入了运行时私有字段</strong>。</p>
<p>下面从 <strong>TypeScript</strong> 和 <strong>JavaScript</strong> 两个角度分别说明，并对比异同。</p>
<hr/>
<h2 data-id="heading-0">一、TypeScript 类成员变量修饰符（编译时）</h2>
<p>TypeScript 在 <strong>编译阶段</strong> 提供以下关键字作为访问修饰符：</p>



































<table><thead><tr><th>修饰符</th><th>含义</th><th>是否生成 JS 代码</th><th>可见性</th></tr></thead><tbody><tr><td><code>public</code></td><td>公共（默认）</td><td>❌ 不生成额外代码</td><td>类内、子类、外部均可访问</td></tr><tr><td><code>private</code></td><td>私有</td><td>❌ 仅类型检查，<strong>不阻止运行时访问</strong></td><td>仅类内部可访问（TS 编译时报错）</td></tr><tr><td><code>protected</code></td><td>受保护</td><td>❌ 仅类型检查</td><td>类内部 + 子类可访问</td></tr><tr><td><code>readonly</code></td><td>只读</td><td>❌ 仅类型检查</td><td>初始化后不可修改（TS 报错）</td></tr></tbody></table>
<h3 data-id="heading-1">✅ 示例（TypeScript）：</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;        <span class="hljs-comment">// 默认就是 public</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;         <span class="hljs-comment">// TS 禁止外部访问</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;    <span class="hljs-comment">// 子类可访问</span>
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>;   <span class="hljs-comment">// 初始化后不可改</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, id: <span class="hljs-built_in">number</span>, email: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">email</span> = email;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">createdAt</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
  }
}
</code></pre>
<blockquote>
<p>⚠️ 注意：<br/>
<code>private</code> / <code>protected</code> <strong>只在 TypeScript 编译时生效</strong>，编译成 JS 后，这些字段仍是普通属性，<strong>运行时仍可被访问或修改</strong>！</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">// 编译后的 JS（无 private 保护！）
const <span class="hljs-attr">user</span> = new User(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"a@example.com"</span>)<span class="hljs-comment">;</span>
console.log(user.id)<span class="hljs-comment">; // ✅ 能访问！JS 不报错</span>
<span class="hljs-attr">user.id</span> = <span class="hljs-number">999</span><span class="hljs-comment">;        // ✅ 能修改！</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">二、JavaScript 类成员变量修饰符（运行时，ES2022+）</h2>
<p>从 <strong>ECMAScript 2022（ES13）</strong> 开始，JavaScript 原生支持 <strong>真正的私有字段（Private Fields）</strong> ，使用 <code>#</code> 前缀。</p>























<table><thead><tr><th>语法</th><th>含义</th><th>运行时是否私有</th><th>是否可被外部访问</th></tr></thead><tbody><tr><td><code>#fieldName</code></td><td>私有字段</td><td>✅ 是</td><td>❌ 完全无法从类外访问</td></tr><tr><td>普通字段（无前缀）</td><td>公共字段</td><td>❌ 否</td><td>✅ 可自由访问</td></tr></tbody></table>
<h3 data-id="heading-3">✅ 示例（JavaScript / TypeScript 均支持）：</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-meta">#id;                    <span class="hljs-comment">// 私有字段（JS 原生私有）</span></span>
  name;                   <span class="hljs-comment">// 公共字段</span>

  <span class="hljs-built_in">constructor</span>(name, id) {
    <span class="hljs-keyword">this</span>.name = name;
    <span class="hljs-keyword">this</span>.<span class="hljs-meta">#id = id;        <span class="hljs-comment">// 只能在类内部访问</span></span>
  }

  <span class="hljs-built_in">getId</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-meta">#id;      <span class="hljs-comment">// ✅ OK</span></span>
  }
}

<span class="hljs-type">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-built_in">User</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">2</span>);
console.<span class="hljs-built_in">log</span>(user.name);   <span class="hljs-comment">// ✅ "Bob"</span>
console.<span class="hljs-built_in">log</span>(user.<span class="hljs-meta">#id);    <span class="hljs-comment">// ❌ SyntaxError! 无法访问</span></span>
</code></pre>
<blockquote>
<p>✅ <strong>关键优势</strong>：<br/>
<code>#id</code> 是<strong>真正的私有</strong>，即使在运行时也无法绕过（除非用 Proxy 等 hack，但正常代码做不到）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">三、TypeScript 对 JS 私有字段的支持</h2>
<p>TypeScript <strong>完全支持 <code>#</code> 私有字段</strong>，并提供类型检查：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  #<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, id: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.#id = id;
  }

  <span class="hljs-title function_">getId</span>(): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.#id; <span class="hljs-comment">// ✅ TS 知道这是 number</span>
  }
}
</code></pre>
<blockquote>
<p>🔸 此时你<strong>不需要</strong>用 <code>private</code>，因为 <code>#id</code> 已经是运行时私有。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">四、对比总结</h2>



































<table><thead><tr><th>特性</th><th>TypeScript <code>private</code></th><th>JavaScript <code>#field</code></th></tr></thead><tbody><tr><td><strong>作用时机</strong></td><td>编译时（类型检查）</td><td>运行时（真实私有）</td></tr><tr><td><strong>能否被外部访问</strong></td><td>✅ 能（JS 无保护）</td><td>❌ 不能</td></tr><tr><td><strong>是否生成额外代码</strong></td><td>❌ 否</td><td>✅ 是（保留 <code>#</code> 语法）</td></tr><tr><td><strong>兼容性</strong></td><td>所有 JS 环境（因被擦除）</td><td>需要 ES2022+ 或 Babel 转译</td></tr><tr><td><strong>推荐场景</strong></td><td>快速开发、内部项目</td><td>需要真正封装、库开发</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">五、最佳实践建议</h2>
<h3 data-id="heading-7">✅ 优先使用 <strong>JavaScript 原生私有字段 <code>#</code></strong></h3>
<ul>
<li>如果目标环境支持（现代浏览器 / Node.js 12+），<strong>优先用 <code>#fieldName</code></strong>。</li>
<li>它提供<strong>真正的封装</strong>，避免“假装私有”的陷阱。</li>
</ul>
<h3 data-id="heading-8">✅ 在 TypeScript 中：</h3>
<ul>
<li>若需兼容旧环境 → 用 <code>private</code>（但要清楚它只是“纸面私有”）。</li>
<li>若用现代环境 → <strong>直接用 <code>#</code></strong> ，无需 <code>private</code>。</li>
</ul>
<h3 data-id="heading-9">✅ 不要混用：</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// ❌ 不推荐：语义重复且混乱</span>
<span class="hljs-keyword">private</span> <span class="hljs-meta">#id; <span class="hljs-comment">// 错误！不能同时用</span></span>
</code></pre>
<h3 data-id="heading-10">✅ <code>readonly</code> 仍是 TS 特有（JS 无等价物）</h3>
<ul>
<li>
<p>可配合 <code>#</code> 使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
  <span class="hljs-keyword">readonly</span> #<span class="hljs-attr">apiUrl</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.#apiUrl = url; <span class="hljs-comment">// 初始化后不可变（TS 检查）</span>
  }
}
</code></pre>
</li>
</ul>
<hr/>
<h2 data-id="heading-11">六、补充：其他相关修饰符</h2>

























<table><thead><tr><th>修饰符</th><th>语言</th><th>说明</th></tr></thead><tbody><tr><td><code>static</code></td><td>TS &amp; JS</td><td>静态成员（属于类，不属于实例）</td></tr><tr><td><code>abstract</code></td><td>TS only</td><td>抽象类/方法（不能实例化）</td></tr><tr><td><code>declare</code></td><td>TS only</td><td>声明属性存在（用于 .d.ts 或装饰器）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">✅ 总结</h2>

























<table><thead><tr><th>需求</th><th>推荐方案</th></tr></thead><tbody><tr><td><strong>真正的私有字段</strong></td><td>使用 JavaScript <code>#fieldName</code>（ES2022+）</td></tr><tr><td><strong>仅开发时提醒（兼容旧环境）</strong></td><td>使用 TypeScript <code>private</code></td></tr><tr><td><strong>只读属性</strong></td><td>TypeScript <code>readonly</code>（JS 无原生支持）</td></tr><tr><td><strong>公共字段</strong></td><td>直接声明（TS/JS 均默认 public）</td></tr></tbody></table>
<blockquote>
<p>🎯 <strong>现代项目建议</strong>：<br/>
<strong>用 <code>#</code> 实现私有，用 <code>readonly</code> 实现只读，放弃 <code>private</code>（除非必须兼容旧 JS）</strong> 。</p>
</blockquote>
<p>这样既能获得类型安全，又能保证运行时封装性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别让 API Key 裸奔：基于 TRAE SOLO 的大模型安全配置最佳实践]]></title>    <link>https://juejin.cn/post/7577681092138647587</link>    <guid>https://juejin.cn/post/7577681092138647587</guid>    <pubDate>2025-11-30T05:01:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577681092138647587" data-draft-id="7577681092138631203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别让 API Key 裸奔：基于 TRAE SOLO 的大模型安全配置最佳实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-30T05:01:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别让 API Key 裸奔：基于 TRAE SOLO 的大模型安全配置最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:01:52.000Z" title="Sun Nov 30 2025 05:01:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong>：前几天，我的一位创业朋友半夜给我打电话，声音都在抖。因为开发实习生不小心把带有 <code>sk-</code> 开头的 OpenAI Key 提交到了 GitHub 公开仓库。短短 15 分钟，信用卡被刷爆了 2000 美元。
这种“惨案”在 AI 开发圈子里简直太常见了。很多时候，我们只顾着让模型跑起来，却忘了给它穿上“防弹衣”。
今天不谈复杂的 DevSecOps，只聊聊在日常开发中，如何利用 <strong>TRAE SOLO</strong> 的原生能力，以最低的成本构建一套“防手抖”的 API Key 安全管理流程。</p>
</blockquote>
<h2 data-id="heading-0">那些年我们踩过的安全雷区</h2>
<p>你现在的代码里，是不是还藏着这样的“定时炸弹”？</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 绝对禁止的写法</span>
client = OpenAI(api_key=<span class="hljs-string">"sk-abcdefg123456..."</span>) 
</code></pre>
<p>或者稍微好一点，用了 <code>.env</code> 文件，但却忘了把它加到 <code>.gitignore</code> 里，结果一次 <code>git push</code>，全世界都看到了你的密钥。</p>
<p>更隐蔽的风险是<strong>日志泄露</strong>。调试的时候随手打印一句 <code>print(request.headers)</code>，密钥就堂而皇之地躺在了服务器日志里，被 ELK 采集走，让运维小哥看个正着。</p>
<p>这些低级错误，光靠“小心”是防不住的。我们需要的是工具层面的<strong>强制约束</strong>。</p>
<h2 data-id="heading-1">环境变量的“正确打开方式”</h2>
<p>在 TRAE SOLO 中，管理环境变量不再需要手动创建 <code>.env</code> 文件并祈祷别提交错。它内置的配置管理机制，天然支持<strong>本地开发与生产环境的隔离</strong>。</p>
<h3 data-id="heading-2">1. 利用 TRAE SOLO 的配置注入</h3>
<p>TRAE SOLO 允许我们在 IDE 层面配置密钥，而不是写在项目文件里。这意味着，即使你把整个项目文件夹打包发给别人，密钥也不会泄露。</p>
<p>我们可以编写一个简单的配置加载器，配合 Pydantic 的 <code>BaseSettings</code>，实现强类型的配置管理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic_settings <span class="hljs-keyword">import</span> BaseSettings, SettingsConfigDict
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> Field, SecretStr

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppSettings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    <span class="hljs-comment"># 使用 SecretStr 类型，防止 print() 时意外打印明文</span>
    openai_api_key: SecretStr = Field(..., alias=<span class="hljs-string">"OPENAI_API_KEY"</span>)
    deepseek_api_key: SecretStr = Field(..., alias=<span class="hljs-string">"DEEPSEEK_API_KEY"</span>)
    
    <span class="hljs-comment"># 允许从 .env 文件加载，但优先级低于环境变量</span>
    model_config = SettingsConfigDict(
        env_file=<span class="hljs-string">".env"</span>, 
        env_file_encoding=<span class="hljs-string">"utf-8"</span>,
        extra=<span class="hljs-string">"ignore"</span>
    )

<span class="hljs-comment"># 实例化配置</span>
settings = AppSettings()

<span class="hljs-comment"># ✅ 安全的使用方式</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Key loaded: <span class="hljs-subst">{settings.openai_api_key}</span>"</span>) 
<span class="hljs-comment"># 输出: Key loaded: ********** (Pydantic 会自动脱敏)</span>
</code></pre>
<h3 data-id="heading-3">2. 编写 Git 提交前的“看门狗”</h3>
<p>TRAE SOLO 的 <code>DiffView</code> 功能不仅能看代码差异，配合 <code>pre-commit</code> 钩子，还能成为一道安全防线。</p>
<p>我们可以配置一个简单的 Python 脚本作为 <code>pre-commit</code> hook，在提交前扫描所有变动文件，检测是否包含 <code>sk-</code> 等敏感特征。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># scripts/scan_secrets.py</span>
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># 定义敏感特征正则</span>
PATTERNS = [
    <span class="hljs-string">r"sk-[a-zA-Z0-9]{20,}"</span>,  <span class="hljs-comment"># OpenAI 风格</span>
    <span class="hljs-string">r"x-api-key.*['\"]"</span>,      <span class="hljs-comment"># 通用 API Key</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_files</span>(<span class="hljs-params">files</span>):
    found_secrets = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">for</span> file_path <span class="hljs-keyword">in</span> files:
        content = Path(file_path).read_text(encoding=<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'ignore'</span>)
        <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> PATTERNS:
            <span class="hljs-keyword">if</span> re.search(pattern, content):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚨 警告: 在 <span class="hljs-subst">{file_path}</span> 中发现疑似 API Key！"</span>)
                found_secrets = <span class="hljs-literal">True</span>
    <span class="hljs-keyword">return</span> found_secrets

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 获取 git 暂存区的文件列表（此处简化为扫描当前目录）</span>
    <span class="hljs-keyword">if</span> scan_files(sys.argv[<span class="hljs-number">1</span>:]):
        sys.exit(<span class="hljs-number">1</span>) <span class="hljs-comment"># 阻止提交</span>
</code></pre>
<p>在 TRAE SOLO 的终端中，将此脚本集成到 Git 流程中，就能在源头掐断泄露风险。</p>
<h2 data-id="heading-4">进阶实战：用 TRAE SOLO 监控 API 调用成本</h2>
<p>光防泄露还不够，万一 Key 被盗用了或者模型陷入死循环怎么办？我们需要<strong>可观测性</strong>。</p>
<p>利用 TRAE SOLO 的 <code>SOLO Coder</code>，我们可以快速生成一个 API 调用拦截器（Interceptor），实时统计 Token 消耗。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps

<span class="hljs-comment"># 配置日志格式，绝对不要打印完整的 Authorization 头</span>
logging.basicConfig(level=logging.INFO, <span class="hljs-built_in">format</span>=<span class="hljs-string">'%(asctime)s - %(message)s'</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">monitor_cost</span>(<span class="hljs-params">func</span>):
<span class="hljs-meta">    @wraps(<span class="hljs-params">func</span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        start_time = time.time()
        <span class="hljs-keyword">try</span>:
            response = func(*args, **kwargs)
            
            <span class="hljs-comment"># 假设 response 包含 usage 信息 (OpenAI 格式)</span>
            usage = <span class="hljs-built_in">getattr</span>(response, <span class="hljs-string">'usage'</span>, <span class="hljs-literal">None</span>)
            <span class="hljs-keyword">if</span> usage:
                logging.info(
                    <span class="hljs-string">f"API调用成功 | 耗时: <span class="hljs-subst">{time.time() - start_time:<span class="hljs-number">.2</span>f}</span>s | "</span>
                    <span class="hljs-string">f"Tokens: <span class="hljs-subst">{usage.total_tokens}</span> (In: <span class="hljs-subst">{usage.prompt_tokens}</span>, Out: <span class="hljs-subst">{usage.completion_tokens}</span>)"</span>
                )
            <span class="hljs-keyword">return</span> response
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logging.error(<span class="hljs-string">f"API调用失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-comment"># --- 模拟调用 ---</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MockClient</span>:
<span class="hljs-meta">    @monitor_cost</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_completion</span>(<span class="hljs-params">self, prompt</span>):
        time.sleep(<span class="hljs-number">0.5</span>)
        <span class="hljs-comment"># 模拟返回对象</span>
        <span class="hljs-keyword">class</span> <span class="hljs-title class_">MockResponse</span>:
            usage = <span class="hljs-built_in">type</span>(<span class="hljs-string">'Usage'</span>, (), {<span class="hljs-string">'total_tokens'</span>: <span class="hljs-number">150</span>, <span class="hljs-string">'prompt_tokens'</span>: <span class="hljs-number">50</span>, <span class="hljs-string">'completion_tokens'</span>: <span class="hljs-number">100</span>})()
        <span class="hljs-keyword">return</span> MockResponse()

client = MockClient()
client.chat_completion(<span class="hljs-string">"Hello AI"</span>)
</code></pre>
<p>把这段代码封装成中间件，配合 Prometheus 或简单的日志监控，一旦发现 Token 消耗速率异常（比如每分钟消耗超过 $10），立刻触发报警。</p>
<h2 data-id="heading-5">避坑指南：安全不是一次性的</h2>
<p>在构建安全防线时，有几个隐蔽的坑需要注意：</p>
<h3 data-id="heading-6">1. 忽略了历史提交记录</h3>
<p>很多新手以为把含有 Key 的文件删了或者加进 <code>.gitignore</code> 就万事大吉了。
<strong>真相</strong>：Key 依然躺在 <code>.git</code> 文件夹的历史记录里，用 <code>git log -p</code> 一查一个准。
<strong>对策</strong>：必须使用 <code>git filter-repo</code> 或 BFG Repo-Cleaner 彻底清洗历史记录，或者干脆删库重建。</p>
<h3 data-id="heading-7">2. 错误地信任前端环境</h3>
<p>有些开发者为了图省事，直接在前端 JS 代码里调用 OpenAI API。
<strong>真相</strong>：前端没有任何秘密。任何用户只要按 F12 打开控制台，网络请求里的 Key 就一览无余。
<strong>对策</strong>：必须通过<strong>后端中转</strong>（Backend-for-Frontend 模式）。前端请求后端接口，后端附加上 Key 再转发给大模型。</p>
<h3 data-id="heading-8">3. 密钥轮换机制缺失</h3>
<p>Key 用了一年都不换，一旦泄露就是毁灭性打击。
<strong>对策</strong>：建立定期轮换机制。如果使用 Azure OpenAI 或 AWS Bedrock，利用 IAM 角色代替长期 Key 才是正解。</p>
<h2 data-id="heading-9">结语</h2>
<p>在大模型时代，API Key 就是你的<strong>数字钱包</strong>。</p>
<p>TRAE SOLO 提供的不仅是编码效率的提升，更是一种<strong>规范化的工程约束</strong>。通过 IDE 层面的配置管理、代码审查和自动化脚本，我们可以在不降低开发速度的前提下，把安全风险降到最低。</p>
<p><strong>不要等到账单炸了才后悔，现在就去检查你的代码库吧。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FastAPI - Tracking ID的设计]]></title>    <link>https://juejin.cn/post/7577702891272994851</link>    <guid>https://juejin.cn/post/7577702891272994851</guid>    <pubDate>2025-11-29T15:12:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891272994851" data-draft-id="7577690150092734504" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FastAPI -  Tracking ID的设计"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T15:12:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="花酒锄作田"/> <meta itemprop="url" content="https://juejin.cn/user/3289345922186590"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FastAPI -  Tracking ID的设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3289345922186590/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    花酒锄作田
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:12:46.000Z" title="Sat Nov 29 2025 15:12:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在实际业务中，根据 <code>tracking_id</code> 追查日志中一条请求的完整处理路径是一个比较常见的需求。不过 FastAPI 官方并没有提供相对应的功能，因此需要开发者自行实现。本文介绍如何基于 <code>contextvars</code>，为每次请求的完整流程都添加一个 tracking_id，并在日志中自动记录。</p>
<h2 data-id="heading-1">什么是 contextvars</h2>
<p>Python 在 3.7 版本的标准库中加入了一个模块 <code>contextvars</code>，顾名思义就是 "(Context Variables) 上下文变量"，通常用来隐式地传递一些环境信息的变量，其作用跟 <code>threading.local()</code> 比较相似。不过 <code>threading.local()</code> 是针对线程的，隔离线程之间的数据状态，而 <code>contextvars</code> 可以用在 <code>asyncio</code> 生态的异步协程中。<strong>PS: <code>contextvars</code> 不仅可以用在异步协程中，也可以替代 <code>threading.local()</code> 用在多线程函数中。</strong></p>
<h2 data-id="heading-2">基本使用</h2>
<ol>
<li>首先编写 <code>context.py</code></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> contextvars
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>

TRACKING_ID: contextvars.ContextVar[<span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]] = contextvars.ContextVar(
    <span class="hljs-string">'tracking_id'</span>, 
    default=<span class="hljs-literal">None</span>
)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tracking_id</span>() -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""用于依赖注入"""</span>
    <span class="hljs-keyword">return</span> TRACKING_ID.get()

</code></pre>
<ol start="2">
<li>编写中间件 <code>middlewares.py</code>，在请求头和响应头中添加 tracking_id 的信息。常见场景就是客户拿着 tracking_id 找碴。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> uuid

<span class="hljs-keyword">from</span> starlette.middleware.base <span class="hljs-keyword">import</span> (BaseHTTPMiddleware,
                                       RequestResponseEndpoint)
<span class="hljs-keyword">from</span> starlette.requests <span class="hljs-keyword">import</span> Request
<span class="hljs-keyword">from</span> starlette.responses <span class="hljs-keyword">import</span> Response

<span class="hljs-keyword">from</span> context <span class="hljs-keyword">import</span> TRACKING_ID


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackingIDMiddleware</span>(<span class="hljs-title class_ inherited__">BaseHTTPMiddleware</span>):
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">
        self, request: Request, call_next: RequestResponseEndpoint
    </span>) -&gt; Response:
        tracking_id = <span class="hljs-built_in">str</span>(uuid.uuid4())
        token = TRACKING_ID.<span class="hljs-built_in">set</span>(tracking_id)
        <span class="hljs-comment"># HTTP 请求头习惯于使用 latin-1 编码</span>
        request.scope[<span class="hljs-string">"headers"</span>].append((<span class="hljs-string">b"x-request-id"</span>, tracking_id.encode(<span class="hljs-string">"latin-1"</span>)))

        <span class="hljs-keyword">try</span>:
            resp = <span class="hljs-keyword">await</span> call_next(request)
        <span class="hljs-keyword">finally</span>:
            <span class="hljs-comment"># 无论是否成功，每次请求结束时重置 tracking_id，避免泄露到下一次的请求中</span>
            TRACKING_ID.reset(token)

        <span class="hljs-comment"># 可选, 在响应中设置跟踪 ID 头</span>
        resp.headers[<span class="hljs-string">"X-Tracking-ID"</span>] = tracking_id

        <span class="hljs-keyword">return</span> resp

</code></pre>
<ol start="3">
<li>编写 handler 函数 <code>handlers.py</code>，测试在 handler 函数中获取 tracking_id。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">from</span> context <span class="hljs-keyword">import</span> TRACKING_ID


<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">mock_db_query</span>():
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
    current_id = TRACKING_ID.get()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is mock_db_query. Current tracking ID: <span class="hljs-subst">{current_id}</span>"</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
</code></pre>
<ol start="4">
<li>编写主函数 <code>main.py</code></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> uvicorn
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Depends, FastAPI
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> PlainTextResponse
<span class="hljs-keyword">from</span> starlette.background <span class="hljs-keyword">import</span> BackgroundTasks

<span class="hljs-keyword">from</span> context <span class="hljs-keyword">import</span> TRACKING_ID, get_tracking_id
<span class="hljs-keyword">from</span> handlers <span class="hljs-keyword">import</span> mock_db_query
<span class="hljs-keyword">from</span> middlewares <span class="hljs-keyword">import</span> TrackingIDMiddleware

app = FastAPI()

app.add_middleware(TrackingIDMiddleware)


<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/qwer"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_qwer</span>():
    <span class="hljs-string">"""测试上下文变量传递"""</span>
    current_id = TRACKING_ID.get()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is get qwer. Current tracking ID: <span class="hljs-subst">{current_id}</span>"</span>)
    <span class="hljs-keyword">return</span> PlainTextResponse(<span class="hljs-string">f"Current tracking ID: <span class="hljs-subst">{current_id}</span>"</span>)


<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/asdf"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_asdf</span>(<span class="hljs-params">tracking_id: <span class="hljs-built_in">str</span> = Depends(<span class="hljs-params">get_tracking_id</span>)</span>):
    <span class="hljs-string">"""测试依赖注入"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is get asdf. tracking ID: <span class="hljs-subst">{tracking_id}</span>"</span>)
    <span class="hljs-keyword">await</span> mock_db_query()
    <span class="hljs-keyword">return</span> PlainTextResponse(<span class="hljs-string">f"Get request, tracking ID: <span class="hljs-subst">{tracking_id}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    uvicorn.run(<span class="hljs-string">"main:app"</span>, host=<span class="hljs-string">"127.0.0.1"</span>, port=<span class="hljs-number">8000</span>, workers=<span class="hljs-number">4</span>)
</code></pre>
<ol start="5">
<li>启动服务后用 curl 测试 api，在控制台可以看到 tracking_id 在请求中都能捕获到。</li>
</ol>
<pre><code class="hljs language-vbnet" lang="vbnet">This <span class="hljs-built_in">is</span> <span class="hljs-keyword">get</span> qwer. Current tracking ID: <span class="hljs-number">01</span>b0153f-<span class="hljs-number">4877</span>-<span class="hljs-number">4</span>ca0-ac35-ed88ab406452
<span class="hljs-symbol">INFO:</span>     <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">55708</span> - <span class="hljs-string">"GET /qwer HTTP/1.1"</span> <span class="hljs-number">200</span> OK
This <span class="hljs-built_in">is</span> <span class="hljs-keyword">get</span> asdf. tracking ID: <span class="hljs-number">0</span>be61d8d-<span class="hljs-number">11</span>a0-<span class="hljs-number">4</span>cb6-<span class="hljs-number">812</span>f-<span class="hljs-number">51</span>b9bfdc2639
This <span class="hljs-built_in">is</span> mock_db_query. Current tracking ID: <span class="hljs-number">0</span>be61d8d-<span class="hljs-number">11</span>a0-<span class="hljs-number">4</span>cb6-<span class="hljs-number">812</span>f-<span class="hljs-number">51</span>b9bfdc2639
<span class="hljs-symbol">INFO:</span>     <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">55722</span> - <span class="hljs-string">"GET /asdf HTTP/1.1"</span> <span class="hljs-number">200</span> OK
</code></pre>
<p>使用 curl 的控制台输出</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">$</span> <span class="hljs-string">curl</span> <span class="hljs-string">-i</span> <span class="hljs-string">http://127.0.0.1:8000/qwer</span>
<span class="hljs-string">HTTP/1.1</span> <span class="hljs-number">200</span> <span class="hljs-string">OK</span>
<span class="hljs-attr">date:</span> <span class="hljs-string">Sat,</span> <span class="hljs-number">29</span> <span class="hljs-string">Nov</span> <span class="hljs-number">2025 06:16:46 </span><span class="hljs-string">GMT</span>
<span class="hljs-attr">server:</span> <span class="hljs-string">uvicorn</span>
<span class="hljs-attr">content-length:</span> <span class="hljs-number">57</span>
<span class="hljs-attr">content-type:</span> <span class="hljs-string">text/plain;</span> <span class="hljs-string">charset=utf-8</span>
<span class="hljs-attr">x-tracking-id:</span> <span class="hljs-string">01b0153f-4877-4ca0-ac35-ed88ab406452</span>

<span class="hljs-attr">Current tracking ID:</span> <span class="hljs-string">01b0153f-4877-4ca0-ac35-ed88ab406452</span>

<span class="hljs-string">=====</span> <span class="hljs-string">另一个请求</span> <span class="hljs-string">=====</span>

<span class="hljs-string">$</span> <span class="hljs-string">curl</span> <span class="hljs-string">-i</span> <span class="hljs-string">http://127.0.0.1:8000/asdf</span>
<span class="hljs-string">HTTP/1.1</span> <span class="hljs-number">200</span> <span class="hljs-string">OK</span>
<span class="hljs-attr">date:</span> <span class="hljs-string">Sat,</span> <span class="hljs-number">29</span> <span class="hljs-string">Nov</span> <span class="hljs-number">2025 06:16:49 </span><span class="hljs-string">GMT</span>
<span class="hljs-attr">server:</span> <span class="hljs-string">uvicorn</span>
<span class="hljs-attr">content-length:</span> <span class="hljs-number">62</span>
<span class="hljs-attr">content-type:</span> <span class="hljs-string">text/plain;</span> <span class="hljs-string">charset=utf-8</span>
<span class="hljs-attr">x-tracking-id:</span> <span class="hljs-string">0be61d8d-11a0-4cb6-812f-51b9bfdc2639</span>

<span class="hljs-string">Get</span> <span class="hljs-string">request,</span> <span class="hljs-attr">tracking ID:</span> <span class="hljs-string">0be61d8d-11a0-4cb6-812f-51b9bfdc2639</span>
</code></pre>
<h2 data-id="heading-3">后台任务型 API</h2>
<p>FastAPI 中有 <code>from starlette.background import BackgroundTasks</code> 可以让接口直接响应，将实际流程放到后台异步处理。因为上面的中间件在响应时会重置 tracking_id，所以后台的协程函数<strong>可能</strong>不会获取到 tracking_id。理论上是这样的，但是本地测试时发现在异步协程中还是能获取到 tracking_id，这可能是本地低并发的问题。在生产环境高并发的情况下，最好还是强制解耦，显式传递 contextvars。</p>
<ol>
<li>自定义的中间件类保持不变。</li>
<li>添加后台任务的 api</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> starlette.background <span class="hljs-keyword">import</span> BackgroundTasks
<span class="hljs-keyword">from</span> handlers <span class="hljs-keyword">import</span> mock_backgroud_task

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/zxcv"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_zxcv</span>(<span class="hljs-params">tasks: BackgroundTasks</span>):
    <span class="hljs-string">"""测试后台任务"""</span>
    current_id = TRACKING_ID.get()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is get zxcv. The current id is <span class="hljs-subst">{current_id}</span>"</span>)

    <span class="hljs-comment"># 显式传递 tracking_id</span>
    tasks.add_task(mock_backgroud_task, current_id)

    <span class="hljs-keyword">return</span> PlainTextResponse(<span class="hljs-string">f"This is get zxcv. The current id is <span class="hljs-subst">{current_id}</span>"</span>)
</code></pre>
<ol start="3">
<li>后台协程函数中显式处理。任务在启动时，使用传入的参数值，在自己的任务执行上下文中，重新设置 <code>TRACKING_ID</code>。在任务结束时，对任务自己设置的上下文进行清理。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">mock_backgroud_task</span>(<span class="hljs-params">request_tracking_id: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]</span>):
    <span class="hljs-keyword">if</span> request_tracking_id <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        request_tracking_id = <span class="hljs-built_in">str</span>(uuid4())
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"WARNING: No tracking ID found. Generate a new one: <span class="hljs-subst">{request_tracking_id}</span>"</span>)
    token = TRACKING_ID.<span class="hljs-built_in">set</span>(request_tracking_id)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 模拟耗时的后台异步任务</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">5</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"This is mock backgroud task. Current tracking ID: <span class="hljs-subst">{request_tracking_id}</span>"</span>)
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 确保 tracking ID 被重置</span>
        TRACKING_ID.reset(token)
</code></pre>
<ol start="4">
<li>启动主程序并测试 tracking_id 是否一致。</li>
</ol>
<h2 data-id="heading-4">日志记录 tracking_id</h2>
<p>tracking_id 在前面是手动添加到 <code>print()</code> 里面的，未免还是麻烦了点，不注意的话还可能忘了。因此，最好是用日志记录器自动获取 <code>tracking_id</code>，这样代码的侵入性改动就大大降低了。</p>
<p>首先需要封装一个日志模块。这里选用标准库 <code>logging</code>，喜欢 <code>loguru</code> 的话也可以试试用 <code>loguru</code> 封装（如果生产环境有频繁且严苛的安全扫描，个人建议还是尽量用标准库比较好，免得经常升级第三方依赖）。如果你的应用运行在 docker 或者 k8s 上，有现成的控制台日志采集工具，那么这个日志模块只需要输出到控制台就行了。如果应用运行在 server 上，需要用比如 <code>filebeat</code> 这样的工具读取日志文件，那么需要解决<strong>日志文件体积增长</strong>、<strong>uvicorn 多工作进程运行同时写日志文件的竞争问题</strong>、以及<strong>高并发情况下写日志文件阻塞异步协程的问题</strong>。</p>
<p>以下日志模块的示例解决了上述问题，主要特点：</p>
<ul>
<li>自动获取 tracking_id，无需手动记录。</li>
<li>日志为 JSON 格式，便于在 ELK 这样的日志聚合系统中查日志。</li>
<li>日志会同时输出到标准输出和日志文件，也可以配置输出到其中一个。</li>
<li>日志文件按天轮转，默认保留最近 7 天的日志，避免日志文件体积增长的问题。</li>
<li>主进程和工作进程输出到各自的日志文件中，避免同时写日志文件的竞争问题。</li>
<li>日志会先输出到队列，避免写文件阻塞异步协程的问题。</li>
</ul>
<ol>
<li>编辑文件 <code>pkg/log/log.py</code>。主要内容都在这个部分。需要对外提供的对象只有 <code>setup_logger</code> 和 <code>close_log_queue</code>。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> logging.handlers <span class="hljs-keyword">import</span> QueueHandler, QueueListener, TimedRotatingFileHandler
<span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> current_process
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> queue <span class="hljs-keyword">import</span> Queue
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>

<span class="hljs-keyword">from</span> context <span class="hljs-keyword">import</span> TRACKING_ID

_queue_listener = <span class="hljs-literal">None</span>
_queue_logger: <span class="hljs-type">Optional</span>[Queue] = <span class="hljs-literal">None</span>
PATTERN_PROCESS_NAME = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r"SpawnProcess-(\d+)"</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">JSONFormatter</span>(logging.Formatter):
    <span class="hljs-string">"""A logging formatter that outputs logs in JSON format."""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">format</span>(<span class="hljs-params">self, record: logging.LogRecord</span>) -&gt; <span class="hljs-built_in">str</span>:
        log_record = {
            <span class="hljs-string">"@timestamp"</span>: self.formatTime(record, <span class="hljs-string">"%Y-%m-%dT%H:%M:%S%z"</span>),
            <span class="hljs-string">"level"</span>: record.levelname,
            <span class="hljs-string">"name"</span>: record.name,
            <span class="hljs-comment"># "taskName": getattr(record, "taskName", None),  # Record task name if needed</span>
            <span class="hljs-string">"processName"</span>: record.processName,  <span class="hljs-comment"># Record process name if needed</span>
            <span class="hljs-string">"tracking_id"</span>: <span class="hljs-built_in">getattr</span>(record, <span class="hljs-string">"tracking_id"</span>, <span class="hljs-literal">None</span>),
            <span class="hljs-string">"loc"</span>: <span class="hljs-string">"%s:%d"</span> % (record.filename, record.lineno),
            <span class="hljs-string">"func"</span>: record.funcName,
            <span class="hljs-string">"message"</span>: record.getMessage(),
        }

        <span class="hljs-keyword">return</span> json.dumps(log_record, ensure_ascii=<span class="hljs-literal">False</span>, default=<span class="hljs-built_in">str</span>)


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackingIDFilter</span>(logging.Filter):
    <span class="hljs-string">"""A logging filter that adds tracking_id to log records.
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">self, record</span>):
        record.tracking_id = TRACKING_ID.get()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_console_handler</span>(<span class="hljs-params">level: <span class="hljs-built_in">int</span></span>) -&gt; logging.StreamHandler:
    <span class="hljs-string">"""Setup a StreamHandler for console logging.
    
    Args:
        level (int): The logging level.
    """</span>
    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(level)
    handler.setFormatter(JSONFormatter())
    <span class="hljs-keyword">return</span> handler


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_file_handler</span>(<span class="hljs-params">
    level: <span class="hljs-built_in">int</span>, log_path: <span class="hljs-built_in">str</span>, rotate_days: <span class="hljs-built_in">int</span>
</span>) -&gt; TimedRotatingFileHandler:
    <span class="hljs-string">"""Setup a TimedRotatingFileHandler for logging.
    
    Args:
        level (int): The logging level.
        log_path (str): The log path.
        rotate_days (int): The number of days to keep log files.
    """</span>
    handler = TimedRotatingFileHandler(
        filename=log_path,
        when=<span class="hljs-string">"midnight"</span>,
        interval=<span class="hljs-number">1</span>,
        backupCount=rotate_days,
        encoding=<span class="hljs-string">"utf-8"</span>,
    )
    handler.setLevel(level)
    handler.setFormatter(JSONFormatter())
    <span class="hljs-keyword">return</span> handler


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_queue_handler</span>(<span class="hljs-params">level: <span class="hljs-built_in">int</span>, log_queue: Queue</span>) -&gt; QueueHandler:
    <span class="hljs-string">"""Setup a QueueHandler for logging.
    
    Args:
        level (int): The logging level.
        log_queue (Queue): The log queue.
    """</span>
    handler = QueueHandler(log_queue)
    handler.setLevel(level)
    <span class="hljs-keyword">return</span> handler


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_spawn_process_number</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    Get the spawn process number for log file naming.
    The server should be started with multiple processes using uvicorn's --workers option.
    Prevent issues caused by multiple processes writing to the same log file.

    Args:
        name (str): The name of the log file.

    Returns:
        str: The spawn process number for log file naming.
    """</span>
    <span class="hljs-keyword">try</span>:
        process_name = current_process().name
        pid = os.getpid()

        <span class="hljs-keyword">if</span> process_name == <span class="hljs-string">"MainProcess"</span>:
            <span class="hljs-keyword">return</span> name
        <span class="hljs-keyword">elif</span> m := PATTERN_PROCESS_NAME.<span class="hljs-keyword">match</span>(process_name):
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-sp<span class="hljs-subst">{m.group(<span class="hljs-number">1</span>)}</span>"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-<span class="hljs-subst">{pid}</span>"</span>

    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-<span class="hljs-subst">{os.getpid()}</span>"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_setup_logpath</span>(<span class="hljs-params">log_dir: <span class="hljs-built_in">str</span>, name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Setup the log path.
    
    Args:
        log_dir (str): The log directory.
        name (str): The name of the log file. Example: "app"

    Returns:
        str: The log path.
    """</span>
    main_name = _get_spawn_process_number(name)
    log_file = <span class="hljs-string">f"<span class="hljs-subst">{main_name}</span>.log"</span>
    log_path = Path(log_dir) / log_file

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> log_path.parent.exists():
        <span class="hljs-keyword">try</span>:
            log_path.parent.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> RuntimeError(
                <span class="hljs-string">f"Failed to create log directory: <span class="hljs-subst">{log_path.parent}</span>"</span>
            ) <span class="hljs-keyword">from</span> e
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(log_path)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate</span>(<span class="hljs-params">level: <span class="hljs-built_in">int</span>, enable_console: <span class="hljs-built_in">bool</span>, enable_file: <span class="hljs-built_in">bool</span>, rotate_days: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Validate the log configuration.
    
    Args:
        level (int): The logging level.
        enable_console (bool): Whether to enable console logging.
        enable_file (bool): Whether to enable file logging.
        rotate_days (int): The number of days to keep log files.

    Raises:
        ValueError: If the log configuration is invalid.
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> enable_console <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> enable_file:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"At least one of enable_console or enable_file must be True."</span>)

    <span class="hljs-keyword">if</span> level <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> [
        logging.DEBUG,
        logging.INFO,
        logging.WARNING,
        logging.ERROR,
        logging.CRITICAL,
    ]:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Invalid logging level specified."</span>)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(rotate_days, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">or</span> rotate_days &lt;= <span class="hljs-number">0</span>:
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"rotate_days must be a positive integer."</span>)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_logger</span>(<span class="hljs-params">
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"app"</span>,
    level: <span class="hljs-built_in">int</span> = logging.DEBUG,
    enable_console: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>,
    enable_file: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>,
    log_dir: <span class="hljs-built_in">str</span> = <span class="hljs-string">"logs"</span>,
    rotate_days: <span class="hljs-built_in">int</span> = <span class="hljs-number">7</span>,
</span>) -&gt; logging.Logger:
    <span class="hljs-string">"""Setup a logger with console and/or file handlers.
    
    Args:
        name (str): The name of the logger. This will be used as the log file name prefix. Defaults to "app".
        level (int): The logging level. Defaults to logging.DEBUG.
        enable_console (bool): Whether to enable console logging. Defaults to True.
        enable_file (bool): Whether to enable file logging. Defaults to True.
        log_dir (str): The log directory. Defaults to "logs".
        rotate_days (int): The number of days to keep log files. Defaults to 7.

    Returns:
        logging.Logger: The configured logger.
    """</span>
    logger = logging.getLogger(name)

    <span class="hljs-keyword">if</span> logger.hasHandlers():
        <span class="hljs-keyword">return</span> logger  <span class="hljs-comment"># Logger is already configured</span>

    _validate(level, enable_console, enable_file, rotate_days)

    logger.setLevel(level)
    logger.propagate = <span class="hljs-literal">False</span>  <span class="hljs-comment"># Prevent log messages from being propagated to the root logger</span>

    log_path = _setup_logpath(log_dir, name)

    handlers = []

    <span class="hljs-keyword">if</span> enable_console:
        handlers.append(_setup_console_handler(level))

    <span class="hljs-keyword">if</span> enable_file:
        handlers.append(_setup_file_handler(level, log_path, rotate_days))

    <span class="hljs-keyword">global</span> _queue_logger, _queue_listener
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _queue_logger:
        _queue_logger = Queue(-<span class="hljs-number">1</span>)

    queue_handler = _setup_queue_handler(level, _queue_logger)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> _queue_listener:
        _queue_listener = QueueListener(
            _queue_logger, *handlers, respect_handler_level=<span class="hljs-literal">True</span>
        )
        _queue_listener.start()

    logger.addHandler(queue_handler)
    logger.addFilter(TrackingIDFilter())

    <span class="hljs-keyword">return</span> logger


<span class="hljs-keyword">def</span> <span class="hljs-title function_">close_log_queue</span>() -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""Close the log queue and stop the listener.
    This function should be called when the application is shutting down to ensure that the log queue is closed and the listener is stopped.
    """</span>
    <span class="hljs-keyword">global</span> _queue_listener
    <span class="hljs-keyword">if</span> _queue_listener:
        _queue_listener.stop()
        _queue_listener = <span class="hljs-literal">None</span>

</code></pre>
<ol start="2">
<li>编辑 <code>pkg/log/__init__.py</code>，便于其它模块导入，个人一般也是通过这个文件告诉别人这个模块哪些对象是 public 的。<code>logger</code> 对象是一个单例，其它模块直接使用即可，一般无需使用 <code>setup_logger</code> 单独创建日志记录器对象。不过有的需求是各个类对象创建各自的日志记录器，所以也对外提供出去了（个人认为没啥必要）。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">from</span> .log <span class="hljs-keyword">import</span> close_log_queue, setup_logger

logger = setup_logger(
    log_dir=<span class="hljs-built_in">str</span>(Path(__file__).parent.parent.parent / <span class="hljs-string">"logs"</span>),
)

__all__ = [
    <span class="hljs-string">"logger"</span>,
    <span class="hljs-string">"setup_logger"</span>,
    <span class="hljs-string">"close_log_queue"</span>,
]

</code></pre>
<ol start="3">
<li>通过 FastAPI 的 lifespan 来调用 <code>close_log_queue</code></li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager

<span class="hljs-keyword">from</span> pkg.log <span class="hljs-keyword">import</span> close_log_queue

<span class="hljs-meta">@asynccontextmanager</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">lifespan</span>(<span class="hljs-params">app: FastAPI</span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span>
    <span class="hljs-keyword">finally</span>:
        close_log_queue()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Shutdown!"</span>)


app = FastAPI(lifespan=lifespan)
</code></pre>
<ol start="4">
<li>将 <code>print()</code> 改成 <code>logger.info()</code>，测试日志中是否自动输出 <code>tracking_id</code>。其中部分改动如下</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">mock_db_query</span>():
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
    current_id = TRACKING_ID.get()
    logger.info(<span class="hljs-string">f"This is mock_db_query. Current tracking ID: <span class="hljs-subst">{current_id}</span>"</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
</code></pre>
<ol start="5">
<li>使用 curl 测试并查看日志</li>
</ol>
<p>curl 命令输出如下：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -i  http://127.0.0.1:8000/asdf
HTTP/1.1 200 OK
<span class="hljs-built_in">date</span>: Sat, 29 Nov 2025 13:07:09 GMT
content-length: 62
content-type: text/plain; charset=utf-8
x-tracking-id: 38a015f7-b0d3-41ea-a2b3-179bf608b4bb

Get request, tracking ID: 38a015f7-b0d3-41ea-a2b3-179bf608b4bb
</code></pre>
<p>服务端的控制台输出如下：</p>
<pre><code class="hljs language-less" lang="less">{"<span class="hljs-variable">@timestamp</span><span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-attribute">-11-29T21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09</span>+<span class="hljs-number">0800</span><span class="hljs-string">", "</span>level<span class="hljs-string">": "</span>INFO<span class="hljs-string">", "</span>name<span class="hljs-string">": "</span>app<span class="hljs-string">", "</span>processName<span class="hljs-string">": "</span>SpawnProcess-<span class="hljs-number">3</span><span class="hljs-string">", "</span>tracking_id<span class="hljs-string">": "</span><span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb<span class="hljs-string">", "</span>loc<span class="hljs-string">": "</span>main.<span class="hljs-attribute">py</span>:<span class="hljs-number">39</span><span class="hljs-string">", "</span>func<span class="hljs-string">": "</span>get_asdf<span class="hljs-string">", "</span>message<span class="hljs-string">": "</span>This is get asdf. tracking <span class="hljs-attribute">ID</span>: <span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb"}
{"<span class="hljs-variable">@timestamp</span><span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-attribute">-11-29T21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">10</span>+<span class="hljs-number">0800</span><span class="hljs-string">", "</span>level<span class="hljs-string">": "</span>INFO<span class="hljs-string">", "</span>name<span class="hljs-string">": "</span>app<span class="hljs-string">", "</span>processName<span class="hljs-string">": "</span>SpawnProcess-<span class="hljs-number">3</span><span class="hljs-string">", "</span>tracking_id<span class="hljs-string">": "</span><span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb<span class="hljs-string">", "</span>loc<span class="hljs-string">": "</span>handlers.<span class="hljs-attribute">py</span>:<span class="hljs-number">12</span><span class="hljs-string">", "</span>func<span class="hljs-string">": "</span>mock_db_query<span class="hljs-string">", "</span>message<span class="hljs-string">": "</span>This is mock_db_query. Current tracking <span class="hljs-attribute">ID</span>: <span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb"}
</code></pre>
<p>日志文件输出如下：</p>
<pre><code class="hljs language-less" lang="less">{"<span class="hljs-variable">@timestamp</span><span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-attribute">-11-29T21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">09</span>+<span class="hljs-number">0800</span><span class="hljs-string">", "</span>level<span class="hljs-string">": "</span>INFO<span class="hljs-string">", "</span>name<span class="hljs-string">": "</span>app<span class="hljs-string">", "</span>processName<span class="hljs-string">": "</span>SpawnProcess-<span class="hljs-number">3</span><span class="hljs-string">", "</span>tracking_id<span class="hljs-string">": "</span><span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb<span class="hljs-string">", "</span>loc<span class="hljs-string">": "</span>main.<span class="hljs-attribute">py</span>:<span class="hljs-number">39</span><span class="hljs-string">", "</span>func<span class="hljs-string">": "</span>get_asdf<span class="hljs-string">", "</span>message<span class="hljs-string">": "</span>This is get asdf. tracking <span class="hljs-attribute">ID</span>: <span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb"}
{"<span class="hljs-variable">@timestamp</span><span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-attribute">-11-29T21</span>:<span class="hljs-number">07</span>:<span class="hljs-number">10</span>+<span class="hljs-number">0800</span><span class="hljs-string">", "</span>level<span class="hljs-string">": "</span>INFO<span class="hljs-string">", "</span>name<span class="hljs-string">": "</span>app<span class="hljs-string">", "</span>processName<span class="hljs-string">": "</span>SpawnProcess-<span class="hljs-number">3</span><span class="hljs-string">", "</span>tracking_id<span class="hljs-string">": "</span><span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb<span class="hljs-string">", "</span>loc<span class="hljs-string">": "</span>handlers.<span class="hljs-attribute">py</span>:<span class="hljs-number">12</span><span class="hljs-string">", "</span>func<span class="hljs-string">": "</span>mock_db_query<span class="hljs-string">", "</span>message<span class="hljs-string">": "</span>This is mock_db_query. Current tracking <span class="hljs-attribute">ID</span>: <span class="hljs-number">38</span>a015f7-b0d3-<span class="hljs-number">41</span>ea-a2b3-<span class="hljs-number">179</span>bf608b4bb"}
</code></pre>
<p>根据以上三条输出可见，tracking_id 在日志中和日志消息中保持一致。</p>
<h3 data-id="heading-5">补充: 另一种解决多进程文件写入问题的方法</h3>
<p>费劲调试完上面的日志模块中，想到另一个解决多进程文件写入问题的方法，那就是由外部工具写日志，服务只输出到控制台，类似 docker 和 k8s 运行环境的解决方案。以下只是思路，大致想来应该没什么问题，感兴趣的话可以尝试一下。</p>
<ol>
<li>移除日志模块中的写文件功能，保留输出到控制台的部分。注意标准输出也有可能阻塞异步协程，所以队列处理器还是要保留的。</li>
<li>启动时用 <code>nohup</code> 将控制台输出重定向到文件中。比如：<code>nohup python main.py &gt; logs/start.log 2&gt;&amp;1 &amp;</code></li>
<li>配置 <code>logrotate</code> 来做日志轮转。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go微服务通信优化：从协议选择到性能调优全攻略｜Go语言进阶（20）]]></title>    <link>https://juejin.cn/post/7577683422878056482</link>    <guid>https://juejin.cn/post/7577683422878056482</guid>    <pubDate>2025-11-29T15:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577683422878056482" data-draft-id="7577647745110671360" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go微服务通信优化：从协议选择到性能调优全攻略｜Go语言进阶（20）"/> <meta itemprop="keywords" content="后端,Go,微服务"/> <meta itemprop="datePublished" content="2025-11-29T15:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="半瓶入梦"/> <meta itemprop="url" content="https://juejin.cn/user/2757990117802792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go微服务通信优化：从协议选择到性能调优全攻略｜Go语言进阶（20）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2757990117802792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    半瓶入梦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:14:48.000Z" title="Sat Nov 29 2025 15:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从一次跨城调用的延迟爆炸说起</h2>
<p>去年业务高峰期前，我们的内容分发平台遇到了一个奇怪的问题：跨城服务调用的平均延迟从150ms突然飙升到了800ms，P99更是突破了3秒。一开始团队怀疑是网络抖动，但抓包分析后发现——90%的延迟都花在了TLS握手和连接建立上。原来，随着流量增长，旧的HTTP/1.1客户端连接池配置不合理，导致每秒创建上千个新连接，完全冲垮了TLS握手能力。</p>
<p>这次事件让我们意识到：微服务通信的每一毫秒延迟，都来自于设计细节的堆叠——协议选择、连接复用、超时策略，甚至一个小小的Keep-Alive配置，都会在高并发下被放大成雪崩效应。</p>
<p>Go社区有足够丰富的通信工具，但要把它们拼成既高效又稳健的体系，需要从协议、链路、数据、治理多维度整体思考。本篇我将结合团队近2年的微服务通信优化经验，梳理关键决策点与调优套路，帮你在设计之初就掌握主动权。</p>
<h2 data-id="heading-1">协议选型三要素：效率、生态与演化成本</h2>
<p>选择通信协议时，我们通常会从三个维度权衡：<strong>效率</strong>（延迟、吞吐、带宽）、<strong>生态</strong>（工具链、调试成本、团队熟悉度）、<strong>演化成本</strong>（扩展能力、版本兼容、技术债务）。下面是我们在不同场景下的选型实践：</p>
<h3 data-id="heading-2">HTTP/1.1：老练却需要精细打磨</h3>
<p><strong>我们用它做什么</strong>：与第三方内容平台、数据接口对接，以及面向浏览器的公开 API。</p>
<p><strong>国内框架参考</strong>：</p>
<ul>
<li><strong>Hertz</strong>（<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.cloudwego.io%2Fdocs%2Fhertz%25EF%25BC%259A%25E5%25AD%2597%25E8%258A%2582%25E5%25BC%2580%25E6%25BA%2590%25E7%259A%2584%25E8%25BD%25BB%25E9%2587%258F" target="_blank" title="http://www.cloudwego.io/docs/hertz%EF%BC%9A%E5%AD%97%E8%8A%82%E5%BC%80%E6%BA%90%E7%9A%84%E8%BD%BB%E9%87%8F" ref="nofollow noopener noreferrer">www.cloudwego.io/docs/hertz：…</a> HTTP 框架，适合对性能有较高要求的场景</li>
<li><strong>Kratos</strong>（go-kratos.dev）：B站开源的微服务框架，提供 HTTP 服务组件与中间件生态</li>
</ul>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：Postman、curl 调试超方便，Nginx 网关、WAF 等中间件支持完美，团队新人上手快</li>
<li>坑点：在我们的内容系统中，早期因未配置 <code>MaxIdleConnsPerHost</code>，导致对同一个第三方内容平台的并发请求时，每秒创建上百个新连接，TLS 握手延迟占比高达 40%</li>
</ul>
<p><strong>优化实招</strong>：</p>
<ul>
<li>强制开启 <code>Keep-Alive</code>，设置合理的 <code>IdleConnTimeout</code>（我们用 60s）</li>
<li>使用 <code>httptrace.ClientTrace</code> 跟踪每个请求的阶段耗时，发现问题瓶颈</li>
<li>对于固定第三方接口，使用 <code>singleflight.Group</code> 合并相同参数的并发请求（比如查询物流状态）</li>
</ul>
<h3 data-id="heading-3">HTTP/2：并发友好但仍需关注队列</h3>
<p><strong>我们用它做什么</strong>：内部服务间的高频调用，特别是聚合类服务（比如商品详情页需要调用价格、库存、促销等 10+ 个服务）。</p>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：多路复用确实解决了 HTTP/1.1 的队头阻塞问题，相同 QPS 下连接数减少了 90%</li>
<li>坑点：在我们的 API 网关中，曾因单连接的 <code>MaxConcurrentStreams</code> 设置过大（默认 250），导致个别慢请求阻塞了整个连接的其他请求</li>
</ul>
<p><strong>优化实招</strong>：</p>
<ul>
<li>在 <code>http2.Server</code> 中设置 <code>MaxConcurrentStreams: 100</code>，避免单连接过载</li>
<li>对于高负载服务，使用客户端负载均衡器（如 <code>grpc-lb</code>）拆分连接到不同实例</li>
<li>监控 <code>inflight</code> 请求数量，当超过阈值时主动触发降级</li>
</ul>
<h3 data-id="heading-4">gRPC：强类型与工具链并重</h3>
<p><strong>我们用它做什么</strong>：核心服务间的高频 RPC 调用，特别是需要 streaming 能力的场景（比如实时内容同步、状态推送）。</p>
<p><strong>国内框架参考</strong>：</p>
<ul>
<li><strong>Kitex</strong>（cloudwego.github.io/kitex）：字节开源的 RPC 框架，支持 gRPC/Thrift，适合高性能 RPC 场景</li>
<li><strong>Kratos</strong>：B站框架，集成 gRPC 与微服务治理能力，提供全链路解决方案</li>
</ul>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：ProtoBuf 压缩效率比 JSON 高 60% 以上，自动生成的客户端代码质量高，内置的健康检查、负载均衡等功能省了很多开发量</li>
<li>坑点：调试确实比 HTTP 麻烦，需要用 <code>grpcurl</code> 或专门的 GUI 工具；对网络中间件要求高，我们曾遇到过某些老版本的 F5 负载均衡器不支持 gRPC 的问题</li>
</ul>
<p><strong>推荐开源工具</strong>：</p>
<ul>
<li><code>buf</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fbuf.build%2F)%25EF%25BC%259A%25E6%25AF%2594%25E5%258E%259F%25E7%2594%259F" target="_blank" title="https://buf.build/)%EF%BC%9A%E6%AF%94%E5%8E%9F%E7%94%9F" ref="nofollow noopener noreferrer">buf.build/)：比原生</a> protoc 更好用的 Protobuf 构建工具，支持 lint、breaking change 检查</li>
<li><code>grpc-go</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgrpc%2Fgrpc-go)%25EF%25BC%259A%25E5%25AE%2598%25E6%2596%25B9" target="_blank" title="https://github.com/grpc/grpc-go)%EF%BC%9A%E5%AE%98%E6%96%B9" ref="nofollow noopener noreferrer">github.com/grpc/grpc-g…</a> gRPC 实现，我们一直在用 v1.50+ 版本，稳定性不错</li>
<li><code>grpc-ecosystem/go-grpc-middleware</code>：提供了限流、熔断、日志等实用中间件</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-proto" lang="proto">// api/checkout/v1/service.proto
syntax = "proto3";
package checkout.v1;

option go_package = "github.com/yourcompany/yourproject/api/checkout/v1";

service CheckoutService {
    // 流式下单接口，支持批量提交
    rpc PlaceOrder(stream OrderRequest) returns (OrderResponse);
    // 订单状态查询
    rpc GetStatus(StatusRequest) returns (StatusResponse);
}

message OrderRequest {
    string order_id = 1;
    repeated Item items = 2;
}

message Item {
    string sku = 1;
    int32 quantity = 2;
}

message OrderResponse {
    bool success = 1;
    string order_id = 2;
    string message = 3;
}

message StatusRequest {
    string order_id = 1;
}

message StatusResponse {
    string order_id = 1;
    string status = 2;
    int64 updated_at = 3;
}
</code></pre>
<h3 data-id="heading-5">GraphQL / REST 混合：面向客户端的聚合层</h3>
<p><strong>我们用它做什么</strong>：移动端和 Web 前端的统一 API 层，替代了原来的多个 BFF（Backend for Frontend）。</p>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：前端可以按需取数，减少了 70% 的无效数据传输；一个 GraphQL 服务替代了原来的 5 个 BFF 服务</li>
<li>坑点：初期因 Resolver 未并行化，导致某些复杂查询的延迟比 REST 还高</li>
</ul>
<p><strong>优化实招</strong>：</p>
<ul>
<li>使用 <code>graphql-go-tools</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwundergraph%2Fgraphql-go-tools" target="_blank" title="https://github.com/wundergraph/graphql-go-tools" ref="nofollow noopener noreferrer">github.com/wundergraph…</a>) 提高 GraphQL 引擎性能</li>
<li>在 Resolver 内部使用 <code>errgroup.Group</code> 并发调用后端服务</li>
<li>配合 <code>dataloader</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgraph-gophers%2Fdataloader" target="_blank" title="https://github.com/graph-gophers/dataloader" ref="nofollow noopener noreferrer">github.com/graph-gophe…</a>) 批量化相同类型的请求（比如批量查询多个商品的价格）</li>
</ul>
<h3 data-id="heading-6">消息队列 / 事件流：解耦延迟容忍型场景</h3>
<p><strong>我们用它做什么</strong>：异步任务处理（比如内容发布后发送通知、更新统计数据），以及事件驱动的微服务架构。</p>
<p><strong>真实体验</strong>：</p>
<ul>
<li>优势：确实实现了服务解耦，在大促期间，即使通知服务挂了，也不会影响核心的订单流程</li>
<li>坑点：调试和全链路追踪比较麻烦，我们曾遇到过消息丢失但很难定位原因的情况</li>
</ul>
<p><strong>推荐开源工具</strong>：</p>
<ul>
<li><code>sarama</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FShopify%2Fsarama)%25EF%25BC%259AGo" target="_blank" title="https://github.com/Shopify/sarama)%EF%BC%9AGo" ref="nofollow noopener noreferrer">github.com/Shopify/sar…</a> 语言中最成熟的 Kafka 客户端，我们用它处理每天数十亿的消息</li>
<li><code>nats.go</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnats-io%2Fnats.go)%25EF%25BC%259A%25E8%25BD%25BB%25E9%2587%258F%25E7%25BA%25A7%25E7%259A%2584%25E6%25B6%2588%25E6%2581%25AF%25E9%2598%259F%25E5%2588%2597%25EF%25BC%258C%25E9%2580%2582%25E5%2590%2588%25E5%25BB%25B6%25E8%25BF%259F%25E6%2595%258F%25E6%2584%259F%25E7%259A%2584%25E5%259C%25BA%25E6%2599%25AF" target="_blank" title="https://github.com/nats-io/nats.go)%EF%BC%9A%E8%BD%BB%E9%87%8F%E7%BA%A7%E7%9A%84%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8C%E9%80%82%E5%90%88%E5%BB%B6%E8%BF%9F%E6%95%8F%E6%84%9F%E7%9A%84%E5%9C%BA%E6%99%AF" ref="nofollow noopener noreferrer">github.com/nats-io/nat…</a></li>
<li><code>watermill</code> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FThreeDotsLabs%2Fwatermill)%25EF%25BC%259AGo" target="_blank" title="https://github.com/ThreeDotsLabs/watermill)%EF%BC%9AGo" ref="nofollow noopener noreferrer">github.com/ThreeDotsLa…</a> 语言的事件驱动框架，支持多种消息队列后端</li>
</ul>
<p><strong>优化实招</strong>：</p>
<ul>
<li>明确定义投递语义（我们在核心业务中使用至少一次投递）</li>
<li>实现死信队列，处理消费失败的消息</li>
<li>监控消费 Lag，当 Lag 超过阈值时触发告警和扩容</li>
</ul>
<h2 data-id="heading-7">连接与传输策略：让链路保持“温热”</h2>
<p>连接管理是微服务通信性能的基石。我们的经验是：<strong>连接池配置的好坏，直接决定了系统在高并发下的稳定性</strong>。</p>
<h3 data-id="heading-8">HTTP 客户端：善用 <code>http.Transport</code></h3>
<p><strong>我们的配置实践</strong>：</p>
<p><strong>框架工具参考</strong>：</p>
<ul>
<li><strong>Hertz</strong> 与 <strong>Kratos</strong> 都提供了优化的 HTTP 客户端实现，内置连接池管理与服务发现能力</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Hertz 客户端示例（需导入 time 包）</span>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"github.com/cloudwego/hertz/client"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewHertzClient</span><span class="hljs-params">()</span></span> client.Client {
    c, _ := client.NewClient(
        client.WithTimeout(<span class="hljs-number">800</span>*time.Millisecond),
        client.WithMaxConnsPerHost(<span class="hljs-number">100</span>),
        client.WithMaxIdleConnsPerHost(<span class="hljs-number">50</span>),
        client.WithIdleConnTimeout(<span class="hljs-number">60</span>*time.Second),
    )
    <span class="hljs-keyword">return</span> c
}
</code></pre>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建一个高性能的 HTTP 客户端</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewHTTPClient</span><span class="hljs-params">()</span></span> *http.Client {
    <span class="hljs-keyword">return</span> &amp;http.Client{
        Timeout: <span class="hljs-number">800</span> * time.Millisecond, <span class="hljs-comment">// 总超时控制</span>
        Transport: &amp;http.Transport{
            <span class="hljs-comment">// 连接池配置</span>
            MaxIdleConns:        <span class="hljs-number">1000</span>,    <span class="hljs-comment">// 全局最大空闲连接数</span>
            MaxIdleConnsPerHost: <span class="hljs-number">100</span>,     <span class="hljs-comment">// 每个主机的最大空闲连接数</span>
            IdleConnTimeout:     <span class="hljs-number">60</span> * time.Second, <span class="hljs-comment">// 空闲连接超时时间</span>
            
            <span class="hljs-comment">// 连接建立相关</span>
            TLSHandshakeTimeout:   <span class="hljs-number">300</span> * time.Millisecond, <span class="hljs-comment">// TLS 握手超时</span>
            ExpectContinueTimeout: <span class="hljs-number">100</span> * time.Millisecond, <span class="hljs-comment">// 100-continue 超时</span>
            DialContext: (&amp;net.Dialer{
                Timeout:   <span class="hljs-number">500</span> * time.Millisecond, <span class="hljs-comment">// 连接建立超时</span>
                KeepAlive: <span class="hljs-number">60</span> * time.Second,       <span class="hljs-comment">// TCP Keep-Alive</span>
                DualStack: <span class="hljs-literal">true</span>,                   <span class="hljs-comment">// 支持 IPv4/IPv6</span>
            }).DialContext,
        },
    }
}
</code></pre>
<p><strong>真实踩坑经验</strong>：</p>
<ul>
<li>早期我们将 <code>MaxIdleConnsPerHost</code> 设置为 10，结果在峰值 QPS 达到 1000 时，每秒创建了 100 个新连接，TLS 握手延迟飙升</li>
<li>后来根据公式 <code>MaxIdleConnsPerHost = 峰值 QPS × 平均响应时间</code>，计算出需要 100 左右，调整后连接复用率从 30% 提升到了 90%</li>
</ul>
<p><strong>进阶优化</strong>：</p>
<ol>
<li>
<p><strong>自定义 DNS 缓存</strong>（解决 DNS 解析延迟问题）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 简单的 DNS 缓存实现</span>
<span class="hljs-keyword">type</span> DNSCache <span class="hljs-keyword">struct</span> {
    cache <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]net.IP
    mu    sync.RWMutex
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *DNSCache)</span></span> LookupIP(host <span class="hljs-type">string</span>) ([]net.IP, <span class="hljs-type">error</span>) {
    c.mu.RLock()
    ips, ok := c.cache[host]
    c.mu.RUnlock()
    <span class="hljs-keyword">if</span> ok {
        <span class="hljs-keyword">return</span> ips, <span class="hljs-literal">nil</span>
    }
    
    ips, err := net.LookupIP(host)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    c.mu.Lock()
    c.cache[host] = ips
    c.mu.Unlock()
    <span class="hljs-keyword">return</span> ips, <span class="hljs-literal">nil</span>
}
</code></pre>
</li>
<li>
<p><strong>使用 <code>httptrace</code> 分析请求阶段耗时</strong>：</p>
<pre><code class="hljs language-go" lang="go">trace := &amp;httptrace.ClientTrace{
    ConnectStart: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(network, addr <span class="hljs-type">string</span>)</span></span> {
        fmt.Printf(<span class="hljs-string">"ConnectStart: %s %s\n"</span>, network, addr)
    },
    ConnectDone: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(network, addr <span class="hljs-type">string</span>, err <span class="hljs-type">error</span>)</span></span> {
        fmt.Printf(<span class="hljs-string">"ConnectDone: %s %s, err: %v\n"</span>, network, addr, err)
    },
    TLSHandshakeStart: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        fmt.Println(<span class="hljs-string">"TLSHandshakeStart"</span>)
    },
    TLSHandshakeDone: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(cs tls.ConnectionState, err <span class="hljs-type">error</span>)</span></span> {
        fmt.Printf(<span class="hljs-string">"TLSHandshakeDone: err: %v\n"</span>, err)
    },
    GotFirstResponseByte: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        fmt.Println(<span class="hljs-string">"GotFirstResponseByte"</span>)
    },
}

req, _ := http.NewRequest(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"https://example.com"</span>, <span class="hljs-literal">nil</span>)
req = req.WithContext(httptrace.WithClientTrace(req.Context(), trace))
</code></pre>
</li>
</ol>
<h3 data-id="heading-9">gRPC 连接：重用 + 背压</h3>
<p><strong>我们的配置实践</strong>：</p>
<p><strong>框架工具参考</strong>：</p>
<ul>
<li><strong>Kitex</strong> 与 <strong>Kratos</strong> 都提供了封装好的 gRPC 客户端，简化了连接池与负载均衡配置</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Kitex 客户端示例</span>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"github.com/cloudwego/kitex/client"</span>
    <span class="hljs-string">"github.com/cloudwego/kitex/pkg/rpcinfo"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewKitexClient</span><span class="hljs-params">()</span></span> (YourServiceClient, <span class="hljs-type">error</span>) {
    c, err := NewClient(
        <span class="hljs-string">"your.service"</span>,
        client.WithHostPorts(<span class="hljs-string">"127.0.0.1:8888"</span>),
        client.WithRPCTimeout(<span class="hljs-number">500</span>*time.Millisecond),
        client.WithConnectTimeout(<span class="hljs-number">200</span>*time.Millisecond),
        client.WithClientBasicInfo(&amp;rpcinfo.EndpointBasicInfo{ServiceName: <span class="hljs-string">"your-client"</span>}),
    )
    <span class="hljs-keyword">return</span> c, err
}
</code></pre>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建一个高性能的 gRPC 客户端连接</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewGRPCClient</span><span class="hljs-params">(addr <span class="hljs-type">string</span>)</span></span> (*grpc.ClientConn, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">return</span> grpc.Dial(addr, 
        grpc.WithTransportCredentials(insecure.NewCredentials()),
        grpc.WithKeepaliveParams(keepalive.ClientParameters{
            Time:                <span class="hljs-number">30</span> * time.Second,    <span class="hljs-comment">// 发送 keepalive 的时间间隔</span>
            Timeout:             <span class="hljs-number">5</span> * time.Second,     <span class="hljs-comment">// keepalive 超时时间</span>
            PermitWithoutStream: <span class="hljs-literal">true</span>,                <span class="hljs-comment">// 即使没有活跃流也发送 keepalive</span>
        }),
        grpc.WithDefaultCallOptions(
            grpc.MaxCallRecvMsgSize(<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">10</span>),   <span class="hljs-comment">// 最大接收消息大小（10MB）</span>
            grpc.MaxCallSendMsgSize(<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">10</span>),   <span class="hljs-comment">// 最大发送消息大小（10MB）</span>
        ),
        grpc.WithInitialWindowSize(<span class="hljs-number">65535</span>*<span class="hljs-number">10</span>),        <span class="hljs-comment">// 初始窗口大小</span>
        grpc.WithInitialConnWindowSize(<span class="hljs-number">65535</span>*<span class="hljs-number">100</span>),   <span class="hljs-comment">// 初始连接窗口大小</span>
    )
}
</code></pre>
<p><strong>真实调优经验</strong>：</p>
<ul>
<li>在我们的实时推荐系统中，曾因 gRPC 流控制配置不当，导致单流写满缓冲后阻塞了其他请求</li>
<li>通过监控 <code>sent/recv message per stream</code> 指标，我们发现问题并调整了窗口大小，最终将 P99 延迟降低了 40%</li>
</ul>
<p><strong>背压实现</strong>：</p>
<ul>
<li>使用 <code>grpc-go</code> 的流控制机制，监控 <code>inflight</code> 请求数量</li>
<li>当 <code>inflight</code> 请求超过阈值时，主动拒绝新请求或触发降级</li>
</ul>
<h3 data-id="heading-10">服务端调优：多路复用 + 零拷贝</h3>
<p><strong>HTTP/2 服务端配置</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 创建一个高性能的 HTTP/2 服务器</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewHTTP2Server</span><span class="hljs-params">()</span></span> *http.Server {
    <span class="hljs-keyword">return</span> &amp;http.Server{
        Addr: <span class="hljs-string">":8080"</span>,
        Handler: http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
            <span class="hljs-comment">// 处理请求</span>
        }),
        TLSConfig: &amp;tls.Config{
            MinVersion: tls.VersionTLS12,
            <span class="hljs-comment">// 启用 HTTP/2</span>
            NextProtos: []<span class="hljs-type">string</span>{<span class="hljs-string">"h2"</span>, <span class="hljs-string">"http/1.1"</span>},
        },
        ReadHeaderTimeout: <span class="hljs-number">500</span> * time.Millisecond,
        ReadTimeout:       <span class="hljs-number">2</span> * time.Second,
        WriteTimeout:      <span class="hljs-number">2</span> * time.Second,
        IdleTimeout:       <span class="hljs-number">60</span> * time.Second,
    }
}
</code></pre>
<p><strong>零拷贝实践</strong>：</p>
<ul>
<li>在我们的静态资源服务中，使用 <code>io.Copy</code> 代替手动读写，触发内核零拷贝</li>
<li>对于大文件传输，使用 <code>http.ServeFile</code> 或 <code>http.ServeContent</code>，它们内部会使用 <code>sendfile</code> 系统调用</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 零拷贝传输文件</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">serveFile</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
    file, err := os.Open(<span class="hljs-string">"path/to/file"</span>)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        http.Error(w, <span class="hljs-string">"File not found"</span>, http.StatusNotFound)
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">defer</span> file.Close()
    
    stat, _ := file.Stat()
    w.Header().Set(<span class="hljs-string">"Content-Length"</span>, strconv.FormatInt(stat.Size(), <span class="hljs-number">10</span>))
    w.Header().Set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/octet-stream"</span>)
    
    <span class="hljs-comment">// 使用 io.Copy 触发零拷贝</span>
    io.Copy(w, file)
}
</code></pre>
<p><strong>防御慢客户端</strong>：</p>
<ul>
<li>设置 <code>ReadIdleTimeout</code> 关闭长时间空闲的连接</li>
<li>使用 <code>http.MaxBytesReader</code> 限制请求体大小，防止内存溢出</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 限制请求体大小为 1MB</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">limitRequestBody</span><span class="hljs-params">(next http.Handler)</span></span> http.Handler {
    <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
        r.Body = http.MaxBytesReader(w, r.Body, <span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>)
        next.ServeHTTP(w, r)
    })
}
</code></pre>
<h2 data-id="heading-11">数据编码与负载裁剪：传得快还要传得准</h2>
<p>数据编码是通信性能的另一个关键因素。我们的原则是：<strong>只传需要的，压缩能压缩的，选择高效的序列化格式</strong>。</p>
<h3 data-id="heading-12">序列化格式选择：没有银弹，只有最合适</h3>
<p><strong>我们的选型实践</strong>：</p>






























<table><thead><tr><th>场景</th><th>推荐格式</th><th>真实效果</th></tr></thead><tbody><tr><td>核心服务间高频调用</td><td>ProtoBuf</td><td>比 JSON 小 60%，序列化速度快 3-5 倍</td></tr><tr><td>面向前端的 API</td><td>JSON + 字段裁剪</td><td>平衡了灵活性和性能</td></tr><tr><td>对延迟极端敏感的场景</td><td>FlatBuffers</td><td>无需解析，直接内存访问，延迟降低 50%</td></tr><tr><td>配置文件</td><td>JSON/YAML</td><td>可读性优先，维护成本低</td></tr></tbody></table>
<p><strong>开源工具推荐</strong>：</p>
<ul>
<li><code>github.com/json-iterator/go</code>（jsoniter）：比标准库 <code>encoding/json</code> 快 2-3 倍，API 兼容</li>
<li><code>github.com/bytedance/sonic</code>：字节跳动开源的 JSON 库，比 jsoniter 更快（但 API 不完全兼容）</li>
<li><code>github.com/golang/protobuf</code>：官方 ProtoBuf 库</li>
<li><code>github.com/google/flatbuffers/go</code>：FlatBuffers 的 Go 实现</li>
</ul>
<h3 data-id="heading-13">字段裁剪：只传需要的数据</h3>
<p><strong>ProtoBuf 中的字段裁剪</strong>：</p>
<ul>
<li>使用 <code>oneof</code> 代替可选字段，减少编码开销</li>
<li>使用 <code>map</code> 存储动态字段，避免定义过多可选字段</li>
<li>在 <code>.proto</code> 文件中使用 <code>reserved</code> 标记不再使用的字段，防止误用</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-proto" lang="proto">// 不推荐：过多可选字段
message User {
    string id = 1;
    string name = 2;
    optional int32 age = 3;
    optional string email = 4;
    optional string phone = 5;
    // ... 更多可选字段
}

// 推荐：使用 oneof 和 map
message User {
    string id = 1;
    string name = 2;
    oneof contact {
        string email = 3;
        string phone = 4;
    }
    map&lt;string, string&gt; extra_info = 5;
}
</code></pre>
<p><strong>REST API 中的字段裁剪</strong>：</p>
<ul>
<li>支持 <code>fields=id,name,email</code> 查询参数，只返回指定字段</li>
<li>在我们的用户中心 API 中，实现字段裁剪后，响应大小减少了 40%，QPS 提升了 25%</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 字段裁剪中间件</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">fieldSelector</span><span class="hljs-params">(next http.Handler)</span></span> http.Handler {
    <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
        fields := r.URL.Query().Get(<span class="hljs-string">"fields"</span>)
        <span class="hljs-keyword">if</span> fields == <span class="hljs-string">""</span> {
            next.ServeHTTP(w, r)
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 记录需要返回的字段</span>
        requiredFields := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>)
        <span class="hljs-keyword">for</span> _, field := <span class="hljs-keyword">range</span> strings.Split(fields, <span class="hljs-string">","</span>) {
            requiredFields[strings.TrimSpace(field)] = <span class="hljs-literal">true</span>
        }
        
        <span class="hljs-comment">// 使用自定义 ResponseWriter 拦截响应并裁剪字段</span>
        crw := &amp;customResponseWriter{ResponseWriter: w, fields: requiredFields}
        next.ServeHTTP(crw, r)
    })
}
</code></pre>
<h3 data-id="heading-14">压缩策略：平衡CPU和带宽</h3>
<p><strong>我们的压缩实践</strong>：</p>
<ul>
<li>对于小于 1KB 的消息，不启用压缩（压缩开销可能超过收益）</li>
<li>对于大于 1KB 的消息，使用 gzip 或 brotli 压缩</li>
<li>在 gRPC 中，使用 <code>grpc.UseCompressor("gzip")</code> 启用压缩</li>
</ul>
<p><strong>gRPC 压缩配置</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 客户端启用 gzip 压缩</span>
conn, err := grpc.Dial(addr, 
    grpc.WithTransportCredentials(insecure.NewCredentials()),
    grpc.WithDefaultCallOptions(
        grpc.UseCompressor(<span class="hljs-string">"gzip"</span>),
        grpc.MaxCallRecvMsgSize(<span class="hljs-number">10</span>*<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>),
    ),
)

<span class="hljs-comment">// 服务端启用 gzip 压缩</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"google.golang.org/grpc/encoding/gzip"</span>

srv := grpc.NewServer(
    grpc.RPCCompressor(gzip.GzipCompressor),
)
</code></pre>
<p><strong>HTTP 压缩配置</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 使用 net/http 启用 gzip 压缩</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/klauspost/compress/gzhttp"</span>

mux := http.NewServeMux()
mux.HandleFunc(<span class="hljs-string">"/"</span>, handler)

<span class="hljs-comment">// 使用 gzhttp 包装 handler，自动处理压缩</span>
compressedHandler := gzhttp.GzipHandler(mux)

srv := &amp;http.Server{
    Addr:    <span class="hljs-string">":8080"</span>,
    Handler: compressedHandler,
}
</code></pre>
<h3 data-id="heading-15">序列化缓存：避免重复工作</h3>
<p><strong>我们的缓存实践</strong>：</p>
<ul>
<li>在热路径上，缓存序列化后的 <code>[]byte</code> 结果</li>
<li>使用 <code>sync.Pool</code> 复用序列化缓冲区，减少内存分配</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 缓存序列化结果</span>
<span class="hljs-keyword">type</span> CachedSerializer <span class="hljs-keyword">struct</span> {
    cache sync.Map <span class="hljs-comment">// key: 结构体指针, value: []byte</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(cs *CachedSerializer)</span></span> Marshal(v <span class="hljs-keyword">interface</span>{}) ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) {
    key := reflect.ValueOf(v).Pointer()
    <span class="hljs-keyword">if</span> data, ok := cs.cache.Load(key); ok {
        <span class="hljs-keyword">return</span> data.([]<span class="hljs-type">byte</span>), <span class="hljs-literal">nil</span>
    }
    
    data, err := jsoniter.Marshal(v)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    cs.cache.Store(key, data)
    <span class="hljs-keyword">return</span> data, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 使用 sync.Pool 复用缓冲区</span>
<span class="hljs-keyword">var</span> bufferPool = sync.Pool{
    New: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">interface</span>{} {
        <span class="hljs-keyword">return</span> &amp;bytes.Buffer{}
    },
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">MarshalWithPool</span><span class="hljs-params">(v <span class="hljs-keyword">interface</span>{})</span></span> ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) {
    buf := bufferPool.Get().(*bytes.Buffer)
    buf.Reset()
    <span class="hljs-keyword">defer</span> bufferPool.Put(buf)
    
    <span class="hljs-keyword">if</span> err := jsoniter.NewEncoder(buf).Encode(v); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">append</span>([]<span class="hljs-type">byte</span>{}, buf.Bytes()...), <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-16">幂等设计：避免重试副作用</h3>
<p><strong>我们的幂等实践</strong>：</p>
<ul>
<li>所有写操作都必须支持幂等</li>
<li>使用业务幂等键（如内容ID、请求流水号）确保重复请求不会产生副作用</li>
<li>在服务端使用 Redis <code>SETNX</code> 或数据库唯一约束实现幂等性</li>
</ul>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 幂等处理器</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">idempotentHandler</span><span class="hljs-params">(redisClient *redis.Client)</span></span> http.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
        <span class="hljs-comment">// 从请求头获取幂等键</span>
        idempotencyKey := r.Header.Get(<span class="hljs-string">"X-Idempotency-Key"</span>)
        <span class="hljs-keyword">if</span> idempotencyKey == <span class="hljs-string">""</span> {
            http.Error(w, <span class="hljs-string">"Missing X-Idempotency-Key"</span>, http.StatusBadRequest)
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 检查是否已经处理过</span>
        key := fmt.Sprintf(<span class="hljs-string">"idempotent:%s"</span>, idempotencyKey)
        exists, err := redisClient.Exists(r.Context(), key).Result()
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            http.Error(w, <span class="hljs-string">"Internal Server Error"</span>, http.StatusInternalServerError)
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-keyword">if</span> exists == <span class="hljs-number">1</span> {
            <span class="hljs-comment">// 已经处理过，直接返回结果</span>
            w.WriteHeader(http.StatusOK)
            w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">"Already processed"</span>))
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 执行实际业务逻辑</span>
        <span class="hljs-comment">// ...</span>
        
        <span class="hljs-comment">// 标记为已处理，设置过期时间</span>
        redisClient.Set(r.Context(), key, <span class="hljs-string">"processed"</span>, <span class="hljs-number">24</span>*time.Hour)
        
        w.WriteHeader(http.StatusOK)
        w.Write([]<span class="hljs-type">byte</span>(<span class="hljs-string">"Success"</span>))
    }
}
</code></pre>
<h2 data-id="heading-17">调优四象限：延迟、吞吐、成本、可靠性</h2>
<p>在实际调优中，我们发现延迟、吞吐、成本和可靠性往往相互制约。以下是我们在实践中总结的调优指南，包含真实案例和可操作的建议。</p>
<h3 data-id="heading-18">延迟优化：从毫秒到微秒的突破</h3>
<p><strong>核心思路</strong>：减少网络往返、优化协议栈、降低序列化开销。</p>
<p><strong>我们的延迟优化实践</strong>：</p>



































<table><thead><tr><th>优化项</th><th>具体措施</th><th>真实效果</th></tr></thead><tbody><tr><td>协议升级</td><td>从 HTTP/1.1 升级到 gRPC</td><td>延迟降低 40%</td></tr><tr><td>连接复用</td><td>优化 HTTP 连接池配置</td><td>TLS 握手次数减少 95%</td></tr><tr><td>序列化优化</td><td>从 JSON 切换到 ProtoBuf</td><td>序列化时间减少 70%</td></tr><tr><td>中间件优化</td><td>移除不必要的调试中间件</td><td>延迟降低 15%</td></tr><tr><td>地域优化</td><td>避免跨 AZ 调用</td><td>延迟降低 30%</td></tr></tbody></table>
<p><strong>代码示例：设置合理的超时</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 使用 context.WithTimeout 设置调用超时</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callService</span><span class="hljs-params">(ctx context.Context, client ServiceClient, req *Request)</span></span> (*Response, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 设置 500ms 超时</span>
    timeoutCtx, cancel := context.WithTimeout(ctx, <span class="hljs-number">500</span>*time.Millisecond)
    <span class="hljs-keyword">defer</span> cancel()
    
    <span class="hljs-comment">// 在新的超时上下文下执行调用</span>
    <span class="hljs-keyword">return</span> client.Call(timeoutCtx, req)
}

<span class="hljs-comment">// 优化 gRPC 客户端延迟配置</span>
conn, err := grpc.Dial(addr, 
    grpc.WithTransportCredentials(insecure.NewCredentials()),
    grpc.WithDefaultCallOptions(
        grpc.WaitForReady(<span class="hljs-literal">true</span>), <span class="hljs-comment">// 等待服务就绪</span>
        grpc.PerRPCCredentials(credentials.NewTLS(tlsConfig)),
        grpc.WithCompressor(<span class="hljs-string">"gzip"</span>),
    ),
    grpc.WithUnaryInterceptor(grpc_retry.UnaryClientInterceptor(
        grpc_retry.WithMax(<span class="hljs-number">3</span>),
        grpc_retry.WithBackoff(grpc_retry.BackoffExponential(<span class="hljs-number">100</span>*time.Millisecond)),
    )),
)
</code></pre>
<h3 data-id="heading-19">吞吐优化：从千级到万级的跨越</h3>
<p><strong>核心思路</strong>：增加并发度、优化资源利用、减少锁竞争。</p>
<p><strong>我们的吞吐优化实践</strong>：</p>



































<table><thead><tr><th>优化项</th><th>具体措施</th><th>真实效果</th></tr></thead><tbody><tr><td>连接池扩容</td><td>调大 <code>MaxIdleConns</code> 和 <code>MaxConnsPerHost</code></td><td>QPS 提升 150%</td></tr><tr><td>并行度调优</td><td>使用 <code>errgroup</code> 并发处理请求</td><td>吞吐量提升 200%</td></tr><tr><td>负载均衡</td><td>从轮询切换到一致性哈希</td><td>热点分布更均匀</td></tr><tr><td>内存优化</td><td>使用 <code>sync.Pool</code> 复用对象</td><td>GC 耗时减少 60%</td></tr><tr><td>请求合并</td><td>实现批量 API</td><td>网络往返减少 70%</td></tr></tbody></table>
<p><strong>代码示例：使用 errgroup 并发处理请求</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"golang.org/x/sync/errgroup"</span>

<span class="hljs-comment">// 并发调用多个服务</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">batchCallServices</span><span class="hljs-params">(ctx context.Context, clients []ServiceClient, reqs []*Request)</span></span> ([]*Response, <span class="hljs-type">error</span>) {
    g, gCtx := errgroup.WithContext(ctx)
    respCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *Response, <span class="hljs-built_in">len</span>(reqs))
    
    <span class="hljs-keyword">for</span> i, client := <span class="hljs-keyword">range</span> clients {
        req := reqs[i]
        g.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
            resp, err := client.Call(gCtx, req)
            <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-keyword">return</span> err
            }
            respCh &lt;- resp
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        })
    }
    
    <span class="hljs-keyword">if</span> err := g.Wait(); err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-built_in">close</span>(respCh)
    
    <span class="hljs-keyword">var</span> resps []*Response
    <span class="hljs-keyword">for</span> resp := <span class="hljs-keyword">range</span> respCh {
        resps = <span class="hljs-built_in">append</span>(resps, resp)
    }
    
    <span class="hljs-keyword">return</span> resps, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-20">成本优化：用最少的资源办最多的事</h3>
<p><strong>核心思路</strong>：动态资源调整、请求合并、资源复用。</p>
<p><strong>我们的成本优化实践</strong>：</p>



































<table><thead><tr><th>优化项</th><th>具体措施</th><th>真实效果</th></tr></thead><tbody><tr><td>动态连接池</td><td>根据负载调整连接数</td><td>资源利用率提升 80%</td></tr><tr><td>请求合并</td><td>实现批量查询 API</td><td>网络成本降低 60%</td></tr><tr><td>资源复用</td><td>使用 <code>sync.Pool</code> 复用缓冲区</td><td>内存占用减少 40%</td></tr><tr><td>低峰期缩容</td><td>按业务低峰期释放资源</td><td>服务器成本降低 30%</td></tr><tr><td>批量处理</td><td>实现异步批量任务</td><td>计算资源利用率提升 70%</td></tr></tbody></table>
<p><strong>代码示例：动态调整连接池大小</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 动态连接池</span>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"golang.org/x/time/rate"</span>
)

<span class="hljs-keyword">type</span> DynamicConnectionPool <span class="hljs-keyword">struct</span> {
    pool          *http.Client
    limiter       *rate.Limiter
    maxConn       <span class="hljs-type">int</span>
    currentConn   <span class="hljs-type">int</span>
    mu            sync.Mutex
    lastAdjustTime time.Time
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewDynamicConnectionPool</span><span class="hljs-params">(maxConn <span class="hljs-type">int</span>)</span></span> *DynamicConnectionPool {
    <span class="hljs-keyword">return</span> &amp;DynamicConnectionPool{
        pool: &amp;http.Client{
            Transport: &amp;http.Transport{
                MaxIdleConns:        maxConn,
                MaxIdleConnsPerHost: maxConn,
            },
        },
        limiter:       rate.NewLimiter(rate.Limit(maxConn), maxConn),
        maxConn:       maxConn,
        currentConn:   maxConn / <span class="hljs-number">2</span>, <span class="hljs-comment">// 初始为最大连接数的一半</span>
        lastAdjustTime: time.Now(),
    }
}

<span class="hljs-comment">// 动态调整连接池大小</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *DynamicConnectionPool)</span></span> adjustPoolSize() {
    p.mu.Lock()
    <span class="hljs-keyword">defer</span> p.mu.Unlock()
    
    <span class="hljs-comment">// 每 5 分钟调整一次</span>
    <span class="hljs-keyword">if</span> time.Since(p.lastAdjustTime) &lt; <span class="hljs-number">5</span>*time.Minute {
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// 根据最近的请求速率调整连接池大小</span>
    <span class="hljs-comment">// 这里简化处理，实际应该根据历史监控数据</span>
    currentRate := p.limiter.Limit()
    newConn := <span class="hljs-type">int</span>(currentRate * <span class="hljs-number">1.5</span>)
    <span class="hljs-keyword">if</span> newConn &gt; p.maxConn {
        newConn = p.maxConn
    }
    <span class="hljs-keyword">if</span> newConn &lt; <span class="hljs-number">10</span> {
        newConn = <span class="hljs-number">10</span>
    }
    
    p.currentConn = newConn
    p.limiter.SetLimit(rate.Limit(newConn))
    
    <span class="hljs-comment">// 更新连接池配置</span>
    transport := p.pool.Transport.(*http.Transport)
    transport.MaxIdleConns = newConn
    transport.MaxIdleConnsPerHost = newConn
    
    p.lastAdjustTime = time.Now()
    log.Printf(<span class="hljs-string">"Adjusted connection pool size from %d to %d"</span>, <span class="hljs-type">int</span>(currentRate), newConn)
}
</code></pre>
<h3 data-id="heading-21">可靠性优化：从可用到高可用的蜕变</h3>
<p><strong>核心思路</strong>：超时控制、重试策略、熔断降级、监控告警。</p>
<p><strong>我们的可靠性优化实践</strong>：</p>



































<table><thead><tr><th>优化项</th><th>具体措施</th><th>真实效果</th></tr></thead><tbody><tr><td>超时控制</td><td>为所有外部调用设置合理超时</td><td>错误率降低 80%</td></tr><tr><td>重试策略</td><td>实现指数退避重试</td><td>成功重试率提升 70%</td></tr><tr><td>熔断降级</td><td>使用 <code>hystrix-go</code> 实现熔断</td><td>雪崩效应完全避免</td></tr><tr><td>监控告警</td><td>监控 P99 延迟和错误率</td><td>故障发现时间缩短 90%</td></tr><tr><td>限流保护</td><td>实现令牌桶限流</td><td>服务可用性提升到 99.99%</td></tr></tbody></table>
<p><strong>代码示例：使用 hystrix-go 实现熔断</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/afex/hystrix-go/hystrix"</span>

<span class="hljs-comment">// 初始化熔断器</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initHystrix</span><span class="hljs-params">()</span></span> {
    hystrix.ConfigureCommand(<span class="hljs-string">"service-call"</span>, hystrix.CommandConfig{
        Timeout:                <span class="hljs-number">500</span>,   <span class="hljs-comment">// 500ms 超时</span>
        MaxConcurrentRequests:  <span class="hljs-number">100</span>,   <span class="hljs-comment">// 最大并发请求数</span>
        RequestVolumeThreshold: <span class="hljs-number">20</span>,    <span class="hljs-comment">// 20 个请求才触发统计</span>
        SleepWindow:            <span class="hljs-number">5000</span>,  <span class="hljs-comment">// 5 秒后尝试半开</span>
        ErrorPercentThreshold:  <span class="hljs-number">50</span>,    <span class="hljs-comment">// 错误率超过 50% 触发熔断</span>
    })
}

<span class="hljs-comment">// 使用熔断器包装服务调用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callServiceWithCircuitBreaker</span><span class="hljs-params">(ctx context.Context, client ServiceClient, req *Request)</span></span> (*Response, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">var</span> resp *Response
    err := hystrix.Do(<span class="hljs-string">"service-call"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
        <span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
        resp, err = client.Call(ctx, req)
        <span class="hljs-keyword">return</span> err
    }, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">error</span> {
        <span class="hljs-comment">// 降级逻辑：返回默认值或错误</span>
        log.Printf(<span class="hljs-string">"Circuit breaker open, returning fallback: %v"</span>, err)
        <span class="hljs-keyword">return</span> err
    })
    
    <span class="hljs-keyword">return</span> resp, err
}

<span class="hljs-comment">// 使用令牌桶实现限流</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"golang.org/x/time/rate"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">rateLimitMiddleware</span><span class="hljs-params">(limiter *rate.Limiter)</span></span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(http.Handler)</span></span> http.Handler {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(next http.Handler)</span></span> http.Handler {
        <span class="hljs-keyword">return</span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span> {
            <span class="hljs-keyword">if</span> !limiter.Allow() {
                http.Error(w, <span class="hljs-string">"Too Many Requests"</span>, http.StatusTooManyRequests)
                <span class="hljs-keyword">return</span>
            }
            next.ServeHTTP(w, r)
        })
    }
}
</code></pre>
<h2 data-id="heading-22">工程治理：观测、灰度与流量控制</h2>
<p>工程治理是通信优化的重要保障，它让我们能够发现问题、验证优化效果并确保服务的稳定性。以下是我们在实践中总结的治理经验。</p>
<h3 data-id="heading-23">监控指标：让性能可视化</h3>
<p><strong>核心指标体系</strong>：</p>
<p><strong>框架监控支持</strong>：</p>
<ul>
<li>国内主流框架都提供了与 Prometheus、Jaeger 等监控系统的集成能力</li>
<li><strong>Kitex</strong> 内置 RPC 相关指标收集，<strong>Kratos</strong> 提供统一的指标组件</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Kratos 监控指标示例</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/go-kratos/kratos/v2/metrics"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initMetrics</span><span class="hljs-params">()</span></span> {
    requestCounter := metrics.NewCounter(
        <span class="hljs-string">"http_request_total"</span>,
        metrics.WithLabels(<span class="hljs-string">"method"</span>, <span class="hljs-string">"path"</span>, <span class="hljs-string">"status"</span>),
        metrics.WithDescription(<span class="hljs-string">"HTTP 请求总数"</span>),
    )
    requestCounter.Inc(<span class="hljs-number">1</span>, <span class="hljs-string">"GET"</span>, <span class="hljs-string">"/api/v1/users"</span>, <span class="hljs-string">"200"</span>)
}
- **延迟指标**：P50、P95、P99 延迟，以及长尾延迟分布
- **流量指标**：QPS、TPS、并发连接数
- **错误指标**：HTTP 错误率、gRPC 错误码分布
- **协议指标**：TLS 握手次数、连接复用率、重传率
- **资源指标**：CPU、内存、带宽使用率

**开源工具推荐**：
- <span class="hljs-string">`github.com/prometheus/client_golang`</span>：Prometheus 客户端库，用于暴露指标
- <span class="hljs-string">`github.com/uber-go/tally`</span>：Uber 开源的指标库，支持多后端
- <span class="hljs-string">`github.com/grafana/grafana`</span>：数据可视化平台，用于监控面板展示

**代码示例：使用 Prometheus 监控 gRPC 服务**
<span class="hljs-string">``</span><span class="hljs-string">`go
import (
    "github.com/prometheus/client_golang/prometheus"
    "github.com/prometheus/client_golang/prometheus/promhttp"
    "google.golang.org/grpc"
    "google.golang.org/grpc/stats"
)

// gRPC 统计拦截器
func newStatsHandler() stats.Handler {
    return &amp;grpcStatsHandler{
        requestDuration: prometheus.NewHistogramVec(
            prometheus.HistogramOpts{
                Name:    "grpc_request_duration_seconds",
                Help:    "gRPC request duration",
                Buckets: prometheus.DefBuckets,
            },
            []string{"method", "status"},
        ),
    }
}

// 注册指标
grpcStats := newStatsHandler()
prometheus.MustRegister(grpcStats.requestDuration)

// 配置 gRPC 服务器
srv := grpc.NewServer(
    grpc.StatsHandler(grpcStats),
)

// 暴露 Prometheus 端点
http.Handle("/metrics", promhttp.Handler())
go http.ListenAndServe(":2112", nil)
</span></code></pre>
<h3 data-id="heading-24">日志与追踪：全链路可观测</h3>
<p><strong>我们的日志与追踪实践</strong>：</p>
<ul>
<li>使用 <code>opentelemetry-go</code> 统一日志、指标和追踪</li>
<li>实现请求全链路追踪，从客户端到服务端</li>
<li>为每个请求生成唯一的 traceID 和 spanID</li>
<li>记录关键请求参数和响应状态</li>
</ul>
<p><strong>开源工具推荐</strong>：</p>
<ul>
<li><code>go.opentelemetry.io/otel</code>：OpenTelemetry Go 客户端</li>
<li><code>github.com/rs/zerolog</code>：高性能 JSON 日志库</li>
<li><code>github.com/openzipkin/zipkin-go</code>：Zipkin 客户端库</li>
</ul>
<p><strong>代码示例：使用 OpenTelemetry 进行全链路追踪</strong></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"go.opentelemetry.io/otel"</span>
    <span class="hljs-string">"go.opentelemetry.io/otel/exporters/zipkin"</span>
    <span class="hljs-string">"go.opentelemetry.io/otel/sdk/trace"</span>
)

<span class="hljs-comment">// 初始化 OpenTelemetry</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initTracer</span><span class="hljs-params">()</span></span> (<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span>, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 创建 Zipkin  exporter</span>
    exporter, err := zipkin.New(
        <span class="hljs-string">"http://localhost:9411/api/v2/spans"</span>,
        zipkin.WithLocalEndpoint(<span class="hljs-string">"service-name"</span>, <span class="hljs-string">"localhost:8080"</span>),
    )
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-comment">// 创建 tracer provider</span>
    provider := trace.NewTracerProvider(
        trace.WithSampler(trace.AlwaysSample()),
        trace.WithBatcher(exporter),
    )
    
    <span class="hljs-comment">// 设置全局 tracer provider</span>
    otel.SetTracerProvider(provider)
    
    <span class="hljs-comment">// 返回清理函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        provider.Shutdown(context.Background())
    }, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 使用追踪包装 gRPC 客户端调用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">tracedGRPCCall</span><span class="hljs-params">(ctx context.Context, client ServiceClient, req *Request)</span></span> (*Response, <span class="hljs-type">error</span>) {
    tracer := otel.Tracer(<span class="hljs-string">"service"</span>)
    ctx, span := tracer.Start(ctx, <span class="hljs-string">"call-service"</span>)
    <span class="hljs-keyword">defer</span> span.End()
    
    <span class="hljs-comment">// 添加属性</span>
    span.SetAttributes(
        attribute.String(<span class="hljs-string">"service.method"</span>, <span class="hljs-string">"Service.Call"</span>),
        attribute.String(<span class="hljs-string">"request.id"</span>, req.ID),
    )
    
    <span class="hljs-comment">// 执行调用</span>
    resp, err := client.Call(ctx, req)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        span.RecordError(err)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    
    <span class="hljs-keyword">return</span> resp, <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-25">灰度与流量控制：安全地验证优化</h3>
<p><strong>灰度发布策略</strong>：</p>
<ul>
<li>使用 <code>istio</code> 或 <code>linkerd</code> 实现流量镜像和灰度发布</li>
<li>按用户、地域、权重等维度分配流量</li>
<li>设置回滚机制，确保出现问题时能快速恢复</li>
</ul>
<p><strong>流量控制实践</strong>：</p>
<ul>
<li>实现令牌桶限流，防止突发流量冲击</li>
<li>使用熔断器保护下游服务</li>
<li>实现请求优先级，确保核心业务不受影响</li>
</ul>
<p><strong>开源工具推荐</strong>：</p>
<ul>
<li><code>github.com/istio/istio</code>：服务网格，用于流量管理和灰度发布</li>
<li><code>github.com/envoyproxy/go-control-plane</code>：Envoy 控制平面，用于动态配置</li>
<li><code>github.com/ulule/limiter</code>：限流库，支持多种算法</li>
</ul>
<p><strong>代码示例：使用 istioctl 进行灰度发布</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建目标规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: service-destination
spec:
  host: service.default.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2'</span> | kubectl apply -f -

<span class="hljs-comment"># 创建虚拟服务，将 10% 流量路由到 v2</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: service-virtual

spec:
  hosts:
  - service.default.svc.cluster.local
  http:
  - route:
    - destination:
        host: service.default.svc.cluster.local
        subset: v1
      weight: 90
    - destination:
        host: service.default.svc.cluster.local
        subset: v2
      weight: 10'</span> | kubectl apply -f -
</code></pre>
<h3 data-id="heading-26">自动化测试：确保优化的质量</h3>
<p><strong>性能测试策略</strong>：</p>
<ul>
<li>使用 <code>github.com/loadimpact/k6</code> 或 <code>github.com/gatling/gatling</code> 进行负载测试</li>
<li>模拟真实的用户行为和流量模式</li>
<li>关注 P99 延迟和错误率等关键指标</li>
</ul>
<p><strong>混沌工程实践</strong>：</p>
<ul>
<li>使用 <code>github.com/Netflix/chaosmonkey</code> 或 <code>github.com/chaos-mesh/chaos-mesh</code> 进行故障注入</li>
<li>测试服务在网络延迟、节点故障等情况下的表现</li>
<li>验证熔断、重试等机制的有效性</li>
</ul>
<p><strong>代码示例：使用 k6 进行性能测试</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">'k6/http'</span>;
<span class="hljs-keyword">import</span> { check, sleep } <span class="hljs-keyword">from</span> <span class="hljs-string">'k6'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> options = {
    <span class="hljs-attr">stages</span>: [
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'30s'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">100</span> },  <span class="hljs-comment">// 逐步增加到 100 并发</span>
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'1m'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">100</span> },   <span class="hljs-comment">// 保持 100 并发</span>
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'30s'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">200</span> },  <span class="hljs-comment">// 逐步增加到 200 并发</span>
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'1m'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">200</span> },   <span class="hljs-comment">// 保持 200 并发</span>
        { <span class="hljs-attr">duration</span>: <span class="hljs-string">'30s'</span>, <span class="hljs-attr">target</span>: <span class="hljs-number">0</span> },    <span class="hljs-comment">// 逐步减少到 0 并发</span>
    ],
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> res = http.<span class="hljs-title function_">get</span>(<span class="hljs-string">'http://localhost:8080/api/v1/users/1'</span>);
    <span class="hljs-title function_">check</span>(res, {
        <span class="hljs-string">'status is 200'</span>: <span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>,
        <span class="hljs-string">'response time &lt; 50ms'</span>: <span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> r.<span class="hljs-property">timings</span>.<span class="hljs-property">duration</span> &lt; <span class="hljs-number">50</span>,
    });
    <span class="hljs-title function_">sleep</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<h2 data-id="heading-27">案例一：跨区域库存系统的协议演进</h2>
<p><strong>背景</strong>：我们的电商库存中心原使用 REST + JSON 进行跨区域库存同步，存在两个主要问题：跨区域同步时延高（平均420ms）、带宽占用大（每天跨区域流量超过10TB）。</p>
<p><strong>策略</strong>：经过评估，我们决定迁移到 gRPC，拆分为 <code>ListDelta</code>、<code>ApplyDelta</code> 两类接口，并引入 streaming 传输批量更新，以减少网络往返次数。</p>
<p><strong>调优步骤</strong>：</p>
<ol>
<li><strong>编码优化</strong>：将库存结构转为 ProtoBuf，减少了 60% 的报文体积。例如，原来的 JSON 格式库存记录约 200 字节，转换后仅 80 字节。</li>
<li><strong>连接管理</strong>：每个边缘节点与中心保持 4 条长连接，启用 <code>keepalive</code> 与健康探针，确保连接稳定性。</li>
<li><strong>监控与回滚</strong>：使用 <code>otelcol</code> 收集延迟样本，设置 P99 超过 150ms 即自动回滚的策略，确保系统稳定性。</li>
</ol>
<p><strong>结果</strong>：区域同步延迟从 420ms 降至 130ms，跨区域带宽下降近一半（每天约 5.5TB），系统稳定运行三个月未出现大规模超时。</p>
<h2 data-id="heading-28">案例二：风控回调的幂等与限流改造</h2>
<p><strong>背景</strong>：风控平台通过 HTTP 回调通知多个业务线，但由于下游服务偶尔超时，导致风控系统发起海量重试，最终引发接口雪崩，成功率一度降至 50% 以下。</p>
<p><strong>策略</strong>：考虑到业务线的技术栈多样性，我们决定保留 HTTP/1.1 协议，但强化客户端限流与幂等性设计。</p>
<p><strong>调优步骤</strong>：</p>
<ol>
<li><strong>幂等性设计</strong>：引入 <code>X-Event-Id</code> 作为幂等键，服务端使用 Redis <code>SETNX</code> 命令防止重复执行，确保同一事件只会被处理一次。</li>
<li><strong>限流与重试</strong>：客户端引入 <code>golang.org/x/time/rate</code> 实现令牌桶限流，并采用指数退避重试策略；将超时时间设为 200ms 并设置重试上限（最多3次）。</li>
<li><strong>批量确认</strong>：增加 <code>/ack</code> 接口，支持一次确认多条回调，减少网络往返次数。</li>
<li><strong>观测与灰度</strong>：灰度阶段启用 <code>otelhttp</code> 中间件，按租户拆分指标，实时监控各业务线的调用情况。</li>
</ol>
<p><strong>结果</strong>：高峰期调用成功率提升至 99.7%，限流生效后未再触发网关熔断，系统稳定性显著提升。</p>
<h2 data-id="heading-29">排查清单：通信链路出问题时先看什么</h2>
<p>当通信链路出现问题时，我们通常按照以下顺序进行排查：</p>
<ol>
<li><strong>连接数暴涨</strong>：检查是否关闭了 Keep-Alive 或爆发重试；审计 <code>MaxIdleConns</code> 和 <code>MaxConnsPerHost</code> 配置。</li>
<li><strong>延迟长尾</strong>：确认是否存在慢 Resolver 或单连接多路复用堵塞；使用 <code>tcpdump</code> 关注 <code>tcp retrans</code> 指标。</li>
<li><strong>带宽飙升</strong>：排查是否启用了压缩、字段裁剪；审查大对象传输，考虑是否需要分页或分批处理。</li>
<li><strong>重试风暴</strong>：观察超时与重试策略是否匹配；防止本服务与网关双重重试，避免雪崩效应。</li>
<li><strong>SSL 错误集中</strong>：校验证书有效期、SNI 配置；开启 OCSP Stapling 缓解证书验证慢的问题。</li>
</ol>
<h2 data-id="heading-30">验收清单：上线前逐条确认</h2>
<p>在通信优化上线前，我们会逐条确认以下事项：</p>
<ol>
<li><strong>协议选择</strong>：有量化依据，并记录在 ADR（Architecture Decision Record）中，确保团队共识。</li>
<li><strong>配置对齐</strong>：客户端与服务端的超时、重试、限流、熔断配置已对齐，避免配置不一致导致的问题。</li>
<li><strong>监控覆盖</strong>：监控覆盖链路关键阶段，延迟分位与错误类型均有告警，确保问题可及时发现。</li>
<li><strong>压测验证</strong>：包括突发流量、跨可用区、慢下游三类场景，验证系统在极端情况下的表现。</li>
<li><strong>回滚路径</strong>：明确回滚路径，能在十分钟内恢复旧协议，降低风险。</li>
</ol>
<h2 data-id="heading-31">总结：通信优化的核心原则</h2>
<ol>
<li><strong>协议匹配场景</strong>：核心服务用 gRPC/Kitex，公开 API 用 HTTP/Hertz，异步用消息队列</li>
<li><strong>连接池是基础</strong>：合理配置 <code>MaxIdleConns</code> 和 <code>MaxIdleConnsPerHost</code>，或直接使用框架默认优化配置</li>
<li><strong>数据传输精瘦化</strong>：优先使用 ProtoBuf，实现字段裁剪，按需启用压缩</li>
<li><strong>系统具备弹性</strong>：实现超时控制、智能重试、熔断和限流机制</li>
<li><strong>治理持续优化</strong>：建立完善的监控体系，通过灰度发布验证优化效果</li>
</ol>
<p><strong>框架选择参考</strong>：</p>
<ul>
<li>高性能 HTTP 服务：考虑 Hertz</li>
<li>高性能 RPC 场景：考虑 Kitex</li>
<li>完整微服务解决方案：考虑 Kratos</li>
</ul>
<p>国内框架在实际生产环境中经过验证，能有效简化通信层的配置与优化工作。</p>
<p>通过这些实践，我们可以构建一个高效、稳定、可维护的微服务通信系统，为业务的快速发展提供可靠的技术支撑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 饼图入门：3 行代码展示数据占比]]></title>    <link>https://juejin.cn/post/7577690150092767272</link>    <guid>https://juejin.cn/post/7577690150092767272</guid>    <pubDate>2025-11-29T15:19:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150092767272" data-draft-id="7576187677839392783" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 饼图入门：3 行代码展示数据占比"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-11-29T15:19:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MOMO陌染"/> <meta itemprop="url" content="https://juejin.cn/user/546920729166618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 饼图入门：3 行代码展示数据占比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/546920729166618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MOMO陌染
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:19:09.000Z" title="Sat Nov 29 2025 15:19:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>饼图的核心作用是<strong>直观呈现各部分数据占总体的比例关系</strong>（比如不同产品的市场份额、家庭开支构成、班级成绩等级分布等），通过扇形的大小对比，能快速看出 “谁占比最高”“谁占比最低”。借助<code>matplotlib</code>库，新手也能轻松用 Python 画出清晰的饼图。</p>
<h2 data-id="heading-0">一、准备工作：安装并导入库</h2>
<p>和之前的柱状图、折线图、散点图一致，核心依赖<code>matplotlib</code>库，若未安装，打开终端 / 命令提示符输入：</p>
<pre><code class="hljs language-bash" lang="bash">pip install matplotlib
</code></pre>
<p>安装完成后，在代码中导入库（惯例简写为<code>plt</code>）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
</code></pre>
<h2 data-id="heading-1">二、最基础的饼图：3 行核心代码</h2>
<p>我们以 “某家庭 monthly 开支构成” 为例，手把手实现第一个饼图。</p>
<h3 data-id="heading-2">步骤 1：准备数据</h3>
<p>定义两个列表，对应 “分类数据”（比如开支项目）和 “对应占比 / 数值”（比如开支金额，饼图会自动计算占比）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 分类数据（饼图的各部分名称）</span>
expenses = [<span class="hljs-string">"房租"</span>, <span class="hljs-string">"餐饮"</span>, <span class="hljs-string">"交通"</span>, <span class="hljs-string">"娱乐"</span>, <span class="hljs-string">"其他"</span>]
<span class="hljs-comment"># 对应数值（可直接用金额，饼图自动计算占比）</span>
amounts = [<span class="hljs-number">3500</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">800</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">500</span>]
</code></pre>
<h3 data-id="heading-3">步骤 2：绘制饼图</h3>
<p>用<code>plt.pie()</code>函数绘制，核心参数是<code>数值数据</code>和<code>分类标签</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 绘制饼图（核心代码）</span>
plt.pie(amounts, labels=expenses)
</code></pre>
<h3 data-id="heading-4">步骤 3：显示图表</h3>
<p>用<code>plt.show()</code>展示绘制结果：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 显示图表</span>
plt.show()
</code></pre>
<h3 data-id="heading-5">完整代码（直接运行可用）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 1. 准备数据</span>
expenses = [<span class="hljs-string">"房租"</span>, <span class="hljs-string">"餐饮"</span>, <span class="hljs-string">"交通"</span>, <span class="hljs-string">"娱乐"</span>, <span class="hljs-string">"其他"</span>]  <span class="hljs-comment"># 分类标签</span>
amounts = [<span class="hljs-number">3500</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">800</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">500</span>]  <span class="hljs-comment"># 对应数值（金额/数量）</span>

<span class="hljs-comment"># 2. 绘制饼图</span>
plt.pie(amounts, labels=expenses)

<span class="hljs-comment"># 3. 显示图表</span>
plt.show()
</code></pre>
<h2 data-id="heading-6">三、简单优化：让占比更清晰</h2>
<p>基础饼图可以添加 “占比百分比”“颜色区分”“突出某部分”，让图表更专业，补充 3 行代码即可：</p>
<pre><code class="hljs language-Python" lang="Python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

expenses = [<span class="hljs-string">"房租"</span>, <span class="hljs-string">"餐饮"</span>, <span class="hljs-string">"交通"</span>, <span class="hljs-string">"娱乐"</span>, <span class="hljs-string">"其他"</span>]
amounts = [<span class="hljs-number">3500</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">800</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">500</span>]

<span class="hljs-comment"># 定义颜色列表（可选，让各部分更易区分）</span>
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#96CEB4"</span>, <span class="hljs-string">"#FECA57"</span>]
<span class="hljs-comment"># 突出某部分（比如突出占比最高的房租，explode参数控制偏移距离）</span>
explode = (<span class="hljs-number">0.1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)

<span class="hljs-comment"># 绘制饼图：添加百分比、颜色、突出效果、文本格式</span>
plt.pie(
    amounts,
    labels=expenses,
    colors=colors,
    explode=explode,
    autopct=<span class="hljs-string">"%1.1f%%"</span>,  <span class="hljs-comment"># 显示占比百分比（保留1位小数）</span>
    startangle=<span class="hljs-number">90</span>  <span class="hljs-comment"># 饼图起始角度（90度=从正上方开始）</span>
)
plt.title(<span class="hljs-string">"某家庭月度开支构成图"</span>)  <span class="hljs-comment"># 图表标题</span>
plt.axis(<span class="hljs-string">"equal"</span>)  <span class="hljs-comment"># 保证饼图是正圆形（避免默认椭圆）</span>

plt.show()
</code></pre>
<h2 data-id="heading-7">四、关键函数说明（新手必记）</h2>






























<table><thead><tr><th>函数</th><th>作用</th><th>常用参数</th></tr></thead><tbody><tr><td><code>plt.pie(x)</code></td><td>绘制饼图（核心）</td><td>x = 数值数据；labels = 分类标签；colors = 颜色列表；explode = 突出效果（元组，对应每个部分的偏移量）；autopct = 百分比格式（如 "%1.1f%%"= 保留 1 位小数）；startangle = 起始角度</td></tr><tr><td><code>plt.title()</code></td><td>设置图表标题</td><td>字符串（如 "月度开支构成"）</td></tr><tr><td><code>plt.axis("equal")</code></td><td>保证饼图为正圆形</td><td>固定参数 "equal"，必加（否则可能是椭圆）</td></tr><tr><td><code>plt.show()</code></td><td>显示图表</td><td>无</td></tr></tbody></table>
<h2 data-id="heading-8">五、常见应用场景</h2>
<p>饼图的核心是 “展示占比”，适合这些场景：</p>
<ol>
<li>构成分析：公司营收构成、产品市场份额、班级学生性别比例</li>
<li>资源分配：项目预算分配、时间利用占比、库存品类占比</li>
<li>层级展示：某指标下各子类别占总体的比例（比如总销售额中各区域的占比）</li>
<li>注意：分类不宜过多（建议不超过 6 类），否则扇形太小，可读性变差</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[antd渐变色边框按钮]]></title>    <link>https://juejin.cn/post/7577705544874459174</link>    <guid>https://juejin.cn/post/7577705544874459174</guid>    <pubDate>2025-11-29T10:32:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544874459174" data-draft-id="7577691061032812590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="antd渐变色边框按钮"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-29T10:32:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="呐呐呐呐呢"/> <meta itemprop="url" content="https://juejin.cn/user/2436173499753037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            antd渐变色边框按钮
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173499753037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    呐呐呐呐呢
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:32:23.000Z" title="Sat Nov 29 2025 10:32:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>直接贴代码把方便，掘金的写代码添加依赖太麻烦了</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> { v4 } <span class="hljs-keyword">from</span> <span class="hljs-string">'uuid'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ButtonProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">SizeType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd/lib/config-provider/SizeContext'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">LinearGradientProps</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">colors</span>: <span class="hljs-built_in">string</span>[];
  direction?: <span class="hljs-string">'to right'</span> | <span class="hljs-string">'to left'</span> | <span class="hljs-string">'to top'</span> | <span class="hljs-string">'to bottom'</span> | <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">angleToCoordinates</span>(<span class="hljs-params">angleDeg: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-comment">// 将角度转换为弧度</span>
  <span class="hljs-keyword">const</span> angleRad = angleDeg * (<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>);

  <span class="hljs-comment">// 计算终点坐标 (起点固定为 [0,0])</span>
  <span class="hljs-comment">// 使用单位圆上的点，长度=1</span>
  <span class="hljs-keyword">const</span> x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(angleRad);
  <span class="hljs-keyword">const</span> y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(angleRad);

  <span class="hljs-comment">// 将坐标转换为百分比字符串</span>
  <span class="hljs-comment">// SVG 渐变坐标可以是负数或大于100%</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>,
    <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>,
    <span class="hljs-attr">x2</span>: <span class="hljs-string">`<span class="hljs-subst">${(x * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)}</span>%`</span>,
    <span class="hljs-attr">y2</span>: <span class="hljs-string">`<span class="hljs-subst">${(y * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)}</span>%`</span>
  };
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">LinearGradientComponent</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">LinearGradientProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ id, colors, direction = <span class="hljs-string">'to right'</span> }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getCoordinates</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 处理数字角度值 (如 150deg)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> direction === <span class="hljs-string">'number'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">angleToCoordinates</span>(direction);
    }

    <span class="hljs-comment">// 处理字符串角度值 (如 "150deg")</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> direction === <span class="hljs-string">'string'</span> &amp;&amp; direction.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'deg'</span>)) {
      <span class="hljs-keyword">const</span> angle = <span class="hljs-built_in">parseFloat</span>(direction);
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(angle)) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">angleToCoordinates</span>(angle);
      }
    }

    <span class="hljs-comment">// 处理关键词方向</span>
    <span class="hljs-keyword">switch</span> (direction) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to right'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to left'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to top'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to bottom'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'100%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to top right'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
      <span class="hljs-keyword">case</span> <span class="hljs-string">'to bottom left'</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'100%'</span> };
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">x1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">y1</span>: <span class="hljs-string">'0%'</span>, <span class="hljs-attr">x2</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">y2</span>: <span class="hljs-string">'0%'</span> };
    }
  };

  <span class="hljs-keyword">const</span> { x1, y1, x2, y2 } = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getCoordinates</span>(), [direction]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">linearGradient</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{id}</span> <span class="hljs-attr">x1</span>=<span class="hljs-string">{x1}</span> <span class="hljs-attr">y1</span>=<span class="hljs-string">{y1}</span> <span class="hljs-attr">x2</span>=<span class="hljs-string">{x2}</span> <span class="hljs-attr">y2</span>=<span class="hljs-string">{y2}</span>&gt;</span>
      {colors.map((color, index) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">stop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">offset</span>=<span class="hljs-string">{</span>`${(<span class="hljs-attr">index</span> / (<span class="hljs-attr">colors.length</span> <span class="hljs-attr">-</span> <span class="hljs-attr">1</span>)) * <span class="hljs-attr">100</span>}%`} <span class="hljs-attr">stopColor</span>=<span class="hljs-string">{color}</span> /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">linearGradient</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
  <span class="hljs-attr">linear</span>: <span class="hljs-built_in">string</span>;
  hoverIconColor?: <span class="hljs-built_in">string</span>;
} &amp; <span class="hljs-title class_">ButtonProps</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">SvgButton</span> = <span class="hljs-title function_">styled</span>(<span class="hljs-title class_">Button</span>) &lt;{ disabled?: <span class="hljs-built_in">boolean</span>; <span class="hljs-attr">linear</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">linearid</span>: <span class="hljs-built_in">string</span> }&gt;<span class="hljs-string">`
  &amp;.ant-btn-variant-outlined:not(:disabled):not(.ant-btn-disabled) {
    --ant-button-default-hover-bg: transparent;
    background: transparent;
  }
  width: 100%;
  height: 100%;
  background: transparent;
  border: none;
  padding: 0;
  cursor: <span class="hljs-subst">${({ disabled }) =&gt; (disabled ? <span class="hljs-string">'not-allowed'</span> : <span class="hljs-string">'pointer'</span>)}</span>;
  outline: none;

  background-clip: text;
  color: transparent;
  fill: transparent;
  background-image: <span class="hljs-subst">${({ linear }) =&gt; linear}</span>;
  p {
    color: #9980df;
  }
  svg {
    fill: url(#<span class="hljs-subst">${({ linearid }) =&gt; linearid}</span>);
  }
`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">SvgButtonWrapper</span> = styled.<span class="hljs-property">div</span>&lt;{ size?: <span class="hljs-title class_">SizeType</span> }&gt;<span class="hljs-string">`
  --ant-control-height: 32px;
  --font-size: 14px;

  &amp;.button-size-large {
    --ant-control-height: 40px;
    --font-size: 16px;
  }
  &amp;.button-size-small {
    --ant-control-height: 24px;
    --font-size: 12px;
  }

  display: inline-block;
  position: relative;
  height: var(--ant-control-height);
  width: fit-content;

  &amp; &gt; svg {
    position: absolute;
    z-index: 0;
    pointer-events: none;

    &amp; &gt; rect {
      transition: fill 0.3s;
    }
  }

  &amp;[aria-disabled='false'] {
    &amp;:hover {
      &amp; &gt; svg &gt; rect:last-child {
        fill: transparent;
      }

      <span class="hljs-subst">${SvgButton}</span> {
        color: #000;
        background-clip: unset;
        background-image: unset;

        p {
          color: <span class="hljs-subst">${({ theme }) =&gt; theme.same}</span>;
        }

        svg {
          fill: <span class="hljs-subst">${({ theme }) =&gt; theme.same}</span>;
        }
      }
    }
  }
  &amp;[aria-disabled='true'] {
    opacity: 0.5;
  }
`</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">LinearButton</span>(<span class="hljs-params">{ linear, children, size, disabled, loading, ...buttonProps }: Props</span>) {
  <span class="hljs-keyword">const</span> colors = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span>
      linear.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/#(?:[a-f0-9]{3}|[a-f0-9]{6})\b|rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*(?:,\s*[\d.]+\s*)?\)/gi</span>) || [],
    [linear]
  );
  <span class="hljs-keyword">const</span> deg = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> linear.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/[0-9]deg/</span>)?.[<span class="hljs-number">0</span>] || <span class="hljs-string">''</span>, [linear]);

  <span class="hljs-keyword">const</span> linearId = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span>
      <span class="hljs-string">`<span class="hljs-subst">${v4({
        random: <span class="hljs-built_in">Uint8Array</span>.<span class="hljs-keyword">from</span>(linear)
      })}</span>`</span>,
    []
  );

  <span class="hljs-keyword">const</span> buttonRef = useRef&lt;<span class="hljs-title class_">HTMLButtonElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [contentSize, setContentSize] = useState&lt;{ <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> }&gt;(
    buttonRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">getBoundingClientRect</span>() || { <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">32</span> }
  );

  <span class="hljs-keyword">const</span> handle = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (buttonRef.<span class="hljs-property">current</span>) {
      <span class="hljs-title function_">setContentSize</span>(buttonRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>());
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">setTimeout</span>(handle, <span class="hljs-number">100</span>);
    }
  }, []);

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">handle</span>();
  }, [children, buttonProps.<span class="hljs-property">icon</span>]);

  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">// 使用svg做背景，按钮背景统一透明，避免比例影响、边框锯齿等问题</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SvgButtonWrapper</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">button-size-</span>${<span class="hljs-attr">size</span> || '<span class="hljs-attr">default</span>'}`} <span class="hljs-attr">aria-disabled</span>=<span class="hljs-string">{!!disabled}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">svg</span>
        <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
        <span class="hljs-attr">height</span>=<span class="hljs-string">"100%"</span>
        <span class="hljs-attr">viewBox</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">0</span> <span class="hljs-attr">0</span> ${<span class="hljs-attr">contentSize.width</span>} ${<span class="hljs-attr">contentSize.height</span>}`}
        <span class="hljs-attr">preserveAspectRatio</span>=<span class="hljs-string">"none"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">defs</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">LinearGradientComponent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{linearId}</span> <span class="hljs-attr">colors</span>=<span class="hljs-string">{[...colors]}</span> <span class="hljs-attr">direction</span>=<span class="hljs-string">{deg}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">defs</span>&gt;</span>

        {/* 背景边框 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">rect</span>
          <span class="hljs-attr">x</span>=<span class="hljs-string">"1"</span>
          <span class="hljs-attr">y</span>=<span class="hljs-string">"1"</span>
          <span class="hljs-attr">width</span>=<span class="hljs-string">{Math.max(contentSize.width</span> <span class="hljs-attr">-</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">height</span>=<span class="hljs-string">{Math.max(contentSize.height</span> <span class="hljs-attr">-</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">rx</span>=<span class="hljs-string">{Math.max(contentSize.height</span> / <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">ry</span>=<span class="hljs-string">{Math.max(contentSize.height</span> / <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">fill</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">url</span>(#${<span class="hljs-attr">linearId</span>})`}
          <span class="hljs-attr">stroke</span>=<span class="hljs-string">"none"</span>
        /&gt;</span>

        {/* 内部填充 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">rect</span>
          <span class="hljs-attr">x</span>=<span class="hljs-string">"2"</span>
          <span class="hljs-attr">y</span>=<span class="hljs-string">"2"</span>
          <span class="hljs-attr">width</span>=<span class="hljs-string">{Math.max(contentSize.width</span> <span class="hljs-attr">-</span> <span class="hljs-attr">4</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">height</span>=<span class="hljs-string">{Math.max(contentSize.height</span> <span class="hljs-attr">-</span> <span class="hljs-attr">4</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">rx</span>=<span class="hljs-string">{Math.max(contentSize.height</span> / <span class="hljs-attr">2</span> <span class="hljs-attr">-</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">ry</span>=<span class="hljs-string">{Math.max(contentSize.height</span> / <span class="hljs-attr">2</span> <span class="hljs-attr">-</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">0</span>)}
          <span class="hljs-attr">fill</span>=<span class="hljs-string">{disabled</span> ? '#<span class="hljs-attr">050505</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">000</span>'}
          <span class="hljs-attr">stroke</span>=<span class="hljs-string">"none"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>

      {/* 实际可点击的按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">SvgButton</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{buttonRef}</span>
        <span class="hljs-attr">linear</span>=<span class="hljs-string">{linear}</span>
        <span class="hljs-attr">size</span>=<span class="hljs-string">{size}</span>
        <span class="hljs-attr">linearid</span>=<span class="hljs-string">{linearId}</span>
        <span class="hljs-attr">disabled</span>=<span class="hljs-string">{!!disabled</span> || !!<span class="hljs-attr">loading</span>}
        {<span class="hljs-attr">...buttonProps</span>}
      &gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">SvgButton</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">SvgButtonWrapper</span>&gt;</span></span>
  );
}
</code></pre>
<p>按钮加渐变边框主要需要解决两个问题</p>
<ol>
<li>不同分辨率下会出现边框消失或视觉不等的情况</li>
<li>如何给文本和svg图标加上渐变</li>
</ol>
<p>所以也尝试过使用border或者渐变背景的方案，最后还是选择svg渲染背景，使用的图标也需要是svg的，hover后的效果根据主题来随便改。容器的大小是通过contentSize计算更新上去的，border默认就是2px，代码上可以写的再整洁一点</p>
<h2 data-id="heading-0">效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2939afa1b0794eaf8ca57d3998f8eb1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZGQ5ZGQ5ZGQ5ZGQ5ZGi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765017143&amp;x-signature=1pEO0cxOUjwU8%2B80xQJc0s%2FUf8U%3D" alt="output.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 中 nextTick 的魔法：为什么它能拿到更新后的 DOM？]]></title>    <link>https://juejin.cn/post/7577693903017967642</link>    <guid>https://juejin.cn/post/7577693903017967642</guid>    <pubDate>2025-11-29T10:37:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903017967642" data-draft-id="7577693903017951258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 中 nextTick 的魔法：为什么它能拿到更新后的 DOM？"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-29T10:37:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 中 nextTick 的魔法：为什么它能拿到更新后的 DOM？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T10:37:22.000Z" title="Sat Nov 29 2025 10:37:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 中 nextTick 的魔法：为什么它能拿到更新后的 DOM？</h2>
<blockquote>
<p>深入理解 Vue 异步更新机制的核心</p>
</blockquote>
<h3 data-id="heading-1">一个令人困惑的场景</h3>
<p>很多 Vue 开发者都遇到过这样的场景：在改变数据后，立即访问 DOM，却发现拿到的是旧的值。这时候，我们就会用到 <code>nextTick</code> 这个神奇的解决方案。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 改变数据</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">'Hello Vue'</span>

<span class="hljs-comment">// 此时 DOM 还没有更新</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-property">textContent</span>) <span class="hljs-comment">// 旧内容</span>

<span class="hljs-comment">// 使用 nextTick 获取更新后的 DOM</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-property">textContent</span>) <span class="hljs-comment">// 'Hello Vue'</span>
})
</code></pre>
<p>那么，<code>nextTick</code> 到底是如何工作的？为什么它能够确保我们在 DOM 更新后再执行回调？今天，我们就来彻底揭开 <code>nextTick</code> 的神秘面纱。</p>
<h3 data-id="heading-2">nextTick 的核心作用</h3>
<p><code>nextTick</code> 是 Vue 提供的一个异步方法，它的主要作用是：</p>
<p><strong>将回调函数延迟到下次 DOM 更新循环之后执行</strong></p>
<p>在 Vue 中，数据变化时，DOM 更新是异步的。Vue 会开启一个队列，并缓冲在同一事件循环中发生的所有数据变更。这样可以避免不必要的计算和 DOM 操作。</p>
<h3 data-id="heading-3">源码解析：nextTick 的实现</h3>
<p>让我们深入到 Vue 的源码中，看看 <code>nextTick</code> 到底是如何实现的。</p>
<h4 data-id="heading-4">1. 核心变量定义</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 回调队列</span>
<span class="hljs-keyword">const</span> callbacks = []
<span class="hljs-comment">// 标记是否已经有 pending 的 Promise</span>
<span class="hljs-keyword">let</span> pending = <span class="hljs-literal">false</span>
<span class="hljs-comment">// 当前是否正在执行回调</span>
<span class="hljs-keyword">let</span> flushing = <span class="hljs-literal">false</span>
<span class="hljs-comment">// 回调执行的位置索引</span>
<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-5">2. nextTick 函数主体</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">nextTick</span>(<span class="hljs-params">cb?: <span class="hljs-built_in">Function</span>, ctx?: <span class="hljs-built_in">Object</span></span>) {
  <span class="hljs-keyword">let</span> _resolve
  <span class="hljs-comment">// 将回调函数包装后推入回调队列</span>
  callbacks.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (cb) {
      <span class="hljs-keyword">try</span> {
        cb.<span class="hljs-title function_">call</span>(ctx)
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-title function_">handleError</span>(e, ctx, <span class="hljs-string">'nextTick'</span>)
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_resolve) {
      <span class="hljs-title function_">_resolve</span>(ctx)
    }
  })
  
  <span class="hljs-comment">// 如果当前没有 pending 的 Promise，就创建一次</span>
  <span class="hljs-keyword">if</span> (!pending) {
    pending = <span class="hljs-literal">true</span>
    <span class="hljs-comment">// 执行异步延迟器</span>
    <span class="hljs-title function_">timerFunc</span>()
  }
  
  <span class="hljs-comment">// 如果没有提供回调且支持 Promise，返回一个 Promise</span>
  <span class="hljs-keyword">if</span> (!cb &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Promise</span> !== <span class="hljs-string">'undefined'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      _resolve = resolve
    })
  }
}
</code></pre>
<h4 data-id="heading-6">3. timerFunc：异步延迟器的实现</h4>
<p>这是 <code>nextTick</code> 最核心的部分，Vue 会按照以下优先级选择异步方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> timerFunc

<span class="hljs-comment">// 优先级：Promise &gt; MutationObserver &gt; setImmediate &gt; setTimeout</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Promise</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-title function_">isNative</span>(<span class="hljs-title class_">Promise</span>)) {
  <span class="hljs-comment">// 情况1：支持 Promise</span>
  <span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()
  timerFunc = <span class="hljs-function">() =&gt;</span> {
    p.<span class="hljs-title function_">then</span>(flushCallbacks)
    <span class="hljs-comment">// 在一些有问题的 UIWebView 中，Promise.then 不会完全触发</span>
    <span class="hljs-comment">// 所以需要额外的 setTimeout 来强制刷新</span>
    <span class="hljs-keyword">if</span> (isIOS) <span class="hljs-built_in">setTimeout</span>(noop)
  }
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isIE &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MutationObserver</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; (
  <span class="hljs-title function_">isNative</span>(<span class="hljs-title class_">MutationObserver</span>) ||
  <span class="hljs-title class_">MutationObserver</span>.<span class="hljs-title function_">toString</span>() === <span class="hljs-string">'[object MutationObserverConstructor]'</span>
)) {
  <span class="hljs-comment">// 情况2：支持 MutationObserver</span>
  <span class="hljs-keyword">let</span> counter = <span class="hljs-number">1</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(flushCallbacks)
  <span class="hljs-keyword">const</span> textNode = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-title class_">String</span>(counter))
  observer.<span class="hljs-title function_">observe</span>(textNode, {
    <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>
  })
  timerFunc = <span class="hljs-function">() =&gt;</span> {
    counter = (counter + <span class="hljs-number">1</span>) % <span class="hljs-number">2</span>
    textNode.<span class="hljs-property">data</span> = <span class="hljs-title class_">String</span>(counter)
  }
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> setImmediate !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-title function_">isNative</span>(setImmediate)) {
  <span class="hljs-comment">// 情况3：支持 setImmediate</span>
  timerFunc = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setImmediate</span>(flushCallbacks)
  }
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 情况4：降级到 setTimeout</span>
  timerFunc = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(flushCallbacks, <span class="hljs-number">0</span>)
  }
}
</code></pre>
<h4 data-id="heading-7">4. flushCallbacks：执行回调队列</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushCallbacks</span>(<span class="hljs-params"/>) {
  flushing = <span class="hljs-literal">true</span>
  pending = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">const</span> copies = callbacks.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>)
  callbacks.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
  index = <span class="hljs-number">0</span>
  
  <span class="hljs-comment">// 执行所有回调</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; copies.<span class="hljs-property">length</span>; i++) {
    index = i
    copies[i]()
  }
  
  flushing = <span class="hljs-literal">false</span>
  index = <span class="hljs-number">0</span>
}
</code></pre>
<h3 data-id="heading-8">完整流程图</h3>
<p>让我们通过流程图来直观理解 <code>nextTick</code> 的完整工作流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[调用 nextTick] --&gt; B[回调函数推入 callbacks 队列]
    B --&gt; C{是否有 pending 的 timerFunc?}
    C --&gt;|否| D[设置 pending = true]
    D --&gt; E[执行 timerFunc]
    E --&gt; F{选择异步方案}
    F --&gt;|优先级1| G[Promise.resolve.then]
    F --&gt;|优先级2| H[MutationObserver]
    F --&gt;|优先级3| I[setImmediate]
    F --&gt;|优先级4| J[setTimeout]
    G --&gt; K[异步任务完成]
    H --&gt; K
    I --&gt; K
    J --&gt; K
    K --&gt; L[执行 flushCallbacks]
    L --&gt; M[遍历执行所有回调]
    M --&gt; N[重置状态]
    C --&gt;|是| O[等待现有 timerFunc 触发]
</code></pre>
<h3 data-id="heading-9">Vue 的异步更新队列</h3>
<p>要真正理解 <code>nextTick</code>，我们还需要了解 Vue 的异步更新队列机制。</p>
<h4 data-id="heading-10">Watcher 与更新队列</h4>
<p>当数据发生变化时，Vue 不会立即更新 DOM，而是将需要更新的 Watcher 放入一个队列中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简化版的更新队列实现</span>
<span class="hljs-keyword">const</span> queue = []
<span class="hljs-keyword">let</span> has = {}
<span class="hljs-keyword">let</span> waiting = <span class="hljs-literal">false</span>
<span class="hljs-keyword">let</span> flushing = <span class="hljs-literal">false</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">queueWatcher</span>(<span class="hljs-params">watcher</span>) {
  <span class="hljs-keyword">const</span> id = watcher.<span class="hljs-property">id</span>
  <span class="hljs-comment">// 避免重复添加</span>
  <span class="hljs-keyword">if</span> (has[id] == <span class="hljs-literal">null</span>) {
    has[id] = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> (!flushing) {
      queue.<span class="hljs-title function_">push</span>(watcher)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 如果已经在刷新，按 id 排序插入</span>
      <span class="hljs-keyword">let</span> i = queue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
      <span class="hljs-keyword">while</span> (i &gt; index &amp;&amp; queue[i].<span class="hljs-property">id</span> &gt; watcher.<span class="hljs-property">id</span>) {
        i--
      }
      queue.<span class="hljs-title function_">splice</span>(i + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, watcher)
    }
    
    <span class="hljs-comment">// 开启下一次的异步更新</span>
    <span class="hljs-keyword">if</span> (!waiting) {
      waiting = <span class="hljs-literal">true</span>
      <span class="hljs-title function_">nextTick</span>(flushSchedulerQueue)
    }
  }
}
</code></pre>
<h4 data-id="heading-11">刷新调度队列</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushSchedulerQueue</span>(<span class="hljs-params"/>) {
  flushing = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">let</span> watcher, id
  
  <span class="hljs-comment">// 队列排序，确保：</span>
  <span class="hljs-comment">// 1. 组件更新顺序为父到子</span>
  <span class="hljs-comment">// 2. 用户 watcher 在渲染 watcher 之前</span>
  <span class="hljs-comment">// 3. 如果一个组件在父组件的 watcher 期间被销毁，它的 watcher 可以被跳过</span>
  queue.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">id</span> - b.<span class="hljs-property">id</span>)
  
  <span class="hljs-comment">// 不要缓存队列长度，因为可能会有新的 watcher 加入</span>
  <span class="hljs-keyword">for</span> (index = <span class="hljs-number">0</span>; index &lt; queue.<span class="hljs-property">length</span>; index++) {
    watcher = queue[index]
    <span class="hljs-keyword">if</span> (watcher.<span class="hljs-property">before</span>) {
      watcher.<span class="hljs-title function_">before</span>()
    }
    id = watcher.<span class="hljs-property">id</span>
    has[id] = <span class="hljs-literal">null</span>
    <span class="hljs-comment">// 执行更新</span>
    watcher.<span class="hljs-title function_">run</span>()
  }
  
  <span class="hljs-comment">// 重置状态</span>
  <span class="hljs-title function_">resetSchedulerState</span>()
}
</code></pre>
<h3 data-id="heading-12">实际应用场景</h3>
<h4 data-id="heading-13">场景 1：获取更新后的 DOM</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">list</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">addItem</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'d'</span>)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'li'</span>).<span class="hljs-property">length</span>) <span class="hljs-comment">// 3，还是旧的</span>
      
      <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'li'</span>).<span class="hljs-property">length</span>) <span class="hljs-comment">// 4，更新后的</span>
      })
    }
  }
}
</code></pre>
<h4 data-id="heading-14">场景 2：在 created 钩子中操作 DOM</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// DOM 还没有被创建</span>
    <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 现在可以安全地操作 DOM 了</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'button'</span>).<span class="hljs-title function_">focus</span>()
    })
  }
}
</code></pre>
<h4 data-id="heading-15">场景 3：与 Promise 结合使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateData</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = <span class="hljs-string">'Updated'</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-number">10</span>
  
  <span class="hljs-comment">// 等待所有 DOM 更新完成</span>
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
  
  <span class="hljs-comment">// 现在可以执行依赖于更新后 DOM 的操作</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateLayout</span>()
}
</code></pre>
<h3 data-id="heading-16">性能优化考虑</h3>
<p>Vue 使用异步更新队列有重要的性能优势：</p>
<ol>
<li><strong>批量更新</strong>：同一事件循环内的所有数据变更会被批量处理</li>
<li><strong>避免重复计算</strong>：相同的 Watcher 只会被推入队列一次</li>
<li><strong>优化渲染</strong>：减少不必要的 DOM 操作</li>
</ol>
<h3 data-id="heading-17">常见问题解答</h3>
<h4 data-id="heading-18">Q: nextTick 和 setTimeout 有什么区别？</h4>
<p>A: 虽然 <code>nextTick</code> 在降级情况下会使用 <code>setTimeout</code>，但它们有本质区别：</p>
<ul>
<li><code>nextTick</code> 会尝试使用微任务（Promise、MutationObserver），而 <code>setTimeout</code> 是宏任务</li>
<li>微任务在当前事件循环结束时执行，宏任务在下一个事件循环开始执行</li>
<li><code>nextTick</code> 能确保在 DOM 更新后立即执行，而 <code>setTimeout</code> 可能会有额外的延迟</li>
</ul>
<h4 data-id="heading-19">Q: 为什么有时候需要连续调用多个 nextTick？</h4>
<p>A: 在某些复杂场景下，可能需要确保某些操作在特定的 DOM 更新之后执行：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">this</span>.<span class="hljs-property">data1</span> = <span class="hljs-string">'first'</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 第一次更新后执行</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">data2</span> = <span class="hljs-string">'second'</span>
  <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 第二次更新后执行</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data3</span> = <span class="hljs-string">'third'</span>
  })
})
</code></pre>
<h4 data-id="heading-20">Q: nextTick 会返回 Promise 吗？</h4>
<p>A: 是的，当不传入回调函数时，<code>nextTick</code> 会返回一个 Promise：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 两种写法是等价的</span>
<span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 操作 DOM</span>
})

<span class="hljs-comment">// 或者</span>
<span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$nextTick()
<span class="hljs-comment">// 操作 DOM</span>
</code></pre>
<h3 data-id="heading-21">总结</h3>
<p>通过本文的深入分析，我们可以看到 <code>nextTick</code> 的实现体现了 Vue 在性能优化上的深思熟虑：</p>
<ol>
<li><strong>异步更新</strong>：通过队列机制批量处理数据变更</li>
<li><strong>优先级策略</strong>：智能选择最优的异步方案</li>
<li><strong>错误处理</strong>：完善的异常捕获机制</li>
<li><strong>兼容性</strong>：优雅的降级方案</li>
</ol>
<p>理解 <code>nextTick</code> 的工作原理，不仅可以帮助我们更好地使用 Vue，还能让我们对 JavaScript 的异步机制有更深入的认识。</p>
<p>希望这篇文章能帮助你彻底掌握 Vue 中 <code>nextTick</code> 的魔法！如果你有任何问题或想法，欢迎在评论区留言讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter 封装一个 tab]]></title>    <link>https://juejin.cn/post/7577705544874737702</link>    <guid>https://juejin.cn/post/7577705544874737702</guid>    <pubDate>2025-11-29T13:16:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544874737702" data-draft-id="7577675494067748890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter 封装一个 tab"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-29T13:16:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="名字被你们想完了"/> <meta itemprop="url" content="https://juejin.cn/user/3065854916834782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter 封装一个 tab
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3065854916834782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    名字被你们想完了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T13:16:02.000Z" title="Sat Nov 29 2025 13:16:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">flutter 封装一个 tab</h2>
<p>flutter版本：3.35.4</p>
<p>demo 链接：</p>
<pre><code class="hljs language-text" lang="text">https://github.com/yhtqw/FrontEndDemo/tree/main/flutter_demo/lib/pages/customize_tab
</code></pre>
<p>在flutter中使用 <strong>TabBar</strong> + <strong>TabBarView</strong> 就能很好的实现，为了使用的便捷性和通用性，所以进行一些封装。</p>
<p>需要看最终效果和最终的封装代码，直接拉到最底部即可～</p>
<p>简单的使用一下，对一些基本的结构限制做出解释。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page19</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> Page19({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;Page19&gt; createState() =&gt; _Page19State();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-comment">// 必须，使用TabController作为桥梁连接TabBar和TabBarView</span>
  <span class="hljs-keyword">late</span> TabController _controller;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();

    _controller = TabController(
      length: <span class="hljs-number">2</span>,
      vsync: <span class="hljs-keyword">this</span>,
      initialIndex: <span class="hljs-number">0</span>,
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          TabBar(
            controller: _controller,
            <span class="hljs-comment">// tab bar选项，数量得和下面一致</span>
            tabs: <span class="hljs-keyword">const</span> [
              Text(<span class="hljs-string">'1111'</span>),
              Text(<span class="hljs-string">'2222'</span>),
            ],
          ),

          <span class="hljs-comment">// 使用TabBarView时，必须指定容器的限制范围。</span>
          <span class="hljs-comment">// 这里直接撑满剩余空间</span>
          Expanded(
            child: TabBarView(
              controller: _controller,
              <span class="hljs-comment">// tab bar每个选项对应的tab页面，数量得很上面一致</span>
              children: <span class="hljs-keyword">const</span> [
                Text(<span class="hljs-string">'1'</span>),
                Text(<span class="hljs-string">'2'</span>),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50031a2165d44806b5471b3b8643d2a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=T0P8YJ7e0LRaVQlKhhiozBn7X4Y%3D" alt="image01.gif" loading="lazy"/></p>
<p>简单的场景当然也可以不使用TabController，但需要DefaultTabController包裹，这样无需手动创建控制器自动就关联上了，大致使用如下：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ... 其他省略</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> DefaultTabController(
      <span class="hljs-comment">// 数量得和下面的一致</span>
      length: <span class="hljs-number">2</span>,
      child: Scaffold(
        backgroundColor: Colors.white,
        body: Column(
          children: [
            SizedBox(height: <span class="hljs-number">100</span>,),

            TabBar(
              tabs: [
                Text(<span class="hljs-string">'1111'</span>),
                Text(<span class="hljs-string">'2222'</span>),
              ],
            ),

            Expanded(
              child: TabBarView(
                children: [
                  Text(<span class="hljs-string">'1'</span>),
                  Text(<span class="hljs-string">'2'</span>),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<p>效果和上面一致。</p>
<p>从上面可以看出 flutter 已经实现了滑动的动画效果，我们只需要对结构样式进行封装，下面我们去体验一下其他的属性，为封装做准备。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> TabController _controller;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();

    _controller = TabController(
      length: <span class="hljs-number">3</span>,
      vsync: <span class="hljs-keyword">this</span>,
      initialIndex: <span class="hljs-number">0</span>,
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          TabBar(
            controller: _controller,
            <span class="hljs-comment">// 注意：选项文本颜色就通过下面设置，不通过选项自身的TextStyle来设置</span>
            <span class="hljs-comment">// tab bar 选项文本选中时的颜色</span>
            labelColor: Colors.blue,
            <span class="hljs-comment">// tab bar 选项文本未选中时的颜色</span>
            unselectedLabelColor: Colors.black,

            <span class="hljs-comment">// 选中指示器相关的属性</span>
            <span class="hljs-comment">// 设置tab bar选中指示器的颜色</span>
            indicatorColor: Colors.blue,
            <span class="hljs-comment">// 设置tab bar选中指示器的大小，默认和选项的文本宽度一致。</span>
            <span class="hljs-comment">// 这里设置的指示器宽度和选项的宽度一致</span>
            <span class="hljs-comment">// 这样设置后切换tab的时候蠕虫蠕动效果就没有了</span>
            indicatorSize: TabBarIndicatorSize.tab,
            <span class="hljs-comment">// 设置tab bar选中指示器的高度</span>
            indicatorWeight: <span class="hljs-number">10</span>,

            <span class="hljs-comment">// 移除tab bar选项点击时的高亮和水波纹反馈效果</span>
            overlayColor: WidgetStateProperty.all(Colors.transparent),

            <span class="hljs-comment">// 设置tab bar选项的内边距</span>
            <span class="hljs-comment">// 在indicatorSize设置为label的时候再设置这个值比较好</span>
            <span class="hljs-comment">// labelPadding: const EdgeInsets.symmetric(horizontal: 40),</span>

            <span class="hljs-comment">// 设置tab bar底部的那条分割线高度，也可以通过dividerColor设置其颜色</span>
            dividerHeight: <span class="hljs-number">0</span>,

            tabs: [<span class="hljs-string">'1111'</span>,<span class="hljs-string">'2222'</span>,<span class="hljs-string">'3333'</span>].map(
              (item) =&gt; Text(item,),
            ).toList(),
          ),

          Expanded(
            child: TabBarView(
              controller: _controller,
              children: [<span class="hljs-string">'1'</span>,<span class="hljs-string">'2'</span>,<span class="hljs-string">'3'</span>].map(
                (item) =&gt;Text(item,),
              ).toList(),
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30010bd94254286a3a2d5a6e2fb49f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=ep3BgnoUvvK%2BrNJnaLWLM0HDV7s%3D" alt="image02.gif" loading="lazy"/></p>
<p>可以看到，上面我们使用了许多选中和选中指示器的效果，也是在tab bar个数少的时候展示的效果，接下来我们加几个再看看效果:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d8a9a581f443c69365902764fa98f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=OzjFbSfy73XO6vFCingRBzAPAIc%3D" alt="image03.png" loading="lazy"/></p>
<p>可以看到选项被挤压，这个时候我们就可以通过 TabBar 的 isScrollable 属性来设置是否可以滚动：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
TabBar(
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">// 设置tab bar选项个数过多超过限制的宽度的时候，是否允许滚动</span>
  isScrollable: <span class="hljs-keyword">true</span>,
),
<span class="hljs-comment">// 其他省略...</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/838a738323dd4a898eb05331a6c59609~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=OpdvpUWYfX7Mdxq%2F5iBSmyDqA9A%3D" alt="image04.gif" loading="lazy"/></p>
<p>我们又发现了允许滚动后，第一个的排列距离容器左边有一些边距，如果想让选项在最左边开始显示，就需要设置tabAlignment属性：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
TabBar(
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">// 设置tab bar选项个数过多超过限制的宽度的时候，是否允许滚动</span>
  isScrollable: <span class="hljs-keyword">true</span>,
  <span class="hljs-comment">// 设置tab bar选项的显示位置</span>
  tabAlignment: TabAlignment.start,
),
<span class="hljs-comment">// 其他省略...</span>
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5afb91717faa4e978089609c827a9fef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=jF6bLnpOi3WkIEholl3%2FmUhdngg%3D" alt="image05.png" loading="lazy"/></p>
<p>关于TabBar的一些常用的属性就体验得差不多了，如果我们要设置整个TabBar容器的样式，例如背景色，圆角，高度等属性时，就需要对TabBar进行包裹，使用外层包裹部件来设置样式:</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
Container(
  height: <span class="hljs-number">60</span>,
  padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="hljs-number">20</span>),
  decoration: <span class="hljs-keyword">const</span> BoxDecoration(
    color: Colors.grey,
    borderRadius: BorderRadius.only(
      topLeft: Radius.circular(<span class="hljs-number">20</span>),
      topRight: Radius.circular(<span class="hljs-number">20</span>),
    )
  ),
  child: TabBar(
    <span class="hljs-comment">// 其他省略...</span>
  ),
),
<span class="hljs-comment">// 其他省略...</span>
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a14d7f7dbcb946f4b90fdfcec8b32bae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=3N%2FoHk1O04zGpgHDHThr0XcQTz8%3D" alt="image06.png" loading="lazy"/></p>
<p>这下关于TabBar的样式就设置的差不多了，那么关于TabBarView的样式就自行通过传染的children部件自行封装实现。</p>
<p>我们从上面的效果中可以看到tab bar选中样式通过属性去自定义可能有些不好看，如果我们想用让指示器为整个背景，并且设置部分样式效果，我们就需要自定义TabBar的indicator属性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75d0f3521a74919a42f664408d36aaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=NWUPd2znWKiJIyo%2BW55GSxol9fg%3D" alt="image07.png" loading="lazy"/></p>
<p>可以看到，如果我们要自定义指示器，需要实现Decoration，并且如果设置了indicator属性，则会忽略indicatorColor和indicatorWeight属性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b0bb7558be4cd782a08cac86bf7718~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=YOmW%2BW3hnuYY8ozNVfdjNzYp6rM%3D" alt="image08.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8a206d57c874b1598894764b8f0d33c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=grBuGTVkVj6cCFC4YJckeUzkKMs%3D" alt="image09.png" loading="lazy"/></p>
<p>为了实现自定义的indicator，我们需要继承Decoration去实现绘制的方法，接下来我们就去实现一个简单的圆角矩形样式（这里不深入展开绘制相关的知识，后面有时间再单独写绘制相关的知识）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomizeTabIndicator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Decoration</span> </span>{
  <span class="hljs-keyword">const</span> CustomizeTabIndicator({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.color,
    <span class="hljs-keyword">this</span>.radius = BorderRadius.zero,
  });

  <span class="hljs-comment">/// <span class="markdown">指示器颜色</span></span>
  <span class="hljs-keyword">final</span> Color color;
  <span class="hljs-comment">/// <span class="markdown">指示器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadius radius;

  <span class="hljs-comment">// 需要重写绘制方法</span>
  <span class="hljs-meta">@override</span>
  BoxPainter createBoxPainter([VoidCallback? onChanged]) =&gt;
      _RoundedPainter(<span class="hljs-keyword">this</span>, onChanged);
}

<span class="hljs-comment">// 自定义绘制方法</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_RoundedPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BoxPainter</span> </span>{
  _RoundedPainter(<span class="hljs-keyword">this</span>.decoration, VoidCallback? onChanged) : <span class="hljs-keyword">super</span>(onChanged);

  <span class="hljs-keyword">final</span> CustomizeTabIndicator decoration;

  <span class="hljs-comment">// 重写绘制的方法，这个方法会传给我们绘制区域的信息</span>
  <span class="hljs-comment">// 我们利用这些信息就可以实现自定义的绘制</span>
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> paint(Canvas canvas, Offset offset, ImageConfiguration configuration) {
    <span class="hljs-comment">// 获取绘制区域的大小，整个变换过程中都会更新</span>
    <span class="hljs-built_in">double</span> width = configuration.size!.width;
    <span class="hljs-built_in">double</span> height = configuration.size!.height;
    <span class="hljs-comment">// 获取绘制区域的偏移量（距离最边上的距离）</span>
    Offset baseOffset = Offset(offset.dx, offset.dy,);

    <span class="hljs-comment">// 设置要绘制的圆角矩形</span>
    <span class="hljs-keyword">final</span> RRect indicatorRRect = _buildRRect(
      baseOffset,
      width,
      height,
    );
    <span class="hljs-comment">// 设置画笔属性</span>
    <span class="hljs-keyword">final</span> Paint paint = Paint()
      ..color = decoration.color
      ..style = PaintingStyle.fill;

    <span class="hljs-comment">// 绘制圆角矩形</span>
    canvas.drawRRect(indicatorRRect, paint);
  }

  <span class="hljs-comment">/// <span class="markdown">绘制圆角指示器</span></span>
  RRect _buildRRect(
    Offset offset,
    <span class="hljs-built_in">double</span> width,
    <span class="hljs-built_in">double</span> height,
  ) {
    <span class="hljs-keyword">return</span> RRect.fromRectAndCorners(
      <span class="hljs-comment">// 圆角矩形的绘制中心</span>
      Rect.fromCenter(
        center: Offset(
          offset.dx + width / <span class="hljs-number">2</span>,
          offset.dy + height / <span class="hljs-number">2</span>,
        ),
        width: width,
        height: height,
      ),
      topLeft: decoration.radius.topLeft,
      topRight: decoration.radius.topRight,
      bottomRight: decoration.radius.bottomRight,
      bottomLeft: decoration.radius.bottomLeft,
    );
  }
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-comment">// 其他省略...</span>
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          Container(
            height: <span class="hljs-number">60</span>,
            width: <span class="hljs-built_in">double</span>.infinity,
            padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="hljs-number">20</span>),
            decoration: <span class="hljs-keyword">const</span> BoxDecoration(
              color: Colors.grey,
              borderRadius: BorderRadius.only(
                topLeft: Radius.circular(<span class="hljs-number">20</span>),
                topRight: Radius.circular(<span class="hljs-number">20</span>),
              )
            ),
            child: TabBar(
              controller: _controller,
              <span class="hljs-comment">// 注意：选项文本颜色就通过下面设置，不通过选项自身的TextStyle来设置</span>
              <span class="hljs-comment">// tab bar 选项文本选中时的颜色</span>
              labelColor: Colors.blue,
              <span class="hljs-comment">// tab bar 选项文本未选中时的颜色</span>
              unselectedLabelColor: Colors.black,

              <span class="hljs-comment">// 选中指示器相关的属性</span>
              <span class="hljs-comment">// 自定义指示器</span>
              indicator: <span class="hljs-keyword">const</span> CustomizeTabIndicator(
                color: Colors.amber,
              ),

              <span class="hljs-comment">// 设置tab bar选项个数过多超过限制的宽度的时候，是否允许滚动</span>
              isScrollable: <span class="hljs-keyword">true</span>,
              <span class="hljs-comment">// 设置tab bar选项的显示位置</span>
              tabAlignment: TabAlignment.start,

              <span class="hljs-comment">// 设置tab bar选项的内边距</span>
              <span class="hljs-comment">// 在indicatorSize设置为label的时候再设置这个值比较好</span>
              labelPadding: <span class="hljs-keyword">const</span> EdgeInsets.only(right: <span class="hljs-number">30</span>),

              <span class="hljs-comment">// 设置tab bar底部的那条分割线高度，也可以通过dividerColor设置其颜色</span>
              dividerHeight: <span class="hljs-number">0</span>,

              tabs: [<span class="hljs-string">'1111'</span>,<span class="hljs-string">'2222'</span>,<span class="hljs-string">'3333'</span>,<span class="hljs-string">'4444'</span>,<span class="hljs-string">'5555'</span>,<span class="hljs-string">'6666'</span>,<span class="hljs-string">'7777'</span>].map(
                (item) =&gt; Padding(
                  padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                    horizontal: <span class="hljs-number">20</span>,
                    vertical: <span class="hljs-number">5</span>,
                  ),
                  child: Text(item,)
                ),
              ).toList(),
            ),
          ),
          <span class="hljs-comment">// 其他省略...</span>
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddfd3a0615824abc83bb3c2404cb528e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=BxsX8KyUfQrZMCn6ULtGI2JaA3g%3D" alt="image10.gif" loading="lazy"/></p>
<p>通过上面的一系列的使用，接下来封装就很明了了，属性主要分为：</p>
<ul>
<li>tab bar相关
<ul>
<li>tab bar容器的属性</li>
<li>tab bar相关属性</li>
</ul>
</li>
<li>tab views相关</li>
<li>其他属性</li>
</ul>
<p>接下来基于上述的开始封装：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'customize_tab_indicator.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">抽取一些默认的属性</span></span>
BorderRadius ctDefaultIndicatorBorderRadius = BorderRadius.circular(<span class="hljs-number">10</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomizeTab</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> CustomizeTab({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">this</span>.tabBarHeight = kToolbarHeight,
    <span class="hljs-keyword">this</span>.tabBarBackgroundColor,
    <span class="hljs-keyword">this</span>.tabBarPadding,
    <span class="hljs-keyword">this</span>.tabBarBorderRadius,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tabs,
    <span class="hljs-keyword">this</span>.unselectedColor,
    <span class="hljs-keyword">this</span>.selectedColor,
    <span class="hljs-keyword">this</span>.tabBarOptionMargin = <span class="hljs-keyword">const</span> EdgeInsets.only(right: <span class="hljs-number">10</span>),
    <span class="hljs-keyword">this</span>.tabBarOptionPadding = EdgeInsets.zero,
    <span class="hljs-keyword">this</span>.indicatorColor = Colors.blue,
    <span class="hljs-keyword">this</span>.indicatorBorderRadius,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tabViews,
    <span class="hljs-keyword">this</span>.initialIndex,
    <span class="hljs-keyword">this</span>.onChangeTabIndex,
  });

  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的高度，默认为AppBar工具栏组件的高度</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> tabBarHeight;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的背景颜色</span></span>
  <span class="hljs-keyword">final</span> Color? tabBarBackgroundColor;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的内边距</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry? tabBarPadding;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadiusGeometry? tabBarBorderRadius;
  <span class="hljs-comment">/// <span class="markdown">tab 选项</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; tabs;
  <span class="hljs-comment">/// <span class="markdown">tab 选项未选中时的颜色</span></span>
  <span class="hljs-keyword">final</span> Color? unselectedColor;
  <span class="hljs-comment">/// <span class="markdown">tab 选项选中时的颜色</span></span>
  <span class="hljs-keyword">final</span> Color? selectedColor;
  <span class="hljs-comment">/// <span class="markdown">tab bar 选项每项的margin</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarOptionMargin;
  <span class="hljs-comment">/// <span class="markdown">tab bar 选项每项的padding(因为大概率每项的padding是一致的，所以进行抽取)</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarOptionPadding;
  <span class="hljs-comment">/// <span class="markdown">指示器的颜色</span></span>
  <span class="hljs-keyword">final</span> Color indicatorColor;
  <span class="hljs-comment">/// <span class="markdown">指示器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadius? indicatorBorderRadius;
  <span class="hljs-comment">/// <span class="markdown">tab 页面</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; tabViews;
  <span class="hljs-comment">/// <span class="markdown">初始化显示tab的索引</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> initialIndex;
  <span class="hljs-comment">/// <span class="markdown">当tab索引发生改变时的回调函数</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">int</span>)? onChangeTabIndex;

  <span class="hljs-meta">@override</span>
  State&lt;CustomizeTab&gt; createState() =&gt; _CustomizeTabState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CustomizeTabState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CustomizeTab</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> TabController _controller;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();

    _controller = TabController(
      length: widget.tabs.length,
      vsync: <span class="hljs-keyword">this</span>,
      initialIndex: widget.initialIndex ?? <span class="hljs-number">0</span>,
    )..addListener(() {
      <span class="hljs-comment">// indexIsChanging主要作用就是标识TabController是否正处于索引切换过程中。</span>
      <span class="hljs-comment">// 点击切换，在执行动画期间为true，用户手势操作结束后且动画完成为false</span>
      <span class="hljs-comment">// 滑动切换为false</span>
      <span class="hljs-comment">// 使用indexIsChanging来判断当前tab变化是否完成，完成了就执行回调</span>
      <span class="hljs-keyword">if</span> (!_controller.indexIsChanging) {
        widget.onChangeTabIndex?.call(_controller.index);
      }
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-comment">/// <span class="markdown">对每个tab加内边距</span></span>
  Widget _buildTab(Widget tab) {
    <span class="hljs-keyword">return</span> Padding(
      padding: widget.tabBarOptionPadding,
      child: tab,
    );
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 通过父容器的约束动态构建子部件</span>
    <span class="hljs-keyword">return</span> LayoutBuilder(
      builder: (_, BoxConstraints boxConstraints) =&gt; Column(
        children: [
          Container(
            width: <span class="hljs-built_in">double</span>.infinity,
            height: widget.tabBarHeight,
            padding: widget.tabBarPadding,
            decoration: BoxDecoration(
              color: widget.tabBarBackgroundColor,
              borderRadius: widget.tabBarBorderRadius,
            ),
            child: TabBar(
              controller: _controller,
              indicator: CustomizeTabIndicator(
                color: widget.indicatorColor,
                radius: widget.indicatorBorderRadius ??
                    ctDefaultIndicatorBorderRadius,
              ),
              isScrollable: <span class="hljs-keyword">true</span>,
              dividerHeight: <span class="hljs-number">0</span>,
              labelPadding: widget.tabBarOptionMargin,
              tabAlignment: TabAlignment.start,
              unselectedLabelColor: widget.unselectedColor,
              labelColor: widget.selectedColor,
              tabs: widget.tabs.map((tab) =&gt; _buildTab(tab)).toList(),
            ),
          ),

          <span class="hljs-comment">// 因为TabBarView必须要约束</span>
          <span class="hljs-comment">// 所以定义它的高度就为外界的约束高度减去TabBar的高度</span>
          SizedBox(
            width: <span class="hljs-built_in">double</span>.infinity,
            height: boxConstraints.maxHeight - widget.tabBarHeight,
            child: TabBarView(
              controller: _controller,
              children: widget.tabViews,
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'../widgets/page19/customize_tab.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page19</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> Page19({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;Page19&gt; createState() =&gt; _Page19State();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  Widget _buildTab(<span class="hljs-built_in">String</span> txt) {
    <span class="hljs-keyword">return</span> Text(
      txt,
      style: <span class="hljs-keyword">const</span> TextStyle(
        fontSize: <span class="hljs-number">14</span>,
      ),
    );
  }

  Widget _buildTabView(<span class="hljs-built_in">String</span> txt) {
    <span class="hljs-keyword">return</span> Container(
      padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">20</span>),
      color: Colors.grey,
      child: Text(txt),
    );
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          Expanded(
            child: CustomizeTab(
              tabBarBackgroundColor: Colors.amber,
              tabBarPadding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                horizontal: <span class="hljs-number">20</span>,
              ),
              tabBarBorderRadius: <span class="hljs-keyword">const</span> BorderRadius.only(
                topRight: Radius.circular(<span class="hljs-number">20</span>),
                topLeft: Radius.circular(<span class="hljs-number">20</span>),
              ),
              unselectedColor: Colors.black,
              selectedColor: Colors.white,
              tabBarOptionPadding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                horizontal: <span class="hljs-number">15</span>,
                vertical: <span class="hljs-number">5</span>,
              ),
              indicatorColor: Colors.orange,
              onChangeTabIndex: (index) {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前的索引为：<span class="hljs-subst">$index</span>'</span>);
              },
              tabs: [<span class="hljs-string">'tab1'</span>, <span class="hljs-string">'tab2'</span>, <span class="hljs-string">'tab3'</span>, <span class="hljs-string">'tab4'</span>, <span class="hljs-string">'tab5'</span>].map(
                (item) =&gt; _buildTab(item),
              ).toList(),
              tabViews: [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>].map(
                (item) =&gt; _buildTabView(item),
              ).toList(),
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df879ac790674caea03a33b87e0da7ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=gaJEOeEof9fVgxYdkG1sfh7r8BE%3D" alt="image11.gif" loading="lazy"/></p>
<p>上面我们就完成了一个简单的tab封装，但是目前还不算很通用，例如我想要TabBar在下面，TabView在上面，这个就不能直接使用了，得更改内部代码，所以继续继续封装，允许用户自定义方向。</p>
<p>接下来进行TabBar位置的分析：</p>
<ol>
<li>在顶部（top）</li>
</ol>
<p>不用具体分析了，因为上面就是基于在顶部封装的。</p>
<ol start="2">
<li>在底部（bottom）</li>
</ol>
<p>与在顶部相比，只是结构倒序一下就行了。</p>
<ol start="3">
<li>在左边（left）</li>
</ol>
<p>在左边，结构从上下结构（Column）变成左右结构（Row），而且TabBar不支持直接转成上下结构，所以只有另辟蹊径。从左右结构变成上下结构旋转90度也能实现效果，基于此在做调整，让整个容器旋转90度的时候，TabBar的选项则也被旋转了90度，从视觉效果上看就是倒置的，大致效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e67a5415682147f2b6d2ada5c8918a42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=YeJyVPhIZ4DHskotFiWT1AJIQVI%3D" alt="image12.png" loading="lazy"/></p>
<p>所以我们对每个子项向反方向旋转90度即可还原显示。</p>
<p>对于TabView，原先的交互方式为左右滑动切换，现在变成左右结构了，那么交互方式得从左右变成上下，TabView不支持直接变成上下滑动，所以有两种方式解决：</p>
<p>一种是使用PageView，这个天生就支持上下滑动，但是如果使用这个，得维护PageController，同步TabBar的切换，有兴趣的可自行试一下。</p>
<p>另一种方式依然是旋转，我们将其旋转90度后，自然而然滑动手势从左右变成了上下，不过需要注意的是，子项依然要反方向旋转90度还原。</p>
<ol start="4">
<li>在右边（right）</li>
</ol>
<p>与在左边相比，只是结构倒序一下就行了。</p>
<p>简单的分析了如何实现，那么接下来就开始编写：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'customize_tab_indicator.dart'</span>;

<span class="hljs-comment">/// <span class="markdown">tab bar 位置的枚举</span></span>
<span class="hljs-keyword">enum</span> TabBarPosition { top, bottom, left, right }

<span class="hljs-comment">/// <span class="markdown">抽取一些默认的属性</span></span>
BorderRadius ctDefaultIndicatorBorderRadius = BorderRadius.circular(<span class="hljs-number">10</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomizeTab</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> CustomizeTab({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">this</span>.tabBarHeight = kToolbarHeight,
    <span class="hljs-keyword">this</span>.tabBarBackgroundColor,
    <span class="hljs-keyword">this</span>.tabBarPadding = EdgeInsets.zero,
    <span class="hljs-keyword">this</span>.tabBarBorderRadius,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tabs,
    <span class="hljs-keyword">this</span>.unselectedColor,
    <span class="hljs-keyword">this</span>.selectedColor,
    <span class="hljs-keyword">this</span>.tabBarOptionMargin = <span class="hljs-keyword">const</span> EdgeInsets.only(right: <span class="hljs-number">10</span>),
    <span class="hljs-keyword">this</span>.tabBarOptionPadding = EdgeInsets.zero,
    <span class="hljs-keyword">this</span>.indicatorColor = Colors.blue,
    <span class="hljs-keyword">this</span>.indicatorBorderRadius,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.tabViews,
    <span class="hljs-keyword">this</span>.initialIndex,
    <span class="hljs-keyword">this</span>.onChangeTabIndex,
    <span class="hljs-keyword">this</span>.position = TabBarPosition.top,
  });

  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的高度，默认为AppBar工具栏组件的高度</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> tabBarHeight;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的背景颜色</span></span>
  <span class="hljs-keyword">final</span> Color? tabBarBackgroundColor;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的内边距</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarPadding;
  <span class="hljs-comment">/// <span class="markdown">tab bar 容器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadiusGeometry? tabBarBorderRadius;
  <span class="hljs-comment">/// <span class="markdown">tab 选项</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; tabs;
  <span class="hljs-comment">/// <span class="markdown">tab 选项未选中时的颜色</span></span>
  <span class="hljs-keyword">final</span> Color? unselectedColor;
  <span class="hljs-comment">/// <span class="markdown">tab 选项选中时的颜色</span></span>
  <span class="hljs-keyword">final</span> Color? selectedColor;
  <span class="hljs-comment">/// <span class="markdown">tab bar 选项每项的margin</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarOptionMargin;
  <span class="hljs-comment">/// <span class="markdown">tab bar 选项每项的padding(因为大概率每项的padding是一致的，所以进行抽取)</span></span>
  <span class="hljs-keyword">final</span> EdgeInsetsGeometry tabBarOptionPadding;
  <span class="hljs-comment">/// <span class="markdown">指示器的颜色</span></span>
  <span class="hljs-keyword">final</span> Color indicatorColor;
  <span class="hljs-comment">/// <span class="markdown">指示器的圆角属性</span></span>
  <span class="hljs-keyword">final</span> BorderRadius? indicatorBorderRadius;
  <span class="hljs-comment">/// <span class="markdown">tab 页面</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; tabViews;
  <span class="hljs-comment">/// <span class="markdown">初始化显示tab的索引</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> initialIndex;
  <span class="hljs-comment">/// <span class="markdown">当tab索引发生改变时的回调函数</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">int</span>)? onChangeTabIndex;
  <span class="hljs-comment">/// <span class="markdown">tab bar所在位置，默认为top</span></span>
  <span class="hljs-keyword">final</span> TabBarPosition position;

  <span class="hljs-meta">@override</span>
  State&lt;CustomizeTab&gt; createState() =&gt; _CustomizeTabState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_CustomizeTabState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">CustomizeTab</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> TabController _controller;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();

    _controller = TabController(
      length: widget.tabs.length,
      vsync: <span class="hljs-keyword">this</span>,
      initialIndex: widget.initialIndex ?? <span class="hljs-number">0</span>,
    )..addListener(() {
      <span class="hljs-comment">// indexIsChanging主要作用就是标识TabController是否正处于索引切换过程中。</span>
      <span class="hljs-comment">// 点击切换，在执行动画期间为true，用户手势操作结束后且动画完成为false</span>
      <span class="hljs-comment">// 滑动切换为false</span>
      <span class="hljs-comment">// 使用indexIsChanging来判断当前tab变化是否完成，完成了就执行回调</span>
      <span class="hljs-keyword">if</span> (!_controller.indexIsChanging) {
        widget.onChangeTabIndex?.call(_controller.index);
      }
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-comment">/// <span class="markdown">对每个tab加内边距</span></span>
  Widget _buildTabOption(Widget tab) {
    <span class="hljs-keyword">final</span> Widget tabOption = Padding(
      padding: widget.tabBarOptionPadding,
      child: tab,
    );

    <span class="hljs-comment">// 如果是left和right，因为外层的TabBar容器旋转了90度</span>
    <span class="hljs-comment">// 那Tab选项就旋转-90度还原，达到视觉的统一</span>
    <span class="hljs-keyword">if</span> (widget.position == TabBarPosition.left || widget.position == TabBarPosition.right) {
      <span class="hljs-keyword">return</span> RotatedBox(
        quarterTurns: <span class="hljs-number">-1</span>,
        child: tabOption,
      );
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> tabOption;
    }
  }

  <span class="hljs-comment">/// <span class="markdown">构建TabBar</span></span>
  Widget _buildTabBar() {
    <span class="hljs-keyword">final</span> Widget tabBar = Container(
      width: <span class="hljs-built_in">double</span>.infinity,
      height: widget.tabBarHeight,
      padding: widget.tabBarPadding,
      decoration: BoxDecoration(
        color: widget.tabBarBackgroundColor,
        borderRadius: widget.tabBarBorderRadius,
      ),
      child: TabBar(
        controller: _controller,
        indicator: CustomizeTabIndicator(
          color: widget.indicatorColor,
          radius: widget.indicatorBorderRadius
              ?? ctDefaultIndicatorBorderRadius,
        ),
        isScrollable: <span class="hljs-keyword">true</span>,
        dividerHeight: <span class="hljs-number">0</span>,
        labelPadding: widget.tabBarOptionMargin,
        tabAlignment: TabAlignment.start,
        unselectedLabelColor: widget.unselectedColor,
        labelColor: widget.selectedColor,
        tabs: widget.tabs.map((tab) =&gt; _buildTabOption(tab)).toList(),
      ),
    );

    <span class="hljs-keyword">if</span> (widget.position == TabBarPosition.left || widget.position == TabBarPosition.right) {
      <span class="hljs-comment">// 如果是left和right，则旋转90度，</span>
      <span class="hljs-keyword">return</span> RotatedBox(
        quarterTurns: <span class="hljs-number">1</span>,
        child: tabBar,
      );
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> tabBar;
    }
  }

  Widget _buildTabView(BoxConstraints boxConstraints) {
    <span class="hljs-keyword">final</span> EdgeInsets tabBarPadding = widget.tabBarPadding.resolve(TextDirection.ltr);

    <span class="hljs-keyword">return</span> widget.position == TabBarPosition.top || widget.position == TabBarPosition.bottom ? SizedBox(
      width: <span class="hljs-built_in">double</span>.infinity,
      height: boxConstraints.maxHeight -
          widget.tabBarHeight -
          tabBarPadding.top -
          tabBarPadding.bottom,
      child: TabBarView(
        controller: _controller,
        children: widget.tabViews,
      ),
    ) : SizedBox(
      <span class="hljs-comment">// 如果是left或者right，则宽高设置交换，并且将TabBarView旋转90度</span>
      width: boxConstraints.maxWidth -
          widget.tabBarHeight -
          tabBarPadding.top -
          tabBarPadding.bottom,
      height: <span class="hljs-built_in">double</span>.infinity,
      child: RotatedBox(
        quarterTurns: <span class="hljs-number">1</span>,
        child: TabBarView(
          controller: _controller,
          <span class="hljs-comment">// 因为TabBarView旋转了90度，对应的Tab项要旋转-90度还原</span>
          children: widget.tabViews.map((tabView) =&gt; RotatedBox(
            quarterTurns: <span class="hljs-number">-1</span>,
            child: tabView,
          )).toList(),
        ),
      ),
    );
  }

  <span class="hljs-comment">/// <span class="markdown">构建tab</span></span>
  Widget _buildTab(BoxConstraints boxConstraints) {
    <span class="hljs-built_in">List</span>&lt;Widget&gt; children = [
      _buildTabBar(),
      _buildTabView(boxConstraints),
    ];

    <span class="hljs-comment">// 如果是bottom和right，则渲染的结构会倒置</span>
    <span class="hljs-keyword">if</span> (widget.position == TabBarPosition.bottom
        || widget.position == TabBarPosition.right) {
      children = children.reversed.toList();
    }

    <span class="hljs-comment">// 如果是top或者bottom，则是上下结构</span>
    <span class="hljs-comment">// 如果是left或者right，则是左右结构</span>
    <span class="hljs-keyword">return</span> widget.position == TabBarPosition.top || widget.position == TabBarPosition.bottom
        ? Column(
          children: children,
        )
        : Row(
          children: children,
        );
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 通过父容器的约束动态构建子部件</span>
    <span class="hljs-keyword">return</span> LayoutBuilder(
      builder: (_, BoxConstraints boxConstraints) =&gt; _buildTab(boxConstraints),
    );
  }
}
</code></pre>
<p>完成编码后就开始测试使用：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'../widgets/page19/customize_tab.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Page19</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> Page19({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;Page19&gt; createState() =&gt; _Page19State();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_Page19State</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">Page19</span>&gt; <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-comment">// 用于动态切换tab bar的位置</span>
  TabBarPosition _tabBarPosition = TabBarPosition.top;

  <span class="hljs-comment">/// <span class="markdown">构建tab项</span></span>
  Widget _buildTab(<span class="hljs-built_in">String</span> txt) {
    <span class="hljs-keyword">return</span> Text(
      txt,
      style: <span class="hljs-keyword">const</span> TextStyle(
        fontSize: <span class="hljs-number">14</span>,
      ),
    );
  }

  <span class="hljs-comment">/// <span class="markdown">构建tab view</span></span>
  Widget _buildTabView(<span class="hljs-built_in">String</span> txt) {
    <span class="hljs-keyword">return</span> Container(
      padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">20</span>),
      color: Colors.grey,
      child: Column(
        children: [
          Container(
            width: <span class="hljs-built_in">double</span>.infinity,
            height: <span class="hljs-number">60</span>,
            decoration: BoxDecoration(
              color: Colors.amber,
              borderRadius: BorderRadius.circular(<span class="hljs-number">20</span>),
            ),
            alignment: Alignment.center,
            child: Text(txt),
          )
        ],
      ),
    );
  }

  <span class="hljs-comment">/// <span class="markdown">改变tab bar的位置</span></span>
  <span class="hljs-keyword">void</span> _onChangePosition(TabBarPosition tabBarPosition) {
    setState(() {
      _tabBarPosition = tabBarPosition;
    });
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      backgroundColor: Colors.white,
      body: Column(
        children: [
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">100</span>,),

          Expanded(
            child: CustomizeTab(
              tabBarHeight: <span class="hljs-number">100</span>,
              tabBarBackgroundColor: Colors.amber,
              tabBarPadding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                horizontal: <span class="hljs-number">20</span>,
              ),
              unselectedColor: Colors.black,
              selectedColor: Colors.white,
              tabBarOptionPadding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(
                horizontal: <span class="hljs-number">15</span>,
                vertical: <span class="hljs-number">5</span>,
              ),
              indicatorColor: Colors.orange,
              position: _tabBarPosition,
              onChangeTabIndex: (index) {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前的索引为：<span class="hljs-subst">$index</span>'</span>);
              },
              tabs: [<span class="hljs-string">'tab1'</span>, <span class="hljs-string">'tab2'</span>, <span class="hljs-string">'tab3'</span>, <span class="hljs-string">'tab4'</span>, <span class="hljs-string">'tab5'</span>].map(
                (item) =&gt; _buildTab(item),
              ).toList(),
              tabViews: [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>, <span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>].map(
                (item) =&gt; _buildTabView(item),
              ).toList(),
            ),
          ),

          Container(
            height: <span class="hljs-number">200</span>,
            color: Colors.black,
            padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="hljs-number">20</span>),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                ElevatedButton(
                  onPressed: () =&gt; _onChangePosition(TabBarPosition.left),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'左'</span>),
                ),
                ElevatedButton(
                  onPressed: () =&gt; _onChangePosition(TabBarPosition.right),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'右'</span>),
                ),
                ElevatedButton(
                  onPressed: () =&gt; _onChangePosition(TabBarPosition.top),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'上'</span>),
                ),
                ElevatedButton(
                  onPressed: () =&gt; _onChangePosition(TabBarPosition.bottom),
                  child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'下'</span>),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/361ac0f9e57142edbf19456dddcae10f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765026962&amp;x-signature=qADqaxBzNYF1%2By%2FuM051d7dcj%2B4%3D" alt="image13.gif" loading="lazy"/></p>
<p>至此我们就简单封装了一个tab，极大的方便了使用。</p>
<p>感兴趣的也可以关注我的微信公众号【前端学习小营地】，不定时会分享一些小功能～</p>
<p>文章到此就结束了，感谢阅读，拜拜～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 组件的组合模式之道 (Composition Pattern)]]></title>    <link>https://juejin.cn/post/7577675494067896346</link>    <guid>https://juejin.cn/post/7577675494067896346</guid>    <pubDate>2025-11-29T14:46:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494067896346" data-draft-id="7577693903018360858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 组件的组合模式之道 (Composition Pattern)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-29T14:46:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iMonster"/> <meta itemprop="url" content="https://juejin.cn/user/1785262612681832"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 组件的组合模式之道 (Composition Pattern)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1785262612681832/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iMonster
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:46:32.000Z" title="Sat Nov 29 2025 14:46:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于 React Universe Conf 2025 中 Fernando Rojo 的演讲《Composition is all you need》，以下是关于如何使用**组合模式（Composition Pattern）**重构复杂 React 组件的教程和代码总结。</p>
<hr/>
<h2 data-id="heading-0">React 组件的组合模式之道 (Composition Pattern)</h2>
<h3 data-id="heading-1">1. 核心问题：单体组件的陷阱 (The Monolith Trap)</h3>
<p>在开发初期，我们通常创建一个简单的组件（如 <code>Composer</code> 输入框）。随着需求增加（支持多态、编辑模式、转发模式等），我们往往通过添加 <code>Boolean</code> 属性来控制功能。</p>
<p><strong>反模式代码示例：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ 典型的“单体”组件，充满条件判断</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Composer</span>(<span class="hljs-params">{ 
  onSubmit, 
  isThread, 
  isEditingMessage, 
  initialText, 
  onCancel 
}</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"composer"</span>&gt;</span>
      {/* 只有非编辑模式才支持拖拽 */}
      {!isEditingMessage &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">DropZone</span> /&gt;</span>}
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">{initialText}</span> /&gt;</span>
      
      {/* 线程模式下的额外选项 */}
      {isThread &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Checkbox</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Also send to channel"</span> /&gt;</span>}
      
      <span class="hljs-tag">&lt;<span class="hljs-name">Footer</span>&gt;</span>
        {/* 只有非编辑模式才显示附件按钮 */}
        {!isEditingMessage &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">AttachmentButton</span> /&gt;</span>}
        
        {/* 提交按钮逻辑复杂 */}
        {isEditingMessage ? (
           <span class="hljs-tag">&lt;&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onCancel}</span>&gt;</span>Cancel<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
             <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onSubmit}</span>&gt;</span>Save<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
           <span class="hljs-tag">&lt;/&gt;</span>
        ) : (
           <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onSubmit}</span>&gt;</span>Send<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Footer</span>&gt;</span></span>
    &lt;/div&gt;
  );
}
</code></pre>
<p><strong>缺点：</strong> 代码难以维护，条件渲染（Ternary Hell）泛滥，且容易出现不可能的状态组合。</p>
<hr/>
<h3 data-id="heading-2">2. 解决方案：组合模式 (Composition)</h3>
<p>与其通过属性（Props）告诉组件<strong>做什么</strong>，不如通过子组件（Children）直接<strong>构建</strong>组件。这种方式类似于 <code>Radix UI</code> 的设计理念。</p>
<p>我们将大组件拆分为多个小的、职责单一的子组件，并通过 <code>Context</code> 共享状态。</p>
<h4 data-id="heading-3">基础架构代码</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 1. 创建 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ComposerContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-comment">// 2. Provider 组件：管理状态和对外接口</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ComposerProvider</span> = (<span class="hljs-params">{ children, state, actions, meta }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ComposerContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">state</span>, <span class="hljs-attr">actions</span>, <span class="hljs-attr">meta</span> }}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ComposerContext.Provider</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 3. 子组件：消费 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ComposerInput</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { state, actions } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ComposerContext</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{state.text}</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> actions.update(e.target.value)} 
    /&gt;</span>
  );
};

<span class="hljs-comment">// ... 其他子组件 (Composer.Header, Composer.Footer, etc.)</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">3. 实战重构：构建不同的 Composer</h3>
<p>通过组合，我们可以在不修改内部逻辑的情况下，构建出完全不同的 UI 变体。</p>
<h4 data-id="heading-5">场景 A：基础频道输入框 (Channel Composer)</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChannelComposer</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用自定义 Hook 获取全局频道逻辑</span>
  <span class="hljs-keyword">const</span> { state, actions } = <span class="hljs-title function_">useChannelLogic</span>(); 

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Composer.Provider</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{state}</span> <span class="hljs-attr">actions</span>=<span class="hljs-string">{actions}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Composer.DropZone</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Frame</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Header</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Input</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Footer</span>&gt;</span>
          {/* 使用封装好的通用操作组 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.CommonActions</span> /&gt;</span> 
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.SubmitButton</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Footer</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Frame</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Provider</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-6">场景 B：编辑消息输入框 (Edit Message Composer)</h4>
<p><strong>需求差异：</strong></p>
<ol>
<li>不需要拖拽上传 (<code>DropZone</code>)。</li>
<li>底部按钮不同（取消/保存）。</li>
<li>某些操作按钮不可见（如附件）。</li>
</ol>
<p><strong>组合实现：</strong>
我们只需要<strong>不渲染</strong>不需要的组件，并<strong>替换</strong>底部的按钮即可，无需任何 <code>Boolean</code> 属性。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">EditMessageComposer</span>(<span class="hljs-params">{ messageId, initialText, onCancel }</span>) {
  <span class="hljs-keyword">const</span> { state, actions } = <span class="hljs-title function_">useEditMessageLogic</span>(messageId, initialText);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Composer.Provider</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{state}</span> <span class="hljs-attr">actions</span>=<span class="hljs-string">{actions}</span>&gt;</span>
      {/* 移除 DropZone */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Frame</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Header</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Input</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Footer</span>&gt;</span>
          {/* 手动列出需要的 Action，而不是用通用的 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.FormatText</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Emoji</span> /&gt;</span>
          
          {/* 自定义底部按钮布局 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex gap-2"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onCancel}</span>&gt;</span>Cancel<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{actions.submit}</span>&gt;</span>Save<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Footer</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Frame</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Provider</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h3 data-id="heading-7">4. 进阶技巧：状态提升与解耦 (Lift Your State)</h3>
<p>这是该演讲最核心的观点。<strong>状态管理应该与 UI 组件解耦。</strong></p>
<p><code>Composer</code> 的 UI 组件（Input, Footer 等）不应该知道状态是来自于 <code>useState</code>（本地状态）还是 <code>useGlobalStore</code>（全局同步状态）。它们只负责渲染 Provider 提供的数据。</p>
<h4 data-id="heading-8">场景 C：转发消息 (Forward Message)</h4>
<p><strong>复杂点：</strong></p>
<ol>
<li>这是一个模态框（Modal）。</li>
<li>提交按钮在 Composer <strong>外部</strong>（Modal 的 Footer）。</li>
<li>状态是临时的（Ephemeral），不需要同步到服务器。</li>
</ol>
<p><strong>代码实现：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ForwardMessageDialog</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 状态提升：在父组件控制状态</span>
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 定义符合 Provider 接口的 state 和 actions</span>
  <span class="hljs-keyword">const</span> state = { text };
  <span class="hljs-keyword">const</span> actions = { 
    <span class="hljs-attr">update</span>: setText, 
    <span class="hljs-attr">submit</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Forwarding:"</span>, text) 
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Dialog</span>&gt;</span>
      {/* 2. 将本地状态注入 Provider */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Provider</span> <span class="hljs-attr">state</span>=<span class="hljs-string">{state}</span> <span class="hljs-attr">actions</span>=<span class="hljs-string">{actions}</span> <span class="hljs-attr">meta</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">inputRef</span> }}&gt;</span>
        
        {/* UI 部分 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Frame</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Input</span> /&gt;</span> 
          <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Footer</span>&gt;</span>
             {/* 只有少量的操作按钮 */}
             <span class="hljs-tag">&lt;<span class="hljs-name">Composer.Emoji</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Footer</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Frame</span>&gt;</span>

        {/* 3. 外部按钮也可以消费同一个 Context */}
        <span class="hljs-tag">&lt;<span class="hljs-name">Dialog.Footer</span>&gt;</span>
           <span class="hljs-tag">&lt;<span class="hljs-name">CopyLinkButton</span> /&gt;</span>
           {/* 这个按钮在 Composer 外部，但能触发提交 */}
           <span class="hljs-tag">&lt;<span class="hljs-name">ForwardButton</span> /&gt;</span> 
        <span class="hljs-tag">&lt;/<span class="hljs-name">Dialog.Footer</span>&gt;</span>

      <span class="hljs-tag">&lt;/<span class="hljs-name">Composer.Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Dialog</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 外部按钮实现</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ForwardButton</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 因为被包在 Composer.Provider 内，依然可以访问 context</span>
  <span class="hljs-keyword">const</span> { actions } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ComposerContext</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{actions.submit}</span>&gt;</span>Forward<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-9">总结：为什么要这样做？</h3>
<ol>
<li><strong>消除“布尔地狱”：</strong> 不再需要传递 <code>isEditing={true}</code>、<code>isForwarding={true}</code> 并在组件深处做判断。需要什么功能，就渲染什么组件。</li>
<li><strong>状态灵活性：</strong> 同一套 UI 组件可以配合 <code>useState</code>（本地）、<code>Redux/Zustand</code>（全局）甚至 <code>Ref</code> 一起工作，只要通过 Provider 传入即可。</li>
<li><strong>可维护性：</strong> 当需要在“转发”功能中修改按钮样式时，你只需要修改 <code>ForwardMessageDialog</code>，完全不会影响到“频道聊天”的代码。</li>
<li><strong>AI 友好：</strong> 这种结构化、声明式的代码更容易被 AI 理解和生成，减少了 AI 产生幻觉（Hallucination）或逻辑错误的概率。</li>
</ol>
<p><strong>一句话总结：</strong>
不要把所有的逻辑塞进一个组件里。<strong>提升你的状态 (Lift your state)，组合你的内部组件 (Compose your internals)。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML5敲击乐 PART--1]]></title>    <link>https://juejin.cn/post/7577715145121644598</link>    <guid>https://juejin.cn/post/7577715145121644598</guid>    <pubDate>2025-11-29T15:53:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577715145121644598" data-draft-id="7576838095519580211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML5敲击乐 PART--1"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-29T15:53:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="izx888"/> <meta itemprop="url" content="https://juejin.cn/user/1241762540820323"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML5敲击乐 PART--1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1241762540820323/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    izx888
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:53:43.000Z" title="Sat Nov 29 2025 15:53:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HTML5 敲击乐：前端开发实战 PART-1 —— 用代码“弹奏”你的第一架网页钢琴</h2>
<p>在当今的 Web 开发世界中，前端不仅是用户与产品之间的桥梁，更是创意与技术融合的舞台。而作为前端三大基石——<strong>HTML、CSS 和 JavaScript</strong>——它们分别构建了网页的“骨骼”、“外貌”与“灵魂”。本文将以一个趣味十足的小项目 <strong>“HTML5 模拟钢琴”</strong> 为切入点，带你系统理解前端开发的核心逻辑，并掌握高效实现交互式应用的关键技巧。</p>
<hr/>
<h3 data-id="heading-1">一、前端三剑客：结构 × 样式 × 行为</h3>
<p>任何现代网页都离不开这三位“主角”的协同工作：</p>
<ul>
<li><strong>HTML（超文本标记语言）</strong> ：负责定义页面的<strong>结构与语义</strong>。<br/>
在模拟钢琴中，每个琴键都是一个 HTML 元素（如 <code>&lt;div&gt;</code> 或 <code>&lt;span&gt;</code>），共同组成完整的键盘布局。</li>
<li><strong>CSS（层叠样式表）</strong> ：掌控页面的<strong>视觉表现</strong>。<br/>
它让白键洁白、黑键深邃，还能通过 <code>:hover</code>、<code>:active</code> 等伪类添加点击反馈，甚至用 <code>transition</code> 实现平滑动画，赋予琴键“生命感”。</li>
<li><strong>JavaScript</strong>：驱动页面的<strong>交互行为</strong>。<br/>
它监听用户的点击或键盘输入，触发对应音符的播放，真正让这架“数字钢琴”发出声音——这才是“敲击乐”的核心！</li>
</ul>
<blockquote>
<p><strong>设计哲学</strong>：结构、样式、行为分离（Separation of Concerns）是现代前端开发的基本原则。清晰的职责划分，让代码更易维护、扩展和协作。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、HTML5 基础：从骨架搭建开始</h3>
<p>HTML5 是当前 Web 标准的主流版本，其标志性开头是：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
</code></pre>
<p>这一行声明告诉浏览器：“请以标准模式解析此文档”，避免因“怪异模式”（Quirks Mode）导致的渲染不一致问题。</p>
<p>使用 VS Code 等现代编辑器时，只需输入 <code>!</code> 并按 <code>Tab</code>，即可自动生成完整的 HTML5 模板，极大提升开发效率。</p>
<h4 data-id="heading-3">构建琴键结构</h4>
<p>在 <code>&lt;body&gt;</code> 中，我们用以下方式组织琴键：</p>
<ul>
<li>使用 <code>&lt;div class="piano"&gt;</code> 作为整个钢琴的容器；</li>
<li>内部嵌套多个 <code>&lt;div class="key white"&gt;</code> 和 <code>&lt;div class="key black"&gt;</code> 分别代表白键与黑键。</li>
</ul>
<blockquote>
<p><strong>小知识</strong>：</p>
<ul>
<li><code>&lt;div&gt;</code> 是<strong>块级元素</strong>，默认独占一行，可设置宽高，适合做布局容器；</li>
<li><code>&lt;span&gt;</code> 是<strong>行内元素</strong>，尺寸由内容决定，通常用于包裹文本。<br/>
理解二者区别，是掌握页面布局的第一步。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-4">三、CSS 样式：打造逼真的钢琴外观</h3>
<p>有了结构，下一步就是“化妆”——用 CSS 赋予琴键真实感：</p>
<ul>
<li>
<p><strong>基础样式</strong>：设置白键背景为白色、黑键为黑色，调整宽度、高度、边距；</p>
</li>
<li>
<p><strong>布局方案</strong>：推荐使用 <strong>Flexbox</strong>（而非过时的 <code>float</code>）实现琴键水平排列，代码简洁且响应友好；</p>
</li>
<li>
<p><strong>交互反馈</strong>：</p>
<ul>
<li><code>:hover</code>：鼠标悬停时轻微变色或加阴影；</li>
<li><code>:active</code>：点击瞬间产生“按下”效果；</li>
</ul>
</li>
<li>
<p><strong>增强质感</strong>：利用 <code>border-radius</code> 圆角、<code>box-shadow</code> 阴影、<code>transition</code> 过渡动画，让界面更具现代感。</p>
</li>
</ul>
<blockquote>
<p>示例片段：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.white</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">60px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.1s</span>;
}
<span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.white</span><span class="hljs-selector-pseudo">:active</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">2px</span>);
}
</code></pre>
</blockquote>
<hr/>
<h3 data-id="heading-5">四、JavaScript 行为：让钢琴真正“发声”</h3>
<p>这是项目最激动人心的部分——让点击变成音乐！</p>
<h4 data-id="heading-6">核心功能实现：</h4>
<ol>
<li>
<p><strong>事件监听</strong><br/>
为每个琴键绑定 <code>click</code> 事件，或监听全局 <code>keydown</code> 键盘事件（如 A/S/D 对应 Do/Re/Mi）。</p>
</li>
<li>
<p><strong>音频播放</strong><br/>
可选择两种方式：</p>
<ul>
<li><strong><code>&lt;audio&gt;</code> 标签预加载</strong>：简单直接，适合初学者；</li>
<li><strong>Web Audio API</strong>：更强大灵活，支持音效合成与精确控制（进阶方向）。</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong><br/>
避免快速连点导致声音重叠，可通过节流（throttle）或记录“正在播放”状态来优化体验。</p>
</li>
</ol>
<h4 data-id="heading-7">模块化思维</h4>
<p>将功能拆分为独立函数：</p>
<ul>
<li><code>createPiano()</code>：动态生成琴键；</li>
<li><code>playNote(note)</code>：播放指定音符；</li>
<li><code>bindEvents()</code>：统一绑定交互逻辑。</li>
</ul>
<p>这样不仅提升可读性，也为后续扩展（如添加录音、节奏训练等）打下基础。</p>
<hr/>
<h3 data-id="heading-8">五、提效利器：现代前端开发工具链</h3>
<p>高效开发离不开这些“神助攻”：</p>
<ul>
<li><strong>Emmet 语法</strong>：<br/>
输入 <code>div.piano&gt;div.key*8</code> + <code>Tab</code>，秒速生成 8 个琴键结构；</li>
<li><strong>Live Server（VS Code 插件）</strong> ：<br/>
启动本地服务器，保存即自动刷新浏览器，所见即所得，调试效率翻倍。</li>
</ul>
<hr/>
<h3 data-id="heading-9">六、面试高频考点回顾</h3>
<p>在技术面试中，以下概念常被考察：</p>





















<table><thead><tr><th>问题</th><th>答案要点</th></tr></thead><tbody><tr><td><code>&lt;!DOCTYPE html&gt;</code> 的作用？</td><td>声明 HTML5 文档类型，确保浏览器以标准模式渲染，避免兼容性问题。</td></tr><tr><td>HTML 文件的本质是什么？</td><td>一种结构化文本文档，浏览器将其解析为 DOM 树，供 JS 操作。</td></tr><tr><td>块级 vs 行内元素的区别？</td><td>块级独占一行、可设宽高；行内不换行、尺寸由内容决定。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">结语：从“敲代码”到“敲出旋律”</h3>
<p>通过“HTML5 模拟钢琴”这个小而美的项目，我们不仅实践了前端三剑客的协同开发流程，更体会到了<strong>用代码创造交互乐趣</strong>的魅力。从 <code>! + Tab</code> 快速搭建骨架，到 Emmet 提升编码速度，再到 Live Server 实现实时预览——现代前端开发已变得前所未有的高效与直观。</p>
<p>未来，随着 AI 与 Web 技术的深度融合，前端工程师的角色将更像一位“数字导演”：用技术编排用户体验，用创意传递情感价值。而这一切的起点，正是对 HTML5 的深刻理解与灵活运用。</p>
<blockquote>
<p><strong>动手试试吧！</strong><br/>
打开你的编辑器，敲下第一行代码，让浏览器为你奏响属于程序员的旋律 🎹✨</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openresty容器导出火焰图]]></title>    <link>https://juejin.cn/post/7577689171222708274</link>    <guid>https://juejin.cn/post/7577689171222708274</guid>    <pubDate>2025-11-29T15:28:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171222708274" data-draft-id="7577675494067372058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openresty容器导出火焰图"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T15:28:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风的归宿55"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779297303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openresty容器导出火焰图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779297303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风的归宿55
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:28:02.000Z" title="Sat Nov 29 2025 15:28:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们线上使用的是容器部署的openresty作为网关，用于处理请求转发以及使用lua代理处理部分请求。有时候会出现在流量没有增加特别多，但是openresty的cpu跑满的情况。为了能快速查出瓶颈并解决问题，我们增加了一些监控，用于排查各种情况导致的nginx cpu升高问题。这里主要介绍下 openresty导出cpu火焰图的方式，通过cpu火焰图可以快速发现占用cpu高的函数，从而协助快速定位问题以及进行性能优化。</p>
<p>目前网上的文档大部分都是在主机上导出火焰图的，这篇文章介绍了导出<strong>容器部署的openresty cpu火焰图</strong>的方式。</p>
<p>这里先给两张示例图，cpu火焰图分为nginx的c代码 和 处理业务的lua代码 两种。</p>
<p><strong>nginx火焰图</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ce1033bd3fe4aa5a3661e0e2283d7b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034882&amp;x-signature=ZvomBb9PZgmf6Mi81QnR%2FUvIJY4%3D" alt="1.jpg" loading="lazy"/></p>
<p><strong>lua火焰图</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50d1abdb2e444cce9c6d8d331a0ac434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034882&amp;x-signature=G8ebqv5LdweKcxWUIYuqxPy%2FYiI%3D" alt="2.jpg" loading="lazy"/></p>
<h3 data-id="heading-0">导出火焰图流程</h3>
<h5 data-id="heading-1">一、 准备工作</h5>
<h6 data-id="heading-2">1. 安装内核debug包</h6>
<p>在导出火焰图之前，有一些准备工作需要处理，首先是安装一些内核的debug信息包和开发包，这样在导出火焰图时程序才知道当前执行的函数名称，不然导出的火焰图只有一些很简略的信息，比如[unknown]，[libc-2.28.so] 这种。</p>
<p>安装时需要先根据系统版本找到对应的debug包，输入命令uname -a查询操作系统版本，这里以3.10.0-1160.76.1.el7.x86_64为例，首先找到下载对应内核debug包的网站，然后在机器上通过wget下载。</p>
<pre><code class="hljs language-bash" lang="bash">需要下载的包
kernel-debuginfo-3.10.0-1160.76.1.el7.x86_64.rpm
kernel-debuginfo-common-x86_64-3.10.0-1160.76.1.el7.x86_64.rpm
kernel-devel-3.10.0-1160.76.1.el7.x86_64.rpm

下载网站参考
http://debuginfo.centos.org/
https://buildlogs.centos.org/c7.2009.u.x86_64/kernel/

执行命令下载
wget http://debuginfo.centos.org/7/x86_64/kernel-debuginfo-3.10.0-1160.76.1.el7.x86_64.rpm 
wget http://debuginfo.centos.org/7/x86_64/kernel-debuginfo-common-x86_64-3.10.0-1160.76.1.el7.x86_64.rpm 
wget https://buildlogs.centos.org/c7.2009.u.x86_64/kernel/20220810161826/3.10.0-1160.76.1.el7.x86_64/kernel-devel-3.10.0-1160.76.1.el7.x86_64.rpm

安装
rpm -ivh *3.10.0-1160.76.1.el7.x86_64.rpm
</code></pre>
<h6 data-id="heading-3">2. 安装perf，stapxx和FlameGraph</h6>
<p>perf用于导出nginx c语言的cpu剖析信息，stapxx用于导出lua代码的cpu剖析信息，而FlameGraph则是用于将导出的cpu剖析信息转换为可阅读的svg格式的火焰图。</p>
<ul>
<li>perf：执行yum install -y perf命令即可。</li>
<li>stapxx： git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenresty%2Fstapxx.git" target="_blank" title="https://github.com/openresty/stapxx.git" ref="nofollow noopener noreferrer">github.com/openresty/s…</a></li>
<li>FlameGraph： git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbrendangregg%2FFlameGraph.git" target="_blank" title="https://github.com/brendangregg/FlameGraph.git" ref="nofollow noopener noreferrer">github.com/brendangreg…</a></li>
</ul>
<h6 data-id="heading-4">3. 制作导出lua火焰图的工具镜像</h6>
<p>这里制作一个镜像，用于导出容器内的openresty的cpu剖析信息。需要制作镜像的原因我在这里说明下。</p>
<p>之前尝试过几种方式导出容器内的openresty的cpu剖析信息，但是都不好处理。</p>
<ul>
<li>
<p>直接在主机上导出：因为导出lua的cpu剖析信息的话，需要有对应openresty版本的debug包，不然无法显示函数名称。因此尝试了在主机上编译并安装 容器中使用版本的openresty，然后加上debug信息，但是发现很难编译出和容器中完全一样的nginx二进制，导出cpu信息时会报错说 openresty的构建ID 不一致，并且主机和容器里面的虚拟主机系统有区别，会导致stapxx等程序有问题，比如在主机上运行stapxx时，需要修改对应stapxx/tapset/luajit.sxx的代码，改为32位的，但是容器中启动openresty的操作系统是64位的，就会报错。</p>
</li>
<li>
<p>编译一个包含主机内核的debug包的容器，在容器内运行stapxx导出lua的cpu剖析信息，但是导出的信息会变少甚至报错，因为docker中的操作系统其实不包含内核，因此在docker容器中安装主机的内核debug包会报错，但是安装容器内操作系统的debug包，又会找不到信息。因为实际上运行的操作系统内核只有主机上的内核。</p>
<p><strong>使用镜像的原因总结：</strong></p>
</li>
</ul>
<ol>
<li>在主机上很难打包出和容器中完全一致的openresty，因此直接使用线上的容器openresty制作一个镜像，解决openresty版本一致的问题。</li>
<li>需要安装openresty的debug信息包，因为使用容器openresty，这个就好处理了，直接在生成镜像时运行命令debuginfo-install -y openresty-1.21.4.1-1.el8.x86_64 安装</li>
<li>一个主机只有一个内核，就是主机上的操作系统版本的内核，但是容器内启动openresty的操作系统版本可能和主机的不一致，这个怎么处理。  其实不用管容器中的操作系统，因为导出cpu剖析信息时是需要从内核抓取函数代码的，而内核的版本是主机上操作系统的版本，因此在容器中挂载主机上的 /lib/modules，/sys/kernel/debug和/usr/src/kernels目录，这样stapxx就能找到执行函数对应的名称了。</li>
</ol>
<p>下面提供下打镜像的文件和流程。</p>
<pre><code class="hljs language-bash" lang="bash">dockerfile文件：
FROM nginx:10.9.0
RUN yum -y install systemtap &amp;&amp; debuginfo-install -y openresty-1.21.4.1-1.el8.x86_64 
ENTRYPOINT [<span class="hljs-string">"tail"</span>, <span class="hljs-string">"-f"</span>, <span class="hljs-string">"/dev/null"</span>]

生成镜像：
docker build -t openresty-debug:2.0.0 .

容器启动命令是：
docker run --<span class="hljs-built_in">rm</span> --name debug --pid=host -v /lib/modules:/lib/modules -v /root/debug:/root/debug -v /sys/kernel/debug:/sys/kernel/debug -v /usr/src/kernels:/usr/src/kernels --privileged --entrypoint /bin/bash  openresty-debug:2.0.0  -c <span class="hljs-string">"cd /root/debug/stapxx/ &amp;&amp; export PATH=\$PWD:\$PATH &amp;&amp; ./samples/lj-lua-stacks.sxx --skip-badvars --arg time=30 -x <span class="hljs-variable">$top_nginx_worker_pid</span> &gt; /root/debug/a.bt"</span>

其中/lib/modules，/sys/kernel/debug和/usr/src/kernels是把主机上的kernel debug包挂载进来
之前安装的stapxx，FlameGraph 我是放在/root/debug文件夹下，如果需要放在其他目录下，可以修改docker启动命令，将目录挂载到容器中。

--pid=host是让容器使用主机的pid空间，才能查到nginx的pid
</code></pre>
<h6 data-id="heading-5">4. 修改stapxx脚本的代码</h6>
<p>直接使用stapxx运行可能会出现如下所示的错误。</p>
<pre><code class="hljs language-rust" lang="rust">semantic error: unable to find member <span class="hljs-symbol">'gcptr32</span>' <span class="hljs-keyword">for</span> <span class="hljs-title class_">struct</span> <span class="hljs-title function_ invoke__">GCRef</span> (alternatives: gcptr64): operator '<span class="hljs-punctuation">-&gt;</span>' at :<span class="hljs-number">449</span>:<span class="hljs-number">100</span>
        source:     gco = @<span class="hljs-title function_ invoke__">cast</span>(pt, <span class="hljs-string">"GCproto"</span>, <span class="hljs-string">"/usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.0"</span>)<span class="hljs-punctuation">-&gt;</span>chunkname<span class="hljs-punctuation">-&gt;</span>gcptr32
        
或者

semantic error: unable to find member <span class="hljs-symbol">'fr</span>' <span class="hljs-keyword">for</span> <span class="hljs-title class_">union</span> <span class="hljs-title function_ invoke__">TValue</span> (alternatives: gcr, i, n, it, <span class="hljs-type">u32</span>, <span class="hljs-type">u64</span>, ftsz, it64): operator '<span class="hljs-punctuation">-&gt;</span>' at :<span class="hljs-number">75</span>:<span class="hljs-number">83</span>
        source:     @<span class="hljs-title function_ invoke__">cast</span>(@tv, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"/usr/local/openresty/luajit/lib/libluajit-5.1.so.2.1.0"</span>)<span class="hljs-punctuation">-&gt;</span>fr<span class="hljs-punctuation">-&gt;</span>tp<span class="hljs-punctuation">-&gt;</span>ftsz
</code></pre>
<p>这是因为openresty会因为系统不同而使用不同的宏编译，具体的openresty代码可以通过 bundule/LuaJIT-2.1-20220411/src/lj_obj.h和lj_arch.h文件进行查看，主要是openresty使用了和stapxx默认代码的不同位数的指针导致报错，这里只需要修改stapxx的 tapset/luajit.sxx的代码，根据报错的提示进行修改就可以了，比如将gcptr32批量替换成gcptr64。</p>
<pre><code class="hljs language-rust" lang="rust">可选，下载openresty代码查看：
wget https:<span class="hljs-comment">//openresty.org/download/openresty-1.21.4.1.tar.gz</span>
主要查看bundule/LuaJIT-<span class="hljs-number">2.1</span>-<span class="hljs-number">20220411</span>/src/lj_obj.h和lj_arch.h  ，需要对比stapxx中结构和openresty中的结果，然后进行修改

执行命令批量替换：
sed -i <span class="hljs-symbol">'s</span>/gcptr32/gcptr64/g' stapxx/tapset/luajit.sxx
sed -i <span class="hljs-symbol">'s</span>/<span class="hljs-punctuation">-&gt;</span>fr<span class="hljs-punctuation">-&gt;</span>tp<span class="hljs-punctuation">-&gt;</span>ftsz/<span class="hljs-punctuation">-&gt;</span>ftsz/g' stapxx/tapset/luajit.sxx
sed -i <span class="hljs-symbol">'s</span>/<span class="hljs-punctuation">-&gt;</span>fr<span class="hljs-punctuation">-&gt;</span>tp<span class="hljs-punctuation">-&gt;</span>pcr<span class="hljs-punctuation">-&gt;</span>ptr32/<span class="hljs-punctuation">-&gt;</span>ftsz/g' stapxx/tapset/luajit.sxx
sed -i <span class="hljs-symbol">'s</span>/<span class="hljs-punctuation">-&gt;</span>ptr32/<span class="hljs-punctuation">-&gt;</span>ptr64/g' stapxx/tapset/luajit.sxx
sed -i <span class="hljs-symbol">'s</span>/<span class="hljs-punctuation">-&gt;</span>fr<span class="hljs-punctuation">-&gt;</span>func/<span class="hljs-punctuation">-&gt;</span>gcr/g' stapxx/tapset/luajit.sxx
</code></pre>
<h5 data-id="heading-6">二、 导出openresty火焰图</h5>
<h6 data-id="heading-7">1. 导出nginx的c语言的火焰图</h6>
<p>这个比较简单，只要执行perf命令就可以导出，然后通过FlameGraph转成火焰图，其中$top_nginx_worker_pid变量是nginx worker的pid</p>
<pre><code class="hljs language-bash" lang="bash">perf record -F 99 -g -p <span class="hljs-string">"<span class="hljs-variable">$top_nginx_worker_pid</span>"</span> -- <span class="hljs-built_in">sleep</span> 30
perf script | ./FlameGraph/stackcollapse-perf.pl| ./FlameGraph/flamegraph.pl &gt; ./ngx_c_flame.svg
</code></pre>
<h6 data-id="heading-8">2. 导出lua的火焰图</h6>
<p>通过执行docker命令导出lua的cpu剖析信息，然后通过FlameGraph转成火焰图。</p>
<pre><code class="hljs language-bash" lang="bash">docker run --<span class="hljs-built_in">rm</span> --name debug --pid=host -v /lib/modules:/lib/modules -v /root/debug:/root/debug -v /sys/kernel/debug:/sys/kernel/debug -v /usr/src/kernels:/usr/src/kernels --privileged --entrypoint /bin/bash  openresty-debug:2.0.0  -c <span class="hljs-string">"cd /root/debug/stapxx/ &amp;&amp; export PATH=\$PWD:\$PATH &amp;&amp; ./samples/lj-lua-stacks.sxx --skip-badvars --arg time=30 -x <span class="hljs-variable">$top_nginx_worker_pid</span> &gt; /root/debug/a.bt"</span>

./FlameGraph/stackcollapse-stap.pl a.bt &gt; a.cbt
./FlameGraph/flamegraph.pl a.cbt  &gt; ngx_lua_flame.svg
</code></pre>
<h6 data-id="heading-9">3. 参考脚本</h6>
<p>最后贴一下整体的生成脚本，用于参考</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-function"><span class="hljs-title">get_top_cpu_nginx_worker_pid</span></span>() {
    <span class="hljs-comment"># 使用 top 命令获取进程信息，筛选出 Nginx worker 进程</span>
    <span class="hljs-built_in">local</span> top_pid=$(top -b -n 1 | awk <span class="hljs-string">'/nginx/ {print $1, $9}'</span> | <span class="hljs-built_in">sort</span> -k2 -nr | <span class="hljs-built_in">head</span> -n 1 | awk <span class="hljs-string">'{print $1}'</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$top_pid</span>"</span>
}

<span class="hljs-comment"># 调用函数并输出结果</span>
top_nginx_worker_pid=$(get_top_cpu_nginx_worker_pid)
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$top_nginx_worker_pid</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"CPU 使用率最高的 Nginx worker 进程 PID: <span class="hljs-variable">$top_nginx_worker_pid</span>"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"未找到 Nginx worker 进程。"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">cd</span> /root/debug

<span class="hljs-built_in">echo</span> <span class="hljs-string">"perf nginx cpu flame,wait 30s"</span>
perf record -F 99 -g -p <span class="hljs-string">"<span class="hljs-variable">$top_nginx_worker_pid</span>"</span> -- <span class="hljs-built_in">sleep</span> 30
perf script | ./FlameGraph/stackcollapse-perf.pl| ./FlameGraph/flamegraph.pl &gt; ./ngx_c_flame.svg

<span class="hljs-built_in">echo</span> <span class="hljs-string">"perf nginx cpu flame done"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"stap nginx lua flame,wait 30s"</span>

docker run --<span class="hljs-built_in">rm</span> --name debug --pid=host -v /lib/modules:/lib/modules -v /root/debug:/root/debug -v /sys/kernel/debug:/sys/kernel/debug -v /usr/src/kernels:/usr/src/kernels --privileged --entrypoint /bin/bash  openresty-debug:2.0.0  -c <span class="hljs-string">"cd /root/debug/stapxx/ &amp;&amp; export PATH=\$PWD:\$PATH &amp;&amp; ./samples/lj-lua-stacks.sxx --skip-badvars --arg time=30 -x <span class="hljs-variable">$top_nginx_worker_pid</span> &gt; /root/debug/a.bt"</span>

./FlameGraph/stackcollapse-stap.pl a.bt &gt; a.cbt
./FlameGraph/flamegraph.pl a.cbt  &gt; ngx_lua_flame.svg

<span class="hljs-built_in">echo</span> <span class="hljs-string">"stap nginx lua flame done"</span>
</code></pre>
<p>这里也贴一下stapxx/tapset/luajit.sxx的代码，用于参考：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// module luajit</span>


<span class="hljs-variable">@use</span> nginx.lua


$*<span class="hljs-attribute">pt </span>:= <span class="hljs-variable">@cast</span>(pt, <span class="hljs-string">"GCproto"</span>, <span class="hljs-string">"$^libluajit_path"</span>)


<span class="hljs-comment">//@define LJ_TLIGHTUD  %( 4294967292 %)</span>
<span class="hljs-variable">@define</span> LJ_TLIGHTUD  %( <span class="hljs-number">4294901760</span> %)
<span class="hljs-variable">@define</span> LJ_TSTR  %( <span class="hljs-number">4294967291</span> %)
<span class="hljs-variable">@define</span> LJ_TUDATA  %( <span class="hljs-number">4294967283</span> %)
<span class="hljs-variable">@define</span> LJ_TFUNC  %( <span class="hljs-number">4294967287</span> %)


<span class="hljs-variable">@define</span> TSTR    %( <span class="hljs-number">4</span> %)
<span class="hljs-variable">@define</span> TUPVAL  %( <span class="hljs-number">5</span> %)
<span class="hljs-variable">@define</span> TTHREAD %( <span class="hljs-number">6</span> %)
<span class="hljs-variable">@define</span> TPROTO  %( <span class="hljs-number">7</span> %)
<span class="hljs-variable">@define</span> TFUNC   %( <span class="hljs-number">8</span> %)
<span class="hljs-variable">@define</span> TTRACE  %( <span class="hljs-number">9</span> %)
<span class="hljs-variable">@define</span> TCDATA  %( <span class="hljs-number">10</span> %)
<span class="hljs-variable">@define</span> TTAB    %( <span class="hljs-number">11</span> %)
<span class="hljs-variable">@define</span> TUDATA  %( <span class="hljs-number">12</span> %)

<span class="hljs-variable">@define</span> CTSHIFT_NUM  %( <span class="hljs-number">28</span> %)
<span class="hljs-variable">@define</span> CT_HASSIZE   %( <span class="hljs-number">5</span> %)
<span class="hljs-variable">@define</span> CT_ATTRIB    %( <span class="hljs-number">8</span> %)
<span class="hljs-variable">@define</span> CTMASK_CID   %( <span class="hljs-number">0</span>xffff %)

<span class="hljs-variable">@define</span> FF_LUA %( <span class="hljs-number">0</span> %)
<span class="hljs-variable">@define</span> FF_C   %( <span class="hljs-number">1</span> %)

<span class="hljs-variable">@define</span> FRAME_LUA   %( <span class="hljs-number">0</span> %)
<span class="hljs-variable">@define</span> FRAME_CONT  %( <span class="hljs-number">2</span> %)
<span class="hljs-variable">@define</span> FRAME_TYPE  %( <span class="hljs-number">3</span> %)
<span class="hljs-variable">@define</span> FRAME_P     %( <span class="hljs-number">4</span> %)
<span class="hljs-variable">@define</span> FRAME_TYPEP %( (<span class="hljs-variable">@FRAME_TYPE</span>|<span class="hljs-variable">@FRAME_P</span>) %)

<span class="hljs-variable">@define</span> NO_BCPOS    %( ~<span class="hljs-number">0</span> %)

<span class="hljs-variable">@define</span> sizeof_GCtab  %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCtab"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_TValue  %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_lua_State %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"struct lua_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCfunc %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"union GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCupval %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCupval"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCstr %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCstr"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCudata %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCudata"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_Node %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"Node"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCfuncC %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCfuncC"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCfuncL %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCfuncL"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCRef %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCRef"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCproto %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCproto"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCtrace %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCtrace"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_GCcdata %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCcdata"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_IRIns %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"IRIns"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_IRRef %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"IRRef"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_SnapShot %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"SnapShot"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_SnapEntry %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"SnapEntry"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_K64Array %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"K64Array"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_ptr %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"global_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;strmask %)
<span class="hljs-variable">@define</span> sizeof_GCcdataVar %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCcdataVar"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)
<span class="hljs-variable">@define</span> sizeof_BCIns %( &amp;<span class="hljs-variable">@cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"BCIns"</span>, <span class="hljs-string">"$^libluajit_path"</span>)[<span class="hljs-number">1</span>] %)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">strdata</span>(s) %(
    (<span class="hljs-variable">@s</span> + <span class="hljs-variable">@sizeof_GCstr</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_gc</span>(frame) %(
    <span class="hljs-variable">@cast</span>(<span class="hljs-variable">@frame</span>, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;gcr-&gt;gcptr64
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_ftsz</span>(tv) %(
    <span class="hljs-variable">@cast</span>(<span class="hljs-variable">@tv</span>, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;ftsz
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_type</span>(f) %(
    (<span class="hljs-variable">@frame_ftsz</span>(<span class="hljs-variable">@f</span>) &amp; <span class="hljs-variable">@FRAME_TYPE</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_typep</span>(f) %(
    (<span class="hljs-variable">@frame_ftsz</span>(<span class="hljs-variable">@f</span>) &amp; <span class="hljs-variable">@FRAME_TYPEP</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_islua</span>(f) %(
    (<span class="hljs-variable">@frame_type</span>(<span class="hljs-variable">@f</span>) == <span class="hljs-variable">@FRAME_LUA</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_iscont</span>(f) %(
    (<span class="hljs-variable">@frame_typep</span>(<span class="hljs-variable">@f</span>) == <span class="hljs-variable">@FRAME_CONT</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_pc</span>(tv) %(
    <span class="hljs-variable">@cast</span>(<span class="hljs-variable">@tv</span>, <span class="hljs-string">"TValue"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;ftsz
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_contpc</span>(f) %(
    (<span class="hljs-variable">@frame_pc</span>(<span class="hljs-variable">@f</span>) - <span class="hljs-number">1</span> * <span class="hljs-variable">@sizeof_BCIns</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">bc_a</span>(i) %(
    ((<span class="hljs-variable">@i</span> &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0</span>xff)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_prevl</span>(f) %(
    (<span class="hljs-variable">@f</span> - (<span class="hljs-number">1</span> + <span class="hljs-variable">@bc_a</span>(<span class="hljs-built_in">user_uint32</span>(<span class="hljs-variable">@frame_pc</span>(<span class="hljs-variable">@f</span>) - <span class="hljs-number">4</span>))) * <span class="hljs-variable">@sizeof_TValue</span>)
%)

<span class="hljs-variable">@define</span> FRAME_VARG  %( <span class="hljs-number">3</span> %)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_isvarg</span>(f) %(
    (<span class="hljs-variable">@frame_typep</span>(<span class="hljs-variable">@f</span>) == <span class="hljs-variable">@FRAME_VARG</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_sized</span>(f) %(
    (<span class="hljs-variable">@frame_ftsz</span>(<span class="hljs-variable">@f</span>) &amp; ~<span class="hljs-variable">@FRAME_TYPEP</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">frame_prevd</span>(f) %(
    (<span class="hljs-variable">@f</span> - <span class="hljs-variable">@frame_sized</span>(<span class="hljs-variable">@f</span>))
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">isluafunc</span>(fn) %(
    (<span class="hljs-variable">@cast</span>(<span class="hljs-variable">@fn</span>, <span class="hljs-string">"GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;c-&gt;ffid == <span class="hljs-variable">@FF_LUA</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">isffunc</span>(fn) %(
    (<span class="hljs-variable">@cast</span>(<span class="hljs-variable">@fn</span>, <span class="hljs-string">"GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;c-&gt;ffid &gt; <span class="hljs-variable">@FF_C</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">funcproto</span>(fn) %(
    (<span class="hljs-variable">@cast</span>(<span class="hljs-variable">@fn</span>, <span class="hljs-string">"GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;l-&gt;pc-&gt;ptr64 - <span class="hljs-variable">@sizeof_GCproto</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">proto_bc</span>(pt) %(
    (<span class="hljs-variable">@pt</span> + <span class="hljs-variable">@sizeof_GCproto</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">proto_bcpos</span>(pt, pc) %(
    ((<span class="hljs-variable">@pc</span> - <span class="hljs-variable">@proto_bc</span>(<span class="hljs-variable">@pt</span>)) / <span class="hljs-variable">@sizeof_BCIns</span>)
%)

<span class="hljs-variable">@define</span> <span class="hljs-built_in">proto_lineinfo</span>(pt) %(
    <span class="hljs-variable">@cast</span>(<span class="hljs-variable">@pt</span>, <span class="hljs-string">"GCproto"</span>, <span class="hljs-string">"$^libluajit_path"</span>)-&gt;lineinfo-&gt;ptr64
%)


global luajit_cfunc_cache


function <span class="hljs-built_in">luajit_frame_func</span>(f) {
    <span class="hljs-selector-tag">gco</span> = @<span class="hljs-selector-tag">frame_gc</span>(f)
    $*<span class="hljs-selector-tag">gco</span> := @<span class="hljs-selector-tag">cast</span>(gco, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">fn</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_G</span>(L)
{
    $*L := @cast(L, "lua_State", "$^libluajit_path")
    return $*L-&gt;glref-&gt;ptr64
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_gcref</span>(r)
{
    $*r := @cast(r, "GCRef", "$^libluajit_path")
    return $*r-&gt;gcptr64
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_objlen</span>(o, gct, g)
{
    $*o := @cast(o, "GCobj", "$^libluajit_path")
    if (gct == @TSTR) {
        /*
        if ($*o-&gt;str-&gt;len == 0) {
            printf("empty string found.\n")
        }
        */
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">str-</span>&gt;<span class="hljs-selector-tag">len</span> + <span class="hljs-number">1</span> + @<span class="hljs-selector-tag">sizeof_GCstr</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TTAB</span>) {
        <span class="hljs-selector-tag">t</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">tab</span>
        $*<span class="hljs-selector-tag">t</span> := @<span class="hljs-selector-tag">cast</span>(t, <span class="hljs-string">"GCtab"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">asize</span> = $*<span class="hljs-selector-tag">t-</span>&gt;<span class="hljs-selector-tag">asize</span>
        <span class="hljs-selector-tag">hmask</span> = $*<span class="hljs-selector-tag">t-</span>&gt;<span class="hljs-selector-tag">hmask</span>

        <span class="hljs-selector-tag">n</span> = <span class="hljs-number">0</span>
        <span class="hljs-selector-tag">if</span> (hmask &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-selector-tag">n</span> += @<span class="hljs-selector-tag">sizeof_Node</span> * (hmask + <span class="hljs-number">1</span>)
        }

        <span class="hljs-selector-tag">if</span> (asize &gt; <span class="hljs-number">0</span> &amp;&amp; $*t-&gt;colo &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-selector-tag">n</span> += @<span class="hljs-selector-tag">sizeof_TValue</span> * <span class="hljs-selector-tag">asize</span>
        }

        <span class="hljs-selector-tag">if</span> ($*t-&gt;colo) {
            <span class="hljs-selector-tag">n</span> += ($*t-&gt;colo &amp; <span class="hljs-number">0</span>x7f) * @<span class="hljs-selector-tag">sizeof_TValue</span> + @<span class="hljs-selector-tag">sizeof_GCtab</span>

        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">n</span> += @<span class="hljs-selector-tag">sizeof_GCtab</span>
        }

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">n</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TUDATA</span>) {
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">ud-</span>&gt;<span class="hljs-selector-tag">len</span> + @<span class="hljs-selector-tag">sizeof_GCudata</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TPROTO</span>) {
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">sizept</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TTHREAD</span>) {
        <span class="hljs-selector-tag">L</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">th</span>
        <span class="hljs-comment">//printf("open upval: %p\n", luajit_gcref(&amp;$*L-&gt;openupval))</span>
        <span class="hljs-comment">//printf("lua_State: %d\n", @sizeof_lua_State)</span>
        <span class="hljs-selector-tag">n</span> = @<span class="hljs-selector-tag">sizeof_lua_State</span> + $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">stacksize</span> * @<span class="hljs-selector-tag">sizeof_TValue</span>
        <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">openupval</span>
        <span class="hljs-selector-tag">while</span> (p) {
            <span class="hljs-selector-tag">o</span> = <span class="hljs-selector-tag">luajit_gcref</span>(p)
            <span class="hljs-selector-tag">if</span> (o == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">break</span>;
            }

            $*<span class="hljs-selector-tag">o</span> := @<span class="hljs-selector-tag">cast</span>(o, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
            <span class="hljs-selector-tag">gct</span> = $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gch-</span>&gt;<span class="hljs-selector-tag">gct</span>
            <span class="hljs-selector-tag">size</span> = <span class="hljs-selector-tag">luajit_objlen</span>(o, gct, g)
            <span class="hljs-comment">//printf("%s: %d\n", typenames[@TSTR], size)</span>
            <span class="hljs-selector-tag">n</span> += <span class="hljs-selector-tag">size</span>
            <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gch-</span>&gt;<span class="hljs-selector-tag">nextgc</span>
        }

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">n</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TFUNC</span>) {
        <span class="hljs-selector-tag">fn</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">fn</span>
        $*<span class="hljs-selector-tag">fn</span> := @<span class="hljs-selector-tag">cast</span>(fn, <span class="hljs-string">"GCfunc"</span>, <span class="hljs-string">"$^libluajit_path"</span>);
        <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@isluafunc</span>(fn)) {
            <span class="hljs-selector-tag">n</span> = $*<span class="hljs-selector-tag">fn-</span>&gt;<span class="hljs-selector-tag">l-</span>&gt;<span class="hljs-selector-tag">nupvalues</span>
            <span class="hljs-comment">//n = 0</span>
            <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">sizeof_GCfuncL</span> <span class="hljs-selector-tag">-</span> @<span class="hljs-selector-tag">sizeof_GCRef</span> + @<span class="hljs-selector-tag">sizeof_GCRef</span> * <span class="hljs-selector-tag">n</span>
        }

        <span class="hljs-selector-tag">n</span> = $*<span class="hljs-selector-tag">fn-</span>&gt;<span class="hljs-selector-tag">c-</span>&gt;<span class="hljs-selector-tag">nupvalues</span>
        <span class="hljs-comment">//n = 0</span>
        <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">sizeof_GCfuncC</span> <span class="hljs-selector-tag">-</span> @<span class="hljs-selector-tag">sizeof_TValue</span> + @<span class="hljs-selector-tag">sizeof_TValue</span> * <span class="hljs-selector-tag">n</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TUPVAL</span>) {
        <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">sizeof_GCupval</span>
    }

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TTRACE</span>) {
        <span class="hljs-selector-tag">T</span> = <span class="hljs-selector-tag">o</span>
        $*<span class="hljs-selector-tag">T</span> := @<span class="hljs-selector-tag">cast</span>(T, <span class="hljs-string">"GCtrace"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">return</span> ((<span class="hljs-variable">@sizeof_GCtrace</span> + <span class="hljs-number">7</span>) &amp; ~<span class="hljs-number">7</span>)
               + ($*T-&gt;nins - $*T-&gt;nk) * @<span class="hljs-selector-tag">sizeof_IRIns</span>
               + $*<span class="hljs-selector-tag">T-</span>&gt;<span class="hljs-selector-tag">nsnap</span> * @<span class="hljs-selector-tag">sizeof_SnapShot</span>
               + $*<span class="hljs-selector-tag">T-</span>&gt;<span class="hljs-selector-tag">nsnapmap</span> * @<span class="hljs-selector-tag">sizeof_SnapEntry</span>
    }

    $*<span class="hljs-selector-tag">g</span> := @<span class="hljs-selector-tag">cast</span>(g, <span class="hljs-string">"global_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)

    <span class="hljs-selector-tag">if</span> (gct == <span class="hljs-variable">@TCDATA</span>) {
        <span class="hljs-selector-tag">cd</span> = <span class="hljs-selector-tag">o</span>
        $*<span class="hljs-selector-tag">cd</span> := @<span class="hljs-selector-tag">cast</span>(cd, <span class="hljs-string">"GCcdata"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">if</span> ($*cd-&gt;marked &amp; <span class="hljs-number">0</span>x80) {
            <span class="hljs-comment">/* cdata is a vector */</span>
            <span class="hljs-selector-tag">cdatav</span> = <span class="hljs-selector-tag">cd</span> <span class="hljs-selector-tag">-</span> @<span class="hljs-selector-tag">sizeof_GCcdataVar</span>
            $*<span class="hljs-selector-tag">cdatav</span> := @<span class="hljs-selector-tag">cast</span>(cdatav, <span class="hljs-string">"GCcdataVar"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
            <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">cdatav-</span>&gt;<span class="hljs-selector-tag">len</span> + $*<span class="hljs-selector-tag">cdatav-</span>&gt;<span class="hljs-selector-tag">extra</span>
        }

        <span class="hljs-comment">/* cdata is not a vector */</span>
        <span class="hljs-selector-tag">cts</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">ctype_state-</span>&gt;<span class="hljs-selector-tag">ptr64</span>
        $*<span class="hljs-selector-tag">cts</span> := @<span class="hljs-selector-tag">cast</span>(cts, <span class="hljs-string">"CTState"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">id</span> = $*<span class="hljs-selector-tag">cd-</span>&gt;<span class="hljs-selector-tag">ctypeid</span>
        <span class="hljs-selector-tag">ct</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">cts-</span>&gt;<span class="hljs-selector-tag">tab</span><span class="hljs-selector-attr">[id]</span>
        $*<span class="hljs-selector-tag">ct</span> := @<span class="hljs-selector-tag">cast</span>(ct, <span class="hljs-string">"CType"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">while</span> (($*ct-&gt;info &gt;&gt; <span class="hljs-variable">@CTSHIFT_NUM</span>) == <span class="hljs-variable">@CT_ATTRIB</span>) {
            <span class="hljs-comment">//printf("XXX skipping c type attribute\n")</span>
            <span class="hljs-selector-tag">ct</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">cts-</span>&gt;<span class="hljs-selector-tag">tab</span><span class="hljs-selector-attr">[$*ct-&gt;info &amp; @CTMASK_CID]</span>
        }

        <span class="hljs-selector-tag">if</span> (($*ct-&gt;info &gt;&gt; <span class="hljs-variable">@CTSHIFT_NUM</span>) &lt;= <span class="hljs-variable">@CT_HASSIZE</span>) {
            <span class="hljs-selector-tag">sz</span> = $*<span class="hljs-selector-tag">ct-</span>&gt;<span class="hljs-selector-tag">size</span>

        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">sz</span> = @<span class="hljs-selector-tag">sizeof_ptr</span>
        }

        <span class="hljs-comment">//printf("GCcdata size: %d\n", @sizeof_GCcdata)</span>
        <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">sizeof_GCcdata</span> + <span class="hljs-selector-tag">sz</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_jit_state_size</span>(J)
{
    $*J := @cast(J, "jit_State", "$^libluajit_path")

    ir_k64_size = 0
    // In the newer revision of luajit, 64-bit constants are represented as an
    // array of TValue. Uncomment following code if the luajit being used
    // is using linked list to represent 64-bit constants. As the 64-bit
    // constants don't take lots of memory, it does not seems to be a big deal
    // if you don't uncomment following code for the older luajit.
    //
    /*
    $*k := @cast(k, "K64Array", "$^libluajit_path")
    for (k = $*J-&gt;k64-&gt;ptr64; <span class="hljs-selector-tag">k</span>; ) {
        <span class="hljs-selector-tag">ir_k64_size</span> += @<span class="hljs-selector-tag">sizeof_K64Array</span>
        <span class="hljs-selector-tag">k</span> = $*<span class="hljs-selector-tag">k-</span>&gt;<span class="hljs-selector-tag">next-</span>&gt;<span class="hljs-selector-tag">ptr64</span>
    }
    <span class="hljs-selector-tag">if</span> (ir_k64_size) {
        <span class="hljs-comment">//printf("64-bit constants: %d\n", ir_k64_size)</span>
    }
    */

    sizesnapmap = $*J-&gt;sizesnapmap * <span class="hljs-variable">@sizeof_SnapEntry</span>
    if (sizesnapmap) {
        <span class="hljs-comment">//printf("JIT snap map buffer size: %d\n", sizesnapmap)</span>
    }

    sizesnap = $*J-&gt;sizesnap * <span class="hljs-variable">@sizeof_SnapShot</span>
    if (sizesnap) {
        <span class="hljs-comment">//printf("JIT snap buffer size: %d\n", sizesnap)</span>
    }

    sizeirbuf = ($*J-&gt;irtoplim - $*J-&gt;irbotlim) * <span class="hljs-variable">@sizeof_IRIns</span>
    if (sizeirbuf) {
        <span class="hljs-comment">//printf("JIT IR buffer size: %d\n", sizeirbuf)</span>
    }

    sizetrace = $*J-&gt;sizetrace * <span class="hljs-variable">@sizeof_GCRef</span>
    if (sizetrace) {
        <span class="hljs-comment">//printf("JIT trace array size: %d\n", sizetrace)</span>
    }

    return ir_k64_size + sizesnapmap + sizesnap + sizeirbuf + sizetrace
}


<span class="hljs-comment">/* returns a TValue* pointer */</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_index2adr</span>(L, idx)
{
    <span class="hljs-selector-tag">if</span> (idx &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">o</span> = $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">base</span> + (idx - <span class="hljs-number">1</span>) * @<span class="hljs-selector-tag">sizeof_TValue</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">o</span> &lt; $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">top</span> ? <span class="hljs-selector-tag">o</span> : <span class="hljs-number">0</span>
    }

    <span class="hljs-selector-tag">top</span> = $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">top</span>

    <span class="hljs-selector-tag">if</span> (idx != <span class="hljs-number">0</span> &amp;&amp; -idx &lt;= top - $*L-&gt;base) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">top</span> + <span class="hljs-selector-tag">idx</span> * @<span class="hljs-selector-tag">sizeof_TValue</span>;
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>
}


<span class="hljs-comment">/* convert GCstr to stap string */</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_unbox_gcstr</span>(gcs)
{
    <span class="hljs-selector-tag">if</span> (gcs == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> ""
    }

    $*<span class="hljs-selector-tag">gcs</span> := @<span class="hljs-selector-tag">cast</span>(gcs, <span class="hljs-string">"GCstr"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">src</span> = @<span class="hljs-selector-tag">strdata</span>(gcs)
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">user_string_n_warn</span>(src, $*gcs-&gt;len)
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_tostring</span>(L, idx)
{
    $*o := @cast(o, "TValue", "$^libluajit_path")
    o = luajit_index2adr(L, idx)
    if (o == 0) {
        return "&lt;nil&gt;"
    }

    <span class="hljs-selector-tag">if</span> ($*o-&gt;it == <span class="hljs-variable">@LJ_TSTR</span>) {
        <span class="hljs-selector-tag">gco</span> = $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gcr-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
        $*<span class="hljs-selector-tag">gco</span> := @<span class="hljs-selector-tag">cast</span>(gco, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">s</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">str</span>
        $*<span class="hljs-selector-tag">s</span> := @<span class="hljs-selector-tag">cast</span>(s, <span class="hljs-string">"GCstr"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">user_string_n</span>(s + <span class="hljs-variable">@sizeof_GCstr</span>, $*s-&gt;len)
    }

    <span class="hljs-selector-tag">return</span> "&lt;<span class="hljs-selector-tag">unknown</span>&gt;"
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_tostringlen</span>(L, idx)
{
    $*o := @cast(o, "TValue", "$^libluajit_path")
    o = luajit_index2adr(L, idx)
    if (o == 0) {
        return -1
    }

    <span class="hljs-selector-tag">if</span> ($*o-&gt;it == <span class="hljs-variable">@LJ_TSTR</span>) {
        <span class="hljs-selector-tag">gco</span> = $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gcr-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
        $*<span class="hljs-selector-tag">gco</span> := @<span class="hljs-selector-tag">cast</span>(gco, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">s</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">str</span>
        $*<span class="hljs-selector-tag">s</span> := @<span class="hljs-selector-tag">cast</span>(s, <span class="hljs-string">"GCstr"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">s-</span>&gt;<span class="hljs-selector-tag">len</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">-1</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_touserdata</span>(L, idx)
{
    $*o := @cast(o, "TValue", "$^libluajit_path")
    o = luajit_index2adr(L, idx)
    if (o == 0) {
        return 0
    }

    <span class="hljs-comment">//printf("udata type: %d (%d)\n", $*o-&gt;it, ($*o-&gt;it &gt;&gt; 15))</span>

    <span class="hljs-selector-tag">if</span> ($*o-&gt;it == <span class="hljs-variable">@LJ_TUDATA</span>) {
        <span class="hljs-selector-tag">gco</span> = $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gcr-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
        <span class="hljs-selector-tag">ud</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">ud</span>
        $*<span class="hljs-selector-tag">ud</span> := @<span class="hljs-selector-tag">cast</span>(ud, <span class="hljs-string">"GCudata"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ud</span> + @<span class="hljs-selector-tag">sizeof_GCudata</span>
    }

    <span class="hljs-selector-tag">if</span> ($*o-&gt;it == <span class="hljs-variable">@LJ_TLIGHTUD</span>) {
        <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">u64</span> <span class="hljs-selector-tag">&amp;</span> <span class="hljs-number">0</span><span class="hljs-selector-tag">x7fffffffffff</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_proto_chunkname</span>(pt) {
    <span class="hljs-selector-tag">gco</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">chunkname-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">str</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_debug_framepc</span>(L, T, fn, pt, nextframe) {
    <span class="hljs-comment">//printf("debug framepc: L=%p, fn=%p, nextframe = %p\\n", L, fn, nextframe)</span>
    <span class="hljs-selector-tag">if</span> (nextframe == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> @<span class="hljs-selector-tag">NO_BCPOS</span>
    }

    <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_islua</span>(nextframe)) {
        <span class="hljs-selector-tag">ins</span> = @<span class="hljs-selector-tag">frame_pc</span>(nextframe);
        <span class="hljs-comment">//printf("frame is lua, ins = %p\\n", ins)</span>

    } <span class="hljs-selector-tag">else</span> <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_iscont</span>(nextframe)) {
        <span class="hljs-comment">//println("frame is cont")</span>
        <span class="hljs-selector-tag">ins</span> = @<span class="hljs-selector-tag">frame_contpc</span>(nextframe)

    } <span class="hljs-selector-tag">else</span> {
        <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> add support for cframe */</span>
    }

    <span class="hljs-comment">//printf("debug framepc: ins = %p\\n", ins)</span>
    <span class="hljs-selector-tag">pos</span> = @<span class="hljs-selector-tag">proto_bcpos</span>(pt, ins) <span class="hljs-selector-tag">-</span> <span class="hljs-number">1</span>;
    <span class="hljs-selector-tag">sizebc</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">sizebc</span>
    <span class="hljs-selector-tag">if</span> (pos &gt; sizebc) {
        <span class="hljs-comment">//printf("Undo the effects of lj_trace_exit for JLOOP.\n")</span>
        <span class="hljs-selector-tag">if</span> (!T) {
            <span class="hljs-selector-tag">T</span> = <span class="hljs-selector-tag">ins</span> <span class="hljs-selector-tag">-</span> <span class="hljs-number">1</span> * @<span class="hljs-selector-tag">sizeof_BCIns</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">&amp;</span>@<span class="hljs-selector-tag">cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GCtrace"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-tag">-</span>&gt;<span class="hljs-selector-tag">startins</span>;
        }
        <span class="hljs-comment">//printf("startpc: %d\n", $*T-&gt;startpc-&gt;ptr64)</span>
        <span class="hljs-selector-tag">pos</span> = @<span class="hljs-selector-tag">proto_bcpos</span>(pt, $*T-&gt;startpc-&gt;ptr64);
        <span class="hljs-comment">//printf("Found adjusted position: %d\n", pos)</span>
    }
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">pos</span>;
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_debug_line</span>(pt, pc)
{
    <span class="hljs-selector-tag">lineinfo</span> = @<span class="hljs-selector-tag">proto_lineinfo</span>(pt)
    <span class="hljs-comment">//printf("lj_debug_line: lineinfo = %p, %x &lt;= %x\\n", lineinfo,</span>
           <span class="hljs-comment">//pc, $pt-&gt;sizebc)</span>
    <span class="hljs-selector-tag">sizebc</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">sizebc</span>

    <span class="hljs-selector-tag">if</span> (pc &lt;= sizebc &amp;&amp; lineinfo) {
        <span class="hljs-selector-tag">first</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">firstline</span>

        <span class="hljs-selector-tag">if</span> (pc == sizebc) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span> + $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">numline</span>
        }

        <span class="hljs-selector-tag">if</span> (pc-- == <span class="hljs-number">0</span>) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span>
        }

        <span class="hljs-selector-tag">if</span> ($*pt-&gt;numline &lt; <span class="hljs-number">256</span>) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span> + @<span class="hljs-selector-tag">cast</span>(lineinfo, <span class="hljs-string">"uint8_t"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-attr">[pc]</span>
        }

        <span class="hljs-selector-tag">if</span> ($*pt-&gt;numline &lt; <span class="hljs-number">65536</span>) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span> + @<span class="hljs-selector-tag">cast</span>(lineinfo, <span class="hljs-string">"uint16_t"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-attr">[pc]</span>
        }

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">first</span> + @<span class="hljs-selector-tag">cast</span>(lineinfo, <span class="hljs-string">"uint32_t"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-attr">[pc]</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">-1</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_debug_frameline</span>(L, T, fn, pt, nextframe)
{
    <span class="hljs-selector-tag">pc</span> = <span class="hljs-selector-tag">luajit_debug_framepc</span>(L, T, fn, pt, nextframe)
    <span class="hljs-selector-tag">if</span> (pc != <span class="hljs-variable">@NO_BCPOS</span>) {
        <span class="hljs-selector-tag">if</span> (pc &lt;= $*pt-&gt;sizebc) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">luajit_debug_line</span>(pt, pc)
        }
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">-1</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_debug_dumpstack</span>(L, T, depth, base, simple)
{
    <span class="hljs-selector-tag">level</span> = <span class="hljs-number">0</span>
    <span class="hljs-selector-tag">dir</span> = <span class="hljs-number">1</span>
    <span class="hljs-selector-tag">if</span> (depth &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">level</span> = ~<span class="hljs-selector-tag">depth</span>
        <span class="hljs-selector-tag">depth</span> = <span class="hljs-selector-tag">dir</span> = <span class="hljs-selector-tag">-1</span>
    }
    <span class="hljs-selector-tag">bt</span> = ""
    <span class="hljs-selector-tag">while</span> (level != depth) {
        <span class="hljs-comment">/* lj_debug_frame(L, level, &amp;size) {{{ */</span>
        <span class="hljs-selector-tag">bot</span> = $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">stack-</span>&gt;<span class="hljs-selector-tag">ptr64</span>
        <span class="hljs-selector-tag">found_frame</span> = <span class="hljs-number">0</span>
        <span class="hljs-selector-tag">tmp_level</span> = <span class="hljs-selector-tag">level</span>
        <span class="hljs-comment">/* Traverse frames backwards. */</span>
        <span class="hljs-selector-tag">for</span> (nextframe = frame = base - <span class="hljs-variable">@sizeof_TValue</span>; frame &gt; bot; ) {
            <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_gc</span>(frame) == L) {
                <span class="hljs-selector-tag">tmp_level</span>++
            }

            <span class="hljs-selector-tag">if</span> (tmp_level-- == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">size</span> = (nextframe - frame) / @<span class="hljs-selector-tag">sizeof_TValue</span>
                <span class="hljs-selector-tag">found_frame</span> = <span class="hljs-number">1</span>
                <span class="hljs-selector-tag">break</span>
            }
            <span class="hljs-selector-tag">nextframe</span> = <span class="hljs-selector-tag">frame</span>
            <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_islua</span>(frame)) {
                <span class="hljs-selector-tag">frame</span> = @<span class="hljs-selector-tag">frame_prevl</span>(frame)

            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@frame_isvarg</span>(frame)) {
                    <span class="hljs-selector-tag">tmp_level</span>++;  <span class="hljs-comment">/* Skip vararg pseudo-frame. */</span>
                }

                <span class="hljs-selector-tag">frame</span> = @<span class="hljs-selector-tag">frame_prevd</span>(frame);
            }
        }

        <span class="hljs-selector-tag">if</span> (!found_frame) {
            <span class="hljs-selector-tag">frame</span> = <span class="hljs-number">0</span>
            <span class="hljs-selector-tag">size</span> = <span class="hljs-selector-tag">tmp_level</span>
        }
        <span class="hljs-comment">/* }}} */</span>

        <span class="hljs-selector-tag">if</span> (frame) {
            <span class="hljs-comment">//nextframe = size ? frame + size * @sizeof_TValue : 0</span>
            <span class="hljs-selector-tag">fn</span> = <span class="hljs-selector-tag">luajit_frame_func</span>(frame)
            <span class="hljs-selector-tag">if</span> (fn == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">return</span> ""
            }
            <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@isluafunc</span>(fn)) {
                <span class="hljs-selector-tag">pt</span> = @<span class="hljs-selector-tag">funcproto</span>(fn)

                <span class="hljs-selector-tag">if</span> (simple) {
                    <span class="hljs-selector-tag">line</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">firstline</span>

                } <span class="hljs-selector-tag">else</span> {
                    <span class="hljs-selector-tag">line</span> = <span class="hljs-selector-tag">luajit_debug_frameline</span>(L, T, fn, pt, nextframe)
                    <span class="hljs-selector-tag">if</span> (line &lt; <span class="hljs-number">0</span>) {
                        <span class="hljs-selector-tag">line</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">firstline</span>
                        <span class="hljs-comment">//printf("using firstline %d\n", line)</span>

                    } <span class="hljs-selector-tag">else</span> {
                        <span class="hljs-comment">//printf("GOT the lineno %d\n", line)</span>
                    }
                }

                <span class="hljs-selector-tag">name</span> = <span class="hljs-selector-tag">luajit_proto_chunkname</span>(pt)  <span class="hljs-comment">/* GCstr *name */</span>
                <span class="hljs-selector-tag">if</span> (name == <span class="hljs-number">0</span>) {
                    <span class="hljs-selector-tag">return</span> ""
                }

                <span class="hljs-selector-tag">path</span> = <span class="hljs-selector-tag">luajit_unbox_gcstr</span>(name)
                <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"%s:%d\n"</span>, path, line)

            } <span class="hljs-selector-tag">else</span> <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@isffunc</span>(fn)) {
                <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"builtin#%d\n"</span>, $*fn-&gt;c-&gt;ffid)

            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-comment">/* C function */</span>
                <span class="hljs-selector-tag">cfunc</span> = $*<span class="hljs-selector-tag">fn-</span>&gt;<span class="hljs-selector-tag">c-</span>&gt;<span class="hljs-selector-tag">f</span>
                <span class="hljs-selector-tag">sym</span> = <span class="hljs-selector-tag">luajit_cfunc_cache</span><span class="hljs-selector-attr">[cfunc]</span>
                <span class="hljs-selector-tag">if</span> (sym == <span class="hljs-string">""</span>) {
                    <span class="hljs-selector-tag">sym</span> = <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"C:%s\n"</span>, <span class="hljs-built_in">usymname</span>(cfunc))
                    <span class="hljs-selector-tag">luajit_cfunc_cache</span><span class="hljs-selector-attr">[cfunc]</span> = <span class="hljs-selector-tag">sym</span>
                }
                <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">sym</span>
            }

        } <span class="hljs-selector-tag">else</span> <span class="hljs-selector-tag">if</span> (dir == <span class="hljs-number">1</span>) {
            <span class="hljs-selector-tag">break</span>

        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">level</span> <span class="hljs-selector-tag">-</span>= <span class="hljs-selector-tag">size</span>
        }
        <span class="hljs-selector-tag">level</span> += <span class="hljs-selector-tag">dir</span>
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">bt</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_cur_thread</span>(g)
{
    $*g := @cast(g, "global_State", "$^libluajit_path")
    gco = $*g-&gt;cur_L-&gt;gcptr64
    if (gco == 0) {
        return 0
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">th</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_get_trace</span>(g, traceno)
{
    <span class="hljs-selector-tag">GG</span> = <span class="hljs-selector-tag">g</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">&amp;</span>@<span class="hljs-selector-tag">cast</span>(<span class="hljs-number">0</span>, <span class="hljs-string">"GG_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)<span class="hljs-selector-tag">-</span>&gt;<span class="hljs-selector-tag">g</span>
    $*<span class="hljs-selector-tag">GG</span> := @<span class="hljs-selector-tag">cast</span>(GG, <span class="hljs-string">"GG_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">J</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">GG-</span>&gt;<span class="hljs-selector-tag">J</span>
    $*<span class="hljs-selector-tag">J</span> := @<span class="hljs-selector-tag">cast</span>(J, <span class="hljs-string">"jit_State"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">if</span> (J == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-number">0</span>
    }

    <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">J-</span>&gt;<span class="hljs-selector-tag">trace</span><span class="hljs-selector-attr">[traceno]</span><span class="hljs-selector-tag">-</span>&gt;<span class="hljs-selector-tag">gcptr64</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_trace_starting_func</span>(g, trace)
{
    $*trace := @cast(trace, "GCtrace", "$^libluajit_path")
    gco = $*trace-&gt;startpt-&gt;gcptr64
    if (gco == 0) {
        return ""
    }

    <span class="hljs-selector-tag">pt</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">gco-</span>&gt;<span class="hljs-selector-tag">pt</span>

    <span class="hljs-selector-tag">firstline</span> = $*<span class="hljs-selector-tag">pt-</span>&gt;<span class="hljs-selector-tag">firstline</span>

    <span class="hljs-selector-tag">name</span> = <span class="hljs-selector-tag">luajit_proto_chunkname</span>(pt)  <span class="hljs-comment">/* GCstr *name */</span>
    <span class="hljs-selector-tag">path</span> = <span class="hljs-selector-tag">luajit_unbox_gcstr</span>(name)

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"%s:%d"</span>, path, firstline)
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_print_backtrace</span>(simple)
{
    <span class="hljs-selector-tag">if</span> (<span class="hljs-variable">@defined</span>(<span class="hljs-variable">@var</span>(<span class="hljs-string">"globalL"</span>, <span class="hljs-string">"$^exec_path"</span>))) {
        <span class="hljs-selector-tag">mL</span> = @<span class="hljs-selector-tag">var</span>(<span class="hljs-string">"globalL"</span>, <span class="hljs-string">"$^exec_path"</span>)

    } <span class="hljs-selector-tag">else</span> {
        <span class="hljs-selector-tag">mL</span> = <span class="hljs-selector-tag">ngx_lua_get_main_lua_vm</span>()
    }

    <span class="hljs-selector-tag">if</span> (mL == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> ""
    }

    <span class="hljs-selector-tag">g</span> = <span class="hljs-selector-tag">luajit_G</span>(mL)
    <span class="hljs-selector-tag">if</span> (g == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> ""
    }

    <span class="hljs-selector-tag">L</span> = <span class="hljs-selector-tag">luajit_cur_thread</span>(g)
    <span class="hljs-selector-tag">if</span> (L == <span class="hljs-number">0</span>) {
        <span class="hljs-selector-tag">return</span> ""
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">luajit_backtrace</span>(L, g, simple)
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_backtrace</span>(L, g, simple)
{
    <span class="hljs-selector-tag">bt</span> = ""

    <span class="hljs-selector-tag">vmstate</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">vmstate</span>
    <span class="hljs-selector-tag">if</span> (vmstate &gt;= <span class="hljs-number">0</span> || (vmstate == -<span class="hljs-number">3</span> &amp;&amp; $*g-&gt;jit_base-&gt;ptr64)) {
        <span class="hljs-comment">/* compiled Lua code */</span>

        <span class="hljs-selector-tag">T</span> = <span class="hljs-selector-tag">luajit_get_trace</span>(g, vmstate)
        <span class="hljs-selector-tag">if</span> (T) {
            <span class="hljs-selector-tag">if</span> (simple) {
                <span class="hljs-selector-tag">func</span> = <span class="hljs-selector-tag">luajit_trace_starting_func</span>(g, T)
                <span class="hljs-selector-tag">if</span> (func != <span class="hljs-string">""</span>) {
                    <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">sprintf</span>(<span class="hljs-string">"T:%s\n"</span>, func)
                }

            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-comment">//printf("start pc: %d\n", $*T-&gt;startpc-&gt;ptr64)</span>
            }

            <span class="hljs-selector-id">#warn</span>(<span class="hljs-built_in">sprintf</span>(<span class="hljs-string">"bt: %s"</span>, bt))
        }

        <span class="hljs-selector-tag">base</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">jit_base-</span>&gt;<span class="hljs-selector-tag">ptr64</span>
        <span class="hljs-selector-tag">if</span> (!base) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">bt</span>
        }

        <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">luajit_debug_dumpstack</span>(L, T, $^<span class="hljs-attribute">arg_depth </span>:<span class="hljs-built_in">default</span>(<span class="hljs-number">30</span>), base, simple)
        <span class="hljs-comment">/*
        if (bt != "") {
            warn(sprintf("JIT backtrace: %s\n", bt))
        }
        */</span>

        <span class="hljs-comment">/*
        if (vmstate == -3) {
            printf("HIT JIT GC: %s===\n", bt)
        }
        */</span>

    } <span class="hljs-selector-tag">else</span> {

        <span class="hljs-selector-tag">if</span> (vmstate == -<span class="hljs-number">1</span> &amp;&amp; !$*L-&gt;cframe) {
            <span class="hljs-selector-tag">return</span> ""
        }

        <span class="hljs-selector-tag">if</span> (vmstate == -<span class="hljs-number">1</span> || vmstate == -<span class="hljs-number">2</span> || vmstate == -<span class="hljs-number">3</span>) {
            <span class="hljs-selector-tag">base</span> = $*<span class="hljs-selector-tag">L-</span>&gt;<span class="hljs-selector-tag">base</span>
            <span class="hljs-selector-tag">bt</span> .= <span class="hljs-selector-tag">luajit_debug_dumpstack</span>(L, <span class="hljs-number">0</span>, $^arg_depth, base, simple)
        }
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">bt</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_vm_state</span>(g)
{
    <span class="hljs-selector-tag">return</span> $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">vmstate</span>
}


<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_find_gcstr</span>(g, str)
{
    <span class="hljs-selector-tag">len</span> = <span class="hljs-selector-tag">strlen</span>(str)
    <span class="hljs-selector-tag">strmask</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">strmask</span>
    <span class="hljs-selector-tag">strnum</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">strnum</span>
    <span class="hljs-selector-tag">strhash</span> = $*<span class="hljs-selector-tag">g-</span>&gt;<span class="hljs-selector-tag">strhash</span>
    $*<span class="hljs-selector-tag">strhash</span> := @<span class="hljs-selector-tag">cast</span>(strhash, <span class="hljs-string">"GCRef"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
    <span class="hljs-selector-tag">ret</span> = <span class="hljs-number">0</span>

    <span class="hljs-selector-tag">n</span> = <span class="hljs-number">0</span>
    <span class="hljs-selector-tag">done</span> = <span class="hljs-number">0</span>
    <span class="hljs-selector-tag">for</span> (i = <span class="hljs-number">0</span>; i &lt;= strmask; i++) {
        <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">strhash</span><span class="hljs-selector-attr">[i]</span>

        <span class="hljs-selector-tag">while</span> (p) {
            <span class="hljs-selector-tag">o</span> = <span class="hljs-selector-tag">luajit_gcref</span>(p)
            <span class="hljs-selector-tag">if</span> (o == <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">break</span>
            }

            $*<span class="hljs-selector-tag">o</span> := @<span class="hljs-selector-tag">cast</span>(o, <span class="hljs-string">"GCobj"</span>, <span class="hljs-string">"$^libluajit_path"</span>)
            <span class="hljs-selector-tag">if</span> ($*o-&gt;str-&gt;len == len) {
                <span class="hljs-selector-tag">gcs</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">str</span>
                <span class="hljs-selector-tag">s</span> = <span class="hljs-selector-tag">luajit_unbox_gcstr</span>(gcs)
                <span class="hljs-selector-tag">if</span> (s == str) {
                    <span class="hljs-selector-tag">done</span> = <span class="hljs-number">1</span>
                    <span class="hljs-selector-tag">ret</span> = <span class="hljs-selector-tag">gcs</span>
                    <span class="hljs-selector-tag">break</span>
                }
            }

            <span class="hljs-selector-tag">if</span> (++n == strnum) {
                <span class="hljs-selector-tag">done</span> = <span class="hljs-number">1</span>
                <span class="hljs-selector-tag">break</span>
            }

            <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gch-</span>&gt;<span class="hljs-selector-tag">nextgc</span>
        }

        <span class="hljs-selector-tag">if</span> (done) {
            <span class="hljs-selector-tag">break</span>
        }
    }

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ret</span>
}

<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">luajit_bucket_depth</span>(p)
{
    <span class="hljs-selector-tag">n</span> = <span class="hljs-number">0</span>
    <span class="hljs-selector-tag">while</span> (p) {
        $*o := @cast(o, "GCobj", "$^libluajit_path")
        o = luajit_gcref(p)
        if (o == 0) {
            break
        }

        <span class="hljs-selector-tag">n</span>++;
        <span class="hljs-selector-tag">p</span> = <span class="hljs-selector-tag">&amp;</span>$*<span class="hljs-selector-tag">o-</span>&gt;<span class="hljs-selector-tag">gch-</span>&gt;<span class="hljs-selector-tag">nextgc</span>
    }
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">n</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Frida如何稳定连接PC端跟Android手机端]]></title>    <link>https://juejin.cn/post/7577693903018377242</link>    <guid>https://juejin.cn/post/7577693903018377242</guid>    <pubDate>2025-11-29T14:39:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903018377242" data-draft-id="7577675494067863578" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Frida如何稳定连接PC端跟Android手机端"/> <meta itemprop="keywords" content="Android,Mac,Xposed"/> <meta itemprop="datePublished" content="2025-11-29T14:39:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YF0211"/> <meta itemprop="url" content="https://juejin.cn/user/2576910988619064"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Frida如何稳定连接PC端跟Android手机端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2576910988619064/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YF0211
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:39:08.000Z" title="Sat Nov 29 2025 14:39:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>必须把 frida-server 以 “zygote bypass 模式” 启动</strong></h2>
<p>正确的启动方式（稳定可用）</p>
<ol>
<li>把 frida-server 放到一个适合的目录：</li>
</ol>
<pre><code class="hljs language-perl" lang="perl">adb <span class="hljs-keyword">push</span> frida /data/<span class="hljs-keyword">local</span>/tmp/
adb shell
su
<span class="hljs-keyword">chmod</span> <span class="hljs-number">755</span> /data/<span class="hljs-keyword">local</span>/tmp/frida
</code></pre>
<ol start="2">
<li>使用 <code>--runtime=v8</code> 强制 V8 引擎模式（解决 ptrace 延时错误）</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">su -c <span class="hljs-string">"/data/local/tmp/frida --runtime=v8 -D"</span>
</code></pre>
<p><strong>必须加 <code>-D</code>（daemon 模式）</strong></p>
<ol start="3">
<li>禁用 seccomp（Pixel 5 必须）</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">setenforce <span class="hljs-number">0</span>
su -c <span class="hljs-string">"cmd task lock-profile 0"</span>
</code></pre>
<p>尽管已经是 Permissive，但依然有 <strong>seccomp filter</strong> 阻拦 ptrace，必须加上这个命令：
解锁 task profile（Pixel 系列特有）：</p>
<pre><code class="hljs language-arduino" lang="arduino">su -c <span class="hljs-string">"locksettings set-secure user_verified 1"</span>
</code></pre>
<ol start="4">
<li>不要 spawn，在 Android 14 会失败,正确 attach 方法：先启动 APP，再 attach.</li>
</ol>
<pre><code class="hljs language-css" lang="css">adb shell pidof com<span class="hljs-selector-class">.charmy</span><span class="hljs-selector-class">.cupist</span>
frida -U -<span class="hljs-selector-tag">p</span> &lt;PID&gt; <span class="hljs-attr">--runtime</span>=v8
</code></pre>
<p>若还失败，加：</p>
<pre><code class="hljs language-css" lang="css">frida -U -<span class="hljs-selector-tag">p</span> &lt;PID&gt; <span class="hljs-attr">--enable-jit</span> <span class="hljs-attr">--runtime</span>=v8
</code></pre>
<ol start="5">
<li>Pixel 5 / Android 14 专属补丁（最关键),Pixel 5 需要关闭 hardware-assisted ptrace restriction</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">adb shell su -c <span class="hljs-string">"echo 0 &gt; /proc/sys/kernel/yama/ptrace_scope"</span>

</code></pre>
<p>再检查：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/sys/kernel/yama/ptrace_scope
</code></pre>
<p>必须返回 <code>0</code></p>
<ol start="6">
<li>如果仍附加失败 → 使用 Riru / LSPosed 注入 FridaDex（效果最佳）,安装模块：</li>
</ol>
<pre><code class="hljs language-python" lang="python">frida-riru-<span class="hljs-number">17.</span>x.x.<span class="hljs-built_in">zip</span>
</code></pre>
<p>模块特点：</p>
<p>✔ 无需 frida-server<br/>
✔ 不走 ptrace<br/>
✔ Android 14 完全兼容<br/>
✔ APP 启动即注入</p>
<p>然后使用：</p>
<pre><code class="hljs">frida -U -n com.charmy.cupist
</code></pre>
<p>即可稳定注入。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transformer 的技术层面]]></title>    <link>https://juejin.cn/post/7577625663257772032</link>    <guid>https://juejin.cn/post/7577625663257772032</guid>    <pubDate>2025-11-29T11:46:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577625663257772032" data-draft-id="7577647745110179840" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transformer 的技术层面"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-29T11:46:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户480215170247"/> <meta itemprop="url" content="https://juejin.cn/user/2631551226224443"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transformer 的技术层面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2631551226224443/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户480215170247
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T11:46:20.000Z" title="Sat Nov 29 2025 11:46:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们已经知道，在大模型推理与训练过程中，所有数据的处理都以**向量（Vector）**形式进行。从整体来看，Transformer 会将整个上下文的信息不断融合进每一个 token 的隐藏状态中，而用于预测下一个词的，是 <strong>最后一个 token 经过多层注意力与 MLP 后的隐藏向量（hidden state）</strong> 。</p>
<p>下面我们从模型的入口开始——向量的形成（Embedding），再到核心的 Attention、MLP，最后到解码器，完整理解一句话是如何被“理解”并生成下一词的。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、编码层（Embedding + 位置编码）</strong></h2>
<p>当句子进入模型后，会被分割成一个一个的 <strong>token（词或子词）</strong> 。<br/>
这些 token 本质上是词表中的索引（例如 0~5w 的数字）。</p>
<p>Transformer 的“编码层”实际上不是 Encoder 模块，而是：</p>
<pre><code class="hljs language-css" lang="css">Token Embedding  
+ <span class="hljs-attribute">Position</span> Embedding / Encoding
</code></pre>
<p>例如 GPT-3 中，Embedding 会将每个 token 映射到一个 <strong>12288 维向量</strong>。同时，模型还会加入“位置编码”，让模型区分句子顺序（例如知道“你吃苹果” ≠ “苹果吃你”）。</p>
<p>此时的每个 token 只是一个独立向量，<strong>它还不知道上下文，也不知道左边是什么右边是什么</strong>。接下来就交给注意力机制。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、注意力机制（Attention）</strong></h2>
<p>经过 Embedding 后，每个 token 的向量都会并行地计算三种投影：</p>
<ul>
<li><strong>Q（Query）</strong> ：我在寻找什么信息？</li>
<li><strong>K（Key）</strong> ：别人如何根据我来判断是否应该关注我？</li>
<li><strong>V（Value）</strong> ：如果别人关注我，我愿意提供什么内容特征？</li>
</ul>
<p>这三者来自三组独立的矩阵：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">q</span> = xW_Q
<span class="hljs-attr">k</span> = xW_K
<span class="hljs-attr">v</span> = xW_V
</code></pre>
<p>Attention 的核心是：</p>
<blockquote>
<p><strong>Q 与 K 的相似度决定“关注的权重”，<br/>
V 决定“被拿走的内容”。</strong></p>
</blockquote>
<p>数学表现为：</p>
<p>αij=softmax(qi⋅kjdk)\alpha_{ij} = softmax\left(\frac{q_i \cdot k_j}{\sqrt{d_k}}\right)αij​=softmax(dk​​qi​⋅kj​​) outi=∑jαijvjout_i = \sum_j \alpha_{ij} v_jouti​=j∑​αij​vj​</p>
<p>这意味着：</p>
<ul>
<li>token <em>i</em> 会根据 Q 与所有 token 的 K 的相似度决定“看谁多，看谁少”；</li>
<li>得到的权重再与 V 加权求和，形成每个 token 融合上下文后的语义表示。</li>
</ul>
<p>因此，一个“苹果”会在上下文的帮助下从：</p>
<pre><code class="hljs">“苹果”
</code></pre>
<p>变成：</p>
<pre><code class="hljs">“被小朋友咬了一口的红富士苹果”
</code></pre>
<p>它获得了上下文赋予的语义补充。</p>
<hr/>
<h2 data-id="heading-2"><strong>三、多头注意力（Multi-Head Attention）</strong></h2>
<p>为了让模型从不同角度观察句子（如句法、语义、实体、关系等），Transformer 并不是只做一次 QKV，而是：</p>
<blockquote>
<p><strong>同一层内部使用多组（如 GPT-3 的 96 组）Q/K/V 并行计算注意力。</strong></p>
</blockquote>
<p>每一组叫做一个 <strong>head（注意力头）</strong> 。</p>
<p>流程：</p>
<pre><code class="hljs language-bash" lang="bash">输入向量 → 96 套 W_Q/W_K/W_V → 得到 96 套 q/k/v  
→ 96 次独立的 Attention  
→ concat 拼接  
→ 再线性融合回到原维度
</code></pre>
<p>你可以理解为：</p>
<blockquote>
<p><strong>多头注意力 = 单层内部的 96 个“不同视角”同时读懂一句话。</strong></p>
</blockquote>
<p>但这一整套操作仍然被视为 <strong>一次 Attention 层</strong>。</p>
<hr/>
<h2 data-id="heading-3"><strong>四、MLP（前馈网络 / 多层感知机）</strong></h2>
<p>Attention 让 token 得到了上下文信息，但语义仍需要进一步非线性变换与特征组合——这正是 MLP 的作用。</p>
<p>一句话总结：</p>
<blockquote>
<p><strong>Attention 负责“信息流动与上下文理解”，<br/>
MLP 负责“特征增强、非线性表达与高阶抽象”。</strong></p>
</blockquote>
<p>例如：</p>
<ul>
<li>“塔” 经过 Attention 后知道上下文指的是“埃菲尔铁塔”；</li>
<li>MLP 会进一步加强它的特征，如“铁做的、高、有结构特征”等。</li>
</ul>
<p>MLP 结构通常是：</p>
<pre><code class="hljs">d_model → d_ff（扩大数倍）→ d_model
</code></pre>
<p>通过两次线性变换 + 激活函数（如 GELU），使 token 的语义表达更丰富。</p>
<hr/>
<h2 data-id="heading-4"><strong>五、多层 Transformer（Layer Stack）</strong></h2>
<p>Transformer 的基本结构单元是 <strong>一个 block</strong>：</p>
<pre><code class="hljs">（1）多头注意力  
（2）残差 + LayerNorm  
（3）MLP  
（4）残差 + LayerNorm
</code></pre>
<p>GPT-3 175B 具有 <strong>96 层</strong>这样的 block，层层堆叠，每一层都使 token 的隐藏状态更抽象、更全局、更高阶。</p>
<p>因此：</p>
<blockquote>
<p><strong>多头 = 同一层内部的横向并行<br/>
多层 = 模型纵向的深度堆叠</strong></p>
</blockquote>
<p>两者不是一回事。</p>
<hr/>
<h2 data-id="heading-5"><strong>六、解码器（线性层 + Softmax）</strong></h2>
<p>Transformer 最终会使用“最后一个 token 的隐藏状态”来预测下一词。</p>
<p>流程：</p>
<ol>
<li><strong>线性层（Linear）</strong><br/>
将 hidden state（如 12288 维）映射到词表维度（如 50k 维），得到 logits（生猛分数）。</li>
<li><strong>Softmax</strong><br/>
把 logits 转成概率分布，表示每个词作为下一 token 的可能性。</li>
</ol>
<p>最终：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">P</span>(苹果) = <span class="hljs-number">0.72</span>  
<span class="hljs-selector-tag">P</span>(香蕉) = <span class="hljs-number">0.10</span>  
<span class="hljs-selector-tag">P</span>(葡萄) = <span class="hljs-number">0.05</span>  
...
</code></pre>
<p>之后由推理策略（greedy/top-k/top-p 等）选择下一词。</p>
<hr/>
<h2 data-id="heading-6"><strong>七、最终总结</strong></h2>
<p>Transformer 的完整流程可以总结为：</p>
<ol>
<li>文本 → token → Embedding + 位置编码</li>
<li>多头注意力让每个 token 与所有其他 token 交换信息</li>
<li>MLP 进一步抽象特征</li>
<li>多层 block 堆叠形成深度理解</li>
<li>最后一个 token 的隐藏状态经线性层 + softmax 得到下一词概率</li>
<li>推理策略选出下一个 token</li>
</ol>
<p>这就是 Transformer 结构的核心逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小白也能看懂! 今年爆火的 MCP 协议究竟是什么？写给普通人的 MCP 指南]]></title>    <link>https://juejin.cn/post/7577971299742466086</link>    <guid>https://juejin.cn/post/7577971299742466086</guid>    <pubDate>2025-11-30T03:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577971299742466086" data-draft-id="7577689171223265330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小白也能看懂! 今年爆火的 MCP 协议究竟是什么？写给普通人的 MCP 指南"/> <meta itemprop="keywords" content="MCP,AIGC,后端"/> <meta itemprop="datePublished" content="2025-11-30T03:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="韩数"/> <meta itemprop="url" content="https://juejin.cn/user/2788017218794462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小白也能看懂! 今年爆火的 MCP 协议究竟是什么？写给普通人的 MCP 指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017218794462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    韩数
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:20:09.000Z" title="Sun Nov 30 2025 03:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是韩数同学。致力于分享 Github 上那些  好玩  有趣  免费  实用  的高质量项目。</p>
<p>我们关注这个世界上那些新奇的开源项目，作为开源技术博主，我们也很想带你去了解那些技术背后的事情, 今天是我们 AIGC 首篇文章, 关于 MCP 协议。</p>
<h4 data-id="heading-0">为什么我们需要 MCP</h4>
<p>在了解什么是 MCP 之前,  我们需要先最基础的了解下大模型，也就是我们通常所提的 LLM. LLM 的概念到今天已经完全不再陌生,  首先大语言模型主要的特点则在于它使用过去的数据训练而成,  因此未开启联网能力下的大语言模型的知识则停留在训练他的数据那一刻，我们可以写一个例子简单证明这一点:</p>
<p>例如我们可以问大模型一个简单的问题: 请帮我生成一个 json 数据，使用最新的日期</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bca56b4743041878f7272afa6e8f8fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=ejnx%2FwQhc7KSxDZvJRHSQkxxYAo%3D" alt="image.png" loading="lazy"/></p>
<p>因此这就意味着一个明显的问题，那就是大语言模型的局限性，试想人类如何获取新知识？</p>
<p>我们可以上搜索引擎查网页,  去图书馆查阅相关数据，还可以缠着朋友问，我们依靠主动与世界交互而获取新知识，而单纯靠大模型本身很难做到这一点。</p>
<p>知识的局限性和缺乏和与用户电脑进行真实交互极大的制约了大语言模型的能力。</p>
<h4 data-id="heading-1">Function Calling 和 Tool </h4>
<p>而为了解决这个问题，各个大模型服务商提出了 Function Calling 和 Tool 概念， Function Calling  为 OpenAI 模型提供了一种强大且灵活的方式，使其能够与外部系统进行交互，并访问其训练数据之外的数据。Tool 则是由 OpenAI 已经内置托管的一系列 Function Calling,  例如联网搜索，生成图像，解析文件等等等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ce0c22a222741c09ffa49c9a1a47808~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=WMw8F%2B18ennW%2BgjfCc8K1RCW92E%3D" alt="Image" loading="lazy"/></p>
<p>例如当我们需要问大模型当前的天气如何时，我们需要定义这样一个 Function Calling  并注册到 大模型 的上下文中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e9b37ad331644a2adaa350d7010aca8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=qCh7QlHTwgcDG1IBXHupBZbELV4%3D" alt="Image" loading="lazy"/></p>
<p>此时的 Function Calling 注意它的 parameters 部分已经和 MCP 的协议非常像了，这部分基本上是从 Openapi 的协议演变而来的。</p>
<p>调用过程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46f1647cc614f63b72a7407a490bb7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=vhwbNcHfGNkjcuutxrnUqOfzxgg%3D" alt="Image" loading="lazy"/></p>
<h3 data-id="heading-2">Function Calling  执行流程:</h3>
<ol>
<li>Code：将function描述和要求发送给LLM</li>
<li>LLM：LLM来确定是直接给答复，还是需要调用 function</li>
<li>LLM：如何要调用function，则返回需要调用的 function 以及调用 function 所需要的参数</li>
<li>Code：程序收到 LLM 返回后，根据 LLM 的返回信息，执行 function</li>
<li>Code：将 function 执行后得到的结果，以及 prompt 提示词发送给 LLM</li>
<li>LLM：LLM 产生最终回答</li>
</ol>
<p>当我们只需要解决类似于查天气这类比较特定的场景时，使用 Function Calling 是非常合适的，但是当我们需要大量 Function Calling 时，意味着我们则需要为每一个功能项都实现对应的调用函数, 比较麻烦，第二个不同的大模型的 Function Calling 的协议可能还不一样。<strong>因此我们需要一种协议，可以将各种数据源或者操作以服务的方式使用统一的协议从外部集成到大模型的工具中供大模型调用，从而增强大模型的能力，为大模型安装能与聊天框之外进行实际交互的触手</strong></p>
<h4 data-id="heading-3">MCP 协议</h4>
<p>在这样的一个背景下,  2024 年 11 月 25 日,  Anthropic 发布了一篇文章,  正式提出了 Model Context Protocol 模型上下文协议,  也就是我们所熟知的 MCP,  并同步推出了相关的 SDK 套件,  Claude 客户端针对 MCP 的支持,  MCP 相关的开源仓库。发布即可用，站在今天的角度回看这篇不到千字的博客，很难不认为这是一次蓄谋已久的针对 OpenAPI 的突然袭击。</p>
<p>在这篇文章中,  Anthropic 提出了关于 MCP 的最初构想,  MCP 解决了 Function Calling 引发的扩展困难，协议混乱这一挑战。它提供了一个通用的开放标准，就像电脑是 IO 接口与 USB 标准一样。用于连接 AI 系统与数据源，用单一协议替代分散的集成。结果是为AI系统提供所需数据访问的更简单、更可靠的方式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b1a1f7df584f1e978abf89a2c41e8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=SL6CfZNZSiHhBWWcQrOSZG8bOZY%3D" alt="image.png" loading="lazy"/></p>
<p>有了 MCP 之后，大模型可以以统一的方式读懂来自四面八方的数据操作了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c5839fc790d4b1d8434d6160b7ced35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=p57UOAIH67OrzcsP%2FHi3MOd%2Bqxc%3D" alt="image.png" loading="lazy"/></p>
<p>2025 年，<strong>随着越来越多的公司和开发者针对 MCP 协议达成共识，MCP 成为了大模型与第三方数据源集成的事实标准。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/387c6159538d4f268c252697f81ae246~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=4m8gvqQQOk78Vs7l4ogL%2Fhc%2FCKw%3D" alt="image.png" loading="lazy"/></p>
<p>就像上面那张图所示的，在 MCP 出现之前，大模型是一个没有四肢只有嘴巴的人类，所有的一切知识需要人工整理好之后一点点喂进去嘴巴里面。想象一下，在 MCP 出现之前，我们想让大模型帮我们做一些需要外部数据源的事情时，<strong>例如分析公司最近一个月的营收信息</strong> 这样的需求时，我们要如何做？自己从公司的数据库中拉取信息，整理成对 llm 友好的格式例如 csv 或者 json。然后把数据粘贴进大模型冰冷的聊天框，搭配自己精心准备的 prompt，然后交给大模型去分析。<strong>这和嚼碎了喂饭没有本质上的区别</strong>，这时候当另外一个人也有类似的需求的时候时，你会发现他也需要这么从头来一遍。而 MCP 的出现则很好的解决了这个问题:</p>
<ol>
<li>协议的一致性可以保证不管是 deepseek和 claude 调用 mcp 时可以保证一致的行为。</li>
<li>MCP 的能力可以共享了，平台方例如 jira 或者 slack 可以封装成 MCP 插件，所有需要调用 jira 或者 slack 的人无需二次开发，可以实现开箱即用。</li>
<li>数据安全，如果你需要大模型读取内部数据，你可以实现自己的 MCP server 并决定返回哪些数据。</li>
</ol>
<h4 data-id="heading-4">MCP 协议组成部分</h4>
<p>MCP 主要有以下三部分组成，分别是客户端(Client),  主机(Host) 和 服务器(Server).  这里的主机可以理解为发起请求的 LLM 程序，比如 大模型桌面端。每个 host 可以运行多个连接(client)。每个 client 都可以连多个 MCP 服务，client 使用 Rpc 的方式与服务端通信。例如deepseek 可以同时安装 slack 和 jira, github 等多个 MCP server。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37433993a93f4e24b4c6765c183d9306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z-p5pWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765077609&amp;x-signature=pM0%2BQzcyFNpWbpEAtEhxWzb3C1s%3D" alt="image.png" loading="lazy"/></p>
<p>MCP Client 与 Server 保持一对一的连接,   当我们向大模型提问时:</p>
<ol>
<li><strong>MCP Client 会先从 Mcp server 获取所有可用的 MCP Server 提供的 tool 列表, 然后一并交给大模型。</strong></li>
<li><strong>大模型会根据上下文决定是否使用工具， 如果需要执行工具，则会生成对应的调用询问用户是否执行该 tool,用户确认过之后（询问这部不同的客户端的行为可能不一样), MCP Client 带着参数执行对应 tool 所属的 Mcp Server 的调用。</strong></li>
<li><strong>MCP Client 将 MCP server 调用的返回结果发送回  llm.</strong></li>
<li><strong>LLM 基于上下文以及 MCP Server 调用的结果生成回复。</strong></li>
</ol>
<p>除了 MCP client，另外一个核心的组件就是 MCP server 了。MCP server 可以是远程服务器，也可以是本地在 docker 中运行的服务，但是他们提供的作用都是一样的，以 api 的方式提供能够实际执行的操作。MCP server 主要有三部分构成</p>
<ul>
<li>资源: 可以是文档或者 api 返回信息等。</li>
<li>工具: 实际可以执行的操作，例如调用查询数据。</li>
<li>提示, 预先编写的 prompt，比如你提供一个生成 ppt 的 mcp prompt</li>
</ul>
<p>MCP 的出现确实弥补了传统的 function calling 的不足，但是现阶段的 MCP 并不能算是完美的，仍然还有许多问题需要解决。1.  #### token 的消耗问题，这应该是最轻的一个问题了，当我们向 llm 提问时，llm 始终会去加载所有的 mcp tool 去判断是否调用 mcp 工具。如果我们注册了过多的 mcp server，则会加剧 token 的消耗。同时如果多个 mcp server 存在功能相似 tool,  这些 tool 的描述写的也大差不差，这个时候 agent 判断调用哪个 mcp server 的 tool 的准确性就会受到很大的影响。</p>
<ol>
<li>安全风险,  如果一个非法的 mcp server 提供了 某些和 jira 类似的 tool, 就有可能造成 mcp 名称冲突攻击，即将一些可能包含敏感信息的参数发送给相似的确实错误的 mcp server 上。同时由于目前 mcp server 缺乏统一的认证体系，因此从一些第三方网站安装的 mcp server 可能存在恶意程序。等等等等</li>
<li>缺乏统一的认证体系和细粒度的权限控制。不同的 mcp server 的认证方式可能完全不同, 有的使用环境变量注入 api_key 有的使用 oatuh 等等。</li>
<li>基于 jsonrcp 的协议无法处理文件上传这种复杂的操作。</li>
<li>潜在的性能问题,  由于 mcp 连接远程 MCP 只支持 SSE 协议,  但是由于 SSE 是一个长链接服务，因此对于高性能高并发的场景并不是十分友好</li>
</ol>
<h4 data-id="heading-5">总结</h4>
<p>关于 MCP Server 的开发，如果你之前已经接触过后端开发，那么开发一个 MCP Server 对于来说并不是一项难事, 无非是提供另外一种样式的接口罢了 MCP 并不是技术上非常高大上的东西，但确实是人工智能时代发展过程中的必然产物。现阶段的 MCP 协议仍然称不上完美,  仍然有许多需要完善的地方,  但是无法否认的是，MCP 的出现确实为 AI 增加了四肢,  将我们带向了更远的地方，使得更多的事情变得可能。</p>
<h4 data-id="heading-6">介绍下我自己</h4>
<p>我是韩数同学，技术博主&amp;开源博主，如果你想要知道这个世界上有哪些 好玩,有趣,免费,实用 的开源项目，欢迎在绿泡泡或者红泡泡搜索我们。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌AI模型Gemini 3.0 Pro，已经杀疯了！]]></title>    <link>https://juejin.cn/post/7577718777481363494</link>    <guid>https://juejin.cn/post/7577718777481363494</guid>    <pubDate>2025-11-29T14:16:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777481363494" data-draft-id="7577705544874852390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌AI模型Gemini 3.0 Pro，已经杀疯了！"/> <meta itemprop="keywords" content="人工智能,Gemini,AIGC"/> <meta itemprop="datePublished" content="2025-11-29T14:16:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小灰"/> <meta itemprop="url" content="https://juejin.cn/user/2137106333828663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌AI模型Gemini 3.0 Pro，已经杀疯了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106333828663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小灰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T14:16:01.000Z" title="Sat Nov 29 2025 14:16:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员小灰。</p>
<p>2025年11月18日，谷歌公司推出了他们最新版本的大模型——Gemini3.0 pro。</p>
<p>最近小灰也体验了一下Gemini3.0 pro，对于这个当今公认最强的AI模型，我的心中唯有震撼。（后文简称Gemini3）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bd401e498c9449288df2362587d756f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=q6HE9DO%2FEpwjBw%2FqpwCGpXwUg90%3D" alt="" loading="lazy"/></p>
<p><strong>Gemini3有多强？</strong></p>
<p>国外有一个权威的AI模型能力排行网站，名为大众竞技场（LMSYS Chatbot Arena）。</p>
<p>在这个网站里，所有主流的AI大模型都会两两分组进行对战，通过双盲测试的方式让用户判断大模型的能力强弱，比拼的维度包含通用能力、代码能力、解决难题能力、多模态能力等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef78977746694ce8aeb52df6b9939cd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=Ykr2CeG7XHeTyF%2BYtmn97ybBIMY%3D" alt="" loading="lazy"/></p>
<p>当Gemini3问世的那一刻，它在所有的排行榜上都遥遥领先，让近期发布的GPT-5 pro和Grox 4.1都黯然失色。</p>
<p><strong>通用能力排行榜：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/497c7a83acd84970aba8e8dffc1ddcd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=UTKiVNKS07TaI%2BrDX4s8JrQDhwM%3D" alt="" loading="lazy"/></p>
<p><strong>代码能力排行榜：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5890e9afeec249a89c5fbf45c839826c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=iUD%2F70GPhDgsfebe16%2BkMNVDbno%3D" alt="" loading="lazy"/></p>
<p><strong>解决难题能力排行榜：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27d92f0cec0496f82645f924da6d9d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=2Y7Qt7Y2r5SY0%2FRxqVn3%2FWCAR%2BU%3D" alt="" loading="lazy"/></p>
<p>Gemini3在大众竞技场的成绩仅仅是冰山一角，这个强大的模型在BenchMark等基准测试平台的表现同样亮眼，由于篇幅原因，小灰这里就不过多赘述了。</p>
<p><strong>怎样免费使用Gemini3</strong></p>
<p>既然Gemini3模型如此强大，我们从哪里能免费使用它呢？小灰在此推荐三个免费入口。</p>
<p>第一个推荐的是<strong>Gemini官网</strong>，入口如下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2F" target="_blank" title="https://gemini.google.com/" ref="nofollow noopener noreferrer">gemini.google.com/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70fd7366e8a043dfb2deb6b361a57249~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=xg5Lxb3ydF%2FmINh3oIxZxGqXfPU%3D" alt="" loading="lazy"/></p>
<p>在Gemini官网的对话框右下角可以选择模型，选定“思考（3 Pro）”这一项，就可以使用Gemini3版本了。不过免费会员每天只有5次左右的试用额度。</p>
<p>第二个推荐的是<strong>Google AI Studio</strong>，入口如下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2F" target="_blank" title="https://aistudio.google.com/" ref="nofollow noopener noreferrer">aistudio.google.com/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e777ed6798334cae9fb629c470324a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=RzYZxXxBbkBkyAZaXdvnBej1eIw%3D" alt="" loading="lazy"/></p>
<p>在网站首页点击“Try Gemini3”选项，同样可以免费使用Gemini3。<strong>Google AI Studio也存在</strong>一定的使用频次限制，但是比官网要宽松一些，大约每天可用50次左右。</p>
<p>第三个推荐的是<strong>LMSYS Chatbot Arena，也就是刚才我们提到的大众竞技场，入口如下：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flmarena.ai%2F" target="_blank" title="https://lmarena.ai/" ref="nofollow noopener noreferrer">lmarena.ai/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba11e67e87164a05bc47030c273ed7fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=zBuqf%2BqYj0EQvoZrt9BD2%2BOX8Lc%3D" alt="" loading="lazy"/></p>
<p>把LMArena首页的模式设置为“Direct Chat”（直接聊天），大模型选择gemini-3-pro，即可开启免费的使用。</p>
<p>在这里使用Gemini3虽然没有次数限制，但会有一定的速率限制，有可能需要排队。</p>
<p><strong>Gemini3的实操体验</strong></p>
<p>说完了免费试用Gemini3的几种途径，接下来我们进入实操环节，切切实实体验一把Gemini3模型的强大。</p>
<p>如何具体展现出Gemini3模型的强大之处呢？我们不妨尝试让Gemini3为我们生成一款有趣的小游戏。</p>
<p>魂斗罗这款游戏，可以说是伴随着80后和90后的朋友一起长大的，小灰也同样是魂斗罗系列游戏的重度爱好者。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76800e86ce8548b2b8340401475cf04e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=Vfl1Dn7OkkrrlQoH5kFKJPvIuAs%3D" alt="" loading="lazy"/></p>
<p>下面我们尝试用一句提示词，让Gemini 3为我们生成一个网页版的魂斗罗小游戏。</p>
<p>首先把Gemini的工具选项当中找到Canvas，这是Gemini的核心功能之一，专门用于处理长篇写作和编程任务：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f54f779de44c84a9dc747f43741802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=%2FWu58knRRAxg5yljBw24L8zuj4Q%3D" alt="" loading="lazy"/></p>
<p>我们的提示词如下：</p>
<p>编写一个魂斗罗游戏，带有boss战，有至少两个关卡。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/279fc24145e34b14a0011d94a2407520~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=YWF1LAyRz5ULjipHB%2BIbGU5e%2FGs%3D" alt="" loading="lazy"/></p>
<p>从视频中可以看到，Gemini3很快就为我们生成了一套Html5游戏代码，接下来让我们进行第一次测试：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17baac48d6254a58a8df116e1d81ebe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=H99%2FpqqFbjxLRaEWXhEdgunvNeM%3D" alt="" loading="lazy"/></p>
<p>啊这......不得不说，Gemini3偶尔也有翻车的时候。没关系，我们让模型重新来生成：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f21c3f1b9c7439da29073643a4d8b62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=GqHZbON5B6CWPIYyIL0pygHfPkE%3D" alt="" loading="lazy"/></p>
<p>这一回游戏总算可以正常运行了。在没有任何美工资源的情况下，Gemini3能为我们做到这种程度，已经相当不错了。</p>
<p>不过游戏中存在两处bug，其中一处bug是关卡中存在一条很长的沟壑，无法进行跳跃；另一处bug是击败boss之后，游戏流程就此卡住了。</p>
<p>我们让模型修改这两处bug：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44ac08510c0241b794654cd68ce69ee4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=D3EW50hOmNkhql0dzgPPOMpSXSE%3D" alt="" loading="lazy"/></p>
<p>可以看到，游戏中的两处bug已经修改。但我一开始想让游戏包含至少两个关卡，目前却只有一关。</p>
<p>接下来，我们让AI继续修改游戏代码，增加一个关卡：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42c6cbbc27d5462dad50a2ce07dd5c7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=Zx5XPkLDmktXnhGz%2BiLXXSv1xPc%3D" alt="" loading="lazy"/></p>
<p>现在两个关卡确实有了，但游戏里只有3条命，第二关总是过不去。</p>
<p>怎么办呢？很简单，我们来把游戏改为30条命即可：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78aa0ee7e63e48558cb9650d1769aa0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=fwf7pyxoaGTWQahphQE0HzE9bJM%3D" alt="" loading="lazy"/></p>
<p>终于，第二关boss也被我们战胜了，游戏完美通关。</p>
<p>不过这还不是我们的终点。为了充分展现Gemini3的能力，我们来尝试把这款游戏改为一款3D游戏：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d168f62c0444c7ea99fe9f4766d7f1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=955jYjeZ5%2FYhYqOgTuGQ0sPAzbs%3D" alt="" loading="lazy"/></p>
<p>从视频可以看出，游戏的场景和角色都已经3D化了。尽管有些细节还不太完善，但只要我们愿意，多进行几轮对话就可以把所有的细节做得更加完善。</p>
<p>好了，用Gemini3开发魂斗罗小游戏的过程，我们就展示到这里。没有复杂的提示词，没有美工资源，仅仅是几轮简单的对话，Gemini3就为我们生成了这样一款完成度较高的游戏，这样的代码能力不可谓不惊艳。</p>
<p>如果大家有兴趣，可以尽情发挥想象力，用Gemini3做出更多有趣又酷炫的项目。</p>
<p><strong>写在最后</strong></p>
<p>记得2023年，GPT-4模型刚刚上线的时候，我曾经用GPT-4生成了一款简单的飞行射击游戏。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bee3ca423df84e19bb66798fa12e6be6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP54Gw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765030560&amp;x-signature=SJOPRUTcx9%2FHXkbw%2BMZ5XkHKqVo%3D" alt="" loading="lazy"/></p>
<p>尽管当时的生成过程非常麻烦，生成的结果也很粗糙，但当时的我还是被AI的能力深深吸引了。</p>
<p>没想到仅仅是两年半的时间，AI模型已经取得了如此大的进步，Gemini3跟当年GPT-4之间的差距，简直像是成年人与小孩子之间的差距。</p>
<p>在这个技术飞速进步的时代，小灰感受到的唯有震撼。</p>
<p>希望在2026年，我们可以看到更加丰富、更加强大的AI模型和AI应用，小灰也热切期望着为大家分享更多有趣又有用的AI玩法。</p>
<p>大家有哪些想要了解的AI产品和项目？欢迎把你的想法打在留言区。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【URP】Unity[内置Shader]非光照Unlit]]></title>    <link>https://juejin.cn/post/7577689171223314482</link>    <guid>https://juejin.cn/post/7577689171223314482</guid>    <pubDate>2025-11-30T03:38:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171223314482" data-draft-id="7577971299742482470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【URP】Unity[内置Shader]非光照Unlit"/> <meta itemprop="keywords" content="游戏开发,Unity3D,图形学"/> <meta itemprop="datePublished" content="2025-11-30T03:38:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【URP】Unity[内置Shader]非光照Unlit
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:38:42.000Z" title="Sun Nov 30 2025 03:38:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>URP内置Unlit Shader的作用与原理</strong></h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.unity.cn%2Fcn%2FPackages-cn%2Fcom.unity.render-pipelines.universal%4014.1%2Fmanual%2Funlit-shader.html" target="_blank" title="https://docs.unity.cn/cn/Packages-cn/com.unity.render-pipelines.universal@14.1/manual/unlit-shader.html" ref="nofollow noopener noreferrer">Unlit Shader</a>是Unity通用渲染管线(URP)中的基础着色器，主要用于渲染不受光照影响的物体。其核心原理是通过直接采样纹理或颜色值输出到屏幕，跳过了复杂的光照计算流程。这种着色器特别适合UI元素、粒子特效、全息投影等需要保持恒定亮度的场景，因为它的渲染结果不会随光照环境变化而改变。</p>
<p>在URP架构中，Unlit Shader通过ShaderLab语法定义，内部使用HLSL编写核心逻辑。与Built-in管线相比，URP版本优化了渲染流程，包含三个关键Pass：主绘制Pass、深度Only Pass和元数据Pass（用于光照烘焙）。其核心特点是：</p>
<ul>
<li>无光照计算：直接输出Albedo颜色或纹理采样结果</li>
<li>支持Alpha混合：可实现透明效果</li>
<li>移动端优化：减少了GPU指令数量</li>
</ul>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.render-pipelines.universal@14.1/manual/images/Inspectors/Shaders/Unlit.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>发展历史演变</strong></h2>
<p>Unlit Shader随着Unity渲染管线的演进经历了三个阶段：</p>
<ul>
<li>‌<strong>Built-in管线时期</strong>‌（2012-2018）：最初作为简单着色器出现在标准资源包中，使用CG语言编写，功能较为基础</li>
<li>‌<strong>LWRP过渡期</strong>‌（2018-2020）：轻量级渲染管线中首次针对移动平台优化，引入HLSL替代CG</li>
<li>‌<strong>URP成熟期</strong>‌（2020至今）：成为Universal RP的核心组件，支持Shader Graph可视化编程，并优化了多Pass协作机制</li>
</ul>
<h2 data-id="heading-2"><strong>具体使用示例</strong></h2>
<p>创建Unlit材质的基本步骤：</p>
<ul>
<li>在Project窗口右键创建Material</li>
<li>材质Inspector中选择Shader路径："Universal Render Pipeline/Unlit"</li>
<li>配置基础属性：
<ul>
<li>‌<strong>Base Map</strong>‌：主纹理贴图</li>
<li>‌<strong>Base Color</strong>‌：色调叠加</li>
<li>‌<strong>Alpha</strong>‌：透明度控制</li>
</ul>
</li>
</ul>
<p>代码说明：</p>
<ul>
<li>
<p>定义包含纹理和颜色属性的基础Unlit Shader</p>
</li>
<li>
<p>使用URP核心库中的TransformObjectToHClip方法进行坐标转换</p>
</li>
<li>
<p>片元着色器直接返回纹理采样结果与颜色的乘积</p>
</li>
<li>
<p>UnlitExample.shader</p>
<pre><code class="hljs language-c" lang="c">Shader <span class="hljs-string">"Custom/UnlitTexture"</span>
{
    Properties {
        _MainTex (<span class="hljs-string">"Texture"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> {}
        _Color (<span class="hljs-string">"Color"</span>, Color) = (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
    }
    SubShader {
        Tags { <span class="hljs-string">"RenderType"</span>=<span class="hljs-string">"Opaque"</span> }
        Pass {
            HLSLPROGRAM
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> vertex vert</span>
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> fragment frag</span>
            <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>

            <span class="hljs-keyword">struct</span> Attributes {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };

            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Varyings</span> {</span>
                float4 positionCS : SV_POSITION;
                float2 uv : TEXCOORD0;
            };

            sampler2D _MainTex;
            float4 _Color;

            Varyings <span class="hljs-title function_">vert</span><span class="hljs-params">(Attributes IN)</span> {
                Varyings OUT;
                OUT.positionCS = TransformObjectToHClip(IN.positionOS.xyz);
                OUT.uv = IN.uv;
                <span class="hljs-keyword">return</span> OUT;
            }

            half4 <span class="hljs-title function_">frag</span><span class="hljs-params">(Varyings IN)</span> : SV_Target {
                <span class="hljs-keyword">return</span> tex2D(_MainTex, IN.uv) * _Color;
            }
            ENDHLSL
        }
    }
}
</code></pre>
</li>
<li>
<p>UnlitGraph.shadergraph</p>
<pre><code class="hljs language-c" lang="c">{
    <span class="hljs-string">"m_Nodes"</span>: [
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"d4f5e3c7-1a2d-4b8f-a3e1-6c9b8d2e1f0a"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.Texture2DNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">-208</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">-16</span> },
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ],
            <span class="hljs-string">"m_Texture"</span>: { <span class="hljs-string">"m_DefaultValue"</span>: {} }
        },
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.ColorNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">-200</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">100</span> },
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ],
            <span class="hljs-string">"m_Color"</span>: { <span class="hljs-string">"r"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"g"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span> }
        },
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.MultiplyNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span> },
            <span class="hljs-string">"m_Inputs"</span>: [
                { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"a"</span>, <span class="hljs-string">"m_SlotId"</span>: <span class="hljs-number">0</span> },
                { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"b"</span>, <span class="hljs-string">"m_SlotId"</span>: <span class="hljs-number">1</span> }
            ],
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ]
        }
    ],
    <span class="hljs-string">"m_Edges"</span>: [
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-string">"d4f5e3c7-1a2d-4b8f-a3e1-6c9b8d2e1f0a.out"</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.a"</span> },
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6.out"</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.b"</span> }
    ]
}
</code></pre>
</li>
</ul>
<h2 data-id="heading-3"><strong>Shader Graph应用示例</strong></h2>
<p>在Shader Graph中创建Unlit效果的步骤：</p>
<ul>
<li>创建新的Shader Graph文件（右键 &gt; Create &gt; Shader &gt; Universal Render Pipeline &gt; Unlit Shader Graph）</li>
<li>核心节点配置：
<ul>
<li>添加‌<strong>Sample Texture 2D</strong>‌节点作为基础纹理输入</li>
<li>连接‌<strong>Color</strong>‌参数节点实现色调控制</li>
<li>使用‌<strong>Multiply</strong>‌节点混合纹理和颜色</li>
</ul>
</li>
<li>高级功能扩展：
<ul>
<li>添加‌<strong>Time</strong>‌节点驱动UV动画</li>
<li>通过‌<strong>Vertex Position</strong>‌节点实现顶点变形</li>
</ul>
</li>
</ul>
<p>代码说明：</p>
<ul>
<li>
<p>构建包含纹理采样和颜色混合的基础Unlit着色器</p>
</li>
<li>
<p>通过节点连接实现材质属性的可视化编辑</p>
</li>
<li>
<p>可扩展添加UV滚动、顶点动画等高级效果</p>
</li>
<li>
<p>UnlitExample.shader</p>
<pre><code class="hljs language-c" lang="c">Shader <span class="hljs-string">"Custom/UnlitTexture"</span>
{
    Properties {
        _MainTex (<span class="hljs-string">"Texture"</span>, <span class="hljs-number">2</span>D) = <span class="hljs-string">"white"</span> {}
        _Color (<span class="hljs-string">"Color"</span>, Color) = (<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
    }
    SubShader {
        Tags { <span class="hljs-string">"RenderType"</span>=<span class="hljs-string">"Opaque"</span> }
        Pass {
            HLSLPROGRAM
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> vertex vert</span>
            <span class="hljs-meta">#<span class="hljs-keyword">pragma</span> fragment frag</span>
            <span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>

            <span class="hljs-keyword">struct</span> Attributes {
                float4 positionOS : POSITION;
                float2 uv : TEXCOORD0;
            };

            <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Varyings</span> {</span>
                float4 positionCS : SV_POSITION;
                float2 uv : TEXCOORD0;
            };

            sampler2D _MainTex;
            float4 _Color;

            Varyings <span class="hljs-title function_">vert</span><span class="hljs-params">(Attributes IN)</span> {
                Varyings OUT;
                OUT.positionCS = TransformObjectToHClip(IN.positionOS.xyz);
                OUT.uv = IN.uv;
                <span class="hljs-keyword">return</span> OUT;
            }

            half4 <span class="hljs-title function_">frag</span><span class="hljs-params">(Varyings IN)</span> : SV_Target {
                <span class="hljs-keyword">return</span> tex2D(_MainTex, IN.uv) * _Color;
            }
            ENDHLSL
        }
    }
}
</code></pre>
</li>
<li>
<p>UnlitGraph.shadergraph</p>
<pre><code class="hljs language-c" lang="c">{
    <span class="hljs-string">"m_Nodes"</span>: [
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"d4f5e3c7-1a2d-4b8f-a3e1-6c9b8d2e1f0a"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.Texture2DNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">-208</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">-16</span> },
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ],
            <span class="hljs-string">"m_Texture"</span>: { <span class="hljs-string">"m_DefaultValue"</span>: {} }
        },
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.ColorNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">-200</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">100</span> },
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ],
            <span class="hljs-string">"m_Color"</span>: { <span class="hljs-string">"r"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"g"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span> }
        },
        {
            <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7"</span>,
            <span class="hljs-string">"m_Type"</span>: <span class="hljs-string">"UnityEditor.ShaderGraph.MultiplyNode"</span>,
            <span class="hljs-string">"m_Position"</span>: { <span class="hljs-string">"x"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"y"</span>: <span class="hljs-number">0</span> },
            <span class="hljs-string">"m_Inputs"</span>: [
                { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"a"</span>, <span class="hljs-string">"m_SlotId"</span>: <span class="hljs-number">0</span> },
                { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"b"</span>, <span class="hljs-string">"m_SlotId"</span>: <span class="hljs-number">1</span> }
            ],
            <span class="hljs-string">"m_Outputs"</span>: [ { <span class="hljs-string">"m_Id"</span>: <span class="hljs-string">"out"</span> } ]
        }
    ],
    <span class="hljs-string">"m_Edges"</span>: [
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-string">"d4f5e3c7-1a2d-4b8f-a3e1-6c9b8d2e1f0a.out"</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.a"</span> },
        { <span class="hljs-string">"m_OutputSlot"</span>: <span class="hljs-string">"a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6.out"</span>, <span class="hljs-string">"m_InputSlot"</span>: <span class="hljs-string">"b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7.b"</span> }
    ]
}
</code></pre>
</li>
</ul>
<p>实际应用时可结合粒子系统创建发光轨迹，或为UI元素添加动态高亮效果。URP Unlit Shader的轻量级特性使其在移动设备上能保持60fps以上的渲染性能</p>
<h2 data-id="heading-4">典型应用场景及实现</h2>
<h3 data-id="heading-5"><strong>光晕效果（Halo）</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：角色技能特效、UI高亮提示。通过透明纹理实现边缘发光，如1中描述的透明光晕材质。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>导入纹理并设置：<code>Texture Type</code>为<code>Default (sRGB)</code>，勾选<code>Alpha Is Transparency</code>，<code>Wrap Mode</code>设为<code>Clamp</code>。</li>
<li>创建材质：选择<code>Universal Render Pipeline/Unlit</code> Shader，设置<code>Surface Type</code>为<code>Transparent</code>，拖拽纹理到<code>Base Map</code>插槽。</li>
<li>调整<code>Tint</code>颜色控制光晕色彩。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-6"><strong>全息投影效果</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：科幻场景中的虚拟角色或界面。结合透明度与扫描线纹理。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>使用<code>Unlit</code> Shader并启用透明混合（<code>Blend SrcAlpha OneMinusSrcAlpha</code>）。</li>
<li>添加顶点偏移代码模拟全息抖动，通过<code>_Time</code>变量控制动态效果。</li>
<li>叠加扫描线纹理（如<code>_HologramLine1</code>）和菲涅尔反射增强立体感。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7"><strong>透明遮罩（如塑料薄膜）</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：UI遮罩或半透明装饰物。通过Alpha通道控制透明度，如中的塑料薄膜材质。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>在图片编辑器中创建带Alpha通道的纹理，白色区域不透明，灰色区域半透明。</li>
<li>材质Shader选择<code>Unlit</code>，设置<code>Transparent</code>模式，纹理绑定到<code>Base Map</code>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8"><strong>发光广告牌（Billboard）</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：游戏内固定亮度标识或霓虹灯。直接显示纹理颜色不受光照影响。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>使用<code>Unlit</code> Shader，<code>Surface Type</code>设为<code>Opaque</code>。</li>
<li>通过<code>Base Map</code>设置发光纹理，调整<code>Tint</code>颜色增强亮度。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9"><strong>景深遮挡标记</strong></h3>
<ul>
<li>‌<strong>应用实例</strong>‌：半透明物体深度写入（如玻璃瓶），解决景深效果失效问题。</li>
<li>‌<strong>实现步骤</strong>‌：
<ul>
<li>创建两个材质：一个透明材质（<code>Queue=Transparent</code>），一个深度写入材质（<code>Queue=2000</code>）。</li>
<li>深度写入材质使用<code>Unlit</code> Shader并启用<code>ZWrite On</code>。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10"><strong>关键注意事项</strong></h3>
<ul>
<li>‌<strong>渲染顺序</strong>‌：透明物体需关闭深度写入（<code>ZWrite Off</code>），并合理设置<code>Queue</code>标签避免混合错误。</li>
<li>‌<strong>性能优化</strong>‌：复杂效果（如全息投影）建议结合顶点着色器计算，减少片元着色器负担</li>
</ul>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13021255.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13021255%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13021255&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【从UnityURP开始探索游戏渲染】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Node.js 批量导入多语言标签到 Strapi]]></title>    <link>https://juejin.cn/post/7577702891273568291</link>    <guid>https://juejin.cn/post/7577702891273568291</guid>    <pubDate>2025-11-30T03:40:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273568291" data-draft-id="7577690150093307944" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Node.js 批量导入多语言标签到 Strapi"/> <meta itemprop="keywords" content="前端,Node.js,Trae"/> <meta itemprop="datePublished" content="2025-11-30T03:40:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Node.js 批量导入多语言标签到 Strapi
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:40:41.000Z" title="Sun Nov 30 2025 03:40:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在多语言网站开发中，我们常常需要在 Strapi 中维护大量的标签（Tags），比如文章标签、产品分类标签等。如果手动在后台创建上百条标签，会非常耗时且容易出错。本文将介绍如何使用 <strong>Node.js 脚本</strong>批量导入标签，并支持多语言（英文 / 德语 / 法语）与自动生成 slug。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、项目背景</h2>
<p>假设我们有一个 Next.js + Strapi 项目，Strapi 作为内容管理系统（CMS），我们希望：</p>
<ul>
<li>批量导入 1000+ 标签</li>
<li>支持多语言（en / de / fr）</li>
<li>自动生成 URL slug</li>
<li>避免重复创建</li>
</ul>
<p>为了实现这些目标，我们可以写一个 Node.js 脚本，调用 Strapi 的 REST API 来批量创建标签。</p>
<hr/>
<h2 data-id="heading-1">二、准备工作</h2>
<ol>
<li>
<p><strong>获取 Strapi API Token</strong>
在 Strapi 后台创建一个 <strong>API Token</strong>，选择 <strong>Full Access</strong> 或者至少有 Tags CRUD 权限。
在项目根目录创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-env" lang="env">STRAPI_API_URL=https://your-strapi-domain.com
STRAPI_API_TOKEN=YOUR_API_TOKEN
</code></pre>
</li>
<li>
<p><strong>安装依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install node-fetch@2 dotenv
</code></pre>
</li>
<li>
<p><strong>准备标签数据</strong>
我们将标签写成 <code>tags.json</code> 文件，示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tags"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title_en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Economy"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title_de"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Wirtschaft"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title_fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Économie"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"economy"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_de"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wirtschaft"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"economie"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"title_en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Technology"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title_de"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Technologie"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title_fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Technologie"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_en"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"technology"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_de"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"technologie"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"slug_fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"technologie"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">三、核心脚本解析</h2>
<p>以下是 <code>import_tags_to_strapi.js</code> 的核心实现：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> fetch = <span class="hljs-built_in">require</span>(<span class="hljs-string">'node-fetch'</span>); <span class="hljs-comment">// npm install node-fetch@2</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).<span class="hljs-title function_">config</span>();

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STRAPI_URL</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">STRAPI_API_URL</span> || <span class="hljs-string">'http://localhost:1337'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TOKEN</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">STRAPI_API_TOKEN</span>;

<span class="hljs-keyword">const</span> raw = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'tags.json'</span>, <span class="hljs-string">'utf8'</span>);
<span class="hljs-keyword">const</span> { tags } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(raw);

<span class="hljs-comment">// helper: sleep</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sleep</span> = (<span class="hljs-params">ms</span>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(res, ms));
</code></pre>
<h3 data-id="heading-3">1. 创建英文标签</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> enBody = {
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">title</span>: tagObj.<span class="hljs-property">title_en</span>,
    <span class="hljs-attr">slug</span>: tagObj.<span class="hljs-property">slug_en</span>
  }
};
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${STRAPI_URL}</span>/api/tags?populate=none`</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${TOKEN}</span>`</span>,
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(enBody)
});
</code></pre>
<h3 data-id="heading-4">2. 创建德语和法语本地化</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> deBody = {
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">title</span>: tagObj.<span class="hljs-property">title_de</span>, <span class="hljs-attr">slug</span>: tagObj.<span class="hljs-property">slug_de</span> },
  <span class="hljs-attr">locale</span>: <span class="hljs-string">'de'</span>
};
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${STRAPI_URL}</span>/api/tags/<span class="hljs-subst">${createdId}</span>/localizations`</span>, { ... });

<span class="hljs-keyword">const</span> frBody = {
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">title</span>: tagObj.<span class="hljs-property">title_fr</span>, <span class="hljs-attr">slug</span>: tagObj.<span class="hljs-property">slug_fr</span> },
  <span class="hljs-attr">locale</span>: <span class="hljs-string">'fr'</span>
};
<span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${STRAPI_URL}</span>/api/tags/<span class="hljs-subst">${createdId}</span>/localizations`</span>, { ... });
</code></pre>
<blockquote>
<p>这里使用了 Strapi <strong>Localizations API</strong>，保证不同语言之间的标签关联。</p>
</blockquote>
<h3 data-id="heading-5">3. 批量处理与防刷限流</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; tags.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">createTag</span>(tags[i], i + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">200</span>); <span class="hljs-comment">// 避免 API 请求过快</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-6">四、运行脚本</h2>
<pre><code class="hljs language-bash" lang="bash">node import_tags_to_strapi.js
</code></pre>
<p>执行后，你会看到：</p>
<pre><code class="hljs language-ini" lang="ini">1 created EN <span class="hljs-attr">id</span>= <span class="hljs-number">15</span>
1 created DE localization
1 created FR localization
2 created EN <span class="hljs-attr">id</span>= <span class="hljs-number">16</span>
...
done import
</code></pre>
<hr/>
<h2 data-id="heading-7">五、注意事项</h2>
<ol>
<li><strong>API Token 权限</strong>：确保 Token 有 Tag 的读写权限。</li>
<li><strong>slug 唯一性</strong>：Strapi 对 slug 有唯一性要求，建议提前生成或使用 <code>slugify</code>。</li>
<li><strong>请求频率</strong>：一次导入大量标签时，增加 <code>sleep</code> 时间可避免 Strapi 报 429。</li>
<li><strong>多语言管理</strong>：Localizations API 保证标签在多语言之间关联，便于前端展示。</li>
</ol>
<hr/>
<h2 data-id="heading-8">六、总结</h2>
<p>通过 Node.js 脚本批量导入 Strapi 标签可以大幅提高效率，并且可以：</p>
<ul>
<li>支持上千条标签</li>
<li>自动生成 slug</li>
<li>支持多语言</li>
<li>可在 CI/CD 或部署脚本中重复执行</li>
</ul>
<p>这种方式特别适合新闻网站、博客、产品目录、跨语言项目等。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app开发app之前提须知（IOS/安卓）]]></title>    <link>https://juejin.cn/post/7577681092138467363</link>    <guid>https://juejin.cn/post/7577681092138467363</guid>    <pubDate>2025-11-30T03:44:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577681092138467363" data-draft-id="7577690150093176872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app开发app之前提须知（IOS/安卓）"/> <meta itemprop="keywords" content="前端,uni-app"/> <meta itemprop="datePublished" content="2025-11-30T03:44:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼樱前端"/> <meta itemprop="url" content="https://juejin.cn/user/2392187252771181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app开发app之前提须知（IOS/安卓）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392187252771181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼樱前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:44:38.000Z" title="Sun Nov 30 2025 03:44:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是鱼樱！！！</p>
<p>关注公众号<code>【鱼樱AI实验室】</code>持续分享更多前端和AI辅助前端编码新知识~~</p>
<p>不定时写点笔记写点生活~写点前端经验。</p>
<p>在当前环境下，纯前端开发者可以通过技术深化、横向扩展、切入新兴领域（MCP TOOLS AI应用产品方向 等）以及产品化思维找到突破口。（不管写多久的代码，技术深度广度如何一定要具备<code>独立赚钱</code>的能力呀！！老铁们，因为总有一天你不在职场总有一天会面对选择和职场的无情）</p>
<p>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
<p>前端最卷的开发语言一点不为过，三天一小更，五天一大更。。。一年一个框架升级~=嗯，要的就是这样感觉！与时俱进~ 接下来会逐步分享<code>uni-app</code>的一些开发经验。从文档到基础到实战以及遇到的问题~时间节点不限。</p>
<p>最近依旧比较忙，技术文章还是会不定时更新一些核心的技术分享，和大家一起学习前端路程。</p>
<h2 data-id="heading-0">前言须知</h2>
<p><code>uni-app</code> App 端内置了一个基于 weex 改进的原生渲染引擎，提供了原生渲染能力，在 App 端，如果使用 vue 页面，则使用 webview 渲染；如果使用 nvue 页面(native vue 的缩写)，则使用原生渲染。一个 App 中可以同时使用两种页面，比如首页使用 nvue，二级页使用 vue 页面</p>
<p>虽然 nvue 也可以多端编译，输出 H5 和小程序，但 nvue 的 css 写法受限，所以如果你不开发 App，那么不需要使用 nvue</p>
<p>nvue 的组件和 API 写法与 vue 页面一致</p>
<p>如果你熟悉 weex 或 react native 开发，那么 nvue 是你的更优选择，能切实提升你的开发效率，降低成本</p>
<p>如果你是 web 前端，不熟悉原生排版，那么建议你仍然以使用 vue 页面为主，在 App 端某些 vue 页面表现不佳的场景下使用 nvue 作为强化补充。</p>
<p>uni-app 在 App 端，支持 vue 页面和 nvue 页面混搭、互相跳转。也支持纯 nvue 原生渲染。</p>
<p>启用纯原生渲染模式，可以减少 App 端的包体积、减少使用时的内存占用。因为 webview 渲染模式的相关模块将被移除。</p>
<p>在 manifest.json 源码视图的<code>"app-plus"</code>下配置<code>"renderer":"native"</code>，即代表 App 端启用纯原生渲染模式。此时 pages.json 注册的 vue 页面将被忽略，vue 组件也将被原生渲染引擎来渲染。</p>
<p>如果不指定该值，默认是不启动纯原生渲染的。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// manifest.json</span>
	<span class="hljs-punctuation">{</span>
	   <span class="hljs-comment">// ...</span>
		<span class="hljs-comment">// App平台特有配置</span>
	   <span class="hljs-attr">"app-plus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
	      <span class="hljs-attr">"renderer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"native"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//App端纯原生渲染模式</span>
	   <span class="hljs-punctuation">}</span>
	<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">编译模式</h2>
<p><strong>weex 编译模式和 uni-app 编译模式（推荐）</strong></p>
<p>weex 的组件和 JS API，与 uni-app 不同。uni-app 与微信小程序相同  主要介绍 uni-app 方式 weex自行了解</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/254529af32d34d22add29c650b2e32b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=Xl9AMmBlX9j4gbevc%2Fc4UpE3eaA%3D" alt="image.png" loading="lazy"/></p>
<p>在 manifest.json 中修改 2 种编译模式，<code>manifest.json</code> -&gt; <code>app-plus</code> -&gt; <code>nvueCompiler</code> 切换编译模式。
<code>nvueCompiler</code> 有两个值：</p>
<ul>
<li>weex</li>
<li>uni-app</li>
</ul>
<pre><code class="hljs language-json" lang="json">	<span class="hljs-comment">// manifest.json</span>
	<span class="hljs-punctuation">{</span>
		<span class="hljs-comment">// ...</span>
		<span class="hljs-comment">// App平台特有配置</span>
		<span class="hljs-attr">"app-plus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
			<span class="hljs-attr">"nvueCompiler"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"uni-app"</span> <span class="hljs-comment">//是否启用 uni-app 模式</span>
		<span class="hljs-punctuation">}</span>
	<span class="hljs-punctuation">}</span>
</code></pre>
<p>原生开发没有页面滚动的概念，页面内容高过屏幕高度时，内容并不会自动滚动；只有将页面内容放在<code>list</code>、<code>waterfall</code>、<code>scroll-view/scroller</code>这几个组件下内容才可滚动。这不符合前端开发的习惯，所以在 nvue 编译为 <code>uni-app</code>模式时，<code>uni-app</code>框架会给 nvue 页面外层自动嵌套一个 <code>scroller</code>，从而实现页面内容的自动滚动。</p>
<p><strong>注意</strong>：</p>
<ul>
<li><code>uni-app</code>框架仅对 nvue 页面嵌套<code>scroller</code>容器，不会给组件自动套<code>scroller</code>容器；</li>
<li>若 nvue 页面有<code>recycle-list</code>组件时，<code>uni-app</code>框架也不会自动给页面嵌套<code>scroller</code>容器</li>
<li>若你不希望自动嵌套<code>scroller</code>容器，可在<code>pages.json</code>中通过如下配置进行关闭：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"disableScroll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-comment">// 不嵌套 scroller</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>HBuilderX 3.1.0+ 开始支持新的样式编译模式</strong></p>
<ul>
<li>weex 编译模式：老模式，样式支持与普通 weex 相同</li>
<li>uni-app 编译模式：新模式，在 weex 原有样式基础上支持组合选择器（相邻兄弟选择器、普通兄弟选择器、子选择器、后代选择器）<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F38751" target="_blank" title="https://ask.dcloud.net.cn/article/38751" ref="nofollow noopener noreferrer">详见</a></li>
</ul>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-comment">// manifest.json</span>
  <span class="hljs-punctuation">{</span>
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// App平台特有配置</span>
      <span class="hljs-attr">"app-plus"</span><span class="hljs-punctuation">:</span>  <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"nvueStyleCompiler"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uni-app"</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-2">快速上手</h2>
<p>在 HBuilderX 的 <code>uni-app</code> 项目中，新建页面，弹出界面右上角可以选择是建立<code>vue</code>页面还是<code>nvue</code>页面，或者 2 个同时建</p>
<p>不管是 vue 页面还是 nvue 页面，都需要在<code>pages.json</code>中注册。如果在 HBuilderX 中新建页面是会自动注册的，如果使用其他编辑器，则需要自行在 pages.json 里注册。</p>
<p>如果一个页面路由下同时有 vue 页面和 nvue 页面，即出现同名的 vue 和 nvue 文件。那么在 App 端，会仅使用 nvue 页面，同名的 vue 文件将不会被编译到 App 端。而在非 App 端，会优先使用 vue 页面。</p>
<p>如果不同名，只有 nvue 页面，则在非 app 端，只有 uni-app 编译模式的 nvue 文件才会编译。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96331e2892094ca795ba4c89362bf75f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=%2F5ZBYr4dzE3vhqrRSePbIdoOAlQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">开发 nvue 页面需注意</h3>
<p><code>nvue</code> 页面结构同 <code>vue</code>, 由 <code>template</code>、<code>style</code>、<code>script</code> 构成。</p>
<ul>
<li>
<p>template： 模板写法、数据绑定同 vue。组件支持 2 种模式，</p>
<ul>
<li>uni-app 组件，同 uni-app 写法。</li>
<li>App 端 nvue 专用组件，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fcomponent%2Fbarcode" target="_blank" title="https://uniapp.dcloud.io/component/barcode" ref="nofollow noopener noreferrer">uniapp.dcloud.io/component/b…</a>。</li>
</ul>
</li>
<li>
<p>style：由于采用原生渲染，<strong>并非所有浏览器的 css 均支持，布局模型只支持 flex 布局</strong>，虽然不会造成某些界面布局无法实现，但写法要注意。详见：<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-css" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-css" ref="nofollow noopener noreferrer">样式</a></p>
</li>
<li>
<p>script：写法同 vue，并支持 3 种 API：</p>
<ul>
<li>nvue API ：仅支持 App 端，uni-app 编译模式也可使用。使用前需先引入对应模块，参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-api" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-api" ref="nofollow noopener noreferrer">模块引入 API</a></li>
<li>uni API：<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fapi%2FREADME" target="_blank" title="https://uniapp.dcloud.io/api/README" ref="nofollow noopener noreferrer">uniapp.dcloud.io/api/README</a></li>
<li>plus API：仅支持 App 端。<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.html5plus.org%2Fdoc%2Fh5p.html" target="_blank" title="http://www.html5plus.org/doc/h5p.html" ref="nofollow noopener noreferrer">www.html5plus.org/doc/h5p.htm…</a></li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">调试 nvue 页面</h3>
<p>HBuilderX 内置了 weex 调试工具的强化版，包括审查界面元素、看 log、debug 打断点，<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fdebug%2Fdebug-app.html" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/debug/debug-app.html" ref="nofollow noopener noreferrer">详见</a></p>
<h4 data-id="heading-5">注意事项</h4>
<ul>
<li><code>vue</code> 和 <code>nvue</code> 页面均支持断点调试</li>
<li>目前仅支持 <code>nvue</code> 页面审查元素，<code>vue</code> 页面暂不支持，以及 <code>Android</code> 平台的 <code>nvue</code> 审查元素暂不支持查看 <code>style</code></li>
<li>App 端提供真机运行的<code>console.log</code>日志输出，运行到真机或模拟器时，不用点<code>debug</code>按钮，运行手机 App，会在<code>HBuilderX</code>的控制台直接输出日志。</li>
<li>如果是调试<code>App</code>的界面和常规 API，<strong>推荐编译到 H5 端</strong>，点<code>HBuilderX</code>右上角的预览，在内置浏览器里调<code>Dom</code>，保存后立即看到结果，调试更方便。并且 H5 端也支持<code>titleNView</code>的各种复杂设置。唯一要注意的就是<code>css</code>兼容性，使用太新的<code>css</code>在<code>pc</code>上预览可能正常，但低端<code>Android</code>上异常，具体可查询<code>caniuse</code>等网站。</li>
<li>常用的开发模式就是<code>pc</code>上使用内置浏览器预览调 dom，运行到真机上看<code>console.log</code>。如果是很复杂的问题才使用<code>debug</code>。</li>
<li>uni-app 的 App 端的 webkit remote debug，只能调试视图层，不能调试逻辑层。因为 uni-app 的 js 不是运行在 webview 里，而是独立的 jscore 里。</li>
<li>部分 manifest 配置，如三方 sdk 配置，需要打包后生效的，可以打包一个自定义运行基座。打包自定义基座后运行这个自定义基座，同样可以真机运行和 debug。打包正式包将无法真机运行和 debug。</li>
<li>调试依赖 chrome 安装位置，找不到可能会导致调试报错。社区反馈中有用户主动修改了 chrome 的安装位置，导致内置的 puppeteer 查找 chrome失败，如果你修改了 chrome 的安装位置，请参考 《<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F41558" target="_blank" title="https://ask.dcloud.net.cn/article/41558" ref="nofollow noopener noreferrer">HBuilderX APP端 uni/nvue 调试报错问题</a>》</li>
</ul>
<h3 data-id="heading-6">nvue开发与vue开发的常见区别</h3>
<ol>
<li>nvue 页面控制显隐只可以使用<code>v-if</code>不可以使用<code>v-show</code></li>
<li>nvue 页面只能使用<code>flex</code>布局，不支持其他布局方式。页面开发前，首先想清楚这个页面的纵向内容有什么，哪些是要滚动的，然后每个纵向内容的横轴排布有什么，按 flex 布局设计好界面。</li>
<li>nvue 页面的布局排列方向默认为竖排（<code>column</code>），如需改变布局方向，可以在 <code>manifest.json</code> -&gt; <code>app-plus</code> -&gt; <code>nvue</code> -&gt; <code>flex-direction</code> 节点下修改，仅在 uni-app 模式下生效。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fcollocation%2Fmanifest%3Fid%3Dnvue" target="_blank" title="https://uniapp.dcloud.io/collocation/manifest?id=nvue" ref="nofollow noopener noreferrer">详情</a>。</li>
<li>nvue页面编译为H5、小程序时，会做一件css默认值对齐的工作。因为weex渲染引擎只支持flex，并且默认flex方向是垂直。而H5和小程序端，使用web渲染，默认不是flex，并且设置<code>display:flex</code>后，它的flex方向默认是水平而不是垂直的。所以nvue编译为H5、小程序时，会自动把页面默认布局设为flex、方向为垂直。当然开发者手动设置后会覆盖默认设置。</li>
<li>文字内容，必须、只能在<code>&lt;text&gt;</code>组件下。不能在<code>&lt;div&gt;</code>、<code>&lt;view&gt;</code>的<code>text</code>区域里直接写文字。否则即使渲染了，也无法绑定js里的变量。</li>
<li>只有<code>text</code>标签可以设置字体大小，字体颜色。</li>
<li>布局不能使用百分比、没有媒体查询。</li>
<li>nvue 切换横竖屏时可能导致样式出现问题，建议有 nvue 的页面锁定手机方向。</li>
<li>支持的css有限，不过并不影响布局出你需要的界面，<code>flex</code>还是非常强大的。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-css.html%23flex" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-css.html#flex" ref="nofollow noopener noreferrer">详见</a></li>
<li>不支持背景图。但可以使用<code>image</code>组件和层级来实现类似web中的背景效果。因为原生开发本身也没有web这种背景图概念</li>
<li>css选择器支持的比较少，只能使用 class 选择器。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-css.html" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-css.html" ref="nofollow noopener noreferrer">详见</a></li>
<li>nvue 的各组件在安卓端默认是透明的，如果不设置<code>background-color</code>，可能会导致出现重影的问题。</li>
<li><code>class</code> 进行绑定时只支持数组语法。</li>
<li>Android端在一个页面内使用大量圆角边框会造成性能问题，尤其是多个角的样式还不一样的话更耗费性能。应避免这类使用。</li>
<li>nvue页面没有<code>bounce</code>回弹效果，只有几个列表组件有<code>bounce</code>效果，包括 <code>list</code>、<code>recycle-list</code>、<code>waterfall</code>。</li>
<li>原生开发没有页面滚动的概念，页面内容高过屏幕高度并不会自动滚动，只有部分组件可滚动（<code>list</code>、<code>waterfall</code>、<code>scroll-view/scroller</code>），要滚的内容需要套在可滚动组件下。这不符合前端开发的习惯，所以在 nvue 编译为 uni-app模式时，给页面外层自动套了一个 <code>scroller</code>，页面内容过高会自动滚动。（组件不会套，页面有<code>recycle-list</code>时也不会套）。后续会提供配置，可以设置不自动套。</li>
<li>在 App.vue 中定义的全局js变量不会在 nvue 页面生效。<code>globalData</code>和<code>vuex</code>是生效的。</li>
<li>App.vue 中定义的全局css，对nvue和vue页面同时生效。如果全局css中有些css在nvue下不支持，编译时控制台会报警，建议把这些不支持的css包裹在<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fplatform" target="_blank" title="https://uniapp.dcloud.io/platform" ref="nofollow noopener noreferrer">条件编译</a>里，<code>APP-PLUS-NVUE</code></li>
<li>不能在 <code>style</code> 中引入字体文件，nvue 中字体图标的使用参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-api.html%23addrule" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-api.html#addrule" ref="nofollow noopener noreferrer">加载自定义字体</a>。如果是本地字体，可以用<code>plus.io</code>的API转换路径。</li>
<li>目前不支持在 nvue 页面使用 <code>typescript/ts</code>。
<strong>21</strong>.  nvue 页面关闭原生导航栏时，想要模拟状态栏，可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F35111" target="_blank" title="https://ask.dcloud.net.cn/article/35111" ref="nofollow noopener noreferrer">参考文章</a>。但是，仍然<strong>强烈建议在nvue页面使用原生导航栏</strong>。nvue的渲染速度再快，也没有原生导航栏快。原生排版引擎解析<code>json</code>绘制原生导航栏耗时很少，而解析nvue的js绘制整个页面的耗时要大的多，尤其在新页面进入动画期间，对于复杂页面，没有原生导航栏会在动画期间产生整个屏幕的白屏或闪屏。</li>
</ol>
<h3 data-id="heading-7">iOS 平台下拉组件 refresh 组件注意问题</h3>
<p>iOS 平台默认情况下滚动容器组件（如<code>list</code>、<code>waterfall</code>组件）内容不足时，由于没有撑满容器的可视区域会导致无法上下滚动，此时无法操作下拉刷新功能，无法触发<code>refresh</code>组件的<code>@refresh</code>、<code>@pullingdown</code>事件。 此时可在容器组件中配置<code>alwaysScrollableVertical</code>属性值为<code>true</code>来设置支持上下滚动，支持下拉刷新操作。</p>
<blockquote>
<p>Android 平台不存在此问题</p>
</blockquote>
<h4 data-id="heading-8">用法</h4>
<pre><code class="hljs language-nvue" lang="nvue">&lt;list class="scroll-v list" enableBackToTop="true" scroll-y alwaysScrollableVertical="true"&gt;
	&lt;refresh class="refresh" @refresh="onrefresh()" @pullingdown="onpullingdown"&gt;
		&lt;!-- refresh content --&gt;
	&lt;/refresh&gt;
	&lt;cell v-for="(newsitem,index) in list" :key="newsitem.id"&gt;
		&lt;!-- cell content --&gt;
	&lt;/cell&gt;
&lt;/list&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18d5a212772d471f84750462d052781e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=WPbSlHxNtvV9c%2BsFSsye0RYq9lU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">HTML5+ 能力</h2>
<p><code>uni-app</code> App 端内置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.html5plus.org%2Fdoc%2F" target="_blank" title="https://www.html5plus.org/doc/" ref="nofollow noopener noreferrer">HTML5+</a> 引擎，让 js 可以直接调用丰富的原生能力</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a056cec33d7544c0875177ad4e79d426~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=DMijjtu2pg6YmxlsRyNfdusla8w%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">条件编译调用 HTML5+</h4>
<p>小程序及 H5 等平台是没有 HTML5+ 扩展规范的，因此在 <code>uni-app</code> 调用 HTML5+ 的扩展规范时，需要注意使用条件编译。否则运行到h5、小程序等平台会出现 <code>plus is not defined</code>错误。</p>
<pre><code class="hljs language-nvue" lang="nvue">// #ifdef APP-PLUS
var appid = plus.runtime.appid;
console.log('应用的 appid 为：' + appid);
// #endif
</code></pre>
<h4 data-id="heading-11"><code>uni-app</code>不需要 <code>plus ready</code></h4>
<p>在html中使用plus的api，需要等待plus ready。 而<code>uni-app</code>不需要等，可以直接使用。而且如果你调用plus ready，反而不会触发。</p>
<h4 data-id="heading-12"><code>uni-app</code> 中的事件监听</h4>
<p>在普通的 H5+ 项目中，需要使用 <code>document.addEventListener</code> 监听原生扩展的事件。</p>
<p><code>uni-app</code> 中，没有 document。可以使用 <code>plus.globalEvent.addEventListener</code> 来实现。</p>
<pre><code class="hljs language-nvue" lang="nvue">// #ifdef APP-PLUS
// 监听新意图事件
plus.globalEvent.addEventListener('newintent', function(){});
// #endif
</code></pre>
<p>复制代码</p>
<p>同理，在 <code>uni-app</code> 中使用 Native.js 时，一些 Native.js 中对于原生事件的监听同样需要按照上面的方法去实现。</p>
<h2 data-id="heading-13">Native.js 能力</h2>
<p>Native.js技术，简称NJS，是一种将手机操作系统的原生对象转义，映射为JS对象，在JS里编写原生代码的技术。 如果说Node.js把js扩展到服务器世界，那么Native.js则把js扩展到手机App的原生世界。 HTML/JS/Css全部语法只有7万多，而原生语法有几十万，Native.js大幅提升了HTML5的能力。 NJS突破了浏览器的功能限制，也不再需要像Hybrid那样由原生语言开发插件才能补足浏览器欠缺的功能。 NJS编写的代码，最终需要在HBuilder里打包发行为App安装包，或者在支持Native.js技术的浏览器里运行。目前Native.js技术不能在普通手机浏览器里直接运行。</p>
<ul>
<li>NJS大幅扩展了HTML5的能力范围，原本只有原生或Hybrid App的原生插件才能实现的功能如今可以使用JS实现。</li>
<li>NJS大幅提升了App开发效率，将iOS、Android、Web的3个工程师组队才能完成的App，变为1个web工程师就搞定。</li>
<li>NJS不再需要配置原生开发和编译环境，调试、打包均在HBuilder里进行。没有mac和xcode一样可以开发iOS应用。</li>
<li>如果不熟悉原生API也没关系，我们汇总了很多NJS的代码示例，复制粘贴就可以用。<a href="https://link.juejin.cn?target=http%3A%2F%2Fask.dcloud.net.cn%2Farticle%2F114" target="_blank" title="http://ask.dcloud.net.cn/article/114" ref="nofollow noopener noreferrer">ask.dcloud.net.cn/article/114</a></li>
</ul>
<p>再次强调，Native.js不是一个js库，不需要下载引入到页面的script中，也不像nodejs那样有单独的运行环境，Native.js的运行环境是集成在5+runtime里的，使用HBuilder打包的app或流应用都可以直接使用Native.js。</p>
<h2 data-id="heading-14">注意事项：</h2>
<ul>
<li>
<p>Uni-app不支持Native.js执行UI相关操作的API调用及webview相关API调用。将失效无法正常使用。Uni-app不推荐使用Native.js</p>
</li>
<li>
<p>Native API具有平台依赖性，所以需要通过以下方式判断当前的运行平台</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">judgePlatform</span>(<span class="hljs-params"/>){
	<span class="hljs-keyword">switch</span> ( plus.<span class="hljs-property">os</span>.<span class="hljs-property">name</span> ) {
		<span class="hljs-keyword">case</span> <span class="hljs-string">"Android"</span>:
		<span class="hljs-comment">// Android平台: plus.android.*</span>
		<span class="hljs-keyword">break</span>;
		<span class="hljs-keyword">case</span> <span class="hljs-string">"iOS"</span>:
		<span class="hljs-comment">// iOS平台: plus.ios.*</span>
		<span class="hljs-keyword">break</span>;
		<span class="hljs-attr">default</span>:
		<span class="hljs-comment">// 其它平台</span>
		<span class="hljs-keyword">break</span>;
	}
}
</code></pre>
<ul>
<li>在NJS中调用Native API或从Native API返回数据到NJS时会自动转换数据类型</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb70f936bde54fe5b6e6660832bab412~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=KGGqKFoSxcWfYLG5aBUzi%2FI99vc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-15">技术要求</h3>
<p>由于NJS是直接调用Native API，需要对Native API有一定了解，知道所需要的功能调用了哪些原生API，能看懂原生代码并参考原生代码修改为JS代码。 否则只能直接copy别人写好的NJS代码。</p>
<h2 data-id="heading-16">renderjs能力</h2>
<p><code>renderjs</code>是一个运行在视图层的js。它比<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fminiprogram-subject.html%23wxs" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/miniprogram-subject.html#wxs" ref="nofollow noopener noreferrer">WXS</a>更加强大。它只支持app-vue和web。</p>
<p><code>renderjs</code>的主要作用有2个：</p>
<ol>
<li>大幅降低逻辑层和视图层的通讯损耗，提供高性能视图交互能力</li>
<li>在视图层操作dom，运行 for web 的 js库</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8a99c2201604e78b0402df9ec679140~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG85qix5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765079078&amp;x-signature=nAEadX6XH4i7Vd5w2Of%2Fi6MWEZc%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>nvue的视图层是原生的，无法运行js。但提供了bindingx技术来解决通信阻塞。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fnvue-api.html%23bindingx" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/nvue-api.html#bindingx" ref="nofollow noopener noreferrer">详见</a></li>
<li>微信小程序下替代方案是wxs，这是微信提供的一个裁剪版renderjs。<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fminiprogram-subject.html%23wxs" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/miniprogram-subject.html#wxs" ref="nofollow noopener noreferrer">详见</a></li>
<li>web下不存在逻辑层和视图层的通信阻塞，也可以直接操作dom，所以在web端使用renderjs主要是为了跨端复用代码。<strong>如果只开发web端，没有必要使用renderjs</strong>。</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;script <span class="hljs-variable language_">module</span>=<span class="hljs-string">"test"</span> lang=<span class="hljs-string">"renderjs"</span>&gt;
	<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
		<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
			<span class="hljs-comment">// ...</span>
		},
		<span class="hljs-attr">methods</span>: {
			<span class="hljs-comment">// ...</span>
		}
	}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-17">过去的问题</h3>
<ul>
<li>H5端流行的echart报表因为涉及大量dom操作，无法跨端使用</li>
<li>wx-chart在跨端和更新方面都不足</li>
<li>插件市场提供了比wx-chart更好的、全端可用的<a href="https://link.juejin.cn?target=https%3A%2F%2Fext.dcloud.net.cn%2Fplugin%3Fid%3D271" target="_blank" title="https://ext.dcloud.net.cn/plugin?id=271" ref="nofollow noopener noreferrer">uChart</a>。但受限于小程序架构逻辑层和视图层分离，导致的通信折损，图表的动画性能不佳。并且uchart只实现了echart的常用功能，还有一些功能没有实现。</li>
</ul>
<h3 data-id="heading-18">新的解决方案</h3>
<p>从uni-app 2.5.5+起，新提供了<a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.io%2Fframe%3Fid%3Drenderjs" target="_blank" title="https://uniapp.dcloud.io/frame?id=renderjs" ref="nofollow noopener noreferrer">renderjs</a>技术。它是wxs的升级版，一种可以运行在视图层的js。</p>
<p>通过renderjs编写的代码，直接运行在视图层（也就是webview中），可以完整的运行echart等库，并且没有了逻辑层和视图层频繁通行的折损，让动画不再卡顿。</p>
<p>renderjs支持app-vue和h5，不支持其他平台。如果你只考虑这2个平台，可以直接使用本示例，使用完整版的echart。如果还要兼容多端小程序，建议仍然使用uchart。</p>
<p>renderjs，不止能运行echart，其他如F2、threejs等web库都可以运行。</p>
<h3 data-id="heading-19">renderjs使用注意事项</h3>
<ul>
<li>目前仅支持内联使用。</li>
<li>不要直接引用大型类库，推荐通过动态创建 script 方式引用。</li>
<li>可以使用 vue 组件的生命周期(不支持 beforeDestroy、destroyed、beforeUnmount、unmounted)，不可以使用 App、Page 的生命周期</li>
<li>视图层和逻辑层通讯方式与 <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Ftutorial%2Fminiprogram-subject.html%23wxs" target="_blank" title="https://uniapp.dcloud.net.cn/tutorial/miniprogram-subject.html#wxs" ref="nofollow noopener noreferrer">WXS</a> 一致，另外可以通过 this.$ownerInstance 获取当前组件的 ComponentDescriptor 实例。</li>
<li>this.$ownerInstance.callMethod() 仅支持调用逻辑层vue选项式中的 methods 中定义的方法。</li>
<li>注意逻辑层给数据时最好一次性给到渲染层，而不是不停从逻辑层向渲染层发消息，那样还是会产生逻辑层和视图层的多次通信，还是会卡</li>
<li>观测更新的数据在视图层可以直接访问到。</li>
<li>APP 端视图层的页面引用资源的路径相对于根目录计算，例如：./static/test.js。</li>
<li>APP 端可以使用 dom、bom API，不可直接访问逻辑层数据，不可以使用 uni 相关接口（如：uni.request）</li>
<li>H5 端逻辑层和视图层实际运行在同一个环境中，相当于使用 mixin 方式，可以直接访问逻辑层数据。</li>
<li>vue3 项目不支持 <code>setup script</code> 用法。</li>
</ul>
<h2 data-id="heading-20">APP 离线 SDK</h2>
<p>App离线开发工具包，即App离线SDK，是把App运行环境（runtime）封装为原生开发调用接口，开发者可以在自己的 Android 及 iOS 原生开发环境配置工程使用，包括 Android离线开发SDK 及 iOS离线开发SDK。</p>
<p><strong>注意：本SDK仅限于<code>uni-app</code>项目使用</strong></p>
<ul>
<li>Android 离线SDK-正式版  <a href="https://link.juejin.cn?target=https%3A%2F%2Fnativesupport.dcloud.net.cn%2FAppDocs%2Fdownload%2Fandroid.html" target="_blank" title="https://nativesupport.dcloud.net.cn/AppDocs/download/android.html" ref="nofollow noopener noreferrer">nativesupport.dcloud.net.cn/AppDocs/dow…</a></li>
<li>iOS 离线SDK - 正式版 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnativesupport.dcloud.net.cn%2FAppDocs%2Fdownload%2Fios.html" target="_blank" title="https://nativesupport.dcloud.net.cn/AppDocs/download/ios.html" ref="nofollow noopener noreferrer">nativesupport.dcloud.net.cn/AppDocs/dow…</a></li>
<li>AppKey申请配置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnativesupport.dcloud.net.cn%2FAppDocs%2Fusesdk%2Fappkey.html" target="_blank" title="https://nativesupport.dcloud.net.cn/AppDocs/usesdk/appkey.html" ref="nofollow noopener noreferrer">nativesupport.dcloud.net.cn/AppDocs/use…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>