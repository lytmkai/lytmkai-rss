<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Redis（122）Redis的版本更新如何进行？]]></title>    <link>https://juejin.cn/post/7572051762983927860</link>    <guid>https://juejin.cn/post/7572051762983927860</guid>    <pubDate>2025-11-13T23:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572051762983927860" data-draft-id="7571846248720236544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（122）Redis的版本更新如何进行？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T23:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（122）Redis的版本更新如何进行？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T23:06:06.000Z" title="Thu Nov 13 2025 23:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 的版本更新涉及到一些步骤，包括备份现有数据、下载并安装新版本、配置新版本、迁移数据以及进行测试等。以下是 Redis 版本更新的详细步骤和示例代码。</p>
<h3 data-id="heading-0">1. 备份现有数据</h3>
<p>在进行版本更新之前，备份现有的数据是非常重要的。你可以通过复制 RDB 和 AOF 文件进行备份。</p>
<h4 data-id="heading-1">备份命令</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 备份 RDB 文件</span>
<span class="hljs-built_in">cp</span> /var/lib/redis/dump.rdb /backup/dump.rdb

<span class="hljs-comment"># 备份 AOF 文件</span>
<span class="hljs-built_in">cp</span> /var/lib/redis/appendonly.aof /backup/appendonly.aof
</code></pre>
<h3 data-id="heading-2">2. 下载并安装新版本</h3>
<p>从 Redis 官方网站下载最新版本的 Redis，然后编译并安装。</p>
<h4 data-id="heading-3">下载和编译 Redis</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 下载 Redis 源代码</span>
wget http://download.redis.io/releases/redis-6.2.6.tar.gz
tar xzf redis-6.2.6.tar.gz
<span class="hljs-built_in">cd</span> redis-6.2.6

<span class="hljs-comment"># 编译 Redis</span>
make

<span class="hljs-comment"># 安装 Redis</span>
sudo make install
</code></pre>
<h3 data-id="heading-4">3. 配置新版本</h3>
<p>安装完新版本后，要确保配置文件的正确性。新的 Redis 配置文件通常位于 <code>/etc/redis/redis.conf</code>。你需要将旧版本的配置文件复制到新版本，并进行必要的调整。</p>
<h4 data-id="heading-5">复制配置文件</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">cp</span> /etc/redis/redis.conf /etc/redis/redis.conf.bak
<span class="hljs-built_in">cp</span> /path/to/new/redis.conf /etc/redis/redis.conf
</code></pre>
<h4 data-id="heading-6">检查和调整配置文件</h4>
<p>打开新的配置文件 <code>/etc/redis/redis.conf</code>，检查以下配置项：</p>
<pre><code class="hljs language-conf" lang="conf"># 端口号
port 6379

# 数据文件存放路径
dir /var/lib/redis

# RDB 文件名称
dbfilename dump.rdb

# AOF 配置
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
</code></pre>
<h3 data-id="heading-7">4. 停止旧版本 Redis 服务</h3>
<p>在安装新版本之前，先停止旧版本的 Redis 服务。</p>
<h4 data-id="heading-8">停止 Redis 服务</h4>
<pre><code class="hljs language-sh" lang="sh">sudo systemctl stop redis
</code></pre>
<h3 data-id="heading-9">5. 启动新版本 Redis 服务</h3>
<p>启动新版本的 Redis 服务，并确保它能正常运行。</p>
<h4 data-id="heading-10">启动 Redis 服务</h4>
<pre><code class="hljs language-sh" lang="sh">sudo systemctl start redis
</code></pre>
<h3 data-id="heading-11">6. 迁移数据（如果必要）</h3>
<p>如果新版本 Redis 需要数据迁移，通常可以通过加载旧的 RDB 或 AOF 文件来完成。此步骤通常在启动 Redis 服务时自动完成。</p>
<h3 data-id="heading-12">7. 验证和测试</h3>
<p>最后，验证和测试新版本的 Redis 是否正常工作。可以通过 Redis 命令行客户端进行一些基本操作测试。</p>
<h4 data-id="heading-13">基本操作测试</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 连接到 Redis</span>
redis-cli

<span class="hljs-comment"># 测试写入数据</span>
<span class="hljs-built_in">set</span> key <span class="hljs-string">"value"</span>

<span class="hljs-comment"># 测试读取数据</span>
get key
</code></pre>
<h3 data-id="heading-14">8. 回滚计划</h3>
<p>在更新过程中，如果出现问题，需要有一个回滚计划。你可以通过恢复之前备份的 RDB 和 AOF 文件来回滚到旧版本。</p>
<h4 data-id="heading-15">回滚步骤</h4>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 停止 Redis 服务</span>
sudo systemctl stop redis

<span class="hljs-comment"># 恢复备份文件</span>
<span class="hljs-built_in">cp</span> /backup/dump.rdb /var/lib/redis/dump.rdb
<span class="hljs-built_in">cp</span> /backup/appendonly.aof /var/lib/redis/appendonly.aof

<span class="hljs-comment"># 安装旧版本（如果必要）</span>
<span class="hljs-comment"># 可以重新编译并安装旧版本的 Redis</span>

<span class="hljs-comment"># 启动 Redis 服务</span>
sudo systemctl start redis
</code></pre>
<h3 data-id="heading-16">示例代码</h3>
<p>以下是一个简单的 Java 代码示例，展示了如何通过 Jedis 进行 Redis 操作，验证新版本 Redis 是否正常工作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisUpdateExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 连接到 Redis 服务器</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 测试写入数据</span>
            jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);

            <span class="hljs-comment">// 测试读取数据</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key"</span>);
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"value"</span>.equals(value)) {
                System.out.println(<span class="hljs-string">"Redis update successful! Key value: "</span> + value);
            } <span class="hljs-keyword">else</span> {
                System.err.println(<span class="hljs-string">"Redis update failed! Key value: "</span> + value);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-17">总结</h3>
<p>Redis 版本更新是一个系统性的操作，需要备份数据、下载并安装新版本、调整配置、迁移数据以及进行充分的测试。通过遵循上述详细步骤，可以确保 Redis 版本更新的顺利进行，并在出现问题时有计划地进行回滚。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（123）Redis在大数据场景下的应用有哪些？]]></title>    <link>https://juejin.cn/post/7572010680897241128</link>    <guid>https://juejin.cn/post/7572010680897241128</guid>    <pubDate>2025-11-13T23:07:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680897241128" data-draft-id="7572020278387605538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（123）Redis在大数据场景下的应用有哪些？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T23:07:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（123）Redis在大数据场景下的应用有哪些？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T23:07:00.000Z" title="Thu Nov 13 2025 23:07:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 在大数据场景中的应用非常广泛，涵盖了缓存、分布式锁、实时分析、数据去重、计数器和限流、数据流处理等多个领域。以下是每个应用场景的详细介绍及相应的 Java 代码示例。</p>
<h3 data-id="heading-0">1. 缓存</h3>
<p>Redis 作为高性能的内存缓存，可以显著提升数据库查询、API 响应和网页内容加载的速度。</p>
<h4 data-id="heading-1">示例代码</h4>
<p>以下示例展示了如何使用 Redis 作为数据库查询结果的缓存：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCacheExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:1001:profile"</span>;
            
            <span class="hljs-comment">// 尝试从 Redis 缓存中获取数据</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">cachedProfile</span> <span class="hljs-operator">=</span> jedis.get(cacheKey);
            <span class="hljs-keyword">if</span> (cachedProfile != <span class="hljs-literal">null</span>) {
                System.out.println(<span class="hljs-string">"Cache hit: "</span> + cachedProfile);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 模拟数据库查询</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">dbProfile</span> <span class="hljs-operator">=</span> queryDatabaseForProfile(<span class="hljs-number">1001</span>);
                
                <span class="hljs-comment">// 将结果存入 Redis 缓存，设置过期时间为 60 秒</span>
                jedis.setex(cacheKey, <span class="hljs-number">60</span>, dbProfile);
                System.out.println(<span class="hljs-string">"Cache miss: "</span> + dbProfile);
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">queryDatabaseForProfile</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> {
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"{ \"id\": 1001, \"name\": \"John Doe\", \"email\": \"john.doe@example.com\" }"</span>;
    }
}
</code></pre>
<h3 data-id="heading-2">2. 分布式锁</h3>
<p>在分布式系统中，Redis 可以用作分布式锁，以确保同一资源不会被多个实例同时访问。</p>
<h4 data-id="heading-3">示例代码</h4>
<p>下面是基于 Redis 实现分布式锁的示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLockExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:resource"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">LOCK_EXPIRE</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>; <span class="hljs-comment">// 锁的超时秒数</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-keyword">if</span> (acquireLock(jedis, LOCK_KEY, LOCK_EXPIRE)) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 执行需要加锁的操作</span>
                    System.out.println(<span class="hljs-string">"Lock acquired, performing operation..."</span>);
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// 释放锁</span>
                    releaseLock(jedis, LOCK_KEY);
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"Failed to acquire lock."</span>);
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquireLock</span><span class="hljs-params">(Jedis jedis, String lockKey, <span class="hljs-type">int</span> expireSeconds)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.setnx(lockKey, String.valueOf(System.currentTimeMillis() + expireSeconds * <span class="hljs-number">1000</span>));
        <span class="hljs-keyword">if</span> (result == <span class="hljs-number">1</span>) {
            jedis.expire(lockKey, expireSeconds);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-comment">// 当前锁已存在，检查是否已过期</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockValue</span> <span class="hljs-operator">=</span> jedis.get(lockKey);
        <span class="hljs-keyword">if</span> (lockValue != <span class="hljs-literal">null</span> &amp;&amp; Long.parseLong(lockValue) &lt; System.currentTimeMillis()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> jedis.getSet(lockKey, String.valueOf(System.currentTimeMillis() + expireSeconds * <span class="hljs-number">1000</span>));
            <span class="hljs-keyword">if</span> (oldValue != <span class="hljs-literal">null</span> &amp;&amp; oldValue.equals(lockValue)) {
                jedis.expire(lockKey, expireSeconds);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseLock</span><span class="hljs-params">(Jedis jedis, String lockKey)</span> {
        jedis.del(lockKey);
        System.out.println(<span class="hljs-string">"Lock released."</span>);
    }
}
</code></pre>
<h3 data-id="heading-4">3. 实时分析</h3>
<p>Redis 的发布/订阅（Pub/Sub）机制适用于实时数据流处理，例如消息队列、实时数据分析和通知系统。</p>
<h4 data-id="heading-5">示例代码</h4>
<p>以下示例展示了如何使用 Redis 的 Pub/Sub 实现简单的消息发布和订阅：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.JedisPubSub;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisPubSubExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(RedisPubSubExample::startSubscriber).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(RedisPubSubExample::startPublisher).start();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startSubscriber</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            jedis.subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPubSub</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(String channel, String message)</span> {
                    System.out.println(<span class="hljs-string">"Received message: "</span> + message + <span class="hljs-string">" from channel: "</span> + channel);
                }
            }, <span class="hljs-string">"my-channel"</span>);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startPublisher</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
                jedis.publish(<span class="hljs-string">"my-channel"</span>, <span class="hljs-string">"Message "</span> + i);
                System.out.println(<span class="hljs-string">"Published message: "</span> + i);
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 模拟发布间隔</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-6">4. 数据去重</h3>
<p>Redis 的 Set 数据结构非常适用于去重操作，例如在大规模数据导入过程中去重。</p>
<h4 data-id="heading-7">示例代码</h4>
<p>下面是利用 Redis Set 实现数据去重的示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisDeduplicationExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">dedupKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"unique:data"</span>;

            String[] dataList = {<span class="hljs-string">"data1"</span>, <span class="hljs-string">"data2"</span>, <span class="hljs-string">"data3"</span>, <span class="hljs-string">"data2"</span>, <span class="hljs-string">"data1"</span>};
            <span class="hljs-keyword">for</span> (String data : dataList) {
                <span class="hljs-keyword">if</span> (jedis.sadd(dedupKey, data) == <span class="hljs-number">1</span>) {
                    System.out.println(<span class="hljs-string">"New unique data added: "</span> + data);
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"Duplicate data ignored: "</span> + data);
                }
            }

            <span class="hljs-comment">// 打印去重后的数据</span>
            System.out.println(<span class="hljs-string">"Unique data set: "</span> + jedis.smembers(dedupKey));
        }
    }
}
</code></pre>
<h3 data-id="heading-8">5. 计数器和限流</h3>
<p>Redis 的 INCR 和 INCRBY 命令非常适合用于实现计数器和限流功能，例如 API 调用次数限制。</p>
<h4 data-id="heading-9">示例代码</h4>
<p>以下是利用 Redis 实现简单计数器和限流的示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisRateLimiterExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RATE_LIMIT_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"rate:limit"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">RATE_LIMIT</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXPIRE_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                <span class="hljs-keyword">if</span> (isAllowed(jedis, RATE_LIMIT_KEY, RATE_LIMIT, EXPIRE_SECONDS)) {
                    System.out.println(<span class="hljs-string">"Request "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" is allowed."</span>);
                } <span class="hljs-keyword">else</span> {
                    System.out.println(<span class="hljs-string">"Request "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" is rate-limited."</span>);
                }
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 模拟请求间隔</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAllowed</span><span class="hljs-params">(Jedis jedis, String key, <span class="hljs-type">int</span> limit, <span class="hljs-type">int</span> expireSeconds)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentCount</span> <span class="hljs-operator">=</span> jedis.incr(key);
        <span class="hljs-keyword">if</span> (currentCount == <span class="hljs-number">1</span>) {
            jedis.expire(key, expireSeconds);
        }
        <span class="hljs-keyword">return</span> currentCount &lt;= limit;
    }
}
</code></pre>
<h3 data-id="heading-10">6. 使用 Redis Streams 进行数据流处理</h3>
<p>Redis Streams 是 Redis 5.0 新增的数据结构，适用于处理高吞吐量的数据流。</p>
<h4 data-id="heading-11">示例代码</h4>
<p>以下是使用 Redis Streams 进行数据生产和消费的示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.StreamEntryID;
<span class="hljs-keyword">import</span> redis.clients.jedis.StreamEntry;

<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.AbstractMap.SimpleEntry;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisStreamsExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">STREAM_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mystream"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(RedisStreamsExample::produceStreamData).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(RedisStreamsExample::consumeStreamData).start();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">produceStreamData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
                Map&lt;String, String&gt; message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
                message.put(<span class="hljs-string">"field1"</span>, <span class="hljs-string">"value"</span> + i);
                jedis.xadd(STREAM_KEY, StreamEntryID.NEW_ENTRY, message);
                System.out.println(<span class="hljs-string">"Produced stream entry: value"</span> + i);
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 模拟生产间隔</span>
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        }
    }

    
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在死磕模板语法？Vue渲染函数+JSX让你开发效率翻倍！]]></title>    <link>https://juejin.cn/post/7572087162230194218</link>    <guid>https://juejin.cn/post/7572087162230194218</guid>    <pubDate>2025-11-13T23:28:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572087162230194218" data-draft-id="7572087162230177834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在死磕模板语法？Vue渲染函数+JSX让你开发效率翻倍！"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-13T23:28:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在死磕模板语法？Vue渲染函数+JSX让你开发效率翻倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T23:28:49.000Z" title="Thu Nov 13 2025 23:28:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开篇：被模板限制的烦恼时刻</h2>
<p>你是不是也遇到过这样的场景？产品经理拿着设计稿过来，说要做一个超级灵活的动态表单，每个字段的类型、验证规则、布局方式都可能随时变化。你看着那复杂的条件渲染，心里默默计算着要写多少v-if、v-switch，还有那些嵌套很深的组件结构，光是想想就头大。</p>
<p>或者，你需要封装一个高度可复用的业务组件，但使用模板时总觉得有些逻辑表达起来不够直接，尤其是在处理动态组件、递归组件这些高级用法时，模板语法显得有点力不从心。</p>
<p>别担心，今天我要跟你分享的Vue渲染函数和JSX，就是专门为解决这些问题而生的利器。它们能让你在Vue开发中拥有更大的灵活性，特别是在那些模板难以应对的动态场景里。</p>
<p>学完今天的内容，你会掌握如何用JSX写出更简洁直观的组件代码，理解渲染函数的工作原理，还能在实际项目中灵活运用这些技术解决复杂问题。</p>
<h2 data-id="heading-1">为什么需要超越模板？</h2>
<p>先来说说模板的局限性。Vue的模板语法确实很友好，声明式、易上手，但在处理特别复杂的动态逻辑时，模板会变得冗长且难以维护。</p>
<p>想象一下这样的需求：根据后端返回的配置对象，动态渲染一个完整的页面结构。配置里可能包含按钮、输入框、表格等各种组件，还有它们之间的嵌套关系。用模板的话，你可能要写一大堆v-if和动态组件，代码可读性直线下降。</p>
<p>这时候渲染函数和JSX的优势就体现出来了。它们本质上都是JavaScript，能够利用JS完整的编程能力来表达组件结构。循环、条件判断、递归，这些在JS里都很自然，但在模板里就需要各种指令配合。</p>
<p>不过要说明的是，我并不是说模板不好。在大多数常规场景下，模板依然是最佳选择。只有在真正需要更大灵活性的动态场景中，才需要考虑使用渲染函数或JSX。</p>
<h2 data-id="heading-2">初识渲染函数：用JavaScript描述UI</h2>
<p>先来看一个最简单的例子。平时我们用模板写一个按钮组件可能是这样的：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['btn', `btn-${type}`]"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleClick"</span>&gt;</span>
    {{ text }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>如果用渲染函数来写，会是这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'type'</span>, <span class="hljs-string">'text'</span>],
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'click'</span>)
    }
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params">h</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(
      <span class="hljs-string">'button'</span>,
      {
        <span class="hljs-attr">class</span>: [<span class="hljs-string">'btn'</span>, <span class="hljs-string">`btn-<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.type}</span>`</span>],
        <span class="hljs-attr">on</span>: {
          <span class="hljs-attr">click</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClick</span>
        }
      },
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>
    )
  }
}
</code></pre>
<p>这里的<code>h</code>函数是创建虚拟DOM节点的工具，它接收三个参数：标签名、数据对象、子节点。数据对象可以包含class、style、props、on等属性。</p>
<p>可能你会觉得，这看起来比模板复杂啊？别急，这只是一个入门示例。当逻辑变得复杂时，渲染函数的优势才会真正显现。</p>
<h2 data-id="heading-3">JSX：更直观的写法</h2>
<p>如果你觉得上面的渲染函数写法还是有些抽象，那么JSX可能会让你眼前一亮。JSX是一种JavaScript的语法扩展，它让我们能在JS中写类似HTML的结构。</p>
<p>同样的按钮组件，用JSX来写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'type'</span>, <span class="hljs-string">'text'</span>],
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'click'</span>)
    }
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
        <span class="hljs-attr">class</span>=<span class="hljs-string">{[</span>'<span class="hljs-attr">btn</span>', `<span class="hljs-attr">btn-</span>${<span class="hljs-attr">this.type</span>}`]}
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleClick}</span>
      &gt;</span>
        {this.text}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    )
  }
}
</code></pre>
<p>是不是感觉亲切多了？JSX让渲染函数的写法更加直观，特别是对于有React经验的开发者来说，几乎可以无缝切换。</p>
<p>要在Vue项目中使用JSX，你需要配置相应的Babel插件。现在主流的Vue脚手架工具都支持这个功能，配置起来也很简单。</p>
<h2 data-id="heading-4">动态场景实战：可配置表单渲染器</h2>
<p>让我们来看一个真实的业务场景。假设我们要做一个动态表单渲染器，根据JSON配置来渲染不同的表单字段。</p>
<p>首先定义配置结构：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> formConfig = [
  {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'input'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'username'</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'用户名'</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'请输入用户名'</span>
  },
  {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'select'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'gender'</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'性别'</span>,
    <span class="hljs-attr">options</span>: [
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'男'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'male'</span> },
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'女'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'female'</span> }
    ]
  },
  {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'checkbox'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'hobbies'</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'兴趣爱好'</span>,
    <span class="hljs-attr">options</span>: [
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'读书'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'reading'</span> },
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'运动'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'sports'</span> }
    ]
  }
]
</code></pre>
<p>如果用模板来实现，可能会是这样：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-renderer"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"field in config"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"field.name"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>{{ field.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"field.type === 'input'"</span>
        <span class="hljs-attr">:type</span>=<span class="hljs-string">"field.type"</span>
        <span class="hljs-attr">:name</span>=<span class="hljs-string">"field.name"</span>
        <span class="hljs-attr">:required</span>=<span class="hljs-string">"field.required"</span>
        <span class="hljs-attr">:placeholder</span>=<span class="hljs-string">"field.placeholder"</span>
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData[field.name]"</span>
      &gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">select</span>
        <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"field.type === 'select'"</span>
        <span class="hljs-attr">:name</span>=<span class="hljs-string">"field.name"</span>
        <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData[field.name]"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span>
          <span class="hljs-attr">v-for</span>=<span class="hljs-string">"option in field.options"</span>
          <span class="hljs-attr">:key</span>=<span class="hljs-string">"option.value"</span>
          <span class="hljs-attr">:value</span>=<span class="hljs-string">"option.value"</span>
        &gt;</span>
          {{ option.label }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"field.type === 'checkbox'"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>
          <span class="hljs-attr">v-for</span>=<span class="hljs-string">"option in field.options"</span>
          <span class="hljs-attr">:key</span>=<span class="hljs-string">"option.value"</span>
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
            <span class="hljs-attr">:value</span>=<span class="hljs-string">"option.value"</span>
            <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData[field.name]"</span>
          &gt;</span>
          {{ option.label }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>可以看到，模板里有很多条件判断，代码结构比较复杂。现在来看看用JSX如何实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'config'</span>],
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">formData</span>: {}
    }
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">renderField</span> = (<span class="hljs-params">field</span>) =&gt; {
      <span class="hljs-keyword">const</span> commonProps = {
        <span class="hljs-attr">name</span>: field.<span class="hljs-property">name</span>,
        <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>[field.<span class="hljs-property">name</span>],
        <span class="hljs-attr">onInput</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>[field.<span class="hljs-property">name</span>] = value
        }
      }

      <span class="hljs-keyword">switch</span> (field.<span class="hljs-property">type</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'input'</span>:
          <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span>
              {<span class="hljs-attr">...commonProps</span>}
              <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
              <span class="hljs-attr">required</span>=<span class="hljs-string">{field.required}</span>
              <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{field.placeholder}</span>
            /&gt;</span></span>
          )
        
        <span class="hljs-keyword">case</span> <span class="hljs-string">'select'</span>:
          <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> {<span class="hljs-attr">...commonProps</span>}&gt;</span>
              {field.options.map(option =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{option.value}</span>&gt;</span>
                  {option.label}
                <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span>
          )
        
        <span class="hljs-keyword">case</span> <span class="hljs-string">'checkbox'</span>:
          <span class="hljs-keyword">return</span> (
            <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
              {field.options.map(option =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                    <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
                    <span class="hljs-attr">value</span>=<span class="hljs-string">{option.value}</span>
                    <span class="hljs-attr">checked</span>=<span class="hljs-string">{this.formData[field.name]?.includes(option.value)}</span>
                    <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
                      const values = this.formData[field.name] || []
                      if (e.target.checked) {
                        this.formData[field.name] = [...values, option.value]
                      } else {
                        this.formData[field.name] = values.filter(v =&gt; v !== option.value)
                      }
                    }}
                  /&gt;
                  {option.label}
                <span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
          )
        
        <span class="hljs-attr">default</span>:
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
      }
    }

    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-renderer"</span>&gt;</span>
        {this.config.map(field =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{field.name}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>{field.label}<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
            {renderField(field)}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
</code></pre>
<p>用JSX实现的代码结构更清晰，逻辑更集中。特别是当表单字段类型增多时，只需要在switch语句中添加新的case即可，扩展性更好。</p>
<h2 data-id="heading-5">高级技巧：递归组件与动态组件</h2>
<p>渲染函数和JSX在处理递归组件和动态组件时尤其强大。比如我们要实现一个无限级嵌套的树形组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'TreeNode'</span>,
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">node</span>: <span class="hljs-title class_">Object</span>
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">renderNode</span> = (<span class="hljs-params">node</span>) =&gt; {
      <span class="hljs-comment">// 如果有子节点，递归渲染</span>
      <span class="hljs-keyword">if</span> (node.<span class="hljs-property">children</span> &amp;&amp; node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> (
          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tree-node"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"node-content"</span>&gt;</span>{node.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"children"</span>&gt;</span>
              {node.children.map(child =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">TreeNode</span> <span class="hljs-attr">node</span>=<span class="hljs-string">{child}</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{child.id}</span> /&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
        )
      }
      
      <span class="hljs-comment">// 叶子节点</span>
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tree-node leaf"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"node-content"</span>&gt;</span>{node.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      )
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title function_">renderNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span>)
  }
}
</code></pre>
<p>在JSX中，我们可以直接使用组件名来引用当前组件，实现递归渲染。这在模板中虽然也能实现，但写起来会比较别扭。</p>
<p>再看动态组件的例子。假设我们需要根据数据类型动态选择不同的展示组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> componentMap = {
  <span class="hljs-attr">text</span>: <span class="hljs-title class_">TextDisplay</span>,
  <span class="hljs-attr">image</span>: <span class="hljs-title class_">ImageDisplay</span>,
  <span class="hljs-attr">video</span>: <span class="hljs-title class_">VideoDisplay</span>,
  <span class="hljs-attr">chart</span>: <span class="hljs-title class_">ChartDisplay</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'data'</span>],
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicComponent</span> = componentMap[<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">type</span>]
    
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">DynamicComponent</span>) {
      <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>未知数据类型<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    }

    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DynamicComponent</span> 
        <span class="hljs-attr">data</span>=<span class="hljs-string">{this.data}</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"data-display"</span>
      /&gt;</span></span>
    )
  }
}
</code></pre>
<p>这种动态组件的选择逻辑在JSX中表达得非常自然，如果要用模板的话，需要配合<code>&lt;component :is="componentType"&gt;</code>语法，但在复杂逻辑下不如JSX直观。</p>
<h2 data-id="heading-6">性能优化与最佳实践</h2>
<p>使用渲染函数和JSX时，有几个性能优化的要点需要注意。</p>
<p>首先是正确的使用key。在循环渲染元素时，一定要提供稳定且唯一的key：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {this.items.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>其次是避免不必要的重新渲染。在复杂的渲染函数中，可以合理使用计算属性和方法来缓存一些中间结果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'items'</span>],
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">processedItems</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 复杂的处理逻辑放在计算属性中</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
        ...item,
        <span class="hljs-attr">processed</span>: <span class="hljs-literal">true</span>
      }))
    }
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        {this.processedItems.map(item =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
</code></pre>
<p>另外，在JSX中正确使用插槽。Vue的插槽在JSX中有对应的写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义带插槽的组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-header"</span>&gt;</span>
          {this.$slots.header}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
          {this.$slots.default}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-footer"</span>&gt;</span>
          {this.$slots.footer}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}

<span class="hljs-comment">// 使用带插槽的组件</span>
<span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Card</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot</span>=<span class="hljs-string">"header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这里是主要内容<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">slot</span>=<span class="hljs-string">"footer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>确定<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-7">与Composition API的完美结合</h2>
<p>在Vue 3的Composition API中，渲染函数和JSX的配合更加默契。我们可以在setup函数中直接返回渲染函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'items'</span>],
  <span class="hljs-title function_">setup</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-keyword">const</span> searchQuery = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
    
    <span class="hljs-keyword">const</span> filteredItems = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> props.<span class="hljs-property">items</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span>
        item.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(searchQuery.<span class="hljs-property">value</span>)
      )
    })
    
    <span class="hljs-comment">// 直接返回渲染函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
          <span class="hljs-attr">vModel</span>=<span class="hljs-string">{searchQuery.value}</span>
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"搜索..."</span>
        /&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          {filteredItems.value.map(item =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
</code></pre>
<p>这种写法让逻辑和UI更加紧密地结合在一起，代码的组织方式更加灵活。</p>
<h2 data-id="heading-8">实战：封装一个高级表格组件</h2>
<p>让我们用JSX封装一个功能丰富的高级表格组件，支持动态列、排序、筛选等功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">data</span>: <span class="hljs-title class_">Array</span>,
    <span class="hljs-attr">columns</span>: <span class="hljs-title class_">Array</span>,
    <span class="hljs-attr">sortable</span>: <span class="hljs-title class_">Boolean</span>
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">sortKey</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">sortOrder</span>: <span class="hljs-string">'asc'</span>,
      <span class="hljs-attr">filters</span>: {}
    }
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">processedData</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">let</span> result = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>]
      
      <span class="hljs-comment">// 应用筛选</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filters</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (value) {
          result = result.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> 
            <span class="hljs-title class_">String</span>(item[key]).<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">includes</span>(value.<span class="hljs-title function_">toLowerCase</span>())
          )
        }
      })
      
      <span class="hljs-comment">// 应用排序</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span>) {
        result.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> aVal = a[<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span>]
          <span class="hljs-keyword">const</span> bVal = b[<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span>]
          <span class="hljs-keyword">const</span> modifier = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortOrder</span> === <span class="hljs-string">'asc'</span> ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span>
          
          <span class="hljs-keyword">if</span> (aVal &lt; bVal) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span> * modifier
          <span class="hljs-keyword">if</span> (aVal &gt; bVal) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> * modifier
          <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
        })
      }
      
      <span class="hljs-keyword">return</span> result
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleSort</span>(<span class="hljs-params">key</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span> === key) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortOrder</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortOrder</span> === <span class="hljs-string">'asc'</span> ? <span class="hljs-string">'desc'</span> : <span class="hljs-string">'asc'</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortKey</span> = key
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">sortOrder</span> = <span class="hljs-string">'asc'</span>
      }
    },
    
    <span class="hljs-title function_">handleFilter</span>(<span class="hljs-params">key, value</span>) {
      <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filters</span>, key, value)
    }
  },
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"advanced-table"</span>&gt;</span>
        {/* 表头 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-header"</span>&gt;</span>
          {this.columns.map(column =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header-cell"</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{column.key}</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{column.title}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              
              {/* 排序按钮 */}
              {this.sortable &amp;&amp; (
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
                  <span class="hljs-attr">class</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">sort-btn</span> ${<span class="hljs-attr">this.sortKey</span> === <span class="hljs-string">column.key</span> ? '<span class="hljs-attr">active</span>' <span class="hljs-attr">:</span> ''}`}
                  <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> this.handleSort(column.key)}
                &gt;
                  {this.sortKey === column.key &amp;&amp; this.sortOrder === 'asc' ? '↑' : '↓'}
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
              )}
              
              {/* 筛选输入框 */}
              <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
                <span class="hljs-attr">class</span>=<span class="hljs-string">"filter-input"</span>
                <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"筛选..."</span>
                <span class="hljs-attr">value</span>=<span class="hljs-string">{this.filters[column.key]</span> || ''}
                <span class="hljs-attr">onInput</span>=<span class="hljs-string">{(e)</span> =&gt;</span> this.handleFilter(column.key, e.target.value)}
              /&gt;
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        {/* 表格内容 */}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-body"</span>&gt;</span>
          {this.processedData.map((row, index) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-row"</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>&gt;</span>
              {this.columns.map(column =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"table-cell"</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{column.key}</span>&gt;</span>
                  {column.render ? column.render(row) : row[column.key]}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
</code></pre>
<p>这个表格组件展示了JSX在复杂组件封装中的强大能力。我们可以很灵活地控制渲染逻辑，实现各种动态功能。</p>
<h2 data-id="heading-9">什么时候该用，什么时候不该用</h2>
<p>虽然渲染函数和JSX很强大，但并不是所有场景都适合使用。这里给你一些实用的建议：</p>
<p><strong>推荐使用渲染函数/JSX的场景：</strong></p>
<ul>
<li>需要高度动态的组件结构</li>
<li>复杂的条件渲染逻辑</li>
<li>递归组件</li>
<li>基于运行时条件动态选择组件</li>
<li>需要更大编程灵活性的高级组件库</li>
</ul>
<p><strong>不推荐使用的场景：</strong></p>
<ul>
<li>简单的静态布局</li>
<li>团队对JSX不熟悉</li>
<li>需要设计师或非技术人员参与模板修改</li>
<li>已经用模板写得很好的常规业务组件</li>
</ul>
<p>记住，技术选型的核心是选择合适的工具解决问题，而不是追求最新最潮的技术。</p>
<h2 data-id="heading-10">从模板平滑迁移到JSX</h2>
<p>如果你决定在项目中尝试JSX，这里有一些平滑迁移的建议：</p>
<p>首先，可以从一些简单的组件开始尝试。比如先找一个逻辑比较复杂的组件，用JSX重写，感受一下差异。</p>
<p>其次，充分利用Vue Devtools。JSX组件在Devtools中的调试体验和模板组件基本一致，你可以正常查看组件层次、props、状态等信息。</p>
<p>另外，建立团队的代码规范。JSX给了我们更大的灵活性，但也需要相应的规范来保证代码质量。比如规定何时使用JSX、代码组织方式等。</p>
<p>最后，记住模板和JSX可以共存。你不需要一次性重写所有组件，可以在同一个项目中混合使用，根据每个组件的特性选择合适的技术。</p>
<h2 data-id="heading-11">结尾：拥抱更灵活的Vue开发方式</h2>
<p>今天我们深入探讨了Vue渲染函数和JSX在动态场景中的应用。从基础的语法到高级的实战技巧，相信你已经感受到了这种开发方式的魅力。</p>
<p>记住，模板、渲染函数、JSX都是Vue生态中的重要组成部分，它们各有适用的场景。作为开发者，我们的目标是掌握各种工具，然后在合适的场景选择合适的技术。</p>
<p>JSX和渲染函数不是要取代模板，而是为我们提供了另一种解决问题的思路。当模板遇到瓶颈时，知道还有这样一条路可以走，这才是最重要的。</p>
<p>现在，你是否已经在想自己的哪个项目可以用上这些技术了？欢迎在评论区分享你的想法和问题，我们一起探讨Vue开发的更多可能性！</p>
<p>下次再见，希望你已经准备好用更灵活的方式编写Vue组件了！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战 - Python实用工具与库 - 文件批量处理脚本]]></title>    <link>https://juejin.cn/post/7572062035141132298</link>    <guid>https://juejin.cn/post/7572062035141132298</guid>    <pubDate>2025-11-13T23:53:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572062035141132298" data-draft-id="7572087181608190002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战 - Python实用工具与库 - 文件批量处理脚本"/> <meta itemprop="keywords" content="后端,面试,Python"/> <meta itemprop="datePublished" content="2025-11-13T23:53:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战 - Python实用工具与库 - 文件批量处理脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T23:53:36.000Z" title="Thu Nov 13 2025 23:53:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在实际开发、数据整理或办公自动化中，我们经常需要一次性处理大量文件，例如：</p>
</blockquote>
<ul>
<li>批量重命名文件</li>
<li>批量复制/移动文件</li>
<li>批量压缩文件</li>
<li>批量格式转换</li>
<li>批量读取与写入文本内容</li>
</ul>
<p>Python 的标准库中，<code>os</code>、<code>shutil</code>、<code>glob</code> 等模块可以轻松构建各种文件批处理脚本，是自动化办公与数据清洗的利器。</p>
<p>本章将从常见场景出发，通过示例脚本帮助你快速掌握文件批量处理能力。</p>
<hr/>
<h2 data-id="heading-0">一、基础库介绍</h2>
<h4 data-id="heading-1"><strong>1. os 模块</strong></h4>
<p>提供文件路径、文件夹、新建/删除目录等操作。</p>
<p>常用方法：</p>
<ul>
<li><code>os.listdir()</code></li>
<li><code>os.rename()</code></li>
<li><code>os.path.exists()</code></li>
<li><code>os.makedirs()</code></li>
<li><code>os.remove()</code></li>
</ul>
<h4 data-id="heading-2"><strong>2. shutil 模块</strong></h4>
<p>执行高级文件操作：</p>
<ul>
<li>拷贝文件：<code>shutil.copy()</code></li>
<li>移动文件：<code>shutil.move()</code></li>
<li>拷贝整个文件夹：<code>shutil.copytree()</code></li>
</ul>
<h4 data-id="heading-3"><strong>3. glob 模块</strong></h4>
<p>使用通配符批量匹配文件，例如：</p>
<pre><code class="hljs language-python" lang="python">glob.glob(<span class="hljs-string">"*.txt"</span>)
glob.glob(<span class="hljs-string">"images/*.jpg"</span>)
</code></pre>
<p>是处理大量文件时非常方便的模块。</p>
<hr/>
<h2 data-id="heading-4">二、批量重命名文件</h2>
<p>例如：把文件名全部改为统一格式 <code>img_001.jpg、img_002.jpg</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os

folder = <span class="hljs-string">"images"</span>

files = os.listdir(folder)

<span class="hljs-keyword">for</span> i, filename <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(files, start=<span class="hljs-number">1</span>):
    old_path = os.path.join(folder, filename)
    ext = os.path.splitext(filename)[<span class="hljs-number">1</span>]
    new_name = <span class="hljs-string">f"img_<span class="hljs-subst">{i:03d}</span><span class="hljs-subst">{ext}</span>"</span>
    new_path = os.path.join(folder, new_name)
    os.rename(old_path, new_path)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"重命名完成。"</span>)
</code></pre>
<p><strong>技术要点</strong></p>
<ul>
<li><code>os.path.splitext()</code> 可获得文件扩展名</li>
<li><code>i:03d</code> 生成 001、002 的数字序号</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、批量复制/移动文件</h2>
<h4 data-id="heading-6"><strong>1. 批量复制</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">import</span> glob

src_files = glob.glob(<span class="hljs-string">"data/*.txt"</span>)
dst_folder = <span class="hljs-string">"backup"</span>

os.makedirs(dst_folder, exist_ok=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> src_files:
    shutil.copy(file, dst_folder)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"复制完成。"</span>)
</code></pre>
<h4 data-id="heading-7"><strong>2. 批量移动</strong></h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">import</span> glob

<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> glob.glob(<span class="hljs-string">"data/*.csv"</span>):
    shutil.move(file, <span class="hljs-string">"csv_files"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"移动完成。"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-8">四、批量删除文件</h2>
<p>例如，删除所有 <code>.log</code> 文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> glob

<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> glob.glob(<span class="hljs-string">"logs/*.log"</span>):
    os.remove(file)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除完成。"</span>)
</code></pre>
<p>目录删除使用 <code>shutil.rmtree("folder")</code>。</p>
<hr/>
<h2 data-id="heading-9">五、批量读取文本内容并写入汇总文件</h2>
<p>比如，你有 100 个 <code>.txt</code> 日志文件，需要汇总到一个文件。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> glob

files = glob.glob(<span class="hljs-string">"logs/*.txt"</span>)

<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"summary.txt"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> outfile:
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
            outfile.write(<span class="hljs-string">f"=== 文件：<span class="hljs-subst">{file}</span> ===\n"</span>)
            outfile.write(f.read())
            outfile.write(<span class="hljs-string">"\n\n"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"汇总完成。"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-10">六、批量修改文件内容（查找 + 替换）</h2>
<p>在大量 <code>.txt</code> 文件中，将所有 <code>"测试"</code> 替换为 <code>"正式"</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> glob

<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> glob.glob(<span class="hljs-string">"docs/*.txt"</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        text = f.read()

    text = text.replace(<span class="hljs-string">"测试"</span>, <span class="hljs-string">"正式"</span>)

    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        f.write(text)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"批量替换完成。"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-11">七、批量压缩文件（zipfile模块）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> zipfile
<span class="hljs-keyword">import</span> glob

files = glob.glob(<span class="hljs-string">"data/*.csv"</span>)

<span class="hljs-keyword">with</span> zipfile.ZipFile(<span class="hljs-string">"data.zip"</span>, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">as</span> zipf:
    <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:
        zipf.write(file)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"压缩完成。"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-12">八、批量处理的实战案例：自动整理下载目录</h2>
<p>下面给出一个实战脚本，把下载目录按文件类型分类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">import</span> glob

download_folder = <span class="hljs-string">"downloads"</span>

file_types = {
    <span class="hljs-string">"图片"</span>: [<span class="hljs-string">"*.jpg"</span>, <span class="hljs-string">"*.png"</span>],
    <span class="hljs-string">"视频"</span>: [<span class="hljs-string">"*.mp4"</span>],
    <span class="hljs-string">"压缩包"</span>: [<span class="hljs-string">"*.zip"</span>, <span class="hljs-string">"*.rar"</span>],
    <span class="hljs-string">"文档"</span>: [<span class="hljs-string">"*.pdf"</span>, <span class="hljs-string">"*.docx"</span>, <span class="hljs-string">"*.txt"</span>]
}

<span class="hljs-keyword">for</span> folder_name, patterns <span class="hljs-keyword">in</span> file_types.items():
    target_folder = os.path.join(download_folder, folder_name)
    os.makedirs(target_folder, exist_ok=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> patterns:
        <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> glob.glob(os.path.join(download_folder, pattern)):
            shutil.move(file, target_folder)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"下载目录已整理完毕！"</span>)
</code></pre>
<p>执行后，文件会自动分类到各自目录，办公效率提升非常明显。</p>
<hr/>
<h2 data-id="heading-13">九、文件批处理脚本的最佳实践</h2>
<ul>
<li><strong>使用 glob 匹配大量文件更快</strong></li>
<li><strong>写入文件前备份原文件</strong></li>
<li><strong>对文件操作加入 try/except 防止脚本崩溃</strong></li>
<li>复杂任务建议封装成函数或类</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">try</span>:
    shutil.move(src, dst)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"移动失败："</span>, e)
</code></pre>
<hr/>
<h2 data-id="heading-14">十、总结</h2>
<p>本章你掌握了 Python 在文件自动化中的核心技能：</p>
<ul>
<li>批量重命名</li>
<li>批量复制、移动、删除</li>
<li>批量读取、写入和替换内容</li>
<li>批量压缩</li>
<li>使用 glob 进行文件匹配</li>
<li>实战：自动整理下载目录</li>
</ul>
<p>这些脚本结合日常办公场景，可以最大化提升工作效率，是每个 Python 工程师必须掌握的技能点。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 编程实战 · 实用工具与库 — Flask 基础入门]]></title>    <link>https://juejin.cn/post/7572095192418123803</link>    <guid>https://juejin.cn/post/7572095192418123803</guid>    <pubDate>2025-11-13T23:54:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572095192418123803" data-draft-id="7572087181608206386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 编程实战 · 实用工具与库 — Flask 基础入门"/> <meta itemprop="keywords" content="后端,面试,Python"/> <meta itemprop="datePublished" content="2025-11-13T23:54:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 编程实战 · 实用工具与库 — Flask 基础入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T23:54:17.000Z" title="Thu Nov 13 2025 23:54:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Flask 是 Python 生态中最灵活、最轻量的 Web 框架之一，非常适合快速构建接口、网站原型、后台服务等。它遵循 WSGI 标准，核心库极其简洁，但可以通过插件无限扩展。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0"><strong>1. Flask 基础概念</strong></h2>
<h3 data-id="heading-1">✔ Flask 是什么？</h3>
<ul>
<li>一个 <strong>微框架（Micro Framework）</strong></li>
<li>默认只提供核心组件：路由、请求处理、模板、调试器</li>
<li>需要什么功能就安装什么扩展（ORM、表单验证、JWT、数据库等）</li>
</ul>
<h3 data-id="heading-2">✔ Flask 的优势</h3>
<ul>
<li>
<p>代码简洁、上手快</p>
</li>
<li>
<p>灵活度极高（不像 Django 那样有强约束）</p>
</li>
<li>
<p>大量插件生态，如：</p>
<ul>
<li>Flask-RESTful（构建 REST API）</li>
<li>Flask-SQLAlchemy（数据库 ORM）</li>
<li>Flask-Login（登录鉴权）</li>
<li>Flask-JWT-Extended（JWT）</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-3"><strong>2. Flask 环境搭建</strong></h2>
<pre><code class="hljs language-bash" lang="bash">pip install flask
</code></pre>
<p>验证安装：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> flask
<span class="hljs-built_in">print</span>(flask.__version__)
</code></pre>
<hr/>
<h2 data-id="heading-4"><strong>3. 第一个 Flask 项目</strong></h2>
<p>创建 <code>app.py</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask

app = Flask(__name__)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello Flask!"</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(debug=<span class="hljs-literal">True</span>)
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-bash" lang="bash">python app.py
</code></pre>
<p>浏览器访问：</p>
<pre><code class="hljs language-arduino" lang="arduino">http:<span class="hljs-comment">//127.0.0.1:5000/</span>
</code></pre>
<hr/>
<h2 data-id="heading-5"><strong>4. 路由（Routing）</strong></h2>
<p>路由就是 URL 与函数的映射。</p>
<h3 data-id="heading-6">① 基本路由</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/hello'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello!"</span>
</code></pre>
<h3 data-id="heading-7">② 路由参数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/user/&lt;name&gt;'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_user</span>(<span class="hljs-params">name</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"User: <span class="hljs-subst">{name}</span>"</span>
</code></pre>
<p>类型转换器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/add/&lt;int:a&gt;/&lt;int:b&gt;'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(a + b)
</code></pre>
<hr/>
<h2 data-id="heading-8"><strong>5. 请求与响应</strong></h2>
<p>Flask 提供 <code>request</code> 对象用于获取 HTTP 请求数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/login'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():
    username = request.form.get(<span class="hljs-string">'username'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Welcome <span class="hljs-subst">{username}</span>"</span>
</code></pre>
<h4 data-id="heading-9">✔ 获取不同数据来源：</h4>

























<table><thead><tr><th>来源</th><th>写法</th></tr></thead><tbody><tr><td>URL 参数</td><td><code>request.args</code></td></tr><tr><td>表单数据</td><td><code>request.form</code></td></tr><tr><td>JSON 数据</td><td><code>request.json</code></td></tr><tr><td>文件上传</td><td><code>request.files</code></td></tr></tbody></table>
<p>示例：JSON 接口</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/add'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">api_add</span>():
    data = request.json
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"result"</span>: data[<span class="hljs-string">"a"</span>] + data[<span class="hljs-string">"b"</span>]
    }
</code></pre>
<hr/>
<h2 data-id="heading-10"><strong>6. 返回 JSON 数据</strong></h2>
<p>推荐使用 <code>jsonify</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> jsonify

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/info'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">info</span>():
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">"name"</span>: <span class="hljs-string">"Flask"</span>, <span class="hljs-string">"version"</span>: <span class="hljs-number">2.0</span>})
</code></pre>
<hr/>
<h2 data-id="heading-11"><strong>7. 模板渲染（Jinja2）</strong></h2>
<p>Flask 默认使用 <strong>Jinja2</strong> 模板引擎。</p>
<p>目录结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">project/
  app.py
  templates/
<span class="hljs-code">    index.html
</span></code></pre>
<p><code>app.py</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> render_template

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/page'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">page</span>():
    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">'index.html'</span>, title=<span class="hljs-string">"首页"</span>)
</code></pre>
<p><code>index.html</code>:</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-12"><strong>8. 静态文件（CSS/JS/图片）</strong></h2>
<p>默认路径：<code>static/</code></p>
<pre><code class="hljs language-arduino" lang="arduino">project/
  <span class="hljs-type">static</span>/
    style.css
</code></pre>
<p>HTML 使用：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/static/style.css"</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-13"><strong>9. 项目结构推荐（小型项目）</strong></h2>
<pre><code class="hljs language-arduino" lang="arduino">project/
  app.py
  templates/
  <span class="hljs-type">static</span>/
  requirements.txt
</code></pre>
<hr/>
<h2 data-id="heading-14"><strong>10. Flask 扩展（常用）</strong></h2>

































<table><thead><tr><th>功能</th><th>扩展</th></tr></thead><tbody><tr><td>ORM</td><td>Flask-SQLAlchemy</td></tr><tr><td>登录鉴权</td><td>Flask-Login</td></tr><tr><td>表单验证</td><td>WTForms / Flask-WTF</td></tr><tr><td>REST API</td><td>Flask-RESTful</td></tr><tr><td>跨域</td><td>Flask-Cors</td></tr><tr><td>JWT</td><td>Flask-JWT-Extended</td></tr></tbody></table>
<p>安装示例：</p>
<pre><code class="hljs language-bash" lang="bash">pip install flask_sqlalchemy
pip install flask_cors
</code></pre>
<hr/>
<h2 data-id="heading-15"><strong>11. 生产环境部署</strong></h2>
<p>开发环境用 Flask 自带的调试服务器即可，但生产环境应使用：</p>
<ul>
<li><strong>Gunicorn + Nginx</strong>（Linux）</li>
<li><strong>Waitress</strong>（Windows）</li>
<li><strong>Docker</strong>（最佳方案）</li>
</ul>
<p>示例（Gunicorn）：</p>
<pre><code class="hljs language-bash" lang="bash">gunicorn -w 4 app:app
</code></pre>
<hr/>
<h2 data-id="heading-16"><strong>12. 实战练习：构建简易 REST API</strong></h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify

app = Flask(__name__)

db = []

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/items'</span>, methods=[<span class="hljs-string">'GET'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_items</span>():
    <span class="hljs-keyword">return</span> jsonify(db)

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/items'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_item</span>():
    item = request.json
    db.append(item)
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">"msg"</span>: <span class="hljs-string">"added"</span>, <span class="hljs-string">"item"</span>: item})

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run(debug=<span class="hljs-literal">True</span>)
</code></pre>
<p>测试 POST 接口：</p>
<pre><code class="hljs language-json" lang="json">POST /items
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"apple"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"qty"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-17"><strong>总结</strong></h2>
<p>通过这篇内容，你已经掌握 Flask 的基础技能：</p>
<p>✔ 搭建 Flask 项目
✔ 路由配置
✔ 请求与响应
✔ 处理 JSON / 表单
✔ 模板引擎
✔ 静态文件
✔ 推荐项目结构
✔ REST API 实战</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT-5.1 核心特性深度解析，它会是模型性能的新标杆吗？]]></title>    <link>https://juejin.cn/post/7572010680897257512</link>    <guid>https://juejin.cn/post/7572010680897257512</guid>    <pubDate>2025-11-14T00:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680897257512" data-draft-id="7572016447805521946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT-5.1 核心特性深度解析，它会是模型性能的新标杆吗？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-14T00:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT-5.1 核心特性深度解析，它会是模型性能的新标杆吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T00:02:41.000Z" title="Fri Nov 14 2025 00:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>距离OpenAI发布GPT-5仅仅过去三个月，我们便迎来了其旗舰模型的又一次重要升级——<strong>GPT-5.1</strong>正式亮相。根据官方报告，新版模型在对话情商、逻辑推理和代码生成等多方面实现了显著提升。</p>
<p>回顾今年，基座模型领域呈现出爆发式的发展态势。笔者曾撰写多篇文章，深入解析了包括<a href="https://juejin.cn/post/7555687221233631278" target="_blank" title="https://juejin.cn/post/7555687221233631278">DeepSeek系列</a>、<a href="https://juejin.cn/post/7530202220802359331" target="_blank" title="https://juejin.cn/post/7530202220802359331">Qwen系列</a>和<a href="https://juejin.cn/post/7507554645227536411" target="_blank" title="https://juejin.cn/post/7507554645227536411">Claude系列</a>在内的主流模型技术演进。而OpenAI作为行业领军者，其更新节奏尤为引人注目：从年初主打高情商对话但成本较高的GPT-4.5，到随后实现降本增效的GPT-4.1，再到在编程推理能力上实现突破但对话体验有所妥协的GPT-5，直至如今实现全面均衡发展的GPT-5.1。这一系列快速迭代，清晰地展现了OpenAI对基座模型最优形态的持续探索。</p>
<p>本篇分享笔者将和大家一起深入解析GPT-5.1的核心特性，共同探讨这次更新是否能够树立模型性能的新标杆~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e28dee23578f40d393bb0f413a25ad44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=FL8v0QzgWpTxY6FomntdgqlZKn0%3D" alt="14.png" loading="lazy"/></p>
<h2 data-id="heading-1">一、高情商对话</h2>
<p>或许是考虑到日常对话才是用户最高频的使用场景，也或许是为了回应此前GPT-5在对话表现上“情商不足”的批评，本次GPT-5.1选择将“提升模型情商”作为重点发力方向，致力于让模型回复更具人情味与交流感。用OpenAI官方的表述来说，就是实现了“more conversational”（更自然的对话体验），而实际测试中，GPT-5.1在这方面的进步也确实令人印象深刻。</p>
<p>以询问“不存在的海马emoji”为例，GPT-5.1并没有直接否定问题的前提，而是先列举多个可能与海马相关的现有表情供用户参考，随后逐步引导用户意识到：目前Unicode字符集中确实没有专门的海马emoji。更值得一提的是，它在回复中通过字号变化逐步突出重点，营造出引人入胜的对话节奏，整个对话体验非常棒！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a43ad14d6cc94d6c9a2ff92f6e824799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=cDHLNxFq2DNI72fvQJF3qBQs4MM%3D" alt="7.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c72f960cf48401e837950f05f724a69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=qGLqPtDsBLoJqTboS9DiM33Aje8%3D" alt="8.png" loading="lazy"/></p>
<p>反观GPT-5，不仅回复风格较为生硬，仅给出直接结论，甚至还出现了“幻觉”，错误地提供了一个并不存在的emoji作为答案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/481da0c159d044e59d71f6f91223d9ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=iO%2Bm%2FUID4rGdvUDmtHl4ywQX%2FBI%3D" alt="9.png" loading="lazy"/></p>
<p>在情感类问题的处理上，GPT-5.1同样展现出更强的共情能力。它会先体察用户情绪，给予安慰，再进一步提供建议；而GPT-5则往往直接输出几条冷冰冰的建议条目。根据笔者多次测试，无论问题是否实际、情绪是否合理，GPT-5.1都能站在用户的角度给予理解与回应，真正做到“人情味拉满”。相信这一提升，将对聊天对话、角色扮演等强交互类应用带来显著体验优化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da70354e47884f1bbba4f9c2333ecce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=vaRZ3KBUjLg%2FQbQGs%2B6ipemfOek%3D" alt="10.png" loading="lazy"/></p>
<h2 data-id="heading-2">二、指令跟随能力提升</h2>
<p>模型在对话中展现出更强的“人情味”，其实质是指令跟随能力的大幅进步。笔者通过一项测试来直观对比：要求模型始终以6个字进行回复。结果显示，GPT-5.1能够严格遵循该设定，保持回复长度一致；而GPT-5在多次交互后逐渐忽略初始指令，甚至出现回复内容溢出、结构混乱的情况。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/797241d5af834d7fbeff5dfb924dfbe7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=Gggh73QiAMLVogMuaboFeE5KiMk%3D" alt="11.png" loading="lazy"/></p>
<p>指令跟随能力的增强，直接提升了Agent智能体在实际应用中的表现。一方面，系统消息的设置能够更稳定地生效，另一方面，模型调用外部工具的准确率也得到改善。可以说，GPT-5.1不仅优化了对话体验，也为构建更可靠、高效的智能体系统奠定了坚实基础。</p>
<p>此外，GPT-5.1还内置了多种对话风格，用户可根据场景灵活选用。根据笔者测试，结合不同的语气风格与系统提示词，GPT-5.1能够胜任多种类型的对话交互与文本生成任务，展现出优秀的适应性与可控性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d19d52c32bfc4a20938122ace1fabaf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=7QLaHgv0TZmEPdBCsQznLbre63E%3D" alt="1.png" loading="lazy"/></p>
<h2 data-id="heading-3">三、编程能力显著增强</h2>
<p>除了指令跟随能力的显著提升，GPT-5.1在编程方面也实现了跨越式进步。无论是开发小游戏、构建响应式前端页面，还是实现复杂的交互效果，GPT-5.1都展现出全球顶尖的代码生成与理解能力，稳居第一梯队模型之列。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c238207473b493dab92cbf4987bd1c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=GkxpBRu0xNmO%2BPG%2FH2owVwXMfRY%3D" alt="12.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e46692d796e4b62a0d118cd7a832c1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=UdMu9aDdDrPpzMQfx9iJhul9k0E%3D" alt="13.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeecc83ac3af4650a55636c81d9beaef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=qWO1a1NhF37gEGkHYXae0g3tV7M%3D" alt="2.gif" loading="lazy"/></p>
<p>更值得注意的是，GPT-5.1在物理遵循能力方面取得了重大突破。过去，在模拟复杂物体运动与交互的领域，Claude系列模型曾占据明显优势；而如今，GPT-5.1正快速迎头赶上。以“砖块烟囱模拟爆破”任务为例：GPT-5所生成的程序几乎无法反映真实的物理规律，运行效果混乱，难以体现出合理的运动逻辑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/634009c397d44034b953c83ad5a0fc0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=DUhmTr%2FPJmztqqy08VUgcRCgids%3D" alt="0.gif" loading="lazy"/></p>
<p>反观GPT-5.1，在相同任务中不仅能够模拟出基本的物理过程，整体效果已接近Claude 4.5的水平。尽管仍存在细微瑕疵，但其在运动轨迹、碰撞响应等方面已具备合理的物理一致性，进步显著。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4a1b6047788475f9070af2453647fa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=at0UQEY2zd1Ol4ETHEuRBMz0%2BQg%3D" alt="1.gif" loading="lazy"/></p>
<h2 data-id="heading-4">四、自适应推理机制</h2>
<p>除了在指令跟随与编程能力上的显著进步，GPT-5.1 还首次引入了“自适应推理机制”，能够根据问题的复杂程度动态调整思考深度，实现效率与效果之间的智能平衡。具体来说，GPT-5.1 发布了两类不同定位的模型：</p>
<ul>
<li><strong>GPT-5.1-Instant</strong>：面向日常对话场景，适用于大多数通用聊天任务；</li>
<li><strong>GPT-5.1-Thinking</strong>：专为复杂推理问题设计，具备更强的思维链推导能力。</li>
</ul>
<p>所谓的“自适应推理机制”，即模型能够自动识别用户问题的复杂度，并据此为<strong>GPT-5.1-Thinking</strong>动态设定思维链长度。这是当前推理模型领域的前沿发展方向：对简单问题减少思维步骤以提升响应速度，对复杂问题则增加思维步骤以保障回答质量。根据 OpenAI 发布的数据，与 GPT-5 相比：在简单问题上，GPT-5.1 的思维链长度减少了 57%；在复杂问题上，其思维链长度则增加了 71%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3697f68dd304cb182f9d2579d25f8dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763683361&amp;x-signature=TuQSQWEWGodWpYvmFqBV8E2z36I%3D" alt="2.png" loading="lazy"/></p>
<p>这一机制并非首次尝试，其雏形可追溯至 GPT-5-CodeX 中所采用的动态推理策略。如今在 GPT-5.1 中进一步成熟，标志着 OpenAI 在推理模型的智能化与资源调度方面再次迈出关键一步！</p>
<h2 data-id="heading-5">五、总结</h2>
<p>从去年推理模型O1的推出，到今年上半年支持人工设定推理强度的混合推理模式，再到如今具备自适应推理能力的GPT-5.1正式发布，大模型技术的发展速度可谓日新月异，OpenAI模型演进路径也愈发清晰。目前，GPT-5.1已在ChatGPT官网全面上线。为平滑过渡，OpenAI将在未来三个月内继续保留GPT-5模型选项。GPT-5.1的API也计划于近期逐步开放。由于该模型仍属于GPT-5系列，其API调用方式预计不会出现大幅变动，方便开发者快速迁移和测试。欢迎大家在实际使用中对比体验，也欢迎在评论区分享你的使用心得~</p>
<p>以上就是本篇分享全部内容，同时也预告一下笔者的专栏<a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>正在火热更新中，最近笔者在组织全新的LangChain1.0 RAG实战分享，带大家构建一个前后端多模态RAG项目，预计本周完成第一期内容，大家敬请期待~</p>
<p><a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>专栏内容源自笔者在实际学习和工作中对 LangChain 与 LangGraph 的深度使用经验，旨在帮助大家系统性地、高效地掌握 AI Agent 的开发方法，在各大技术平台获得了不少关注与支持。如果大家感兴趣，欢迎关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 进阶：企业级性能与可观测性指南]]></title>    <link>https://juejin.cn/post/7572052559821651974</link>    <guid>https://juejin.cn/post/7572052559821651974</guid>    <pubDate>2025-11-13T15:04:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572052559821651974" data-draft-id="7572039006529617956" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 进阶：企业级性能与可观测性指南"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2025-11-13T15:04:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 进阶：企业级性能与可观测性指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T15:04:12.000Z" title="Thu Nov 13 2025 15:04:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>扩展 Spring Boot 应用不仅仅是添加更多服务器。它关乎<strong>工程效率</strong>——在水平扩展之前，从现有硬件中榨取每一分性能。</p>
<p>在本文中，我们将探讨如何为高性能、云原生环境调优、扩展和分析 Spring Boot 应用——包含<strong>实践示例</strong>、<strong>代码注释</strong>和<strong>架构可视化</strong>，你可以立即应用。</p>
<h2 data-id="heading-0">为什么性能优化很重要</h2>
<p>大多数 Spring Boot 应用在开发环境中表现良好，但在生产级负载下崩溃，原因包括：</p>
<ul>
<li>未优化的连接池</li>
<li>低效的缓存</li>
<li>阻塞的 I/O 线程</li>
<li>糟糕的 JVM 配置</li>
</ul>
<blockquote>
<p><strong>目标：</strong> 在扩展基础设施_之前_修复瓶颈。</p>
</blockquote>
<p>我们将涵盖以下内容：</p>
<ul>
<li>连接池与数据库优化</li>
<li>智能缓存策略（Caffeine + Redis）</li>
<li>异步与响应式编程</li>
<li>HTTP 层调优</li>
<li>JVM、GC 与分析技术</li>
<li>可观测性与自动扩缩容</li>
</ul>
<h2 data-id="heading-1">1. 连接池与数据库优化</h2>
<p>数据库连接池通常是 Spring Boot 应用中的<strong>第一个可扩展性瓶颈</strong>。虽然 Spring Boot 内置了 <strong>HikariCP</strong>（最快的连接池之一），但默认配置并未针对生产工作负载进行调优。</p>
<p>让我们看看配置如何影响吞吐量和延迟。</p>
<h3 data-id="heading-2">默认配置（不适合生产）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:postgresql://localhost:5432/app_db</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">app_user</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">secret</span>
</code></pre>
<p>使用默认配置时，HikariCP 会创建一个小的连接池（通常为 10 个连接），这可能导致负载下的<strong>线程阻塞</strong>和<strong>超时</strong>。</p>
<h3 data-id="heading-3">针对高吞吐量的优化配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:postgresql://localhost:5432/app_db</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">app_user</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">secret</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">30</span>     <span class="hljs-comment"># (1) 最大活跃连接数</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>          <span class="hljs-comment"># (2) 预热备用连接</span>
      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">10000</span>       <span class="hljs-comment"># (3) 回收空闲连接</span>
      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span> <span class="hljs-comment"># (4) 失败前的等待时间</span>
      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>     <span class="hljs-comment"># (5) 回收老化连接</span>
</code></pre>
<p><strong>注释：</strong></p>
<ul>
<li>保持 <code>maximum-pool-size</code> ≤ 数据库的实际限制（避免连接耗尽）。</li>
<li><code>minimum-idle</code> 确保在负载峰值下快速响应。</li>
<li><code>max-lifetime</code> &lt; 数据库超时时间可防止<strong>僵尸套接字</strong>。</li>
</ul>
<h3 data-id="heading-4">检测慢查询</h3>
<p>Hibernate 可以记录超过阈值的查询，帮助及早发现性能问题。</p>
<pre><code class="hljs language-properties" lang="properties">spring.jpa.properties.hibernate.session.events.log.LOG_QUERIES_SLOWER_THAN_MS=1000
</code></pre>
<p>这会记录所有超过 1 秒的 SQL——非常适合发现 <strong>N+1 查询</strong>、<strong>缺失索引</strong>或<strong>重度连接</strong>。</p>
<blockquote>
<p>💡 提示：将这些日志与 <strong>Actuator 跟踪指标</strong>结合使用，以关联 API 延迟与数据库查询时间。</p>
</blockquote>
<h3 data-id="heading-5">批量写入优化</h3>
<p>批处理可以显著减少数据库往返次数。</p>
<pre><code class="hljs language-properties" lang="properties">spring.jpa.properties.hibernate.jdbc.batch_size=50
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
</code></pre>
<p>操作 | 无批处理 | 有批处理（size=50）
500 次插入 | 500 次网络调用 | 10 批 × 50 条记录
⏱️ 时间 | ~4s | ~0.4s（快 8–10 倍）</p>
<p><strong>可视化提示：</strong>
将每次数据库写入想象为一次"网络跳转"。批处理使你的应用以更少的跳转到达终点。</p>
<h2 data-id="heading-6">2. 高性能智能缓存策略</h2>
<h3 data-id="heading-7">使用 Caffeine 的内存缓存</h3>
<p>没有缓存时，每个请求都会命中数据库。有了缓存，重复查询可以在<strong>微秒级</strong>返回结果。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableCaching</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfig</span> {
  <span class="hljs-meta">@Bean</span>
  <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaffeineCacheManager</span>(<span class="hljs-string">"products"</span>, <span class="hljs-string">"users"</span>);
  }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
  <span class="hljs-meta">@Cacheable("products")</span>
  <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long id)</span> {
    simulateSlowService(); <span class="hljs-comment">// 2s DB call</span>
    <span class="hljs-keyword">return</span> repository.findById(id).orElseThrow();
  }
}
</code></pre>
<p><strong>结果：</strong></p>
<ul>
<li>首次调用：命中数据库（2s）</li>
<li>后续调用：&lt;10ms（来自缓存）</li>
</ul>
<blockquote>
<p><strong>专业提示：</strong> 使用以下配置调优淘汰策略：</p>
</blockquote>
<pre><code class="hljs language-properties" lang="properties">spring.cache.cache-names=products
spring.cache.caffeine.spec=maximumSize=1000,expireAfterWrite=5m
</code></pre>
<p>这确保过期数据不会滞留，同时避免 OOM。</p>
<h3 data-id="heading-8">使用 Redis 的分布式缓存</h3>
<p>本地缓存在多个应用实例之间不起作用——这时需要 <strong>Redis</strong>。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">cache:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">redis</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">redis:</span>
      <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Cacheable(value = "userProfiles", key = "#id", sync = true)</span>
<span class="hljs-keyword">public</span> UserProfile <span class="hljs-title function_">getUserProfile</span><span class="hljs-params">(Long id)</span> {
  <span class="hljs-keyword">return</span> userRepository.findById(id).orElseThrow();
}
</code></pre>
<blockquote>
<p><code>sync = true</code> 可防止<strong><em>缓存雪崩</em></strong>：如果多个请求同时未命中，只有一个会重新计算。</p>
</blockquote>
<p><strong>图表：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">Client</span> → Spring Boot → Redis Cache → Database
           ↑             ↓
        cache hit     cache miss
</code></pre>
<h2 data-id="heading-9">3. 异步与响应式处理</h2>
<h3 data-id="heading-10">使用 <code>@Async</code> 并行执行</h3>
<p>阻塞调用会扼杀并发性。Spring 的 <code>@Async</code> 支持非阻塞执行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportService</span> {

  <span class="hljs-meta">@Async</span>
  <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">generateReport</span><span class="hljs-params">()</span> {
    simulateHeavyComputation();
    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"Report Ready"</span>);
  }
}

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> {
  <span class="hljs-meta">@Bean</span>
  <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
    executor.setCorePoolSize(<span class="hljs-number">10</span>);
    executor.setMaxPoolSize(<span class="hljs-number">30</span>);
    executor.setQueueCapacity(<span class="hljs-number">100</span>);
    executor.initialize();
    <span class="hljs-keyword">return</span> executor;
  }
}
</code></pre>
<p>📈 <strong>结果：</strong></p>
<ul>
<li>在重负载下延迟降低 30–50%</li>
<li>突发流量期间 CPU 使用率平衡</li>
</ul>
<blockquote>
<p><strong>最佳实践：</strong> 始终使用 Actuator 中的 <code>ThreadPoolTaskExecutorMetrics</code> 监控线程池耗尽情况。</p>
</blockquote>
<h3 data-id="heading-11">使用 Spring WebFlux 的响应式 API</h3>
<p><strong>响应式编程</strong>在<strong>_I/O 密集型_应用</strong>中表现出色，如流式传输、聊天或实时仪表板。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveController</span> {
  <span class="hljs-meta">@GetMapping("/users")</span>
  <span class="hljs-keyword">public</span> Flux&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> userRepository.findAll();
  }
}
</code></pre>
<p>在这里，单个线程处理数千个并发连接——<strong>没有每个请求一个线程的开销</strong>。</p>
<p><strong>可视化流程：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">Request <span class="hljs-number">1</span> → Reactor <span class="hljs-keyword">Event</span> <span class="hljs-keyword">Loop</span>
Request <span class="hljs-number">2</span> → same thread, queued <span class="hljs-keyword">as</span> Flux
Request <span class="hljs-number">3</span> → non-blocking <span class="hljs-keyword">async</span> chain
</code></pre>
<h2 data-id="heading-12">4. HTTP 层优化</h2>
<p>在处理并发 HTTP 请求时，每一毫秒都很重要。</p>
<h3 data-id="heading-13">为生产环境调优 Tomcat</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">tomcat:</span>
    <span class="hljs-attr">threads:</span>
      <span class="hljs-attr">max:</span> <span class="hljs-number">200</span>
      <span class="hljs-attr">min-spare:</span> <span class="hljs-number">20</span>
    <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">5000</span>
    <span class="hljs-attr">accept-count:</span> <span class="hljs-number">100</span>
</code></pre>
<ul>
<li><code>max</code>：2× CPU 核心数（适用于 CPU 密集型应用）</li>
<li><code>accept-count</code>：新连接的队列大小</li>
<li><code>connection-timeout</code>：及早丢弃慢客户端</li>
</ul>
<p><strong>为什么重要：</strong> 线程过多会增加上下文切换。线程过少 → 连接被丢弃。</p>
<h3 data-id="heading-14">为异步工作负载切换到 Undertow</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-undertow<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>Undertow 的事件驱动 I/O 模型在以下场景中扩展性更好：</p>
<ul>
<li>长轮询 API</li>
<li>流式响应</li>
<li>WebFlux 应用</li>
</ul>
<p><strong><em>基准测试：</em></strong> 在异步密集型应用中，Undertow 的延迟性能比 Tomcat 高出 <strong>20–30%</strong>。</p>
<h2 data-id="heading-15">5. JVM 与 GC 优化</h2>
<h3 data-id="heading-16">生产环境的 JVM 参数</h3>
<pre><code class="hljs language-bash" lang="bash">JAVA_OPTS=<span class="hljs-string">"
  -Xms512m -Xmx2048m \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+UseStringDeduplication \
  -XX:+HeapDumpOnOutOfMemoryError"</span>
</code></pre>
<p><strong>主要优势：</strong></p>
<ul>
<li><code>UseG1GC</code>：适合微服务延迟。</li>
<li><code>MaxGCPauseMillis</code>：保持 GC 暂停时间 &lt;200ms。</li>
<li><code>UseStringDeduplication</code>：在 JSON 密集型 API 中节省 20–40% 堆内存。</li>
<li><code>HeapDumpOnOutOfMemoryError</code>：支持崩溃后的根本原因分析。</li>
</ul>
<p><strong><em>专业提示</em></strong><em>：</em> 对于超低延迟应用，测试 <strong>ZGC</strong>（Java 17+）或 <strong>Shenandoah GC</strong>——暂停时间可以降至 10ms 以下。</p>
<h2 data-id="heading-17">6. 可观测性与自动扩缩容</h2>
<h3 data-id="heading-18">Spring Boot Actuator + Micrometer</h3>
<p>无法测量的东西，就无法优化。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,info,metrics,prometheus</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
MeterRegistry registry;

<span class="hljs-meta">@PostConstruct</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerCustomMetric</span><span class="hljs-params">()</span> {
  Gauge.builder(<span class="hljs-string">"custom.activeUsers"</span>, <span class="hljs-built_in">this</span>::getActiveUserCount)
       .description(<span class="hljs-string">"Number of active users"</span>)
       .register(registry);
}
</code></pre>
<p>📈 导出到 Prometheus 并在 Grafana 中可视化：</p>
<ul>
<li>每秒请求数（RPS）</li>
<li>数据库连接利用率</li>
<li>缓存命中率</li>
<li>GC 暂停时长</li>
</ul>
<p><strong>可视化提示：</strong> 将指标组合到"服务健康仪表板"中，关联负载下的 CPU、延迟和内存。</p>
<h3 data-id="heading-19">使用 Kubernetes HPA 自动扩缩容</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">autoscaling/v2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">HorizontalPodAutoscaler</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">minReplicas:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">maxReplicas:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">Resource</span>
      <span class="hljs-attr">resource:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">cpu</span>
        <span class="hljs-attr">target:</span>
          <span class="hljs-attr">averageUtilization:</span> <span class="hljs-number">70</span>
</code></pre>
<p>当 CPU 超过 70% 时，<strong>Kubernetes 自动扩缩容</strong> Pod——无需人工干预。</p>
<blockquote>
<p><strong>专业提示：</strong> 使用自定义 Prometheus 指标（例如，请求速率或队列深度）实现超越 CPU 的更智能扩缩容信号。</p>
</blockquote>
<h2 data-id="heading-20">CI/CD 中的持续负载测试</h2>
<p>使用 <strong>Gatling</strong> 持续验证性能。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.gatling<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>gatling-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.9.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<p>在部署后集成负载场景：</p>
<pre><code class="hljs language-bash" lang="bash">mvn gatling:<span class="hljs-built_in">test</span>
</code></pre>
<p>📊 在生产用户感受到之前检测性能回归。</p>
<h2 data-id="heading-21">🧩 结论</h2>
<p>扩展 Spring Boot 不是添加服务器的问题——而是<strong>为效率而工程化</strong>。
通过调优每一层——从<strong>连接池</strong>到 <strong>JVM 参数</strong>、<strong>缓存设计</strong>和<strong>可观测性仪表板</strong>——你可以实现：</p>
<ul>
<li>更快的响应时间</li>
<li>可预测的资源利用率</li>
<li>自愈、自动扩缩容的系统</li>
</ul>
<blockquote>
<p>更多Spring Boot技术指南可关注我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fspring4all.com%2F" target="_blank" title="https://spring4all.com/" ref="nofollow noopener noreferrer">SpringForAll社区</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO推出1天啦，限免到15号，你还没体验吗]]></title>    <link>https://juejin.cn/post/7572020278387408930</link>    <guid>https://juejin.cn/post/7572020278387408930</guid>    <pubDate>2025-11-13T15:05:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572020278387408930" data-draft-id="7572020278387245090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO推出1天啦，限免到15号，你还没体验吗"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-13T15:05:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO推出1天啦，限免到15号，你还没体验吗
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T15:05:04.000Z" title="Thu Nov 13 2025 15:05:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Trae SOLO模式已经正式推出一天了</p>
<p>点击左上角的logo，就可以切换solo模式了，切换后的ide布局非常的酷炫，有两个模式</p>
<ul>
<li>coder：可以用来改bug，写需求这些</li>
<li>builder：适合从0到1的开发，从生成prd开始到构建完整项目，而且trae还提供了便捷部署到vercel可以线上访问的集成</li>
</ul>
<p>但是没有模型相关的选择，内置进去了，没有暴露出来给用户去选择</p>
<p>我试了一下使用coder改bug，plan模式下提出需求或者bug，会先生成文档，你可以根据文档再次确认需求，没问题后开始实施，这种模式其实更好，可以让模型充分的理解需求，避免偏差。</p>
<p>可以看下面图里的使用过程：</p>
<p>plan给模型提问题：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fe7f3104cef48858ab4e41dbfe283da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763651104&amp;x-signature=7kN3xDgce0XV%2F9Odsy9q2rPov5c%3D" alt="image.png" loading="lazy"/></p>
<p>生成的文档也可以进行二次修改，确认无误后点击执行就子的开始开发了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2795e32e224f4ba09fe90546920cce3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763651104&amp;x-signature=Du7mmDMf0cUNyH5OSSKasrPp57U%3D" alt="image.png" loading="lazy"/></p>
<p>如果文档不准确，还可以继续对话，模型会对文档进行修改</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e12eb4a44c1472e876647d28f842436~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763651104&amp;x-signature=2CyHzSEhu1bU0OcTkjKdIGrY%2FZ0%3D" alt="image.png" loading="lazy"/></p>
<p>然后点击执行模型就开始编辑了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03cf0456e31743ec8c1f47a1ee433da7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763651104&amp;x-signature=MIuvHG19NMdDEoIHys%2B6I3YNZVM%3D" alt="image.png" loading="lazy"/></p>
<p>需要注意，实时跟随打开以后，界面就会跟随模型的操作去变化，比如修改文件，实时的去跟随编辑状态。</p>
<p>比较大的一个变化还是界面布局上的，solo模式的核心应该还是主要聚焦在ai coding方面，个人感觉还是挺不错，比较酷炫的，用起来也很顺手，没用很不适应的感觉。</p>
<p>还没体验的快去试试吧，限免到15号，国内版和国际版都可以用。</p>
<p>下载地址：<a href="https://www.trae.ai/?utm_source=ads&amp;utm_medium=gg_sem_dl_pur&amp;utm_campaign=188644211187_23034576121_brand_simple_broadmatch_p10_us/ca_en_&amp;gad_source=1&amp;gad_campaignid=23034576121&amp;gbraid=0AAAAArENyFXV1mD6WsAaIUkYSUVl-PL8X&amp;gclid=CjwKCAiAoNbIBhB5EiwAZFbYGDpIylnokNx2rO6yUbFMANLjA9W6x87CCDUzSswtWXXMMWB3qHMxYBoCcS4QAvD_BwE" target="_blank" title="https://www.trae.ai/?utm_source=ads&amp;utm_medium=gg_sem_dl_pur&amp;utm_campaign=188644211187_23034576121_brand_simple_broadmatch_p10_us/ca_en_&amp;gad_source=1&amp;gad_campaignid=23034576121&amp;gbraid=0AAAAArENyFXV1mD6WsAaIUkYSUVl-PL8X&amp;gclid=CjwKCAiAoNbIBhB5EiwAZFbYGDpIylnokNx2rO6yUbFMANLjA9W6x87CCDUzSswtWXXMMWB3qHMxYBoCcS4QAvD_BwE" ref="nofollow noopener noreferrer">www.trae.ai/?utm_source…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[限时免费！字节 TRAE SOLO 正式上线，无需邀请码！新增 TRAE Coder（附实测体验）]]></title>    <link>https://juejin.cn/post/7572016447805571098</link>    <guid>https://juejin.cn/post/7572016447805571098</guid>    <pubDate>2025-11-13T15:48:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447805571098" data-draft-id="7572062035140542474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="限时免费！字节 TRAE SOLO 正式上线，无需邀请码！新增 TRAE Coder（附实测体验）"/> <meta itemprop="keywords" content="Trae,AI编程"/> <meta itemprop="datePublished" content="2025-11-13T15:48:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员X小鹿"/> <meta itemprop="url" content="https://juejin.cn/user/2928754709505608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            限时免费！字节 TRAE SOLO 正式上线，无需邀请码！新增 TRAE Coder（附实测体验）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754709505608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员X小鹿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T15:48:35.000Z" title="Thu Nov 13 2025 15:48:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是X小鹿。<strong>昨天（11.12），字节的 TRAE SOLO 正式版全面开放，不需要邀请码了，人人可用，而且限时免费！</strong></p>
<p>11.12 ~ 11.15，所有人都可以免费使用 TRAE SOLO。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc173bc12214b7f9278ecd83a7e232f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763653714&amp;x-signature=vS8fzCAlv4kHZlgiL6AqPEObi9c%3D" alt="图片" loading="lazy"/></p>
<p>SOLO 模式这次也全新升级，除了之前上线的 <strong>SOLO Builder</strong> 外，这次还新上了 <strong>SOLO Coder</strong>。</p>
<p>两种 SOLO 模式适合不同的场景，下面详细介绍。</p>
<p>除此之外，新升级的 TRAE SOLO 这次还支持「<strong>多任务并行</strong>」。</p>
<p>也就是说，可以同时运行多个任务了。每个任务，都有自己的模型和上下文，并且会为每项任务选择最佳模型。</p>
<p>下面一起来看看吧。</p>
<h2 data-id="heading-0">SOLO Builder</h2>
<p><strong>SOLO Builder，今年 7 月（2025）最初上线的 SOLO 模式，适用于端到端快速生成应用。</strong></p>
<p>下面的这个案例，当时就是 TRAE 的 SOLO Builder 模式实现的。</p>
<p><a href="https://juejin.cn/post/7547498416759652404" target="_blank" title="https://juejin.cn/post/7547498416759652404">字节Trae SOLO实战分享：3小时上线一个网站，全栈开发自动部署，比Claude Code狠10倍！（附保姆级教程）</a></p>
<p>从零开发到部署一个 AI 工具导航站（含用户端和管理端），涉及前端、后端鉴权、数据库操作等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da41aaea5d9e491594a5d21db01072c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763653714&amp;x-signature=nmmTJRoM5G2uUMUe7GRa9SqP05g%3D" alt="图片" loading="lazy"/></p>
<p>里面也分享了如何关联 Supabase 来进行后端及数据库的操作，以及开发好的项目如何一键部署到 Vercel 上，还有一些 TRAE 使用小技巧，感兴趣可以看看。</p>
<p><strong>简单来说，在 SOLO Builder 模式下，用户只需要描述任务需求，SOLO Builder 就能自动实现从需求分析、生成 PRD、开发、测试、部署上线的全流程。</strong></p>
<p>SOLO Builder 模式除了支持 Supabase 服务、一键部署服务外，还支持<code>Figma 导入</code>（将设计文件转化为可运行的代码）、<code>AI 服务</code>、<code>支付服务</code>等。</p>
<p>非常适合从 0 到 1 高效构建项目以及快速落地想法。</p>
<h2 data-id="heading-1">SOLO Coder</h2>
<p>下面来说说 SOLO Coder 模式。</p>
<p>SOLO Coder 模式是这次 TRAE SOLO 升级后新增的模式。</p>
<p><strong>适用于复杂的编程项目，比如项目迭代、bug 修复、架构优化等。</strong></p>
<p>拿昨天在改的一个项目来试一下。</p>
<p>昨天在改项目的一个 bug，用其他 AI Coding 工具，改了一个多小时，反反复复，都没有改好，期间还切换了多个大模型来尝试，都毫无效果。</p>
<p>正好来试下 TRAE 的 SOLO Coder 模式。</p>
<p>TRAE 支持上传图片。把问题的截图发给 TRAE，然后输入问题描述。</p>
<p>右上角有一个「Plan」，如果是复杂的长任务，可以考虑开启。</p>
<p>开启计划模式后，它会先分析需求，然后生成规划，等我们确认后，才会执行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce8f96c3a6404d5799649c7b30dbeda2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763653714&amp;x-signature=zlCn3Xx0RXWCl5J8d2AW2JNgzmI%3D" alt="图片" loading="lazy"/></p>
<p>可以看到，SOLO Coder 会先调用内置的 Search Agent 来检索工作区的代码，在了解到足够的上下文后生成规划。</p>
<p>可以在右侧手动修改（或继续对话来修改），确认没问题后，点「执行」，SOLO Coder 就开始干活了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff066896a41942ef95426d0172b00df0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763653714&amp;x-signature=d8%2FVzDuX42m6d6cwFKsqdHNse6w%3D" alt="图片" loading="lazy"/></p>
<p>执行完成后，会生成一个「产物汇总」，包括文档及代码变更。</p>
<p>把项目跑起来测了一下，居然一次改对了！这效率感人啊～</p>
<p><strong>SOLO Coder 支持添加多个自定义智能体。</strong></p>
<p>SOLO Coder 作为主控智能体，会在执行的过程中自动调用合适的智能体来完成相应的任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8acc2af163aa42fe9397cbe3adda2769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763653714&amp;x-signature=0wVJUl%2FPkffiSzNw3Nn0cr5V1J4%3D" alt="图片" loading="lazy"/></p>
<p><strong>SOLO Coder 还能实时查看上下文的使用率，会在执行任务的过程中自动压缩上下文，也可以点「压缩」按钮来手动压缩。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e21ba64d752a439382bf0f203225f1bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763653714&amp;x-signature=RBEFHEulAF6uYKSk9K2mvTaj7RE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">写在最后</h2>
<p>使用过程中，也遇到一些小问题。</p>
<p>比如在一开始强调了整个过程要用中文输出后，TRAE 在执行一段时间后，又会变成英文输出。</p>
<p>不过 TRAE 升级后的 SOLO 模式，整体使用下来体验还是很不错的，不管是之前的 SOLO Builder 模式，还是这次新上线的 SOLO Coder 模式。</p>
<p><strong>不知道 SOLO Coder 和 SOLO Buillder 这俩模式怎么选？</strong></p>
<p>可以看下 TRAE 官方文档里的这份对比：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef768420a07a4274a87030b728124bc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763653714&amp;x-signature=MKLO6GFonuV7QvhkM1FQBXYuDS4%3D" alt="图片" loading="lazy"/></p>
<p>这几天，一直到 11.15 号，TRAE SOLO 都是可以免费使用的，有需要的可以抓紧体验～</p>
<p>不过，虽然是免费，但是也有免费次数。下午在用 SOLO 时，突然就不能用了，提示要升级 Pro 或 14 小时后。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8109bd10e73488ba0d64f94fa09c09e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763653714&amp;x-signature=L%2BDQ3xqjKRAbBEGgwieQ8HVMH5M%3D" alt="图片" loading="lazy"/></p>
<p>以上就是今天的分享，感兴趣的快去试试吧。</p>
<p>最后附上 TRAE（国际版）的下载地址：</p>
<p><strong><a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">www.trae.ai/</a></strong></p>
<p>ps：TRAE SOLO 模式目前只在 TRAE 国际版全面开放了，TRAE 国内版的 SOLO 模式还要再等等。</p>
<hr/>
<blockquote>
<p>我是<a href="https://juejin.cn/user/2928754709505608/posts" title="https://juejin.cn/user/2928754709505608/posts" target="_blank">程序员X小鹿</a>，前互联网大厂程序员，也是一名 AIGC 爱好者，持续分享更多好用的 AI 工具，欢迎一起交流~</p>
</blockquote>
<p><strong>推荐阅读</strong></p>
<p><a href="https://juejin.cn/post/7454501732203610131" title="https://juejin.cn/post/7454501732203610131" target="_blank">2024年终AI工具汇总：9大AI领域，70+精选AI工具，全都在这了！(建议收藏)</a></p>
<p>更多 AI 工具见<a href="https://juejin.cn/column/7284164153576947724" title="https://juejin.cn/column/7284164153576947724" target="_blank">【AI工具】</a>专栏，持续更新中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【智能硬件】AI 眼镜论文笔记]]></title>    <link>https://juejin.cn/post/7572164122235453450</link>    <guid>https://juejin.cn/post/7572164122235453450</guid>    <pubDate>2025-11-13T14:10:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572164122235453450" data-draft-id="7572164122235420682" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【智能硬件】AI 眼镜论文笔记"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-13T14:10:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【智能硬件】AI 眼镜论文笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T14:10:14.000Z" title="Thu Nov 13 2025 14:10:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【智能硬件】AI眼镜论文笔记</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 概要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 论文内容总结</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.1 AI for Service</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1.2 EgoLife</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 自己的需求</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 业界调研</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 分类</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 交互</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 功能</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.3 痛点</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.4 方案</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.5 和手机的关系</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.6 眼镜公司</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 概要</h3>
<p>刷到两篇论文</p>
<ul>
<li>”AI for Service: Proactive Assistance with AI Glasses“，<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2510.14359%25E3%2580%2582" target="_blank" title="https://arxiv.org/pdf/2510.14359%E3%80%82" ref="nofollow noopener noreferrer">arxiv.org/pdf/2510.14…</a></li>
<li>“EgoLife: Towards Egocentric Life Assistant”，<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2503.03803" target="_blank" title="https://arxiv.org/pdf/2503.03803" ref="nofollow noopener noreferrer">arxiv.org/pdf/2503.03…</a></li>
</ul>
<p>因为我身边也有几个朋友在做智能眼镜。于是就研读了这两篇论文，也从用户角度做了下调研，整理出来了这篇笔记。</p>
<p>注：事实上，本文后半部分早在4月份就写好了，因为我总想继续完善，想把更好的作品呈现出来，所以它一直躺在我的草稿箱中（类似的草稿有几十篇）。最近看到一个说法："行业发展比写PPT的速度还快"。于是决定，类似这种半成品，还是早早发出来吧，不再继续吃灰了。</p>
<h3 data-id="heading-2">0x01 论文内容总结</h3>
<h4 data-id="heading-3">1.1 AI for Service</h4>
<h5 data-id="heading-4">1.1.1 研究背景与核心范式</h5>
<p>当前 AI 服务多以被动响应为主，需用户发出明确指令才能提供服务，难以深度融入日常生活。为此，论文提出 “AI for Service（AI4Service）” 这一全新范式，旨在通过 AI 技术实现主动、实时且个性化的服务，推动服务模式从 “人找服务” 向 “AI 代理找服务” 转变。该范式的核心特征包括通用性（应对多样化生活场景）、主动性（主动发现服务需求）和定制化（适配用户个体差异）。</p>
<h5 data-id="heading-5">1.1.2 核心技术挑战与解决方案</h5>
<ol>
<li>“何时服务”（Know When）：需精准识别环境中的服务触发时机并分类事件类型，通过高精度时序模式识别与上下文感知技术，平衡服务及时性与非侵入性。</li>
<li>“如何服务”（Know How）：提供通用服务与个性化服务两层解决方案，通用服务基于短期场景提供标准化内容，个性化服务则融合用户长期行为模式实现定制化输出。</li>
</ol>
<h5 data-id="heading-6">1.1.3 Alpha-Service 框架设计</h5>
<p>受冯・诺依曼计算机架构启发，论文提出 Alpha-Service 统一框架，通过五大核心组件协同实现主动服务，具体如下：</p>
<ol>
<li>输入单元：采用双模型架构，轻量级在线模型持续监测第一视角视频流以触发服务时机，重量级离线模型则对场景进行精细化分析，平衡实时性与分析深度。</li>
<li>中央处理单元：作为系统 “中枢”，基于大语言模型实现任务分解、调度与结果合成，将复杂任务拆解为子任务并分配至对应组件，最终整合多源信息生成统一响应。</li>
<li>算术逻辑单元：负责工具集成与调用，当系统内部知识不足时，通过网页搜索等外部工具获取实时信息，支撑复杂决策。</li>
<li>记忆单元：以结构化 JSON 文件存储用户长期交互历史与偏好，通过检索增强提示策略，为个性化服务提供数据支撑。</li>
<li>输出单元：将系统分析结果提炼为简洁指令，通过语音合成技术实现多模态输出，适配免提等实际使用场景。</li>
</ol>
<h5 data-id="heading-7">1.1.4 思考</h5>
<p>几点思考如下：</p>
<ol>
<li>模型轻量化与效率提升：针对边缘设备的资源约束，引入模型压缩、量化或知识蒸馏技术，优化轻量级与重量级模型的协同机制，减少能耗同时降低推理延迟；探索异构计算架构，合理分配 CPU、GPU 资源，提升实时处理能力。</li>
<li>工具生态与服务多样性拓展：当前算术逻辑单元主要依赖网页搜索工具，可丰富工具库，集成地图导航、设备控制、专业数据库查询等多样化工具；建立工具调用的智能决策机制，基于任务类型与场景特征自适应选择最优工具组合。</li>
<li>记忆单元智能化升级：引入向量数据库与语义检索技术，提升用户偏好挖掘的精准度；结合联邦学习等隐私计算方法，在保障数据本地化与匿名化的前提下，优化个性化服务的冷启动问题。</li>
<li>服务干预策略精细化：针对主动服务的非侵入性需求，可设计用户意图置信度评估机制，根据置信度动态调整服务触发阈值；提供可定制化的服务频率与干预方式设置，满足不同用户的隐私偏好与使用习惯。</li>
<li>多场景适配能力强化：拓展极端环境（如强光、噪音）、多用户交互、跨场景切换等复杂场景的测试与优化；增强系统对特殊用户群体（如视障、老年用户）的适配性，提升服务的包容性。</li>
</ol>
<h4 data-id="heading-8">1.2 EgoLife</h4>
<p>EgoLife 把“第一视角生活流”升级为“可预测、可干预的个人服务”，让模型从「看见」走向「预见」。</p>
<h5 data-id="heading-9">1.2.1 背景</h5>
<p>南洋理工大学刘子纬助理教授领导的联合团队，针对当前 AI 助手 “被动响应、难以理解人类长期行为与社交互动” 的局限，发起<strong>EgoLife 项目</strong>，旨在开发基于 AI 眼镜的 “自传式记忆” 智能助手 —— 通过第一人称视角捕捉日常数据，让 AI 真正 “读懂生活”，实现如 “推荐符合口味的餐厅”“提醒会议”“预测遗漏日用品” 等主动辅助功能。项目最终形成三大核心成果：<strong>EgoLife 数据集</strong>、<strong>EgoLifeQA 长情境问答基准</strong>、<strong>EgoButler 智能助手系统</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d952cda7de944260aec9aebba04d04c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763647814&amp;x-signature=lQ1SUs9Vh0PjzJhTWMl28n1F2gE%3D" alt="exported_image" loading="lazy"/></p>
<p>exported_image</p>
<h5 data-id="heading-10">1.2.2 数据采集与数据集构建</h5>
<h6 data-id="heading-11">1. 采集设计</h6>
<p>为获取丰富、真实的第一人称数据，团队设计了严谨的采集方案：</p>
<ul>
<li><strong>参与者</strong>：6 人（通过小红书招募，因男性参与者临时缺席，最终含项目负责人；MBTI 多为直觉型（N）+ 感知型（P），适配开放式探索）</li>
<li><strong>采集环境</strong>：定制 “EgoHouse”，除满足日常居住外，布置 15 个 GoPro 摄像头（覆盖公共区域，提供第三人称视角）、2 个毫米波雷达（获取空间与运动数据）</li>
<li><strong>核心任务</strong>：让 6 人共同生活 7 天，以 “筹备地球日庆祝活动” 为目标，自然产生讨论、购物、烹饪、排练等社交与协作场景</li>
<li><strong>采集设备</strong>：每人佩戴 Meta Aria 智能眼镜，该设备集成高清摄像头、空间音频麦克风与 IMU（惯性测量单元），可全方位捕捉视觉、听觉、运动信息，要求每人每天至少记录 6 小时清醒活动</li>
</ul>
<h6 data-id="heading-12">2. 数据规模与处理</h6>
<ul>
<li>
<p><strong>原始数据规模</strong>：共收集<strong>300 小时自我中心视频</strong>，同步获取第三人称视角视频、空间 / 运动数据，确保多模态覆盖</p>
</li>
<li>
<p>数据处理流程（4 大核心模块）：</p>
<ol>
<li><strong>EgoSync</strong>：将 6 人的眼镜数据、外部摄像头 / 雷达数据进行时间同步，解决多源数据错位问题</li>
<li><strong>EgoBlur</strong>：对敏感信息（如人脸、私人文件）进行模糊处理，保障参与者隐私</li>
<li><strong>EgoCaption</strong>：将视频按 5 分钟分段，以 0.8 倍速播放，由注释员口述标注，生成<strong>36.1 万条 “旁白” 片段</strong>（平均每条 2.65 秒），再通过 GPT-4o-mini 合并为 2.5 万条 “合并字幕”，最终结合抽样画面与转录文本生成 “视听字幕”，并经人类验证</li>
<li><strong>EgoTranscript</strong>：应用语音识别技术生成初步转录文本，通过开源算法区分 6 位说话人，将音轨拆分为 6 条独立轨道，确保每条转录准确反映对应参与者的听觉内容</li>
</ol>
</li>
</ul>
<h5 data-id="heading-13">1.2.3 EgoLifeQA</h5>
<p>现有基准（如 EgoSchema、EgoPlan-Bench）多处理短时间上下文，而 EgoLifeQA 聚焦 “长情境、生活导向” 问答，要求 AI 处理<strong>远超 2 小时甚至数天前</strong>的信息，更贴近真实生活中 AI 助手的使用场景（如 “回忆 3 天前的早餐”）。EgoLifeQA 通过 5 类任务，全面评估 AI 对生活场景的理解能力，具体如下表：</p>









































<table><thead><tr><th>任务类型</th><th>核心能力</th><th>示例问题</th><th>回答要求</th></tr></thead><tbody><tr><td><strong>EntityLog</strong></td><td>物品细节长期记忆</td><td>“我们付的酸奶价格最接近哪个选项？A.2 元 B.3 元 C.4 元 D.5 元”</td><td>回忆购物场景价格，需精准到具体数值</td></tr><tr><td><strong>EventRecall</strong></td><td>过去事件回忆</td><td>“在计划跳舞后第一首被提到的歌是什么？A.Why Not Dance B.Mushroom...”</td><td>定位特定会话，提取关键信息</td></tr><tr><td><strong>HabitInsight</strong></td><td>个人习惯洞察</td><td>“我喝咖啡时通常同时做什么活动？A. 刷 TikTok B. 发短信 C. 整理房间 D. 做手工”</td><td>从多天数据中归纳行为规律</td></tr><tr><td><strong>RelationMap</strong></td><td>人际互动模式映射</td><td>“Shure 正在弹吉他，还有谁通常和我们一起弹吉他？A.Choizst B.Jake C.Nicrous”</td><td>识别人物身份，关联社交历史</td></tr><tr><td><strong>TaskMaster</strong></td><td>任务管理与意图追踪</td><td>“我的购物车里已经有很多东西了，我们之前讨论过但我还没买的是什么？”</td><td>记忆清单，区分已购 / 未购物品</td></tr></tbody></table>
<h5 data-id="heading-14">1.2.4 EgoButler 系统</h5>
<p>EgoButler（融合视听理解与长期记忆的 AI 助手） 是 EgoLife 项目的核心落地成果，由<strong>EgoGPT（全模态理解模块）</strong> 与<strong>EgoRAG（分层检索模块）</strong> 组成，二者协同实现对超长上下文的理解与问答。</p>
<h6 data-id="heading-15">1. EgoGPT</h6>
<ul>
<li>
<p>基础架构：基于 LLaVA-OneVision 模型（底层为 Qwen2 架构），为增强音频处理能力，参考 Ola 模型设计新增音频分支 —— 使用 Whisper Large v3 编码音频，在 LibriSpeech 数据集上训练音频投影模块，最终通过 EgoIT-99K 数据集微调整合</p>
<ul>
<li><strong>EgoIT-99K 数据集</strong>：涵盖 9 个经典自我中心视频数据集（如 Ego4D、Charades-Ego），精选 1529 个视频（686 个带音频），总时长 43.16 小时，生成 9.948 万条问答对（含视频描述、音视频描述等类型）</li>
</ul>
</li>
<li>
<p>核心功能：</p>
<ol>
<li>持续视频描述：处理每个 30 秒的自我中心视频片段，结合视觉 + 音频输入生成详细场景描述</li>
<li>辅助问答：接收 EgoRAG 检索到的相关线索，整合信息生成精准回答</li>
</ol>
</li>
<li>
<p>个性化优化：使用 EgoLife 项目第一天的视频数据进行微调，让模型具备身份识别能力，为理解人际互动（如 RelationMap 任务）奠定基础</p>
</li>
</ul>
<h6 data-id="heading-16">2. EgoRAG</h6>
<p>EgoRAG 模拟人类 “分层回忆” 逻辑（如 “回忆 3 天前早餐：先定位日期→再定位时段→最后记细节”），解决超长上下文检索效率问题，分为 “记忆库构建” 与 “检索回答” 两阶段：</p>




















<table><thead><tr><th>阶段</th><th>核心操作</th><th>目的</th></tr></thead><tbody><tr><td>记忆库构建</td><td>1. 收集 EgoGPT 生成的 30 秒片段描述（细粒度记忆）2. 定期生成小时级摘要（汇总每小时主要事件）3. 生成天级摘要（捕捉每日关键点）</td><td>建立多层索引，实现高效信息管理</td></tr><tr><td>检索回答</td><td>1. 问题分析：提取关键词（如 “昨天”“超市”“酸奶”）2. 粗检索：在天级摘要中缩小范围到目标时段3. 精检索：在小时级 / 细粒度记忆中定位相关片段4. 结果整合：将片段送入 EgoGPT 生成回答</td><td>避免逐帧搜索，秒级完成 300 小时数据检索</td></tr></tbody></table>
<h5 data-id="heading-17">1.2.5 现存挑战</h5>
<ul>
<li>
<p>EgoGPT 的局限：</p>
<ol>
<li>语音情感理解不足：依赖 ASR 训练数据，难以识别笑声、情绪语调等非语义信息</li>
<li>身份识别过拟合：仅用第一天数据微调，易将 “穿相似衣服的不同人” 误判为同一人</li>
</ol>
</li>
<li>
<p>EgoRAG 的局限：</p>
<ol>
<li>缺乏多步推理能力：仅支持单次检索，无法迭代优化搜索策略</li>
<li>无容错性：若检索不到直接支持证据，无法通过推理补充缺失信息，导致无法回答</li>
</ol>
</li>
</ul>
<h5 data-id="heading-18">1.2.6 关键问题</h5>
<p>问题 1：EgoLife 项目的 EgoButler 系统如何解决 “AI 难以处理超长（如数天前）上下文” 的问题？其核心技术逻辑与传统问答系统有何不同？</p>
<p><strong>答案</strong>：EgoButler 通过 “EgoGPT 全模态理解 + EgoRAG 分层检索” 的协同架构解决超长上下文问题，核心技术逻辑与传统系统的差异如下：</p>
<ol>
<li><strong>分层记忆管理</strong>：EgoRAG 不存储原始超长视频，而是将 EgoGPT 生成的 30 秒片段描述（细粒度记忆）定期汇总为 “小时级摘要→天级摘要”，建立多层索引 —— 传统系统多存储原始数据或单一维度摘要，检索时需逐帧 / 逐片段遍历，效率极低；</li>
<li><strong>模拟人类回忆逻辑</strong>：检索时先通过天级摘要缩小到目标日期 / 时段（如 “昨天”），再通过小时级摘要定位大致场景（如 “下午购物”），最后通过细粒度记忆找到具体信息（如 “酸奶价格”），实现 “粗→精” 的高效检索 —— 传统系统多直接基于关键词全局搜索，无法利用时间维度的层级关系；</li>
<li><strong>全模态理解支撑</strong>：EgoGPT 通过视觉 + 音频融合理解生成精准片段描述，为检索提供高质量 “记忆单元”，且能整合检索到的多片段信息生成连贯回答 —— 传统系统常单模态处理（如仅文本），难以应对生活场景中的多模态信息（如 “看到吉他 + 听到弹唱” 的关联）。</li>
</ol>
<p>问题 2：EgoLifeQA 基准包含哪几类任务？这些任务分别对应真实生活中 AI 助手的哪些核心能力？请结合具体任务示例说明其与传统基准的核心差异。</p>
<p><strong>答案</strong>：EgoLifeQA 包含 5 类任务，对应 AI 助手的 5 项核心生活辅助能力，与传统基准（如 EgoSchema）的核心差异在于 “处理超 2 小时甚至数天前的长情境”，具体如下：</p>
<ol>
<li><strong>EntityLog（物品细节长期记忆）</strong> ：对应 “记住生活物品关键信息” 的能力，如 “我们付的酸奶价格最接近哪个选项？”—— 传统基准多处理短期物品信息（如 “当前画面中的物品”），而该任务需回忆数天前购物场景的具体价格；</li>
<li><strong>EventRecall（过去事件回忆）</strong> ：对应 “追溯特定过往事件” 的能力，如 “在计划跳舞后第一首被提到的歌是什么？”—— 传统基准多聚焦 “当前 / 近期事件”，该任务需从海量历史对话中定位特定时间点的信息；</li>
<li><strong>HabitInsight（个人习惯洞察）</strong> ：对应 “归纳用户长期习惯” 的能力，如 “我喝咖啡时通常同时做什么活动？”—— 传统基准无习惯归纳需求，该任务需从多天数据中提炼行为规律（如 “3 次喝咖啡时做手工”）；</li>
<li><strong>RelationMap（人际互动映射）</strong> ：对应 “理解用户社交关系” 的能力，如 “Shure 正在弹吉他，还有谁通常和我们一起弹吉他？”—— 传统基准少涉及人际互动，该任务需关联多场景下的人物行为历史；</li>
<li><strong>TaskMaster（任务管理）</strong> ：对应 “追踪任务进度与未完成事项” 的能力，如 “我的购物车里已经有很多东西了，我们之前讨论过但我还没买的是什么？”—— 传统基准多处理单一任务指令，该任务需记忆历史讨论内容并对比当前进度。</li>
</ol>
<h3 data-id="heading-19">0x02 自己的需求</h3>
<p>以下是我自己的需求。</p>
<p>我对AI眼镜的期望是“附带某些功能的常规眼镜”。首先是眼镜，要无感佩戴，自然融入日常生活；然后在此之上再添加一些生活中的便利AI功能。而不是把手机顶在头上。具体有如下述求：</p>
<ul>
<li>足够轻便，可以长时间舒适地佩戴。</li>
<li>电池续航足够支撑全天佩戴。希望有快充。因为对于近视人来说要长期佩戴，频繁充电意味需要摘下眼镜。</li>
<li>支持眼睛盒充电。眼镜盒要支持5次以上满额充电；对眼睛盒充电时长不要超过3小时。最好能支持手机给眼镜充电，边充边用。</li>
<li>可以方便的操控，比如通过指环。</li>
<li>能客串蓝牙耳机，具备隔音、降噪能力；</li>
<li>不要有声音外溢，保证聆听私密性。</li>
<li>外形足够吸引人或者说符合用户的自我标签（因为眼镜外观是用户自我标签的对外表达，生活中手机“撞脸”的概率极高，但眼镜撞脸的概率却极低，AI眼镜这个品类先天就需要更丰富多样的产品）。</li>
<li>可以随手拍摄，不要有快门延迟，而且当头部有频繁动作时，要保证拍摄稳定性。暗光环境要保证拍摄效果。</li>
<li>眼镜录制的内容可以无缝传到社交媒体、手机或者电脑。</li>
<li>可以应对整机下水清洗。</li>
<li>希望眼镜可以接收到手机上的通知，比如微信消息等（决定了眼镜在日常生活中的被使用的频次到底有多高）。</li>
</ul>
<p>总结之后，我不确定在当前的行业现状下，AI眼镜可以全部满足这些要求。因为这涉及了眼镜行业的通用痛点。</p>
<h3 data-id="heading-20">0x03 业界调研</h3>
<h4 data-id="heading-21">3.1 分类</h4>
<p>智能眼镜的分类有不同说法。</p>
<ul>
<li>
<p>一种说法是：不带屏幕的眼镜称作AI眼镜，带显示模块光学组件的眼镜称作AR眼镜。</p>
</li>
<li>
<p>也有再加上摄像头进行分类，即：</p>
<ul>
<li>(1)无摄像头、无显示屏幕；</li>
<li>(2)无摄像头、带显示屏幕；</li>
<li>(3)带摄像头、无显示屏幕；</li>
<li>(4)带摄像头、带显示屏幕。</li>
</ul>
</li>
</ul>
<p>长期方向是AI+AR融合发展：AI提升AR的交互智能（如手势识别、眼动追踪等），AR为AI提供虚实融合的显示载体。</p>
<h4 data-id="heading-22">3.2 交互</h4>
<p>AI 眼镜的交互形态正突破传统设备的边界，当前已形成触摸、语音、显示、手势识别、眼动追踪等多元方式。从人体工学角度看，其佩戴位置天然贴近三大感官枢纽 —— 负责言语输出的嘴巴、接收声音的耳朵、获取视觉信息的眼睛，这使得它能够无缝集成语音交互、音频输出、高清影像捕捉等功能，甚至兼容智能耳机、相机等硬件，进化为复合型智能设备，灵活适配不同场景。</p>
<p>与手机相比，AI 眼镜的交互优势体现在信息维度的拓展与使用自由度的提升。视觉信息的密度与带宽远胜声音，为输入输出提供了更丰富的载体；而 “免提机位” 的特性，让第一视角的生活记录不再局限于碎片化瞬间，更能完整留存连续体验。这种特性催生了新的交互逻辑：以手部微手势为基础模态，用户只需将手自然放置于身体一侧、裤兜或大腿等放松位置即可操作，再结合语音指令、镜腿轻触等辅助方式，构建全局交互体系。</p>
<p>目前，指环作为过渡形态展现出独特价值 —— 低成本、兼具时尚感，且能实现基础交互需求。</p>
<p>对行业来说，交互设计的关键是别再一门心思盯着屏幕界面了。不是说屏幕界面没用，而是要追求 “少操作、步骤简单、反应快” 的界面逻辑，把场景放在第一位。得先搞清楚用户在什么时间、什么地方，当下最需要啥，然后琢磨怎么让服务自然地出现，能不能做到不用动手操作。要是实在得设计一次操作，那也得精准戳中用户最核心的需求点。</p>
<h4 data-id="heading-23">3.2 功能</h4>
<p>AI 眼镜的功能潜力，根植于多模态 AI 基础模型的能力边界 —— 搜索、私人助理、实时字幕、场景识别、动作分析等基础能力，为其拓展出丰富的应用可能：从实时视觉识别、语音交互、场景理解，到 AR 导航、记忆辅助、健康监测，乃至专业领域的手术辅助、设备巡检等。</p>
<p>但现实使用数据揭示了功能设计的深层规律：据不完全统计，70% 的用户要么很少用 AI 功能，要么尝个鲜就不用了；剩下 30% 经常用的用户里，超过一半是拿它当搜索引擎，大概 30% 用来翻译，其他的就是查导航、看天气这些基础操作。还有份统计显示，大家常用的功能集中在拍照录像、处理音频、沉浸式办公；骑行导航、同声传译这些用得不算多；而帮听障人士辅助、采集动作数据这些，只适合特定人群。</p>
<p>这些数据指向一个结论：功能堆得再多也不算厉害，关键是在成本、戴着舒服不舒服、好不好看之间找到平衡，把场景价值做透。行业别再执着于打造 “啥功能都有的 AI+AR 眼镜” 了，得从用户的实际需求出发，该减的功能果断减，专心做细分市场。设计思路得围绕 “场景优先”：先明确用户在具体场景里最需要啥，再选合适的方式（比如用看的、用听的）呈现数据和服务，最后把操作方式优化好，让每一个功能都能真正帮到用户。</p>
<h4 data-id="heading-24">3.3 痛点</h4>
<p>行业痛点也就是技术难点，也有不同说法：</p>
<ul>
<li>不可能三角：即续航、重量、算力这三者不可能同时满足。</li>
<li>不可能六边形：续航、功能、重量、体积、美观、方便 这六方面不可能同时满足。</li>
<li>也有人认为痛点是内容、价格、舒适度、性能和成本。</li>
</ul>
<p>其本质就是：功能越多，能耗和需要的算力就越高。如果扩大电池的容量，又会影响到眼镜的重量。这可能需要用低功耗芯片和高能量密度电池来解决。</p>
<h4 data-id="heading-25">3.4 方案</h4>
<p>在智能硬件领域，如何把产品”做小“是个业界难题。需要产业链各个环节的紧密配合、工程化探索以及大量行业Know-How的积累。比如：</p>
<ul>
<li>如何从系统层面降低整体功耗；</li>
<li>如何处理/配置端侧AI算力？多核异构系统？分布式架构？</li>
<li>如何优化优化双芯片、双系统能力？有些方案不是“开箱即用”，相当考验技术实力。</li>
<li>如何确定边缘计算与云协同的平衡点；</li>
<li>有意思的是，眼镜续航与AI的第一性原理是相悖的，AI的第一性原理是“数据量”，指的是数据体量和数据质量，而眼镜在有限的电池容量下，在满足基本交互的情况下，能给AI提供多少体量的数据，POV视觉数据和远近声场数据的数据质量从何体现？这些都需要更多行业从业者来摸索。</li>
</ul>
<h4 data-id="heading-26">3.5 和手机的关系</h4>
<p>关于 AI 眼镜和手机到底啥关系，行业一直有两种说法：一种说 AI 眼镜早晚取代手机，另一种说它本质就是手机的延伸。从现在的情况来看，后一种更靠谱。</p>
<p>手机是生活和数字世界的核心，攒下了庞大的开发者资源和服务体系，这种核心地位短时间内没法被替代。</p>
<p>作为手机的配件，AI 眼镜的价值在于接手那些更适合在眼前完成的操作 —— 手机上那些简单、不用复杂处理的界面和操作，挪到眼镜上后，靠着第一视角的便捷性，体验会更好。但这不是说 AI 眼镜只能靠手机活着，它得有自己的特色：借着佩戴位置靠近感官的优势，在不用手操作、实时识别场景这些方面打造别人替代不了的能力，和手机形成互补，而不是互相竞争。</p>
<h4 data-id="heading-27">3.6 眼镜公司</h4>
<p>AI 眼镜的产业链已经很成熟了，像光学零件、芯片、显示模块、传感器这些核心部件，都能靠现有的消费电子产业链实现批量生产。但想在行业里站稳脚跟，企业得具备多种能力：既要懂手机及相关生态的技术，又得会让端侧的小模型和云端的大模型配合工作，还得有整合 IoT 生态的经验，以及研发适合眼镜的操作系统的实力。</p>
<p>模型策略是 AI 眼镜做出差异化的关键。谷歌眼镜的例子早就证明了，模型能力是产品价值的核心。对企业来说，别想着和大公司在通用模型上硬碰硬，不如走特色路线：比如用端侧的小模型处理语音识别和简单的语义理解，再联动云端大模型给出更深入的回应；把设备打造成有情景智能的助手，专门弥补通用模型的不足，在行业理解、懂用户需求、自己积累的专有技术上建立优势。更重要的是要预判模型的发展节奏 —— 提前五个月预估技术能达到啥水平，同时研发原型产品和应对方案，这样等模型更新迭代时，才能快速适配场景需求。</p>
<p>数据怎么流转也是个没解决的核心问题。哪些场景的数据需要收集、什么时候收集、收集多少、数据是由手机系统接收还是应用接收、处理时端侧和云端怎么分工、返回的内容怎么呈现、数据怎么存储和销毁，这些问题的答案直接影响产品体验和用户信任，也是行业需要一起探索的基础问题。</p>
<h3 data-id="heading-28">0xFF 参考</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA4MTQ4NjQzMw%3D%3D%26mid%3D2652782250%26idx%3D2%26sn%3D7774accac6b4c14e5344bd2e00ea0f90%26chksm%3D8512ac0a1ea8d7860940a9dcaca0ea5fa578c322ba29eded0d636c46692e2ee7b700f1542b08%26mpshare%3D1%26scene%3D1%26srcid%3D05088VMI2qR7OLovkIcyECGS%26sharer_shareinfo%3D21b9086c280e476fe19d54aa61db4050%26sharer_shareinfo_first%3D21b9086c280e476fe19d54aa61db4050%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA4MTQ4NjQzMw==&amp;mid=2652782250&amp;idx=2&amp;sn=7774accac6b4c14e5344bd2e00ea0f90&amp;chksm=8512ac0a1ea8d7860940a9dcaca0ea5fa578c322ba29eded0d636c46692e2ee7b700f1542b08&amp;mpshare=1&amp;scene=1&amp;srcid=05088VMI2qR7OLovkIcyECGS&amp;sharer_shareinfo=21b9086c280e476fe19d54aa61db4050&amp;sharer_shareinfo_first=21b9086c280e476fe19d54aa61db4050#rd" ref="nofollow noopener noreferrer">8000字深度思考：AI眼镜的格局、困局、破局</a> ZeR0 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">智东西</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F21356410025" target="_blank" title="https://zhuanlan.zhihu.com/p/21356410025" ref="nofollow noopener noreferrer">万字解剖：百镜大战，如何胜出？回到AI眼镜产品本身</a> [Ian在AR行业]</p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++的开发难点在哪里？]]></title>    <link>https://juejin.cn/post/7572164122235469834</link>    <guid>https://juejin.cn/post/7572164122235469834</guid>    <pubDate>2025-11-13T14:12:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572164122235469834" data-draft-id="7572062035140214794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++的开发难点在哪里？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T14:12:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++的开发难点在哪里？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T14:12:37.000Z" title="Thu Nov 13 2025 14:12:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>C++这玩意儿，搞过的人都知道它是个让人又爱又恨的主儿。你说它厉害吧，确实厉害，性能直接怼到硬件层面；你说它烦人吧，也是真烦人，随便一个坑就能让你debug到凌晨三点。</p>
<p>来，咱们聊聊C++里那些让人头秃的问题。</p>
<p><strong>内存管理：自己申请的内存，含着泪也要用下去</strong></p>
<p>在C++里，内存这事儿你得自己管。用<code>new</code>申请了内存，就得记得用<code>delete</code>释放。听起来简单是吧？但实际写起代码来，各种幺蛾子就来了。</p>
<p>最常见的就是内存泄漏——申请了忘释放，程序跑着跑着内存就吃光了。还有更刺激的悬空指针：内存已经释放了，你还拿着指针去访问，直接给你来个段错误。最坑的是，有时候这种错误不是必现的，可能程序跑十次才崩一次，让你怀疑人生。</p>
<p>现在虽然有智能指针帮忙，但也不是万事大吉。<code>shared_ptr</code>用不好，循环引用照样让你内存泄漏。你就得记住，可能形成环的时候要用<code>weak_ptr</code>来破局。</p>
<p><strong>面向对象：理想很丰满，现实很骨感</strong></p>
<p>学面向对象的时候，老师讲得天花乱坠，等你在C++里用起来才发现到处都是坑。</p>
<p>最典型的就是对象切片——你想把一个子类对象传给接受父类参数的函数，结果子类特有的部分全被“切”没了。这就好比你买了个顶配手机，结果被人强行换成了标配，憋屈不？</p>
<p>多重继承更是个深坑。特别是那个“菱形继承”，一个类从两个父类继承，这两个父类又来自同一个爷爷类，最后孙子类里会有两份爷爷的数据。为了解决这个问题，你得用虚继承，但那玩意儿理解起来就够喝一壶的。</p>
<p><strong>模板：一入模板深似海</strong></p>
<p>模板这玩意儿，用好了是真香，但用不好就是灾难。</p>
<p>最让人崩溃的是模板的错误信息。普通代码出错，编译器会告诉你“第20行有个语法错误”；模板代码出错，编译器能给你刷出几百行的错误信息，看得你眼花缭乱，最后发现可能就是个分号写错了。</p>
<p>C++20引入了Concept，算是让模板好用了不少，但学习成本又上去了。而且模板用多了，编译时间直线上升，改一行代码等编译等得你都能去泡杯咖啡。</p>
<p><strong>未定义行为：代码界的薛定谔的猫</strong></p>
<p>这是C++里最玄学的部分。未定义行为就是说，代码这么写，标准没规定会发生什么。它可能正常工作，可能崩溃，可能给出错误结果，甚至可能今天正常工作明天就崩了。</p>
<p>常见的未定义行为包括数组越界、解引用空指针、有符号整数溢出等等。最可怕的是，有时候你的代码在开发环境跑得好好的，到了生产环境就莫名其妙出问题。</p>
<p><strong>多线程：同时扔三个球还要不落地</strong></p>
<p>写多线程代码就像杂技表演，你得同时处理多个任务还不能出错。</p>
<p>数据竞争是最常见的问题——多个线程同时读写同一个数据，还没加锁，结果数据状态就乱套了。死锁就更精彩了：线程A等着线程B释放锁，线程B等着线程A释放锁，大家大眼瞪小眼，程序就卡那儿不动了。</p>
<p>C++11虽然提供了不错的线程库，但真要写出健壮的多线程代码，还得对内存模型、原子操作有深入理解，这又是一座要爬的大山。</p>
<p><strong>历史包袱：带着镣铐跳舞</strong></p>
<p>C++要兼容C，还要照顾老版本，这就导致它背着一堆历史包袱。</p>
<p>C风格的数组和指针，用起来远不如<code>vector</code>和<code>array</code>安全方便。预处理器宏缺乏类型安全，调试起来也麻烦。头文件机制导致编译时间慢，大项目改个基础头文件，整个项目都得重新编译。</p>
<p><strong>总结</strong></p>
<p>说实话，C++确实难搞，但它的强大也是实实在在的。关键是要有正确的方法：</p>
<p>别头铁，能用现代特性就用现代特性，智能指针、容器这些能帮你避开很多坑。
工具要用好，静态分析、内存检测工具该用就用，别跟自己过不去。
多看优秀代码和最佳实践，站在巨人肩膀上不香吗？</p>
<p>搞C++就像学开车，刚开始可能手忙脚乱，但熟练之后就能享受驾驶的乐趣了。虽然路上可能还会遇到坑，但至少你知道怎么绕过去了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Blazor现状调研分析：2025年全栈开发的新选择]]></title>    <link>https://juejin.cn/post/7572016447805308954</link>    <guid>https://juejin.cn/post/7572016447805308954</guid>    <pubDate>2025-11-13T14:14:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447805308954" data-draft-id="7572016447805292570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Blazor现状调研分析：2025年全栈开发的新选择"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-13T14:14:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Blazor现状调研分析：2025年全栈开发的新选择
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T14:14:25.000Z" title="Thu Nov 13 2025 14:14:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>2025年，Blazor作为微软基于.NET技术栈的前端框架，正以其独特的“浏览器+Razor”理念在Web开发领域掀起波澜。</p>
</blockquote>
<p>Blazor，这个名字源于Browser + Razor的组合，让开发者能够使用C#和.NET技术栈来构建现代Web应用，而不必依赖JavaScript。</p>
<p>随着.NET 10的发布和WebAssembly技术的成熟，Blazor已经在企业级应用、实时交互系统和跨平台开发中找到了自己的位置。</p>
<h2 data-id="heading-0">一、Blazor技术架构与演变</h2>
<h3 data-id="heading-1">1.1 两种主要托管模型</h3>
<p>Blazor提供<strong>两种不同的托管模型</strong>，以适应不同的应用场景：</p>
<ul>
<li>
<p><strong>Blazor Server</strong>：组件在服务器上运行，通过SignalR与客户端交互。这种模式<strong>首次加载速度快</strong>，页面仅需加载少量HTML和JavaScript，适合内网环境和实时性要求高的应用。</p>
</li>
<li>
<p><strong>Blazor WebAssembly</strong>：组件在浏览器中直接运行，基于WebAssembly执行。它支持<strong>离线运行</strong>和跨平台应用，但首次加载需要下载完整的WebAssembly运行时。</p>
</li>
</ul>
<h3 data-id="heading-2">1.2 技术实现原理</h3>
<p>Blazor巧妙地利用了WebAssembly技术，将.NET生态系统带回浏览器端。其核心在于对DotNetAnywhere解释器的改造，使其能够被编译为WebAssembly代码，并实现了.NET与JavaScript之间的互操作性。</p>
<p>一个简单的“hello world”应用程序需要下载约300KB的数据，包括轻量级的.NET运行时、核心库、应用程序代码以及启动和与WebAssembly代码交互所需的包装器库。</p>
<h3 data-id="heading-3">1.3 与传统框架的对比</h3>
<p>与ASP.NET MVC和ASP.NET Core相比，Blazor采用了<strong>组件化开发模式</strong>，更适合构建交互密集型应用。</p>
<p>在性能方面，基准测试显示ASP.NET Core能达到15,000+ req/sec，而Blazor Server约为8,000+ req/sec，ASP.NET MVC则为5,000+ req/sec。</p>
<h2 data-id="heading-4">二、2025年Blazor生态系统现状</h2>
<h3 data-id="heading-5">2.1 丰富的UI组件库</h3>
<p>Blazor生态系统已涌现出<strong>多种成熟的UI组件库</strong>，满足不同场景的需求：</p>
<ul>
<li>
<p><strong>商业级组件库</strong>：如Ignite UI for Blazor、Syncfusion Blazor DataGrid和Telerik UI for Blazor，提供企业级功能如实时数据更新、Excel-like UX、高级编辑和数据导出等。</p>
</li>
<li>
<p><strong>开源解决方案</strong>：MudBlazor遵循Material Design 3设计规范，提供从基础UI元素到复杂数据可视化的全系列组件；BootstrapBlazor基于Bootstrap 5构建，提供超过150个开箱即用的组件。</p>
</li>
</ul>
<h3 data-id="heading-6">2.2 开发工具与平台支持</h3>
<p>随着.NET 10的发布，Blazor获得了<strong>增强的可观测性</strong>、改进的OpenAPI支持以及更简单的渲染未找到页面的方法。</p>
<p>Visual Studio和.NET CLI提供了完整的开发工具链，调试体验非常优秀。 2025年第二季度，Telerik UI for Blazor还引入了AI编码助手，帮助用户生成业务代码，减少修改输出所需的时间。</p>
<h2 data-id="heading-7">三、Blazor的优势与适用场景</h2>
<h3 data-id="heading-8">3.1 核心优势</h3>
<ul>
<li>
<p><strong>统一技术栈</strong>：开发者可以使用C#和.NET技术栈进行前后端开发，<strong>代码复用性高</strong>，对于已熟悉.NET的团队入门成本低。</p>
</li>
<li>
<p><strong>强大的工具链</strong>：微软官方提供支持，Blazor与其他.NET技术（如ASP.NET Core、EF Core）无缝集成。</p>
</li>
<li>
<p><strong>实时交互支持</strong>：Blazor Server通过SignalR内置实时通信，适合需要实时更新（如仪表盘、聊天应用）的场景。</p>
</li>
<li>
<p><strong>跨平台能力</strong>：Blazor WebAssembly基于WebAssembly技术，支持离线运行和跨平台应用，与.NET MAUI集成可用于构建跨平台桌面和移动应用。</p>
</li>
</ul>
<h3 data-id="heading-9">3.2 典型应用场景</h3>
<p>根据实际应用案例，Blazor在以下场景中表现优异：</p>
<ul>
<li>
<p><strong>企业级应用</strong>：如数据可视化、内部管理工具（CRM、ERP系统）。某大型金融机构使用BootstrapBlazor构建的后台管理系统，通过内置的数据表格组件实现了百万级数据的高效渲染，配合虚拟滚动技术，页面加载时间从3秒优化至0.5秒。</p>
</li>
<li>
<p><strong>实时交互系统</strong>：聊天应用、实时监控（IoT或网络监控仪表盘）。</p>
</li>
<li>
<p><strong>内容管理系统</strong>：如FluentCMS—AI驱动的ASP.NET Core Blazor CMS。</p>
</li>
</ul>
<h2 data-id="heading-10">四、挑战与局限性</h2>
<h3 data-id="heading-11">4.1 性能问题</h3>
<p>Blazor Server的<strong>延迟依赖网络质量</strong>，需要稳定的网络连接，延迟较高可能影响用户体验。</p>
<p>Blazor WebAssembly的<strong>首次加载较慢</strong>，需要加载.NET运行时和依赖库，导致首次加载时间长。 虽然现在有AOT和压缩，但体验还是不如主流前端框架。</p>
<h3 data-id="heading-12">4.2 生态系统成熟度</h3>
<p>与JavaScript生态系统相比，Blazor的<strong>社区和插件生态相对较小</strong>。</p>
<p>虽然基础组件库已经丰富，但在复杂交互和动画效果方面仍不如React和Vue灵活。 当需要复杂的前端特性或接入成熟的前端库（如图表、富文本编辑器）时，开发者要么等待社区封装，要么自己写JSInterop。</p>
<h3 data-id="heading-13">4.3 开发体验问题</h3>
<p>Blazor的<strong>文档、API稳定性</strong>存在挑战，框架还在发展中，很多功能和写法变化太快。</p>
<p>这导致“文档和示例用的是旧写法”、“AI生成的代码直接跑不通”、“StackOverflow上的答案全是过时的”等情况。 此外，AI对Blazor的支持相比主流前端技术栈也有较大差距。</p>
<h2 data-id="heading-14">五、企业级选型建议</h2>
<h3 data-id="heading-15">5.1 技术选型决策指南</h3>
<p>在选择Blazor前，团队应考虑以下因素：</p>
<ul>
<li><strong>团队背景</strong>：如果团队主要由.NET开发者组成，Blazor能显著降低学习成本。</li>
<li><strong>项目类型</strong>：对于内部工具、管理后台和对.NET技术栈高度依赖的项目，Blazor是理想选择。</li>
<li><strong>性能要求</strong>：对于高并发场景，需要谨慎评估Blazor Server的服务器压力。</li>
</ul>
<h3 data-id="heading-16">5.2 与其他前端框架对比</h3>



































<table><thead><tr><th>特性</th><th>Blazor</th><th>Vue/React</th></tr></thead><tbody><tr><td><strong>语言与技术栈</strong></td><td>基于C#和.NET</td><td>JavaScript/TypeScript</td></tr><tr><td><strong>学习曲线</strong></td><td>对.NET开发者平缓</td><td>对前端开发者友好</td></tr><tr><td><strong>性能表现</strong></td><td>中等，首次加载较慢</td><td>轻量，性能优秀</td></tr><tr><td><strong>生态系统</strong></td><td>相对较小但成长中</td><td>庞大且成熟</td></tr><tr><td><strong>实时交互</strong></td><td>内置支持</td><td>需要额外库</td></tr></tbody></table>
<h2 data-id="heading-17">六、未来展望</h2>
<p>随着.NET 10的发布，Blazor生态系统正持续快速发展。 未来有几个值得关注的方向：</p>
<ul>
<li><strong>性能优化</strong>：进一步优化Blazor的性能，包括减小下载体积、提升执行效率等。</li>
<li><strong>工具链完善</strong>：完善Blazor的工具链，提供更好的开发体验。</li>
<li><strong>AI集成增强</strong>：更多AI辅助功能将被集成到Blazor开发环境中，提高开发效率。</li>
<li><strong>微前端架构</strong>：Blazor可能更深入地融入微前端架构，支持大型应用的模块化开发。</li>
</ul>
<h2 data-id="heading-18">结论</h2>
<p>Blazor在2025年已经成为一个<strong>成熟且可靠的Web开发框架</strong>，特别适合.NET技术栈的团队构建企业级应用。它在统一技术栈、开发效率和企业级集成方面具有明显优势，但在生态系统成熟度、性能和团队协作方面仍存在挑战。</p>
<p>对于考虑采用Blazor的团队，建议<strong>从小型项目开始</strong>，逐步评估其在特定场景下的表现，再决定是否在更大范围内应用。</p>
<p>虽然Blazor可能无法完全取代JavaScript生态，但它确实为.NET开发者提供了一个<strong>高效、一致的全栈开发体验</strong>，值得在合适的场景中尝试和应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Security 核心组件]]></title>    <link>https://juejin.cn/post/7572021695294849074</link>    <guid>https://juejin.cn/post/7572021695294849074</guid>    <pubDate>2025-11-13T14:25:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695294849074" data-draft-id="7572062035140296714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Security 核心组件"/> <meta itemprop="keywords" content="后端,Spring"/> <meta itemprop="datePublished" content="2025-11-13T14:25:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gelald"/> <meta itemprop="url" content="https://juejin.cn/user/923245499657822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Security 核心组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/923245499657822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gelald
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T14:25:11.000Z" title="Thu Nov 13 2025 14:25:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>以下 Spring Security 的版本是 6.1.0</p>
</blockquote>
<h2 data-id="heading-0">UserDetails</h2>
<p><code>UserDetails</code> 是一份静态的用户数据模型，提供了用户信息，回答了“用户是谁”的问题。它不参与认证的过程，只为认证过程提供数据，比如：用户名、密码、权限列表、帐号状态。</p>
<p>请注意：<code>UserDetails</code> 和项目中自定义的 "User" 不能直接划等号，这里会存在一个转换的过程，自定义的用户数据模型往往包含更多或更少的信息，<code>UserDetails</code> 是 Spring Security 官方定义的数据规范，在构建 <code>UserDetials</code> 对象时需要遵循规范来保证认证过程符合预期，比如：账号是否可用、是否锁定、用户有哪些权限等等。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> {

    <span class="hljs-comment">/**
     * 用户权限集合，用于构建认证主体的权限集合
     */</span>
    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();

    String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span>;

    String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 账号是否过期，如果是，在认证阶段会抛出 AccountExpiredException
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonExpired</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 账号是否锁定，如果是，在认证阶段会抛出 LockedException
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAccountNonLocked</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 账号凭证（一般指密码）是否过期，如果是，在认证阶段会抛出 CredentialsExpiredException
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCredentialsNonExpired</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 账号是否可用，如果不可用，在认证阶段会抛出 DisabledException
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnabled</span><span class="hljs-params">()</span>;
}
</code></pre>
<h3 data-id="heading-1">UserDetailsService</h3>
<p><code>UserDetailsService</code> 是 Spring Security 提供的查询 <code>UserDetails</code> 的规范，里面只有一个方法：<code>loadUserByUsername</code>，其中这个 Username 不一定真的对应我们自定义用户的 username，它可以是任意的用户唯一标识，比如在以手机号码为主体的认证系统中，这个 username 就可以是用户的手机号码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDetailsService</span> {

    UserDetails <span class="hljs-title function_">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException;
}
</code></pre>
<p>在实际开发中，我们需要实现这个接口，来完成用户数据的查询并封装成 <code>UserDetails</code> 格式返回</p>
<h2 data-id="heading-2">Authentication</h2>
<p><code>Authentication</code> 是一个动态的认证上下文对象，回答了“请求主体是谁？是否通过认证？拥有哪些权限？”的问题。这是它和 <code>UserDetails</code> 最本质的区别，一个是用户数据模型，而它是 Spring Security 中实际流动和使用的核心对象。</p>
<p>在认证阶段，认证前它仅封装了用户提交的登录凭证（比如用户名和密码）；认证成功后它会被再次填充为一个包含用户信息的对象，来证明这个用户已经通过了认证。</p>
<p>在授权阶段，其中 <code>authorization</code> 属性是授权决策的直接数据来源。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Authentication</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Principal</span>, Serializable {

    <span class="hljs-comment">/**
     * 认证主体的权限集合，用于鉴权
     */</span>
    Collection&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">GrantedAuthority</span>&gt; getAuthorities();

    <span class="hljs-comment">/**
     * 认证前：用户凭证（密码）
     * 认证后：出于安全考虑，会对其进行擦除，返回 null
     */</span>
    Object <span class="hljs-title function_">getCredentials</span><span class="hljs-params">()</span>;

    Object <span class="hljs-title function_">getDetails</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 认证前：用户名
     * 认证后：通过认证的用户对象
     */</span>
    Object <span class="hljs-title function_">getPrincipal</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 声明认证主体是否已经通过了认证
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAuthenticated</span><span class="hljs-params">()</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthenticated</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isAuthenticated)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException;
}
</code></pre>
<h2 data-id="heading-3">SecurityContext</h2>
<p><code>SecurityContext</code> 翻译为安全上下文，在用户通过认证后，认证信息会被包含在 <code>Authentication</code> 对象中，而 <code>Authentication</code> 会存储到 <code>SecurityContext</code> 上下文中。</p>
<p>简单理解为：<strong>存放认证信息的容器</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SecurityContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Serializable</span> {
    Authentication <span class="hljs-title function_">getAuthentication</span><span class="hljs-params">()</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthentication</span><span class="hljs-params">(Authentication authentication)</span>;
}
</code></pre>
<h2 data-id="heading-4">SecurityContextHolder</h2>
<p><code>SecurityContextHolder</code> 从名字中不难看出他是用于获取 <code>SecurityContext</code> 的组件，但是细看源码，它并不直接负责存储，而是提供存储的策略，实际的存储工作由不同的 <code>SecurityContextHolderStrategy</code> 来实现。</p>
<p><code>SecurityContextHolder</code> 会调用当前使用的 <code>SecurityContextHolderStrategy</code> 来获取或修改 <code>SecurityContext</code>。有 3 种存储策略：</p>
<ul>
<li><code>MODE_THREADLOCAL</code>：底层使用 <code>ThreadLocal</code> 来实现存储，<code>SecurityContext</code> 存储在当前线程中（默认存储策略）</li>
<li><code>MODE_INHERITABLETHREADLOCAL</code>：底层使用 <code>InheritableThreadLocal</code> 来实现存储，在 <code>MODE_THREADLOCAL</code> 基础上，可以在开启的子线程中获取 <code>SecurityContext</code></li>
<li><code>MODE_GLOBAL</code>：底层使用静态变量来实现存储，<code>SecurityContext</code> 始终只有一份会被全局读写</li>
</ul>
<h3 data-id="heading-5">自定义 SecurityContextHolderStrategy</h3>
<p>如果 3 种默认的存储策略都不满足使用的话，可以自定义存储策略</p>
<ul>
<li>实现 <code>SecurityContextHolderStrategy</code> 接口，并实现接口方法</li>
<li>在 <code>spring.security.strategy</code> 配置值中指定自定义的 <code>SecurityContextHolderStrategy</code> 的全限定类名</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityContextHolder</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SYSTEM_PROPERTY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"spring.security.strategy"</span>;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">strategyName</span> <span class="hljs-operator">=</span> System.getProperty(SYSTEM_PROPERTY);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SecurityContextHolderStrategy strategy;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeStrategy</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">if</span> (MODE_PRE_INITIALIZED.equals(strategyName)) {
          Assert.state(strategy != <span class="hljs-literal">null</span>, <span class="hljs-string">"When using "</span> + MODE_PRE_INITIALIZED
                + <span class="hljs-string">", setContextHolderStrategy must be called with the fully constructed strategy"</span>);
          <span class="hljs-keyword">return</span>;
       }
       <span class="hljs-keyword">if</span> (!StringUtils.hasText(strategyName)) {
          <span class="hljs-comment">// Set default</span>
          strategyName = MODE_THREADLOCAL;
       }
        <span class="hljs-comment">// 按官方提供的存储策略初始化</span>
       <span class="hljs-keyword">if</span> (strategyName.equals(MODE_THREADLOCAL)) {
          strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalSecurityContextHolderStrategy</span>();
          <span class="hljs-keyword">return</span>;
       }
       <span class="hljs-keyword">if</span> (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) {
          strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InheritableThreadLocalSecurityContextHolderStrategy</span>();
          <span class="hljs-keyword">return</span>;
       }
       <span class="hljs-keyword">if</span> (strategyName.equals(MODE_GLOBAL)) {
          strategy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GlobalSecurityContextHolderStrategy</span>();
          <span class="hljs-keyword">return</span>;
       }
       <span class="hljs-comment">// Try to load a custom strategy</span>
       <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 关键：按类名加载你的自定义 SecurityContextHolderStrategy</span>
          Class&lt;?&gt; clazz = Class.forName(strategyName);
          Constructor&lt;?&gt; customStrategy = clazz.getConstructor();
          strategy = (SecurityContextHolderStrategy) customStrategy.newInstance();
       }
       <span class="hljs-keyword">catch</span> (Exception ex) {
          ReflectionUtils.handleReflectionException(ex);
       }
    }
}
</code></pre>
<h2 data-id="heading-6">AuthenticationProvider</h2>
<p><code>AuthenticationProvider</code> 是实际负责认证工作的核心组件，前面提到过：<code>Authentication</code> 中的数据会在认证前后产生变化，就是 <code>AuthenticationProvider</code> 来实现的。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationProvider</span> {

    <span class="hljs-comment">/**
     * 执行核心的认证逻辑
     */</span>
    Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException;

    <span class="hljs-comment">/**
     * 决定当前 Provider 实现类是否支持认证这个认证主体
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span>;

}
</code></pre>
<h3 data-id="heading-7">AbstractUserDetailsAuthenticationProvider</h3>
<p>以用户名密码登录的机制为例，它的实现类是 <code>AbstractUserDetailsAuthenticationProvider</code>，它的 <code>supports</code> 方法是这样子的：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span> {
      <span class="hljs-keyword">return</span> (UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication));
    }
</code></pre>
<p>判断当前 <code>authentication</code> 是否和 <code>UsernamePasswordAuthenticationToken</code> 类相同，显然用户名密码登录时的 <code>Authentication</code> 会使用 <code>UsernamePasswordAuthenticationToken</code> 作为实现类</p>
<p>接下来看 <code>authenticate</code> 方法（仅列出关键代码）：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException {
      <span class="hljs-comment">// 第一步校验参数...</span>

      <span class="hljs-comment">// 第二步从 cache 中获取用户，如果没有启用 cache 的话，默认是 NullUserCache 实现 cache（不做任何的缓存操作）</span>
      <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.userCache.getUserFromCache(username);
      <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-comment">// 如果 cache 中无法查询到用户，那么使用 retrieveUser 方法来获取用户</span>
          <span class="hljs-comment">// 其中 retrieveUser 方法是子类实现的，最终把 user 查询出来</span>
          user = retrieveUser(username, (UsernamePasswordAuthenticationToken) authentication);
        }
        <span class="hljs-keyword">catch</span> (UsernameNotFoundException ex) {
          <span class="hljs-comment">// 查不到 user 会抛出 UsernameNotFoundException，进而被封装成 BadCredentialsException</span>
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCredentialsException</span>(<span class="hljs-built_in">this</span>.messages
              .getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>, <span class="hljs-string">"Bad credentials"</span>));
        }
      }

      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 第三步做的校验包括：isAccountNonLocked、isEnabled、isAccountNonExpired</span>
        <span class="hljs-comment">// 如果不满足以上条件，那么会抛出各类型的异常</span>
        <span class="hljs-built_in">this</span>.preAuthenticationChecks.check(user);
        <span class="hljs-comment">// 第四步执行子类中实现的额外校验</span>
        <span class="hljs-comment">// 一般是密码校验</span>
        additionalAuthenticationChecks(user, (UsernamePasswordAuthenticationToken) authentication);
      }
      <span class="hljs-keyword">catch</span> (AuthenticationException ex) {
        <span class="hljs-comment">// ...</span>
      }
      <span class="hljs-comment">// 第五步做的校验是：isCredentialsNonExpired</span>
      <span class="hljs-built_in">this</span>.postAuthenticationChecks.check(user);
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// 可以看到 principalToReturn 被指定为整个 user</span>
      <span class="hljs-type">Object</span> <span class="hljs-variable">principalToReturn</span> <span class="hljs-operator">=</span> user;
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// 最终给 Authenticatoin 注入用户信息，实现认证前后的数据转换，其中 Authentication 的 principal 会填充 user 信息</span>
      <span class="hljs-keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);
    }
</code></pre>
<h3 data-id="heading-8">DaoAuthenticationProvider</h3>
<p><code>DaoAuthenticationProvider</code> 是 <code>AbstractUserDetailsAuthenticationProvider</code> 的实现类，负责了上面提到的 <code>retrieveUser</code>、<code>additionalAuthenticationChecks</code> 等重要工作</p>
<p>首先看 <code>retrieveUser</code>，主要的工作还是去查询用户，另外还有一个防攻击的额外步骤：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> UserDetails <span class="hljs-title function_">retrieveUser</span><span class="hljs-params">(String username, UsernamePasswordAuthenticationToken authentication)</span>
        <span class="hljs-keyword">throws</span> AuthenticationException {
      prepareTimingAttackProtection();
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// getUserDetailsService 方法去获取我们实现 UserDetailsService 接口的实现类来调用 loadUserByUsername 方法</span>
        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">loadedUser</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getUserDetailsService().loadUserByUsername(username);
        <span class="hljs-keyword">if</span> (loadedUser == <span class="hljs-literal">null</span>) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalAuthenticationServiceException</span>(
              <span class="hljs-string">"UserDetailsService returned null, which is an interface contract violation"</span>);
        }
        <span class="hljs-keyword">return</span> loadedUser;
      }
      <span class="hljs-keyword">catch</span> (UsernameNotFoundException ex) {
        <span class="hljs-comment">// 非常精妙的一个设计：即使无法查询到用户，依然去对一个默认的密码做密码校验</span>
        <span class="hljs-comment">// 目的：填充密码校验的时间，让攻击者无法通过响应时间来破解用户名是否存在</span>
        mitigateAgainstTimingAttack(authentication);
        <span class="hljs-keyword">throw</span> ex;
      }
      <span class="hljs-comment">//...</span>
    }
</code></pre>
<p>然后看 <code>additionalAuthenticationChecks</code> 方法，就是通过 passwordEncoder 来校验密码：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@SuppressWarnings("deprecation")</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">additionalAuthenticationChecks</span><span class="hljs-params">(UserDetails userDetails,
        UsernamePasswordAuthenticationToken authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException {
      <span class="hljs-comment">// 参数校验...</span>
      <span class="hljs-type">String</span> <span class="hljs-variable">presentedPassword</span> <span class="hljs-operator">=</span> authentication.getCredentials().toString();
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.passwordEncoder.matches(presentedPassword, userDetails.getPassword())) {
        <span class="hljs-built_in">this</span>.logger.debug(<span class="hljs-string">"Failed to authenticate since password does not match stored value"</span>);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadCredentialsException</span>(<span class="hljs-built_in">this</span>.messages
            .getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>, <span class="hljs-string">"Bad credentials"</span>));
      }
    }
</code></pre>
<h2 data-id="heading-9">AuthenticationManager</h2>
<p><code>AuthenticationManager</code> 接口的结构和 <code>AuthenticationProvider</code> 结构很类似，都是有一个 <code>authenticate</code> 方法，但是它们扮演的角色却大不相同。</p>
<p>核心功能是指派之前提到的 <code>supports</code> 方法是 <code>true</code> 的 <code>AuthenticationProvider</code> 来执行真正的认证工作</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthenticationManager</span> {

    Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException;
}
</code></pre>
<h3 data-id="heading-10">ProviderManager</h3>
<p><code>ProviderManager</code> 是 Spring Security 中使用到的实现类，里面的逻辑更证实了他只是一个委派者角色</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException {
        <span class="hljs-comment">// ...</span>
      Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Authentication</span>&gt; toTest = authentication.getClass();
      <span class="hljs-keyword">for</span> (AuthenticationProvider provider : getProviders()) {
        <span class="hljs-comment">// 验证 supports 方法是否返回 true，true 的情况才满足认证的条件</span>
        <span class="hljs-keyword">if</span> (!provider.supports(toTest)) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-comment">// 打印日志...</span>
        <span class="hljs-keyword">try</span> {
          result = provider.authenticate(authentication);
          <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) {
            copyDetails(authentication, result);
            <span class="hljs-keyword">break</span>;
          }
        }
        <span class="hljs-keyword">catch</span> (AccountStatusException | InternalAuthenticationServiceException ex) {
          <span class="hljs-comment">// 异常处理...</span>
        }
        <span class="hljs-keyword">catch</span> (AuthenticationException ex) {
          <span class="hljs-comment">// 异常处理...</span>
        }
      }
      <span class="hljs-comment">// ...</span>
    }
</code></pre>
<h2 data-id="heading-11">DefaultSecurityFilterChain</h2>
<p>Spring Security 对 Servlet 应用增加是基于 Servlet Filter 实现的，常见的包括处理 csrf 的过滤器、校验权限的过滤器、处理登录的过滤器等等，它们通常会被组织成一个 FilterChain 的形式来工作，我们可以理解为一个 FilterChain 包含了多个相同模块但不同功能的 Filter。比如 Spring Security 提供的 FilterChain 就叫 <code>DefaultSecurityFilterChain</code>，我们引入了 Spring Security 的依赖并启动应用后，控制台会输出这一段信息：</p>
<pre><code class="hljs language-txt" lang="txt">2023-06-14T08:55:22.321-03:00  INFO 76975 --- [           main] o.s.s.web.DefaultSecurityFilterChain     : Will secure any request with [
org.springframework.security.web.session.DisableEncodeUrlFilter@404db674,
org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@50f097b5,
org.springframework.security.web.context.SecurityContextHolderFilter@6fc6deb7,
org.springframework.security.web.header.HeaderWriterFilter@6f76c2cc,
org.springframework.security.web.csrf.CsrfFilter@c29fe36,
org.springframework.security.web.authentication.logout.LogoutFilter@ef60710,
org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter@7c2dfa2,
org.springframework.security.web.authentication.ui.DefaultLoginPageGeneratingFilter@4397a639,
org.springframework.security.web.authentication.ui.DefaultLogoutPageGeneratingFilter@7add838c,
org.springframework.security.web.authentication.www.BasicAuthenticationFilter@5cc9d3d0,
org.springframework.security.web.savedrequest.RequestCacheAwareFilter@7da39774,
org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@32b0876c,
org.springframework.security.web.authentication.AnonymousAuthenticationFilter@3662bdff,
org.springframework.security.web.access.ExceptionTranslationFilter@77681ce4,
org.springframework.security.web.access.intercept.AuthorizationFilter@169268a7]
</code></pre>
<p>可以看到这个 FilterChain 里面包含的多个 Filter，一旦看见这些 Filter，说明 Spring Security 已经成功接管了项目的认证授权模块</p>
<h3 data-id="heading-12">UsernamePasswordAuthenticationFilter</h3>
<p><code>UsernamePasswordAuthenticationFilter</code> 是 Spring Security 过滤器链上关于认证的过滤器，它是发起认证流程的起点，所有的组件都将由它来组织并发起工作</p>
<p>回顾 Filter 的工作流程，核心方法就是 <code>doFilter</code>，拦截请求，完成拦截的逻辑后会递归地调用同一 FilterChain 上的 Filter，我们看 <code>UsernamePasswordAuthenticationFilter</code> 父类中实现的 <code>doFilter</code> 方法：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span>
        <span class="hljs-keyword">throws</span> IOException, ServletException {
      doFilter((HttpServletRequest) request, (HttpServletResponse) response, chain);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span>
        <span class="hljs-keyword">throws</span> IOException, ServletException {
      <span class="hljs-comment">// ...</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// attemptAuthentication 是执行认证的核心方法</span>
        <span class="hljs-type">Authentication</span> <span class="hljs-variable">authenticationResult</span> <span class="hljs-operator">=</span> attemptAuthentication(request, response);
        <span class="hljs-comment">// 认证成功后存储 session 信息，这里不展开</span>
        <span class="hljs-built_in">this</span>.sessionStrategy.onAuthentication(authenticationResult, request, response);
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// 认证通过后的处理</span>
        successfulAuthentication(request, response, chain, authenticationResult);
      }
      <span class="hljs-keyword">catch</span> (InternalAuthenticationServiceException failed) {
        <span class="hljs-built_in">this</span>.logger.error(<span class="hljs-string">"An internal error occurred while trying to authenticate the user."</span>, failed);
        <span class="hljs-comment">// 认证失败的处理</span>
        unsuccessfulAuthentication(request, response, failed);
      }
      <span class="hljs-keyword">catch</span> (AuthenticationException ex) {
        <span class="hljs-comment">// 认证失败的处理</span>
        unsuccessfulAuthentication(request, response, ex);
      }
    }
</code></pre>
<p>可以看到 <code>doFilter</code> 方法中的核心逻辑还是执行 <code>attemptAuthentication</code> 方法，认证成功后做某些处理，认证失败又会做另外的处理，我们具体看它会做什么处理：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">successfulAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,
        Authentication authResult)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        
        <span class="hljs-comment">// 这里使用 SecurityContextHolderStrategy 来创建 SecurityContext </span>
        <span class="hljs-type">SecurityContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.securityContextHolderStrategy.createEmptyContext();
        <span class="hljs-comment">// 为 SecurityContext 存储 Authentication 对象</span>
        context.setAuthentication(authResult);
        <span class="hljs-comment">// 更新 SecurityContext 到 SecurityContextHolder 中，方便后续使用</span>
        <span class="hljs-built_in">this</span>.securityContextHolderStrategy.setContext(context);

        <span class="hljs-built_in">this</span>.securityContextRepository.saveContext(context, request, response);
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.logger.isDebugEnabled()) {
            <span class="hljs-built_in">this</span>.logger.debug(LogMessage.format(<span class="hljs-string">"Set SecurityContextHolder to %s"</span>, authResult));
        }
        <span class="hljs-built_in">this</span>.rememberMeServices.loginSuccess(request, response, authResult);
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.eventPublisher != <span class="hljs-literal">null</span>) {
            <span class="hljs-built_in">this</span>.eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InteractiveAuthenticationSuccessEvent</span>(authResult, <span class="hljs-built_in">this</span>.getClass()));
        }
        <span class="hljs-built_in">this</span>.successHandler.onAuthenticationSuccess(request, response, authResult);
    }


    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unsuccessfulAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,
        AuthenticationException failed)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        
        <span class="hljs-comment">// 认证失败先清除 SecurityContext</span>
        <span class="hljs-built_in">this</span>.securityContextHolderStrategy.clearContext();

        <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">"Failed to process authentication request"</span>, failed);
        <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">"Cleared SecurityContextHolder"</span>);
        <span class="hljs-built_in">this</span>.logger.trace(<span class="hljs-string">"Handling authentication failure"</span>);
        <span class="hljs-built_in">this</span>.rememberMeServices.loginFail(request, response);
        <span class="hljs-built_in">this</span>.failureHandler.onAuthenticationFailure(request, response, failed);
    }
</code></pre>
<p>最后看 <code>attemptAuthentication</code> 方法，核心的工作依然是调用 <code>AuthenticationManager</code> 进而去委派实际的 <code>AuthenticationProvider</code> 来完成实际的认证工作</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Authentication <span class="hljs-title function_">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span>
          <span class="hljs-keyword">throws</span> AuthenticationException {
        <span class="hljs-comment">// ...</span>
        
        <span class="hljs-comment">// 参数处理</span>
       <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> obtainUsername(request);
       username = (username != <span class="hljs-literal">null</span>) ? username.trim() : <span class="hljs-string">""</span>;
       <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> obtainPassword(request);
       password = (password != <span class="hljs-literal">null</span>) ? password : <span class="hljs-string">""</span>;
       
       <span class="hljs-comment">// 把用户名密码封装到 Authentication 中</span>
       <span class="hljs-type">UsernamePasswordAuthenticationToken</span> <span class="hljs-variable">authRequest</span> <span class="hljs-operator">=</span> UsernamePasswordAuthenticationToken.unauthenticated(username, password);
       <span class="hljs-comment">// 这里主要把 IP地址、sessionId 信息添加到 Authentication 中</span>
        setDetails(request, authRequest);
       
       <span class="hljs-comment">// 调用 AuthenticationManager 来完成认证</span>
       <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getAuthenticationManager().authenticate(authRequest);
    }

</code></pre>
<h2 data-id="heading-13">Spring Security 认证流程简易流程图</h2>
<p><img src="https://wingbun-notes-image.oss-cn-guangzhou.aliyuncs.com/images/image.png" alt="Spring Security 认证流程" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小伙伴们学习 C#/.NET 相关技术栈的学习心得和路线]]></title>    <link>https://juejin.cn/post/7572016447805407258</link>    <guid>https://juejin.cn/post/7572016447805407258</guid>    <pubDate>2025-11-13T14:32:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447805407258" data-draft-id="7572062035140280330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小伙伴们学习 C#/.NET 相关技术栈的学习心得和路线"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-11-13T14:32:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小伙伴们学习 C#/.NET 相关技术栈的学习心得和路线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T14:32:13.000Z" title="Thu Nov 13 2025 14:32:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天咱们一起来看看<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Frq-_dMpdLltPxvOdihl0UA" target="_blank" title="https://mp.weixin.qq.com/s/rq-_dMpdLltPxvOdihl0UA" ref="nofollow noopener noreferrer">DotNetGuide技术社区</a>小伙伴们学习 C#/.NET 相关技术栈的学习心得和路线。</p>
<h2 data-id="heading-1">小伙伴们的学习心得和路线</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1d45c0147814aa2a7f8a7de69520197~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649133&amp;x-signature=n0SQkMHl4ssrDBmK6Fb8R9BWCMQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1055bb22ecd4b0eb1d837007c027510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649133&amp;x-signature=4xFqA9I06PsCJk0UmY0ZLlSvpQs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2f0da158ec04716b9ca87abca02f1dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649133&amp;x-signature=y93Tn%2BAZocZ3zxLtPCFBaG%2Bbqmw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e77f3934ed204a769ccdf8ba433532f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649133&amp;x-signature=%2BM0hGN1%2BMdRvIb7xx5OQBvufZ68%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e4d267310064eccb1ef2bdab8bec28f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649133&amp;x-signature=c9prorsrvJcnrV68usWSnPrvviE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77251326e3e0481fa12cb3f7fc64f6cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649133&amp;x-signature=rTbaaYlcM9JJ%2Fv1LJkc8tUI%2B5Q0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59be702f06274561b73ff7a22a6a96ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649133&amp;x-signature=%2B5cRXM9tYO6pelXcWEq8iqlW2rc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">C#/.NET/.NET Core学习、工作、面试指南</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9081bcc0ca142f6ae1c3f69e60a1af4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649133&amp;x-signature=fWLdQYJTNHGX8%2BrkVRctj97RiYY%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[好消息，.NET 10 正式发布，更智能、更安全、更高性能的统一开发平台！]]></title>    <link>https://juejin.cn/post/7572164122235568138</link>    <guid>https://juejin.cn/post/7572164122235568138</guid>    <pubDate>2025-11-13T14:37:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572164122235568138" data-draft-id="7572132100327637042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="好消息，.NET 10 正式发布，更智能、更安全、更高性能的统一开发平台！"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-11-13T14:37:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            好消息，.NET 10 正式发布，更智能、更安全、更高性能的统一开发平台！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T14:37:30.000Z" title="Thu Nov 13 2025 14:37:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>好消息，.NET 团队于 2025 11 月 11 日宣布 .NET 10 正式发布，这是迄今为止最高效、最现代、最安全、最智能且性能最高的 .NET 版本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c0de23e11b2479e859eb20d4af5ee35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=FHIelZZmHqTss1V%2Fqx%2FjWFgJUOI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0967f0051844c73a469e1ce362fdba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=5raqO4MSWh39%2B3Qwq%2FDzt6FHDVE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">长期支持版本（LTS）</h2>
<p>.NET 10 是一个长期支持版本（LTS） ，将支持三年 ，直至 2028 年 11 月 10 日。我们强烈建议生产环境中的应用程序升级到 .NET 10，以便享受更长的支持周期、显著的性能提升以及众多新功能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/faee06a8870044b9a6d06a93e08cf5da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=LM2IYGFA6y%2FDZ3sh26rFUHd7zP0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">下载 .NET 10 体验</h2>
<ul>
<li><strong>.NET 10 下载地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdotnet.microsoft.com%2Fzh-cn%2Fdownload%2Fdotnet%2F10.0" target="_blank" title="https://dotnet.microsoft.com/zh-cn/download/dotnet/10.0" ref="nofollow noopener noreferrer">dotnet.microsoft.com/zh-cn/downl…</a></li>
<li><strong>Visual Studio 2026 下载体验：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fvisualstudio.microsoft.com%2Fzh-hans%2Fdownloads" target="_blank" title="https://visualstudio.microsoft.com/zh-hans/downloads" ref="nofollow noopener noreferrer">visualstudio.microsoft.com/zh-hans/dow…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0834131893644088aac517edf233b2a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=EnYJKdQ9cmuGEiXi0HwhwOfFWOw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1824c5b576354aa585c65ecf8c1e6090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=%2B1P6KnuYu45GSg7oPZ%2BuwAQ4raU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">.NET 10 应用更快，内存占用更低</h2>
<p>.NET 10 是迄今为止速度最快的 .NET 版本，在运行时、工作负载和语言层面都进行了全面优化。</p>
<blockquote>
<p>.NET 10 中的性能改进详细介绍：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fannouncing-dotnet-10" target="_blank" title="https://devblogs.microsoft.com/dotnet/announcing-dotnet-10" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/anno…</a></p>
</blockquote>
<p><strong>主要改进：</strong></p>
<ul>
<li><strong>JIT 编译器增强：</strong> 改进了内联、循环克隆、方法去虚拟化，以及优化了结构体参数的代码生成功能。</li>
<li><strong>NativeAOT 改进：</strong> 生成体积更小、运行更快的提前编译应用。</li>
<li><strong>运行时优化：</strong> 增强的循环反转（loop inversion）和栈分配（stack allocation）策略，带来可衡量的性能提升。</li>
<li><strong>硬件加速方面：</strong> 支持尖端英特尔芯片的AVX10.2指令集，以及用于高级向量化的Arm64 SVE指令集，配合Arm64写屏障优化可将垃圾回收（GC）暂停时间缩短8-20%。</li>
</ul>
<h2 data-id="heading-4">C# 14 新特性</h2>
<p>C# 14 引入了多项新功能与增强，旨在提升开发者的工作效率与代码质量。主要更新包括：</p>
<ul>
<li><strong>字段支持的属性</strong>：提供了从自动实现属性过渡到编写自定义 <code>get</code> 和 <code>set</code> 访问器的更平滑路径。你可以使用上下文关键字 <code>field</code> 来访问编译器生成的支持字段。</li>
<li><strong>对未绑定泛型类型的 <code>nameof</code> 支持</strong>：<code>nameof</code> 表达式现在支持未绑定的泛型类型，例如 <code>List&lt;&gt;</code>，它返回类型的名称，而无需类型参数。</li>
<li><strong><code>Span&lt;T&gt;</code> 与 <code>ReadOnlySpan&lt;T&gt;</code> 的隐式转换</strong>：为这两种类型提供了原生支持的隐式转换。</li>
<li><strong>Lambda 表达式支持参数修饰符</strong>：在 Lambda 表达式中，现在允许使用 <code>ref</code>、<code>in</code> 或 <code>out</code> 等参数修饰符，而无需显式指定参数类型。</li>
<li><strong>扩展属性与方法</strong>：新增的扩展块支持静态扩展方法，以及静态和实例扩展属性。</li>
<li><strong>空条件赋值</strong>：可以使用 <code>?.</code> 运算符进行空条件检查后的赋值操作。</li>
</ul>

<ul>
<li><strong>等等等...</strong></li>
</ul>
<h2 data-id="heading-5">ASP.NET Core 中的新增功能</h2>
<p>ASP.NET Core 10.0 版本带来了多项新功能和改进，包括<code>Blazor</code>、<code>OpenAPI</code>、<code>Minimal API</code>、<code>SignalR</code>和身份验证和授权的优化与更新。</p>
<blockquote>
<p>ASP.NET Core 中的新增功能详细介绍：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fzh-cn%2Faspnet%2Fcore%2Frelease-notes%2Faspnetcore-10.0%3Fview%3Daspnetcore-10.0" target="_blank" title="https://learn.microsoft.com/zh-cn/aspnet/core/release-notes/aspnetcore-10.0?view=aspnetcore-10.0" ref="nofollow noopener noreferrer">learn.microsoft.com/zh-cn/aspne…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f79f36c75574702ab6fb215fde5ca5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=kCC54W1N0oOTnirlP6CExVMZojE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">.NET 库更新</h2>
<p>.NET 10 的类库在加密、网络、序列化等多个方面带来了重要更新，让 .NET 应用程序更加安全和高效。</p>
<h2 data-id="heading-7">人工智能，从简单的集成到多代理系统</h2>
<p>.NET 让构建 AI 驱动的应用变得简单直接，无论是轻量级集成还是复杂的多智能体系统都能轻松应对。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/408914a3b3cc41a292411ac2f0195bcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=yTnvQmg1JQQlR7CN7yXUHZZXvO4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">Microsoft 代理框架：构建智能多代理系统</h3>
<p>Microsoft 代理框架通过将语义内核和 AutoGen 的优点结合到统一体验中，简化了智能代理 AI 系统的构建。无论您是构建单个 AI 代理还是协调多个代理协同工作，该框架都能提供您所需的模式和基础设施。</p>
<ul>
<li>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-framework" target="_blank" title="https://github.com/microsoft/agent-framework" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54c1b085be1e4245a8de5138bce49ac8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=2ociEv4d4DQQppUslgddp92EQW4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">人工智能应用的统一构建模块</h3>
<p><code>Microsoft.Extensions.AI</code> 和 <code>Microsoft.Extensions.VectorData</code> 提供统一的抽象，用于将 AI 服务集成到您的应用程序中。IChatClient 接口通过一致的 API 与任何提供程序（OpenAI、Azure OpenAI、GitHub Models、Ollama）配合使用，从而可以轻松切换提供程序或支持多个后端，而无需重写代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c06a102b22f24cce9a801dde66fe348f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=f%2FUPrPDRANbl2%2BKdqhSJgw9huh8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">.NET 提供一流的 MCP 支持</h3>
<p>.NET 提供对 Model Context Protocol（MCP，模型上下文协议） 的一流支持，让 AI 智能体能够通过标准化方式连接外部工具和服务。MCP 使 AI 智能体可以访问数据源、API 和各种工具，从而显著提升其能力和适用场景的多样性。</p>
<ul>
<li>C# MCP SDK：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Fcsharp-sdk" target="_blank" title="https://github.com/modelcontextprotocol/csharp-sdk" ref="nofollow noopener noreferrer">github.com/modelcontex…</a></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc27f2ba1df4b11b68d915cd3e46ff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=kSeSKtQd7%2BOGdxZ9bgjhPNBAi5g%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">EF Core 10 中的新增功能</h2>
<ul>
<li>矢量搜索支持 (Azure SQL/SQL Server)。</li>
<li>JSON 类型支持 (Azure SQL/SQL Server 2025)。</li>
<li>全文搜索支持（Azure Cosmos DB for NoSQL）。</li>
<li>支持 .NET 10 LeftJoin 和 RightJoin 运算符。</li>
<li>参数化集合查询策略优化。</li>
<li>等等等...</li>
</ul>
<blockquote>
<p>EF Core 10 中的新增功能详细介绍：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fzh-cn%2Fef%2Fcore%2Fwhat-is-new%2Fef-core-10.0%2Fwhatsnew" target="_blank" title="https://learn.microsoft.com/zh-cn/ef/core/what-is-new/ef-core-10.0/whatsnew" ref="nofollow noopener noreferrer">learn.microsoft.com/zh-cn/ef/co…</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4efbb38a8b074b3fb680ffc17e8db055~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763649449&amp;x-signature=tDL9v%2BzYdtZujYNiFqgtTq1baXg%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[十月份 AI Coding 实践！Qoder、CC、Codex 还是 iflow？]]></title>    <link>https://juejin.cn/post/7572062035140411402</link>    <guid>https://juejin.cn/post/7572062035140411402</guid>    <pubDate>2025-11-13T14:50:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572062035140411402" data-draft-id="7572062035140362250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="十月份 AI Coding 实践！Qoder、CC、Codex 还是 iflow？"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-11-13T14:50:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            十月份 AI Coding 实践！Qoder、CC、Codex 还是 iflow？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T14:50:17.000Z" title="Thu Nov 13 2025 14:50:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个月不管是工作中还是在闲暇时分，都在大量使用 AI 来完成编程任务。这篇文章主要从<strong>模型</strong>和<strong>工具</strong>两个方面来分享一下三金在实际应用中的一些经验和踩坑。</p>
<h3 data-id="heading-0">模型</h3>
<p>首先要说的就是<strong>模型</strong>，因为这玩意儿就<strong>跟人的智商一样</strong>，智商的高低决定了 AI Coding 的结果上限。</p>
<p>从我使用过的模型来看，主要分为两类：<strong>付费</strong>和<strong>开源</strong>。</p>
<p>在付费模型中，被大家耳熟能详的就是 Claude、GPT5 和 Gemini 2.5 Pro。它们的实力也毋庸置疑，在使用相同 AI 工具的情况下，<strong>付费模型产出的结果质量就是优于免费模型</strong>。</p>
<p>而这三个模型的能力排名，以我个人的观点，依次是：<strong>Claude -&gt; GPT5 -&gt; Gemini 2.5 Pro</strong>。</p>
<p>没错，Claude 模型在我心中依旧是无冕之王。</p>
<p>它在代码质量、可处理的项目规模大小、工程化等维度，还是优于后面两者。其实 GPT5 现在也非常 OK，在编码能力上和 Claude 的差距已经被追的很小，所以也有小伙伴会觉得 GPT5 优于 Claude。</p>
<p>不过这个仁者见仁、智者见智，除了模型之外，工具和提示词在其中也占据了大部分影响因素，三金更推荐大家同时使用它们<strong>进行协同开发，效果更加显著</strong>。</p>
<p>而在开源模型中，GLM 4.6 是当今的佼佼者，其次是 Kimi K2、DeepSeek V3 系列、Qwen3 Coder Plus 以及最近 MiniMax 刚出的 M2。</p>
<p>这几款模型三金都有尝试过进行 AI Coding，而最终产物给我的感觉就是——<strong>能跑，但不能细看</strong>，属于非常“优秀”的<strong>防御性代码开发选手</strong>。应对中小型应用开发来说绰绰有余，开发复杂的大型项目，会让人恨不得给“它们”两拳。</p>
<p>综上，在有能力和渠道的情况下，我优先使用 Claude 4.5 和 Claude 4，其次是 GPT5。若渠道无法使用这些模型的情况下，会优先使用 GLM 4.6。</p>
<blockquote>
<p>给大家<strong>推两个非常好用的免费站点</strong>，有提供 Claude 模型和 GPT5 模型。分别是：</p>
<p>AgentRouter：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentrouter.org%2Fregister%3Faff%3DZtjZ" target="_blank" title="https://agentrouter.org/register?aff=ZtjZ" ref="nofollow noopener noreferrer">agentrouter.org/register?af…</a></p>
<p>AnyRouter：<a href="https://link.juejin.cn?target=https%3A%2F%2Fanyrouter.top%2Fregister%3Faff%3DeQIH" target="_blank" title="https://anyrouter.top/register?aff=eQIH" ref="nofollow noopener noreferrer">anyrouter.top/register?af…</a></p>
</blockquote>
<h3 data-id="heading-1">工具</h3>
<p>说完模型之后接下来就是工具，上面说到智商决定了 AI Coding 的结果上限，那么<strong>工具就决定了 AI Coding 的效率和质量上限</strong>。</p>
<p>这个月主要在用的四款 AI Coding 工具，分别是 <strong>Claude Code、Codex、IFlow 和 Qoder</strong>。</p>
<p>其中：</p>
<ul>
<li>Claude Code 就是 Claude 模型它们家出的，名字也是配套的；</li>
<li>Codex 是 OpenAI 出的终端 CLI 工具，搭配 GPT5 也非常好用！</li>
<li>IFlow 是阿里心流团队推出的产品，最大的亮点就是<strong>内置的模型全是免费的</strong>！！目前支持 GLM 4.6、MiniMax M2、Qwen3-Coder 等模型；</li>
<li>Qoder 也是阿里的产品，今年 8 月面世，它还是通义灵码的原班人马打造的。好多人疑惑阿里怎么搞了这么多 AI Coding 的工具，我个人理解 IFlow 和通义灵码的受众群体是面向国内开发人员，而 Qoder 则是面向海外或者全球开发者。</li>
</ul>
<p>我先使用 Qoder 的 <strong>Quest 模式</strong>搭建了一个初版的项目架子，它是通过我提交的一份我自认为详细的 PRD，从需求详细设计、任务拆分到前后端代码搭建<strong>完全一条龙</strong>。</p>
<p>让我感到惊奇的是，这套代码竟然真的能跑起来！它可不单单是前端跑前端、后端跑后端，而是<strong>前后端接口联调都搞好了</strong>，不止如此，<strong>还搭配了 Docker 容器化</strong>。真的超出了我的预期，非常赞！</p>
<p>不过这个模式也非常吃 Credits，一套组合拳下来，我的 2000 Credits 已经告罄，犹豫了一会儿，先转战到了 Claude Code（使用 AgentRouter 和 AnyRouter 中转）。</p>
<p>Claude Code 是 CLI AI 编码模式的鼻祖，迭代到 2.x 版本之后配合 Claude 模型也是“一派宗师”的存在。更别说 MCP、SubAgent 以及 Spec Kit 这些，直接让 Claude Code 如虎添翼，在它的帮助下我很快便完善了项目上的各种细节和漏洞，各个功能也逐渐达到了预期的状态，整体逐步向可发布生产的标准推进。</p>
<p>然！天有不测风云，Claude 他们又开始大规模封号针对中国用户，导致那段时间 Claude 模型不可用，不得已之下我转而使用 Codex 搭配 GPT5 来继续推荐项目进度。</p>
<p>说实话，尽管 Codex 的热度和 Claude Code 不相上下，但在这之前我是没有使用过 Codex 的，抱着试一试的心态，我配置好了 Codex 以及 GPT5 High 开始进行小范围测试。以下是我使用 Codex 的一些感受：</p>
<ul>
<li><strong>慢</strong>！！在 Codex 中有个配置叫 <strong>model_reasoning_effort</strong>，用来<strong>配置模型的推理力度</strong>，支持 <strong>低（low）、中（medium）和高（high），前期不知情的情况下一直设置的是 High，既慢又费 token。但效果也是没得说，这种状态下的它，就像一个经验非常丰富的架构师</strong>，会给出一些非常有建设性意义的结论！</li>
<li>如果降低模型的推理力度，你会感觉虽然速度快了，但是代码产出质量实打实的下降了，完全不及 Claude。</li>
<li>改代码时直接就给你改掉了，也不问你同不同意。</li>
<li>配置项不像其他 AI CLI 那样使用 JSON 或者环境变量进行设置，而是 TOML 格式，写习惯 JSON 之后突然有些不适应，尤其是如果要配置 MCP 还需要注意转义之类的。</li>
</ul>
<p>所以后期我就搭配 Claude Code （后面服务又恢复了）和 Codex GPT5 High 一起使用，Codex 作为架构师负责出方案和设计，Claude Code 做一线研发，根据方案和设计进行产出，效果杠杠的，项目进度直接干到 98%。</p>
<p>现在就剩下一些样式优化我会用 Iflow 来做，不过需要提前进行样式定制，不然按照 AI 自己独有的品味，出来的样式可能会有一些赛博朋克。</p>
<p>iflow 这个产品，别的不说，就免费这一点，真的很值得大家去尝试一下。而且背靠大厂，在行为模式上又和 Claude Code 看齐，我实在想不出有什么理由能拒绝它，除非你的代码严格保密！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[commit 成功为什么数据只更新了部分？]]></title>    <link>https://juejin.cn/post/7572039006529601572</link>    <guid>https://juejin.cn/post/7572039006529601572</guid>    <pubDate>2025-11-13T14:57:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572039006529601572" data-draft-id="7571657746345410614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="commit 成功为什么数据只更新了部分？"/> <meta itemprop="keywords" content="后端,Java,数据库"/> <meta itemprop="datePublished" content="2025-11-13T14:57:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="提前退休的java猿"/> <meta itemprop="url" content="https://juejin.cn/user/465848660928872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            commit 成功为什么数据只更新了部分？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848660928872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    提前退休的java猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T14:57:36.000Z" title="Thu Nov 13 2025 14:57:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>我是[<a href="https://juejin.cn/user/465848660928872" title="https://juejin.cn/user/465848660928872" target="_blank">提前退休的java猿</a>]，一名7年java开发经验的开发组长，分享工作中的各种问题！（抖音、公众号同号）</p>
</blockquote>
<p>昨天在看【java深度调试技术】的时候看到数据库死锁这一章节.然后我就在思考平时写的代码 死锁的场景太多了，为什么工作了七八年从来没遇到因为死锁导致的业务阻塞问题，也从来没有解决过数据库的死锁问题。</p>
<p>今天这篇文章的主题就讲一下为什么我们很少去解决数据死锁问题，围绕这个话题我们会带出一个新的知识点：<strong>数据库在某些情况下只会回滚部分SQL</strong> 以及 我们通过在什么情况下应该去看日志，什么情况下去查询当前事务的情况。</p>
<h2 data-id="heading-1">为什么很少遇到数据库死锁</h2>
<p>业务并发低并发低这个是很少发生死锁的主要原因. 除了这个问题之外和数据库本身的死锁机制也有很大的关系.
主流的SQL数据都是有死锁检测机制大同小异罢了。所以当我们的数据库检测到死锁之后，就会回滚部分死锁事务，从不会一直阻塞我们的业务。</p>
<h3 data-id="heading-2">MySQL数据库的死锁检测机制</h3>
<p>今天就来说一下主流的SQL数据库它的死锁检测机制，当然主要还是讨论一下MySQL就行了。
mysql 的死锁检测机制或者说死锁兜底机制主要有个关键的配置:</p>
<ul>
<li>第一个是否开启死锁检测配置(默认开启)： <code>innodb_deadlock_detect = ON</code></li>
<li>第二配置等待锁超时时间(默认50s)： <code>innodb_lock_wait_timeout = 50</code></li>
</ul>
<h4 data-id="heading-3">第一步：innodb_deadlock_detect</h4>
<p>MySQL的InnoDB引擎通过 等待图（Wait-for Graph）算法来检测死锁。系统会周期性地检查是否存在事务间的循环等待链，一旦发现，就会立即触发死锁处理机制。会回滚一个或者多个死锁事务，选择回滚代价小的事务（插入、更新、删除行数小的）。</p>
<blockquote>
<p>当然这个死锁检测机制是可以通过配置关闭的，这个机制也会存在一定的性能开销，所以在极高的并发下可以考虑关闭死锁检测.<br/>
🔈 死锁检测配置（默认开启）：<code>innodb_deadlock_detect = ON</code><br/>
📒SQL官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-deadlock-detection.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.4/en/innodb-deadlock-detection.html" ref="nofollow noopener noreferrer">dev.mysql.com/doc/refman/…</a></p>
</blockquote>
<h5 data-id="heading-4">测试（mysql8.0）</h5>
<pre><code class="hljs language-js" lang="js">-----------------------事务<span class="hljs-number">1</span>------------------------------
<span class="hljs-comment">// 第一步：会话 01 ，关闭自动提交事务，更新 navigation</span>
set autocommit = <span class="hljs-number">0</span>;
<span class="hljs-variable constant_">UPDATE</span> navigation <span class="hljs-variable constant_">SET</span> name = <span class="hljs-string">'txt01'</span>;

<span class="hljs-comment">//第三步：更新 navigation_relation_station，一直等待锁</span>
<span class="hljs-variable constant_">UPDATE</span> navigation_relation_station <span class="hljs-variable constant_">SET</span> navigation_id = <span class="hljs-number">101</span>;

---------------------事务<span class="hljs-number">2</span>--------------------------------
<span class="hljs-comment">//第二步：会话 02，关闭自动提交事务，更新 navigation_relation_station</span>
set autocommit = <span class="hljs-number">0</span>;
<span class="hljs-variable constant_">UPDATE</span> navigation_relation_station <span class="hljs-variable constant_">SET</span> navigation_id = <span class="hljs-number">2</span>;
<span class="hljs-comment">// 第四步： 更新 navigation ，形成死锁</span>

<span class="hljs-variable constant_">UPDATE</span> navigation <span class="hljs-variable constant_">SET</span> name = <span class="hljs-string">'txt02'</span>;
</code></pre>
<p>当执行第四步时就会形成死锁，事务1报错回滚，错误信息如下：</p>
<pre><code class="hljs language-text" lang="text">UPDATE navigation_relation_station SET navigation_id = 101
1213 - Deadlock found when trying to get lock; try restarting transaction
查询时间: 5.445s
</code></pre>
<h4 data-id="heading-5">第二步：innodb_lock_wait_timeout</h4>
<p>这个配置算是一个等待锁的一个兜底机制，不管是<strong>发生死锁（死锁探测机制关闭）</strong>，还是因为<strong>锁被其他事务长时间占用</strong> 导致的锁等待超时，这个配置就显得非常重要了。默认50s,根据实际场景调整。 如果超过这个这个配置的设置时间了会发生么？</p>
<p>✅默认会回滚等待超时事务中获取锁的那条SQL，没错不是回滚整个事务. 当然这只是MySQL的默认策略，这个回滚策略也是可以通过配置控制的。可通过配置（默认关闭，回滚等待锁的SQL）让其回滚整个事务：<code>innodb_rollback_on_timeout = OFF</code></p>
<h5 data-id="heading-6">测试（MySQL8.0）</h5>
<p>💦本次测试当事务在等待锁超时的情况的下，数据库是只回滚部分SQL。并且会话保持，出错之后继续commit，看看能否执行成功，成功的部分是否为事务中未回滚的前半部分语句。</p>
<p>mysql 数据如下，ID为主键索引（避免锁范围扩大）</p>

















<table><thead><tr><th>id</th><th>realname</th></tr></thead><tbody><tr><td>1</td><td>零零一</td></tr><tr><td>2</td><td>零零二</td></tr></tbody></table>
<p>做一下测试，模拟等待锁超时的情况：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//第一步,事务1，抢占 ID 为1的行锁，不提交事务</span>
set autocommit = <span class="hljs-number">0</span>;
update t_user set realname = <span class="hljs-string">"事务1"</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">"1"</span>;

<span class="hljs-comment">// 第二步，事务2，先更新ID为2的数据，再更新ID= 1的数据（等待锁）</span>
set autocommit = <span class="hljs-number">0</span>;
update t_user set realname = <span class="hljs-string">"事务2-2"</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">"2"</span>;
update t_user  set realname = <span class="hljs-string">"事务2-1"</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">"1"</span>;
commit;
</code></pre>
<p>第二步的事务等待锁超时，输出结果如下：</p>
<pre><code class="hljs language-js" lang="js">update t_user set realname = <span class="hljs-string">"事务2-2"</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">"2"</span>
&gt; <span class="hljs-title class_">Affected</span> <span class="hljs-attr">rows</span>: <span class="hljs-number">1</span>
&gt; 查询时间: 0s

update t_user  set realname = <span class="hljs-string">"事务2-1"</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">"1"</span>
&gt; <span class="hljs-number">1205</span> - <span class="hljs-title class_">Lock</span> wait timeout exceeded; <span class="hljs-keyword">try</span> restarting transaction
&gt; 查询时间: <span class="hljs-number">51.</span>353s
</code></pre>
<p>再次commit第二的事务，发现能提交成功，刷新列表，发现只有事务中的第一条SQL执行成功了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3a8c83d826e4fd09b92b8744f4cca7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763650656&amp;x-signature=%2F%2BL1LRJpbcMiPsDtFCbYbTyU%2FKM%3D" alt="image.png" loading="lazy"/>
✅<strong>测试结论</strong>：当事务因为等待锁超时（没有开启回滚整个事务），数据会报错，并且事务会回滚等待锁的SQL语句。此时会话依然保持，可以继续commit，事务等待锁之前的SQL将会被重新提交。</p>
<h3 data-id="heading-7">如何解决死锁问题</h3>
<p><del>官网和博客好多说使用<strong>SHOW ENGINE INNODB STATUS</strong>，这个命令能执行成功，但是我从来没有看到过任何信息（不知道怎么回事儿，模拟发生过死锁）。</del></p>
<h4 data-id="heading-8">看死锁日志</h4>
<p><strong>日志准备</strong>：MySQL8.0 windows 环境中，配置文件需要指定error日志输出文件，以及开启死锁日志记录。</p>
<pre><code class="hljs language-js" lang="js"># my.<span class="hljs-property">ini</span> 文件配置
[mysqld]
innodb_print_all_deadlocks = <span class="hljs-number">1</span>
log_error = <span class="hljs-regexp">/var/</span>log/mysql/error.<span class="hljs-property">log</span>
</code></pre>
<p>📟同时还要确保我们的死锁检测配置时开启的，不然也看不到死锁日志</p>
<p>模拟死锁SQL：</p>
<pre><code class="hljs language-js" lang="js">------------------- 事务<span class="hljs-number">49421</span>-----------------------
第一步
set autocommit = <span class="hljs-number">0</span> ;
<span class="hljs-variable constant_">UPDATE</span> t_user <span class="hljs-variable constant_">SET</span> realname = <span class="hljs-string">'tx01-1'</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">'101'</span>;
第三步
<span class="hljs-variable constant_">UPDATE</span> t_user <span class="hljs-variable constant_">SET</span> realname = <span class="hljs-string">'tx02-1'</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">'102'</span>;
<span class="hljs-variable constant_">COMMIT</span>

-----------------事务<span class="hljs-number">49422</span>--------------------------
第二步
set autocommit = <span class="hljs-number">0</span> ;
<span class="hljs-variable constant_">UPDATE</span> t_user <span class="hljs-variable constant_">SET</span> realname = <span class="hljs-string">'tx122222-1'</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">'102'</span>;
第四步
<span class="hljs-variable constant_">UPDATE</span> t_user <span class="hljs-variable constant_">SET</span> realname = <span class="hljs-string">'tx1111-1'</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">'101'</span>;
<span class="hljs-variable constant_">COMMIT</span>;
</code></pre>
<p>死锁日志如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">TRANSACTION</span> <span class="hljs-number">49421</span>, <span class="hljs-variable constant_">ACTIVE</span> <span class="hljs-number">12</span> sec starting index read
mysql tables <span class="hljs-keyword">in</span> use <span class="hljs-number">1</span>, locked <span class="hljs-number">1</span>
<span class="hljs-variable constant_">LOCK</span> <span class="hljs-variable constant_">WAIT</span> <span class="hljs-number">3</span> lock <span class="hljs-title function_">struct</span>(s), heap size <span class="hljs-number">1136</span>, <span class="hljs-number">2</span> row <span class="hljs-title function_">lock</span>(s), undo log entries <span class="hljs-number">1</span>
<span class="hljs-title class_">MySQL</span> thread id <span class="hljs-number">8</span>, <span class="hljs-variable constant_">OS</span> thread handle <span class="hljs-number">31912</span>, query id <span class="hljs-number">130</span> localhost ::<span class="hljs-number">1</span> root updating
<span class="hljs-variable constant_">UPDATE</span> t_user <span class="hljs-variable constant_">SET</span> realname = <span class="hljs-string">'tx02-1'</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">'102'</span>
<span class="hljs-variable constant_">RECORD</span> <span class="hljs-variable constant_">LOCKS</span> space id <span class="hljs-number">10</span> page no <span class="hljs-number">17899</span> n bits <span class="hljs-number">216</span> index <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-keyword">of</span> table <span class="hljs-string">`test`</span>.<span class="hljs-string">`t_user`</span> trx id <span class="hljs-number">49421</span> lock_mode X locks rec but not gap waiting （等待锁 <span class="hljs-number">102</span>）
<span class="hljs-title class_">Record</span> lock, heap no <span class="hljs-number">150</span> <span class="hljs-variable constant_">PHYSICAL</span> <span class="hljs-attr">RECORD</span>: n_fields <span class="hljs-number">6</span>; compact format; info bits <span class="hljs-number">0</span>
 <span class="hljs-number">0</span>: len <span class="hljs-number">3</span>; hex <span class="hljs-number">313032</span>; asc <span class="hljs-number">102</span>;;
 <span class="hljs-number">1</span>: len <span class="hljs-number">6</span>; hex 00000000c10e; asc       ;;
 <span class="hljs-number">2</span>: len <span class="hljs-number">7</span>; hex 02000001540b3b; asc     T ;;;
 <span class="hljs-number">3</span>: len <span class="hljs-number">13</span>; hex <span class="hljs-number">31303231323334333238623363</span>; asc 1021234328b3c;;
 <span class="hljs-number">4</span>: len <span class="hljs-number">10</span>; hex 74783132323232322d31; asc tx122222-<span class="hljs-number">1</span>;;
 <span class="hljs-number">5</span>: len <span class="hljs-number">3</span>; hex <span class="hljs-number">386266</span>; asc 8bf;;

<span class="hljs-variable constant_">TRANSACTION</span> <span class="hljs-number">49422</span>, <span class="hljs-variable constant_">ACTIVE</span> <span class="hljs-number">8</span> sec starting index read, thread declared inside <span class="hljs-title class_">InnoDB</span> <span class="hljs-number">5000</span>
mysql tables <span class="hljs-keyword">in</span> use <span class="hljs-number">1</span>, locked <span class="hljs-number">1</span>
<span class="hljs-number">3</span> lock <span class="hljs-title function_">struct</span>(s), heap size <span class="hljs-number">1136</span>, <span class="hljs-number">2</span> row <span class="hljs-title function_">lock</span>(s), undo log entries <span class="hljs-number">1</span>
<span class="hljs-title class_">MySQL</span> thread id <span class="hljs-number">9</span>, <span class="hljs-variable constant_">OS</span> thread handle <span class="hljs-number">28276</span>, query id <span class="hljs-number">134</span> localhost ::<span class="hljs-number">1</span> root updating
<span class="hljs-variable constant_">UPDATE</span> t_user <span class="hljs-variable constant_">SET</span> realname = <span class="hljs-string">'tx1111-1'</span> <span class="hljs-variable constant_">WHERE</span> id = <span class="hljs-string">'101'</span>
<span class="hljs-variable constant_">RECORD</span> <span class="hljs-variable constant_">LOCKS</span> space id <span class="hljs-number">10</span> page no <span class="hljs-number">17899</span> n bits <span class="hljs-number">216</span> index <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-keyword">of</span> table <span class="hljs-string">`test`</span>.<span class="hljs-string">`t_user`</span> trx id 
<span class="hljs-number">49422</span> lock_mode X locks rec but not gap （持有锁<span class="hljs-number">102</span>）
<span class="hljs-title class_">Record</span> lock, heap no <span class="hljs-number">150</span> <span class="hljs-variable constant_">PHYSICAL</span> <span class="hljs-attr">RECORD</span>: n_fields <span class="hljs-number">6</span>; compact format; info bits <span class="hljs-number">0</span>
 <span class="hljs-number">0</span>: len <span class="hljs-number">3</span>; hex <span class="hljs-number">313032</span>; asc <span class="hljs-number">102</span>;;
 <span class="hljs-number">1</span>: len <span class="hljs-number">6</span>; hex 00000000c10e; asc       ;;
 <span class="hljs-number">2</span>: len <span class="hljs-number">7</span>; hex 02000001540b3b; asc     T ;;;
 <span class="hljs-number">3</span>: len <span class="hljs-number">13</span>; hex <span class="hljs-number">31303231323334333238623363</span>; asc 1021234328b3c;;
 <span class="hljs-number">4</span>: len <span class="hljs-number">10</span>; hex 74783132323232322d31; asc tx122222-<span class="hljs-number">1</span>;;
 <span class="hljs-number">5</span>: len <span class="hljs-number">3</span>; hex <span class="hljs-number">386266</span>; asc 8bf;;

<span class="hljs-variable constant_">RECORD</span> <span class="hljs-variable constant_">LOCKS</span> space id <span class="hljs-number">10</span> page no <span class="hljs-number">17899</span> n bits <span class="hljs-number">216</span> index <span class="hljs-variable constant_">PRIMARY</span> 
<span class="hljs-keyword">of</span> table <span class="hljs-string">`test`</span>.<span class="hljs-string">`t_user`</span> trx id <span class="hljs-number">49422</span> lock_mode X locks rec but not gap waiting（等待锁<span class="hljs-number">101</span>）

<span class="hljs-title class_">Record</span> lock, heap no <span class="hljs-number">149</span> <span class="hljs-variable constant_">PHYSICAL</span> <span class="hljs-attr">RECORD</span>: n_fields <span class="hljs-number">6</span>; compact format; info bits <span class="hljs-number">0</span>
 <span class="hljs-number">0</span>: len <span class="hljs-number">3</span>; hex <span class="hljs-number">313031</span>; asc <span class="hljs-number">101</span>;;
 <span class="hljs-number">1</span>: len <span class="hljs-number">6</span>; hex 00000000c10d; asc       ;;
 <span class="hljs-number">2</span>: len <span class="hljs-number">7</span>; hex 01000001010c84; asc        ;;
 <span class="hljs-number">3</span>: len <span class="hljs-number">13</span>; hex <span class="hljs-number">31303131323334333238623363</span>; asc 1011234328b3c;;
 <span class="hljs-number">4</span>: len <span class="hljs-number">6</span>; hex 747830312d31; asc tx01-<span class="hljs-number">1</span>;;
 <span class="hljs-number">5</span>: len <span class="hljs-number">3</span>; hex <span class="hljs-number">386266</span>; asc 8bf;;

</code></pre>
<p>🔱不会分析丢给AI就行了。 从上面的信息能看到具体的代码阻塞到的是哪行，这样自己再去定位代码其实也比较简单了。</p>
<h4 data-id="heading-9">查询事务表信息</h4>
<p>因为我们mysql 自带的死锁检测机制会自动回滚 其中代价小的事务，所以因为死锁导致阻塞的事务就很难通过
查询运行中事务的状态来定位了。</p>
<p>当然如果是系统并发非常高，并且死锁检测机制被关闭，或者说用来查询长事务，可以去通过查看下面的信息来定位问题。</p>
<p>下面这些操作需要数据开启性能模式，默认开启：<code>performance_schema = ON</code></p>
<ul>
<li>MySQL 8.0 及以上版本：使用 <code>performance_schema.data_locks</code> 和 <code>performance_schema.data_lock_waits</code> 查看锁信息，配合 <code>INNODB_TRX</code> 查看事务详情。</li>
<li>MySQL 5.7 及以下版本：仍可使用 <code>INNODB_LOCKS</code>、<code>INNODB_LOCK_WAITS</code>、<code>INNODB_TRX</code> 这三个表。</li>
</ul>
<p>✅推荐使用：<code>performance_schema.INNODB_TRX</code> 和 <code>performance_schema.data_locks</code> 表就行了；</p>
<p><strong>data_locks</strong>：表关键信息事务ID，事务获取锁数据（比如主键值）、等待锁数据，所以这个是很方便定位到死锁的，定位到死锁的事务ID，然后再去<code>INNODB_TRX</code>回查，就能定位到指定的SQL</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a52d3e43baad4bceb7d1b9b270e423e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763650656&amp;x-signature=zMYv1gKqysNY7C3od13GOwKjqIc%3D" alt="image.png" loading="lazy"/></p>
<p><strong>INNODB_TRX</strong> :表关键信息有事务ID，事务状态，等待执行的SQL。</p>
<p>事务状态字段： trx_state (事务状态，如果在等待锁就会显示：LOCK_WAIT)；
事务ID：trx_id；事务等待执行SQL：trx_query  ，事务的开始时间等（💢用来定位挂起的事务就非常方便了）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83063b31e96b43c0aeeb8a80ce3dc2df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o-Q5YmN6YCA5LyR55qEamF2YeeMvw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763650656&amp;x-signature=98uxJG7u3c%2Fe2gkUUovhQ7pzkK8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">死锁的预防</h4>
<p>🔊这个就很简单了，首先就是保持更新表的顺序，比如各业务操作更新多表的时候，可以按照先更新主表再更新副表的顺序，或者直接按照 表名的 字符串排序更新。第二就是减少事务占用的时间 减少锁占用的时间，合理使用索引减少锁的范围，</p>
<h4 data-id="heading-11">监控死锁的第三方工具</h4>
<p>上面都是基于MySQL 自带日志和事务表来分析的。下面介绍一下一些三方工具吧。
当然现在很多企业都使用大厂的云服务器，基本都自带数据库监控工具。</p>
<h5 data-id="heading-12">1. Percona Toolkit（PT 工具集）</h5>
<ul>
<li><strong>作用</strong>：<code>pt-deadlock-logger</code>专门用于监控和记录 MySQL 死锁信息，可实时抓取死锁日志并输出到文件或数据库，支持定时运行和历史分析。</li>
<li><strong>用法示例</strong>：<code>pt-deadlock-logger --user=root --password=xxx localhost</code>会持续监控并打印新发生的死锁，也可指定输出到文件：<code>--dest file:/var/log/mysql/deadlocks.log</code></li>
</ul>
<h5 data-id="heading-13">2. MySQL Workbench</h5>
<ul>
<li><strong>作用</strong>：MySQL 官方图形化工具，内置 “Performance” 模块，可直观查看当前事务、锁等待、死锁历史等信息（需连接数据库后在 “Data Export” 或 “Performance Schema” 面板中操作）。</li>
<li><strong>优势</strong>：可视化展示锁等待关系，适合新手快速定位问题。</li>
</ul>
<h5 data-id="heading-14">3. Orchestrator</h5>
<ul>
<li><strong>作用</strong>：一款开源的 MySQL 高可用管理工具，除了主从切换，还能监控数据库锁状态、死锁事件，并提供告警功能。</li>
<li><strong>适用场景</strong>：分布式 MySQL 集群环境，需结合监控平台使用。</li>
</ul>
<h5 data-id="heading-15">4. 监控平台集成（Prometheus + Grafana）</h5>
<ul>
<li><strong>原理</strong>：通过 <code>mysqld_exporter</code> 采集 MySQL 锁相关指标（如 <code>innodb_deadlocks</code> 计数器），在 Grafana 中配置仪表盘，实时监控死锁发生频率，并设置告警（如死锁数突增时触发邮件 / 短信告警）。</li>
<li><strong>关键指标</strong>：<code>innodb_deadlocks</code>（累计死锁次数）、<code>innodb_lock_waits</code>（锁等待次数）等。</li>
</ul>
<h2 data-id="heading-16">MySQL什么场景下数据库会回滚部分SQL</h2>
<p>上文说了等待锁超时，默认情况下会回滚等待锁的SQL。除了这种情况还存在其他情况也有这个问题。比如：</p>
<p>📃官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://dev.mysql.com/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer">dev.mysql.com/doc/refman/…</a></p>








































<table><thead><tr><th>错误类型</th><th>InnoDB 的处理方式</th><th>简要说明与案例</th></tr></thead><tbody><tr><td><strong>表空间满</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td><td>回滚<strong>SQL语句</strong></td><td>例如，批量插入大量数据时，如果<code>ibdata</code>文件或独立表空间达到上限</td></tr><tr><td><strong>事务死锁</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td><td>回滚<strong>整个事务</strong></td><td>例如，事务A持有行1锁等待行2，事务B持有行2锁等待行1。InnoDB会选择回滚其中一个事务（让另一个成功）。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td></tr><tr><td><strong>锁等待超时</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td><td>默认回滚<strong>当前语句</strong></td><td>例如，一条更新语句等待锁超过<code>innodb_lock_wait_timeout</code>设置，该语句被回滚。启用<code>innodb_rollback_on_timeout</code>会回滚整个事务。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td></tr><tr><td><strong>重复键错误</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td><td>回滚<strong>单行操作</strong></td><td>例如，<code>INSERT</code>多条数据，其中某条违反唯一键约束，仅该行插入失败。</td></tr><tr><td><strong>行过长错误</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td><td>回滚<strong>SQL语句</strong></td><td>例如，尝试插入一个<code>VARCHAR</code>字段长度超过列定义的数据</td></tr><tr><td><strong>其他多数错误</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td><td>回滚<strong>SQL语句</strong></td><td>通常由MySQL上层代码检测到，如语法错误等，会回滚对应的SQL语句。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmysqldev.dev.org.tw%2Fdoc%2Frefman%2F8.4%2Fen%2Finnodb-error-handling.html" target="_blank" title="https://mysqldev.dev.org.tw/doc/refman/8.4/en/innodb-error-handling.html" ref="nofollow noopener noreferrer"/></td></tr></tbody></table>
<p>📢 博主测试过 锁等待超时，和 重复键插入，报错之后，继续commit ，报错行之后的SQL不会再被执行，只会提交回滚行之前的SQL。</p>
<h2 data-id="heading-17">总结</h2>
<p>从为什么很少遇到死锁的原因，到死锁相关的配置，到死锁的解决思路，再到哪些场景数据库在回滚的时候会回滚当前阻塞的SQL。写这篇文章确实比较耗费心力，因为博主也做了很多测试。希望各位兄弟姐妹点个赞 收藏吧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI会聊天了？GPT-5.1双核驱动情商大升级！]]></title>    <link>https://juejin.cn/post/7571808096937639977</link>    <guid>https://juejin.cn/post/7571808096937639977</guid>    <pubDate>2025-11-13T13:17:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096937639977" data-draft-id="7571972751529033764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI会聊天了？GPT-5.1双核驱动情商大升级！"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-13T13:17:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI会聊天了？GPT-5.1双核驱动情商大升级！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T13:17:33.000Z" title="Thu Nov 13 2025 13:17:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>嘿，各位AI圈的朋友们，又到了我们激动人心的时刻！OpenAI在2025年11月13日这个普通的日子，扔下了一颗不普通的“重磅炸弹”——GPT-5.1系列模型正式登场。别以为又是些冷冰冰的跑分数据升级，这次，OpenAI玩真的了，他们把焦点从单纯的“智商”竞赛，转向了如何让AI变得“更有人情味”、“更懂你”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-13_21.09.49-1024x535.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-13_21.09.49-1024x535.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc17515f2b2f406c8032e196e15d0adb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763644653&amp;x-signature=GWcSV2lQWfbc9o9FoHOY6tgzOUk%3D" alt="iShot_2025-11-13_21.09.49" loading="lazy"/></a></p>
<p>这次升级的核心，是推出了GPT-5.1家族的两位新成员：<strong>GPT-5.1 Instant（即时版）</strong> 和 <strong>GPT-5.1 Thinking（思考版）</strong>。Instant，顾名思义，就是你日常的“快节奏伙伴”，它更温暖、更听话，甚至带点小顽皮，适合快速对话和信息获取。而Thinking版本，则是你解决复杂问题的“解题专家”，它会像人类一样，在面对难题时花点时间“思考”，给出更深入、更易懂的答案，尤其在数学和编程等硬核领域表现亮眼。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-13_21.09.19-1024x599.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-13_21.09.19-1024x599.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e1884fe6de74845b905f52785b1cb8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763644653&amp;x-signature=F1ydpNfS7wDeiNKvvqDnUtOC1Os%3D" alt="iShot_2025-11-13_21.09.19" loading="lazy"/></a></p>
<p>最让我拍案叫绝的，是它引入的“<strong>自适应推理</strong>”能力。想象一下，AI不再是那个只会按部就班的“书呆子”，它学会了“看脸色”行事，能根据你的问题难度，自己决定要“想多久”。简单问题秒回，复杂问题则会“沉思”片刻，给出更深思熟虑的答案。这种智能分配思考资源的模式，无疑让AI的交互体验变得更自然、更像真人了。</p>
<p>但更厉害的还在后面！OpenAI这次可真是把“私人定制”玩明白了。除了那些耳熟能详的默认、友好、高效模式，他们还大手笔地加入了什么“<strong>专业（Professional）</strong>”、“<strong>坦诚（Candid）</strong>”、甚至“<strong>古灵精怪（Quirky）</strong>”的风格！这意味着你可以根据不同场景，随时切换你的ChatGPT“人格”。更绝的是，他们还在实验精细化控制功能，让你能通过滑块微调AI的<strong>简洁度、热情度、易读性，甚至是表情符号的使用频率</strong>。我的天，这不就是打造你的专属AI灵魂伴侣吗？而且，如果你在对话中展现出特定偏好，ChatGPT还会主动询问是否保存——真正做到了“无感”个性化。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-13_21.09.28-965x1024.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-13_21.09.28-965x1024.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/177ba736ca1d4366aee701b9bd92b423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763644653&amp;x-signature=nTxfzokOsHw2grBgHR4cs5NW7R4%3D" alt="iShot_2025-11-13_21.09.28" loading="lazy"/></a></p>
<p>值得一提的是，OpenAI在安全考量上也迈出了更人性化的一步。他们首次将“<strong>心理健康（Mental Health）</strong>”和“<strong>情感依赖（Emotional Reliance）</strong>”纳入评估维度——这可不是小事，它意味着AI不光要聪明，还得“懂人心”，要学会如何以健康的方式陪伴我们，而不是助长不健康的情感依赖。</p>
<p>当然，新模型发布总是让人期待又忐忑。目前，这次更新正在逐步推送，付费用户将优先体验，免费用户也无需着急，后续很快会跟上。而且，OpenAI还贴心地准备了“后悔药”：付费用户在三个月内可以随时切换回旧的GPT-5模型。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-13_21.09.40-1024x645.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-13_21.09.40-1024x645.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e9e339570a04ed2baf8fdaa1f4666fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763644653&amp;x-signature=SiHxD0ZLU5KaQOc3O2xbXPNvu3E%3D" alt="iShot_2025-11-13_21.09.40" loading="lazy"/></a></p>
<p>所以，朋友们，GPT-5.1的发布，远不止是数字上的堆叠，更像是宣告了AI未来将成为我们身边“更懂你、更有温度”的伙伴。用OpenAI应用CEO Fidji Simo的话说，这次升级的核心，是将**智商（IQ）与情商（EQ）**更好地结合起来。这不就是我们一直期待的，那个既聪明又善解人意的AI吗？未来已来，我们拭目以待。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Nginx核心技术》第11章：实现MySQL数据库的负载均衡]]></title>    <link>https://juejin.cn/post/7572028313930285096</link>    <guid>https://juejin.cn/post/7572028313930285096</guid>    <pubDate>2025-11-13T13:19:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572028313930285096" data-draft-id="7572020278387195938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 《Nginx核心技术》第11章：实现MySQL数据库的负载均衡"/> <meta itemprop="keywords" content="后端,架构,Nginx"/> <meta itemprop="datePublished" content="2025-11-13T13:19:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冰_河"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942303527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             《Nginx核心技术》第11章：实现MySQL数据库的负载均衡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942303527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冰_河
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T13:19:04.000Z" title="Thu Nov 13 2025 13:19:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：冰河
<br/>星球：<a href="https://link.juejin.cn?target=http%3A%2F%2Fm6z.cn%2F6aeFbs" target="_blank" title="http://m6z.cn/6aeFbs" ref="nofollow noopener noreferrer">m6z.cn/6aeFbs</a>
<br/>博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbinghe.gitcode.host" target="_blank" title="https://binghe.gitcode.host" ref="nofollow noopener noreferrer">binghe.gitcode.host</a>
<br/>文章汇总：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbinghe.gitcode.host%2Fmd%2Fall%2Fall.html" target="_blank" title="https://binghe.gitcode.host/md/all/all.html" ref="nofollow noopener noreferrer">binghe.gitcode.host/md/all/all.…</a>
<br/>星球项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbinghe.gitcode.host%2Fmd%2Fzsxq%2Fintroduce.html" target="_blank" title="https://binghe.gitcode.host/md/zsxq/introduce.html" ref="nofollow noopener noreferrer">binghe.gitcode.host/md/zsxq/int…</a></p>
<blockquote>
<p>沉淀，成长，突破，帮助他人，成就自我。</p>
</blockquote>
<ul>
<li>本章难度：★★☆☆☆</li>
<li>本章重点：用最简短的篇幅介绍Nginx最核心的知识，掌握Nginx实现MySQL数据库的负载均衡，并能够灵活运用到实际项目中，维护高可用系统。</li>
</ul>
<p><strong>大家好，我是冰河~~</strong></p>
<p>今天给大家介绍《Nginx核心技术》的第11章：实现MySQL数据库的负载均衡，多一句没有，少一句不行，用最简短的篇幅讲述Nginx最核心的知识，好了，开始今天的内容。</p>
<h2 data-id="heading-0">11.1 本章概述</h2>
<p>Nginx能够实现HTTP、HTTPS协议的负载均衡，也能够实现TCP协议的负载均衡。那么，问题来了，可不可以通过Nginx实现MySQL数据库的负载均衡呢？答案是：可以。接下来，就让我们一起探讨下如何使用Nginx实现MySQL的负载均衡。</p>
<h2 data-id="heading-1">11.2 前提条件</h2>
<p><strong>注意：使用Nginx实现MySQL数据库的负载均衡，前提是要搭建MySQL的主主复制环境，关于MySQL主主复制环境的搭建，后续会在MySQL专题为大家详细阐述。这里，我们假设已经搭建好MySQL的主主复制环境，MySQL服务器的IP和端口分别如下所示。</strong></p>
<ul>
<li>192.168.1.101    3306</li>
<li>192.168.1.102    3306</li>
</ul>
<p>通过Nginx访问MySQL的IP和端口如下所示。</p>
<ul>
<li>192.168.1.100    3306</li>
</ul>
<h2 data-id="heading-2">11.3 Nginx实现MySQL负载均衡</h2>
<p>nginx在版本1.9.0以后支持tcp的负载均衡，具体可以参照官网关于模块<a href="https://link.juejin.cn?target=http%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fstream%2Fngx_stream_core_module.html%23tcp_nodelay" target="_blank" title="http://nginx.org/en/docs/stream/ngx_stream_core_module.html#tcp_nodelay" ref="nofollow noopener noreferrer">ngx_stream_core_module</a>的叙述，链接地址为：<a href="https://link.juejin.cn?target=http%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fstream%2Fngx_stream_core_module.html%23tcp_nodelay%25E3%2580%2582" target="_blank" title="http://nginx.org/en/docs/stream/ngx_stream_core_module.html#tcp_nodelay%E3%80%82" ref="nofollow noopener noreferrer">nginx.org/en/docs/str…</a></p>
<p>nginx从1.9.0后引入模块ngx_stream_core_module，模块是没有编译的，需要用到编译，编译时需添加--with-stream配置参数，stream负载均衡官方配置样例如下所示。</p>
<pre><code class="hljs language-bash" lang="bash">worker_processes auto;
error_log /var/log/nginx/error.log info;

events {
    worker_connections  1024;
}

stream {
    upstream backend {
        <span class="hljs-built_in">hash</span> <span class="hljs-variable">$remote_addr</span> consistent;

        server backend1.example.com:12345 weight=5;
        server 127.0.0.1:12345            max_fails=3 fail_timeout=30s;
        server unix:/tmp/backend3;
    }

    upstream dns {
       server 192.168.0.1:53535;
       server dns.example.com:53;
    }

    server {
        listen 12345;
        proxy_connect_timeout 1s;
        proxy_timeout 3s;
        proxy_pass backend;
    }

    server {
        listen 127.0.0.1:53 udp;
        proxy_responses 1;
        proxy_timeout 20s;
        proxy_pass dns;
    }
    
    server {
        listen [::1]:12345;
        proxy_pass unix:/tmp/stream.socket;
    }
}
</code></pre>
<p>说到这里，使用Nginx实现MySQL的负载均衡就比较简单了。我们可以参照上面官方的配置示例来配置MySQL的负载均衡。这里，我们可以将Nginx配置成如下所示。</p>
<pre><code class="hljs language-bash" lang="bash">user  nginx;
<span class="hljs-comment">#user root;</span>
worker_processes  1;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
events {
    worker_connections  1024;
}
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format  main  <span class="hljs-string">'$remote_addr - $remote_user [$time_local] "$request" '</span>
                      <span class="hljs-string">'$status $body_bytes_sent "$http_referer" '</span>
                      <span class="hljs-string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;
    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    <span class="hljs-comment">#tcp_nopush     on;</span>
    keepalive_timeout  65;
    <span class="hljs-comment">#gzip  on;</span>
    include /etc/nginx/conf.d/*.conf;
}

stream{
	upstream mysql{
		server 192.168.1.101:3306 weight=1;
		server 192.168.1.102:3306 weight=1;
	}
        
	server{
		listen 3306;
		server_name 192.168.1.100;
		proxy_pass mysql;
	}
}
</code></pre>
<p>配置完成后，我们就可以通过如下方式来访问MySQL数据库。</p>
<pre><code class="hljs language-bash" lang="bash">jdbc:mysql://192.168.1.100:3306/数据库名称
</code></pre>
<p>此时，Nginx会将访问MySQL的请求路由到IP地址为192.168.1.101和192.168.1.102的MySQL上。</p>
<p><strong>好了，相信各位小伙伴们对Nginx如何实现MySQL数据库的负载均衡，有了进一步的了解，我是冰河，我们下期见~~</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀深度实测！GPT-5.1 vs Claude Sonnet 4.5！谁是赢家？从万字长文到古诗词创作，从3D游戏编程到浏览器自动化，结果竟然出人意料！Cla]]></title>    <link>https://juejin.cn/post/7571972751529050148</link>    <guid>https://juejin.cn/post/7571972751529050148</guid>    <pubDate>2025-11-13T13:26:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571972751529050148" data-draft-id="7572021695294652466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀深度实测！GPT-5.1 vs Claude Sonnet 4.5！谁是赢家？从万字长文到古诗词创作，从3D游戏编程到浏览器自动化，结果竟然出人意料！Cla"/> <meta itemprop="keywords" content="AIGC,OpenAI,ChatGPT"/> <meta itemprop="datePublished" content="2025-11-13T13:26:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀深度实测！GPT-5.1 vs Claude Sonnet 4.5！谁是赢家？从万字长文到古诗词创作，从3D游戏编程到浏览器自动化，结果竟然出人意料！Cla
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T13:26:41.000Z" title="Thu Nov 13 2025 13:26:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">GPT-5.1实测：有进步，但没你想的那么强</h2>
<p><strong>昨天凌晨，OpenAI发布了GPT-5.1。我花了一整天时间深度测试，结果可能和你预期的不太一样。</strong></p>
<p>🔥🔥🔥本篇笔记所对应的视频：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RJCbB5EcC%2F" target="_blank" title="https://www.bilibili.com/video/BV1RJCbB5EcC/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1RJ…</a></p>
<p>先说结论：GPT-5.1确实比三个月前的GPT-5有进步，但如果你期待的是碾压级的提升，可能要失望了。更直白点说，在很多实际任务中，它依然不如Claude Sonnet 4.5。</p>
<p>这不是黑，是实测数据。我做了横向对比测试，包括长文本生成、文学创作、前端开发等多个场景，有些结果出乎意料。</p>
<h3 data-id="heading-1">先说说GPT-5.1改了啥</h3>
<p>OpenAI这次主打"务实"路线。三个月前GPT-5发布时翻车了——很多用户反映新模型还不如老的好用，数学题算错，代码写得不靠谱。OpenAI当时解释说是"路由系统"的锅，就是AI不知道该用哪个版本来回答你。</p>
<p>GPT-5.1的改进主要集中在三个方面：</p>
<p><strong>第一，双模式系统。</strong> Instant模式速度快，适合日常对话；Thinking模式专攻难题，会根据问题复杂度动态调整思考时间。听起来很美好，实测下来确实比GPT-5更灵活。</p>
<p><strong>第二，减少"胡编乱造"。</strong> 官方数据说幻觉率从4.8%降到2.1%，这个改进挺实在的。测试中遇到不确定的问题，它确实更愿意承认"我不知道"，而不是硬着头皮瞎编。</p>
<p><strong>第三，个性化定制。</strong> 现在可以选8种不同的对话风格，从专业严肃到有趣轻松都有。这个功能挺有用，不同场景可以切换不同风格。</p>
<h3 data-id="heading-2">实测数据说话：长文本生成完败</h3>
<p>我的第一个测试是让两个AI生成万字学习报告。给了同样的开源项目仓库链接，要求深度分析。</p>
<p>结果？</p>
<p><strong>GPT-5.1：</strong> 总字符3.1万，中文约6900字 <strong>Claude Sonnet 4.5：</strong> 总字符5.1万，中文约1.2万字</p>
<p>Claude直接多写了近一倍。这不是个例，在多轮测试中，GPT-5.1的长文本输出能力始终比较"克制"。如果你需要生成长篇报告、详细分析，Claude确实更给力。</p>
<p>有意思的是第二轮测试。我让它们写一篇1000字左右的公众号文章介绍这个项目。</p>
<p><strong>GPT-5.1：</strong> 写了1600多字，技术细节很详实，但风格偏硬核，适合开发者看 <strong>Claude Sonnet 4.5：</strong> 写了1400多字，更接近1000字的要求，通俗易懂，小白也能看懂</p>
<p>拿这两篇文章给Gemini 2.5 Pro评判，它的结论是：GPT-5.1写的是技术文档，Claude写的是科普文。各有千秋，但Claude在字数控制和受众定位上更精准。</p>
<h3 data-id="heading-3">文学创作：差距明显</h3>
<p>这个测试让我挺意外的。我让两个AI按照"望海潮"这个词牌名写一首宋词，主题是"秋去冬来，慨叹时光流逝"，要求严格遵循格律。</p>
<p><strong>Claude Sonnet 4.5</strong> 50秒就写出来了：</p>
<p>"霜染层林，风吹落叶，西窗又见秋残。 雁阵惊寒，荷池凋敝，凄凄几度凭栏..."</p>
<p>意象经典（霜、雁、荷池都是写秋的标准配置），情感到位，格律基本符合。虽然下阕有一句"冬临春去匆忙"不太合适（题目要求的是秋冬，不是冬春），但整体很有意境。</p>
<p><strong>GPT-5.1</strong> 思考更久才给出答案：</p>
<p>"霜风渐紧，疏林欲尽，残阳又坠天涯。 寒雁横空，芦花带雪，疏钟远度平沙..."</p>
<p>格律也对，但问题不少：</p>
<ul>
<li>上阕和下阕都提到"霜"，重复了</li>
<li>"新篁覆瓦"这个词用得不对，新篁是春天的竹笋，和秋冬主题不搭</li>
<li>"鬓影添华"和后面又重复提"鬓影添霜华"</li>
<li>整体读起来比较生硬</li>
</ul>
<p>老实说，在古诗词这种需要意境和文采的任务上，GPT-5.1明显不如Claude。</p>
<h3 data-id="heading-4">前端开发：各有输赢</h3>
<p>测试了几个前端任务：</p>
<p><strong>SVG动画：</strong> 让它们用SVG画一只猫和一只狗在草地上走路，天空有云和飞鸟。</p>
<ul>
<li>GPT-5.1：画出来的分不清是猫还是狗，比较抽象</li>
<li>Claude Sonnet 4.5：猫狗能认出来，鸟画得也更像样</li>
</ul>
<p><strong>UI设计：</strong> 让它们做一个蜂箱管理仪表盘。</p>
<ul>
<li>Claude的配色、布局、字体都很精致</li>
<li>GPT-5.1用了深黑配色，整体效果差一截</li>
</ul>
<p><strong>页面还原：</strong> 给一张截图让它们还原。</p>
<ul>
<li>两个都还原得不错</li>
<li>Claude的配色更接近原图</li>
<li>GPT-5.1的背景色偏差比较大</li>
</ul>
<p><strong>3D开发：</strong> 让它们用Three.js开发魔方游戏。这个难度大，涉及3D图形、WebGL、旋转算法、交互逻辑等多个技术点。</p>
<p>结果两个都翻车了：</p>
<ul>
<li>Claude做出了一个魔方，但点击"打乱"按钮没反应，功能没实现</li>
<li>GPT-5.1的页面直接看不到魔方</li>
</ul>
<p>这个测试说明，真正复杂的3D应用，目前的AI还搞不定。</p>
<h3 data-id="heading-5">Python动画：旗鼓相当</h3>
<p>最后测试了一个有趣的任务：用Python写一个冒泡排序的可视化动画，画面中有12只不同大小的小鸭子，一只大母鸭用冒泡算法把小鸭子从小到大排序。</p>
<p>两个AI都完成了：</p>
<ul>
<li>Claude画的鸭子太大太密集，不太好看清细节，但排序逻辑完全正确</li>
<li>GPT-5.1画的鸭子简陋一些，相邻鸭子大小区分不明显，但也实现了功能</li>
</ul>
<p>这个任务上两个差不多，都能完成，只是视觉效果各有问题。</p>
<h3 data-id="heading-6">知识更新度：Claude领先</h3>
<p>一个容易被忽略的点：知识库截止日期。</p>
<ul>
<li><strong>GPT-5.1：</strong> 2024年6月</li>
<li><strong>Claude Sonnet 4.5：</strong> 2025年1月</li>
</ul>
<p>整整差了7个月。如果你需要了解最新的技术动态、时事信息，Claude的知识更新。</p>
<h3 data-id="heading-7">浏览器自动化：GPT-5.1有进步</h3>
<p>在OpenAI的Atlas浏览器中测试了自动化任务：访问博客，提取第一篇文章，改写后发布到X平台。</p>
<p>GPT-5.1完成这个任务用了1分05秒，速度比之前的GPT-5快了不少。虽然最后没有直接点击发布（需要人工审核），但整个流程执行得挺流畅。</p>
<p>这可能是GPT-5.1少数明显优于前代的地方。</p>
<h3 data-id="heading-8">总结：有进步，但别期待太高</h3>
<p>测试下来，我的真实感受是：</p>
<p><strong>GPT-5.1的优点：</strong></p>
<ul>
<li>比GPT-5确实有进步，尤其在减少胡编和浏览器自动化方面</li>
<li>个性化定制功能实用</li>
<li>数学和编程能力有提升（虽然没实测，但官方数据应该靠谱）</li>
</ul>
<p><strong>GPT-5.1的短板：</strong></p>
<ul>
<li>长文本生成能力依然弱于Claude</li>
<li>文学创作（古诗词、散文）明显不如Claude</li>
<li>前端UI设计审美一般</li>
<li>复杂3D应用还搞不定</li>
<li>知识库更新慢于Claude</li>
</ul>
<p><strong>适用场景建议：</strong></p>
<ul>
<li>需要生成长文、详细报告 → 用Claude</li>
<li>写作需要文采、意境 → 用Claude</li>
<li>前端UI设计 → 优先Claude</li>
<li>数学、编程、逻辑推理 → 可以试试GPT-5.1</li>
<li>浏览器自动化 → GPT-5.1不错</li>
<li>日常对话、快速查询 → 两个都行</li>
</ul>
<p>OpenAI这次的更新很务实，没吹牛，老老实实修bug、优化体验。但客观说，GPT-5.1并没有拉开和竞品的差距，在某些场景甚至还落后。</p>
<p>AI的竞争现在是白热化阶段，每个模型都有自己的长处和短处。作为用户，最好的策略是根据任务选模型，而不是盲目迷信某一个。</p>
<p><strong>我的建议：Plus会员可以同时订阅ChatGPT和Claude，根据任务切换使用。专业用户建议两个都试试，找到最适合自己工作流的那个。</strong></p>
<p>三个月后GPT-5的翻车还历历在目，这次5.1算是稳住了，但要说惊艳，还差点意思。</p>
<p>你用过GPT-5.1了吗？实际体验如何？欢迎在评论区分享你的测试结果。</p>
<hr/>
<p><strong>测试环境说明：</strong></p>
<ul>
<li>测试时间：2025年11月13日</li>
<li>GPT-5.1：Thinking模式</li>
<li>Claude Sonnet 4.5：Thinking模式</li>
<li>测试项目：长文本、文学创作、前端开发、Python动画、浏览器自动化</li>
<li>客观性声明：本文基于实际测试结果，未收取任何推广费用</li>
</ul>
<hr/>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[生产环境Sourcemap策略：从苹果事故看前端构建安全架构设计]]></title>    <link>https://juejin.cn/post/7571808096937705513</link>    <guid>https://juejin.cn/post/7571808096937705513</guid>    <pubDate>2025-11-13T13:42:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571808096937705513" data-draft-id="7569064516920524834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="生产环境Sourcemap策略：从苹果事故看前端构建安全架构设计"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-13T13:42:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端一小卒"/> <meta itemprop="url" content="https://juejin.cn/user/1943592286564045"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            生产环境Sourcemap策略：从苹果事故看前端构建安全架构设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592286564045/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端一小卒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T13:42:25.000Z" title="Thu Nov 13 2025 13:42:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你对 React 源码解析感兴趣，欢迎访问我的微信公众号- 【前端小卒】</p>
<p>在我的博客中，你可以找到：</p>
<p>🔍 完整的 React 源码解析电子书 - 从基础概念到高级实现，全面覆盖 React 19 的核心机制
📖 系统化的学习路径 - 按照 React 的执行流程，循序渐进地深入每个模块
💡 实战案例分析 - 结合真实场景，理解 React 设计思想和最佳实践
🚀 最新技术动态 - 持续更新 React 新特性和性能优化技巧</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03cb80d7f8846ac92a4e5c569685655~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LiA5bCP5Y2S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763646145&amp;x-signature=kY7U4dLC0d9FOiz0zfdCE81ypNQ%3D" alt="wechat.png" loading="lazy"/></p>
<p>就在这个月，<strong>2025年11月3日</strong>，苹果上线的全新 <code>apps.apple.com</code> 上演了一场P0级的“源码裸奔”事故。使用 Svelte开发的应用，竟然<strong>忘记了在生产环境中移除 Sourcemap 配置</strong>。</p>
<p><strong>这意味着什么！</strong></p>
<p>全球任何一个人可以打开浏览器的DevTools，<strong>就能够看到并且获取苹果未经压缩、带注释、结构清晰、功能完备的前端源码</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8e2d8f831b84edab63f89da60a85acb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LiA5bCP5Y2S:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763646145&amp;x-signature=2Av53RYWAt3Pq1D2KD%2Fw75RIwQU%3D" alt="G44vIqfWYAAq6Ab.jpeg" loading="lazy"/></p>
<p>为何一个生产代码，会如此“裸奔”？而这个答案直指一个被错误配置的文件——<code>Sourcemap</code>。</p>
<p>尽管作为一名业务前端，在各种场所自嘲：前端业务代码没有价值，远离业务核心。但这不并等于前端代码可以裸奔，将可能存在的密钥、业务逻辑、后端API地址赤裸裸的放在公众面前。</p>
<p>本文将从这起最新的“泄码”事件出发，深入Sourcemap的底层原理，彻底搞懂这个 <code>Sourcemap</code>。</p>
<h3 data-id="heading-0">什么是 Sourcemap？为什么需要它？</h3>
<p>在现代前端工作流中，我们写的 <code>src/index.js</code> 并不能直接在浏览器运行。它需要经过一系列处理：</p>
<ol>
<li><strong>转换（Transpiling）：</strong> Babel 将 ES-Next/TS/JSX -&gt; 目标浏览器支持的 ES 版本。</li>
<li><strong>打包（Bundling）：</strong> Webpack 或 Vite 将上百个模块文件合并成少数几个文件。</li>
<li><strong>压缩（Minifying）：</strong> Terser 或 UglifyJS 将代码中的空格、换行、注释全部删除，并将变量名替换为 <code>a</code>, <code>b</code>, <code>c</code> 等短字符。</li>
</ol>
<p>通过这样处理，我们得到了更小的文件体积、更少的HTTP请求以及相对代码安全（提高了源码的阅读门槛）</p>
<p><strong>但这带来了巨大的“痛点”：</strong></p>
<p>当我们线上代码出现问题报错时，在监控平台收到的错误异常信息往往是这样的：</p>
<pre><code class="hljs language-arduino" lang="arduino">TypeError: <span class="hljs-function">Cannot read properties of <span class="hljs-title">undefined</span> <span class="hljs-params">(reading <span class="hljs-string">'a'</span>)</span>
    at e.t.<span class="hljs-title">a</span> <span class="hljs-params">(app.chunk<span class="hljs-number">.8</span>efda.min.js:<span class="hljs-number">1</span>:<span class="hljs-number">1053</span>)</span>
</span></code></pre>
<p>这个信息毫无意义。你完全不知道 <code>app.chunk.8efda.min.js</code> 文件的第1行第1053列，对应的是源代码中哪一行代码，往往只能凭直觉+连蒙带猜。</p>
<p><strong>Sourcemap 就是来解决这个问题的。</strong></p>
<p>它是一个独立的 <code>.map</code> json 文件，精确地维护着“源码”和“生产代码“之间的映射关系</p>
<p>当浏览器（或Sentry等异常监控平台）拿到报错信息时，它会查找对应的 <code>.map</code> 文件，然后定位到真正的错误位置：</p>
<pre><code class="hljs language-bash" lang="bash">TypeError: Cannot <span class="hljs-built_in">read</span> properties of undefined (reading <span class="hljs-string">'user'</span>)
    at fetchUser (src/components/user.ts:58:12)
</code></pre>
<h3 data-id="heading-1">解剖 <code>.map</code> 文件</h3>
<p>Sourcemap 的核心就是一个 JSON 文件。让我们来看一个它最简单的结构：</p>
<p>JSON</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"version"</span>: <span class="hljs-number">3</span>,
  <span class="hljs-string">"file"</span>: <span class="hljs-string">"bundle.min.js"</span>,
  <span class="hljs-string">"sourceRoot"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"sources"</span>: [<span class="hljs-string">"src/index.js"</span>, <span class="hljs-string">"src/utils.js"</span>],
  <span class="hljs-string">"names"</span>: [<span class="hljs-string">"add"</span>, <span class="hljs-string">"MAGIC_NUMBER"</span>, <span class="hljs-string">"subtract"</span>],
  <span class="hljs-string">"sourcesContent"</span>: [
    <span class="hljs-string">"import { add } from './utils.js';<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>console.log(add(5, MAGIC_NUMBER));"</span>,
    <span class="hljs-string">"export const MAGIC_NUMBER = 7;<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>export const add = (a, b) =&gt; a + b;<span class="hljs-subst">\n</span>export const subtract = (a, b) =&gt; a - b;"</span>
  ],
  <span class="hljs-string">"mappings"</span>: <span class="hljs-string">"AAAA,SAASA,IAAI,QAAQ,cACpB,QAAQC,cAAc,EACrBC,OAAO,CAACC,GAAG,CAACH,GAAG,CAAC,CAAC,EAAEC,YAAW,CAAC,CAAC"</span>
}
</code></pre>
<p>我们来逐个解析这些字段：</p>
<ul>
<li>
<p><code>version</code>: 版本号，目前最新且通用的是版本3。</p>
</li>
<li>
<p><code>file</code>: 压缩后的文件名（即 <code>bundle.min.js</code> 是由 <code>mappings</code> 映射生成的）。</p>
</li>
<li>
<p><code>sourceRoot</code>: 源码的根目录（可选）。</p>
</li>
<li>
<p><code>sources</code>: 一个数组，包含了所有源码文件的路径。</p>
</li>
<li>
<p><code>names</code>: 一个数组，包含了源码中所有被混淆替换掉的变量名和属性名。</p>
</li>
<li>
<p><code>sourcesContent</code>: <strong>[高危字段]</strong> 一个数组，包含了所有源码的<strong>原文内容</strong>。如果这个字段存在，意味着 <code>.map</code> 文件本身就包含了所有源码，泄露风险极大！</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-2"><code>mappings</code> 字段</h4>
<p><code>mappings</code> 字段是 Sourcemap 的核心，也是它最为复杂的部分。我们看到的一堆像乱码长串字符<code>AAAA,SAASA,IAAI...</code> 到底是什么？</p>
<p>这不是乱码，而是一种超高效率的编码——<strong>Base64 VLQ (Variable-length quantity)</strong> ，这存储了源码和压缩码之间所有位置映射关系。</p>
<p>为什么用它？</p>
<p>如果用 JSON 存储每个位置的映射 [{ genLine: 1, genCol: 5, srcFile: 0, srcLine: 2, srcCol: 10 }, ...]，那么这个 .map 文件会比你的 js 文件本体还大几倍。而 VLQ 编码就是为了极致的压缩体积。</p>
<p><code>mappings</code> 字符串通过两种符号来组织：</p>
<ul>
<li><strong>分号 (<code>;</code>)：</strong> 代表“换行”。每个分号对应压缩后文件（<code>bundle.min.js</code>）的<strong>一行</strong>。</li>
<li><strong>逗号 (<code>,</code>)：</strong> 代表“位置”。在同一行中，用逗号分隔多个映射点（Segments）。</li>
</ul>
<p>例如 <code>AAAA,CAAC;CACC</code> 的意思是：</p>
<ul>
<li><code>AAAA</code> 和 <code>CAAC</code> 两个映射点在压缩文件的第1行。</li>
<li><code>CACC</code> 映射点在压缩文件的第2行。</li>
</ul>
<p><strong>Base64 VLQ 编码</strong></p>
<p><code>AAAA</code> 或 <code>CAAC</code> 这样的每个“映射点”（Segment）到底代表什么？</p>
<p>它通常包含4到5个数字：</p>
<ol>
<li>压缩后代码的<strong>列号</strong></li>
<li><code>sources</code> 数组中<strong>文件索引</strong></li>
<li>源码的<strong>行号</strong></li>
<li>源码的<strong>列号</strong></li>
<li>（可选）<code>names</code> 数组中的<strong>变量名索引</strong></li>
</ol>
<p>而 Base64 VLQ 是一种“可变长”的编码方式，想象一种特殊的编码，用来表示数字。表示 <code>1</code> 只需要1个字符 <code>C</code>，表示 <code>5</code> 只需要1个字符 <code>K</code>，但表示 <code>1000</code> 可能需要3个字符。它对“小数字”的编码极其高效。</p>
<p>这是 VLQ 编码能做到极致压缩的<strong>最关键</strong>一点：<strong>它存储的不是绝对位置，而是“相对前一个位置的偏移量（Delta）”</strong> 。</p>
<p>举个例子：</p>
<ul>
<li>第一个映射点 <code>AAAA</code> 解码后是 <code>[0, 0, 0, 0]</code>（代表：压缩后0列，第0个文件，第0行，第0列）。</li>
<li>假设第二个映射点 <code>CAAC</code> 解码后是 <code>[0, 0, 1, 0]</code>。</li>
</ul>
<p>这<strong>不</strong>代表它映射到源码的 <code>(1, 0)</code> 位置。它代表的是<strong>偏移量</strong>：</p>
<ul>
<li>压缩后列号：<code>0</code> (相对上一个映射点 <code>AAAA</code> 的0列，偏移 <code>+0</code>)</li>
<li>文件索引：<code>0</code> (相对上一个的0，偏移 <code>+0</code>)</li>
<li>源码行号：<code>1</code> (相对上一个的0行，偏移 <code>+1</code>)</li>
<li>源码列号：<code>0</code> (相对上一个的0列，偏移 <code>+0</code>)</li>
</ul>
<p>所以 <code>CAAC</code> 真正映射的位置是源码的 <code>(0+1, 0+0)</code>，即第1行第0列。</p>
<p>因为源码和压缩码在大多数情况下都是顺序的，所以两次映射之间的“偏移量”通常都非常小（比如 <code>+1</code>, <code>+0</code>），这些小数字用 VLQ 编码后，只需要一个字符。这就是 <code>mappings</code> 字符串能如此之短的秘密。</p>
<h3 data-id="heading-3">如何在 Webpack 与 Vite 中玩转 Sourcemap</h3>
<p>上面讲解了原理，现在我们来进行实战，在业务中我们必须区分 <code>development</code> 和 <code>production</code>。而关于sourcemap的分类，这里我们以webapck为例子。尽管webpack有二十多种，但大体上可以分为以下几种：</p>
<h4 data-id="heading-4">“sourcemap”</h4>
<p>在每次构建中，都会生成以下的文件产物树</p>
<pre><code class="hljs language-arduino" lang="arduino">dist/
 ├─ app<span class="hljs-number">.3</span>cf7.js
 └─ app<span class="hljs-number">.3</span>cf7.js.map      
</code></pre>
<p><strong>app.3bf4.js尾部注释</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//# sourceMappingURL=app.3cf7.js.map</span>
</code></pre>
<p><strong>.map 数据样例（只留关键列）</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"file"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"app.3cf7.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"webpack://my-app/src/utils/add.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"webpack://my-app/src/pages/Pay.vue"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sourcesContent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>      <span class="hljs-comment">// ① 完整源码嵌在这里</span>
    <span class="hljs-string">"export const add = (a, b) =&gt; a + b;"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"&lt;template&gt;...&lt;/template&gt;\n&lt;script&gt;..."</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"submit"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AAAA,SAASA,IAAG,SAASC,..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sourceRoot"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果我们在浏览器中打开devtools就能够看到以下的日志：</p>
<pre><code class="hljs language-arduino" lang="arduino">Sources ▸ webpack:<span class="hljs-comment">// ▸ src/pages/Pay.vue</span>
</code></pre>
<p>sourcemap能够提供列级的精度映射，是 <strong>Sentry、Bugsnag 还原真实源码</strong> 的最低要求，但是其体积最大，如果将 .map文件发到cdn上，那就GG了。</p>
<h4 data-id="heading-5"><code>hidden-source-map</code></h4>
<p>hidden-source-map在在每次构建中，都会生成以下的文件产物树,而map内容也和soucemap的完全一致。</p>
<pre><code class="hljs language-arduino" lang="arduino">dist/
 ├─ app<span class="hljs-number">.3</span>cf7.js            <span class="hljs-comment">// **没有** sourceMappingURL 注释</span>
 └─ app<span class="hljs-number">.3</span>cf7.js.map        <span class="hljs-comment">// 文件照样生成，只是浏览器不知道</span>
</code></pre>
<p>其在浏览器中报错堆栈停留在压缩码位置，而用户也在Sources面板看不到 webpack://树，这意味着浏览器“找不到”这个 .map 文件，用户无法用它来反解源码。</p>
<pre><code class="hljs language-java" lang="java">at <span class="hljs-title function_">e</span> <span class="hljs-params">(app.3cf7.js:<span class="hljs-number">1</span>:<span class="hljs-number">1340</span>)</span>
</code></pre>
<p>在日常开发中，往往通过ci工具把 <code>.map</code> 私有上传到 Sentry，这样不存在泄漏源码的风险，监控又能够提供完整的错误路径。</p>
<h4 data-id="heading-6"><code>cheap-module-source-map</code></h4>
<p>在每次构建中，都会生成以下的文件产物树</p>
<pre><code class="hljs language-arduino" lang="arduino">dist/
 ├─ app<span class="hljs-number">.3</span>cf7.js
 └─ app<span class="hljs-number">.3</span>cf7.js.map
</code></pre>
<p>对于map文件中，其不会存在列消息</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AAAA,CAAC,CAAC,CAAC..."</span>  <span class="hljs-comment">// 只记录「行→行」映射</span>
**没有列信息**                       <span class="hljs-comment">// VLQ 第 1、4 段永远为 0</span>
</code></pre>
<p>所以当业务报错时，DevTools只能断到 <strong>第 58 行</strong>，无法断到 <strong>第 58 行第 12 列</strong>。</p>
<pre><code class="hljs language-java" lang="java">at <span class="hljs-title function_">submitOrder</span> <span class="hljs-params">(Pay.vue:<span class="hljs-number">58</span>)</span>   <span class="hljs-comment">// 看不到 :58:12</span>
</code></pre>
<p>这种类型的sourcemap在<strong>开发环境</strong>够用且 rebuild快，如果在<strong>测试环境</strong>想省磁盘 / 加速 CI 也可选它。</p>
<h4 data-id="heading-7"><code>eval-cheap-module-source-map</code>　</h4>
<p>在每次构建中，都会生成以下的文件产物</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">**</span>没有 .map 文件<span class="hljs-operator">**</span>
所有代码包裹成：
eval(
  <span class="hljs-string">"////# sourceURL=webpack://my-app/src/pages/Pay.vue?3f20<span class="hljs-subst">\n</span>"</span> <span class="hljs-operator">+</span>
  <span class="hljs-string">"export default {<span class="hljs-subst">\n</span>  name: <span class="hljs-subst">\"</span>Pay<span class="hljs-subst">\"</span><span class="hljs-subst">\n</span>}"</span>
)
</code></pre>
<p>在<strong>浏览器 Sources</strong>，我们也可以双击点击源码，但是只能断行。</p>
<pre><code class="hljs language-ruby" lang="ruby">▸ <span class="hljs-symbol">webpack:</span>/<span class="hljs-regexp">/ ▸ src/pages</span><span class="hljs-regexp">/Pay.vue?3f20   /</span><span class="hljs-regexp">/ 虚拟文件
</span></code></pre>
<p><code>eval-cheap-module-source-map</code>能够做到 <strong>本地 HMR</strong> 秒级重编（磁盘 0 写入），但是其最好在生产禁，因为CSP策略可能 block <code>eval</code>，同时无实体文件无法收集到监控平台。</p>
<hr/>
<h4 data-id="heading-8">inline-source-map</h4>
<p>在每次构建中，都会生成以下的文件产物</p>
<pre><code class="hljs language-arduino" lang="arduino">dist/
 └─ app<span class="hljs-number">.3</span>cf7.js   <span class="hljs-comment">// 只有一个文件</span>
</code></pre>
<p>在app.3cf7.js的<strong>尾部追加</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjoz...</span>
</code></pre>
<p>事实上，其整个 <code>.map</code> JSON（含 sourcesContent）被 <strong>base64 内联</strong> 直接导致js文件体积暴增30-50%。</p>
<p>所以其应用场景比较局限：往往写文件库比如loadsh时，一个文件走天下，而多入口业务项目<strong>千万别用</strong>，每个 chunk 都会生成一份内联map文件，体积直接爆炸。</p>
<h4 data-id="heading-9"><code>nosources-source-map</code></h4>
<p><strong>产物示例</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/Pay.vue"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sourcesContent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// ① 关键：只有路径，没有内容</span>
  <span class="hljs-attr">"names"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"submit"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mappings"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AAAA,SAASA..."</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>DevTools 效果</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">Sources ▸ webpack:<span class="hljs-comment">// ▸ src/Pay.vue     // 树在，文件能点开</span>
**内容是空白的** —— 提示 “Source content is <span class="hljs-keyword">not</span> available”
</code></pre>
<p>这个几乎是官方UI 框架（vue.global.prod.js、react.production.min.js）<strong>标配</strong>，用户可看到「目录结构」方便调试，<strong>却看不到具体实现</strong>。</p>
<p>如果我们要把包发到CDN，希望 Sentry 仍能还原列号，那么使用这个就行即可。</p>
<hr/>
<p>####. <code>eval</code>
<strong>产物</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">eval</span>(<span class="hljs-string">"function add(a,b){return a+b}\n//# sourceURL=webpack:///./src/add.js"</span>)
</code></pre>
<p>当业务报错时，报错栈只能看到 <strong>压缩后变量名</strong>。而这个能提供最快 rebuild，在<strong>超大型 monorepo</strong> 本地开发阶段图个极致 rebuild 速度，往往会选它，但在生产环境中，其都无法满足条件。</p>
<h3 data-id="heading-10">生产环境的安全与最佳实践</h3>
<p>现在我们回到开头苹果（2025年11月）的“泄密”事件。他们犯了什么错？</p>
<p>他们很可能在生产环境配置了 <code>build.sourcemap: true</code> (如果是Vite/Rollup) 或 <code>devtool: 'source-map'</code> (如果是Webpack)，并且<strong>忘记了移除 <code>sourceMappingURL</code> 注释</strong>，同时<strong>将生成的 <code>.map</code> 文件和 <code>.js</code> 文件一起部署到了公网服务器上</strong>，<strong>也忘记了用 Nginx 拦截</strong>。</p>
<p>看上去，他们几乎踩了我们能想到的每一个“雷”，如果中间任何一个环节稍微严谨点，都不会出现这个问题。</p>
<p>这就是最严重的安全红线：<strong>绝对不要将 <code>.map</code> 文件部署到公网用户可以访问到的地方！</strong></p>
<blockquote>
<p>“但是，我白屏了就是需要定位问题，怎么办！”</p>
</blockquote>
<p>那么我们就要<strong>用户无法访问 Sourcemap，但我们自己可以。</strong></p>
<p>在 CI/CD 流程中，使用 hidden-source-map (Webpack) 或 build.sourcemap: true + 移除插件 (Vite) 来构建。这会生成 .map 文件，但浏览器不会加载它。</p>
<p>同时不要将 .map 文件部署到你的CDN或Web服务器。而是将这些 .map 文件上传到私有的错误监控平台，例如 Sentry、FrontJS 或自建的内网服务器。</p>
<p>而对于<strong>开源库/组件库</strong> 而言 <code>nosources-source-map</code>是最优选，其部署简单，只暴露目录结构和变量名，不暴露源码逻辑，方便他人调试。</p>
<p>这个流程完美地实现了“鱼和熊掌兼得”：在对源码绝对安全的掌控下，还能拥有完整的线上调试能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WPF/C#：使用Microsoft Agent Framework框架创建一个带有审批功能的终端Agent]]></title>    <link>https://juejin.cn/post/7572012699628175387</link>    <guid>https://juejin.cn/post/7572012699628175387</guid>    <pubDate>2025-11-13T12:04:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572012699628175387" data-draft-id="7572132100327227442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WPF/C#：使用Microsoft Agent Framework框架创建一个带有审批功能的终端Agent"/> <meta itemprop="keywords" content="C#"/> <meta itemprop="datePublished" content="2025-11-13T12:04:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WPF/C#：使用Microsoft Agent Framework框架创建一个带有审批功能的终端Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:04:50.000Z" title="Thu Nov 13 2025 12:04:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近新出了一个Microsoft Agent Framework框架，我感觉还挺有意思的，就通过它的那个<code>Using function tools with human in the loop approvals</code>例子，做了一个终端助手Agent。我觉得使用这个作为学习人在环上这个例子蛮合适的，因为对于需要执行敏感操作（如系统命令）的场景，人工审批机制显得尤为重要。本文以Rouyan为例，说明如何使用Microsoft Agent Framework创建一个能够执行终端命令并具备人工审批功能的WPF应用。</p>
<p>在详细介绍之前，先来看看它的效果。</p>
<p>1、比如获取当前时间</p>
<p>会先弹出一个人工审批窗口：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b3770138d9b49a98967ccc9b80c76dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=F%2F3MT3ek%2FuAVwsxjD2czV9M2Oyk%3D" alt="image-20251017213637660" loading="lazy"/></p>
<p>然后你点击同意了才会执行：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afd53c18c5a24b568bb4e783d49624d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=Xxt%2F8daPwCpAP7%2Fgz4%2B8%2FEdeO5Y%3D" alt="image-20251017213716893" loading="lazy"/></p>
<p>如果你拒绝了就是这样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2055b23647745f7a94f91619316c4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=OKzISgXqI4E%2B%2FZvBiesROYm7BqA%3D" alt="image-20251017213755043" loading="lazy"/></p>
<p>实际上你可以利用终端做很多事情，我再举一个例子。</p>
<p>2、新建一个文件，写入你好：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c47d29e703346e599c37f9d02b72268~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=OObNqWnQmoRONzYyOz7L%2FZZQcGU%3D" alt="image-20251017214320364" loading="lazy"/></p>
<p>选择同意，结果如图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/516d19eac35d4a9e82f723dbf61c9d15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=dz8VY7Barr%2B6kY5RM7e4J26rNL4%3D" alt="image-20251017214407194" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08900a30970048bd8305bf1a32c5069b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=5LxGYBMMfjS6z4%2BErrAxptmHqMM%3D" alt="image-20251017214543527" loading="lazy"/></p>
<p>在介绍如何具体实现之前，先来介绍一下Microsoft Agent Framework。</p>
<h2 data-id="heading-1">Microsoft Agent Framework介绍</h2>
<p>GitHub上的简介是：“一个用于构建、编排和部署AI代理及多代理工作流程的框架，支持Python和.NET。”</p>
<p>GitHub地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-framework" target="_blank" title="https://github.com/microsoft/agent-framework" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8521ff892e474b848f6c624a882986~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=Ei2lnlS7LGYVHcWg%2FdAhiFJ0NpM%3D" alt="image-20251017215713327" loading="lazy"/></p>
<p>Microsoft Agent Framework 是一个开源开发工具包，用于为 .NET 和 Python 构建 AI 代理和多代理工作流。它整合并扩展了 Semantic Kernel 和 AutoGen 项目的思想，融合了两者的优点，并新增了多项功能。该框架由同一团队开发，将成为未来构建 AI 代理的统一基础。</p>
<p>Agent Framework 提供了两大主要功能类别：</p>
<p><span>AI 代理：单个代理利用大语言模型（LLM）处理用户输入，调用工具和 MCP 服务器执行操作，并生成响应。代理支持的模型提供商包括 Azure OpenAI、OpenAI 和 Azure AI。</span></p>
<p><span>工作流：基于图形的工作流，用于连接多个代理和功能，以执行复杂的多步骤任务。工作流支持基于类型的路由、嵌套、检查点以及适用于人工干预场景的请求/响应模式。</span></p>
<p>该框架还提供了基础构建模块，包括模型客户端（聊天补全和响应）、用于状态管理的代理线程、用于代理记忆的上下文提供程序、用于拦截代理操作的中间件，以及用于工具集成的MCP客户端。这些组件共同为您提供灵活性和强大功能，以构建交互性强、稳健且安全的AI应用程序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89fcc75f98fa4ec6abad031d75cda563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=8Plt1SX%2BGDgjtet2Q8eMHhLcpdU%3D" alt="image-20251017215856749" loading="lazy"/></p>
<h2 data-id="heading-2">具体实现</h2>
<p>1、安装Nuget包：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/143d83bac73e426b841408fbfc5bd51d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=imV6DJQAE6TlQNnMMenP3sNOM2o%3D" alt="image-20251017220544499" loading="lazy"/></p>
<p>2、编写运行脚本的函数</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Description(<span class="hljs-string">"Execute a Windows cmd.exe script and return its output."</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ExecuteCmd</span>(<span class="hljs-params">[Description(<span class="hljs-string">"The script content to run via 'cmd.exe /c'."</span></span>)] <span class="hljs-built_in">string</span> script)</span>
{
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-keyword">var</span> psi = <span class="hljs-keyword">new</span> ProcessStartInfo(<span class="hljs-string">"cmd.exe"</span>, <span class="hljs-string">"/c "</span> + script)
        {
            UseShellExecute = <span class="hljs-literal">false</span>,
            RedirectStandardOutput = <span class="hljs-literal">true</span>,
            RedirectStandardError = <span class="hljs-literal">true</span>,
            CreateNoWindow = <span class="hljs-literal">true</span>
        };

        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> process = <span class="hljs-keyword">new</span> Process())
        {
            process.StartInfo = psi;
            process.Start();

            <span class="hljs-built_in">string</span> output = process.StandardOutput.ReadToEnd();
            <span class="hljs-built_in">string</span> error = process.StandardError.ReadToEnd();

            process.WaitForExit();

            <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrWhiteSpace(error))
            {
                <span class="hljs-keyword">return</span> <span class="hljs-string">$"错误: <span class="hljs-subst">{error.Trim()}</span>"</span>;
            }

            <span class="hljs-keyword">return</span> output.Trim();
        }
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        <span class="hljs-keyword">return</span> <span class="hljs-string">$"执行失败: <span class="hljs-subst">{ex.Message}</span>"</span>;
    }
}
</code></pre>
<p>3、配置AI Agent</p>
<p>文档中只写了Azure中怎么使用，兼容OpenAI格式的可以这样写：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 配置AI Agent</span>
 DotEnv.Load();
 <span class="hljs-keyword">var</span> envVars = DotEnv.Read();

 <span class="hljs-keyword">var</span> apiKey = envVars[<span class="hljs-string">"OPENAI_API_KEY"</span>];
 <span class="hljs-keyword">var</span> model = envVars[<span class="hljs-string">"OPENAI_CHAT_MODEL"</span>];
 <span class="hljs-keyword">var</span> baseUrl = <span class="hljs-keyword">new</span> Uri(envVars[<span class="hljs-string">"OPENAI_BASE_URL"</span>]);

 ApiKeyCredential apiKeyCredential = <span class="hljs-keyword">new</span> ApiKeyCredential(apiKey);

 OpenAIClientOptions openAIClientOptions = <span class="hljs-keyword">new</span> OpenAIClientOptions();
 openAIClientOptions.Endpoint = baseUrl;

 AIAgent agent = <span class="hljs-keyword">new</span> OpenAIClient(apiKeyCredential, openAIClientOptions)
     .GetChatClient(model)
     .CreateAIAgent(instructions: <span class="hljs-string">"你是一个乐于助人的助手，可以执行命令行脚本。请使用中文回答。"</span>, tools: [<span class="hljs-keyword">new</span> ApprovalRequiredAIFunction(AIFunctionFactory.Create(ExecuteCmd))]);
</code></pre>
<p>这里有一个新东西就是<code>ApprovalRequiredAIFunction</code>。</p>
<p>这说明如果调用这个函数需要经过人工审批。</p>
<p>4、审批流程</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Call the agent and check if there are any user input requests to handle.</span>
AgentThread thread = agent.GetNewThread();

<span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> agent.RunAsync(InputText, thread);
<span class="hljs-keyword">var</span> userInputRequests = response.UserInputRequests.ToList();
</code></pre>
<p>我们先来看看这个是什么，运行起来打个断点看看：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41392255d63f487fb79f26089f363fe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640289&amp;x-signature=FAPDpG5dKI%2F%2FXceaJkehnTzDrL0%3D" alt="image-20251017221907635" loading="lazy"/></p>
<p>这就是一个Agent想要执行的函数，那么现在来看看如何审批：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">while</span> (userInputRequests.Count &gt; <span class="hljs-number">0</span>)
{
    <span class="hljs-keyword">var</span> userInputResponses = <span class="hljs-keyword">new</span> List&lt;ChatMessage&gt;();

    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> functionApprovalRequest <span class="hljs-keyword">in</span> userInputRequests.OfType&lt;FunctionApprovalRequestContent&gt;())
    {
        <span class="hljs-keyword">var</span> scriptContent = functionApprovalRequest.FunctionCall.Arguments?[<span class="hljs-string">"script"</span>]?.ToString() ?? <span class="hljs-string">"未知脚本"</span>;
        <span class="hljs-keyword">var</span> functionName = functionApprovalRequest.FunctionCall.Name;

        <span class="hljs-keyword">var</span> dialogVm = <span class="hljs-keyword">new</span> HumanApprovalDialogViewModel
        {
            Title = <span class="hljs-string">"命令执行审批"</span>,
            Message = <span class="hljs-string">$"是否同意执行以下命令？\n\n函数名称: <span class="hljs-subst">{functionName}</span>\n脚本内容: <span class="hljs-subst">{scriptContent}</span>"</span>
        };

        <span class="hljs-built_in">bool</span>? result = _windowManager.ShowDialog(dialogVm);
        <span class="hljs-built_in">bool</span> approved = result == <span class="hljs-literal">true</span>;

        userInputResponses.Add(<span class="hljs-keyword">new</span> ChatMessage(ChatRole.User, [functionApprovalRequest.CreateResponse(approved)]));
    }

    <span class="hljs-comment">// Pass the user input responses back to the agent for further processing.</span>
    response = <span class="hljs-keyword">await</span> agent.RunAsync(userInputResponses, thread);
    userInputRequests = response.UserInputRequests.ToList();
}
</code></pre>
<p>根据这个地方<code>userInputResponses.Add(new ChatMessage(ChatRole.User, [functionApprovalRequest.CreateResponse(approved)]));</code>中的approved传入的是true还是false表示用户是同意还是拒绝。</p>
<p>然后发送请求获取新的回复，直到没有需要人工审批的函数为止。</p>
<p>5、流式响应</p>
<p>最后再获取一个流式响应：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> update <span class="hljs-keyword">in</span> agent.RunStreamingAsync(<span class="hljs-string">"输出最终答案"</span>, thread))
{
    OutputText += update.Text;
}
</code></pre>
<h2 data-id="heading-3">最后</h2>
<p>以上就是本期的全部内容，希望对你有所帮助。</p>
<p>全部代码已上传至GitHub，地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMing-jiayou%2FRouyan%25E3%2580%2582" target="_blank" title="https://github.com/Ming-jiayou/Rouyan%E3%80%82" ref="nofollow noopener noreferrer">github.com/Ming-jiayou…</a></p>
<p>终端助手的代码主要在src/Rouyan/Pages/ViewModel/TerminalAgentViewModel.cs中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Forrester调研400位高级决策者，揭示AI应用未来]]></title>    <link>https://juejin.cn/post/7572164122235109386</link>    <guid>https://juejin.cn/post/7572164122235109386</guid>    <pubDate>2025-11-13T12:12:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572164122235109386" data-draft-id="7572021695294324786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Forrester调研400位高级决策者，揭示AI应用未来"/> <meta itemprop="keywords" content="人工智能,云计算"/> <meta itemprop="datePublished" content="2025-11-13T12:12:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AKAMAI"/> <meta itemprop="url" content="https://juejin.cn/user/829502942352628"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Forrester调研400位高级决策者，揭示AI应用未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/829502942352628/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AKAMAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:12:17.000Z" title="Thu Nov 13 2025 12:12:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>根据Gartner预测，2025年全球人工智能支出预计将达到6440亿美元，较2024年增长76.4%。在此背景下，企业已将AI视为关乎生存的战略要务。然而，它们在投资AI时具体关注哪些方面？</p>
<p>我们决定与Forrester合作寻找答案。我们对400名负责AI和企业云战略的高级决策者进行了双盲研究。受访者包括来自科技、金融服务、媒体、零售、制造和医疗保健行业的总监、副总裁和C级高管。</p>
<p>本研究旨在揭示企业如何规划近期及长期的AI工作流程和AI工具，尤其关注期望值最高的面向客户的应用。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fforrester-enterprise-ai-report-2025%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251113_external1_blogarticles226" target="_blank" title="https://www.akamai.com/zh/lp/forrester-enterprise-ai-report-2025?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251113_external1_blogarticles226" ref="nofollow noopener noreferrer">《企业级AI现状：积累经验，管理风险》</a>（Forrester OSNAP报告）揭示，AI已成为跨行业、跨地区的战略要务。</p>
<p>为理解这些结果的重要性，让我们深入探讨其驱动因素、当前采用模式背后的原因，以及组织和开发团队接下来该如何保持行业领先地位。</p>
<h4 data-id="heading-0"><strong><strong>AI正定义竞争格局</strong></strong></h4>
<p>Forrester数据显示，76%的企业应用AI解决方案和应用来改善客户体验，71%用以加强客户留存，76%用以提升运营效率。这些是收入增长和竞争优势的核心驱动力。</p>
<p>成功部署AI的组织更能：</p>
<ul>
<li>通过客户体验实现差异化</li>
<li>获取并保护市场份额</li>
<li>加速创新周期</li>
<li>释放运营杠杆效应</li>
<li>构建抵御颠覆的未来韧性</li>
</ul>
<p><strong><strong>通过客户体验实现差异化</strong></strong></p>
<p>个性化服务或推荐、通过自动化实现更快速的服务、智能服务解决，这些都直接改善了客户体验—Forrester将其确定为AI投资的头号驱动因素。在竞争激烈的市场中，客户互动的质量是决定用户忠诚度和留存的关键。</p>
<p><strong><strong>获取并保护市场份额</strong></strong></p>
<p>通过将生成式AI等人工智能能力深度融入客户旅程，企业得以打造更具用户粘性、且难以被竞争对手复制的体验。这不仅有效提升了客户净留存率，也显著增加了用户的转换成本。</p>
<p><strong><strong>加速创新周期</strong></strong></p>
<p>使用AI的企业能够更快地推出新产品和服务，尤其是在整合了程序化内容生成、视觉搜索与预测分析等高级能力后。在那些上市速度与市场份额增长紧密相关的行业中，这构成了一个决定性优势。</p>
<p><strong><strong>释放运营杠杆</strong></strong></p>
<p>AI驱动效率提升，无论是通过流程自动化还是员工能力增强，都将直接转化为成本降低、扩展加速，以及更高价值工作的聚焦。</p>
<p><strong><strong>构建抗颠覆韧性</strong></strong></p>
<p>正如Forrester所指，企业评估AI成功不仅看效率，更关注其对长期收入与客户终身价值的影响。行动迟缓者，恐将被已将AI深度融入核心能力的对手所超越。</p>
<p>从开发者视角看，这一转变意味着AI已嵌入关键业务路径。支撑AI的代码直接牵动客户终身价值与净留存率等核心指标，使可靠性、可扩展性与伦理考量，成为AI设计的重中之重。</p>
<h4 data-id="heading-1"><strong><strong>已验证的用例与下一波创新浪潮</strong></strong></h4>
<p>Forrester强调，采用最广泛的AI用例是那些直接影响客户触点的领域：个性化（53%）、自动化客户服务解决（53%）和回答客户问题（52%）。这些用例占主导地位，是因为它们能带来可衡量的短期成果。</p>
<p>与投资回报不明确的抽象AI计划相比，能够提升转化率的推荐引擎或减少客户流失的聊天机器人，更容易获得领导层的支持。对于企业及其开发团队而言，这种侧重转化为对能够扩展、处理实时数据并最大限度减少客户互动延迟的系统的持续需求。</p>
<p><strong><strong>技术选择将决定AI竞赛的赢家与输家</strong></strong></p>
<p>企业正纷纷加入这波强大的AI浪潮，但力求避免"翻船"。关于AI陷阱和失败的报道屡见不鲜，因此需要深思熟虑和审慎的方法才能成为成功案例之一。</p>
<p>通常，选择从已确定的用例（如AI聊天机器人）入手以快速见效，有助于建立对其AI战略的信心并提升AI应用熟练度。</p>
<p>反过来，这种信心为开展更复杂或更贴合其业务需求的细分AI实施打开了大门。这些应用往往因行业而异。例如：</p>
<ul>
<li>零售和旅游业专注于个性化和视觉搜索以提升客户体验。</li>
<li>金融服务更看重自动化和欺诈检测。</li>
<li>医疗保健和生命科学领域采用AI更为谨慎，在创新与合规及风险之间取得平衡。</li>
</ul>
<p>除了这些已确定的用例，实验性探索正在增加。近半数（46%）的组织正在试点程序化内容创建，40%在测试视觉搜索，而37%在探索面部识别。</p>
<p>这些实验性研发很重要，因为今天的"副业项目"可能成为明天的竞争基准。回想一下酒店业的移动入住是如何从新奇事物转变为必需服务的。鼓励开发团队试点新兴技术的企业更有可能为AI驱动工具和解决方案的爆发式增长做好准备。</p>
<h4 data-id="heading-2"><strong><strong>风险、安全与声誉：AI的隐性成本</strong></strong></h4>
<p>该研究也揭示了多项发人深省的现状。总共63%的受访者将安全担忧列为首要障碍，55%担心合规问题，近半数（45%）担心若AI未能达到预期会损害声誉。</p>
<p>从技术角度看，这些数字强调了对于以下治理框架的需求：</p>
<ul>
<li>保护数据管道以防泄漏</li>
<li>模型监控以检测漂移或偏差</li>
<li>模拟生产环境的测试协议</li>
</ul>
<p>但降低这些风险不仅仅需要技术保障措施。</p>
<p>企业可以从全局性的风险管理思维中受益。安全不仅需要强化的基础设施，还需要清晰的数据处理政策和定期审计，以便在攻击者之前发现漏洞。合规要求开发团队、法律团队和监管专家之间的协作，以确保模型符合不断发展的行业和地区标准。而声誉风险则要求透明度和问责制。</p>
<p>能够解释其AI系统如何决策并证明其公平性的公司，在出现问题时遭遇强烈反对的可能性要小得多。换言之，企业不仅仅是在编写模型，更是在部署关乎业务成败、并反映组织诚信的系统。</p>
<p>降低风险意味着将工程纪律与组织问责相结合，从而确保对创新的追求不以牺牲安全、合规或信任为代价。</p>
<h4 data-id="heading-3"><strong><strong>克服集成障碍</strong></strong></h4>
<p>企业正通过多种技术方法来分散风险。Forrester报告显示，云原生技术（81%）、开源AI（72%）和AI托管服务（77%）的采用率很高。然而，仍有55%的组织将技术和平台差距视为其首要挑战。</p>
<p>这种双重性反映了一个开发者熟知的现实：工具易得，集成难。专有API、碎片化的生态系统以及参差不齐的合规要求都拖慢了进展。那些构建灵活、混合架构的组织——利用开源创新、托管服务实现扩展、边缘部署实现低延迟体验——更能克服这一障碍。</p>
<p>旨在短期内全球部署AI的公司需要的不仅仅是云基础设施：他们需要能够跨监管区域运营、支持本地数据驻留并提供一致性能的合作伙伴。</p>
<p>在Forrester的数据中，专业AI提供商被评为首选合作伙伴。这与我在实践中观察到的情况一致：组织希望供应商既能提供全球覆盖，又具备深厚的技术专长。</p>
<h4 data-id="heading-4"><strong><strong>企业当前可采取的五项行动</strong></strong></h4>
<p>Forrester研究指出：AI已是常态，企业的成败取决于其把握机遇与管理风险的能力。基于最新洞察，我们建议立即推进以下五项措施：</p>
<ol>
<li><strong><strong>以客户价值锚定AI</strong></strong><br/>
每次AI部署都应与客户体验、留存率或收入的可量化提升直接挂钩。</li>
<li><strong><strong>兼顾速度与治理</strong></strong><br/>
在快速推进的同时，将合规、测试与监控前置至开发初始阶段。</li>
<li><strong><strong>构建灵活架构</strong></strong><br/>
结合开源、云原生与AI托管服务，从技术上规避供应商锁定。</li>
<li><strong><strong>审慎选择合作伙伴</strong></strong><br/>
优先考虑具备全球规模、本地化合规能力与可靠交付记录的供应商。</li>
<li><strong><strong>将实验纳入研发体系</strong></strong><br/>
打破试点孤岛，把AI实践的经验融入长期技术路线图。</li>
</ol>
<h4 data-id="heading-5"><strong><strong>定义AI新时代</strong></strong></h4>
<p>Forrester研究印证了我们共同的观察：AI已成为企业战略的核心。然而数据也揭示出，企业愿景与现实部署之间仍存张力。</p>
<p>开发者、架构师与业务领导者必须意识到：今天所构建的AI，不仅影响产品功能，更将决定未来的客户体验与品牌信誉。那些以客户为中心、采纳灵活技术策略并携手可信合作伙伴的组织，不仅能在AI浪潮中立足，更将共同定义这个时代。</p>
<h4 data-id="heading-6"><strong><strong>了解更多</strong></strong></h4>
<p>如果您有兴趣进一步了解企业AI的现状，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.akamai.com%2Fzh%2Flp%2Fforrester-enterprise-ai-report-2025%3Futm_campaign%3Df-mc-65893%26utm_id%3Dapj_cc%26utm_source%3Djuejin%26utm_medium%3Darticle_advertorial%26utm_content%3Djuejing_251113_external2_blogarticles226" target="_blank" title="https://www.akamai.com/zh/lp/forrester-enterprise-ai-report-2025?utm_campaign=f-mc-65893&amp;utm_id=apj_cc&amp;utm_source=juejin&amp;utm_medium=article_advertorial&amp;utm_content=juejing_251113_external2_blogarticles226" ref="nofollow noopener noreferrer">请阅读完整报告</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MoE 负载均衡之争：为何 Mixtral 的“实用主义”胜过了“统计主义”？]]></title>    <link>https://juejin.cn/post/7572010680896749608</link>    <guid>https://juejin.cn/post/7572010680896749608</guid>    <pubDate>2025-11-13T12:33:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896749608" data-draft-id="7572020278386982946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MoE 负载均衡之争：为何 Mixtral 的“实用主义”胜过了“统计主义”？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-13T12:33:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MoE 负载均衡之争：为何 Mixtral 的“实用主义”胜过了“统计主义”？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:33:17.000Z" title="Thu Nov 13 2025 12:33:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MoE 负载均衡之争：为何 Mixtral 的“实用主义”胜过了“统计主义”？</h2>
<p>在当今的大模型（LLM）领域，MoE（Mixture of Experts）架构已经成为实现“更快、更强、更大”的黄金门票。通过“稀疏激活”，MoE 允许模型拥有数千亿甚至万亿的总参数（知识库），同时保持着极低（且可控）的计算成本（推理速度）。</p>
<p>但这个“天下没有免费的午餐”的故事里，有一个致命的“阿喀琉斯之踵”——<strong>负载均衡 (Load Balancing)</strong> 。</p>
<p>如果你不加约束，Gating 网络（分诊台）会很快“偷懒”，发现有几个专家特别“聪明”，然后把所有任务都交给它们。这会导致“明星专家”过劳，而“摸鱼专家”完全得不到训练，白白浪费了宝贵的 GPU 资源和模型容量。</p>
<p>为了解决这个问题，研究者们设计了“辅助损失函数” (Auxiliary Loss Function) 来“惩罚”这种不均衡。今天，我们就来深入对比两种最著名、最有代表性的负载均衡策略。</p>
<p>这不仅仅是一场数学公式的较量，更是一场“统计纯洁性”与“工程实用性”的对决。</p>
<hr/>
<h3 data-id="heading-1">策略一：“统计主义”的优雅——CV 损失 (GShard)</h3>
<p>第一种方法来自 Google GShard 等早期 MoE 论文，它在数学上非常“优雅”，力求实现统计上的完美均衡。</p>
<p><strong>核心思想：</strong> 我们应该让所有专家被 Gating 网络赋予的**“总重要性” (Total Importance)** 保持一致。</p>
<p>核心公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>Importance</mtext></msub><mo>=</mo><msub><mi>w</mi><mtext>Importance</mtext></msub><mo>⋅</mo><mtext>CV</mtext><mo stretchy="false">(</mo><mtext>Importance</mtext><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L_{\text{Importance}} = w_{\text{Importance}} \cdot \text{CV}(\text{Importance}(X))^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Importance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7306em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Importance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">CV</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">Importance</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>公式分解：</strong></p>
<ol>
<li>
<p><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></strong> ：Gating 网络为单个 Token <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 输出的、<em>经过 Top-K 筛选和 Softmax 归一化</em>的稀疏概率向量。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Importance</mtext><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><mi>X</mi></mrow></msub><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Importance}(X) = \sum_{x \in X} G(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Importance</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0771em;vertical-align:-0.3271em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3271em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>：</p>
<p>这是最关键的一步。我们把一个批次 (Batch) 中所有 Token 的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">G(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span> 向量全部加起来，得到一个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 维（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 为专家数）的“总重要性”向量。例如 [150.3, 149.8, 150.1, 149.9]。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>CV</mtext><mo stretchy="false">(</mo><mo>…</mo><mtext> </mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{CV}(\dots)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">CV</span></span><span class="mopen">(</span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mclose">)</span></span></span></span></span>：</p>
<p>计算这个“总重要性”向量的变异系数 (Coefficient of Variation)，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mtext>标准差</mtext><mtext>平均值</mtext></mfrac></mrow><annotation encoding="application/x-tex">\frac{\text{标准差}}{\text{平均值}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">平均值</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">标准差</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>Importance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{Importance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Importance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<p>我们最小化这个变异系数的平方。</p>
</li>
</ol>
<p>直觉：</p>
<p>变异系数是衡量“不均衡性”的完美指标。</p>
<ul>
<li><strong>完美均衡：</strong> <code>[150, 150, 150]</code>。标准差 = 0，CV = 0，损失 = 0。</li>
<li><strong>极度失衡：</strong> <code>[450, 0, 0]</code>。标准差和 CV 都非常高，损失非常大。</li>
</ul>
<p>这种方法在理论上近乎完美，它只需要一次 <code>AllReduce</code>（计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><mi>G</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\sum G(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">G</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>），计算高效且数学逻辑清晰。</p>
<hr/>
<h3 data-id="heading-2">策略二：“实用主义”的胜利——Switch 损失 (Mixtral)</h3>
<p>第二种方法来自 Google 的 Switch Transformer 论文，并被 Mixtral 8x7B 等当前最先进的开源模型所采用。它看起来“更复杂”或“更不直观”，但它解决了一个致命的漏洞。</p>
<p><strong>核心思想：</strong> 我们必须<em>同时</em>平衡 Gating 网络的“路由信心”和专家的“实际工作量”。</p>
<p>核心公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub><mo>=</mo><mi>N</mi><mo>⋅</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}} = N \cdot \sum_{i=1}^{N} f_i \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p><strong>公式分解：</strong></p>
<ol>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (平均路由概率)：</p>
<p>Gating 网络在这个批次中，平均分配给专家 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的**“概率”**（即“意向”）。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (任务分配比例)：</p>
<p>通过 Top-K 硬决策后，专家 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 实际 被分配到的 Token 比例（即“实际工作量”）。</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<p>我们最小化 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 向量和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 向量的“点积”（Dot Product）。</p>
</li>
</ol>
<p>直觉：</p>
<p>这个公式的巧妙之处在于，它将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（一个不可微分的“硬决策”结果）和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（一个可微分的“软概率”）绑定在了一起。我们稍后会看到，这不仅解决了负载均衡，还顺便解决了“梯度回传”的难题。</p>
<hr/>
<h3 data-id="heading-3">巅峰对决：CV 损失的“致命漏洞”</h3>
<p>表面上看，CV 损失（策略一）更简单、更高效。为什么 Mixtral 反而选择了更复杂的 Switch 损失（策略二）呢？</p>
<p><strong>因为 CV 损失可以被 Gating 网络“欺骗”。</strong></p>
<p>CV 损失平衡的是“概率总和”，而不是“实际工作”。让我们来看一个 Gating 网络“作弊”的场景：</p>
<blockquote>
<p><strong>作弊场景 (Top-K=1, N=2)：</strong></p>
<p>假设 Gating 网络决定“作弊”：</p>
<ul>
<li>它将 <strong>1000 个 Token</strong> 路由给<strong>专家 1</strong>，但每次只给 <strong>0.1</strong> 的低概率。</li>
<li>它将 <strong>100 个 Token</strong> 路由给<strong>专家 2</strong>，但每次都给 <strong>1.0</strong> 的高概率。</li>
</ul>
<p><strong>1. CV 损失（策略一）如何看待：</strong></p>
<ul>
<li>专家 1 的“总重要性”： <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mo>×</mo><mn>0.1</mn><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">1000 \times 0.1 = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1000</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">100</span></span></span></span></span></li>
<li>专家 2 的“总重要性”： <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>×</mo><mn>1.0</mn><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">100 \times 1.0 = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">100</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Importance</mtext></mrow><annotation encoding="application/x-tex">\text{Importance}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">Importance</span></span></span></span></span></span> 向量 = <code>[100, 100]</code></li>
<li><strong>CV = 0！损失 = 0！</strong></li>
<li><strong>结论：</strong> CV 损失认为这是“完美均衡”。</li>
</ul>
<p><strong>2. 实际 GPU 上的情况：</strong></p>
<ul>
<li>专家 1（GPU 1）被激活了 <strong>1000 次</strong>。</li>
<li>专家 2（GPU 2）被激活了 <strong>100 次</strong>。</li>
<li><strong>结论：</strong> 负载<strong>极度不均衡</strong>！GPU 1 过劳，GPU 2 摸鱼。</li>
</ul>
</blockquote>
<p>CV 损失被 Gating 网络的“花言巧语”（概率）所蒙蔽，而没有看到“实际工作”的分配。</p>
<p><strong>Switch 损失（策略二）如何看待：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">f_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (实际工作量) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>0.91</mn></mrow><annotation encoding="application/x-tex">\approx 0.91</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.91</span></span></span></span></span> (91% 的 Token 去了 1 号)</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">f_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (实际工作量) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>0.09</mn></mrow><annotation encoding="application/x-tex">\approx 0.09</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.09</span></span></span></span></span> (9% 的 Token 去了 2 号)</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">P_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (平均概率) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>0.1</mn></mrow><annotation encoding="application/x-tex">\approx 0.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.1</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">P_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (平均概率) <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mn>1.0</mn></mrow><annotation encoding="application/x-tex">\approx 1.0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.0</span></span></span></span></span></li>
</ul>
<p>Switch 损失会发现 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 向量 (<code>[0.91, 0.09]</code>) 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 向量 (<code>[0.1, 1.0]</code>) 都极度不均衡，它们的点积（损失）会<strong>非常高</strong>，从而产生一个巨大的“惩罚”信号，迫使 Gating 网络停止这种“作弊”行为。</p>
<hr/>
<h3 data-id="heading-4">对比总结：为何“实用”胜过“优雅”？</h3>








































<table><thead><tr><th><strong>特性</strong></th><th><strong>策略一 (CV Loss / GShard)</strong></th><th><strong>策略二 (Switch Loss / Mixtral)</strong></th></tr></thead><tbody><tr><td><strong>核心理念</strong></td><td>统计主义：平衡“总概率”</td><td>实用主义：平衡“实际工作”</td></tr><tr><td><strong>平衡对象</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (概率/意向)</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (意向) <strong>和</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (实际工作量)</td></tr><tr><td><strong>计算开销</strong></td><td>理论上更低（1 次 AllReduce）</td><td>略高（2 次 AllReduce）</td></tr><tr><td><strong>鲁棒性</strong></td><td><strong>低</strong>。可被 Gating“欺骗”</td><td><strong>高</strong>。能捕捉到“实际负载”的不均</td></tr><tr><td><strong>主要用户</strong></td><td>早期 Google MoE 研究</td><td><strong>Mixtral</strong>、Switch Transformer</td></tr><tr><td><strong>额外优势</strong></td><td>无</td><td>巧妙地利用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 解决了 Top-K 的“不可微分”问题</td></tr></tbody></table>
<h4 data-id="heading-5">最后的赢家：Switch 损失的“一箭双雕”</h4>
<p>Switch 损失（策略二）的胜利不仅在于它更鲁棒，还在于它的设计是“一箭双雕”。</p>
<p>我们之前讨论过，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（实际工作量）来自 Top-K 硬决策，它本身是<strong>不可微分</strong>的（梯度无法回传）。</p>
<p>而 Switch 损失 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub><mo>=</mo><mi>N</mi><mo>⋅</mo><mo>∑</mo><mo stretchy="false">(</mo><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L_{\text{balance}} = N \cdot \sum (f_i \cdot P_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 在反向传播时，被设计为**“绕过”**了这个障碍。它将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 视为一个“常数”，梯度只通过 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 回传（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∇</mi><mi>L</mi><mo>∝</mo><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><mi mathvariant="normal">∇</mi><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\nabla L \propto f_i \cdot \nabla P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">∇</span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord">∇</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）。</p>
<p>这意味着：</p>
<ol>
<li>它利用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 来<strong>实现负载均衡</strong>。</li>
<li>它利用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 作为“权重”，为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 这条<strong>可微分路径</strong>提供了梯度。</li>
</ol>
<p>结论：</p>
<p>CV 损失是一个“优雅”的数学公式，它试图平衡一个“代理指标”（概率），但最终失败了。</p>
<p>Switch 损失是一个“实用”的工程方案，它看起来更复杂，但它牢牢抓住了**“平衡实际 GPU 计算量”**这个核心目标，并顺便解决了梯度难题。</p>
<p>在构建强大、高效、可靠的 MoE 模型时，选择一个能“看穿谎言”的损失函数至关重要。在这场对决中，Mixtral 所代表的“实用主义”显然赢得了胜利。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[揭秘 MoE 训练的“三驾马车”]]></title>    <link>https://juejin.cn/post/7572010680896782376</link>    <guid>https://juejin.cn/post/7572010680896782376</guid>    <pubDate>2025-11-13T12:42:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896782376" data-draft-id="7572010680896765992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="揭秘 MoE 训练的“三驾马车”"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-13T12:42:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            揭秘 MoE 训练的“三驾马车”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:42:56.000Z" title="Thu Nov 13 2025 12:42:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">揭秘 MoE 训练的“三驾马车”：一篇博客看懂 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></h2>
<p>在混合专家模型（MoE）的宏伟蓝图中，我们惊叹于它如何用“稀疏激活”撬动万亿参数，实现了前所未有的性能和效率。但一个鲜为人知的事实是：<strong>训练 MoE 模型是一场极其精妙的“多目标优化”</strong> 。</p>
<p>仅仅告诉模型“你要预测准确”（即最小化主损失 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）是远远不够的。这样做，你的 Gating 网络（分诊台）会迅速“偷懒”或“崩溃”。</p>
<p>为了“驯服” Gating 网络，使其高效、公平、稳定地工作，我们必须引入另外两个“辅助损失函数”。它们与主损失一起，构成了 MoE 训练的“三驾马车”。</p>
<p>今天，我们将深入探讨这三大损失各自的使命，以及它们如何协同作战。</p>
<hr/>
<h3 data-id="heading-1">一号马车：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (主损失) —— “前进的方向”</h3>
<p>这是最简单、最核心的损失。</p>
<ul>
<li><strong>目标：</strong> 任务性能。</li>
<li><strong>公式：</strong> 通常是“交叉熵损失” (Cross-Entropy Loss)。</li>
<li><strong>它告诉模型：</strong> “<strong>你的最终答案必须是正确的！</strong> ”</li>
</ul>
<p>无论架构多复杂，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 始终是拉动整个模型向“更智能”方向前进的核心驱动力。但只有它，Gating 网络会“野蛮生长”，导致以下两个核心问题。</p>
<hr/>
<h3 data-id="heading-2">二号马车：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (负载均衡损失) —— “公平与效率”</h3>
<p><strong>问题：</strong> Gating 网络会“偷懒”，发现有几个专家特别“聪明”，然后把所有任务都交给它们。这导致“明星专家”过劳，“摸鱼专家”完全得不到训练，白白浪费了模型容量。</p>
<p><strong>目标：</strong> 强制 Gating 网络“雨露均沾”，确保工作负载被<em>公平地</em>分配给所有专家。</p>
<ul>
<li><strong>它告诉 Gating 网络：</strong> “<strong>你必须把工作公平地分配给所有人，不许有明星和摸鱼！</strong> ”</li>
</ul>
<p>我们之前详细对比了两种实现方式，其中“Switch 损失”因其鲁棒性而成为现代 MoE（如 Mixtral）的首选。</p>
<h5 data-id="heading-3">1. 策略一（已过时）：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>CV</mtext><mo stretchy="false">(</mo><mo>…</mo><mtext> </mtext><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\text{CV}(\dots)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">CV</span></span><span class="mopen">(</span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 损失 (GShard)</h5>
<ul>
<li><strong>理念：</strong> “统计主义”。平衡 Gating 网络的“总概率”（即“意向”）。</li>
<li><strong>漏洞：</strong> 它可以被 Gating 网络“欺骗”。Gating 可以给 1000 个 Token 0.1 的概率（总和 100），给 100 个 Token 1.0 的概率（总和 100）。CV 损失认为这很“均衡”，但<em>实际工作量</em>却是 1000 vs 100，极不均衡。</li>
</ul>
<h5 data-id="heading-4">2. 策略二（当前主流）：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 损失 (Switch / Mixtral)</h5>
<ul>
<li><strong>理念：</strong> “实用主义”。<strong>同时</strong>平衡“实际工作量” (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 和“路由信心” (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)。</li>
<li><strong>优势：</strong> 它能完美捕捉到上述“作弊”行为。由于它直接惩罚“实际工作量” (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">f_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 的不均衡，Gating 网络无法“撒谎”，必须老老实实地将 Token <em>真正地</em>平均分配到不同的 GPU（专家）上。</li>
</ul>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 确保了 MoE 模型的“效率”和“容量”能被充分利用。但它只解决了“公平”，没有解决“稳定”。</p>
<hr/>
<h3 data-id="heading-5">三号马车：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (z-损失) —— “稳定与克制”</h3>
<p><strong>问题：</strong> 即使 Gating 网络学会了“公平”，它也可能在训练中变得“过度自信”。它可能会输出<em>极大</em>的原始分数（Logits），比如 <code>[50, 1, -10, ...]</code>。</p>
<p><strong>为什么“大分数”是坏事？</strong></p>
<ol>
<li><strong>数值不稳定：</strong> 极大的 Logits 会导致梯度爆炸或消失，让训练过程（尤其是使用 16 位浮点数时）非常不稳定。</li>
<li><strong>过早收敛：</strong> Gating 过早地“焊死”了它的路由决策，丧失了“探索”其他专家组合的灵活性，导致模型陷入局部最优。</li>
</ol>
<p><strong>目标：</strong> 正则化。防止 Gating 网络输出的 Logits 数值过大。</p>
<ul>
<li><strong>它告诉 Gating 网络：</strong> “<strong>你可以有偏好，但你不许过度自信！把你的分数（Logits）保持在 0 附近！</strong> ”</li>
</ul>
<p>核心公式（简化版）：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub><mo>∝</mo><msub><mo>∑</mo><mtext>batch</mtext></msub><msup><mrow><mo fence="true">(</mo><mtext>LogSumExp</mtext><mo stretchy="false">(</mo><mtext>Top-K Logits</mtext><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L_{\text{router-z}} \propto \sum_{\text{batch}} \left( \text{LogSumExp}(\text{Top-K Logits}) \right)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2537em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">batch</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord text"><span class="mord">LogSumExp</span></span><span class="mopen">(</span><span class="mord text"><span class="mord">Top-K Logits</span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.954em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>工作原理：</strong></p>
<ul>
<li><strong>LogSumExp (LSE)</strong> 是一个“平滑的最大值”函数。当 Logits 很大时（例如 <code>[50, 1]</code>），LSE 的结果也会非常大（约等于 50）。</li>
<li>这个损失函数的目标是<strong>最小化 LSE 的平方</strong>。</li>
<li>因此，每当 Gating 网络试图输出一个很大的 Logit（如 50），<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就会产生一个<strong>巨大的惩罚</strong>，迫使 Gating 网络把这个值“拉回”到更小的、接近 0 的范围（比如 <code>[1.5, 0.5]</code>）。</li>
</ul>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就像一个“缰绳”，防止 Gating 网络这匹马（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）在“公平”的道路上跑得太快而“失控”。</p>
<hr/>
<h3 data-id="heading-6">总结：三驾马车的协同作战</h3>
<p>MoE 模型的最终训练，就是一场精妙的“多目标优化”。工程师需要通过超参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> 来平衡这三驾马车：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>Total</mtext></msub><mo>=</mo><msub><mi>L</mi><mtext>main</mtext></msub><mo>+</mo><mi>α</mi><mo>⋅</mo><msub><mi>L</mi><mtext>balance</mtext></msub><mo>+</mo><mi>β</mi><mo>⋅</mo><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{Total}} = L_{\text{main}} + \alpha \cdot L_{\text{balance}} + \beta \cdot L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Total</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4445em;"/><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<ol>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>main</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{main}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">main</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (主损失)</strong> ：拉动马车向着“正确答案”前进。（<strong>性能</strong>）</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>balance</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{balance}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">balance</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (负载均衡)</strong> ：确保所有拉车的马（专家）都在平均用力，没有马“摸鱼”。（<strong>效率</strong>）</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mtext>router-z</mtext></msub></mrow><annotation encoding="application/x-tex">L_{\text{router-z}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">router-z</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> (z-损失)</strong> ：确保 Gating 网络（车夫）在挥鞭子（路由）时保持“冷静”和“克制”，防止马车失控。（<strong>稳定</strong>）</li>
</ol>
<p>只有当这三股力量达到完美的和谐与平衡时，MoE 这个庞大、复杂而又强大的模型，才能被成功地“驯服”，发挥出它的全部潜力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从逻辑到直觉，我的疑难问题方法论]]></title>    <link>https://juejin.cn/post/7572010680896864296</link>    <guid>https://juejin.cn/post/7572010680896864296</guid>    <pubDate>2025-11-13T12:56:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896864296" data-draft-id="7572020278387032098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从逻辑到直觉，我的疑难问题方法论"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-13T12:56:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码农胖大海"/> <meta itemprop="url" content="https://juejin.cn/user/4195392102086967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从逻辑到直觉，我的疑难问题方法论
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4195392102086967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码农胖大海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:56:31.000Z" title="Thu Nov 13 2025 12:56:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>解决疑难问题是一场心智的马拉松，是科学、艺术与经验的结合。</p>
</blockquote>
<h2 data-id="heading-0">一、前言</h2>
<p>笔者从事前端开发已逾十年，其中近半时间深耕于前端基础设施团队，专注技术支撑工作。</p>
<p>在日常工作中，我发现无论是团队内部还是业务侧的同学，在排查复杂、疑难问题时，常常陷入思维混乱、在错误的方向上反复试探，最终耗费大量时间却徒劳无功的困境。</p>
<p>所幸，因岗位性质所致，我亲身经历并解决过的各类“疑难杂症”可谓数不胜数。基于这些宝贵的实战经验，我系统地总结了一套问题定位与解决的方法论。旨在帮助你在面对复杂问题时，能快速理清头绪、找准方向，从容、高效地解决问题。</p>
<h2 data-id="heading-1">二、共识</h2>
<p>在开始之前，我们必须达成一项核心共识：解决复杂问题，本质上是一场严密的逻辑推理。 唯有坚守逻辑，才能跳出思维混乱的泥潭，避免在错误的方向上反复打转。</p>
<p>逻辑是一个抽象的概念，为避免歧义，我首先阐明自己对它的认识与理解。仅以此为共识基础，你需要在长期分析问题的过程中构建、践行自己的“逻辑”。</p>
<ol>
<li>逻辑，是严谨的因果链
<ul>
<li>它要求我们就像侦探一样，基于线索提出假设，并通过实验快速验证，继而用环环相扣、确凿的证据，构建坚实的推理链条，最终得到“真相”这个答案。</li>
</ul>
</li>
<li>逻辑，是科学的论证方法
<ul>
<li>就像控制变量法，在其他条件完全一致时，结果的改变才能唯一地归因于那个被改变的变量。这是构建有效逻辑的基石。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-2">三、实践</h2>
<p>下面这几条，已经刻进我的DNA里，成了遇到问题后的条件反射。你可以把它看作一个排查流程，但不必死板照搬，关键是形成这种思维习惯。</p>
<ol>
<li>
<p>先彻底搞懂问题</p>
<ul>
<li>花足够的时间，把问题的现象、发生的场景、稳定的复现步骤搞清楚后再行动。</li>
<li>千万不要犯经验主义错误，才听一两句描述就自动联想为某个已知问题，盲目下手。</li>
</ul>
</li>
<li>
<p>依靠直觉快速验证</p>
<ul>
<li>没错，解决问题最快的方式就是依靠直觉。依靠你多年积累的经验、对系统的熟悉度。觉得“这儿可能有问题”或者“跟上次那个Bug很像”，就立刻去验证或者直接上解决方案。这是最效率的做法。</li>
<li>经验主义”在这里上大分，但千万不要思维定式，如果验证下来不对，果断止损，下一步。</li>
</ul>
</li>
<li>
<p>搜搜看，常有意外之喜</p>
<ul>
<li>你遇到的难题，很可能已被千万程序员踩过一遍。去搜索引擎、去技术社区、去官方Issues里找找看，说不定有惊喜。</li>
<li>工具方面推荐：搜索引擎（如必应、AI问答）、技术社区（如掘金、知乎）、官方渠道（MDN、GitHub Issues）。至于百度与CSDN……珍爱生命，尽早远离。</li>
</ul>
</li>
<li>
<p>展现真正的技术：删、比、问</p>
<ul>
<li>删。通过删除/注释代码，不断缩小问题出现的范围；或者通过编写最简Demo，找到最小复现条件。</li>
<li>比。对比正常与异常场景，从环境、网络、账号、依赖到代码逻辑逐一比较，差异点往往就是破案关键线索。 </li>
<li>问。把清晰的复现步骤和关键代码喂给AI，它有时能提供意想不到的分析视角。</li>
</ul>
</li>
<li>
<p>做好复盘，沉淀为直觉</p>
<ul>
<li>问题解决后，及时记录总结，构建个人案例库。这正是你未来“直觉”的来源。</li>
<li>《程序员的思维修炼》把这种依靠“直觉”解决问题的能力，作为区分专家与学徒的关键。</li>
<li>记录至少应包括：问题现象、原因分析、解决方案、复盘改进。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-3">四、感悟</h2>
<ol>
<li>
<p>及时求助</p>
<ul>
<li>
<p>每个人都有自身局限性，你不可能解决所有问题。及时向同事或更资深的人求助，没什么难为情的。</p>
</li>
<li>
<p>寻求帮助前做好功课，并不会降低别人对你的评价</p>
</li>
<li>
<p>功课的内容至少包含，问题的现象、自己已经做的分析猜测以及尝试，最好有个文档</p>
</li>
</ul>
</li>
<li>
<p>沟通与商务，也是解决方案</p>
<ul>
<li>不是所有问题都需要用技术硬解。有些问题在技术层面解决成本极高，或者本身就是由沟通误解、商务限制引起的。此时，推动沟通或调整需求，往往是更优解。</li>
</ul>
</li>
<li>
<p>最后，所有的方法都只是技巧，高效、正确的解决问题根本上还依赖技术和经验的长期积累。与君共勉，加油！</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端高频面试题之Vue（高级篇）]]></title>    <link>https://juejin.cn/post/7571972751529017380</link>    <guid>https://juejin.cn/post/7571972751529017380</guid>    <pubDate>2025-11-13T13:00:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571972751529017380" data-draft-id="7571815573933801535" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端高频面试题之Vue（高级篇）"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2025-11-13T13:00:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小寒"/> <meta itemprop="url" content="https://juejin.cn/user/694547078987287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端高频面试题之Vue（高级篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547078987287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T13:00:21.000Z" title="Thu Nov 13 2025 13:00:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、说一下 Vue.js 的响应式原理</h2>
<h3 data-id="heading-1">1.1 Vue2 响应式原理</h3>
<p>核心原理就是通过 <code>Object.defineProperty</code> 对对象属性进行劫持，重新定义对象的 <code>getter</code> 和 <code>setter</code>，在 <code>getter</code> 取值时收集依赖，在 <code>setter</code> 修改值时触发依赖更新，更新页面。</p>
<p>Vue2 对数组和对象做了两种不同方式的处理。</p>
<p><strong>监听对象变化：</strong></p>
<p>针对对象来说，Vue 会循环遍历对象的每一个属性，用 defineReactive 重新定义 <code>getter</code> 和 <code>setter</code>。</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">target,key,value</span>){
    <span class="hljs-title function_">observer</span>(value);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target,key,{ ¸v
        <span class="hljs-title function_">get</span>(<span class="hljs-params"/>){
            <span class="hljs-comment">// ... 收集依赖逻辑</span>
            <span class="hljs-keyword">return</span> value;
        },
        <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>){
            <span class="hljs-keyword">if</span> (value !== newValue) {
                value = newValue;
                <span class="hljs-title function_">observer</span>(newValue) <span class="hljs-comment">// 把新设置的值包装成响应式</span>
            }
            <span class="hljs-comment">// ...触发依赖更新逻辑</span>
        }
    })
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observer</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> data !== <span class="hljs-string">'object'</span>){
        <span class="hljs-keyword">return</span> data
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> data){
        <span class="hljs-title function_">defineReactive</span>(data,key,data[key]);
    }
}
</code></pre>
<p><strong>监听数组变化：</strong></p>
<p>我们都知道，数组其实也是对象，同样可以用 <code>Object.defineProperty</code> 劫持数组的每一项，但如果数组有100万项，那就要调用 <code>Object.defineProperty</code> 一百万次，这样的话性能太低了。鉴于平时我们操作数组大都是采用数组提供的原生方法，于是 Vue 对数组重写原型链，在调用7个能改变自身的原生方法(<code>push</code>，<code>pop</code>，<code>shift</code>，<code>unshift</code>，<code>splice</code>，<code>sort</code>，<code>reverse</code>)时，通知页面进行刷新，具体实现过程如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 先拿到数组的原型</span>
<span class="hljs-keyword">const</span> oldArrayProtoMethods = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-comment">// 用Object.create创建一个以oldArrayProtoMethods为原型的对象</span>
<span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(oldArrayProtoMethods)
<span class="hljs-keyword">const</span> methods = [
    <span class="hljs-string">'push'</span>,
    <span class="hljs-string">'pop'</span>,
    <span class="hljs-string">'shift'</span>,
    <span class="hljs-string">'unshift'</span>,
    <span class="hljs-string">'sort'</span>,
    <span class="hljs-string">'reverse'</span>,
    <span class="hljs-string">'splice'</span>
]
methods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
    <span class="hljs-comment">// 给arrayMethods定义7个方法</span>
    arrayMethods[method] = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>){
        <span class="hljs-comment">// 先找到数组对应的原生方法进行调用</span>
        <span class="hljs-keyword">const</span> result = oldArrayProtoMethods[method].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
        <span class="hljs-comment">// 声明inserted，用来保存数组新增的数据</span>
        <span class="hljs-keyword">let</span> inserted
        <span class="hljs-comment">// __ob__是Observer类实例的一个属性，data中的每个对象都是一个Observer类的实例</span>
        <span class="hljs-keyword">const</span> ob = <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>
        <span class="hljs-keyword">switch</span>(method) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">'push'</span>:
            <span class="hljs-keyword">case</span> <span class="hljs-string">'unshift'</span>:
                inserted = args
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">'splice'</span>:
                inserted = args.<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>)
            <span class="hljs-attr">default</span>:
                <span class="hljs-keyword">break</span>
        }
        <span class="hljs-comment">// 比如有新增的数据，新增数据也要被定义为响应式</span>
        <span class="hljs-keyword">if</span>(inserted) ob.<span class="hljs-title function_">observeArray</span>(inserted)
        <span class="hljs-comment">// 通知页面更新</span>
        ob.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
        <span class="hljs-keyword">return</span> result
    }
})
</code></pre>
<p><strong>Object.defineProperty的缺点：</strong></p>
<ol>
<li>无法监听新增属性和删除属性的变化，需要通过 <code>$set</code>、<code>$delete</code> 实现。</li>
<li>监测数组的索引性能太低，故而直接通过数组索引改值无法触发响应式。</li>
<li>初始化时需要一次性递归调用，性能较差。</li>
</ol>
<h3 data-id="heading-2">1.2 Vue3 的响应式改进</h3>
<p>Vue3 采用 <code>Proxy + Reflect</code> 配合实现响应式。能解决上述 <code>Object.defineProperty</code> 的所有缺陷，唯一缺点就是兼容性没有 <code>Object.defineProperty</code> 好。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> handler = {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> target[key] === <span class="hljs-string">"object"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target[key], handler);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, key);
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, key, value</span>) {
    <span class="hljs-keyword">let</span> oldValue = target[key];
    <span class="hljs-keyword">if</span> (oldValue !== value) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(target, key, value);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },
};
<span class="hljs-keyword">let</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, handler);
</code></pre>
<h2 data-id="heading-3">2、介绍一下 Vue 中的 diff 算法？</h2>
<p>Vue 的 diff 算法是平级比较，不考虑跨级比较的情况。内部采用<strong>深度递归的方式 + 双指针</strong>的方式进行比较。</p>
<p><strong>比较过程:</strong></p>
<ol>
<li>先比较是否是相同节点。</li>
<li>相同节点比较属性,并复用老节点。</li>
<li>比较儿子节点，考虑老节点和新节点儿子的情况。</li>
<li>优化比较：头头、尾尾、头尾、尾头。</li>
<li>比对查找进行复用。</li>
</ol>
<p>Vue3 在这个比较过程的基础上增加了<strong>最长递增子序列</strong>实现diff算法。</p>
<ul>
<li>找出不需要移动的现有节点。</li>
<li>只对需要移动的节点进行操作。</li>
<li>最小化 DOM 操作次数。</li>
</ul>
<h2 data-id="heading-4">3、Vue 的模板编译原理是什么？</h2>
<p>Vue 中的模板编译就是把我们写的 <code>template</code> 转换为渲染函数(<code>render function</code>) 的过程，它主要经历3个步骤：</p>
<ol>
<li><strong>解析（Parse）</strong>：将 template 模板转换成 ast 抽象语法树。</li>
<li><strong>优化（Optimize）</strong>：对静态节点做静态标记，减少 diff 过程中的比对。</li>
<li><strong>生成（Generate）</strong>：重新生成代码，将 ast 抽象语法数转化成可执行的渲染函数代码。</li>
</ol>
<h3 data-id="heading-5">3.1 解析阶段</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>用 HTML 解析器将模板解析为 AST。</li>
<li>AST中用 js 对象描述模板，里面包含了元素类型、属性、子节点等信息。</li>
<li>解析指令（<code>v-for、v-if</code>）和事件（<code>@click</code>）、插值表达式<code>{{}}</code>等 vue 语法。</li>
</ul>
<h3 data-id="heading-6">3.2 优化阶段</h3>
<ul>
<li>遍历上一步生成的 ast，标记静态节点，比如用 <code>v-once</code> 的节点，以及没有用到响应式数据的节点。</li>
<li>标记静态根节点，避免不必要的渲染。</li>
</ul>
<h3 data-id="heading-7">3.3 代码生成阶段</h3>
<p>vue2 解析结果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">with</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, {
      <span class="hljs-attr">attrs</span>: {
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"app"</span>
      }
    }, [<span class="hljs-title function_">_c</span>(<span class="hljs-string">'p'</span>, [<span class="hljs-title function_">_v</span>(<span class="hljs-title function_">_s</span>(message))])])
  }
}
</code></pre>
<ul>
<li><code>_c</code>: 是 createElement 的别名，用于创建 VNode。</li>
<li><code>_v</code>: 创建文本 VNode。</li>
<li><code>_s</code>: 是 toString 的别名，用于将值转换为字符串。</li>
</ul>
<p>vue3 解析结果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { toDisplayString <span class="hljs-keyword">as</span> _toDisplayString, createElementVNode <span class="hljs-keyword">as</span> _createElementVNode, openBlock <span class="hljs-keyword">as</span> _openBlock, createElementBlock <span class="hljs-keyword">as</span> _createElementBlock } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {
  <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"div"</span>, { <span class="hljs-attr">id</span>: <span class="hljs-string">"app"</span> }, [
    <span class="hljs-title function_">_createElementVNode</span>(<span class="hljs-string">"p"</span>, <span class="hljs-literal">null</span>, <span class="hljs-title function_">_toDisplayString</span>(_ctx.<span class="hljs-property">message</span>), <span class="hljs-number">1</span> <span class="hljs-comment">/* TEXT */</span>)
  ]))
}
</code></pre>
<ul>
<li><code>_openBlock</code>: 开启一个"block"区域，用于收集动态子节点。</li>
<li><code>_createElementBlock</code>: 创建一个块级虚拟 DOM 节点。</li>
<li><code>_createElementVNode</code>: 创建一个普通虚拟 DOM 节点。</li>
<li><code>_toDisplayString</code>: 将响应式数据 _ctx.message 转换为显示字符串，或者处理 null/undefined 等值，确保它们能正确渲染为空白字符串。</li>
</ul>
<p>vue2在线编译：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftemplate-explorer.vuejs.org%2F" target="_blank" title="https://template-explorer.vuejs.org/" ref="nofollow noopener noreferrer">template-explorer.vuejs.org/</a>。</p>
<p>vue3在线编译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.template-explorer.vuejs.org%2F" target="_blank" title="https://v2.template-explorer.vuejs.org/" ref="nofollow noopener noreferrer">v2.template-explorer.vuejs.org/</a>。</p>
<p><strong>运行时+编译(runtime-compiler) vs 仅运行时(runtime-only)：</strong></p>
<ol>
<li>完整版（运行时+编译）：
<ul>
<li>包含编译模块，可以写 template 模版。</li>
<li>体积较大（～30kb）。</li>
</ul>
</li>
<li>仅运行时版本
<ul>
<li>需要在打包时使用 <code>vue-loader</code> 进行编译。</li>
<li>体积较小（～20kb）。</li>
</ul>
</li>
</ol>
<p>平时开发项目推荐使用仅运行时(runtime-only)版本。</p>
<p><strong>编译后的特点：</strong></p>
<ol>
<li><strong>虚拟DOM</strong>：渲染函数生成的是虚拟DOM节点(VNode)。</li>
<li><strong>响应式绑定</strong>：渲染函数中的变量会自动建立依赖关系。</li>
<li><strong>性能优化</strong>：通过静态节点标记减少不必要的更新。</li>
</ol>
<h2 data-id="heading-8">4、v-show 和 v-if 的原理</h2>
<p>简单来说，<code>v-if</code> 内部是通过一个三元表达式来实现的，而 <code>v-show</code> 则是通过控制 DOM 元素的 <code>display</code> 属性来实现的。</p>
<p>v-if 源码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">genIfConditions</span> (
    <span class="hljs-attr">conditions</span>: <span class="hljs-title class_">ASTIfConditions</span>,
    <span class="hljs-attr">state</span>: <span class="hljs-title class_">CodegenState</span>,
    altGen?: <span class="hljs-title class_">Function</span>,
    altEmpty?: string
    ): string {
    <span class="hljs-keyword">if</span> (!conditions.<span class="hljs-property">length</span>) {
        <span class="hljs-keyword">return</span> altEmpty || <span class="hljs-string">'_e()'</span>
    }
    <span class="hljs-keyword">const</span> condition = conditions.<span class="hljs-title function_">shift</span>()
    <span class="hljs-keyword">if</span> (condition.<span class="hljs-property">exp</span>) {   <span class="hljs-comment">// 如果有表达式</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">`(<span class="hljs-subst">${condition.exp}</span>)?<span class="hljs-subst">${ // 将表达式作为条件拼接成元素
        genTernaryExp(condition.block)
        }</span>:<span class="hljs-subst">${
        genIfConditions(conditions, state, altGen, altEmpty)
        }</span>`</span>
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${genTernaryExp(condition.block)}</span>`</span> <span class="hljs-comment">// 没有表达式直接生成元素 像v-else</span>
    }

    <span class="hljs-comment">// v-if with v-once should generate code like (a)?_m(0):_m(1)</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">genTernaryExp</span> (el) {
        <span class="hljs-keyword">return</span> altGen
        ? <span class="hljs-title function_">altGen</span>(el, state)
        : el.<span class="hljs-property">once</span>
            ? <span class="hljs-title function_">genOnce</span>(el, state)
            : <span class="hljs-title function_">genElement</span>(el, state)
    }
}
</code></pre>
<p>v-show 源码：</p>
<pre><code class="hljs language-js" lang="js">{
    bind (<span class="hljs-attr">el</span>: any, { value }: <span class="hljs-title class_">VNodeDirective</span>, <span class="hljs-attr">vnode</span>: <span class="hljs-title class_">VNodeWithData</span>) {
    <span class="hljs-keyword">const</span> originalDisplay = el.<span class="hljs-property">__vOriginalDisplay</span> =
        el.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span> ? <span class="hljs-string">''</span> : el.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> <span class="hljs-comment">// 获取原始显示值</span>
        el.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = value ? originalDisplay : <span class="hljs-string">'none'</span> <span class="hljs-comment">// 根据属性控制显示或者隐藏</span>
    }  
} 
</code></pre>
<h2 data-id="heading-9">5、v-if 和 v-for  哪个优先级更高？为什么？</h2>
<ul>
<li>vue2 中 <code>v-for</code> 的优先级比 <code>v-if</code> 高，它们作用于一个节点上会导致先循环后对每一项进行判断，浪费性能。</li>
<li>vue3 中 <code>v-if</code> 的优先级比 <code>v-for</code> 高，这就会导致 <code>v-if</code> 中的条件无法访问 <code>v-for</code> 作用域名中定义的变量别名。</li>
</ul>
<pre><code class="hljs language-vue" lang="vue">&lt;li v-for="item in arr" v-if="item.visible"&gt;
  {{ item}}
&lt;/li&gt;
</code></pre>
<p>以上代码在 <code>vue3</code> 的编译结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { renderList <span class="hljs-keyword">as</span> _renderList, <span class="hljs-title class_">Fragment</span> <span class="hljs-keyword">as</span> _Fragment, openBlock <span class="hljs-keyword">as</span> _openBlock, createElementBlock <span class="hljs-keyword">as</span> _createElementBlock, toDisplayString <span class="hljs-keyword">as</span> _toDisplayString, createCommentVNode <span class="hljs-keyword">as</span> _createCommentVNode } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">_ctx, _cache, $props, $setup, $data, $options</span>) {
  <span class="hljs-keyword">return</span> (_ctx.<span class="hljs-property">item</span>.<span class="hljs-property">visible</span>)
    ? (<span class="hljs-title function_">_openBlock</span>(<span class="hljs-literal">true</span>), <span class="hljs-title function_">_createElementBlock</span>(_Fragment, { <span class="hljs-attr">key</span>: <span class="hljs-number">0</span> }, <span class="hljs-title function_">_renderList</span>(_ctx.<span class="hljs-property">arr</span>, <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-title function_">_openBlock</span>(), <span class="hljs-title function_">_createElementBlock</span>(<span class="hljs-string">"li"</span>, <span class="hljs-literal">null</span>, <span class="hljs-title function_">_toDisplayString</span>(item), <span class="hljs-number">1</span> <span class="hljs-comment">/* TEXT */</span>))
      }), <span class="hljs-number">256</span> <span class="hljs-comment">/* UNKEYED_FRAGMENT */</span>))
    : <span class="hljs-title function_">_createCommentVNode</span>(<span class="hljs-string">"v-if"</span>, <span class="hljs-literal">true</span>)
}
</code></pre>
<p>可以看出 <code>vue3</code> 在编译时会先判断 <code>v-if</code>，然后再走 <code>v-for</code> 的循环，所以在 <code>v-if</code> 中自然就无法访问 <code>v-for</code> 作用域名中定义的变量别名。</p>
<p>这样的写法在 vue3 中会抛出一个警告⚠️，<code>[Vue warn]: Property "item" was accessed during render but is not defined on instance</code>，导致渲染失败。</p>
<p>以上代码在 <code>vue2</code> 还不能直接编译，因为 <code>vue2</code> 的组件需要一个根节点，所以我们在外层加一个 <code>div</code>：</p>
<pre><code class="hljs language-js" lang="js">&lt;div&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in arr"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"item.visible"</span>&gt;</span>
    {{ item}}
  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
&lt;/div&gt;
</code></pre>
<p>其编译结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">with</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, <span class="hljs-title function_">_l</span>((arr), <span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) {
      <span class="hljs-keyword">return</span> (item.<span class="hljs-property">visible</span>) ? <span class="hljs-title function_">_c</span>(<span class="hljs-string">'li'</span>, [<span class="hljs-title function_">_v</span>(<span class="hljs-string">"\n    "</span> + <span class="hljs-title function_">_s</span>(item) + <span class="hljs-string">"\n  "</span>)]) :
        <span class="hljs-title function_">_e</span>()
    }), <span class="hljs-number">0</span>)
  }
}
</code></pre>
<p>很明显是先循环 <code>arr</code>，然后每一项再用 <code>item.visible</code> 去判断的，也印证了在 <code>vue2</code> 中， <code>v-for</code> 的优先级高于 <code>v-if</code>。</p>
<blockquote>
<p>所以不管是 <code>vue2</code> 还是 <code>vue3</code>，都不推荐同时使用 <code>v-if</code> 和 <code>v-for</code>，更好的方案是采用计算属性，或者在外层再包裹一个容器元素，将 <code>v-if</code> 作用在容器元素上。</p>
</blockquote>
<h2 data-id="heading-10">6、nextTick 的原理是什么？</h2>
<h3 data-id="heading-11">6.1 Vue2 的 nextTick：</h3>
<ul>
<li>首选微任务：
<ul>
<li><strong>Promise.resolve().then(flushCallbacks)</strong>：最常见，使用 Promise 创建微任务。</li>
<li><strong>MutationObserver</strong>：如果 Promise 不可用，创建一个文本节点，修改其内容触发 MutationObserver 的观察器回调。</li>
</ul>
</li>
<li>回退宏任务：
<ul>
<li><strong>setImmediate</strong>：如果环境支持 setImmediate，比如 node 环境，则会优先使用 setImmediate 。</li>
<li><strong>setTimeout(flushCallbacks, 0)</strong>：最后使用定时器。</li>
</ul>
</li>
</ul>
<p>这里体现了<strong>优雅降级</strong>的思想。</p>
<h3 data-id="heading-12">6.2 Vue3 的 nextTick：</h3>
<ul>
<li>由于 Vue3 不再考虑 promise 的兼容性，所以 nextTick 的实现原理就是 promise.then 方法。</li>
</ul>
<h2 data-id="heading-13">7、Vue.set 方法是如何实现的?</h2>
<p><strong>Vue2的实现</strong>：在 Vue 2 中，Vue.set 的实现主要位于 <code>src/core/observer/index.js</code> 中：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">set</span> (<span class="hljs-attr">target</span>: <span class="hljs-title class_">Array</span> | <span class="hljs-title class_">Object</span>, <span class="hljs-attr">key</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">val</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">any</span> {
    <span class="hljs-comment">// 1.如果是数组 Vue.set(array,1,100); 调用我们重写的splice方法 (这样可以更新视图)</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(target) &amp;&amp; <span class="hljs-title function_">isValidArrayIndex</span>(key)) {
        target.<span class="hljs-property">length</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(target.<span class="hljs-property">length</span>, key)
        target.<span class="hljs-title function_">splice</span>(key, <span class="hljs-number">1</span>, val)
        <span class="hljs-keyword">return</span> val
    }
    <span class="hljs-comment">// 2.如果是对象本身的属性，则直接添加即可</span>
    <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> target &amp;&amp; !(key <span class="hljs-keyword">in</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)) {
        target[key] = val
        <span class="hljs-keyword">return</span> val
    }
    <span class="hljs-keyword">const</span> ob = (<span class="hljs-attr">target</span>: <span class="hljs-built_in">any</span>).<span class="hljs-property">__ob__</span>
    <span class="hljs-comment">// 3.如果是响应式的也不需要将其定义成响应式属性</span>
    <span class="hljs-keyword">if</span> (!ob) {
        target[key] = val
        <span class="hljs-keyword">return</span> val
    }
    <span class="hljs-comment">// 4.将属性定义成响应式的</span>
    <span class="hljs-title function_">defineReactive</span>(ob.<span class="hljs-property">value</span>, key, val)
    <span class="hljs-comment">// 5.通知视图更新</span>
    ob.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
    <span class="hljs-keyword">return</span> val
}
</code></pre>
<p>Vue3 中 set 方法已经被移除，因为 proxy 天然弥补 vue2 响应式的缺陷。</p>
<h2 data-id="heading-14">8、Vue.use 是干什么的?原理是什么?</h2>
<p>Vue.use 是用来使用插件的，我们可以在插件中扩展全局组件、指令、原型方法等。</p>
<p>Vue.use 源码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Vue</span>.<span class="hljs-property">use</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">plugin: <span class="hljs-built_in">Function</span> | <span class="hljs-built_in">Object</span></span>) {
    <span class="hljs-comment">// 插件不能重复的加载</span>
    <span class="hljs-keyword">const</span> installedPlugins = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_installedPlugins</span> || (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_installedPlugins</span> = []))
    <span class="hljs-keyword">if</span> (installedPlugins.<span class="hljs-title function_">indexOf</span>(plugin) &gt; -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
    }
    <span class="hljs-comment">// additional parameters</span>
    <span class="hljs-keyword">const</span> args = <span class="hljs-title function_">toArray</span>(<span class="hljs-variable language_">arguments</span>, <span class="hljs-number">1</span>)
    args.<span class="hljs-title function_">unshift</span>(<span class="hljs-variable language_">this</span>)  <span class="hljs-comment">// install方法的第一个参数是Vue的构造函数，其他参数是Vue.use中除了第一个参数的其他参数</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> plugin.<span class="hljs-property">install</span> === <span class="hljs-string">'function'</span>) { <span class="hljs-comment">// 调用插件的install方法</span>
        plugin.<span class="hljs-property">install</span>.<span class="hljs-title function_">apply</span>(plugin, args)  <span class="hljs-title class_">Vue</span>.<span class="hljs-property">install</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">Vue,args</span>){}
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> plugin === <span class="hljs-string">'function'</span>) { <span class="hljs-comment">// 插件本身是一个函数，直接让函数执行</span>
        plugin.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, args) 
    }
    installedPlugins.<span class="hljs-title function_">push</span>(plugin) <span class="hljs-comment">// 缓存插件</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>
}
</code></pre>
<h2 data-id="heading-15">9、介绍下 Vue 中的 mixin，Vue3 为何不再推荐使用它？</h2>
<p>mixin 是 Vue 2 中一种复用组件逻辑的方式，允许将可复用的配置（data、methods、computed、lifecycle hooks 等）抽离成一个对象，然后通过 mixins: [] 合并到组件中。支持全局注入和局部注入。</p>
<ul>
<li>作用：抽离公共的业务逻辑</li>
<li>原理：类似“对象的继承”，当组件初始化时会调用 <code>mergeOptions</code> 方法进行合并，采用策略模式针对不同的属性进行合并。如果混入的数据和本身组件中的数据冲突，会采用“就近原则”以组件的数据为准。</li>
</ul>
<p><strong>mixin 的优点：</strong></p>
<ul>
<li>复用逻辑（如表单验证、权限判断）。</li>
<li>全局注入（如日志、埋点）。</li>
<li>减少重复代码。</li>
</ul>
<p><strong>mixin 中有很多缺陷：</strong></p>
<ul>
<li>命名冲突问题：mixin 中的变量、函数名可能会与组件中的重名。</li>
<li>依赖问题：</li>
<li>数据来源问题：</li>
</ul>
<p><strong>vue3 不再推荐使用它的理由如下：</strong></p>





























<table><thead><tr><th>问题</th><th>说明</th></tr></thead><tbody><tr><td><strong>1. 隐式依赖 &amp; 数据来源不明确</strong></td><td>组件行为来自多个 mixin，难以追踪 data、methods 是从哪里来的。</td></tr><tr><td><strong>2. 命名冲突</strong></td><td>多个 mixin 可能定义同名 data、methods，合并规则复杂（同名 methods 后者覆盖前者，data 合并为对象，同名 Key 后者覆盖前者）。</td></tr><tr><td><strong>3. 调试和维护困难</strong></td><td>父组件无法知道子组件内部有哪些 mixin 注入的属性，排查 bug 和调试困难。</td></tr><tr><td><strong>4. 不利于 Tree-shaking</strong></td><td>打包时难以移除未使用的 mixin 代码。</td></tr><tr><td><strong>5. 与 Composition API 理念冲突</strong></td><td>Mixin 是“横切关注点”，而 Composition API 强调显式、可组合的逻辑。</td></tr></tbody></table>
<p>Vue 3 推荐替代方案：Composition API + 可复用函数（Composables）。</p>



































<table><thead><tr><th>特性</th><th>Mixin</th><th>Composables</th></tr></thead><tbody><tr><td>数据来源明确</td><td>隐式</td><td>显式（import）</td></tr><tr><td>是否有命名冲突问题</td><td>有</td><td>无</td></tr><tr><td>逻辑封装</td><td>全局污染</td><td>按需引入</td></tr><tr><td>Tree-shaking 支持</td><td>差</td><td>好</td></tr><tr><td>TypeScript 支持</td><td>差</td><td>好</td></tr></tbody></table>
<p>对于全局混入（Global Mixin），Vue3 虽然提供了 <code>app.mixin()</code>，但不推荐，推荐使用:</p>
<ol>
<li><code>app.config.globalProperties</code>。</li>
<li><code>app.provide</code> 在顶层提供数据，组件通过 <code>inject</code> 方法消费数据。</li>
</ol>
<h2 data-id="heading-16">10、介绍下 Vue.js 中的函数式组件、异步组件和递归组件</h2>
<h3 data-id="heading-17">10.1 函数式组件（Functional Components）</h3>
<p>函数式组件是一种轻量级、无状态的组件形式。它们很像纯函数：接收 props，返回 虚拟 DOM（vnode）。函数式组件在渲染过程中不会创建组件实例 (也就是说，没有 this)，也不会触发常规的组件生命周期钩子。没有响应式系统、生命周期和实例的开销，函数式组件自然在渲染上更加高效和快速。</p>
<p>总而言之，函数式组件有<strong>无状态</strong>、<strong>无this</strong>、<strong>无生命周期</strong>、<strong>性能更高</strong>等特点。</p>
<p>使用场景：适合简单、静态的 UI 元素，如列表项或包装组件。</p>
<p>在 Vue 2 中，通过 <code>functional: true</code> 声明；在 Vue 3 中，函数式组件更简单，直接返回渲染函数。</p>
<p><strong>Vue2 示例</strong>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template functional&gt;
  &lt;div&gt;{{ props.msg }}&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>或者 js 形式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">functional</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">props</span>: [<span class="hljs-string">'msg'</span>],
  <span class="hljs-title function_">render</span>(<span class="hljs-params">h, { props }</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, props.<span class="hljs-property">msg</span>);
  }
};
</code></pre>
<p><strong>Vue3 示例</strong>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { h } from 'vue';

const FunctionalComp = (props) =&gt; h('div', props.msg);
&lt;/script&gt;

&lt;template&gt;
  &lt;FunctionalComp msg="Hello Functional" /&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-18">10.2 异步组件（Async Components）</h3>
<p>异步组件是一种懒加载（Lazy Loading）机制，用于按需加载组件代码，优化初始加载时间和性能。Vue 会动态导入组件，只有在使用时才下载和渲染，常用于路由或大型组件。</p>
<p><strong>特点：</strong></p>
<ul>
<li>通过 <code>import()</code> 动态加载，返回 Promise。</li>
<li>支持加载中（loading）、错误（error）和超时（timeout）处理。</li>
<li>在 Vue 3 中，使用 <code>defineAsyncComponent</code> 更规范，支持与 <code>&lt;Suspense&gt;</code> 结合（Vue 3 独有，用于统一处理异步）。</li>
</ul>
<p><strong>Vue2 示例</strong>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  components: {
    AsyncComp: () =&gt; import('./AsyncComp.vue')
  }
};
&lt;/script&gt;

&lt;template&gt;
  &lt;AsyncComp /&gt;
&lt;/template&gt;
</code></pre>
<p><strong>Vue3 示例</strong>:</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { defineAsyncComponent } from 'vue';

const AsyncComp = defineAsyncComponent(() =&gt; import('./AsyncComp.vue'));
&lt;/script&gt;

&lt;template&gt;
  &lt;Suspense&gt;
    &lt;template #default&gt;
      &lt;AsyncComp /&gt;
    &lt;/template&gt;
    &lt;template #fallback&gt;加载中...&lt;/template&gt;
  &lt;/Suspense&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-19">10.3 递归组件（Recursive Components）</h3>
<p>递归组件是指组件内部调用自身，用于处理树形或嵌套数据结构，如菜单、树视图或评论回复。Vue 支持组件自引用，但需注意避免无限循环（通过条件终止递归）。</p>
<p><strong>特点：</strong></p>
<ul>
<li>组件需有名称（<code>name</code> 选项），才能自引用。</li>
<li>常结合 <code>v-for</code> 和 props 传递数据。</li>
</ul>
<p><strong>Vue 2 示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;ul&gt;
    &lt;li v-for="item in tree" :key="item.id"&gt;
      {{ item.name }}
      &lt;Tree v-if="item.children" :tree="item.children" /&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'Tree',  // 必须有 name
  props: ['tree']
};
&lt;/script&gt;
</code></pre>
<p><strong>Vue 3 示例：</strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { defineAsyncComponent } from 'vue';  // 可选：异步加载避免循环

const Tree = defineAsyncComponent(() =&gt; import('./Tree.vue'));  // 自引用
defineProps(['tree']);
&lt;/script&gt;

&lt;template&gt;
  &lt;ul&gt;
    &lt;li v-for="item in tree" :key="item.id"&gt;
      {{ item.name }}
      &lt;Tree v-if="item.children" :tree="item.children" /&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-20">11、Vue.js 中的 vue-loader 是什么？</h2>
<p>Vue-loader 是一个专为 Vue.js 设计的 <code>Webpack loader</code>（加载器），其主要作用是将 Vue 的单文件组件（Single-File Components，简称 SFC，即 .vue 文件）转换为可执行的 JavaScript 模块。 它允许开发者以一种结构化的方式编写组件，将模板（template）、脚本（script）和样式（style）封装在同一个文件中，便于管理和维护。</p>
<p><strong>核心功能</strong>:</p>
<ul>
<li><strong>解析 SFC 文件</strong>：Vue-loader 会自动处理 <code>.vue</code> 文件中的三个部分：
<ul>
<li><strong>template 部分</strong>：编译为 Vue 的渲染函数（render function）。</li>
<li><strong>script 部分</strong>：提取为组件的 JavaScript 逻辑，支持 ES 模块和 TypeScript。</li>
<li><strong>style部分</strong>：处理 CSS，支持预处理器（如 Sass、Less）并可选地应用 scoped（作用域样式）或 CSS Modules。</li>
</ul>
</li>
<li><strong>热重载（Hot Module Replacement，HMR）</strong>：在开发模式下，支持组件的热更新，无需刷新页面即可看到变化，提高开发效率。</li>
<li><strong>自定义块（Custom Blocks）</strong>：支持扩展，如添加 <code>&lt;docs&gt;</code> 或其他自定义标签，用于文档生成或其他工具集成。</li>
<li><strong>预处理器支持</strong>：无缝集成 Babel、PostCSS 等工具链。</li>
</ul>
<h2 data-id="heading-21">12、Vue.extend 方法的作用？</h2>
<p><code>Vue.extend</code>方法可以作为基础 Vue 构造器，创建一个“子类”。参数是一个包含组件选项的对象。</p>
<p><strong>Vue2 示例：</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> dialog = <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">extend</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">"&lt;div&gt;{{hello}} {{world}}&lt;/div&gt;"</span>,
  <span class="hljs-attr">data</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">hello</span>: <span class="hljs-string">"hello"</span>,
      <span class="hljs-attr">world</span>: <span class="hljs-string">"world"</span>,
    };
  },
});
<span class="hljs-comment">// 创建 dialog 实例，并手动挂载到一个元素上。</span>
<span class="hljs-keyword">new</span> <span class="hljs-title function_">dialog</span>().$mount(<span class="hljs-string">"#app"</span>);
</code></pre>
<blockquote>
<p>注意：在 <code>Vue.extend</code> 中的 <code>data</code> 必须是一个函数，要不然会报错。</p>
</blockquote>
<p><strong>Vue3 示例：</strong></p>
<p>Vue3 中不在使用 Vue.extend 方法，而是采用render方法进行手动渲染。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Modal.vue --&gt;
&lt;template&gt;
  &lt;div class="modal"&gt;这是一个弹窗&lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'Modal',
}
&lt;/script&gt;
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div id="box"&gt;&lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { h, render, createApp, onMounted } from 'vue'
import Modal from './Modal.vue'

onMounted(() =&gt; {
  render(h(Modal), document.getElementById('box'));
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-22">13、keep-alive 的原理</h2>
<p><code>&lt;keep-alive&gt;</code> 是 Vue.js 的内置组件，它的功能是在多个组件间动态切换时缓存被移除的组件实例，避免重复渲染和状态丢失，提高性能。它是一个抽象组件（abstract: true），不会渲染到 DOM，也不会出现在组件树中，而是通过插槽（slots）和自定义 render 函数实现缓存逻辑。</p>
<p><strong>核心实现机制：</strong></p>
<ol>
<li><strong>抽象组件与 Render 函数：</strong></li>
</ol>
<ul>
<li><code>&lt;keep-alive&gt;</code> 通过 render 函数处理包裹的内容（通常是动态组件，如 <code>&lt;component&gt;</code> 或 v-if 切换的组件）。</li>
<li>在 render 中，它从插槽获取子组件的 VNode（虚拟节点）。如果子组件有 key（推荐使用），则用 key 作为缓存标识；否则用组件的 tag 或 cid（组件 ID）。</li>
<li>如果组件已缓存，直接返回缓存的 VNode（设置 vnode.componentInstance.keepAlive = true 以标记缓存状态）；否则，渲染新实例并存入缓存。</li>
</ul>
<ol start="2">
<li><strong>缓存存储：</strong></li>
</ol>
<ul>
<li>内部使用一个对象（this.cache）作为缓存 Map，以 key 为键，值为 VNode 对象（包含组件实例）。</li>
<li>当组件首次渲染时，存入缓存；切换回时，从缓存取出，避免重新创建实例和执行 mounted 钩子。</li>
</ul>
<ol start="3">
<li><strong>LRU 缓存算法：</strong></li>
</ol>
<ul>
<li>支持 max 属性设置最大缓存数量（Vue 2.5+）。</li>
<li>使用 Least Recently Used（最近最少使用）算法：当缓存超出 max 时，删除最久未访问的组件（通过 this.keys 数组跟踪访问顺序）。</li>
<li>访问组件时，将其 key 移到数组末尾（最近使用）；超出时，删除数组开头的 key，并销毁对应实例（调用 $destroy）。</li>
</ul>
<ol start="4">
<li><strong>过滤规则（include/exclude）：</strong></li>
</ol>
<ul>
<li>通过 include（白名单）和 exclude（黑名单）属性决定哪些组件缓存，支持字符串、正则、数组或函数。</li>
<li>在 created 钩子中，监听这些 prop 的变化，并调用 pruneCache 更新缓存（移除不匹配的组件）。</li>
</ul>
<ol start="5">
<li><strong>生命周期钩子：</strong></li>
</ol>
<ul>
<li>缓存组件不会触发 destroyed/unmounted，而是使用 activated（激活时）和 deactivated（失活时）钩子。</li>
<li>这允许开发者在切换时管理状态（如暂停定时器），而非完全销毁。</li>
</ul>
<blockquote>
<p><strong>注意事项：</strong></p>
<ul>
<li>只缓存一个直接子组件（插槽内容），不支持多个。</li>
<li>Vue 3 中原理类似，但优化了 VNode 处理和 Composition API 支持。</li>
<li>潜在问题：缓存过多导致内存占用；需手动清理资源（如在 deactivated 中停止监听）。</li>
</ul>
</blockquote>
<h2 data-id="heading-23">14、Vue.js 中使用了哪些设计模式?</h2>
<h3 data-id="heading-24">1. 观察者模式 (Observer Pattern)</h3>
<ul>
<li>描述：Vue 的响应式系统使用观察者模式，通过 Proxy (Vue 3) 或 Object.defineProperty (Vue 2) 拦截对象属性的 get/set 操作。当数据变化时，通知订阅者（Watcher）更新视图。</li>
<li>应用：在 reactive() 函数中，返回 Proxy 对象，get 陷阱用于依赖收集 (track)，set 陷阱用于触发更新 (trigger)。</li>
<li>优势：实现了细粒度的变更检测，避免全局重渲染。</li>
</ul>
<h3 data-id="heading-25">2. 发布-订阅模式 (Publish-Subscribe Pattern)</h3>
<ul>
<li>描述：Vue 的事件系统和响应式通知机制采用 Pub-Sub 模式。数据变化时发布事件，订阅者（如组件渲染函数）接收并响应。</li>
<li>应用：在响应式系统中，trigger() 函数检索订阅者效果并调用它们；事件 API 如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>i</mi><mi>t</mi><mtext>和</mtext></mrow><annotation encoding="application/x-tex">emit 和 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mi</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">和</span></span></span></span></span>on 也基于此。</li>
<li>优势：解耦了数据生产者和消费者，支持异步更新。</li>
</ul>
<h3 data-id="heading-26">3. 代理模式 (Proxy Pattern)</h3>
<p>描述：Vue 3 的响应式系统直接使用 ES6 Proxy 作为代理层，拦截对象操作，实现透明的响应式。
应用：reactive() 返回 Proxy 对象，代理目标对象的访问和修改。
优势：比 Vue 2 的 defineProperty 更强大，支持数组和 Map/Set 等类型。</p>
<h3 data-id="heading-27">4. 策略模式 (Strategy Pattern)</h3>
<ul>
<li>描述：Vue 的虚拟 DOM diff 算法使用不同策略（如 key-based diff 或简单 patch）来优化更新。</li>
<li>应用：在渲染过程中，根据节点类型选择 diff 策略。</li>
<li>优势：最小化 DOM 操作，提高渲染效率。</li>
</ul>
<h3 data-id="heading-28">5. 单例模式(Singleton Pattern)</h3>
<ul>
<li>描述：整个程序中有且仅有一个实例。</li>
<li>应用：vuex 的 store 和插件。</li>
<li>优势：全局唯一、节约资源、便于管理。</li>
</ul>
<h3 data-id="heading-29">6. 工厂模式(Factory Pattern)</h3>
<ul>
<li>描述：提供了一种创建对象的方式，使得创建对象的过程与使用对象的过程分离。</li>
<li>应用：Vue2 中的组件创建，传入参数给 <code>createComponentInstance</code> 就可以创建实例。</li>
<li>优势：解藕，易于维护。</li>
</ul>
<h2 data-id="heading-30">15、Vue.js 应用中常见的内存泄漏来源有哪些？</h2>
<ol>
<li>未清理的事件监听器、定时器、动画</li>
</ol>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { onMounted, onUnmounted } from 'vue';

let timer = null;
let controller = null;
let raf = null;

onMounted(() =&gt; {
  // 定时器
  timer = setInterval(() =&gt; {}, 1000);
  // 动画
  raf = requestAnimationFrame(() =&gt; {});
  // 事件监听
  window.addEventListener('resize', handleResize);
});

onUnmounted(() =&gt; {
  clearInterval(timer);
  cancelAnimationFrame(this.raf);
  window.removeEventListener('resize', handleResize);
});
&lt;/script&gt;
</code></pre>
<ol start="2">
<li>未移除的第三方库实例</li>
</ol>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { onMounted, onUnmounted } from 'vue';

let chart = null;

onMounted(() =&gt; {
  chart = echarts.init(this.$refs.chart);
});

onUnmounted(() =&gt; {
  chart?.dispose();
});
&lt;/script&gt;
</code></pre>
<ol start="3">
<li>事件总线（Event Bus）未解绑</li>
</ol>
<p>vue2 用可以用 <code>new Vue</code> 全局创建一个事件总线实例，或者在组件中直接使用 <code>this.$on</code>、<code>this.$emit</code>、<code>this.$off</code>。</p>
<p>vue3 则需要借助第三库，比如 mitt 来实现事件总线。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { onMounted, onUnmounted } from 'vue';
import mitt from 'mitt';

// 创建事件总线实例
const emitter = mitt();

onMounted(() =&gt; {
  emitter.on('update', this.handler);
});

onUnmounted(() =&gt; {
  emitter.off('update', this.handler);
});
&lt;/script&gt;
</code></pre>
<p>顺便提一下， vue3 为啥去掉 <code>$on、$emit、$off</code> 这些 API，主要有以下原因：</p>
<ol>
<li>设计理念的调整</li>
</ol>
<p>Vue 3 更加注重组件间通信的明确性和可维护性。$on 这类事件 API 本质上是一种 "发布 - 订阅" 模式，容易导致组件间关系模糊（多个组件可能监听同一个事件，难以追踪事件来源和流向）。Vue 3 推荐使用更明确的通信方式，如：</p>
<ul>
<li>父子组件通过 props 和 emit 通信</li>
<li>跨组件通信使用 provide/inject 或 Pinia/Vuex 等状态管理库</li>
<li>复杂场景可使用专门的事件总线库（如 mitt</li>
</ul>
<ol start="2">
<li>与 Composition API 的适配</li>
</ol>
<p>Vue 3 主推的 Composition API 强调逻辑的封装和复用，而 $on 基于选项式 API 的实例方法，与 Composition API 的函数式思维不太契合。移除后，开发者可以更自然地使用响应式变量或第三方事件库来实现类似功能。</p>
<ol start="3">
<li>减少潜在问题</li>
</ol>
<ul>
<li>$on 容易导致内存泄漏（忘记解绑事件）</li>
<li>事件名称可能冲突（全局事件总线尤其明显）</li>
<li>不利于 TypeScript 类型推断，难以实现类型安全</li>
</ul>
<h3 data-id="heading-31">4. 未清理的 Watcher</h3>
<p>Vue 本身不会泄漏内存，泄漏几乎都来自<strong>开发者未清理的副作用</strong>。养成“创建即清理”的习惯，使用 <code>beforeDestroy</code> 或者 <code>onUnmounted</code> 集中清理，在使用 <code>keep-alive</code> 的组件中，视情况在 <code>deactivated</code> 钩子中清理资源。</p>
<h2 data-id="heading-32">16、Vue.js 中的性能优化手段有哪些？</h2>
<h3 data-id="heading-33">16.1 数据相关</h3>
<ul>
<li>Vue2 中数据层级不易过深，合理设置响应式数据；</li>
<li>Vue2 非响应式数据可以通过 Object.freeze()方法冻结属性；</li>
<li>合理使用 computed，利用其缓存能力提高性能。</li>
</ul>
<h3 data-id="heading-34">16.2 组件相关</h3>
<ul>
<li>控制组件粒度（Vue 采用组件级更新）；</li>
<li>合适场景可使用函数式组件（函数式组件开销低）；</li>
<li>采用异步组件（借助构建工具的分包的能力，减少主包体积）；</li>
<li>在组件卸载或者非激活状态及时清除定时器、DOM事件、事件总线、三方库的实例等。</li>
<li>v-on 按需监听、使用动态 watch 和及时销毁 watch。</li>
</ul>
<h3 data-id="heading-35">16.3 渲染相关</h3>
<ul>
<li>合理设置 key 属性；</li>
<li>v-show 和 v-if 的选取；</li>
<li>使用防抖、节流、分页、虚拟滚动、时间分片等策略；</li>
<li>合理使用 keep-alive 、v-once、v-memo 进行逻辑优化。</li>
</ul>
<h2 data-id="heading-36">结语</h2>
<p>以上是整理的 Vue 高级的高频面试题，如有错误或者可以优化的地方欢迎评论区指正，后续还会更新 Vuex 和 Vue-router 相关面试题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 ffmpeg 查看多媒体解码的配置信息]]></title>    <link>https://juejin.cn/post/7572164122234929162</link>    <guid>https://juejin.cn/post/7572164122234929162</guid>    <pubDate>2025-11-13T11:04:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572164122234929162" data-draft-id="7572012699628027931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 ffmpeg 查看多媒体解码的配置信息"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-13T11:04:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 ffmpeg 查看多媒体解码的配置信息
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:04:24.000Z" title="Thu Nov 13 2025 11:04:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 ffmpeg 查看多媒体解码的配置信息</h3>
<pre><code class="hljs language-c" lang="c">code@uos:~$ ffmpeg
ffmpeg version <span class="hljs-number">4.4</span><span class="hljs-number">.2</span>-deepin4 <span class="hljs-title function_">Copyright</span> <span class="hljs-params">(c)</span> 2000-2021 the FFmpeg developers
  built with gcc 8 <span class="hljs-params">(Uos <span class="hljs-number">8.3</span><span class="hljs-number">.0</span><span class="hljs-number">.12</span>-deepin1)</span>
  configuration: --prefix=/usr --extra-version=deepin4 --toolchain=hardened --libdir=/usr/lib/aarch64-linux-gnu --incdir=/usr/include/aarch64-linux-gnu --arch=arm64 --enable-gpl --disable-stripping --enable-avresample --disable-filter=resample --enable-gnutls --enable-ladspa --enable-libaom --enable-libass --enable-libbluray --enable-libbs2b --enable-libcaca --enable-libcdio --enable-libcodec2 --enable-libdav1d --enable-libflite --enable-libfontconfig --enable-libfreetype --enable-libfribidi --enable-libgme --enable-libgsm --enable-libjack --enable-libmp3lame --enable-libmysofa --enable-libopenjpeg --enable-libopenmpt --enable-libopus --enable-libpulse --enable-librabbitmq --enable-librubberband --enable-libshine --enable-libsnappy --enable-libsoxr --enable-libspeex --enable-libsrt --enable-libssh --enable-libtheora --enable-libtwolame --enable-libvidstab --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx265 --enable-libxml2 --enable-libxvid --enable-libzimg --enable-libzmq --enable-libzvbi --enable-lv2 --enable-omx --enable-ftomx --enable-openal --enable-opencl --enable-opengl --enable-sdl2 --enable-libdavs2 --enable-libxavs2 --disable-sndio --enable-pocketsphinx --enable-librsvg --enable-libdc1394 --enable-libdrm --enable-libiec61883 --enable-chromaprint --enable-frei0r --enable-libx264 --enable-shared
  libavutil      <span class="hljs-number">56.</span> <span class="hljs-number">70.100</span> / <span class="hljs-number">56.</span> <span class="hljs-number">70.100</span>
  libavcodec     <span class="hljs-number">58.134</span><span class="hljs-number">.100</span> / <span class="hljs-number">58.134</span><span class="hljs-number">.100</span>
  libavformat    <span class="hljs-number">58.</span> <span class="hljs-number">76.100</span> / <span class="hljs-number">58.</span> <span class="hljs-number">76.100</span>
  libavdevice    <span class="hljs-number">58.</span> <span class="hljs-number">13.100</span> / <span class="hljs-number">58.</span> <span class="hljs-number">13.100</span>
  libavfilter     <span class="hljs-number">7.110</span><span class="hljs-number">.100</span> /  <span class="hljs-number">7.110</span><span class="hljs-number">.100</span>
  libavresample   <span class="hljs-number">4.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0</span> /  <span class="hljs-number">4.</span>  <span class="hljs-number">0.</span>  <span class="hljs-number">0</span>
  libswscale      <span class="hljs-number">5.</span>  <span class="hljs-number">9.100</span> /  <span class="hljs-number">5.</span>  <span class="hljs-number">9.100</span>
  libswresample   <span class="hljs-number">3.</span>  <span class="hljs-number">9.100</span> /  <span class="hljs-number">3.</span>  <span class="hljs-number">9.100</span>
  libpostproc    <span class="hljs-number">55.</span>  <span class="hljs-number">9.100</span> / <span class="hljs-number">55.</span>  <span class="hljs-number">9.100</span>
Hyper fast Audio and Video encoder
usage: ffmpeg [options] [[infile options] -i infile]... {[outfile options] outfile}...

Use -h to get full help or, even better, run <span class="hljs-string">'man ffmpeg'</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从面条代码到抽象能力：一个小表单场景里的前端成长四阶段]]></title>    <link>https://juejin.cn/post/7571972751528673316</link>    <guid>https://juejin.cn/post/7571972751528673316</guid>    <pubDate>2025-11-13T11:08:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571972751528673316" data-draft-id="7571815573933310015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从面条代码到抽象能力：一个小表单场景里的前端成长四阶段"/> <meta itemprop="keywords" content="前端,架构,设计模式"/> <meta itemprop="datePublished" content="2025-11-13T11:08:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月亮有石头"/> <meta itemprop="url" content="https://juejin.cn/user/3526889032395613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从面条代码到抽象能力：一个小表单场景里的前端成长四阶段
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889032395613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月亮有石头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:08:25.000Z" title="Thu Nov 13 2025 11:08:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常业务开发里，有一类场景出现频率极高：</p>
<ul>
<li>页面里有一个子表单组件（用 <code>ref</code> 引用）</li>
<li>提交前要让子表单先做一轮校验</li>
<li>校验通过后，从当前组件的数据里组装一个 payload 发给后端</li>
</ul>
<p>看起来再普通不过，比如下面这样一段代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
  <span class="hljs-comment">// 先让子表单组件校验</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">reviewForm</span>?.<span class="hljs-title function_">validate</span>();
  <span class="hljs-keyword">if</span> (!res || !res.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(res?.<span class="hljs-property">message</span> || <span class="hljs-string">'请完善自评信息'</span>);
  }
}

<span class="hljs-keyword">const</span> payload = {
  <span class="hljs-attr">reviewContent</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>,
  <span class="hljs-attr">attachmentList</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">attachmentList</span>,
};

<span class="hljs-comment">// 调接口……</span>
</code></pre>
<ul>
<li>有内容就校验；</li>
<li>校验不过就提示；</li>
<li>校验通过就拼一个 <code>payload</code> 去提交。</li>
</ul>
<p>很多前端的“表单生涯”，就是从这种<strong>线性、直接、带一点点面条味</strong>的代码开始的。</p>
<p>有意思的是：<br/>
<strong>同样一个需求，不同水平的前端，会写出完全不同层次的代码。</strong><br/>
从这个小例子出发，我们刚好可以串一条：<strong>初级 → 中级 → 高级 → 架构</strong> 的成长路径。</p>
<hr/>
<h2 data-id="heading-0">一、初级前端：能把流程串起来，就是胜利 🎯</h2>
<h3 data-id="heading-1">典型写法</h3>
<p>还是这段最“朴素”的代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">reviewForm</span>?.<span class="hljs-title function_">validate</span>();
  <span class="hljs-keyword">if</span> (!res || !res.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(res?.<span class="hljs-property">message</span> || <span class="hljs-string">'请完善自评信息'</span>);
  }
}

<span class="hljs-keyword">const</span> payload = {
  <span class="hljs-attr">reviewContent</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>,
  <span class="hljs-attr">attachmentList</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">attachmentList</span>,
};

<span class="hljs-comment">// 调用接口，比如：api.submit(payload)</span>
</code></pre>
<p>逻辑完全按脑子里的流程来：</p>
<ol>
<li>有自评内容吗？（<code>this.reviewContent?.length</code>）</li>
<li>有的话就调用子表单的 <code>validate()</code></li>
<li>校验没过就弹一条错误消息</li>
<li>校验通过，拼一个请求体对象</li>
<li>调接口</li>
</ol>
<h3 data-id="heading-2">这个阶段的特点</h3>
<ul>
<li>
<p>✅ 优点：</p>
<ul>
<li>写起来非常快；</li>
<li>读起来也很直接——业务同学都能看懂。</li>
</ul>
</li>
<li>
<p>❌ 问题：</p>
<ul>
<li>
<p><strong>强耦合在当前组件</strong>：</p>
<ul>
<li>假设 <code>$refs.reviewForm</code> 一定存在；</li>
<li>假设 <code>validate()</code> 返回 <code>{ ok, message }</code>；</li>
<li>假设消息提示必须在这里做。</li>
</ul>
</li>
<li>
<p>逻辑、UI 提示、payload 结构全部糊在一起；</p>
</li>
<li>
<p>若别的页面也要搞“先校验子表单再组装 payload”，往往是复制粘贴一份再改改字段。</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>初级阶段的核心目标其实只有一个：  <strong>“我能把功能做出来。”</strong><br/>
想到哪写到哪，是完全正常的。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、中级前端：开始对“重复”和“耦合”过敏 🧩</h2>
<p>当你写了第三、第四个类似的提交流程后，会开始皱眉头：</p>
<ul>
<li>“怎么又是先 <code>validate</code> 再拼对象？”</li>
<li>“为什么到处都有同样的错误提示逻辑？”</li>
<li>“这要是修改字段名，不得全项目搜索一遍？”</li>
</ul>
<p>这时候，就会自然走向第一步抽象：<strong>提取工具函数</strong>。</p>
<h3 data-id="heading-4">第一步：按“模块”抽函数</h3>
<p>比如我们为这块自评表单单独写一个工具文件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/reviewForm.js</span>

<span class="hljs-comment">// 校验自评表单</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateReview</span>(<span class="hljs-params">vm</span>) {
  <span class="hljs-keyword">if</span> (!vm.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
    <span class="hljs-comment">// 没填内容，视为不需要校验</span>
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> };
  }

  <span class="hljs-keyword">const</span> form = vm.<span class="hljs-property">$refs</span>.<span class="hljs-property">reviewForm</span>;
  <span class="hljs-keyword">if</span> (!form || <span class="hljs-keyword">typeof</span> form.<span class="hljs-property">validate</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-comment">// 看业务需求，这里也可以认为是异常</span>
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> };
  }

  <span class="hljs-keyword">const</span> res = form.<span class="hljs-title function_">validate</span>();

  <span class="hljs-keyword">if</span> (!res || res.<span class="hljs-property">ok</span> === <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">const</span> msg = res?.<span class="hljs-property">message</span> || <span class="hljs-string">'自评信息校验未通过'</span>;
    vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">message</span>: msg };
  }

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> };
}

<span class="hljs-comment">// 构建自评 payload</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">buildReviewPayload</span>(<span class="hljs-params">vm</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">reviewContent</span>: vm.<span class="hljs-property">reviewContent</span>,
    <span class="hljs-attr">attachmentList</span>: vm.<span class="hljs-property">attachmentList</span>,
  };
}
</code></pre>
<p>组件里就可以这样用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { validateReview, buildReviewPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/reviewForm'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { ok } = <span class="hljs-title function_">validateReview</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">if</span> (!ok) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> payload = <span class="hljs-title function_">buildReviewPayload</span>(<span class="hljs-variable language_">this</span>);
  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(payload);
}
</code></pre>
<h3 data-id="heading-5">中级前端的思维变化</h3>
<ul>
<li>不再满足于“能跑”，开始追求“以后好改一点”；</li>
<li>能意识到：可以把<strong>公共逻辑抽成函数</strong>，避免重复粘贴；</li>
<li>但抽象粒度通常还是<strong>按业务模块划分</strong>：<br/>
<code>reviewFormUtils</code>、<code>baseInfoUtils</code>、<code>priceUtils</code>……</li>
</ul>
<p>封装有了，代码好了不少，但还停留在“<strong>每个业务模块一套</strong>”的阶段：<br/>
每加一个新表单，又是一组新的 <code>validateXxx + buildXxxPayload</code>。</p>
<hr/>
<h2 data-id="heading-6">三、高级前端：从“封装”走向“抽象模式” 🧠</h2>
<p>再往前走一步，你会开始问更有意思的问题：</p>
<blockquote>
<ul>
<li>这些校验 + payload 的套路，本质上是不是一样的？</li>
<li>哪些是“流程”，哪些是“策略/细节”？</li>
<li>我能不能写一份通用逻辑，让所有表单都用？</li>
</ul>
</blockquote>
<h3 data-id="heading-7">1）提炼通用流程：getPayload</h3>
<p>观察会发现，每个表单提交流程几乎都是：</p>
<ol>
<li>根据某个 <code>ref</code> 拿到子表单组件；</li>
<li>调用 <code>validate()</code> 做校验；</li>
<li>如果失败 → 提示并中断；</li>
<li>如果成功 → 根据当前组件数据构造 payload。</li>
</ol>
<p>于是可以写出一个<strong>只关心流程</strong>的函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/getPayload.js</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Vue</span>} <span class="hljs-variable">vm</span> - 当前组件实例
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">buildPayload</span> - (vm) =&gt; payload 对象
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">String</span>} <span class="hljs-variable">refName</span> - 子表单的 ref 名
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPayload</span>(<span class="hljs-params">vm, buildPayload, refName</span>) {
  <span class="hljs-keyword">const</span> form = vm.<span class="hljs-property">$refs</span>?.[refName];

  <span class="hljs-comment">// 没有这个表单：视为无需校验，直接拼 payload</span>
  <span class="hljs-keyword">if</span> (!form || <span class="hljs-keyword">typeof</span> form.<span class="hljs-property">validate</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: <span class="hljs-title function_">buildPayload</span>(vm) };
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params">res</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!res || res.<span class="hljs-property">ok</span> === <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">const</span> msg = res?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验未通过'</span>;
      vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: <span class="hljs-title function_">buildPayload</span>(vm) };
  };

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> maybe = form.<span class="hljs-title function_">validate</span>();

    <span class="hljs-comment">// 支持 Promise 风格的 validate</span>
    <span class="hljs-keyword">if</span> (maybe &amp;&amp; <span class="hljs-keyword">typeof</span> maybe.<span class="hljs-property">then</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> maybe.<span class="hljs-title function_">then</span>(handle).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> msg = e?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验异常'</span>;
        vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
      });
    }

    <span class="hljs-comment">// 同步返回</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">handle</span>(maybe);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">const</span> msg = e?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验异常'</span>;
    vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
  }
}
</code></pre>
<p>组件使用示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { getPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/getPayload'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayload</span>(
    <span class="hljs-variable language_">this</span>,
    <span class="hljs-function">(<span class="hljs-params">vm</span>) =&gt;</span> ({
      <span class="hljs-attr">reviewContent</span>: vm.<span class="hljs-property">reviewContent</span>,
      <span class="hljs-attr">attachmentList</span>: vm.<span class="hljs-property">attachmentList</span>,
    }),
    <span class="hljs-string">'reviewForm'</span>,
  );

  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(res.<span class="hljs-property">payload</span>);
}
</code></pre>
<p>此时，<code>getPayload</code>：</p>
<ul>
<li>不再关心 payload 结构；</li>
<li>不再关心具体业务，只负责：<br/>
<strong>“找到表单 → 校验 → 错误处理 → 调用参数构造 payload”</strong> 。</li>
</ul>
<h3 data-id="heading-8">2）这里已经有设计模式的影子</h3>
<ul>
<li>
<p><code>getPayload</code> 像是一个小号的 <strong>模板方法模式</strong>（Template Method）：</p>
<ul>
<li>固定了流程：<strong>校验 → 错误处理 → 构建 payload</strong>；</li>
<li>把“payload 怎么构”这一段留给调用方（作为“模板中的可变步骤”）。</li>
</ul>
</li>
<li>
<p><code>buildPayload</code> 实际上也符合 <strong>策略模式</strong>（Strategy）的思路：</p>
<ul>
<li>同一个处理流程，根据不同策略函数（buildXxxPayload），构建不同业务数据。</li>
</ul>
</li>
</ul>
<p>高级前端的特点是：</p>
<ul>
<li>不只是“会封装”，而是会从逻辑里识别出<strong>模式</strong>；</li>
<li>能把“稳定的部分”和“易变的部分”拆开，分别对待；</li>
<li>会刻意让代码有<strong>可扩展点</strong>，而不是为了当前需求把东西都焊死。</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、前端架构：把“表单校验 + payload”升级成一种通用能力 🏗️</h2>
<p>再往上一个段位，前端架构考虑的不只是“这段代码写得好不好看”，而是：</p>
<blockquote>
<p>“这种模式在<strong>整个项目范围内</strong>，要怎么用、怎么演进？”</p>
</blockquote>
<p>如果全站有 N 个子表单，每个都要：</p>
<ul>
<li>ref + validate</li>
<li>再拼各自的 payload</li>
</ul>
<p>那么架构会更倾向于做一件事：</p>
<blockquote>
<p>把这种模式<strong>正式命名、抽象成一类‘能力’</strong>，然后由所有页面共同复用。</p>
</blockquote>
<h3 data-id="heading-10">1）用配置表达“表单 → payload”的映射关系</h3>
<p>先把“这个 ref 对应什么 payload”抽成配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// config/formPayloadMap.js</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> formPayloadMap = {
  <span class="hljs-comment">// 自评表单</span>
  <span class="hljs-title function_">reviewForm</span>(<span class="hljs-params">vm</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">reviewContent</span>: vm.<span class="hljs-property">reviewContent</span>,
      <span class="hljs-attr">attachmentList</span>: vm.<span class="hljs-property">attachmentList</span>,
    };
  },

  <span class="hljs-comment">// 基础信息表单</span>
  <span class="hljs-title function_">baseForm</span>(<span class="hljs-params">vm</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">baseInfo</span>: vm.<span class="hljs-property">baseInfo</span>,
      <span class="hljs-attr">projectId</span>: vm.<span class="hljs-property">projectId</span>,
    };
  },

  <span class="hljs-comment">// 报价表单</span>
  <span class="hljs-title function_">priceForm</span>(<span class="hljs-params">vm</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">priceList</span>: vm.<span class="hljs-property">priceList</span>,
    };
  },

  <span class="hljs-comment">// ……</span>
};
</code></pre>
<h3 data-id="heading-11">2）getPayload：只需要传 refName</h3>
<p>现在改造 <code>getPayload</code>，变成只需要 <code>vm + refName</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/getPayload.js</span>
<span class="hljs-keyword">import</span> { formPayloadMap } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/config/formPayloadMap'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getPayload</span>(<span class="hljs-params">vm, refName</span>) {
  <span class="hljs-keyword">const</span> buildPayload = formPayloadMap[refName];

  <span class="hljs-keyword">if</span> (!buildPayload) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[getPayload] 未配置 ref "<span class="hljs-subst">${refName}</span>" 对应的 payload 构造函数`</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">`未配置 <span class="hljs-subst">${refName}</span> 映射`</span> };
  }

  <span class="hljs-keyword">const</span> form = vm.<span class="hljs-property">$refs</span>?.[refName];

  <span class="hljs-comment">// 没有表单：视为无需校验，直接拼 payload</span>
  <span class="hljs-keyword">if</span> (!form || <span class="hljs-keyword">typeof</span> form.<span class="hljs-property">validate</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: <span class="hljs-title function_">buildPayload</span>(vm) };
  }

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handle</span> = (<span class="hljs-params">res</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!res || res.<span class="hljs-property">ok</span> === <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">const</span> msg = res?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验未通过'</span>;
      vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: <span class="hljs-title function_">buildPayload</span>(vm) };
  };

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> maybe = form.<span class="hljs-title function_">validate</span>();

    <span class="hljs-keyword">if</span> (maybe &amp;&amp; <span class="hljs-keyword">typeof</span> maybe.<span class="hljs-property">then</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> maybe
        .<span class="hljs-title function_">then</span>(handle)
        .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> msg = e?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验异常'</span>;
          vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
        });
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title function_">handle</span>(maybe);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">const</span> msg = e?.<span class="hljs-property">message</span> || <span class="hljs-string">'校验异常'</span>;
    vm.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(msg);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">payload</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">message</span>: msg };
  }
}
</code></pre>
<p>组件里的使用体验就变成：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { getPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/getPayload'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayload</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'reviewForm'</span>);
  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(res.<span class="hljs-property">payload</span>);
}
</code></pre>
<p><strong>调用方只需要关心：</strong></p>
<ul>
<li>“我这块用的是哪个 <code>ref</code> 的表单？”</li>
</ul>
<p>至于：</p>
<ul>
<li>要不要校验；</li>
<li>校验怎么提示；</li>
<li>payload 字段怎么组装；</li>
</ul>
<p>全部由统一机制 + 配置来处理。</p>
<h3 data-id="heading-12">3）架构视角下，多了几件事要考虑</h3>
<p>在这个阶段，思考重心变成了：</p>
<ul>
<li>
<p><strong>一致性</strong>：</p>
<ul>
<li>表单校验行为统一；</li>
<li>错误提示统一；</li>
<li>payload 结构的调整有统一入口。</li>
</ul>
</li>
<li>
<p><strong>可配置 / 可扩展</strong>：</p>
<ul>
<li>
<p>新增表单只需要：</p>
<ol>
<li>约定好 ref 名；</li>
<li>在 <code>formPayloadMap</code> 里加一个构造函数；</li>
</ol>
</li>
<li>
<p>对核心流程无侵入。</p>
</li>
</ul>
</li>
<li>
<p><strong>领域化</strong>：</p>
<ul>
<li>不再把子表单当成“某个页面的实现细节”，<br/>
而是当成领域里的一个“实体”：<br/>
<code>reviewForm</code>、<code>baseForm</code>、<code>priceForm</code>……</li>
<li>每个实体都有“校验 + 构造请求体”的统一接口。</li>
</ul>
</li>
<li>
<p><strong>长期演进成本</strong>：</p>
<ul>
<li>
<p>将来如果：</p>
<ul>
<li>改用新的 UI 表单库；</li>
<li>数据结构升级；</li>
<li>Vue2 升 Vue3；</li>
</ul>
</li>
<li>
<p>——绝大多数改动都可以限制在小范围内完成。</p>
</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、同一个需求，不同段位的差别到底是什么？</h2>
<p>用一句话概括每个阶段的心智模式：</p>
<ul>
<li>
<p><strong>初级前端：</strong></p>
<blockquote>
<p>“我能把这个流程串起来，让它跑起来。”</p>
</blockquote>
</li>
<li>
<p><strong>中级前端：</strong></p>
<blockquote>
<p>“这里有重复，我抽一个函数出来，大家都用。”</p>
</blockquote>
</li>
<li>
<p><strong>高级前端：</strong></p>
<blockquote>
<p>“这是一种模式。<br/>
哪些是稳定流程？哪些是可变策略？<br/>
我怎么设计抽象，让一份逻辑服务多个业务？”</p>
</blockquote>
</li>
<li>
<p><strong>前端架构：</strong></p>
<blockquote>
<p>“这不仅是个工具函数，而是一类‘通用能力’。<br/>
我要用机制 + 配置，把它变成整个项目的基础设施。”</p>
</blockquote>
</li>
</ul>
<p>而最初那段看起来有点“面条味”的代码，其实只是起点。</p>
<p><strong>当你开始嫌弃这类代码，开始思考“能不能抽象、能不能通用”的那一刻，你就已经在从“写代码的人”，向“设计代码的人”迈进了。</strong></p>
<hr/>
<p>如果你现在项目里正好到处都是：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">xxx</span>.<span class="hljs-title function_">validate</span>();
<span class="hljs-comment">// if (!res.ok) ...</span>
<span class="hljs-comment">// const payload = { ... }</span>
</code></pre>
<p>不妨找一个最典型的提交流程，从：</p>
<blockquote>
<p>直接写 → 提取函数 → 通用流程 + 策略 → 配置化</p>
</blockquote>
<p>这四步路径里，选你觉得<strong>当前团队能接受的一步</strong>先落地。<br/>
技术成长很多时候不是换框架、追新库，而是搞定这种“看起来很小，但无处不在”的模式。</p>
<hr/>
<h2 data-id="heading-14">六、如果业务继续变复杂：往“建造者风格”进化 🧱</h2>
<p>前面那套 <code>getPayload + formPayloadMap</code>，足以覆盖<strong>大部分常规业务表单</strong>场景：</p>
<ul>
<li>每个表单的 payload 结构相对固定；</li>
<li>只要从 <code>vm</code> 上摘几个字段拼一下就行。</li>
</ul>
<p>但真实项目有时候会长成这样：</p>
<blockquote>
<ul>
<li>某些字段是「勾选了某个开关才需要拼进去」</li>
<li>某些片段要按不同的业务类型组合（比如：普通流程 / 加急流程 / 审批流）</li>
<li>有时还需要先异步拿一部分数据，再参与构建 payload</li>
</ul>
</blockquote>
<p>这时候，简单的：</p>
<pre><code class="hljs language-js" lang="js">formPayloadMap[refName](vm) {
  <span class="hljs-keyword">return</span> { ... };
}
</code></pre>
<p>就可能开始变得又长又丑了：里面充满 if / switch / 三元运算符。</p>
<p>这个时候，就可以考虑往**“建造者风格（Builder-style）”**上进化：<br/>
把一个“大 payload”拆成多个可组合的构建步骤。</p>
<h3 data-id="heading-15">1）一个简化版 PayloadBuilder 示例</h3>
<p>先来个最小可用的版本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// builders/PayloadBuilder.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PayloadBuilder</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = {};
  }

  <span class="hljs-title function_">withReview</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">reviewContent</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">reviewContent</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withAttachments</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">attachmentList</span>)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">attachmentList</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">attachmentList</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-title function_">withBaseInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">baseInfo</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">baseInfo</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>.<span class="hljs-property">baseInfo</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">// 你可以继续加更多 withXxx 模块…</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>;
  }
}
</code></pre>
<p>使用方式（举个场景）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PayloadBuilder</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/builders/PayloadBuilder'</span>;
<span class="hljs-keyword">import</span> { getPayload } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/getPayload'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-title function_">onSubmit</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayload</span>(
    <span class="hljs-variable language_">this</span>,
    <span class="hljs-function">(<span class="hljs-params">vm</span>) =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PayloadBuilder</span>(vm)
      .<span class="hljs-title function_">withReview</span>()
      .<span class="hljs-title function_">withAttachments</span>()
      .<span class="hljs-title function_">withBaseInfo</span>()
      .<span class="hljs-title function_">build</span>(),
    <span class="hljs-string">'reviewForm'</span>,
  );

  <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(res.<span class="hljs-property">payload</span>);
}
</code></pre>
<p>这里发生了几件事：</p>
<ul>
<li>
<p><code>getPayload</code> 仍然负责：<br/>
<strong>找到 ref → 校验 → 错误处理</strong>；</p>
</li>
<li>
<p>具体 payload 构建过程交给 <code>PayloadBuilder</code>：</p>
<ul>
<li>每个 <code>withXxx()</code> 负责一个独立模块；</li>
<li><code>build()</code> 返回最终对象。</li>
</ul>
</li>
</ul>
<p>好处是：</p>
<ul>
<li>
<p>可以非常自然地按业务组合：</p>
<ul>
<li>某些场景只要 <code>.withReview().withAttachments()</code></li>
<li>另一些场景再 <code>.withBaseInfo().withSomethingElse()</code></li>
</ul>
</li>
<li>
<p>单个 <code>withXxx</code> 内部逻辑变复杂也不怕，<strong>不会把一个函数搞成 200 行 if-else</strong>。</p>
</li>
</ul>
<h3 data-id="heading-16">2）什么时候才值得用 Builder 风格？</h3>
<p>简单粗暴的判断：</p>
<ul>
<li>
<p>✅ <strong>值得上 Builder 的情况</strong>：</p>
<ul>
<li>payload 真的是**「很多块拼起来」**的；</li>
<li>不同业务场景需要「选择性启用某些块」；</li>
<li>每块内部逻辑都可能变得很复杂（多条件、多分支、甚至异步）。</li>
</ul>
</li>
<li>
<p>❌ <strong>没必要上 Builder 的情况</strong>：</p>
<ul>
<li>只是把 3～5 个字段丢进对象里；</li>
<li>变动很少，大部分字段都是 1:1 映射；</li>
<li>没有复杂的组合逻辑。</li>
</ul>
</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p>Builder 风格的价值，在于<strong>把一个复杂构建过程拆成多个可组合的小模块</strong>。<br/>
如果你的业务没有复杂到这个程度，<br/>
现在这套 <code>formPayloadMap[refName](vm)</code> + 少量 if，其实已经刚刚好。</p>
</blockquote>
<h3 data-id="heading-17">3）和前面几级抽象的关系</h3>
<p>可以把这几层理解成「渐进增强」：</p>
<ul>
<li>
<p>Lv.3 高级前端：</p>
<blockquote>
<p><code>getPayload(vm, buildPayload, refName)</code></p>
</blockquote>
<ul>
<li>通用流程 + 策略函数，已经很好用了。</li>
</ul>
</li>
<li>
<p>Lv.4/架构阶段：</p>
<blockquote>
<p>配一个 <code>formPayloadMap[refName] = buildPayload</code></p>
</blockquote>
<ul>
<li>把“谁负责构建什么”集中管理。</li>
</ul>
</li>
<li>
<p>Builder 风格：</p>
<blockquote>
<p>在单个 <code>buildPayload(vm)</code> 的实现内部，如果逻辑变复杂，再引入 <code>PayloadBuilder</code></p>
</blockquote>
<ul>
<li>是对<strong>某一个领域的构建细节</strong>做进一步拆分，而不是推翻整个体系。</li>
</ul>
</li>
</ul>
<p>也就是说，<strong>Builder 不是替代前面的抽象，而是为「某个复杂 payload」加的一层“精细化构建工具”。</strong></p>
<hr/>
<h2 data-id="heading-18">七、这条路还能怎么走？一些扩展方向思路 🚀</h2>
<p>最后顺带聊几个可以继续进化的方向，你可以根据项目实际情况慢慢加，不用一口吃胖子。</p>
<h3 data-id="heading-19">1）配合 TypeScript 做强类型约束</h3>
<p>当前的写法都是 JS 靠自觉：</p>
<ul>
<li><code>formPayloadMap</code> 的 key/返回结构完全靠约定；</li>
<li><code>getPayload</code> 的返回 <code>{ ok, payload }</code> 也没有类型提示。</li>
</ul>
<p>如果用 TS，可以做几件事：</p>
<ul>
<li>
<p>为 <code>formPayloadMap</code> 建立一个统一的类型 Map：</p>
<ul>
<li>比如：<code>type FormPayloadMap = { reviewForm: ReviewPayload; baseForm: BasePayload; ... }</code></li>
</ul>
</li>
<li>
<p>让 <code>getPayload</code> 根据 <code>refName</code> 返回不同的 payload 类型（泛型 + 索引类型）；</p>
</li>
<li>
<p>给 <code>PayloadBuilder</code> 每个 <code>withXxx()</code> 加上返回类型约束，防止漏字段/写错字段名。</p>
</li>
</ul>
<p>好处是：<strong>一旦后端改了字段，TS 能第一时间把相关代码全标红</strong>，你就不需要靠“全局搜索 + 祈祷”。</p>
<h3 data-id="heading-20">2）统一成“多表单聚合”的流程</h3>
<p>很多真实页面不是只有一个子表单，而是：</p>
<blockquote>
<p>顶层页面 → N 个子块（基础信息、自评、报价、附件……）<br/>
最后统一点一个「提交」，要校验所有子块，组合所有 payload。</p>
</blockquote>
<p>在现有基础上，可以设计一个“多表单聚合器”，伪代码例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">collectAllPayloads</span>(<span class="hljs-params">vm, configList</span>) {
  <span class="hljs-keyword">const</span> allPayload = {};

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> cfg <span class="hljs-keyword">of</span> configList) {
    <span class="hljs-keyword">const</span> { refName, mountPoint } = cfg;
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPayload</span>(vm, refName);
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">false</span> };

    <span class="hljs-comment">// mountPoint 决定这块 payload 挂在最终对象的哪里</span>
    allPayload[mountPoint] = res.<span class="hljs-property">payload</span>;
  }

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">payload</span>: allPayload };
}
</code></pre>
<p>调用时：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">collectAllPayloads</span>(<span class="hljs-variable language_">this</span>, [
  { <span class="hljs-attr">refName</span>: <span class="hljs-string">'baseForm'</span>, <span class="hljs-attr">mountPoint</span>: <span class="hljs-string">'baseInfo'</span> },
  { <span class="hljs-attr">refName</span>: <span class="hljs-string">'reviewForm'</span>, <span class="hljs-attr">mountPoint</span>: <span class="hljs-string">'review'</span> },
  { <span class="hljs-attr">refName</span>: <span class="hljs-string">'priceForm'</span>, <span class="hljs-attr">mountPoint</span>: <span class="hljs-string">'price'</span> },
]);

<span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">return</span>;
<span class="hljs-keyword">await</span> api.<span class="hljs-title function_">submit</span>(res.<span class="hljs-property">payload</span>);
</code></pre>
<p>这时：</p>
<ul>
<li><code>getPayload</code> 是<strong>单个表单的能力</strong>；</li>
<li><code>collectAllPayloads</code> 是<strong>多表单聚合的能力</strong>；</li>
<li>再配合 Builder，你就有了一条从“字段级 → 模块级 → 表单级 → 全页级”的构建链路。</li>
</ul>
<h3 data-id="heading-21">3）把“校验 + 构建”做成可插拔中间件</h3>
<p>现在，<code>getPayload</code> 里，校验逻辑顺序是写死的：</p>
<blockquote>
<p>校验 → 错误提示 → 构建 payload</p>
</blockquote>
<p>如果业务越来越复杂，可以考虑做成类似“中间件管线”的模式，比如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> pipeline = [
  validateFormStep,
  extraAsyncCheckStep,
  normalizeDataStep,
  buildPayloadStep,
];

<span class="hljs-title function_">runPipeline</span>(vm, refName, pipeline);
</code></pre>
<p>每个 step 接收 context（比如 <code>{ vm, form, payload }</code>），按顺序处理。<br/>
这样你可以：</p>
<ul>
<li>在某些表单插入额外风控校验；</li>
<li>在某些表单前面加数据归一化逻辑；</li>
<li>保持主流程一致但允许个性化“插片”。</li>
</ul>
<p>这就已经非常接近「前端领域里自己的 mini-framework」了。</p>
<h3 data-id="heading-22">4）跨框架 / 跨项目复用</h3>
<p>你现在的设计，其实已经很容易跨栈：</p>
<ul>
<li>ref 概念：React 可以用 <code>useRef</code> + <code>forwardRef</code> 来模拟；</li>
<li>validate：绝大多数表单库都有类似 API；</li>
<li>payload 构造：和框架无关，本身就是纯函数/Builder。</li>
</ul>
<p>如果你有多个项目（Vue2/Vue3/React 混合），理论上可以：</p>
<ul>
<li>把“构建规则”和“校验规则”抽到一个独立 npm 包；</li>
<li>每个项目只写一层很薄的“外壳”，适配自己的 ref/组件体系。</li>
</ul>
<p>这就是从“一个项目里的抽象”，升级成“多项目共享的领域包”。</p>
<hr/>
<p>你现在这整套，从最开始那段：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">reviewContent</span>?.<span class="hljs-property">length</span>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">reviewForm</span>?.<span class="hljs-title function_">validate</span>();
  <span class="hljs-keyword">if</span> (!res || !res.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(res?.<span class="hljs-property">message</span> || <span class="hljs-string">'请完善自评信息'</span>);
  }
}
<span class="hljs-keyword">const</span> payload = { ... };
</code></pre>
<p>一路演进到：</p>
<ul>
<li>通用 <code>getPayload</code></li>
<li>配置化 <code>formPayloadMap</code></li>
<li>按需引入 <code>PayloadBuilder</code> 做复杂构建</li>
<li>再往外是多表单聚合、类型约束、流水线、跨项目复用</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 dmesg 查看内核的实时日志]]></title>    <link>https://juejin.cn/post/7572002432451002377</link>    <guid>https://juejin.cn/post/7572002432451002377</guid>    <pubDate>2025-11-13T11:13:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432451002377" data-draft-id="7572021695294128178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 dmesg 查看内核的实时日志"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-13T11:13:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 dmesg 查看内核的实时日志
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:13:13.000Z" title="Thu Nov 13 2025 11:13:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 dmesg 查看内核的实时日志</h3>
<pre><code class="hljs language-c" lang="c">root@uos:~<span class="hljs-meta"># dmesg -wH</span>
[<span class="hljs-number">11</span>月<span class="hljs-number">10</span> <span class="hljs-number">14</span>:<span class="hljs-number">59</span>] [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">1</span>][HISI_DRM_HEAPS D]:do_alloc_memory: need alloc size=<span class="hljs-number">0x3000</span>, now pool size=<span class="hljs-number">0x1a60000</span>
[  +<span class="hljs-number">0.000000</span>] [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">2</span>][HISI_DRM_HEAPS D]:do_alloc_memory: alloc success, now pool size=<span class="hljs-number">0x1a60000</span>
[  +<span class="hljs-number">0.000031</span>] [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">3</span>][DPU_DRM D]:hisi_drm_alloc_buf: alloc drm bufsuccess, size=<span class="hljs-number">0x3000</span>
[  +<span class="hljs-number">0.000854</span>] [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">4</span>][DPU_DRM D]:hisi_drm_gem_check_flags: heap id = <span class="hljs-number">0</span>, attrs = <span class="hljs-number">5</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 journalctl 查看系统的实时日志]]></title>    <link>https://juejin.cn/post/7572012699628044315</link>    <guid>https://juejin.cn/post/7572012699628044315</guid>    <pubDate>2025-11-13T11:15:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572012699628044315" data-draft-id="7572021695294144562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 journalctl 查看系统的实时日志"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2025-11-13T11:15:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 journalctl 查看系统的实时日志
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:15:24.000Z" title="Thu Nov 13 2025 11:15:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 journalctl 查看系统的实时日志</h3>
<pre><code class="hljs language-c" lang="c">root@uos:~<span class="hljs-meta"># journalctl -f</span>
-- Logs begin at Mon <span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-03</span> <span class="hljs-number">18</span>:<span class="hljs-number">29</span>:<span class="hljs-number">06</span> CST. --
<span class="hljs-number">11</span>月 <span class="hljs-number">10</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">09</span> uos kernel: [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">5</span>][HISI_DRM_HEAPS D]:do_alloc_memory: alloc success, now pool size=<span class="hljs-number">0x2450000</span>
<span class="hljs-number">11</span>月 <span class="hljs-number">10</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">09</span> uos kernel: [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">6</span>][DPU_DRM D]:hisi_drm_alloc_buf: alloc drm bufsuccess, size=<span class="hljs-number">0x3000</span>
<span class="hljs-number">11</span>月 <span class="hljs-number">10</span> <span class="hljs-number">15</span>:<span class="hljs-number">29</span>:<span class="hljs-number">09</span> uos kernel: [pid:<span class="hljs-number">3256</span>,cpu1,Xwayland,<span class="hljs-number">7</span>][DPU_DRM D]:hisi_drm_gem_check_flags: heap id = <span class="hljs-number">0</span>, attrs = <span class="hljs-number">5</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Checkmate：自建监控新标杆！开源替代Zabbix的轻量级方案实战]]></title>    <link>https://juejin.cn/post/7571815997068329000</link>    <guid>https://juejin.cn/post/7571815997068329000</guid>    <pubDate>2025-11-13T11:22:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068329000" data-draft-id="7534551428461527074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Checkmate：自建监控新标杆！开源替代Zabbix的轻量级方案实战"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-13T11:22:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YL_jia"/> <meta itemprop="url" content="https://juejin.cn/user/1467226241383211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Checkmate：自建监控新标杆！开源替代Zabbix的轻量级方案实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1467226241383211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YL_jia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:22:33.000Z" title="Thu Nov 13 2025 11:22:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Checkmate：自建监控新标杆！开源替代Zabbix的轻量级方案实战</h2>
<blockquote>
<p>告别臃肿监控系统，1核1GB内存打造企业级基础设施监控平台</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa9f9d4b34d64998a93e4b43234254a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763637752&amp;x-signature=6YlPbcKwz9EymaOr6QEOYT3kEUY%3D" alt="Checkmate监控仪表盘示例" loading="lazy"/><br/>
（Checkmate现代化的监控界面展示）</p>
<h3 data-id="heading-1">引言：当传统监控工具成为运维的负担</h3>
<p>凌晨3点，刺耳的告警声划破寂静——不是业务故障，而是<strong>监控系统自身崩溃</strong>。这是许多运维团队的真实噩梦。传统监控方案如Zabbix、Nagios面临<strong>三大痛点</strong>：资源消耗巨大（单节点常需8GB+内存）、配置复杂（学习曲线陡峭）、扩展困难（集群部署复杂）。而<strong>Checkmate</strong>作为开源监控领域的新星，凭借<strong>轻量化架构（1核1GB即可运行）+ 零配置自动发现 + Prometheus生态兼容</strong>的三重优势，正在GitHub掀起风暴。本文将带你从核心原理到企业实战，全面掌握这款现代监控利器。</p>
<hr/>
<h3 data-id="heading-2">一、Checkmate核心优势：重新定义基础设施监控</h3>
<h4 data-id="heading-3">1. 轻量化架构设计（与传统方案对比）</h4>



































<table><thead><tr><th><strong>指标</strong></th><th>Zabbix</th><th>Prometheus</th><th><strong>Checkmate</strong></th></tr></thead><tbody><tr><td>内存占用</td><td>4GB+</td><td>2GB+</td><td><strong>&lt;512MB</strong></td></tr><tr><td>启动速度</td><td>90秒+</td><td>30秒</td><td><strong>&lt;5秒</strong></td></tr><tr><td>配置复杂度</td><td>高（Web+配置文件）</td><td>中（YAML文件）</td><td><strong>零配置自动发现</strong></td></tr><tr><td>部署方式</td><td>复杂</td><td>中等</td><td><strong>单二进制文件</strong></td></tr></tbody></table>
<h4 data-id="heading-4">2. 智能发现引擎</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[网络扫描] --&gt; B(自动识别设备类型)
    B --&gt; C{设备类型}
    C --&gt;|Linux服务器| D[采集CPU/内存/磁盘]
    C --&gt;|网络设备| E[采集SNMP指标]
    C --&gt;|K8s集群| F[发现Pod/Node]
    D --&gt; G[生成监控面板]
    E --&gt; G
    F --&gt; G
</code></pre>
<ul>
<li><strong>跨协议支持</strong>：SSH、SNMP、WMI、IPMI一网打尽</li>
<li><strong>拓扑自动绘制</strong>：实时生成网络设备连接关系图</li>
<li><strong>无代理监控</strong>：90%指标通过标准协议获取，无需安装客户端</li>
</ul>
<h4 data-id="heading-5">3. 告警智能降噪</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 智能告警聚合算法示例</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">deduplicate_alerts</span>(<span class="hljs-params">alerts</span>):
    <span class="hljs-comment"># 基于指纹的告警分组</span>
    grouped = group_by(alerts, <span class="hljs-keyword">lambda</span> a: a.fingerprint)
    
    <span class="hljs-comment"># 时间窗口聚合（5分钟内相同告警合并）</span>
    <span class="hljs-keyword">for</span> group <span class="hljs-keyword">in</span> grouped:
        <span class="hljs-keyword">if</span> time_range(group) &lt; <span class="hljs-number">5</span>*<span class="hljs-number">60</span>:
            send_alert(summarize(group))  <span class="hljs-comment"># 发送聚合通知</span>
</code></pre>
<h4 data-id="heading-6">4. 开放生态系统</h4>
<ul>
<li><strong>PromQL兼容</strong>：直接使用Prometheus查询语法</li>
<li><strong>Grafana原生支持</strong>：作为数据源无缝接入</li>
<li><strong>Webhook集成</strong>：告警推送至钉钉/企业微信/Slack</li>
<li><strong>API驱动</strong>：完整RESTful接口支持自动化运维</li>
</ul>
<hr/>
<h3 data-id="heading-7">二、十分钟极速部署：全场景安装指南</h3>
<h4 data-id="heading-8">1. Docker单机部署（开发测试）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建持久化目录</span>
<span class="hljs-built_in">mkdir</span> -p /data/checkmate/{config,data}

<span class="hljs-comment"># 启动容器</span>
docker run -d --name checkmate \
  -p 8080:8080 \
  -v /data/checkmate/config:/etc/checkmate \
  -v /data/checkmate/data:/var/lib/checkmate \
  checkmate/checkmate:latest
</code></pre>
<p>访问 <code>http://localhost:8080</code> 使用默认账号 <code>admin/checkmate</code></p>
<h4 data-id="heading-9">2. Kubernetes集群部署（生产推荐）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># checkmate-deployment.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">checkmate</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">checkmate</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">checkmate/checkmate:2.4.0</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/checkmate</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">CONFIG_PATH</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"/etc/checkmate/config.yaml"</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 配置自动发现</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">checkmate-config</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">config.yaml:</span> <span class="hljs-string">|
    discovery:
      cidr: 10.0.0.0/16
      protocols: [ssh, snmp]
    alerting:
      receivers:
        - name: ops-team
          type: webhook
          url: "https://oapi.dingtalk.com/robot/send?access_token=xxx"
</span></code></pre>
<h4 data-id="heading-10">3. 裸机二进制部署（边缘场景）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载最新版 (Linux amd64)</span>
wget https://github.com/checkmate-dev/checkmate/releases/latest/checkmate-linux-amd64

<span class="hljs-comment"># 设置为可执行文件</span>
<span class="hljs-built_in">chmod</span> +x checkmate-linux-amd64

<span class="hljs-comment"># 创建配置文件</span>
<span class="hljs-built_in">cat</span> &gt; checkmate.yaml &lt;&lt;<span class="hljs-string">EOF
discovery:
  cidr: 192.168.1.0/24
  snmp_community: public
EOF</span>

<span class="hljs-comment"># 启动服务</span>
./checkmate-linux-amd64 --config checkmate.yaml
</code></pre>
<hr/>
<h3 data-id="heading-11">三、企业级实战：三大场景深度优化</h3>
<h4 data-id="heading-12">案例1：电商大促资源保障体系</h4>
<p><strong>挑战</strong>：</p>
<ul>
<li>黑五期间200+服务器资源监控</li>
<li>秒级发现CPU过载/磁盘爆满</li>
</ul>
<p><strong>Checkmate方案</strong>：</p>
<ol>
<li><strong>动态基线告警</strong>：
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 基于历史数据的动态阈值</span>
<span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighCPU</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">cpu_usage</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">(avg_over_time(cpu_usage[7d])</span> <span class="hljs-string">+</span> <span class="hljs-number">2</span><span class="hljs-string">*stddev_over_time(cpu_usage[7d]))</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span>
</code></pre>
</li>
<li><strong>资源拓扑视图</strong>：<br/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d62c12ab44469bb361beb8f29c25b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763637752&amp;x-signature=iTNZqmbt%2F4s%2F7kki8O367LCtvlE%3D" alt="资源拓扑图" loading="lazy"/><br/>
（自动生成的服务器资源关联图）</li>
<li><strong>效果</strong>：
<ul>
<li>提前30分钟预测3台服务器过载</li>
<li>自动扩容避免200万美元损失</li>
</ul>
</li>
</ol>
<h4 data-id="heading-13">案例2：金融行业合规监控</h4>
<p><strong>需求</strong>：</p>
<ul>
<li>满足等保2.0对网络设备的监控要求</li>
<li>审计日志保留180天</li>
</ul>
<p><strong>实施路径</strong>：</p>
<ol>
<li><strong>网络设备发现</strong>：
<pre><code class="hljs language-bash" lang="bash">discovery:
  cidr: 10.1.0.0/16
  protocols: [snmp]
  snmp_communities: 
    - <span class="hljs-string">"finance@2024"</span> <span class="hljs-comment"># 加密Community</span>
</code></pre>
</li>
<li><strong>合规报表生成</strong>：
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">/* 审计日志查询示例 */</span>
<span class="hljs-keyword">SELECT</span> device_ip, check_item, <span class="hljs-keyword">result</span> 
<span class="hljs-keyword">FROM</span> audit_logs 
<span class="hljs-keyword">WHERE</span> <span class="hljs-type">timestamp</span> <span class="hljs-operator">&gt;</span> now() <span class="hljs-operator">-</span> <span class="hljs-type">interval</span> <span class="hljs-string">'180 days'</span>;
</code></pre>
</li>
<li><strong>安全加固</strong>：
<ul>
<li>TLS双向认证</li>
<li>基于RBAC的权限控制</li>
</ul>
</li>
</ol>
<h4 data-id="heading-14">案例3：智能制造工厂监控</h4>
<p><strong>场景</strong>：</p>
<ul>
<li>50+工业PLC设备</li>
<li>5个分散厂区</li>
</ul>
<p><strong>创新方案</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[厂区1] --&gt;|OPC UA| B(边缘Checkmate节点)
    C[厂区2] --&gt;|Modbus| B
    B --&gt; D[中心监控平台]
    D --&gt; E[大屏可视化]
</code></pre>
<ul>
<li><strong>边缘计算</strong>：树莓派运行Checkmate（内存&lt;300MB）</li>
<li><strong>协议转换</strong>：工业协议转Prometheus指标</li>
<li><strong>效果</strong>：<br/>
设备故障发现时间从<strong>8小时缩短至15分钟</strong></li>
</ul>
<hr/>
<h3 data-id="heading-15">四、最佳实践：效能最大化配置</h3>
<h4 data-id="heading-16">1. 监控项优化配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config.yaml 关键配置</span>
<span class="hljs-attr">metrics:</span>
  <span class="hljs-comment"># Linux服务器</span>
  <span class="hljs-attr">linux:</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">15s</span>
    <span class="hljs-attr">items:</span> [<span class="hljs-string">cpu</span>, <span class="hljs-string">memory</span>, <span class="hljs-string">disk</span>, <span class="hljs-string">network</span>]
  
  <span class="hljs-comment"># 网络设备</span>
  <span class="hljs-attr">snmp:</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
    <span class="hljs-attr">oids:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span><span class="hljs-number">.1</span><span class="hljs-number">.1</span><span class="hljs-number">.3</span><span class="hljs-number">.0</span>  <span class="hljs-comment"># 系统运行时间</span>
      <span class="hljs-bullet">-</span> <span class="hljs-number">1.3</span><span class="hljs-number">.6</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span><span class="hljs-number">.1</span><span class="hljs-number">.2</span><span class="hljs-number">.2</span><span class="hljs-number">.1</span><span class="hljs-number">.10</span> <span class="hljs-comment"># 入站流量</span>
  
  <span class="hljs-comment"># 自定义脚本</span>
  <span class="hljs-attr">custom_script:</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">"/scripts/check_application.sh"</span>
    <span class="hljs-attr">interval:</span> <span class="hljs-string">1m</span>
</code></pre>
<h4 data-id="heading-17">2. 告警分级策略</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">alerting:</span>
  <span class="hljs-attr">routes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> 
        <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
      <span class="hljs-attr">receiver:</span> <span class="hljs-string">'ops-pager'</span>
      
    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> 
        <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
      <span class="hljs-attr">receiver:</span> <span class="hljs-string">'ops-slack'</span>
  
  <span class="hljs-attr">templates:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">application_alert</span>
      <span class="hljs-attr">body:</span> <span class="hljs-string">|
        [{{ .Status | toUpper }}] {{ .AlertName }}
        {{ range .Annotations.SortedPairs }}{{ .Name }}: {{ .Value }}
        {{ end }}
</span></code></pre>
<h4 data-id="heading-18">3. 性能调优参数</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 高负载环境启动参数</span>
./checkmate \
  --max-routines=500 \     <span class="hljs-comment"># 最大并发协程数</span>
  --tsdb-retention=30d \   <span class="hljs-comment"># 数据保留周期</span>
  --query-timeout=10s      <span class="hljs-comment"># 查询超时设置</span>
</code></pre>
<hr/>
<h3 data-id="heading-19">五、与传统方案对比：为什么选择Checkmate？</h3>



































<table><thead><tr><th><strong>场景</strong></th><th>Zabbix</th><th>Prometheus+Alertmanager</th><th><strong>Checkmate</strong></th></tr></thead><tbody><tr><td><strong>资源受限环境</strong></td><td>难以运行</td><td>需要多组件</td><td>✅ 单节点运行</td></tr><tr><td><strong>配置复杂度</strong></td><td>高（学习曲线陡）</td><td>中（需配采集器）</td><td>✅ 自动发现零配置</td></tr><tr><td><strong>扩展性</strong></td><td>垂直扩展</td><td>水平扩展复杂</td><td>✅ 原生集群支持</td></tr><tr><td><strong>维护成本</strong></td><td>高（专职运维）</td><td>中</td><td>✅ 无人值守</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-20">六、未来演进：AI驱动的智能运维</h3>
<p>Checkmate 3.0路线图：</p>
<ol>
<li><strong>异常预测引擎</strong>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LSTM时序预测伪代码</span>
model = LSTM().train(historical_metrics)
anomaly_score = model.predict(current_values)
<span class="hljs-keyword">if</span> anomaly_score &gt; threshold:
    trigger_alert(<span class="hljs-string">"预测故障: 磁盘将在4小时内写满"</span>)
</code></pre>
</li>
<li><strong>根因分析系统</strong>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
  A[MySQL慢查询] --&gt; B(关联分析)
  B --&gt; C[发现磁盘IO延迟]
  C --&gt; D[定位RAID卡故障]
</code></pre>
</li>
<li><strong>自然语言交互</strong>
<blockquote>
<p>用户：“为什么订单服务延迟升高？”<br/>
Checkmate：“检测到数据库主节点CPU使用率95%，建议扩容”</p>
</blockquote>
</li>
</ol>
<hr/>
<h3 data-id="heading-21">结语：监控系统的新范式</h3>
<p>Checkmate用<strong>极简主义解决复杂问题</strong>的理念，诠释了现代运维工具的真谛——它不追求功能的大而全，而是聚焦在<strong>自动化发现、轻量高效、智能分析</strong>的核心价值上。正如某互联网公司CTO所言：“<strong>当我们把监控系统内存从32GB降到1GB时，才真正体会到技术选型的价值</strong>”。</p>
<p><strong>立即体验</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d -p 8080:8080 checkmate/checkmate
</code></pre>
<p><strong>资源获取</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcheckmate-dev%2Fcheckmate" target="_blank" title="https://github.com/checkmate-dev/checkmate" ref="nofollow noopener noreferrer">GitHub项目主页</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheckmate.dev%2Fdocs%2Fenterprise" target="_blank" title="https://checkmate.dev/docs/enterprise" ref="nofollow noopener noreferrer">企业部署白皮书</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheckmate.dev%2Fconfig-builder" target="_blank" title="https://checkmate.dev/config-builder" ref="nofollow noopener noreferrer">监控配置生成器</a></li>
</ul>
<p><strong>讨论话题</strong>：<br/>
👉 你在监控系统使用中遇到的最大痛点是什么？<br/>
👉 最期待Checkmate新增哪些智能特性？</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OkHttp网络框架设计]]></title>    <link>https://juejin.cn/post/7571815997068345384</link>    <guid>https://juejin.cn/post/7571815997068345384</guid>    <pubDate>2025-11-13T11:25:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571815997068345384" data-draft-id="7571768210716409871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OkHttp网络框架设计"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-13T11:25:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="杨充"/> <meta itemprop="url" content="https://juejin.cn/user/1978776659695784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OkHttp网络框架设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1978776659695784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    杨充
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:25:11.000Z" title="Thu Nov 13 2025 11:25:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">OkHttp网络框架设计</h2>
<h5 data-id="heading-1">目录介绍</h5>
<ul>
<li>01.整体概述介绍
<ul>
<li>1.1 概述介绍</li>
<li>1.2 核心特性说明</li>
<li>1.3 技术架构概览</li>
<li>1.4 问题思考</li>
</ul>
</li>
<li>02.核心架构设计
<ul>
<li>2.1 整体架构设计</li>
<li>2.2 整体设计思路</li>
<li>2.3 核心组件关系图</li>
</ul>
</li>
<li>03.核心组件详解
<ul>
<li>3.1 OkHttpClient</li>
<li>3.2 Request请求封装</li>
<li>3.3 Call请求执行接口</li>
<li>3.4 Dispatcher调度器</li>
<li>3.5 拦截器机制</li>
<li>3.6 Response返回</li>
</ul>
</li>
<li>04.核心流程分析
<ul>
<li>4.1 请求执行流程</li>
<li>4.2 连接管理流程</li>
<li>4.3 缓存处理流程</li>
</ul>
</li>
<li>05.关键技术特性
<ul>
<li>5.1 连接池管理</li>
<li>5.2 HTTP/2支持</li>
<li>5.3 缓存机制设计</li>
<li>5.4 安全特性设计</li>
<li>5.5 SSL/TLS流程</li>
</ul>
</li>
<li>06.性能优化策略
<ul>
<li>6.1 连接复用</li>
<li>6.2 请求合并</li>
<li>6.3 压缩传输</li>
<li>6.4 内存管理</li>
</ul>
</li>
<li>07.使用示例说明
<ul>
<li>7.1 基本使用</li>
<li>7.2 高级配置</li>
<li>7.3 统计请求耗时</li>
</ul>
</li>
<li>08.最佳实践
<ul>
<li>8.1 客户端复用</li>
<li>8.2 请求取消</li>
<li>8.3 错误处理</li>
</ul>
</li>
<li>09.架构优势
<ul>
<li>9.1 设计模式应用</li>
<li>9.2 SOLID原则体现</li>
<li>9.3 性能优势</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">01.整体概述介绍</h3>
<h4 data-id="heading-3">1.1 概述介绍</h4>
<p>OkHttp是一个高效的HTTP客户端库，专为Android和Java应用程序设计。基于OkHttpLib模块的源码分析，详细阐述了OkHttp的架构设计、核心组件、工作流程和技术特性。避免陷入代码细节，着重理解设计思想！</p>
<h4 data-id="heading-4">1.2 核心特性说明</h4>
<ul>
<li><strong>高效的HTTP/2支持</strong>：完整支持HTTP/2协议，包括连接复用、服务器推送等特性</li>
<li><strong>连接池管理</strong>：自动管理连接池，减少连接建立的开销</li>
<li><strong>透明的GZIP压缩</strong>：自动处理响应压缩，减少网络传输量</li>
<li><strong>响应缓存</strong>：支持HTTP缓存，避免重复请求</li>
<li><strong>请求/响应拦截</strong>：灵活的拦截器机制，支持请求和响应的定制化处理</li>
<li><strong>故障恢复</strong>：自动重试机制，提高网络请求的可靠性</li>
</ul>
<h4 data-id="heading-5">1.3 技术架构概览</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[应用层] --&gt; B[OkHttpClient]
    B --&gt; C[Request Builder]
    B --&gt; D[Call Factory]
    D --&gt; E[RealCall]
    E --&gt; F[Dispatcher]
    F --&gt; G[拦截器链]
    G --&gt; H[网络层]
    
    subgraph "拦截器链"
        I[应用拦截器]
        J[重试拦截器]
        K[桥接拦截器]
        L[缓存拦截器]
        M[连接拦截器]
        N[网络拦截器]
        O[服务器调用拦截器]
    end
    
    G --&gt; I
    I --&gt; J
    J --&gt; K
    K --&gt; L
    L --&gt; M
    M --&gt; N
    N --&gt; O
</code></pre>
<h4 data-id="heading-6">1.4 问题思考</h4>
<ul>
<li>OkHttp设计：OkHttp整体设计思路是什么样的？request和respond分别如何设计？如何设计call请求操作？</li>
<li>OkHttp同步异步：如何设计同步和异步请求？同步操作做了什么？异步操作如何处理逻辑？</li>
<li>OkHttp拦截器：拦截器是如何设计的？为什么需要拦截器？拦截器如何处理拦截，和向下分发逻辑？如何做重试机制的设计？</li>
<li>OkHttp缓存：如何设计缓存？什么情况下会用到网络缓存？缓存拦截器的核心思想是什么？</li>
<li>OkHttp分发器：同步和异步请求的Dispatcher是如何调度的？设计的巧妙之处是什么？</li>
<li>OkHttp线程池：使用了什么线程池？是如何管理线程任务？跟普通线程池使用有何区别？</li>
</ul>
<h3 data-id="heading-7">02.核心架构设计</h3>
<h4 data-id="heading-8">2.1 整体架构设计</h4>
<p>OkHttp采用分层架构设计，主要包括以下几个层次：</p>
<ol>
<li><strong>应用接口层</strong>：提供简洁的API接口，包括OkHttpClient、Request、Response等</li>
<li><strong>调度管理层</strong>：Dispatcher负责请求的调度和线程池管理</li>
<li><strong>拦截器链层</strong>：责任链模式实现的拦截器机制</li>
<li><strong>连接管理层</strong>：ConnectionPool管理HTTP连接的复用</li>
<li><strong>网络传输层</strong>：底层的Socket连接和数据传输</li>
</ol>
<h4 data-id="heading-9">2.2 整体设计思路</h4>
<p>网络请求到响应大概流程图如下所示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a03f661a0294b1693e804639ca02227~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2o5YWF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763637911&amp;x-signature=CUOeO9WdYpqlmWf3uboLitviqTM%3D" alt="image" loading="lazy"/></p>
<p>整体设计思路大概如下所示：</p>
<ul>
<li>第一步：创建OkHttpClient对象，由于创建这个对象十分复杂，因此采用builder设计模式构造</li>
<li>第二步：包装Request请求体对象，主要是存放url，header，get请求，post请求等等属性</li>
<li>第三步：通过newCall(request)去创建一个call请求</li>
<li>第四步：开始执行同步execute或者enqueue请求，这里会使用到线程池</li>
<li>第五步：添加各种拦截器，缓存拦截器，</li>
<li>第六步：处理缓存拦截，数据复用的技术逻辑</li>
<li>第七步：创建连接请求的操作，给服务端发送请求</li>
<li>第八步：获取返回response数据，这里主要是处理code和body数据</li>
</ul>
<h4 data-id="heading-10">2.3 核心组件关系图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class OkHttpClient {
        +Dispatcher dispatcher
        +List~Interceptor~ interceptors
        +ConnectionPool connectionPool
        +Cache cache
        +newCall(Request) Call
    }
    
    class Request {
        +HttpUrl url
        +String method
        +Headers headers
        +RequestBody body
    }
    
    class Call {
        &lt;&lt;interface&gt;&gt;
        +execute() Response
        +enqueue(Callback) void
        +cancel() void
    }
    
    class RealCall {
        +OkHttpClient client
        +Request originalRequest
        +execute() Response
        +enqueue(Callback) void
    }
    
    class Dispatcher {
        +ExecutorService executorService
        +Deque~AsyncCall~ readyAsyncCalls
        +Deque~AsyncCall~ runningAsyncCalls
        +Deque~RealCall~ runningSyncCalls
    }
    
    class Interceptor {
        &lt;&lt;interface&gt;&gt;
        +intercept(Chain) Response
    }
    
    OkHttpClient --&gt; Request : creates
    OkHttpClient --&gt; Call : newCall()
    Call &lt;|-- RealCall : implements
    OkHttpClient --&gt; Dispatcher : uses
    RealCall --&gt; Interceptor : uses
</code></pre>
<h3 data-id="heading-11">03.核心组件详解</h3>
<h4 data-id="heading-12">3.1 OkHttpClient</h4>
<p>OkHttpClient是整个框架的入口点，采用建造者模式进行配置：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OkHttpClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Cloneable</span>, Call.Factory, WebSocket.Factory {
    <span class="hljs-keyword">final</span> Dispatcher dispatcher;
    <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> Proxy proxy;
    <span class="hljs-keyword">final</span> List&lt;Protocol&gt; protocols;
    <span class="hljs-keyword">final</span> List&lt;ConnectionSpec&gt; connectionSpecs;
    <span class="hljs-keyword">final</span> List&lt;Interceptor&gt; interceptors;
    <span class="hljs-keyword">final</span> List&lt;Interceptor&gt; networkInterceptors;
    <span class="hljs-keyword">final</span> EventListener.Factory eventListenerFactory;
    <span class="hljs-keyword">final</span> ProxySelector proxySelector;
    <span class="hljs-keyword">final</span> CookieJar cookieJar;
    <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> Cache cache;
    <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> InternalCache internalCache;
    <span class="hljs-keyword">final</span> SocketFactory socketFactory;
    <span class="hljs-keyword">final</span> SSLSocketFactory sslSocketFactory;
    <span class="hljs-keyword">final</span> ConnectionPool connectionPool;
    <span class="hljs-comment">// ... 更多配置项</span>
}
</code></pre>
<p>创建OkHttpClient对象，主要是用于Api网络请求的对象。类似于初始化网络请求，可以设置超时时间，日志打印拦截器，代理，ssl校验，域名校验等等。</p>
<p><strong>主要职责</strong>：</p>
<ul>
<li>管理全局配置（超时、代理、SSL等）</li>
<li>创建Call对象</li>
<li>管理拦截器链</li>
<li>管理连接池和缓存</li>
</ul>
<h5 data-id="heading-13">3.1.1 创建流程架构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始创建OkHttpClient] --&gt; B{使用方式}
    
    B --&gt;|默认构造| C[new OkHttpClient]
    B --&gt;|Builder模式| D[new OkHttpClient.Builder]
    
    C --&gt; E[使用默认配置]
    D --&gt; F[配置各种参数]
    
    E --&gt; G[创建默认组件]
    F --&gt; H[验证配置参数]
    
    G --&gt; I[初始化Dispatcher]
    H --&gt; I
    
    I --&gt; J[初始化ConnectionPool]
    J --&gt; K[初始化SSL配置]
    K --&gt; L[初始化拦截器链]
    L --&gt; M[初始化缓存配置]
    M --&gt; N[初始化超时配置]
    N --&gt; O[初始化事件监听器]
    O --&gt; P[创建OkHttpClient实例]
    
    P --&gt; Q[客户端就绪]
    
    style C fill:#e3f2fd
    style D fill:#f3e5f5
    style G fill:#e8f5e8
    style H fill:#fff3e0
    style Q fill:#c8e6c9
</code></pre>
<h5 data-id="heading-14">3.1.2 Builder模式原理</h5>
<p>OkHttpClient采用Builder模式的主要原因：</p>
<ol>
<li><strong>参数众多</strong>：OkHttpClient有30+个配置参数</li>
<li><strong>可选配置</strong>：大部分参数都有合理的默认值</li>
<li><strong>不可变性</strong>：创建后的OkHttpClient实例不可修改</li>
<li><strong>链式调用</strong>：提供流畅的API体验</li>
<li><strong>参数验证</strong>：在build()时统一验证参数合法性</li>
</ol>
<h5 data-id="heading-15">3.1.3 Builder配置流程图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant Builder as OkHttpClient.Builder
    participant Validator as 参数验证器
    participant Factory as 组件工厂
    participant Client as OkHttpClient
    
    App-&gt;&gt;Builder: new Builder()
    Builder-&gt;&gt;Builder: 初始化默认配置
    
    loop 配置各种参数
        App-&gt;&gt;Builder: 设置配置项
        Builder-&gt;&gt;Builder: 存储配置值
    end
    
    App-&gt;&gt;Builder: build()
    Builder-&gt;&gt;Validator: 验证配置参数
    alt 参数无效
        Validator--&gt;&gt;Builder: 抛出异常
        Builder--&gt;&gt;App: 配置异常
    else 参数有效
        Validator--&gt;&gt;Builder: 验证通过
        Builder-&gt;&gt;Factory: 创建组件实例
        Factory--&gt;&gt;Builder: 返回组件
        Builder-&gt;&gt;Client: new OkHttpClient(builder)
        Client-&gt;&gt;Client: 复制Builder配置
        Client--&gt;&gt;Builder: OkHttpClient实例
        Builder--&gt;&gt;App: 返回客户端
    end
</code></pre>
<h5 data-id="heading-16">3.1.4 超时配置关系图</h5>
<p>在创建对象时，连接超时，读取超时，写入超时，完整请求超时，都可以灵活配置。那么这块是如何设计的呢？</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[超时配置] --&gt; B[callTimeout]
    A --&gt; C[connectTimeout]
    A --&gt; D[readTimeout]
    A --&gt; E[writeTimeout]
    A --&gt; F[pingInterval]
    
    B --&gt; G[整个请求的总超时时间]
    C --&gt; H[TCP连接建立超时]
    D --&gt; I[从服务器读取数据超时]
    E --&gt; J[向服务器写入数据超时]
    F --&gt; K[HTTP/2连接保活间隔]
    
    G --&gt; L[包含连接、读写、重定向等所有时间]
    H --&gt; M[默认10秒]
    I --&gt; N[默认10秒]
    J --&gt; O[默认10秒]
    K --&gt; P[默认0-不发送ping]
    
    style A fill:#e3f2fd
    style B fill:#ffebee
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#f3e5f5
    style F fill:#e1f5fe
</code></pre>
<h4 data-id="heading-17">3.2 Request请求封装</h4>
<p>主要是封装一个Request请求体。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
        .url(url)
        .addHeader(<span class="hljs-string">"cookie"</span>,<span class="hljs-string">"yangchong"</span>)
        .get()
        .build();
</code></pre>
<p>Request类封装了HTTP请求的所有信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Request</span> {
    <span class="hljs-keyword">final</span> HttpUrl url;
    <span class="hljs-keyword">final</span> String method;
    <span class="hljs-keyword">final</span> Headers headers;
    <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> RequestBody body;
    <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Object&gt; tags;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Builder</span> {
        <span class="hljs-meta">@Nullable</span> HttpUrl url;
        String method;
        Headers.Builder headers;
        <span class="hljs-meta">@Nullable</span> RequestBody body;
        Map&lt;Class&lt;?&gt;, Object&gt; tags = Collections.emptyMap();
    }
}
</code></pre>
<p>Request包括Headers和RequestBody，而RequestBody是abstract的，他的子类是有FormBody(表单提交的)和MultipartBody(文件上传)，分别对应了两种不同的MIME类型。</p>
<pre><code class="hljs language-text" lang="text">FormBody ："application/x-www-form-urlencoded"
MultipartBody："multipart/"+xxx.
</code></pre>
<p><strong>核心特性</strong>：</p>
<ul>
<li>不可变对象设计，线程安全</li>
<li>建造者模式构建</li>
<li>支持多种HTTP方法（GET、POST、PUT、DELETE等）</li>
<li>灵活的Header管理</li>
</ul>
<h4 data-id="heading-18">3.3 Call请求执行接口</h4>
<p>如何设计Call请求基于接口开发，设计了Call接口，里面主要做同步请求execute，异步请求enqueue，取消请求cancel等等。</p>
<p>Call类详解：有道词典翻译该类注释：调用是准备执行的请求。call可以取消。由于此对象表示单个请求/响应对(流)，因此不能执行两次。</p>
<p>主要是HTTP请求任务封装</p>
<ul>
<li>可以说我们能用到的操纵基本上都定义在这个接口里面了，可以通过Call对象来操作请求，同步请求execute，异步请求enqueue。</li>
<li>而Call接口内部提供了Factory工厂方法模式(将对象的创建延迟到工厂类的子类去进行，从而实现动态配置)。</li>
</ul>
<p>Call接口定义了请求执行的标准：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Call</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Cloneable</span> {
    Request <span class="hljs-title function_">request</span><span class="hljs-params">()</span>;
    Response <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">enqueue</span><span class="hljs-params">(Callback responseCallback)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isExecuted</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isCanceled</span><span class="hljs-params">()</span>;
    Timeout <span class="hljs-title function_">timeout</span><span class="hljs-params">()</span>;
    Call <span class="hljs-title function_">clone</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>RealCall实现</strong>：</p>
<ul>
<li>同步执行：<code>execute()</code>方法直接在当前线程执行</li>
<li>异步执行：<code>enqueue()</code>方法提交到线程池执行</li>
<li>请求取消：支持请求的取消操作</li>
</ul>
<h5 data-id="heading-19">3.3.1 核心方法对比</h5>



































<table><thead><tr><th>特性</th><th>execute()</th><th>enqueue()</th></tr></thead><tbody><tr><td>执行方式</td><td>同步阻塞</td><td>异步非阻塞</td></tr><tr><td>线程模型</td><td>当前线程执行</td><td>线程池执行</td></tr><tr><td>返回方式</td><td>直接返回Response</td><td>通过Callback回调</td></tr><tr><td>异常处理</td><td>抛出IOException</td><td>通过Callback.onFailure</td></tr><tr><td>调度管理</td><td>简单记录</td><td>复杂的队列调度</td></tr></tbody></table>
<h5 data-id="heading-20">3.3.2 执行流程架构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[应用调用] --&gt; B{选择执行方式}
    B --&gt;|同步| C[call.execute]
    B --&gt;|异步| D[call.enqueue]
    
    C --&gt; E[Dispatcher.executed]
    D --&gt; F[Dispatcher.enqueue]
    
    E --&gt; G[getResponseWithInterceptorChain]
    F --&gt; H[AsyncCall入队]
    H --&gt; I[promoteAndExecute]
    I --&gt; J[线程池执行AsyncCall]
    J --&gt; K[AsyncCall.execute]
    K --&gt; G
    
    G --&gt; L[拦截器链处理]
    L --&gt; M[网络请求]
    M --&gt; N[Response返回]
    
    N --&gt; O{执行方式}
    O --&gt;|同步| P[直接返回Response]
    O --&gt;|异步| Q[Callback.onResponse]
    
    style C fill:#e1f5fe
    style D fill:#f3e5f5
    style G fill:#fff3e0
    style L fill:#e8f5e8
</code></pre>
<h5 data-id="heading-21">3.3.3 Execute执行时序图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant RealCall as RealCall
    participant Transmitter as Transmitter
    participant Dispatcher as Dispatcher
    participant Chain as InterceptorChain
    participant Network as 网络层
    
    App-&gt;&gt;RealCall: execute()
    
    Note over RealCall: 1. 检查执行状态
    RealCall-&gt;&gt;RealCall: synchronized检查executed
    alt 已执行
        RealCall--&gt;&gt;App: IllegalStateException
    end
    RealCall-&gt;&gt;RealCall: executed = true
    
    Note over RealCall: 2. 超时和生命周期管理
    RealCall-&gt;&gt;Transmitter: timeoutEnter()
    RealCall-&gt;&gt;Transmitter: callStart()
    
    Note over RealCall: 3. 调度器管理
    RealCall-&gt;&gt;Dispatcher: executed(this)
    Note over Dispatcher: 添加到runningSyncCalls队列
    
    Note over RealCall: 4. 执行请求
    RealCall-&gt;&gt;Chain: getResponseWithInterceptorChain()
    Chain-&gt;&gt;Network: 网络请求处理
    Network--&gt;&gt;Chain: Response
    Chain--&gt;&gt;RealCall: Response
    
    Note over RealCall: 5. 清理工作
    RealCall-&gt;&gt;Dispatcher: finished(this)
    Note over Dispatcher: 从runningSyncCalls移除
    
    RealCall--&gt;&gt;App: Response
</code></pre>
<h5 data-id="heading-22">3.3.4 Enqueue执行时序图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant RealCall as RealCall
    participant Dispatcher as Dispatcher
    participant AsyncCall as AsyncCall
    participant ThreadPool as 线程池
    participant Chain as InterceptorChain
    participant Callback as Callback
    
    App-&gt;&gt;RealCall: enqueue(callback)
    
    Note over RealCall: 1. 状态检查和设置
    RealCall-&gt;&gt;RealCall: synchronized检查executed
    RealCall-&gt;&gt;RealCall: executed = true
    
    Note over RealCall: 2. 创建AsyncCall
    RealCall-&gt;&gt;AsyncCall: new AsyncCall(callback)
    RealCall-&gt;&gt;Dispatcher: enqueue(asyncCall)
    
    Note over Dispatcher: 3. 调度逻辑
    Dispatcher-&gt;&gt;Dispatcher: 添加到readyAsyncCalls
    Dispatcher-&gt;&gt;Dispatcher: promoteAndExecute()
    
    alt 可以立即执行
        Dispatcher-&gt;&gt;Dispatcher: 移动到runningAsyncCalls
        Dispatcher-&gt;&gt;AsyncCall: executeOn(executorService)
        AsyncCall-&gt;&gt;ThreadPool: execute(this)
        
        Note over ThreadPool: 4. 异步执行
        ThreadPool-&gt;&gt;AsyncCall: run()
        AsyncCall-&gt;&gt;AsyncCall: execute()
        AsyncCall-&gt;&gt;Chain: getResponseWithInterceptorChain()
        Chain--&gt;&gt;AsyncCall: Response
        
        Note over AsyncCall: 5. 回调处理
        AsyncCall-&gt;&gt;Callback: onResponse(call, response)
        AsyncCall-&gt;&gt;Dispatcher: finished(this)
    else 需要等待
        Note over Dispatcher: 保持在readyAsyncCalls队列中
    end
    
    RealCall--&gt;&gt;App: void (立即返回)
</code></pre>
<h4 data-id="heading-23">3.4 Dispatcher调度器</h4>
<p>网络请求肯定涉及多线程，如何处理大量任务？采用Dispatcher作为调度，与线程池配合实现了高并发，低阻塞的的运行。针对请求任务，采用Deque作为集合，按照入队的顺序先进先出。</p>
<p>Dispatcher负责管理请求的执行调度：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dispatcher</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxRequests</span> <span class="hljs-operator">=</span> <span class="hljs-number">64</span>;  <span class="hljs-comment">// 最大并发请求数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxRequestsPerHost</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;  <span class="hljs-comment">// 单主机最大并发数</span>
    
    <span class="hljs-comment">// 等待执行的异步请求队列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;AsyncCall&gt; readyAsyncCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();
    <span class="hljs-comment">// 正在执行的异步请求队列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;AsyncCall&gt; runningAsyncCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();
    <span class="hljs-comment">// 正在执行的同步请求队列</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayDeque</span>&lt;&gt;();
}
</code></pre>
<p><strong>调度策略</strong>：</p>
<ul>
<li>最大并发请求数限制（默认64个）</li>
<li>单主机最大并发数限制（默认5个）</li>
<li>使用双端队列管理等待和运行中的请求</li>
<li>自动的线程池管理</li>
</ul>
<h5 data-id="heading-24">3.4.1 Dispatcher架构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[Dispatcher] --&gt; B[ExecutorService]
    A --&gt; C[readyAsyncCalls]
    A --&gt; D[runningAsyncCalls]
    A --&gt; E[runningSyncCalls]
    
    B --&gt; F[ThreadPoolExecutor]
    F --&gt; G[核心线程数: 0]
    F --&gt; H[最大线程数: Integer.MAX_VALUE]
    F --&gt; I[空闲时间: 60秒]
    F --&gt; J[队列: SynchronousQueue]
    
    C --&gt; K[等待执行的异步请求]
    D --&gt; L[正在执行的异步请求]
    E --&gt; M[正在执行的同步请求]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style F fill:#e8f5e8
</code></pre>
<h5 data-id="heading-25">3.4.2 异步调度架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "Dispatcher异步调度架构"
        A[Dispatcher] --&gt; B[ExecutorService]
        A --&gt; C[readyAsyncCalls]
        A --&gt; D[runningAsyncCalls]
        A --&gt; E[runningSyncCalls]
        
        B --&gt; F[ThreadPoolExecutor]
        F --&gt; G[核心线程池]
        F --&gt; H[最大线程数]
        F --&gt; I[队列管理]
        
        subgraph "调度策略"
            J[最大并发请求]
            K[单主机最大请求]
            L[空闲回调]
        end
        
        subgraph "请求队列"
            C --&gt; M[等待队列]
            D --&gt; N[执行队列]
            E --&gt; O[同步队列]
        end
    end
</code></pre>
<h5 data-id="heading-26">3.4.3 调度策略流程图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[AsyncCall入队] --&gt; B[添加到readyAsyncCalls]
    B --&gt; C[调用promoteAndExecute]
    C --&gt; D{检查执行条件}
    
    D --&gt; E{总请求数 &lt; maxRequests?}
    E --&gt;|否| F[保持在ready队列]
    E --&gt;|是| G{主机请求数 &lt; maxRequestsPerHost?}
    
    G --&gt;|否| H[继续检查下一个]
    G --&gt;|是| I[移动到running队列]
    
    I --&gt; J[callsPerHost计数+1]
    J --&gt; K[提交到线程池执行]
    K --&gt; L[AsyncCall.execute]
    
    L --&gt; M[执行网络请求]
    M --&gt; N[请求完成]
    N --&gt; O[调用finished方法]
    O --&gt; P[callsPerHost计数-1]
    P --&gt; Q[从running队列移除]
    Q --&gt; R[再次调用promoteAndExecute]
    R --&gt; S[尝试执行ready队列中的请求]
    
    H --&gt; T{还有更多请求?}
    T --&gt;|是| D
    T --&gt;|否| U[结束本轮调度]
    
    F --&gt; U
    S --&gt; U
</code></pre>
<h4 data-id="heading-27">3.5 拦截器机制</h4>
<p>OKHttp有两种调用方式，一种是阻塞的同步请求，一种是异步的非阻塞的请求。</p>
<p>但是无论同步还是异步都会调用下RealCall的 getResponseWithInterceptorChain方法来完成请求，同时将返回数据或者状态通过Callback来完成。</p>
<blockquote>
<p>设计拦截器的核心原理</p>
</blockquote>
<p>Interceptor 负责拦截和分发。先来看看含义：观察，修改以及可能短路的请求输出和响应请求的回来。通常情况下拦截器用来添加，移除或者转换请求或者回应的头部信息。</p>
<p>拦截器，就像水管一样，把一节一节的水管(拦截器)连起来，形成一个回路。实际上client到server也是如此，通过一个又一个的interceptor串起来，然后把数据发送到服务器，又能接受返回的数据，每一个拦截器(水管)都有自己的作用，分别处理不同东西，比如消毒，净化，去杂质，就像一层层过滤网一样。</p>
<blockquote>
<p>接口是如何设计的</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Interceptor</span> {
   <span class="hljs-comment">//负责拦截</span>
  Response <span class="hljs-title function_">intercept</span><span class="hljs-params">(Chain chain)</span> <span class="hljs-keyword">throws</span> IOException;
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Chain</span> {
     <span class="hljs-comment">//负责分发、前行</span>
    Response <span class="hljs-title function_">proceed</span><span class="hljs-params">(Request request)</span> <span class="hljs-keyword">throws</span> IOException;
  }
}
</code></pre>
<h5 data-id="heading-28">3.5.1 拦截器时序图</h5>
<p>OkHttp的拦截器采用责任链模式，每个拦截器负责特定的功能：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant Client as OkHttpClient
    participant RealCall as RealCall
    participant Chain as InterceptorChain
    participant AppInt as 应用拦截器
    participant RetryInt as 重试拦截器
    participant BridgeInt as 桥接拦截器
    participant CacheInt as 缓存拦截器
    participant ConnInt as 连接拦截器
    participant NetInt as 网络拦截器
    participant CallInt as 调用服务器拦截器
    
    App-&gt;&gt;Client: newCall(request)
    Client-&gt;&gt;RealCall: create
    App-&gt;&gt;RealCall: execute()
    RealCall-&gt;&gt;Chain: proceed(request)
    Chain-&gt;&gt;AppInt: intercept(chain)
    AppInt-&gt;&gt;RetryInt: chain.proceed()
    RetryInt-&gt;&gt;BridgeInt: chain.proceed()
    BridgeInt-&gt;&gt;CacheInt: chain.proceed()
    CacheInt-&gt;&gt;ConnInt: chain.proceed()
    ConnInt-&gt;&gt;NetInt: chain.proceed()
    NetInt-&gt;&gt;CallInt: chain.proceed()
    CallInt--&gt;&gt;NetInt: response
    NetInt--&gt;&gt;ConnInt: response
    ConnInt--&gt;&gt;CacheInt: response
    CacheInt--&gt;&gt;BridgeInt: response
    BridgeInt--&gt;&gt;RetryInt: response
    RetryInt--&gt;&gt;AppInt: response
    AppInt--&gt;&gt;Chain: response
    Chain--&gt;&gt;RealCall: response
    RealCall--&gt;&gt;App: response
</code></pre>
<h5 data-id="heading-29">3.5.2 拦截器类关系图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class Interceptor {
        &lt;&lt;interface&gt;&gt;
        +intercept(Chain) Response
    }
    
    class Chain {
        &lt;&lt;interface&gt;&gt;
        +request() Request
        +proceed(Request) Response
        +connection() Connection
        +call() Call
    }
    
    class RealInterceptorChain {
        -List~Interceptor~ interceptors
        -Transmitter transmitter
        -Exchange exchange
        -int index
        -Request request
        +proceed(Request) Response
        +proceed(Request, Transmitter, Exchange) Response
    }
    
    class RetryAndFollowUpInterceptor {
        -OkHttpClient client
        -int MAX_FOLLOW_UPS
        +intercept(Chain) Response
        -recover(IOException, Transmitter, boolean, Request) boolean
        -followUpRequest(Response, Route) Request
    }
    
    class BridgeInterceptor {
        -CookieJar cookieJar
        +intercept(Chain) Response
        -cookieHeader(List~Cookie~) String
    }
    
    class CacheInterceptor {
        -InternalCache cache
        +intercept(Chain) Response
        -cacheCandidate(Request) Response
        -strategy(Request, Response) CacheStrategy
    }
    
    class ConnectInterceptor {
        -OkHttpClient client
        +intercept(Chain) Response
    }
    
    class CallServerInterceptor {
        -boolean forWebSocket
        +intercept(Chain) Response
    }
    
    Interceptor &lt;|-- RetryAndFollowUpInterceptor
    Interceptor &lt;|-- BridgeInterceptor
    Interceptor &lt;|-- CacheInterceptor
    Interceptor &lt;|-- ConnectInterceptor
    Interceptor &lt;|-- CallServerInterceptor
    Chain &lt;|-- RealInterceptorChain
    RealInterceptorChain --&gt; Interceptor : uses
</code></pre>
<h5 data-id="heading-30">3.5.3 内置拦截器详解</h5>
<ol>
<li><strong>应用拦截器（Application Interceptors）</strong></li>
</ol>
<ul>
<li>用户自定义的拦截器</li>
<li>在请求发送前和响应接收后执行</li>
<li>可以修改请求和响应</li>
</ul>
<ol start="2">
<li><strong>重试和重定向拦截器（RetryAndFollowUpInterceptor）</strong></li>
</ol>
<ul>
<li>处理请求失败重试</li>
<li>处理HTTP重定向</li>
<li>管理连接的获取和释放</li>
</ul>
<ol start="3">
<li><strong>桥接拦截器（BridgeInterceptor）</strong></li>
</ol>
<ul>
<li>将用户请求转换为网络请求</li>
<li>添加必要的HTTP头（Content-Type、Content-Length等）</li>
<li>处理Cookie</li>
<li>处理GZIP压缩</li>
</ul>
<ol start="4">
<li><strong>缓存拦截器（CacheInterceptor）</strong></li>
</ol>
<ul>
<li>实现HTTP缓存策略</li>
<li>处理缓存的读取和写入</li>
<li>支持强制缓存和协商缓存</li>
</ul>
<ol start="5">
<li><strong>连接拦截器（ConnectInterceptor）</strong></li>
</ol>
<ul>
<li>建立与服务器的连接</li>
<li>管理连接池</li>
<li>处理HTTP/2连接复用</li>
</ul>
<ol start="6">
<li><strong>网络拦截器（Network Interceptors）</strong></li>
</ol>
<ul>
<li>用户自定义的网络级拦截器</li>
<li>在实际网络请求前后执行</li>
</ul>
<ol start="7">
<li><strong>调用服务器拦截器（CallServerInterceptor）</strong></li>
</ol>
<ul>
<li>实际的网络IO操作</li>
<li>发送请求数据</li>
<li>读取响应数据</li>
</ul>
<h5 data-id="heading-31">3.5.4 重定向拦截器</h5>
<p>核心功能</p>
<ul>
<li><strong>异常恢复</strong>：处理网络异常和连接失败</li>
<li><strong>重定向处理</strong>：自动处理HTTP重定向响应</li>
<li><strong>重试逻辑</strong>：根据策略决定是否重试请求</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[接收请求] --&gt; B[准备连接]
    B --&gt; C{是否被取消?}
    C --&gt;|是| D[抛出IOException]
    C --&gt;|否| E[执行下一个拦截器]
    
    E --&gt; F{是否发生异常?}
    F --&gt;|是| G[调用recover方法]
    F --&gt;|否| H[检查响应状态]
    
    G --&gt; I{是否可恢复?}
    I --&gt;|是| J[继续重试]
    I --&gt;|否| K[抛出异常]
    
    H --&gt; L[调用followUpRequest]
    L --&gt; M{需要重定向?}
    M --&gt;|否| N[返回响应]
    M --&gt;|是| O{重定向次数超限?}
    
    O --&gt;|是| P[抛出ProtocolException]
    O --&gt;|否| Q[更新请求]
    Q --&gt; R[关闭当前响应]
    R --&gt; J
    
    J --&gt; B
    
    style G fill:#ffebee
    style I fill:#fff3e0
    style M fill:#e8f5e8
    style O fill:#fce4ec
</code></pre>
<h5 data-id="heading-32">3.5.6 缓存拦截器</h5>
<p>核心功能</p>
<ul>
<li><strong>缓存策略</strong>：根据HTTP缓存规范决定缓存行为</li>
<li><strong>缓存读取</strong>：从缓存中读取有效的响应</li>
<li><strong>缓存写入</strong>：将可缓存的响应写入缓存</li>
<li><strong>条件请求</strong>：发送If-None-Match、If-Modified-Since等条件请求</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[接收请求] --&gt; B[从缓存获取候选响应]
    B --&gt; C[计算缓存策略]
    C --&gt; D{网络请求为null?}
    
    D --&gt;|是| E{缓存响应为null?}
    D --&gt;|否| F{缓存响应为null?}
    
    E --&gt;|是| G[返回504错误]
    E --&gt;|否| H[返回缓存响应]
    
    F --&gt;|是| I[执行网络请求]
    F --&gt;|否| J[执行条件网络请求]
    
    I --&gt; K[获取网络响应]
    J --&gt; L[获取网络响应]
    
    K --&gt; M{响应可缓存?}
    L --&gt; N{响应状态码?}
    
    N --&gt;|304| O[更新缓存响应]
    N --&gt;|其他| P[使用网络响应]
    
    O --&gt; Q[返回更新后的缓存响应]
    P --&gt; R{响应可缓存?}
    
    M --&gt;|是| S[写入缓存]
    M --&gt;|否| T[返回网络响应]
    
    R --&gt;|是| U[写入缓存]
    R --&gt;|否| V[返回网络响应]
    
    S --&gt; T
    U --&gt; V
    
    style D fill:#e3f2fd
    style E fill:#f3e5f5
    style F fill:#e8f5e8
    style M fill:#fff3e0
    style N fill:#fce4ec
    style R fill:#e0f2f1
</code></pre>
<h5 data-id="heading-33">3.5.7 网络请求拦截器</h5>
<p>CallServerInterceptor（网络请求拦截器）</p>
<ul>
<li><strong>请求发送</strong>：将HTTP请求发送到服务器</li>
<li><strong>响应接收</strong>：接收服务器的HTTP响应</li>
<li><strong>流控制</strong>：管理请求和响应的数据流</li>
<li><strong>协议处理</strong>：处理HTTP/1.1和HTTP/2的具体协议细节</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Chain as RealInterceptorChain
    participant CallServer as CallServerInterceptor
    participant Exchange as Exchange
    participant Codec as ExchangeCodec
    participant Connection as RealConnection
    participant Server as 服务器
    
    Chain-&gt;&gt;CallServer: intercept(chain)
    CallServer-&gt;&gt;Exchange: writeRequestHeaders(request)
    Exchange-&gt;&gt;Codec: writeRequestHeaders(request)
    Codec-&gt;&gt;Connection: 发送请求头
    Connection-&gt;&gt;Server: HTTP请求头
    
    alt 有请求体
        CallServer-&gt;&gt;Exchange: createRequestBody(request)
        CallServer-&gt;&gt;CallServer: 写入请求体数据
        CallServer-&gt;&gt;Exchange: finishRequest()
        Exchange-&gt;&gt;Codec: finishRequest()
        Codec-&gt;&gt;Connection: 发送请求体
        Connection-&gt;&gt;Server: HTTP请求体
    end
    
    CallServer-&gt;&gt;Exchange: readResponseHeaders()
    Exchange-&gt;&gt;Codec: readResponseHeaders()
    Codec-&gt;&gt;Connection: 读取响应头
    Connection-&gt;&gt;Server: 请求响应头
    Server--&gt;&gt;Connection: HTTP响应头
    Connection--&gt;&gt;Codec: 响应头数据
    Codec--&gt;&gt;Exchange: 解析后的响应头
    Exchange--&gt;&gt;CallServer: Response.Builder
    
    alt 有响应体
        CallServer-&gt;&gt;Exchange: openResponseBody(response)
        Exchange-&gt;&gt;Codec: openResponseBodySource(response)
        Note over CallServer: 创建响应体Source
    end
    
    CallServer--&gt;&gt;Chain: 完整的Response对象
</code></pre>
<h5 data-id="heading-34">3.5.8 拦截器链状态管理</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; Created: new RealInterceptorChain()
    Created --&gt; Executing: proceed()调用
    Executing --&gt; NextInterceptor: index++, 创建新链
    NextInterceptor --&gt; Executing: interceptor.intercept()
    Executing --&gt; Completed: 返回Response
    Executing --&gt; Error: 异常发生
    Error --&gt; [*]
    Completed --&gt; [*]
    
    note right of NextInterceptor
        每次proceed()调用都会：
        1. index + 1
        2. 创建新的RealInterceptorChain
        3. 传递给下一个拦截器
    end note
</code></pre>
<h4 data-id="heading-35">3.6 Response返回</h4>
<p>Response核心职责</p>
<ul>
<li><strong>响应封装</strong>：统一封装HTTP响应的所有信息</li>
<li><strong>流式处理</strong>：支持大文件的流式读取和处理</li>
<li><strong>内存管理</strong>：优化内存使用，避免大响应体的内存溢出</li>
<li><strong>协议适配</strong>：支持HTTP/1.1和HTTP/2协议的响应处理</li>
<li><strong>缓存集成</strong>：与缓存系统无缝集成</li>
</ul>
<h5 data-id="heading-36">3.6.1 类层次结构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class Response {
        -Request request
        -Protocol protocol
        -int code
        -String message
        -Headers headers
        -ResponseBody body
        -Response networkResponse
        -Response cacheResponse
        -Response priorResponse
        -Handshake handshake
        -long sentRequestAtMillis
        -long receivedResponseAtMillis
        +Builder newBuilder()
        +boolean isSuccessful()
        +boolean isRedirect()
        +String header(String)
        +List~String~ headers(String)
        +ResponseBody body()
        +void close()
    }
    
    class ResponseBody {
        &lt;&lt;abstract&gt;&gt;
        +MediaType contentType()
        +long contentLength()
        +BufferedSource source()
        +String string()
        +byte[] bytes()
        +InputStream byteStream()
        +Reader charStream()
        +void close()
    }
    
    class RealResponseBody {
        -String contentTypeString
        -long contentLength
        -BufferedSource source
        +MediaType contentType()
        +long contentLength()
        +BufferedSource source()
    }
    
    class Headers {
        -String[] namesAndValues
        +String get(String)
        +List~String~ values(String)
        +Set~String~ names()
        +int size()
        +String name(int)
        +String value(int)
        +Builder newBuilder()
    }
    
    class Builder {
        -Request request
        -Protocol protocol
        -int code
        -String message
        -Headers.Builder headers
        -ResponseBody body
        +Builder request(Request)
        +Builder protocol(Protocol)
        +Builder code(int)
        +Builder message(String)
        +Builder header(String, String)
        +Builder headers(Headers)
        +Builder body(ResponseBody)
        +Response build()
    }
    
    Response --&gt; ResponseBody : contains
    Response --&gt; Headers : contains
    Response --&gt; Builder : creates
    ResponseBody &lt;|-- RealResponseBody : implements
    Response -- Builder : inner class
</code></pre>
<h5 data-id="heading-37">3.6.2 创建流程架构图</h5>
<p>Response创建流程架构图</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[服务器响应] --&gt; B[ExchangeCodec读取]
    B --&gt; C{协议类型}
    
    C --&gt;|HTTP/1.1| D[Http1ExchangeCodec]
    C --&gt;|HTTP/2| E[Http2ExchangeCodec]
    
    D --&gt; F[解析状态行]
    E --&gt; G[解析HTTP/2帧]
    
    F --&gt; H[解析响应头]
    G --&gt; H
    
    H --&gt; I[创建Response.Builder]
    I --&gt; J[设置基本信息]
    J --&gt; K[设置响应头]
    K --&gt; L[创建ResponseBody]
    L --&gt; M[构建Response对象]
    
    M --&gt; N[拦截器处理]
    N --&gt; O[返回给应用层]
    
    style D fill:#e3f2fd
    style E fill:#f3e5f5
    style I fill:#e8f5e8
    style L fill:#fff3e0
    style N fill:#fce4ec
</code></pre>
<h5 data-id="heading-38">3.6.3 状态行解析流程图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[读取状态行] --&gt; B[StatusLine.parse]
    B --&gt; C{解析成功?}
    C --&gt;|否| D[抛出ProtocolException]
    C --&gt;|是| E[提取协议版本]
    E --&gt; F[提取状态码]
    F --&gt; G[提取状态消息]
    G --&gt; H[创建Response.Builder]
    H --&gt; I[设置protocol]
    I --&gt; J[设置code]
    J --&gt; K[设置message]
    K --&gt; L{状态码检查}
    L --&gt;|100 Continue| M{期望Continue?}
    L --&gt;|其他| N[读取响应头]
    M --&gt;|是| O[返回null]
    M --&gt;|否| P[返回Builder]
    N --&gt; Q[返回完整Builder]
    
    style C fill:#fff3e0
    style L fill:#e3f2fd
    style M fill:#f3e5f5
</code></pre>
<h5 data-id="heading-39">3.6.4 Headers解析流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Codec as ExchangeCodec
    participant Reader as Source/BufferedSource
    participant Headers as Headers.Builder
    participant Parser as HeaderParser
    
    Codec-&gt;&gt;Reader: readHeaderLine()
    loop 读取每一行
        Reader--&gt;&gt;Codec: 响应头行
        alt 空行(响应头结束)
            Codec-&gt;&gt;Codec: break
        else 正常响应头
            Codec-&gt;&gt;Parser: 解析头部名称和值
            Parser--&gt;&gt;Codec: name, value
            Codec-&gt;&gt;Headers: addLenient(name, value)
        else 多行头部(折叠)
            Codec-&gt;&gt;Parser: 处理折叠行
            Parser--&gt;&gt;Codec: 合并后的值
            Codec-&gt;&gt;Headers: 更新头部值
        end
    end
    Headers--&gt;&gt;Codec: Headers对象
</code></pre>
<h5 data-id="heading-40">3.6.5 ResponseBody架构设计</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class ResponseBody {
        &lt;&lt;abstract&gt;&gt;
        +MediaType contentType()
        +long contentLength()
        +BufferedSource source()
        +String string()
        +byte[] bytes()
        +InputStream byteStream()
        +Reader charStream()
        +void close()
        +create(MediaType, String)$ ResponseBody
        +create(MediaType, byte[])$ ResponseBody
        +create(MediaType, long, BufferedSource)$ ResponseBody
    }
    
    class RealResponseBody {
        -String contentTypeString
        -long contentLength
        -BufferedSource source
        +MediaType contentType()
        +long contentLength()
        +BufferedSource source()
    }
    
    class CacheWritingResponseBody {
        -ResponseBody delegate
        -CacheRequest cacheRequest
        -BufferedSink cacheBody
        -Source cacheWritingSource
        +long contentLength()
        +BufferedSource source()
    }
    
    class GzipResponseBody {
        -ResponseBody responseBody
        -GzipSource gzipSource
        +long contentLength()
        +BufferedSource source()
    }
    
    ResponseBody &lt;|-- RealResponseBody
    ResponseBody &lt;|-- CacheWritingResponseBody
    ResponseBody &lt;|-- GzipResponseBody
    CacheWritingResponseBody --&gt; ResponseBody : delegates to
    GzipResponseBody --&gt; ResponseBody : wraps
</code></pre>
<h5 data-id="heading-41">3.6.6 ResponseBody数据读取</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[ResponseBody数据读取] --&gt; B{读取方式选择}
    
    B --&gt;|小数据| C[string方法]
    B --&gt;|二进制数据| D[bytes方法]
    B --&gt;|流式读取| E[source方法]
    B --&gt;|InputStream| F[byteStream方法]
    B --&gt;|字符流| G[charStream方法]
    
    C --&gt; H[一次性读取到内存]
    D --&gt; I[一次性读取到字节数组]
    E --&gt; J[BufferedSource流式读取]
    F --&gt; K[InputStream包装]
    G --&gt; L[Reader字符流]
    
    H --&gt; M{数据大小}
    I --&gt; M
    M --&gt;|小于1MB| N[适合]
    M --&gt;|大于1MB| O[可能OOM]
    
    J --&gt; P[内存友好]
    K --&gt; P
    L --&gt; P
    
    style C fill:#ffebee
    style D fill:#ffebee
    style E fill:#e8f5e8
    style F fill:#e8f5e8
    style G fill:#e8f5e8
    style O fill:#ffcdd2
    style P fill:#c8e6c9
</code></pre>
<h5 data-id="heading-42">3.6.7 Response生命周期</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用代码
    participant Call as RealCall
    participant Chain as InterceptorChain
    participant Exchange as Exchange
    participant Codec as ExchangeCodec
    participant Response as Response
    participant Body as ResponseBody
    
    App-&gt;&gt;Call: execute() / enqueue()
    Call-&gt;&gt;Chain: getResponseWithInterceptorChain()
    Chain-&gt;&gt;Exchange: 拦截器链处理
    Exchange-&gt;&gt;Codec: readResponseHeaders()
    Codec--&gt;&gt;Exchange: Response.Builder
    Exchange-&gt;&gt;Exchange: openResponseBody()
    Exchange-&gt;&gt;Body: 创建ResponseBody
    Body--&gt;&gt;Exchange: ResponseBody实例
    Exchange-&gt;&gt;Response: Builder.body().build()
    Response--&gt;&gt;Chain: 完整Response
    Chain--&gt;&gt;Call: Response
    Call--&gt;&gt;App: Response
    
    Note over App: 应用处理Response
    App-&gt;&gt;Body: string() / bytes() / source()
    Body--&gt;&gt;App: 响应数据
    App-&gt;&gt;Response: close()
    Response-&gt;&gt;Body: close()
    Body-&gt;&gt;Codec: 关闭底层连接
</code></pre>
<h5 data-id="heading-43">3.6.8 响应数据处理</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[响应数据处理] --&gt; B{数据大小评估}
    B --&gt;|小于64KB| C[直接内存读取]
    B --&gt;|64KB-1MB| D[分块读取]
    B --&gt;|大于1MB| E[流式处理]
    
    C --&gt; F[string/bytes方法]
    D --&gt; G[BufferedSource分块]
    E --&gt; H[InputStream/Reader]
    
    F --&gt; I[一次性分配内存]
    G --&gt; J[固定大小缓冲区]
    H --&gt; K[按需分配]
    
    I --&gt; L{内存充足?}
    L --&gt;|是| M[正常处理]
    L --&gt;|否| N[OutOfMemoryError]
    
    J --&gt; O[内存可控]
    K --&gt; O
    
    style N fill:#ffcdd2
    style O fill:#c8e6c9
    style M fill:#e8f5e8
</code></pre>
<h5 data-id="heading-44">3.6.9 Response错误处理</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[Response处理] --&gt; B{状态码检查}
    B --&gt;|2xx| C[成功响应]
    B --&gt;|3xx| D[重定向处理]
    B --&gt;|4xx| E[客户端错误]
    B --&gt;|5xx| F[服务器错误]
    
    C --&gt; G[正常处理ResponseBody]
    D --&gt; H[RetryAndFollowUpInterceptor处理]
    E --&gt; I[应用层错误处理]
    F --&gt; J[可能重试]
    
    G --&gt; K{ResponseBody读取}
    K --&gt;|成功| L[返回数据]
    K --&gt;|IO异常| M[连接错误处理]
    K --&gt;|协议异常| N[协议错误处理]
    
    H --&gt; O[自动重定向]
    I --&gt; P[返回错误Response]
    J --&gt; Q[重试或失败]
    
    M --&gt; R[关闭连接]
    N --&gt; R
    R --&gt; S[抛出异常]
    
    style E fill:#fff3e0
    style F fill:#ffebee
    style M fill:#ffcdd2
    style N fill:#ffcdd2
</code></pre>
<h5 data-id="heading-45">3.6.10 Response缓存机制</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用
    participant Cache as CacheInterceptor
    participant DiskCache as DiskLruCache
    participant Network as 网络层
    participant Response as Response
    
    App-&gt;&gt;Cache: 请求
    Cache-&gt;&gt;DiskCache: 查找缓存
    alt 缓存命中且有效
        DiskCache--&gt;&gt;Cache: 缓存Response
        Cache-&gt;&gt;Response: 创建缓存Response
        Response--&gt;&gt;App: 返回缓存数据
    else 缓存过期或不存在
        Cache-&gt;&gt;Network: 网络请求
        Network--&gt;&gt;Cache: 网络Response
        Cache-&gt;&gt;DiskCache: 存储Response
        Cache-&gt;&gt;Response: 包装为缓存写入Response
        Response--&gt;&gt;App: 返回网络数据
        Note over Response: 读取时同时写入缓存
    end
</code></pre>
<h3 data-id="heading-46">04.核心流程分析</h3>
<h4 data-id="heading-47">4.1 请求执行流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[创建OkHttpClient] --&gt; B[构建Request]
    B --&gt; C[调用newCall创建Call]
    C --&gt; D{同步还是异步?}
    
    D --&gt;|同步| E[call.execute]
    D --&gt;|异步| F[call.enqueue]
    
    E --&gt; G[Dispatcher调度]
    F --&gt; H[加入异步队列]
    H --&gt; I[线程池执行]
    I --&gt; G
    
    G --&gt; J[构建拦截器链]
    J --&gt; K[依次执行拦截器]
    K --&gt; L[发送网络请求]
    L --&gt; M[接收响应]
    M --&gt; N[拦截器链处理响应]
    N --&gt; O[返回Response]
    
    O --&gt; P{异步?}
    P --&gt;|是| Q[回调Callback]
    P --&gt;|否| R[直接返回]
</code></pre>
<h4 data-id="heading-48">4.2 连接管理流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Call as RealCall
    participant ConnInt as ConnectInterceptor
    participant Pool as ConnectionPool
    participant Conn as RealConnection
    participant Socket as Socket
    
    Call-&gt;&gt;ConnInt: intercept()
    ConnInt-&gt;&gt;Pool: get(address)
    
    alt 连接池中有可用连接
        Pool--&gt;&gt;ConnInt: 返回现有连接
    else 需要创建新连接
        ConnInt-&gt;&gt;Conn: create new
        Conn-&gt;&gt;Socket: connect()
        Socket--&gt;&gt;Conn: connected
        Conn--&gt;&gt;Pool: put(connection)
        Pool--&gt;&gt;ConnInt: 返回新连接
    end
    
    ConnInt-&gt;&gt;Call: proceed with connection
</code></pre>
<h4 data-id="heading-49">4.3 缓存处理流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[请求到达缓存拦截器] --&gt; B{缓存是否存在?}
    
    B --&gt;|否| C[继续网络请求]
    B --&gt;|是| D{缓存是否有效?}
    
    D --&gt;|有效| E[返回缓存响应]
    D --&gt;|需要验证| F[添加条件请求头]
    D --&gt;|过期| C
    
    F --&gt; G[发送条件请求]
    G --&gt; H{服务器响应}
    
    H --&gt;|304 Not Modified| I[返回缓存内容]
    H --&gt;|200 OK| J[更新缓存并返回新内容]
    
    C --&gt; K[网络请求]
    K --&gt; L{响应可缓存?}
    L --&gt;|是| M[存储到缓存]
    L --&gt;|否| N[直接返回响应]
    M --&gt; N
</code></pre>
<h3 data-id="heading-50">05.关键技术特性</h3>
<h4 data-id="heading-51">5.1 连接池管理</h4>
<p>OkHttp使用连接池来复用HTTP连接，提高性能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConnectionPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(
        <span class="hljs-number">0</span>, Integer.MAX_VALUE, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;&gt;(), 
        Util.threadFactory(<span class="hljs-string">"OkHttp ConnectionPool"</span>, <span class="hljs-literal">true</span>)
    );
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RealConnectionPool delegate;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConnectionPool</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConnectionPool</span><span class="hljs-params">(<span class="hljs-type">int</span> maxIdleConnections, <span class="hljs-type">long</span> keepAliveDuration, TimeUnit timeUnit)</span> {
        <span class="hljs-built_in">this</span>.delegate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealConnectionPool</span>(taskRunner, maxIdleConnections, keepAliveDuration, timeUnit);
    }
}
</code></pre>
<p><strong>连接池特性</strong>：</p>
<ul>
<li>默认最大空闲连接数：5个</li>
<li>默认连接保活时间：5分钟</li>
<li>自动清理过期连接</li>
<li>支持HTTP/1.1和HTTP/2连接复用</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[ConnectionPool创建] --&gt; B[设置最大空闲连接数: 5]
    B --&gt; C[设置连接保活时间: 5分钟]
    C --&gt; D[创建RealConnectionPool]
    D --&gt; E[启动清理线程池]
    
    E --&gt; F[连接使用流程]
    F --&gt; G{需要新连接?}
    G --&gt;|是| H[创建新连接]
    G --&gt;|否| I[复用现有连接]
    
    H --&gt; J[连接加入池中]
    I --&gt; K[更新连接使用时间]
    J --&gt; L[连接使用完毕]
    K --&gt; L
    
    L --&gt; M[连接变为空闲状态]
    M --&gt; N[清理线程检查]
    N --&gt; O{连接过期?}
    O --&gt;|是| P[移除并关闭连接]
    O --&gt;|否| Q[保持连接]
    
    P --&gt; R[连接池维护完成]
    Q --&gt; R
    
    style A fill:#e3f2fd
    style D fill:#f3e5f5
    style G fill:#fff3e0
    style O fill:#ffebee
</code></pre>
<h4 data-id="heading-52">5.2 HTTP/2支持</h4>
<p>OkHttp完整支持HTTP/2协议：</p>
<ul>
<li><strong>多路复用</strong>：单个连接上并发处理多个请求</li>
<li><strong>服务器推送</strong>：服务器主动推送资源</li>
<li><strong>头部压缩</strong>：HPACK算法压缩HTTP头部</li>
<li><strong>流量控制</strong>：精确控制数据传输速率</li>
</ul>
<h5 data-id="heading-53">5.2.1 HTTP/2连接架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "HTTP/2多路复用架构"
        A[Http2Connection] --&gt; B[Http2Writer]
        A --&gt; C[Http2Reader]
        A --&gt; D[Settings]
        A --&gt; E[流管理器]
        
        E --&gt; F[Http2Stream 1]
        E --&gt; G[Http2Stream 2]
        E --&gt; H[Http2Stream N]
        
        subgraph "流控制"
            I[连接级流控]
            J[流级流控]
            K[窗口更新]
        end
        
        subgraph "帧处理"
            L[DATA帧]
            M[HEADERS帧]
            N[SETTINGS帧]
            O[WINDOW_UPDATE帧]
            P[PING帧]
        end
        
        F --&gt; I
        G --&gt; I
        H --&gt; I
        
        F --&gt; J
        G --&gt; J
        H --&gt; J
    end
</code></pre>
<h4 data-id="heading-54">5.3 缓存机制设计</h4>
<p>实现完整的HTTP缓存策略：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Interceptor</span> {
    <span class="hljs-meta">@Override</span> 
    <span class="hljs-keyword">public</span> Response <span class="hljs-title function_">intercept</span><span class="hljs-params">(Chain chain)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Response</span> <span class="hljs-variable">cacheCandidate</span> <span class="hljs-operator">=</span> cache != <span class="hljs-literal">null</span> ? cache.get(chain.request()) : <span class="hljs-literal">null</span>;
        
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">CacheStrategy</span> <span class="hljs-variable">strategy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheStrategy</span>.Factory(now, chain.request(), cacheCandidate).get();
        <span class="hljs-type">Request</span> <span class="hljs-variable">networkRequest</span> <span class="hljs-operator">=</span> strategy.networkRequest;
        <span class="hljs-type">Response</span> <span class="hljs-variable">cacheResponse</span> <span class="hljs-operator">=</span> strategy.cacheResponse;
        
        <span class="hljs-comment">// 缓存策略处理逻辑</span>
        <span class="hljs-keyword">if</span> (networkRequest == <span class="hljs-literal">null</span> &amp;&amp; cacheResponse == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>.Builder()
                .request(chain.request())
                .protocol(Protocol.HTTP_1_1)
                .code(<span class="hljs-number">504</span>)
                .message(<span class="hljs-string">"Unsatisfiable Request (only-if-cached)"</span>)
                .build();
        }
        
        <span class="hljs-keyword">if</span> (networkRequest == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> cacheResponse.newBuilder()
                .cacheResponse(stripBody(cacheResponse))
                .build();
        }
        
        <span class="hljs-comment">// 继续网络请求...</span>
    }
}
</code></pre>
<h5 data-id="heading-55">5.3.1 缓存架构设计</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp缓存架构"
        A[OkHttpClient] --&gt; B[CacheInterceptor]
        B --&gt; C[CacheStrategy]
        C --&gt; D[Cache]
        D --&gt; E[DiskLruCache]
        
        F[Request] --&gt; G[CacheControl]
        H[Response] --&gt; I[Headers]
        I --&gt; J[CacheControl]
        
        B --&gt; K[InternalCache]
        K --&gt; L[CacheRequest]
        K --&gt; M[Response缓存]
        
        subgraph "缓存决策"
            C --&gt; N[网络请求]
            C --&gt; O[缓存响应]
            C --&gt; P[条件请求]
        end
        
        subgraph "存储层"
            E --&gt; Q[Journal文件]
            E --&gt; R[Entry文件]
            E --&gt; S[Snapshot]
        end
    end
</code></pre>
<h5 data-id="heading-56">5.3.2 缓存核心组件</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class Cache {
        -DiskLruCache cache
        -InternalCache internalCache
        +get(Request) Response
        +put(Response) CacheRequest
        +remove(Request)
        +urls() Iterator
        +size() long
        +maxSize() long
    }
    
    class CacheInterceptor {
        -InternalCache cache
        +intercept(Chain) Response
        -cacheWritingResponse(CacheRequest, Response) Response
    }
    
    class CacheStrategy {
        +Factory factory
        +networkRequest Request
        +cacheResponse Response
        +get() CacheStrategy
    }
    
    class DiskLruCache {
        -File directory
        -long maxSize
        -Map&lt;String, Entry&gt; lruEntries
        +get(String) Snapshot
        +edit(String) Editor
        +remove(String) boolean
    }
    
    class CacheControl {
        -boolean noCache
        -boolean noStore
        -int maxAgeSeconds
        -int maxStaleSeconds
        -int minFreshSeconds
        +parse(Headers) CacheControl
    }
    
    Cache --&gt; DiskLruCache
    Cache --&gt; InternalCache
    CacheInterceptor --&gt; Cache
    CacheInterceptor --&gt; CacheStrategy
    CacheStrategy --&gt; CacheControl
</code></pre>
<h5 data-id="heading-57">5.3.3 缓存决策流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[接收请求] --&gt; B{检查缓存}
    B --&gt;|无缓存| C[发起网络请求]
    B --&gt;|有缓存| D{缓存是否新鲜}
    
    D --&gt;|新鲜| E[返回缓存响应]
    D --&gt;|过期| F{是否允许过期缓存}
    
    F --&gt;|允许| G{检查max-stale}
    F --&gt;|不允许| H{支持条件请求}
    
    G --&gt;|在允许范围内| E
    G --&gt;|超出范围| H
    
    H --&gt;|支持| I[发起条件请求]
    H --&gt;|不支持| C
    
    I --&gt; J{服务器响应}
    J --&gt;|304 Not Modified| K[更新缓存元数据]
    J --&gt;|200 OK| L[更新缓存内容]
    
    K --&gt; E
    L --&gt; M[返回新响应]
    C --&gt; N{响应可缓存}
    N --&gt;|可缓存| O[存储到缓存]
    N --&gt;|不可缓存| M
    O --&gt; M
</code></pre>
<h5 data-id="heading-58">5.3.4 磁盘缓存设计</h5>
<p>DiskLruCache是OkHttp缓存的核心存储引擎，采用LRU（Least Recently Used）算法：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "DiskLruCache架构"
        A[DiskLruCache] --&gt; B[Journal文件]
        A --&gt; C[Entry映射]
        A --&gt; D[Executor线程池]
        
        B --&gt; E[操作日志]
        E --&gt; F[CLEAN记录]
        E --&gt; G[DIRTY记录]
        E --&gt; H[REMOVE记录]
        E --&gt; I[READ记录]
        
        C --&gt; J[Entry对象]
        J --&gt; K[文件索引]
        J --&gt; L[长度信息]
        J --&gt; M[访问时间]
        
        subgraph "文件存储"
            N[缓存目录]
            N --&gt; O[journal文件]
            N --&gt; P[journal.tmp]
            N --&gt; Q[journal.bkp]
            N --&gt; R[entry.0文件]
            N --&gt; S[entry.1文件]
        end
    end
</code></pre>
<h5 data-id="heading-59">5.3.5 缓存拦截器思想</h5>
<p>CacheInterceptor核心流程</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant I as CacheInterceptor
    participant C as Cache
    participant D as DiskLruCache
    participant F as FileSystem
    
    I-&gt;&gt;C: put(response)
    C-&gt;&gt;C: 计算缓存键
    C-&gt;&gt;D: edit(key)
    D-&gt;&gt;D: 创建Editor
    D-&gt;&gt;F: 创建临时文件
    F--&gt;&gt;D: 文件句柄
    D--&gt;&gt;C: Editor对象
    C-&gt;&gt;C: 创建CacheRequest
    C--&gt;&gt;I: CacheRequest
    
    Note over I: 写入响应数据
    I-&gt;&gt;I: cacheWritingResponse()
    I-&gt;&gt;I: 包装ResponseBody
    
    Note over I: 数据流写入
    loop 读取网络响应
        I-&gt;&gt;I: 读取数据块
        I-&gt;&gt;C: 写入缓存
        I-&gt;&gt;I: 写入客户端
    end
    
    I-&gt;&gt;C: 完成写入
    C-&gt;&gt;D: editor.commit()
    D-&gt;&gt;F: 重命名临时文件
    D-&gt;&gt;D: 更新Journal
    D--&gt;&gt;C: 成功
    C--&gt;&gt;I: 完成
</code></pre>
<h4 data-id="heading-60">5.4 安全特性设计</h4>
<p>在安全性方面采用了多层防护策略，涵盖传输层安全(TLS)、证书验证、主机名校验、数据完整性保护等多个维度。</p>
<ul>
<li><strong>TLS支持</strong>：支持TLS 1.2和1.3</li>
<li><strong>证书锁定</strong>：Certificate Pinning防止中间人攻击</li>
<li><strong>主机名验证</strong>：严格的主机名验证</li>
<li><strong>协议降级保护</strong>：防止协议降级攻击</li>
</ul>
<h5 data-id="heading-61">5.4.1 安全组件架构图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[OkHttpClient] --&gt; B[SSL/TLS配置]
    A --&gt; C[证书验证]
    A --&gt; D[主机名校验]
    A --&gt; E[连接安全]
    
    B --&gt; F[SSLSocketFactory]
    B --&gt; G[X509TrustManager]
    B --&gt; H[ConnectionSpec]
    B --&gt; I[TlsVersion]
    B --&gt; J[CipherSuite]
    
    C --&gt; K[CertificatePinner]
    C --&gt; L[CertificateChainCleaner]
    C --&gt; M[TrustRootIndex]
    
    D --&gt; N[OkHostnameVerifier]
    D --&gt; O[HostnameVerifier]
    
    E --&gt; P[RealConnection]
    E --&gt; Q[Handshake]
    E --&gt; R[Protocol协商]
    
    F --&gt; S[平台SSL实现]
    G --&gt; T[证书信任链]
    K --&gt; U[证书固定]
    L --&gt; V[证书链清理]
    N --&gt; W[主机名匹配]
    P --&gt; X[TLS握手]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#fce4ec
</code></pre>
<h5 data-id="heading-62">5.4.2 安全数据流图</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用程序
    participant Client as OkHttpClient
    participant Conn as RealConnection
    participant SSL as SSLSocket
    participant Server as 服务器
    
    App-&gt;&gt;Client: 创建HTTPS请求
    Client-&gt;&gt;Conn: 建立连接
    Conn-&gt;&gt;SSL: 创建SSL连接
    
    Note over SSL,Server: TLS握手过程
    SSL-&gt;&gt;Server: ClientHello
    Server-&gt;&gt;SSL: ServerHello + Certificate
    
    SSL-&gt;&gt;SSL: 证书链验证
    SSL-&gt;&gt;SSL: 主机名验证
    SSL-&gt;&gt;SSL: 证书固定检查
    
    alt 验证成功
        SSL-&gt;&gt;Server: ClientKeyExchange
        Server-&gt;&gt;SSL: Finished
        SSL-&gt;&gt;Conn: 安全连接建立
        Conn-&gt;&gt;Client: 连接就绪
        Client-&gt;&gt;App: 可以发送请求
    else 验证失败
        SSL-&gt;&gt;Conn: 验证失败
        Conn-&gt;&gt;Client: 连接异常
        Client-&gt;&gt;App: 抛出安全异常
    end
</code></pre>
<h5 data-id="heading-63">5.4.3 证书验证机制</h5>
<p>OkHttp使用CertificateChainCleaner来清理和验证证书链：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CertificateChainCleaner</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> List&lt;Certificate&gt; <span class="hljs-title function_">clean</span><span class="hljs-params">(List&lt;Certificate&gt; chain, String hostname)</span>
      <span class="hljs-keyword">throws</span> SSLPeerUnverifiedException;

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CertificateChainCleaner <span class="hljs-title function_">get</span><span class="hljs-params">(X509TrustManager trustManager)</span> {
    <span class="hljs-keyword">return</span> Platform.get().buildCertificateChainCleaner(trustManager);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CertificateChainCleaner <span class="hljs-title function_">get</span><span class="hljs-params">(X509TrustManager trustManager, TrustRootIndex trustRootIndex)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicCertificateChainCleaner</span>(trustRootIndex);
  }
}
</code></pre>
<p>证书链验证流程</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as OkHttpClient
    participant Cleaner as CertificateChainCleaner
    participant Trust as TrustManager
    participant Root as TrustRootIndex
    
    Client-&gt;&gt;Cleaner: clean(certificateChain, hostname)
    Cleaner-&gt;&gt;Cleaner: 构建完整证书链
    
    loop 对每个证书
        Cleaner-&gt;&gt;Root: findByIssuerAndSignature(cert)
        Root--&gt;&gt;Cleaner: 返回匹配的根证书
    end
    
    Cleaner-&gt;&gt;Trust: checkServerTrusted(chain, authType)
    
    alt 验证成功
        Trust--&gt;&gt;Cleaner: 验证通过
        Cleaner--&gt;&gt;Client: 返回清理后的证书链
    else 验证失败
        Trust--&gt;&gt;Cleaner: 抛出异常
        Cleaner--&gt;&gt;Client: 证书验证失败
    end
</code></pre>
<h5 data-id="heading-64">5.4.4 主机名验证</h5>
<p>OkHostnameVerifier实现，OkHttp实现了符合RFC 2818标准的主机名验证器</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始主机名验证] --&gt; B{输入是IP地址?}
    B --&gt;|是| C[IP地址验证]
    B --&gt;|否| D[域名验证]
    
    C --&gt; E[获取证书SAN中的IP地址]
    E --&gt; F{IP地址匹配?}
    F --&gt;|是| G[验证成功]
    F --&gt;|否| H[验证失败]
    
    D --&gt; I[获取证书SAN中的DNS名称]
    I --&gt; J[遍历每个DNS名称]
    J --&gt; K{是通配符模式?}
    
    K --&gt;|否| L[精确匹配]
    K --&gt;|是| M[通配符验证]
    
    L --&gt; N{完全匹配?}
    N --&gt;|是| G
    N --&gt;|否| O{还有更多DNS名称?}
    
    M --&gt; P[检查通配符规则]
    P --&gt; Q{通配符匹配?}
    Q --&gt;|是| G
    Q --&gt;|否| O
    
    O --&gt;|是| J
    O --&gt;|否| H
    
    style G fill:#c8e6c9
    style H fill:#ffcdd2
</code></pre>
<h5 data-id="heading-65">5.4.5 中间人攻击防护</h5>
<p>OkHttp通过多层防护机制防止中间人攻击：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[中间人攻击防护] --&gt; B[证书验证]
    A --&gt; C[证书固定]
    A --&gt; D[主机名验证]
    A --&gt; E[HSTS支持]
    A --&gt; F[证书透明度]
    
    B --&gt; G[证书链完整性检查]
    B --&gt; H[证书有效期验证]
    B --&gt; I[证书撤销检查]
    
    C --&gt; J[公钥固定]
    C --&gt; K[证书指纹固定]
    C --&gt; L[CA固定]
    
    D --&gt; M[SAN验证]
    D --&gt; N[通配符规则检查]
    D --&gt; O[IP地址验证]
    
    E --&gt; P[强制HTTPS重定向]
    E --&gt; Q[HSTS预加载]
    
    F --&gt; R[SCT验证]
    F --&gt; S[CT日志检查]
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style E fill:#fce4ec
    style F fill:#e0f2f1
</code></pre>
<h4 data-id="heading-66">5.5 SSL/TLS流程</h4>
<p>SSL配置层次图</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[SSL/TLS配置] --&gt; B[SocketFactory]
    A --&gt; C[SSLSocketFactory]
    A --&gt; D[X509TrustManager]
    A --&gt; E[HostnameVerifier]
    A --&gt; F[CertificatePinner]
    A --&gt; G[ConnectionSpec]
    
    B --&gt; H[普通Socket创建]
    C --&gt; I[SSL Socket创建]
    D --&gt; J[证书信任验证]
    E --&gt; K[主机名验证]
    F --&gt; L[证书固定验证]
    G --&gt; M[连接规范配置]
    
    I --&gt; N[TLS握手]
    J --&gt; N
    K --&gt; N
    L --&gt; N
    M --&gt; N
    
    N --&gt; O[安全连接建立]
    
    style A fill:#e3f2fd
    style N fill:#f3e5f5
    style O fill:#c8e6c9
</code></pre>
<h5 data-id="heading-67">5.5.1 TLS版本支持</h5>
<p>OkHttp支持多个TLS版本，并提供了灵活的配置机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TlsVersion</span> {
  TLS_1_3(<span class="hljs-string">"TLSv1.3"</span>), <span class="hljs-comment">// jdk11+, android10+</span>
  TLS_1_2(<span class="hljs-string">"TLSv1.2"</span>), <span class="hljs-comment">// jdk7+, android16+</span>
  TLS_1_1(<span class="hljs-string">"TLSv1.1"</span>), <span class="hljs-comment">// jdk7+, android16+</span>
  TLS_1_0(<span class="hljs-string">"TLSv1.0"</span>), <span class="hljs-comment">// jdk7+, android16+</span>
  SSL_3_0(<span class="hljs-string">"SSLv3"</span>);   <span class="hljs-comment">// jdk6+, android9+</span>

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> TlsVersion[] DEFAULT = {
    TLS_1_3, TLS_1_2, TLS_1_1, TLS_1_0
  };
}
</code></pre>
<h5 data-id="heading-68">5.5.2 TLS版本策略</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始TLS协商] --&gt; B{服务器支持TLS 1.3?}
    B --&gt;|是| C[使用TLS 1.3]
    B --&gt;|否| D{服务器支持TLS 1.2?}
    D --&gt;|是| E[使用TLS 1.2]
    D --&gt;|否| F{服务器支持TLS 1.1?}
    F --&gt;|是| G[使用TLS 1.1]
    F --&gt;|否| H{服务器支持TLS 1.0?}
    H --&gt;|是| I[使用TLS 1.0]
    H --&gt;|否| J[连接失败]
    
    C --&gt; K[建立安全连接]
    E --&gt; K
    G --&gt; K
    I --&gt; K
    
    style C fill:#c8e6c9
    style E fill:#dcedc8
    style G fill:#f0f4c3
    style I fill:#fff9c4
    style J fill:#ffcdd2
</code></pre>
<h5 data-id="heading-69">5.5.3 TLS握手过程</h5>
<p>RealConnection负责建立安全的TLS连接：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as OkHttpClient
    participant Conn as RealConnection
    participant SSL as SSLSocket
    participant Server as 服务器
    participant Verifier as HostnameVerifier
    participant Pinner as CertificatePinner
    
    Client-&gt;&gt;Conn: connectTls()
    Conn-&gt;&gt;SSL: createSocket()
    Conn-&gt;&gt;SSL: 配置连接规范
    Conn-&gt;&gt;SSL: startHandshake()
    
    Note over SSL,Server: TLS握手协商
    SSL-&gt;&gt;Server: ClientHello
    Server-&gt;&gt;SSL: ServerHello + Certificate + ServerHelloDone
    SSL-&gt;&gt;Server: ClientKeyExchange + ChangeCipherSpec + Finished
    Server-&gt;&gt;SSL: ChangeCipherSpec + Finished
    
    SSL-&gt;&gt;Conn: 握手完成
    Conn-&gt;&gt;Conn: 获取握手信息
    
    Conn-&gt;&gt;Verifier: verify(hostname, session)
    alt 主机名验证成功
        Verifier--&gt;&gt;Conn: true
        Conn-&gt;&gt;Pinner: check(hostname, certificates)
        alt 证书固定验证成功
            Pinner--&gt;&gt;Conn: 验证通过
            Conn-&gt;&gt;Conn: 选择应用层协议
            Conn--&gt;&gt;Client: 安全连接建立成功
        else 证书固定验证失败
            Pinner--&gt;&gt;Conn: SSLPeerUnverifiedException
            Conn--&gt;&gt;Client: 连接失败
        end
    else 主机名验证失败
        Verifier--&gt;&gt;Conn: false
        Conn--&gt;&gt;Client: SSLPeerUnverifiedException
    end
</code></pre>
<h3 data-id="heading-70">06.性能优化策略</h3>
<h4 data-id="heading-71">6.1 连接复用</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[请求1] --&gt; B[连接池]
    C[请求2] --&gt; B
    D[请求3] --&gt; B
    B --&gt; E[复用连接1]
    B --&gt; F[复用连接2]
    E --&gt; G[服务器]
    F --&gt; G
</code></pre>
<h5 data-id="heading-72">6.1.1 连接复用架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp连接复用架构"
        A[OkHttpClient] --&gt; B[ConnectionPool]
        B --&gt; C[RealConnectionPool]
        C --&gt; D[RealConnection]
        
        E[Request] --&gt; F[RealCall]
        F --&gt; G[ExchangeFinder]
        G --&gt; H[RouteSelector]
        
        G --&gt; I[Exchange]
        I --&gt; D
        
        subgraph "连接管理"
            C --&gt; J[连接清理任务]
            C --&gt; K[连接复用逻辑]
            C --&gt; L[连接池统计]
        end
        
        subgraph "路由选择"
            H --&gt; M[Route]
            H --&gt; N[Proxy]
            H --&gt; O[InetSocketAddress]
        end
        
        subgraph "协议支持"
            D --&gt; P[HTTP/1.1]
            D --&gt; Q[HTTP/2]
            D --&gt; R[HTTPS/TLS]
        end
    end
</code></pre>
<h4 data-id="heading-73">6.2 请求合并</h4>
<p>对于相同的请求，OkHttp会自动合并，避免重复请求。</p>
<h4 data-id="heading-74">6.3 压缩传输</h4>
<ul>
<li>自动GZIP压缩响应体</li>
<li>支持Brotli压缩算法</li>
<li>透明的压缩/解压缩处理</li>
</ul>
<h4 data-id="heading-75">6.4 内存管理</h4>
<ul>
<li>使用Okio进行高效的IO操作</li>
<li>智能的缓冲区管理</li>
<li>及时释放不需要的资源</li>
</ul>
<h5 data-id="heading-76">6.4.1 内存管理架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp内存管理架构"
        A[内存管理] --&gt; B[对象池化]
        A --&gt; C[缓冲区管理]
        A --&gt; D[流复用]
        
        B --&gt; E[连接池复用]
        B --&gt; F[请求对象复用]
        B --&gt; G[响应对象复用]
        
        C --&gt; H[Okio Buffer]
        C --&gt; I[Segment池]
        C --&gt; J[ByteString缓存]
        
        D --&gt; K[InputStream复用]
        D --&gt; L[OutputStream复用]
        D --&gt; M[Socket流复用]
        
        subgraph "垃圾回收优化"
            N[弱引用使用]
            O[及时资源释放]
            P[循环引用避免]
        end
        
        subgraph "内存监控"
            Q[内存使用统计]
            R[泄漏检测]
            S[性能指标]
        end
    end
</code></pre>
<h5 data-id="heading-77">6.4.2 IO操作架构</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp IO架构"
        A[应用层] --&gt; B[OkHttp API]
        B --&gt; C[Interceptor Chain]
        C --&gt; D[Network Layer]
        
        D --&gt; E[Okio]
        E --&gt; F[BufferedSource]
        E --&gt; G[BufferedSink]
        
        F --&gt; H[Source]
        G --&gt; I[Sink]
        
        H --&gt; J[Socket InputStream]
        I --&gt; K[Socket OutputStream]
        
        subgraph "缓冲优化"
            L[Segment Buffer]
            M[零拷贝操作]
            N[批量读写]
        end
        
        subgraph "压缩优化"
            O[GZip压缩]
            P[Deflate压缩]
            Q[Brotli压缩]
        end
        
        F --&gt; L
        G --&gt; L
        C --&gt; O
        C --&gt; P
    end
</code></pre>
<h3 data-id="heading-78">07.使用示例说明</h3>
<h4 data-id="heading-79">7.1 基本使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建客户端</span>
<span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
    .connectTimeout(<span class="hljs-number">10</span>, TimeUnit.SECONDS)
    .readTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
    .writeTimeout(<span class="hljs-number">30</span>, TimeUnit.SECONDS)
    .build();

<span class="hljs-comment">// 构建请求</span>
<span class="hljs-type">Request</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Builder()
    .url(<span class="hljs-string">"https://api.example.com/data"</span>)
    .header(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer token"</span>)
    .build();

<span class="hljs-comment">// 同步执行</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">Response</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.newCall(request).execute()) {
    <span class="hljs-keyword">if</span> (response.isSuccessful()) {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> response.body().string();
        <span class="hljs-comment">// 处理响应数据</span>
    }
}

<span class="hljs-comment">// 异步执行</span>
client.newCall(request).enqueue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Call call, IOException e)</span> {
        <span class="hljs-comment">// 处理失败</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResponse</span><span class="hljs-params">(Call call, Response response)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">if</span> (response.isSuccessful()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> response.body().string();
            <span class="hljs-comment">// 处理响应数据</span>
        }
    }
});
</code></pre>
<h4 data-id="heading-80">7.2 高级配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
    <span class="hljs-comment">// 连接池配置</span>
    .connectionPool(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionPool</span>(<span class="hljs-number">10</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES))
    <span class="hljs-comment">// 缓存配置</span>
    .cache(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>(cacheDir, <span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>)) <span class="hljs-comment">// 50MB缓存</span>
    <span class="hljs-comment">// 拦截器</span>
    .addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingInterceptor</span>())
    .addNetworkInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NetworkInterceptor</span>())
    <span class="hljs-comment">// 重试配置</span>
    .retryOnConnectionFailure(<span class="hljs-literal">true</span>)
    <span class="hljs-comment">// 代理配置</span>
    .proxy(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(Proxy.Type.HTTP, <span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(<span class="hljs-string">"proxy.example.com"</span>, <span class="hljs-number">8080</span>)))
    <span class="hljs-comment">// SSL配置</span>
    .sslSocketFactory(sslSocketFactory, trustManager)
    .hostnameVerifier(hostnameVerifier)
    .build();
</code></pre>
<h4 data-id="heading-81">7.3 统计请求耗时</h4>
<p>OkHttp如何进行各个请求环节的耗时统计呢？</p>
<ul>
<li>OkHttp 版本提供了EventListener接口，可以让调用者接收一系列网络请求过程中的事件，例如DNS解析、TSL/SSL连接、Response接收等。</li>
<li>通过继承此接口，调用者可以监视整个应用中网络请求次数、流量大小、耗时(比如dns解析时间，请求时间，响应时间等等)情况。</li>
</ul>
<p>如何消耗记录时间</p>
<ul>
<li>在OkHttp库中有一个EventListener类。该类是网络事件的侦听器。扩展这个类以监视应用程序的HTTP调用的数量、大小和持续时间。</li>
<li>所有启动/连接/获取事件最终将接收到匹配的结束/释放事件，要么成功(非空参数)，要么失败(非空可抛出)。</li>
<li>比如，可以在开始链接记录时间；dns开始，结束等方法解析记录时间，可以计算dns的解析时间。</li>
<li>比如，可以在开始请求记录时间，记录connectStart，connectEnd等方法时间，则可以计算出connect连接时间。</li>
</ul>
<p>OkHttp性能监控架构</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "OkHttp性能监控架构"
        A[EventListener] --&gt; B[连接事件]
        A --&gt; C[DNS事件]
        A --&gt; D[请求事件]
        A --&gt; E[响应事件]
        
        B --&gt; F[连接开始]
        B --&gt; G[连接结束]
        B --&gt; H[连接获取]
        B --&gt; I[连接释放]
        
        C --&gt; J[DNS开始]
        C --&gt; K[DNS结束]
        
        D --&gt; L[请求开始]
        D --&gt; M[请求头发送]
        D --&gt; N[请求体发送]
        
        E --&gt; O[响应头接收]
        E --&gt; P[响应体接收]
        E --&gt; Q[响应结束]
        
        subgraph "指标收集"
            R[连接池统计]
            S[请求延迟]
            T[吞吐量统计]
            U[错误率统计]
        end
        
        subgraph "性能分析"
            V[热点分析]
            W[瓶颈识别]
            X[优化建议]
        end
    end
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCVSharp：ArUco 标记检测与透视变换]]></title>    <link>https://juejin.cn/post/7572002432451133449</link>    <guid>https://juejin.cn/post/7572002432451133449</guid>    <pubDate>2025-11-13T11:56:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572002432451133449" data-draft-id="7572016447804997658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCVSharp：ArUco 标记检测与透视变换"/> <meta itemprop="keywords" content="OpenCV"/> <meta itemprop="datePublished" content="2025-11-13T11:56:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCVSharp：ArUco 标记检测与透视变换
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:56:06.000Z" title="Thu Nov 13 2025 11:56:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>对于.NET开发者而言，入门OpenCV的一个很舒适的方式就是先去使用OpenCVSharp，它是 OpenCV 的 .NET 封装，而且作者还开源了一个示例库，可以通过示例库进行入门学习。</p>
<p>OpenCVSharp仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshimat%2Fopencvsharp" target="_blank" title="https://github.com/shimat/opencvsharp" ref="nofollow noopener noreferrer">github.com/shimat/open…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/764d56beb7e0422e960e33f83ca92311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=yGHYOVqAGHx%2B%2BGI90pQtvt7rV0I%3D" alt="" loading="lazy"/></p>
<p>opencvsharp_samples仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshimat%2Fopencvsharp_samples" target="_blank" title="https://github.com/shimat/opencvsharp_samples" ref="nofollow noopener noreferrer">github.com/shimat/open…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a422e53880d49f2813f4cd1916f03ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=5meWdCHK8OxTDnEkwvmP%2FgrGmN4%3D" alt="" loading="lazy"/></p>
<p>作者提供了几十个可以直接运行的示例代码，一开始可以先大概运行一下这些示例，看一下用这个库可以实现哪些功能。</p>
<p>入门第一步就是先学会用，那些视觉算法的原理可以先不懂，大概了解一下就够了，等后面真的需要你深入了解的时候再去了解也不迟，现在深入理解原理容易让小白放弃，刚开始入门我们就当一名踏踏实实的“掉包侠”。</p>
<h2 data-id="heading-1">Aruco 标记检测与透视变换</h2>
<p>第一个例子是关于Aruco 标记检测和透视变换的。</p>
<p>第一步先运行起来，看一下实现了什么效果？</p>
<p>首先原图是这样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb3ef77a81024fa3aa30c3393e5532d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=9lxTW1XjHwiJgvp7%2F1GRZ5dGtxQ%3D" alt="" loading="lazy"/></p>
<p>注意到上面有4个有点奇怪的四边形。</p>
<p>然后识别这几个四边形的区域：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fdd7418cf604d56873941817e9cd7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=GIIk2LbK4mCB6nA9VCnHnRulaQA%3D" alt="" loading="lazy"/></p>
<p>然后再进行一下透视变换：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90b07701104849269dc6b403928f35cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=4aB8az51kvJpcD3zdpvs5Ss80xM%3D" alt="" loading="lazy"/></p>
<p>刚刚看到的这些四边形就是Aruco标记，它是拿来干嘛的呢？我的简单理解就是拿来标记用的，一个经典的应用就是替换相框中的图片。</p>
<p>OpenCVSharp好像还没有提供生成Aruco标记的功能，但是已经有了识别的功能，让我们看看这个效果是如何实现的吧！！</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// The locations of the markers in the image at FilePath.Image.Aruco.</span>
 <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> upperLeftMarkerId = <span class="hljs-number">160</span>;
 <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> upperRightMarkerId = <span class="hljs-number">268</span>;
 <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> lowerRightMarkerId = <span class="hljs-number">176</span>;
 <span class="hljs-keyword">const</span> <span class="hljs-built_in">int</span> lowerLeftMarkerId = <span class="hljs-number">168</span>;

 <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> src = Cv2.ImRead(ImagePath);

 <span class="hljs-keyword">var</span> detectorParameters = <span class="hljs-keyword">new</span> DetectorParameters();
 detectorParameters.CornerRefinementMethod = CornerRefineMethod.Subpix;
 detectorParameters.CornerRefinementWinSize = <span class="hljs-number">9</span>;

 <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> dictionary = CvAruco.GetPredefinedDictionary(PredefinedDictionaryName.Dict4X4_1000);

 CvAruco.DetectMarkers(src, dictionary, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> corners, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> ids, detectorParameters, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> rejectedPoints);
</code></pre>
<p>每个Aruco标记都有一个确定的ID，然后根据路径读取图片。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> detectorParameters = <span class="hljs-keyword">new</span> DetectorParameters();
detectorParameters.CornerRefinementMethod = CornerRefineMethod.Subpix;
detectorParameters.CornerRefinementWinSize = <span class="hljs-number">9</span>;
</code></pre>
<p>进行检测器参数配置：</p>
<p>DetectorParameters: 创建ArUco检测器的参数对象，用于控制标记检测的精度和行为</p>
<p>CornerRefinementMethod.Subpix: 设置角点细化方法为子像素级别，提高角点检测精度</p>
<p>CornerRefinementWinSize = 9: 设置角点细化窗口大小为9x9像素，用于角点周围的子像素级优化</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> dictionary = CvAruco.GetPredefinedDictionary(PredefinedDictionaryName.Dict4X4_1000);
</code></pre>
<p>进行字典配置：</p>
<p>CvAruco.GetPredefinedDictionary: 获取OpenCV预定义的ArUco标记字典</p>
<p>PredefinedDictionaryName.Dict4X4_1000: 选择4x4位编码、包含1000个不同标记的字典类型</p>
<pre><code class="hljs language-csharp" lang="csharp">CvAruco.DetectMarkers(src, dictionary, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> corners, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> ids, detectorParameters, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> rejectedPoints);
</code></pre>
<p>这就在进行ArUco标记检测了，主要知道一下参数是什么意思就行了。</p>
<p>src - 输入图像，包含要检测ArUco标记的源图像</p>
<p>dictionary - 标记字典，预定义的ArUco标记字典（前面配置的Dict4X4_1000）</p>
<p>corners - 检测到的标记角点（输出参数），每个标记的4个角点坐标，按顺时针顺序存储（从左上角开始）</p>
<p>ids - 检测到的标记ID（输出参数），每个检测到的标记对应的ID编号</p>
<p>detectorParameters - 检测参数，前面配置的检测器参数（包含角点细化等设置）</p>
<p>rejectedPoints - 被拒绝的候选标记（输出参数），检测过程中被识别为候选但最终被拒绝的标记角点</p>
<p>自己再稍微打断点加深一下印象：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f90611ba6c184b4f977a027b38ca9a92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=3na4ByE%2BvaHbaFFBgAQlnKksapw%3D" alt="" loading="lazy"/></p>
<p>确实是，每一项都有四个点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fffe9d62a06c4fe2a7bb7a14214dec44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=UXa3HRvuMQUyU012PZ2%2FTJN251U%3D" alt="" loading="lazy"/></p>
<p>检测出了ArUco标记的ID。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c8774b6ab24fb3814b6bc550f868d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=v%2FPvZep4gQHPDtwG975UXMPEfAk%3D" alt="" loading="lazy"/></p>
<p>确实有一组被拒绝的候选标记。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> detectedMarkers = src.Clone();
CvAruco.DrawDetectedMarkers(detectedMarkers, corners, ids, Scalar.Crimson);
</code></pre>
<p>在图像上绘制区域与ID。</p>
<pre><code class="hljs language-csharp" lang="csharp">            <span class="hljs-comment">// Find the index of the four markers in the ids array. We'll use this same index into the</span>
            <span class="hljs-comment">// corners array to find the corners of each marker.</span>
            <span class="hljs-keyword">var</span> upperLeftCornerIndex = Array.FindIndex(ids, id =&gt; id == upperLeftMarkerId);
            <span class="hljs-keyword">var</span> upperRightCornerIndex = Array.FindIndex(ids, id =&gt; id == upperRightMarkerId);
            <span class="hljs-keyword">var</span> lowerRightCornerIndex = Array.FindIndex(ids, id =&gt; id == lowerRightMarkerId);
            <span class="hljs-keyword">var</span> lowerLeftCornerIndex = Array.FindIndex(ids, id =&gt; id == lowerLeftMarkerId);

            <span class="hljs-comment">// Make sure we found all four markers.</span>
            <span class="hljs-keyword">if</span> (upperLeftCornerIndex &lt; <span class="hljs-number">0</span> || upperRightCornerIndex &lt; <span class="hljs-number">0</span>
                 || lowerRightCornerIndex &lt; <span class="hljs-number">0</span> || lowerLeftCornerIndex &lt; <span class="hljs-number">0</span>)
            {
                <span class="hljs-keyword">return</span>;
            }

            <span class="hljs-comment">// Marker corners are stored clockwise beginning with the upper-left corner.</span>
            <span class="hljs-comment">// Get the first (upper-left) corner of the upper-left marker.</span>
            <span class="hljs-keyword">var</span> upperLeftPixel = corners[upperLeftCornerIndex][<span class="hljs-number">0</span>];
            <span class="hljs-comment">// Get the second (upper-right) corner of the upper-right marker.</span>
            <span class="hljs-keyword">var</span> upperRightPixel = corners[upperRightCornerIndex][<span class="hljs-number">1</span>];
            <span class="hljs-comment">// Get the third (lower-right) corner of the lower-right marker.</span>
            <span class="hljs-keyword">var</span> lowerRightPixel = corners[lowerRightCornerIndex][<span class="hljs-number">2</span>];
            <span class="hljs-comment">// Get the fourth (lower-left) corner of the lower-left marker.</span>
            <span class="hljs-keyword">var</span> lowerLeftPixel = corners[lowerLeftCornerIndex][<span class="hljs-number">3</span>];

            <span class="hljs-comment">// Create coordinates for passing to GetPerspectiveTransform</span>
            <span class="hljs-keyword">var</span> sourceCoordinates = <span class="hljs-keyword">new</span> List&lt;Point2f&gt;
            {
                upperLeftPixel, upperRightPixel, lowerRightPixel, lowerLeftPixel
            };
</code></pre>
<p>就是确保都找到了这些ID，然后确定了一个区域，就是这么一个区域：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a4728ca1d0044b5a6b93ba49a8fb14c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639766&amp;x-signature=uNN3TxvUDTGMjxJAVpTGMyJvLRQ%3D" alt="" loading="lazy"/></p>
<p>这个区域由第一个ArUco标记的左上角点、第二个右上角点、第三个左下角点与第四个右下角点组成。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> destinationCoordinates = <span class="hljs-keyword">new</span> List&lt;Point2f&gt;
{
    <span class="hljs-keyword">new</span> Point2f(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>),
    <span class="hljs-keyword">new</span> Point2f(<span class="hljs-number">1024</span>, <span class="hljs-number">0</span>),
    <span class="hljs-keyword">new</span> Point2f(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>),
    <span class="hljs-keyword">new</span> Point2f(<span class="hljs-number">0</span>, <span class="hljs-number">1024</span>),
};

</code></pre>
<p>首先进行目标坐标定义，定义了变换后的标准矩形区域，创建一个1024×1024像素的正方形。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> transform = Cv2.GetPerspectiveTransform(sourceCoordinates, destinationCoordinates);
</code></pre>
<p>然后进行计算透视变换矩阵：</p>
<p>sourceCoordinates: 从检测到的4个ArUco标记角点提取的源坐标</p>
<p>destinationCoordinates: 目标标准矩形坐标</p>
<p>返回值: 3×3的透视变换矩阵，用于将源四边形映射到目标矩形</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> normalizedImage = <span class="hljs-keyword">new</span> Mat();
Cv2.WarpPerspective(src, normalizedImage, transform, <span class="hljs-keyword">new</span> Size(<span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>));
</code></pre>
<p>应用透视变换:</p>
<p>src: 原始输入图像</p>
<p>normalizedImage: 输出的标准化图像</p>
<p>transform: 透视变换矩阵</p>
<p>new Size(1024, 1024): 输出图像尺寸</p>
<p>这样就得到了最后的那张图片。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React：使用Tailwind CSS、Streamdown与Ant Design X]]></title>    <link>https://juejin.cn/post/7572021695294242866</link>    <guid>https://juejin.cn/post/7572021695294242866</guid>    <pubDate>2025-11-13T11:57:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695294242866" data-draft-id="7572016447805014042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React：使用Tailwind CSS、Streamdown与Ant Design X"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-11-13T11:57:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React：使用Tailwind CSS、Streamdown与Ant Design X
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T11:57:54.000Z" title="Thu Nov 13 2025 11:57:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用Tailwind CSS</h2>
<p><span>Tailwind CSS 简介是“用于快速用户界面开发的原子化 CSS 框架。”</span></p>
<p>Tailwind CSS 是一个功能优先的实用优先（utility-first）CSS框架，它通过提供大量原子化的工具类（utility classes），让开发者直接在HTML中构建自定义设计，而无需编写传统的CSS。与传统框架如Bootstrap不同，Tailwind不提供预设的UI组件，而是专注于底层样式，如flex、pt-4（padding-top: 1rem）、text-center等，这些类名直接对应CSS属性，使得样式声明高度语义化且可预测。其核心优势在于解决了“自定义CSS命名混乱”和“维护复杂”的问题，同时通过配置文件（如tailwind.config.js）支持主题定制、响应式设计（如md:text-lg）和状态变体（如hover:bg-blue-500），灵活适配各种项目需求。</p>
<p>先通过官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2Fdocs%2Finstallation%2Fusing-vite%25E5%25B0%2586Tailwind" target="_blank" title="https://tailwindcss.com/docs/installation/using-vite%E5%B0%86Tailwind" ref="nofollow noopener noreferrer">tailwindcss.com/docs/instal…</a> CSS 作为 Vite 插件进行安装。</p>
<p>之前是把样式都交给AI写了，但是发现AI喜欢每个组件对应一个样式，这样子不方便后续维护，既然都交给AI了那么还不如直接让AI用Tailwind CSS。经过实测发现AI写Tailwind CSS的水平还是很强的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/715230bd834640dcafa8080158c6129e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=xhwGFyfnz7KxqThMd6rEFuW8SIU%3D" alt="" loading="lazy"/></p>
<p>静态页面交给AI写用Tailwind CSS用的已经很好了。</p>
<h2 data-id="heading-1">使用Ant Desgin X</h2>
<p><span>@ant-design/x 是一个专注于 React 生态的先进 AI 组件库，旨在简化与人工智能集成的开发过程。</span></p>
<p>该库包括高度定制化的 AI 组件，允许开发者轻松地将对话 AI 集成到他们的应用中。除了丰富的 UI 组件，@ant-design/x 还提供了一揽子 API 解决方案，支持开发者通过令牌认证直接接入现有 AI 服务，无缝衔接与 AI 的对话和交互。无论是建立智能聊天应用、提升用户交互体验还是加快 AI 能力的集成，@ant-design/x 都是 React 开发者进入 AI 世界的理想伙伴。</p>
<p>官方仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fx" target="_blank" title="https://github.com/ant-design/x" ref="nofollow noopener noreferrer">github.com/ant-design/…</a></p>
<p>官方文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.ant.design%2Fcomponents%2Foverview-cn" target="_blank" title="https://x.ant.design/components/overview-cn" ref="nofollow noopener noreferrer">x.ant.design/components/…</a></p>
<p>这个组件比较新直接让AI来写是不太行的，需要自己看下文档，不过文档已经提供了比较详细的示例代码了，自己看懂之后，复制粘贴一下交给AI，当做AI的上下文，写起来估计问题也不大。</p>
<p>目前使用Ant Desgin X做了一个简单的AI聊天界面了，自己用AI写的组件的质量跟大厂写的肯定是不能比的，既然大厂都做的这么好了，直接用大厂做好的轮子就行了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ef39e731c164e73bccb83b9943fc836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=eG%2FBcbDaKWqfIXZlaNx%2FyBt4tk4%3D" alt="" loading="lazy"/></p>
<p>AI对Ant Design这个组件库很熟练，使用这个组件库的Menu + React Router代替了之前写的自定义样式 + React Router。</p>
<p>使用Ant Design做了一个模型配置页面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22ae6c19ed3b4234b89eed37f57da975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=DHd5dlCOma%2FyI7tlDG3u9cXRHtg%3D" alt="" loading="lazy"/></p>
<p>个人感觉让AI用知名组件库来写比纯让AI自己写还是好多了。</p>
<h2 data-id="heading-2">使用Streamdown</h2>
<p>这个也是一个新东西直接让AI来写是不太行的，需要自己先看下仓库介绍。</p>
<p><span>Streamdown的简介是“react-markdown 的即插即用替代品，专为 AI 驱动的流式传输而设计。”</span></p>
<p>官方仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fstreamdown" target="_blank" title="https://github.com/vercel/streamdown" ref="nofollow noopener noreferrer">github.com/vercel/stre…</a></p>
<p>用起来在流式传输方面确实比之前使用的react-markdown效果要好一点。</p>
<p>渲染代码效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10057528c82743d9a757aa298c63b63d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=zd93AetezjwAv%2BMx3yaxanMEPw0%3D" alt="" loading="lazy"/></p>
<p>渲染表格效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb77ebbead6640868b379691b1244364~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=0FbyPGb1zXpqCQvn2bmbZjJ66OI%3D" alt="" loading="lazy"/></p>
<p>渲染mermaid图效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4803f2354af49508a86129fff9432c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=ZtkPxXbIh9XZz89Rii%2BCT%2BLfwXc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">遇到的问题</h2>
<p>被一个SSE传输导致前端总是没有换行的一个问题困扰最久。</p>
<p>之前的效果是这样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5818cc2dded54c4d87d388c274f112a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=ZdoAfUOC7Oq1PbMMvOW%2BqbZodV4%3D" alt="" loading="lazy"/></p>
<p>总是只有一行，我能发现应该是后端传过来的换行符没有被正常解析导致的，但是叫AI改了很久还是没有很好地解决，自己上网查了一下，果然发现有很多人都遇到过这个问题。</p>
<p>一个很不错的解决方案就是进行转义，因为SSE传输有他自己的格式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f93fd17862242cf8fbd1637da5e3ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=%2FWhv3xzdUFoj6VnlgSFM6z8hME8%3D" alt="" loading="lazy"/></p>
<p>前端在处理的时候一般喜欢将所有\n都去掉，就导致了AI回复就只有一段话。</p>
<p>可以在后端将AI回复中的\n转义为一个占位符，这里用的是&lt;|newline|&gt;，然后在前端再将这个占位符转化为\n即可。</p>
<p>后端处理：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55c64a5878a54727b34a31cad9762ee0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=oNTZQA23vI5aZC7SJfdF876bfTg%3D" alt="" loading="lazy"/></p>
<p>前端处理：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5297269817004ce98ff60d2d37e0de03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=R9Ai2IHEePjVkSE1pY0GqYXGwow%3D" alt="" loading="lazy"/></p>
<p>这样AI回复就不会就只有一段内容了，AI回复中带有的换行能正常保留了。</p>
<h2 data-id="heading-4">一些学到的知识点</h2>
<p><strong>解构写法</strong></p>
<p>这种写法：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Sidebar</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">SidebarProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ collapsed = <span class="hljs-literal">false</span> }</span>) =&gt;</span> {}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea9b3445bc984b4bb89c1051c965a155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763639873&amp;x-signature=0P9hLOVXQtaiwuHjF6wQsiIqQhY%3D" alt="" loading="lazy"/></p>
<p>类型安全：TypeScript 确保组件接收正确的 props 类型</p>
<p>简洁性：解构和默认值在一行完成</p>
<p>可读性：直接看到组件需要哪些 props</p>
<p>自文档化：类型定义作为组件的"文档"</p>
<p><strong>React.useEffect的使用</strong></p>
<p>useEffect 是 React 中最重要的钩子之一，它让你能够在函数组件中执行副作用操作。</p>
<p>副作用（Side Effects）：指组件渲染之外的操作，如：</p>
<p>数据获取（API调用）</p>
<p>订阅（定时器、事件监听）</p>
<p>手动修改DOM</p>
<p>localStorage操作</p>
<p><strong>React.useMemo的使用</strong></p>
<p>useMemo 是 React 提供的性能优化钩子，用于记忆化计算结果，避免在每次渲染时重复执行昂贵的计算。</p>
<p><strong>localStorage的使用</strong></p>
<p>localStorage 是 Web 浏览器提供的一种客户端存储机制，允许网站在用户浏览器中持久化存储数据。</p>
<p>基本概念
localStorage 是 Window 对象的属性，提供了键值对存储功能，数据没有过期时间，除非用户手动清除或通过代码删除。</p>
<p>特点</p>
<p>持久性存储：数据在浏览器关闭后仍然保留</p>
<p>同源策略：只能访问同一域名下的数据</p>
<p>字符串存储：所有数据都以字符串形式存储</p>
<p>同步操作：读写操作是同步的</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Microsoft Agent Framework/C#：了解Workflows的几种不同模式]]></title>    <link>https://juejin.cn/post/7572021695294275634</link>    <guid>https://juejin.cn/post/7572021695294275634</guid>    <pubDate>2025-11-13T12:02:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695294275634" data-draft-id="7572002432451149833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Microsoft Agent Framework/C#：了解Workflows的几种不同模式"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-13T12:02:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Microsoft Agent Framework/C#：了解Workflows的几种不同模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:02:13.000Z" title="Thu Nov 13 2025 12:02:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近有空的时候在学习Microsoft Agent Framework，在这个框架中目前Workflows分为了Sequential、Concurrent、Handoffs以及Groupchat四种模式，今天让我们来了解一下这四种不同的模式。</p>
<p>首先需要以下两个包：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c805c085bac8450ba458d51ad3198cb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=D7rgcaSgF4uD52kGK45rvK5KZN8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">Sequential 模式</h2>
<p>在开始介绍之前，先看下它的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12377eeb621549ee8e24734d2288dead~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=39xT%2FmnWbApLZtVWHveAUQeJ1k0%3D" alt="" loading="lazy"/></p>
<p>首先需要先构建一个IChatClient：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-keyword">var</span> apiKey = Environment.GetEnvironmentVariable(<span class="hljs-string">"OPENAI_API_KEY"</span>) ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">"未设置环境变量：OPENAI_API_KEY"</span>);
 <span class="hljs-comment">//var model = Environment.GetEnvironmentVariable("OPENAI_MODEL") ?? "gpt-4o-mini";</span>
 <span class="hljs-keyword">var</span> model = <span class="hljs-string">"moonshotai/Kimi-K2-Instruct-0905"</span>;
 <span class="hljs-keyword">var</span> baseUrl = Environment.GetEnvironmentVariable(<span class="hljs-string">"OPENAI_BASEURL"</span>) ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">"未设置环境变量：OPENAI_BASEURL"</span>);
         
 ApiKeyCredential apiKeyCredential = <span class="hljs-keyword">new</span> ApiKeyCredential(apiKey);

 OpenAIClientOptions openAIClientOptions = <span class="hljs-keyword">new</span> OpenAIClientOptions();
 openAIClientOptions.Endpoint = <span class="hljs-keyword">new</span> Uri(baseUrl);

 <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> OpenAIClient(apiKeyCredential, openAIClientOptions).GetChatClient(model).AsIChatClient();
</code></pre>
<p>现在通过这个函数方便构建不同的翻译代理：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span>为指定目标语言创建翻译代理。<span class="hljs-doctag">&lt;/summary&gt;</span></span>
 <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ChatClientAgent <span class="hljs-title">GetTranslationAgent</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> targetLanguage, IChatClient chatClient</span>)</span> =&gt;
     <span class="hljs-keyword">new</span>(chatClient,
         <span class="hljs-string">$"你是一个翻译助手，只使用<span class="hljs-subst">{targetLanguage}</span>回应。对于任何输入，"</span> +
         <span class="hljs-string">$"首先输出输入语言的名称，然后将输入翻译成<span class="hljs-subst">{targetLanguage}</span>。"</span>);
</code></pre>
<p>构建顺序工作流：</p>
<pre><code class="hljs language-csharp" lang="csharp">  <span class="hljs-comment">// 创建顺序工作流</span>
  <span class="hljs-keyword">var</span> workflow = AgentWorkflowBuilder.BuildSequential(
      <span class="hljs-function"><span class="hljs-keyword">from</span> lang <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-built_in">string</span>[]</span>)["French", "Spanish", "English"] 
      <span class="hljs-keyword">select</span> <span class="hljs-title">GetTranslationAgent</span>(<span class="hljs-params">lang, client</span>)
  )</span>;
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5b2ebc9f0dc45f09a6305a6950ac856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=5snQMOp%2FeZ2YD1INhgkM2C2Z8B0%3D" alt="" loading="lazy"/></p>
<p>参数就是一组AIAgent，然后工作流会将这些AIAgent按顺序组合起来。</p>
<p>运行这个工作流：</p>
<pre><code class="hljs language-csharp" lang="csharp">  List&lt;ChatMessage&gt; messages = [<span class="hljs-keyword">new</span>(ChatRole.User, InputText)];
  <span class="hljs-keyword">await</span> RunWorkflowAsync(workflow, messages);
  
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task&lt;List&lt;ChatMessage&gt;&gt; RunWorkflowAsync(Workflow workflow, List&lt;ChatMessage&gt; messages)
{
    <span class="hljs-built_in">string</span>? lastExecutorId = <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">await</span> <span class="hljs-keyword">using</span> StreamingRun run = <span class="hljs-keyword">await</span> InProcessExecution.StreamAsync(workflow, messages);
    <span class="hljs-keyword">await</span> run.TrySendMessageAsync(<span class="hljs-keyword">new</span> TurnToken(emitEvents: <span class="hljs-literal">true</span>));
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (WorkflowEvent evt <span class="hljs-keyword">in</span> run.WatchStreamAsync())
    {
        <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">is</span> AgentRunUpdateEvent e)
        {
            <span class="hljs-keyword">if</span> (e.ExecutorId != lastExecutorId)
            {
                OutputText += <span class="hljs-string">"\n"</span>;
                lastExecutorId = e.ExecutorId;

                OutputText += <span class="hljs-string">$"<span class="hljs-subst">{e.ExecutorId}</span>：\n"</span>;
            }

            OutputText += e.Update.Text;
            <span class="hljs-keyword">if</span> (e.Update.Contents.OfType&lt;FunctionCallContent&gt;().FirstOrDefault() <span class="hljs-keyword">is</span> FunctionCallContent call)
            {
               OutputText += <span class="hljs-string">"\n"</span>;
               OutputText += <span class="hljs-string">$"[调用函数 '<span class="hljs-subst">{call.Name}</span>'，参数: <span class="hljs-subst">{JsonSerializer.Serialize(call.Arguments)}</span>]"</span>;
            }
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">is</span> WorkflowOutputEvent output)
        {
            OutputText += <span class="hljs-string">"\n\n工作流完成！"</span>;
            <span class="hljs-keyword">return</span> output.As&lt;List&lt;ChatMessage&gt;&gt;()!;
        }
    }

    <span class="hljs-keyword">return</span> [];
}
</code></pre>
<p>与直觉不一样的地方是只有在传入TurnToken的时候才会开始运行：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">await</span> run.TrySendMessageAsync(<span class="hljs-keyword">new</span> TurnToken(emitEvents: <span class="hljs-literal">true</span>));
</code></pre>
<p>然后通过WorkflowEvent来进行不同操作。</p>
<p>这个例子看最后的输入就是这样的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da50d6c3067e4c29a66badd15b631745~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=dHmRQGGQIUTRjkAxHmoAezsMGTs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">Concurrent 模式</h2>
<p>还是先来看下效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ada191422f8484d986a8d780fcc2d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=cuDZw3tIYA0nlzHtWqFf6yczRM8%3D" alt="" loading="lazy"/></p>
<p>Concurrent就是并发工作流，对同一个输入，不同的AI Agent同时响应。</p>
<p>看一下怎么构建：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 创建并发工作流</span>
 <span class="hljs-keyword">var</span> workflow = AgentWorkflowBuilder.BuildConcurrent(
     <span class="hljs-function"><span class="hljs-keyword">from</span> lang <span class="hljs-title">in</span> (<span class="hljs-params"><span class="hljs-built_in">string</span>[]</span>)["French", "Spanish", "English"] 
     <span class="hljs-keyword">select</span> <span class="hljs-title">GetTranslationAgent</span>(<span class="hljs-params">lang, client</span>)
 )</span>;
</code></pre>
<h2 data-id="heading-3">Handoffs 模式</h2>
<p>Handoffs就是交接模式，跟之前的不太一样，首先我们先创建3个不同的AI Agent：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 创建专门的代理</span>
ChatClientAgent historyTutor = <span class="hljs-keyword">new</span>(client,
    <span class="hljs-string">"你提供历史查询方面的帮助。清晰地解释重要事件和背景。只回应历史相关内容。"</span>,
    <span class="hljs-string">"history_tutor"</span>,
    <span class="hljs-string">"历史问题的专业代理"</span>);

ChatClientAgent mathTutor = <span class="hljs-keyword">new</span>(client,
    <span class="hljs-string">"你提供数学问题方面的帮助。在每一步解释你的推理过程并包含示例。只回应数学相关内容。"</span>,
    <span class="hljs-string">"math_tutor"</span>,
    <span class="hljs-string">"数学问题的专业代理"</span>);

ChatClientAgent triageAgent = <span class="hljs-keyword">new</span>(client,
    <span class="hljs-string">"你根据用户的作业问题确定使用哪个代理。总是将任务交接给另一个代理。"</span>,
    <span class="hljs-string">"triage_agent"</span>,
    <span class="hljs-string">"将消息路由到适当的专业代理"</span>);
</code></pre>
<p>看下如何构建：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 创建交接工作流</span>
 <span class="hljs-keyword">var</span> workflow = AgentWorkflowBuilder.CreateHandoffBuilderWith(triageAgent)
     .WithHandoffs(triageAgent, [mathTutor, historyTutor])
     .WithHandoffs([mathTutor, historyTutor], triageAgent)
     .Build();
</code></pre>
<p>来看下效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca85601410a45ed84294a7d9d25241a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=PSkkA9DTeJ7PN%2FKLGiTnr45zJ%2Bs%3D" alt="" loading="lazy"/></p>
<p>这次会到这个地方：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/411959a80af04a2a922880a0c3d99378~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=1m9fLpWKj3AZMfiteOVozxHG3Ik%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1d23954f8df42fd8f6a31376bcc288c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=cWhAdXp2tqxRifeDCktWkylXjgY%3D" alt="" loading="lazy"/></p>
<p>内部有一个FunctionCall交接给了对应的代理。</p>
<p>看一下最终的结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/743a409ecbee4d8f9912ae45b6201c93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=9oXlovby1yIJKk67tGO3dAwSgdQ%3D" alt="" loading="lazy"/></p>
<p>再问一个数学相关的问题看看效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e1e83094cf24370bfbd516f5d6203d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=OWyvl7hz9z7A%2FLa9Sv8DpyXynsc%3D" alt="" loading="lazy"/></p>
<p>看一下最终的结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0806b5a43c88438fb8e33e7f404563ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=3%2FdPt%2BFxFzAXOjunqHXLQ8l6w6c%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">Groupchat 模式</h2>
<p>Groupchat模式就是开启一个AI群聊，我拿辩论举个例子。</p>
<pre><code class="hljs language-csharp" lang="csharp"> ChatClientAgent chatClientAgent1 = <span class="hljs-keyword">new</span>(client, <span class="hljs-string">"你是辩论正方"</span>);
 ChatClientAgent chatClientAgent2 = <span class="hljs-keyword">new</span>(client, <span class="hljs-string">"你是辩论反方"</span>);
 
  <span class="hljs-comment">// 创建群聊工作流</span>
 <span class="hljs-keyword">var</span> workflow = AgentWorkflowBuilder.CreateGroupChatBuilderWith(agents =&gt; <span class="hljs-keyword">new</span> RoundRobinGroupChatManager(agents) { MaximumIterationCount = <span class="hljs-number">5</span> })
     .AddParticipants([chatClientAgent1, chatClientAgent2])
     .Build();
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3857827e1de4697b640bc84f887bbb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=M%2BSwBd%2BQL4FAlMl1K8MAI2icSFA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a98ec5634ef4db9ab2733f9b7d0da0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640133&amp;x-signature=sXusfynZtRL6Zcd6PPQLjpBF2PM%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WPF/C#：使用Stylet中的IWindowManager用于显示等待窗体、对话框与消息框]]></title>    <link>https://juejin.cn/post/7572016447805030426</link>    <guid>https://juejin.cn/post/7572016447805030426</guid>    <pubDate>2025-11-13T12:03:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572016447805030426" data-draft-id="7572021695294292018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WPF/C#：使用Stylet中的IWindowManager用于显示等待窗体、对话框与消息框"/> <meta itemprop="keywords" content="C#"/> <meta itemprop="datePublished" content="2025-11-13T12:03:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mingupup"/> <meta itemprop="url" content="https://juejin.cn/user/2298414003918396"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WPF/C#：使用Stylet中的IWindowManager用于显示等待窗体、对话框与消息框
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2298414003918396/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mingupup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T12:03:14.000Z" title="Thu Nov 13 2025 12:03:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p><strong>显示等待框意义</strong></p>
<p>在创建WPF应用的时候，如果我们要执行一个耗时的操作，那么给用户显示一个等待窗体是很常见的需求，通过显示一个等待窗体让用户明白运行的这个软件并没有崩溃，能有效消除用户的焦虑与不确定性，同时能极大提升用户体验，展示软件的专业性和品质，将无聊的等待转化为可预期的、安心的过程。</p>
<p><strong>显示对话框意义</strong></p>
<p>对话框能有效地捕获用户焦点。作为模态窗口，它会强制用户必须完成当前任务（如确认、输入信息或做出选择），之后才能继续操作主窗口。这保证了关键业务流程（如保存文件前的确认）的完整性，防止用户误操作。其次，对话框是信息收集与展示的专用容器。它将特定任务（如设置、登录、详情查看）的UI元素和逻辑封装起来，使主窗口界面保持简洁，同时提升了代码的模块化和可维护性。</p>
<p><strong>显示信息框意义</strong></p>
<p>信息框的核心价值在于即时性与强制性。对于操作成功、失败或出现警告等重要反馈，它能立刻捕获用户注意力，通过模态显示确保用户看到并处理该信息，避免了关键提示被忽略。其次，它为用户提供了快速决策的途径。除了纯信息展示，信息框可附带“是/否”、“确定/取消”等按钮，让用户在不离开当前上下文的情况下，就能对简单询问做出迅速回应，如确认删除操作。</p>
<h2 data-id="heading-1">Stylet介绍</h2>
<p>Stylet是一个轻量级、高性能的MVVM框架，专为WPF设计。它摆脱了传统MVVM的样板代码，通过基于约定的特性，使得View和ViewModel的自动关联、依赖注入等变得极其简单。开发者几乎无需配置即可快速上手，其内置的功能如IConductor屏幕管理和事件聚合器，能优雅地处理复杂的应用程序导航与模块间通信。Stylet的目标是让开发者专注于业务逻辑本身，而非繁琐的框架配置，从而显著提升WPF应用的开发效率与代码质量。</p>
<p>本文通过使用Stylet内置的IWindowManager可以很容易实现这个需求。</p>
<h2 data-id="heading-2">显示等待框</h2>
<p>要显示等待窗体那么必须先做一个等待窗体。</p>
<p>创建一个WaitingView.xaml：</p>
<pre><code class="hljs language-csharp" lang="csharp">&lt;Window x:Class=<span class="hljs-string">"Rouyan.Pages.View.WaitingView"</span>
        xmlns=<span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
        xmlns:x=<span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span>
        xmlns:d=<span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span>
        xmlns:mc=<span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span>
        xmlns:materialDesign=<span class="hljs-string">"http://materialdesigninxaml.net/winfx/xaml/themes"</span>
        xmlns:local=<span class="hljs-string">"clr-namespace:Rouyan.Pages.View"</span>
        mc:Ignorable=<span class="hljs-string">"d"</span>
        Title=<span class="hljs-string">"WaitingWindow"</span> 
        Height=<span class="hljs-string">"200"</span> 
        Width=<span class="hljs-string">"350"</span>
        WindowStyle=<span class="hljs-string">"ToolWindow"</span>
        WindowStartupLocation=<span class="hljs-string">"CenterScreen"</span>
        ResizeMode=<span class="hljs-string">"NoResize"</span>
        Topmost=<span class="hljs-string">"True"</span>&gt;
    &lt;Grid&gt;
        &lt;Grid.RowDefinitions&gt;
            &lt;RowDefinition Height=<span class="hljs-string">"Auto"</span>/&gt;
            &lt;RowDefinition Height=<span class="hljs-string">"Auto"</span>/&gt;
        &lt;/Grid.RowDefinitions&gt;
        
        &lt;Border Grid.Row=<span class="hljs-string">"0"</span>
                Background=<span class="hljs-string">"{DynamicResource PrimaryHueMidBrush}"</span>
                Padding=<span class="hljs-string">"16 8"</span>&gt;
            &lt;TextBlock HorizontalAlignment=<span class="hljs-string">"Center"</span>
                       Text=<span class="hljs-string">"{Binding Text}"</span>
                       FontSize=<span class="hljs-string">"16"</span>/&gt;
        &lt;/Border&gt;
        
        &lt;!-- 进度条区域 --&gt;
        &lt;StackPanel Grid.Row=<span class="hljs-string">"1"</span>
                    Orientation=<span class="hljs-string">"Vertical"</span>
                    HorizontalAlignment=<span class="hljs-string">"Center"</span>
                    VerticalAlignment=<span class="hljs-string">"Center"</span>
                    Margin=<span class="hljs-string">"20"</span>&gt;
            
            &lt;ProgressBar Style=<span class="hljs-string">"{StaticResource MaterialDesignCircularProgressBar}"</span>
                         Foreground=<span class="hljs-string">"{DynamicResource SecondaryHueMidBrush}"</span>
                         Width=<span class="hljs-string">"60"</span>
                         Height=<span class="hljs-string">"60"</span>
                         IsIndeterminate=<span class="hljs-string">"True"</span>/&gt;
                
            &lt;TextBlock Text=<span class="hljs-string">"请稍候..."</span>
                       FontSize=<span class="hljs-string">"14"</span>
                       HorizontalAlignment=<span class="hljs-string">"Center"</span>
                       Foreground=<span class="hljs-string">"{DynamicResource MaterialDesignBody}"</span>
                       Margin=<span class="hljs-string">"0,10,0,0"</span>/&gt;
                
        &lt;/StackPanel&gt;
    &lt;/Grid&gt;
&lt;/Window&gt;
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c27516bb2234eb787213717a7607265~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=IZ4MV5cey3inIixTcB6tYGfpirs%3D" alt="" loading="lazy"/></p>
<p>分为两行，上面一行用于显示要显示的信息，下面一行用于显示ProgressBar与"请稍候..."的组合。</p>
<p>现在再来创建对应的ViewModel：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WaitingViewModel</span> : <span class="hljs-title">Screen</span>
 {      
     <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Text { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-string">"处理中..."</span>;

 }
</code></pre>
<p>显示这个等待窗体，比如当我们运行一个耗时任务的时候，可以先显示这个等待窗体给用户：</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment">// 显示等待窗体          </span>
 waitingVm = _container.Get&lt;WaitingViewModel&gt;();
 waitingVm.Text = <span class="hljs-string">"正在分析请求，请稍候..."</span>;
 _windowManager.ShowWindow(waitingVm);
</code></pre>
<p>显示等待窗体主要使用了Stylet中自带的一个组件IWindowManager，我们可以在构造函数中进行依赖注入：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IContainer _container;
<span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IWindowManager _windowManager;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">TerminalAgentViewModel</span>(<span class="hljs-params">IContainer container,IWindowManager windowManager</span>)</span>
{
    _container = container;
    _windowManager = windowManager;
}
</code></pre>
<p>由于等待窗体是一个Window，因此需要使用IWindowManager的ShowWindow方法。</p>
<p>Stylet会帮我们将所有View与ViewModel都以瞬态的形式注入依赖注入容器中了，因此可以不用自己在这里new一个viewmodel而是可以直接从容器中取一个出来：</p>
<pre><code class="hljs language-csharp" lang="csharp"> waitingVm = _container.Get&lt;WaitingViewModel&gt;();
</code></pre>
<p><span>IWindowManager的ShowWindow方法的使用，反直觉的一点是传入的不是这个窗体，而是这个窗体对应的ViewModel，Stylet会根据这个ViewModel自动找到对应的View，这也体现了Stylet中ViewModel First的思想。</span></p>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e867c51c8d4a4941965cc7f6b77b1a3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=4GTbvRiDzOuEIj%2BV4groL4hTl94%3D" alt="" loading="lazy"/></p>
<p>这时候可能会有一个疑问就是那么怎么关闭这个窗体呢？</p>
<p>如果是获取对应的Window，我们调用close方法就可以了，现在获取的是对应的ViewModel该如何关闭这个窗体呢？</p>
<p>Stylet已经考虑到了这一个，只要这样写就可以关闭这个窗体：</p>
<pre><code class="hljs language-csharp" lang="csharp"> waitingVm.RequestClose();
</code></pre>
<h2 data-id="heading-3">显示对话框</h2>
<p>使用Stylet中的IWindowManager显示对话框同样也很简单。</p>
<p>首先创建一个HumanApprovalDialogView：</p>
<pre><code class="hljs language-csharp" lang="csharp">&lt;Window x:Class=<span class="hljs-string">"Rouyan.Pages.View.HumanApprovalDialogView"</span>
        xmlns=<span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span>
        xmlns:x=<span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span>
        xmlns:d=<span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span>
        xmlns:mc=<span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span>
        xmlns:s=<span class="hljs-string">"https://github.com/canton7/Stylet"</span>
        mc:Ignorable=<span class="hljs-string">"d"</span>
        Title=<span class="hljs-string">"{Binding Title}"</span>
        Height=<span class="hljs-string">"200"</span>
        Width=<span class="hljs-string">"420"</span>
        WindowStartupLocation=<span class="hljs-string">"CenterOwner"</span>
        ResizeMode=<span class="hljs-string">"NoResize"</span>
        Topmost=<span class="hljs-string">"True"</span>&gt;
    &lt;Window.InputBindings&gt;
        &lt;KeyBinding Command=<span class="hljs-string">"{s:Action Approve}"</span> Key=<span class="hljs-string">"Y"</span>/&gt;
        &lt;KeyBinding Command=<span class="hljs-string">"{s:Action Reject}"</span> Key=<span class="hljs-string">"N"</span>/&gt;
    &lt;/Window.InputBindings&gt;
    &lt;Grid Margin=<span class="hljs-string">"16"</span>&gt;
        &lt;Grid.RowDefinitions&gt;
            &lt;RowDefinition Height=<span class="hljs-string">"*"</span>/&gt;
            &lt;RowDefinition Height=<span class="hljs-string">"Auto"</span>/&gt;
        &lt;/Grid.RowDefinitions&gt;

        &lt;!-- 顶部消息行 --&gt;
        &lt;ScrollViewer Grid.Row=<span class="hljs-string">"0"</span> VerticalScrollBarVisibility=<span class="hljs-string">"Auto"</span>&gt;
            &lt;TextBlock Text=<span class="hljs-string">"{Binding Message}"</span>
                       TextWrapping=<span class="hljs-string">"Wrap"</span>
                       FontSize=<span class="hljs-string">"14"</span>/&gt;
        &lt;/ScrollViewer&gt;

        &lt;!-- 底部按钮行：左侧同意，右侧拒绝 --&gt;
        &lt;Grid Grid.Row=<span class="hljs-string">"1"</span> Margin=<span class="hljs-string">"0,16,0,0"</span>&gt;
            &lt;Grid.ColumnDefinitions&gt;
                &lt;ColumnDefinition Width=<span class="hljs-string">"*"</span>/&gt;
                &lt;ColumnDefinition Width=<span class="hljs-string">"*"</span>/&gt;
            &lt;/Grid.ColumnDefinitions&gt;

            &lt;Button Grid.Column=<span class="hljs-string">"0"</span>
                    Content=<span class="hljs-string">"同意(Y)"</span>
                    Width=<span class="hljs-string">"100"</span>
                    Height=<span class="hljs-string">"30"</span>
                    HorizontalAlignment=<span class="hljs-string">"Left"</span>
                    IsDefault=<span class="hljs-string">"True"</span>
                    Command=<span class="hljs-string">"{s:Action Approve}"</span>/&gt;

            &lt;Button Grid.Column=<span class="hljs-string">"1"</span>
                    Content=<span class="hljs-string">"拒绝(N)"</span>
                    Width=<span class="hljs-string">"100"</span>
                    Height=<span class="hljs-string">"30"</span>
                    HorizontalAlignment=<span class="hljs-string">"Right"</span>
                    IsCancel=<span class="hljs-string">"True"</span>
                    Command=<span class="hljs-string">"{s:Action Reject}"</span>/&gt;
        &lt;/Grid&gt;
    &lt;/Grid&gt;
&lt;/Window&gt;
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2dbfb2b8e314631905181ab04cbc258~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=FUuT%2BzJiXe9kismTg721tvsDfQI%3D" alt="" loading="lazy"/></p>
<p>创建对应的ViewModel：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HumanApprovalDialogViewModel</span> : <span class="hljs-title">Screen</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HumanApprovalDialogViewModel</span>()</span>
    {
        Title = <span class="hljs-string">"执行审批"</span>;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> _title = <span class="hljs-built_in">string</span>.Empty;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Title
    {
        <span class="hljs-keyword">get</span> =&gt; _title;
        <span class="hljs-keyword">set</span> =&gt; SetAndNotify(<span class="hljs-keyword">ref</span> _title, <span class="hljs-keyword">value</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> _message = <span class="hljs-built_in">string</span>.Empty;
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> Message
    {
        <span class="hljs-keyword">get</span> =&gt; _message;
        <span class="hljs-keyword">set</span> =&gt; SetAndNotify(<span class="hljs-keyword">ref</span> _message, <span class="hljs-keyword">value</span>);
    }

    <span class="hljs-comment">// Approve the action</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Approve</span>()</span>
    {
        RequestClose(<span class="hljs-literal">true</span>);
    }

    <span class="hljs-comment">// Reject the action</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reject</span>()</span>
    {
        RequestClose(<span class="hljs-literal">false</span>);
    }
}
</code></pre>
<p>使用方式与ShowWindow也很相似：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> dialogVm = <span class="hljs-keyword">new</span> HumanApprovalDialogViewModel
{
    Title = <span class="hljs-string">"函数调用审批"</span>,
    Message = <span class="hljs-string">$"是否同意这个操作？"</span>
};

<span class="hljs-built_in">bool</span>? result = _windowManager.ShowDialog(dialogVm);
</code></pre>
<p>最大的区别就是模态与非模态。</p>
<p>模态：
当一个模态窗口（如对话框）出现时，它会独占用户的操作焦点。在用户完成该窗口的任务（例如点击“确定”或“取消”）并关闭它之前，无法与应用程序的其他任何窗口进行交互。程序流程也会在此处暂停，等待窗口关闭后返回结果。这就像一个强制性的“选择题”，你必须回答才能继续。常见场景包括文件保存、确认删除等需要用户明确决策的流程。</p>
<p>非模态：
非模态窗口则像一个开放的助手。它显示后，用户可以随时在它和应用程序的其他窗口之间自由切换，无需关闭它。程序也会继续执行，不会被窗口的开启或关闭打断。这就像一个可以随时查阅的“便签”或“计算器”。它常用于工具箱、属性面板或辅助信息窗口，让用户在主任务进行时能方便地获取额外功能或信息。</p>
<p><span>简言之就是模态就是会阻塞程序运行，要你明确给一个反馈，非模态不会阻塞程序的运行，就单纯显示一个窗体。</span></p>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03fc72263d3e43a9b4673a8359d76a11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=0jHbZSFwQyJfw%2F4cn%2FjbLg%2BJzCM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c36686ddbd4a9b8815bdb6587605a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=Hj6w1ORs8EaMoieZ%2Ftg9vmOU4LY%3D" alt="" loading="lazy"/></p>
<p>同意就返回true，拒绝或者关闭窗体就返回false。</p>
<h2 data-id="heading-4">显示信息框</h2>
<p>我们可以发现IWindowManager除了有ShowWindow与ShowDialog方法外还有一个ShowMessage方法，现在来看下这个方法的使用吧！！</p>
<p>1、基本用法 - 只显示消息</p>
<pre><code class="hljs language-csharp" lang="csharp">_windowManager.ShowMessageBox(<span class="hljs-string">"你好"</span>);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26c669b5cd5242bb9a16d1d996df4a49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=AKGjMjtb6NhNPPR%2BormWK%2BB9DZU%3D" alt="" loading="lazy"/></p>
<p>2、带标题的消息框</p>
<pre><code class="hljs language-csharp" lang="csharp">_windowManager.ShowMessageBox(<span class="hljs-string">"操作完成"</span>, <span class="hljs-string">"提示"</span>);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee8a2ad8e84e41fba8d09a6b771b5b35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=jbANp6fTQ3QJdgUkG%2BTzPI5%2BV3E%3D" alt="" loading="lazy"/></p>
<p>3、带确认和取消按钮的消息框</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-keyword">var</span> result1 = _windowManager.ShowMessageBox(<span class="hljs-string">"确定要删除这个文件吗？"</span>, <span class="hljs-string">"确认删除"</span>,
     MessageBoxButton.OKCancel, MessageBoxImage.Question);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73cc3bd4a9664e1ca709f0eb9fa75acf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=jwHDIYoASBNFYhXTjVbUVxeR8EI%3D" alt="" loading="lazy"/></p>
<p>4、带是/否/取消按钮和警告图标的消息框</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> result2 = _windowManager.ShowMessageBox(<span class="hljs-string">"文件已修改，是否保存？"</span>, <span class="hljs-string">"保存确认"</span>,
    MessageBoxButton.YesNoCancel, MessageBoxImage.Warning);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b25b7572907d4a0a93b7c189109bb028~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=LOrE14q6ddNZkQQiM%2BCV%2BFWIe58%3D" alt="" loading="lazy"/></p>
<p>5、带自定义按钮标签的消息框 (使用YesNoCancel按钮以展示更多选项)</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">var</span> customButtons = <span class="hljs-keyword">new</span> Dictionary&lt;MessageBoxResult, <span class="hljs-built_in">string</span>&gt;
{
    { MessageBoxResult.Yes, <span class="hljs-string">"继续"</span> },
    { MessageBoxResult.No, <span class="hljs-string">"停止"</span> },
    { MessageBoxResult.Cancel, <span class="hljs-string">"取消"</span> }
};
<span class="hljs-keyword">var</span> result3 = _windowManager.ShowMessageBox(<span class="hljs-string">"检测到潜在风险，是否继续操作？"</span>, <span class="hljs-string">"安全警告"</span>,
    MessageBoxButton.YesNoCancel, MessageBoxImage.Exclamation, MessageBoxResult.No, MessageBoxResult.Cancel, customButtons);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f654cf2a8404a61b1e94d0b06738ffb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=pc%2F6uklVZRA8GRxMJZFfv54odGA%3D" alt="" loading="lazy"/></p>
<p>6、带文本对齐和流方向的消息框</p>
<pre><code class="hljs language-csharp" lang="csharp">_windowManager.ShowMessageBox(<span class="hljs-string">"这是一个从右到左显示的消息框文本"</span>, <span class="hljs-string">"RTL示例"</span>,
    MessageBoxButton.OK, MessageBoxImage.Information, MessageBoxResult.None, MessageBoxResult.None,
    <span class="hljs-literal">null</span>, FlowDirection.RightToLeft, TextAlignment.Center);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90c051e6b0ec479d9001f7546a17c390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=QXx3T8GvdX64oOoaR5HLJl2nE4Q%3D" alt="" loading="lazy"/></p>
<p>7、完整参数示例</p>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-keyword">var</span> fullResult = _windowManager.ShowMessageBox(
     <span class="hljs-string">"这是一个完整的消息框示例，包含了所有参数的使用"</span>,
     <span class="hljs-string">"完整示例"</span>,
     MessageBoxButton.OKCancel,
     MessageBoxImage.Information,
     MessageBoxResult.OK,
     MessageBoxResult.Cancel,
     <span class="hljs-literal">null</span>,
     FlowDirection.LeftToRight,
     TextAlignment.Left);
</code></pre>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/597b553aec334191b1168ba4c13ba031~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbWluZ3VwdXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763640194&amp;x-signature=N1HB%2FXiekgl9LgLuIVUAY6JnWpo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">最后</h2>
<p>本文梳理了Stylet中IWindowManager的用法，分别是ShowWindow、ShowDialog与ShowMessageBox希望对你有所帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？]]></title>    <link>https://juejin.cn/post/7571372478803820559</link>    <guid>https://juejin.cn/post/7571372478803820559</guid>    <pubDate>2025-11-12T02:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571372478803820559" data-draft-id="7571280402964922403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2025-11-12T02:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            货拉拉数据工厂：从3k+工具到AI智能体，我们如何让造数效率翻倍？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:06:17.000Z" title="Wed Nov 12 2025 02:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：代丽 货拉拉/技术中心/质量保障部/履约组</p>
</blockquote>
<p>当一个数据平台的工具量突破3000+、日均调用超50万次，是该庆祝规模化的胜利，还是警惕效率的陷阱？</p>
<p>货拉拉数据工厂就曾站在这样的十字路口——依托高效的"协议编程"架构，我们实现了工具的爆发式增长，却也迎来了用户最真实的抱怨："工具太多选不出""串流程要记半天""新手上手太费劲"。</p>
<p>于是，一场从"平台化"到"AI智能化"的跃迁就此启动。今天，我们就聊聊这场转型背后的痛点、方案与收获。</p>
<h2 data-id="heading-0">一、3k+工具的甜蜜烦恼：高效架构下的使用困局</h2>
<p>在聊转型前，必须先说说支撑我们走到今天的核心底气——"协议编程"架构，简单来说就是：</p>
<blockquote>
<p>工具开发者只需写Java工具类（遵循统一规范），平台通过自研解析引擎自动提取功能描述、输入输出参数等元信息，前端再自动生成可视化界面。</p>
</blockquote>
<p>这个模式的威力有多强？开发者不用管前端交互、权限控制这些"杂事"，专注业务逻辑就行，<strong>工具开发成本直接降低60%以上</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc4dbf418904fce8705fb9f3cca9d7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=CwN1EYRKuEZUhzLPIf5V%2FU6YhOw%3D" alt="" loading="lazy"/></p>
<p>靠着这套打法，数据工厂迅速成为内部造数的核心基础设施：工具总量突破3k+，日均调用超50万次。但规模上去了，新问题也找上门了，集中在两个核心痛点：</p>
<h3 data-id="heading-1">1. 工具太多，选得发愁</h3>
<p>为了鼓励提效，我们采用"全局核心工具+业务线自定义工具"的运营策略，这就导致很多功能相似的工具并存。比如"账号信息查询"这个简单场景，平台上就有3个主流版本：</p>
<ul>
<li>账号中台：通用版（支持全账户类型）</li>
<li>司机业务线：专属版（仅支持司机账户）</li>
<li>用户业务线：专属版（仅支持用户账户）</li>
</ul>
<p>实际使用中，70%的用户会优先选本业务线工具，导致通用工具复用率不足30%；更糟的是，新用户得花<strong>3分钟对比测试</strong>才能找到合适的工具，提升了使用门槛。</p>
<h3 data-id="heading-2">2. 步骤太繁，操作耗时</h3>
<p>我们的工具大多是"原子化"的，一个工具只干一件事。但真实业务场景往往需要多工具串联，比如"下单并给指定司机流转至完单"这个高频操作，用户得手动走三步：</p>
<ol>
<li>用"获取司机信息"工具查车型</li>
<li>用"下单"工具完成创建</li>
<li>用"订单流转"工具更新状态</li>
</ol>
<p>整个流程平均要5分钟，中间还要手动记结果、切工具，不仅麻烦，还容易出错。</p>
<h2 data-id="heading-3">二、升级目标：让造数像"说话"一样简单</h2>
<p>针对这些痛点，我们明确了AI升级的核心方向：<strong>打造一个能理解自然语言、自主调度工具的智能体（Agent）</strong> ，彻底改变用户与数据工厂的交互方式。</p>
<p>具体来说，就是要实现三个核心能力，让用户从"工具操作者"变成"需求提出者"：</p>
<ul>
<li><strong>精准懂需求</strong>：不用记工具名，用日常话描述需求就行（比如"查一下司机张三的账号信息并履约完单"）</li>
<li><strong>智能配工具</strong>：系统自动选最优工具，多步骤场景自动串联，不用手动组合</li>
<li><strong>自动跑流程</strong>：参数传递、工具调用、结果整合全自动化，直接给最终结果</li>
</ul>
<p>我们的愿景很直接： <strong>"所想即所得，所造皆能成"</strong> 。初期目标更是明确：造数效率提升50%以上，新用户上手时间缩短到1分钟内。</p>
<h2 data-id="heading-4">三、技术方案：AI+数据工厂的三重协同落地</h2>
<h3 data-id="heading-5">3.1 技术决策：从理论最优到落地可行</h3>
<p>智能体的核心技术选型，我们围绕业务特性做了多轮评估。常见的与LLM结合方案有三种：RAG（检索增强生成）、MCP（执行引擎）和Fine-tuning（模型微调）。</p>
<p>从理论上看，Fine-tuning似乎是最优解——数据工厂覆盖货运、小拉出行、国际化等全业务线，沉淀了大量特有领域知识，微调能让模型深度融合这些知识，减少上下文输入量，提升稳定性。</p>
<p>但早期简易尝试后，我们发现了实际障碍：微调需要大量标注数据，且对算法团队的技术能力要求极高，同时持续迭代的成本也难以承受。综合落地难度与效果反馈，我们最终确定了 <strong>“LLM+RAG+MCP”的协同路径</strong>，兼顾效果、成本与落地效率。</p>
<h3 data-id="heading-6">3.2 技术方案：三大模块构筑智能体能力</h3>
<p>我们将智能体拆解为“大脑（LLM）-知识库（RAG）-手脚（MCP）”三个核心模块，分别负责“理解决策”“知识储备”“执行落地”，形成完整工作流。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1f66e63fa8b4a7daaa8ba3779f0d252~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=zN%2BsUd4%2BP4VMhzj13z0lz3lz0os%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">3.2.1 LLM：智能体的“决策大脑”</h4>
<p>LLM是智能体的核心决策层，使用到LLM的共有6处，出于成本与调优效果做了如下组合与配置（精选3个展示）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13d498042d0c40f291357121e167093d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=FrB3C63EgMES2AmvEf6YYtYT4MU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">3.2.2 RAG：智能体的“知识储备库”</h4>
<p>LLM 具备强大的通用能力，但对我们内部 3000 + 工具的具体信息 “一无所知”。若直接输入全量工具信息，会导致上下文过载。因此，我们通过 RAG 技术构建 “精准检索 - 高效赋能” 的知识库体系，助力智能体精准 “认知” 所需工具。</p>
<p>实践中，我们选用 bge_base_zh_1.5 作为 Embedding 模型，以适配中文语义理解场景；同时，为提升检索的精度与全面性，搭建了双层知识库筛选策略，并将其与固定原子工具列表组合，最终形成 toolList给到LLM使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4f53877a952443b8546e0d3c8ae4a61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=iqw4Ihwf3tHrg38zrItumGLOBvw%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>全量工具详情知识库</strong>：数据直接同步平台工具数据库，细分为“线上”“线下”两个子库——线上库对应生产环境工具，线下库对应测试环境工具，避免智能体误调用测试工具影响线上业务，保障执行安全性。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97aa3aebd49240b4ad3ff99c42da5aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=6e%2BriJkIPo57AXC09Ie8kq%2BZi2M%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li><strong>自然语言与工具映射知识库</strong>：人工维护多语义映射关系，解决“用户表述≠工具描述”的匹配难题。比如“下单”“开单”“创建订单”等不同说法，均映射到同一工具，大幅提升模糊需求的匹配准确率。</li>
</ol>
<p>具体配置与分段信息如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10109254d5fb4aa3ba78f23fe5e012c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=jZll3THBqBe2PxPi4hfBGz7%2FMPA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.2.3 MCP：智能体的“执行手脚”</h4>
<p>工具组合方案确定后，就需要MCP（执行引擎）负责“落地执行”，核心解决“按序执行、参数传递、失败处理、结果解析”四大问题，让智能体“会用”工具。</p>
<p>此处tool仅有一个，功能是单个工具运行，其执行逻辑依赖于prompt，prompt大纲设计：</p>
<ul>
<li><strong>核心任务定位</strong>：按工具序列依次执行，保障前序结果向后续传递，失败自动重试；提取执行结果并匹配用户诉求，用自然语言呈现。</li>
<li><strong>核心执行规则</strong>： - 顺序执行：严格遵循工具列表顺序，前序工具执行成功是后序执行的前提； - 参数关联：动态参数从历史执行结果中自动提取，固定参数保持预设值不变； - 失败处理：执行失败触发重试机制（默认3次），重试失败则终止流程并记录失败状态与原因。</li>
<li><strong>结果解析规范</strong>：根据执行状态码（如ret值）判断成败；成功则筛选核心信息分点呈现，失败则明确标注状态码、失败环节及可能原因，便于用户排查。</li>
</ul>
<h2 data-id="heading-10">四、阶段性成果：上线三月，效率与口碑双丰收</h2>
<p>今年8月AI智能体正式上线，作为内部工具的智能化升级尝试，经过一段时间的推广与迭代，在核心效率指标与用户口碑方面已取得显著成效，验证了升级方向的可行性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be704eafbb134285b0a6eb90522d2dee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763518191&amp;x-signature=W1ynp356ITusJ312zFBXhobXtWI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">4.1 核心数据：用户渗透良好，效率提升显著</h3>
<p>上线至今，智能体的用户接纳度逐步提升，核心效率指标达到预期目标：</p>
<ul>
<li><strong>用户渗透</strong>：累计吸引500+内部用户使用，涵盖测试、产品、开发等关键技术岗位；</li>
<li><strong>调用表现</strong>：当前支持工具100+，累计调用次数3k+，受限于部分用户使用习惯尚未完全转变和支持工具数量有限，但高频用户的周均调用频次达10次，使用粘性较高；</li>
<li><strong>效率提升</strong>：核心业务场景的造数效率提升效果明显，以“下单并流转至完单”为例，操作时间从原有的5分钟缩短至1.5分钟左右，效率提升70%；</li>
<li><strong>使用门槛</strong>：新用户上手适应时间从原有的3分钟压缩至1分钟内，自然语言交互方式有效降低了工具使用的学习成本；</li>
</ul>
<h3 data-id="heading-12">4.2 用户反馈：跨岗位认可，痛点解决明确</h3>
<p>尽管当前使用规模仍在拓展，但智能体精准解决了用户的核心痛点，获得了实际使用者的广泛认可，积累了不少正面反馈：</p>
<ul>
<li><strong>研发岗位</strong>：“这个太牛了，不用去数据工厂找工具了，研发联调的时候很受用”——某开发反馈；</li>
<li><strong>产岗位</strong>：“说实话，有AI*数据工厂，产品验收轻松多了”——某产品反馈；</li>
<li><strong>测试岗位</strong>：“太好用了，测试经常要批量造数，和它说，它可以一次完成，原来我还得在页面点多次”——某测试反馈。</li>
</ul>
<h3 data-id="heading-13">4.3 成果价值：验证方向，沉淀经验</h3>
<p>此次阶段性成果的核心价值，不仅在于效率数据的提升，更在于验证了“AI+数据工厂”模式的可行性：一方面，通过智能化手段解决了平台规模化后的核心痛点，为后续推广积累了真实使用案例；另一方面，基于用户反馈沉淀了模型调优、交互设计的经验，为进一步提升调用频次、扩大使用范围奠定了基础。</p>
<h2 data-id="heading-14">五、未来规划：在迭代中持续精进</h2>
<p>AI智能体的初步落地验证了方向的可行性，但在实际应用中，我们也发现了需要持续优化的核心痛点。基于当前反馈，后续将聚焦问题解决与能力升级，稳步推进智能化深化。</p>
<h3 data-id="heading-15">5.1 现存核心痛点</h3>
<p>结合用户使用数据与反馈收集，目前主要存在两类待解决的问题，也是后续优化的方向：</p>
<ul>
<li><strong>表述习惯差异导致的适配问题</strong>：不同岗位、不同使用经验的用户，对同一业务场景的表述存在差异。以“小b下单”场景为例，用户可能表述为“小b下单”“货运下单”“APP创建小b订单”等多种形式。尽管当前通过持续丰富RAG知识库已实现问题可控，但知识库更新存在一定后置性，未能从源头减少歧义。</li>
<li><strong>LLM</strong> <strong>上下文过载与幻觉问题</strong>：数据工厂工具覆盖货拉拉货运、小拉出行、国际化等全业务线，为保障LLM对业务场景的理解精度，需在上下文中外挂大量业务知识与工具信息，导致上下文内容过载。这一问题直接引发LLM幻觉现象频发（如工具选错、生成逻辑有误的执行序列等），单纯通过精简上下文内容已难以有效缓解。</li>
</ul>
<h3 data-id="heading-16">5.2 后续优化路径</h3>
<p>针对上述痛点，我们制定了明确的分阶段优化计划，兼顾短期问题解决与长期能力提升：</p>
<h4 data-id="heading-17">1. 前置化引导，降低表述歧义</h4>
<p>为解决表述差异问题，后续将从“后置知识库补充”转向“前置输入引导”。计划在交互界面增加场景化引导模块：基于历史调用数据梳理高频业务场景（如订单创建、账号查询、状态流转等），为每个场景配置标准化话术模板与关键词提示。用户输入时，系统可根据初步语义识别推荐对应场景模板，用户仅需补充关键参数即可完成需求提交，从源头降低歧义表述概率。</p>
<h4 data-id="heading-18"><strong>2. 职责拆分 + 场景固化，从架构层面降低幻觉概率</strong></h4>
<p>针对上下文过载引发的幻觉问题，采用 “现有平台交互改造 + 智能体职责拆分” 双轮驱动策略，具体如下：</p>
<ul>
<li><strong>现有平台交互改造</strong>：将现有平台执行底层升级为智能体执行模式，前端除了结果展示采用智能体输出效果，其他不变。该方式既能适配用户现有使用习惯，又能规避 LLM 动态组装工具带来的幻觉风险。</li>
<li><strong>智能体职责拆分</strong>：当前智能体核心决策依赖 “工具组装” 单一 LLM，导致其同时承载业务知识存储、工具匹配判断、执行序列生成等多重职责。后续将核心职责拆分为 “业务知识解析”“工具匹配筛选”“执行序列生成” 三个独立模块，通过 “轻量化 LLM + 专用 RAG 知识库” 协同实现（如专用 RAG 承载业务知识、独立 LLM 负责工具匹配）。此举可显著降低单个模型的上下文负载，从架构层面减少幻觉发生概率。</li>
</ul>
<h4 data-id="heading-19">3. 长期技术探索：微调路径持续验证</h4>
<p>尽管初期因数据、成本等因素放弃了Fine-tuning方案，但随着业务数据的积累与技术成本的优化，我们将持续小范围验证微调可行性。计划选取高频业务场景（如订单全链路相关工具），构建专属微调数据集，探索“基础模型+场景微调”的混合模式，进一步提升模型对特定场景的理解精度与决策稳定性。</p>
<h3 data-id="heading-20">5.3 转型感悟：AI落地是场长期修行</h3>
<p>在智能体落地过程中，我们深刻体会到：LLM的强大之处在于其泛化能力，但相较于传统工程代码的强可控性，它更像一个“需要持续调教的伙伴”。AI赋能并非一蹴而就，而是循序渐进的迭代过程——既要接受初期的不完美，通过实际场景反馈持续调优；也要保持对新技术的敏感度，及时将成熟的技术方案融入现有体系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！]]></title>    <link>https://juejin.cn/post/7571402480967368740</link>    <guid>https://juejin.cn/post/7571402480967368740</guid>    <pubDate>2025-11-12T06:49:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571402480967368740" data-draft-id="7564718467829465088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！"/> <meta itemprop="keywords" content="后端,Java,MyBatis"/> <meta itemprop="datePublished" content="2025-11-12T06:49:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis-Plus 让你开发效率翻倍！新手也能5分钟上手！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T06:49:38.000Z" title="Wed Nov 12 2025 06:49:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是大华。这篇文章介绍<code>MyBatis-Plus</code>！</p>
<p><strong>什么是 MyBatis-Plus？</strong></p>
<p>简单来说，<code>MyBatis-Plus</code>是<code>MyBatis</code>的增强工具，在MyBatis的基础上只做增强不做改变，<strong>既能够简化开发，又能够提高效率</strong>！</p>
<p>我们就从最简单的开始吧！只需要几行代码就能搞定常见的 CRUD 操作。</p>
<p>如果你是新手，可以能快速的学习<code>MyBatis-Plus</code>，如果你是有经验的开发，也可以巩固一下相关的内容。</p>
<h3 data-id="heading-0">1. 添加依赖</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在 pom.xml 中添加以下依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis-Plus Starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 数据库驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Lombok 简化实体类开发 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-comment"># 替换成你的数据库信息</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/mybatis_plus_demo?useSSL=false&amp;serverTimezone=Asia/Shanghai&amp;characterEncoding=utf8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>

<span class="hljs-comment"># MyBatis-Plus 配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-comment"># 打印 SQL 日志，方便调试</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启驼峰命名自动转换</span>
  <span class="hljs-attr">global-config:</span>
    <span class="hljs-attr">db-config:</span>
      <span class="hljs-comment"># 逻辑删除配置</span>
      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span>  <span class="hljs-comment"># 全局逻辑删除的实体字段名</span>
      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span>        <span class="hljs-comment"># 逻辑已删除值(默认为 1)</span>
      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span>    <span class="hljs-comment"># 逻辑未删除值(默认为 0)</span>
      <span class="hljs-attr">id-type:</span> <span class="hljs-string">auto</span>               <span class="hljs-comment"># 主键ID自增</span>
</code></pre>
<h3 data-id="heading-2">3. 实体类设计</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.*;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("user")</span>  <span class="hljs-comment">// 指定对应的数据库表名</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-comment">/**
     * 用户ID - 主键
     * <span class="hljs-doctag">@TableId</span> 注解表示这是主键
     * value = "id" 表示对应数据库字段名
     * type = IdType.AUTO 表示主键自增
     */</span>
    <span class="hljs-meta">@TableId(value = "id", type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-comment">/**
     * 用户名
     * 如果字段名与数据库列名一致（驼峰转下划线），可以省略 <span class="hljs-doctag">@TableField</span>
     */</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 年龄
     */</span>
    <span class="hljs-keyword">private</span> Integer age;
    
    <span class="hljs-comment">/**
     * 邮箱
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 创建时间
     * <span class="hljs-doctag">@TableField</span> 配置填充策略
     */</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    
    <span class="hljs-comment">/**
     * 更新时间
     * 插入和更新时都自动填充
     */</span>
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
    
    <span class="hljs-comment">/**
     * 逻辑删除字段
     * 0-未删除 1-已删除
     */</span>
    <span class="hljs-meta">@TableLogic</span>
    <span class="hljs-keyword">private</span> Integer deleted;
}
</code></pre>
<h3 data-id="heading-3">4. Mapper 接口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.Mapper;

<span class="hljs-comment">/**
 * UserMapper 接口
 * 继承 BaseMapper 就自动拥有了 CRUD 方法
 * 
 * 注意：BaseMapper&lt;User&gt; 中的 User 是实体类类型
 */</span>
<span class="hljs-meta">@Mapper</span>  <span class="hljs-comment">// 一定要加上 @Mapper 注解，Spring 才能扫描到</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; {
    <span class="hljs-comment">// 不需要写任何方法，基本的 CRUD 都已经有了！</span>
    
    <span class="hljs-comment">/**
     * 如果需要自定义SQL，可以这样写
     */</span>
    <span class="hljs-comment">// @Select("SELECT * FROM user WHERE age &gt; #{minAge}")</span>
    <span class="hljs-comment">// List&lt;User&gt; selectUsersByMinAge(@Param("minAge") Integer minAge);</span>
}
</code></pre>
<h3 data-id="heading-4">5. 服务层实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-comment">/**
 * UserService 实现类
 * 
 * 继承 ServiceImpl 就自动拥有了更多的 CRUD 方法
 * 参数说明：
 * - UserMapper：你的 Mapper 接口
 * - User：你的实体类
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; {
    <span class="hljs-comment">// 可以在这里添加自定义的业务方法</span>
    
    <span class="hljs-comment">/**
     * 自定义方法：根据用户名查询用户
     */</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserByUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 使用 MP 的查询构造器</span>
        <span class="hljs-keyword">return</span> lambdaQuery()
                .eq(User::getUsername, username)  <span class="hljs-comment">// username = ?</span>
                .one();  <span class="hljs-comment">// 查询一条记录</span>
    }
    
    <span class="hljs-comment">/**
     * 自定义方法：根据邮箱后缀查询用户
     */</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getUsersByEmailSuffix</span><span class="hljs-params">(String emailSuffix)</span> {
        <span class="hljs-keyword">return</span> lambdaQuery()
                .likeRight(User::getEmail, emailSuffix)  <span class="hljs-comment">// email like 'emailSuffix%'</span>
                .list();
    }
}
</code></pre>
<h3 data-id="heading-5">6. 新增操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 新增用户
     */</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-comment">// 方法1：使用 save 方法</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.save(user);
        
        <span class="hljs-keyword">if</span> (success) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"新增用户成功，用户ID："</span> + user.getId();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"新增用户失败"</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 批量新增用户
     */</span>
    <span class="hljs-meta">@PostMapping("/batch")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;User&gt; users)</span> {
        <span class="hljs-comment">// 批量插入，每次插入100条</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.saveBatch(users, <span class="hljs-number">100</span>);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"批量新增成功"</span> : <span class="hljs-string">"批量新增失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 新增或更新用户（存在则更新，不存在则新增）
     */</span>
    <span class="hljs-meta">@PostMapping("/save-or-update")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">saveOrUpdateUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.saveOrUpdate(user);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"操作成功"</span> : <span class="hljs-string">"操作失败"</span>;
    }
}
</code></pre>
<h3 data-id="heading-6">7. 查询操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 查询相关操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID查询用户
     */</span>
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-keyword">return</span> userService.getById(id);
    }
    
    <span class="hljs-comment">/**
     * 查询所有用户
     */</span>
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.list();
    }
    
    <span class="hljs-comment">/**
     * 条件查询：查询年龄大于18的用户
     */</span>
    <span class="hljs-meta">@GetMapping("/adults")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAdultUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .gt(User::getAge, <span class="hljs-number">18</span>)        <span class="hljs-comment">// age &gt; 18</span>
                .list();
    }
    
    <span class="hljs-comment">/**
     * 复杂条件查询：年龄在18-60之间，并且用户名包含"张"
     */</span>
    <span class="hljs-meta">@GetMapping("/complex")</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getComplexUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .between(User::getAge, <span class="hljs-number">18</span>, <span class="hljs-number">60</span>)           <span class="hljs-comment">// age between 18 and 60</span>
                .like(User::getUsername, <span class="hljs-string">"张"</span>)           <span class="hljs-comment">// username like '%张%'</span>
                .orderByDesc(User::getAge)               <span class="hljs-comment">// 按年龄降序</span>
                .list();
    }
    
    <span class="hljs-comment">/**
     * 分页查询
     */</span>
    <span class="hljs-meta">@GetMapping("/page")</span>
    <span class="hljs-keyword">public</span> Page&lt;User&gt; <span class="hljs-title function_">getUserPage</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> Integer current,
            <span class="hljs-meta">@RequestParam(defaultValue = "10")</span> Integer size)</span> {
        
        <span class="hljs-comment">// 创建分页对象</span>
        Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size);
        
        <span class="hljs-comment">// 执行分页查询</span>
        <span class="hljs-keyword">return</span> userService.page(page);
    }
    
    <span class="hljs-comment">/**
     * 带条件的分页查询
     */</span>
    <span class="hljs-meta">@GetMapping("/page-with-condition")</span>
    <span class="hljs-keyword">public</span> Page&lt;User&gt; <span class="hljs-title function_">getUserPageWithCondition</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> Integer current,
            <span class="hljs-meta">@RequestParam(defaultValue = "10")</span> Integer size,
            <span class="hljs-meta">@RequestParam(required = false)</span> String keyword)</span> {
        
        Page&lt;User&gt; page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, size);
        
        <span class="hljs-keyword">return</span> userService.lambdaQuery()
                .like(StringUtils.isNotBlank(keyword), User::getUsername, keyword)
                .page(page);
    }
}
</code></pre>
<h3 data-id="heading-7">8. 更新操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 更新操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID更新用户
     */</span>
    <span class="hljs-meta">@PutMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-keyword">if</span> (user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"用户ID不能为空"</span>;
        }
        
        <span class="hljs-comment">// 方法1：根据ID更新所有字段</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.updateById(user);
        
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"更新成功"</span> : <span class="hljs-string">"更新失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 条件更新：将所有年龄小于18的用户年龄设置为18
     */</span>
    <span class="hljs-meta">@PutMapping("/fix-age")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">fixAge</span><span class="hljs-params">()</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.lambdaUpdate()
                .lt(User::getAge, <span class="hljs-number">18</span>)        <span class="hljs-comment">// age &lt; 18</span>
                .set(User::getAge, <span class="hljs-number">18</span>)       <span class="hljs-comment">// 设置 age = 18</span>
                .update();
        
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"年龄修复成功"</span> : <span class="hljs-string">"年龄修复失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 部分字段更新
     */</span>
    <span class="hljs-meta">@PatchMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">partialUpdateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, 
                                   <span class="hljs-meta">@RequestBody</span> Map&lt;String, Object&gt; updates)</span> {
        <span class="hljs-comment">// 移除不能更新的字段</span>
        updates.remove(<span class="hljs-string">"id"</span>);
        updates.remove(<span class="hljs-string">"createTime"</span>);
        
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.updateById(id, updates);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"部分更新成功"</span> : <span class="hljs-string">"部分更新失败"</span>;
    }
}
</code></pre>
<h3 data-id="heading-8">9. 删除操作</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 删除操作
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
    
    <span class="hljs-comment">/**
     * 根据ID删除用户（逻辑删除）
     */</span>
    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 逻辑删除，实际上执行的是 update 操作，将 deleted 字段设置为 1</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.removeById(id);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"删除成功"</span> : <span class="hljs-string">"删除失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 批量删除
     */</span>
    <span class="hljs-meta">@DeleteMapping("/batch")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">batchDeleteUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;Long&gt; ids)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.removeByIds(ids);
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"批量删除成功"</span> : <span class="hljs-string">"批量删除失败"</span>;
    }
    
    <span class="hljs-comment">/**
     * 条件删除：删除所有年龄大于100的用户
     */</span>
    <span class="hljs-meta">@DeleteMapping("/old")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteOldUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> userService.lambdaUpdate()
                .gt(User::getAge, <span class="hljs-number">100</span>)       <span class="hljs-comment">// age &gt; 100</span>
                .remove();
        <span class="hljs-keyword">return</span> success ? <span class="hljs-string">"删除老年用户成功"</span> : <span class="hljs-string">"删除失败"</span>;
    }
}
</code></pre>
<h2 data-id="heading-9">高级特性</h2>
<h3 data-id="heading-10">10. 自动填充功能</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自动填充处理器
 * 用于自动填充 createTime 和 updateTime
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMetaObjectHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MetaObjectHandler</span> {
    
    <span class="hljs-comment">/**
     * 插入时自动填充
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-comment">// 填充创建时间</span>
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"createTime"</span>, LocalDateTime.class, LocalDateTime.now());
        <span class="hljs-comment">// 填充更新时间</span>
        <span class="hljs-built_in">this</span>.strictInsertFill(metaObject, <span class="hljs-string">"updateTime"</span>, LocalDateTime.class, LocalDateTime.now());
    }
    
    <span class="hljs-comment">/**
     * 更新时自动填充
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateFill</span><span class="hljs-params">(MetaObject metaObject)</span> {
        <span class="hljs-comment">// 更新时只填充更新时间</span>
        <span class="hljs-built_in">this</span>.strictUpdateFill(metaObject, <span class="hljs-string">"updateTime"</span>, LocalDateTime.class, LocalDateTime.now());
    }
}
</code></pre>
<h3 data-id="heading-11">11. 分页插件配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * MyBatis-Plus 配置类
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.yourpackage.mapper")</span>  <span class="hljs-comment">// 指定Mapper接口的扫描路径</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    
    <span class="hljs-comment">/**
     * 分页插件配置
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        
        <span class="hljs-comment">// 分页插件</span>
        <span class="hljs-type">PaginationInnerInterceptor</span> <span class="hljs-variable">paginationInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL);
        paginationInterceptor.setMaxLimit(<span class="hljs-number">1000L</span>);  <span class="hljs-comment">// 设置最大单页限制数量</span>
        paginationInterceptor.setOverflow(<span class="hljs-literal">true</span>);   <span class="hljs-comment">// 超出最大页数后回到第一页</span>
        
        interceptor.addInnerInterceptor(paginationInterceptor);
        
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<h3 data-id="heading-12">12. 乐观锁插件配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 MybatisPlusConfig 中添加乐观锁插件</span>
<span class="hljs-comment">/**
 * 乐观锁插件配置
 */</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> OptimisticLockerInnerInterceptor <span class="hljs-title function_">optimisticLockerInnerInterceptor</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockerInnerInterceptor</span>();
}

<span class="hljs-comment">// 实体类中配置乐观锁字段</span>
<span class="hljs-meta">@Version</span>
<span class="hljs-keyword">private</span> Integer version;
</code></pre>
<h3 data-id="heading-13">13. 谨慎使用场景</h3>
<p><strong>1. 超复杂 SQL 场景</strong></p>
<ul>
<li>涉及大量复杂联表查询</li>
<li>需要高度优化的自定义 SQL</li>
<li>复杂的存储过程调用</li>
</ul>
<p><strong>2. 性能要求极高的场景</strong></p>
<ul>
<li>高并发写入场景</li>
<li>需要精细控制 SQL 执行的场景</li>
</ul>
<p><strong>3. 遗留系统改造</strong></p>
<ul>
<li>已有复杂 MyBatis 配置的项目</li>
<li>数据库设计不符合 MP 规范</li>
</ul>
<h3 data-id="heading-14">14. 不推荐使用场景</h3>
<p><strong>1. JPA 生态重度依赖项目</strong></p>
<ul>
<li>已经深度使用 Spring Data JPA</li>
<li>需要 JPA 的级联操作等特性</li>
</ul>
<p><strong>2. 非关系型数据库</strong></p>
<ul>
<li>MongoDB、Redis 等 NoSQL 数据库</li>
<li>图数据库等特殊存储</li>
</ul>
<h2 data-id="heading-15">最佳实践建议</h2>
<h3 data-id="heading-16">15. 实体类设计规范</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基础实体类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseEntity</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT)</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    
    <span class="hljs-meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
    
    <span class="hljs-meta">@TableLogic</span>
    <span class="hljs-keyword">private</span> Integer deleted;
}

<span class="hljs-comment">// 业务实体类</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span>
<span class="hljs-meta">@TableName("sys_user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseEntity</span> {
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">// 数据库字段名与实体类字段名不一致时使用</span>
    <span class="hljs-meta">@TableField("phone_number")</span>
    <span class="hljs-keyword">private</span> String phoneNumber;
    
    <span class="hljs-comment">// 不映射到数据库的字段</span>
    <span class="hljs-meta">@TableField(exist = false)</span>
    <span class="hljs-keyword">private</span> String temporaryCode;
}
</code></pre>
<h3 data-id="heading-17">16. 服务层封装建议</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 好的服务层封装</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; {
    
    <span class="hljs-comment">/**
     * 业务方法：用户注册
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">register</span><span class="hljs-params">(UserRegisterDTO registerDTO)</span> {
        <span class="hljs-comment">// 1. 校验用户名是否已存在</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> lambdaQuery()
                .eq(User::getUsername, registerDTO.getUsername())
                .exists();
        <span class="hljs-keyword">if</span> (exists) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户名已存在"</span>);
        }
        
        <span class="hljs-comment">// 2. DTO 转 Entity</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        BeanUtils.copyProperties(registerDTO, user);
        
        <span class="hljs-comment">// 3. 保存用户</span>
        <span class="hljs-keyword">return</span> save(user);
    }
    
    <span class="hljs-comment">/**
     * 安全的更新方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">safeUpdate</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.getId() == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户ID不能为空"</span>);
        }
        
        <span class="hljs-comment">// 只更新非空字段</span>
        <span class="hljs-keyword">return</span> lambdaUpdate()
                .eq(User::getId, user.getId())
                .set(user.getUsername() != <span class="hljs-literal">null</span>, User::getUsername, user.getUsername())
                .set(user.getAge() != <span class="hljs-literal">null</span>, User::getAge, user.getAge())
                .set(user.getEmail() != <span class="hljs-literal">null</span>, User::getEmail, user.getEmail())
                .update();
    }
}
</code></pre>
<h3 data-id="heading-18">17. 异常处理建议</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 全局异常处理
 */</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 处理业务异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Result&lt;?&gt;&gt; handleBusinessException(BusinessException e) {
        log.error(<span class="hljs-string">"业务异常: {}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> ResponseEntity.badRequest().body(Result.error(e.getMessage()));
    }
    
    <span class="hljs-comment">/**
     * 处理数据异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(DataAccessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Result&lt;?&gt;&gt; handleDataAccessException(DataAccessException e) {
        log.error(<span class="hljs-string">"数据访问异常: {}"</span>, e.getMessage());
        <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(Result.error(<span class="hljs-string">"数据操作失败"</span>));
    }
}

<span class="hljs-comment">/**
 * 统一返回结果
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> Integer code;
    <span class="hljs-keyword">private</span> String message;
    <span class="hljs-keyword">private</span> T data;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;();
        result.setCode(<span class="hljs-number">200</span>);
        result.setMessage(<span class="hljs-string">"成功"</span>);
        result.setData(data);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Result&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(String message)</span> {
        Result&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;();
        result.setCode(<span class="hljs-number">500</span>);
        result.setMessage(message);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p><strong>工具是为人服务的</strong>，选择适合自己项目的技术栈才是最重要的。MyBatis-Plus 在大多数业务场景下都能显著提升开发效率，值得大家深入学习和使用。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-20">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fy-GJ26kl0-yT6hE3fy2KjQ" target="_blank" title="https://mp.weixin.qq.com/s/y-GJ26kl0-yT6hE3fy2KjQ" ref="nofollow noopener noreferrer">《MySQL 为什么不推荐用雪花ID 和 UUID 做主键？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1Th3DuMqYpt4Xg5hEywIww" target="_blank" title="https://mp.weixin.qq.com/s/1Th3DuMqYpt4Xg5hEywIww" ref="nofollow noopener noreferrer">《用html写了个超好用的网页主题切换插件》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FaGLep07rnMQdQLyDHBer8Q" target="_blank" title="https://mp.weixin.qq.com/s/aGLep07rnMQdQLyDHBer8Q" ref="nofollow noopener noreferrer">《还在用 WebSocket 做实时通信？SSE 可能更简单》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角]]></title>    <link>https://juejin.cn/post/7571338749198303282</link>    <guid>https://juejin.cn/post/7571338749198303282</guid>    <pubDate>2025-11-12T00:54:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571338749198303282" data-draft-id="7571295102851317786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2025-11-12T00:54:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            淘宝 9 块 9 的 DeepSeek，撕开了魔幻世界的一角
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:54:04.000Z" title="Wed Nov 12 2025 00:54:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>现在的世界是越来越魔幻，早就超出了常人的理解范畴。</p>
<p>我最近老刷淘宝，昨天不知哪来的兴致，没什么特定缘由，纯粹好奇当下的相关生态，便鬼使神差在搜索栏敲了 “DeepSeek”。翻了没两下，一家店的标题瞬间抓住了他的眼球 ——“无需部署、打开即用，全程不卡顿”，售价才 10 块钱，付款人数却已经破了 1000。</p>
<p>盯着页面琢磨了半天，越想越纳闷：不用买家本地部署，还能保证立刻响应，这到底是什么神仙操作？</p>
<p>要知道，DeepSeek 的热度虽已过去半年，但直到现在，偶尔还是能见到这玩意儿的身影，甚至可能让人猛地想起当初被它支配的日子。</p>
<p>于是点进去了，这数据还确实挺好的，DeepSeek的需求还是旺。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a209f806f0154bbfb32cc2d7dd9ba25d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=NDkVqg8rQo16YNI0ERxxdKa7dxk%3D" alt="图片" loading="lazy"/></p>
<p>按捺不住满心的好奇，我干脆直接下了单、付了款。</p>
<h2 data-id="heading-1">收到货后</h2>
<p>可等卖家发来所谓的 “产品”，当场就懵了 —— 那瞬间的冲击感，让差点以为自己不小心闯进了平行宇宙，满脑子都是 “这到底是啥？！”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75f2ae0dc9264087a0122291675f78e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=%2F8SGW97Z2fXHFZZDTt6Goa5g9jk%3D" alt="图片" loading="lazy"/></p>
<p>我第一反应直接懵了：这难道是遇到活菩萨了？居然自己部署了 DeepSeek，还开了公网供大家免费似的用？这算力得有多足啊？</p>
<p>有这资源，哥们儿直接去卖算力不比这 10 块钱一单赚得多？</p>
<p>可等定睛一看，瞬间愣住了 —— 这网址怎么这么眼熟？再仔细瞅了瞅，好家伙，居然是<a href="https://link.juejin.cn?target=https%3A%2F%2Fn.cn%2F" target="_blank" title="https://n.cn/" ref="nofollow noopener noreferrer">n.cn</a>？！</p>
<p>**这不是...360的纳米搜索？？？<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3a77e83579646e5ba19dc849c5b140d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=HfC4lQjs6JD4y7vk1f7AIloJDp4%3D" alt="图片" loading="lazy"/></p>
<p>我点开另一个网址。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88340c9955a44ceca2e324c3e127abdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=r5wsvrq1SIP9YD7QqPsvQwC3Hxo%3D" alt="图片" loading="lazy"/></p>
<p>我一时间无语凝噎，我的大脑宕机了整整10秒钟。我想到了这个事情比较抽象，但是，我没想到能抽象到这种地步。因为，反差感极强，我本来会以为，哥们就卖链接，肯定不少差评，但，事情不太一样了起来。这个评论区，几乎全是好评。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71ec1059d5084f5b85b83a2b5a766179~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=j4nNOmXv0cCHDdZ1720j%2BbM%2Femo%3D" alt="图片" loading="lazy"/></p>
<p>甚至有300个88VIP的好评。我一条一条的看了下去，我感觉，这个世界在我的脑中，好像更魔幻，更立体了。有用户留言说，确实不卡，输出的代码很规范。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133b1ffd54194746ba0cd58f44f05fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=MmMvPL9DXnEpNCY3MM1ARye3wIY%3D" alt="图片" loading="lazy"/></p>
<p>“可以啊，是免费的r1，跟描述一致，性价比很高，不用买会员了也。”
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3c99efd8b8b49968351e3a7fa2096e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763513644&amp;x-signature=TqbzdKi0xiRUWGwq%2FJt7oOqx2NU%3D" alt="图片" loading="lazy"/></p>
<p>**不用买会员了。我不知道你们是什么感受，我突然鼻子一酸。我看到的，忽然是一个个非常活生生、立体形象的人。</p>
<p>或许对于这些Ta们来说：白天在公司，他得忍着老板的 PUA 强撑着干活，连反驳的底气都没有 —— 这份薪资微薄的工作，是他在四五线小城唯一的糊口依靠。</p>
<p>晚上回到十几平米的出租屋，狭小的空间里塞满了不甘。他太想改变命运了，太怕一辈子困在原地，所以总琢磨着学门新本事，抓住点什么。</p>
<p>AI、大模型、席卷时代的技术革命，这些词像针一样扎着他的心。他知道这是翻身的机会，可每一次听说，都伴随着深深的恐慌 —— 怕自己追不上这股浪潮，怕被时代彻底抛弃。</p>
<p>可真要迈出脚步，才发现前路全是望不到头的坎：官网得靠 “魔法上网” 才能访问，他摸不着门道；会员订阅几十上百块一个月，抵得上他好几天的饭钱，根本舍不得花；那些部署教程里的术语，像天书一样晦涩，硬生生把他挡在门外，连入门的缝隙都不给留。</p>
<p>好不容易扒到 DeepSeek 和 ChatGPT 的官网，他咬碎了牙才掏出不便宜的会员费，以为终于摸到了门槛。可实际用起来，却满是失望 —— 不仅卡顿得让人抓狂，历史记录里还莫名冒出不属于自己的内容，钱花得冤枉又憋屈。</p>
<p>一次次尝试，一次次被现实打回原形。他就像个被遗弃在站台外的人，眼睁睁看着时代的列车呼啸而过，自己却连上车的资格都没有。那种求而不得的无力感，沉甸甸压在胸口，让他喘不过气。</p>
<p>直到那天在淘宝刷到那个 9.9 元的商品，<code>“无需部署”“打开即用”“立刻响应” </code>这几个字，像黑夜里的一束光，瞬间照亮了他的渴望。</p>
<p>他反复看了好几遍商品页面，纠结了很久 —— 兜里的钱每一分都要算计，他怕这又是一场骗局，怕最后连这两顿拼好饭的钱都打了水漂。可对改变的渴望，终究压过了所有顾虑。</p>
<p>下单后，他攥着手机等回复，收到可直接点开的链接时，手指都带着点颤抖。怀着忐忑点进去，居然真的能用，还异常流畅。</p>
<p>那一刻，他紧绷的肩膀突然垮了下来，长长舒了一口气，眼眶甚至有点发热。他觉得自己终于花最少的钱，攥住了那张三寸见方的、通往新世界的船票。</p>
<p><strong>满心欢喜地跑到评论区，他认认真真打下 “性价比很高，不用买会员了”，字里行间全是满足。他甚至偷偷窃喜，觉得自己占了天大的便宜，用 9.9 元就撬动了原本遥不可及的生产力工具。</strong></p>
<p>他把这个链接小心翼翼收进浏览器书签，像珍藏一件稀世珍宝。这是他在残酷生活里，拼尽全力才抓住的小小捷径，是支撑他继续往前走的一点希望。</p>
<p>可他不知道，这份被他视若珍宝的 “机会”，本就明晃晃摊在阳光下，对所有人免费开放。他只是恰好站在了信息的阴影里，没见过那片触手可及的光明，只能靠着这点 “微光”，笨拙又执着地追赶着时代的脚步。</p>
<p><strong>AI的发展，永不止步。</strong> <code>愿所有人都能跟上时代的洪流</code>，用自己信息差打出一片新的天地！</p>
<h3 data-id="heading-2">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 3.38 版本发布了，看看有哪些新特性]]></title>    <link>https://juejin.cn/post/7572010680896274472</link>    <guid>https://juejin.cn/post/7572010680896274472</guid>    <pubDate>2025-11-13T10:06:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572010680896274472" data-draft-id="7571815997068001320" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 3.38 版本发布了，看看有哪些新特性"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-13T10:06:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个写不完程序的猿"/> <meta itemprop="url" content="https://juejin.cn/user/4055446188735672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 3.38 版本发布了，看看有哪些新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4055446188735672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个写不完程序的猿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:06:17.000Z" title="Thu Nov 13 2025 10:06:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">介绍</h2>
<p>欢迎回到我们定期发布的季度版本 Flutter 3.38。本次更新旨在通过点简写和 Widget 预览的更新来提升您的开发效率并优化开发者体验。感谢社区的贡献，本次版本共包含来自 145 位贡献者的 825 次提交，其中 37 位是首次贡献者。让我们深入了解一下本次版本更新的内容。</p>
<h2 data-id="heading-1">Dot shorthands</h2>
<p>编写更简洁的 Dart 代码！我们很高兴地宣布 Dart 的一项新特性——<strong>点简写</strong>！简写允许您省略 Dart 可以推断的类型，从而减少样板代码。</p>
<p>例如，你可以使用简写<code>.start</code>来代替<code>MainAxisAlignment.start</code>。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 使用简写</span>
<span class="hljs-selector-tag">Column</span> ( 
  <span class="hljs-attribute">mainAxisAlignment </span>: .start, 
  <span class="hljs-attribute">crossAxisAlignment </span>: .center, 
  <span class="hljs-attribute">children </span>: [ <span class="hljs-comment">/* ... */</span> ], 
), 

<span class="hljs-comment">// 不使用简写</span>
<span class="hljs-selector-tag">Column</span> ( 
  <span class="hljs-attribute">mainAxisAlignment </span>: MainAxisAlignment.start, 
  <span class="hljs-attribute">crossAxisAlignment </span>: CrossAxisAlignment.center, 
  <span class="hljs-attribute">children </span>: [ <span class="hljs-comment">/* … */</span> ], 
),
</code></pre>
<p>这同样适用于命名构造函数！你可以<code>.all</code>这样写<code>EdgeInsets.all</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino">填充（
  填充：.全部（<span class="hljs-number">8.0</span>），
  子元素：文本（<span class="hljs-string">'Hello world'</span>），
），
</code></pre>
<p>Dart 3.10 和 Flutter 3.38 默认启用此功能。更多信息，请查看dart.dev 上的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdart.dev%2Flanguage%2Fdot-shorthands" target="_blank" title="https://dart.dev/language/dot-shorthands" ref="nofollow noopener noreferrer">dot 简写页面。您还可以在</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dart.dev%2Fea8b952b6088" target="_blank" title="https://blog.dart.dev/ea8b952b6088" ref="nofollow noopener noreferrer">Dart 3.10 发布博</a>文中了解更多相关内容（例如 Dart hooks！）。</p>
<h2 data-id="heading-2">web</h2>
<h3 data-id="heading-3">Web 开发配置文件</h3>
<p>该<code>flutter run</code>命令现在支持 Web 设置配置文件。您可以在<code>web_dev_config.yaml</code>项目根目录的文件中指定主机、端口、证书和标头信息。将该文件检入，以便团队中的每个人都能使用相同的设置进行调试。有关更多信息，请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fweb-dev-config-file" target="_blank" title="https://docs.flutter.dev/platform-integration/web/web-dev-config-file" ref="nofollow noopener noreferrer">“设置 Web 开发配置文件”</a>。</p>
<h3 data-id="heading-4">Web 开发代理设置</h3>
<p>除了现有的命令行参数外，Web 开发配置文件还支持新的代理设置。代理设置允许将对已配置路径的请求转发到另一台服务器。这使得开发能够连接到同一主机上动态端点的 Web 客户端变得更加容易。</p>
<p>有关代理设置的详细信息，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fweb-dev-config-file" target="_blank" title="https://docs.flutter.dev/platform-integration/web/web-dev-config-file" ref="nofollow noopener noreferrer">设置 Web 开发配置文件</a>。</p>
<h3 data-id="heading-5">扩展了对网页热重载的支持</h3>
<p>现在，当您在浏览器中打开 Flutter 应用的链接并运行该应用时，状态热重载功能默认启用<code>-d web-server</code>。即使同时连接多个浏览器，此功能也能正常工作。</p>
<p>与之前一样<code>-d chrome</code>，此功能可以使用标志暂时禁用<code>--no-web-experimental-hot-reload</code>。禁用此功能的功能将在未来的版本中移除，因此，如果您在开发流程中遇到问题，请使用 Dart 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdart-lang%2Fsdk%2Fissues%2Fnew%3Ftemplate%3D5_web_hot_reload.yml" target="_blank" title="https://github.com/dart-lang/sdk/issues/new?template=5_web_hot_reload.yml" ref="nofollow noopener noreferrer">Web 热重载问题模板</a>提交错误报告。更多信息，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Fplatform-integration%2Fweb%2Fbuilding%23hot-reload-web" target="_blank" title="https://docs.flutter.dev/platform-integration/web/building#hot-reload-web" ref="nofollow noopener noreferrer">Web 热重载文档</a>。</p>
<h2 data-id="heading-6">框架</h2>
<p>此版本包含框架中的许多强大的新功能和改进，使开发人员能够对高级 UI、导航和平台交互进行更精细的控制。</p>
<p>现在，开发者在使用 <code>Overlay.of</code> 创建弹出窗口、对话框和其他浮动 UI 元素时拥有了更大的控制权<code>OverlayPortal</code>。现在可以<code>Overlay</code>使用 <code>Overlay.of</code> 在组件树的任何上级组件中渲染子组件<code>OverlayPortal.overlayChildLayoutBuilder</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174239" target="_blank" title="https://github.com/flutter/flutter/pull/174239" ref="nofollow noopener noreferrer">#174239</a>），从而更轻松地显示应用范围的通知或其他需要突破父组件布局限制的 UI。底层 <code>Overlay.of</code> 方法也得到了增强，变得更加健壮高效（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174315" target="_blank" title="https://github.com/flutter/flutter/pull/174315" ref="nofollow noopener noreferrer">#174315</a>）。</p>
<p>为了提供更现代化的 Android 导航体验，预测性返回路径过渡效果现已默认启用<code>MaterialApp</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173860" target="_blank" title="https://github.com/flutter/flutter/pull/173860" ref="nofollow noopener noreferrer">#173860</a>）。当用户执行返回手势时，当前路径会以动画形式消失，同时用户会看到主屏幕的预览。此外，默认页面过渡效果也已更新，以<code>FadeForwardsPageTransitionsBuilder</code>反映<code>ZoomPageTransitionsBuilder</code>原生应用的行为。</p>
<p>此次版本更新还深化了桌面集成。在 Windows 系统上，开发者现在可以访问已连接显示器的列表，并查询每个显示器的详细属性，例如分辨率、刷新率和物理尺寸（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F164460" target="_blank" title="https://github.com/flutter/flutter/pull/164460" ref="nofollow noopener noreferrer">#164460</a>）。这使得创建具有复杂窗口管理功能的应用程序成为可能。</p>
<p>最后，框架本身的容错性也得到了提升。组件生命周期回调中发生的错误（例如 <code>get_errors( </code>didUpdateWidget<code>)</code>）现在能够得到更优雅的处理，从而避免在元素树中引发级联故障（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173148" target="_blank" title="https://github.com/flutter/flutter/pull/173148" ref="nofollow noopener noreferrer">#173148</a>）。此外，<code>get_errors()</code> 也正确实现了相等性判断，确保相同的提供程序得到相同的处理，<code>ResizeImage</code>从而使图像缓存和比较更加可预测（ <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172643" target="_blank" title="https://github.com/flutter/flutter/pull/172643" ref="nofollow noopener noreferrer">#172643</a>）。<code>ResizeImage</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172643" target="_blank" title="https://github.com/flutter/flutter/pull/172643" ref="nofollow noopener noreferrer"/></p>
<p>在网页上，UI 的优化仍在继续，修复了<code>RSuperellipse</code>当圆角半径大于小部件本身时出现的渲染错误（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172254" target="_blank" title="https://github.com/flutter/flutter/pull/172254" ref="nofollow noopener noreferrer">#172254</a>），现在，这种情况将被处理，以按预期生成药丸形状。</p>
<p>对于国际用户而言，检测浏览器首选语言环境的功能现在更加强大。引擎现在使用标准<code>Intl.Locale</code>Web API 来解析浏览器语言，取代了之前手动且较为脆弱的实现方式（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172964" target="_blank" title="https://github.com/flutter/flutter/pull/172964" ref="nofollow noopener noreferrer">#172964</a>）。这一改进带来了更可靠的语言环境检测，并为全球用户提供了更佳的体验。</p>
<p>一个特定于 Android 系统的漏洞（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171973" target="_blank" title="https://github.com/flutter/flutter/pull/171973" ref="nofollow noopener noreferrer">#171973</a>）已修复，该漏洞主要影响配备硬件键盘的三星设备。此前，用户与文本框交互后<code>TextField</code>，Android 输入法编辑器 (IME) 可能会卡在“过期”状态。这会导致 IME 错误地拦截“回车”或“空格”键的按下，从而阻止非文本控件（例如文本框<code>Checkbox</code>或<code>Radio</code>按钮）接收到事件。此修​​复程序确保<code>InputMethodManager</code>在文本连接关闭时正确重置 IME，清除其“过期”状态，并恢复用户可预期的硬件键盘交互。</p>
<h3 data-id="heading-7">材料和库比蒂诺更新</h3>
<p>Material 和 Cupertino 库持续发展，专注于 API 的一致性和优化的用户体验。此次版本更新带来了重要的 API 迁移、全新的组件功能以及诸多改进，让构建美观实用的用户界面变得更加轻松。</p>
<p>基于已弃用的旧版本<code>MaterialState</code>，本次版本继续推进内部向更统一的版本的迁移。这提供了一种一致且富有表现力的方式来定义控件在不同交互状态（例如按下、悬停或禁用）下<code>WidgetState</code>的外观，并且无需对现有应用进行任何更改。此次迁移已应用于多种控件及其主题，包括<code>IconButton</code>、、和（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173893" target="_blank" title="https://github.com/flutter/flutter/pull/173893" ref="nofollow noopener noreferrer">#173893</a>）。新的 API 还增强了功能和灵活性；例如，现在包含一个属性（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F169821" target="_blank" title="https://github.com/flutter/flutter/pull/169821" ref="nofollow noopener noreferrer">#169821</a>），允许以编程方式控制其视觉状态，从而为更自定义和交互式的设计打开了大门。<code>ElevatedButton``Checkbox``Switch</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173893" target="_blank" title="https://github.com/flutter/flutter/pull/173893" ref="nofollow noopener noreferrer"/><code>IconButton``statesController</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F169821" target="_blank" title="https://github.com/flutter/flutter/pull/169821" ref="nofollow noopener noreferrer"/></p>
<p>此次版本更新还引入了几个新特性和便捷的 API。<code>Badge.count</code>构造函数现在包含一个<code>maxCount</code>参数（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171054" target="_blank" title="https://github.com/flutter/flutter/pull/171054" ref="nofollow noopener noreferrer">#171054</a>），可以轻松限制显示的数量（例如，显示“99+”而不是“100”）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc36e56f6e7e457eb1916f4886662e16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=AIY9Kg%2BHsadiaQhvm3JyzoOwcyg%3D" alt="" loading="lazy"/></p>
<p>为了实现更精细的手势控制，该<code>InkWell</code>小部件现在具有<code>onLongPressUp</code>回调功能（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173221" target="_blank" title="https://github.com/flutter/flutter/pull/173221" ref="nofollow noopener noreferrer">#173221</a>），可用于触发仅在用户抬起手指时才应完成的操作。</p>
<p>Cupertino 库也在不断努力提升其 iOS 兼容性。<code>CupertinoSlidingSegmentedControl</code>新增了一个<code>isMomentary</code>属性（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F164262" target="_blank" title="https://github.com/flutter/flutter/pull/164262" ref="nofollow noopener noreferrer">#164262</a>），允许控件在不保持选中状态的情况下触发操作。为了更好地匹配原生 iOS 的行为，该控件<code>CupertinoSheet</code>在完全展开状态下向上拖动时，现在会呈现微妙的“拉伸”效果（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F168547" target="_blank" title="https://github.com/flutter/flutter/pull/168547" ref="nofollow noopener noreferrer">#168547</a>）。</p>
<p>最后，本次版本更新包含多项改进，优化了核心组件的行为。亮点包括修复了<code>DropdownMenuFormField</code>表单重置时正确清除文本字段的问题（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174937" target="_blank" title="https://github.com/flutter/flutter/pull/174937" ref="nofollow noopener noreferrer">#174937</a>），以及更新了组件以<code>SegmentedButton</code>改进焦点处理（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173953" target="_blank" title="https://github.com/flutter/flutter/pull/173953" ref="nofollow noopener noreferrer">#173953</a>）并确保其边框能够正确反映组件的状态（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172754" target="_blank" title="https://github.com/flutter/flutter/pull/172754" ref="nofollow noopener noreferrer">#172754</a>）。</p>
<h3 data-id="heading-8">解耦 Material and Cupertino</h3>
<p>我们一直在进行大量的规划工作，旨在将 Material 和 Cupertino 库与框架解耦。以下列表包含了围绕近期发布的一些设计文档展开的讨论。</p>
<p><strong>改进 flutter/packages 的发布流程，解耦后将包含 Material 和 Cupertino。</strong></p>
<ul>
<li>状态：已决定</li>
<li>思路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fu%2F1%2Fd%2F18kjoP-4LAXEllugVOQRg6vZELyD6MuxlKilLD4lFxSY%2Fedit" target="_blank" title="https://docs.google.com/document/u/1/d/18kjoP-4LAXEllugVOQRg6vZELyD6MuxlKilLD4lFxSY/edit" ref="nofollow noopener noreferrer">第一方软件包发布策略</a></li>
<li>决定：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1jUoFaawutbYsCI5oY3pDP_l-xpv6FhDKlcI1-EoT02s%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1jUoFaawutbYsCI5oY3pDP_l-xpv6FhDKlcI1-EoT02s/edit?tab=t.0" ref="nofollow noopener noreferrer">批量发布单页说明（公开共享）</a></li>
</ul>
<p><strong>颜色和点阵速记</strong></p>
<ul>
<li>状态：已决定</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1y38TN9AUTyd0eTbu4kx4FiNgfsLDPvWvi92Fv5HWFjQ%2Fedit%3Ftab%3Dt.0%23heading%3Dh.pub7jnop54q0" target="_blank" title="https://docs.google.com/document/d/1y38TN9AUTyd0eTbu4kx4FiNgfsLDPvWvi92Fv5HWFjQ/edit?tab=t.0#heading=h.pub7jnop54q0" ref="nofollow noopener noreferrer">Flutter 基础配色方案（公开分享）</a></li>
</ul>
<p><strong>解耦测试</strong></p>
<ul>
<li>状态：进行中</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1UHxALQqCbmgjnM1RNV9xE2pK3IGyx-UktGX1D7hYCjs%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1UHxALQqCbmgjnM1RNV9xE2pK3IGyx-UktGX1D7hYCjs/edit?tab=t.0" ref="nofollow noopener noreferrer">解耦框架测试（公开共享）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F177028" target="_blank" title="https://github.com/flutter/flutter/issues/177028" ref="nofollow noopener noreferrer">github.com/flutter/flu…</a></li>
</ul>
<p><strong>文本</strong></p>
<ul>
<li>状态：讨论中</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.google.com%2Fdocument%2Fd%2F1oFezK5leJzTWA5lsw3BQGx7gLbhpSL8dMleU3HD7bNY%2Fedit%3Ftab%3Dt.0" target="_blank" title="https://docs.google.com/document/d/1oFezK5leJzTWA5lsw3BQGx7gLbhpSL8dMleU3HD7bNY/edit?tab=t.0" ref="nofollow noopener noreferrer">Flutter 将设计与文本解耦（公开分享）</a></li>
</ul>
<h3 data-id="heading-9">滚动：更稳健、更可预测的条形滚动</h3>
<p>此版本带来了一系列修复，使得构建复杂的滚动布局（尤其是使用<code>SliverMainAxisGroup</code>和的布局<code>SliverCrossAxisGroup</code>）更加稳健和可预测。</p>
<p>使用这些组件将多个 Sliver 分组的开发者会发现，手势处理现在更加可靠。现在可以正确计算这些组内 Sliver 的点击和其他指针事件的命中测试，确保用户交互按预期运行（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174265" target="_blank" title="https://github.com/flutter/flutter/pull/174265" ref="nofollow noopener noreferrer">#174265</a>）。</p>
<p>其他几项修复也使得滚动行为更加准确<code>SliverMainAxisGroup</code>。使用固定标题时过度滚动的问题已得到解决（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173349" target="_blank" title="https://github.com/flutter/flutter/pull/173349" ref="nofollow noopener noreferrer">#173349</a>），调用<code>showOnScreen</code>显示小片段现在可以正常工作（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171339" target="_blank" title="https://github.com/flutter/flutter/pull/171339" ref="nofollow noopener noreferrer">#171339</a>），并且内部滚动偏移计算更加精确（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174369" target="_blank" title="https://github.com/flutter/flutter/pull/174369" ref="nofollow noopener noreferrer">#174369</a>）。</p>
<p>对于构建自定义滚动视图的开发者来说，新的<code>SliverGrid.list</code>构造函数（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173925" target="_blank" title="https://github.com/flutter/flutter/pull/173925" ref="nofollow noopener noreferrer">#173925</a>）提供了一种更简洁的方式，可以从简单的子列表创建网格。</p>
<p>此次更新还改进了复杂布局中键盘和方向键用户的焦点导航体验。在具有不同滚动轴的嵌套滚动视图（例如水平轮播图的垂直列表）中，方向性焦点导航现在更加可预测，防止焦点在不同部分之间意外跳转（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172875" target="_blank" title="https://github.com/flutter/flutter/pull/172875" ref="nofollow noopener noreferrer">#172875</a>）。</p>
<h3 data-id="heading-10">无障碍设计：为所有用户提供更具包容性的体验</h3>
<p>确保所有用户都能访问应用程序是 Flutter 框架的基石。此次版本更新延续了这一承诺，赋予开发者更多程序控制权，改善了国际用户的体验，并优化了核心组件的可访问性。</p>
<p>对于构建复杂应用程序的开发者而言，此版本引入了在 iOS 上默认启用辅助功能的功能<code>WidgetsFlutterBinding.instance.ensureSemantics</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174163" target="_blank" title="https://github.com/flutter/flutter/pull/174163" ref="nofollow noopener noreferrer">#174163</a><code>debugDumpSemanticsTree</code> ）。此外，由于新增了文本输入验证结果信息，有助于更快地诊断问题（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174677" target="_blank" title="https://github.com/flutter/flutter/pull/174677" ref="nofollow noopener noreferrer">#174677</a> ），因此调试辅助功能问题也变得更加容易。</p>
<p>为了增强基于 Sliver 的滚动视图的辅助功能，我们新增了一个<code>SliverSemantics</code>组件（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F167300" target="_blank" title="https://github.com/flutter/flutter/pull/167300" ref="nofollow noopener noreferrer">#167300</a>）。与现有组件类似，开发者可以在滚动视图中<code>Semantics</code>使用该组件，为 Sliver 树的各个部分添加特定的语义信息。这对于标注标题、分配语义角色以及为屏幕阅读器添加描述性标签尤为有用，从而为用户提供更易于理解和访问的体验。<code>SliverSemantics``CustomScrollView</code></p>
<p>最后，核心组件的辅助功能持续改进。<code>CupertinoExpansionTile</code>现在默认情况下可访问（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174480" target="_blank" title="https://github.com/flutter/flutter/pull/174480" ref="nofollow noopener noreferrer">#174480</a>），并且该<code>AutoComplete</code>组件现在会向用户播报搜索结果的状态（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173480" target="_blank" title="https://github.com/flutter/flutter/pull/173480" ref="nofollow noopener noreferrer">#173480</a>）。其他改进，例如增大触摸目标<code>TimePicker</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F170060" target="_blank" title="https://github.com/flutter/flutter/pull/170060" ref="nofollow noopener noreferrer">#170060</a>），也有助于提供更便捷的开箱即用体验。</p>
<h2 data-id="heading-11">iOS</h2>
<p>我们很高兴地确认，Flutter 完全支持最新的平台版本：iOS 26、Xcode 26 和 macOS 26，这些版本均于 9 月发布。这确保您可以立即在 Apple 最新的操作系统和工具上开始开发和测试您的应用。</p>
<p>您可能已经注意到，Flutter 最新版本为 iOS 开发者带来了显著的体验提升，解决了用户长期以来的一个痛点：在物理设备上运行 Flutter 应用时，Xcode 应用必须自动启动<code>flutter run</code>。我们引入了一种新的部署方式，使用 Xcode 26 命令行工具 <code>npm run </code>devicectl<code>dev</code> 来进行应用的安装、启动和调试。这种方式无需在部署过程中调用 Xcode 应用，大多数情况下完全依赖于命令行 Xcode 构建工具。如果您遇到任何问题，可以使用 <code>npm run dev</code> 禁用此部署方式<code>flutter config --no-enable-lldb-debugging</code>，并请<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2Fnew%2Fchoose" target="_blank" title="https://github.com/flutter/flutter/issues/new/choose" ref="nofollow noopener noreferrer">提交 issue</a>告知我们！</p>
<p>此前，此功能依赖于 Xcode 自动化，但在 Xcode 26 中变得不稳定且容易出错，尤其是在连续运行命令时。如果您现在正在为最新的 Apple 版本进行开发，我们强烈建议您将 Flutter 版本更新到 3.38 或更高版本。</p>
<h3 data-id="heading-12">UIScene 生命周期迁移</h3>
<p>Flutter 3.38 包含了对苹果强制要求的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Ftechnotes%2Ftn3187-migrating-to-the-uikit-scene-based-life-cycle" target="_blank" title="https://developer.apple.com/documentation/technotes/tn3187-migrating-to-the-uikit-scene-based-life-cycle" ref="nofollow noopener noreferrer">UIScene 生命周期</a>的重要支持。这是继苹果在 WWDC25 上宣布“在 iOS 26 之后的版本中，任何使用最新 SDK 构建的 UIKit 应用都必须使用 UIScene 生命周期，否则将无法启动”之后的一项关键且积极的更新。</p>
<p>为确保您的 iOS Flutter 应用程序在未来的 iOS 版本上保持兼容性并成功启动，需要进行迁移。</p>
<p><strong>迁移 Flutter 应用程序</strong></p>
<p>所有现有的 iOS Flutter 应用都必须迁移到新的生命周期。您可以通过两种方式完成此迁移：</p>
<ol>
<li>手动迁移：请按照 Flutter<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-flutter-apps" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-flutter-apps" ref="nofollow noopener noreferrer">网站</a>上提供的手动迁移说明进行操作。</li>
<li>自动迁移（实验性功能）：启用此实验性功能可自动处理迁移。此功能将在未来的版本中默认启用。运行以下命令：</li>
</ol>
<p><code>flutter config --enable-uiscene-migration</code></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fplans%3Fsource%3Dupgrade_membership---post_li_non_moc_upsell--3f7b258f7228---------------------------------------" target="_blank" title="https://medium.com/plans?source=upgrade_membership---post_li_non_moc_upsell--3f7b258f7228---------------------------------------" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83d130648ca14f57b12f161cbe22a35b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=hLwCNkBRffP8UU%2BRs0bp8Vt4SWs%3D" alt="成为会员" loading="lazy"/></a></p>
<p><strong>迁移 Flutter 插件</strong></p>
<p>依赖应用程序生命周期事件的 Flutter 插件必须更新为使用 UIScene 生命周期事件。插件开发者应参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-flutter-plugins" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-flutter-plugins" ref="nofollow noopener noreferrer">迁移指南</a>。未迁移的插件将在未来的版本中显示警告。</p>
<p><strong>迁移嵌入式 Flutter（可选）</strong></p>
<p>对于将 Flutter 嵌入原生宿主应用程序的项目，迁移是可选的，但强烈建议进行。使用“<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes%2Fuiscenedelegate%23migration-guide-for-adding-flutter-to-existing-app-add-to-app" target="_blank" title="https://docs.flutter.dev/release/breaking-changes/uiscenedelegate#migration-guide-for-adding-flutter-to-existing-app-add-to-app" ref="nofollow noopener noreferrer">添加到应用程序迁移指南”</a>采用 Flutter 新的 UIScene API ，可以为您的插件启用场景生命周期事件，从而确保与 Flutter 生态系统的兼容性。</p>
<h2 data-id="heading-13">安卓</h2>
<h3 data-id="heading-14">16KB页面大小兼容性</h3>
<p>升级到 Flutter 3.38 是满足<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fpractices%2Fpage-sizes" target="_blank" title="https://developer.android.com/guide/practices/page-sizes" ref="nofollow noopener noreferrer">Google Play 16 KB 页面大小兼容性要求</a>的必要准备。从<a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid-developers.googleblog.com%2F2025%2F05%2Fprepare-play-apps-for-devices-with-16kb-page-size.html" target="_blank" title="https://android-developers.googleblog.com/2025/05/prepare-play-apps-for-devices-with-16kb-page-size.html" ref="nofollow noopener noreferrer">2025 年 11 月 1 日</a>起，面向 Android 15 及更高版本的应用必须支持 16 KB 页面。此项变更可确保您的应用在高内存设备上正常运行，并带来性能提升，例如启动速度提升高达 30%。Flutter 3.38 将默认的 Android ndkVersion 更新为 NDK r28，这是原生代码实现 16 KB 页面大小支持的最低要求。</p>
<h3 data-id="heading-15">内存修复</h3>
<p>Flutter 3.38<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F173770" target="_blank" title="https://github.com/flutter/flutter/issues/173770" ref="nofollow noopener noreferrer">修复了</a>一个影响所有 Android 平台 Flutter 应用的严重内存泄漏问题。该问题（在 3.29.0 版本中引入）发生在 Activity 在退出时被销毁的情况下，无论是开发者设置中配置的销毁方式，还是由于内存不足而被系统强制终止的 Activity。</p>
<h3 data-id="heading-16">Android 依赖项更新</h3>
<p>为您的应用找到合适的 Android 依赖项版本组合通常是一项挑战，这些依赖项包括 Gradle、Android Gradle 插件 (AGP)、Kotlin Gradle 插件 (KGP)、Java 等。对于 Flutter 3.38 版本，我们在持续集成 (CI) 环境中测试并确认了以下 Android 依赖项版本组合的兼容性：</p>
<ul>
<li><strong>Java 17</strong>：Flutter 3.38 中 Android 开发的最低版本要求。</li>
<li><strong>KGP 2.2.20</strong>：该工具<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fgradle-configure-project.html%23apply-the-plugin" target="_blank" title="https://kotlinlang.org/docs/gradle-configure-project.html#apply-the-plugin" ref="nofollow noopener noreferrer">支持的最高Kotlin Gradle 插件版本。</a></li>
<li><strong>AGP 8.11.1</strong>：最新的 Android Gradle 插件版本，与 KGP 2.2.20<a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fgradle-configure-project.html%23apply-the-plugin" target="_blank" title="https://kotlinlang.org/docs/gradle-configure-project.html#apply-the-plugin" ref="nofollow noopener noreferrer">兼容。</a></li>
<li><strong>Gradle 8.14</strong>：此版本与所选的 Java、KGP 和 AGP 版本兼容。请注意，AGP 8.11.1 的最低版本要求为 Gradle 8.13。</li>
</ul>
<p>为了确保您的应用能够在不同的 Flutter 版本之间无缝运行，我们强烈建议您在构建文件中使用 Flutter SDK 提供的 API 级别变量。此版本配置的值如下：</p>
<ul>
<li><code>flutter.compileSdkVersion</code>（API 36）</li>
<li><code>flutter.targetSdkVersion</code>（API 36）</li>
<li><code>flutter.minSdkVersion</code>（API 24）或更高</li>
</ul>
<h2 data-id="heading-17">引擎</h2>
<h3 data-id="heading-18">性能叠加层</h3>
<p>性能叠加层已重构，效率更高，在 Skia 和 Impeller 后端上的渲​​染时间均有所缩短。这意味着您可以以更少的开销获得更准确的性能数据。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176364" target="_blank" title="https://github.com/flutter/flutter/pull/176364" ref="nofollow noopener noreferrer">#176364</a>）</p>
<h3 data-id="heading-19"><strong>Vulkan 和 OpenGL ES</strong></h3>
<p>对 Vulkan 和 OpenGL ES 后端的诸多修复和改进提高了在更广泛设备上的稳定性和性能。这包括更好地处理管线缓存（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176322" target="_blank" title="https://github.com/flutter/flutter/pull/176322" ref="nofollow noopener noreferrer">#176322</a>）、栅栏等待器（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173085" target="_blank" title="https://github.com/flutter/flutter/pull/173085" ref="nofollow noopener noreferrer">#173085</a>）和图像布局过渡（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173884" target="_blank" title="https://github.com/flutter/flutter/pull/173884" ref="nofollow noopener noreferrer">#173884</a>）。</p>
<h3 data-id="heading-20"><strong>渲染器统一</strong></h3>
<p>CanvasKit 和 Skwasm 渲染器的统一工作仍在继续。本次版本更新包含大量重构，以在两者之间共享更多代码，这将带来更一致的用户体验，并加快未来的开发速度（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F174588" target="_blank" title="https://github.com/flutter/flutter/pull/174588" ref="nofollow noopener noreferrer">#174588</a>）。</p>
<h3 data-id="heading-21">线程合并</h3>
<p>iOS 和 Android 系统中已移除选择退出线程合并的功能。欲了解更多信息，请观看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DmiW7vCmQwnw" target="_blank" title="https://www.youtube.com/watch?v=miW7vCmQwnw" ref="nofollow noopener noreferrer">精彩的线程合并</a>视频。</p>
<h2 data-id="heading-22">开发者工具和集成开发环境</h2>
<h3 data-id="heading-23">实验性小部件预览 — 更新</h3>
<p>Flutter 3.35 引入了 Widget Previews（组件预览），这是一项实验性功能，旨在收集社区的早期反馈。Flutter 3.38 版本对 Widget Previews 进行了重大改进，包括：</p>
<ul>
<li><strong>IDE 集成</strong>：我们的 VSCode 和 IntelliJ/Android Studio 插件均已更新，初步支持 Widget 预览。现在，您可以直接在 IDE 中查看预览，从而获得更流畅的开发体验。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eddd9325a394e5abc299424e8482928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=xfueeJ5rK3Rqbb3w5tpXhWW6rbg%3D" alt="" loading="lazy"/></p>
<p><em>VSCode 中嵌入了小部件预览。</em></p>
<p>在集成开发环境 (IDE) 中使用时，控件预览环境默认配置为根据当前选定的源文件筛选显示的预览：</p>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5523ec1be60e4007882e555de4dfec75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=1Tkpqux%2BBqbL1BzaaGM0GWdk1KA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>小部件预览环境主题和控件改进</strong>：小部件预览环境现在支持浅色和深色模式，以及自定义 IDE 配色方案，以匹配您的开发环境。小部件预览环境中的控件也进行了调整，以减少占用空间，从而为渲染预览腾出更多空间。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81af1c5cbc2144c9b758ba4d9111c12d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=7VtppMMTLvx0%2FW8GyEq23oz9qLQ%3D" alt="" loading="lazy"/></p>
<p><em>为小部件预览环境提供自定义主题支持。</em></p>
<ul>
<li><strong>预览可扩展性</strong>：预览注解类不再标记为 final，现在可以扩展以创建自定义预览注解，从而减少常见预览类型的样板代码。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a887ce18185646bda685fc093e14c702~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=c3rdsqe%2Fe33VUb5Ef%2F8SekvnXNA%3D" alt="" loading="lazy"/></p>
<p><em>自定义注解示例</em><code>BrightnessPreview</code> <em>。</em></p>
<ul>
<li><strong>多预览支持</strong>：新增的<code>MultiPreview</code>基类允许从单个自定义注释创建多个预览变体。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71472db634af4b63af1710fe1ab1d720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=4hpx%2BTpAupZ7lNoEpgI7XLPOehA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>预览组</strong>：类中的新分组参数<code>Preview</code>允许对相关的预览进行分组。</li>
</ul>
<p>按回车键或点击查看完整尺寸的图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db78dfe644d94c439cf4b617d44b6df5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5Liq5YaZ5LiN5a6M56iL5bqP55qE54y_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763634188&amp;x-signature=xHQKUC6laoqz16%2FDUA7xgfy%2FVrM%3D" alt="" loading="lazy"/></p>
<p><em>预览组中多个“亮度”预览的示例。</em></p>
<ul>
<li><strong>放宽了对 @Preview 注解参数的限制</strong>：现在支持将私有常量作为<code>Preview</code>注解的参数。函数参数（例如 wrapper 和 theme）仍然需要具有公开的、静态可访问的名称。</li>
</ul>
<p>小部件预览功能目前仍处于实验阶段，您的反馈对塑造其未来至关重要。API 和用户体验尚不稳定，我们会根据您的反馈不断改进。</p>
<p>根据早期反馈，我们计划进行更多改进以提升组件预览体验，包括：</p>
<ol>
<li><strong>Flutter DevTools Widget Inspector 支持</strong>：Widget Inspector 正在更新，以支持在 widget 预览环境中检查预览效果。我们计划将检查器直接嵌入到 widget 预览器中，使其无论您处于何种开发环境都能轻松访问。</li>
<li><strong>IDE中的多项目支持</strong>：目前，组件预览器仅支持显示单个项目或Pub工作区内的预览。我们正在积极研究如何支持在IDE会话中包含多个Flutter项目的方案（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F173550" target="_blank" title="https://github.com/flutter/flutter/issues/173550" ref="nofollow noopener noreferrer">问题#173550</a>）。</li>
<li><strong>提升启动性能</strong>：我们正在研究提升启动性能的机会，以缩短初始启动时间，包括：</li>
</ol>
<ul>
<li>首次运行后启动预编译的组件预览环境</li>
<li>并行化预览检测逻辑以更好地处理大型项目</li>
</ul>
<p>首先，请查看文档，然后告诉我们您的想法！</p>
<ul>
<li><strong>阅读文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Ftools%2Fwidget-previewer" target="_blank" title="https://docs.flutter.dev/tools/widget-previewer" ref="nofollow noopener noreferrer">Flutter Widget 预览（实验性功能）入门指南</a></li>
<li><strong>提供反馈：在</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2Fnew%2Fchoose" target="_blank" title="https://github.com/flutter/flutter/issues/new/choose" ref="nofollow noopener noreferrer">Flutter GitHub 存储库</a>中提交问题和功能请求。</li>
<li><strong>了解更多</strong>：如需深入了解技术细节，请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fflutter.dev%2Fgo%2Fwidget-previews-architecture" target="_blank" title="https://flutter.dev/go/widget-previews-architecture" ref="nofollow noopener noreferrer">Flutter Widget Previews 架构文档</a>。</li>
</ul>
<p><em><strong>重要提示</strong></em> <em>：已知 Widget Previewer 在执行某些操作后可能会崩溃或停止更新</em><code>flutter pub get</code> <em>。如果遇到此问题，请</em><code>flutter pub get</code><em>在项目中运行相关命令并重启 IDE。</em> <em>详情请参阅</em><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fissues%2F178317" target="_blank" title="https://github.com/flutter/flutter/issues/178317" ref="nofollow noopener noreferrer"> <em>#178317 。</em></a>**</p>
<h3 data-id="heading-24">开发者工具更新</h3>
<p>Flutter 3.38 修复了 2025 年 DevTools 用户调查中用户指出的一些主要痛点，包括：</p>
<p><strong>网络面板改进</strong></p>
<ul>
<li>使用户更容易了解面板何时正在记录网络流量。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9495" target="_blank" title="https://github.com/flutter/devtools/pull/9495" ref="nofollow noopener noreferrer">#9495</a>）</li>
<li>修复了复制粘贴网络请求相关的问题。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9472" target="_blank" title="https://github.com/flutter/devtools/pull/9472" ref="nofollow noopener noreferrer">#9472</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9482" target="_blank" title="https://github.com/flutter/devtools/pull/9482" ref="nofollow noopener noreferrer">#9482</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9485" target="_blank" title="https://github.com/flutter/devtools/pull/9485" ref="nofollow noopener noreferrer">#9485</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter-intellij%2Fpull%2F8588" target="_blank" title="https://github.com/flutter/flutter-intellij/pull/8588" ref="nofollow noopener noreferrer">#8588</a>）</li>
</ul>
<p><strong>Flutter Inspector 修复</strong></p>
<ul>
<li>修复了选择控件时有时会打开底层框架源代码而不是用户源代码的错误。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F176530" target="_blank" title="https://github.com/flutter/flutter/pull/176530" ref="nofollow noopener noreferrer">#176530</a>）</li>
<li>修复了偶尔会导致无法与检查器面板顶部按钮进行交互的错误。（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fdevtools%2Fpull%2F9327" target="_blank" title="https://github.com/flutter/devtools/pull/9327" ref="nofollow noopener noreferrer">#9327</a>）</li>
</ul>
<h2 data-id="heading-25">弃用和重大变更</h2>
<p>作为 Flutter 框架现代化和改进工作的一部分，本次版本更新包含了几个重要的弃用项和重大变更。</p>
<p>关键的构建和工具变更可能会影响自定义构建脚本。Flutter <code>version</code>SDK 根目录下的文件已被移除，取而代之的是位于 [<code>flutter.version.json</code>此处应填写路径] 的新文件<code>bin/cache</code>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172793" target="_blank" title="https://github.com/flutter/flutter/pull/172793" ref="nofollow noopener noreferrer">#172793</a>）。此外，该<code>AssetManifest.json</code>文件不再默认生成（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F172594" target="_blank" title="https://github.com/flutter/flutter/pull/172594" ref="nofollow noopener noreferrer">#172594</a>）。</p>
<p>其他显著变化包括：</p>
<ul>
<li>为了使行为更可预测，包含操作的 SnackBar 将不再自动关闭（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F173084" target="_blank" title="https://github.com/flutter/flutter/pull/173084" ref="nofollow noopener noreferrer">#173084</a>）。</li>
<li>构造函数<code>OverlayPortal.targetsRootOverlay</code>已被弃用，取而代之的是更灵活的<code>OverlayPortal</code>（<code>overlayLocation: OverlayChildLocation.rootOverlay</code>）。</li>
<li>的几个属性<code>CupertinoDynamicColor</code>，例如<code>withAlpha</code>和<code>withOpacity</code>，现在已被弃用，取而代之的是标准<code>Color</code>方法（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fflutter%2Fflutter%2Fpull%2F171160" target="_blank" title="https://github.com/flutter/flutter/pull/171160" ref="nofollow noopener noreferrer">#171160</a>）。</li>
<li>Flutter 3.38 要求 Android 的最低 Java 版本为 17，与<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gradle.org%2Fcurrent%2Fuserguide%2Fcompatibility.html" target="_blank" title="https://docs.gradle.org/current/userguide/compatibility.html" ref="nofollow noopener noreferrer">Gradle 8.14</a>（2025 年 7 月发布）的最低要求一致。</li>
</ul>
<p>有关这些变更和其他变更的更多详细信息和迁移指南，请查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fbreaking-changes" target="_blank" title="https://docs.flutter.dev/release/breaking-changes" ref="nofollow noopener noreferrer">重大变更页面</a>。</p>
<h2 data-id="heading-26">结尾</h2>
<p>Flutter 3.38 改动还是挺多的， 要升级的还得等等看看，避免在生产环境使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ajax 数据请求详解与实战]]></title>    <link>https://juejin.cn/post/7572021695293980722</link>    <guid>https://juejin.cn/post/7572021695293980722</guid>    <pubDate>2025-11-13T10:10:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572021695293980722" data-draft-id="7572016447804555290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ajax 数据请求详解与实战"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-13T10:10:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="T___T"/> <meta itemprop="url" content="https://juejin.cn/user/1599155645973066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ajax 数据请求详解与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1599155645973066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    T___T
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:10:29.000Z" title="Thu Nov 13 2025 10:10:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，<strong>网页与服务器的数据交互</strong>已经成为核心功能之一。<br/>
而支撑这一功能的技术之一，正是 <strong>Ajax（Asynchronous JavaScript and XML）</strong> 。<br/>
今天我们就来系统了解一下 Ajax 的工作原理、请求流程以及一个完整的示例。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 Ajax？</h2>
<p><strong>Ajax</strong> 全称是 <strong>异步 JavaScript 和 XML</strong>，<br/>
中文意思是“异步的 JavaScript 与 XML”。</p>
<p>虽然名字里有 XML，但如今开发中我们更多使用 <strong>JSON</strong> 格式来传输数据。<br/>
它最大的特点是：<strong>在不刷新页面的情况下与服务器通信，动态更新网页内容。</strong></p>
<hr/>
<h2 data-id="heading-1">二、Ajax 的基本工作流程</h2>
<p>Ajax 的实现依赖浏览器内置的一个对象：<code>XMLHttpRequest</code>（简称 XHR）。<br/>
通过这个对象，我们可以主动发起 HTTP 请求并接收响应。</p>
<p>流程如下：</p>
<ol>
<li>
<p><strong>创建请求对象</strong></p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">xhr</span> = new XMLHttpRequest()<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>配置请求信息</strong></p>
<pre><code class="hljs language-python" lang="python">xhr.<span class="hljs-built_in">open</span>(method, url, <span class="hljs-keyword">async</span>);
</code></pre>
<ul>
<li><code>method</code>：请求方式（如 <code>GET</code>、<code>POST</code>）</li>
<li><code>url</code>：目标接口地址</li>
<li><code>async</code>：是否异步（<code>true</code> 为异步，<code>false</code> 为同步）</li>
</ul>
</li>
<li>
<p><strong>发送请求</strong></p>
<pre><code class="hljs language-ini" lang="ini">xhr.send()<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>监听请求状态变化</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">xhr.onreadystatechange</span> = function() {
    if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) {
        const <span class="hljs-attr">data</span> = JSON.parse(xhr.responseText)<span class="hljs-comment">;</span>
        console.log(data)<span class="hljs-comment">;</span>
    }
}<span class="hljs-comment">;</span>
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">三、readyState 状态说明</h2>
<p>在 Ajax 请求过程中，<code>readyState</code> 表示请求的不同阶段：</p>



































<table><thead><tr><th>状态码</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>0</td><td>初始化</td><td>请求未初始化</td></tr><tr><td>1</td><td>打开</td><td>已调用 <code>open()</code>，还未发送</td></tr><tr><td>2</td><td>发送</td><td>已发送请求，接收到响应头</td></tr><tr><td>3</td><td>接收</td><td>正在接收服务器数据</td></tr><tr><td>4</td><td>完成</td><td>请求完成，已接收到全部响应数据</td></tr></tbody></table>
<p>同时要注意：</p>
<ul>
<li><code>xhr.status</code> 表示 HTTP 响应状态（例如 <code>200</code> 表示成功）。</li>
<li><code>xhr.responseText</code> 是服务器返回的字符串数据。</li>
</ul>
<hr/>
<h2 data-id="heading-3">四、实战示例：请求 GitHub 数据</h2>
<p>下面是一个完整的 Ajax 请求示例，用来获取 GitHub 上某组织的成员数据：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Ajax 数据请求<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"members"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 1. 创建 XMLHttpRequest 对象</span>
        <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

        <span class="hljs-comment">// 2. 打开请求 (异步)</span>
        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'https://api.github.com/orgs/lemoncode/members'</span>, <span class="hljs-literal">true</span>);

        <span class="hljs-comment">// 3. 监听状态变化</span>
        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
                <span class="hljs-comment">// 4. 解析 JSON 数据</span>
                <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

                <span class="hljs-comment">// 5. 渲染到页面</span>
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'members'</span>).<span class="hljs-property">innerHTML</span> =
                    data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-string">`&lt;li&gt;<span class="hljs-subst">${item.login}</span>&lt;/li&gt;`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">''</span>);
            }
        };

        <span class="hljs-comment">// 6. 发送请求</span>
        xhr.<span class="hljs-title function_">send</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>执行后，浏览器会在控制台打印出返回的数据，同时在网页中显示成员列表。</p>
<hr/>
<h2 data-id="heading-4">五、同步与异步的区别</h2>
<ul>
<li><strong>同步请求（async = false）</strong> ：<br/>
浏览器会等待服务器响应后再执行后续代码，页面会“卡住”。</li>
<li><strong>异步请求（async = true）</strong> ：<br/>
浏览器不会等待，能继续执行后续代码，响应回来后再触发回调函数。<br/>
—— 这正是 Ajax 的核心优势所在。</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、现代替代方案：Fetch 与 Axios</h2>
<p>如今，在实际开发中，我们更常用以下方式：</p>
<ul>
<li><strong>Fetch API</strong>：更简洁现代的异步请求方式。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">fetch('https://api.github.com/orgs/lemoncode/members')
  .then(<span class="hljs-attr">res</span> =&gt; res.json())
  .then(<span class="hljs-attr">data</span> =&gt; console.log(data))
  .catch(<span class="hljs-attr">err</span> =&gt; console.error(err))<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">🧩 七、小结</h2>





























<table><thead><tr><th>要点</th><th>内容</th></tr></thead><tbody><tr><td>Ajax 全称</td><td>异步 JavaScript 和 XML</td></tr><tr><td>核心对象</td><td>XMLHttpRequest</td></tr><tr><td>关键方法</td><td><code>open()</code>、<code>send()</code>、<code>onreadystatechange</code></td></tr><tr><td>常用属性</td><td><code>readyState</code>、<code>status</code>、<code>responseText</code></td></tr><tr><td>主要用途</td><td>实现网页的动态数据加载，不刷新页面即可更新内容</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">✅ 结语</h3>
<p>Ajax 是前端与服务器通信的基础技术之一。<br/>
理解其底层原理不仅能帮助你更好地使用 <code>fetch</code>，<br/>
更能让你彻底理解<strong>浏览器异步通信机制</strong>的本质。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最新MCP规范解读，看这篇就够了！]]></title>    <link>https://juejin.cn/post/7571456639477006346</link>    <guid>https://juejin.cn/post/7571456639477006346</guid>    <pubDate>2025-11-12T07:59:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571456639477006346" data-draft-id="7571416207972499506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最新MCP规范解读，看这篇就够了！"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-12T07:59:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最新MCP规范解读，看这篇就够了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:59:53.000Z" title="Wed Nov 12 2025 07:59:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP是什么? 为什么需要它?</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67c9ad979a2434989229286027f7185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539193&amp;x-signature=AvWJDuUolC0sslAql0%2FE8bjN4jg%3D" alt="" loading="lazy"/><br/>
想象一下，你正在开发一个 AI 编程助手，它需要:</p>
<ul>
<li>读取和修改项目文件</li>
<li>查询数据库Schema</li>
<li>搜索代码仓库</li>
<li>执行Git操作</li>
</ul>
<p>传统做法是为每个数据源写一套专用代码，不同团队重复造轮子。<strong>Model Context Protocol(MCP)</strong> 就是为了解决这个问题而生的开放标准协议。</p>
<p><strong>通俗理解</strong>: MCP就像是「AI应用的USB接口标准」。就像USB让不同设备都能接入电脑一样，MCP让不同的数据源和工具都能以统一方式接入AI应用。</p>
<p><strong>实际案例</strong>: 在Claude Desktop中，你可以配置多个官方MCP服务器:</p>
<ul>
<li><strong>Filesystem服务器</strong>: 安全地读写本地文件，有权限控制</li>
<li><strong>SQLite服务器</strong>: 查询和分析SQLite数据库，自动生成SQL</li>
<li><strong>GitHub服务器</strong>: 搜索仓库、创建Issue、管理PR</li>
</ul>
<p>你的AI应用只需实现一个MCP客户端，就能连接所有服务器，无需为每个服务器写专用代码。</p>
<h2 data-id="heading-1">二、架构设计： 三个角色的分工</h2>
<p>MCP采用<strong>宿主-客户端-服务器</strong>三层架构，就像一家公司的组织结构:</p>
<p><strong>宿主(Host)</strong> = 总经理</p>
<ul>
<li>管理所有客户端</li>
<li>控制安全策略和权限</li>
<li>负责AI模型的调用</li>
</ul>
<p><strong>客户端(Client)</strong> = 部门经理</p>
<ul>
<li>客户端负责连接服务器</li>
<li>负责双方的沟通协调</li>
<li>转发消息和通知</li>
</ul>
<p><strong>服务器(Server)</strong> = 业务专员</p>
<ul>
<li>提供具体功能(资源、工具、提示模板)</li>
<li>可以是本地程序或远程服务</li>
<li>不知道其他服务器的存在</li>
</ul>
<h2 data-id="heading-2">三、协议约定：统一规范与个性化扩展</h2>
<p><strong>每个MCP服务器提供的工具、资源都不一样，但它们都遵循相同的MCP协议规范。</strong></p>
<h3 data-id="heading-3">3.1 协议的分层设计</h3>
<p>MCP采用 <strong>基础协议 + 功能扩展</strong> 的设计，就像HTTP协议一样:</p>
<p><strong>核心层(所有实现必须支持)</strong> :</p>
<ul>
<li>JSON-RPC 2.0消息格式</li>
<li>初始化握手流程(initialize/initialized)</li>
<li>基本错误处理</li>
</ul>
<p><strong>功能层(按需选择)</strong> :</p>
<ul>
<li>Resources、Prompts、Tools(服务器端)</li>
<li>Roots、Sampling、Elicitation(客户端)</li>
</ul>
<p><strong>这样设计的好处</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">统一的基础协议 → 保证互操作性
<span class="hljs-bullet">     +</span>
灵活的功能选择 → 满足不同场景需求
<span class="hljs-code">     ↓
既标准化又可扩展
</span></code></pre>
<h3 data-id="heading-4">3.2 协议约定的过程</h3>
<p><strong>步骤1: 基础协议是固定的</strong><br/>
所有MCP服务器和客户端都遵循相同的JSON-RPC 2.0格式:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 请求格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 必须是2.0</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 唯一标识</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"方法名"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 要调用的方法</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 参数对象</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 响应格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 对应请求的ID</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 成功结果</span>
  <span class="hljs-comment">// 或 "error": {...}    // 错误信息</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 能力在初始化时协商</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端发起初始化</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 我支持LLM采样</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>           <span class="hljs-comment">// 我支持根目录</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyClient"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 我提供工具</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>       <span class="hljs-comment">// 我提供资源</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLiteServer"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>协商完成后，双方都知道对方支持什么功能，<strong>只使用交集部分</strong>。</p>
<p><strong>步骤3: 方法名称是标准化的</strong><br/>
MCP规范定义了标准方法名:</p>








































<table><thead><tr><th>功能</th><th>方法名</th><th>说明</th></tr></thead><tbody><tr><td>列出资源</td><td><code>resources/list</code></td><td>固定方法名</td></tr><tr><td>读取资源</td><td><code>resources/read</code></td><td>固定方法名</td></tr><tr><td>列出工具</td><td><code>tools/list</code></td><td>固定方法名</td></tr><tr><td>调用工具</td><td><code>tools/call</code></td><td>固定方法名</td></tr><tr><td>列出提示</td><td><code>prompts/list</code></td><td>固定方法名</td></tr><tr><td>获取提示</td><td><code>prompts/get</code></td><td>固定方法名</td></tr></tbody></table>
<p><strong>步骤4: 具体内容是个性化的</strong><br/>
虽然方法名固定，但每个服务器返回的<strong>具体数据</strong>不同:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// SQLite服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行SQL查询"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list_tables"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"列出所有表"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// Filesystem服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"读取文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"write_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"写入文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search_files"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"搜索文件"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">3.3 协议发现机制</h3>
<p>客户端如何知道服务器有哪些工具?</p>
<p><strong>第一步：列举</strong></p>
<pre><code class="hljs language-css" lang="css">客户端 → 服务器: {"method": <span class="hljs-string">"tools/list"</span>}
服务器 → 客户端: {
  "tools": [
    {
      "name": <span class="hljs-string">"query"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
      <span class="hljs-string">"inputSchema"</span>: {           // JSON Schema定义输入格式
        "type": <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
          "sql": {"type": <span class="hljs-string">"string"</span>}
        }
      }
    }
  ]
}
</code></pre>
<p><strong>第二步：调用</strong></p>
<pre><code class="hljs language-json" lang="json">客户端 → 服务器<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 使用第一步获得的工具名</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"sql"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SELECT * FROM users"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键点</strong>:通过JSON Schema，客户端知道如何正确调用工具，无需硬编码。</p>
<h2 data-id="heading-6">四、协议基础：如何通信?</h2>
<p>MCP基于JSON-RPC 2.0构建，这是一个成熟的远程过程调用协议。理解这一层对掌握MCP至关重要。</p>
<h3 data-id="heading-7">4.1 JSON-RPC 2.0基础</h3>
<p><strong>消息类型</strong></p>
<p>MCP中有三种基本消息类型。<br/>
<strong>1. 请求(Request)</strong> - 期待响应</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,           <span class="hljs-regexp">//</span> 协议版本,必须是<span class="hljs-string">"2.0"</span>
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,                     <span class="hljs-regexp">//</span> 请求唯一标识(字符串或数字)
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>,     <span class="hljs-regexp">//</span> 要调用的方法名
  <span class="hljs-string">"params"</span>: {                  <span class="hljs-regexp">//</span> 可选的参数对象
    <span class="hljs-string">"cursor"</span>: <span class="hljs-string">"page2"</span>
  }
}
</code></pre>
<p><strong>2. 响应(Response)</strong> - 对请求的回复</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 成功响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                     <span class="hljs-comment">// 必须与请求的id相同</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 成功结果</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行查询"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 错误响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 错误对象</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-32602</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// 错误码(整数)</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"参数无效"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 错误描述</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 可选的额外信息</span>
      <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cursor"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"格式错误"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 通知(Notification)</strong> - 单向消息,无需响应</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/resources/updated"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 通知方法名</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                                   <span class="hljs-comment">// 通知参数</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/data.json"</span>
  <span class="hljs-punctuation">}</span>
  <span class="hljs-comment">// 注意:没有id字段</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>标准错误码</strong></p>
<p>MCP使用JSON-RPC 2.0的标准错误码:</p>








































<table><thead><tr><th>错误码</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>-32700</td><td>Parse error</td><td>JSON解析错误</td></tr><tr><td>-32600</td><td>Invalid Request</td><td>无效的请求格式</td></tr><tr><td>-32601</td><td>Method not found</td><td>方法不存在</td></tr><tr><td>-32602</td><td>Invalid params</td><td>参数无效</td></tr><tr><td>-32603</td><td>Internal error</td><td>服务器内部错误</td></tr><tr><td>-32002</td><td>Resource not found</td><td>资源未找到(MCP扩展)</td></tr></tbody></table>
<h3 data-id="heading-8">4.2 能力协商详解</h3>
<p>能力协商是MCP连接建立的第一步，决定了整个会话中可用的功能。</p>
<p><strong>初始化流程详解</strong></p>
<p><strong>阶段1: 客户端发起初始化</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 客户端支持的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 客户端能力声明</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持根目录</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持根目录变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 支持LLM采样</span>
      <span class="hljs-attr">"elicitation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 支持用户询问</span>
      <span class="hljs-attr">"experimental"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                <span class="hljs-comment">// 实验性功能</span>
        <span class="hljs-attr">"customFeature"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>            <span class="hljs-comment">// 自定义功能</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 客户端信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyAIApp"</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 程序名(必填)</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// 版本号(必填)</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的AI应用"</span>             <span class="hljs-comment">// 显示名称(可选)</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段2: 服务器响应能力</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 服务器选择的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 服务器能力声明</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 支持资源</span>
        <span class="hljs-attr">"subscribe"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 支持资源订阅</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持资源列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持工具</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                     <span class="hljs-comment">// 支持提示模板</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>           <span class="hljs-comment">// 不支持列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"logging"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>                    <span class="hljs-comment">// 支持日志输出</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 服务器信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite-mcp-server"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.1.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLite MCP服务器"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"instructions"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"此服务器提供SQLite数据库访问能力"</span>  <span class="hljs-comment">// 可选的使用说明</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段3: 客户端确认就绪</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/initialized"</span>  <span class="hljs-comment">// 无id,这是通知</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>协议版本协商规则</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">客户端请求版本: <span class="hljs-string">"2024-11-05"</span>
         ↓
    服务器支持?
    ↙        ↘
  支持        不支持
   ↓            ↓
返回相同版本  返回服务器支持的最新版本
   ↓            ↓
协商成功    客户端检查是否支持
              ↙        ↘
           支持        不支持
            ↓            ↓
         协商成功     断开连接
</code></pre>
<p><strong>实际示例</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 场景1: 版本匹配</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  ✅ 成功

<span class="hljs-comment">// 场景2: 服务器版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-06-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果不支持则断开

<span class="hljs-comment">// 场景3: 客户端版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-01-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果支持则降级使用
</code></pre>
<p><strong>能力交集计算</strong></p>
<p>初始化后,双方只能使用<strong>共同支持的能力</strong>:</p>
<pre><code class="hljs language-css" lang="css">客户端能力: {roots, sampling, elicitation}
服务器能力: {resources, tools, prompts}
         ↓
   可用功能集合
   ├─ 客户端 → 服务器: resources, tools, prompts
   └─ 服务器 → 客户端: roots, sampling, elicitation
</code></pre>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 客户端代码示例</span>
<span class="hljs-keyword">if</span> server_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"tools"</span>):
    <span class="hljs-meta"># 服务器支持工具,可以调用</span>
    tools = <span class="hljs-keyword">await</span> session.list_tools()
<span class="hljs-keyword">else</span>:
    <span class="hljs-meta"># 服务器不支持工具,跳过</span>
    print(<span class="hljs-string">"服务器不提供工具功能"</span>)

<span class="hljs-keyword">if</span> client_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"sampling"</span>):
    <span class="hljs-meta"># 客户端支持采样,服务器可以请求</span>
    <span class="hljs-meta"># (服务器端会检查这个能力)</span>
    pass
</code></pre>
<h3 data-id="heading-9">4.3 连接生命周期深入</h3>
<p><strong>完整的消息时序图</strong></p>
<pre><code class="hljs language-scss" lang="scss">客户端                                            服务器
  │                                              │
  │  <span class="hljs-number">1</span>. initialize (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">2</span>. initialize (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">3</span>. initialized (通知)                        │ 
  ├──────────────────────────────────────&gt;│
  │                                              │
  │═══════════ 正常操作阶段 ════════════        │
  │                                              │
  │  <span class="hljs-number">4</span>. tools/list (请求)                         │
  ├──────────────────────────────────────&gt;│
  │                                              │
  │  <span class="hljs-number">5</span>. tools/list (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {tools: [...]}                           │
  │                                              │
  │  <span class="hljs-number">6</span>. tools/call (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {name: <span class="hljs-string">"query"</span>, arguments: {...}}        │
  │                                              │
  │  <span class="hljs-number">7</span>. notifications/progress (通知)             │
  │&lt;──────────────────────────────────────┤
  │     {progress: <span class="hljs-number">50</span>, total: <span class="hljs-number">100</span>}               │
  │                                              │
  │  <span class="hljs-number">8</span>. tools/call (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {<span class="hljs-attribute">content</span>: [...]}                         │
  │                                              │
  │  <span class="hljs-number">9</span>. notifications/resources/updated          │
  │&lt;──────────────────────────────────────┤
  │     {uri: <span class="hljs-string">"file://..."</span>}                      │
  │                                              │
  │═══════════ 关闭阶段 ═══════════           │
  │                                              │
  │  <span class="hljs-number">10</span>. 关闭stdin                               │
  ├─────────────X                             │
  │                                             │
  │                                          服务器退出
</code></pre>
<p><strong>初始化前的限制</strong></p>
<p>在<code>initialized</code>通知发送前:</p>
<p><strong>客户端只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>请求</li>
<li>✅ <code>ping</code>请求(用于保活)</li>
<li>❌ 其他任何请求</li>
</ul>
<p><strong>服务器只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>响应</li>
<li>✅ <code>ping</code>请求</li>
<li>✅ <code>logging</code>通知(日志)</li>
<li>❌ 其他任何消息</li>
</ul>
<p><strong>违反限制的后果</strong>:</p>
<pre><code class="hljs language-css" lang="css">// 客户端在初始化前调用tools/list
请求: {"method": <span class="hljs-string">"tools/list"</span>}
响应: {
  "error": {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32600</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"会话未初始化"</span>
  }
}
</code></pre>
<p><strong>超时和重试机制</strong></p>
<p><strong>请求超时</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-comment"># 设置30秒超时</span>
<span class="hljs-keyword">try</span>:
    result = <span class="hljs-keyword">await</span> asyncio.wait_for(
        session.call_tool(<span class="hljs-string">"slow_operation"</span>, {}),
        timeout=<span class="hljs-number">30.0</span>
    )
<span class="hljs-keyword">except</span> asyncio.TimeoutError:
    <span class="hljs-comment"># 发送取消通知</span>
    <span class="hljs-keyword">await</span> session.send_notification(
        <span class="hljs-string">"notifications/cancelled"</span>,
        {<span class="hljs-string">"requestId"</span>: <span class="hljs-string">"123"</span>, <span class="hljs-string">"reason"</span>: <span class="hljs-string">"超时"</span>}
    )
</code></pre>
<p><strong>进度通知重置超时</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 当收到进度通知时,可以重置超时计时器</span>
<span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>  <span class="hljs-comment"># 基础超时</span>
<span class="hljs-attr">max_timeout</span> = <span class="hljs-number">300</span>  <span class="hljs-comment"># 最大超时(5分钟)</span>

while True:
    try:
        <span class="hljs-attr">msg</span> = await wait_for_message(timeout)
        if <span class="hljs-attr">msg.method</span> == <span class="hljs-string">"notifications/progress"</span>:
            <span class="hljs-comment"># 收到进度,重置超时</span>
            <span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>
    except TimeoutError:
        <span class="hljs-comment"># 超时处理</span>
        break
</code></pre>
<h3 data-id="heading-10">4.4 传输方式对比</h3>
<p><strong>stdio传输详解</strong></p>
<p><strong>优点</strong>:</p>
<ul>
<li>✅ 简单直接,适合本地开发</li>
<li>✅ 进程隔离,安全性好</li>
<li>✅ 自动管理生命周期</li>
<li>✅ 无需网络配置</li>
</ul>
<p><strong>缺点</strong>:</p>
<ul>
<li>❌ 只能本地使用</li>
<li>❌ 不支持多客户端</li>
<li>❌ 调试相对困难</li>
</ul>
<p><strong>消息格式</strong>:</p>
<pre><code class="hljs">消息1\n
消息2\n
消息3\n
</code></pre>
<p>每个JSON对象占一行,以<code>\n</code>分隔。</p>
<p><strong>HTTP传输详解</strong></p>
<p><strong>架构</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────┐         HTTP POST         ┌─────────┐
│         ├──────────────────────────&gt;│         │
│ 客户端  │  请求/通知/响应(JSON-RPC) │ 服务器  │
│         │&lt;──────────────────────────┤         │
└─────────┘     HTTP 响应/SSE流       └─────────┘
             (application/json 或
              text/event-stream)
</code></pre>
<p><strong>发送消息(POST)</strong> :</p>
<pre><code class="hljs language-bash" lang="bash">POST /mcp HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Accept: application/json, text/event-stream
Mcp-Session-Id: abc123

{<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:1,<span class="hljs-string">"method"</span>:<span class="hljs-string">"tools/list"</span>}
</code></pre>
<p><strong>立即响应(JSON)</strong> :</p>
<pre><code class="hljs language-css" lang="css">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
<span class="hljs-attribute">Content</span>-Type: application/json

{"jsonrpc":<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{"tools":[...]}}
</code></pre>
<p><strong>流式响应(SSE)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
Content-Type: <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123

<span class="hljs-symbol">id:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">25</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">2</span>  
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">50</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">3</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{<span class="hljs-string">"content"</span>:[...]}}
</code></pre>
<p><strong>接收服务器消息(GET)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">GET</span> /mcp HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-symbol">Host:</span> localhost:<span class="hljs-number">8080</span>
<span class="hljs-symbol">Accept:</span> <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123
Last-<span class="hljs-keyword">Event</span>-ID: <span class="hljs-number">42</span>
</code></pre>
<p><strong>会话管理</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端设置会话ID</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/mcp"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_mcp</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">"initialize"</span>:
        session_id = generate_session_id()
        <span class="hljs-keyword">return</span> Response(
            content=json.dumps(result),
            headers={<span class="hljs-string">"Mcp-Session-Id"</span>: session_id}
        )

<span class="hljs-comment"># 客户端后续请求携带会话ID</span>
<span class="hljs-meta">@client.request</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">method, params</span>):
    headers = {}
    <span class="hljs-keyword">if</span> self.session_id:
        headers[<span class="hljs-string">"Mcp-Session-Id"</span>] = self.session_id
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> http.post(
        <span class="hljs-string">"/mcp"</span>,
        json={<span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>, <span class="hljs-string">"method"</span>: method, <span class="hljs-string">"params"</span>: params},
        headers=headers
    )
</code></pre>
<p><strong>断线重连</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_sse</span>(<span class="hljs-params">last_event_id=<span class="hljs-literal">None</span></span>):
    headers = {<span class="hljs-string">"Accept"</span>: <span class="hljs-string">"text/event-stream"</span>}
    <span class="hljs-keyword">if</span> last_event_id:
        headers[<span class="hljs-string">"Last-Event-ID"</span>] = last_event_id
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.stream(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"/mcp"</span>, headers=headers) <span class="hljs-keyword">as</span> stream:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> stream.aiter_lines():
            <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">"id:"</span>):
                last_event_id = line[<span class="hljs-number">3</span>:].strip()
            <span class="hljs-keyword">elif</span> line.startswith(<span class="hljs-string">"data:"</span>):
                data = json.loads(line[<span class="hljs-number">5</span>:])
                <span class="hljs-keyword">yield</span> data, last_event_id
</code></pre>
<h3 data-id="heading-11">4.5 实际通信示例</h3>
<p>让我们看一个完整的SQLite查询场景:</p>
<pre><code class="hljs language-css" lang="css">// <span class="hljs-number">1</span>. 列出工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>
}

服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"result"</span>: {
    "tools": [
      {
        "name": <span class="hljs-string">"query"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
        <span class="hljs-string">"inputSchema"</span>: {
          "type": <span class="hljs-string">"object"</span>,
          <span class="hljs-string">"properties"</span>: {
            "sql": {"type": <span class="hljs-string">"string"</span>}
          },
          "required": [<span class="hljs-string">"sql"</span>]
        }
      }
    ]
  }
}

// <span class="hljs-number">2</span>. 调用查询工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/call"</span>,
  <span class="hljs-string">"params"</span>: {
    "name": <span class="hljs-string">"query"</span>,
    <span class="hljs-string">"arguments"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>
    },
    "_meta": {
      "progressToken": <span class="hljs-string">"query-123"</span>  // 请求进度通知
    }
  }
}

// <span class="hljs-number">3</span>. 服务器发送进度(异步通知)
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"notifications/progress"</span>,
  <span class="hljs-string">"params"</span>: {
    "progressToken": <span class="hljs-string">"query-123"</span>,
    <span class="hljs-string">"progress"</span>: <span class="hljs-number">50</span>,
    <span class="hljs-string">"total"</span>: <span class="hljs-number">100</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"正在扫描users表..."</span>
  }
}

// <span class="hljs-number">4</span>. 返回查询结果
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    "<span class="hljs-attribute">content</span>": [
      {
        "type": <span class="hljs-string">"text"</span>,
        <span class="hljs-string">"text"</span>: <span class="hljs-string">"查询结果: 1,234个活跃用户"</span>
      }
    ],
    "isError": false
  }
}

// <span class="hljs-number">5</span>. 如果查询出错
服务器 → 客户端(错误情况):
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"error"</span>: {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32603</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"SQL语法错误"</span>,
    <span class="hljs-string">"data"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>,
      <span class="hljs-string">"error"</span>: <span class="hljs-string">"near "</span>WHERE<span class="hljs-string">": syntax error"</span>,
      <span class="hljs-string">"position"</span>: <span class="hljs-number">35</span>
    }
  }
}
</code></pre>
<p>这就是MCP通信的完整过程!通过JSON-RPC 2.0，客户端和服务器可以进行结构化、类型安全的通信。</p>
<h2 data-id="heading-12">五、服务器能力：三种核心功能</h2>
<p>MCP服务器可以提供三种功能。</p>
<h3 data-id="heading-13">5.1 Resources(资源)：应用决定用什么</h3>
<p><strong>资源就是数据</strong>，比如文件内容、数据库记录、API响应。</p>
<p><strong>谁控制</strong>: 应用程序决定把哪些资源提供给AI</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出所有可用资源</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 读取某个资源</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/read"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/main.py"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>资源URI示例</strong>:</p>
<ul>
<li><code>file:///project/src/main.py</code> - 文件</li>
<li><code>db://schema/users</code> - 数据库表结构</li>
<li><code>git://commits/main</code> - Git提交历史</li>
<li><code>https://api.example.com/data</code> - Web API</li>
</ul>
<p><strong>订阅变更</strong>: 可以订阅资源,当它变化时自动收到通知。</p>
<p><strong>实际案例</strong>: Filesystem服务器暴露资源</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///Users/alice/project/src/main.py"</span>,  <span class="hljs-comment">// Python源文件</span>
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"main.py"</span>,                                  <span class="hljs-comment">// 文件名</span>
  <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,                        <span class="hljs-comment">// 文件类型</span>
  <span class="hljs-string">"text"</span>: <span class="hljs-string">"import os<span class="hljs-subst">\n</span>def main()..."</span>                  <span class="hljs-comment">// 文件内容</span>
}
</code></pre>
<p>客户端AI可以读取这个资源，理解代码结构后提供重构建议或生成测试。</p>
<h3 data-id="heading-14">5.2 Prompts(提示模板)：用户选择用什么</h3>
<p><strong>什么是Prompt?</strong></p>
<p>Prompt就像是「对话模板」或「快捷指令」，把常用的复杂指令预设好，用户一键调用。用生活中的例子类比，就像微信的「快捷回复」或IDE中的「代码片段(Snippet)」。</p>
<p><strong>为什么需要Prompt?</strong><br/>
场景1:没有Prompt时</p>
<pre><code class="hljs language-markdown" lang="markdown">用户每次都要输入:
"请分析这个Git仓库最近一周的提交,统计:
<span class="hljs-bullet">1.</span> 总提交次数
<span class="hljs-bullet">2.</span> 每个作者的贡献
<span class="hljs-bullet">3.</span> 修改的主要文件
<span class="hljs-bullet">4.</span> 是否有破坏性变更
请用表格格式输出"
</code></pre>
<p>场景2:有Prompt后</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户只需:</span>
1. 点击 <span class="hljs-string">"/analyze-commits"</span> 命令
2. 选择分支 <span class="hljs-string">"main"</span>
3. AI自动执行完整分析
</code></pre>
<p><strong>Prompt的数据结构</strong></p>
<p><strong>定义一个Prompt</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// Prompt的唯一标识</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"提交历史分析"</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 用户界面显示的名称</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析Git提交并生成报告"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 功能说明</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                          <span class="hljs-comment">// 需要的参数列表</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 参数名</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"要分析的分支名"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 参数说明</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>                    <span class="hljs-comment">// 是否必填</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// 时间范围</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"起始日期(如:7 days ago)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>                   <span class="hljs-comment">// 可选参数</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"author"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 作者过滤</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"只看某个作者的提交"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际使用示例</strong></p>
<p><strong>步骤1: 列出所有可用的Prompt</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端请求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prompts/list"</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"📊 提交历史分析"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析指定分支的提交历史,生成统计报告"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"review_code"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🔍 代码审查"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对代码进行质量审查和改进建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file_path"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"focus"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explain_error"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🐛 错误诊断"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"解释错误信息并提供修复建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error_message"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 用户在界面上看到这些选项</strong></p>
<pre><code class="hljs language-bash" lang="bash">━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  可用命令:
  
  📊 /analyze-commits
     分析指定分支的提交历史
     
  🔍 /review-code  
     对代码进行质量审查
     
  🐛 /explain-error
     解释错误信息并修复
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>步骤3: 用户选择并填写参数</strong></p>
<pre><code class="hljs language-ini" lang="ini">用户输入: /analyze-commits

系统弹窗:
┌─────────────────────────┐
│ 提交历史分析            │
├─────────────────────────┤
│ 分支名 *: <span class="hljs-section">[main      ]</span> │
│ 时间范围: <span class="hljs-section">[7 days ago]</span> │
│ 作者:     <span class="hljs-section">[          ]</span> │
│                         │
│      <span class="hljs-section">[取消]</span>  <span class="hljs-section">[确定]</span>     │
└─────────────────────────┘
</code></pre>
<p><strong>步骤4: 获取完整的Prompt内容</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 客户端请求</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"prompts/get"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"analyze_commits"</span>,       <span class="hljs-comment">// 使用哪个模板</span>
    <span class="hljs-string">"arguments"</span>: {                    <span class="hljs-comment">// 用户填写的参数</span>
      <span class="hljs-string">"branch"</span>: <span class="hljs-string">"main"</span>,
      <span class="hljs-string">"since"</span>: <span class="hljs-string">"7 days ago"</span>
    }
  }
}

<span class="hljs-comment">// 服务器响应 - 返回完整的对话消息</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"分析main分支最近7天的提交"</span>,
    <span class="hljs-string">"messages"</span>: [                     <span class="hljs-comment">// 发送给AI的完整对话</span>
      {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,               <span class="hljs-comment">// 用户角色</span>
        <span class="hljs-string">"content"</span>: {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-string">"text"</span>: <span class="hljs-string">"请分析main分支在过去7天的Git提交历史。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>需要统计:<span class="hljs-subst">\n</span>1. 总提交次数<span class="hljs-subst">\n</span>2. 每个作者的贡献次数和代码行数<span class="hljs-subst">\n</span>3. 主要修改的文件列表<span class="hljs-subst">\n</span>4. 是否包含breaking changes<span class="hljs-subst">\n</span>5. 提交消息的规范性<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>请用表格格式输出结果,并在最后给出改进建议。"</span>
        }
      }
    ]
  }
}
</code></pre>
<p><strong>步骤5: 客户端将消息发送给AI</strong></p>
<pre><code class="hljs language-bash" lang="bash">用户看到AI正在分析...

AI返回:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 main分支提交分析报告(最近7天)

总提交次数: 23

作者贡献统计:
┌────────────┬────────┬──────────┐
│ 作者       │ 提交数 │ 代码行数  │
├────────────┼────────┼──────────┤
│ Alice      │   12   │  +543/-89│
│ Bob        │    8   │  +234/-45│
│ Charlie    │    3   │  +123/-12│
└────────────┴────────┴──────────┘

主要修改文件:
- src/api/users.py (8次修改)
- src/models/user.py (5次修改)
- tests/test_user.py (4次修改)

Breaking Changes: 无

提交规范性: 良好 (91%符合Conventional Commits)

改进建议:
1. 建议增加单元测试覆盖率
2. 部分提交消息过于简短
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>Prompt的内容类型</strong></p>
<p>Prompt消息中可以包含多种内容:<br/>
<strong>1. 纯文本</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请审查这段代码..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>2. 嵌入图片</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"base64-encoded-image-data"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 图片数据</span>
    <span class="hljs-attr">"mimeType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image/png"</span>                  <span class="hljs-comment">// 图片类型</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 嵌入资源</strong>(引用MCP资源)</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"resource"</span>,
    <span class="hljs-string">"resource"</span>: {
      <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///project/src/user.py"</span>,  <span class="hljs-comment">// 资源URI</span>
      <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,
      <span class="hljs-string">"text"</span>: <span class="hljs-string">"class User:<span class="hljs-subst">\n</span>    def __init__..."</span>  <span class="hljs-comment">// 资源内容</span>
    }
  }
}
</code></pre>
<p><strong>4. 多轮对话</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我想优化这段代码"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// AI的回复</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供代码内容"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resource"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 用户提供代码</span>
        <span class="hljs-attr">"resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Prompt vs Tool vs Resource 对比</strong></p>
<pre><code class="hljs language-scss" lang="scss">特性          Prompt              Tool                Resource
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
控制者        用户主动选择         AI自动决定           应用程序控制

触发方式      用户点击命令         AI判断需要调用       应用自动附加
              /analyze                              或用户选择
              
返回内容      对话消息            执行结果             数据内容
              (给AI的指令)        (函数返回值)         (上下文信息)
              
典型用途      工作流模板          执行操作             提供背景信息
              快捷指令            查询数据             文件内容
              
示例          代码审查模板        执行SQL查询          项目README
              错误诊断向导        发送邮件             数据库Schema
              
用户感知      ✅ 明显             ❓ 可能不知道         ❓ 透明的
              (用户点击)          (AI决定)            (自动加载)
</code></pre>
<p>Prompt是预设的对话模板，通过参数化实现灵活应用，提升用户体验，并能与MCP其他能力组合形成完整工作流。</p>
<p><strong>代码实现示例</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端:注册Prompt</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_commits"</span>,
            title=<span class="hljs-string">"📊 提交历史分析"</span>,
            description=<span class="hljs-string">"分析Git提交历史并生成统计报告"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"branch"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"分支名"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>},
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"since"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"时间范围"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">False</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_commits"</span>:
        branch = arguments[<span class="hljs-string">"branch"</span>]
        since = arguments.get(<span class="hljs-string">"since"</span>, <span class="hljs-string">"7 days ago"</span>)
        
        <span class="hljs-comment"># 构建完整的提示消息</span>
        prompt_text = <span class="hljs-string">f"""
请分析<span class="hljs-subst">{branch}</span>分支在<span class="hljs-subst">{since}</span>的Git提交历史。

需要统计:
1. 总提交次数
2. 每个作者的贡献
3. 主要修改的文件
4. 是否有breaking changes

请用表格格式输出。
        """</span>
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: prompt_text}
                }
            ]
        }

<span class="hljs-comment"># 客户端:使用Prompt</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">use_prompt</span>(<span class="hljs-params">session, prompt_name, arguments</span>):
    <span class="hljs-comment"># 获取Prompt内容</span>
    prompt = <span class="hljs-keyword">await</span> session.get_prompt(
        name=prompt_name,
        arguments=arguments
    )
    
    <span class="hljs-comment"># 将消息发送给AI</span>
    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> prompt.messages:
        ai_response = <span class="hljs-keyword">await</span> send_to_ai(message)
        <span class="hljs-built_in">print</span>(ai_response)
</code></pre>
<h3 data-id="heading-15">5.3 Tools(工具)：AI 自己决定用什么</h3>
<p><strong>Tool就是可执行的函数</strong>，比如查询数据库、调用API、写文件。</p>
<p><strong>谁控制</strong>：AI模型根据对话内容自己决定调用哪个工具</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出可用工具</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// AI调用工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回结果</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京天气:晴,温度22°C"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"isError"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">5.4 其他功能</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fcompletion" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/completion" ref="nofollow noopener noreferrer"><strong>补全</strong></a></p>
<p>MCP提供标准化的参数自动补全功能，支持为提示和资源URI提供上下文相关的建议，实现类似IDE的交互体验。服务器通过声明<code>completions</code>能力，支持对<code>ref/prompt</code>和<code>ref/resource</code>两种引用类型的补全，每次最多返回100个按相关性排序的建议值，并可通过<code>completion/complete</code>请求获取补全结果。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Flogging" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/logging" ref="nofollow noopener noreferrer"><strong>日志</strong></a></p>
<p>MCP提供结构化日志消息传递机制，允许服务器向客户端发送包含严重性级别、可选记录器名称和任意JSON可序列化数据的日志通知。服务器需声明<code>logging</code>能力，支持遵循RFC 5424标准的日志级别（从debug到emergency），客户端可通过<code>logging/setLevel</code>请求配置最低日志级别，服务器通过<code>notifications/message</code>通知发送日志消息。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fpagination" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/pagination" ref="nofollow noopener noreferrer"><strong>分页</strong></a></p>
<p>MCP支持对可能返回大量结果集的列表操作进行分页处理，使用基于不透明游标的分页模型而非数字页码。服务器在响应中包含当前页结果和可选的<code>nextCursor</code>字段（表示更多结果存在），客户端可通过在请求中包含游标继续分页。支持分页的操作包括<code>resources/list</code>、<code>resources/templates/list</code>、<code>prompts/list</code>和<code>tools/list</code>，客户端必须将游标视为不透明令牌。</p>
<h2 data-id="heading-17">六、客户端能力：反向请求</h2>
<p>客户端不仅接收服务器的数据，也可以提供能力给服务器使用:</p>
<h3 data-id="heading-18">6.1 Sampling(采样)：服务器请求客户端调用AI</h3>
<p><strong>场景</strong>: 服务器在处理任务时，需要AI帮忙分析中间结果。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sampling/createMessage"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这个数据正常吗?"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"modelPreferences"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"hints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-3-sonnet"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 建议用的模型</span>
      <span class="hljs-attr">"intelligencePriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 要求智能程度</span>
      <span class="hljs-attr">"speedPriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span>                     <span class="hljs-comment">// 速度要求</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际案例</strong>:Filesystem服务器在搜索大量文件时,请求AI判断哪些文件最相关。</p>
<h3 data-id="heading-19">6.2 Roots(目录)：告诉服务器工作范围</h3>
<p><strong>场景</strong>: 让服务器知道可以访问哪些目录。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"roots/list"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///home/user/project"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的项目"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>服务器知道只能在这个目录里操作，保护其他文件安全。</p>
<h3 data-id="heading-20">6.3 Elicitation(引导)：服务器向用户询问信息</h3>
<p><strong>场景</strong>: 服务器需要用户提供额外信息才能继续。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elicitation/create"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供您的GitHub用户名"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"requestedSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>用户响应</strong>:</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"action"</span>: <span class="hljs-string">"accept"</span>,  <span class="hljs-regexp">//</span> 或<span class="hljs-string">"decline"</span>拒绝, <span class="hljs-string">"cancel"</span>取消
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"username"</span>: <span class="hljs-string">"octocat"</span>
  }
}
</code></pre>
<p><strong>实际案例</strong>: Git服务器需要知道提交信息格式，弹窗问用户:"请选择提交规范:Conventional Commits/Angular/Custom?"</p>
<h2 data-id="heading-21">七、完整实战：从零构建天气查询MCP</h2>
<p>下面让我们从头到尾构建一个完整的MCP系统，包含服务器和客户端。</p>
<h3 data-id="heading-22">7.1 需求分析</h3>
<p><strong>目标</strong>: 构建一个天气查询MCP服务器,提供:</p>
<ul>
<li><strong>资源</strong>: 城市列表</li>
<li><strong>工具</strong>: 查询天气、获取预报</li>
<li><strong>提示</strong>: 天气分析模板</li>
</ul>
<h3 data-id="heading-23">7.2 服务器实现(Python)</h3>
<p><strong>第一步: 安装MCP SDK</strong></p>
<pre><code class="hljs">pip install mcp
</code></pre>
<p><strong>第二步: 创建服务器 (weather_server.py)</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server <span class="hljs-keyword">import</span> Server
<span class="hljs-keyword">from</span> mcp.types <span class="hljs-keyword">import</span> Resource, Tool, Prompt, TextContent
<span class="hljs-keyword">import</span> mcp.server.stdio
<span class="hljs-keyword">import</span> httpx

<span class="hljs-comment"># 创建MCP服务器实例</span>
server = Server(<span class="hljs-string">"weather-server"</span>)

<span class="hljs-comment"># 1. 定义资源:支持的城市列表</span>
<span class="hljs-meta">@server.list_resources()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_resources</span>():
    <span class="hljs-string">"""返回可用的资源列表"""</span>
    <span class="hljs-keyword">return</span> [
        Resource(
            uri=<span class="hljs-string">"weather://cities"</span>,
            name=<span class="hljs-string">"支持的城市列表"</span>,
            mimeType=<span class="hljs-string">"application/json"</span>,
            description=<span class="hljs-string">"查询天气支持的所有城市"</span>
        )
    ]

<span class="hljs-meta">@server.read_resource()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">uri: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""读取具体资源内容"""</span>
    <span class="hljs-keyword">if</span> uri == <span class="hljs-string">"weather://cities"</span>:
        cities = [<span class="hljs-string">"北京"</span>, <span class="hljs-string">"上海"</span>, <span class="hljs-string">"广州"</span>, <span class="hljs-string">"深圳"</span>, <span class="hljs-string">"杭州"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"contents"</span>: [{
                <span class="hljs-string">"uri"</span>: uri,
                <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"application/json"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-built_in">str</span>(cities)
            }]
        }

<span class="hljs-comment"># 2. 定义工具:天气查询</span>
<span class="hljs-meta">@server.list_tools()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tools</span>():
    <span class="hljs-string">"""返回可用的工具列表"""</span>
    <span class="hljs-keyword">return</span> [
        Tool(
            name=<span class="hljs-string">"get_current_weather"</span>,
            description=<span class="hljs-string">"获取指定城市的当前天气"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                        <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称,如'北京'"</span>
                    }
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        ),
        Tool(
            name=<span class="hljs-string">"get_forecast"</span>,
            description=<span class="hljs-string">"获取未来3天天气预报"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>},
                    <span class="hljs-string">"days"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"预报天数(1-3)"</span>, <span class="hljs-string">"default"</span>: <span class="hljs-number">3</span>}
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        )
    ]

<span class="hljs-meta">@server.call_tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""执行工具调用"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"get_current_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-comment"># 实际项目中这里调用真实的天气API</span>
        <span class="hljs-comment"># 示例:使用模拟数据</span>
        weather_data = {
            <span class="hljs-string">"city"</span>: city,
            <span class="hljs-string">"temperature"</span>: <span class="hljs-number">22</span>,
            <span class="hljs-string">"condition"</span>: <span class="hljs-string">"晴"</span>,
            <span class="hljs-string">"humidity"</span>: <span class="hljs-number">45</span>
        }
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">f"<span class="hljs-subst">{city}</span>当前天气:\n温度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'temperature'</span>]}</span>°C\n天气: <span class="hljs-subst">{weather_data[<span class="hljs-string">'condition'</span>]}</span>\n湿度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'humidity'</span>]}</span>%"</span>
            }]
        }
    
    <span class="hljs-keyword">elif</span> name == <span class="hljs-string">"get_forecast"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        days = arguments.get(<span class="hljs-string">"days"</span>, <span class="hljs-number">3</span>)
        <span class="hljs-comment"># 模拟预报数据</span>
        forecast = <span class="hljs-string">f"<span class="hljs-subst">{city}</span>未来<span class="hljs-subst">{days}</span>天预报:\n第1天: 晴,20-25°C\n第2天: 多云,18-23°C\n第3天: 小雨,16-20°C"</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: forecast}]
        }

<span class="hljs-comment"># 3. 定义提示模板:天气分析</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-string">"""返回可用的提示模板"""</span>
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_weather"</span>,
            description=<span class="hljs-string">"分析天气趋势并给出建议"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"city"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""获取提示模板内容"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: <span class="hljs-string">f"请分析<span class="hljs-subst">{city}</span>的天气情况,并给出出行建议。包括:\n1. 温度是否适宜\n2. 是否需要带伞\n3. 穿衣建议"</span>
                    }
                }
            ]
        }

<span class="hljs-comment"># 启动服务器</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 使用stdio传输(本地)</span>
    mcp.server.stdio.run_stdio_server(server)
</code></pre>
<h3 data-id="heading-24">7.3 配置服务器(Claude Desktop)</h3>
<p>创建配置文件 <code>~/Library/Application Support/Claude/claude_desktop_config.json</code>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"weather"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/to/weather_server.py"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-25">7.4 客户端实现(Python)</h3>
<p>如果要自己实现客户端:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp <span class="hljs-keyword">import</span> ClientSession
<span class="hljs-keyword">from</span> mcp.client.stdio <span class="hljs-keyword">import</span> stdio_client
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 连接到服务器</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_client(
        command=<span class="hljs-string">"python"</span>,
        args=[<span class="hljs-string">"/path/to/weather_server.py"</span>]
    ) <span class="hljs-keyword">as</span> (read, write):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(read, write) <span class="hljs-keyword">as</span> session:
            
            <span class="hljs-comment"># 1. 初始化连接</span>
            <span class="hljs-keyword">await</span> session.initialize()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 连接成功!"</span>)
            
            <span class="hljs-comment"># 2. 列出可用资源</span>
            resources = <span class="hljs-keyword">await</span> session.list_resources()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📁 可用资源: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(resources.resources)}</span>"</span>)
            <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> resources.resources:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{r.name}</span>: <span class="hljs-subst">{r.uri}</span>"</span>)
            
            <span class="hljs-comment"># 3. 读取城市列表资源</span>
            cities_resource = <span class="hljs-keyword">await</span> session.read_resource(
                uri=<span class="hljs-string">"weather://cities"</span>
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌍 城市列表: <span class="hljs-subst">{cities_resource.contents[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 4. 列出可用工具</span>
            tools = <span class="hljs-keyword">await</span> session.list_tools()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔧 可用工具: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tools.tools)}</span>"</span>)
            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools.tools:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{t.name}</span>: <span class="hljs-subst">{t.description}</span>"</span>)
            
            <span class="hljs-comment"># 5. 调用工具查询天气</span>
            result = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_current_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌤️  查询结果:\n<span class="hljs-subst">{result.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 6. 获取预报</span>
            forecast = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_forecast"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"上海"</span>, <span class="hljs-string">"days"</span>: <span class="hljs-number">3</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📅 天气预报:\n<span class="hljs-subst">{forecast.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 7. 列出提示模板</span>
            prompts = <span class="hljs-keyword">await</span> session.list_prompts()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n💡 提示模板: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(prompts.prompts)}</span>"</span>)
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> prompts.prompts:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{p.name}</span>: <span class="hljs-subst">{p.description}</span>"</span>)
            
            <span class="hljs-comment"># 8. 获取提示内容</span>
            prompt = <span class="hljs-keyword">await</span> session.get_prompt(
                name=<span class="hljs-string">"analyze_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"广州"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📝 生成的提示:\n<span class="hljs-subst">{prompt.messages[<span class="hljs-number">0</span>][<span class="hljs-string">'content'</span>][<span class="hljs-string">'text'</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h3 data-id="heading-26">7.5 运行效果</h3>
<pre><code class="hljs language-makefile" lang="makefile">$ python weather_client.py

✅ 连接成功!

📁 可用资源: 1
  - 支持的城市列表: weather://cities

🌍 城市列表: ['北京', '上海', '广州', '深圳', '杭州']

🔧 可用工具: 2
  - get_current_weather: 获取指定城市的当前天气
  - get_forecast: 获取未来3天天气预报

🌤️  查询结果:
<span class="hljs-section">北京当前天气:</span>
<span class="hljs-section">温度: 22°C</span>
<span class="hljs-section">天气: 晴</span>
<span class="hljs-section">湿度: 45%</span>

📅 天气预报:
<span class="hljs-section">上海未来3天预报:</span>
<span class="hljs-section">第1天: 晴,20-25°C</span>
<span class="hljs-section">第2天: 多云,18-23°C</span>
<span class="hljs-section">第3天: 小雨,16-20°C</span>

💡 提示模板: 1
  - analyze_weather: 分析天气趋势并给出建议

📝 生成的提示:
<span class="hljs-section">请分析广州的天气情况,并给出出行建议。包括:</span>
1. 温度是否适宜
2. 是否需要带伞
3. 穿衣建议
</code></pre>
<h2 data-id="heading-27">八、其他部分：MCP基础协议的另一半</h2>
<h3 data-id="heading-28">8.1 授权（Authorization）</h3>
<p>MCP授权规范定义了基于HTTP传输的安全授权机制，使MCP客户端能够代表资源所有者向受限制的MCP服务器发出请求。该规范基于OAuth 2.1及相关标准，实现了授权服务器发现、动态客户端注册和访问令牌管理。例如，客户端通过<code>resource</code>参数明确指定目标MCP服务器（如<code>https://mcp.example.com</code>），服务器则验证令牌是否专门为其颁发，确保令牌不会被误用于其他服务，从而防止"令牌传递"安全漏洞。</p>
<h3 data-id="heading-29">8.2 取消（Cancellation）</h3>
<p>MCP取消机制允许通过通知消息中止正在进行的请求，任何一方都可以发送<code>notifications/cancelled</code>通知来终止先前发出的请求。例如，当用户取消长时间运行的操作时，客户端可以发送包含请求ID和可选原因的取消通知，接收方应停止处理、释放资源且不发送响应。该机制考虑了网络延迟导致的竞态条件，允许接收方在请求已完成或无法取消时忽略通知，同时建议双方记录取消原因以便调试。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/cancelled"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"requestId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户取消"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-30">8.3 Ping机制</h3>
<p>MCP提供了可选的ping机制，允许任何一方验证对方是否仍然响应且连接存活。该机制通过简单的请求/响应模式实现，例如客户端发送<code>{"jsonrpc":"2.0","id":"123","method":"ping"}</code>，服务器必须立即响应<code>{"jsonrpc":"2.0","id":"123","result":{}}</code>。如果在合理超时时间内未收到响应，发送方可以将连接视为陈旧并终止连接或尝试重新连接。实现应定期发送ping以检测连接健康状况，但应避免过度ping以减少网络开销。</p>
<h3 data-id="heading-31">8.4 进度跟踪（Progress）</h3>
<p>MCP支持通过通知消息对长时间运行的操作进行可选的进度跟踪。请求方可以在请求元数据中包含唯一的<code>progressToken</code>（如字符串"task123"）来接收进度更新，接收方则可以发送包含进度值、可选总值和消息的<code>notifications/progress</code>通知。例如，文件上传操作可以发送<code>{"progress":50,"total":100,"message":"正在上传文件..."}</code>来指示完成百分比。进度值必须随每个通知递增，双方应实现速率限制以防止消息泛滥，并在操作完成后停止发送进度通知。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/progress"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"progressToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"task123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"progress"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 当前进度</span>
    <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 总量</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在上传文件..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-32">九、安全实践：必须重视</h2>
<h3 data-id="heading-33">9.1 核心原则</h3>
<p><strong>1. 用户同意优先</strong></p>
<ul>
<li>所有数据访问必须经用户明确同意</li>
<li>所有工具调用前必须让用户确认</li>
</ul>
<p><strong>2. 数据隐私保护</strong></p>
<ul>
<li>服务器只能看到必要的信息</li>
<li>完整对话历史保留在宿主,不发给服务器</li>
</ul>
<p><strong>3. 工具安全</strong></p>
<ul>
<li>工具代表代码执行,必须谨慎</li>
<li>显示工具要做什么,让用户批准</li>
</ul>
<p><strong>4. 输入验证</strong></p>
<ul>
<li>服务器必须验证所有输入</li>
<li>客户端必须验证工具返回的结果</li>
</ul>
<h3 data-id="heading-34">9.2 实际建议</h3>
<p><strong>服务器开发者</strong>:</p>
<ul>
<li>验证所有输入参数</li>
<li>实现访问控制和速率限制</li>
<li>记录操作日志供审计</li>
</ul>
<p><strong>客户端开发者</strong>:</p>
<ul>
<li>显示清晰的权限请求界面</li>
<li>在调用工具前展示参数</li>
<li>实现工具调用超时机制</li>
</ul>
<h2 data-id="heading-35">十、MCP生态：谁开发客户端?</h2>
<p><strong>关键认知</strong>: 在MCP生态中，<strong>客户端通常不是由下游开发者开发的</strong>，而是<strong>内置在AI应用平台中</strong>。</p>
<pre><code class="hljs language-css" lang="css">  开发者开发MCP服务器
       ↓
  配置到AI平台(Claude/<span class="hljs-attribute">Cursor</span>等)
       ↓
  AI平台内置的MCP客户端自动连接
</code></pre>
<p>对于软件开发者来说，在MCP生态中的位置如下。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">角色定位:</span>
┌─────────────────────────────────────────┐
│ AI平台开发者(Anthropic, Cursor等)       │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP客户端SDK                    │
│  ✅ 集成到自己的AI应用中                │
│  ✅ 提供配置界面                        │
│  ✅ 管理MCP服务器生命周期               │
│  ✅ 处理AI与MCP的交互逻辑               │
└─────────────────────────────────────────┘
                 ↓ 提供平台
┌─────────────────────────────────────────┐
│ MCP服务器开发者(你、我、社区)           │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP服务器                       │
│  ✅ 实现Resources/Tools/Prompts        │
│  ✅ 编写使用文档                        │
│  ✅ 发布到npm/PyPI                      │
│  ❌ 不需要开发客户端                    │
│  ❌ 不需要关心AI如何调用                │
└─────────────────────────────────────────┘
                 ↓ 使用服务
┌─────────────────────────────────────────┐
│ 最终用户(开发者、分析师等)               │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 安装需要的MCP服务器                 │
│  ✅ 配置到AI平台                        │
│  ✅ 使用AI完成任务                      │
│  ❌ 不需要写代码                        │
└─────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-36">后记</h2>
<p>MCP 让 AI 应用开发变得更简单、更安全、更强大。它不是银弹，但为构建可靠的AI系统提供了坚实基础。<strong>本文全部内容基于提示编写，欢迎交流讨论！</strong></p>
<h2 data-id="heading-37">参考文献</h2>
<ol>
<li>MCP官方规范: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18" ref="nofollow noopener noreferrer">modelcontextprotocol.io/specificati…</a></li>
<li>JSON-RPC 2.0: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jsonrpc.org%2F" target="_blank" title="https://www.jsonrpc.org/" ref="nofollow noopener noreferrer">www.jsonrpc.org/</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析]]></title>    <link>https://juejin.cn/post/7571829879827628051</link>    <guid>https://juejin.cn/post/7571829879827628051</guid>    <pubDate>2025-11-13T10:20:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571829879827628051" data-draft-id="7572004684178669622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析"/> <meta itemprop="keywords" content="人工智能,开源"/> <meta itemprop="datePublished" content="2025-11-13T10:20:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="算家计算"/> <meta itemprop="url" content="https://juejin.cn/user/1426490793396571"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PaddleOCR-VL-vLLM-OpenAI-API使用教程来了！手把手教你搞定文档解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1426490793396571/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    算家计算
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-13T10:20:37.000Z" title="Thu Nov 13 2025 10:20:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>通过 OpenAI 兼容的 API 接口使用该工具的【本地部署教程】请点击以下链接：</strong></p>
<p><a href="https://juejin.cn/post/7569789282429255722" target="_blank" title="https://juejin.cn/post/7569789282429255722">告别繁琐文档处理！PaddleOCR-VL-vLLM-OpenAI-API本地部署教程：精准解析文本/表格/公式 - 掘金</a></p>
<p><strong>模型一键部署及使用方法请进入“算家云”官网</strong></p>
<h2 data-id="heading-0">概述</h2>
<p>PaddleOCR-VL 是一个基于视觉语言模型的多功能图像识别工具，支持 OCR 文字识别、表格识别、公式识别和图表识别等功能。本文档介绍如何通过 OpenAI 兼容的 API 接口使用该模型。</p>
<p><strong>功能验证状态</strong>: 所有四种任务类型已通过完整测试，功能稳定可用（测试时间：2025-11-07）</p>
<h2 data-id="heading-1">API 配置信息</h2>
<ul>
<li><strong>API 端点</strong>: <code>http://xn-b.suanjiayun.com:51849/v1/</code>  <strong>(实例对外开放端口)</strong></li>
<li><strong>模型名称</strong>: <code>PaddleOCR-VL</code></li>
<li><strong>API Key</strong>: <code>EMPTY</code>（无需真实密钥）</li>
<li><strong>最大上下文长度</strong>: 4096 tokens</li>
<li><strong>超时设置</strong>: 建议 3600 秒</li>
<li><strong>平均响应时间</strong>: 3-5 秒</li>
</ul>
<h2 data-id="heading-2">环境准备</h2>
<h3 data-id="heading-3">1. 安装依赖</h3>
<pre><code class="hljs">pip install openai
</code></pre>
<h3 data-id="heading-4">2. 基础配置</h3>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI

<span class="hljs-attr">client</span> = OpenAI(
    <span class="hljs-attr">api_key</span>=<span class="hljs-string">"EMPTY"</span>,
    <span class="hljs-attr">base_url</span>=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
    <span class="hljs-attr">timeout</span>=<span class="hljs-number">3600</span>
)
</code></pre>
<h2 data-id="heading-5">支持的任务类型</h2>
<h3 data-id="heading-6">1. OCR 文字识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"OCR:"</code></li>
<li><strong>功能</strong>: 识别图像中的文字内容</li>
<li><strong>输出格式</strong>: 纯文本，保持原有布局结构</li>
<li><strong>适用场景</strong>: 文档扫描、票据识别、标牌识别等</li>
<li><strong>测试结果</strong>: 准确识别文字和数字，布局保持良好</li>
</ul>
<p><strong>示例输出</strong>:</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-built_in">CINNAMON</span> SUGAR
<span class="hljs-number">1</span> x <span class="hljs-number">17</span>,<span class="hljs-number">000</span>
<span class="hljs-number">17</span>,<span class="hljs-number">000</span>
SUB TOTAL
<span class="hljs-number">17</span>,<span class="hljs-number">000</span>
</code></pre>
<h3 data-id="heading-7">2. 表格识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Table Recognition:"</code></li>
<li><strong>功能</strong>: 识别和解析表格结构及内容</li>
<li><strong>输出格式</strong>: 结构化标记语言（<code>&lt;fcel&gt;</code>, <code>&lt;lcel&gt;</code>, <code>&lt;ecel&gt;</code>, <code>&lt;nl&gt;</code>）</li>
<li><strong>适用场景</strong>: 财务报表、数据表格、统计表等</li>
<li><strong>测试结果</strong>: 能够准确识别表格行列结构</li>
</ul>
<p><strong>标记说明</strong>:</p>
<ul>
<li><code>&lt;fcel&gt;</code>: 第一列单元格</li>
<li><code>&lt;lcel&gt;</code>: 最后一列单元格</li>
<li><code>&lt;ecel&gt;</code>: 空单元格</li>
<li><code>&lt;nl&gt;</code>: 新行</li>
</ul>
<h3 data-id="heading-8">3. 公式识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Formula Recognition:"</code></li>
<li><strong>功能</strong>: 识别数学公式和科学公式</li>
<li><strong>输出格式</strong>: 格式化对齐的文本，保持数字对齐</li>
<li><strong>适用场景</strong>: 学术论文、教材、科研文档等</li>
<li><strong>测试结果</strong>: 能识别运算符，保持格式对齐</li>
</ul>
<h3 data-id="heading-9">4. 图表识别 ✅</h3>
<ul>
<li><strong>任务标识</strong>: <code>"Chart Recognition:"</code></li>
<li><strong>功能</strong>: 识别图表类型和数据内容</li>
<li><strong>输出格式</strong>: 表格化数据（Category | Value 格式）</li>
<li><strong>适用场景</strong>: 数据可视化图表、统计图形等</li>
<li><strong>测试结果</strong>: 自动结构化数据，便于后续处理</li>
</ul>
<p><strong>示例输出</strong>:</p>
<pre><code class="hljs language-objectivec" lang="objectivec">Category | Value
<span class="hljs-built_in">CINNAMON</span> SUGAR | <span class="hljs-number">17000</span>
SUB TOTAL | <span class="hljs-number">17000</span>
GRAND TOTAL | <span class="hljs-number">17000</span>
</code></pre>
<h2 data-id="heading-10">使用示例</h2>
<h3 data-id="heading-11">快速开始 - 基础 OCR 识别</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

<span class="hljs-comment"># 初始化客户端</span>
client = OpenAI(
    api_key=<span class="hljs-string">"EMPTY"</span>,
    base_url=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
    timeout=<span class="hljs-number">3600</span>
)

<span class="hljs-comment"># 定义任务类型</span>
TASKS = {
    <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"OCR:"</span>,
    <span class="hljs-string">"table"</span>: <span class="hljs-string">"Table Recognition:"</span>,
    <span class="hljs-string">"formula"</span>: <span class="hljs-string">"Formula Recognition:"</span>,
    <span class="hljs-string">"chart"</span>: <span class="hljs-string">"Chart Recognition:"</span>,
}

<span class="hljs-comment"># 构建请求消息</span>
messages = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"你的图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"ocr"</span>]  <span class="hljs-comment"># 选择任务类型</span>
            }
        ]
    }
]

<span class="hljs-comment"># 发送请求</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在处理图像..."</span>)
    response = client.chat.completions.create(
        model=<span class="hljs-string">"PaddleOCR-VL"</span>,
        messages=messages,
        temperature=<span class="hljs-number">0.0</span>,
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 识别成功!"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📝 识别结果:\n<span class="hljs-subst">{response.choices[<span class="hljs-number">0</span>].message.content}</span>"</span>)
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 识别失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h3 data-id="heading-12">不同任务类型示例</h3>
<h4 data-id="heading-13">表格识别示例</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 表格识别 - 返回结构化标记</span>
<span class="hljs-attr">messages</span> = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"包含表格的图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"table"</span>]
            }
        ]
    }
]

<span class="hljs-attr">response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
)
<span class="hljs-comment"># 输出示例: &lt;fcel&gt;内容&lt;fcel&gt;内容&lt;nl&gt;...</span>
</code></pre>
<h4 data-id="heading-14">图表识别示例</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 图表识别 - 返回表格化数据</span>
<span class="hljs-attr">messages</span> = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"图表图片URL"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"chart"</span>]
            }
        ]
    }
]

<span class="hljs-attr">response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
)
<span class="hljs-comment"># 输出示例: Category | Value\n项目名 | 数值</span>
</code></pre>
<h2 data-id="heading-15">图片输入方式</h2>
<h3 data-id="heading-16">1. 网络图片 URL</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"image_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://example.com/image.jpg"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-17">2. Base64 编码图片</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> base64

<span class="hljs-keyword">def</span> <span class="hljs-title function_">encode_image</span>(<span class="hljs-params">image_path</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
        <span class="hljs-keyword">return</span> base64.b64encode(image_file.read()).decode(<span class="hljs-string">'utf-8'</span>)

base64_image = encode_image(<span class="hljs-string">"path/to/your/image.jpg"</span>)

<span class="hljs-string">"image_url"</span>: {
    <span class="hljs-string">"url"</span>: <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
}
</code></pre>
<h2 data-id="heading-18">完整功能类 - 生产就绪版本</h2>
<p>基于实际测试结果，以下是经过验证的完整功能类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaddleOCRVL</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.client = OpenAI(
            api_key=<span class="hljs-string">"EMPTY"</span>,
            base_url=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
            timeout=<span class="hljs-number">3600</span>
        )
        self.tasks = {
            <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"OCR:"</span>,
            <span class="hljs-string">"table"</span>: <span class="hljs-string">"Table Recognition:"</span>,
            <span class="hljs-string">"formula"</span>: <span class="hljs-string">"Formula Recognition:"</span>,
            <span class="hljs-string">"chart"</span>: <span class="hljs-string">"Chart Recognition:"</span>,
        }
        self.output_formats = {
            <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"纯文本格式"</span>,
            <span class="hljs-string">"table"</span>: <span class="hljs-string">"结构化标记语言"</span>,
            <span class="hljs-string">"formula"</span>: <span class="hljs-string">"格式化对齐文本"</span>,
            <span class="hljs-string">"chart"</span>: <span class="hljs-string">"表格化数据"</span>
        }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recognize</span>(<span class="hljs-params">self, image_url, task_type=<span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""
        图像识别主函数 - 已通过完整测试验证

        Args:
            image_url (str): 图片URL或本地路径
            task_type (str): 任务类型 ('ocr', 'table', 'formula', 'chart')
            verbose (bool): 是否显示详细处理信息

        Returns:
            dict: 包含识别结果和元信息的字典
        """</span>
        <span class="hljs-keyword">if</span> task_type <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.tasks:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"不支持的任务类型: <span class="hljs-subst">{task_type}</span>. 支持的类型: <span class="hljs-subst">{<span class="hljs-built_in">list</span>(self.tasks.keys())}</span>"</span>)

        <span class="hljs-keyword">if</span> verbose:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚀 开始 <span class="hljs-subst">{task_type.upper()}</span> 识别..."</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📊 预期输出格式: <span class="hljs-subst">{self.output_formats[task_type]}</span>"</span>)

        <span class="hljs-comment"># 处理本地图片</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_url.startswith((<span class="hljs-string">'http://'</span>, <span class="hljs-string">'https://'</span>)):
            image_url = self._encode_local_image(image_url)

        messages = [
            {
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                        <span class="hljs-string">"image_url"</span>: {<span class="hljs-string">"url"</span>: image_url}
                    },
                    {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: self.tasks[task_type]
                    }
                ]
            }
        ]

        <span class="hljs-keyword">try</span>:
            start_time = time.time()
            response = self.client.chat.completions.create(
                model=<span class="hljs-string">"PaddleOCR-VL"</span>,
                messages=messages,
                temperature=<span class="hljs-number">0.0</span>,
            )
            end_time = time.time()
            processing_time = end_time - start_time

            result = {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
                <span class="hljs-string">"content"</span>: response.choices[<span class="hljs-number">0</span>].message.content,
                <span class="hljs-string">"task_type"</span>: task_type,
                <span class="hljs-string">"processing_time"</span>: <span class="hljs-built_in">round</span>(processing_time, <span class="hljs-number">2</span>),
                <span class="hljs-string">"output_format"</span>: self.output_formats[task_type]
            }

            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 识别成功! 耗时: <span class="hljs-subst">{processing_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)

            <span class="hljs-keyword">return</span> result

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            error_result = {
                <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
                <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e),
                <span class="hljs-string">"task_type"</span>: task_type,
                <span class="hljs-string">"processing_time"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"output_format"</span>: <span class="hljs-literal">None</span>
            }

            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 识别失败: <span class="hljs-subst">{e}</span>"</span>)

            <span class="hljs-keyword">return</span> error_result

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_recognize</span>(<span class="hljs-params">self, image_urls, task_type=<span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""批量识别功能"""</span>
        results = []
        <span class="hljs-keyword">for</span> i, url <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(image_urls):
            <span class="hljs-keyword">if</span> verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n处理第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(image_urls)}</span> 张图片..."</span>)
            result = self.recognize(url, task_type, verbose)
            results.append(result)
            time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 避免请求过于频繁</span>
        <span class="hljs-keyword">return</span> results

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_encode_local_image</span>(<span class="hljs-params">self, image_path</span>):
        <span class="hljs-string">"""编码本地图片为 base64"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(image_path, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> image_file:
                base64_image = base64.b64encode(image_file.read()).decode(<span class="hljs-string">'utf-8'</span>)
                <span class="hljs-comment"># 根据文件扩展名确定MIME类型</span>
                <span class="hljs-keyword">if</span> image_path.lower().endswith(<span class="hljs-string">'.png'</span>):
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"data:image/png;base64,<span class="hljs-subst">{base64_image}</span>"</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"data:image/jpeg;base64,<span class="hljs-subst">{base64_image}</span>"</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"无法读取图片文件: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 使用示例 - 基于实际测试验证</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    ocr = PaddleOCRVL()

    <span class="hljs-comment"># 测试用的收据图片URL</span>
    test_image = <span class="hljs-string">"https://ofasys-multimodal-wlcb-3-toshanghai.oss-accelerate.aliyuncs.com/wpf272043/keepme/image/receipt.png"</span>

    <span class="hljs-comment"># OCR 识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"ocr"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"OCR 结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)

    <span class="hljs-comment"># 表格识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"table"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"表格识别结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)

    <span class="hljs-comment"># 图表识别</span>
    result = ocr.recognize(test_image, <span class="hljs-string">"chart"</span>, verbose=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">"success"</span>]:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"图表识别结果:\n<span class="hljs-subst">{result[<span class="hljs-string">'content'</span>]}</span>"</span>)
</code></pre>
<h2 data-id="heading-19">性能特点（基于实际测试）</h2>
<h3 data-id="heading-20">✅ 已验证的性能指标</h3>
<ul>
<li><strong>响应时间</strong>: 3-5 秒（所有任务类型）</li>
<li><strong>成功率</strong>: 100%（基于测试样本）</li>
<li><strong>API 稳定性</strong>: 连续测试无异常</li>
<li><strong>识别准确率</strong>: 文字和数字识别准确</li>
</ul>
<h3 data-id="heading-21">📊 输出格式对比</h3>




































<table><thead><tr><th>任务类型</th><th>输出格式</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td>OCR</td><td>纯文本</td><td>保持原布局</td><td>文档扫描、文字提取</td></tr><tr><td>Table</td><td>标记语言</td><td>结构化标记</td><td>表格数据解析</td></tr><tr><td>Formula</td><td>对齐文本</td><td>格式化显示</td><td>公式文档处理</td></tr><tr><td>Chart</td><td>表格数据</td><td>Category</td><td>Value</td><td>数据分析处理</td></tr></tbody></table>
<h2 data-id="heading-22">注意事项</h2>
<h3 data-id="heading-23">🔧 技术要求</h3>
<ol>
<li><strong>网络连接</strong>: 确保能够访问 API 端点 <code>http://xn-b.suanjiayun.com:51849/v1/</code></li>
<li><strong>图片格式</strong>: 支持常见图片格式（JPG、PNG、GIF 等）</li>
<li><strong>图片大小</strong>: 建议图片不超过 10MB</li>
<li><strong>超时设置</strong>: 建议设置 3600 秒超时（实际处理时间 3-5 秒）</li>
<li><strong>错误处理</strong>: 始终使用 try-except 处理可能的网络或 API 错误</li>
</ol>
<h3 data-id="heading-24">💡 最佳实践</h3>
<ol>
<li><strong>图片质量</strong>: 使用高清晰度图片获得最佳识别效果</li>
<li><strong>任务选择</strong>: 根据实际需求选择合适的任务类型</li>
<li><strong>结果处理</strong>: 不同任务类型返回不同格式，需要相应的后处理逻辑</li>
<li><strong>批量处理</strong>: 在请求间添加适当延迟（建议 1-2 秒）</li>
</ol>
<h2 data-id="heading-25">常见问题</h2>
<h3 data-id="heading-26">Q: 如何提高识别准确率？</h3>
<p>A:</p>
<ul>
<li>确保图片清晰度足够</li>
<li>避免图片过度压缩</li>
<li>选择合适的任务类型</li>
<li>根据测试结果，当前识别准确率已经很高</li>
</ul>
<h3 data-id="heading-27">Q: 支持批量处理吗？</h3>
<p>A: 支持，可以使用提供的 <code>batch_recognize</code> 方法，或循环调用单张处理</p>
<h3 data-id="heading-28">Q: 如何处理不同的输出格式？</h3>
<p>A:</p>
<ul>
<li><strong>OCR</strong>: 直接使用文本内容</li>
<li><strong>Table</strong>: 需要解析 <code>&lt;fcel&gt;</code>, <code>&lt;nl&gt;</code> 等标记</li>
<li><strong>Chart</strong>: 可以直接按 <code>|</code> 分割处理表格数据</li>
</ul>
<h3 data-id="heading-29">Q: API 响应时间如何？</h3>
<p>A: 根据测试结果，所有任务类型的响应时间都在 3-5 秒内</p>
<h3 data-id="heading-30">Q: 如何处理识别错误？</h3>
<p>A: 检查网络连接、图片格式和 API 端点配置。使用提供的错误处理机制</p>
<h2 data-id="heading-31">功能验证测试</h2>
<h3 data-id="heading-32">🧪 测试用例</h3>
<p>为了验证文档中的所有功能，可以运行以下测试代码：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 快速功能验证测试</span>
from openai import OpenAI

def quick_test():
    <span class="hljs-attr">client</span> = OpenAI(
        <span class="hljs-attr">api_key</span>=<span class="hljs-string">"EMPTY"</span>,
        <span class="hljs-attr">base_url</span>=<span class="hljs-string">"http://xn-b.suanjiayun.com:51849/v1/"</span>,
        <span class="hljs-attr">timeout</span>=<span class="hljs-number">3600</span>
    )

    <span class="hljs-attr">test_image</span> = <span class="hljs-string">"https://ofasys-multimodal-wlcb-3-toshanghai.oss-accelerate.aliyuncs.com/wpf272043/keepme/image/receipt.png"</span>
    <span class="hljs-attr">tasks</span> = [<span class="hljs-string">"OCR:"</span>, <span class="hljs-string">"Table Recognition:"</span>, <span class="hljs-string">"Formula Recognition:"</span>, <span class="hljs-string">"Chart Recognition:"</span>]

    print("🚀 开始功能验证测试...")

    for i, task in enumerate(tasks):
        print(f"\n测试 {i+1}/4: {task}")
        try:
            <span class="hljs-attr">messages</span> = [{
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: [
                    {<span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>, <span class="hljs-string">"image_url"</span>: {<span class="hljs-string">"url"</span>: test_image}},
                    {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: task}
                ]
            }]

            <span class="hljs-attr">response</span> = client.chat.completions.create(
                <span class="hljs-attr">model</span>=<span class="hljs-string">"PaddleOCR-VL"</span>,
                <span class="hljs-attr">messages</span>=messages,
                <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.0</span>,
            )
            print(f"✅ {task} 测试通过")
        except Exception as e:
            print(f"❌ {task} 测试失败: {e}")

    print("\n🎉 测试完成!")

if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    quick_test()
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器之内置四大多线程API]]></title>    <link>https://juejin.cn/post/7571477608393572352</link>    <guid>https://juejin.cn/post/7571477608393572352</guid>    <pubDate>2025-11-12T09:01:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571477608393572352" data-draft-id="7571641339687895040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器之内置四大多线程API"/> <meta itemprop="keywords" content="前端,JavaScript,浏览器"/> <meta itemprop="datePublished" content="2025-11-12T09:01:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器之内置四大多线程API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:01:00.000Z" title="Wed Nov 12 2025 09:01:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">一、为什么 Web Worker 能实现 “多线程”？</h3>
<p>浏览器的 JS 引擎（如 V8）本身是单线程的，但浏览器是多进程 / 多线程架构。Web Worker 的本质是 <strong>浏览器为 JS 提供的 “额外线程池”</strong> ，核心原理：</p>
<ol>
<li><strong>线程隔离</strong>：Worker 线程与主线程是完全隔离的内存空间（不共享堆内存），通过 “消息队列” 通信（数据传输基于结构化克隆算法，深拷贝）。</li>
<li><strong>阻塞无关性</strong>：Worker 线程的阻塞（如死循环）不会影响主线程，但会导致自身无法响应消息。</li>
<li><strong>资源限制</strong>：浏览器对 Worker 数量有上限（通常同源下不超过 20 个），且单个 Worker 占用的内存有限制（避免滥用系统资源）。</li>
</ol>
<p><strong>关键区别</strong>：与 Node.js 的 <code>child_process</code> 不同，Web Worker 无法共享内存（需通过 <code>SharedArrayBuffer</code> 实现有限共享，见下文），且受浏览器安全策略（如跨域限制）约束。</p>
<p><strong>总结：</strong>
webwork是通过js的方式唤起浏览器的内置api使用，辅助前端计算的一种方式，就像fetch、ajaix那样唤起浏览器的接口查询一样。</p>
<h3 data-id="heading-1">多线程四大API</h3>
<p>Web Worker 是前端 “多线程” 的基础规范，但浏览器针对不同场景设计了 <strong>4 种独立的 Worker 类型</strong>—— 它们共享 “线程隔离” 的核心思想（避免阻塞主线程），但定位、能力、使用场景完全不同，均为 W3C 标准定义的原生 API（无需第三方库），底层由浏览器独立实现（无依赖关系）。</p>
<h4 data-id="heading-2">浏览器 4 种核心 Worker 类型对比表</h4>



































<table><thead><tr><th>Worker 类型</th><th>核心定位</th><th>底层依赖</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>Web Worker</strong></td><td>主线程的 “计算助手”，处理耗时计算</td><td>浏览器线程池</td><td>大数据排序、加密解密、复杂算法计算</td></tr><tr><td><strong>Shared Worker</strong></td><td>多页面共享的 “后台协调者”，跨页面通信</td><td>浏览器共享线程</td><td>多标签页登录状态同步、跨页数据协同</td></tr><tr><td><strong>Service Worker</strong></td><td>页面离线的 “代理服务器”，拦截请求 + 缓存</td><td>浏览器后台线程</td><td>离线应用、请求拦截优化、浏览器推送通知</td></tr><tr><td><strong>Worklet</strong></td><td>渲染管线的 “实时处理器”，介入渲染流程</td><td>浏览器渲染线程</td><td>CSS 物理动画、音频降噪、Canvas 渲染优化</td></tr></tbody></table>
<h3 data-id="heading-3">二、分类</h3>
<h4 data-id="heading-4">1. Web Worker（计算型：解决主线程阻塞）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>独立于主线程的 “计算线程”，仅与创建它的主线程通信（一对一）；</li>
</ul>

<ul>
<li>生命周期与页面绑定（页面关闭则 Worker 销毁）；</li>
</ul>

<ul>
<li>不阻塞 UI，专门处理耗时计算（避免页面卡顿）。</li>
</ul>
<p><strong>示例：10 万条数据排序</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（main.js）：发起计算请求，接收结果</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">Worker</span>) {
  <span class="hljs-comment">// 1. 创建 Worker 实例</span>
  <span class="hljs-keyword">const</span> sortWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'sort-worker.js'</span>);
  
  <span class="hljs-comment">// 2. 生成 10 万条随机大数据（模拟复杂计算场景）</span>
  <span class="hljs-keyword">const</span> bigData = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100000</span>);
  
  <span class="hljs-comment">// 3. 发送数据给 Worker，触发计算</span>
  sortWorker.<span class="hljs-title function_">postMessage</span>(bigData);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主线程：已发送数据，等待排序结果...'</span>);
  
  <span class="hljs-comment">// 4. 接收 Worker 返回的计算结果</span>
  sortWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主线程：排序完成，前 10 条数据：'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>));
    sortWorker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 计算完成，销毁 Worker（避免内存泄漏）</span>
  };
  
  <span class="hljs-comment">// 5. 监听 Worker 错误（如代码报错）</span>
  sortWorker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker 错误：<span class="hljs-subst">${err.message}</span>（行号：<span class="hljs-subst">${err.lineno}</span>）`</span>);
    sortWorker.<span class="hljs-title function_">terminate</span>();
  };
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'当前浏览器不支持 Web Worker'</span>);
}
<span class="hljs-comment">// Worker 线程（sort-worker.js）：执行耗时计算</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> data = e.<span class="hljs-property">data</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Worker 线程：开始排序 10 万条数据...'</span>);
  
  <span class="hljs-comment">// 耗时计算（示例用内置排序，实际可替换为快排、归并等复杂算法）</span>
  <span class="hljs-keyword">const</span> sortedData = data.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);
  
  <span class="hljs-comment">// 向主线程返回结果</span>
  self.<span class="hljs-title function_">postMessage</span>(sortedData);
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// Worker 主动关闭，释放资源</span>
};
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>主线程可正常处理用户交互（点击、滚动），排序在后台线程执行，页面无卡顿；计算完成后自动销毁 Worker，无内存泄漏。</p>
<h4 data-id="heading-5">2. Shared Worker（协同型：多页面数据同步）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>同源多页面可共享同一个 Worker 实例（突破 “单页面私有” 限制）；</li>
</ul>

<ul>
<li>通过 port（通信端口）实现多页面与 Worker 的双向通信；</li>
</ul>

<ul>
<li>适合跨页面状态同步（无需重复请求接口）。</li>
</ul>
<p><strong>示例：多标签页登录状态同步</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程 - 页面 A（login.html）：登录后同步状态</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">SharedWorker</span>) {
  <span class="hljs-comment">// 1. 创建 Shared Worker 实例</span>
  <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
  <span class="hljs-comment">// 2. 激活通信端口（必须调用 start()）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 3. 模拟登录按钮点击，发送登录状态给 Worker</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'login-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> userInfo = { <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>, <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span> };
    sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN'</span>, <span class="hljs-attr">data</span>: userInfo });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面 A：已发送登录状态'</span>);
  });
  
  <span class="hljs-comment">// 4. 接收 Worker 广播的消息（如其他页面同步的状态）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面 A 收到消息：'</span>, e.<span class="hljs-property">data</span>);
  };
}
<span class="hljs-comment">// 主线程 - 页面 B（index.html）：实时获取登录状态</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">SharedWorker</span>) {
  <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 1. 向 Worker 请求当前登录状态</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'QUERY_STATUS'</span> });
  
  <span class="hljs-comment">// 2. 接收状态（页面 A 登录后，页面 B 实时更新）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'LOGIN_STATUS'</span>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">textContent</span> = e.<span class="hljs-property">data</span>.<span class="hljs-property">isLogin</span> 
        ? <span class="hljs-string">`已登录：<span class="hljs-subst">${e.data.username}</span>`</span> 
        : <span class="hljs-string">'未登录'</span>;
    }
  };
}
<span class="hljs-comment">// Shared Worker 线程（sync-worker.js）：维护全局状态，广播消息</span>
<span class="hljs-keyword">const</span> connections = []; <span class="hljs-comment">// 存储所有连接的页面端口</span>
<span class="hljs-keyword">let</span> globalState = { <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">''</span> }; <span class="hljs-comment">// 全局共享状态</span>
<span class="hljs-comment">// 监听页面连接（新页面打开时触发）</span>
self.<span class="hljs-property">onconnect</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];
  connections.<span class="hljs-title function_">push</span>(port); <span class="hljs-comment">// 记录新连接的页面</span>
  port.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 处理页面发送的消息</span>
  port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    <span class="hljs-keyword">switch</span> (msg.<span class="hljs-property">data</span>.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'LOGIN'</span>:
        <span class="hljs-comment">// 更新全局状态</span>
        globalState = msg.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;
        <span class="hljs-comment">// 广播给所有连接的页面（同步状态到页面 A、B...）</span>
        connections.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-title function_">postMessage</span>({ 
          <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_STATUS'</span>, 
          ...globalState 
        }));
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'QUERY_STATUS'</span>:
        <span class="hljs-comment">// 单独响应某个页面的状态查询</span>
        port.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_STATUS'</span>, ...globalState });
        <span class="hljs-keyword">break</span>;
    }
  };
  
  <span class="hljs-comment">// 页面关闭时，移除端口（避免内存泄漏）</span>
  port.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> index = connections.<span class="hljs-title function_">indexOf</span>(port);
    <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) connections.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
  };
};
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>页面 A 点击 “登录” 后，页面 B 无需刷新，实时显示 “已登录：admin”；多标签页共享同一登录状态，无需重复调用登录接口。</p>
<h4 data-id="heading-6">3. Service Worker（网络型：离线缓存 + 请求拦截）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>完全独立于页面，运行在浏览器后台（页面关闭后仍可活动）；</li>
</ul>

<ul>
<li>拦截所有网络请求，可自定义缓存策略（实现离线访问）；</li>
</ul>

<ul>
<li>生命周期包含 “安装→激活→运行”，需手动管理缓存版本。</li>
</ul>
<p><strong>示例：离线缓存静态资源 + API 请求</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（main.js）：注册 Service Worker，触发离线逻辑</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 注册 Service Worker（脚本需在根目录，确保作用域覆盖所有页面）</span>
      <span class="hljs-keyword">const</span> registration = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功，作用域：'</span>, registration.<span class="hljs-property">scope</span>);
      
      <span class="hljs-comment">// 2. 测试离线请求（首次联网缓存，后续断网可访问）</span>
      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'API 请求结果：'</span>, data);
      });
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Service Worker 注册失败：'</span>, err);
    }
  });
}
<span class="hljs-comment">// Service Worker 线程（sw.js）：缓存+请求拦截逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'offline-cache-v1'</span>; <span class="hljs-comment">// 缓存版本（更新时修改版本号）</span>
<span class="hljs-comment">// 需要缓存的资源列表（静态资源+API接口）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_ASSETS</span> = [
  <span class="hljs-string">'/'</span>, 
  <span class="hljs-string">'/index.html'</span>,
  <span class="hljs-string">'/styles.css'</span>,
  <span class="hljs-string">'/api/data'</span> <span class="hljs-comment">// 需缓存的 API 接口</span>
];
<span class="hljs-comment">// 1. 安装阶段：缓存静态资源（仅首次注册/版本更新时触发）</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 等待缓存完成后，再进入激活阶段</span>
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(<span class="hljs-variable constant_">CACHE_ASSETS</span>)) <span class="hljs-comment">// 批量缓存资源</span>
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-title function_">skipWaiting</span>()) <span class="hljs-comment">// 跳过等待，立即激活新 Worker（替换旧版本）</span>
  );
});
<span class="hljs-comment">// 2. 激活阶段：清理旧缓存（避免缓存膨胀）</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cacheNames</span> =&gt;</span> {
      <span class="hljs-comment">// 删除非当前版本的缓存</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        cacheNames.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name !== <span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> caches.<span class="hljs-title function_">delete</span>(name))
      );
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>()) <span class="hljs-comment">// 强制所有打开的页面使用新 Worker</span>
  );
});
<span class="hljs-comment">// 3. 拦截请求：优先从缓存返回，无缓存则请求网络</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 仅拦截同源的 GET 请求（避免跨域资源和非幂等请求）</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-property">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; event.<span class="hljs-property">request</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">'same-origin'</span>) {
    event.<span class="hljs-title function_">respondWith</span>(
      caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cachedResponse</span> =&gt;</span> {
          <span class="hljs-comment">// 缓存命中：直接返回缓存资源</span>
          <span class="hljs-keyword">if</span> (cachedResponse) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'从缓存返回：'</span>, event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
            <span class="hljs-keyword">return</span> cachedResponse;
          }
          <span class="hljs-comment">// 缓存未命中：发起网络请求，并缓存新结果</span>
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkResponse</span> =&gt;</span> {
            caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
              cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, networkResponse.<span class="hljs-title function_">clone</span>()); <span class="hljs-comment">// 缓存新请求</span>
            });
            <span class="hljs-keyword">return</span> networkResponse;
          });
        })
    );
  }
});
</code></pre>
<p><strong>运行效果</strong>：</p>
<ul>
<li>首次联网时，自动缓存 index.html、styles.css 和 /api/data；</li>
</ul>

<ul>
<li>断网后刷新页面，仍能正常加载页面和 API 数据（从缓存读取）；</li>
</ul>

<ul>
<li>缓存版本更新时，自动清理旧缓存，避免资源冗余。</li>
</ul>
<h4 data-id="heading-7">4. Worklet（实时型：介入渲染流程）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>嵌入浏览器渲染管线（如 CSS 引擎线程、音频线程），低延迟（&lt;1ms）；</li>
</ul>

<ul>
<li>直接干预渲染过程（动画、绘制、音频处理），弥补 Web Worker 通信延迟的缺陷；</li>
</ul>

<ul>
<li>细分类型：CSSWorklet（动画）、AudioWorklet（音频）、PaintWorklet（绘制）。</li>
</ul>
<p><strong>示例：CSSWorklet 实现物理弹性动画</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 主线程（main.js）：注册 Worklet，关联动画</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'CSSWorklet'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 注册自定义 Worklet（加载动画逻辑脚本）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">CSSWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'bounce-worklet.js'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSSWorklet 注册成功'</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'CSSWorklet 注册失败：'</span>, err);
  }
}
<span class="hljs-comment">// HTML 结构：动画元素</span>
<span class="hljs-comment">/*
&lt;div class="box"&gt;弹性动画方块&lt;/div&gt;
*/</span>
<span class="hljs-comment">// CSS 样式：绑定 Worklet 动画</span>
<span class="hljs-comment">/*
.box {
  width: 100px;
  height: 100px;
  background: red;
  /* 使用 Worklet 定义的动画（名称与 Worklet 中注册一致） */</span>
  <span class="hljs-attr">animation</span>: bounce 2s infinite;
}
<span class="hljs-comment">/* 定义动画进度（from→to 对应 Worklet 中的 0→1） */</span>
<span class="hljs-meta">@keyframes</span> bounce {
  <span class="hljs-keyword">from</span> { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateY</span>(<span class="hljs-number">0</span>); }
  to { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateY</span>(300px); }
}
*/
<span class="hljs-comment">// CSSWorklet 线程（bounce-worklet.js）：自定义动画逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BounceWorklet</span> {
  <span class="hljs-comment">// 每一帧的计算（嵌入渲染管线，实时执行）</span>
  <span class="hljs-title function_">process</span>(<span class="hljs-params">inputs, outputs, parameters</span>) {
    <span class="hljs-keyword">const</span> [t] = inputs; <span class="hljs-comment">// 动画进度（0~1，from→to）</span>
    <span class="hljs-keyword">const</span> [output] = outputs; <span class="hljs-comment">// 输出结果（最终的 CSS 样式值）</span>
    
    <span class="hljs-comment">// 物理弹性公式（模拟重力+反弹效果，非匀速动画）</span>
    <span class="hljs-keyword">const</span> bounce = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(t * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(-t * <span class="hljs-number">0.5</span>);
    <span class="hljs-comment">// 输出 transform 样式（控制方块位置）</span>
    output.<span class="hljs-property">value</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${<span class="hljs-number">300</span> * (<span class="hljs-number">1</span> - bounce)}</span>px)`</span>;
  }
}
<span class="hljs-comment">// 注册 Worklet 动画（名称需与 CSS 中的 @keyframes 名称一致）</span>
<span class="hljs-title function_">registerAnimator</span>(<span class="hljs-string">'bounce'</span>, <span class="hljs-title class_">BounceWorklet</span>);
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>红色方块以 “物理弹性轨迹” 上下运动（类似小球落地反弹），动画流畅无卡顿；Worklet 运行在渲染线程，延迟极低，避免 Web Worker 通信导致的动画掉帧。</p>
<h3 data-id="heading-8">三、混合使用：多 Worker 协同解决复杂场景</h3>
<h4 data-id="heading-9">场景需求：离线数据分析 Dashboard</h4>
<p>需要同时满足 4 个核心需求：</p>
<ol>
<li>离线访问（断网后仍可查看历史数据）；</li>
</ol>

<ol start="2">
<li>多标签页同步分析结果（无需重复解析）；</li>
</ol>

<ol start="3">
<li>后台解析 10 万条 CSV 数据（不阻塞页面）；</li>
</ol>

<ol start="4">
<li>实时渲染流畅图表（动画无掉帧）。</li>
</ol>
<h4 data-id="heading-10">完整实现代码（整合 4 种 Worker）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（dashboard.js）：整合所有 Worker，协调流程</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 第一步：注册 Service Worker（离线缓存）</span>
      <span class="hljs-keyword">const</span> swRegistration = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功'</span>);
      <span class="hljs-comment">// 2. 第二步：创建 Shared Worker（多页面同步）</span>
      <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
      sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
      <span class="hljs-comment">// 3. 第三步：创建 Web Worker（CSV 数据解析）</span>
      <span class="hljs-keyword">const</span> csvWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'csv-worker.js'</span>);
      <span class="hljs-comment">// 4. 第四步：注册 CSSWorklet（图表动画优化）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'CSSWorklet'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">CSSWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'chart-worklet.js'</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSSWorklet 注册成功'</span>);
      }
      <span class="hljs-comment">// 5. 页面元素：文件上传、图表容器、状态文本</span>
      <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'file-upload'</span>);
      <span class="hljs-keyword">const</span> chartContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chart-container'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>);
      <span class="hljs-comment">// 6. 监听文件上传：触发 CSV 解析</span>
      fileInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> (file &amp;&amp; file.<span class="hljs-property">name</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.csv'</span>)) {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'正在解析 CSV 文件...'</span>;
          csvWorker.<span class="hljs-title function_">postMessage</span>(file); <span class="hljs-comment">// 发送文件给 Web Worker</span>
        } <span class="hljs-keyword">else</span> {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'请上传 CSV 格式文件！'</span>;
        }
      });
      <span class="hljs-comment">// 7. 接收 Web Worker 解析结果：渲染+同步+缓存</span>
      csvWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> analysisResult = e.<span class="hljs-property">data</span>; <span class="hljs-comment">// 解析结果（数据数组+统计信息）</span>
        
        <span class="hljs-comment">// 7.1 渲染图表（用 CSSWorklet 优化动画）</span>
        <span class="hljs-title function_">renderChart</span>(analysisResult, chartContainer);
        
        <span class="hljs-comment">// 7.2 同步结果到其他标签页（通过 Shared Worker）</span>
        sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'ANALYSIS_RESULT'</span>,
          <span class="hljs-attr">data</span>: analysisResult
        });
        
        <span class="hljs-comment">// 7.3 缓存结果到 Service Worker（支持离线访问）</span>
        <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>) {
          navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'CACHE_RESULT'</span>,
            <span class="hljs-attr">key</span>: <span class="hljs-string">'last-csv-analysis'</span>,
            <span class="hljs-attr">data</span>: analysisResult
          });
        }
        
        <span class="hljs-comment">// 7.4 更新状态文本</span>
        statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">`解析完成：共 <span class="hljs-subst">${analysisResult.totalCount}</span> 条&lt;/doubaocanvas&gt;
</span></code></pre>
<h3 data-id="heading-11">四、关于self</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 1. 来源：Worker 线程的内置全局对象，浏览器自动注入，无需定义</span>
<span class="hljs-comment">// 2. 作用：等同于主线程的 window，是 Worker 线程访问自身能力的入口</span>
<span class="hljs-comment">// 3. 隔离性：不同 Worker 的 self 是独立实例，互不干扰（如 Web Worker 的 self ≠ Service Worker 的 self）</span>
<span class="hljs-comment">// 4. 核心能力：接收/发送消息（onmessage/postMessage）、管理生命周期（close）、调用 Worker 专属 API</span>
</code></pre>
<h5 data-id="heading-12">Worker 中 self 的简单代码示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Worker 线程（calc-worker.js）</span>
<span class="hljs-comment">// self 指向当前 Web Worker 实例，仅用于计算相关逻辑</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { num1, num2 } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">const</span> sum = num1 + num2; <span class="hljs-comment">// 简单计算：两数相加</span>
  self.<span class="hljs-title function_">postMessage</span>(sum); <span class="hljs-comment">// 用 self 向主线程返回结果</span>
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 用 self 主动关闭 Worker，释放资源</span>
};
<span class="hljs-comment">// 主线程（main.js）- 配合使用</span>
<span class="hljs-keyword">const</span> calcWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'calc-worker.js'</span>);
calcWorker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">num1</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">num2</span>: <span class="hljs-number">20</span> }); <span class="hljs-comment">// 发数据给 Worker</span>
calcWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算结果：'</span>, e.<span class="hljs-property">data</span>); <span class="hljs-comment">// 输出 30</span>
};
</code></pre>
<h5 data-id="heading-13">注意：</h5>
<pre><code class="hljs language-lua" lang="lua">// 注意 <span class="hljs-number">1</span>：Worker 中不能用 window，必须用 <span class="hljs-built_in">self</span>（因 Worker 无窗口概念）
// 注意 <span class="hljs-number">2</span>：<span class="hljs-built_in">self</span> 无法访问 DOM（如 document、body），仅能处理非 UI 逻辑
// 注意 <span class="hljs-number">3</span>：简单场景可省略 <span class="hljs-built_in">self</span>（如 onmessage = () =&gt; {} 等同于 <span class="hljs-built_in">self</span>.onmessage = () =&gt; {}），但复杂场景建议保留，增强可读性
</code></pre>
<h3 data-id="heading-14">五、生产环境使用的平衡点</h3>
<h4 data-id="heading-15">1. 错误处理与健壮性</h4>
<ul>
<li>
<p>Worker 内部错误不会冒泡到主线程，需单独监听：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程</span>
worker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker错误：<span class="hljs-subst">${err.message}</span>`</span>);
  worker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 出错后销毁Worker，避免内存泄漏</span>
};

<span class="hljs-comment">// Worker线程</span>
self.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ERROR'</span>, <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> });
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 主动关闭</span>
};
</code></pre>
</li>
<li>
<p>网络错误：Worker 脚本加载失败（404）时，主线程会触发 <code>error</code> 事件，需捕获并降级处理。</p>
</li>
</ul>
<h4 data-id="heading-16">2. 内存管理与资源回收</h4>
<ul>
<li>避免创建过多 Worker：每个 Worker 都是独立线程，占用内存和 CPU，建议通过 “Worker 池” 复用（如用 <code>p-queue</code> 管理 Worker 实例）。</li>
<li>及时销毁无用 Worker：<code>worker.terminate()</code>（主线程主动销毁，立即终止）或 <code>self.close()</code>（Worker 主动关闭，清理后终止）。</li>
<li>警惕内存泄漏：Worker 中若持有 <code>setInterval</code>、未关闭的 <code>fetch</code> 请求等，即使调用 <code>terminate</code> 也可能导致内存泄漏，需先清理资源。</li>
</ul>
<h4 data-id="heading-17">3. 跨域与安全策略</h4>
<ul>
<li>Worker 脚本必须与主线程同源（协议、域名、端口一致），若需加载跨域脚本，需通过 <code>importScripts</code> 加载且服务器允许跨域（<code>Access-Control-Allow-Origin</code>）。</li>
<li>禁止访问 <code>file://</code> 协议下的脚本（浏览器安全限制），本地开发需用 <code>http-server</code> 启动服务。</li>
<li>敏感操作限制：Worker 中无法使用 <code>localStorage</code>（部分浏览器支持，但规范不推荐），建议用 <code>IndexedDB</code> 存储大量数据（异步 API，不阻塞）。</li>
</ul>
<h4 data-id="heading-18">4. 兼容性处理与降级方案</h4>
<ul>
<li>
<p>浏览器支持：IE 完全不支持，Edge 12+、Chrome 4+、Firefox 3.5+ 支持基本特性，<code>SharedArrayBuffer</code> 和 <code>SharedWorker</code> 兼容性较差。</p>
</li>
<li>
<p>降级逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">if (window.Worker) {
  <span class="hljs-comment">// 使用Worker</span>
} else {
  <span class="hljs-comment">// 降级到主线程执行（给用户提示“当前浏览器可能卡顿”）</span>
  <span class="hljs-built_in">heavyTask</span>();
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-19">六、性能陷阱</h3>
<ol>
<li>
<p><strong>过度使用 Worker 导致性能反降</strong>小数据计算（如几毫秒可完成的操作）用 Worker 反而会增加通信开销（序列化 + 消息传递），建议仅对 <strong>执行时间 &gt; 50ms</strong> 的任务使用 Worker。</p>
</li>
<li>
<p><strong>频繁通信导致主线程阻塞</strong>若 Worker 与主线程高频次 <code>postMessage</code>（如每秒 hundreds 次），序列化数据会占用主线程资源，导致卡顿。解决方案：</p>
<ul>
<li>批量发送数据（累计一定量后再通信）；</li>
<li>用 <code>SharedArrayBuffer</code> 减少序列化开销。</li>
</ul>
</li>
<li>
<p><strong>Worker 中滥用同步 API</strong>Worker 虽然不阻塞 UI，但内部的同步操作（如 <code>XMLHttpRequest</code> 的同步请求、大量同步循环）会阻塞自身线程，导致无法响应消息。建议优先使用异步 API（<code>fetch</code>、<code>setImmediate</code>）。</p>
</li>
<li>
<p><strong>忽略线程优先级</strong>浏览器会给 Worker 分配较低的线程优先级，若需 “近实时” 处理（如游戏帧计算），可能出现延迟。此时可考虑 <code>requestIdleCallback</code> 结合 Worker，利用主线程空闲时间处理。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！]]></title>    <link>https://juejin.cn/post/7571355146770481194</link>    <guid>https://juejin.cn/post/7571355146770481194</guid>    <pubDate>2025-11-12T01:04:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571355146770481194" data-draft-id="7559205383505526823" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！"/> <meta itemprop="keywords" content="Bun,Node.js,测试"/> <meta itemprop="datePublished" content="2025-11-12T01:04:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Legend80s"/> <meta itemprop="url" content="https://juejin.cn/user/2568105753839790"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bun Test 不支持时间快进？我用这招让单元测试提速 8 倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2568105753839790/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Legend80s
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:04:05.000Z" title="Wed Nov 12 2025 01:04:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>假设我们的组件或函数内使用了 <code>setInterval</code> (<code>setTimeout</code> 同理)，如果不对其进行任何操作，“傻傻等待”的话，一个单元测试可能就要耗费几秒钟才能完成，甚至还可能超时。</p>
<p>老牌的 jest 或新的 vitest 以及 node:test 原生都支持“时间快进”。但是 bun:test（v1.2.23 2025-10-10）尚未支持 <code>jest/vi.advanceTimersByTime</code>，将报错：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 快进1秒，触发1次 setInterval 回调</span>
<span class="hljs-number">37</span> |   vi.<span class="hljs-title function_">advanceTimersByTime</span>(<span class="hljs-number">1000</span>)
          ^
<span class="hljs-title class_">TypeError</span>: vi.<span class="hljs-property">advanceTimersByTime</span> is not a <span class="hljs-keyword">function</span>. (<span class="hljs-title class_">In</span> <span class="hljs-string">'vi.advanceTimersByTime(1000)'</span>, <span class="hljs-string">'vi.advanceTimersByTime'</span> is <span class="hljs-literal">undefined</span>)
</code></pre>
<p>难道只能“坐以待毙”？不，我们还有一种workaround。就是通过重写或者说 mock 全局 <code>setInterval / setTimeout</code>。</p>
<p>效果一睹为快：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8a359406d474f0095f2cf286b556703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVnZW5kODBz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763514245&amp;x-signature=BZpvpHv%2BJ5VZzyimXgBh%2FDk9A0M%3D" alt="成功将耗时从 2s+ 优化到 300ms+，是其 1/8" loading="lazy"/></p>
<h2 data-id="heading-0">解决办法：重写 <code>setInterval</code></h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src\DeepThinkButton\demo\advanced.test.tsx:</span>
<span class="hljs-keyword">import</span> { afterEach, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>

<span class="hljs-comment">// 1. 保存原始的 setInterval</span>
<span class="hljs-keyword">const</span> originalSetInterval = globalThis.<span class="hljs-property">setInterval</span>

<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在每个测试开始前启用假定时器</span>
  <span class="hljs-comment">// @ts-expect-error</span>
  globalThis.<span class="hljs-property">setInterval</span> = <span class="hljs-function">(<span class="hljs-params">callback, delay</span>) =&gt;</span> {
    <span class="hljs-comment">// console.log('callback, delay:', { callback, delay })</span>

    <span class="hljs-keyword">if</span> (callback.<span class="hljs-property">name</span> === <span class="hljs-string">'deepThinkButtonInterval'</span>) {
      <span class="hljs-comment">// 返回一个原始 ID，并且内部调用原始函数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">callback</span>()
      }, <span class="hljs-number">0</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(callback, delay)
    }
  }
})

<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在每个测试结束后恢复真定时器</span>
  globalThis.<span class="hljs-property">setInterval</span> = originalSetInterval
})
</code></pre>
<h3 data-id="heading-1">使用</h3>
<p>假设我们有如下待测试代码，测试深度思考功能：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 逐个字符显示，当完整内容显示后停止</span>
timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepThinkButtonInterval</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">setThinkContent</span>(<span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (text.<span class="hljs-property">length</span> &lt; <span class="hljs-variable constant_">THINK_CONTENT</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-comment">// 每次输出 N 个字符</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">THINK_CONTENT</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, text.<span class="hljs-property">length</span> + <span class="hljs-number">2</span>)
    }

    <span class="hljs-built_in">clearInterval</span>(timer)
    <span class="hljs-title function_">setThinkingStatus</span>(<span class="hljs-string">'Completed'</span>)
    <span class="hljs-title function_">setThinkingStopTime</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>())
    <span class="hljs-keyword">return</span> text
  })
}, <span class="hljs-number">20</span>)
</code></pre>
<p>执行</p>
<pre><code class="hljs language-ts" lang="ts">❯ bun test src/<span class="hljs-title class_">DeepThinkButton</span>/
</code></pre>
<p>正常情况耗时 2s+：</p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">2563.</span>00ms]
</code></pre>
<p>第一步修改待测试代码：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- timer = setInterval(() =&gt; {</span>
<span class="hljs-addition">+ timer = setInterval(function deepThinkButtonInterval() {</span>
</code></pre>
<p>也就是匿名函数改成具名函数，方便我们针对性 mock。</p>
<p>当我们给单测添加上述 mock 后，<strong>耗时减少到 1s+</strong>：</p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">1344.</span>00ms]
</code></pre>
<p>但其实我们还可以加速，即在一个 interval 回调中多次运行函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src\DeepThinkButton\demo\advanced.test.tsx:</span>
<span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 运行 6 次</span>
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
    <span class="hljs-title function_">callback</span>()
  }, <span class="hljs-number">0</span>)
</code></pre>
<p>可以看到又从 <strong>1s+ 优化到了 300ms+ ⚡️ ！</strong></p>
<pre><code class="hljs language-ts" lang="ts">✓ 自定义 icon、按钮尺寸，以及思考内容折叠后效果 [<span class="hljs-number">328.</span>00ms]
</code></pre>
<p>成功将耗时从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>s</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">2s+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord mathnormal">s</span><span class="mord">+</span></span></span></span></span> 优化到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>300</mn><mi>m</mi><mi>s</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">300ms+</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">300</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord">+</span></span></span></span></span>，是其 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mn>8</mn></mrow><annotation encoding="application/x-tex">1/8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1/8</span></span></span></span></span>！</p>
<h2 data-id="heading-2">重构</h2>
<p>目前只有一个 test case 还好，如果多个 case 需要则要避免违背 DRY 原则，所以接下来我们封装成函数。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// tests/utils.ts</span>
<span class="hljs-keyword">import</span> { afterEach, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">advanceInterval</span>(<span class="hljs-params">
  callbackName: <span class="hljs-built_in">string</span>,
  { ms = <span class="hljs-number">0</span>, batchCalledCount = <span class="hljs-number">1</span> }: { ms?: <span class="hljs-built_in">number</span>; batchCalledCount?: <span class="hljs-built_in">number</span> } = {},
</span>) {
  <span class="hljs-comment">// 1. 保存原始的 setInterval</span>
  <span class="hljs-keyword">const</span> originalSetInterval = globalThis.<span class="hljs-property">setInterval</span>

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在每个测试开始前启用假定时器</span>
    <span class="hljs-comment">// @ts-expect-error</span>
    globalThis.<span class="hljs-property">setInterval</span> = <span class="hljs-function">(<span class="hljs-params">callback, delay</span>) =&gt;</span> {
      <span class="hljs-comment">// 返回一个模拟的ID，或者调用原始函数</span>
      <span class="hljs-keyword">if</span> (callback.<span class="hljs-property">name</span> === callbackName) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; batchCalledCount; i++) {
            <span class="hljs-title function_">callback</span>()
          }
        }, ms)
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalSetInterval</span>(callback, delay)
      }
    }
  })

  <span class="hljs-title function_">afterEach</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 在每个测试结束后恢复真定时器</span>
    globalThis.<span class="hljs-property">setInterval</span> = originalSetInterval
  })
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-diff" lang="diff">// src/DeepThinkButton/demo/advanced.test.tsx
import React from 'react'
import { test, expect } from 'vitest'
import { render, screen, fireEvent } from '@testing-library/react'

import Demo from './advanced'
import { advanceInterval } from '@/tests/rtl'

<span class="hljs-addition">+ advanceInterval('deepThinkButtonInterval', { batchCalledCount: 6 })</span>

test('自定义 icon、按钮尺寸，以及思考内容折叠后效果', async () =&gt; {
  ...
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践]]></title>    <link>https://juejin.cn/post/7571379089991483446</link>    <guid>https://juejin.cn/post/7571379089991483446</guid>    <pubDate>2025-11-12T02:49:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089991483446" data-draft-id="7571334572769771563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践"/> <meta itemprop="keywords" content="前端,HTML,JavaScript"/> <meta itemprop="datePublished" content="2025-11-12T02:49:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏷️ HTML 属性参考 - 常用与全局属性的行为、兼容性与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T02:49:48.000Z" title="Wed Nov 12 2025 02:49:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🎯 <strong>学习目标</strong>：系统掌握HTML常用属性与全局属性的语义与行为，理解布尔/枚举属性的差异、跨源与安全相关属性的正确配置，并形成可落地的兼容性与可访问性最佳实践</p>
<p>📊 <strong>难度等级</strong>：初级-中级<br/>
🏷️ <strong>技术标签</strong>：<code>#HTML</code> <code>#属性</code> <code>#全局属性</code> <code>#布尔属性</code> <code>#data-*</code> <code>#ARIA</code> <code>#兼容性</code><br/>
⏱️ <strong>阅读时间</strong>：约9分钟</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🌟 引言</h2>
<p>HTML 的属性（attribute）决定了元素的语义、行为和表现。看似简单的 <code>disabled</code>、<code>contenteditable</code>、<code>hidden</code> 或 <code>data-*</code>，在不同的上下文与浏览器实现中却有不少差异：布尔属性是否需要写值？枚举属性有哪些合法取值？<code>crossorigin</code> 与 <code>integrity</code> 如何协同保障资源安全？这些问题若处理不当，会带来可访问性、性能甚至安全风险。</p>
<p>在日常的前端开发中，你是否遇到过这样的困扰：</p>
<ul>
<li>布尔属性写成 <code>disabled="false"</code> 仍然生效，导致交互异常；</li>
<li>滥用 <code>contenteditable</code> 造成键盘可访问性退化；</li>
<li>外链脚本未配置 SRI 与 CORS，被安全策略拦截或错误不透明；</li>
<li>图片懒加载与解码策略混用，出现首屏闪烁与布局抖动；</li>
</ul>
<p>今天分享 7 个「属性行为与最佳实践」核心技巧，帮你在开发中少踩坑、写出更稳妥的页面。</p>
<hr/>
<h2 data-id="heading-1">💡 核心技巧详解</h2>
<blockquote>
<p>📝 使用说明：本文选择 7 个最常用、最易混淆的属性主题进行讲解，每节均含场景、常见误区、推荐方案与要点。</p>
</blockquote>
<h3 data-id="heading-2">1. 全局属性速查：语义清晰、行为可控</h3>
<h4 data-id="heading-3">🔍 应用场景</h4>
<p>需要为元素添加标识与语义、调整方向与可编辑性、控制显示与拖拽能力等通用行为。</p>
<p>常见的全局属性包括：<code>id</code>、<code>class</code>、<code>title</code>、<code>lang</code>、<code>dir</code>、<code>hidden</code>、<code>draggable</code>、<code>contenteditable</code>。</p>
<h4 data-id="heading-4">❌ 常见问题</h4>
<ul>
<li>滥用 <code>id</code> 导致页面内唯一性被破坏；</li>
<li><code>dir</code>/<code>lang</code> 未设置，RTL/LTR 文本方向或语言识别错误；</li>
<li>非必要场景启用 <code>contenteditable</code>，可访问性与输入法体验变差；</li>
<li>用 <code>hidden</code> 替代逻辑卸载，产生无意义的可聚焦元素。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错示例：任意启用 contenteditable 与隐身元素可聚焦问题 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"card"</span> <span class="hljs-attr">hidden</span> <span class="hljs-attr">contenteditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"编辑卡片"</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：仅在明确编辑场景启用 contenteditable；按需设置语言与方向 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"profile"</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span> <span class="hljs-attr">dir</span>=<span class="hljs-string">"ltr"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"用户资料"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"profile__title"</span>&gt;</span>资料<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"profile__desc"</span>&gt;</span>可编辑区域仅限下面的备注。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"memo"</span> <span class="hljs-attr">contenteditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"编辑备注"</span>&gt;</span>在此添加备注...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 安全启用/关闭可编辑区域
 * <span class="hljs-doctag">@description</span> 根据布尔开关控制元素的 contenteditable 与可聚焦性
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">enable</span> - 是否启用可编辑
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleEditable</span> = (<span class="hljs-params">el, enable</span>) =&gt; {
  <span class="hljs-comment">// 仅在需要时才启用，避免全局滥用</span>
  el.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'contenteditable'</span>, enable ? <span class="hljs-string">'true'</span> : <span class="hljs-string">'false'</span>);
  el.<span class="hljs-property">tabIndex</span> = enable ? <span class="hljs-number">0</span> : -<span class="hljs-number">1</span>; <span class="hljs-comment">// 控制键盘可访问性</span>
};
</code></pre>
<h4 data-id="heading-6">💡 核心要点</h4>
<ul>
<li><code>id</code> 必须全页面唯一；</li>
<li>为文档或区域设置正确的 <code>lang</code> 与 <code>dir</code>；</li>
<li><code>hidden</code> 会将元素从可访问性树中移除（但仍在 DOM），用于暂时隐藏而非卸载；</li>
<li><code>contenteditable</code> 仅用于编辑场景，注意键盘与焦点管理。</li>
</ul>
<h4 data-id="heading-7">🎯 实际应用</h4>
<p>在富文本组件中，仅对编辑容器启用 <code>contenteditable</code>，同时结合 <code>aria-label</code> 与键盘导航提示改善可访问性。</p>
<hr/>
<h3 data-id="heading-8">2. 布尔属性行为：存在即为真，值会被忽略</h3>
<h4 data-id="heading-9">🔍 应用场景</h4>
<p>控制交互状态，如禁用、自动聚焦、必填、隐藏等：<code>disabled</code>、<code>autofocus</code>、<code>required</code>、<code>hidden</code>、<code>checked</code>。</p>
<h4 data-id="heading-10">❌ 常见问题</h4>
<ul>
<li>写成 <code>disabled="false"</code> 仍然是禁用；</li>
<li>将布尔属性赋为字符串，误以为可关闭行为；</li>
<li>误用 <code>autofocus</code> 影响无障碍体验（页面初始焦点跳跃）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错示例：disabled="false" 仍然禁用 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">"false"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：通过属性存在性表达布尔含义；JS 控制用 property 更直观 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"submitBtn"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 切换布尔属性：存在即为真
 * <span class="hljs-doctag">@description</span> 使用 property 控制更直观，避免字符串赋值歧义
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLButtonElement</span>} <span class="hljs-variable">btn</span> - 目标按钮
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">disabled</span> - 是否禁用
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setDisabled</span> = (<span class="hljs-params">btn, disabled</span>) =&gt; {
  btn.<span class="hljs-property">disabled</span> = disabled; <span class="hljs-comment">// 使用 property 代替 setAttribute('disabled', 'false')</span>
};

<span class="hljs-comment">/**
 * 初始化页面焦点
 * <span class="hljs-doctag">@description</span> 谨慎使用 autofocus，优先在脚本中设定初始焦点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">target</span> - 需要获得焦点的元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">initFocus</span> = (<span class="hljs-params">target</span>) =&gt; {
  target.<span class="hljs-title function_">focus</span>(); <span class="hljs-comment">// 统一在脚本中管理初始焦点</span>
};
</code></pre>
<h4 data-id="heading-12">💡 核心要点</h4>
<ul>
<li>布尔属性仅凭「存在」即可生效，属性值通常被忽略；</li>
<li>在 JS 中优先使用 property（如 <code>el.disabled = true</code>），更直观也更兼容；</li>
<li>避免在初始加载阶段使用 <code>autofocus</code> 影响读屏与键盘用户。</li>
</ul>
<h4 data-id="heading-13">🎯 实际应用</h4>
<p>表单组件库中统一封装 <code>disabled</code> 控制逻辑，所有按钮与输入框采用 property 控制，避免属性字符串误用。</p>
<hr/>
<h3 data-id="heading-14">3. 枚举属性：合法取值与默认行为</h3>
<h4 data-id="heading-15">🔍 应用场景</h4>
<p>控制策略选择或行为方式：<code>loading</code>（img：<code>auto</code>/<code>lazy</code>/<code>eager</code>）、<code>decoding</code>（img：<code>sync</code>/<code>async</code>/<code>auto</code>）、<code>crossorigin</code>（<code>anonymous</code>/<code>use-credentials</code>）、<code>autocomplete</code>（多枚举值）。</p>
<h4 data-id="heading-16">❌ 常见问题</h4>
<ul>
<li>写入不合法取值被忽略，导致行为回退到默认；</li>
<li>不了解默认值，造成性能或兼容性问题（如图片解码抖动）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：不合法取值将被忽略，退回默认行为 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/hero.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"fast"</span> <span class="hljs-attr">decoding</span>=<span class="hljs-string">"quick"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-17">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 合法取值：lazy 与 async 可配合减少首屏抖动 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/img/hero.jpg"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">decoding</span>=<span class="hljs-string">"async"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 规范化枚举属性取值
 * <span class="hljs-doctag">@description</span> 保证属性在合法集合内，否则回退到安全默认
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">name</span> - 枚举属性名
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">allowed</span> - 合法取值集合
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">value</span> - 待设置的值
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setEnumAttr</span> = (<span class="hljs-params">el, name, allowed, value</span>) =&gt; {
  <span class="hljs-keyword">const</span> v = allowed.<span class="hljs-title function_">includes</span>(value) ? value : allowed[<span class="hljs-number">0</span>];
  el.<span class="hljs-title function_">setAttribute</span>(name, v);
};
</code></pre>
<h4 data-id="heading-18">💡 核心要点</h4>
<ul>
<li>明确每个枚举属性的合法取值集合与默认值；</li>
<li>图片建议 <code>loading="lazy"</code> + <code>decoding="async"</code>，减少阻塞与抖动；</li>
<li>跨源枚举值仅限 <code>anonymous</code> 与 <code>use-credentials</code>，影响资源请求与错误可见性。</li>
</ul>
<h4 data-id="heading-19">🎯 实际应用</h4>
<p>资源管理组件统一通过枚举校验函数设置 <code>loading</code>/<code>decoding</code>，确保配置合法与表现稳定。</p>
<hr/>
<h3 data-id="heading-20">4. 数据属性 data-* 与 dataset：结构化携带业务数据</h3>
<h4 data-id="heading-21">🔍 应用场景</h4>
<p>在不污染语义的前提下，为元素附加结构化元数据，配合脚本读取与更新。</p>
<h4 data-id="heading-22">❌ 常见问题</h4>
<ul>
<li>将业务状态塞进 <code>class</code>/<code>id</code>，难以维护；</li>
<li>用 <code>innerHTML</code> 拼字符串读取数据，易遭XSS风险。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：用 class/id 存业务状态，耦合样式与脚本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"order_1234"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn processing"</span>&gt;</span>下单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-23">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：使用 data-* 描述元数据，脚本通过 dataset 读取/更新 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"orderBtn"</span> <span class="hljs-attr">data-order-id</span>=<span class="hljs-string">"1234"</span> <span class="hljs-attr">data-state</span>=<span class="hljs-string">"processing"</span>&gt;</span>下单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 读取并更新 dataset
 * <span class="hljs-doctag">@description</span> 通过 dataset 读取/写入 data-*，保持结构化与安全
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 目标元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">{orderId:string,state:string</span>}}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useDataset</span> = (<span class="hljs-params">el</span>) =&gt; {
  <span class="hljs-keyword">const</span> { orderId, state } = el.<span class="hljs-property">dataset</span>;
  <span class="hljs-comment">// 更新状态为已完成</span>
  el.<span class="hljs-property">dataset</span>.<span class="hljs-property">state</span> = <span class="hljs-string">'done'</span>;
  <span class="hljs-keyword">return</span> { orderId, state };
};
</code></pre>
<h4 data-id="heading-24">💡 核心要点</h4>
<ul>
<li><code>data-*</code> 值始终是字符串；复杂数据请用 JSON 并在脚本中解析；</li>
<li>读取使用 <code>el.dataset.xxx</code>（自动将 <code>data-xxx</code> 转驼峰）；</li>
<li>避免将视觉样式与业务状态耦合在 <code>class</code>/<code>id</code>。</li>
</ul>
<h4 data-id="heading-25">🎯 实际应用</h4>
<p>在列表项中用 <code>data-id</code>/<code>data-type</code> 附加元数据，事件委托时通过 <code>dataset</code> 精确识别目标项。</p>
<hr/>
<h3 data-id="heading-26">5. 表单属性最佳实践：可用性与安全</h3>
<h4 data-id="heading-27">🔍 应用场景</h4>
<p>文件选择与拍照、自动完成功能、输入合法性：<code>accept</code>、<code>capture</code>、<code>autocomplete</code>、<code>required</code> 等。</p>
<h4 data-id="heading-28">❌ 常见问题</h4>
<ul>
<li><code>accept</code> 写错 MIME/扩展名，导致系统选择器无法过滤；</li>
<li><code>capture</code> 盲目开启，移动端直接拉起摄像头影响体验；</li>
<li><code>autocomplete</code> 未按枚举值配置，自动填充失败或扰民。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：accept 写错扩展名或缺少 MIME --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/jpg"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-29">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 推荐：精确的 MIME 或扩展名；按需配置 capture 与 autocomplete --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fileInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/jpeg,image/png"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cameraInput"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span> <span class="hljs-attr">capture</span>=<span class="hljs-string">"environment"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">autocomplete</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">required</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 校验文件选择类型
 * <span class="hljs-doctag">@description</span> 检查文件扩展名是否符合 accept 策略
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">File</span>} <span class="hljs-variable">file</span> - 用户选择的文件
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否通过校验
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">validateFileType</span> = (<span class="hljs-params">file</span>) =&gt; {
  <span class="hljs-keyword">const</span> ok = <span class="hljs-regexp">/(jpe?g|png)$/i</span>.<span class="hljs-title function_">test</span>(file.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">return</span> ok;
};
</code></pre>
<h4 data-id="heading-30">💡 核心要点</h4>
<ul>
<li><code>accept</code> 建议使用 MIME 类型（更通用）+ 扩展名兜底；</li>
<li>移动端谨慎使用 <code>capture</code>，为用户保留从相册选择的路径；</li>
<li><code>autocomplete</code> 使用标准枚举取值提升可用性与安全（如 <code>email</code>、<code>username</code>、<code>current-password</code>）。</li>
</ul>
<h4 data-id="heading-31">🎯 实际应用</h4>
<p>上传组件在客户端先做轻量类型校验，失败时不触发网络请求，减少后端压力与无效流量。</p>
<hr/>
<h3 data-id="heading-32">6. 跨源与安全属性：<code>crossorigin</code>、<code>integrity</code>、<code>referrerpolicy</code></h3>
<h4 data-id="heading-33">🔍 应用场景</h4>
<p>外链脚本/样式/图片资源的安全与错误透明化，CDN 资源加载。</p>
<h4 data-id="heading-34">❌ 常见问题</h4>
<ul>
<li>使用 SRI（<code>integrity</code>）却未设置匹配的 CORS（<code>crossorigin</code>），导致校验失败或错误不可见；</li>
<li>未配置 <code>referrerpolicy</code>，敏感页面泄露来源信息。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：SRI 未配合 CORS，可能导致资源校验失败或错误信息被隐藏 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/app.min.js"</span> <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-..."</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h4 data-id="heading-35">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ SRI + CORS 协同；可按需设置 referrerpolicy --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/app.min.js"</span>
  <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-..."</span>
  <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
  <span class="hljs-attr">referrerpolicy</span>=<span class="hljs-string">"no-referrer"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 校验跨源配置是否完整
 * <span class="hljs-doctag">@description</span> 简单检查元素是否同时具备 integrity 与合适的 crossorigin
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLScriptElement</span>} <span class="hljs-variable">el</span> - 外链脚本元素
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否满足基本安全配置
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">checkCrossOriginSafety</span> = (<span class="hljs-params">el</span>) =&gt; {
  <span class="hljs-keyword">const</span> hasSRI = !!el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'integrity'</span>);
  <span class="hljs-keyword">const</span> co = el.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'crossorigin'</span>);
  <span class="hljs-keyword">const</span> ok = hasSRI &amp;&amp; (co === <span class="hljs-string">'anonymous'</span> || co === <span class="hljs-string">'use-credentials'</span>);
  <span class="hljs-keyword">return</span> ok;
};
</code></pre>
<h4 data-id="heading-36">💡 核心要点</h4>
<ul>
<li>SRI 要与 <code>crossorigin</code> 协同；</li>
<li><code>referrerpolicy</code> 根据场景合理配置（如下载页可用 <code>no-referrer</code>）；</li>
<li>了解错误可见性：跨源脚本在无 CORS 时错误堆栈受限。</li>
</ul>
<h4 data-id="heading-37">🎯 实际应用</h4>
<p>CDN 资源统一模板化：所有外链脚本/样式自动附加 <code>integrity</code> 与 <code>crossorigin</code>，并提供策略位可配置 <code>referrerpolicy</code>。</p>
<hr/>
<h3 data-id="heading-38">7. 可访问性与 ARIA：属性与角色的协同</h3>
<h4 data-id="heading-39">🔍 应用场景</h4>
<p>自定义组件（如伪按钮、可折叠区域）需要通过 <code>role</code> 与 <code>aria-*</code> 提升语义与可操作性。</p>
<h4 data-id="heading-40">❌ 常见问题</h4>
<ul>
<li>仅靠 <code>div</code> + 点击事件充当按钮，键盘用户无法操作；</li>
<li>误用 <code>aria-*</code> 与原生属性冲突（如对 <code>&lt;button&gt;</code> 重复声明 <code>role="button"</code>）。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ❌ 易错：无键盘可访问性与语义缺失 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"doLike()"</span>&gt;</span>点赞<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-41">✅ 推荐方案</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ✅ 使用 role 与 aria-* 改善语义与交互；同时处理键盘事件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"like"</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"点赞"</span> <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>&gt;</span>点赞<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 为伪按钮添加键盘可访问性
 * <span class="hljs-doctag">@description</span> 处理 Enter/Space 键以触发点击行为
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">el</span> - 伪按钮元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">() =&gt; void</span>} <span class="hljs-variable">onActive</span> - 激活时的回调
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">enhancePseudoButton</span> = (<span class="hljs-params">el, onActive</span>) =&gt; {
  el.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> k = e.<span class="hljs-property">key</span>;
    <span class="hljs-keyword">if</span> (k === <span class="hljs-string">'Enter'</span> || k === <span class="hljs-string">' '</span>) {
      e.<span class="hljs-title function_">preventDefault</span>();
      <span class="hljs-title function_">onActive</span>();
    }
  });
};
</code></pre>
<h4 data-id="heading-42">💡 核心要点</h4>
<ul>
<li>原生控件优先（<code>&lt;button&gt;</code>、<code>&lt;a&gt;</code> 等）；若必须自定义，再使用 <code>role</code> 与 <code>aria-*</code>；</li>
<li>始终为可交互元素提供键盘等效操作；</li>
<li>避免与原生属性冲突的冗余 <code>role</code> 声明。</li>
</ul>
<h4 data-id="heading-43">🎯 实际应用</h4>
<p>在卡片组件的可折叠区域使用 <code>aria-expanded</code> 与键盘事件，保证读屏与键盘用户体验一致。</p>
<hr/>
<h2 data-id="heading-44">📊 技巧对比总结</h2>





















































<table><thead><tr><th>技巧</th><th>使用场景</th><th>优势</th><th>注意事项</th></tr></thead><tbody><tr><td>全局属性速查</td><td>元素语义与行为</td><td>统一管理 <code>lang/dir</code> 与编辑性</td><td>慎用 <code>contenteditable</code> 与 <code>hidden</code></td></tr><tr><td>布尔属性行为</td><td>交互禁用/焦点</td><td>property 控制直观兼容</td><td>避免 <code>autofocus</code> 影响可访问性</td></tr><tr><td>枚举属性</td><td>资源加载与策略</td><td>明确合法取值与默认值</td><td><code>crossorigin</code> 仅两种取值</td></tr><tr><td>data-* 与 dataset</td><td>携带元数据</td><td>结构化与安全</td><td>值为字符串，复杂用 JSON</td></tr><tr><td>表单属性</td><td>文件与自动填充</td><td>可用性与安全</td><td>谨慎 <code>capture</code>，精确 <code>accept</code></td></tr><tr><td>跨源与安全</td><td>外链资源</td><td>SRI + CORS 协同</td><td>错误可见性受跨源影响</td></tr><tr><td>ARIA 可访问性</td><td>自定义组件</td><td>语义与键盘可用性</td><td>避免与原生属性冲突</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-45">🎯 实战应用建议</h2>
<h3 data-id="heading-46">最佳实践</h3>
<ol>
<li>全局启用文档 <code>lang</code> 与合理的 <code>dir</code> 配置，国际化场景更稳。</li>
<li>统一封装布尔属性控制，全部走 property（<code>el.disabled = true</code>）。</li>
<li>图片使用 <code>loading="lazy"</code> + <code>decoding="async"</code>，减少首屏阻塞与抖动。</li>
<li>业务元数据统一使用 <code>data-*</code>，避免与样式耦合。</li>
<li>表单的 <code>accept/capture/autocomplete</code> 按枚举规范配置，兼顾体验与安全。</li>
<li>外链资源模板化 SRI + CORS，必要时加 <code>referrerpolicy</code>，保障安全与隐私。</li>
</ol>
<h3 data-id="heading-47">性能考虑</h3>
<ul>
<li>图片与媒体优先使用懒加载与异步解码；</li>
<li>减少不必要的可编辑区域与聚焦跳转；</li>
<li>外链资源开启校验与跨源配置，降低失败成本并提升错误可见性。</li>
</ul>
<hr/>
<h2 data-id="heading-48">💡 总结</h2>
<p>这 7 个属性主题覆盖了日常开发中最常见且最易混淆的行为。掌握它们能让你的页面：</p>
<ol>
<li>更语义化、可访问；</li>
<li>更可控、少踩坑；</li>
<li>更安全、可观测；</li>
<li>更稳定、高性能。</li>
</ol>
<hr/>
<h2 data-id="heading-49">🔗 相关资源</h2>
<ul>
<li>MDN: HTML attribute reference — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FAttributes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: Global attributes — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FGlobal_attributes" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: ARIA roles, states and properties — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAccessibility%2FARIA" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Accessibility/ARIA" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
<li>MDN: Subresource Integrity (SRI) — <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FSubresource_Integrity" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity" ref="nofollow noopener noreferrer">developer.mozilla.org/en-US/docs/…</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 今日收获：理解了布尔与枚举属性的差异、data-* 的安全用法与跨源安全配置的关键点，能够在项目中落地更稳妥的属性策略。</p>
</blockquote>
<p><strong>如果这篇文章对你有帮助，欢迎点赞、收藏和分享！有任何问题也欢迎在评论区讨论。</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制]]></title>    <link>https://juejin.cn/post/7571351275976605747</link>    <guid>https://juejin.cn/post/7571351275976605747</guid>    <pubDate>2025-11-12T00:21:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571351275976605747" data-draft-id="7571352754896437274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制"/> <meta itemprop="keywords" content="后端,Python,IPython"/> <meta itemprop="datePublished" content="2025-11-12T00:21:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python编程实战 - Python实用工具与库 - 爬虫防封与代理机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T00:21:57.000Z" title="Wed Nov 12 2025 00:21:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在进行网页爬取时，如果频繁访问同一网站，极有可能被网站识别为爬虫，从而封禁 IP 或要求验证码验证。
为了保证爬虫稳定、高效运行，我们需要了解并掌握 <strong>防封机制与代理使用方法</strong>。</p>
</blockquote>
<p>本章将介绍 Python 爬虫中常用的防封策略、代理原理及实战应用技巧。</p>
<hr/>
<h2 data-id="heading-0">一、为什么会被封</h2>
<p>网站封禁爬虫主要是为了防止资源滥用与服务器过载。常见的封禁手段包括：</p>
<ol>
<li><strong>IP 封禁</strong>：短时间内请求频繁，直接拉黑访问 IP。</li>
<li><strong>User-Agent 检测</strong>：识别请求头中是否包含浏览器标识。</li>
<li><strong>Referer 检查</strong>：判断请求是否来自正常页面跳转。</li>
<li><strong>Cookie 校验</strong>：验证登录状态或访问来源。</li>
<li><strong>请求频率限制</strong>：同一用户短时间内过多请求触发反爬。</li>
</ol>
<p>要应对这些情况，我们可以从 <strong>“伪装自己”</strong> 和 <strong>“多IP访问”</strong> 两个方向入手。</p>
<hr/>
<h2 data-id="heading-1">二、请求伪装：模拟真实用户访问</h2>
<h3 data-id="heading-2">1. 设置请求头</h3>
<p><code>requests</code> 支持通过 <code>headers</code> 参数自定义请求头。
常见做法是添加浏览器信息，让服务器认为请求来自正常用户。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">"https://example.com"</span>
headers = {
    <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span>
                  <span class="hljs-string">"AppleWebKit/537.36 (KHTML, like Gecko) "</span>
                  <span class="hljs-string">"Chrome/122.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Referer"</span>: <span class="hljs-string">"https://www.google.com"</span>,
}
response = requests.get(url, headers=headers)
<span class="hljs-built_in">print</span>(response.status_code)
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 随机切换 User-Agent</h3>
<p>为了避免单一 User-Agent 被识别为爬虫，可以在请求中随机切换浏览器标识。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> random

user_agents = [
    <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/123.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) Firefox/124.0"</span>,
    <span class="hljs-string">"Mozilla/5.0 (Linux; Android 10) Mobile Safari/537.36"</span>,
]

headers = {<span class="hljs-string">"User-Agent"</span>: random.choice(user_agents)}
</code></pre>
<p>每次访问时随机选择一个头部，能有效减少被识别风险。</p>
<hr/>
<h3 data-id="heading-4">3. 添加延时与随机等待</h3>
<p>频繁访问网站最容易触发风控。
合理的做法是添加访问间隔，并随机化等待时间：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> random

time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))  <span class="hljs-comment"># 等待1~3秒</span>
</code></pre>
<p>这样能让访问节奏更像人类操作。</p>
<hr/>
<h2 data-id="heading-5">三、使用代理服务器（Proxy）</h2>
<p>当 IP 被封时，使用代理服务器可以切换出口 IP，从而继续访问。</p>
<p>代理服务器会代替你访问目标网站，然后将结果返回。
Python 中可以通过 <code>requests</code> 轻松使用代理。</p>
<hr/>
<h3 data-id="heading-6">1. 设置代理参数</h3>
<pre><code class="hljs language-python" lang="python">proxies = {
    <span class="hljs-string">"http"</span>: <span class="hljs-string">"http://123.45.67.89:8080"</span>,
    <span class="hljs-string">"https"</span>: <span class="hljs-string">"http://123.45.67.89:8080"</span>,
}

response = requests.get(<span class="hljs-string">"https://httpbin.org/ip"</span>, proxies=proxies, timeout=<span class="hljs-number">10</span>)
<span class="hljs-built_in">print</span>(response.text)
</code></pre>
<p>如果代理有效，返回的 IP 将与本机不同。</p>
<hr/>
<h3 data-id="heading-7">2. 使用代理池（Proxy Pool）</h3>
<p>手动设置代理不方便，可以使用 <strong>代理池</strong> 自动随机选取可用代理。</p>
<p>简单示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> time

proxies_list = [
    <span class="hljs-string">"http://111.22.33.44:8080"</span>,
    <span class="hljs-string">"http://222.11.55.66:8888"</span>,
    <span class="hljs-string">"http://77.88.99.100:3128"</span>,
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_random_proxy</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"http"</span>: random.choice(proxies_list), <span class="hljs-string">"https"</span>: random.choice(proxies_list)}

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    proxy = get_random_proxy()
    <span class="hljs-keyword">try</span>:
        res = requests.get(<span class="hljs-string">"https://httpbin.org/ip"</span>, proxies=proxy, timeout=<span class="hljs-number">5</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"使用代理 <span class="hljs-subst">{proxy[<span class="hljs-string">'http'</span>]}</span> -&gt; <span class="hljs-subst">{res.json()}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"代理失效："</span>, e)
    time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 购买或搭建代理池</h3>
<p>免费代理常常不稳定，建议：</p>
<ul>
<li>使用付费代理服务（如芝麻代理、快代理等）。</li>
<li>自行搭建代理池服务，结合 Redis 存储和自动检测可用 IP。</li>
</ul>
<p>一个简单的代理池架构：</p>
<pre><code class="hljs">爬虫程序 → 请求代理池接口 → 返回可用代理 → 访问目标网站
代理池后台 → 定期检测代理可用性 → 清理无效IP
</code></pre>
<hr/>
<h2 data-id="heading-9">四、Cookie 与会话保持</h2>
<p>某些网站需要登录才能访问数据，这时需要处理 <strong>Cookie</strong>。
可以使用 <code>requests.Session()</code> 自动保持会话状态。</p>
<pre><code class="hljs language-python" lang="python">session = requests.Session()
login_url = <span class="hljs-string">"https://example.com/login"</span>
payload = {<span class="hljs-string">"username"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"password"</span>: <span class="hljs-string">"pass"</span>}
session.post(login_url, data=payload)

<span class="hljs-comment"># 登录成功后继续访问页面</span>
resp = session.get(<span class="hljs-string">"https://example.com/user/profile"</span>)
<span class="hljs-built_in">print</span>(resp.text)
</code></pre>
<p><code>Session</code> 会自动保存登录后的 Cookie 信息，避免每次请求重新认证。</p>
<hr/>
<h2 data-id="heading-10">五、验证码与高级防爬</h2>
<p>有的网站会要求输入验证码或 JavaScript 加密验证请求。
常见应对思路包括：</p>
<ol>
<li><strong>人工辅助识别</strong>：遇到验证码暂停爬取，手动输入。</li>
<li><strong>OCR 识别验证码</strong>：通过 <code>pytesseract</code> 识别简单图片验证码。</li>
<li><strong>模拟浏览器行为</strong>：使用 <code>selenium</code> 或 <code>playwright</code> 执行网页中的 JS 逻辑。</li>
</ol>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver

driver = webdriver.Chrome()
driver.get(<span class="hljs-string">"https://example.com"</span>)
<span class="hljs-built_in">print</span>(driver.title)
driver.quit()
</code></pre>
<p>这种方式能绕过大部分基于 JS 渲染或验证的防爬机制。</p>
<hr/>
<h2 data-id="heading-11">六、异常与重试机制</h2>
<p>网络请求容易超时或失败，建议添加异常重试机制。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_request</span>(<span class="hljs-params">url, retries=<span class="hljs-number">3</span></span>):
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(retries):
        <span class="hljs-keyword">try</span>:
            res = requests.get(url, timeout=<span class="hljs-number">10</span>)
            <span class="hljs-keyword">if</span> res.status_code == <span class="hljs-number">200</span>:
                <span class="hljs-keyword">return</span> res.text
        <span class="hljs-keyword">except</span> requests.RequestException:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 次请求失败，重试中..."</span>)
            time.sleep(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">七、综合实战示例</h2>
<p>综合以上技巧，我们可以实现一个稳定、抗封的爬虫：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests, random, time

headers_list = [
    {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 Chrome/122.0.0.0"</span>},
    {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 Firefox/124.0"</span>},
]
proxies_list = [
    <span class="hljs-string">"http://123.45.67.89:8080"</span>,
    <span class="hljs-string">"http://222.111.55.66:8888"</span>
]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">url</span>):
    headers = random.choice(headers_list)
    proxy = {<span class="hljs-string">"http"</span>: random.choice(proxies_list), <span class="hljs-string">"https"</span>: random.choice(proxies_list)}
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, headers=headers, proxies=proxy, timeout=<span class="hljs-number">10</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问成功："</span>, response.status_code, <span class="hljs-string">"IP："</span>, proxy)
        <span class="hljs-keyword">return</span> response.text
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问失败："</span>, e)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    html = fetch(<span class="hljs-string">"https://httpbin.org/ip"</span>)
    time.sleep(random.uniform(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>))
</code></pre>
<hr/>
<h2 data-id="heading-13">八、总结</h2>

































<table><thead><tr><th>策略</th><th>说明</th></tr></thead><tbody><tr><td><strong>请求伪装</strong></td><td>设置随机 User-Agent、Referer 等头信息</td></tr><tr><td><strong>请求间隔控制</strong></td><td>使用随机延时，模拟真实用户行为</td></tr><tr><td><strong>代理机制</strong></td><td>通过代理IP切换访问来源</td></tr><tr><td><strong>会话保持</strong></td><td>使用 Session 管理登录状态</td></tr><tr><td><strong>异常重试</strong></td><td>防止临时网络错误导致程序中断</td></tr><tr><td><strong>浏览器模拟</strong></td><td>处理验证码或动态渲染内容</td></tr></tbody></table>
<hr/>
<p>通过合理运用这些防封策略与代理机制，你的 Python 爬虫将更稳定、更高效、更接近真实用户访问行为，为后续数据采集与分析奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 useState 到 URLState：前端状态管理的另一种思路]]></title>    <link>https://juejin.cn/post/7571306072423628842</link>    <guid>https://juejin.cn/post/7571306072423628842</guid>    <pubDate>2025-11-12T01:09:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571306072423628842" data-draft-id="7571306072423612458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 useState 到 URLState：前端状态管理的另一种思路"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2025-11-12T01:09:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宇余"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453424542"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 useState 到 URLState：前端状态管理的另一种思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453424542/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宇余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T01:09:56.000Z" title="Wed Nov 12 2025 01:09:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 React 开发中，<code>useState</code> 是我们最常用的状态管理工具之一。它轻量、直观，能满足大多数组件级状态管理需求。但在某些场景下，比如列表筛选、分页、多页面共享状态时，单纯使用 <code>useState</code> 会遇到状态丢失、刷新页面重置等问题。这时候，<strong>URLState</strong> 或许是一个更优雅的解决方案。</p>
<h2 data-id="heading-0">一、useState 的「痛点」场景</h2>
<p>先来看一个常见的业务场景：实现一个带筛选功能的商品列表页，包含「价格区间」「分类」「排序方式」三个筛选条件。用 <code>useState</code> 实现的代码可能是这样的：</p>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 筛选状态</span>
  <span class="hljs-keyword">const</span> [priceRange, setPriceRange] = <span class="hljs-title function_">useState</span>([<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>]);
  <span class="hljs-keyword">const</span> [category, setCategory] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'all'</span>);
  <span class="hljs-keyword">const</span> [sortBy, setSortBy] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'price-asc'</span>);

  <span class="hljs-comment">// 筛选逻辑...</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FilterPanel</span> 
        <span class="hljs-attr">priceRange</span>=<span class="hljs-string">{priceRange}</span>
        <span class="hljs-attr">onPriceRangeChange</span>=<span class="hljs-string">{setPriceRange}</span>
        <span class="hljs-attr">category</span>=<span class="hljs-string">{category}</span>
        <span class="hljs-attr">onCategoryChange</span>=<span class="hljs-string">{setCategory}</span>
        <span class="hljs-attr">sortBy</span>=<span class="hljs-string">{sortBy}</span>
        <span class="hljs-attr">onSortByChange</span>=<span class="hljs-string">{setSortBy}</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductGrid</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这段代码看似没问题，但存在三个明显痛点：</p>
<ul>
<li>
<p><strong>页面刷新状态丢失</strong>：用户筛选后刷新页面，所有筛选条件会重置为初始值，体验极差。</p>
</li>
<li>
<p><strong>状态无法共享</strong>：如果需要在其他页面（比如商品详情页）回退到筛选后的列表，无法携带筛选状态。</p>
</li>
<li>
<p><strong>无法书签/分享</strong>：用户想把筛选后的结果分享给同事，复制链接过去是未筛选的初始状态。</p>
</li>
</ul>
<h2 data-id="heading-1">二、什么是 URLState？为什么要用它？</h2>
<p><strong>URLState</strong> 是将应用状态存储在 URL 查询参数（Query String）中的状态管理方式。比如上面的筛选场景，使用 URLState 后，URL 可能变成这样：</p>
<pre><code class="hljs language-Plain" lang="Plain">
https://example.com/products?price=0-1000&amp;category=electronics&amp;sort=price-asc
</code></pre>
<p>这种方式的核心优势在于：</p>
<ul>
<li>
<p>「刷新不丢状态」：URL 是浏览器的持久化载体，刷新页面参数不会消失。</p>
</li>
<li>
<p>「天然可共享」：复制 URL 即可分享当前状态，支持书签保存。</p>
</li>
<li>
<p>「跨页传参简单」：不同页面间通过 URL 即可传递状态，无需依赖全局状态库。</p>
</li>
<li>
<p>「可回溯」：浏览器的前进/后退按钮能直接回溯状态变更历史。</p>
</li>
</ul>
<h2 data-id="heading-2">三、实现 URLState：自定义 useURLState Hook</h2>
<p>其实 URLState 的实现并不复杂，核心是通过 <code>URLSearchParams</code> 操作查询参数，并结合 React 的状态更新机制。下面我们封装一个通用的 <code>useURLState</code> Hook。</p>
<h3 data-id="heading-3">3.1 核心逻辑拆解</h3>
<ol>
<li>
<p>从 URL 中解析初始状态：通过 <code>new URLSearchParams(window.location.search)</code> 获取查询参数。</p>
</li>
<li>
<p>定义状态更新函数：修改状态时，同步更新 URL（使用 <code>history.pushState</code> 避免页面刷新）。</p>
</li>
<li>
<p>监听 URL 变化：当用户通过前进/后退按钮切换历史记录时，同步更新组件状态。</p>
</li>
</ol>
<h3 data-id="heading-4">3.2 完整实现代码</h3>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useState, useEffect, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useURLState</span>(<span class="hljs-params">initialState = {}</span>) {
  <span class="hljs-comment">// 从 URL 解析状态</span>
  <span class="hljs-keyword">const</span> parseURLState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
    <span class="hljs-keyword">const</span> state = {};
    
    <span class="hljs-comment">// 遍历初始状态，从 URL 中提取对应参数</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(initialState).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, defaultValue]</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> value = searchParams.<span class="hljs-title function_">get</span>(key);
      <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) {
        state[key] = defaultValue;
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 处理不同类型的默认值（数字、布尔、数组等）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defaultValue === <span class="hljs-string">'number'</span>) {
        state[key] = <span class="hljs-title class_">Number</span>(value);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defaultValue === <span class="hljs-string">'boolean'</span>) {
        state[key] = value === <span class="hljs-string">'true'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(defaultValue)) {
        state[key] = value.<span class="hljs-title function_">split</span>(<span class="hljs-string">'-'</span>);
      } <span class="hljs-keyword">else</span> {
        state[key] = value;
      }
    });
    
    <span class="hljs-keyword">return</span> state;
  }, [initialState]);

  <span class="hljs-comment">// 初始化状态：从 URL 解析或使用初始值</span>
  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(<span class="hljs-title function_">parseURLState</span>());

  <span class="hljs-comment">// 当 URL 变化时（前进/后退），同步更新状态</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePopState</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setState</span>(<span class="hljs-title function_">parseURLState</span>());
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'popstate'</span>, handlePopState);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'popstate'</span>, handlePopState);
  }, [parseURLState]);

  <span class="hljs-comment">// 更新状态并同步到 URL</span>
  <span class="hljs-keyword">const</span> setURLState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">newState</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
    <span class="hljs-keyword">const</span> nextState = { ...state, ...newState };
    
    <span class="hljs-comment">// 遍历新状态，更新到 searchParams</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(nextState).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (value === initialState[key]) {
        <span class="hljs-comment">// 如果值等于初始值，移除该参数（保持 URL 简洁）</span>
        searchParams.<span class="hljs-title function_">delete</span>(key);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 数组类型用 "-" 拼接</span>
        <span class="hljs-keyword">const</span> paramValue = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value) ? value.<span class="hljs-title function_">join</span>(<span class="hljs-string">'-'</span>) : <span class="hljs-title class_">String</span>(value);
        searchParams.<span class="hljs-title function_">set</span>(key, paramValue);
      }
    });
    
    <span class="hljs-comment">// 更新 URL（pushState 不会刷新页面）</span>
    <span class="hljs-keyword">const</span> searchString = searchParams.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> newUrl = searchString ? <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.location.pathname}</span>?<span class="hljs-subst">${searchString}</span>`</span> : <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span>;
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">''</span>, newUrl);
    
    <span class="hljs-comment">// 更新组件状态</span>
    <span class="hljs-title function_">setState</span>(nextState);
  }, [state, initialState]);

  <span class="hljs-keyword">return</span> [state, setURLState];
}
</code></pre>
<h2 data-id="heading-5">四、实战：用 URLState 重构商品列表页</h2>
<p>有了 <code>useURLState</code>，我们可以轻松重构之前的商品列表页，解决 <code>useState</code> 带来的痛点：</p>
<pre><code class="hljs language-jsx" lang="jsx">
<span class="hljs-keyword">import</span> { useURLState } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useURLState'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用 useURLState 替代 useState，初始状态和之前一致</span>
  <span class="hljs-keyword">const</span> [state, setURLState] = <span class="hljs-title function_">useURLState</span>({
    <span class="hljs-attr">priceRange</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>], <span class="hljs-comment">// 数组类型</span>
    <span class="hljs-attr">category</span>: <span class="hljs-string">'all'</span>,       <span class="hljs-comment">// 字符串类型</span>
    <span class="hljs-attr">sortBy</span>: <span class="hljs-string">'price-asc'</span>    <span class="hljs-comment">// 字符串类型</span>
  });

  <span class="hljs-keyword">const</span> { priceRange, category, sortBy } = state;

  <span class="hljs-comment">// 筛选条件变更时，调用 setURLState 更新</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePriceChange</span> = (<span class="hljs-params">newRange</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">priceRange</span>: newRange });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCategoryChange</span> = (<span class="hljs-params">newCategory</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">category</span>: newCategory });
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSortChange</span> = (<span class="hljs-params">newSort</span>) =&gt; {
    <span class="hljs-title function_">setURLState</span>({ <span class="hljs-attr">sortBy</span>: newSort });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FilterPanel</span> 
        <span class="hljs-attr">priceRange</span>=<span class="hljs-string">{priceRange}</span>
        <span class="hljs-attr">onPriceRangeChange</span>=<span class="hljs-string">{handlePriceChange}</span>
        <span class="hljs-attr">category</span>=<span class="hljs-string">{category}</span>
        <span class="hljs-attr">onCategoryChange</span>=<span class="hljs-string">{handleCategoryChange}</span>
        <span class="hljs-attr">sortBy</span>=<span class="hljs-string">{sortBy}</span>
        <span class="hljs-attr">onSortByChange</span>=<span class="hljs-string">{handleSortChange}</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ProductGrid</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>此时，用户筛选商品后，URL 会自动更新为：</p>
<pre><code class="hljs language-Plain" lang="Plain">
https://example.com/products?priceRange=0-2000&amp;category=electronics&amp;sortBy=price-desc
</code></pre>
<p>刷新页面、复制链接分享、后退到上一个筛选状态，都能完美生效！</p>
<h2 data-id="heading-6">五、URLState 的适用场景与注意事项</h2>
<h3 data-id="heading-7">5.1 适用场景</h3>
<ul>
<li>
<p>列表筛选、分页、排序等「可分享」的状态。</p>
</li>
<li>
<p>多步骤表单（如注册流程）的进度状态。</p>
</li>
<li>
<p>单页应用中的「页面级」状态（如标签页切换）。</p>
</li>
</ul>
<h3 data-id="heading-8">5.2 注意事项</h3>
<ul>
<li>
<p><strong>不要存储敏感信息</strong>：URL 参数会暴露在地址栏、浏览器历史、服务器日志中，密码、token 等敏感信息绝对不能用 URLState。</p>
</li>
<li>
<p><strong>参数不宜过多/过长</strong>：浏览器对 URL 长度有上限（通常 2KB-8KB），复杂状态建议用全局状态库（如 Redux）。</p>
</li>
<li>
<p><strong>处理特殊类型数据</strong>：对于对象等复杂类型，需要先序列化（如 JSON.stringify），但会增加 URL 长度，需谨慎使用。</p>
</li>
</ul>
<h2 data-id="heading-9">六、总结</h2>
<p><code>useState</code> 是 React 状态管理的基石，但在「状态持久化」「可分享」场景下存在局限。URLState 作为一种轻量级的补充方案，通过 URL 查询参数实现状态的持久化和共享，无需引入复杂的状态管理库，就能解决很多实际业务问题。</p>
<p>当然，URLState 不是银弹，它和 <code>useState</code>、全局状态库是互补关系。在合适的场景选择合适的工具，才是高效开发的关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>