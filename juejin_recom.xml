<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[万字长文！大模型(LLM)推理优化技术总结（非常详细）]]></title>    <link>https://juejin.cn/post/7586167377382227994</link>    <guid>https://juejin.cn/post/7586167377382227994</guid>    <pubDate>2025-12-22T06:03:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586167377382227994" data-draft-id="7585121055036489778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万字长文！大模型(LLM)推理优化技术总结（非常详细）"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-22T06:03:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万字长文！大模型(LLM)推理优化技术总结（非常详细）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:03:34.000Z" title="Mon Dec 22 2025 06:03:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>大模型训练成本很高，且在推理过程中需要大量的计算资源，为了能够实现大模型应用落地，需解决大模型推理成本、模型响应速度等问题，这就需要对大模型进行推理优化。为此，本文将详细介绍主流的大模型推理优化技术，文章安排如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca343c64398840c4beab036c2b6ec2a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=w7xTAbTU0Gzhb0m8AN63dMHfxZw%3D" alt="" loading="lazy"/>本文相关内容需要大家对Transformer架构和注意力机制有一个基本的了解。</p>
<h2 data-id="heading-0">1.  什么是LLM推理</h2>
<hr/>
<p>大多数流行的only-decode LLM（例如 GPT-4、Qwen系列）都是针对因果建模目标进行预训练的，本质上是作为下一个词预测器。<strong>「这些 LLM 将一系列tokens作为输入，并自回归生成后续tokens，直到满足停止条件」</strong>（例如，生成tokens数量的限制或遇到停止词）或直到生成特殊的 <code>&lt;end&gt;</code> 标记生成结束的tokens。该过程涉及两个阶段：预填充阶段和解码阶段。</p>
<p>请注意，tokens是模型处理的语言的原子部分。一个tokens大约是四个英文字符。所有自然语言在输入模型之前都会转换为tokens。下图是大模型推理过程。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fc135a4e92a45c29502bcefe8a12a73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=TuRsAC9QOwb9Ohl9paUy4gv9d6s%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-1">1.1 预填充阶段（Prefill）</h4>
<p>在预填充阶段，也可以理解为输入阶段。LLM处理输入token以计算中间状态（keys和value），用于生成“第一个”token。每个新的token都依赖于所有先前的token，但由于输入的全部已知，因此在运算上，都是高度并行化矩阵运算，可以有效地使用GPU。</p>
<h4 data-id="heading-2">1.2 解码阶段（Decode）</h4>
<p>在解码阶段，可以理解为输出阶段。LLM一次自回归生成一个输出token，直到满足停止条件。<strong>「每个输出tokens都需要直到之前迭代的所有输出状态（keys和values）」</strong>。这与预填充输入处理相比，就像矩阵向量运算未充分利用GPU计算能力。数据（weights, keys, values, activations） 从内存传输到GPU的速度决定了延迟，而不是计算实际时间消耗。即，这是一个内存限制操作。</p>
<p>本文中的许多推理挑战和相应的解决方案都涉及此解码阶段的优化：高效的注意力模块、有效管理键和值等。</p>
<p>不同的LLMs可能使用不同的tokenizers，因此比较它们之间的输出tokens可能并不简单。在比较推理吞吐量时，即使两个 LLMs每秒输出的tokens相似，如果它们使用不同的tokenizers，也可能不相等。这是因为相应的tokens可能代表不同数量的字符。</p>
<h4 data-id="heading-3">1.3 批处理（Batching）</h4>
<p>提高 GPU 利用率和有效吞吐量的最简单方法是通过批处理。由于多个请求使用相同的模型，因此权重的内存成本被分散。<strong>「大批量数据传输到 GPU 一次处理，将提高GPU资源的利用率。然而，批量大小只能增加到一定限制，此时可能会导致内存溢出」</strong>。为了防止这种情况发生，需要查看键值 (KV) 缓存和 LLM 内存要求。</p>
<p>传统批处理（也称为静态批处理， static batching）不是最佳的。这是因为对于批次中的每个请求，LLM 可能会生成不同数量的tokens，并且不同tokens有不同的执行时间。因此，批次中的所有请求都必须等待最长token的处理完成，而生成长度的巨大差异可能会加剧这种情况。有一些方法可以缓解这种情况，例如稍动态批处理。</p>
<h4 data-id="heading-4">1.4 KV缓存</h4>
<p>解码阶段的一种常见优化是 KV 缓存。解码阶段在每个时间步生成单个token，但每个token依赖于之前token的键和值张量（包括预填充时计算的输入tokens的 KV 张量，以及当前时间步之前计算的任何新 KV 张量） 。</p>
<p><strong>「为了避免在每个时间步重新计算所有tokens的这些张量，可以将它们缓存在 GPU 内存中」</strong>。每次迭代，当需要计算新token时，它们都会被添加到正在运行的缓存中，以便在下一次迭代中使用。在一些实现中，模型的每一层都有一个KV缓存。下图展示了KV的缓存机制。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd705ca24cee4806b8e881c46a362f4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=D2kxmtfzpvG370E9BapzfKtbh8w%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">1.5 大模型内存需求</h4>
<p>实际上，LLM对GPU显存的需求主要是模型权重和KV缓存：</p>
<ul>
<li><strong>「模型权重」</strong>：模型参数占用内存。例如，具有 70 亿个参数的模型（例如 Llama 2-7B ），以 16 位精度（FP16 或 BF16）加载，将占用大约 <code>7B * sizeof(FP16) ~= 14 GB</code> 的内存。</li>
<li><strong>「KV缓存」</strong>：自注意力张量的缓存占用内存，避免冗余计算。</li>
</ul>
<p>使用批处理时，批处理中每个请求的 KV 缓存仍然必须单独分配，并且可能会占用大量内存。下面的公式描述了 KV 缓存的大小，适用于当今最常见的 LLM 架构。</p>
<p><code>每个Token KV缓存（字节）=2 * (num_layers) * (num_heads * dim_head) * precision_in_bytes</code></p>
<p>第一个因子 2 代表 <code>K</code> 和 <code>V</code> 矩阵。通常，(<code>num_heads * dim_head</code>)的值与Transformer的<code>hidden_size</code>（或模型的维度，d_model）相同。这些模型属性通常可以在配置文件中找到。</p>
<p>输入批次中输入序列中的每个tokens都需要此内存大小。假设半精度，KV缓存的总大小由以下公式给出:</p>
<p><code>总的Token KV缓存（字节）= (batch_size) * (sequence_length) * 2 * (num_layers) * (hidden_size) * sizeof(FP16)</code></p>
<p>例如，对于 16 位精度的 Llama 2-7B 模型，批量大小为 1，KV 缓存的大小将为 1 * 4096 * 2 * 32 * 4096 * 2 字节，即约 2 GB。</p>
<p>可以发现Llama 2-7B本身模型权重占用为14G，单个输入序列长度4096需要缓存为2G，这就需要16GB的显存，要运行该模型可见单个显存的要求。为此如何高效的管理 KV 缓存就成为了一项重要的挑战。内存需求随着批量大小和序列长度线性增长，它限制了可服务的吞吐量，并对长上下文输入提出了挑战。这就是本文中介绍的多项优化背后的动机。</p>
<h3 data-id="heading-6">2.模型并行</h3>
<p><strong>「减少模型权重在每设备的显存占用的一种方法是将模型分布在多个 GPU 上。分散内存和计算可以运行更大的模型或更大批量的输入」</strong>。模型并行化是训练或推理模型所必需的，模型并行化需要比单个设备更多的内存，用来训练和推理（延迟或者吐量）。根据模型权重的划分方式，有多种方法可以并行化模型。</p>
<p>请注意，数据并行也是一种经常在与下面列出的其他技术相同的技术。在这种情况下，模型的权重被复制到多个设备上，并且输入的（全局）批量大小在每个设备上被分成微批次。它通过处理较大的批次来减少总体执行时间。然而，这是一种训练时间优化，在推理过程中不太相关。</p>
<h4 data-id="heading-7">2.1 Pipeline并行</h4>
<p>Pipeline并行化将模型（垂直）分片为块，其中每个块包含在单独设备上执行的层的子集。下图展示了四路Pipeline，其中模型按顺序分区，并且所有层的四分之一子集在每个设备上执行。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a64eb5a761244c39a11c1d036abe5648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=NYpHJXk7diOvAo1Nav4uM06aKuI%3D" alt="" loading="lazy"/>一个设备上的一组操作的输出被传递到下一个设备，后者继续执行后续块。 和  分别表示设备 n 上的前向传播和后向传播。每个设备上存储模型权重的内存需求被分成四份。</p>
<p>该方法的**「缺点是，由于处理的顺序性质，某些设备或层在等待前一层的输出（激活、梯度）时可能保持空闲状态」**。这会导致前向和后向传递效率低下或出现“Pipeline bubbles”。在上图（b）中，白色空白区域是Pipeline并行性产生的Pipeline bubbles，其中设备闲置且未得到充分利用。</p>
<p>为了在一定时间内充分利用GPU，可以通过微批处理的方式，即：分成多批，一个GPU完成之后立马安排下一次计算，但是这种方式可以在一定程度上缓解这种情况，如图 2c 所示。输入的全局批次大小被分成了批次，这些子批次被一一处理，最后累积梯度。请注意， 和  分别表示设备 n 上 m 批次的前向和后向传递。这种方法缩小了管道气泡的尺寸，但并没有完全消除它们。</p>
<h4 data-id="heading-8">2.2 Tensor并行</h4>
<p>Tensor并行化将模型的各个层（水平）分片为更小的、独立的计算块，这些计算块可以在不同的设备上执行。Transformer的主要组成部分，注意力块和多层感知器（MLP）层是可以利用Tensor并行化的。在多头注意力块中，每个头或一组头可以分配给不同的设备，以便它们可以独立且并行地计算。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629babdd078c44a6839c25bdadb3437f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=MtXCKSa5z7lqYon7CNY93xyn1qY%3D" alt="" loading="lazy"/> 分为  和  。对于输入 ，可以在同一批次不同设备上计算  和 ，其中，是identity 操作。这将每个设备上存储权重的内存需求减半。归约操作  组合了第二层的输出。</p>
<p>上图（b）是自注意力层中Tensor并行的示例。多个注意力头本质上是并行的，并且可以跨设备分割。</p>
<h4 data-id="heading-9">2.3 Sequence并行</h4>
<p>Tensor并行化是有局限性，它需要将层划分为独立的、可管理的块，不适用于 LayerNorm和 Dropout等操作，而是在tensor并行中复制。虽然 LayerNorm和 Dropout的计算成本较低，但它们确实需要大量内存来存储（冗余）激活。</p>
<p>如Reducing Activation Recomputation in Large Transformer Models所示，这些操作在输入序列中是独立的，并且这些操作可以沿着“序列维度”进行分区，从而提高内存效率。这称为序列并行性。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43a47af518db4df19218f8845d2eef9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=9fJV5gMWanIFgFonYq5Rymjh%2F0s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.注意力机制优化</h3>
<p>缩放点积注意力 (SDPA， scaled dot-product attention) 操作将query和key对映射到输出，如论文Attention Is All You Need所述。</p>
<h4 data-id="heading-11">3.1 多头注意力（MHA）</h4>
<p>作为 SDPA 的增强，<strong>「三个变换张量对Q，K，V分别进行线性变换，这些变换不会改变原有张量的尺寸」</strong>，使模型能够共同关注来自不同位置的不同表示子空间的信息。这些子空间是独立学习的，使模型能够更丰富地理解输入中的不同位置。</p>
<p>如下图所示（缩放点积注意力（左）和多头注意力（右）），多个并行注意力操作的输出被拼接后线性投影以组合起来。每个并行注意力层称为“头”，这种方法称为多头注意力（MHA）。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf972fac877e4eabb07414020af55b38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=DDehmY0LhS%2FmYEV%2BWH%2FNwnUEygA%3D" alt="" loading="lazy"/>）。这使得计算成本与单头注意力相似。</p>
<h4 data-id="heading-12">3.2 多查询注意力（MQA）</h4>
<p>MHA 的推理优化之一称为多查询注意力 (MQA)，如 Fast Transformer Decoding 中提出的，在多个注意力头之间共享键和值。与以前一样，查询向量仍然被投影多次。</p>
<p>虽然 MQA 中完成的计算量与 MHA 相同，但从内存读取的数据量（键、值）只是以前的一小部分。<strong>「当受内存带宽限制时，这可以实现更好的计算利用率」</strong>。它还减少了内存中 KV 缓存的大小，为更大的批量大小留出了空间。</p>
<p><strong>「key头的减少会带来潜在的准确性下降」</strong>。此外，需要在推理时利用这种优化的模型需要在启用 MQA 的情况下进行训练（或至少使用大约 5% 的训练量进行微调）。</p>
<h4 data-id="heading-13">3.3 分组注意力（GQA）</h4>
<p>分组查询注意力 (GQA) 通过将键和值投影到几组查询头，在 MHA 和 MQA 之间取得平衡（如下图所示）。在每个组中，它的行为类似于多查询注意力。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ab58176498a41c9aa135d68dd8ad921~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=YLgjoMosezegyL5vy5%2Bm%2BUtZTvk%3D" alt="" loading="lazy"/><strong>「分组查询注意力（中心）的键值头多于一个，但少于查询头的数量，这是内存需求和模型质量之间的平衡」</strong>。多查询注意力（右）具有单个键值头，有助于节省内存。</p>
<p>最初使用 MHA 训练的模型可以使用原始训练计算的一小部分通过 GQA 进行“升级训练”。它们获得接近 MHA 的质量，同时保持接近 MQA 的计算效率。 <strong>「Llama 2 70B 是利用 GQA 的模型示例」</strong>。</p>
<p><strong>「MQA 和 GQA 等优化通过减少存储的key头和value头的数量来帮助减少 KV 缓存所需的内存」</strong>。 KV 缓存的管理方式可能仍然效率低下。与优化注意力模块本身不同，下一节将介绍一种更高效的 KV 缓存管理技术。</p>
<h4 data-id="heading-14">3.4 Flash attention</h4>
<p>优化注意力机制的另一种方法是修改某些计算的顺序，以更好地利用 GPU 的内存层次结构。神经网络通常用层来描述，大多数实现也以这种方式布局，每次按顺序对输入数据进行一种计算。这并不总是能带来最佳性能，因为对已经进入内存层次结构的更高、性能更高级别的值进行更多计算可能是有益的。</p>
<p>在实际计算过程中将多个层融合在一起可以最大限度地减少 GPU 需要读取和写入内存的次数，并将需要相同数据的计算分组在一起，即使它们是神经网络中不同层的一部分。</p>
<p>一种非常流行的融合是**「FlashAttention，这是一种 I/O 感知精确注意算法」<strong>，详细信息请参阅:<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2205.14135" target="_blank" title="https://arxiv.org/abs/2205.14135" ref="nofollow noopener noreferrer">arxiv.org/abs/2205.14…</a>。精确注意力意味着它在数学上与标准多头注意力相同（具有可用于多查询和分组查询注意力的变体），因此可以无需修改即可交换到现有的模型架构，甚至是已经训练的模型。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5200bb54dab54c569a1e64bd477b9cfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=2HHsSc1MidNyP%2FqECK7GwVlvX5Q%3D" alt="" loading="lazy"/></strong>「FlashAttention 使用“平铺”一次性完全计算并写出最终矩阵的一小部分，而不是分步对整个矩阵进行部分计算，写出中间值」**。上图显示了 40 GB GPU 上的平铺 FlashAttention 计算模式和内存层次结构。右图显示了对注意力机制的不同组件进行融合和重新排序所带来的相对加速。</p>
<h4 data-id="heading-15">3.5 PageAttention</h4>
<p>有时，KV 缓存会静态地“过度配置”(over-provisioned)，以考虑最大可能的输入（支持的序列长度），因为输入的大小是不可预测的。例如，如果模型支持的最大序列长度为 2,048，则无论请求中输入和生成的输出的大小如何，都将在内存中保留大小为 2,048 的数据。该空间可以是连续分配的，并且通常其中大部分未被使用，从而导致内存浪费或碎片。该保留空间在请求的生命周期内被占用。下图展示了由于过度配置和低效的 KV 缓存管理而导致的内存浪费和碎片。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c9702bf160a4c81b5a4cfdeb809bb8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=IGBPw1%2BbPKsTUok6Jcqg2jt7GVk%3D" alt="" loading="lazy"/>为此，UC伯克利的研究人员受操作系统分页的启发，提出了PagedAttention(<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2309.06180" target="_blank" title="https://arxiv.org/pdf/2309.06180" ref="nofollow noopener noreferrer">arxiv.org/pdf/2309.06…</a>)算法，<strong>「PagedAttention 算法能够将连续的键和值存储在内存中的不连续空间中」</strong>。它将每个请求的 KV 缓存划分为代表固定数量token的块，这些块可以不连续存储。</p>
<p>在注意力计算期间，使用根据记录索引获取这些块。当新的token产生时，就会进行新的区块分配。这些块的大小是固定的，消除了因不同请求需要不同分配等挑战而产生的低效率。这极大地限制了内存浪费，从而实现了更大的批量大小（从而提高了吞吐量）。常用的vLLM推理框架就是采用的PagedAttention技术。</p>
<h3 data-id="heading-16">5.模型优化技术</h3>
<p>到目前为止，我们已经讨论了 LLM 消耗内存的不同方式、跨多个不同 GPU 分配内存的一些方式，以及优化注意力机制和 KV 缓存。还有多种模型优化技术可以通过修改模型权重本身来减少每个 GPU 上的内存使用。 GPU 还具有专用硬件来加速这些修改值的运算，从而为模型提供更多加速。</p>
<h4 data-id="heading-17">5.1 量化（Quantization）</h4>
<p><strong>「量化是降低模型权重和激活精度的过程」</strong>。大多数模型都以 32 或 16 位精度进行训练，其中每个参数和激活元素占用 32 或 16 位内存（单精度浮点）。然而，大多数深度学习模型可以用每个值八个甚至更少的位来有效表示。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66d1bb00f8ef41629baad5295330169d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=pWHw5pXry%2FFjjy2Azks13iGwti0%3D" alt="" loading="lazy"/>上图显示了一种可能的量化方法之前和之后的值分布。在这种情况下，会丢失一些精度，并且剪裁会丢失一些动态范围，从而允许以更小的格式表示值。</p>
<p>但是降低模型的精度可以带来多种好处。如果模型占用的内存空间较少，则可以在相同数量的硬件上安运行更大的模型。<strong>「量化还意味着可以在相同的带宽上传输更多参数，这有助于加速带宽有限的模型」</strong>。</p>
<p>LLM 有许多不同的量化技术，涉及降低激活、权重或两者的精度。量化权重要简单得多，因为它们在训练后是固定的。然而，这可能会留下一些性能问题，因为激活仍然保持在更高的精度。 GPU 没有用于乘以 INT8 和 FP16 数字的专用硬件，因此必须将权重转换回更高精度以进行实际运算。</p>
<p>还可以量化激活、Transformer块和网络层的输入，但这也有其自身的挑战。激活向量通常包含异常值，有效地增加了它们的动态范围，并使以比权重更低的精度表示这些值变得更具挑战性。</p>
<p>一种选择是通过模型传递代表性数据集并选择以比其他激活更高的精度表示某些激活来找出这些异常值可能出现的位置 (LLM.int8())。另一种选择是借用易于量化的权重的动态范围，并在激活中重用该范围。</p>
<h4 data-id="heading-18">5.2 稀疏（Sparsity）</h4>
<p>与量化类似，事实证明，许多深度学习模型对于修剪或用 0 本身替换某些接近 0 的值具有鲁棒性。<strong>「稀疏矩阵是许多元素为 0 的矩阵」</strong>。这些矩阵可以用压缩形式表示，比完整的稠密矩阵占用的空间更少。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec5fcffd7d4d4fc8b8183c00efad05d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=9Cr%2FGDnu4sDgYX91a%2FJT3b20f4k%3D" alt="" loading="lazy"/>GPU 尤其具有针对某种结构化稀疏性的硬件加速，其中每四个值中有两个由零表示。稀疏表示还可以与量化相结合，以实现更大的执行速度。<strong>「寻找以稀疏格式表示大型语言模型的最佳方法仍然是一个活跃的研究领域」</strong>，并为未来提高推理速度提供了一个有希望的方向。</p>
<h4 data-id="heading-19">5.3 蒸馏（Distillation）</h4>
<p>缩小模型大小的另一种方法是通过称为蒸馏的过程将其知识转移到较小的模型。<strong>「此过程涉及训练较小的模型（称为学生）来模仿较大模型（教师）的行为」</strong>。蒸馏模型的成功例子包括 DistilBERT，它将 BERT 模型压缩了 40%，同时保留了 97% 的语言理解能力，速度提高了 60%。</p>
<p>虽然LLMs中的蒸馏是一个活跃的研究领域，但神经网络的一般方法首次在论文Distilling the Knowledge in a Neural Network(<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F1503.02531" target="_blank" title="https://arxiv.org/abs/1503.02531" ref="nofollow noopener noreferrer">arxiv.org/abs/1503.02…</a>)中提出：学生网络经过训练，可以反映较大教师网络的性能，使用损失函数来测量其输出之间的差异。该目标还可能包括将学生的输出与真实标签进行匹配的原始损失函数。</p>
<p>匹配的教师输出可以是最后一层（称为 logits）或中间层激活。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f3f7171843b47f59201f44d7fe300b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=1Y9Gw7YgRH0R00A3qCkLxa%2BKT9U%3D" alt="" loading="lazy"/>上图显示了知识蒸馏通用的总体框架(<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2006.05525" target="_blank" title="https://arxiv.org/pdf/2006.05525" ref="nofollow noopener noreferrer">arxiv.org/pdf/2006.05…</a>)。教师的 logits是学生使用蒸馏损失进行优化的软目标。其他蒸馏方法可能会使用其他损失措施来从老师那里“蒸馏”知识。</p>
<p><strong>「蒸馏的另一种方法是使用教师合成的数据对LLMs学生进行监督培训，这在人工注释稀缺或不可用时特别有用」</strong>。一步一步蒸馏！更进一步，除了作为基本事实的标签之外，还从LLMs教师那里提取基本原理。这些基本原理作为中间推理步骤，以数据有效的方式培训规模较小的LLMs。</p>
<p>值得注意的是，当今许多最先进的LLMs都拥有限制性许可证，禁止使用他们的成果来训练其他LLMs，这使得找到合适的教师模型具有挑战性。</p>
<h3 data-id="heading-20">6.模型服务技术</h3>
<p>模型执行通常受内存带宽限制，特别是权重中的带宽限制。即使在应用了前面描述的所有模型优化之后，它仍然很可能受到内存限制。因此，在加载模型权重时尽可能多地处理它们。换句话说，尝试并行。可以采取两种方法：</p>
<ul>
<li><strong>「动态批处理」</strong>(In-flight batching) ：同时执行多个不同的请求。</li>
<li><strong>「预测推理」</strong>(Speculative inference) ：并行执行序列的多个不同步骤以尝试节省时间。</li>
</ul>
<h4 data-id="heading-21">6.1 动态批处理（In-flight batching）</h4>
<p>LLMs 具有一些独特的执行特征，这些特征可能导致在实践中难以有效地处理批量请求。一个模型可以同时用于多种不同的任务。从聊天机器人中的简单问答响应到文档摘要或代码块的生成，工作负载是高度动态的，输出大小变化几个数量级。</p>
<p>这种多功能性使得批处理请求并有效地并行执行它们变得具有挑战性，这是服务神经网络的常见优化。这可能会导致某些请求比其他请求更早完成。</p>
<p>为了管理这些动态负载，<strong>「许多LLMs 服务解决方案包括一种称为连续或动态批处理的优化调度技术」</strong>。这利用了这样一个事实：LLMs的整个文本生成过程可以分解为模型上的多次执行迭代。</p>
<p><strong>「通过动态批处理，服务器运行时会立即从批处理中剔除已完成的序列，而不是等待整个批处理完成后再继续处理下一组请求」</strong>。然后，它开始执行新请求，而其他请求仍在进行中。因此，动态批处理可以极大地提高实际用例中 GPU 的整体利用率。</p>
<h4 data-id="heading-22">6.2 预测推理（Speculative inference）</h4>
<p>预测推理也称为推测采样、辅助生成或分块并行解码，是并行执行 LLM 的另一种方式。通常，GPT 风格的大语言模型是自回归模型，逐个生成文本标记。</p>
<p>生成的每个标记都依赖于它之前的所有标记来提供上下文。这意味着在常规执行中，<strong>「不可能从同一个序列并行生成多个token，必须等待第 n 个token生成后才能生成 n+1 个token」</strong>。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac07536b5fbf454eacb165733fa32dc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988214&amp;x-signature=NXHv%2Bg%2FoGy3GeyqTnFxcFl6vBCg%3D" alt="" loading="lazy"/>上图为预测推理的示例，其中临时模型临时预测并行验证或拒绝的多个未来步骤。在这种情况下，临时模型中的前两个预测token被接受，而最后一个在继续生成之前被拒绝并删除。</p>
<p>预测性抽样提供了一种解决方法。<strong>「这种方法的基本思想是使用一些“更便宜”的过程来生成几个token长的临时序列」</strong>。然后，并行执行多个步骤的主要“验证”模型，使用廉价临时序列作为需要的执行步骤的“预测”上下文。</p>
<p>如果验证模型生成与临时序列相同的token，那么就知道接受这些token作为输出。否则，可以丢弃第一个不匹配标记之后的所有内容，并使用新的临时序列重复该过程。</p>
<p>如何生成临时token有许多不同的选项，每个选项都有不同的权衡。可以训练多个模型，或在单个预训练模型上微调多个头，以预测未来多个步骤的标记。或者，可以使用小型模型作为临时模型，使用更大、功能更强大的模型作为验证器。</p>
<h3 data-id="heading-23">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[现代 JavaScript 特性：TypeScript 深度解析与实践]]></title>    <link>https://juejin.cn/post/7585928504949800996</link>    <guid>https://juejin.cn/post/7585928504949800996</guid>    <pubDate>2025-12-22T06:05:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585928504949800996" data-draft-id="7585928504949784612" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="现代 JavaScript 特性：TypeScript 深度解析与实践"/> <meta itemprop="keywords" content="前端,JavaScript,TypeScript"/> <meta itemprop="datePublished" content="2025-12-22T06:05:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024肥宅"/> <meta itemprop="url" content="https://juejin.cn/user/588993964030574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            现代 JavaScript 特性：TypeScript 深度解析与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993964030574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024肥宅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:05:07.000Z" title="Mon Dec 22 2025 06:05:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">引言</h4>
<p>TypeScript作为JavaScript的超集，为现代前端开发带来了强大的类型系统和面向对象编程能力。它不仅在编译时提供类型检查，还支持ECMAScript的最新特性，极大地提高了代码的可维护性和开发体验。本文将深入探讨TypeScript的核心特性，包括类型检查、接口泛型、装饰器等底层实现原理，并补充类型推断、高级类型、工程化实践等关键内容，通过完整代码示例展示TypeScript在真实项目中的应用价值。</p>
<h4 data-id="heading-1">一、类型检查的简单实现</h4>
<h5 data-id="heading-2">运行时类型检查的基础</h5>
<p>TypeScript在编译时进行类型检查，但理解其背后的原理有助于我们实现运行时类型检查。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1.1 基础类型检查器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeChecker</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isNumber</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"number"</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(value);
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isBoolean</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"boolean"</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isArray</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value);
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isObject</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> value !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"object"</span> &amp;&amp; !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value);
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isFunction</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"function"</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isNull</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> value === <span class="hljs-literal">null</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isUndefined</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"undefined"</span>;
  }

  <span class="hljs-comment">// 复合类型检查</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isType</span>(<span class="hljs-params">value, expectedType</span>) {
    <span class="hljs-keyword">switch</span> (expectedType) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"string"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isString</span>(value);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"number"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isNumber</span>(value);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"boolean"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isBoolean</span>(value);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"array"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isArray</span>(value);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"object"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isObject</span>(value);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"function"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isFunction</span>(value);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"null"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isNull</span>(value);
      <span class="hljs-keyword">case</span> <span class="hljs-string">"undefined"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isUndefined</span>(value);
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Unsupported type: <span class="hljs-subst">${expectedType}</span>`</span>);
    }
  }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">TypeChecker</span>.<span class="hljs-title function_">isString</span>(<span class="hljs-string">"hello"</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">TypeChecker</span>.<span class="hljs-title function_">isNumber</span>(<span class="hljs-number">42</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">TypeChecker</span>.<span class="hljs-title function_">isType</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], <span class="hljs-string">"array"</span>)); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 1.2 增强的类型检查器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedTypeChecked</span> {
  <span class="hljs-keyword">static</span> types = {
    <span class="hljs-attr">string</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">number</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"number"</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(value),
    <span class="hljs-attr">boolean</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"boolean"</span>,
    <span class="hljs-attr">array</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value),
    <span class="hljs-attr">object</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span>
      value !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"object"</span> &amp;&amp; !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value),
    <span class="hljs-attr">function</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"function"</span>,
    <span class="hljs-attr">null</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> value === <span class="hljs-literal">null</span>,
    <span class="hljs-attr">undefined</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"undefined"</span>,
    <span class="hljs-comment">// 自定义类型</span>
    <span class="hljs-attr">email</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(value),
    <span class="hljs-attr">uuid</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span>
      <span class="hljs-regexp">/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i</span>.<span class="hljs-title function_">test</span>(
        value
      ),
    <span class="hljs-attr">date</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>,
    <span class="hljs-comment">// 联合类型</span>
    <span class="hljs-attr">union</span>: <span class="hljs-function">(<span class="hljs-params">value, types</span>) =&gt;</span> types.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">type</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">check</span>(value, type)),
    <span class="hljs-comment">// 字面量类型</span>
    <span class="hljs-attr">literal</span>: <span class="hljs-function">(<span class="hljs-params">value, expected</span>) =&gt;</span> vaue === expected,
  };

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">check</span>(<span class="hljs-params">value, type</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type === <span class="hljs-string">"string"</span>) {
      <span class="hljs-keyword">const</span> checker = <span class="hljs-variable language_">this</span>.<span class="hljs-property">types</span>[type];
      <span class="hljs-keyword">return</span> checker ? <span class="hljs-title function_">checker</span>(value) : <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type === <span class="hljs-string">"object"</span> &amp;&amp; type.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">if</span> (type.<span class="hljs-property">type</span> === <span class="hljs-string">"union"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">types</span>.<span class="hljs-title function_">union</span>(value, type.<span class="hljs-property">types</span>);
      }
      <span class="hljs-keyword">if</span> (type.<span class="hljs-property">type</span> === <span class="hljs-string">"literal"</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">types</span>.<span class="hljs-title function_">literal</span>(value, type.<span class="hljs-property">value</span>);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">value, schema</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema === <span class="hljs-string">"string"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">check</span>(value, schema);
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(schema)) {
      <span class="hljs-comment">// 数组类型</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">check</span>(value, <span class="hljs-string">"array"</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">const</span> [itemType] = schema;
      <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">every</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validate</span>(item, itemType));
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema === <span class="hljs-string">"object"</span> &amp;&amp; !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(schema)) {
      <span class="hljs-comment">// 对象类型</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">check</span>(value, <span class="hljs-string">"object"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, propSchema] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(schema)) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validate</span>(value[key], propSchema)) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
      }

      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> schema = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"string"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-string">"number"</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">"email"</span>,
  <span class="hljs-attr">tags</span>: [<span class="hljs-string">"string"</span>],
  <span class="hljs-attr">address</span>: {
    <span class="hljs-attr">street</span>: <span class="hljs-string">"string"</span>,
    <span class="hljs-attr">city</span>: <span class="hljs-string">"string"</span>,
  },
};

<span class="hljs-keyword">const</span> data = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"John"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">"john@example.com"</span>,
  <span class="hljs-attr">tags</span>: [<span class="hljs-string">"developer"</span>, <span class="hljs-string">"typescript"</span>],
  <span class="hljs-attr">address</span>: {
    <span class="hljs-attr">street</span>: <span class="hljs-string">"123 Main St"</span>,
    <span class="hljs-attr">city</span>: <span class="hljs-string">"New York"</span>,
  },
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">EnhancedTypeChecked</span>.<span class="hljs-title function_">validate</span>(data, schema)); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 1.3 编译时类型检查模拟</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createTypeSafeProxy</span>(<span class="hljs-params">target, schema</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
    <span class="hljs-title function_">set</span>(<span class="hljs-params">obj, prop, value</span>) {
      <span class="hljs-keyword">if</span> (schema[prop]) {
        <span class="hljs-keyword">const</span> isValid = <span class="hljs-title class_">EnhancedTypeChecked</span>.<span class="hljs-title function_">validate</span>(value, schema[prop]);
        <span class="hljs-keyword">if</span> (!isValid) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(
            <span class="hljs-string">`Invalid type for property <span class="hljs-subst">${prop}</span>. Expected <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(
              schema[prop]
            )}</span>, got <span class="hljs-subst">${<span class="hljs-keyword">typeof</span> value}</span>`</span>
          );
        }
      }
      obj[prop] = value;
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    },
    <span class="hljs-title function_">get</span>(<span class="hljs-params">obj, prop</span>) {
      <span class="hljs-keyword">return</span> obj[prop];
    },
  });
}

<span class="hljs-keyword">const</span> userSchema = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"string"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-string">"number"</span>,
  <span class="hljs-attr">active</span>: <span class="hljs-string">"boolean"</span>,
};

<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">createTypeSafeProxy</span>({}, userSchema);

<span class="hljs-keyword">try</span> {
  user.<span class="hljs-property">name</span> = <span class="hljs-string">"Alice"</span>; <span class="hljs-comment">// 成功</span>
  user.<span class="hljs-property">age</span> = <span class="hljs-string">"25"</span>; <span class="hljs-comment">// Invalid type for property age. Expected "number", got string</span>
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>);
}
</code></pre>
<h5 data-id="heading-3">TypeScript编译器模拟</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleTypeScriptCompiler</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">typeRegistry</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span> = [];
  }

  <span class="hljs-comment">// 解析类型注释</span>
  <span class="hljs-title function_">parseTypeAnnotation</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-keyword">const</span> typeRegex = <span class="hljs-regexp">/:\s*([^{}\[\]]+|\{[^}]+\}|\[[^\]]+\])/g</span>;
    <span class="hljs-keyword">const</span> matches = [];
    <span class="hljs-keyword">let</span> match;

    <span class="hljs-keyword">while</span> ((match = typeRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      matches.<span class="hljs-title function_">push</span>(match[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>());
    }

    <span class="hljs-keyword">return</span> matches;
  }

  <span class="hljs-comment">// 提取接口定义</span>
  <span class="hljs-title function_">extractInterface</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-keyword">const</span> interfaceRegex = <span class="hljs-regexp">/interface\s+(\w+)\s*\{([^}]+)\}/g</span>;
    <span class="hljs-keyword">const</span> interfaces = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-keyword">let</span> match;

    <span class="hljs-keyword">while</span> ((match = interfaceRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> [, name, body] = match;
      <span class="hljs-keyword">const</span> properties = {};

      body.<span class="hljs-title function_">split</span>(<span class="hljs-string">";"</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">line</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> propMatch = line.<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(\w+)\s*:\s*([^;]+)/</span>);
        <span class="hljs-keyword">if</span> (propMatch) {
          <span class="hljs-keyword">const</span> [, propName, propType] = propMatch;
          properties[propName] = propType.<span class="hljs-title function_">trim</span>();
        }
      });

      interfaces.<span class="hljs-title function_">set</span>(name, properties);
    }

    <span class="hljs-keyword">return</span> interfaces;
  }

  <span class="hljs-comment">// 检查函数类型</span>
  <span class="hljs-title function_">checkFunctionTypes</span>(<span class="hljs-params">code, interfaces</span>) {
    <span class="hljs-keyword">const</span> functionRegex =
      <span class="hljs-regexp">/function\s+(\w+)\(([^)]*)\)\s*(?::\s*([^{]+))?\s*\{/g</span>;
    <span class="hljs-keyword">const</span> errors = [];
    <span class="hljs-keyword">let</span> match;

    <span class="hljs-keyword">while</span> ((match = functionRegex.<span class="hljs-title function_">exec</span>(code)) !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> [, functionName, params, returnType] = match;

      <span class="hljs-comment">// 检查参数类型</span>
      <span class="hljs-keyword">if</span> (params) {
        params.<span class="hljs-title function_">split</span>(<span class="hljs-string">","</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">param</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> paramMatch = param.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(\w+)\s*:\s*(\w+)/</span>);
          <span class="hljs-keyword">if</span> (paramMatch) {
            <span class="hljs-keyword">const</span> [, paramName, paramType] = paramMatch;
            <span class="hljs-comment">// 这里可以添加实际类型检查逻辑</span>
          }
        });
      }

      <span class="hljs-comment">// 这里可以添加返回值类型检查逻辑</span>
    }

    <span class="hljs-keyword">return</span> errors;
  }

  <span class="hljs-comment">// 编译TypeScript代码</span>
  <span class="hljs-title function_">compile</span>(<span class="hljs-params">code</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span> = [];

    <span class="hljs-comment">// 提取接口</span>
    <span class="hljs-keyword">const</span> interfaces = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractInterface</span>(code);

    <span class="hljs-comment">// 检查类型</span>
    <span class="hljs-keyword">const</span> typeErrors = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkFunctionTypes</span>(code, interfaces);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span>.<span class="hljs-title function_">push</span>(...typeErrors);

    <span class="hljs-comment">// 移除类型注释, 生成JavaScript代码</span>
    <span class="hljs-keyword">let</span> jsCode = code
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:\s*([^{}\[\]]+|\{[^}]+\}|\[[^\]]+\])/g</span>, <span class="hljs-string">""</span>) <span class="hljs-comment">// 移除参数和变量类型</span>
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/interface\s+\w+\s*\{[^}]+\}/g</span>, <span class="hljs-string">""</span>) <span class="hljs-comment">// 移除接口定义</span>
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\s*\/\/.*$/gm</span>, <span class="hljs-string">""</span>) <span class="hljs-comment">// 移除注释</span>
      .<span class="hljs-title function_">trim</span>();

    <span class="hljs-keyword">return</span> {
      jsCode,
      <span class="hljs-attr">errors</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">errors</span>,
      <span class="hljs-attr">interfaces</span>: <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(interfaces.<span class="hljs-title function_">entries</span>()),
    };
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> tsCode = <span class="hljs-string">`
interface User {
  name: string;
  age: number;
}

function greet(user: User): string {
  return "Hello, " + user.name;
}

const john: User = { name: "John", age: 30 };
console.log(greet(john));
`</span>;

<span class="hljs-keyword">const</span> compiler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleTypeScriptCompiler</span>();
<span class="hljs-keyword">const</span> result = compiler.<span class="hljs-title function_">compile</span>(tsCode);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"生成的JavaScript代码:"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">jsCode</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"提取的接口:"</span>, result.<span class="hljs-property">interfaces</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"类型错误:"</span>, result.<span class="hljs-property">errors</span>);
</code></pre>
<h4 data-id="heading-4">二、接口和泛型的模拟</h4>
<h5 data-id="heading-5">接口的实现与模拟</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2.1 接口检查器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">InterfaceChecker</span> {
  <span class="hljs-keyword">static</span> interfaces = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-comment">// 定义接口</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">defineInterface</span>(<span class="hljs-params">name, structure</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">interfaces</span>.<span class="hljs-title function_">set</span>(name, structure);
  }
  
  <span class="hljs-comment">// 检查对象是否实现接口</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">implements</span>(<span class="hljs-params">obj, interfaceName</span>) {
    <span class="hljs-keyword">const</span> interfaceDef = <span class="hljs-variable language_">this</span>.<span class="hljs-property">interfaces</span>.<span class="hljs-title function_">get</span>(interfaceName);
    <span class="hljs-keyword">if</span> (!interfaceDef) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`接口 <span class="hljs-subst">${interfaceName}</span> 未定义`</span>);
    }
    
    <span class="hljs-comment">// 检查所有必需属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [prop, type] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(interfaceDef.<span class="hljs-property">required</span> || {})) {
      <span class="hljs-keyword">if</span> (!(prop <span class="hljs-keyword">in</span> obj)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">if</span> (type &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkType</span>(obj[prop], type)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
    
    <span class="hljs-comment">// 检查可选属性类型（如果存在）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [prop, type] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(interfaceDef.<span class="hljs-property">optional</span> || {})) {
      <span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">in</span> obj &amp;&amp; type &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkType</span>(obj[prop], type)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
    
    <span class="hljs-comment">// 检查方法</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> method <span class="hljs-keyword">of</span> interfaceDef.<span class="hljs-property">methods</span> || []) {
      <span class="hljs-keyword">if</span> (!(method <span class="hljs-keyword">in</span> obj) || <span class="hljs-keyword">typeof</span> obj[method] !== <span class="hljs-string">'function'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-comment">// 类型检查</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">checkType</span>(<span class="hljs-params">value, type</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> type === <span class="hljs-string">'string'</span>) {
      <span class="hljs-keyword">switch</span> (type) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'string'</span>: <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'number'</span>: <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'number'</span> &amp;&amp; !<span class="hljs-built_in">isNaN</span>(value);
        <span class="hljs-keyword">case</span> <span class="hljs-string">'boolean'</span>: <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'boolean'</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'object'</span>: <span class="hljs-keyword">return</span> value !== <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span>;
        <span class="hljs-attr">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(type)) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value) &amp;&amp; value.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkType</span>(item, type[<span class="hljs-number">0</span>]));
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-comment">// 创建实现接口的类</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createClass</span>(<span class="hljs-params">interfaceName, implementation</span>) {
    <span class="hljs-keyword">const</span> interfaceDef = <span class="hljs-variable language_">this</span>.<span class="hljs-property">interfaces</span>.<span class="hljs-title function_">get</span>(interfaceName);
    <span class="hljs-keyword">if</span> (!interfaceDef) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`接口 <span class="hljs-subst">${interfaceName}</span> 未定义`</span>);
    }
    
    <span class="hljs-comment">// 创建类</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">DynamicClass</span> = <span class="hljs-keyword">class</span> {
      <span class="hljs-title function_">constructor</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-keyword">if</span> (implementation.<span class="hljs-property">constructor</span>) {
          implementation.<span class="hljs-property">constructor</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
        }
        
        <span class="hljs-comment">// 验证实例是否符合接口</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">implements</span>(interfaceName)) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`类未正确实现接口 <span class="hljs-subst">${interfaceName}</span>`</span>);
        }
      }
      
      <span class="hljs-title function_">implements</span>(<span class="hljs-params">interfaceName</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">InterfaceChecker</span>.<span class="hljs-title function_">implements</span>(<span class="hljs-variable language_">this</span>, interfaceName);
      }
    };
    
    <span class="hljs-comment">// 添加接口要求的方法和属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [prop, descriptor] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(implementation)) {
      <span class="hljs-keyword">if</span> (prop !== <span class="hljs-string">'constructor'</span>) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-title class_">DynamicClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, prop, descriptor);
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">DynamicClass</span>;
  }
}

<span class="hljs-comment">// 定义接口</span>
<span class="hljs-title class_">InterfaceChecker</span>.<span class="hljs-title function_">defineInterface</span>(<span class="hljs-string">'Serializable'</span>, {
  <span class="hljs-attr">required</span>: {
    <span class="hljs-attr">toJSON</span>: <span class="hljs-string">'function'</span>,
    <span class="hljs-attr">fromJSON</span>: <span class="hljs-string">'function'</span>
  }
});

<span class="hljs-title class_">InterfaceChecker</span>.<span class="hljs-title function_">defineInterface</span>(<span class="hljs-string">'User'</span>, {
  <span class="hljs-attr">required</span>: {
    <span class="hljs-attr">id</span>: <span class="hljs-string">'number'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'string'</span>
  },
  <span class="hljs-attr">optional</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'string'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-string">'number'</span>
  },
  <span class="hljs-attr">methods</span>: [<span class="hljs-string">'save'</span>, <span class="hljs-string">'delete'</span>]
});

<span class="hljs-comment">// 2.2 使用接口</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">UserClass</span> = <span class="hljs-title class_">InterfaceChecker</span>.<span class="hljs-title function_">createClass</span>(<span class="hljs-string">'User'</span>, {
  <span class="hljs-attr">constructor</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">id, name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  },
  
  <span class="hljs-attr">save</span>: {
    <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`保存用户 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  },
  
  <span class="hljs-attr">delete</span>: {
    <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`删除用户 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  },
  
  <span class="hljs-attr">toJSON</span>: {
    <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>
      };
    }
  }
});

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserClass</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'Alice'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-title function_">implements</span>(<span class="hljs-string">'User'</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-title function_">implements</span>(<span class="hljs-string">'Serializable'</span>)); <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 2.3 运行时接口验证装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">implementsInterface</span>(<span class="hljs-params">interfaceName</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">target</span>) {
    <span class="hljs-keyword">const</span> originalConstructor = target;
    
    <span class="hljs-comment">// 返回新的构造函数</span>
    <span class="hljs-keyword">const</span> newConstructor = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
      <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title function_">originalConstructor</span>(...args);
      
      <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">InterfaceChecker</span>.<span class="hljs-title function_">implements</span>(instance, interfaceName)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`类 <span class="hljs-subst">${target.name}</span> 未实现接口 <span class="hljs-subst">${interfaceName}</span>`</span>);
      }
      
      <span class="hljs-keyword">return</span> instance;
    };
    
    <span class="hljs-comment">// 复制原型链</span>
    newConstructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = originalConstructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
    
    <span class="hljs-keyword">return</span> newConstructor;
  };
}

<span class="hljs-comment">// 使用装饰器</span>
@<span class="hljs-title function_">interface</span>(<span class="hljs-string">'User'</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdminUser</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">id, name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  
  <span class="hljs-title function_">save</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'保存管理员'</span>);
  }
  
  <span class="hljs-title function_">delete</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'删除管理员'</span>);
  }
}

<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> admin = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdminUser</span>(<span class="hljs-number">1</span>, <span class="hljs-string">'Admin'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AdminUser创建成功'</span>);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>);
}
</code></pre>
<h5 data-id="heading-6">泛型的实现与模拟</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2.4 泛型容器类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericContainer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span> = value;
  }
  
  <span class="hljs-keyword">get</span> <span class="hljs-title function_">value</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span>;
  }
  
  <span class="hljs-keyword">set</span> <span class="hljs-title function_">value</span>(<span class="hljs-params">newValue</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span> = newValue;
  }
  
  <span class="hljs-comment">// 泛型方法：转换值类型</span>
  <span class="hljs-title function_">map</span>(<span class="hljs-params">transformer</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericContainer</span>(<span class="hljs-title function_">transformer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span>));
  }
  
  <span class="hljs-comment">// 检查类型（运行时）</span>
  <span class="hljs-title function_">checkType</span>(<span class="hljs-params">expectedType</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span> === expectedType;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> numberContainer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericContainer</span>(<span class="hljs-number">42</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberContainer.<span class="hljs-property">value</span>); <span class="hljs-comment">// 42</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberContainer.<span class="hljs-title function_">checkType</span>(<span class="hljs-string">'number'</span>)); <span class="hljs-comment">// true</span>

<span class="hljs-keyword">const</span> stringContainer = numberContainer.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-string">`数字: <span class="hljs-subst">${n}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stringContainer.<span class="hljs-property">value</span>); <span class="hljs-comment">// "数字: 42"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stringContainer.<span class="hljs-title function_">checkType</span>(<span class="hljs-string">'string'</span>)); <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 2.5 泛型函数工厂</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createGenericFunction</span>(<span class="hljs-params">typeCheck</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 泛型身份函数</span>
    <span class="hljs-attr">identity</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) {
      <span class="hljs-keyword">if</span> (typeCheck &amp;&amp; !<span class="hljs-title function_">typeCheck</span>(value)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'类型不匹配'</span>);
      }
      <span class="hljs-keyword">return</span> value;
    },
    
    <span class="hljs-comment">// 泛型数组操作</span>
    <span class="hljs-attr">filterArray</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr, predicate</span>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'第一个参数必须是数组'</span>);
      }
      <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">filter</span>(predicate);
    },
    
    <span class="hljs-comment">// 泛型映射</span>
    <span class="hljs-attr">mapArray</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr, mapper</span>) {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'第一个参数必须是数组'</span>);
      }
      <span class="hljs-keyword">return</span> arr.<span class="hljs-title function_">map</span>(mapper);
    }
  };
}

<span class="hljs-comment">// 创建特定类型的泛型函数</span>
<span class="hljs-keyword">const</span> numberFunctions = <span class="hljs-title function_">createGenericFunction</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'number'</span>);
<span class="hljs-keyword">const</span> stringFunctions = <span class="hljs-title function_">createGenericFunction</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'string'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFunctions.<span class="hljs-title function_">identity</span>(<span class="hljs-number">123</span>)); <span class="hljs-comment">// 123</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stringFunctions.<span class="hljs-title function_">identity</span>(<span class="hljs-string">'hello'</span>)); <span class="hljs-comment">// "hello"</span>

<span class="hljs-comment">// 2.6 泛型约束模拟</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericValidator</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">value, constraints</span>) {
    <span class="hljs-comment">// 类型约束</span>
    <span class="hljs-keyword">if</span> (constraints.<span class="hljs-property">type</span> &amp;&amp; <span class="hljs-keyword">typeof</span> value !== constraints.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 最小/最大值约束</span>
    <span class="hljs-keyword">if</span> (constraints.<span class="hljs-property">min</span> !== <span class="hljs-literal">undefined</span> &amp;&amp; value &lt; constraints.<span class="hljs-property">min</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">if</span> (constraints.<span class="hljs-property">max</span> !== <span class="hljs-literal">undefined</span> &amp;&amp; value &gt; constraints.<span class="hljs-property">max</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 长度约束</span>
    <span class="hljs-keyword">if</span> (constraints.<span class="hljs-property">minLength</span> !== <span class="hljs-literal">undefined</span> &amp;&amp; value.<span class="hljs-property">length</span> &lt; constraints.<span class="hljs-property">minLength</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">if</span> (constraints.<span class="hljs-property">maxLength</span> !== <span class="hljs-literal">undefined</span> &amp;&amp; value.<span class="hljs-property">length</span> &gt; constraints.<span class="hljs-property">maxLength</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 自定义验证函数</span>
    <span class="hljs-keyword">if</span> (constraints.<span class="hljs-property">validator</span> &amp;&amp; !constraints.<span class="hljs-title function_">validator</span>(value)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-comment">// 创建受约束的泛型类</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createConstrainedClass</span>(<span class="hljs-params">constraints</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstrainedContainer</span> {
      <span class="hljs-title function_">constructor</span>(<span class="hljs-params">value</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">GenericValidator</span>.<span class="hljs-title function_">validate</span>(value, constraints)) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'值不符合约束条件'</span>);
        }
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span> = value;
      }
      
      <span class="hljs-keyword">get</span> <span class="hljs-title function_">value</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span>;
      }
      
      <span class="hljs-keyword">set</span> <span class="hljs-title function_">value</span>(<span class="hljs-params">newValue</span>) {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">GenericValidator</span>.<span class="hljs-title function_">validate</span>(newValue, constraints)) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'新值不符合约束条件'</span>);
        }
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span> = newValue;
      }
    };
  }
}

<span class="hljs-comment">// 使用泛型约束</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">NumberContainer</span> = <span class="hljs-title class_">GenericValidator</span>.<span class="hljs-title function_">createConstrainedClass</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>,
  <span class="hljs-attr">min</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">max</span>: <span class="hljs-number">100</span>
});

<span class="hljs-keyword">const</span> <span class="hljs-title class_">StringContainer</span> = <span class="hljs-title class_">GenericValidator</span>.<span class="hljs-title function_">createConstrainedClass</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
  <span class="hljs-attr">minLength</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">maxLength</span>: <span class="hljs-number">50</span>
});

<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> numContainer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberContainer</span>(<span class="hljs-number">50</span>); <span class="hljs-comment">// 成功</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numContainer.<span class="hljs-property">value</span>); <span class="hljs-comment">// 50</span>
  
  <span class="hljs-keyword">const</span> strContainer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringContainer</span>(<span class="hljs-string">'Hello'</span>); <span class="hljs-comment">// 成功</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strContainer.<span class="hljs-property">value</span>); <span class="hljs-comment">// "Hello"</span>
  
  <span class="hljs-comment">// numContainer.value = 150; // 抛出错误</span>
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>);
}

<span class="hljs-comment">// 2.7 泛型工具类型模拟</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericUtils</span> {
  <span class="hljs-comment">// 模拟 Partial&lt;T&gt;</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">partial</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">const</span> result = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
        result[key] = obj[key];
      }
    }
    <span class="hljs-keyword">return</span> result;
  }
  
  <span class="hljs-comment">// 模拟 Readonly&lt;T&gt;</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">readonly</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">const</span> result = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(result, key, {
          <span class="hljs-attr">value</span>: obj[key],
          <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>
        });
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(result);
  }
  
  <span class="hljs-comment">// 模拟 Pick&lt;T, K&gt;</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">pick</span>(<span class="hljs-params">obj, keys</span>) {
    <span class="hljs-keyword">const</span> result = {};
    keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> obj) {
        result[key] = obj[key];
      }
    });
    <span class="hljs-keyword">return</span> result;
  }
  
  <span class="hljs-comment">// 模拟 Omit&lt;T, K&gt;</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">omit</span>(<span class="hljs-params">obj, keys</span>) {
    <span class="hljs-keyword">const</span> result = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key) &amp;&amp; !keys.<span class="hljs-title function_">includes</span>(key)) {
        result[key] = obj[key];
      }
    }
    <span class="hljs-keyword">return</span> result;
  }
  
  <span class="hljs-comment">// 模拟 Record&lt;K, T&gt;</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">record</span>(<span class="hljs-params">keys, valueCreator</span>) {
    <span class="hljs-keyword">const</span> result = {};
    keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      result[key] = <span class="hljs-title function_">valueCreator</span>(key);
    });
    <span class="hljs-keyword">return</span> result;
  }
}

<span class="hljs-comment">// 使用泛型工具</span>
<span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">GenericUtils</span>.<span class="hljs-title function_">pick</span>(user, [<span class="hljs-string">'id'</span>, <span class="hljs-string">'name'</span>])); <span class="hljs-comment">// { id: 1, name: 'John' }</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">GenericUtils</span>.<span class="hljs-title function_">omit</span>(user, [<span class="hljs-string">'email'</span>, <span class="hljs-string">'age'</span>])); <span class="hljs-comment">// { id: 1, name: 'John' }</span>

<span class="hljs-keyword">const</span> readonlyUser = <span class="hljs-title class_">GenericUtils</span>.<span class="hljs-title function_">readonly</span>(user);
<span class="hljs-comment">// readonlyUser.name = 'Bob'; // 在严格模式下会抛出错误</span>
</code></pre>
<h4 data-id="heading-7">三、装饰器的实现原理</h4>
<h5 data-id="heading-8">装饰器基础实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 3.1 基础装饰器工厂</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-params">decoratorFunc</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-comment">// 类装饰器</span>
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">0</span>] === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">const</span> targetClass = args[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">decoratorFunc</span>(targetClass) || targetClass;
    }
    
    <span class="hljs-comment">// 方法装饰器</span>
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> === <span class="hljs-number">3</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">2</span>] === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">const</span> [target, property, descriptor] = args;
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">decoratorFunc</span>(target, property, descriptor) || descriptor;
    }
    
    <span class="hljs-comment">// 属性装饰器</span>
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> === <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">1</span>] === <span class="hljs-string">'string'</span>) {
      <span class="hljs-keyword">const</span> [target, property] = args;
      <span class="hljs-title function_">decoratorFunc</span>(target, property);
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 参数装饰器</span>
    <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> === <span class="hljs-number">3</span> &amp;&amp; <span class="hljs-keyword">typeof</span> args[<span class="hljs-number">2</span>] === <span class="hljs-string">'number'</span>) {
      <span class="hljs-keyword">const</span> [target, property, parameterIndex] = args;
      <span class="hljs-title function_">decoratorFunc</span>(target, property, parameterIndex);
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">decoratorFunc</span>(...args);
  };
}

<span class="hljs-comment">// 3.2 类装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">classDecorator</span>(<span class="hljs-params">logMessage</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">targetClass</span>) =&gt;</span> {
    <span class="hljs-comment">// 保存原始构造函数</span>
    <span class="hljs-keyword">const</span> originalConstructor = targetClass;
    
    <span class="hljs-comment">// 创建新的构造函数</span>
    <span class="hljs-keyword">const</span> newConstructor = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${logMessage}</span>: 创建 <span class="hljs-subst">${originalConstructor.name}</span> 实例`</span>);
      <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title function_">originalConstructor</span>(...args);
      
      <span class="hljs-comment">// 可以在这里修改实例</span>
      <span class="hljs-keyword">if</span> (logMessage.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'sealed'</span>)) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">seal</span>(instance);
      }
      
      <span class="hljs-keyword">return</span> instance;
    };
    
    <span class="hljs-comment">// 复制原型链</span>
    newConstructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = originalConstructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
    
    <span class="hljs-comment">// 复制静态属性</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(newConstructor, originalConstructor);
    
    <span class="hljs-keyword">return</span> newConstructor;
  });
}

<span class="hljs-comment">// 3.3 方法装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">methodDecorator</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property, descriptor</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;
    
    descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
      <span class="hljs-comment">// 前置处理</span>
      <span class="hljs-keyword">if</span> (options.<span class="hljs-property">log</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`调用方法: <span class="hljs-subst">${property}</span>, 参数:`</span>, args);
      }
      
      <span class="hljs-keyword">if</span> (options.<span class="hljs-property">measureTime</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">`方法 <span class="hljs-subst">${property}</span> 执行时间`</span>);
      }
      
      <span class="hljs-comment">// 执行原始方法</span>
      <span class="hljs-keyword">const</span> result = originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      
      <span class="hljs-comment">// 后置处理</span>
      <span class="hljs-keyword">if</span> (options.<span class="hljs-property">measureTime</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">`方法 <span class="hljs-subst">${property}</span> 执行时间`</span>);
      }
      
      <span class="hljs-keyword">if</span> (options.<span class="hljs-property">log</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`方法 <span class="hljs-subst">${property}</span> 返回:`</span>, result);
      }
      
      <span class="hljs-keyword">return</span> result;
    };
    
    <span class="hljs-keyword">return</span> descriptor;
  });
}

<span class="hljs-comment">// 3.4 属性装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">propertyDecorator</span>(<span class="hljs-params">defaultValue</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property</span>) =&gt;</span> {
    <span class="hljs-comment">// 创建私有属性名称</span>
    <span class="hljs-keyword">const</span> privateProp = <span class="hljs-string">`_<span class="hljs-subst">${property}</span>`</span>;
    
    <span class="hljs-comment">// 定义getter和setter</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target, property, {
      <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[privateProp] !== <span class="hljs-literal">undefined</span> ? <span class="hljs-variable language_">this</span>[privateProp] : defaultValue;
      },
      <span class="hljs-title function_">set</span>(<span class="hljs-params">value</span>) {
        <span class="hljs-variable language_">this</span>[privateProp] = value;
      },
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
    });
  });
}

<span class="hljs-comment">// 3.5 参数装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parameterDecorator</span>(<span class="hljs-params">validator</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property, parameterIndex</span>) =&gt;</span> {
    <span class="hljs-comment">// 获取方法的参数验证元数据</span>
    <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">__parameterValidations</span>) {
      target.<span class="hljs-property">__parameterValidations</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    }
    
    <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${property}</span>_<span class="hljs-subst">${parameterIndex}</span>`</span>;
    target.<span class="hljs-property">__parameterValidations</span>.<span class="hljs-title function_">set</span>(key, validator);
    
    <span class="hljs-comment">// 重写方法以添加参数验证</span>
    <span class="hljs-keyword">const</span> originalMethod = target[property];
    
    target[property] = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
      <span class="hljs-comment">// 验证参数</span>
      <span class="hljs-keyword">const</span> validator = target.<span class="hljs-property">__parameterValidations</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">`<span class="hljs-subst">${property}</span>_<span class="hljs-subst">${parameterIndex}</span>`</span>);
      <span class="hljs-keyword">if</span> (validator &amp;&amp; !<span class="hljs-title function_">validator</span>(args[parameterIndex])) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`参数 <span class="hljs-subst">${parameterIndex}</span> 验证失败`</span>);
      }
      
      <span class="hljs-keyword">return</span> originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
    };
  });
}

<span class="hljs-comment">// 使用示例</span>
@<span class="hljs-title function_">classDecorator</span>(<span class="hljs-string">'自动日志记录 - sealed'</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  @<span class="hljs-title function_">propertyDecorator</span>(<span class="hljs-string">'guest'</span>)
  role;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
  
  @<span class="hljs-title function_">methodDecorator</span>({ <span class="hljs-attr">log</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">measureTime</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-title function_">greet</span>(<span class="hljs-params">@parameterDecorator(val =&gt; <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'string'</span>) message</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 说: <span class="hljs-subst">${message}</span>`</span>;
  }
  
  @<span class="hljs-title function_">methodDecorator</span>({ <span class="hljs-attr">log</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-title function_">setRole</span>(<span class="hljs-params">@parameterDecorator(role =&gt; [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'user'</span>, <span class="hljs-string">'guest'</span>].includes(role)) newRole</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">role</span> = newRole;
  }
}

<span class="hljs-keyword">const</span> service = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>(<span class="hljs-string">'Alice'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(service.<span class="hljs-property">role</span>); <span class="hljs-comment">// "guest" (默认值)</span>
service.<span class="hljs-title function_">setRole</span>(<span class="hljs-string">'admin'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(service.<span class="hljs-title function_">greet</span>(<span class="hljs-string">'你好!'</span>)); <span class="hljs-comment">// 输出日志和结果</span>
</code></pre>
<h5 data-id="heading-9">高级装饰器模式</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 3.6 依赖注入装饰器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DependencyContainer</span> {
  <span class="hljs-keyword">static</span> dependencies = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">register</span>(<span class="hljs-params">token, implementation</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">set</span>(token, implementation);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">token</span>) {
    <span class="hljs-keyword">const</span> dependency = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">get</span>(token);
    <span class="hljs-keyword">if</span> (!dependency) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`未找到依赖: <span class="hljs-subst">${token}</span>`</span>);
    }
    
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> dependency === <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">dependency</span>();
    }
    
    <span class="hljs-keyword">return</span> dependency;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">inject</span>(<span class="hljs-params">token</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property, descriptor</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (descriptor) {
      <span class="hljs-comment">// 方法参数注入</span>
      <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;
      
      descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-comment">// 解析依赖</span>
        <span class="hljs-keyword">const</span> dependency = <span class="hljs-title class_">DependencyContainer</span>.<span class="hljs-title function_">resolve</span>(token);
        <span class="hljs-keyword">return</span> originalMethod.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, dependency, ...args);
      };
      
      <span class="hljs-keyword">return</span> descriptor;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 属性注入</span>
      <span class="hljs-keyword">return</span> {
        <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">DependencyContainer</span>.<span class="hljs-title function_">resolve</span>(token);
        },
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
      };
    }
  });
}

<span class="hljs-comment">// 3.7 路由装饰器（类似Angular/NestJS）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Router</span> {
  <span class="hljs-keyword">static</span> routes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property, descriptor</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">const</span> routeKey = <span class="hljs-string">`GET <span class="hljs-subst">${path}</span>`</span>;
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>.<span class="hljs-title function_">set</span>(routeKey, {
        <span class="hljs-attr">controller</span>: target.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>,
        <span class="hljs-attr">method</span>: property,
        <span class="hljs-attr">handler</span>: originalMethod
      });
      
      descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`路由: <span class="hljs-subst">${routeKey}</span>`</span>);
        <span class="hljs-keyword">return</span> originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      };
      
      <span class="hljs-keyword">return</span> descriptor;
    });
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">post</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property, descriptor</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">const</span> routeKey = <span class="hljs-string">`POST <span class="hljs-subst">${path}</span>`</span>;
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>.<span class="hljs-title function_">set</span>(routeKey, {
        <span class="hljs-attr">controller</span>: target.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>,
        <span class="hljs-attr">method</span>: property,
        <span class="hljs-attr">handler</span>: originalMethod
      });
      
      <span class="hljs-keyword">return</span> descriptor;
    });
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">method, path</span>) {
    <span class="hljs-keyword">const</span> routeKey = <span class="hljs-string">`<span class="hljs-subst">${method}</span> <span class="hljs-subst">${path}</span>`</span>;
    <span class="hljs-keyword">const</span> route = <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>.<span class="hljs-title function_">get</span>(routeKey);
    
    <span class="hljs-keyword">if</span> (route) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`处理请求: <span class="hljs-subst">${routeKey}</span>`</span>);
      <span class="hljs-comment">// 实际中会创建控制器实例并调用方法</span>
      <span class="hljs-keyword">return</span> route.<span class="hljs-property">handler</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}

<span class="hljs-comment">// 3.8 验证装饰器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Validator</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">target, property, value</span>) {
    <span class="hljs-keyword">const</span> validations = target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>;
    <span class="hljs-keyword">if</span> (validations &amp;&amp; validations[property]) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> validation <span class="hljs-keyword">of</span> validations[property]) {
        <span class="hljs-keyword">if</span> (!validation.<span class="hljs-title function_">validator</span>(value)) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(validation.<span class="hljs-property">message</span> || <span class="hljs-string">`验证失败: <span class="hljs-subst">${property}</span>`</span>);
        }
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">required</span>(<span class="hljs-params">message = <span class="hljs-string">'该字段是必填的'</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property, descriptor</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (descriptor) {
        <span class="hljs-comment">// 方法参数验证</span>
        <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>;
        
        descriptor.<span class="hljs-property">value</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
          <span class="hljs-keyword">const</span> value = args[<span class="hljs-number">0</span>];
          <span class="hljs-keyword">if</span> (!value &amp;&amp; value !== <span class="hljs-number">0</span> &amp;&amp; value !== <span class="hljs-literal">false</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);
          }
          <span class="hljs-keyword">return</span> originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
        };
        
        <span class="hljs-keyword">return</span> descriptor;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 属性验证</span>
        <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>) {
          target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span> = {};
        }
        
        <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property]) {
          target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property] = [];
        }
        
        target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property].<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">validator</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value != <span class="hljs-literal">null</span> &amp;&amp; value !== <span class="hljs-string">''</span>,
          message
        });
        
        <span class="hljs-comment">// 创建getter/setter</span>
        <span class="hljs-keyword">const</span> privateProp = <span class="hljs-string">`_<span class="hljs-subst">${property}</span>`</span>;
        
        <span class="hljs-keyword">return</span> {
          <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[privateProp];
          },
          <span class="hljs-title function_">set</span>(<span class="hljs-params">value</span>) {
            <span class="hljs-variable language_">this</span>[privateProp] = value;
          },
          <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
        };
      }
    });
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">minLength</span>(<span class="hljs-params">length, message</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>) {
        target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span> = {};
      }
      
      <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property]) {
        target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property] = [];
      }
      
      target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property].<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">validator</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> !value || value.<span class="hljs-property">length</span> &gt;= length,
        <span class="hljs-attr">message</span>: message || <span class="hljs-string">`长度不能少于 <span class="hljs-subst">${length}</span> 个字符`</span>
      });
    });
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">maxLength</span>(<span class="hljs-params">length, message</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">createDecorator</span>(<span class="hljs-function">(<span class="hljs-params">target, property</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>) {
        target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span> = {};
      }
      
      <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property]) {
        target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property] = [];
      }
      
      target.<span class="hljs-property">constructor</span>.<span class="hljs-property">__validations</span>[property].<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">validator</span>: <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> !value || value.<span class="hljs-property">length</span> &lt;= length,
        <span class="hljs-attr">message</span>: message || <span class="hljs-string">`长度不能超过 <span class="hljs-subst">${length}</span> 个字符`</span>
      });
    });
  }
}

<span class="hljs-comment">// 使用高级装饰器</span>
@<span class="hljs-title function_">classDecorator</span>(<span class="hljs-string">'用户控制器'</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  @<span class="hljs-title class_">Router</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>)
  <span class="hljs-title function_">getAllUsers</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> [<span class="hljs-string">'Alice'</span>, <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'Charlie'</span>];
  }
  
  @<span class="hljs-title class_">Router</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/users'</span>)
  <span class="hljs-title function_">createUser</span>(<span class="hljs-params">@Validator.required() name</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, name };
  }
}

<span class="hljs-comment">// 用户模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  @<span class="hljs-title class_">Validator</span>.required(<span class="hljs-string">'用户名是必填的'</span>)
  @<span class="hljs-title class_">Validator</span>.<span class="hljs-title function_">minLength</span>(<span class="hljs-number">3</span>, <span class="hljs-string">'用户名至少3个字符'</span>)
  @<span class="hljs-title class_">Validator</span>.<span class="hljs-title function_">maxLength</span>(<span class="hljs-number">20</span>, <span class="hljs-string">'用户名最多20个字符'</span>)
  username;
  
  @<span class="hljs-title class_">Validator</span>.required(<span class="hljs-string">'密码是必填的'</span>)
  @<span class="hljs-title class_">Validator</span>.<span class="hljs-title function_">minLength</span>(<span class="hljs-number">6</span>, <span class="hljs-string">'密码至少6个字符'</span>)
  password;
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">username, password</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> = username;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = password;
  }
  
  <span class="hljs-title function_">validate</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prop <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hasOwnProperty</span>(prop)) {
        <span class="hljs-title class_">Validator</span>.<span class="hljs-title function_">validate</span>(<span class="hljs-variable language_">this</span>, prop, <span class="hljs-variable language_">this</span>[prop]);
      }
    }
  }
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">'alice'</span>, <span class="hljs-string">'password123'</span>);
user.<span class="hljs-title function_">validate</span>(); <span class="hljs-comment">// 成功</span>

<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> invalidUser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">'a'</span>, <span class="hljs-string">'123'</span>);
  invalidUser.<span class="hljs-title function_">validate</span>(); <span class="hljs-comment">// 抛出错误</span>
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>);
}
</code></pre>
<h4 data-id="heading-10">四、类型推断与类型系统</h4>
<h5 data-id="heading-11">类型推断实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 4.1 类型推断引擎</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeInferenceEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">typeRegistry</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">variableTypes</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// 推断变量类型</span>
  <span class="hljs-title function_">inferVariableType</span>(<span class="hljs-params">name, value</span>) {
    <span class="hljs-keyword">let</span> inferredType = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">inferValueType</span>(value);
    
    <span class="hljs-comment">// 检查是否已经声明过类型</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">variableTypes</span>.<span class="hljs-title function_">has</span>(name)) {
      <span class="hljs-keyword">const</span> declaredType = <span class="hljs-variable language_">this</span>.<span class="hljs-property">variableTypes</span>.<span class="hljs-title function_">get</span>(name);
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isCompatible</span>(inferredType, declaredType)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`类型不匹配: 变量 <span class="hljs-subst">${name}</span> 声明为 <span class="hljs-subst">${declaredType}</span>, 但推断为 <span class="hljs-subst">${inferredType}</span>`</span>);
      }
      <span class="hljs-keyword">return</span> declaredType;
    }
    
    <span class="hljs-comment">// 记录推断的类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">variableTypes</span>.<span class="hljs-title function_">set</span>(name, inferredType);
    <span class="hljs-keyword">return</span> inferredType;
  }
  
  <span class="hljs-comment">// 推断值类型</span>
  <span class="hljs-title function_">inferValueType</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'null'</span>;
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'undefined'</span>;
    
    <span class="hljs-keyword">const</span> type = <span class="hljs-keyword">typeof</span> value;
    
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value)) {
        <span class="hljs-comment">// 推断数组元素类型</span>
        <span class="hljs-keyword">if</span> (value.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'any[]'</span>;
        <span class="hljs-keyword">const</span> elementType = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">inferValueType</span>(value[<span class="hljs-number">0</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${elementType}</span>[]`</span>;
      }
      
      <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'Date'</span>;
      <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'RegExp'</span>;
      
      <span class="hljs-comment">// 推断对象结构</span>
      <span class="hljs-keyword">const</span> structure = {};
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> value) {
        <span class="hljs-keyword">if</span> (value.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
          structure[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">inferValueType</span>(value[key]);
        }
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(structure);
    }
    
    <span class="hljs-keyword">return</span> type;
  }
  
  <span class="hljs-comment">// 检查类型兼容性</span>
  <span class="hljs-title function_">isCompatible</span>(<span class="hljs-params">type1, type2</span>) {
    <span class="hljs-keyword">if</span> (type1 === type2) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 处理any类型</span>
    <span class="hljs-keyword">if</span> (type1 === <span class="hljs-string">'any'</span> || type2 === <span class="hljs-string">'any'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-comment">// 处理数组类型</span>
    <span class="hljs-keyword">if</span> (type1.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'[]'</span>) &amp;&amp; type2.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'[]'</span>)) {
      <span class="hljs-keyword">const</span> elementType1 = type1.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">2</span>);
      <span class="hljs-keyword">const</span> elementType2 = type2.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">2</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isCompatible</span>(elementType1, elementType2);
    }
    
    <span class="hljs-comment">// 处理对象类型</span>
    <span class="hljs-keyword">if</span> (type1.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'{'</span>) &amp;&amp; type2.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'{'</span>)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> obj1 = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(type1);
        <span class="hljs-keyword">const</span> obj2 = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(type2);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj1) {
          <span class="hljs-keyword">if</span> (obj1.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
            <span class="hljs-keyword">if</span> (!obj2[key] || !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isCompatible</span>(obj1[key], obj2[key])) {
              <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
          }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-comment">// 推断函数返回类型</span>
  <span class="hljs-title function_">inferFunctionReturn</span>(<span class="hljs-params">func, args</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = func.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, args);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">inferValueType</span>(result);
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'any'</span>;
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> engine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeInferenceEngine</span>();

<span class="hljs-keyword">const</span> variables = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">scores</span>: [<span class="hljs-number">95</span>, <span class="hljs-number">88</span>, <span class="hljs-number">92</span>],
  <span class="hljs-attr">profile</span>: {
    <span class="hljs-attr">email</span>: <span class="hljs-string">'alice@example.com'</span>,
    <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [name, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(variables)) {
  <span class="hljs-keyword">const</span> type = engine.<span class="hljs-title function_">inferVariableType</span>(name, value);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span>: <span class="hljs-subst">${type}</span>`</span>);
}

<span class="hljs-comment">// 4.2 联合类型推断</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">inferUnionType</span>(<span class="hljs-params">values</span>) {
  <span class="hljs-keyword">const</span> types = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> values) {
    <span class="hljs-keyword">const</span> engine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeInferenceEngine</span>();
    types.<span class="hljs-title function_">add</span>(engine.<span class="hljs-title function_">inferValueType</span>(value));
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(types).<span class="hljs-title function_">join</span>(<span class="hljs-string">' | '</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">inferUnionType</span>([<span class="hljs-number">1</span>, <span class="hljs-string">'hello'</span>, <span class="hljs-literal">true</span>])); <span class="hljs-comment">// "number | string | boolean"</span>

<span class="hljs-comment">// 4.3 上下文类型推断</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ContextualTyping</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">inferWithContext</span>(<span class="hljs-params">value, context</span>) {
    <span class="hljs-keyword">const</span> engine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeInferenceEngine</span>();
    <span class="hljs-keyword">const</span> valueType = engine.<span class="hljs-title function_">inferValueType</span>(value);
    
    <span class="hljs-comment">// 如果有上下文类型，检查兼容性</span>
    <span class="hljs-keyword">if</span> (context.<span class="hljs-property">expectedType</span>) {
      <span class="hljs-keyword">if</span> (!engine.<span class="hljs-title function_">isCompatible</span>(valueType, context.<span class="hljs-property">expectedType</span>)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`上下文类型不匹配: 期望 <span class="hljs-subst">${context.expectedType}</span>, 实际 <span class="hljs-subst">${valueType}</span>`</span>);
      }
      <span class="hljs-keyword">return</span> context.<span class="hljs-property">expectedType</span>;
    }
    
    <span class="hljs-keyword">return</span> valueType;
  }
}

<span class="hljs-keyword">const</span> context = { <span class="hljs-attr">expectedType</span>: <span class="hljs-string">'string'</span> };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ContextualTyping</span>.<span class="hljs-title function_">inferWithContext</span>(<span class="hljs-string">'hello'</span>, context)); <span class="hljs-comment">// "string"</span>
<span class="hljs-comment">// ContextualTyping.inferWithContext(123, context); // 抛出错误</span>
</code></pre>
<h5 data-id="heading-12">高级类型系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 4.4 条件类型模拟</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionalType</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">extends</span>(<span class="hljs-params">T, U</span>) {
    <span class="hljs-comment">// 简化实现：检查T是否可以赋值给U</span>
    <span class="hljs-keyword">return</span> T === U || T === <span class="hljs-string">'any'</span>;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">extract</span>(<span class="hljs-params">T, U</span>) {
    <span class="hljs-comment">// 模拟 Extract&lt;T, U&gt;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extends</span>(T, U)) {
      <span class="hljs-keyword">return</span> T;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">'never'</span>;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">exclude</span>(<span class="hljs-params">T, U</span>) {
    <span class="hljs-comment">// 模拟 Exclude&lt;T, U&gt;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extends</span>(T, U)) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'never'</span>;
    }
    <span class="hljs-keyword">return</span> T;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">nonNullable</span>(<span class="hljs-params">T</span>) {
    <span class="hljs-comment">// 模拟 NonNullable&lt;T&gt;</span>
    <span class="hljs-keyword">if</span> (T === <span class="hljs-string">'null'</span> || T === <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'never'</span>;
    }
    <span class="hljs-keyword">return</span> T;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">returnType</span>(<span class="hljs-params">func</span>) {
    <span class="hljs-comment">// 模拟 ReturnType&lt;T&gt;</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">func</span>();
      <span class="hljs-keyword">const</span> engine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeInferenceEngine</span>();
      <span class="hljs-keyword">return</span> engine.<span class="hljs-title function_">inferValueType</span>(result);
    } <span class="hljs-keyword">catch</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'any'</span>;
    }
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">parameters</span>(<span class="hljs-params">func</span>) {
    <span class="hljs-comment">// 模拟 Parameters&lt;T&gt;</span>
    <span class="hljs-keyword">const</span> funcStr = func.<span class="hljs-title function_">toString</span>();
    <span class="hljs-keyword">const</span> paramMatch = funcStr.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\(([^)]*)\)/</span>);
    
    <span class="hljs-keyword">if</span> (paramMatch) {
      <span class="hljs-keyword">const</span> params = paramMatch[<span class="hljs-number">1</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-title function_">trim</span>());
      <span class="hljs-keyword">return</span> params.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">param</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> [name, type] = param.<span class="hljs-title function_">split</span>(<span class="hljs-string">':'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>());
        <span class="hljs-keyword">return</span> type || <span class="hljs-string">'any'</span>;
      });
    }
    
    <span class="hljs-keyword">return</span> [];
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ConditionalType</span>.<span class="hljs-title function_">extends</span>(<span class="hljs-string">'string'</span>, <span class="hljs-string">'string'</span>)); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ConditionalType</span>.<span class="hljs-title function_">extract</span>(<span class="hljs-string">'string | number'</span>, <span class="hljs-string">'string'</span>)); <span class="hljs-comment">// "string"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ConditionalType</span>.<span class="hljs-title function_">exclude</span>(<span class="hljs-string">'string | number'</span>, <span class="hljs-string">'string'</span>)); <span class="hljs-comment">// "number"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ConditionalType</span>.<span class="hljs-title function_">nonNullable</span>(<span class="hljs-string">'string | null'</span>)); <span class="hljs-comment">// "string"</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">sampleFunc</span>(<span class="hljs-params">x, y</span>) {
  <span class="hljs-keyword">return</span> x + y;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ConditionalType</span>.<span class="hljs-title function_">returnType</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">sampleFunc</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))); <span class="hljs-comment">// "number"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">ConditionalType</span>.<span class="hljs-title function_">parameters</span>(sampleFunc)); <span class="hljs-comment">// ["any", "any"]</span>

<span class="hljs-comment">// 4.5 映射类型模拟</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MappedType</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">partial</span>(<span class="hljs-params">T</span>) {
    <span class="hljs-comment">// 模拟 Partial&lt;T&gt;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> T === <span class="hljs-string">'string'</span> &amp;&amp; T.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'{'</span>)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(T);
        <span class="hljs-keyword">const</span> result = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
          result[key] = obj[key] + <span class="hljs-string">'?'</span>; <span class="hljs-comment">// 添加可选标记</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result);
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">return</span> T;
      }
    }
    <span class="hljs-keyword">return</span> T;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">required</span>(<span class="hljs-params">T</span>) {
    <span class="hljs-comment">// 模拟 Required&lt;T&gt;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> T === <span class="hljs-string">'string'</span> &amp;&amp; T.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'{'</span>)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(T);
        <span class="hljs-keyword">const</span> result = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
          <span class="hljs-keyword">const</span> type = obj[key].<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'?'</span>) ? obj[key].<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>) : obj[key];
          result[key] = type;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result);
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">return</span> T;
      }
    }
    <span class="hljs-keyword">return</span> T;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">readonly</span>(<span class="hljs-params">T</span>) {
    <span class="hljs-comment">// 模拟 Readonly&lt;T&gt;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> T === <span class="hljs-string">'string'</span> &amp;&amp; T.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'{'</span>)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(T);
        <span class="hljs-keyword">const</span> result = {};
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
          result[key] = <span class="hljs-string">'readonly '</span> + obj[key];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result);
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-keyword">return</span> T;
      }
    }
    <span class="hljs-keyword">return</span> T;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">record</span>(<span class="hljs-params">K, T</span>) {
    <span class="hljs-comment">// 模拟 Record&lt;K, T&gt;</span>
    <span class="hljs-keyword">const</span> keys = K.<span class="hljs-title function_">split</span>(<span class="hljs-string">' | '</span>);
    <span class="hljs-keyword">const</span> result = {};
    keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> cleanKey = key.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/['"]/g</span>, <span class="hljs-string">''</span>);
      result[cleanKey] = T;
    });
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> userType = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'string'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-string">'number?'</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'string'</span>
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Partial:'</span>, <span class="hljs-title class_">MappedType</span>.<span class="hljs-title function_">partial</span>(userType));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Required:'</span>, <span class="hljs-title class_">MappedType</span>.required(userType));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Readonly:'</span>, <span class="hljs-title class_">MappedType</span>.<span class="hljs-title function_">readonly</span>(userType));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Record:'</span>, <span class="hljs-title class_">MappedType</span>.<span class="hljs-title function_">record</span>(<span class="hljs-string">'"id" | "name"'</span>, <span class="hljs-string">'string'</span>));
</code></pre>
<h4 data-id="heading-13">五、模块与命名空间</h4>
<h5 data-id="heading-14">TypeScript模块系统</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 5.1 模块加载器模拟</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeScriptModuleLoader</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleCache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// 定义模块</span>
  <span class="hljs-title function_">define</span>(<span class="hljs-params">moduleId, dependencies, factory</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">set</span>(moduleId, {
      dependencies,
      factory,
      <span class="hljs-attr">exports</span>: {},
      <span class="hljs-attr">resolved</span>: <span class="hljs-literal">false</span>
    });
  }
  
  <span class="hljs-comment">// 解析模块</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">moduleId</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleCache</span>.<span class="hljs-title function_">has</span>(moduleId)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleCache</span>.<span class="hljs-title function_">get</span>(moduleId);
    }
    
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">get</span>(moduleId);
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">module</span>) {
      <span class="hljs-comment">// 尝试作为外部模块加载</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadExternalModule</span>(moduleId);
    }
    
    <span class="hljs-comment">// 解析依赖</span>
    <span class="hljs-keyword">const</span> depPromises = <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'exports'</span>) <span class="hljs-keyword">return</span> {};
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'require'</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">require</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
      <span class="hljs-keyword">if</span> (dep === <span class="hljs-string">'module'</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: moduleId, <span class="hljs-attr">exports</span>: {} };
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-built_in">require</span>(dep);
    });
    
    <span class="hljs-keyword">const</span> dependencies = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(depPromises);
    
    <span class="hljs-comment">// 执行工厂函数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">exports</span> = <span class="hljs-variable language_">module</span>.<span class="hljs-property">factory</span>.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, dependencies);
    
    <span class="hljs-comment">// 缓存结果</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">exports</span> || {};
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">resolved</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moduleCache</span>.<span class="hljs-title function_">set</span>(moduleId, <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
  }
  
  <span class="hljs-comment">// 加载外部模块（模拟）</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadExternalModule</span>(<span class="hljs-params">moduleId</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`加载外部模块: <span class="hljs-subst">${moduleId}</span>`</span>);
    
    <span class="hljs-comment">// 模拟动态导入</span>
    <span class="hljs-keyword">if</span> (moduleId.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.'</span>)) {
      <span class="hljs-comment">// 相对路径</span>
      <span class="hljs-keyword">const</span> mockModule = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">mockLoadModule</span>(moduleId);
      <span class="hljs-keyword">return</span> mockModule;
    }
    
    <span class="hljs-comment">// 假设是npm包</span>
    <span class="hljs-keyword">return</span> {};
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">mockLoadModule</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-comment">// 模拟模块内容</span>
    <span class="hljs-keyword">const</span> mockModules = {
      <span class="hljs-string">'./math'</span>: {
        <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,
        <span class="hljs-attr">subtract</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b
      },
      <span class="hljs-string">'./utils'</span>: {
        <span class="hljs-attr">format</span>: <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> str.<span class="hljs-title function_">toUpperCase</span>(),
        <span class="hljs-attr">parse</span>: <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(str)
      }
    };
    
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>)); <span class="hljs-comment">// 模拟延迟</span>
    
    <span class="hljs-keyword">return</span> mockModules[path] || {};
  }
  
  <span class="hljs-comment">// 编译TypeScript模块</span>
  <span class="hljs-title function_">compileModule</span>(<span class="hljs-params">source</span>) {
    <span class="hljs-comment">// 移除类型注解</span>
    <span class="hljs-keyword">const</span> jsCode = source
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:\s*\w+(?:&lt;[^&gt;]*&gt;)?(?=\s*[;,=){}])/g</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// 移除类型注解</span>
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/export\s+(?:default\s+)?/g</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// 简化导出</span>
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/import\s+.*?from\s+['"](.+)['"]/g</span>, <span class="hljs-string">'// 导入: $1'</span>); <span class="hljs-comment">// 注释化导入</span>
    
    <span class="hljs-keyword">return</span> jsCode;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeScriptModuleLoader</span>();

<span class="hljs-comment">// 定义TypeScript模块</span>
<span class="hljs-keyword">const</span> mathSource = <span class="hljs-string">`
export function add(a: number, b: number): number {
  return a + b;
}

export function subtract(a: number, b: number): number {
  return a - b;
}

export default class Calculator {
  multiply(a: number, b: number): number {
    return a * b;
  }
}
`</span>;

<span class="hljs-keyword">const</span> appSource = <span class="hljs-string">`
import { add } from './math';
import Calculator from './math';

export function calculate(): number {
  const calc = new Calculator();
  return add(10, calc.multiply(2, 3));
}
`</span>;

<span class="hljs-comment">// 编译模块</span>
<span class="hljs-keyword">const</span> mathJS = loader.<span class="hljs-title function_">compileModule</span>(mathSource);
<span class="hljs-keyword">const</span> appJS = loader.<span class="hljs-title function_">compileModule</span>(appSource);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'编译后的math模块:'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mathJS);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'编译后的app模块:'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(appJS);

<span class="hljs-comment">// 5.2 命名空间实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NamespaceManager</span> {
  <span class="hljs-keyword">static</span> namespaces = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">namespace, contents</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">namespaces</span>.<span class="hljs-title function_">has</span>(namespace)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">namespaces</span>.<span class="hljs-title function_">set</span>(namespace, {});
    }
    
    <span class="hljs-keyword">const</span> ns = <span class="hljs-variable language_">this</span>.<span class="hljs-property">namespaces</span>.<span class="hljs-title function_">get</span>(namespace);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(ns, contents);
    
    <span class="hljs-comment">// 暴露到全局</span>
    <span class="hljs-keyword">const</span> parts = namespace.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>);
    <span class="hljs-keyword">let</span> current = globalThis;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; parts.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">const</span> part = parts[i];
      <span class="hljs-keyword">if</span> (i === parts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
        current[part] = ns;
      } <span class="hljs-keyword">else</span> {
        current[part] = current[part] || {};
        current = current[part];
      }
    }
    
    <span class="hljs-keyword">return</span> ns;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">namespace</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">namespaces</span>.<span class="hljs-title function_">get</span>(namespace);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">export</span>(<span class="hljs-params">namespace, <span class="hljs-built_in">exports</span></span>) {
    <span class="hljs-keyword">const</span> ns = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>(namespace) || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">create</span>(namespace, {});
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(ns, <span class="hljs-built_in">exports</span>);
  }
}

<span class="hljs-comment">// 使用命名空间</span>
<span class="hljs-title class_">NamespaceManager</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'MyApp.Math'</span>, {
  <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,
  <span class="hljs-attr">subtract</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b,
  <span class="hljs-attr">constants</span>: {
    <span class="hljs-attr">PI</span>: <span class="hljs-number">3.14159</span>,
    <span class="hljs-attr">E</span>: <span class="hljs-number">2.71828</span>
  }
});

<span class="hljs-title class_">NamespaceManager</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'MyApp.Utils'</span>, {
  <span class="hljs-attr">format</span>: <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> str.<span class="hljs-title function_">toUpperCase</span>(),
  <span class="hljs-attr">validate</span>: <span class="hljs-function"><span class="hljs-params">obj</span> =&gt;</span> obj != <span class="hljs-literal">null</span>
});

<span class="hljs-comment">// 访问命名空间</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MyApp</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 5</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MyApp</span>.<span class="hljs-property">Utils</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">'hello'</span>)); <span class="hljs-comment">// "HELLO"</span>
</code></pre>
<h4 data-id="heading-15">六、工程化与构建工具集成</h4>
<h5 data-id="heading-16">TypeScript配置与编译</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 6.1 TypeScript配置解析器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TSConfigParser</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-keyword">const</span> defaults = {
      <span class="hljs-attr">compilerOptions</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'es5'</span>,
        <span class="hljs-attr">module</span>: <span class="hljs-string">'commonjs'</span>,
        <span class="hljs-attr">strict</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">esModuleInterop</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">skipLibCheck</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">forceConsistentCasingInFileNames</span>: <span class="hljs-literal">true</span>
      },
      <span class="hljs-attr">include</span>: [<span class="hljs-string">'src/**/*'</span>],
      <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'node_modules'</span>, <span class="hljs-string">'dist'</span>]
    };
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepMerge</span>(defaults, config);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">deepMerge</span>(<span class="hljs-params">target, source</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) {
      <span class="hljs-keyword">if</span> (source.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isObject</span>(source[key]) &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isObject</span>(target[key])) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepMerge</span>(target[key], source[key]);
        } <span class="hljs-keyword">else</span> {
          target[key] = source[key];
        }
      }
    }
    <span class="hljs-keyword">return</span> target;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isObject</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-keyword">return</span> item &amp;&amp; <span class="hljs-keyword">typeof</span> item === <span class="hljs-string">'object'</span> &amp;&amp; !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(item);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">generateCompilerCommand</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-keyword">const</span> options = config.<span class="hljs-property">compilerOptions</span>;
    <span class="hljs-keyword">const</span> args = [];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(options)) {
      <span class="hljs-keyword">const</span> argName = <span class="hljs-string">`--<span class="hljs-subst">${key}</span>`</span>;
      
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'boolean'</span>) {
        <span class="hljs-keyword">if</span> (value) args.<span class="hljs-title function_">push</span>(argName);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>) {
        args.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${argName}</span> <span class="hljs-subst">${value}</span>`</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(value)) {
        args.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${argName}</span> <span class="hljs-subst">${value.join(<span class="hljs-string">','</span>)}</span>`</span>);
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">`tsc <span class="hljs-subst">${args.join(<span class="hljs-string">' '</span>)}</span>`</span>;
  }
}

<span class="hljs-comment">// 示例配置</span>
<span class="hljs-keyword">const</span> tsconfig = {
  <span class="hljs-attr">compilerOptions</span>: {
    <span class="hljs-attr">target</span>: <span class="hljs-string">'es2020'</span>,
    <span class="hljs-attr">module</span>: <span class="hljs-string">'esnext'</span>,
    <span class="hljs-attr">lib</span>: [<span class="hljs-string">'es2020'</span>, <span class="hljs-string">'dom'</span>],
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">'./dist'</span>,
    <span class="hljs-attr">rootDir</span>: <span class="hljs-string">'./src'</span>,
    <span class="hljs-attr">strict</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">moduleResolution</span>: <span class="hljs-string">'node'</span>,
    <span class="hljs-attr">baseUrl</span>: <span class="hljs-string">'.'</span>,
    <span class="hljs-attr">paths</span>: {
      <span class="hljs-string">'@/*'</span>: [<span class="hljs-string">'src/*'</span>]
    },
    <span class="hljs-attr">allowSyntheticDefaultImports</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">include</span>: [<span class="hljs-string">'src/**/*.ts'</span>, <span class="hljs-string">'src/**/*.tsx'</span>],
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'node_modules'</span>]
};

<span class="hljs-keyword">const</span> parsedConfig = <span class="hljs-title class_">TSConfigParser</span>.<span class="hljs-title function_">parse</span>(tsconfig);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'解析后的配置:'</span>, parsedConfig);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'编译器命令:'</span>, <span class="hljs-title class_">TSConfigParser</span>.<span class="hljs-title function_">generateCompilerCommand</span>(parsedConfig));

<span class="hljs-comment">// 6.2 构建管道模拟</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeScriptBuildPipeline</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = config;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">steps</span> = [];
  }
  
  <span class="hljs-title function_">addStep</span>(<span class="hljs-params">name, processor</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">steps</span>.<span class="hljs-title function_">push</span>({ name, processor });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">sourceFiles</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始构建TypeScript项目...'</span>);
    
    <span class="hljs-keyword">let</span> processedFiles = sourceFiles;
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> step <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">steps</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`执行步骤: <span class="hljs-subst">${step.name}</span>`</span>);
      
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(processedFiles)) {
        <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
          processedFiles.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> step.<span class="hljs-title function_">processor</span>(file, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>))
        );
        processedFiles = results;
      } <span class="hljs-keyword">else</span> {
        processedFiles = <span class="hljs-keyword">await</span> step.<span class="hljs-title function_">processor</span>(processedFiles, <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>);
      }
    }
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'构建完成!'</span>);
    <span class="hljs-keyword">return</span> processedFiles;
  }
}

<span class="hljs-comment">// 构建步骤处理器</span>
<span class="hljs-keyword">const</span> processors = {
  <span class="hljs-comment">// 类型检查</span>
  <span class="hljs-attr">typeCheck</span>: <span class="hljs-keyword">async</span> (file, config) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`类型检查: <span class="hljs-subst">${file.name}</span>`</span>);
    <span class="hljs-comment">// 模拟类型检查</span>
    <span class="hljs-keyword">if</span> (file.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'error'</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`类型错误: <span class="hljs-subst">${file.name}</span>`</span>);
    }
    <span class="hljs-keyword">return</span> file;
  },
  
  <span class="hljs-comment">// 编译</span>
  <span class="hljs-attr">compile</span>: <span class="hljs-keyword">async</span> (file, config) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`编译: <span class="hljs-subst">${file.name}</span>`</span>);
    
    <span class="hljs-comment">// 模拟编译过程</span>
    <span class="hljs-keyword">const</span> jsCode = file.<span class="hljs-property">content</span>
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:\s*\w+/g</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// 移除类型注解</span>
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/interface\s+\w+\s*\{[^}]+\}/g</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// 移除接口</span>
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/export\s+type\s+\w+/g</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// 移除类型导出</span>
      .<span class="hljs-title function_">trim</span>();
    
    <span class="hljs-keyword">return</span> {
      ...file,
      <span class="hljs-attr">content</span>: jsCode,
      <span class="hljs-attr">extension</span>: <span class="hljs-string">'.js'</span>
    };
  },
  
  <span class="hljs-comment">// 打包</span>
  <span class="hljs-attr">bundle</span>: <span class="hljs-keyword">async</span> (files, config) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'打包文件...'</span>);
    
    <span class="hljs-keyword">const</span> bundleContent = files
      .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> <span class="hljs-string">`// <span class="hljs-subst">${file.name}</span>\n<span class="hljs-subst">${file.content}</span>`</span>)
      .<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n\n'</span>);
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'bundle.js'</span>,
      <span class="hljs-attr">content</span>: bundleContent,
      <span class="hljs-attr">size</span>: bundleContent.<span class="hljs-property">length</span>
    };
  },
  
  <span class="hljs-comment">// 压缩</span>
  <span class="hljs-attr">minify</span>: <span class="hljs-keyword">async</span> (file, config) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'压缩代码...'</span>);
    
    <span class="hljs-comment">// 简单压缩：移除空格和注释</span>
    <span class="hljs-keyword">const</span> minified = file.<span class="hljs-property">content</span>
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\/\/.*$/gm</span>, <span class="hljs-string">''</span>)
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\/\*[\s\S]*?\*\//g</span>, <span class="hljs-string">''</span>)
      .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\s+/g</span>, <span class="hljs-string">' '</span>)
      .<span class="hljs-title function_">trim</span>();
    
    <span class="hljs-keyword">return</span> {
      ...file,
      <span class="hljs-attr">content</span>: minified,
      <span class="hljs-attr">size</span>: minified.<span class="hljs-property">length</span>
    };
  }
};

<span class="hljs-comment">// 模拟源文件</span>
<span class="hljs-keyword">const</span> sourceFiles = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'math.ts'</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">`
      export function add(a: number, b: number): number {
        return a + b;
      }
      
      export function subtract(a: number, b: number): number {
        return a - b;
      }
    `</span>
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'app.ts'</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">`
      import { add } from './math';
      
      export function calculate(): number {
        return add(1, 2);
      }
    `</span>
  }
];

<span class="hljs-comment">// 创建构建管道</span>
<span class="hljs-keyword">const</span> pipeline = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeScriptBuildPipeline</span>(tsconfig)
  .<span class="hljs-title function_">addStep</span>(<span class="hljs-string">'类型检查'</span>, processors.<span class="hljs-property">typeCheck</span>)
  .<span class="hljs-title function_">addStep</span>(<span class="hljs-string">'编译'</span>, processors.<span class="hljs-property">compile</span>)
  .<span class="hljs-title function_">addStep</span>(<span class="hljs-string">'打包'</span>, processors.<span class="hljs-property">bundle</span>)
  .<span class="hljs-title function_">addStep</span>(<span class="hljs-string">'压缩'</span>, processors.<span class="hljs-property">minify</span>);

<span class="hljs-comment">// 执行构建</span>
pipeline.<span class="hljs-title function_">build</span>(sourceFiles).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'构建结果:'</span>, result);
});
</code></pre>
<h4 data-id="heading-17">七、实战应用: 在JavaScript项目中引入TypeScript</h4>
<h5 data-id="heading-18">渐进式迁移策略</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 7.1 混合项目结构管理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridProjectManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">tsDir</span>: <span class="hljs-string">'src/ts'</span>,
      <span class="hljs-attr">jsDir</span>: <span class="hljs-string">'src/js'</span>,
      <span class="hljs-attr">buildDir</span>: <span class="hljs-string">'dist'</span>,
      <span class="hljs-attr">allowJS</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">checkJS</span>: <span class="hljs-literal">true</span>,
      ...options
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileRegistry</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
  }
  
  <span class="hljs-comment">// 注册文件</span>
  <span class="hljs-title function_">registerFile</span>(<span class="hljs-params">path, type</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileRegistry</span>.<span class="hljs-title function_">set</span>(path, {
      type,
      <span class="hljs-attr">dependencies</span>: [],
      <span class="hljs-attr">errors</span>: []
    });
    
    <span class="hljs-comment">// 自动检测文件类型</span>
    <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ts'</span>) || path.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.tsx'</span>)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileRegistry</span>.<span class="hljs-title function_">get</span>(path).<span class="hljs-property">type</span> = <span class="hljs-string">'typescript'</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (path.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.js'</span>) || path.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.jsx'</span>)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileRegistry</span>.<span class="hljs-title function_">get</span>(path).<span class="hljs-property">type</span> = <span class="hljs-string">'javascript'</span>;
    }
  }
  
  <span class="hljs-comment">// 分析依赖关系</span>
  <span class="hljs-title function_">analyzeDependencies</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">const</span> file = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileRegistry</span>.<span class="hljs-title function_">get</span>(path);
    <span class="hljs-keyword">if</span> (!file) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readFile</span>(path);
    <span class="hljs-keyword">const</span> dependencies = [];
    
    <span class="hljs-comment">// 解析导入语句</span>
    <span class="hljs-keyword">const</span> importRegex = <span class="hljs-regexp">/import\s+(?:.*?from\s+)?['"]([^'"]+)['"]/g</span>;
    <span class="hljs-keyword">let</span> match;
    
    <span class="hljs-keyword">while</span> ((match = importRegex.<span class="hljs-title function_">exec</span>(content)) !== <span class="hljs-literal">null</span>) {
      dependencies.<span class="hljs-title function_">push</span>(match[<span class="hljs-number">1</span>]);
    }
    
    file.<span class="hljs-property">dependencies</span> = dependencies;
  }
  
  <span class="hljs-comment">// 检查混合项目问题</span>
  <span class="hljs-title function_">checkHybridIssues</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> issues = [];
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [path, file] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileRegistry</span>) {
      <span class="hljs-comment">// 检查TypeScript文件是否导入了未定义的JavaScript模块</span>
      <span class="hljs-keyword">if</span> (file.<span class="hljs-property">type</span> === <span class="hljs-string">'typescript'</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dep <span class="hljs-keyword">of</span> file.<span class="hljs-property">dependencies</span>) {
          <span class="hljs-keyword">if</span> (dep.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.js'</span>)) {
            <span class="hljs-keyword">const</span> depPath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePath</span>(path, dep);
            <span class="hljs-keyword">const</span> depFile = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileRegistry</span>.<span class="hljs-title function_">get</span>(depPath);
            
            <span class="hljs-keyword">if</span> (depFile &amp;&amp; depFile.<span class="hljs-property">type</span> === <span class="hljs-string">'javascript'</span>) {
              issues.<span class="hljs-title function_">push</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">'ts-imports-js'</span>,
                <span class="hljs-attr">message</span>: <span class="hljs-string">`TypeScript文件 <span class="hljs-subst">${path}</span> 导入了JavaScript文件 <span class="hljs-subst">${depPath}</span>`</span>,
                <span class="hljs-attr">severity</span>: <span class="hljs-string">'warning'</span>,
                <span class="hljs-attr">suggestion</span>: <span class="hljs-string">'考虑将JavaScript文件迁移为TypeScript或添加类型声明'</span>
              });
            }
          }
        }
      }
      
      <span class="hljs-comment">// 检查JavaScript文件是否缺少JSDoc注释</span>
      <span class="hljs-keyword">if</span> (file.<span class="hljs-property">type</span> === <span class="hljs-string">'javascript'</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">checkJS</span>) {
        <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readFile</span>(path);
        <span class="hljs-keyword">const</span> hasJSDoc = <span class="hljs-regexp">/\/\*\*\s*\n(?:[^*]|\*(?!\/))*\*\//</span>.<span class="hljs-title function_">test</span>(content);
        
        <span class="hljs-keyword">if</span> (!hasJSDoc) {
          issues.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'missing-jsdoc'</span>,
            <span class="hljs-attr">message</span>: <span class="hljs-string">`JavaScript文件 <span class="hljs-subst">${path}</span> 缺少JSDoc注释`</span>,
            <span class="hljs-attr">severity</span>: <span class="hljs-string">'info'</span>,
            <span class="hljs-attr">suggestion</span>: <span class="hljs-string">'添加JSDoc注释以提供类型信息'</span>
          });
        }
      }
    }
    
    <span class="hljs-keyword">return</span> issues;
  }
  
  <span class="hljs-comment">// 生成迁移建议</span>
  <span class="hljs-title function_">generateMigrationPlan</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> plan = {
      <span class="hljs-attr">phase1</span>: [], <span class="hljs-comment">// 立即迁移的文件</span>
      <span class="hljs-attr">phase2</span>: [], <span class="hljs-comment">// 可以稍后迁移的文件</span>
      <span class="hljs-attr">declarations</span>: [] <span class="hljs-comment">// 需要创建的类型声明文件</span>
    };
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [path, file] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileRegistry</span>) {
      <span class="hljs-keyword">if</span> (file.<span class="hljs-property">type</span> === <span class="hljs-string">'javascript'</span>) {
        <span class="hljs-comment">// 分析复杂性</span>
        <span class="hljs-keyword">const</span> complexity = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">assessComplexity</span>(path);
        
        <span class="hljs-keyword">if</span> (complexity &lt;= <span class="hljs-number">2</span>) {
          plan.<span class="hljs-property">phase1</span>.<span class="hljs-title function_">push</span>(path);
        } <span class="hljs-keyword">else</span> {
          plan.<span class="hljs-property">phase2</span>.<span class="hljs-title function_">push</span>(path);
        }
        
        <span class="hljs-comment">// 检查是否需要声明文件</span>
        <span class="hljs-keyword">if</span> (file.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> dep.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'@types/'</span>))) {
          plan.<span class="hljs-property">declarations</span>.<span class="hljs-title function_">push</span>(path);
        }
      }
    }
    
    <span class="hljs-keyword">return</span> plan;
  }
  
  <span class="hljs-comment">// 评估文件复杂性</span>
  <span class="hljs-title function_">assessComplexity</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">readFile</span>(path);
    <span class="hljs-keyword">let</span> score = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 基于行数</span>
    <span class="hljs-keyword">const</span> lines = content.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>).<span class="hljs-property">length</span>;
    <span class="hljs-keyword">if</span> (lines &gt; <span class="hljs-number">100</span>) score += <span class="hljs-number">2</span>;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lines &gt; <span class="hljs-number">50</span>) score += <span class="hljs-number">1</span>;
    
    <span class="hljs-comment">// 基于函数数量</span>
    <span class="hljs-keyword">const</span> functionCount = (content.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/function\s+\w+|\b\w+\s*=/g</span>) || []).<span class="hljs-property">length</span>;
    score += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(functionCount / <span class="hljs-number">5</span>), <span class="hljs-number">3</span>);
    
    <span class="hljs-comment">// 基于外部依赖</span>
    <span class="hljs-keyword">const</span> importCount = (content.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/import\s+|require\(/g</span>) || []).<span class="hljs-property">length</span>;
    score += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(importCount, <span class="hljs-number">2</span>);
    
    <span class="hljs-keyword">return</span> score;
  }
  
  <span class="hljs-comment">// 工具方法</span>
  <span class="hljs-title function_">readFile</span>(<span class="hljs-params">path</span>) {
    <span class="hljs-comment">// 模拟文件读取</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">'模拟文件内容'</span>;
  }
  
  <span class="hljs-title function_">resolvePath</span>(<span class="hljs-params">base, relative</span>) {
    <span class="hljs-comment">// 简化路径解析</span>
    <span class="hljs-keyword">return</span> relative;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> manager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HybridProjectManager</span>({
  <span class="hljs-attr">tsDir</span>: <span class="hljs-string">'src/ts'</span>,
  <span class="hljs-attr">jsDir</span>: <span class="hljs-string">'src/js'</span>,
  <span class="hljs-attr">checkJS</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-comment">// 注册文件</span>
manager.<span class="hljs-title function_">registerFile</span>(<span class="hljs-string">'src/js/user.js'</span>, <span class="hljs-string">'javascript'</span>);
manager.<span class="hljs-title function_">registerFile</span>(<span class="hljs-string">'src/ts/auth.ts'</span>, <span class="hljs-string">'typescript'</span>);
manager.<span class="hljs-title function_">registerFile</span>(<span class="hljs-string">'src/js/utils.js'</span>, <span class="hljs-string">'javascript'</span>);

<span class="hljs-comment">// 分析问题</span>
<span class="hljs-keyword">const</span> issues = manager.<span class="hljs-title function_">checkHybridIssues</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'发现的问题:'</span>, issues);

<span class="hljs-comment">// 生成迁移计划</span>
<span class="hljs-keyword">const</span> migrationPlan = manager.<span class="hljs-title function_">generateMigrationPlan</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'迁移计划:'</span>, migrationPlan);

<span class="hljs-comment">// 7.2 类型声明生成器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeDeclarationGenerator</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">generateFromJS</span>(<span class="hljs-params">jsCode, options = {}</span>) {
    <span class="hljs-keyword">const</span> declarations = [];
    
    <span class="hljs-comment">// 解析函数</span>
    <span class="hljs-keyword">const</span> functionRegex = <span class="hljs-regexp">/function\s+(\w+)\s*\(([^)]*)\)/g</span>;
    <span class="hljs-keyword">let</span> match;
    
    <span class="hljs-keyword">while</span> ((match = functionRegex.<span class="hljs-title function_">exec</span>(jsCode)) !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> [, funcName, params] = match;
      <span class="hljs-keyword">const</span> paramTypes = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">inferParamTypes</span>(params);
      <span class="hljs-keyword">const</span> returnType = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">inferReturnType</span>(jsCode, funcName);
      
      declarations.<span class="hljs-title function_">push</span>(
        <span class="hljs-string">`declare function <span class="hljs-subst">${funcName}</span>(<span class="hljs-subst">${paramTypes}</span>): <span class="hljs-subst">${returnType}</span>;`</span>
      );
    }
    
    <span class="hljs-comment">// 解析类</span>
    <span class="hljs-keyword">const</span> classRegex = <span class="hljs-regexp">/class\s+(\w+)/g</span>;
    <span class="hljs-keyword">while</span> ((match = classRegex.<span class="hljs-title function_">exec</span>(jsCode)) !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> [, className] = match;
      <span class="hljs-keyword">const</span> classDeclaration = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateClassDeclaration</span>(jsCode, className);
      declarations.<span class="hljs-title function_">push</span>(classDeclaration);
    }
    
    <span class="hljs-comment">// 解析变量导出</span>
    <span class="hljs-keyword">const</span> exportRegex = <span class="hljs-regexp">/exports\.(\w+)\s*=/g</span>;
    <span class="hljs-keyword">while</span> ((match = exportRegex.<span class="hljs-title function_">exec</span>(jsCode)) !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> [, exportName] = match;
      <span class="hljs-keyword">const</span> type = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">inferVariableType</span>(jsCode, exportName);
      declarations.<span class="hljs-title function_">push</span>(<span class="hljs-string">`declare const <span class="hljs-subst">${exportName}</span>: <span class="hljs-subst">${type}</span>;`</span>);
    }
    
    <span class="hljs-keyword">return</span> declarations.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">inferParamTypes</span>(<span class="hljs-params">paramsStr</span>) {
    <span class="hljs-keyword">const</span> params = paramsStr.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-title function_">trim</span>()).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p);
    
    <span class="hljs-keyword">return</span> params.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">param, index</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> [name, defaultValue] = param.<span class="hljs-title function_">split</span>(<span class="hljs-string">'='</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>());
      <span class="hljs-keyword">let</span> type = <span class="hljs-string">'any'</span>;
      
      <span class="hljs-keyword">if</span> (defaultValue) {
        <span class="hljs-keyword">if</span> (defaultValue.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"'"</span>) || defaultValue.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'"'</span>)) {
          type = <span class="hljs-string">'string'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (defaultValue === <span class="hljs-string">'true'</span> || defaultValue === <span class="hljs-string">'false'</span>) {
          type = <span class="hljs-string">'boolean'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(defaultValue))) {
          type = <span class="hljs-string">'number'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (defaultValue === <span class="hljs-string">'[]'</span>) {
          type = <span class="hljs-string">'any[]'</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (defaultValue === <span class="hljs-string">'{}'</span>) {
          type = <span class="hljs-string">'object'</span>;
        }
      }
      
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${name}</span>: <span class="hljs-subst">${type}</span>`</span>;
    }).<span class="hljs-title function_">join</span>(<span class="hljs-string">', '</span>);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">inferReturnType</span>(<span class="hljs-params">jsCode, funcName</span>) {
    <span class="hljs-comment">// 简化实现：检查return语句</span>
    <span class="hljs-keyword">const</span> returnRegex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`function\\s+<span class="hljs-subst">${funcName}</span>[^{]*{([^}]*return[^;]+;)?`</span>, <span class="hljs-string">'i'</span>);
    <span class="hljs-keyword">const</span> match = jsCode.<span class="hljs-title function_">match</span>(returnRegex);
    
    <span class="hljs-keyword">if</span> (match &amp;&amp; match[<span class="hljs-number">1</span>]) {
      <span class="hljs-keyword">const</span> returnExpr = match[<span class="hljs-number">1</span>].<span class="hljs-title function_">replace</span>(<span class="hljs-string">'return'</span>, <span class="hljs-string">''</span>).<span class="hljs-title function_">trim</span>();
      
      <span class="hljs-keyword">if</span> (returnExpr.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"'"</span>) || returnExpr.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'"'</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'string'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (returnExpr === <span class="hljs-string">'true'</span> || returnExpr === <span class="hljs-string">'false'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'boolean'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(returnExpr))) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'number'</span>;
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'any'</span>;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">generateClassDeclaration</span>(<span class="hljs-params">jsCode, className</span>) {
    <span class="hljs-keyword">const</span> declaration = [<span class="hljs-string">`declare class <span class="hljs-subst">${className}</span> {`</span>];
    
    <span class="hljs-comment">// 提取构造函数</span>
    <span class="hljs-keyword">const</span> constructorRegex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`constructor\\(([^)]*)\\)`</span>, <span class="hljs-string">'g'</span>);
    <span class="hljs-keyword">const</span> constructorMatch = constructorRegex.<span class="hljs-title function_">exec</span>(jsCode);
    
    <span class="hljs-keyword">if</span> (constructorMatch) {
      <span class="hljs-keyword">const</span> params = constructorMatch[<span class="hljs-number">1</span>];
      <span class="hljs-keyword">const</span> paramTypes = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">inferParamTypes</span>(params);
      declaration.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  constructor(<span class="hljs-subst">${paramTypes}</span>);`</span>);
    }
    
    <span class="hljs-comment">// 提取方法</span>
    <span class="hljs-keyword">const</span> methodRegex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`<span class="hljs-subst">${className}</span>\\.prototype\\.(\\w+)\\s*=\\s*function`</span>, <span class="hljs-string">'g'</span>);
    <span class="hljs-keyword">while</span> ((match = methodRegex.<span class="hljs-title function_">exec</span>(jsCode)) !== <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">const</span> [, methodName] = match;
      declaration.<span class="hljs-title function_">push</span>(<span class="hljs-string">`  <span class="hljs-subst">${methodName}</span>(): any;`</span>);
    }
    
    declaration.<span class="hljs-title function_">push</span>(<span class="hljs-string">'}'</span>);
    <span class="hljs-keyword">return</span> declaration.<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">inferVariableType</span>(<span class="hljs-params">jsCode, varName</span>) {
    <span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`<span class="hljs-subst">${varName}</span>\\s*=\\s*([^;]+)`</span>, <span class="hljs-string">'g'</span>);
    <span class="hljs-keyword">const</span> match = regex.<span class="hljs-title function_">exec</span>(jsCode);
    
    <span class="hljs-keyword">if</span> (match) {
      <span class="hljs-keyword">const</span> value = match[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>();
      
      <span class="hljs-keyword">if</span> (value.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'['</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'any[]'</span>;
      <span class="hljs-keyword">if</span> (value.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'{'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'object'</span>;
      <span class="hljs-keyword">if</span> (value.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"'"</span>) || value.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'"'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'string'</span>;
      <span class="hljs-keyword">if</span> (value === <span class="hljs-string">'true'</span> || value === <span class="hljs-string">'false'</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'boolean'</span>;
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">parseFloat</span>(value))) <span class="hljs-keyword">return</span> <span class="hljs-string">'number'</span>;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-string">'any'</span>;
  }
}

<span class="hljs-comment">// 生成类型声明示例</span>
<span class="hljs-keyword">const</span> jsCode = <span class="hljs-string">`
function greet(name) {
  return 'Hello, ' + name;
}

class User {
  constructor(name, age = 18) {
    this.name = name;
    this.age = age;
  }
  
  sayHello() {
    return greet(this.name);
  }
}

exports.greet = greet;
exports.User = User;
exports.VERSION = '1.0.0';
`</span>;

<span class="hljs-keyword">const</span> declarations = <span class="hljs-title class_">TypeDeclarationGenerator</span>.<span class="hljs-title function_">generateFromJS</span>(jsCode);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'生成的类型声明:'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(declarations);
</code></pre>
<h4 data-id="heading-19">八、性能优化与最佳实践</h4>
<h5 data-id="heading-20">TypeScript编译优化</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 8.1 增量编译</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IncrementalCompiler</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileCache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastCompileTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  }
  
  <span class="hljs-comment">// 检查文件是否需要重新编译</span>
  <span class="hljs-title function_">needsRecompile</span>(<span class="hljs-params">filePath, content</span>) {
    <span class="hljs-keyword">const</span> cached = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileCache</span>.<span class="hljs-title function_">get</span>(filePath);
    
    <span class="hljs-keyword">if</span> (!cached) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 新文件</span>
    }
    
    <span class="hljs-keyword">if</span> (cached.<span class="hljs-property">content</span> !== content) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 内容改变</span>
    }
    
    <span class="hljs-comment">// 检查依赖是否改变</span>
    <span class="hljs-keyword">const</span> dependencies = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencyGraph</span>.<span class="hljs-title function_">get</span>(filePath) || [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dep <span class="hljs-keyword">of</span> dependencies) {
      <span class="hljs-keyword">const</span> depCached = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileCache</span>.<span class="hljs-title function_">get</span>(dep);
      <span class="hljs-keyword">if</span> (!depCached || depCached.<span class="hljs-property">timestamp</span> &gt; cached.<span class="hljs-property">timestamp</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 依赖已更新</span>
      }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 无需重新编译</span>
  }
  
  <span class="hljs-comment">// 增量编译</span>
  <span class="hljs-title function_">incrementalCompile</span>(<span class="hljs-params">files</span>) {
    <span class="hljs-keyword">const</span> toCompile = [];
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">needsRecompile</span>(file.<span class="hljs-property">path</span>, file.<span class="hljs-property">content</span>)) {
        toCompile.<span class="hljs-title function_">push</span>(file);
      }
    }
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`需要重新编译 <span class="hljs-subst">${toCompile.length}</span> 个文件`</span>);
    
    <span class="hljs-keyword">if</span> (toCompile.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'没有文件需要重新编译，使用缓存'</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCachedOutput</span>();
    }
    
    <span class="hljs-comment">// 执行编译</span>
    <span class="hljs-keyword">const</span> results = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compileFiles</span>(toCompile);
    
    <span class="hljs-comment">// 更新缓存</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> toCompile) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileCache</span>.<span class="hljs-title function_">set</span>(file.<span class="hljs-property">path</span>, {
        <span class="hljs-attr">content</span>: file.<span class="hljs-property">content</span>,
        <span class="hljs-attr">timestamp</span>: startTime,
        <span class="hljs-attr">output</span>: results[file.<span class="hljs-property">path</span>]
      });
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastCompileTime</span> = startTime;
    
    <span class="hljs-keyword">return</span> results;
  }
  
  <span class="hljs-title function_">compileFiles</span>(<span class="hljs-params">files</span>) {
    <span class="hljs-comment">// 简化编译过程</span>
    <span class="hljs-keyword">const</span> results = {};
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> files) {
      results[file.<span class="hljs-property">path</span>] = file.<span class="hljs-property">content</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:\s*\w+/g</span>, <span class="hljs-string">''</span>);
    }
    
    <span class="hljs-keyword">return</span> results;
  }
  
  <span class="hljs-title function_">getCachedOutput</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> output = {};
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [path, cached] <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileCache</span>) {
      output[path] = cached.<span class="hljs-property">output</span>;
    }
    
    <span class="hljs-keyword">return</span> output;
  }
}

<span class="hljs-comment">// 8.2 项目引用优化</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProjectReferenceOptimizer</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">optimize</span>(<span class="hljs-params">config, projects</span>) {
    <span class="hljs-keyword">const</span> optimized = { ...config };
    
    <span class="hljs-comment">// 分析项目依赖</span>
    <span class="hljs-keyword">const</span> dependencies = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeDependencies</span>(projects);
    
    <span class="hljs-comment">// 设置项目引用</span>
    optimized.<span class="hljs-property">compilerOptions</span> = {
      ...optimized.<span class="hljs-property">compilerOptions</span>,
      <span class="hljs-attr">composite</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">declaration</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">declarationMap</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">incremental</span>: <span class="hljs-literal">true</span>
    };
    
    optimized.<span class="hljs-property">references</span> = dependencies.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> ({ <span class="hljs-attr">path</span>: dep }));
    
    <span class="hljs-keyword">return</span> optimized;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">analyzeDependencies</span>(<span class="hljs-params">projects</span>) {
    <span class="hljs-keyword">const</span> graph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    
    <span class="hljs-comment">// 构建依赖图</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> project <span class="hljs-keyword">of</span> projects) {
      <span class="hljs-keyword">const</span> deps = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractImports</span>(project.<span class="hljs-property">source</span>);
      graph.<span class="hljs-title function_">set</span>(project.<span class="hljs-property">name</span>, deps);
    }
    
    <span class="hljs-comment">// 拓扑排序</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">topologicalSort</span>(graph);
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">extractImports</span>(<span class="hljs-params">source</span>) {
    <span class="hljs-keyword">const</span> imports = [];
    <span class="hljs-keyword">const</span> importRegex = <span class="hljs-regexp">/import\s+.*?\s+from\s+['"]([^'"]+)['"]/g</span>;
    <span class="hljs-keyword">let</span> match;
    
    <span class="hljs-keyword">while</span> ((match = importRegex.<span class="hljs-title function_">exec</span>(source)) !== <span class="hljs-literal">null</span>) {
      imports.<span class="hljs-title function_">push</span>(match[<span class="hljs-number">1</span>]);
    }
    
    <span class="hljs-keyword">return</span> imports;
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">topologicalSort</span>(<span class="hljs-params">graph</span>) {
    <span class="hljs-keyword">const</span> visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
    <span class="hljs-keyword">const</span> result = [];
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">visit</span> = (<span class="hljs-params">node</span>) =&gt; {
      <span class="hljs-keyword">if</span> (visited.<span class="hljs-title function_">has</span>(node)) <span class="hljs-keyword">return</span>;
      visited.<span class="hljs-title function_">add</span>(node);
      
      <span class="hljs-keyword">const</span> dependencies = graph.<span class="hljs-title function_">get</span>(node) || [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dep <span class="hljs-keyword">of</span> dependencies) {
        <span class="hljs-title function_">visit</span>(dep);
      }
      
      result.<span class="hljs-title function_">push</span>(node);
    };
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> node <span class="hljs-keyword">of</span> graph.<span class="hljs-title function_">keys</span>()) {
      <span class="hljs-title function_">visit</span>(node);
    }
    
    <span class="hljs-keyword">return</span> result;
  }
}

<span class="hljs-comment">// 8.3 内存优化</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeScriptMemoryOptimizer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryCache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxCacheSize</span> = <span class="hljs-number">100</span>;
  }
  
  <span class="hljs-comment">// 编译结果缓存</span>
  <span class="hljs-title function_">cacheCompilationResult</span>(<span class="hljs-params">filePath, ast, diagnostics, output</span>) {
    <span class="hljs-keyword">const</span> cacheEntry = {
      ast,
      diagnostics,
      output,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">size</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateSize</span>(ast) + <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateSize</span>(output)
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryCache</span>.<span class="hljs-title function_">set</span>(filePath, cacheEntry);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanupCache</span>();
  }
  
  <span class="hljs-comment">// 获取缓存结果</span>
  <span class="hljs-title function_">getCachedResult</span>(<span class="hljs-params">filePath</span>) {
    <span class="hljs-keyword">const</span> cached = <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryCache</span>.<span class="hljs-title function_">get</span>(filePath);
    <span class="hljs-keyword">if</span> (cached) {
      <span class="hljs-comment">// 更新访问时间</span>
      cached.<span class="hljs-property">timestamp</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">return</span> cached;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
  
  <span class="hljs-comment">// 清理缓存</span>
  <span class="hljs-title function_">cleanupCache</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryCache</span>.<span class="hljs-property">size</span> &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxCacheSize</span>) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// LRU缓存清理</span>
    <span class="hljs-keyword">const</span> entries = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryCache</span>.<span class="hljs-title function_">entries</span>());
    entries.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a[<span class="hljs-number">1</span>].<span class="hljs-property">timestamp</span> - b[<span class="hljs-number">1</span>].<span class="hljs-property">timestamp</span>);
    
    <span class="hljs-keyword">const</span> toRemove = entries.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, entries.<span class="hljs-property">length</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxCacheSize</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key] <span class="hljs-keyword">of</span> toRemove) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoryCache</span>.<span class="hljs-title function_">delete</span>(key);
    }
  }
  
  <span class="hljs-comment">// 计算对象大小</span>
  <span class="hljs-title function_">calculateSize</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">const</span> str = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj);
    <span class="hljs-keyword">return</span> str.<span class="hljs-property">length</span> * <span class="hljs-number">2</span>; <span class="hljs-comment">// 粗略估计（UTF-16）</span>
  }
  
  <span class="hljs-comment">// AST节点缓存池</span>
  <span class="hljs-title function_">createASTNodePool</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-title function_">getNode</span>(<span class="hljs-params">type, props</span>) {
        <span class="hljs-keyword">const</span> key = <span class="hljs-string">`<span class="hljs-subst">${type}</span>:<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(props)}</span>`</span>;
        
        <span class="hljs-keyword">if</span> (pool.<span class="hljs-title function_">has</span>(key)) {
          <span class="hljs-keyword">return</span> pool.<span class="hljs-title function_">get</span>(key);
        }
        
        <span class="hljs-keyword">const</span> node = { type, ...props };
        pool.<span class="hljs-title function_">set</span>(key, node);
        
        <span class="hljs-keyword">return</span> node;
      },
      
      <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
        pool.<span class="hljs-title function_">clear</span>();
      },
      
      <span class="hljs-keyword">get</span> <span class="hljs-title function_">size</span>() {
        <span class="hljs-keyword">return</span> pool.<span class="hljs-property">size</span>;
      }
    };
  }
}
</code></pre>
<h5 data-id="heading-21">TypeScript最佳实践</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 8.4 代码组织最佳实践</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeScriptBestPractices</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">structureProject</span>(<span class="hljs-params">projectType</span>) {
    <span class="hljs-keyword">const</span> structures = {
      <span class="hljs-attr">library</span>: {
        <span class="hljs-attr">src</span>: [
          <span class="hljs-string">'index.ts'</span>, <span class="hljs-comment">// 主入口</span>
          <span class="hljs-string">'types/'</span>,   <span class="hljs-comment">// 类型定义</span>
          <span class="hljs-string">'utils/'</span>,   <span class="hljs-comment">// 工具函数</span>
          <span class="hljs-string">'core/'</span>,    <span class="hljs-comment">// 核心逻辑</span>
          <span class="hljs-string">'tests/'</span>    <span class="hljs-comment">// 测试文件</span>
        ],
        <span class="hljs-attr">config</span>: [
          <span class="hljs-string">'tsconfig.json'</span>,
          <span class="hljs-string">'tsconfig.build.json'</span>,
          <span class="hljs-string">'package.json'</span>,
          <span class="hljs-string">'.eslintrc.js'</span>
        ],
        <span class="hljs-attr">docs</span>: <span class="hljs-string">'README.md'</span>
      },
      
      <span class="hljs-attr">application</span>: {
        <span class="hljs-attr">src</span>: [
          <span class="hljs-string">'main.ts'</span>,          <span class="hljs-comment">// 应用入口</span>
          <span class="hljs-string">'components/'</span>,      <span class="hljs-comment">// 组件</span>
          <span class="hljs-string">'services/'</span>,        <span class="hljs-comment">// 服务层</span>
          <span class="hljs-string">'models/'</span>,          <span class="hljs-comment">// 数据模型</span>
          <span class="hljs-string">'utils/'</span>,           <span class="hljs-comment">// 工具函数</span>
          <span class="hljs-string">'styles/'</span>,          <span class="hljs-comment">// 样式文件</span>
          <span class="hljs-string">'assets/'</span>,          <span class="hljs-comment">// 静态资源</span>
          <span class="hljs-string">'tests/'</span>            <span class="hljs-comment">// 测试</span>
        ],
        <span class="hljs-attr">config</span>: [
          <span class="hljs-string">'tsconfig.json'</span>,
          <span class="hljs-string">'tsconfig.app.json'</span>,
          <span class="hljs-string">'package.json'</span>,
          <span class="hljs-string">'webpack.config.js'</span>
        ],
        <span class="hljs-attr">public</span>: <span class="hljs-string">'index.html'</span>
      },
      
      <span class="hljs-attr">node</span>: {
        <span class="hljs-attr">src</span>: [
          <span class="hljs-string">'index.ts'</span>,         <span class="hljs-comment">// 应用入口</span>
          <span class="hljs-string">'controllers/'</span>,     <span class="hljs-comment">// 控制器</span>
          <span class="hljs-string">'services/'</span>,        <span class="hljs-comment">// 服务层</span>
          <span class="hljs-string">'models/'</span>,          <span class="hljs-comment">// 数据模型</span>
          <span class="hljs-string">'middleware/'</span>,      <span class="hljs-comment">// 中间件</span>
          <span class="hljs-string">'routes/'</span>,          <span class="hljs-comment">// 路由</span>
          <span class="hljs-string">'utils/'</span>,           <span class="hljs-comment">// 工具函数</span>
          <span class="hljs-string">'tests/'</span>            <span class="hljs-comment">// 测试</span>
        ],
        <span class="hljs-attr">config</span>: [
          <span class="hljs-string">'tsconfig.json'</span>,
          <span class="hljs-string">'package.json'</span>,
          <span class="hljs-string">'.env'</span>,
          <span class="hljs-string">'dockerfile'</span>
        ]
      }
    };
    
    <span class="hljs-keyword">return</span> structures[projectType] || structures.<span class="hljs-property">library</span>;
  }
  
  <span class="hljs-keyword">static</span> namingConventions = {
    <span class="hljs-attr">interfaces</span>: {
      <span class="hljs-attr">rule</span>: <span class="hljs-string">'使用 PascalCase，以 I 开头'</span>,
      <span class="hljs-attr">examples</span>: [<span class="hljs-string">'IUser'</span>, <span class="hljs-string">'IProductService'</span>, <span class="hljs-string">'IRepository'</span>]
    },
    
    <span class="hljs-attr">types</span>: {
      <span class="hljs-attr">rule</span>: <span class="hljs-string">'使用 PascalCase'</span>,
      <span class="hljs-attr">examples</span>: [<span class="hljs-string">'UserData'</span>, <span class="hljs-string">'ApiResponse'</span>, <span class="hljs-string">'ConfigOptions'</span>]
    },
    
    <span class="hljs-attr">classes</span>: {
      <span class="hljs-attr">rule</span>: <span class="hljs-string">'使用 PascalCase'</span>,
      <span class="hljs-attr">examples</span>: [<span class="hljs-string">'UserService'</span>, <span class="hljs-string">'DatabaseConnection'</span>, <span class="hljs-string">'HttpClient'</span>]
    },
    
    <span class="hljs-attr">variables</span>: {
      <span class="hljs-attr">rule</span>: <span class="hljs-string">'使用 camelCase'</span>,
      <span class="hljs-attr">examples</span>: [<span class="hljs-string">'userName'</span>, <span class="hljs-string">'productList'</span>, <span class="hljs-string">'isLoading'</span>]
    },
    
    <span class="hljs-attr">constants</span>: {
      <span class="hljs-attr">rule</span>: <span class="hljs-string">'使用 UPPER_SNAKE_CASE'</span>,
      <span class="hljs-attr">examples</span>: [<span class="hljs-string">'MAX_RETRY_COUNT'</span>, <span class="hljs-string">'API_BASE_URL'</span>, <span class="hljs-string">'DEFAULT_TIMEOUT'</span>]
    },
    
    <span class="hljs-attr">generics</span>: {
      <span class="hljs-attr">rule</span>: <span class="hljs-string">'使用单个大写字母，T 开头'</span>,
      <span class="hljs-attr">examples</span>: [<span class="hljs-string">'T'</span>, <span class="hljs-string">'K'</span>, <span class="hljs-string">'V'</span>, <span class="hljs-string">'TKey'</span>, <span class="hljs-string">'TValue'</span>]
    }
  };
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">createTSConfig</span>(<span class="hljs-params">projectType, options = {}</span>) {
    <span class="hljs-keyword">const</span> baseConfig = {
      <span class="hljs-attr">compilerOptions</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'es2020'</span>,
        <span class="hljs-attr">module</span>: <span class="hljs-string">'commonjs'</span>,
        <span class="hljs-attr">lib</span>: [<span class="hljs-string">'es2020'</span>],
        <span class="hljs-attr">outDir</span>: <span class="hljs-string">'./dist'</span>,
        <span class="hljs-attr">rootDir</span>: <span class="hljs-string">'./src'</span>,
        <span class="hljs-attr">strict</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">esModuleInterop</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">skipLibCheck</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">forceConsistentCasingInFileNames</span>: <span class="hljs-literal">true</span>
      }
    };
    
    <span class="hljs-keyword">const</span> typeSpecific = {
      <span class="hljs-attr">library</span>: {
        <span class="hljs-attr">compilerOptions</span>: {
          <span class="hljs-attr">declaration</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">declarationMap</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">sourceMap</span>: <span class="hljs-literal">true</span>
        }
      },
      
      <span class="hljs-attr">application</span>: {
        <span class="hljs-attr">compilerOptions</span>: {
          <span class="hljs-attr">jsx</span>: <span class="hljs-string">'react-jsx'</span>,
          <span class="hljs-attr">moduleResolution</span>: <span class="hljs-string">'node'</span>,
          <span class="hljs-attr">allowSyntheticDefaultImports</span>: <span class="hljs-literal">true</span>
        }
      },
      
      <span class="hljs-attr">node</span>: {
        <span class="hljs-attr">compilerOptions</span>: {
          <span class="hljs-attr">module</span>: <span class="hljs-string">'commonjs'</span>,
          <span class="hljs-attr">target</span>: <span class="hljs-string">'es2020'</span>,
          <span class="hljs-attr">lib</span>: [<span class="hljs-string">'es2020'</span>]
        }
      }
    };
    
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepMerge</span>(
      baseConfig,
      typeSpecific[projectType] || {},
      { <span class="hljs-attr">compilerOptions</span>: options }
    );
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">deepMerge</span>(<span class="hljs-params">...objects</span>) {
    <span class="hljs-keyword">return</span> objects.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, obj</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
        <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isObject</span>(obj[key]) &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isObject</span>(acc[key])) {
            acc[key] = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deepMerge</span>(acc[key], obj[key]);
          } <span class="hljs-keyword">else</span> {
            acc[key] = obj[key];
          }
        }
      }
      <span class="hljs-keyword">return</span> acc;
    }, {});
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">isObject</span>(<span class="hljs-params">item</span>) {
    <span class="hljs-keyword">return</span> item &amp;&amp; <span class="hljs-keyword">typeof</span> item === <span class="hljs-string">'object'</span> &amp;&amp; !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(item);
  }
  
  <span class="hljs-comment">// 错误处理最佳实践</span>
  <span class="hljs-keyword">static</span> errorHandlingPatterns = {
    <span class="hljs-comment">// 使用Result类型处理错误</span>
    <span class="hljs-title class_">Result</span>: <span class="hljs-string">`
type Result&lt;T, E = Error&gt; = 
  | { success: true; data: T }
  | { success: false; error: E };

function safeOperation(): Result&lt;string&gt; {
  try {
    const result = riskyOperation();
    return { success: true, data: result };
  } catch (error) {
    return { success: false, error: error as Error };
  }
}
    `</span>,
    
    <span class="hljs-comment">// 自定义错误类</span>
    <span class="hljs-title class_">CustomError</span>: <span class="hljs-string">`
class AppError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500
  ) {
    super(message);
    this.name = 'AppError';
  }
}

class ValidationError extends AppError {
  constructor(message: string) {
    super(message, 'VALIDATION_ERROR', 400);
    this.name = 'ValidationError';
  }
}
    `</span>,
    
    <span class="hljs-comment">// 错误边界</span>
    <span class="hljs-title class_">ErrorBoundary</span>: <span class="hljs-string">`
class ErrorBoundary {
  private errorHandlers = new Map&lt;string, (error: Error) =&gt; void&gt;();
  
  register(component: string, handler: (error: Error) =&gt; void) {
    this.errorHandlers.set(component, handler);
  }
  
  handle(component: string, error: Error) {
    const handler = this.errorHandlers.get(component);
    if (handler) {
      handler(error);
    } else {
      console.error(\`未处理的错误 (\${component}):\`, error);
    }
  }
}
    `</span>
  };
}

<span class="hljs-comment">// 使用最佳实践</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'库项目结构:'</span>, <span class="hljs-title class_">TypeScriptBestPractices</span>.<span class="hljs-title function_">structureProject</span>(<span class="hljs-string">'library'</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'命名约定:'</span>, <span class="hljs-title class_">TypeScriptBestPractices</span>.<span class="hljs-property">namingConventions</span>);

<span class="hljs-keyword">const</span> libConfig = <span class="hljs-title class_">TypeScriptBestPractices</span>.<span class="hljs-title function_">createTSConfig</span>(<span class="hljs-string">'library'</span>, {
  <span class="hljs-attr">outDir</span>: <span class="hljs-string">'./lib'</span>,
  <span class="hljs-attr">declarationDir</span>: <span class="hljs-string">'./types'</span>
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'库TS配置:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(libConfig, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
</code></pre>
<h4 data-id="heading-22">总结</h4>
<p>TypeScript通过强大的类型系统、接口泛型、装饰器等特性，极大地提升了JavaScript代码的质量和开发体验。本文深入探讨了TypeScript的核心实现原理和高级特性，并提供了实际可用的代码示例。</p>
<p><strong>核心要点总结:</strong></p>
<ol>
<li><strong>类型系统:</strong> TypeScript通过编译时类型检查提供安全保障，运行时也可通过代理模式实现类型验证</li>
<li><strong>接口与泛型:</strong> 通过设计模式模拟接口实现，泛型提供代码复用性和类型安全性</li>
<li><strong>装饰器:</strong> 元编程的强大工具，实现依赖注入、验证、日志等横切关注点</li>
<li><strong>类型推断:</strong> 自动推断变量类型，减少冗余的类型注解</li>
<li><strong>模块与工程化:</strong> 完善的模块系统支持，与构建工具深度集成</li>
<li><strong>最佳实践:</strong> 合理的项目结构、命名约定和错误处理策略</li>
</ol>
<p>TypeScript不仅是JavaScript的类型超集，更是一种工程化实践。它将静态类型语言的严谨性与JavaScript的灵活性完美结合，成为现代前端开发不可或缺的工具。随着TypeScript的持续发展，其类型系统将变得更加智能和强大，为构建大型、可维护的应用程序提供坚实保障。</p>
<p>在实际项目中，应根据团队规模、项目复杂度和技术栈选择合适的TypeScript特性，平衡类型安全性和开发效率。通过渐进式迁移策略，即使现有JavaScript项目也能平滑过渡到TypeScript，享受类型系统带来的诸多好处。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[A2UI vs OOD全栈方案：AI驱动UI的两种技术路径深度解析]]></title>    <link>https://juejin.cn/post/7585928504949833764</link>    <guid>https://juejin.cn/post/7585928504949833764</guid>    <pubDate>2025-12-22T06:09:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585928504949833764" data-draft-id="7585928504949817380" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="​ A2UI vs OOD全栈方案：AI驱动UI的两种技术路径深度解析"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2025-12-22T06:09:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ​ A2UI vs OOD全栈方案：AI驱动UI的两种技术路径深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:09:49.000Z" title="Mon Dec 22 2025 06:09:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：AI驱动UI的核心矛盾与技术选型</h2>
<p>当AI需要生成交互式UI时，开发者面临两大核心矛盾：<strong>安全可控</strong>与<strong>跨平台兼容</strong>。传统方案中，AI生成HTML/JS存在XSS风险，而多端适配又需重复开发——A2UI（Google开源声明式UI协议）与OOD全栈方案（Java注解驱动的全栈框架）分别给出了不同解法：</p>
<ul>
<li>A2UI以“JSON元数据描述”为核心，让AI只输出“界面意图”，客户端用原生组件渲染，主打安全与跨平台；</li>
<li>OOD以“Java注解+强类型协同”为核心，构建“前端组件-后端服务”全栈闭环，主打企业级可维护性与效率。</li>
</ul>
<p>本文将先解析A2UI的协议设计与技术原理，再对比OOD全栈方案的架构特性，最终给出场景化选型建议。</p>
<h2 data-id="heading-1">一、A2UI：AI与客户端的UI交互契约</h2>
<p>A2UI（Agent-to-UI）并非框架，而是<strong>面向代理驱动界面的声明式JSON协议</strong>——核心是让AI生成“界面描述数据”，而非可执行代码，客户端通过预定义组件目录（Catalog）渲染原生UI，彻底解决“AI生成UI的安全与跨平台问题”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aa3eb74771d4a8d9cef623f93b7d5ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988589&amp;x-signature=q7xGudVklEVa%2FOQhDIoqV6nmRSA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-2">1.1 核心定位：为什么需要A2UI？</h3>
<p>传统AI交互的痛点的在于“纯文本低效”与“代码生成不安全”：</p>
<ul>
<li>文本交互：用户预订餐厅需多轮问答（“哪天？”“几点？”），效率低；</li>
<li>代码生成：AI输出HTML/JS易引发XSS攻击，且多端样式不统一。</li>
</ul>
<p>A2UI的解法是“<strong>数据替代代码</strong>”：AI生成符合协议规范的JSON元数据（描述“要什么UI”），客户端用自己的原生组件（如Web的React、移动端的Flutter）渲染（负责“怎么画UI”），实现“像数据一样安全，像代码一样有表达力”。</p>
<h3 data-id="heading-3">1.2 底层技术原理：三大核心设计</h3>
<p>A2UI的技术壁垒在于“适配AI流式生成”与“安全隔离”，核心原理可拆解为三部分：</p>
<h4 data-id="heading-4">1.2.1 流式消息：AI边想边输出，客户端渐进渲染</h4>
<p>A2UI采用<strong>SSE（Server-Sent Events）传输JSONL（JSON Lines）格式</strong>，AI无需一次性生成完整UI，可“边生成边发送”，客户端“边接收边缓冲”，避免用户等待。核心消息类型分4类，按流程协作：</p>






























<table><thead><tr><th align="left">消息类型</th><th align="left">作用</th><th align="left">示例片段</th></tr></thead><tbody><tr><td align="left"><code>surfaceUpdate</code></td><td align="left">定义组件结构（缓冲，不渲染）</td><td align="left"><code>{"surfaceUpdate":{"surfaceId":"booking","components":[{"id":"date-input","component":{"DateTimeInput":{"value":{"path":"/booking/date"}}}]}}</code></td></tr><tr><td align="left"><code>dataModelUpdate</code></td><td align="left">更新组件绑定数据（缓冲）</td><td align="left"><code>{"dataModelUpdate":{"surfaceId":"booking","contents":{"key":"/booking/date","valueString":"2025-12-16T19:00:00Z"}}}</code></td></tr><tr><td align="left"><code>beginRendering</code></td><td align="left">触发渲染（避免半成品界面）</td><td align="left"><code>{"beginRendering":{"surfaceId":"booking","root":"date-input"}}</code></td></tr><tr><td align="left"><code>deleteSurface</code></td><td align="left">销毁无用UI（释放内存）</td><td align="left"><code>{"deleteSurface":{"surfaceId":"booking"}}</code></td></tr></tbody></table>
<p><strong>关键优势</strong>：AI生成复杂UI（如多字段表单）时，用户能看到界面逐步构建，体验优于“空白等待”。</p>
<h4 data-id="heading-5">1.2.2 声明式组件：邻接表模型适配AI生成</h4>
<p>传统UI描述是嵌套结构（如HTML），AI需完整构思层级关系；A2UI采用<strong>扁平化邻接表模型</strong>——每个组件独立定义，通过ID引用建立父子关系，AI可按任意顺序生成组件。</p>
<p>示例：生成“预订表单”的组件定义（顺序无关）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 1. 先定义父容器（Card）</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"form-card"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"Card"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"date-input"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"submit-btn"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-comment">// 2. 再定义子组件（日期选择器+按钮）</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"date-input"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"DateTimeInput"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"/booking/date"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"submit-btn"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"Button"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"literalString"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"确认"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"confirm_booking"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>技术价值</strong>：</p>
<ul>
<li>AI友好：无需提前规划嵌套关系，出错时仅需重发单个组件；</li>
<li>增量更新：修改按钮文本只需重发<code>submit-btn</code>的定义，无需重建整个UI树。</li>
</ul>
<h4 data-id="heading-6">1.2.3 安全沙箱：客户端控制组件白名单</h4>
<p>A2UI的安全性核心是“<strong>组件目录（Catalog）</strong> ”——客户端维护“组件类型-原生实现”的映射表（白名单），AI仅能引用表中的组件，无法自定义或注入代码。</p>
<p>示例Web端Catalog映射：</p>




















<table><thead><tr><th align="left">A2UI组件类型</th><th align="left">客户端原生实现</th><th align="left">约束条件</th></tr></thead><tbody><tr><td align="left"><code>Button</code></td><td align="left">React Button组件</td><td align="left">仅支持primary/default类型</td></tr><tr><td align="left"><code>DateTimeInput</code></td><td align="left">Ant Design DatePicker</td><td align="left">禁用未来30天选择</td></tr></tbody></table>
<p><strong>安全逻辑</strong>：AI发送<code>surfaceUpdate</code>后，客户端先校验组件类型是否在Catalog中，不存在则直接丢弃——从根源杜绝恶意组件注入。</p>
<h3 data-id="heading-7">1.3 关键特性与适用场景</h3>
<h4 data-id="heading-8">核心特性：</h4>
<ol>
<li><strong>跨平台原生</strong>：同一份JSON可在Web（Lit/Angular）、移动（Flutter/SwiftUI）、桌面渲染，样式随客户端设计系统统一；</li>
<li><strong>响应式数据绑定</strong>：基于JSON Pointer（如<code>/booking/date</code>）关联组件与数据，数据变化时仅更新绑定组件；</li>
<li><strong>LLM友好</strong>：扁平结构+流式生成，AI解析正确率超95%，无需理解复杂语法。</li>
</ol>
<h4 data-id="heading-9">适用场景：</h4>
<ul>
<li>✅ AI动态生成UI（如智能助手生成预订表单、客服生成工单界面）；</li>
<li>✅ 多平台统一交互（Web/移动端共用一份AI逻辑）；</li>
<li>✅ 安全敏感场景（金融、政务，需杜绝代码执行风险）。</li>
</ul>
<h2 data-id="heading-10">二、OOD全栈方案：Java注解驱动的企业级全栈框架</h2>
<p>OOD并非单纯前端框架，而是“<strong>前端轻量级组件框架+后端Ooder注解驱动框架</strong>”的一体化方案——核心是通过Java注解实现“前后端强类型协同”，解决企业级应用“全栈开发效率低”与“架构可维护性差”的问题。</p>
<h3 data-id="heading-11">2.1 核心定位：企业级全栈的“注解化”解耦</h3>
<p>传统全栈开发的痛点在于“前后端对接碎片化”：前端写请求代码、后端写接口文档、字段映射需手动适配。OOD的解法是“<strong>注解驱动全栈衔接</strong>”：</p>
<ul>
<li>后端Ooder框架：用Java注解定义接口、数据映射、事件逻辑；</li>
<li>前端组件框架：通过注解引用后端能力，无需手动编写适配代码；</li>
<li>整体目标：让开发者聚焦业务逻辑，而非对接细节。</li>
</ul>
<h3 data-id="heading-12">2.2 底层技术原理：注解驱动的全栈协同</h3>
<p>OOD的技术核心是“<strong>后端注解引擎+前端三层架构+胶水层强类型约束</strong>”，三者联动实现全栈闭环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3b980b49df7488ea596d50521cfaef8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766988589&amp;x-signature=B3LlCBLx5mcS1kZJjUhB4fYUb9Q%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-13">2.2.1 后端Ooder：Java注解驱动的全栈能力</h4>
<p>Ooder框架通过三大核心注解，将后端能力“封装成前端可直接引用的资源”：</p>
<ol>
<li><strong>@ApiBind：接口绑定自动化</strong>undefined用注解定义前端组件与后端接口的映射，编译时自动生成请求代理类，前端无需写HTTP代码：  // 后端接口定义
@ApiBind(url = "/api/user/list", method = HttpMethod.GET)
public class UserListApi {
@RequestParam(required = true) // 强制参数校验（前端无需再校验）
private Integer pageSize;
}前端组件通过<code>@ApiRef("UserListApi")</code>直接引用，框架自动处理请求、响应解析与错误重试。</li>
<li><strong>@DataMapping：数据映射无感知</strong>undefined用注解定义后端DTO与前端组件字段的映射，避免手动转换：  public class UserDTO {
@DataMapping(target = "userName") // 映射前端组件的userName字段
private String user_name; // 后端下划线命名，前端驼峰命名
}底层通过CGLIB动态生成映射代理，比传统反射快5倍，兼顾效率与易用性。</li>
<li><strong>@EventBind：事件逻辑后端定义</strong>undefined前端组件的交互逻辑（如按钮点击）通过后端注解定义，前端仅需触发事件ID：  @EventBind(componentId = "submit-btn", event = "onClick")
public class SubmitEvent {
@PreCheck("validateForm") // 点击前执行表单校验（后端定义）
@PostAction("refreshTable") // 点击后刷新表格
public void execute(UserDTO dto) {
// 后端业务逻辑（如保存数据）
}
}</li>
</ol>
<h4 data-id="heading-14">2.2.1 前端三层架构：适配AI与可视化</h4>
<p>OOD前端并非低代码工具，而是为“AI辅助开发”设计的轻量级架构，分三层各司其职：</p>
<ul>
<li><strong>可视化界面层</strong>：组件树视图+预览窗口，支持所见即所得配置；</li>
<li><strong>逻辑处理层</strong>：动作解析引擎（将配置转成可执行逻辑）+执行调度器（管理异步顺序）；</li>
<li><strong>数据存储层</strong>：JSON Schema校验配置，确保AI生成的组件符合规范。</li>
</ul>
<p>核心优势：AI只需聚焦“逻辑处理层”（解析动作配置），无需理解前端细节，解析正确率从85%提升至98%。</p>
<h4 data-id="heading-15">2.2.3 胶水层：强类型协同避免对接错误</h4>
<p>OOD通过“<strong>Java枚举+编译时校验</strong>”解决前后端“方法不匹配”“参数类型错误”：</p>
<ul>
<li>前端组件对应后端枚举类，定义支持的方法与参数类型：  public enum InputMethod implements ComponentMethod {
setValue(String.class), // 前端仅能调用此方法，参数必须是String
setDisabled(Boolean.class);
}</li>
<li>编译时校验：若前端调用枚举外的方法，或参数类型错误，直接报错，避免运行时问题。</li>
</ul>
<h3 data-id="heading-16">2.3 关键特性与适用场景</h3>
<h4 data-id="heading-17">核心特性：</h4>
<ol>
<li><strong>企业级能力</strong>：支持权限控制、事务管理、数据一致性（继承Java生态优势）；</li>
<li><strong>工具链完善</strong>：设计稿解析（Figma→注解参数）、接口生成（根据@ApiBind自动生成后端模板）；</li>
<li><strong>强类型安全</strong>：编译时校验前后端对接，减少70%的联调问题。</li>
</ol>
<h4 data-id="heading-18">适用场景：</h4>
<ul>
<li>✅ 企业级全栈应用（ERP、CRM，需稳定的后端能力与权限控制）；</li>
<li>✅ 多团队协作开发（强类型约束保障代码一致性）；</li>
<li>✅ 传统应用升级（需与现有Java后端无缝集成）。</li>
</ul>
<h2 data-id="heading-19">三、A2UI与OOD全栈方案核心差异对比</h2>













































<table><thead><tr><th align="left">对比维度</th><th align="left">A2UI协议</th><th align="left">OOD全栈方案</th></tr></thead><tbody><tr><td align="left">核心载体</td><td align="left">JSON元数据（弱类型，客户端校验）</td><td align="left">Java注解+枚举（强类型，编译时校验）</td></tr><tr><td align="left">技术内核</td><td align="left">声明式UI描述+客户端原生渲染</td><td align="left">注解驱动全栈衔接+前后端强类型协同</td></tr><tr><td align="left">安全性保障</td><td align="left">组件目录白名单（无代码执行）</td><td align="left">编译时类型校验+枚举方法约束</td></tr><tr><td align="left">跨平台能力</td><td align="left">天然跨平台（一份JSON多端渲染）</td><td align="left">后端统一，前端需适配多端组件</td></tr><tr><td align="left">AI适配重点</td><td align="left">AI生成UI意图（动态、流式）</td><td align="left">AI解析配置（静态、强约束）</td></tr><tr><td align="left">企业级特性</td><td align="left">仅UI渲染，需额外集成后端能力</td><td align="left">内置权限、事务、数据一致性支持</td></tr><tr><td align="left">开发门槛</td><td align="left">低（懂JSON即可）</td><td align="left">中（需掌握Java注解与前端基础）</td></tr></tbody></table>
<h2 data-id="heading-20">四、选型建议：场景决定技术路径</h2>
<ol>
<li><strong>AI驱动的动态交互场景</strong>：选A2UI
<ul>
<li>例：智能助手生成预订表单、客服系统生成工单界面；</li>
<li>理由：跨平台原生渲染+安全沙箱，适配AI动态生成需求。</li>
</ul>
</li>
<li><strong>企业级全栈应用场景</strong>：选OOD全栈方案
<ul>
<li>例：制造行业ERP、金融行业CRM；</li>
<li>理由：注解驱动提效+强类型安全，适配复杂业务与多团队协作。</li>
</ul>
</li>
<li><strong>混合场景（企业级+AI功能）</strong>：A2UI+OOD协同
<ul>
<li>方案：OOD后端提供核心业务接口（用户、订单），AI通过A2UI生成动态UI，前端通过OOD注解对接后端接口；</li>
<li>优势：兼顾企业级数据安全与AI交互灵活性。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-21">结语：两种技术的未来演进</h2>
<ul>
<li>A2UI：将进一步扩展组件能力（支持图表、树形组件），完善“AI与客户端状态同步”机制，适配更复杂的交互场景；</li>
<li>OOD全栈方案：将优化注解编译效率（基于GraalVM生成原生镜像），增强AI生成注解配置的能力（自然语言→@ApiBind注解）。</li>
</ul>
<p>二者并非竞争关系，而是分别解决“AI UI交互”与“企业级全栈”的不同痛点——未来在“企业级AI应用”中，有望形成“OOD负责数据层+A2UI负责交互层”的互补格局。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次“虚拟环境复制引发的血案”：记一次 itsdangerous 版本混乱排查全过程]]></title>    <link>https://juejin.cn/post/7586136543955140646</link>    <guid>https://juejin.cn/post/7586136543955140646</guid>    <pubDate>2025-12-22T06:12:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543955140646" data-draft-id="7586136543955124262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次“虚拟环境复制引发的血案”：记一次 itsdangerous 版本混乱排查全过程"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-22T06:12:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次“虚拟环境复制引发的血案”：记一次 itsdangerous 版本混乱排查全过程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:12:59.000Z" title="Mon Dec 22 2025 06:12:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：不要复制带 <code>venv</code> 的项目文件夹！否则你会在“pip 显示 1.1.0，Python 却跑 2.2.0”的迷宫里绕到怀疑人生。</p>
</blockquote>
<h2 data-id="heading-0">一次“虚拟环境复制引发的血案”：记一次 itsdangerous 版本混乱排查全过程</h2>
<hr/>
<h3 data-id="heading-1">起因：一个看似简单的注册功能</h3>
<p>我正在开发一个 Flask 应用，需要实现用户邮箱确认功能。按照惯例，使用 <code>itsdangerous</code> 生成带过期时间的 token：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> itsdangerous <span class="hljs-keyword">import</span> URLSafeTimedSerializer

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_confirmation_token</span>(<span class="hljs-params">self, expiration=<span class="hljs-number">3600</span></span>):
    s = URLSafeTimedSerializer(
        current_app.config[<span class="hljs-string">'SECRET_KEY'</span>],
        expires_in=expiration,
        salt=<span class="hljs-string">'confirm'</span>
    )
    <span class="hljs-keyword">return</span> s.dumps({<span class="hljs-string">'confirm'</span>: self.<span class="hljs-built_in">id</span>})
</code></pre>
<p>结果一调用就报错：</p>
<pre><code class="hljs language-css" lang="css">TypeError: <span class="hljs-built_in">__init__</span>() got an unexpected keyword argument <span class="hljs-string">'expires_in'</span>
</code></pre>
<p>？？？不是说 <code>URLSafeTimedSerializer</code> 支持 <code>expires_in</code> 吗？</p>
<hr/>
<h3 data-id="heading-2">第一重迷惑：版本到底是什么？</h3>
<p>我查了下依赖：</p>
<pre><code class="hljs language-powershell" lang="powershell">pip list | select-string dang
# 输出：itsdangerous 1.1.0
</code></pre>
<p>但为了保险，我在代码里加了打印：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> itsdangerous
<span class="hljs-built_in">print</span>(<span class="hljs-string">"REAL version:"</span>, itsdangerous.__version__)
</code></pre>
<p>输出竟然是：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-type">REAL</span> version: <span class="hljs-number">2.2</span><span class="hljs-number">.0</span>
</code></pre>
<p><strong>pip 说 1.1.0，Python 说 2.2.0</strong> —— 我的电脑成精了？</p>
<p>更诡异的是，<code>pip show itsdangerous</code> 一开始显示 1.1.0，后来干脆说“没安装”！</p>
<hr/>
<h3 data-id="heading-3">第二重迷惑：路径对不上</h3>
<p>运行 <code>pip --version</code>，我以为一切正常：</p>
<pre><code class="hljs language-csharp" lang="csharp">pip <span class="hljs-number">25.0</span><span class="hljs-number">.1</span> <span class="hljs-keyword">from</span> c:\projects\shorturl_service\venv\...
</code></pre>
<p>等等！我的项目叫 <code>multi-llm</code>，怎么 pip 路径是 <code>shorturl_service</code>？</p>
<p>原来……我当初是<strong>直接复制了另一个项目 <code>shorturl_service</code>，改名成 <code>multi-llm</code></strong> 的！</p>
<p>而虚拟环境 <code>venv</code> 是<strong>跟着文件夹一起复制过来的</strong>。虽然文件夹名字变了，但 <code>venv</code> 内部所有路径、激活脚本、解释器引用<strong>仍然指向“逻辑上的旧项目”</strong>。</p>
<p>PowerShell 虽然显示 <code>(venv)</code>，但底层用的还是 <code>shorturl_service</code> 的环境！<br/>
这就导致：</p>
<ul>
<li>我在 <code>multi-llm</code> 目录下操作</li>
<li>但 <code>pip</code> 和 <code>python</code> 实际作用于 <code>shorturl_service</code> 的 venv</li>
<li>两个项目的包混在一起，版本冲突爆炸</li>
</ul>
<hr/>
<h3 data-id="heading-4">第三重迷惑：包“幽灵式”存在</h3>
<p>即使我卸载了 <code>itsdangerous</code>，Python 依然能 <code>import</code> 它！</p>
<p>原因可能是：</p>
<ul>
<li>通过 <code>pip install -e</code> 可编辑安装过</li>
<li>手动复制过源码到 <code>site-packages</code></li>
<li><code>.egg-link</code> 或 <code>easy-install.pth</code> 残留</li>
</ul>
<p><code>pip</code> 根本不知道这个包的存在，但 Python 导入系统能找到它——典型的“游离包”。</p>
<hr/>
<h3 data-id="heading-5">终极解决方案：彻底重建虚拟环境</h3>
<h4 data-id="heading-6">✅ 正确操作步骤：</h4>
<pre><code class="hljs language-powershell" lang="powershell"># 1. 退出当前（错误的）环境
deactivate

# 2. 删除复制来的旧 venv（罪魁祸首！）
Remove-Item -Recurse -Force venv

# 3. 创建全新的虚拟环境
python -m venv venv

# 4. 激活
.\venv\Scripts\Activate.ps1

# 5. 重装依赖
pip install -r requirements.txt
</code></pre>
<h4 data-id="heading-7">✅ 适配新版 itsdangerous（&gt;=2.0）</h4>
<p>既然用新版，就按新版 API 写：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生成 token</span>
s = URLSafeTimedSerializer(secret_key, salt=<span class="hljs-string">'confirm-email'</span>)
token = s.dumps({<span class="hljs-string">'confirm'</span>: self.<span class="hljs-built_in">id</span>}, expiration)  <span class="hljs-comment"># 注意：expiration 是 dumps 的参数！</span>

<span class="hljs-comment"># 验证 token</span>
data = s.loads(token, max_age=expiration)  <span class="hljs-comment"># 注意：用 max_age！</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">血泪教训总结</h3>

























<table><thead><tr><th>错误做法</th><th>正确做法</th></tr></thead><tbody><tr><td>复制整个项目文件夹（含 venv）并改名</td><td>只复制源码，<strong>重新创建 venv</strong></td></tr><tr><td>相信 <code>pip list</code> 而不验证运行时版本</td><td>用 <code>python -c "import pkg; print(pkg.__version__)"</code> 确认真实版本</td></tr><tr><td>忽略 <code>pip --version</code> 的路径</td><td>每次激活 venv 后，检查路径是否匹配当前项目</td></tr><tr><td>试图“修复”混乱的环境</td><td><strong>直接删除 venv 重建</strong>，省时省力</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">最后忠告</h3>
<blockquote>
<p><strong>虚拟环境（venv）不是普通文件夹，它是和绝对路径绑定的“活体”</strong>。<br/>
复制它，就像克隆一个人却不更新他的身份证号——迟早出问题。</p>
</blockquote>
<p>从此以后，我的 <code>.gitignore</code> 里永远有这一行：</p>
<pre><code class="hljs">venv/
</code></pre>
<p>而新建项目的第一步，永远是：</p>
<pre><code class="hljs language-bash" lang="bash">python -m venv venv
</code></pre>
<p>——谨以此文，祭奠我浪费的 3 小时 debug 时间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 严格性是非单调的：strict-null-checks 和 no-implicit-any 的相互影响]]></title>    <link>https://juejin.cn/post/7585928504949882916</link>    <guid>https://juejin.cn/post/7585928504949882916</guid>    <pubDate>2025-12-22T06:15:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585928504949882916" data-draft-id="7585928504949866532" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 严格性是非单调的：strict-null-checks 和 no-implicit-any 的相互影响"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2025-12-22T06:15:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 严格性是非单调的：strict-null-checks 和 no-implicit-any 的相互影响
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:15:04.000Z" title="Mon Dec 22 2025 06:15:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文： <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuonw.github.io%2Fblog%2F2025%2F12%2Ftypescript-monotonic%2F" target="_blank" title="https://huonw.github.io/blog/2025/12/typescript-monotonic/" ref="nofollow noopener noreferrer">TypeScript strictness is non-monotonic: strict-null-checks and no-implicit-any interact</a></p>
<p>翻译： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.heyfe.org%2Fblog" target="_blank" title="https://blog.heyfe.org/blog" ref="nofollow noopener noreferrer">嘿嘿</a></p>
<p>来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">前端周刊</a></p>
</blockquote>
<p>TypeScript 编译器选项 <code>strictNullChecks</code> 和 <code>noImplicitAny</code> 以一种奇怪的方式相互作用：仅启用 <code>strictNullChecks</code> 会导致类型错误，而在同时启用 <code>noImplicitAny</code> 后这些错误却消失了。这意味着更严格的设置反而导致更少的错误！</p>
<p>这虽然是一个影响不大的奇闻异事，但我在实际工作中确实遇到了它，当时我正在将一些模块更新为更严格的设置。</p>
<h2 data-id="heading-0">背景</h2>
<p>TypeScript 是驯服 JavaScript 代码库的强大工具，但要获得最大的保障，需要在“严格”模式下使用它。</p>
<p>在现有的 JavaScript 代码库中采用 TypeScript 可以逐步完成：逐个打开每个严格的子设置，并逐一处理出现的错误。这种渐进式方法使得采用变得可行：不要在一次大爆炸中修复<em>整个世界</em>，而是进行多次较小的更改，直到最终世界被修复。</p>
<p>在工作中，我们最近一直在以这种方式逐步提高代码的严格性，然后我遇到了这种相互作用。</p>
<h2 data-id="heading-1">示例</h2>
<p>下面这段代码中，<code>array</code> 的类型是什么？</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> array = [];
array.<span class="hljs-title function_">push</span>(<span class="hljs-number">123</span>);
</code></pre>
<p>作为一个独立的代码片段，它看起来奇怪且毫无意义（“为什么不直接用 <code>const array = [123];</code>？”），但它是真实代码的最小化版本。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> featureFlags = [];

<span class="hljs-keyword">if</span> (<span class="hljs-title function_">enableRocket</span>()) {
  featureFlags.<span class="hljs-title function_">push</span>(<span class="hljs-string">"rocket"</span>);
}
<span class="hljs-keyword">if</span> (<span class="hljs-title function_">enableParachute</span>()) {
  featureFlags.<span class="hljs-title function_">push</span>(<span class="hljs-string">"parachute"</span>);
}

<span class="hljs-title function_">prepareForLandSpeedRecord</span>(featureFlags);
</code></pre>
<p>这里没有显式的类型注解，所以 TypeScript 需要推断它。这种推断有点巧妙，因为它需要“时间旅行”（指需要运行后续语句后回头去修改推断的类型，类似正则回溯）：<code>const array = []</code> 这个声明并没有说明数组中可能包含什么，这个信息只来自代码后面出现的 <code>push</code>。</p>
<p>考虑到所有这些，推断出的确切类型依赖于两个 TypeScript 语言选项也就不足为奇了：</p>



































<table><thead><tr><th/><th>strictNullChecks</th><th>noImplicitAny</th><th>推断类型</th></tr></thead><tbody><tr><td>最不严格</td><td>❌</td><td>❌</td><td>any[]</td></tr><tr><td/><td>❌</td><td>✅</td><td>number[]</td></tr><tr><td/><td>✅</td><td>❌</td><td>never[]</td></tr><tr><td>最严格</td><td>✅</td><td>✅</td><td>number[]</td></tr></tbody></table>
<h2 data-id="heading-2">选项说明</h2>
<p>这里影响推断类型的两个选项是：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Ftsconfig%2F%23strictNullChecks" target="_blank" title="https://www.typescriptlang.org/tsconfig/#strictNullChecks" ref="nofollow noopener noreferrer">strictNullChecks</a>：正确强制处理可选/可为空的值。例如，启用后，一个可为空的字符串变量（类型为 <code>string | null</code>）不能直接用在期望普通 <code>string</code> 值的地方。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Ftsconfig%2F%23noImplicitAny" target="_blank" title="https://www.typescriptlang.org/tsconfig/#noImplicitAny" ref="nofollow noopener noreferrer">noImplicitAny</a>：避免在一些模棱两可的情况下推断出“全能”的 <code>any</code> 类型。</li>
</ul>
<p>最好同时启用它们：<code>strictNullChecks</code> 解决了<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FNull%255Fpointer%23History" target="_blank" title="https://en.wikipedia.org/wiki/Null%5Fpointer#History" ref="nofollow noopener noreferrer">“十亿美元的错误”</a>，而 <code>noImplicitAny</code> 减少了感染代码库的容易出错的 <code>any</code> 的数量。</p>
<h2 data-id="heading-3">问题所在</h2>
<p>我们上表中第三种配置，即启用 <code>strictNullChecks</code> 但禁用 <code>noImplicitAny</code> 时，推断出 <code>array: never[]</code>。因此，代码片段无效并被报错（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fplay%2F%3Fstrict%3Dfalse%26noImplicitAny%3Dfalse%26strictFunctionTypes%3Dfalse%26strictPropertyInitialization%3Dfalse%26strictBindCallApply%3Dfalse%26noImplicitThis%3Dfalse%26noImplicitReturns%3Dfalse%26alwaysStrict%3Dfalse%26esModuleInterop%3Dfalse%26declaration%3Dfalse%26noErrorTruncation%3Dtrue%26noImplicitOverride%3Dfalse%26ts%3D5.9.3%23code%2FGYVwdgxgLglg9mABMAFASkQbwFCL4gegMRQDkAhAOkRiQENlxp4kAjAUwjpAGd3EGUOAAcAtABt2AN3bjEUugCcYdVpMQATTuKV1YCGj0Q9xMAOYALKOICex4ZxXi02XPggIeUAYsV07ALyIANoAugDcbnhKfjaUwrwWKACMAEwAzGiRAL5AA" target="_blank" title="https://www.typescriptlang.org/play/?strict=false&amp;noImplicitAny=false&amp;strictFunctionTypes=false&amp;strictPropertyInitialization=false&amp;strictBindCallApply=false&amp;noImplicitThis=false&amp;noImplicitReturns=false&amp;alwaysStrict=false&amp;esModuleInterop=false&amp;declaration=false&amp;noErrorTruncation=true&amp;noImplicitOverride=false&amp;ts=5.9.3#code/GYVwdgxgLglg9mABMAFASkQbwFCL4gegMRQDkAhAOkRiQENlxp4kAjAUwjpAGd3EGUOAAcAtABt2AN3bjEUugCcYdVpMQATTuKV1YCGj0Q9xMAOYALKOICex4ZxXi02XPggIeUAYsV07ALyIANoAugDcbnhKfjaUwrwWKACMAEwAzGiRAL5AA" ref="nofollow noopener noreferrer">在线示例</a>）：</p>
<pre><code class="hljs language-typescript" lang="typescript">array.<span class="hljs-title function_">push</span>(<span class="hljs-number">123</span>);
<span class="hljs-comment">//         ^^^ 错误：类型“123”的参数不能赋给类型“never”的参数。</span>
</code></pre>
<p>没有任何东西（既不是字面量 <code>123</code>，也不是任何其他 <code>number</code>，也不是任何其他东西）是 <code>never</code> 的“子类型”，所以，是的，这段代码无效是合理的。</p>
<h2 data-id="heading-4">奇怪之处</h2>
<p>“启用一些更严格的要求，然后得到一个错误”并不令人惊讶，也不值得注意……但让我们再仔细看看表格：</p>



































<table><thead><tr><th/><th>strictNullChecks</th><th>noImplicitAny</th><th>推断类型</th></tr></thead><tbody><tr><td>最不严格</td><td>❌</td><td>❌</td><td>any[]</td></tr><tr><td/><td>❌</td><td>✅</td><td>number[]</td></tr><tr><td><strong>报错！</strong></td><td>✅</td><td>❌</td><td><strong>never[]</strong></td></tr><tr><td>最严格</td><td>✅</td><td>✅</td><td>number[]</td></tr></tbody></table>
<p>所以，如果我们从一个宽松的代码库开始，并希望使其变得严格，我们可能会：</p>
<ol>
<li>启用 <code>strictNullChecks</code>，然后遇到一个新错误（不奇怪），然后</li>
<li><strong>解决这个错误</strong>，无需更改代码，只需启用 <code>noImplicitAny</code>（奇怪！）。</li>
</ol>
<p>当我们朝着完全严格的方向前进时，逐个启用严格选项可能会导致一些“虚假的”错误短暂出现，仅仅出现在中间的半严格状态。随着我们打开设置，错误数量会先上升后下降！</p>
<p>我个人期望启用严格选项是单调的：启用的选项越多 = 报错越多。但这一对选项违反了这种期望。</p>
<h2 data-id="heading-5">解决方案</h2>
<p>在尝试使 TypeScript 代码库变得严格时，有几种方法可以“解决”这种奇怪现象：</p>
<ol>
<li>直接用显式注解修复错误，例如 <code>const array: number[] = []</code>。</li>
<li>使用不同的逐个启用顺序：先启用 <code>noImplicitAny</code>，然后再启用 <code>strictNullChecks</code>。如上表所示，按照这个顺序，两个步骤的推断结果都是 <code>array: number[]</code>，因此没有错误。</li>
<li>同时启用它们：不要试图完全渐进，而是将这两个选项作为一步启用。</li>
</ol>
<h2 data-id="heading-6">解释</h2>
<p>为什么启用 <code>strictNullChecks</code> 并禁用 <code>noImplicitAny</code> 会导致一个在其他地方不出现的错误？<a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fa%2F72660888" target="_blank" title="https://stackoverflow.com/a/72660888" ref="nofollow noopener noreferrer">jcalz 在 StackOverflow 上解释得很好</a>，其核心是：</p>
<ul>
<li>这种有问题的组合是一个为了<strong>向后兼容</strong>而留下的边缘情况，其中 <code>array</code> 的类型在其声明处被推断为 <code>never[]</code>，并在后续代码中被锁定。</li>
<li>启用 <code>noImplicitAny</code> 会使编译器在模棱两可的位置（在没有 <code>noImplicitAny</code> 时会推断为 <code>any</code> 的地方）使用“演化”类型（evolving types，可理解为先推断为 any/never 然后后续追加推断的类型）：因此，<code>array</code> 的类型<em>不会</em>在其声明行被确定，并且可以结合来自 <code>push</code> 的信息进行推断。</li>
</ul>
<h2 data-id="heading-7">评论</h2>
<p>这感觉像是一个有趣的脑筋急转弯，而不是一个重大问题：</p>
<ul>
<li>修复这些虚假错误并不是一个重大的负担或显著的浪费时间，而且可以说，添加注解可能使这类代码更清晰。</li>
<li>半严格状态可能有奇怪的行为是可以理解的：我想 TypeScript 开发者更关心完全严格模式下的良好体验，希望中间状态只是垫脚石，而不是长期状态。</li>
</ul>
<h2 data-id="heading-8">总结</h2>
<p>TypeScript 选项 <code>strictNullChecks</code> 和 <code>noImplicitAny</code> 以一种奇怪的方式相互作用：以“错误”的顺序逐个启用它们会导致错误出现然后又消失，违反了单调性的期望（启用的严格选项越多 = 错误越多）。这可能发生在真实代码中，但影响极小，因为很容易解决和/或规避。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 已经改变了，你的 Hooks 也应该改变]]></title>    <link>https://juejin.cn/post/7586178555776843782</link>    <guid>https://juejin.cn/post/7586178555776843782</guid>    <pubDate>2025-12-22T06:16:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586178555776843782" data-draft-id="7585928504949899300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 已经改变了，你的 Hooks 也应该改变"/> <meta itemprop="keywords" content="前端,Vue.js,GitHub"/> <meta itemprop="datePublished" content="2025-12-22T06:16:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 已经改变了，你的 Hooks 也应该改变
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:16:15.000Z" title="Mon Dec 22 2025 06:16:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文： <a href="https://link.juejin.cn?target=https%3A%2F%2Fallthingssmitty.com%2F2025%2F12%2F01%2Freact-has-changed-your-hooks-should-too%2F" target="_blank" title="https://allthingssmitty.com/2025/12/01/react-has-changed-your-hooks-should-too/" ref="nofollow noopener noreferrer">React has changed, your Hooks should too</a></p>
<p>翻译： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.heyfe.org%2Fblog" target="_blank" title="https://blog.heyfe.org/blog" ref="nofollow noopener noreferrer">嘿嘿</a></p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>React Hooks 已经问世多年，但大多数代码库仍然以同样的方式使用它们：用点 <code>useState</code>，过度使用 <code>useEffect</code>，以及大量不经思考就复制粘贴的模式。我们都经历过。</p>
<p>但 Hooks 从来就不是生命周期方法的简单重写。它们是用于构建更具表现力、更模块化架构的设计系统。</p>
<p>随着并发式 React（React 18/19 时代）的到来，React 处理数据（尤其是<strong>异步数据</strong>）的方式已经改变。我们现在有了服务器组件、<code>use()</code>、服务器操作、基于框架的数据加载……甚至根据你的设置，在客户端组件中也具备了一些异步能力。</p>
<p>那么，让我们来看看现代 Hook 模式如今是什么样子，React 在引导开发者走向何方，以及生态系统不断陷入的陷阱。</p>
<h2 data-id="heading-0"><code>useEffect</code> 陷阱：做得太多、太频繁</h2>
<p><code>useEffect</code> 仍然是最常被滥用的 Hook。它常常成为堆放不应属于那里的逻辑的“垃圾场”，例如数据获取、衍生值，甚至简单的状态转换。这通常就是组件开始感觉“诡异”的时候：它们在不恰当的时间重新运行，或者运行得过于频繁。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 每次查询变化时都会重新运行，即使新值实际上相同</span>
  <span class="hljs-title function_">fetchData</span>();
}, [query]);

</code></pre>
<p>这种痛苦大部分源于将<strong>衍生状态</strong>和<strong>副作用</strong>混在一起，而 React 对这两者的处理方式截然不同。</p>
<h3 data-id="heading-1">以 React 预期的方式使用副作用</h3>
<p>React 在这里的规则出奇地简单：</p>
<blockquote>
<p>只在真正有必要时才使用副作用。</p>
</blockquote>
<p>其他一切都应该在渲染过程中衍生出来。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> filteredData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">includes</span>(query));
}, [data, query]);

</code></pre>
<p>当你确实需要一个副作用时，React 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseEffectEvent" target="_blank" title="https://react.dev/reference/react/useEffectEvent" ref="nofollow noopener noreferrer">useEffectEvent</a> 会是你的好帮手。它让你能在副作用内部访问最新的 props/状态，而<strong>不必</strong>扰乱你的依赖数组。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> handleSave = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">saveToServer</span>(formData);
});

</code></pre>
<p>在使用 <code>useEffect</code> 之前，先问问自己：</p>
<ul>
<li>这是由外部因素（网络、DOM、订阅）驱动的吗？</li>
<li>还是我可以在渲染过程中计算这个？</li>
</ul>
<p>如果是后者，像 <code>useMemo</code>、<code>useCallback</code> 或框架提供的基础构建块这样的工具，会让你的组件健壮得多。</p>
<blockquote>
<p>🙋🏻‍♂️ 小贴士</p>
<p>不要把 useEffectEvent 当作一种用来逃避编写依赖数组（dependency arrays）的‘作弊码’。它是专门针对 Effect 内部的操作逻辑进行优化的。”</p>
</blockquote>
<h2 data-id="heading-2">自定义 Hooks：不仅仅是复用，更是真正的封装</h2>
<p>自定义 Hooks 不仅仅是为了减少重复代码。它们关乎将领域逻辑从组件中抽离出来，让你的 UI 专注于……嗯，UI。</p>
<p>例如，与其用这样的设置代码来污染组件：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">listener</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
}, []);

</code></pre>
<p>不如将其移入一个 Hook：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useWindowWidth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(
    <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span> ? <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> : <span class="hljs-number">0</span>
  );

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">listener</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, listener);
    <span class="hljs-comment">// 注意：原文为 'change'，但通常 resize 事件应配对 'resize'，这里保持原文但应该是笔误</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'change'</span>, listener);
  }, []);

  <span class="hljs-keyword">return</span> width;
}

</code></pre>
<p>这样就干净多了。也更容易测试。你的组件不再泄露实现细节。</p>
<blockquote>
<p>SSR 小提示</p>
<p>总是从确定的回退值开始，以避免水合不匹配报错。</p>
</blockquote>
<h2 data-id="heading-3">基于订阅的状态与 <code>useSyncExternalStore</code></h2>
<p>React 18 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseSyncExternalStore" target="_blank" title="https://react.dev/reference/react/useSyncExternalStore" ref="nofollow noopener noreferrer">useSyncExternalStore</a>，它悄无声息地解决了一大类与订阅、撕裂效应和高频更新相关的 Bug。</p>
<p>如果你曾经与 <code>matchMedia</code>、滚动位置或跨渲染行为不一致的第三方存储库斗争过，这就是 React 希望你使用的 API。</p>
<p>它适用于：</p>
<ul>
<li>浏览器 API（<code>matchMedia</code>、页面可见性、滚动位置）</li>
<li>外部存储（Redux、Zustand、自定义订阅系统）</li>
<li>任何对性能敏感或事件驱动的事物</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useMediaQuery</span>(<span class="hljs-params">query</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useSyncExternalStore</span>(
    <span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> mql = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(query);
      mql.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, callback);
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> mql.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'change'</span>, callback);
    },
    <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(query).<span class="hljs-property">matches</span>,
    <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">false</span> <span class="hljs-comment">// SSR 回退值</span>
  );
}

</code></pre>
<h2 data-id="heading-4">使用过渡和延迟值实现更流畅的 UI</h2>
<p>如果你的应用在用户输入或筛选时感觉卡顿，React 的并发工具可以提供帮助。这些并非魔法，但它们能帮助 React 将紧急更新置于高开销更新之前。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-section">[searchTerm, setSearchTerm]</span> = useState('')<span class="hljs-comment">;</span>
const <span class="hljs-attr">deferredSearchTerm</span> = useDeferredValue(searchTerm)<span class="hljs-comment">;</span>

const <span class="hljs-attr">filtered</span> = useMemo(() =&gt; {
  return data.filter(<span class="hljs-attr">item</span> =&gt; item.includes(deferredSearchTerm))<span class="hljs-comment">;</span>
}, <span class="hljs-section">[data, deferredSearchTerm]</span>)<span class="hljs-comment">;</span>

</code></pre>
<p>输入保持响应，而繁重的筛选工作被延后处理。</p>
<p>快速心智模型：</p>
<ul>
<li><code>startTransition(() =&gt; setState())</code> → 延迟<strong>状态更新</strong></li>
<li><code>useDeferredValue(value)</code> → 延迟<strong>衍生值</strong></li>
</ul>
<p>需要时可以一起使用，但不要过度使用。它们不适用于琐碎的计算。</p>
<h2 data-id="heading-5">可测试和可调试的 Hooks</h2>
<p>现代 React DevTools 让检查自定义 Hooks 变得极其简单。如果你能良好地组织你的 Hooks，大部分逻辑无需渲染实际组件就能测试。</p>
<ul>
<li>将领域逻辑与 UI 分离</li>
<li>尽可能直接测试 Hooks</li>
<li>为了清晰，将提供者逻辑提取到其自身的 Hook 中</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuthProvider</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">credentials</span>) =&gt; { <span class="hljs-comment">/* ... */</span> };
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; { <span class="hljs-comment">/* ... */</span> };
  <span class="hljs-keyword">return</span> { user, login, logout };
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AuthProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useAuthProvider</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuthContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">AuthContext.Provider</span>&gt;</span></span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAuth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">AuthContext</span>);
}

</code></pre>
<p>下次调试时，你会感谢自己这么做。</p>
<h2 data-id="heading-6">超越 Hooks：迈向数据优先的 React 应用</h2>
<p>React 正朝着<strong>数据优先的渲染流程</strong>转变，特别是现在服务器组件和基于操作的模式正在成熟。它并非追求像 Solid.js 那样的细粒度响应式，但 React 正大力投入异步数据和服务器驱动的 UI。</p>
<p>值得了解的 API：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2Fuse" target="_blank" title="https://react.dev/reference/react/use" ref="nofollow noopener noreferrer">use()</a> 用于在渲染期间处理异步资源（主要用于服务器组件；通过服务器操作在客户端组件中支持有限）</li>
<li><code>useEffectEvent</code> 用于稳定的副作用回调</li>
<li><code>useActionState</code> 用于类似工作流的异步状态</li>
<li>框架级别的缓存和数据原语</li>
<li>更好的并发渲染工具和 DevTools</li>
</ul>
<p>方向很明确：React 希望我们减少对“瑞士军刀”式 <code>useEffect</code> 的依赖，更多地依赖简洁、由渲染驱动的数据流。</p>
<p>围绕衍生状态和服务器/客户端边界来设计你的 Hooks，能让你的应用天然地面向未来。</p>
<h2 data-id="heading-7">Hooks 即架构，而非语法</h2>
<p>Hooks 不仅仅是比类组件更友好的 API，它们是一种架构模式。</p>
<ul>
<li>将衍生状态放在渲染过程中</li>
<li>只将副作用用于真正的副作用</li>
<li>通过小而专注的 Hooks 组合逻辑</li>
<li>让并发工具平滑处理异步流程</li>
<li>同时考虑客户端<strong>和</strong>服务器边界</li>
</ul>
<p>React 在进化，我们的 Hooks 也应随之进化。</p>
<p>如果你仍然在用 2020 年的方式写 Hooks，那也没关系。我们大多数人都是如此。但 React 18+ 给了我们一个强大得多的工具箱，熟悉这些模式会很快带来回报。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[顶层元素问题：popover vs. dialog]]></title>    <link>https://juejin.cn/post/7586540799220121641</link>    <guid>https://juejin.cn/post/7586540799220121641</guid>    <pubDate>2025-12-22T06:21:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799220121641" data-draft-id="7585928504949932068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="顶层元素问题：popover vs. dialog"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-22T06:21:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            顶层元素问题：popover vs. dialog
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:21:16.000Z" title="Mon Dec 22 2025 06:21:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhtmhell.dev%2Fadventcalendar%2F2025%2F1%2F" target="_blank" title="https://htmhell.dev/adventcalendar/2025/1/" ref="nofollow noopener noreferrer">Top layer troubles: popover vs. dialog</a>
作者：Stephanie Eckles
日期：2025年12月1日
翻译：田八</p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>你是否曾尝试通过设置 <code>z-index: 9999</code> 解决元素层级问题？如果是，那你其实是在与一个基础的CSS概念 <em>——<strong>层叠上下文</strong>——</em> 斗争。</p>
<p>层叠上下文定义了元素在第三维度（即“z轴”）上的排列顺序。你可以把z轴想象成视口中层叠上下文根节点与用户（即通过浏览器视口观察的你）之间的DOM元素的层级。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47b5bf26c50d4decbeec1868dfd0ae48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766989319&amp;x-signature=EVpJrCkohIIsdw6SDRbHvC4BQIU%3D" alt="image.png" loading="lazy"/></p>
<p>一个元素只能在同一层叠上下文中重新调整层级。虽然 <code>z-index</code> 是实现这一点的工具，但失败往往源于层叠上下文的变化。这种变化可能通过多种方式发生，例如使用固定定位（fixed）、粘性定位（sticky）元素，或是将绝对定位（absolute）/相对定位（relative）与 <code>z-index</code> 结合使用等，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FCSS%2FCSS_positioned_layout%2FStacking_context" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_positioned_layout/Stacking_context" ref="nofollow noopener noreferrer">MDN 上列出了更多原因</a>。</p>
<p>现代网页设计有一个“<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FGlossary%2FTop_layer" target="_blank" title="https://developer.mozilla.org/en-US/docs/Glossary/Top_layer" ref="nofollow noopener noreferrer">顶层</a>”特性，它保证使其位于所有其他层叠上下文的最顶层。它覆盖整个视口，不过顶层中的元素实际可见尺寸可能更小。</p>
<p>将元素提升到顶层，可使其摆脱原本所在的任何层叠上下文。</p>
<p>虽然顶层直接解决了一个与CSS相关的问题，但目前还没有属性可用于将元素提升到顶层。取而代之的是，某些元素和特定条件可以访问顶层，例如通过 <code>&lt;div&gt;</code> 标签显示的原生对话框 <code>showModal()</code> 和被指定为 Popover 的元素。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FPopover_API%2FUsing" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Popover_API/Using" ref="nofollow noopener noreferrer">Popover API</a>是一项新推出的 HTML 功能，它允许你声明式的创建非模态覆盖元素。通过使用 Popover API 用来摆脱任何层叠上下文，这是它的一个理想特性。然而，在急于选择这种原生能力之前，需要注意一个潜在的问题。</p>
<h2 data-id="heading-0">场景设定</h2>
<p>想象一下，在2025年的网络世界：你的网页应用包含一个通过“Toast”消息显示通知的服务。你知道的，就是那些通常出现在角落或其他不太可能遮挡其他用户界面（UI）位置的弹出消息。</p>
<p>通常，这些Toast通知通常用于实时提醒，比如保存成功，或者表单提交失败等错误提示。它们有时有时间限制，或者包含如关闭按钮这样的关闭机制。有时它们还包含额外操作，例如“重试”选项，用于重新提交失败的工作流。</p>
<p>既然您的应用紧跟时代潮流，你最近决定将Toast升级为使用Popover API。这样你就可以将Toast组件放置在应用的任何结构中，而无需为了解决层叠上下文问题而采用一些变通方法。毕竟，Toast必须显示在所有其他元素之上，因此通过 Popover 实现顶层访问是明智之举！</p>
<p>你发布了改进版本，并为自己的工作感到自豪。</p>
<p>发布的当周晚些时候，你收到了一份紧急错误报告。不是普通的错误报告，而是一个可访问性违规报告。</p>
<h2 data-id="heading-1">Dialog vs. popover</h2>
<p>你的应用很新潮，你之前也升级使用了原生HTML对话框。那是一次很棒的升级，因为你用原生 Web 功能取代了对 JavaScript 的依赖。这也是你兴奋地将Toast也升级为使用Popover的另一个原因。</p>
<p>那么，错误是什么呢？一位键盘用户正在使用一个包含对话框的工作流程，对话框打开期间，后台进程触发了一个弹出式通知。该通知提示存在错误，需要用户进行交互。</p>
<p>当这位键盘用户试图将焦点切换到Toast上时，出现了错误。他们虽然在视觉上能看到Toast显示在对话框背景之上，但焦点无法成功进入Toast，而是意外地跳到了浏览器UI上。</p>
<p>你可以在这个CodePen示例中亲自体验这个错误，使用Tab键，你会发现你永远无法访问到Toast。你也可以尝试使用屏幕阅读器，会发现虚拟光标也无法进入Toast。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2F5t3ph%2Fpen%2FRNrJxyo%2Fba02f03947d400a202a02e01c643eaea" target="_blank" title="https://codepen.io/5t3ph/pen/RNrJxyo/ba02f03947d400a202a02e01c643eaea" ref="nofollow noopener noreferrer">CodePen</a></p>
<p>如果你能够点击弹出框，可能会觉得至少点击操作是可行的。但很快我们就会发现，事情并非如此。</p>
<h2 data-id="heading-2">为什么Toast弹出框无法访问</h2>
<p>虽然顶层可以超越标准的层叠上下文，但顶层中的元素仍然受分层顺序的影响。最近添加到顶层的元素会显示在之前添加的顶层元素之上。这就是为什么Toast在视觉上会显示在对话框背景之上。</p>
<p>如果弹出框在视觉上可用，那为什么通过键盘或屏幕阅读器的虚拟光标却无法访问呢？</p>
<p>原因在于弹出框与 <em>模态</em> 对话框之间存在竞争关系。当通过 <code>showModal()</code>方法启动原生HTML对话框时，对话框外部的页面会变为 <em>惰性状态</em>。<em>惰性状态</em> 是一种必要的可访问性行为，它会隔离对话框内容，并阻止通过Tab键和虚拟光标访问背景页面。</p>
<p>这个错误是由于Toast弹出框是背景页面DOM的一部分。这意味着由于它位于对话框DOM边界之外，所以也变成了惰性状态。</p>
<p>但是，由于顶层顺序的原因，因为它是在对话框打开后创建的，所以在视觉上，它被放置在对话框的顶部，这一点可能会让你感到困惑。</p>
<p>如果你以为点击弹出框就能关闭它，实际上并非如此，尽管弹出框确实会消失。真正发生的情况是，你触发了弹出框的 <em>轻触关闭</em> 行为。这意味着它关闭是因为你实际上点击了它的边界之外，因为对话框捕获了点击操作。</p>
<p>所以，虽然弹出框被关闭了，但“重试”按钮实际上并没有被点击，这意味着任何关联的事件监听器都不会被触发。</p>
<p>即使你创建了一个自动化测试来专门检查当对话框打开时Toast的提醒功能，该自动化测试仍可能出现误报，因为它触发了对Toast按钮的编程式点击。这种伪点击错误地绕过了由于对话框导致页面变为惰性状态所引发的问题。</p>
<h2 data-id="heading-3">重新获得弹出框访问权限</h2>
<p>解决方案有两个方面：</p>
<ol>
<li>将弹出框(popover)在DOM中实际放置在对话框(dialog)内部。</li>
<li>确保使用 <code>popover="manual"</code>，以防止对话框内的点击操作过早触发弹出框的轻触关闭。</li>
</ol>
<p>完成这两步后，弹出框现在既在视觉上可用，又可以通过任何方式完全交互。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2F5t3ph%2Fpen%2FqEbKpJd%2F57e8ec936911cf8549df0df72c650650" target="_blank" title="https://codepen.io/5t3ph/pen/qEbKpJd/57e8ec936911cf8549df0df72c650650" ref="nofollow noopener noreferrer">Codepan</a></p>
<h2 data-id="heading-4">经验教训与额外考虑</h2>
<p>我们了解到，如果你的网站或应用有可能同时显示弹出框和对话框，并且它们有独立的时间线，那么你需要想出一种在对话框内启动弹出框的机制。</p>
<p>或者，您可以选择在对话框关闭之前禁用后台页面弹出窗口。但如果通知需要及时交互，或者对话框内容有可能触发 Toast 提示，则此方法可能并不理想。</p>
<p>除了可见性和交互性之外，您可能还需要考虑另一个问题：弹出窗口是否需要在对话框关闭后继续保持打开状态。也就是说，即使对话框关闭，弹出窗口也需要保持打开状态，例如继续等待用户执行操作。</p>
<p>虽然我非常支持使用原生平台功能，而且我认为弹出框（popover）尤其出色，但有时冲突是无法完全避免的。事实上，您可能已经遇到过类似的问题，即模态对话框的惰性行为。因此，本文的主要目的是提醒您，如果同时显示背景弹出框和模态对话框，可能会出现问题，因此不要完全放弃之前自定义的弹出框架构。</p>
<p>如果这个问题目前或将来会影响到你的工作，请关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwhatwg%2Fhtml%2Fissues%2F9936" target="_blank" title="https://github.com/whatwg/html/issues/9936" ref="nofollow noopener noreferrer">这个HTML问题，其中正在讨论解决方案。</a></p>
<h2 data-id="heading-5">关于斯蒂芬妮·埃克尔斯</h2>
<p>Stephanie Eckles 是 Adobe Spectrum CSS 的高级设计工程师，也是 CSSWG 的成员，同时还是 ModernCSS.dev 的作者。Steph 拥有超过 15 年的 Web 开发经验，她乐于以作家、研讨会讲师和会议演讲者的身份分享这些经验。她致力于倡导无障碍设计、可扩展 CSS 和 Web 标准。业余时间，她是两个女儿的妈妈，喜欢烘焙和水彩画。</p>
<p>博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmoderncss.dev%2F" target="_blank" title="https://moderncss.dev/" ref="nofollow noopener noreferrer">ModernCSS.dev</a>
Mastodon：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffront-end.social%2F%405t3ph" target="_blank" title="https://front-end.social/@5t3ph" ref="nofollow noopener noreferrer">@5t3ph</a></p>
<blockquote>
<p>译者注：</p>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FReference%2FGlobal_attributes%2Fpopover" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Global_attributes/popover" ref="nofollow noopener noreferrer">popover</a>：弹出框指的是轻提示的弹出式框，没有过多的交互逻辑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTML%2FReference%2FElements%2Fdialog" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Elements/dialog" ref="nofollow noopener noreferrer">dialog</a>：对话框指的是带有交互逻辑的弹出框，例如存在确认和取消按钮，输入框等</li>
</ol>
<p>这两个都是新特性，具体内容可参考MDN</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Token：大语言模型的最小单位到底是什么？]]></title>    <link>https://juejin.cn/post/7586167377382359066</link>    <guid>https://juejin.cn/post/7586167377382359066</guid>    <pubDate>2025-12-22T06:24:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586167377382359066" data-draft-id="7586301866910466099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Token：大语言模型的最小单位到底是什么？"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-12-22T06:24:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Token：大语言模型的最小单位到底是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:24:07.000Z" title="Mon Dec 22 2025 06:24:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote>
<p>在自然语言处理（NLP）和大模型中，Token 是文本处理的基本单位，可以看作是文本的“原子”。简单来说，Token 是将一段原始文本分解后得到的最小有意义的单元。大模型（如 GPT、BERT 等）通过接收和处理这些 Token 序列来理解文本的含义、生成新的文本或完成其他任务。</p>
<h2 data-id="heading-0">1.  Token 的定义</h2>
<hr/>
<p>Token 是文本被分割后的基本组成部分。在自然语言处理中，为了让模型能够理解和处理人类语言，需要将一段连续的文本（如句子或段落）分解成更小的单元，这些单元就是 Token。举个例子：</p>
<p>对于句子 “Hello world”，可以分解为两个 Token：["Hello", "world"]。 不同的分解方式会产生不同类型的 Token，具体取决于模型的设计和任务需求。</p>
<h2 data-id="heading-1">2.  Token 的类型</h2>
<hr/>
<p>根据分割粒度的不同，Token 通常可以分为以下几种类型：</p>
<ul>
<li>单词级 Token 文本按单词进行分割，每个单词作为一个独立的 Token。 示例：“I love coding” → ["I", "love", "coding"] 优点：直观，适合理解完整的单词含义。 缺点：词汇量可能很大，无法处理未见过的新词。</li>
<li>子词级 Token 将单词进一步分解成更小的有意义的片段，通常用于解决单词级 Token 的局限性。 示例：“unhappiness” → ["un", "happi", "ness"] 优点：能处理新词或拼写变体，词汇量较小且灵活。 缺点：单个 Token 的含义可能不完整，需要上下文理解。 字符级 Token 文本按单个字符分割，每个字符作为一个 Token。 示例：“Hello” → ["H", "e", "l", "l", "o"] 优点：词汇量极小，能处理任何文本。 缺点：序列变长，模型需要更多计算资源来捕捉关系。 大模型通常会根据任务需求选择合适的 Token 类型。例如，BERT 使用子词级 Token（如 WordPiece），而一些轻量级模型可能使用字符级 Token。</li>
</ul>
<h2 data-id="heading-2">3.  Token 在大模型中的作用</h2>
<hr/>
<p>大模型（如基于 Transformer 架构的模型）以 Token 序列为核心进行工作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81ebc39fffed43208ddf0c840af41baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766989447&amp;x-signature=WUOvOfBaEPya9QhB18DHWKBuUQw%3D" alt="" loading="lazy"/></p>
<p>Token 在模型的输入、处理和输出阶段都扮演着关键角色：</p>
<ul>
<li>输入阶段：原始文本被分解为 Token 序列后，再把Token 映射为唯一的<code>Token ID</code>（通过词表），再通过模型的<strong>嵌入层（Embedding Layer）</strong>  将 Token ID 映射到一个高维向量（称为 embedding）。这些向量包含了 Token 的语义信息，是模型理解文本的基础。 示例：["Hello", "world"] → [vector1, vector2]</li>
<li>处理阶段：模型通过多层结构（如注意力机制和前馈网络）对 Token 的 embedding 进行变换，分析 Token 之间的关系和上下文信息。例如，它可以理解 “I love coding” 中 “love” 和 “coding” 的关联。</li>
<li>输出阶段：模型对处理后的 embedding 解码，输出下一个 Token 的概率分布向量，再通过词表将概率最高的向量对应的 Token ID 映射为具体 Token：文本生成时逐 Token 拼接成完整内容，分类任务则聚合结果输出对应标签，是模型将语义转化为结果的关键步骤。</li>
</ul>
<h2 data-id="heading-3">4.  Tokenization 过程</h2>
<hr/>
<p>将原始文本转换为 Token 序列的过程称为 Tokenization，通常包括以下步骤：</p>
<ul>
<li>规范化 对文本进行清洗和标准化，例如去除多余空格、统一大小写等。 示例：“Hello, World!” → “hello world”</li>
<li>分割 根据选定的 Token 类型，将文本分割成 Token。 示例：“hello world” → ["hello", "world"]（单词级）</li>
<li>编码 将 Token 转换为模型可以处理的数值表示，即向量化（embedding）。具体来说，模型将每个 Token 映射到一个高维稠密向量空间。这些向量能够捕捉到词的语义信息和上下文关系。在分词之后通常使用嵌入层（Embedding Layer）来实现这一点。嵌入层会将每个 token 映射到一个高维空间，例如 12288 维 （gpt3）。 假如输入的是“ I am a student ”这句话，那么 embeding 层会生成一个 4 x 12288 维的矩阵：  <strong>"I" → [x₁, x₂, …, x₁₂₂₈₈] "am" → [y₁, y₂, …, y₁₂₂₈₈] "a" → [z₁, z₂, …, z₁₂₂₈₈] "student" → [w₁, w₂, …, w₁₂₂₈₈]</strong>  作为 encoder 层的输入在 Transformer 架构中，这一步通常是通过一个嵌入层（Embedding Layer）来完成的。嵌入层负责将每个 Token 转换成对应的向量表示。</li>
</ul>
<p>经过这些步骤，文本就变成了模型能够理解和计算的格式。</p>
<p>不同的大模型可能会选择不同的 tokenization 策略，以适应其架构和应用需求。比如目前主流大模型所使用的 token 类型如下：</p>
<ul>
<li>ChatGPT（OpenAI） Token 类型：Byte Pair Encoding（BPE） 说明：ChatGPT 基于 GPT 系列模型，采用 BPE tokenization。BPE 通过合并高频出现的字符对来构建词汇表，能有效处理未见词（OOV），并在词汇量与计算效率之间取得平衡。</li>
<li>QWen（阿里巴巴） Token 类型：SentencePiece 说明：QWen 使用 SentencePiece，这是一种无监督的 tokenization 方法，支持 BPE 和 unigram language model 两种模式。它特别适合多语言环境，能够灵活适应不同语言的特性。</li>
<li>DeepSeek Token 类型：WordPiece 说明：DeepSeek 采用 WordPiece tokenization，这是 Google 开发的一种算法，最初用于 BERT 模型。通过最大化语言模型的似然选择子词单元，WordPiece 能有效捕捉词缀和词根等语言特征。</li>
<li>LLama（Meta） Token 类型：Byte Pair Encoding（BPE） 说明：LLama 使用 BPE tokenization，与 ChatGPT 类似。BPE 在处理大规模、多样化的文本数据时表现出色，确保模型的高效性和泛化能力。</li>
</ul>
<h2 data-id="heading-4">5.  Token 数量的影响</h2>
<hr/>
<p>Token 序列的长度对大模型的性能有重要影响：</p>
<ul>
<li>序列过长：包含更多信息，但计算复杂度增加，模型可能难以处理（尤其是 Transformer 模型，计算量与序列长度平方相关）。</li>
<li>序列过短：信息不足，可能影响模型对上下文的理解。 因此，大模型通常会设置一个最大 Token 长度（如 512 或 2048），并根据任务需求进行优化。</li>
</ul>
<h3 data-id="heading-5">总结</h3>
<hr/>
<p>Token 是大模型处理文本的核心概念，可以理解为文本的最小构建块。它通过将复杂文本分解为单词、子词或字符等单元，让模型能够一步步分析和生成语言。Token 的类型和数量直接影响模型的性能和效果，而 Tokenization 则是连接原始文本与模型计算的关键步骤。希望这个解释能让你对 Token 有更清晰的认识！</p>
<h3 data-id="heading-6">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FEnjoyEDU%2FLLM" target="_blank" title="https://gitcode.com/EnjoyEDU/LLM" ref="nofollow noopener noreferrer">这里</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 的新时代已经到来：你需要知道的一切]]></title>    <link>https://juejin.cn/post/7586540799220088873</link>    <guid>https://juejin.cn/post/7586540799220088873</guid>    <pubDate>2025-12-22T06:20:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799220088873" data-draft-id="7586178555776876550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 的新时代已经到来：你需要知道的一切"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T06:20:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 的新时代已经到来：你需要知道的一切
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:20:02.000Z" title="Mon Dec 22 2025 06:20:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fthe-next-era-of-react%2F" target="_blank" title="https://blog.logrocket.com/the-next-era-of-react/" ref="nofollow noopener noreferrer">The next era of React has arrived: Here's what you need to know</a></p>
<p>翻译： <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.heyfe.org%2Fblog" target="_blank" title="https://blog.heyfe.org/blog" ref="nofollow noopener noreferrer">嘿嘿</a></p>
<p>来源：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" title="https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank">前端周刊</a></p>
</blockquote>
<p>构建异步 UI 向来都是一件非常困难的事情。导航操作将内容隐藏在加载指示器之后，搜索框在响应无序到达时会产生竞态条件，表单提交则需要手动管理每一个加载状态标志和错误信息。每个异步操作都迫使你手动进行协调。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adf9437aff2848d18d07b0c6ea80ce4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766989201&amp;x-signature=KY1YR1SxekvHyE3kBYSrovw0w8o%3D" alt="image.png" loading="lazy"/></p>
<p>这不是一个性能问题，而是一个协调问题。现在，React 的原语声明式地解决了它。</p>
<p>对于开发团队而言，这标志着我们构建方式的一次根本性转变。React 不再需要每位开发者在每个组件中重新发明异步处理逻辑，而是提供了标准化的原语来自动处理协调。这意味着更少的 Bug、更一致的用户体验，以及更少的调试竞态条件的时间。</p>
<h2 data-id="heading-0">React 的异步协调原语</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61ab8486cd4d4d49b0ae09537f3f3bf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766989201&amp;x-signature=miNM4rDSLulnLH6UgCfwGH7dTKU%3D" alt="image.png" loading="lazy"/></p>
<p>在 React Conf 2025 上，来自 React 团队的 Ricky Hanlon 演示的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fasync-react.dev%2F" target="_blank" title="https://async-react.dev/" ref="nofollow noopener noreferrer">Async React 示例</a>，展示了未来的可能性：一个包含搜索、标签页和状态变更的课程浏览应用，在快速网络下感觉即时，在慢速网络下也能保持流畅。UI 更新自动协调，不会闪烁。</p>
<p>这不是一个新库，而是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-19-2-is-here%2F" target="_blank" title="https://blog.logrocket.com/react-19-2-is-here/" ref="nofollow noopener noreferrer">React 19</a> 的协调 API 与 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Fblog%2F2022%2F03%2F29%2Freact-v18%23what-is-concurrent-react" target="_blank" title="https://react.dev/blog/2022/03/29/react-v18#what-is-concurrent-react" ref="nofollow noopener noreferrer">React 18 的并发特性</a> 的结合。它们共同构成了 React 团队称之为  <strong>“异步 React（Async React）”</strong>  的完整系统，通过可组合的原语来构建响应式的异步应用程序：</p>
<ul>
<li><strong><code>useTransition</code></strong>：跟踪待处理的异步工作。</li>
<li><strong><code>useOptimistic</code></strong>：在状态变更期间提供即时反馈（乐观更新）。</li>
<li><strong><code>Suspense</code></strong>：声明式地处理加载边界。</li>
<li><strong><code>useDeferredValue</code></strong>：在快速更新期间保持稳定的用户体验。</li>
<li><strong><code>use()</code></strong> ：使数据获取（和上下文读取）变得声明式。</li>
</ul>
<p>理解这些部分如何协同工作是关键，它使我们能从命令式的异步代码转向声明式的协调。</p>
<h2 data-id="heading-1">问题：手动的异步协调</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E9%2597%25AE%25E9%25A2%2598%25E6%2589%258B%25E5%258A%25A8%25E7%259A%2584%25E5%25BC%2582%25E6%25AD%25A5%25E5%258D%258F%25E8%25B0%2583" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E9%97%AE%E9%A2%98%E6%89%8B%E5%8A%A8%E7%9A%84%E5%BC%82%E6%AD%A5%E5%8D%8F%E8%B0%83" ref="nofollow noopener noreferrer"/></p>
<p>在这些原语出现之前，开发者必须手动编排每一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-19-2-the-async-shift%2F" target="_blank" title="https://blog.logrocket.com/react-19-2-the-async-shift/" ref="nofollow noopener noreferrer">异步操作</a>。表单提交需要显式的加载和错误状态：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SubmitButton</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>();
            <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-title function_">setError</span>(e.<span class="hljs-property">message</span>);
            <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>);
        }
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isLoading}</span>&gt;</span>
                {isLoading ? '提交中...' : '提交'}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>错误：{error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>数据获取也遵循类似的命令式模式，使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2F15-common-useeffect-mistakes-react%2F" target="_blank" title="https://blog.logrocket.com/15-common-useeffect-mistakes-react/" ref="nofollow noopener noreferrer"><code>useEffect</code></a>：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">UserProfile</span>({ userId }) {
    const <span class="hljs-selector-attr">[user, setUser]</span> = <span class="hljs-built_in">useState</span>(null);
    const <span class="hljs-selector-attr">[isLoading, setIsLoading]</span> = <span class="hljs-built_in">useState</span>(true);
    const <span class="hljs-selector-attr">[error, setError]</span> = <span class="hljs-built_in">useState</span>(null);

    <span class="hljs-built_in">useEffect</span>(() =&gt; {
        <span class="hljs-built_in">setIsLoading</span>(true);
        <span class="hljs-built_in">setError</span>(null);
        <span class="hljs-built_in">fetchUser</span>(userId)
            <span class="hljs-selector-class">.then</span>(data =&gt; {
                setUser(data);
                <span class="hljs-built_in">setIsLoading</span>(false);
            })
            <span class="hljs-selector-class">.catch</span>(e =&gt; {
                setError(e.message);
                <span class="hljs-built_in">setIsLoading</span>(false);
            });
    }, <span class="hljs-selector-attr">[userId]</span>);

    if (isLoading) return &lt;<span class="hljs-selector-tag">div</span>&gt;加载中...&lt;/<span class="hljs-selector-tag">div</span>&gt;;
    if (error) return &lt;<span class="hljs-selector-tag">div</span>&gt;错误：{error}&lt;/<span class="hljs-selector-tag">div</span>&gt;;

    return &lt;<span class="hljs-selector-tag">div</span>&gt;{user<span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p>每个异步操作都重复这个模式：跟踪加载状态、处理错误、协调状态更新。当这种模式扩展到几十个组件时，就会导致不一致的加载状态、被遗忘的错误处理，以及难以调试的微妙竞态条件。</p>
<h2 data-id="heading-2">原语详解</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%258E%259F%25E8%25AF%25AD%25E8%25AF%25A6%25E8%25A7%25A3" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%8E%9F%E8%AF%AD%E8%AF%A6%E8%A7%A3" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-3"><strong>Actions 自动跟踪异步工作</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23actions-%25E8%2587%25AA%25E5%258A%25A8%25E8%25B7%259F%25E8%25B8%25AA%25E5%25BC%2582%25E6%25AD%25A5%25E5%25B7%25A5%25E4%25BD%259C" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#actions-%E8%87%AA%E5%8A%A8%E8%B7%9F%E8%B8%AA%E5%BC%82%E6%AD%A5%E5%B7%A5%E4%BD%9C" ref="nofollow noopener noreferrer"/></p>
<p>React 19 引入了 Actions 来声明式地处理异步协调。将一个异步函数包装在 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseTransition" target="_blank" title="https://react.dev/reference/react/useTransition" ref="nofollow noopener noreferrer"><code>startTransition</code></a> 中，可以让 React 跟踪整个操作：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[isPending, startTransition]</span> = <span class="hljs-built_in">useTransition</span>();

function <span class="hljs-built_in">submitAction</span>() {
    <span class="hljs-built_in">startTransition</span>(async () =&gt; {
        await <span class="hljs-built_in">submitToServer</span>();
    });
}
</code></pre>
<p><code>isPending</code> 标志在 Promise 解决之前一直为 <code>true</code>。React 会自动处理此状态，并且在 Transition 中抛出的错误会冒泡到错误边界（Error Boundary），而不是在分散的 <code>try/catch</code> 块中处理（你仍需自己处理预期的错误，如验证失败）。</p>
<p>React 将在 Transition 中调用的任何函数被称为 “Action”。命名约定很重要：为函数添加 “Action” 后缀表示它们运行在 Transition 中（例如，<code>submitAction</code>、<code>deleteAction</code>）。</p>
<p>以下是使用 Actions 重写的相同按钮：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SubmitButton</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitAction</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>();
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{submitAction}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
            {isPending ? '提交中...' : '提交'}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    );
}
</code></pre>
<p>另一种选择是使用 React 19 的 <code>&lt;form&gt;</code> 组件，它可以通过接受一个 <code>action</code> 属性并将其自动包装在 Transition 中来为你处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitAction</span>(<span class="hljs-params">formData</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitToServer</span>(formData);
}

&lt;form action={submitAction}&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">'username'</span> /&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/form&gt;;
</code></pre>
<p>与手动 Action 一样，错误仍会冒泡到错误边界。当你希望在 UI 中反映表单状态时，React 19 提供了表单实用程序：<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact-dom%2Fhooks%2FuseFormStatus" target="_blank" title="https://react.dev/reference/react-dom/hooks/useFormStatus" ref="nofollow noopener noreferrer"><code>useFormStatus</code></a> 让子组件可以访问表单的待处理状态，而 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseActionState" target="_blank" title="https://react.dev/reference/react/useActionState" ref="nofollow noopener noreferrer"><code>useActionState</code></a> 则允许你根据 Action 的结果更新组件状态（例如显示验证错误或“点赞”计数）。</p>
<p>相同的模式也适用于按钮、输入框和标签页等可复用组件。你的设计组件可以暴露 <code>action</code>、<code>submitAction</code> 或 <code>changeAction</code> 等 Action 属性，并在内部使用 Transitions 来管理待处理状态和其他异步行为。我们稍后将回到这个模式。</p>
<h3 data-id="heading-4"><strong>乐观更新提供即时反馈</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25B9%2590%25E8%25A7%2582%25E6%259B%25B4%25E6%2596%25B0%25E6%258F%2590%25E4%25BE%259B%25E5%258D%25B3%25E6%2597%25B6%25E5%258F%258D%25E9%25A6%2588" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%B9%90%E8%A7%82%E6%9B%B4%E6%96%B0%E6%8F%90%E4%BE%9B%E5%8D%B3%E6%97%B6%E5%8F%8D%E9%A6%88" ref="nofollow noopener noreferrer"/></p>
<p>Actions 提供了待处理状态，但“待处理”并不总是正确的反馈。当你点击复选框来标记任务完成时，它应该立即切换。等待服务器的响应很可能会破坏流程导致竟态问题。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseOptimistic" target="_blank" title="https://react.dev/reference/react/useOptimistic" ref="nofollow noopener noreferrer"><code>useOptimistic()</code></a> 在 Transitions 内部工作，用于在异步 Action 在后台运行时显示即时更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">CompleteButton</span>(<span class="hljs-params">{ complete }</span>) {
    <span class="hljs-keyword">const</span> [optimisticComplete, setOptimisticComplete] = <span class="hljs-title function_">useOptimistic</span>(complete);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params"/>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-title function_">setOptimisticComplete</span>(!optimisticComplete);
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateCompletion</span>(!optimisticComplete);
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{completeAction}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{isPending</span> ? '<span class="hljs-attr">opacity-50</span>' <span class="hljs-attr">:</span> ''}&gt;</span>
            {optimisticComplete ? <span class="hljs-tag">&lt;<span class="hljs-name">CheckIcon</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
    );
}
</code></pre>
<p>复选框会立即切换。如果请求成功，服务器状态将与乐观更新匹配。如果失败，服务器状态保持旧值，因此复选框会自动恢复其原始状态。</p>
<p>与 <code>useState</code>（它会延迟 Transition 内部的更新）不同，<code>useOptimistic</code> 会立即更新。Transition 边界定义了乐观状态的生命周期：它仅在异步 Action 处于待处理状态时持续存在，一旦 Transition 完成，就会自动“落定”到事实来源（props 或服务器状态）。（注：简单说就是当 transition 为 pending 时 optimisticComplete 为 startTransition 中设定的值，而一旦 transition 完成即 pending 为 false 时，optimisticComplete 会放弃 startTransition 的状态而使用传入的值及为例子中的 complete）</p>
<h3 data-id="heading-5"><strong>Suspense 声明式地协调加载状态</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23suspense-%25E5%25A3%25B0%25E6%2598%258E%25E5%25BC%258F%25E5%259C%25B0%25E5%258D%258F%25E8%25B0%2583%25E5%258A%25A0%25E8%25BD%25BD%25E7%258A%25B6%25E6%2580%2581" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#suspense-%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%9C%B0%E5%8D%8F%E8%B0%83%E5%8A%A0%E8%BD%BD%E7%8A%B6%E6%80%81" ref="nofollow noopener noreferrer"/></p>
<p>乐观更新处理了状态变更，但初始数据加载呢？<code>useEffect</code> 模式迫使我们手动管理 <code>isLoading</code> 状态。<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FSuspense" target="_blank" title="https://react.dev/reference/react/Suspense" ref="nofollow noopener noreferrer"><code>Suspense</code></a> 通过允许我们声明式地定义加载边界来解决这个问题。我们需要控制显示什么后备 UI 以及如何分割加载，因此应用的独立部分可以并行加载。</p>
<p>Suspense 与“支持 Suspense”的数据源协同工作：异步服务器组件、使用 <code>use()</code> API 读取的 Promise（我们接下来会介绍），以及像 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fusing-tanstack-query-next-js%2F" target="_blank" title="https://blog.logrocket.com/using-tanstack-query-next-js/" ref="nofollow noopener noreferrer">TanStack Query</a> 这样的库（它提供了用于缓存和去重的 <code>useSuspenseQuery</code>）。</p>
<p>以下是 Suspense 如何协调多个独立数据流：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>仪表板<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ProfileSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">PostsSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserPosts</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>每个组件都可以通过自己的后备方案独立挂起。父组件通过 Suspense 边界处理加载状态，而不是协调多个 <code>useEffect</code> 调用。但有个问题：当你触发导致组件重新获取数据的更新时（如切换标签页或导航），加载后备方案会再次显示，隐藏你已经看到的内容，并产生突兀的加载状态。</p>
<h3 data-id="heading-6"><strong>结合 Transition 与 Suspense</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%2593%25E5%2590%2588-transition-%25E4%25B8%258E-suspense" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%93%E5%90%88-transition-%E4%B8%8E-suspense" ref="nofollow noopener noreferrer"/></p>
<p>将 Transition 与 Suspense 结合可以解决这个问题，它告诉 React 保持现有内容可见，而不是立即再次显示后备方案。以下是一个针对标签页切换的适配示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [tab, setTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'profile'</span>);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTabChange</span>(<span class="hljs-params">newTab</span>) {
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setTab</span>(newTab));
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleTabChange('profile')}&gt;个人资料<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleTabChange('posts')}&gt;帖子<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">LoadingSkeleton</span> /&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isPending</span> ? <span class="hljs-attr">0.7</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>{tab === 'profile' ? <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">UserPosts</span> /&gt;</span>}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>现在，加载后备方案仅在初始加载时显示。当你切换标签页时，Transition 会在新数据在后台加载时保持当前内容可见。不透明度样式使其变暗，以表示更新正在进行。一旦就绪，React 会自动无缝地换入新内容。没有突兀的加载状态，没有卡顿。</p>
<p>关键在于：Transitions 会“暂缓”UI 更新，直到异步工作完成，从而防止 Suspense 边界在导航期间回退到后备状态。像 Next.js 这样的框架使用此功能在新路由加载时保持页面可见。</p>
<h3 data-id="heading-7"><strong><code>use()</code> 直接读取异步数据</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23use-%25E7%259B%25B4%25E6%258E%25A5%25E8%25AF%25BB%25E5%258F%2596%25E5%25BC%2582%25E6%25AD%25A5%25E6%2595%25B0%25E6%258D%25AE" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#use-%E7%9B%B4%E6%8E%A5%E8%AF%BB%E5%8F%96%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE" ref="nofollow noopener noreferrer"/></p>
<p>早些时候，我们看到了 Suspense 如何与“支持 Suspense”的数据源协同工作。<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2Fuse" target="_blank" title="https://react.dev/reference/react/use" ref="nofollow noopener noreferrer"><code>use()</code> API</a> 就是这样的数据源之一：它为数据获取提供了 <code>useEffect</code> 的替代方案，允许你在渲染期间读取 Promise。</p>
<p>以下是用 Suspense 和 <code>use()</code> 重写的最初的 <code>useEffect</code> 示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>(userId));
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params">{ userId }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载用户时出错<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> <span class="hljs-attr">userId</span>=<span class="hljs-string">{userId}</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span>
    );
}
</code></pre>
<p>组件在读取 Promise 时挂起，触发最近的 Suspense 边界，然后在 Promise 解决时带着数据重新渲染。错误被错误边界捕获。与 Hooks 不同，<code>use()</code> 可以条件调用。</p>
<p>一个注意事项：<strong>Promise 需要被缓存</strong>。否则，每次渲染都会重新创建它。在实践中，你可以使用像 Next.js 这样处理缓存和去重的框架。</p>
<h3 data-id="heading-8"><strong>延迟值防止 UI 过载</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%25BB%25B6%25E8%25BF%259F%25E5%2580%25BC%25E9%2598%25B2%25E6%25AD%25A2-ui-%25E8%25BF%2587%25E8%25BD%25BD" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%BB%B6%E8%BF%9F%E5%80%BC%E9%98%B2%E6%AD%A2-ui-%E8%BF%87%E8%BD%BD" ref="nofollow noopener noreferrer"/></p>
<p>Actions 和 Suspense 处理离散的操作：点击、提交、导航。但快速输入（如搜索）需要不同的方法，因为你希望输入框即使在结果加载时也能保持响应。</p>
<p>一种方法可以是设计一个 <code>SearchInput</code> 组件，通过内部乐观状态保持输入响应，并在 Transition 中调用 <code>changeAction</code>，这样父组件只需传递 <code>value</code> 和 <code>changeAction</code>。</p>
<p>当你没有设计组件时，<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FuseDeferredValue" target="_blank" title="https://react.dev/reference/react/useDeferredValue" ref="nofollow noopener noreferrer"><code>useDeferredValue()</code></a> 提供了类似的拆分效果。虽然你可以用它来延迟昂贵的 CPU 计算（性能），但此处的目标是稳定的用户体验。</p>
<p>结合 Suspense、<code>use()</code> 和<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fsignals-fix-error-boundaries%2F" target="_blank" title="https://blog.logrocket.com/signals-fix-error-boundaries/" ref="nofollow noopener noreferrer">ErrorBoundary</a>，我们可以获得完整的搜索体验：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
    <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);
    <span class="hljs-keyword">const</span> isStale = query !== deferredQuery;

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>加载结果时出错<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>搜索中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isStale</span> ? <span class="hljs-attr">0.5</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">SearchResults</span> <span class="hljs-attr">query</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchResults</span>(<span class="hljs-params">{ query }</span>) {
    <span class="hljs-keyword">if</span> (!query) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>开始输入以搜索<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchSearchResults</span>(query));
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {results.map(r =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{r.id}</span>&gt;</span>{r.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>Suspense 后备方案仅在初始加载时显示。在后续搜索期间，<code>useDeferredValue</code> 会在新结果于后台加载时保持旧结果可见（通过 <code>isStale</code> 降低不透明度）。错误边界隔离了失败，即使数据请求失败，搜索输入也能保持功能正常。</p>
<h2 data-id="heading-9">综合应用：Async React 示例</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%25BC%25E5%2590%2588%25E5%25BA%2594%25E7%2594%25A8async-react-%25E7%25A4%25BA%25E4%25BE%258B" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%BC%E5%90%88%E5%BA%94%E7%94%A8async-react-%E7%A4%BA%E4%BE%8B" ref="nofollow noopener noreferrer"/></p>
<p>到目前为止，我们分别了解了每个原语。<a href="https://link.juejin.cn?target=https%3A%2F%2Fasync-react.dev%2F" target="_blank" title="https://async-react.dev/" ref="nofollow noopener noreferrer">Async React 示例</a> 展示了当一个框架将它们整合到路由、数据获取和设计系统中时会发生什么：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Fassets%2Fup_Async-React-2025-12-03-00_06_43.gif" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/assets/up_Async-React-2025-12-03-00_06_43.gif" ref="nofollow noopener noreferrer"><img src="" alt="gif of async react demo" loading="lazy"/></a></p>
<p>尝试切换网络速度以查看 UI 如何适应：在快速连接下即时，在慢速连接下流畅。</p>
<h3 data-id="heading-10"><strong>路由器将导航包装在 Transitions 中：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E8%25B7%25AF%25E7%2594%25B1%25E5%2599%25A8%25E5%25B0%2586%25E5%25AF%25BC%25E8%2588%25AA%25E5%258C%2585%25E8%25A3%2585%25E5%259C%25A8-transitions-%25E4%25B8%25AD" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E8%B7%AF%E7%94%B1%E5%99%A8%E5%B0%86%E5%AF%BC%E8%88%AA%E5%8C%85%E8%A3%85%E5%9C%A8-transitions-%E4%B8%AD" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAction</span>(<span class="hljs-params">value</span>) {
    router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'q'</span>, value);
}
</code></pre>
<p>更新搜索参数是异步的，会更改 URL 并触发数据重新获取，同时 Transition 会跟踪这一切。</p>
<h3 data-id="heading-11"><strong>数据层将</strong> <code>use()</code> <strong>与缓存的 Promise 结合使用：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E6%2595%25B0%25E6%258D%25AE%25E5%25B1%2582%25E5%25B0%2586-use-%25E4%25B8%258E%25E7%25BC%2593%25E5%25AD%2598%25E7%259A%2584-promise-%25E7%25BB%2593%25E5%2590%2588%25E4%25BD%25BF%25E7%2594%25A8" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E6%95%B0%E6%8D%AE%E5%B1%82%E5%B0%86-use-%E4%B8%8E%E7%BC%93%E5%AD%98%E7%9A%84-promise-%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LessonList</span>(<span class="hljs-params">{ tab, search, completeAction }</span>) {
    <span class="hljs-keyword">const</span> lessons = <span class="hljs-title function_">use</span>(data.<span class="hljs-title function_">getLessons</span>(tab, search));
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Design.List</span>&gt;</span>
            {lessons.map(item =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Lesson</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Design.List</span>&gt;</span></span>
    );
}
</code></pre>
<p>当数据加载时，组件会挂起，Suspense 在初始加载时显示后备方案，但在切换标签页和搜索期间，Transitions 会保持旧内容可见。</p>
<h3 data-id="heading-12"><strong>Design 组件暴露 Action 属性：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23design-%25E7%25BB%2584%25E4%25BB%25B6%25E6%259A%25B4%25E9%259C%25B2-action-%25E5%25B1%259E%25E6%2580%25A7" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#design-%E7%BB%84%E4%BB%B6%E6%9A%B4%E9%9C%B2-action-%E5%B1%9E%E6%80%A7" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Design.SearchInput</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{searchAction}</span> /&gt;</span>
</code></pre>
<p><code>SearchInput</code> 在内部使用 <code>useOptimistic</code>，以便在新的 URL 的 Transition 处于待处理状态时立即更新输入值。<code>TabList</code> 同样乐观地更新选中的标签页。</p>
<p>命名约定（“changeAction”）表示传递的函数将在 Transition 中运行。</p>
<h3 data-id="heading-13"><strong>状态变更以相同方式工作：</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%258A%25B6%25E6%2580%2581%25E5%258F%2598%25E6%259B%25B4%25E4%25BB%25A5%25E7%259B%25B8%25E5%2590%258C%25E6%2596%25B9%25E5%25BC%258F%25E5%25B7%25A5%25E4%25BD%259C" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%8A%B6%E6%80%81%E5%8F%98%E6%9B%B4%E4%BB%A5%E7%9B%B8%E5%90%8C%E6%96%B9%E5%BC%8F%E5%B7%A5%E4%BD%9C" ref="nofollow noopener noreferrer"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">mutateToggle</span>(id);
    router.<span class="hljs-title function_">refresh</span>();
}
</code></pre>
<p>这个 <code>completeAction</code> 通过 <code>LessonList</code> 传递给 <code>Design.CompleteButton</code>，该按钮也暴露了一个 <code>action</code> 属性。该按钮在 Action 运行时乐观地更新完成状态。</p>
<hr/>
<p>这是一个简化版的课程应用示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
    <span class="hljs-keyword">const</span> search = router.<span class="hljs-property">search</span>.<span class="hljs-property">q</span> || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> tab = router.<span class="hljs-property">search</span>.<span class="hljs-property">tab</span> || <span class="hljs-string">'all'</span>;

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">searchAction</span>(<span class="hljs-params">value</span>) {
        router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'q'</span>, value);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">tabAction</span>(<span class="hljs-params">value</span>) {
        router.<span class="hljs-title function_">setParams</span>(<span class="hljs-string">'tab'</span>, value);
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">completeAction</span>(<span class="hljs-params">id</span>) {
        <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">mutateToggle</span>(id);
        router.<span class="hljs-title function_">refresh</span>();
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Design.SearchInput</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{searchAction}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Design.TabList</span> <span class="hljs-attr">activeTab</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">changeAction</span>=<span class="hljs-string">{tabAction}</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Design.FallbackList</span> /&gt;</span>}&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">LessonList</span> <span class="hljs-attr">tab</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">search</span>=<span class="hljs-string">{search}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Design.TabList</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    );
}
</code></pre>
<p>协调发生在每个层面：</p>
<ul>
<li><strong>路由</strong>：导航被包装在 Transitions 中。</li>
<li><strong>数据获取</strong>：数据层使用 Suspense 和缓存的 Promise。</li>
<li><strong>设计组件</strong>：组件暴露“Action”属性以在内部处理乐观更新。</li>
</ul>
<p>在快速网络上，更新是即时的。在慢速网络上，乐观 UI 和 Transitions 在没有手动逻辑的情况下保持响应性。原语的复杂性由路由器、数据获取设置和设计系统处理。应用代码只需将它们连接起来。</p>
<hr/>
<h2 data-id="heading-14">构建自定义异步组件</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E6%259E%2584%25E5%25BB%25BA%25E8%2587%25AA%25E5%25AE%259A%25E4%25B9%2589%25E5%25BC%2582%25E6%25AD%25A5%25E7%25BB%2584%25E4%25BB%25B6" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E6%9E%84%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6" ref="nofollow noopener noreferrer"/></p>
<p>大多数应用可能会使用已经实现了这些模式的库中的组件。但你也可以自己实现它们来构建自定义异步组件。</p>
<p>这是一个针对 Next.js 的实用示例：一个与 URL 参数同步的可复用选择组件。</p>
<p>这对于过滤器、排序或任何你希望持久化在 URL 中的 UI 状态很有用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRouter, useSearchParams } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/navigation'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RouterSelect</span>(<span class="hljs-params">{ name, value, options, selectAction }</span>) {
    <span class="hljs-keyword">const</span> [optimisticValue, setOptimisticValue] = <span class="hljs-title function_">useOptimistic</span>(value);
    <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
    <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
    <span class="hljs-keyword">const</span> searchParams = <span class="hljs-title function_">useSearchParams</span>();

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">changeAction</span>(<span class="hljs-params">e</span>) {
        <span class="hljs-keyword">const</span> newValue = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
        <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
            <span class="hljs-title function_">setOptimisticValue</span>(newValue);
            <span class="hljs-keyword">await</span> selectAction?.(newValue);

            <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(searchParams);
            params.<span class="hljs-title function_">set</span>(name, newValue);
            router.<span class="hljs-title function_">push</span>(<span class="hljs-string">`?<span class="hljs-subst">${params.toString()}</span>`</span>);
        });
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{name}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{optimisticValue}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{changeAction}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isPending</span> ? <span class="hljs-attr">0.7</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
            {options.map(opt =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{opt.value}</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{opt.value}</span>&gt;</span>
                    {opt.label}
                <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span>
    );
}
</code></pre>
<p>该组件在内部处理协调。父组件可以通过 <code>selectAction</code> 注入副作用：</p>
<pre><code class="hljs language-ini" lang="ini">function Filters() {
    const <span class="hljs-section">[progress, setProgress]</span> = useState(0)<span class="hljs-comment">;</span>
    const <span class="hljs-section">[optimisticProgress, incrementProgress]</span> = useOptimistic(progress, (prev, increment) =&gt; prev + increment)<span class="hljs-comment">;</span>

    return (
        &lt;&gt;
            &lt;LoadingBar <span class="hljs-attr">progress</span>={optimisticProgress} /&gt;
            &lt;RouterSelect
                <span class="hljs-attr">name</span>=<span class="hljs-string">'category'</span>
                <span class="hljs-attr">selected</span>={selectedCategory}
                <span class="hljs-attr">options</span>={categoryOptions}
                <span class="hljs-attr">selectAction</span>={items =&gt; {
                    incrementProgress(30)<span class="hljs-comment">;</span>
                    setProgress(100)<span class="hljs-comment">;</span>
                }}
            /&gt;
        &lt;/&gt;
    )<span class="hljs-comment">;</span>
}
</code></pre>
<p>在这个例子中，进度条的乐观更新和路由器导航被协调在一起。传递给 <code>selectAction</code> 的任何内容都受益于相同的异步协调。命名约定（“Action”）表示它在 Transition 中运行，并且我们可以在内部调用乐观更新。</p>
<p>这就是 Async React 示例中设计组件使用的模式。<code>SearchInput</code>、<code>TabList</code> 和 <code>CompleteButton</code> 都暴露了 Action 属性，在内部处理 Transitions、乐观更新和待处理状态。</p>
<h2 data-id="heading-15">使用 <code>ViewTransition</code>（Canary）实现平滑动画</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25BD%25BF%25E7%2594%25A8-viewtransitioncanary%25E5%25AE%259E%25E7%258E%25B0%25E5%25B9%25B3%25E6%25BB%2591%25E5%258A%25A8%25E7%2594%25BB" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%BD%BF%E7%94%A8-viewtransitioncanary%E5%AE%9E%E7%8E%B0%E5%B9%B3%E6%BB%91%E5%8A%A8%E7%94%BB" ref="nofollow noopener noreferrer"/></p>
<p>原语解决了更新 <em>何时</em> 发生的问题，而 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FViewTransition" target="_blank" title="https://react.dev/reference/react/ViewTransition" ref="nofollow noopener noreferrer"><code>ViewTransition</code></a> 则解决了它们 <em>看起来如何</em> 的问题。它包装了浏览器的 View Transition API，并专门在 React Transition（由 <code>useTransition</code>、<code>useDeferredValue</code> 或 Suspense 触发）内部更新组件时激活。</p>
<p>默认情况下，它在状态之间进行交叉淡入淡出，你也可以使用 CSS 自定义动画。</p>
<p>以下是 Async React 示例如何使用它为课程列表添加动画：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ViewTransition</span> <span class="hljs-attr">key</span>=<span class="hljs-string">'results'</span> <span class="hljs-attr">default</span>=<span class="hljs-string">'none'</span> <span class="hljs-attr">enter</span>=<span class="hljs-string">'auto'</span> <span class="hljs-attr">exit</span>=<span class="hljs-string">'auto'</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Design.List</span>&gt;</span>
            {lessons.map(item =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">ViewTransition</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Lesson</span> <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span> <span class="hljs-attr">completeAction</span>=<span class="hljs-string">{completeAction}</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">ViewTransition</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Design.List</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ViewTransition</span>&gt;</span></span>
);
</code></pre>
<p>外层的 <code>ViewTransition</code> 在 Suspense 解析或在状态之间切换时（如显示“无结果”）为整个列表添加动画。每个项目上的内层 <code>ViewTransition</code> 为单个课程添加动画：搜索时，现有项目滑动到新位置，而新项目淡入，移除的项目淡出。</p>
<p><strong>注意：</strong>  <code>ViewTransition</code> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-view-transitions-activity-api%2F" target="_blank" title="https://blog.logrocket.com/react-view-transitions-activity-api/" ref="nofollow noopener noreferrer">目前仅在</a> React 的 canary 版本中可用。</p>
<h2 data-id="heading-16">实际权衡</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E5%25AE%259E%25E9%2599%2585%25E6%259D%2583%25E8%25A1%25A1" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E5%AE%9E%E9%99%85%E6%9D%83%E8%A1%A1" ref="nofollow noopener noreferrer"/></p>
<p>采用这些模式通常比它们所替代掉的手动逻辑更简单。你并没有增加复杂性；而是将协调工作丢给了 React。话虽如此，以 Transitions、乐观更新和 Suspense 边界的方式思考确实需要思维转变。</p>
<h3 data-id="heading-17"><strong>何时适用</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25BD%2595%25E6%2597%25B6%25E9%2580%2582%25E7%2594%25A8" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%BD%95%E6%97%B6%E9%80%82%E7%94%A8" ref="nofollow noopener noreferrer"/></p>
<p>这些原语在具有丰富交互性的应用中表现出色：仪表板、管理面板和搜索界面。它们消除了整类的 Bug。竞态条件消失了。导航感觉无缝。你可以用更少的样板代码获得“原生应用”的感觉。</p>
<h3 data-id="heading-18"><strong>不要修复未损坏的东西</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E4%25B8%258D%25E8%25A6%2581%25E4%25BF%25AE%25E5%25A4%258D%25E6%259C%25AA%25E6%258D%259F%25E5%259D%258F%25E7%259A%2584%25E4%25B8%259C%25E8%25A5%25BF" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E4%B8%8D%E8%A6%81%E4%BF%AE%E5%A4%8D%E6%9C%AA%E6%8D%9F%E5%9D%8F%E7%9A%84%E4%B8%9C%E8%A5%BF" ref="nofollow noopener noreferrer"/></p>
<p>如果 <code>useState</code> 和 <code>useEffect</code> 对你来说工作可靠，就没有必要拆除它们。如果你没有在处理竞态条件、突兀的加载状态或输入延迟，你就不需要解决不存在的问题。</p>
<h3 data-id="heading-19"><strong>迁移路径</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E8%25BF%2581%25E7%25A7%25BB%25E8%25B7%25AF%25E5%25BE%2584" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E8%BF%81%E7%A7%BB%E8%B7%AF%E5%BE%84" ref="nofollow noopener noreferrer"/></p>
<p>你可以选择渐进式的采用。下次构建具有复杂异步状态的功能时，可以尝试用 Transition 代替另一个 <code>isLoading</code> 标识。在即时反馈重要的地方添加乐观 UI。这些工具与现有代码共存，因此你可以逐个功能地采用它们。</p>
<h2 data-id="heading-20">结论：向声明式异步的转变</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn%2Fblob%2Fmain%2Fweekly%2F443%2FReact%2520%25E7%259A%2584%25E6%2596%25B0%25E6%2597%25B6%25E4%25BB%25A3%25E5%25B7%25B2%25E7%25BB%258F%25E5%2588%25B0%25E6%259D%25A5%25EF%25BC%259A%25E4%25BD%25A0%25E9%259C%2580%25E8%25A6%2581%25E7%259F%25A5%25E9%2581%2593%25E7%259A%2584%25E4%25B8%2580%25E5%2588%2587%2Findex.md%23%25E7%25BB%2593%25E8%25AE%25BA%25E5%2590%2591%25E5%25A3%25B0%25E6%2598%258E%25E5%25BC%258F%25E5%25BC%2582%25E6%25AD%25A5%25E7%259A%2584%25E8%25BD%25AC%25E5%258F%2598" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn/blob/main/weekly/443/React%20%E7%9A%84%E6%96%B0%E6%97%B6%E4%BB%A3%E5%B7%B2%E7%BB%8F%E5%88%B0%E6%9D%A5%EF%BC%9A%E4%BD%A0%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/index.md#%E7%BB%93%E8%AE%BA%E5%90%91%E5%A3%B0%E6%98%8E%E5%BC%8F%E5%BC%82%E6%AD%A5%E7%9A%84%E8%BD%AC%E5%8F%98" ref="nofollow noopener noreferrer"/></p>
<p>异步 React（Async React）是并发渲染和协调原语的结合，形成了一个用于处理异步工作的完整系统，而这在过去需要手动编排。</p>
<p>随着这些原语在整个生态系统中被采用，这种转变变得切实可行。在 React Conf 2025 上宣布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Freactwg%2Fasync-react%2Fdiscussions" target="_blank" title="https://github.com/reactwg/async-react/discussions" ref="nofollow noopener noreferrer">Async React 工作组</a> 正在积极致力于在路由器、数据获取库和设计组件中标准化这些模式。</p>
<p>我们已经看到它的实际应用：</p>
<ul>
<li><strong>路由器</strong>（如 Next.js）默认将导航包装在 Transitions 中。</li>
<li><strong>数据库</strong>（如 TanStack Query 和 SWR）深度集成了对 Suspense 的支持。</li>
<li><strong>设计系统</strong>预计将跟进，暴露 Action 属性以在内部处理待处理状态和乐观更新。</li>
</ul>
<p>最终，这将异步处理的复杂性从应用代码转移到了框架。你描述 <em>应该发生什么</em>（Action、状态变更、导航），而 React 协调 <em>它如何发生</em>（待处理状态、乐观更新、加载边界）。React 的下一个时代不仅是关于新功能；更是关于让无缝的异步协调成为应用功能的默认方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL索引分析以及相关面试题]]></title>    <link>https://juejin.cn/post/7586237019988426752</link>    <guid>https://juejin.cn/post/7586237019988426752</guid>    <pubDate>2025-12-22T06:22:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586237019988426752" data-draft-id="7586208617604349986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL索引分析以及相关面试题"/> <meta itemprop="keywords" content="后端,MySQL,面试"/> <meta itemprop="datePublished" content="2025-12-22T06:22:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL索引分析以及相关面试题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:22:15.000Z" title="Mon Dec 22 2025 06:22:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 什么是索引</h3>
<ul>
<li>
<p>一种能帮助mysql提高查询效率的数据结构：<strong>索引数据结构</strong></p>
</li>
<li>
<p>索引优点：</p>
<ul>
<li>大大提高数据查询速度</li>
</ul>
</li>
<li>
<p>索引缺点：</p>
<ul>
<li>维护索引需要耗费数据库资源</li>
<li>索引要占用磁盘空间</li>
<li>当对表的数据进行增删改的时候，因为要维护索引，所以速度收到影响</li>
</ul>
</li>
<li>
<p>结合索引的优缺点，得出结论：数据库表并不是索引加的越多越好，而是仅为那些常用的搜索字段建立索引效果才是最佳的！</p>
</li>
</ul>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 索引的分类</h3>
<ul>
<li>
<p><strong>主键索引</strong>：<code>PRIMARY KEY</code></p>
<ul>
<li>设定为逐渐后，数据库自动建立索引，innodb为聚簇索引，主键索引列值不能有空(Null)</li>
</ul>
</li>
<li>
<p><strong>单值索引</strong>：又叫单列索引、普通索引</p>
<ul>
<li>即，一个索引只包含单个列，一个表可以有多个单列索引</li>
</ul>
</li>
<li>
<p><strong>唯一索引</strong>：</p>
<ul>
<li>索引列的值必须唯一，但允许有空值(Null)，但只允许有一个空值(Null)</li>
</ul>
</li>
<li>
<p><strong>复合索引</strong>：</p>
<ul>
<li>即，一个索引可以包含多个列，多个列共同构成一个复合索引！</li>
<li>eg: <code>SELECT id (name age) INDEX WHERE name AND age;</code></li>
</ul>
</li>
<li>
<p><strong>全文索引</strong>：Full Text （MySQL5.7之前，只有MYISAM存储引擎支持全文索引）</p>
<ul>
<li>全文索引类型为FULLTEXT，在定义索引的列上支持值的全文查找，允许在这些索引列中插入重复值和空值。全文索引可以在<strong>Char</strong> 、<strong>Varchar</strong> 上创建。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. 索引的基本操作</h3>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1 主键索引创建</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 建表语句：建表时，设置主键，自动创建主键索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user (
	id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);

<span class="hljs-comment">-- 查看索引</span>
<span class="hljs-keyword">SHOW</span> INDEX <span class="hljs-keyword">FROM</span> t_user;

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">12345678</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d94876dbd364e3e9dc088f5e361ef25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=oWP4GhHk5IX%2BObDT1QwRovwo6a4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2 单列索引创建(普通索引/单值索引)</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 建表时创建单列索引：</span>
<span class="hljs-comment">-- 这种方式创建单列索引，其名称默认为字段名称：name</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user (
	id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)，
    KEY(name)
);

<span class="hljs-comment">-- 建表后创建单列索引：</span>
<span class="hljs-comment">-- 索引名称为：name_index 格式---&gt; 字段名称_index</span>
<span class="hljs-keyword">CREATE</span> INDEX name_index <span class="hljs-keyword">ON</span> t_user(name)

<span class="hljs-comment">-- 删除单列索引</span>
DROPINDEX 索引名称 <span class="hljs-keyword">ON</span> 表名

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">1234567891011121314</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ab7e2d5114345018371aed6d4e48092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=iO1XQIubHRN6DkCWmldcX26zuoU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                         即可免费获取**</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c26de47a574452a8edd80ecc2451fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=YiioVOFnGr7I1UHzR%2F7%2BLCzCV7k%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.3 唯一索引创建</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 建表时创建唯一索引：</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user2 (
	id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    <span class="hljs-keyword">UNIQUE</span>(name)
);

<span class="hljs-comment">-- 建表后创建唯一索引：</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX name_index <span class="hljs-keyword">ON</span> t_user2(name);

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">123456789</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bdd76e198a14280939e2151529a3a35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=l9YZeFVHf0pGQwczBkXu2Y%2BETQM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.4 复合索引创建</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 建表时创建复合索引：</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_user3 (
	id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>,
    KEY(name,age)
);

<span class="hljs-comment">-- 建表后创建复合索引：</span>
<span class="hljs-keyword">CREATE</span> INDEX name_age_index <span class="hljs-keyword">ON</span> t_user3(name,age);

<span class="hljs-comment">-- 复合索引查询的2个原则</span>
<span class="hljs-comment">-- 1.最左前缀原则</span>
<span class="hljs-comment">-- eg: 创建复合索引时，字段的顺序为 name,age,birthday</span>
<span class="hljs-comment">-- 在查询时能利用上索引的查询条件为： </span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user3 <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> ?
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user3 <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> ?
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user3 <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> birthday <span class="hljs-operator">=</span> ?
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user3 <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> birthday <span class="hljs-operator">=</span> ?
<span class="hljs-comment">-- 而其他顺序则不满足最左前缀原则：</span>
... <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> birthday <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> ? <span class="hljs-comment">-- 不满足最左前缀原则</span>
... <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> birthday <span class="hljs-operator">=</span> ? <span class="hljs-comment">-- 不满足最左前缀原则</span>
... <span class="hljs-keyword">WHERE</span> birthday <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> ? <span class="hljs-comment">-- 不满足最左前缀原则</span>
... <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> birthday <span class="hljs-operator">=</span> ? <span class="hljs-comment">-- 不满足最左前缀原则</span>


<span class="hljs-comment">-- 2.MySQL 引擎在执行查询时，为了更好地利用索引，在查询过程中会动态调整查询字段的顺序！</span>
<span class="hljs-comment">-- 这时候再来看上面不满足最左前缀原则的四种情况：</span>
<span class="hljs-comment">-- 不满足最左前缀原则，但经过动态调整顺序后，变为：name age birthday 可以利用复合索引！</span>
... <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> birthday <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> ? 
<span class="hljs-comment">-- 不满足最左前缀原则，也不能动态调整（因为缺少age字段），不可以利用复合索引！</span>
... <span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> birthday <span class="hljs-operator">=</span> ? 
<span class="hljs-comment">-- 不满足最左前缀原则，但经过动态调整顺序后，变为：name age birthday 可以利用复合索引！</span>
... <span class="hljs-keyword">WHERE</span> birthday <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> age <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> name <span class="hljs-operator">=</span> ?
<span class="hljs-comment">-- 不满足最左前缀原则，也不能动态调整（因为缺少name字段），不可以利用复合索引！</span>
... <span class="hljs-keyword">WHERE</span> age <span class="hljs-operator">=</span> ? <span class="hljs-keyword">AND</span> birthday <span class="hljs-operator">=</span> ?

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">123456789101112131415161718192021222324252627282930313233343536</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e618329d9bfd42c6945a0ca63db81cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=DzBxSdwyfzjQQfLZcAOg%2FvbeLLc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4. MySQL索引的数据结构(B+Tree)</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 建表：</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> t_emp(
	id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>
);

<span class="hljs-comment">-- 插入数据：插入时，主键无序</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">5</span>,<span class="hljs-string">'d'</span>,<span class="hljs-number">22</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">6</span>,<span class="hljs-string">'d'</span>,<span class="hljs-number">22</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">7</span>,<span class="hljs-string">'3'</span>,<span class="hljs-number">21</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>,<span class="hljs-string">'a'</span>,<span class="hljs-number">23</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">2</span>,<span class="hljs-string">'b'</span>,<span class="hljs-number">26</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">3</span>,<span class="hljs-string">'c'</span>,<span class="hljs-number">27</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">4</span>,<span class="hljs-string">'a'</span>,<span class="hljs-number">32</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">8</span>,<span class="hljs-string">'f'</span>,<span class="hljs-number">53</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_emp <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">9</span>,<span class="hljs-string">'b'</span>,<span class="hljs-number">13</span>);

<span class="hljs-comment">-- 查询：自动排序，有序展示（因为主键是有主键索引的，因此会自动排序）</span>

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">12345678910111213141516171819</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee8a9cc11407438b9a2b6050f1c7d3d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=GufY%2BNVF6qU0eRRzoRvJwGkX824%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><code>问题：为什么数据插入时，未按照主键顺序，而查询时却是有序的呢</code>？</p>
<ul>
<li>原因：MySQL底层为主键自动创建索引，一旦创建了索引，就会进行排序！</li>
<li>实际上这些数据在MySQL底层的真正存储结构变成了下面这种方式：</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c9ece0034c3430b8acf0cd794cc1e0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=5GKJe9U690jHcABFDxNlZrvqA4k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><code>问题：为什么要排序呢？</code></p>
<ul>
<li>因为排序之后查询效率就快了，比如查询 <code>id = 3</code> 的数据，只需要按照顺序去找即可，而如果不排序，就如同大海捞针，假如100W条数据，可能有时候需要随机查询100W次才找到这个数据，也可能运气好上来第1次就查询到了该数据，不确定性太高！</li>
</ul>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1 原理分析图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d5531cb971b427ea4281b6ecc20fba9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=q05Nn18M3zcCeVNT21UbkeEUDHA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>上图这种分层<code>树</code>结构查询效率较高，因为如果我需要查询 <code>id=4</code>的数据，只需要在页目录中匹配，大于3且小于5，则去3对应的<code>page=2</code>中查找数据，这样就不需要从第1页开始检索数据了，大大提高了效率！</li>
<li>从上图可得出，在只有2层的结构下，1page 可以存储记录总数为 <code>1365 * 455 ≈ 62万条</code>，而如果再加1层结构，来存储page层分页目录数据的分页层PAGE的话，那么1PAGE可以存储总page数为：<code>1365 * 1365 ≈ 186万条page </code>，而1PAGE存储的总记录数为 <code>1365 * 1365 * 455 ≈ 8.5 亿条</code>。因此，我们平时使用的话，2层结构就已经足够了！实际上1个页存储的总数据树可能大于理论估计的，因为我们分配name字段的<code>VARCHAR(20)</code>占20个字节，而实际上可能存储的name数据并没有20个字节，可能更小！</li>
</ul>
<blockquote>
<p>三层结构实例如图：</p>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                         即可免费获取**</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c26de47a574452a8edd80ecc2451fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=YiioVOFnGr7I1UHzR%2F7%2BLCzCV7k%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2 B+[树结构分析]</h4>
<blockquote>
<p>上图4.1 原理分析图中这种索引结构称之为B+树数据结构，那么什么是B+树呢？B树和B+树区别是什么呢?</p>
</blockquote>
<p><strong>问题4.2.1 为什么InnoDB底层使用B+树做索引而不用B树？</strong></p>
<p>B树结构图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5990399f657f43e1a491a0b5e9da03a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=%2FCEkSBShMateM8GhN9nC5941nuA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>
<p>从上面的B树结构图中分析得出，B树每个节点中不仅包含数据的key，还有data数据。而每个页的存储空间是有限的，如果data数据较大时，讲会导致每个节点(即一个页16KB)能存储的key的数量较少，当存储数据量很大时，会造成B树的深度较大，增大查询时的磁盘读取I/O次数，进而影响查询效率。(<strong>树的深度影响I/O读取次数</strong>)</p>
</li>
<li>
<p>在上一小节的B+树结构图分析中，所有数据记录都是按照键值大小顺序存放在同一层的叶子节点上，而非叶子节点上只能存储key值信息，这样可以大大增加每个节点(即一个页16KB)能存储的key的数量，进而可以降低树的高度，进而减少磁盘读取I/O次数，提高查询效率</p>
</li>
<li>
<p>所以B树和B+树的区别就在于：</p>
<ul>
<li>B+树只有叶子节点存储数据记录</li>
<li>B+树非叶子节点只存储键值信息（B树的非叶子也存数据记录）</li>
<li>所有节点直接都有一个链指针</li>
</ul>
</li>
<li>
<p>InnoDB存储引擎中，页的大小为16KB，一般表的主键类型为INT(占用4个字节) 或 BIGINT(占用8个字节)，指针类型也一般占4或8个字节，也就是说，一个页(B+树中的一个节点)中大概可以存储<code>16KB/(8B+8B)=1000</code>个键值(只是估计值，方便计算而已)。也就是说，一个深度为3的B+树索引可以维护<code>10^3 * 10^3 * 10^3 = 10亿</code>条记录。</p>
</li>
<li>
<p>实际情况中每个节点可能不能填充满，因此在数据库中，B+树的高度一般是<strong>24层</strong>。<strong>MySQL的InnoDB存储引擎在设计时是将根节点常驻在内存中（不需要动磁盘I/O）<strong>的，也就是说</strong>查找某个键值的行记录最多只需要13次I/O操作</strong>！（<strong>每查询一层都需要动用一次磁盘I/O</strong>）</p>
</li>
</ul>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5. 聚簇索引和非聚簇索引</h3>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.1 聚簇索引和非聚簇索引分析</h4>
<blockquote>
<p>在表中，聚簇索引实际上就是指的是主键索引！如果表中没有主键的话，则MySQL会根据该表生成一个RoleID，拿这个RoleId当做聚簇索引！</p>
</blockquote>
<ul>
<li>
<p><strong>聚簇索引</strong>：<code>将数据存储与索引放到一起</code>，索引结构的叶子节点保存了每行的数据。例如：4.1小结分析图中的data层一个单位就是聚簇索引存储数据的例子，主键<strong>id</strong> 字段就是聚簇索引，4.1小结分析图就是基于主键索引(聚簇索引)构成的B+树结构！<strong>聚簇索引不一定是主键索引，但是主键索引肯定是聚簇索引</strong>！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/321acada07b04f0a9bb515bb3a634dc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=KU9Qm4NOeYJwze198ilqtjXykKA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
<li>
<p><strong>非聚簇索引</strong>：<code>将数据与索引分开存储</code>，索引结构的叶子节点指向了数据对应的位置(聚簇索引的值)！非聚簇索引检索数据是在自己的 “树” 上进行查找，例如我们根据表中的非聚簇索引<strong>name</strong>字段去查找数据时，流程如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4ffbdb5a7024665b8795d5179f793a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=1FCjU6NDmh7XQaBe6nEtJ9ReH%2Fo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>再看一张比较正规的分析图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2004d257dd354b0f8b18cbf6f898b973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=dfEuqLZJHVovn5V2j6%2F%2F6j8Tr3Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
</ul>
<p><strong>注意</strong>：在InnoDB中，在聚簇索引之上创建的索引称之为<strong>辅助索引</strong>，例如：复合索引、单列索引、唯一索引。<strong>一个表中只能有1个聚簇索引，而其他索引都是辅助索引</strong>！辅助索引的叶子节点存储的不再是行的物理位置，而是主键的值，<strong>辅助索引访问数据总是需要二次查找的</strong>！</p>
<blockquote>
<p>**问题5.1.1 **：为什么非聚簇索引(name字段的单列索引)构成的树，其叶子节点存储聚簇索引(主键id)，而不直接存储行数据的物理地址呢？</p>
<p>换个方式问：非聚簇索引检索数据时，检索一次本树再去聚簇索引树中检索一次，这样二次检索树结构，那么为什么不直接在非聚簇索引树叶子节点中存放行数据物理地址，这样只需要检索一次树结构就拿到行数据呢？</p>
</blockquote>
<p>这里画个图方便理解一些：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ad0a439210c41a6a65f1702e863d94a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=iYUIPhvlNss2iwy%2BGTRppuyfqTc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>​ 从上图得出，在做新增数据时，因为底层是需要基于主键索引进行排序的，那么就可能导致原来某些<strong>数据对应的物理地址发生了变化</strong>，而这时候由于我们的非聚簇索引树的叶子节点直接存储了数据的物理地址，所以为了保证能获取到数据，还需要同时对非聚簇索引树叶子节点的地址进行一遍更新修改！</p>
<p>​ 同理，如果我们不做插入主键id为4这行记录的操作，而是将其删除的话，这个流程可以自己思考一下！</p>
<p>​ 也就是说：<strong>之所以不在非聚簇索引树的叶子节点直接存放行数据的物理地址，是因为，存储数据的物理地址会随着数据库表的CRUD操作而不断变更，为了保证能获取到数据，这时必须要对非聚簇索引树相关叶子节点的地址进行一遍修改</strong>！而存主键，主键不会随着CRUD操作发生变化，宁愿多查一次树，也不要再修改一次树的结构！</p>
<h4 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.2 MySQL两种引擎中的(非)聚簇索引</h4>
<blockquote>
<blockquote>
<p><strong>篇幅限制下面就只能给大家展示小册部分内容了。整理了一份核心面试笔记包括了：Java面试、Spring、JVM、MyBatis、Redis、MySQL、并发编程、微服务、Linux、Springboot、SpringCloud、MQ、Kafka 面试专题</strong></p>
<blockquote>
</blockquote>
<p><strong>需要全套面试笔记及答案【扫一扫】</strong>                         即可免费获取**</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c26de47a574452a8edd80ecc2451fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=YiioVOFnGr7I1UHzR%2F7%2BLCzCV7k%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/>
InnoDB中：</p>
</blockquote>
<ul>
<li>
<p>InnoDB中使用的是聚簇索引，将<strong>主键</strong>组织到一颗B+树中，而行数据就存储在该B+树的叶子节点上，若使用<code>WHERE id = 4</code> 这样的条件查找主键，则按照B+树的检索算法即可查找对应的叶子节点，之后获得对应的行数据！</p>
</li>
<li>
<p>若对使用单列索引(非聚簇索引)的<strong>name</strong>字段进行搜索，则需要执行2个步骤：</p>
<ul>
<li>第一步：在辅助索引B+树中检索<strong>name</strong>，到达其对应的叶子节点后获得该字段对应行记录的<strong>主键id</strong>！</li>
<li>第二步：使用<strong>主键id</strong>在主索引B+树中再次执行一次树的检索，最终到达对应的叶子节点并获取到行记录数据！</li>
</ul>
</li>
<li>
<p><strong>聚簇索引默认是主键</strong>，如果表中没有定义主键，InnoDB会选择一个<strong>唯一且非空的索引</strong>代替主键作为聚簇索引。而如果也没有这样的唯一非空索引，那么InnoDB就会<strong>隐式定义一个主键</strong>（类似于Oracle中的RowId）来做为聚簇索引。</p>
</li>
<li>
<p>如果已经设置了聚簇索引又希望再单独设置聚簇索引，则必须先删除主键，然后添加我们想要的聚簇索引，最后再恢复主键即可！</p>
</li>
</ul>
<blockquote>
<p>MYISAM中：</p>
</blockquote>
<ul>
<li>
<p>MYISAM使用的是非聚簇索引，<strong>非聚簇索引的两颗B+树看上去没有什么不同</strong>，节点的结构完全一致，只是存储的内容不同，主键索引B+树的节点存储了主键，辅助索引B+树存储量辅助键。</p>
</li>
<li>
<p>表数据存储在独立的地方，这两颗B+树的叶子节点都使用一个地址指针指向真正的表数据，对于表数据来说，这两个键没有任何差别。</p>
</li>
<li>
<p><strong>由于索引树是独立的，通过辅助键检索无需再次检索主键索引树</strong>！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d64c5ecd2f624de09ce9714fbadba165~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=VtJ5cJC%2BeB176rjfxBFptZPWT48%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
</ul>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.3 聚簇索引和非聚簇索引的优/劣势</h4>
<blockquote>
<p>问题：5.3.1 使用聚簇索引的优势</p>
</blockquote>
<p><strong>问题</strong>：每次使用辅助索引检索都需要经过2次B+树查找，看上去聚簇索引的效率明显要低于非聚簇索引，那么聚簇索引的优势何在呢？</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1.由于行数据和聚簇索引树的叶子节点存储在一起，同一页中会有多条行数据，首次访问数据页中某条行记录时，会把该数据页数据加载到Buffer(缓存器)中，当再次访问该数据页中其他记录时，不必访问磁盘而直接在内存中完成访问。</span>
<span class="hljs-comment">-- 注：主键id和行数据一起被载入内存，找到对应的叶子节点就可以将行数据返回了，如果按照主键id来组织数据，获取数据效率更快！</span>

<span class="hljs-comment">-- 2.辅助索引的叶子节点，存储主键的值，而不是行数据的存放地址。这样做的好处是，因为叶子节点存放的是主键值，其占据的存储空间小于存放行数据物理地址的储存空间</span>

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">1234</span>
</code></pre>
<blockquote>
<p>问题：5.3.2 使用聚簇索引需要注意什么？</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 当使用主键为聚簇索引时，而不要使用UUID方式，因为UUID的值太过离散，不适合排序，导致索引树调整复杂度增加，消耗更多时间和资源。</span>

<span class="hljs-comment">-- 建议主键最好使用INT/BIGINT类型，且为自增，这样便于排序且默认会在索引树的末尾增加主键值，对索引树的结构影响最小(下面主键自增的问题会解释原因)。而且主键占用的存储空间越大，辅助索引中保存的主键值也会跟着增大，占用空间且影响IO操作读取数据！</span>

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">123</span>
</code></pre>
<blockquote>
<p>问题：5.3.3 为什么主键通常建议使用自增id？</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 聚簇索引树存放数据的物理地址(xx1,xx2,xx3,xxx5)与索引顺序(1,2,3,5)是一致的，即：</span>
<span class="hljs-comment">-- 1.只要索引是相邻的，那么在磁盘上索引对应的行数据存放地址也是相邻的。</span>
<span class="hljs-comment">-- 2.如果主键是自增，那么当插入新数据时，只需要按照顺序在磁盘上开辟新物理地址存储新增行数据即可。</span>
<span class="hljs-comment">-- 3.而如果不是主键自增，那么当新插入数据后，会对索引进行重新排序(重新调整B+树结构)，磁盘上的物理存储地址也需要重新分配要存储的行数据！</span>

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">1234</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bceba2a82a74deab618fa70529dc8a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990797&amp;x-signature=6g4k5Bnm%2FklttQRcDJ7KbaZF5Ik%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p>问题：5.3.4 什么情况下无法利用索引呢？</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 查询语句中使用LIKE关键字：（这种情况主要是针对于单列索引）</span>
<span class="hljs-comment">-- 在使用LIKE关键字查询时，如果匹配字符串的第一个字符为'%'，则索引不会被使用，而'%'不在最左边，而是在右边，则索引会被使用到！</span>
<span class="hljs-comment">-- eg:</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'xx%'</span> <span class="hljs-comment">-- 可以利用上索引,这种情况下可以拿xx到索引树上去匹配</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%xx%'</span> <span class="hljs-comment">-- 不可以利用上索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%xx'</span> <span class="hljs-comment">-- 不可以利用上索引</span>

<span class="hljs-comment">-- 2. 查询语句中使用多列索引：（这种情况主要是针对于聚合索引）</span>
<span class="hljs-comment">-- 多索引是在表的多个字段创建索引，只有查询条件中使用了这些字段中的第一个字段，索引才会被使用。即：最左前缀原则，详情查看3.4小结聚合索引中的介绍！</span>

<span class="hljs-comment">-- 3. 查询语句中使用OR关键字：</span>
<span class="hljs-comment">-- 查询条件中有OR关键字时，如果OR前后的两个条件列都具有索引，则查询中索引将被使用，而如果OR前后有一个或2个列不具有索引，那么查询中索引将不被使用到！</span>

AI写代码<span class="hljs-keyword">sql</span>
<span class="hljs-number">123456789101112</span>
</code></pre>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6. 什么是约束以及分类</h3>
<blockquote>
<p>约束:</p>
</blockquote>
<ul>
<li>
<p>作用：是为了<strong>保证数据的完整性</strong>而实现的摘自一套机制，即(约束是针对表中数据记录的)</p>
</li>
<li>
<p>MySQL中的约束：</p>
<ul>
<li>非空约束：<strong>NOT NULL</strong> 保证某列数据不能存储NULL 值;</li>
<li>唯一约束：<strong>UNIQUE(字段名)</strong>  保证所约束的字段，数据必须是唯一的，允许数据是空值(Null)，但只允许有一个空值(Null)；</li>
<li>主键约束：<strong>PRIMARY KEY(字段名)</strong>  <code>主键约束= 非空约束 + 唯一约束</code> 保证某列数据不能为空且唯一；</li>
<li>外键约束：<strong>FOREIGN KEY(字段名)</strong>  保证一个表中某个字段的数据匹配另一个表中的某个字段，可以建立表与表直接的联系；</li>
<li>自增约束：<strong>AUTO_INCREMENT</strong> 保证表中新插入数据时，某个字段数据可以依次递增；</li>
<li>默认约束：<strong>DEFALUT</strong> 保证表中新插入数据时，如果某个字段未被赋值，则会有默认初始化值；</li>
<li>检查性约束：<strong>CHECK</strong> 保证列中的数据必须符合指定的条件；</li>
</ul>
</li>
<li>
<p>示例：</p>
<ul>
<li>
<pre><code class="hljs language-sql" lang="sql">  <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">member</span>(
  	id <span class="hljs-type">int</span>(<span class="hljs-number">10</span>),
  	phone <span class="hljs-type">int</span>(<span class="hljs-number">15</span>) unsigned zerofill,
  	name <span class="hljs-type">varchar</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
  	<span class="hljs-keyword">constraint</span> uk_name <span class="hljs-keyword">unique</span>(name),
  	<span class="hljs-keyword">constraint</span> pk_id <span class="hljs-keyword">primary</span> key (id),
  	<span class="hljs-keyword">constraint</span> fk_dept_id <span class="hljs-keyword">foreign</span> key (dept_id，字段<span class="hljs-number">2</span>)
  	<span class="hljs-keyword">references</span> dept(主表<span class="hljs-number">1</span>)(dept_id)
  );
</code></pre>
</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“写代码”到“卖价值”：一名工程师关于规模化技能的思考]]></title>    <link>https://juejin.cn/post/7586263211087872026</link>    <guid>https://juejin.cn/post/7586263211087872026</guid>    <pubDate>2025-12-22T06:46:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586263211087872026" data-draft-id="7586301866910613555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“写代码”到“卖价值”：一名工程师关于规模化技能的思考"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-22T06:46:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“写代码”到“卖价值”：一名工程师关于规模化技能的思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:46:20.000Z" title="Mon Dec 22 2025 06:46:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：工程师的技能规模化，不在于重复劳动，而在于将技术与真实行业痛点结合，通过产品化、平台化交付可复用的价值。关键不是“多写代码”，而是“解决有人愿意付费的问题”。</p>
<h2 data-id="heading-0">从“写代码”到“卖价值”：一名工程师关于规模化技能的思考</h2>
<blockquote>
<p><strong>技术本身不值钱，解决真实世界的问题才值钱。</strong></p>
</blockquote>
<p>2025年，在调试一个 Flask 应用中 <code>itsdangerous</code> 的类型错误时，我意识到一个问题远比代码本身更值得深思：<strong>作为一名工程人员，如何让自己的技能产生规模化价值？</strong></p>
<p>当然，也不止是这么一个问题，而是我写了好几款App应用，发现很难推广后，自己的理解豁然开朗，做产品是很难的，短期个人的资源是很难突破的。</p>
<p>过去，我以为“把活干好”就够了；后来，我学会了用 AI 提效；再后来，我发现——<strong>光会做事远远不够，关键是要让别人愿意为你的产出买单。</strong></p>
<p>这篇文章，是我从“埋头编码”走向“价值交付”的思考总结。</p>
<hr/>
<h3 data-id="heading-1">一、误区：以为“复制自己”就是规模化</h3>
<p>早期，我对“规模化”的理解很朴素：</p>
<blockquote>
<p>“多接项目、多写代码、多加班，就能赚更多。”</p>
</blockquote>
<p>但很快发现，这种线性增长有天花板：</p>
<ul>
<li>时间有限，精力有限；</li>
<li>纯手工交付无法复用；</li>
<li>客户只认结果，不关心你写了多少行代码。</li>
</ul>
<p>更危险的是，<strong>如果我的工作能被完全复制，那它也最容易被自动化或外包取代。</strong></p>
<p>真正的规模化，不是“重复劳动”，而是<strong>构建可复用的资产</strong>——无论是工具、知识、流程，还是影响力。</p>
<hr/>
<h3 data-id="heading-2">二、转折：从“技术思维”转向“产品思维”</h3>
<p>我开始问自己几个问题：</p>
<ul>
<li>我解决的问题，是别人真正在意的吗？</li>
<li>如果我不在场，这套方案还能跑起来吗？</li>
<li>有没有人愿意为它付钱？</li>
</ul>
<p>答案往往是否定的。因为工程师容易陷入“技术自嗨”：</p>
<blockquote>
<p>“我用了最新框架！”<br/>
“我的算法效率提升了30%！”</p>
</blockquote>
<p>但客户只关心：</p>
<blockquote>
<p>“这能帮我省多少钱？少加多少班？多赚多少订单？”</p>
</blockquote>
<p>于是，我尝试转变视角：</p>
<ul>
<li>不再卖“技术”，而是卖“解决方案”；</li>
<li>不再追求“完美代码”，而是追求“最小可行价值”（MVP）；</li>
<li>不再等产品做完再推广，而是在开发过程中就找用户验证。</li>
</ul>
<p><strong>技术是手段，价值才是目的。</strong></p>
<hr/>
<h3 data-id="heading-3">三、路径：用“技术 × 行业 × 平台”三角模型定位自己</h3>
<p>我逐渐明白：<strong>单靠技术很难变现，必须找到它与真实世界的交点。</strong></p>
<p>我提出了一个简单的三角模型：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">         行业痛点 
           /  \
          /    \
         /      \
技术能力 —— —— —— 平台机会
</span></code></pre>
<ul>
<li><strong>技术能力</strong>：我擅长什么？（如自动化脚本、API 集成、数据清洗）</li>
<li><strong>行业痛点</strong>：哪个领域正被低效、高成本、合规等问题折磨？</li>
<li><strong>平台机会</strong>：哪个渠道能让我低成本触达客户、完成交付？说人话，还有一个关键的就是，你在什么公司？这是很多人最简单粗暴的认知，大厂中厂小厂，夕阳行业，黄昏产业，还是如日中天的行业？</li>
</ul>
<h4 data-id="heading-4">案例启发：</h4>
<ul>
<li>有人给跨境电商卖家做 Shopify 插件，解决库存同步问题；</li>
<li>有人帮学校老师开发 Excel 自动报表工具，一键生成教务数据；</li>
<li>有人用 LLM 做简历优化服务，通过小红书引流、微信成交。</li>
</ul>
<p>他们不是技术最强的，但<strong>站在了需求爆发的交叉点上</strong>。</p>
<hr/>
<h3 data-id="heading-5">四、方法论：如何找到这个交叉点？</h3>
<h4 data-id="heading-6">1. 从“抱怨”中挖需求</h4>
<p>去知乎、小红书、行业社群看人们在吐槽什么：</p>
<ul>
<li>“每天要手动对账3小时”</li>
<li>“客户资料散落在5个系统里”</li>
<li>“报表格式老变，Excel公式总出错”</li>
</ul>
<p><strong>高频、具体、让人烦躁的痛点，就是金矿。</strong></p>
<h4 data-id="heading-7">2. 绑定一个“正在增长”的行业</h4>
<p>不要在夕阳产业里死磕。关注政策或资本涌入的方向：</p>
<ul>
<li>出海电商（Temu、SHEIN 带动的数字化）</li>
<li>银发经济（养老、慢病管理）</li>
<li>AI 应用层（不是做大模型，而是帮律师、HR、教师提效）、</li>
</ul>
<p>想知道这些，最好看看股市，国家政策啥的，自己刷手机真的不全面，看看别人做的行业解读，行业研究，注重数字量化素养，这些大方向的判断是非常难的。</p>
<blockquote>
<p>技术人不必发明新行业，只需成为新兴行业的“水电煤”。</p>
</blockquote>
<h4 data-id="heading-8">3. 先做“服务”，再产品化</h4>
<p>很多成功产品，最初都是私活：</p>
<ol>
<li>接一个定制项目；</li>
<li>发现10家客户有同样需求；</li>
<li>把解决方案标准化，变成 SaaS 或模板，按月收费。</li>
</ol>
<p>这叫 <strong>“从服务中孵化产品”</strong>，风险最低，反馈最快。</p>
<hr/>
<h3 data-id="heading-9">五、给同行们的行动建议：今天就能开始的三件事</h3>
<ol>
<li>
<p><strong>盘点你的“可产品化”技能</strong><br/>
列出你最擅长的3项能力，问：“这能解决什么人的什么具体问题？”</p>
</li>
<li>
<p><strong>做一个极简 MVP</strong><br/>
不需要完美。一个脚本、一份模板、一次30分钟咨询，足够验证需求。</p>
</li>
<li>
<p><strong>收一次费</strong><br/>
找朋友、前同事或社群成员，<strong>收费试用</strong>。</p>
<blockquote>
<p>免费没人珍惜，付费才是真实反馈？？是不是？收5块钱也是收。</p>
</blockquote>
</li>
</ol>
<hr/>
<h3 data-id="heading-10">我的个人感受</h3>
<p>工程师的终极护城河，是“解决问题的能力 × 商业嗅觉”</p>
<p>AI 时代，写代码越来越容易，但<strong>理解人、洞察需求、交付价值</strong>的能力反而更稀缺。</p>
<p>我不再追求“写出最优雅的代码”，而是追求：</p>
<blockquote>
<p>“我的方案，是否让某个人的工作变得轻松了一点？”</p>
</blockquote>
<p>规模化自己，不是成为流水线上的高效螺丝钉，而是<strong>把自己变成一座桥梁——连接技术与真实世界的需求。</strong></p>
<p>这条路很难，但值得走。</p>
<hr/>
<p><em>写于 2025年12月21日，一个因 SECRET_KEY 类型错误而引发的深夜顿悟。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[流式数据集：效率提升 100 倍！]]></title>    <link>https://juejin.cn/post/7586237019988754432</link>    <guid>https://juejin.cn/post/7586237019988754432</guid>    <pubDate>2025-12-22T06:49:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586237019988754432" data-draft-id="7586482851102015523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="流式数据集：效率提升 100 倍！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-22T06:49:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HuggingFace"/> <meta itemprop="url" content="https://juejin.cn/user/611789528634712"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            流式数据集：效率提升 100 倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/611789528634712/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HuggingFace
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:49:12.000Z" title="Mon Dec 22 2025 06:49:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">快速了解（TLDR）</h2>
<blockquote>
<p>现在只需一行代码，就能通过 <code>load_dataset('dataset', streaming=True)</code> 以流式方式加载数据集，无需下载！</p>
<p>无需复杂配置、不占磁盘空间、不再担心 “磁盘已满” 或 429 请求过多错误，立即开始训练 TB 级数据集！
性能非常强劲：在 64×H100、256 个并发 worker 环境下，流式加载速度甚至超过本地 SSD！
我们优化后的流式系统：请求数减少 100 倍 → 数据解析速度提升 10 倍 → 样本处理速度翻倍 → 即使在 256 个并发 worker 下也 0 崩溃。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ce015041ab8494bad376b2c6c28fb19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSHVnZ2luZ0ZhY2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990952&amp;x-signature=IbteqCFVlQj9up13zQc6Bed1E%2Fg%3D" alt="数据流式加载可视化" loading="lazy"/></p>
<p>在机器学习中，特别是在处理 TB 级别的数据时，数据加载一直是个大难题。我们自己在训练 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fblog%2Fsmollm3" target="_blank" title="https://huggingface.co/blog/smollm3" ref="nofollow noopener noreferrer">SmolLM3</a> 时也深有体会，有段时间每次训练前都得等上 3 小时下载数据。</p>
<p>虽然 <code>datasets</code> 库早就支持流式加载，但在大规模训练中依然面临瓶颈。今天，这一切都变了 🔥。我们花了几个月优化后端，全面提升流式数据集的速度与效率。</p>
<p>那我们到底做了哪些优化？⤵️</p>
<h2 data-id="heading-1">一样简单的 API，更强大的性能</h2>
<p>首先最重要的一点：<strong>改进后的接口依然兼容原来的用法</strong>。你只需要加上 <code>streaming=True</code>，就能流式加载 Hugging Face 上的任意数据集，依旧简单直接。🚀</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset

<span class="hljs-comment"># Stream a dataset instead of downloading it</span>
dataset = load_dataset(<span class="hljs-string">"HuggingFaceM4/FineVisionMax"</span>, split=<span class="hljs-string">"train"</span>, streaming=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># Get the first example</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(<span class="hljs-built_in">iter</span>(dataset)))
</code></pre>
<p>全球成千上万的 AI 开发者每天都在使用 <code>datasets</code>，现在他们无需改动任何代码，就能直接享受到更高的性能。</p>
<h2 data-id="heading-2">问题挑战：大规模流式加载</h2>
<p>流式加载一直是快速了解数据集的好方法，但在训练模型时，大多数人仍然选择将数据预先下载到本地，或使用 S3 等云存储——我们在训练 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fblog%2Fsmolvlm2" target="_blank" title="https://huggingface.co/blog/smolvlm2" ref="nofollow noopener noreferrer">SmolVLM</a> 时也是这么做的。</p>
<p>我们希望改变这种情况，于是在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2FnanoVLM" target="_blank" title="https://github.com/huggingface/nanoVLM" ref="nofollow noopener noreferrer">nanoVLM</a> 时，尝试直接从 Hugging Face Hub 进行流式读取。</p>
<p>但很快就遇到一个严重问题：**一次测试运行在不到一分钟的时间内发出了超过 10 万个请求，结果我们的 IP 被 Hub 屏蔽了！**😅</p>
<p>问题的根源在于：<strong>每个 <code>DataLoader</code> 的 worker 都在独立初始化数据集</strong>，这导致大量冗余请求，形成了“请求风暴”，其中大部分其实是没必要的。</p>
<p>于是我们对启动逻辑进行了深度优化，<strong>最终将启动请求量减少了 100 倍</strong>。总体性能提升如下：</p>
<ul>
<li><strong>数据文件解析速度：提升 10 倍</strong></li>
<li><strong>启动请求效率：提高最多 100 倍</strong></li>
<li><strong>流式速度：提升最多 2 倍</strong></li>
<li><strong>在途请求效率：提升最多 2 倍</strong></li>
</ul>
<h2 data-id="heading-3">技术揭秘：我们具体改了什么？</h2>
<p>我们主要优化了两个阶段：<strong>启动阶段</strong> 和 <strong>流式加载阶段</strong>。</p>
<h3 data-id="heading-4">1. 启动优化 ⚡️</h3>
<p>初始的数据文件解析阶段会触发大量请求。我们进行了以下两项关键优化：</p>
<ul>
<li>
<p><strong>持久化数据文件缓存</strong>：现在所有 <code>DataLoader</code> worker 会共享数据文件列表缓存。第一个 worker 从 Hub 获取文件列表，其余 worker 直接从本地缓存中读取，从而<strong>几乎完全消除启动阶段的请求</strong>，大幅缩短加载时间，彻底告别“请求风暴”。</p>
</li>
<li>
<p><strong>优化文件解析逻辑</strong>：我们精简了初始 worker 向 Hub 请求文件列表的 API 调用数量，将多个请求进行打包处理，进一步<strong>降低启动延迟</strong>。</p>
</li>
</ul>
<h3 data-id="heading-5">2. 流式加载优化 🏎️</h3>
<p>为了提升训练过程中的流式吞吐量，我们新增了两个关键功能：</p>
<ul>
<li>
<p><strong>Parquet 数据预取（Prefetching）</strong>：我们为 Parquet 格式的数据集启用了预取功能。这意味着，在模型处理当前数据块的同时，<code>datasets</code> 库会在后台<strong>提前加载下一块数据</strong>。这样可以让整个数据管道始终保持“满负荷”，确保 GPU 不会因等待数据而处于空闲状态，大大提升训练效率。</p>
</li>
<li>
<p><strong>可配置缓冲机制（Buffering）</strong>：针对高级用户，我们开放了缓冲区的配置参数，支持自定义设置<strong>预取数量和数据块大小</strong>，方便根据自身硬件和网络情况进行 I/O 优化。</p>
</li>
</ul>
<p>以下是如何将默认流式请求大小从 32MiB 提升到 128MiB，并启用预取的示例代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pyarrow
<span class="hljs-keyword">import</span> pyarrow.dataset

fragment_scan_options = pyarrow.dataset.ParquetFragmentScanOptions(
    cache_options=pyarrow.CacheOptions(
        prefetch_limit=<span class="hljs-number">1</span>,
        range_size_limit=<span class="hljs-number">128</span> &lt;&lt; <span class="hljs-number">20</span>
    ),
)
ds = load_dataset(parquet_dataset_id, streaming=<span class="hljs-literal">True</span>, fragment_scan_options=fragment_scan_options)
</code></pre>
<p>通过这些优化，你的数据加载速度可以提升一倍，训练效率更高！</p>
<h2 data-id="heading-6">为什么比 S3 还快？背后是 Xet 技术</h2>
<p>Hugging Face 使用了 <strong>Xet 存储系统</strong>：这是一种去重式存储方案，上传和下载速度极快。与传统远程存储不同，Xet 会跳过重复数据，只传输独特内容。</p>
<p>比如，在 Hugging Face 上传大型数据集时，Xet 的去重机制大幅减少了数据传输量，上传更快；数据一上传完，就可以立即开始流式读取。</p>
<p>对于 Parquet 文件，Xet 利用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fblog%2Fparquet-cdc" target="_blank" title="https://huggingface.co/blog/parquet-cdc" ref="nofollow noopener noreferrer">Parquet 内容定义切块（CDC）</a> 来实现去重，进一步加快传输速度。</p>
<p>此外，我们还推出了 <code>pyspark_huggingface</code> 包，支持 Spark 直接读写 HF 数据集，内置对 Parquet CDC 和 Xet 的支持，大幅加快大数据处理。</p>
<h2 data-id="heading-7">想自定义流式管道？可以！</h2>
<p>有些数据格式 <code>datasets</code> 库还不支持，或者你希望获得更高的控制权，我们也提供了强大的自定义流式能力。</p>
<p><code>huggingface_hub</code> 库中的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fhuggingface_hub%2Fguides%2Fhf_file_system" target="_blank" title="https://huggingface.co/docs/huggingface_hub/guides/hf_file_system" ref="nofollow noopener noreferrer">HfFileSystem</a> 可高效读取远程数据集文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> huggingface_hub <span class="hljs-keyword">import</span> HfFileSystem

path = <span class="hljs-string">f"hf://datasets/<span class="hljs-subst">{dataset_id}</span>/<span class="hljs-subst">{path_in_repo}</span>"</span>
<span class="hljs-keyword">with</span> HfFileSystem().<span class="hljs-built_in">open</span>(path) <span class="hljs-keyword">as</span> f:
    <span class="hljs-comment"># loop with .read() or .readline() to stream data</span>
    <span class="hljs-comment"># or do random access with .seek()</span>
</code></pre>
<p>将 <code>HfFileSystem</code> 传入 PyTorch 的 <code>DataLoader</code> 时，会<strong>复用 <code>.ls()</code> 和 <code>.glob()</code> 的缓存结果</strong>，从而<strong>避免在列举数据文件时产生额外的网络请求</strong>，进一步提升流式加载的效率和稳定性。</p>
<h2 data-id="heading-8">极限测试：我们把它用在 nanoVLM 上了！</h2>
<p>目前我们正在使用这些流式优化功能训练下一代 SmolVLM 模型。得益于新改进，流式加载比我们集群上的多层硬盘系统还要快，<strong>几乎等同于从本地 SSD 读取数据的速度</strong>！</p>
<p>过去，为了避免慢速网络，我们还要把数据拷贝到本地 SSD——整个过程花费 3 小时。而现在，直接流式加载，训练马上开始！</p>
<p>更多细节请看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2FnanoVLM" target="_blank" title="https://github.com/huggingface/nanoVLM" ref="nofollow noopener noreferrer">nanoVLM GitHub</a></p>
<h2 data-id="heading-9">快速上手，立见成效</h2>
<p>这些强大的新功能已经集成到 <code>datasets</code> 和 <code>huggingface_hub</code> 库中。想要体验全新的流式加载性能，只需升级你的库版本，并查阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Fdatasets%2Fstream" target="_blank" title="https://huggingface.co/docs/datasets/stream" ref="nofollow noopener noreferrer">官方文档</a>即可开始使用：</p>
<pre><code class="hljs language-bash" lang="bash">pip install --upgrade datasets huggingface_hub
</code></pre>
<p>为庆祝这一更新，我们已将 FineVision 所有数据源合并并预先打乱成一个统一数据集：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdatasets%2FHuggingFaceM4%2FFineVisionMax" target="_blank" title="https://huggingface.co/datasets/HuggingFaceM4/FineVisionMax" ref="nofollow noopener noreferrer">FineVisionMax</a>。你可以直接用它来训练 VLM 模型，无需手动处理多个数据集！</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset

<span class="hljs-comment"># Stream a dataset instead of downloading it</span>
dataset = load_dataset(<span class="hljs-string">"HuggingFaceM4/FineVisionMax"</span>, split=<span class="hljs-string">"train"</span>, streaming=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># Get the first example</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(<span class="hljs-built_in">iter</span>(dataset)))
</code></pre>
<p>想了解我们是如何大规模运行的？欢迎查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2FnanoVLM" target="_blank" title="https://github.com/huggingface/nanoVLM" ref="nofollow noopener noreferrer">nanoVLM 项目</a></p>
<p>祝你流式加载愉快！🤗</p>
<blockquote>
<p>英文原文: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fblog%2Fstreaming-datasets" target="_blank" title="https://huggingface.co/blog/streaming-datasets" ref="nofollow noopener noreferrer">huggingface.co/blog/stream…</a></p>
<p>原文作者: Andres Marafioti, Quentin Lhoest, ben burtenshaw, Pedro Cuenca, merve</p>
<p>译者: Luke,  Hugging Face Fellow</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[机器学习，KNN 算法]]></title>    <link>https://juejin.cn/post/7585928504950030372</link>    <guid>https://juejin.cn/post/7585928504950030372</guid>    <pubDate>2025-12-22T06:49:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585928504950030372" data-draft-id="7581413562486308870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="机器学习，KNN 算法"/> <meta itemprop="keywords" content="Python,机器学习,后端"/> <meta itemprop="datePublished" content="2025-12-22T06:49:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            机器学习，KNN 算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:49:11.000Z" title="Mon Dec 22 2025 06:49:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">机器学习概述</h2>
<h3 data-id="heading-1">人工智能三大概念</h3>
<ul>
<li>AL：人工智能，机器模拟人类</li>
<li>ML：机器学习，能像人一样思考</li>
<li>DL：深度学习，像人一样活动</li>
</ul>
<blockquote>
<p>机器学习的概念</p>
</blockquote>
<p>让机器自动学习，而不是基于规则的编程</p>
<blockquote>
<p>深度学习</p>
</blockquote>
<p>也叫深度神经网络，大脑仿生，设计一层一层的神经元模拟万事万物</p>
<blockquote>
<p>三者之间的关系</p>
</blockquote>
<ul>
<li>机器学习是实现人工智能的一种途径</li>
<li>深度学习是机器学习的一种方法</li>
</ul>
<h3 data-id="heading-2">学习方式</h3>
<p>基于规则，这没什么好解释的，就是自己指定规则，严格按照规则。</p>
<p><strong>基于模型的学习</strong></p>
<p>让机器自己学习从历史数据中获得经验、训练模型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f7f36e58b434d0496a037893bc228a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=dhZv1%2FTtLsLPlC5cfVw0HcSYT8Y%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">发展史</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/376e95a5b7e44e2f92437ebad2cd0676~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=PfvnwyEADnQEAdFg4sJdzztoUW0%3D" alt="image.png" loading="lazy"/></p>
<p>1956年夏季，以麦卡赛、明斯基、罗切斯特和申农等为首的一批有远见卓识的年轻科学家在一起聚会，共同研究和探讨用机器模拟智能的一系列有关问题，并首次提出了“人工智能”这一术语，它标志着“人工智能”这门新兴学科的正式诞生。</p>
<blockquote>
<p>1956 年被认为是人工智能元年</p>
</blockquote>
<p><strong>1950-1970</strong> 符号主义流派：专家系统占主导地位</p>
<p>1950：图灵设计国际象棋程序</p>
<p>1962：IBM Arthur Samuel 的跳棋程序战胜人类高手（人工智能第一次浪潮）</p>
<p><strong>1980-2000</strong></p>
<p>统计主义流派：主要用统计模型解决问题</p>
<p>1993：Vapnik提出SVM</p>
<p>1997：IBM 深蓝战胜卡斯帕罗夫（人工智能第二次浪潮）</p>
<p><strong>2010-2017</strong></p>
<p>神经网络、深度学习流派</p>
<p>2012：AlexNet深度学习的开山之作</p>
<p>2016：Google AlphaGO 战胜李世石（人工智能第三次浪潮）</p>
<p><strong>2017-至今</strong></p>
<p>大规模预训练模型</p>
<p>2017年，自然语言处理NLP的Transformer框架出现</p>
<p>2018年，Bert和GPT的出现</p>
<p>2022年，chatGPT的出现，进入到大规模模型AIGC发展的阶段</p>
<h3 data-id="heading-4">机器学习发展三要素</h3>
<p>数据、算法、算力三要素相互作用，是AI发展的基石</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfa14855a7dd40acb4678f048e306eaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=If88yIgU36t8LgHXrO002pdg8VM%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>CPU：负责调度任务、计算任务等；主要适合I\O密集型的任务</li>
<li>GPU：更加适合矩阵运算；主要适合计算密集型任务</li>
<li>TPU：Tensor，专门针对神经网络训练设计一款处理器</li>
</ol>
<h3 data-id="heading-5">常用术语</h3>
<blockquote>
<p>样本，特征，标签/目标值</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b83af0fab9d948a5b91d074d66cef10e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=8RTHRm4cXHmRkRZw8b37DluvVpo%3D" alt="image.png" loading="lazy"/></p>
<p>假设就业薪资是计算出来的。那么就业薪资就是<strong>标签</strong>。</p>
<p>对于整个结果叫做数据集</p>
<p>还有一种叫，我们针对于整个训练集，分为，正式和测试，正式数据叫<strong>train</strong>，测试数据叫<strong>test</strong>。比如对于<strong>标签</strong>的测试数据，我们可以说：<strong>y_test</strong>，对于<strong>样本</strong>的测试数据，可以说：<strong>x_test</strong></p>
<h3 data-id="heading-6">算法分类</h3>
<h4 data-id="heading-7">有监督学习是：<strong>有特征、有标签</strong></h4>
<p>即输入的数据是由特征值目标值组成的。如下图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d109380d48e4dcd8ca8137d83ef364b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=0VgkUpVDYcHD5EXW4KVYtaJJhlU%3D" alt="image.png" loading="lazy"/></p>
<p>又可以分为：<strong>连续或者不连续</strong></p>
<ul>
<li>连续的采用：回归</li>
<li>不连续的采用：分类</li>
</ul>
<blockquote>
<p>不连续 = 分类</p>
</blockquote>
<p>为什么叫分类呢，没有特定关系。比如要预测的结果是，好评/中评/差评，没有关系，不能排序。又分为了<strong>二分类和多分类</strong></p>
<ul>
<li>二分类：比如 猫/非猫</li>
<li>多分类：好评/中评/差评等等</li>
</ul>
<p>这个值又叫离散值。</p>
<blockquote>
<p>连续 = 回归</p>
</blockquote>
<p>根据一些特征，可以推断出一个具体的数值。</p>
<p>比如房子的面积、楼层、位置，可以推断出价格。</p>
<h4 data-id="heading-8">无监督学习是：<strong>有特征、无标签</strong></h4>
<p>即输入的数据，没有被标记，未知的类型，没有标签。</p>
<p>会产生<strong>聚类问题</strong></p>
<p>根据样本间的相似性对样本进行聚类，发现事物内部结构及相互关系。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0a41d3ab68d468cac48f1311178e2ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=89DZDakgxCXURXjdc%2Fnqd0RMc7E%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">半监督学习</h4>
<p>工作流程</p>
<ol>
<li>让专家标注少量数据，利用已经标注的数据（也就是带有标签的数据）训练出一个模型</li>
<li>再利用该模型去套用未标记的数据，<strong>结果并不完全正确</strong></li>
<li>通过询问领域专家分类结果与模型做对比，<strong>我们只需要对结果进行整改</strong>，从而对模型做进一步改善和提高。</li>
</ol>
<blockquote>
<p>意义是降低专家数据标注的次数，用于提高效率。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f01be3e9f204d4a88dd9da3289d2519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=%2BTp4Ubuhjwlstx9%2BVJr9BNjNjqQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">强化学习</h4>
<ol>
<li>强化学习（Reinforcement Learning）：机器学习的一个重要分支</li>
<li>应用场景：里程碑AlphaGo围棋、各类游戏、对抗比赛、无人驾驶场景</li>
</ol>
<p>是针对深度学习使用的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e6aea944a8146fba9361df19d4044b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=1d0OieFXzEJhhhr%2F8rvb7ndsSME%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/177ae0b444ed4e28b3b358624820cdc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=U8w7HJ3sb%2FzHBHgKOEisi88i8pg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a4fcee876be4549a013b09a866e93e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=0gEvMC8i%2FVHfkQgN3K%2BpX0RAPuk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">建模流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12add4dd54b04308af6364ac05cef43c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=Pl4atUC4ZL6%2BmGEoJrttyxwp3GU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0b6d0f1d47a4a2ab3c39a5a8d677e88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=GZOb6r6CRnKDqIKgtn5eaR98rfA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>在整个建模流程中，数据基本处理、特征工程一般是耗时、耗精力最多的。</strong></p>
<blockquote>
<p>有监督学习模型训练和模型预测</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b4670ed64084f65a5ee1d9d8f32b305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=Qk04PHJN7CxcXArQKqrInjzxWOg%3D" alt="image.png" loading="lazy"/></p>
<p><strong>机器学习建模的一般步骤</strong></p>
<ul>
<li>获取数据：搜集与完成机器学习任务相关的数据集</li>
<li>数据基本处理：数据集中异常值,缺失值的处理等</li>
<li>特征工程：对数据特征进行提取、转成向量，让模型达到最好的效果</li>
<li>机器学习(模型训练)：选择合适的算法对模型进行训练
<ul>
<li>根据不同的任务来选中不同的算法；有监督学习,无监督学习,半监督学习,强化学习</li>
</ul>
</li>
<li>模型评估：评估效果好上线服务,评估效果不好则重复上述步骤</li>
</ul>
<h3 data-id="heading-12">特征工程</h3>
<p>下面将用房子举例说明：</p>
<blockquote>
<p>什么是特征</p>
</blockquote>
<p>描述了房子的多个参数，比如面积、位置、楼层等等。</p>
<p>利用专业背景知识和技巧处理数据，让机器学习算法效果最好。这个过程就是<strong>特征工程。</strong></p>
<p>数据和特征决定了机器学习的上限，而模型和算法只是逼近这个上限而已。</p>
<p><strong>特征提取</strong></p>
<p>特征提取从无到有的做行列向量数据</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/997c9f037f0b48739692b1380e6ad3d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=NuwmHaTR4qs61IS0Qewv3t90kvg%3D" alt="image.png" loading="lazy"/></p>
<p>这一步要做一些处理：如归一化，标准化</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/980433382ee84bf69e69c98bdfe6ec77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=QKo5q5D2PzkwX%2FfpXaUnySas6O8%3D" alt="image.png" loading="lazy"/></p>
<p><strong>特征降维</strong></p>
<p>将数据从<strong>3个特征</strong>变成<strong>2个特征</strong>。一般会对原始数据产生影响。</p>
<p>比如：数据库里的有三张表，合并成一张表叫<strong>宽表（记录了三个表的核心字段）</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66f44396566c47d090389670b9f57e83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=qBh77GIksVMgtMxEGs0FryFIPTc%3D" alt="image.png" loading="lazy"/></p>
<p><strong>特征选择</strong></p>
<p>特征提取后，有很多特征，需要从众多特征中选取较为重要的特征，叫做<strong>特征选择。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf84b3831c21459e9141d2599979c300~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=bCwB5lD2pCc96uA%2BlDSlw6ffRsA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>特征组合</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b4eb3bb86841de885c7264b43da26a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=cu0Ps7Qeu3ZPtPbfg3IOAgmjNKQ%3D" alt="image.png" loading="lazy"/></p>
<p>总结</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a4610c755c3432c856a050778d1c4ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=hNAyFe%2FGPSB1Kv48laiPf1I1mfM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">拟合</h3>
<ul>
<li>拟合：用在机器学习领域，用来表示模型对样本点的拟合情况</li>
<li>欠拟合：模型在训练集上表现很差、在测试集表现也很差</li>
<li>过拟合：模型在训练集上表现很好、在测试集表现很差</li>
</ul>
<blockquote>
<p>欠拟合例子</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d005ecc8eb274f21bb6e7826f204826b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=82isfbIMyk%2B5Fv4oCHe%2Bwp3p0wg%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>过拟合</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f8b9943f65e44a7938844676fcfc6c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=kUW%2Fa%2BbDqHAss82c3irx3MJ5RLM%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>欠拟合产生的原因：模型过于简单</li>
<li>过拟合产的原因：模型太过于复杂、数据不纯、训练数据太少</li>
</ul>
<p>泛化：模型在新数据集（非训练数据）上的表现好坏的能力。</p>
<p>奥卡姆剃刀原则：给定两个具有相同泛化误差的模型，较简单的模型比较复杂的模型更可取</p>
<p>下面是一张表达了，拟合关系的图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2e83308274b4b32b14c0c6c8ec83012~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=tYb3VOg7u04r8CkmPt5EIu2NO94%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">开发环境搭建 scikit-learn</h2>
<ul>
<li>简单高效的数据挖掘和数据分析工具</li>
<li>可供大家使用，可在各种环境中重复使用</li>
<li>建立在NumPy，SciPy和matplotlib上</li>
<li>开源，可商业使用-获取BSD许可证</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pip install scikit-learn
</code></pre>
<blockquote>
<p>机器学习的流程</p>
</blockquote>
<ol>
<li>数据准备</li>
<li>数据预处理</li>
<li>特征工程
<ol>
<li>特征提取</li>
<li>特征预处理</li>
<li>特征降维</li>
<li>特征选取</li>
<li>特征组合</li>
</ol>
</li>
<li>模型训练</li>
<li>模型评估</li>
<li>模型预测</li>
</ol>
<p>官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fscikit-learn.org%2Fstable%2Findex.html" target="_blank" title="https://scikit-learn.org/stable/index.html" ref="nofollow noopener noreferrer">scikit-learn.org/stable/inde…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74fa17ed44894aab9b6465071f5469d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=zmqDkFHI44swY8TaS5RrYk6Ppbo%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>算法选择路线</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0edc95ae55b414499d7815113917b59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=TBxk2OJ2qfrLqwBPVCYTJwHdT3M%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">knn 算法</h2>
<p>knn算法也叫<strong>k近邻算法</strong>，是属于分类的一种。</p>
<p>knn思想：如果一个样本在特征空间中的 <strong>k 个最相似的样本</strong>中的大多数属于某一个类别，则该样本也属于这个类别</p>
<p>它既可以做分类也可以做回归，那是怎么做的呢，就是找到离你最近，最相似的样本。</p>
<p>假设我们有五个样本，这个时候就有两个问题，第一个叫分类，第二个叫回归。</p>
<ul>
<li>分类是离你最近的五个样本投票，那个多，你就是谁。</li>
<li>回归是根据票数进行排序，找到最小值（具体算法不一定）</li>
</ul>
<h4 data-id="heading-16">分类 K 近邻算法</h4>
<p>样本相似性：样本都是属于一个任务数据集的。样本距离越近则越相似。</p>
<p><strong>欧式距离：对应坐标轴差值平方和开根号</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a125242c0864ef1871be68e0aa4a698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=m0x1E7L45pgFESzX%2FVwYp8VZl6E%3D" alt="image.png" loading="lazy"/></p>
<p>二维平面上点a(x₁,y₁)与b(x₂,y₂)间的欧氏距离：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>12</mn></msub><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo>−</mo><msub><mi>x</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>−</mo><msub><mi>y</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d_{12} = \sqrt{(x_1 - x_2 )^2 + (y_1 - y_2)^2} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span/></span></span></span></span></span></span></span></span></p>
<p>三维空间点<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">a(x_1,y_1,z_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>与<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">b(x_2,y_2,z_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>间的欧氏距离为</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>12</mn></msub><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo>−</mo><msub><mi>x</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo>−</mo><msub><mi>y</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>z</mi><mn>1</mn></msub><mo>−</mo><msub><mi>z</mi><mn>2</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d_{12} = \sqrt{(x_1 - x_2)^2 + (y_1 - y_2)^2 + (z_1 - z_2)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span/></span></span></span></span></span></span></span></span></p>
<p>n维空间点<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>11</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>12</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mrow><mn>1</mn><mi>n</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">a(x_{11},x_{12},\dots,x_{1n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>与<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>21</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>22</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>n</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">b(x_{21},x_{22},\dots,x_{2n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">b</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>（两个n维向量）间的欧氏距离为</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>12</mn></msub><mo>=</mo><msqrt><mrow><msubsup><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mo stretchy="false">(</mo><msub><mi>x</mi><mrow><mn>1</mn><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>k</mi></mrow></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d_{12} = \sqrt{\sum_{k=1}^{n} (x_{1k} - x_{2k})^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.3027em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9373em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.8973em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3027em;"><span/></span></span></span></span></span></span></span></span>。</p>
<blockquote>
<p>案例，计算过程</p>
</blockquote>
<p>求，唐人街探案的欧氏距离，对比功夫熊猫。</p>
<p>谁减去谁不重要，因为开根号可以避免，这里就使用大的减去小的。</p>
<ol>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mrow><mo stretchy="false">(</mo><mn>39</mn><mo>−</mo><mn>23</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>256</mn><mo>+</mo><mo stretchy="false">(</mo><mn>3</mn><mo>−</mo><mn>0</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>9</mn><mo>+</mo><mo stretchy="false">(</mo><mn>31</mn><mo>−</mo><mn>17</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>196</mn></mrow></msqrt><mo>=</mo><mn>461</mn><mo>=</mo><mn>21.47</mn></mrow><annotation encoding="application/x-tex">\sqrt{(39-23)^2=256 + (3-0)^2=9 + (31-17)^2 = 196} = 461 = 21.47</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.305em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.935em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord">39</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">23</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">256</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">0</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">9</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord">31</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord">17</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord">196</span></span></span><span style="top:-2.895em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.305em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">461</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">21.47</span></span></span></span></span></li>
<li>如果 k = 5，将要计算5个最小值排序的情况。将这个五个值，相加平方开根号的过程。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0beebfe7d6645fab94d718a1fd5cc5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=E2dAPhIkfSAfZjiRDwjZASj9nlI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-17">回归 K 值选择</h4>
<p>K值过小：用较小邻域中的训练实例进行预测</p>
<ul>
<li>容易受到异常点的影响</li>
<li>K值的减小就意味着整体模型变得复杂，容易发生过拟合</li>
</ul>
<p><strong>样本越多，KNN 越稳定，K 越大，越能抵抗噪声，样本越少 + K 越小，最容易被误导。</strong></p>
<p>K值过大：用较大邻域中的训练实例进行预测</p>
<ul>
<li>受到样本均衡的问题</li>
<li>且K值的增大就意味着整体的模型变得简单，欠拟合</li>
</ul>
<p><strong>样本少时，K 一大，预测永远是最多类别。</strong></p>
<h4 data-id="heading-18">超参与交叉验证</h4>
<p>超惨是指用户传递过来的参数</p>
<p>统计k中样本最多的那个类别，将未知样本归属于该类别。</p>
<ol>
<li>计算未知样本到每一个训练样本的距离</li>
<li>将训练样本根据距离大小升序排列</li>
<li>取出距离最近的 K 个训练样本</li>
<li>进行多数表决，统计 K 个样本中哪个类别的样本个数最多</li>
<li>将未知的样本归属到出现次数最多的类别</li>
</ol>
<blockquote>
<p>回归问题的处理流程：</p>
</blockquote>
<ol>
<li>计算未知样本到每一个训练样本的距离</li>
<li>将训练样本根据距离大小升序排列</li>
<li>取出距离最近的 K 个训练样本</li>
<li>把这个 K 个样本的目标值计算其平均值</li>
<li>作为将未知的样本预测的值</li>
</ol>
<p>注意类别型的，字符串形式没有办法求平均值。</p>
<p>实际工作中经常使用交叉验证的方式，并且大部分k值较小。</p>
<blockquote>
<p>knn 是寻找与未知样本最近距离的k个样本，采用的是欧式距离</p>
</blockquote>
<h4 data-id="heading-19">KNN 分类算法实现</h4>
<p>概述：找距离测试集最近的K个样本，进行投票，标签最多，就用它作为测试集的结果。</p>
<ul>
<li>思路1：分类思路，投票选最多的</li>
<li>思路2：回归思路，求均值</li>
</ul>
<p>分类思路</p>
<ol>
<li>基于欧式距离计算每个训练集，距离测试集的距离
<ul>
<li>欧氏距离：对应维度差值的平方和，开平方根</li>
</ul>
</li>
<li>按照距离值，进行升序排列，找到距离最小的那K个样本</li>
<li>分类思路：投票选举，票数最多的标签值 -&gt; 作为测试集的标签。
<ul>
<li>如果标签票数一样，参考最简单的模型，就是距离最近的那个结果。奥卡姆剃刀</li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a81d815141644e696fba4782d6b3fb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=0DW7gfGkhhZQQrFWE4Ix1HRwshI%3D" alt="image.png" loading="lazy"/></p>
<p>为什么预测结果是1呢，首先，看最近的3个邻居，那么最后是，0，1，1。于是1大于0，结果是1。</p>
<p>那如果看最近的2个邻居，一个 0 ， 1，取那个呢，不要看顺序，它会取0，为什么，因为 0 小，它取最小值。</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-comment"># 导入 KNN 分类对象</span>
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier

<span class="hljs-comment"># 参考3个最近的K</span>
estimator = KNeighborsClassifier(n_neighbors=<span class="hljs-number">3</span>)

<span class="hljs-comment"># 准备数据集</span>
x_train = [[<span class="hljs-number">1</span>], [<span class="hljs-number">2</span>], [<span class="hljs-number">3</span>], [<span class="hljs-number">4</span>]]
y_train = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]  <span class="hljs-comment"># 分类法：2分法</span>

<span class="hljs-comment"># 准备测试集</span>
x_test = [[<span class="hljs-number">5</span>]]

<span class="hljs-comment"># 模型训练</span>
estimator.fit(x_train, y_train)

<span class="hljs-comment"># 模型预测，获取测试集的预测标签</span>
y_test = estimator.predict(x_test)

<span class="hljs-built_in">print</span>(y_test)
</code></pre>
<h4 data-id="heading-20">KNN 回归算法实现</h4>
<p>为什么结果是 0.15 呢。</p>
<p>找到距离最小的样本是，0.1 和 0.2</p>
<p>那相加 / 2 = 0.15</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-comment"># 导入 KNN 回归算法</span>
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsRegressor

<span class="hljs-comment"># 参考2个最近的K</span>
estimator = KNeighborsRegressor(n_neighbors=<span class="hljs-number">2</span>)

<span class="hljs-comment"># 准备数据集</span>

<span class="hljs-comment"># 验证</span>
<span class="hljs-comment"># 差值：     (9,17,8)      (10,5,1)     (20, 6, 2)   (18, 12, 5)</span>
<span class="hljs-comment"># 平方和       434           126           440          493</span>
<span class="hljs-comment"># 开平方根     20.83         11.22         20.98        22.20</span>
x_train = [[<span class="hljs-number">12</span>, <span class="hljs-number">27</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">13</span>, <span class="hljs-number">15</span>, <span class="hljs-number">10</span>], [<span class="hljs-number">23</span>, <span class="hljs-number">16</span>, <span class="hljs-number">9</span>], [<span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">6</span>]]
y_train = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.4</span>]

<span class="hljs-comment"># 准备测试集</span>
x_test = [[<span class="hljs-number">3</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]]

<span class="hljs-comment"># 模型训练</span>
estimator.fit(x_train, y_train)

<span class="hljs-comment"># 模型预测，获取测试集的预测结果</span>
y_test = estimator.predict(x_test)

<span class="hljs-built_in">print</span>(y_test)
</code></pre>
<h3 data-id="heading-21">距离计算方法</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61ee82a130c740ee8b2e0c73b1f4f4ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=15u4omMTY2YcOJIPPZ%2BJAXOep9k%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-22">曼哈顿距离</h4>
<p>也称为<strong>城市街区距离</strong>，曼哈顿城市特点：横平竖直</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>12</mn></msub><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><mrow><mo fence="true">∣</mo><msub><mi>x</mi><mrow><mn>1</mn><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>k</mi></mrow></msub><mo fence="true">∣</mo></mrow></mrow><annotation encoding="application/x-tex">d_{12} = \sum_{k=1}^{n} \left| x_{1k} - x_{2k} \right|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">∣</span></span></span></span></span></span></p>
<p>举个例子：ABCD四点 X=[ [1,1], [2,2], [3,3], [4,4] ]</p>
<p>计算AB AC AD BC BD曼哈顿距离</p>
<p>经计算得: AB =|2−1|+ ⌈2−1⌉= 2</p>
<p>d = 2 4 6 2 4 2</p>
<p>为什么是这样呢，如下图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34a566bc179a42c28ccfa89a2ad5afcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=3823Fn1PLFfT97PrsPfqZi79FGQ%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>从 0 到 6的位置，走完x是六步，走完y是6步。</li>
<li>用 x和y 的 6 - 0，相加刚好是12。</li>
</ol>
<h4 data-id="heading-23">切比雪夫距离</h4>
<p>和曼哈顿距离有点像，曼哈顿不会斜着走，而切比雪夫是可以的，先斜着走，再直线距离。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31a695d2719e425d940a5be4e10123da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=XyxfrMO9L3wBMKc6%2B0bhbXAlwEQ%3D" alt="image.png" loading="lazy"/></p>
<p>其中 i 表示多个，可以用多组绝对值计算，i 表示的是维度索引，是一组而不是一个</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>12</mn></msub><mo>=</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mrow><mo fence="true">∣</mo><msub><mi>x</mi><mrow><mn>1</mn><mi>i</mi></mrow></msub><mo>−</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>i</mi></mrow></msub><mo fence="true">∣</mo></mrow><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d_{12} = max(\left| x_{1i} - x_{2i} \right|)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="minner"><span class="mopen delimcenter" style="top:0em;">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">∣</span></span><span class="mclose">)</span></span></span></span></span></p>
<h4 data-id="heading-24">闵可夫斯基距离</h4>
<p>不是一种新的距离的度量方式。</p>
<p>是对多个距离度量公式的概括性的表述</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mn>12</mn></msub><mo>=</mo><mroot><mrow><msubsup><mo>∑</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msup><mrow><mo fence="true">∣</mo><msub><mi>x</mi><mrow><mn>1</mn><mi>k</mi></mrow></msub><mo>−</mo><msub><mi>x</mi><mrow><mn>2</mn><mi>k</mi></mrow></msub><mo fence="true">∣</mo></mrow><mi>p</mi></msup></mrow><mi>p</mi></mroot></mrow><annotation encoding="application/x-tex">d_{12} = \sqrt[p]{\sum_{k=1}^n \left| x_{1k} - x_{2k} \right| ^p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.3027em;"/><span class="mord sqrt"><span class="root"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.596em;"><span style="top:-2.8807em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size6 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9373em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;">∣</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">∣</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span></span></span></span></span></span></span><span style="top:-2.8973em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3027em;"><span/></span></span></span></span></span></span></span></span></p>
<p>其中p是一个变参数：</p>
<ul>
<li>当 p=1 时，就是曼哈顿距离</li>
<li>当 p=2 时，就是欧氏距离</li>
<li>当 p→∞ 时，就是切比雪夫距离</li>
</ul>
<p>根据 p 的不同，闵氏距离可表示某一类种的距离</p>
<h3 data-id="heading-25">特征预处理</h3>
<h4 data-id="heading-26">归一化</h4>
<p>特征的<strong>单位或者大小相差较大，或者某特征的方差相比其他的特征要大出几个数量级</strong>，<strong>容易影响（支配）目标结果</strong>，使得一些模型（算法）无法学习到其它的特征。</p>
<p>其实也就是脏数据，比如没有人的身高3米多，也没有人的体重800斤。要对这些脏数据进行处理。</p>
<p>公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mfrac><mrow><mi>x</mi><mo>−</mo><mi>m</mi><mi>i</mi><mi>n</mi></mrow><mrow><mi>m</mi><mi>a</mi><mi>x</mi><mo>−</mo><mi>m</mi><mi>i</mi><mi>n</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">x' = \frac{x - min}{max - min}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.259em;vertical-align:-0.4033em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8557em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">min</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">min</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4033em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>归一化后的值（范围在 [0,1]）</p>
<blockquote>
<p>上面能计算出归一化的值，当然也能反归一化，也就是逆向还原。</p>
</blockquote>
<p>Min-Max标准化的区间映射公式：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mrow><mo mathvariant="normal">′</mo><mo mathvariant="normal">′</mo></mrow></msup><mo>=</mo><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>∗</mo><mo stretchy="false">(</mo><mi>m</mi><mi>x</mi><mo>−</mo><mi>m</mi><mi>i</mi><mo stretchy="false">)</mo><mo>+</mo><mi>m</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">x'' = x' * (mx - mi) + mi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">mi</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">mi</span></span></span></span></span></p>
<p>这里有个特别注意的点：mx 和 mi，是区间最小值和最大值，是自己指定的，希望压到多大和多小。</p>
<p>解释：
公式解释</p>
<ul>
<li>x：特征列中，某个具体要计算的值。</li>
<li>min：该特征列的最小值。</li>
<li>max：该特征列的最大值。</li>
<li>mx：区间的最大值，默认的区间是 [0,1]，即：mx=1</li>
<li>mi：区间的最小值，默认的区间是 [0,1]，即：mi=0</li>
</ul>
<p><strong>归一化的弊端：</strong></p>
<p>即使该特征列的数据再多，也只会受到该列的最大值，最小值的影响，可能导致：数据不均衡。</p>
<p>如果最大值或者最小值又恰巧是异常值，就会导致计算结果偏差，又叫<strong>鲁棒性较差</strong></p>
<blockquote>
<p>案例，假设区间是，5，3</p>
</blockquote>
<pre><code class="hljs language-py" lang="py"><span class="hljs-comment"># 导入归一化的包</span>
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> MinMaxScaler

<span class="hljs-comment"># 创建数据集</span>
x_train = [[<span class="hljs-number">90</span>, <span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">40</span>], [<span class="hljs-number">60</span>, <span class="hljs-number">4</span>, <span class="hljs-number">15</span>, <span class="hljs-number">45</span>], [<span class="hljs-number">75</span>, <span class="hljs-number">3</span>, <span class="hljs-number">13</span>, <span class="hljs-number">46</span>]]

<span class="hljs-comment"># 创建归一化对象</span>
<span class="hljs-comment"># 解释：feature_range 表示区间，这里设置为3，5，默认是 0，1</span>
transfer = MinMaxScaler(feature_range=(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>))

<span class="hljs-comment"># 执行归一化操作</span>
<span class="hljs-comment"># fit_transform 针对于训练集的，即：训练 + 转换（归一化）</span>
<span class="hljs-comment"># fit 针对测试集，只有转换，归一化，返回归一化对象</span>
x_train_new = transfer.fit_transform(x_train)
<span class="hljs-comment"># transfer.fit(x_train)</span>
<span class="hljs-built_in">print</span>(x_train_new)
</code></pre>
<p>跑完答案</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d6a1b85e5b340c39c5129eae9c4f9c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=ajyCTtDGKOFqUbDC6fnm%2Bo5Y0Sg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37ff7391fd13469f9498f1eb457734b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=MaUjehWUvyvRcFtXgrtn%2Bm7iEwI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>适用于小数据集的运算。</strong></p>
<h4 data-id="heading-27">标准化</h4>
<p>计算公式</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mfrac><mrow><mo stretchy="false">(</mo><mi>x</mi><mo>−</mo><mi>m</mi><mi>e</mi><mi>a</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><mi>σ</mi></mfrac></mrow><annotation encoding="application/x-tex">x' = \frac{(x - mean)}{σ}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.355em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">an</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p>它适合于大数据集的应用场景。一般用标准化处理。</p>
<p>注意：数据计算是按列算的，比如：90，60，75</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-comment"># 导入标准化的包</span>
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-comment"># 创建数据集</span>
x_train = [[<span class="hljs-number">90</span>, <span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">40</span>], [<span class="hljs-number">60</span>, <span class="hljs-number">4</span>, <span class="hljs-number">15</span>, <span class="hljs-number">45</span>], [<span class="hljs-number">75</span>, <span class="hljs-number">3</span>, <span class="hljs-number">13</span>, <span class="hljs-number">46</span>]]

<span class="hljs-comment"># 创建标准化对象</span>
transfer = StandardScaler()

<span class="hljs-comment"># 执行标准化操作</span>
<span class="hljs-comment"># fit_transform 针对于训练集的，即：训练 + 转换（标准化）</span>
<span class="hljs-comment"># fit 针对测试集，只有转换，标准化，返回标准化对象</span>
x_train_new = transfer.fit_transform(x_train)
<span class="hljs-comment"># transfer.fit(x_train)</span>
<span class="hljs-comment"># print(x_train_new)</span>

<span class="hljs-comment"># 查看方差</span>
<span class="hljs-built_in">print</span>(transfer.var_)
<span class="hljs-comment"># 查看平均值</span>
<span class="hljs-built_in">print</span>(transfer.mean_)
<span class="hljs-comment"># 查看标准差</span>
<span class="hljs-built_in">print</span>(transfer.scale_)
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2de03eea8724379b484a4e14374421c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=5rsRqn8V2d99c8%2FWjppiv9ToZLk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-28">总结</h4>
<p>数据归一化</p>
<ul>
<li>如果出现异常点，影响了最大值和最小值，那么结果显然会发生改变</li>
<li>应用场景：最大值与最小值非常容易受异常点影响，鲁棒性较差，只适合传统精确小数据场景</li>
</ul>
<p>数据标准化</p>
<ul>
<li>如果出现异常点，由于具有一定数据量，少量的异常点对于平均值的影响并不大</li>
<li>应用场景：适合现代嘈杂大数据场景。(以后就是用你了）</li>
</ul>
<h3 data-id="heading-29">利用KNN算法对鸢尾花分类</h3>
<p>实现流程：</p>
<ol>
<li>获取数据集</li>
<li>数据基本处理</li>
<li>数据集预处理-数据标准化</li>
<li>机器学习(模型训练)</li>
<li>模型评估</li>
<li>模型预测</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/632f538abd4c47ea9f66bc6ac355791c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=%2BJGgIfj53nQbMBGjP8F%2BNU55ZF0%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dfb235c4f7c49ccaaaf958c287a4777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=77aE7DMAwJDiDPDVltu27Ca09Xk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-30">查看数据</h4>
<ul>
<li>x_train 是数据集，对应 data</li>
<li>y_train 是标签集，对应 target</li>
<li>target_names 是标签的语义</li>
</ul>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_load_iris</span>():
    iris_data = load_iris()

    <span class="hljs-comment"># iris_data，结果是字典。</span>
    <span class="hljs-comment"># print(iris_data)</span>

    <span class="hljs-comment"># 查看数据集，即：特征列，分别是：sepal length (cm) sepal width (cm) petal length (cm) petal width (cm)</span>
    <span class="hljs-comment"># print(iris_data.data[:5])</span>

    <span class="hljs-comment"># 查看数据集，即标签列</span>
    <span class="hljs-comment"># print(iris_data.target[:5])</span>

    <span class="hljs-comment"># 查特征列，标签列，即数据集的条数</span>
    <span class="hljs-comment"># print(len(iris_data.data), len(iris_data.target))</span>

    <span class="hljs-comment"># 查看数据集的列名</span>
    <span class="hljs-comment"># print(iris_data.feature_names)</span>

    <span class="hljs-comment"># 具体标签名 ['setosa' 'versicolor' 'virginica']</span>
    <span class="hljs-built_in">print</span>(iris_data.target_names)

    <span class="hljs-comment"># 查看所有 key 的名字</span>
    <span class="hljs-built_in">print</span>(iris_data.keys())

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment"># 加载数据集</span>
    test_load_iris()
</code></pre>
<h4 data-id="heading-31">转为 DataFrame 对象 / 绘制散点图</h4>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:

    <span class="hljs-comment"># 中文显示</span>
    plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>]  <span class="hljs-comment"># 黑体</span>
    plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>] = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 解决负号显示问题</span>


    <span class="hljs-comment"># 加载数据集</span>
    iris_data = load_iris()
    <span class="hljs-comment"># 封装成对象</span>
    frame = pd.DataFrame(data=iris_data.data, columns=iris_data.feature_names, )
    frame[<span class="hljs-string">'label'</span>] = iris_data.target

    <span class="hljs-comment"># 绘制成散点图</span>
    <span class="hljs-comment"># fit_reg 去除拟合回归线</span>
    sns.lmplot(data=frame, y=<span class="hljs-string">'petal width (cm)'</span>, x=<span class="hljs-string">'petal length (cm)'</span>,
               hue=<span class="hljs-string">'label'</span>, fit_reg=<span class="hljs-literal">False</span>)

    plt.title(<span class="hljs-string">'鸢尾花数据集展示'</span>)
    plt.show()
</code></pre>
<h4 data-id="heading-32">区分数据集和测试集</h4>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment"># 加载数据集</span>
    iris_data = load_iris()
    <span class="hljs-comment"># 特征是 data，标签是 target</span>

    <span class="hljs-comment"># 切分训练集和测试集</span>
    <span class="hljs-comment"># 参数1：要被切分的特征</span>
    <span class="hljs-comment"># 参数2：要被切分的标签</span>
    <span class="hljs-comment"># 参数3：测试集的比例，这里是20</span>
    <span class="hljs-comment"># 参数4：随机种子，种子一致</span>
    x_train, x_test, y_train, y_test = train_test_split(iris_data.data, iris_data.target, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">70</span>)

    <span class="hljs-comment"># 打印测试结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'训练集的特征: <span class="hljs-subst">{x_train}</span>'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'训练集的标签: <span class="hljs-subst">{y_train}</span>'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'训练集的条数: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(x_train)}</span>, <span class="hljs-subst">{<span class="hljs-built_in">len</span>(y_train)}</span>'</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'测试集的特征: <span class="hljs-subst">{x_test}</span>'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'测试集的标签: <span class="hljs-subst">{y_test}</span>'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'测试集的条数: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(x_test)}</span>, <span class="hljs-subst">{<span class="hljs-built_in">len</span>(y_test)}</span>'</span>)

</code></pre>
<h4 data-id="heading-33">模型预测和评估</h4>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment"># 1. 加载数据集</span>
    iris_data = load_iris()
    <span class="hljs-comment"># 2. 数据预处理</span>
    x_train, x_test, y_train, y_test = train_test_split(iris_data.data, iris_data.target, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">70</span>)

    <span class="hljs-comment"># 3. 特征工程</span>
    <span class="hljs-comment"># 此处无需手动实现，数据已经转换完毕，分别是：花萼的长度，花萼的宽度，花瓣的长度，花瓣的宽度</span>
    <span class="hljs-comment"># 字段名如下：sepal length (cm) sepal width (cm) petal length (cm) petal width (cm)</span>

    <span class="hljs-comment"># 4. 特征预处理（归一化、标准化），我们发现特征共 4 列，差值都不大。可以不做，这里学习一下。</span>
    <span class="hljs-comment"># 标准化</span>
    transfer = StandardScaler()
    <span class="hljs-comment"># 对于训练集数据，做训练+转换</span>
    x_train = transfer.fit_transform(x_train)
    <span class="hljs-comment"># 对于测试机数据 做转换</span>
    x_test = transfer.transform(x_test)

    <span class="hljs-comment"># 5. 特征降维、特征选取、特征组合、这里不需要做，因为数据比较简单</span>

    <span class="hljs-comment"># 6. 模型训练，选分类</span>
    estimator = KNeighborsClassifier(n_neighbors=<span class="hljs-number">5</span>)
    <span class="hljs-comment"># 具体训练代码</span>
    estimator.fit(x_test, y_test)

    <span class="hljs-comment"># 7. 模型预测</span>
    <span class="hljs-comment"># 对测试集进行数据预测</span>
    y_predict = estimator.predict(x_test)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'模型预测的结果为<span class="hljs-subst">{y_predict}</span>'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'测试集真实数据为<span class="hljs-subst">{y_test}</span>'</span>)

    <span class="hljs-comment"># 对新的数据集做测试</span>
    <span class="hljs-comment"># 准备新的数据集</span>
    x_test_new = [[<span class="hljs-number">3.6</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">0.3</span>]]
    <span class="hljs-comment"># 对新数据重新标准化处理</span>
    x_test_new = transfer.transform(x_test_new)
    <span class="hljs-comment"># 模型预测</span>
    y_predict_new = estimator.predict(x_test_new)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'模型预测结果为：<span class="hljs-subst">{y_predict_new}</span>'</span>)
    <span class="hljs-comment"># 查看上述的特征 -&gt; 各结果标签的 概率值，结果为 0 1 2，查看每个值的概率</span>
    y_predict_proba_new = estimator.predict_proba(x_test_new)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'模型预测概率结果为：<span class="hljs-subst">{y_predict_proba_new}</span>'</span>) <span class="hljs-comment"># 模型预测概率结果为：[[0.2 0.8 0. ]]，根据顺序，表示百分百80是 1 分类</span>

    <span class="hljs-comment"># 8. 模型评估</span>
    <span class="hljs-comment"># KNN 算法评估，主要参考 准确率，即：预测正确的数量 / 总数量</span>
    <span class="hljs-comment"># 方式一：针对于测试集的特征 和 测试集的标签，进行预测，一般不太准确，不建议使用</span>
    <span class="hljs-comment"># 这种方式可以预测前和预测后进行评估，因为没有用到 predict 的值</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'准确率：<span class="hljs-subst">{estimator.score(x_test, y_test)}</span>'</span>) <span class="hljs-comment"># 准确率：0.9666666666666667</span>

    <span class="hljs-comment"># 方式二：针对预测值（y_predict）和测试集的真实标签（y_test）进行评估</span>
    <span class="hljs-comment"># 主要是做模型预测后的评估</span>

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'模型准确率：<span class="hljs-subst">{accuracy_score(y_test, y_predict)}</span>'</span>) <span class="hljs-comment"># 模型准确率：0.9666666666666667</span>
</code></pre>
<h4 data-id="heading-34">fit_transform 和 transform 的区别</h4>
<p>fit_transform 是先基于训练集的特征做，拟合，例如获取均值，标准差，方差等信息，再基于内置好的模型(标准化)对象，调整参数，进行转换。</p>
<p>比如：</p>
<ul>
<li>StandardScaler → 计算每列的均值和标准差</li>
<li>MinMaxScaler → 计算每列的最小值和最大值</li>
<li>PCA → 计算协方差矩阵和特征向量</li>
</ul>
<p>上面这些，只会学习一次，后面直接使用这些参数。</p>
<blockquote>
</blockquote>
<p>而 transform</p>
<p>作用：使用 fit 学到的参数对数据进行转换</p>
<p>比如：</p>
<ul>
<li>标准化：(X - mean) / std</li>
<li>归一化：(X - min) / (max - min)</li>
</ul>
<p>不会重新计算均值/标准差，直接用已有参数。</p>
<blockquote>
<p>总结</p>
</blockquote>
<ul>
<li>fit_transform 再第一次使用</li>
</ul>
<h3 data-id="heading-35">交叉验证</h3>
<p>什么是交叉验证？</p>
<p>它是一种更加完善的，可信度更高的模型预估方式，思路是：把数据集分成 N 份，每次都取 1 份当作测试集，其他的当作训练集，然后计算模型的评分，接下来，再用下一份作为测试集，其他作为训练集，计算模型评分，分成几份，就进行几次计算，最后计算所有评分的均值，当做模型的最终评分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ed8d1e7e0bf42ec9a8547f60e8eb849~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=RgRYB4BKi7KNB9mHeJGsdYt5nQk%3D" alt="image.png" loading="lazy"/></p>
<p>交叉验证法原理：将数据集划分为 cv=4 份</p>
<ol>
<li>第一次：把第一份数据做验证集，其他数据做训练</li>
<li>第二次：把第二份数据做验证集，其他数据做训练</li>
<li>... 以此类推，总共训练4次，评估4次。</li>
<li>使用训练集+验证集多次评估模型，取平均值做交叉验证为模型得分</li>
<li>若k=5模型得分最好，再使用全部训练集(训练集+验证集) 对k=5模型再训练一遍，再使用测试集对k=5模型做评估</li>
</ol>
<p>好处：交叉验证的结果，比单一切分训练集和测试集，获取的评分结果，可信度更高</p>
<p>细节：</p>
<ol>
<li>把数据集分成 N 份，就叫 N折交叉验证。</li>
<li>交叉验证一般和网格搜索一起使用。</li>
</ol>
<p>交叉验证法，是划分数据集的一种方法，<strong>目的就是为了得到更加准确可信的模型评分。</strong></p>
<h3 data-id="heading-36">网格搜索</h3>
<p>为什么需要网格搜索？</p>
<ul>
<li>模型有很多超参数，其能力也存在很大的差异。需要手动产生很多超参数组合，来训练模型</li>
<li>每组超参数都采用交叉验证评估，最后选出最优参数组合建立模型。</li>
</ul>
<p>网格搜索是<strong>模型调参的有力工具</strong>。寻找最优超参数的工具！</p>
<p>只需要将<strong>若干参数</strong>传递给<strong>网格搜索对象</strong>，它自动帮我们完成不同超参数的组合、模型训练、模型评估，最终<strong>返回一组最优的超参数</strong>。</p>
<p>网络搜索就说寻找最优的超惨。</p>
<blockquote>
<p>网格搜索 + 交叉验证的强力组合 (模型选择和调优)</p>
</blockquote>
<ul>
<li>交叉验证解决模型的数据输入问题(数据集划分)得到更可靠的模型</li>
<li>网格搜索解决超参数的组合</li>
<li>两个组合再一起形成一个模型参数调优的解决方案</li>
</ul>
<p>总而言之，网络搜索 + 交叉验证目的就说为了寻找模型的最优解决方案，追求较高的效率。</p>
<h3 data-id="heading-37">交叉验证和网格搜索实战</h3>
<p>一般会对，下面代码的 CV 循环，比如循环20次，它会告诉20次那次好，然后由我们逐个的去判断。</p>
<p>原因：</p>
<ol>
<li>因为折数不一样，超参也不一样。</li>
<li>只跑一次是判断不出来最终结果的</li>
</ol>
<pre><code class="hljs language-py" lang="py">estimator = GridSearchCV(estimator=estimator, param_grid=param_dict, cv=<span class="hljs-number">5</span>)
</code></pre>
<blockquote>
<p>完整代码</p>
</blockquote>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split, GridSearchCV
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment"># 1. 加载数据集</span>
    iris_data = load_iris()
    <span class="hljs-comment"># 2. 数据预处理</span>
    x_train, x_test, y_train, y_test = train_test_split(iris_data.data, iris_data.target, test_size=<span class="hljs-number">0.2</span>,
                                                        random_state=<span class="hljs-number">22</span>)
    <span class="hljs-comment"># 3. 特征预处理</span>
    transfer = StandardScaler()
    transfer.fit_transform(x_train)
    transfer.transform(x_test)

    <span class="hljs-comment"># 4. 模型训练，选分类，注意此时不需要传递 K 的值</span>
    estimator = KNeighborsClassifier()
    <span class="hljs-comment"># 4.1 定义字典，记录超参可能出现的值</span>
    <span class="hljs-comment"># 注意这些值不能写死，</span>
    param_dict = {<span class="hljs-string">'n_neighbors'</span>: <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>))}
    <span class="hljs-comment"># 4.2 创建网格搜索对象</span>
    <span class="hljs-comment"># 参数1：模型对象。参数2：超参字典，参数3：交叉验证的折数</span>
    <span class="hljs-comment"># 返回一个更加强大的模型对象</span>
    estimator = GridSearchCV(estimator=estimator, param_grid=param_dict, cv=<span class="hljs-number">5</span>)

    <span class="hljs-comment"># 模型训练</span>
    estimator.fit(x_test, y_test)

    <span class="hljs-comment"># 5. 模型预测</span>
    y_predict = estimator.predict(x_test)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'模型预测的结果为<span class="hljs-subst">{y_predict}</span>'</span>)

    <span class="hljs-comment"># 6. 打印网格搜索 和 交叉验证的 结果</span>
    <span class="hljs-built_in">print</span>(estimator.best_score_)  <span class="hljs-comment"># 最优组合的平均分 0.9666666666666668</span>
    <span class="hljs-built_in">print</span>(estimator.best_estimator_)  <span class="hljs-comment"># 最优组合的模型对象 KNeighborsClassifier(n_neighbors=6)</span>
    <span class="hljs-built_in">print</span>(estimator.best_params_)  <span class="hljs-comment"># 最优组合的超参（仅供参考） {'n_neighbors': 6}</span>
    <span class="hljs-built_in">print</span>(estimator.cv_results_)  <span class="hljs-comment"># 所有组合的 评分结果（过程）</span>
    <span class="hljs-comment"># {'mean_fit_time': array([0.00020003, 0.00019999, 0.00019984, 0.00040126, 0.00019999]), 'std_fit_time': array([0.00040007, 0.00039997, 0.00039968, 0.00049144, 0.00039997]), 'mean_score_time': array([0.00110083, 0.00140481, 0.00130205, 0.00100107, 0.00140252]), 'std_score_time': array([0.00020204, 0.00037565, 0.00039944, 0.00063234, 0.00049298]), 'param_n_neighbors': masked_array(data=[1, 2, 3, 5, 7],</span>
    <span class="hljs-comment">#              mask=[False, False, False, False, False],</span>
    <span class="hljs-comment">#        fill_value=999999), 'params': [{'n_neighbors': 1}, {'n_neighbors': 2}, {'n_neighbors': 3}, {'n_neighbors': 5},</span>
    <span class="hljs-comment">#        {'n_neighbors': 7}], 'split0_test_score': array([0.83333333, 0.83333333, 0.83333333, 0.83333333, 0.83333333]),</span>
    <span class="hljs-comment">#        'split1_test_score': array([1.        , 0.83333333, 1.        , 0.66666667, 0.66666667]), 'split2_test_score':</span>
    <span class="hljs-comment">#        array([1., 1., 1., 1., 1.]), 'split3_test_score': array([1., 1., 1., 1., 1.]), 'split4_test_score': array([1.</span>
    <span class="hljs-comment">#        , 1.        , 1.        , 1.        , 0.83333333]), 'mean_test_score': array([0.96666667, 0.93333333, 0.96666667,</span>
    <span class="hljs-comment">#        0.9       , 0.86666667]), 'std_test_score': array([0.06666667, 0.08164966, 0.06666667, 0.13333333, 0.12472191]),</span>
    <span class="hljs-comment">#        'rank_test_score': array([1, 3, 1, 4, 5], dtype=int32)}</span>

    <span class="hljs-comment"># 7. 结合上述的结果，对模型再次评估</span>
    estimator = KNeighborsClassifier(n_neighbors=<span class="hljs-number">6</span>)
    estimator.fit(x_train, y_train)

    y_predict = estimator.predict(x_test)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'准确率：<span class="hljs-subst">{accuracy_score(y_test, y_predict)}</span>'</span>) <span class="hljs-comment"># 准确率：0.9333333333333333</span>
</code></pre>
<h3 data-id="heading-38">数字识别</h3>
<h4 data-id="heading-39">根据像素点生成图片</h4>
<p>已知数据</p>
<ul>
<li>MNIST手写数字识别</li>
<li>1999年发布，成为分类算法基准测试的基础</li>
<li>MNIST仍然是研究人员和学习者的可靠资源</li>
</ul>
<blockquote>
<p>从数万个手写图像的数据集中正确识别数字</p>
</blockquote>
<p><strong>数据介绍</strong></p>
<ol>
<li>数据文件 train.csv 和 test.csv 包含从 0 到 9 的手绘数字的灰度图像</li>
<li>每个图像高 28 像素，宽28 像素，共784个像素</li>
<li>每个像素取值范围[0,255]，取值越大意味着该像素颜色越深</li>
<li>训练数据集（train.csv）共785列。
<ul>
<li>第一列为标签，为该图片对应的手写数字。其余784列为该图像的像素值</li>
</ul>
</li>
<li>训练集中的特征名称均有pixel前缀，后面的数字（[0,783])代表了像素的序号。</li>
</ol>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:

    idx = <span class="hljs-number">20</span>

    <span class="hljs-comment"># 获取数据</span>
    data = pd.read_csv(<span class="hljs-string">r'E:\BaiduNetdiskDownload\手写数字识别.csv'</span>)
    <span class="hljs-comment"># 判断用户传入的索引是否合法</span>
    <span class="hljs-keyword">if</span> idx &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> idx &gt;= <span class="hljs-built_in">len</span>(data):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'索引不合法'</span>)
        sys.exit(<span class="hljs-number">1</span>)

    <span class="hljs-comment"># 获取所有的行，从第一列开始，不包含第 0 列</span>
    x = data.iloc[:, <span class="hljs-number">1</span>:]
    y = data.iloc[:, <span class="hljs-number">0</span>]

    <span class="hljs-comment"># 查看下每个数字一共有多少个，注意是 collections 下的</span>

    <span class="hljs-comment"># 数字的种类Counter({1: 4684, 7: 4401, 3: 4351, 9: 4188, 2: 4177, 6: 4137, 0: 4132, 4: 4072, 8: 4063, 5: 3795})</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'数字的种类<span class="hljs-subst">{Counter(y)}</span>'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'像素的形状<span class="hljs-subst">{x.shape}</span>'</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'索引对应的数字是：<span class="hljs-subst">{y[idx]}</span>'</span>)

    <span class="hljs-comment"># 绘制图片</span>
    <span class="hljs-comment"># x.iloc[idx] 返回的是列名+数据</span>
    <span class="hljs-comment"># x.iloc[idx].values 整合成一个数组</span>
    <span class="hljs-comment"># reshape(28, 28) 转换为 28*28 的像素点，因为图片就说 28 * 28</span>
    <span class="hljs-comment"># 结果就是 一个 28*28 的矩阵，，每28个是一个数组</span>
    digit = x.iloc[idx].values.reshape(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>)

    <span class="hljs-comment"># 绘制图片</span>
    plt.imshow(digit, cmap=<span class="hljs-string">'gray'</span>)  <span class="hljs-comment"># 灰度图</span>
    <span class="hljs-comment"># 不显示坐标轴</span>
    plt.axis(<span class="hljs-string">'off'</span>)
    plt.show()
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86745456f0104326acec2cc5fcd0868f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766990951&amp;x-signature=4QZ8R4w8I2KoCSFihwt9ZjpRM70%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-40">模型保存</h4>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> joblib
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment"># 1. 获取数据</span>
    data = pd.read_csv(<span class="hljs-string">'./手写数字识别.csv'</span>)

    <span class="hljs-comment"># 2. 数据预处理</span>
    <span class="hljs-comment"># 像素点，特征</span>
    x = data.iloc[:, <span class="hljs-number">1</span>:]
    <span class="hljs-comment"># 标签</span>
    y = data.iloc[:, <span class="hljs-number">0</span>]

    <span class="hljs-comment"># stratify 表示参考 y 轴数据分布划分数据集和测试集</span>
    x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=<span class="hljs-number">0.2</span>, random_state=<span class="hljs-number">7</span>, stratify=y)

    <span class="hljs-comment"># 3. 特征工程</span>
    transfer = StandardScaler()
    transfer.fit_transform(x_train)
    transfer.transform(x_test)

    <span class="hljs-comment"># 4. 模型训练</span>
    estimator = KNeighborsClassifier(n_neighbors=<span class="hljs-number">5</span>)
    estimator.fit(x_train, y_train)

    <span class="hljs-comment"># 5. 模型评估</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'准确率：<span class="hljs-subst">{estimator.score(x_test, y_test)}</span>'</span>)  <span class="hljs-comment"># 准确率：0.9653571428571428</span>

    <span class="hljs-comment"># 6. 模型评估</span>
    <span class="hljs-comment"># pkl 是 pandas 独有的文件格式</span>
    <span class="hljs-comment"># pth 也是可以的</span>
    joblib.dump(estimator, <span class="hljs-string">'/knn.pkl'</span>)
</code></pre>
<h4 data-id="heading-41">图片数字识别</h4>
<p>因为，加载的图片，是一个0~1的数值，需要 * 255</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> joblib
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-comment"># 1. 加载图片</span>
    <span class="hljs-comment"># 打印出来是 28 * 28 的矩阵</span>
    img = plt.imread(<span class="hljs-string">'./demo.png'</span>)

    <span class="hljs-comment"># 值如果是2，表示灰度图</span>
    <span class="hljs-built_in">print</span>(img.ndim)

    <span class="hljs-comment"># 转 0~255</span>
    img = img * <span class="hljs-number">255</span>

    <span class="hljs-comment"># 显示图片</span>
    plt.imshow(img, cmap=<span class="hljs-string">'gray'</span>)
    plt.show()

    <span class="hljs-comment"># 转换成 一行 矩阵，最多是 28 * 28 = 784列，但是还需要计算，可以直接写 -1，表示能转多少转多少</span>
    img = img.reshape(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>)

    <span class="hljs-comment"># 读取模型</span>
    knn = joblib.load(<span class="hljs-string">'/knn.pkl'</span>)

    <span class="hljs-comment"># 用训练时的特征名构造</span>
    feature_names = knn.feature_names_in_
    img_df = pd.DataFrame(img, columns=feature_names)

    <span class="hljs-comment"># 模型预测</span>
    y_predict = knn.predict(img_df)
    <span class="hljs-built_in">print</span>(y_predict)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[知识库-向量化功能-文本文件向量化]]></title>    <link>https://juejin.cn/post/7586136543955337254</link>    <guid>https://juejin.cn/post/7586136543955337254</guid>    <pubDate>2025-12-22T06:52:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543955337254" data-draft-id="7586167377382572058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="知识库-向量化功能-文本文件向量化"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T06:52:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="初次攀爬者"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            知识库-向量化功能-文本文件向量化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    初次攀爬者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:52:24.000Z" title="Mon Dec 22 2025 06:52:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">知识库-向量化功能-文本文件向量化</h2>
<h3 data-id="heading-1">一、核心逻辑</h3>
<p>基于句子结束符的智能分片策略</p>
<ol>
<li>按句子结束符（<code>。！？；\n\.!?;</code>）分割文本，保证分片语义完整性；</li>
<li>对每个文本分片独立向量化</li>
<li>分片后批量存储至Elasticsearch，同时保留原文档元数据与分片标识，便于后续检索溯源。</li>
</ol>
<h3 data-id="heading-2">二、关键实现代码</h3>
<h4 data-id="heading-3">2.1 文本向量化主方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 处理文本分片与向量化，并批量存储至ES
 * <span class="hljs-doctag">@param</span> largeText 待处理的文本内容
 * <span class="hljs-doctag">@param</span> docMetadata 原文档元数据（如文件名称、上传时间、文件ID等）
 * <span class="hljs-doctag">@return</span> 分片ID列表（用于后续关联查询）
 */</span>
<span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">processLargeText</span><span class="hljs-params">(String largeText, Map&lt;String,Object&gt; docMetadata)</span> {
    <span class="hljs-comment">// 1. 智能分片：按句子结束符分割，避免大文本一次性处理</span>
    List&lt;String&gt; chunks = textSplitter.split(largeText);
    
    <span class="hljs-comment">// 2. 构建分片Document，关联原文档元数据+分片信息+向量数据</span>
    List&lt;Document&gt; chunkDocs = chunks.stream()
            .map(chunk -&gt; {
                <span class="hljs-comment">// 生成分片唯一ID</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">chunkId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString().replace(<span class="hljs-string">"-"</span>, <span class="hljs-string">""</span>);
                <span class="hljs-comment">// 文本分片向量化（调用lrs33/bce-embedding-base_v1模型）</span>
                <span class="hljs-type">float</span>[] embs = embeddingModel.embed(chunk);
                
                <span class="hljs-comment">// 分片元数据：继承原文档元数据 + 分片专属信息</span>
                Map&lt;String, Object&gt; chunkMetadata = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(docMetadata);
                chunkMetadata.put(<span class="hljs-string">"chunkId"</span>, chunkId);          <span class="hljs-comment">// 分片唯一标识</span>
                chunkMetadata.put(<span class="hljs-string">"chunkIndex"</span>, chunks.indexOf(chunk)); <span class="hljs-comment">// 分片序号</span>
                chunkMetadata.put(<span class="hljs-string">"totalChunks"</span>, chunks.size());       <span class="hljs-comment">// 总分片数</span>
                chunkMetadata.put(<span class="hljs-string">"overlapLength"</span>, TextSplitter.CHUNK_OVERLAP); <span class="hljs-comment">// 分片重叠长度</span>
                chunkMetadata.put(<span class="hljs-string">"vector"</span>, embs);                <span class="hljs-comment">// 向量数据</span>
                
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(chunkId, chunk, chunkMetadata);
            }).collect(Collectors.toList());
    
    <span class="hljs-comment">// 3. 批量存储分片至ES向量库（自动适配配置的bulk-size）</span>
    compatibleVectorStoreService.batchStore(chunkDocs);
    
    <span class="hljs-comment">// 返回所有分片ID，便于后续溯源/删除操作</span>
    <span class="hljs-keyword">return</span> chunkDocs.stream().map(Document::getId).collect(Collectors.toList());
}
</code></pre>
<h4 data-id="heading-4">2.2 智能文本分片工具类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 文本分片工具类：按句子结束符分割，保证语义完整性，避免大文本卡死
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextSplitter</span> {
    <span class="hljs-comment">// 分片最大长度（可根据业务调整，建议500-1000字符）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_CHUNK_LENGTH</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;
    <span class="hljs-comment">// 分片重叠长度（避免句子被截断导致语义丢失，建议50-100字符）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CHUNK_OVERLAP</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;
    
    <span class="hljs-comment">/**
     * 智能分割大文本
     * <span class="hljs-doctag">@param</span> text 待分割的大文本
     * <span class="hljs-doctag">@return</span> 语义完整的文本分片列表
     */</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">split</span><span class="hljs-params">(String text)</span> {
        List&lt;String&gt; chunks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">int</span> <span class="hljs-variable">textLength</span> <span class="hljs-operator">=</span> text.length();
        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 循环分片，直到处理完所有文本</span>
        <span class="hljs-keyword">while</span> (start &lt; textLength) {
            <span class="hljs-comment">// 1. 计算分片初始结束位置（不超过最大长度）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> Math.min(start + MAX_CHUNK_LENGTH, textLength);
            
            <span class="hljs-comment">// 2. 若未到文本末尾，回溯至最近的句子结束符，保证分片语义完整</span>
            <span class="hljs-keyword">if</span> (end &lt; textLength) {
                <span class="hljs-type">String</span> <span class="hljs-variable">subText</span> <span class="hljs-operator">=</span> text.substring(start, end);
                <span class="hljs-type">int</span> <span class="hljs-variable">lastEndPos</span> <span class="hljs-operator">=</span> findLastSentenceEnd(subText);
                
                <span class="hljs-comment">// 找到句子结束符：调整结束位置至结束符后</span>
                <span class="hljs-keyword">if</span> (lastEndPos != -<span class="hljs-number">1</span>) {
                    end = start + lastEndPos + <span class="hljs-number">1</span>;
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 未找到结束符：兜底按最大长度分割（避免无限循环）</span>
                    end = start + MAX_CHUNK_LENGTH;
                }
            }
            
            <span class="hljs-comment">// 3. 截取分片并去除首尾空白，非空则加入列表</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">chunk</span> <span class="hljs-operator">=</span> text.substring(start, end).trim();
            <span class="hljs-keyword">if</span> (!chunk.isEmpty()) {
                chunks.add(chunk);
            }
            
            <span class="hljs-comment">// 4. 计算下一个分片起始位置（重叠处理，避免语义断裂）</span>
            start = end - CHUNK_OVERLAP;
            <span class="hljs-comment">// 防止重叠后起始位置为负数（仅首次分片可能触发）</span>
            <span class="hljs-keyword">if</span> (start &lt; <span class="hljs-number">0</span>) {
                start = <span class="hljs-number">0</span>;
            }
        }
        <span class="hljs-keyword">return</span> chunks;
    }
    
    <span class="hljs-comment">/**
     * 查找子文本中最后一个句子结束符的位置
     * 结束符：。！？；\n\.!?;
     * <span class="hljs-doctag">@param</span> subText 子文本
     * <span class="hljs-doctag">@return</span> 最后一个结束符的索引（无则返回-1）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findLastSentenceEnd</span><span class="hljs-params">(String subText)</span> {
        <span class="hljs-comment">// 定义句子结束符正则</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">endChars</span> <span class="hljs-operator">=</span> <span class="hljs-string">"。！？；\n\\.!?;"</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> subText.length() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">if</span> (endChars.indexOf(subText.charAt(i)) != -<span class="hljs-number">1</span>) {
                <span class="hljs-keyword">return</span> i;
            }
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
}
</code></pre>
<h3 data-id="heading-5">三、核心设计说明</h3>
<h4 data-id="heading-6">3.1 分片策略优势</h4>

























<table><thead><tr><th>设计点</th><th>解决的问题</th></tr></thead><tbody><tr><td>按句子结束符分割</td><td>避免生硬截断文本导致的语义破碎，保证分片语义完整性</td></tr><tr><td>分片重叠处理（CHUNK_OVERLAP）</td><td>解决跨分片句子语义断裂问题（如分片1末尾与分片2开头重叠50字符）</td></tr><tr><td>兜底按最大长度分割</td><td>避免无结束符的超长文本（如纯数字/英文）导致循环无法终止</td></tr><tr><td>非空分片过滤</td><td>避免空字符串分片占用ES存储空间</td></tr></tbody></table>
<h4 data-id="heading-7">3.2 关键参数说明</h4>




















<table><thead><tr><th>参数名</th><th>默认值</th><th>调整建议</th></tr></thead><tbody><tr><td>MAX_CHUNK_LENGTH</td><td>1000</td><td>可根据模型上下文窗口（num_ctx=1024）调整，建议不超过1000字符，避免模型处理超时</td></tr><tr><td>CHUNK_OVERLAP</td><td>50</td><td>建议为MAX_CHUNK_LENGTH的5%-10%，过小易丢失跨分片语义，过大则增加冗余存储</td></tr></tbody></table>
<h4 data-id="heading-8">3.3 元数据设计</h4>
<p>分片元数据同时包含<strong>原文档属性</strong>和<strong>分片专属属性</strong>，便于：</p>
<ol>
<li>检索时溯源至原文件（如通过文件ID关联）；</li>
<li>查看分片在原文本中的位置（chunkIndex）；</li>
<li>统计原文本的总分片数（totalChunks）；</li>
<li>快速定位向量数据（vector字段）。</li>
</ol>
<h3 data-id="heading-9">四、性能优化说明</h3>
<ol>
<li><strong>避免大文本一次性处理</strong>：通过循环分片+逐片向量化，降低单次内存占用，解决split方法卡死问题；</li>
<li><strong>批量写入ES</strong>：结合配置的<code>bulk-size</code>，减少ES网络请求次数，提升写入效率；</li>
<li><strong>分片去空</strong>：过滤空白分片，减少无效数据存储和向量计算开销；</li>
<li><strong>索引刷新间隔</strong>：配合ES配置的<code>refresh-interval</code>，避免高频刷盘导致的性能损耗。</li>
</ol>
<h3 data-id="heading-10">五、注意事项</h3>
<ol>
<li>句子结束符正则需覆盖中英文场景（<code>。！？；\n\.!?;</code>），避免遗漏分割点；</li>
<li>向量化时需保证<code>embeddingModel</code>与配置的<code>lrs33/bce-embedding-base_v1</code>模型一致，否则向量维度不匹配；</li>
<li>分片ID采用UUID生成，避免重复；若需关联原文件，可在元数据中增加<code>fileId</code>等标识；</li>
<li>处理长篇文本时，建议增加异步处理逻辑，避免阻塞主线程。</li>
<li>一次性传入超长文本容易使split方法卡死，建议提前将文本分割后再使用</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实现一个简单的并发度控制执行器]]></title>    <link>https://juejin.cn/post/7586182451598557230</link>    <guid>https://juejin.cn/post/7586182451598557230</guid>    <pubDate>2025-12-22T07:00:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586182451598557230" data-draft-id="7586136543955189798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实现一个简单的并发度控制执行器"/> <meta itemprop="keywords" content="后端,Java,性能优化"/> <meta itemprop="datePublished" content="2025-12-22T07:00:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实现一个简单的并发度控制执行器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T07:00:40.000Z" title="Mon Dec 22 2025 07:00:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">并发限制执行器：ExecutorCompletionService 与 ListenableFuture 实战</h2>
<p>大家好，我是桦说编程。</p>
<blockquote>
<p>本文深入解析如何使用 ExecutorCompletionService 和 Guava ListenableFuture 实现并发度可控的任务执行器，掌握生产级并发编程的核心技巧。</p>
</blockquote>
<h3 data-id="heading-1">问题背景</h3>
<p>在高并发场景下，我们可能面临这样的需求(仅为例子）：</p>
<p><strong>场景</strong>：火车票查询系统，用户输入北京到上海，需要查询100个车次的余票信息。</p>
<p><strong>需求</strong>：</p>
<ul>
<li><strong>批量查询</strong>：并发调用100个车次的余票查询接口</li>
<li><strong>限制并发度</strong>：12306限流，单个应用最多10个并发，超过会返回"请稍后再试"</li>
<li><strong>尽快返回</strong>：不能等全部查完，需要立即返回Future供上层组合（边查边展示）</li>
<li><strong>按序映射</strong>：返回的Future列表要和车次列表一一对应（G1-G100）</li>
</ul>
<p>传统方案的痛点：</p>

























<table><thead><tr><th>方案</th><th>问题</th></tr></thead><tbody><tr><td><code>ExecutorService.invokeAll()</code></td><td>阻塞等待所有任务完成，无法立即返回</td></tr><tr><td><code>CompletableFuture.allOf()</code></td><td>无法控制并发度，100个请求同时发出触发限流</td></tr><tr><td>自己用 Semaphore</td><td>代码复杂，需要手动管理信号量和异常</td></tr><tr><td>分批执行（10个一批）</td><td>任务执行时间不均匀，短任务等待长任务，资源利用率低</td></tr></tbody></table>
<p><strong>优化方案</strong>：滑动窗口 - 初始提交10个，每完成一个立即补充下一个，保持10个并发。</p>
<h3 data-id="heading-2">代码实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 并发限制执行器
 * &lt;p&gt;
 * 核心功能：控制任务并发度，采用滑动窗口策略
 * &lt;p&gt;
 * 知识点：
 * 1. ExecutorCompletionService - 按完成顺序获取任务结果
 * 2. ListenableFuture - Guava 可监听 Future
 * 3. SettableFuture - 可手动设置结果的 Future
 * 4. 滑动窗口并发控制 - 初始提交N个，每完成一个立即补充下一个
 *
 * <span class="hljs-doctag">@author</span> 桦说编程
 */</span>
<span class="hljs-meta">@Value</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcurrentLimitExecutor</span>&lt;V&gt; {
    ListeningExecutorService pool;
    <span class="hljs-type">int</span> parallelism;
    BlockingQueue&lt;Future&lt;V&gt;&gt; q;
    ExecutorCompletionService&lt;V&gt; cs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorCompletionService</span>&lt;&gt;(pool, q);
    <span class="hljs-type">ListeningExecutorService</span> <span class="hljs-variable">submitter</span> <span class="hljs-operator">=</span> MoreExecutors.listeningDecorator(
            Executors.newSingleThreadExecutor());

    <span class="hljs-comment">/**
     * 提交所有任务，立即返回Future列表
     *
     * <span class="hljs-doctag">@param</span> tasks 待执行的任务列表
     * <span class="hljs-doctag">@return</span> Future列表，顺序与tasks一致
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> List&lt;ListenableFuture&lt;V&gt;&gt; <span class="hljs-title function_">submitAll</span><span class="hljs-params">(List&lt;Callable&lt;V&gt;&gt; tasks)</span> {
        <span class="hljs-keyword">if</span> (tasks.isEmpty()) {
            <span class="hljs-keyword">return</span> ImmutableList.of();
        }

        <span class="hljs-comment">// 创建结果占位符，数量等于任务数量</span>
        List&lt;SettableFuture&lt;V&gt;&gt; result = IntStream.range(<span class="hljs-number">0</span>, tasks.size())
                .mapToObj(__ -&gt; SettableFuture.&lt;V&gt;create())
                .collect(toImmutableList());

        <span class="hljs-comment">// 首批提交数量</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> Math.min(tasks.size(), parallelism);

        <span class="hljs-comment">// 提交首批任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; start; i++) {
            ListenableFuture&lt;V&gt; f = (ListenableFuture&lt;V&gt;) cs.submit(tasks.get(i));
            linkFuture(f, result.get(i));
        }

        <span class="hljs-comment">// 异步提交剩余任务</span>
        submitter.submit(() -&gt; submitRemaining(tasks, result, start));

        <span class="hljs-keyword">return</span> (List&lt;ListenableFuture&lt;V&gt;&gt;) (List&lt;?&gt;) result;
    }

    <span class="hljs-comment">/**
     * 提交剩余任务（在独立线程中执行）
     * &lt;p&gt;
     * 流程：
     * 1. 等待任意任务完成（cs.take()）
     * 2. 提交下一个任务
     * 3. 将新任务的Future链接到result对应位置
     * 4. 重复直到所有任务提交完
     */</span>
    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submitRemaining</span><span class="hljs-params">(List&lt;Callable&lt;V&gt;&gt; tasks,
                                 List&lt;SettableFuture&lt;V&gt;&gt; result,
                                 <span class="hljs-type">int</span> start)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> start;
        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> tasks.size();
        <span class="hljs-keyword">while</span> (index &lt; size) {
            <span class="hljs-comment">// 阻塞等待任意任务完成（释放一个并发槽位）</span>
            cs.take();

            <span class="hljs-comment">// 提交下一个任务</span>
            ListenableFuture&lt;V&gt; f = (ListenableFuture&lt;V&gt;) cs.submit(tasks.get(index));

            <span class="hljs-comment">// 链接结果到对应位置</span>
            linkFuture(f, result.get(index));

            index++;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">linkFuture</span><span class="hljs-params">(ListenableFuture&lt;V&gt; from, SettableFuture&lt;V&gt; to)</span> {
        from.addListener(() -&gt; to.setFuture(from), directExecutor());
    }
}
</code></pre>
<p><strong>关键设计点</strong>：</p>

























<table><thead><tr><th>设计元素</th><th>说明</th></tr></thead><tbody><tr><td>result 数量</td><td>等于 tasks.size()，每个任务都有对应的 Future</td></tr><tr><td>linkFuture</td><td>将 cs 返回的 Future 链接到 result 中对应位置</td></tr><tr><td>异步补充</td><td>使用 submitter 线程池异步提交剩余任务，不阻塞调用方</td></tr><tr><td>立即返回</td><td>submitAll() 立即返回，上层可用 Futures.allAsList() 组合</td></tr></tbody></table>
<h3 data-id="heading-3">核心知识点</h3>
<h4 data-id="heading-4">1. ExecutorCompletionService</h4>
<p>JDK提供的任务完成服务，核心能力是<strong>按完成顺序获取结果</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
ExecutorCompletionService&lt;Train&gt; cs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutorCompletionService</span>&lt;&gt;(pool);

<span class="hljs-comment">// 提交任务</span>
cs.submit(() -&gt; queryTrain(<span class="hljs-string">"G1"</span>));
cs.submit(() -&gt; queryTrain(<span class="hljs-string">"G2"</span>));

<span class="hljs-comment">// 阻塞获取最先完成的结果（而不是提交顺序）</span>
Future&lt;Train&gt; first = cs.take();  <span class="hljs-comment">// 谁先完成就拿到谁</span>
Future&lt;Train&gt; second = cs.take();
</code></pre>
<p><strong>原理</strong>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">┌─────────────────────────────────────────────┐</span>
<span class="hljs-operator">│</span>      <span class="hljs-type">ExecutorCompletionService</span>              <span class="hljs-operator">│</span>
<span class="hljs-operator">├─────────────────────────────────────────────┤</span>
<span class="hljs-operator">│</span>  <span class="hljs-operator">-</span> executor: <span class="hljs-type">ExecutorService</span>                <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  <span class="hljs-operator">-</span> completionQueue: <span class="hljs-type">BlockingQueue</span>&lt;<span class="hljs-type">Future</span>&gt;   <span class="hljs-operator">│</span>
<span class="hljs-operator">├─────────────────────────────────────────────┤</span>
<span class="hljs-operator">│</span>  <span class="hljs-operator">+</span> submit(<span class="hljs-type">Callable</span>): <span class="hljs-type">Future</span>                 <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  <span class="hljs-operator">+</span> take(): <span class="hljs-type">Future</span>  <span class="hljs-comment">// 阻塞获取已完成的      │</span>
<span class="hljs-operator">│</span>  <span class="hljs-operator">+</span> poll(): <span class="hljs-type">Future</span>  <span class="hljs-comment">// 非阻塞获取            │</span>
<span class="hljs-operator">└─────────────────────────────────────────────┘</span>
         <span class="hljs-operator">│</span>
         <span class="hljs-operator">│</span> 任务完成时自动放入队列
         <span class="hljs-operator">▼</span>
<span class="hljs-operator">┌─────────────────────────────────────────────┐</span>
<span class="hljs-operator">│</span>     <span class="hljs-type">BlockingQueue</span>&lt;<span class="hljs-type">Future</span>&lt;<span class="hljs-type">V</span>&gt;&gt;                <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  <span class="hljs-operator">┌──────┐</span>  <span class="hljs-operator">┌──────┐</span>  <span class="hljs-operator">┌──────┐</span>              <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  <span class="hljs-operator">│</span><span class="hljs-type">Future</span><span class="hljs-operator">│</span>  <span class="hljs-operator">│</span><span class="hljs-type">Future</span><span class="hljs-operator">│</span>  <span class="hljs-operator">│</span><span class="hljs-type">Future</span><span class="hljs-operator">│</span>  <span class="hljs-operator">...</span>         <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>  <span class="hljs-operator">└──────┘</span>  <span class="hljs-operator">└──────┘</span>  <span class="hljs-operator">└──────┘</span>              <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span>   已完成    已完成    已完成                 <span class="hljs-operator">│</span>
<span class="hljs-operator">└─────────────────────────────────────────────┘</span>
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>提交任务时包装Future，添加完成回调</li>
<li>任务完成后自动将Future放入<code>completionQueue</code></li>
<li><code>take()</code>从队列获取，天然按完成顺序</li>
</ul>
<h4 data-id="heading-5">2. Guava ListenableFuture</h4>
<p>标准<code>Future</code>的增强版，支持<strong>回调监听</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 标准Future：只能轮询或阻塞</span>
Future&lt;Train&gt; future = executor.submit(() -&gt; queryTrain(<span class="hljs-string">"G1"</span>));
<span class="hljs-type">Train</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(); <span class="hljs-comment">// 阻塞</span>

<span class="hljs-comment">// ListenableFuture：注册回调</span>
<span class="hljs-type">ListeningExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> MoreExecutors.listeningDecorator(pool);
ListenableFuture&lt;Train&gt; future = executor.submit(() -&gt; queryTrain(<span class="hljs-string">"G1"</span>));

<span class="hljs-comment">// 异步回调（不阻塞）</span>
future.addListener(() -&gt; {
    System.out.println(<span class="hljs-string">"G1查询完成！"</span>);
}, directExecutor());

<span class="hljs-comment">// 或使用Futures工具类</span>
Futures.addCallback(future, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FutureCallback</span>&lt;Train&gt;() {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(Train result)</span> { ... }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Throwable t)</span> { ... }
}, executor);
</code></pre>
<p><strong>核心价值</strong>：</p>
<ul>
<li><strong>非阻塞</strong>：不需要轮询<code>isDone()</code>或阻塞<code>get()</code></li>
<li><strong>组合能力</strong>：<code>Futures.allAsList()</code>, <code>transform()</code>, <code>catching()</code>等</li>
<li><strong>异常传播</strong>：失败会自动传播到下游Future</li>
</ul>
<h4 data-id="heading-6">3. SettableFuture</h4>
<p>可手动设置结果的Future，类似<code>CompletableFuture</code>。</p>
<pre><code class="hljs language-java" lang="java">SettableFuture&lt;Train&gt; future = SettableFuture.create();

<span class="hljs-comment">// 在其他线程设置结果</span>
future.set(train);                       <span class="hljs-comment">// 正常完成</span>
future.setException(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>());  <span class="hljs-comment">// 异常完成</span>
future.setFuture(otherFuture);           <span class="hljs-comment">// 链接另一个Future</span>

<span class="hljs-comment">// 调用方正常使用</span>
<span class="hljs-type">Train</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();
</code></pre>
<h4 data-id="heading-7">4. 并发度控制核心思路</h4>
<p><strong>滑动窗口策略</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">假设 <span class="hljs-attr">parallelism</span>=<span class="hljs-number">3</span>, tasks=<span class="hljs-number">10</span>（查询<span class="hljs-number">10</span>个车次）

初始状态：提交前3个车次到线程池
┌───┬───┬───┐ ┌───┬───┬───┬───┬───┬───┬───┐
│ G1│ G2│ G3│ │ G4│ G5│ G6│ G7│ G8│ G9│G10│
└───┴───┴───┘ └───┴───┴───┴───┴───┴───┴───┘
  执行中          等待中

G1 完成 → 立即提交 G4
┌───┬───┬───┐ ┌───┬───┬───┬───┬───┬───┐
│   │ G2│ G3│ │ G4│ G5│ G6│ G7│ G8│ G9│G10│
└───┴───┴───┘ └───┴───┴───┴───┴───┴───┴───┘
      执行中        等待中

G2 完成 → 立即提交 G5
...

维持窗口大小 = parallelism，任务完成后立即补充新任务
</code></pre>
<p><strong>实现要点</strong>：</p>
<ul>
<li>使用<code>ExecutorCompletionService.take()</code>等待任意任务完成</li>
<li>每完成一个，立即从待执行队列提交下一个</li>
<li>保证同时执行的任务数 ≤ parallelism</li>
</ul>
<h3 data-id="heading-8">使用场景</h3>

























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>批量查询接口</td><td>火车票、机票、酒店查询，下游限流保护</td></tr><tr><td>批量缓存查询</td><td>Redis 连接池有限，控制并发数</td></tr><tr><td>批量 IO 操作</td><td>文件读写、数据库查询</td></tr><tr><td>爬虫系统</td><td>限制爬取速率，避免被封</td></tr></tbody></table>
<h3 data-id="heading-9">总结</h3>
<ul>
<li><strong>ExecutorCompletionService</strong> - <code>take()</code>按完成顺序获取，支持动态补充任务</li>
<li><strong>ListenableFuture + SettableFuture</strong> - 通过<code>linkFuture</code>将内部Future链接到返回占位符</li>
<li><strong>双线程池设计</strong> - pool执行任务，submitter异步补充，不阻塞调用方</li>
<li><strong>滑动窗口策略</strong> - 初始提交N个，每完成一个立即补充下一个</li>
<li><strong>索引严格对应</strong> - result数量等于tasks数量，result[i]对应tasks[i]</li>
</ul>
<p><strong>核心优势</strong>：</p>
<ul>
<li>精确控制并发度，避免下游限流</li>
<li>立即返回Future，支持流式处理（边查边展示）</li>
<li>资源利用率高，短任务不等待长任务</li>
<li>代码简洁，无需手动管理信号量</li>
</ul>
<hr/>
<p>如果这篇文章对你有帮助，欢迎关注我，持续分享高质量技术干货，助你更快提升编程能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[狗都会用的 JRebel License Server - 免费激活 JRebel 和 JetBrains IDE 的终极方案]]></title>    <link>https://juejin.cn/post/7586192313636159522</link>    <guid>https://juejin.cn/post/7586192313636159522</guid>    <pubDate>2025-12-22T06:59:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586192313636159522" data-draft-id="7586237019988787200" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="狗都会用的 JRebel License Server - 免费激活 JRebel 和 JetBrains IDE 的终极方案"/> <meta itemprop="keywords" content="IntelliJ IDEA"/> <meta itemprop="datePublished" content="2025-12-22T06:59:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="kengerlwl"/> <meta itemprop="url" content="https://juejin.cn/user/1171409373758185"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            狗都会用的 JRebel License Server - 免费激活 JRebel 和 JetBrains IDE 的终极方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1171409373758185/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    kengerlwl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:59:11.000Z" title="Mon Dec 22 2025 06:59:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>还在为 JRebel 和 JetBrains IDE 的激活而烦恼？这篇文章将教你如何使用一个开源的 License Server，轻松激活这些工具。无需复杂的配置，只需几步操作，小白也能上手！</p>
<h3 data-id="heading-1">什么是 JRebel License Server？</h3>
<p>JRebel License Server 是一个开源项目，它提供了一个本地的激活服务器，支持：</p>
<ul>
<li>✅ JRebel 7.1+ 和 2018.1+ 版本</li>
<li>
<ul>
<li>✅ JetBrains IDE（旧版本）</li>
</ul>
</li>
<li>
<ul>
<li>✅ 完全自托管，数据安全</li>
</ul>
</li>
<li>
<ul>
<li>✅ 美观的 Web 界面，一键生成激活 URL</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">快速开始（3 种方式）</h3>
<h3 data-id="heading-3">方式一：在线体验（最简单）</h3>
<p>如果你不想自己部署，可以直接使用已部署好的在线服务：</p>
<p>访问地址： <a href="https://link.juejin.cn?target=http%3A%2F%2F43.143.21.219%3A18080%2F" target="_blank" title="http://43.143.21.219:18080/" ref="nofollow noopener noreferrer">JRebel &amp; JetBrains License Server</a></p>
<p>打开这个网址，你就能看到一个简洁的 Web 界面，可以直接生成激活 URL。</p>
<h3 data-id="heading-4">方式二：Docker 部署（推荐）</h3>
<p>如果你的电脑上已经安装了 Docker，只需要一条命令：</p>
<pre><code class="hljs language-shell" lang="shell">docker run -d -p 8080:8080 --name jrebel-server \
  ghcr.io/xiaoyu-ai/jrebel-license-server:latest
```

然后打开浏览器访问：`http://localhost:8080`
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 方式三：本地运行</span></span>

如果你想在本地直接运行：

1. 克隆项目
```bash
git clone https://github.com/xiaoyu-ai/jrebel-license-server.git
cd jrebel-license-server
```

2. 安装依赖
```bash
pip install -r requirements.txt
```

3. 运行服务
```bash
python app.py
```

然后访问：`http://localhost:8080`
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 如何激活 JRebel？</span></span>
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 步骤 1：打开 Web 界面</span></span>

访问 `http://localhost:8080`（或在线地址），你会看到一个简洁的界面。
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 步骤 2：选择产品</span></span>

点击选择 **JRebel** 产品。
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 步骤 3：生成激活 URL</span></span>

点击 **生成激活 URL** 按钮，系统会自动生成一个 GUID 和对应的激活 URL。
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 步骤 4：复制激活 URL</span></span>

点击 **复制** 按钮，将激活 URL 复制到剪贴板。
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 步骤 5：在 JRebel 中激活</span></span>

1. 打开 JRebel 激活界面
2. 选择 **Team URL** 方式
3. 粘贴你复制的激活 URL
4. 邮箱填写任意邮箱（如 test@example.com）
5. 点击 **Activate**

完成！JRebel 已激活。
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 如何激活 JetBrains IDE？</span></span>
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 旧版本 IDE（2021.3 之前）</span></span>

1. 访问 Web 界面，选择 **JetBrains** 产品
2. 生成激活 URL
3. 在 IDE 中：Help → Register → License Server
4. 输入你的服务器地址（如 `http://localhost:8080`）
5. 点击激活
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 新版本 IDE（2021.3+）</span></span>

新版本需要配合 [ja-netfilter](https://gitee.com/ja-netfilter/ja-netfilter) 使用，具体步骤请参考 ja-netfilter 的文档。
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 常见问题</span></span>

**Q：这个工具合法吗？**
A：这是一个开源学习项目，仅供学习研究使用。请支持正版软件。

**Q：能在公网上部署吗？**
A：可以，但建议在内网环境部署，不要将服务暴露到公网。

**Q：激活后会过期吗？**
A：不会。一旦激活成功，就可以长期使用。

**Q：支持哪些 JRebel 版本？**
A：支持 JRebel 7.1+ 和 2018.1+ 版本。
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 项目地址</span></span>

- GitHub：https://github.com/xiaoyu-ai/jrebel-license-server
- 在线演示：https://hack.156354.xyz/
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 总结</span></span>

通过 JRebel License Server，你可以轻松激活 JRebel 和 JetBrains IDE，无需复杂的配置。选择适合你的部署方式，几分钟内就能完成激活。

如果这个项目对你有帮助，别忘了给个 Star ⭐！
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Vue3 + Coze API 打造冰球运动员 AI 生成器：从图片上传到风格化输出]]></title>    <link>https://juejin.cn/post/7586178555777089542</link>    <guid>https://juejin.cn/post/7586178555777089542</guid>    <pubDate>2025-12-22T06:56:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586178555777089542" data-draft-id="7585969437033283626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Vue3 + Coze API 打造冰球运动员 AI 生成器：从图片上传到风格化输出"/> <meta itemprop="keywords" content="前端,Coze,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T06:56:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Vue3 + Coze API 打造冰球运动员 AI 生成器：从图片上传到风格化输出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T06:56:53.000Z" title="Mon Dec 22 2025 06:56:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将带你从零构建一个基于 Vue3 和 Coze 工作流的趣味 AI 应用——“宠物变冰球运动员”生成器。通过上传一张宠物照片，结合用户自定义的队服编号、颜色、位置等参数，即可生成一张风格化的冰球运动员形象图。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、项目背景与目标</h2>
<p>在 AI 能力逐渐普及的今天，越来越多开发者尝试将大模型能力集成进自己的 Web 应用中。本项目的目标是打造一个<strong>轻量、有趣、可分享</strong>的前端应用：</p>
<ul>
<li>用户上传宠物照片；</li>
<li>自定义冰球队服（编号、颜色）、场上位置（守门员/前锋/后卫）、持杆手（左/右）以及艺术风格（写实、乐高、国漫等）；</li>
<li>后端调用 Coze 平台的工作流 API，完成图像生成；</li>
<li>最终返回生成结果并展示。</li>
</ul>
<p>这类“趣味换脸/换装”类应用非常适合社交传播，比如冰球协会举办活动时，鼓励用户上传自家宠物照片生成“冰球明星”，再分享至朋友圈，既有趣又具传播性。</p>
<hr/>
<h2 data-id="heading-1">二、技术栈与核心流程</h2>
<h3 data-id="heading-2">技术选型</h3>
<ul>
<li><strong>前端框架</strong>：Vue 3（<code>&lt;script setup&gt;</code> + Composition API）</li>
<li><strong>状态管理</strong>：<code>ref</code> 响应式变量</li>
<li><strong>HTTP 请求</strong>：原生 <code>fetch</code></li>
<li><strong>AI 能力平台</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coze.cn%2F" target="_blank" title="https://www.coze.cn/" ref="nofollow noopener noreferrer">Coze</a>（提供工作流和文件上传 API）</li>
<li><strong>环境变量</strong>：<code>import.meta.env.VITE_PAT_TOKEN</code>（用于安全存储 PAT Token）</li>
</ul>
<h3 data-id="heading-3">核心业务流程</h3>
<ol>
<li><strong>图片预览</strong>：用户选择图片后，立即在前端显示预览（使用 <code>FileReader</code> + Base64）；</li>
<li><strong>上传图片</strong>：将图片通过 <code>FormData</code> 上传至 Coze 文件服务，获取 <code>file_id</code>；</li>
<li><strong>调用工作流</strong>：携带 <code>file_id</code> 与用户配置参数，调用 Coze 工作流 API；</li>
<li><strong>展示结果</strong>：解析返回的图片 URL 并渲染。</li>
</ol>
<hr/>
<h2 data-id="heading-4">三、代码详解：从模板到逻辑</h2>
<h3 data-id="heading-5">1. 模板结构（Template）</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 图片上传与预览 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"file-input"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"imgPreview"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"imgPreview"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span>
         <span class="hljs-attr">ref</span>=<span class="hljs-string">"uploadImage"</span> 
         <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>
         @<span class="hljs-attr">change</span>=<span class="hljs-string">"updataImageData"</span>
         <span class="hljs-attr">required</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- 配置项：队服、位置、风格等 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"settings"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>队服编号:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"uniform_number"</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>队服颜色:<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"uniform_color"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"红"</span>&gt;</span>红<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"蓝"</span>&gt;</span>蓝<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 其他颜色... --&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"settings"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>位置<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"position"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"0"</span>&gt;</span>守门员<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>前锋<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span>&gt;</span>后卫<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>持杆：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"shooting_hand"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"0"</span>&gt;</span>左手<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>右手<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"selection"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>风格：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"style"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"写实"</span>&gt;</span>写实<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"乐高"</span>&gt;</span>乐高<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 多种艺术风格... --&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
       
      <span class="hljs-comment">&lt;!-- 生成按钮 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"generate"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"generate"</span>&gt;</span>生成<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 输出区域 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"output"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"generated"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"imgUrl"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"imgUrl"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"status"</span>&gt;</span>{{ status }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>  
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：</p>
<ul>
<li>使用 <code>v-if</code> 控制预览图和结果图的显示；</li>
<li><code>accept="image/*"</code> 限制仅可选择图片文件；</li>
<li>所有配置项均通过 <code>v-model</code> 双向绑定到响应式变量。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-6">2. 响应式状态声明（Script Setup）</h3>
<pre><code class="hljs language-ini" lang="ini">import { ref, onMounted } from 'vue'

const <span class="hljs-attr">imgPreview</span> = ref(<span class="hljs-string">''</span>) // 本地预览图（Base64）
const <span class="hljs-attr">uniform_number</span> = ref(<span class="hljs-number">10</span>)
const <span class="hljs-attr">uniform_color</span> = ref(<span class="hljs-string">'红'</span>)
const <span class="hljs-attr">position</span> = ref(<span class="hljs-number">0</span>)
const <span class="hljs-attr">shooting_hand</span> = ref(<span class="hljs-string">'左手'</span>) // 注意：实际传给后端的是 <span class="hljs-number">0</span>/<span class="hljs-number">1</span>，此处为显示用
const <span class="hljs-attr">style</span> = ref(<span class="hljs-string">'写实'</span>)

// 生成状态与结果
const <span class="hljs-attr">status</span> = ref(<span class="hljs-string">''</span>)
const <span class="hljs-attr">imgUrl</span> = ref(<span class="hljs-string">''</span>)

// Coze API 配置
const <span class="hljs-attr">patToken</span> = import.meta.env.VITE_PAT_TOKEN
const <span class="hljs-attr">uploadUrl</span> = <span class="hljs-string">'https://api.coze.cn/v1/files/upload'</span>
const <span class="hljs-attr">workflowUrl</span> = <span class="hljs-string">'https://api.coze.cn/v1/workflow/run'</span>
const <span class="hljs-attr">workflow_id</span> = <span class="hljs-string">'7567272503635771427'</span>
</code></pre>
<blockquote>
<p>🔒 <strong>安全提示</strong>：<code>VITE_PAT_TOKEN</code> 是 Personal Access Token，<strong>绝不能硬编码在代码中</strong>！应通过 <code>.env</code> 文件注入，并确保 <code>.gitignore</code> 中排除该文件。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">3. 图片预览功能：用户体验的关键</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> uploadImage = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(uploadImage.<span class="hljs-property">value</span>) <span class="hljs-comment">// 挂载后指向 input DOM</span>
})
<span class="hljs-comment">// 状态 null -&gt; input DOM  ref也可以用来绑定DOM元素</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updataImageData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> input = uploadImage.<span class="hljs-property">value</span>
  <span class="hljs-keyword">if</span> (!input.<span class="hljs-property">files</span> || input.<span class="hljs-property">files</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-comment">// 文件对象 html新特性</span>
  <span class="hljs-keyword">const</span> file = input.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>() <span class="hljs-comment">// </span>
  reader.<span class="hljs-title function_">readAsDataURL</span>(file)
  <span class="hljs-comment">// readAsDateURL 返回Base64编码的DataURL 可直接用于&lt;img src&gt;</span>
  reader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    imgPreview.<span class="hljs-property">value</span> = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span> <span class="hljs-comment">// // 响应式状态 当拿到图片文件后 立马赋给imgPreview的value 那么此时template中img的src就会接收这个状态 从而响应展示图片</span>
  }
}
</code></pre>
<blockquote>
<p>🌟 <strong>为什么需要预览？</strong></p>
<ul>
<li>用户上传的图片可能较大，上传需时间；</li>
<li>立即显示预览能提升交互反馈感；</li>
<li><code>FileReader.readAsDataURL()</code> 将图片转为 Base64，无需网络请求即可显示。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-8">4. 上传图片到 Coze：获取 file_id</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">uploadFile</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()
  <span class="hljs-keyword">const</span> input = uploadImage.<span class="hljs-property">value</span>
  <span class="hljs-keyword">if</span> (!input.<span class="hljs-property">files</span> || input.<span class="hljs-property">files</span>.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>

  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, input.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>])

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(uploadUrl, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${patToken}</span>`</span>
    },
    <span class="hljs-attr">body</span>: formData
  })

  <span class="hljs-keyword">const</span> ret = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ret)
  <span class="hljs-keyword">if</span> (ret.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {
    status.<span class="hljs-property">value</span> = ret.<span class="hljs-property">msg</span>
    <span class="hljs-keyword">return</span>
    <span class="hljs-comment">// 当code为0时 表示没有错误 那么这里进行判断 当不为0时 返回错误信息给status.value</span>
  }

  <span class="hljs-keyword">return</span> ret.<span class="hljs-property">data</span>.<span class="hljs-property">id</span> <span class="hljs-comment">// 关键：返回 file_id 供后续工作流使用</span>
}
</code></pre>
<blockquote>
<p>⚠️ <strong>常见错误排查</strong>：</p>
<ul>
<li>若返回 <code>{"code":700012006,"msg":"cannot get access token from Authorization header"}</code>，说明 <code>patToken</code> 未正确设置或格式错误；</li>
<li>确保请求头为 <code>'Authorization': 'Bearer xxx'</code>，注意大小写和空格。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-9">5. 调用 Coze 工作流：生成 AI 图像</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">generate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  status.<span class="hljs-property">value</span> = <span class="hljs-string">'图片上传中...'</span>
  <span class="hljs-keyword">const</span> file_id = <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadFile</span>()
  <span class="hljs-keyword">if</span> (!file_id) <span class="hljs-keyword">return</span>

  status.<span class="hljs-property">value</span> = <span class="hljs-string">'图片上传成功，正在生成中...'</span>

  <span class="hljs-keyword">const</span> parameters = {
    <span class="hljs-attr">picture</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ file_id }), <span class="hljs-comment">// 注意：需 stringify</span>
    <span class="hljs-attr">style</span>: style.<span class="hljs-property">value</span>,
    <span class="hljs-attr">uniform_color</span>: uniform_color.<span class="hljs-property">value</span>,
    <span class="hljs-attr">uniform_number</span>: uniform_number.<span class="hljs-property">value</span>,
    <span class="hljs-attr">position</span>: position.<span class="hljs-property">value</span>,
    <span class="hljs-attr">shooting_hand</span>: shooting_hand.<span class="hljs-property">value</span>
  }

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(workflowUrl, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${patToken}</span>`</span>,
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      workflow_id,
      parameters
    })
  })

  <span class="hljs-keyword">const</span> ret = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()
  <span class="hljs-keyword">if</span> (ret.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {
    status.<span class="hljs-property">value</span> = ret.<span class="hljs-property">msg</span>
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(ret.<span class="hljs-property">data</span>) <span class="hljs-comment">// 注意：Coze 返回的是字符串化的 JSON</span>
  imgUrl.<span class="hljs-property">value</span> = data.<span class="hljs-property">data</span>
  status.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>
}
</code></pre>
<blockquote>
<p>❗ <strong>重要细节</strong>：</p>
<ul>
<li><code>picture</code> 字段必须是 <code>JSON.stringify({ file_id })</code>，因为 Coze 工作流节点可能期望字符串输入；</li>
<li><code>ret.data</code> 是字符串，需再次 <code>JSON.parse</code> 才能得到真正的结果对象；</li>
<li>若遇到 <code>{"code":4000,"msg":"The requested API endpoint GET /v1/workflow/run does not exist..."}</code>，说明你用了 <strong>GET</strong> 方法，但该接口只支持 <strong>POST</strong>！</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-10">四、样式与布局（Scoped CSS）</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: row;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
}

<span class="hljs-selector-class">.input</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">330px</span>;
}

<span class="hljs-selector-class">.generated</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">border</span>: solid <span class="hljs-number">1px</span> black;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<blockquote>
<p>✨ 使用 <code>scoped</code> 确保样式隔离，避免污染全局；弹性布局实现左右两栏（配置区 + 结果区）。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">五、总结与延伸</h2>
<p>本项目完整展示了如何将 <strong>前端交互</strong> 与 <strong>AI 工作流</strong> 结合：</p>
<ul>
<li>利用 Vue3 的响应式系统管理状态；</li>
<li>通过 <code>FileReader</code> 实现即时预览；</li>
<li>使用 <code>fetch + FormData</code> 安全上传文件；</li>
<li>调用 Coze API 实现“上传 → 生成 → 展示”闭环。</li>
</ul>
<h3 data-id="heading-12">最后提醒：</h3>
<ul>
<li>务必保护好你的 <code>PAT Token</code>；</li>
<li>遵守 Coze 的 API 调用频率限制，如果无法响应，可以尝试更换你的Coze API；</li>
<li>测试不同风格下的生成效果，优化用户体验。</li>
</ul>
<hr/>
<p>通过这个小而美的项目，你不仅能掌握 Vue3 的实战技巧，还能深入理解如何将 AI 能力无缝集成到 Web 应用中。快去试试吧，让你的宠物穿上冰球队服，成为下一个 AI 冰球明星！🏒🐶</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[攻克制造业知识检索难题：我们如何用Go+AI打造高可用RAG系统，将查询效率提升600%]]></title>    <link>https://juejin.cn/post/7586182451598082094</link>    <guid>https://juejin.cn/post/7586182451598082094</guid>    <pubDate>2025-12-22T04:30:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586182451598082094" data-draft-id="7586167377381965850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="攻克制造业知识检索难题：我们如何用Go+AI打造高可用RAG系统，将查询效率提升600%"/> <meta itemprop="keywords" content="后端,人工智能,Go"/> <meta itemprop="datePublished" content="2025-12-22T04:30:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            攻克制造业知识检索难题：我们如何用Go+AI打造高可用RAG系统，将查询效率提升600%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:30:28.000Z" title="Mon Dec 22 2025 04:30:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>从30分钟到5分钟：一个企业级RAG架构的全链路设计思考</p>
</blockquote>
<h2 data-id="heading-0">前言：制造业的文档之痛</h2>
<p>在大型制造业企业，一线维保人员每天都要面对海量的技术文档：设备手册、故障代码表、维修记录、图纸变更通知...这些文档格式各异（PDF、Excel、HTML），专业术语密集，且分散在各个系统中。</p>
<p>传统的关键词搜索在“螺杆泵G35-2R故障代码E207”这样的专业查询面前显得力不从心。要么搜不到，要么搜不准——一个看似简单的资料查询，平均要<strong>耗费30分钟</strong>。</p>
<p>这正是我们为某大型制造企业定制开发RAG知识库智能助手的背景。今天，我将详细拆解这个项目的架构设计与实战经验，希望能给正在或计划构建企业级AI应用的开发者一些启发。</p>
<h2 data-id="heading-1">一、业务挑战与技术选型</h2>
<h3 data-id="heading-2">1.1 核心痛点</h3>
<ul>
<li><strong>语义鸿沟</strong>：设备型号、故障代码等专有名词传统搜索难以理解</li>
<li><strong>响应延迟</strong>：海量文档索引慢，问答响应时间长</li>
<li><strong>成本控制</strong>：大模型调用成本高昂，且容易产生“幻觉回答”</li>
<li><strong>生态封闭</strong>：知识库能力难以复用到其他AI场景</li>
</ul>
<h3 data-id="heading-3">1.2 技术栈全景</h3>
<pre><code class="hljs language-markdown" lang="markdown">后端框架：Golang + GoFrame (GF)  // 高性能Web服务
AI编排层：CloudWeGo/Eino Graph   // 复杂流程编排
存储层：
<span class="hljs-bullet">  -</span> MySQL（元数据）
<span class="hljs-bullet">  -</span> Elasticsearch（关键词检索）
<span class="hljs-bullet">  -</span> Qdrant（向量检索）
基础设施：
<span class="hljs-bullet">  -</span> Docker容器化
<span class="hljs-bullet">  -</span> Prometheus监控
<span class="hljs-bullet">  -</span> MCP协议（AI能力标准化）
</code></pre>
<p>选择Go语言的核心考量：在高并发文档处理、流式响应等场景下，Go的协程模型能提供卓越的吞吐性能，且部署资源消耗远低于Python方案。</p>
<h2 data-id="heading-4">二、架构设计：四级过滤的RAG流水线</h2>
<p>我们摒弃了简单的“检索-生成”两步走方案，设计了<strong>四级精炼流水线</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">用户查询 → Hybrid <span class="hljs-keyword">Search</span> → Rerank重排 → Grader评分 → LLM生成 → 流式输出
</code></pre>
<h3 data-id="heading-5">2.1 第一关：混合检索（Hybrid Search）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 简化的混合检索逻辑示意</span>
func <span class="hljs-built_in">hybridSearch</span>(query string, topK int) ([]Document, error) {
    <span class="hljs-comment">// 并行执行关键词和向量检索</span>
    <span class="hljs-selector-tag">var</span> keywordResults, vectorResults <span class="hljs-selector-attr">[]</span>Document
    
    wg := sync.WaitGroup{}
    wg<span class="hljs-selector-class">.Add</span>(<span class="hljs-number">2</span>)
    
    go <span class="hljs-built_in">func</span>() {
        defer wg<span class="hljs-selector-class">.Done</span>()
        keywordResults = <span class="hljs-built_in">elasticsearchSearch</span>(query, topK*<span class="hljs-number">2</span>)
    }()
    
    go <span class="hljs-built_in">func</span>() {
        defer wg<span class="hljs-selector-class">.Done</span>() 
        vectorResults = <span class="hljs-built_in">qdrantSearch</span>(query, topK*<span class="hljs-number">2</span>)
    }()
    
    wg<span class="hljs-selector-class">.Wait</span>()
    
    <span class="hljs-comment">// RRF融合排序</span>
    return <span class="hljs-built_in">reciprocalRankFusion</span>(keywordResults, vectorResults, topK), nil
}
</code></pre>
<p><strong>设计思考</strong>：为什么不是纯向量搜索？</p>
<ul>
<li>关键词搜索：保证<strong>查全率</strong>，对精确术语（如“E207”）命中率高</li>
<li>向量搜索：保证<strong>语义理解</strong>，对“设备不转了怎么办”这类描述有效</li>
<li>RRF融合：结合两者优势，1+1&gt;2</li>
</ul>
<h3 data-id="heading-6">2.2 第二关：语义重排（Rerank）</h3>
<p>混合检索返回的Top-20文档，通过专门的Rerank模型（如bge-reranker）进行<strong>精细化相关性排序</strong>。</p>
<p>这个环节将“大致相关”变成“精准相关”。在我们的测试中，经过Rerank后，Top-5文档的相关性评分<strong>从60%提升至85%</strong>。</p>
<h3 data-id="heading-7">2.3 第三关：置信评分（Grader）- 我们的核心创新</h3>
<p>这是我们从实践中提炼出的<strong>关键安全阀</strong>。即便经过前两关，仍可能检索到低质量内容，如果直接喂给LLM，会导致：</p>
<ol>
<li>生成幻觉答案</li>
<li>消耗无效Token（成本浪费）</li>
</ol>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Grader中间件核心逻辑</span>
<span class="hljs-keyword">type</span> GraderMiddleware <span class="hljs-keyword">struct</span> {
    confidenceThreshold <span class="hljs-type">float64</span> <span class="hljs-comment">// 例如0.7</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(g *GraderMiddleware)</span></span> Check(query <span class="hljs-type">string</span>, documents []Document) (<span class="hljs-type">bool</span>, <span class="hljs-type">string</span>) {
    <span class="hljs-comment">// 调用轻量级分类模型评估“文档集是否足以回答问题”</span>
    confidence := evaluateRelevance(query, documents)
    
    <span class="hljs-keyword">if</span> confidence &lt; g.confidenceThreshold {
        <span class="hljs-comment">// 触发熔断，返回兜底回复</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>, <span class="hljs-string">"当前知识库中暂无此问题的准确信息，建议联系技术专家确认。"</span>
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>, <span class="hljs-string">""</span>
}
</code></pre>
<p><strong>效果数据</strong>：</p>
<ul>
<li>拦截约15%的低质量检索</li>
<li>每月节省<strong>20%的大模型调用成本</strong></li>
<li>从源头减少80%的幻觉回答</li>
</ul>
<h3 data-id="heading-8">2.4 第四关：流式生成（Streaming）</h3>
<p>用户体验的最后一公里优化：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 基于SSE的流式输出</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">streamResponse</span><span class="hljs-params">(c *gf.Request, answerChan &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-type">string</span>)</span></span> {
    c.Response.Header().Set(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/event-stream"</span>)
    
    <span class="hljs-keyword">for</span> chunk := <span class="hljs-keyword">range</span> answerChan {
        fmt.Fprintf(c.Response, <span class="hljs-string">"data: %s\n\n"</span>, chunk)
        c.Response.Flush() <span class="hljs-comment">// 立即发送到客户端</span>
    }
}
</code></pre>
<p><strong>关键指标</strong>：</p>
<ul>
<li>首字响应时间（TTFT）&lt; 200ms</li>
<li>用户感知流畅度提升显著</li>
</ul>
<h2 data-id="heading-9">三、Eino Graph：可视化编排复杂AI工作流</h2>
<p>传统AI应用代码像“意大利面条”，各种if-else和回调嵌套。我们采用Eino的Graph（DAG）模式，将整个RAG流程可视化编排：</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[用户查询]</span> --&gt; <span class="hljs-selector-tag">B</span>{Query Understanding}
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[Hybrid Search]</span>
    C --&gt; D<span class="hljs-selector-attr">[Rerank排序]</span>
    D --&gt; E{Grader检查}
    E --&gt;|置信度高| F<span class="hljs-selector-attr">[LLM生成]</span>
    E --&gt;|置信度低| G<span class="hljs-selector-attr">[返回兜底]</span>
    F --&gt; H<span class="hljs-selector-attr">[流式输出]</span>
    G --&gt; H
</code></pre>
<p><strong>Graph编排的优势</strong>：</p>
<ol>
<li><strong>可观测性</strong>：每个节点的执行状态、耗时一目了然</li>
<li><strong>可调试性</strong>：可以单独mock某个节点进行测试</li>
<li><strong>可复用性</strong>：子图可以快速复用到其他场景</li>
</ol>
<h2 data-id="heading-10">四、性能优化实战</h2>
<h3 data-id="heading-11">4.1 索引性能：从串行到并行</h3>
<p>文档索引原本是性能瓶颈，尤其是万页PDF处理。</p>
<p><strong>优化前</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">解析 → 分块 → 向量化 → 存储 (串行，耗时约<span class="hljs-number">40</span>分钟/GB)
</code></pre>
<p><strong>优化后</strong>（利用Eino的Async节点）：</p>
<pre><code class="hljs language-scss" lang="scss">解析 → <span class="hljs-selector-attr">[分块 → 向量化]</span>×N → 存储
         (并行管道)
</code></pre>
<p><strong>成果</strong>：平均处理耗时<strong>降低40%</strong></p>
<h3 data-id="heading-12">4.2 成本优化：Token管理的艺术</h3>
<p>除了Grader拦截外，我们还做了：</p>
<ol>
<li><strong>对话历史摘要</strong>：将长对话历史摘要为关键点，而非全文传递</li>
<li><strong>分块策略优化</strong>：按语义而非固定长度分块，减少冗余</li>
<li><strong>缓存层设计</strong>：高频问题答案缓存，直接返回</li>
</ol>
<h2 data-id="heading-13">五、MCP协议：打开AI生态的钥匙</h2>
<p>这是我们最自豪的设计之一。通过实现Model Context Protocol（MCP），我们将知识库封装成了标准化的AI工具。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// MCP协议配置示例</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search_manufacturing_kb"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"查询制造业知识库"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inputSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>这意味着</strong>：</p>
<ul>
<li>开发人员可以在Cursor中直接调用知识库</li>
<li>可以在Claude Desktop中一键查询设备资料</li>
<li>任何支持MCP的AI客户端都能接入</li>
</ul>
<p>从“又一个内部系统”变成了“AI原生基础设施”。</p>
<h2 data-id="heading-14">六、全链路监控：AI应用的可观测性</h2>
<p>AI应用不是黑盒子，我们建立了完整的监控体系：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Prometheus埋点示例</span>
<span class="hljs-keyword">var</span> (
    retrievalDuration = promauto.NewHistogramVec(
        prometheus.HistogramOpts{
            Name: <span class="hljs-string">"rag_retrieval_duration_seconds"</span>,
            Help: <span class="hljs-string">"检索阶段耗时分布"</span>,
        },
        []<span class="hljs-type">string</span>{<span class="hljs-string">"stage"</span>}, <span class="hljs-comment">// hybrid_search, rerank, grader</span>
    )
    
    tokenUsage = promauto.NewCounterVec(
        prometheus.HistogramOpts{
            Name: <span class="hljs-string">"rag_token_usage_total"</span>,
            Help: <span class="hljs-string">"LLM Token消耗统计"</span>,
        },
        []<span class="hljs-type">string</span>{<span class="hljs-string">"model"</span>, <span class="hljs-string">"type"</span>}, <span class="hljs-comment">// 按模型和输入/输出分别统计</span>
    )
)
</code></pre>
<p>监控看板涵盖：</p>
<ul>
<li>各阶段耗时P95/P99</li>
<li>检索成功率/失败率</li>
<li>Token消耗趋势</li>
<li>用户满意度（通过反馈按钮）</li>
</ul>
<h2 data-id="heading-15">七、业务价值与思考</h2>
<h3 data-id="heading-16">7.1 直接价值</h3>
<ul>
<li><strong>效率提升</strong>：设备故障查询从30分钟→5分钟，<strong>效率提升600%</strong></li>
<li><strong>成本节约</strong>：月均节省20%大模型调用成本</li>
<li><strong>准确率</strong>：专业问题回答准确率&gt;95%</li>
</ul>
<h3 data-id="heading-17">7.2 架构思考：什么是“企业级”RAG？</h3>
<p>通过这个项目，我们总结出企业级RAG的四个核心特征：</p>
<ol>
<li><strong>精准而非泛化</strong>：专有名词理解是生命线</li>
<li><strong>可靠而非炫技</strong>：Grader这样的安全机制必不可少</li>
<li><strong>开放而非封闭</strong>：MCP协议让能力可复用</li>
<li><strong>可控而非黑盒</strong>：全链路监控是运营基础</li>
</ol>
<h3 data-id="heading-18">7.3 给开发者的建议</h3>
<p>如果你正在规划RAG项目：</p>
<p>✅ <strong>一定要做</strong>：</p>
<ul>
<li>设计多级检索过滤机制</li>
<li>实现流式响应提升体验</li>
<li>建立成本监控体系</li>
</ul>
<p>❌ <strong>避免踩坑</strong>：</p>
<ul>
<li>不要相信“纯向量检索解决一切”</li>
<li>不要忽视低质量检索的连锁反应</li>
<li>不要只考虑准确率不考虑响应速度</li>
</ul>
<h2 data-id="heading-19">结语：AI时代的架构师思维</h2>
<p>这个项目给我最深的启示是：在AI时代，架构师的角色正在从“资源管理者”转变为“工作流设计师”。</p>
<p>我们不再只是调API，而是需要：</p>
<ol>
<li><strong>理解业务场景的独特性</strong>（制造业专有名词）</li>
<li><strong>设计复合型AI工作流</strong>（四级过滤）</li>
<li><strong>平衡效果、性能与成本</strong>（Grader机制）</li>
<li><strong>构建开放可观测的系统</strong>（MCP+监控）</li>
</ol>
<p>目前，我们已经将这套架构抽象为可复用的框架，正在帮助更多企业解决他们的知识管理难题。如果你对Go+AI构建企业级应用感兴趣，或者正在面临类似的技术挑战，欢迎交流讨论。</p>
<hr/>
<blockquote>
<p><strong>关于作者</strong>：王中阳，Go/AI全栈开发者，专注帮助开发者用AI提升研发效能与职业竞争力。持续分享Go与AI结合的企业级实战经验。</p>
</blockquote>
<hr/>
<p><strong>一些开放问题供讨论</strong>：</p>
<ol>
<li>在你的业务场景中，RAG最大的技术挑战是什么？</li>
<li>如何平衡检索精度与响应延迟？</li>
<li>你们是如何监控和管理大模型调用成本的？</li>
</ol>
<p>欢迎在评论区分享你的实践与思考！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[四、Node-OPCUA 进阶(2)-OPCUA服务器(一)]]></title>    <link>https://juejin.cn/post/7586167377382064154</link>    <guid>https://juejin.cn/post/7586167377382064154</guid>    <pubDate>2025-12-22T05:09:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586167377382064154" data-draft-id="7585920796100755483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="四、Node-OPCUA 进阶(2)-OPCUA服务器(一) "/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2025-12-22T05:09:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李广山Samuel"/> <meta itemprop="url" content="https://juejin.cn/user/4266544138563288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            四、Node-OPCUA 进阶(2)-OPCUA服务器(一) 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4266544138563288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李广山Samuel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:09:29.000Z" title="Mon Dec 22 2025 05:09:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0"><strong>1.0 写一个简单的node-opcua服务器</strong></h5>
<p>在这个示例中，我们在默认端口上创建了一个空的OPCUA Server。  端点URL是opc.tcp://HOSTNAME:26543，其中HOSTNAME是计算机的名称。</p>
<p><strong>程序结构：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">OPCUAServer</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-opcua"</span>);
(<span class="hljs-keyword">async</span> () =&gt; {
<span class="hljs-keyword">try</span> {
_<span class="hljs-string">"服务器代码"</span>
}
<span class="hljs-keyword">catch</span>(err) {
}
})();
</code></pre>
<p><strong>服务器代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">26543</span> });
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
<span class="hljs-keyword">const</span> endpointUrl = server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">endpointDescriptions</span>()[<span class="hljs-number">0</span>].<span class="hljs-property">endpointUrl</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
<span class="hljs-string">"  服务器启动成功,可以通过 url访问端点:  "</span>,
endpointUrl
);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"按 CTRL+C 停止服务"</span>);
</code></pre>
<p><strong>完整的程序代码 my_</strong><em><strong>first</strong></em>**_server.js：**</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">OPCUAServer</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-opcua"</span>);
(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">26543</span> });
        <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
        <span class="hljs-keyword">const</span> endpointUrl = server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">endpointDescriptions</span>()[<span class="hljs-number">0</span>].<span class="hljs-property">endpointUrl</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
            <span class="hljs-string">" 服务器启动成功,可以通过 url访问端点: "</span>,
            endpointUrl
        );
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"按 CTRL+C 停止服务"</span>);
    }
    <span class="hljs-keyword">catch</span> (err) {
    }
})();
</code></pre>
<h5 data-id="heading-1"><strong>2.0 用Typescript创建一个opcua服务器</strong></h5>
<p>让我们添加chalk模块，它将允许我们在控制台上生成彩色信息。</p>
<pre><code class="hljs language-javascript" lang="javascript">npm install chalk
</code></pre>
<p>下面是代码，程序的框架如下:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// my_first_server_step-1_typescript.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OPCUAServer</span>, <span class="hljs-title class_">ServerState</span>, coerceLocalizedText } <span class="hljs-keyword">from</span> <span class="hljs-string">"node-opcua"</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> chalk <span class="hljs-keyword">from</span> <span class="hljs-string">"chalk"</span>;
(<span class="hljs-keyword">async</span> () =&gt; {
<span class="hljs-keyword">try</span> {
_<span class="hljs-string">"服务器代码"</span>
_<span class="hljs-string">"关闭管理"</span>
}
<span class="hljs-keyword">catch</span>(err) {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"error"</span>, err);
process.<span class="hljs-title function_">exit</span>(-<span class="hljs-number">1</span>);
}
})();
</code></pre>
<p><strong>服务器代码</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({ <span class="hljs-attr">port</span>: <span class="hljs-number">26543</span> });
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
<span class="hljs-keyword">const</span> endpointUrl = server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">endpointDescriptions</span>()[<span class="hljs-number">0</span>].<span class="hljs-property">endpointUrl</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 服务器已运行在 "</span>, endpointUrl);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"按 CTRL+C 停止服务"</span>);
</code></pre>
<p><strong>关闭管理</strong></p>
<p>让我们添加一些代码来优雅地关闭服务器。当用户按下CTRL+C启动服务器的关闭过程时，我们将进行拦截。</p>
<pre><code class="hljs language-javascript" lang="javascript">process.<span class="hljs-title function_">on</span>(<span class="hljs-string">"SIGINT"</span>, <span class="hljs-function">() =&gt;</span> {
_<span class="hljs-string">"防止重新输入"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 收到来自用户的服务器中断 "</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 关闭 ..."</span>);
server.<span class="hljs-property">engine</span>.<span class="hljs-property">serverStatus</span>.<span class="hljs-property">shutdownReason</span> = <span class="hljs-title function_">coerceLocalizedText</span>(<span class="hljs-string">"被管理员关闭"</span>);
server.<span class="hljs-title function_">shutdown</span>(<span class="hljs-number">10000</span>, <span class="hljs-function">() =&gt;</span> {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 关闭结束 "</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 完成 "</span>);
process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">0</span>);
});
});
</code></pre>
<p><strong>防止重新输入</strong></p>
<p>用户可能重复按CTRL+C，我们不希望多次调用shutdown。我们可以通过检查服务器状态来防止这种情况。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (server.<span class="hljs-property">engine</span>.<span class="hljs-property">serverStatus</span>.<span class="hljs-property">state</span> === <span class="hljs-title class_">ServerState</span>.<span class="hljs-property">Shutdown</span>) {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
<span class="hljs-string">"服务器关闭已经请求…关闭将发生在 "</span>,
server.<span class="hljs-property">engine</span>.<span class="hljs-property">serverStatus</span>.<span class="hljs-property">secondsTillShutdown</span>,
<span class="hljs-string">"秒"</span>
);
<span class="hljs-keyword">return</span>;
}
</code></pre>
<p><strong>运行服务器</strong></p>
<p>my_first_server_step-1_typescript.ts</p>
<pre><code class="hljs language-javascript" lang="javascript">npx ts-node-script my_first_server_step-1_typescript.<span class="hljs-property">ts</span>
</code></pre>
<h5 data-id="heading-2"><strong>2.1 指定buildInfo</strong></h5>
<p>在这个示例中，我们在一个自定义端口上创建了一个空的OPCUA服务器，我们还在buildInfo中设置了一些额外的参数。</p>
<p>端点URL是opc.tcp://HOSTNAME:26543，其中HOSTNAME是计算机的名称。</p>
<p><strong>my_first_server_step2.ts</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//my_first_server_step2.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OPCUAServer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"node-opcua"</span>;
(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">try</span> {
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({
<span class="hljs-attr">port</span>: <span class="hljs-number">26543</span>,
<span class="hljs-attr">buildInfo</span>: {
<span class="hljs-attr">manufacturerName</span>: <span class="hljs-string">"公司名"</span>,
<span class="hljs-attr">productName</span>: <span class="hljs-string">"我的第一个OPCUA服务器"</span>,
<span class="hljs-attr">softwareVersion</span>: <span class="hljs-string">"1.0.0"</span>
},
});
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
<span class="hljs-keyword">const</span> endpointUrl = server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-title function_">endpointDescriptions</span>()[<span class="hljs-number">0</span>].<span class="hljs-property">endpointUrl</span>!;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 服务器已运行在 "</span>, endpointUrl);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"按 CTRL+C 停止服务"</span>);
} <span class="hljs-keyword">catch</span> (err) {
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"error"</span>, err);
process.<span class="hljs-title function_">exit</span>(-<span class="hljs-number">1</span>);
}
})();
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot接口防抖大作战，拒绝“手抖”重复提交！]]></title>    <link>https://juejin.cn/post/7586208617603661858</link>    <guid>https://juejin.cn/post/7586208617603661858</guid>    <pubDate>2025-12-22T04:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586208617603661858" data-draft-id="7586482851098542120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot接口防抖大作战，拒绝“手抖”重复提交！"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-22T04:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot接口防抖大作战，拒绝“手抖”重复提交！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:11:51.000Z" title="Mon Dec 22 2025 04:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<h2 data-id="heading-0">一、什么是接口防抖？（又名：救救那个手抖的程序员）</h2>
<p>想象一下这个场景：用户小张在提交订单时，因为网络延迟，他以为没点中那个“提交”按钮，于是疯狂连击了10次！结果...10个一模一样的订单诞生了！</p>
<p><strong>接口防抖</strong> 就像是给按钮加上了一层“冷静期”——“兄弟，你点太快了，先冷静3秒再说！”</p>
<p><strong>防止重复提交</strong> 则是更严格的保安大哥——“同样的身份证（请求）只能进一次，想蒙混过关？没门！”</p>
<p>下面我来教你在SpringBoot中布下天罗地网，拦截这些“手抖攻击”！</p>
<hr/>
<h2 data-id="heading-1">二、实战方案大集合</h2>
<h3 data-id="heading-2">方案1：前端防抖 + 后端令牌锁（双保险）</h3>
<h4 data-id="heading-3">前端防抖代码（JavaScript版）：</h4>
<pre><code class="hljs language-ini" lang="ini">// 给按钮加个“冷静debuff”
let <span class="hljs-attr">isSubmitting</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

function submitOrder() {
    if (isSubmitting) {
        alert("客官您点得太快了，喝口茶歇歇~")<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
    }
    
    <span class="hljs-attr">isSubmitting</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    // 提交请求...
    
    // 3秒后才能再次点击
    setTimeout(() =&gt; {
        <span class="hljs-attr">isSubmitting</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }, 3000)<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-4">后端令牌锁实现：</h4>
<p><strong>步骤1：创建防抖注解</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Target</span>(ElementType.METHOD)
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
public <span class="hljs-variable">@interface</span> PreventDuplicateSubmit {
    <span class="hljs-comment">/**
     * 防抖时间（秒），默认3秒
     */</span>
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">lockTime</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-number">3</span>;
    
    <span class="hljs-comment">/**
     * 锁的key，支持SpEL表达式
     */</span>
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">key</span>() <span class="hljs-selector-tag">default</span> "";
    
    <span class="hljs-comment">/**
     * 提示信息
     */</span>
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">message</span>() <span class="hljs-selector-tag">default</span> "请勿重复提交";
}
</code></pre>
<p><strong>步骤2：实现AOP切面</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class DuplicateSubmitAspect {
    
    <span class="hljs-variable">@Autowired</span>
    private RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-variable">@Autowired</span>
    private HttpServletRequest request;
    
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"@annotation(preventDuplicateSubmit)"</span>)
    public void <span class="hljs-built_in">pointcut</span>(PreventDuplicateSubmit preventDuplicateSubmit) {
    }
    
    <span class="hljs-variable">@Around</span>(<span class="hljs-string">"pointcut(preventDuplicateSubmit)"</span>)
    public Object <span class="hljs-built_in">around</span>(ProceedingJoinPoint joinPoint, 
                        PreventDuplicateSubmit preventDuplicateSubmit) throws Throwable {
        
        <span class="hljs-comment">// 1. 构造锁的key</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">lockKey</span> = <span class="hljs-selector-tag">buildLockKey</span>(joinPoint, preventDuplicateSubmit);
        
        <span class="hljs-comment">// 2. 尝试加锁（setnx操作）</span>
        <span class="hljs-selector-tag">Boolean</span> <span class="hljs-selector-tag">success</span> = <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()
                <span class="hljs-selector-class">.setIfAbsent</span>(lockKey, <span class="hljs-string">"LOCKED"</span>, 
                           preventDuplicateSubmit.<span class="hljs-built_in">lockTime</span>(), TimeUnit.SECONDS);
        
        <span class="hljs-selector-tag">if</span> (Boolean.TRUE.<span class="hljs-built_in">equals</span>(success)) {
            <span class="hljs-comment">// 加锁成功，执行方法</span>
            <span class="hljs-selector-tag">try</span> {
                <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.proceed</span>();
            } <span class="hljs-selector-tag">finally</span> {
                <span class="hljs-comment">// 可以根据业务决定是否立即删除锁</span>
                <span class="hljs-comment">// redisTemplate.delete(lockKey);</span>
            }
        } else {
            <span class="hljs-comment">// 加锁失败，说明重复提交了</span>
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(preventDuplicateSubmit.<span class="hljs-built_in">message</span>());
        }
    }
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">buildLockKey</span>(ProceedingJoinPoint joinPoint, 
                               PreventDuplicateSubmit annotation) {
        <span class="hljs-selector-tag">StringBuilder</span> <span class="hljs-selector-tag">keyBuilder</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">StringBuilder</span>(<span class="hljs-string">"SUBMIT:LOCK:"</span>);
        
        <span class="hljs-comment">// 如果有自定义key</span>
        <span class="hljs-selector-tag">if</span> (StringUtils.<span class="hljs-built_in">isNotBlank</span>(annotation.<span class="hljs-built_in">key</span>())) {
            <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.append</span>(<span class="hljs-built_in">parseKey</span>(joinPoint, annotation.<span class="hljs-built_in">key</span>()));
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-comment">// 默认使用：方法名 + 用户ID + 参数hash</span>
            <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.append</span>(joinPoint.<span class="hljs-built_in">getSignature</span>().<span class="hljs-built_in">toShortString</span>());
            
            <span class="hljs-comment">// 加上用户ID（如果有登录）</span>
            <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">userId</span> = <span class="hljs-selector-tag">getCurrentUserId</span>();
            <span class="hljs-selector-tag">if</span> (userId != null) {
                <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">":"</span>)<span class="hljs-selector-class">.append</span>(userId);
            }
            
            <span class="hljs-comment">// 加上参数摘要</span>
            <span class="hljs-selector-tag">Object</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">args</span> = <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.getArgs</span>();
            <span class="hljs-selector-tag">if</span> (args.length &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">argsHash</span> = <span class="hljs-selector-tag">DigestUtils</span><span class="hljs-selector-class">.md5DigestAsHex</span>(
                    Arrays.<span class="hljs-built_in">deepToString</span>(args).<span class="hljs-built_in">getBytes</span>()
                )<span class="hljs-selector-class">.substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>);
                <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.append</span>(<span class="hljs-string">":"</span>)<span class="hljs-selector-class">.append</span>(argsHash);
            }
        }
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">keyBuilder</span><span class="hljs-selector-class">.toString</span>();
    }
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">getCurrentUserId</span>() {
        <span class="hljs-comment">// 从Token或Session中获取用户ID</span>
        <span class="hljs-comment">// 这里简化处理</span>
        <span class="hljs-selector-tag">return</span> (String) <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.getSession</span>()<span class="hljs-selector-class">.getAttribute</span>(<span class="hljs-string">"userId"</span>);
    }
}
</code></pre>
<p><strong>步骤3：使用示例</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/order"</span>)
public class OrderController {
    
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    <span class="hljs-variable">@PreventDuplicateSubmit</span>(lockTime = <span class="hljs-number">5</span>, message = <span class="hljs-string">"订单正在处理中，请勿重复提交"</span>)
    public ApiResult <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestBody</span> OrderDTO orderDTO) {
        <span class="hljs-comment">// 业务逻辑</span>
        <span class="hljs-selector-tag">orderService</span><span class="hljs-selector-class">.create</span>(orderDTO);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResult</span><span class="hljs-selector-class">.success</span>(<span class="hljs-string">"下单成功"</span>);
    }
    
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/pay"</span>)
    @<span class="hljs-selector-tag">PreventDuplicateSubmit</span>(
        key = <span class="hljs-string">"'PAY:' + #orderNo + ':' + T(com.example.util.UserUtil).getCurrentUserId()"</span>,
        lockTime = <span class="hljs-number">10</span>,
        message = <span class="hljs-string">"支付请求已提交，请勿重复操作"</span>
    )
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ApiResult</span> <span class="hljs-selector-tag">payOrder</span>(String orderNo) {
        <span class="hljs-comment">// 支付逻辑</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResult</span><span class="hljs-selector-class">.success</span>(<span class="hljs-string">"支付成功"</span>);
    }
}
</code></pre>
<h3 data-id="heading-5">方案2：数据库唯一约束（最硬核的方案）</h3>
<p>有时候，最简单的最有效！</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entity</span>
<span class="hljs-variable">@Table</span>(name = <span class="hljs-string">"orders"</span>)
public class Order {
    <span class="hljs-variable">@Id</span>
    <span class="hljs-variable">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)
    private Long id;
    
    <span class="hljs-comment">// 业务唯一号：时间戳 + 用户ID + 随机数</span>
    <span class="hljs-variable">@Column</span>(name = <span class="hljs-string">"order_no"</span>, unique = true, nullable = false)
    private String orderNo;
    
    <span class="hljs-comment">// 或者使用请求ID作为防重</span>
    <span class="hljs-variable">@Column</span>(name = <span class="hljs-string">"request_id"</span>, unique = true)
    private String requestId;
    
    <span class="hljs-comment">// ...其他字段</span>
}

<span class="hljs-variable">@Service</span>
<span class="hljs-variable">@Slf4j</span>
public class OrderService {
    
    <span class="hljs-variable">@Transactional</span>(rollbackFor = Exception.class)
    public void <span class="hljs-built_in">createOrder</span>(OrderDTO dto) {
        <span class="hljs-comment">// 生成唯一请求ID（前端传递或后端生成）</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">requestId</span> = <span class="hljs-selector-tag">dto</span><span class="hljs-selector-class">.getRequestId</span>();
        <span class="hljs-selector-tag">if</span> (StringUtils.<span class="hljs-built_in">isBlank</span>(requestId)) {
            <span class="hljs-selector-tag">requestId</span> = <span class="hljs-selector-tag">UUID</span><span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>();
        }
        
        <span class="hljs-comment">// 检查是否已处理过该请求</span>
        <span class="hljs-selector-tag">if</span> (orderRepository.<span class="hljs-built_in">existsByRequestId</span>(requestId)) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"重复请求被拦截：{}"</span>, requestId);
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"订单已提交，请勿重复操作"</span>);
        }
        
        <span class="hljs-comment">// 创建订单</span>
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>();
        <span class="hljs-selector-tag">order</span><span class="hljs-selector-class">.setRequestId</span>(requestId);
        <span class="hljs-selector-tag">order</span><span class="hljs-selector-class">.setOrderNo</span>(<span class="hljs-built_in">generateOrderNo</span>());
        <span class="hljs-comment">// ...设置其他字段</span>
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">orderRepository</span><span class="hljs-selector-class">.save</span>(order);
        } <span class="hljs-selector-tag">catch</span> (DataIntegrityViolationException e) {
            <span class="hljs-comment">// 捕获唯一约束异常</span>
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"订单已存在，请勿重复提交"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-6">方案3：本地Guava缓存（轻量级方案）</h3>
<p>适合单机部署，简单快捷！</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalDuplicateChecker</span> {
    
    <span class="hljs-comment">// Guava缓存，3秒自动过期</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Boolean</span>&gt; submitCache = <span class="hljs-title class_">CacheBuilder</span>.<span class="hljs-title function_">newBuilder</span>()
            .<span class="hljs-title function_">expireAfterWrite</span>(<span class="hljs-number">3</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>)
            .<span class="hljs-title function_">maximumSize</span>(<span class="hljs-number">10000</span>)
            .<span class="hljs-title function_">build</span>();
    
    <span class="hljs-comment">/**
     * 检查是否重复提交
     * <span class="hljs-doctag">@param</span> key 请求唯一标识
     * <span class="hljs-doctag">@return</span> true=重复提交, false=首次提交
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isDuplicate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 如果key不存在，则放入缓存并返回null</span>
            <span class="hljs-comment">// 如果key存在，则返回缓存的值</span>
            <span class="hljs-keyword">return</span> submitCache.<span class="hljs-title function_">get</span>(key, () -&gt; {
                <span class="hljs-comment">// 这个lambda只在key不存在时执行</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            });
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">ExecutionException</span> e) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 手动放入缓存（用于防止并发时多次通过检查）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">markAsSubmitted</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        submitCache.<span class="hljs-title function_">put</span>(key, <span class="hljs-literal">true</span>);
    }
}

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">LocalDuplicateChecker</span> duplicateChecker;
    
    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/api/submit"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ApiResult</span> <span class="hljs-title function_">submitData</span>(<span class="hljs-params"><span class="hljs-meta">@RequestBody</span> SubmitData data, 
                               HttpServletRequest request</span>) {
        
        <span class="hljs-comment">// 构造唯一key：IP + 用户ID + 数据摘要</span>
        <span class="hljs-title class_">String</span> clientIp = request.<span class="hljs-title function_">getRemoteAddr</span>();
        <span class="hljs-title class_">String</span> userId = <span class="hljs-title function_">getCurrentUserId</span>();
        <span class="hljs-title class_">String</span> dataHash = <span class="hljs-title class_">DigestUtils</span>.<span class="hljs-title function_">md5DigestAsHex</span>(
            <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">toJSONString</span>(data).<span class="hljs-title function_">getBytes</span>()
        ).<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>);
        
        <span class="hljs-title class_">String</span> lockKey = <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"SUBMIT:%s:%s:%s"</span>, 
                                      clientIp, userId, dataHash);
        
        <span class="hljs-keyword">if</span> (duplicateChecker.<span class="hljs-title function_">isDuplicate</span>(lockKey)) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">ApiResult</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"请勿重复提交"</span>);
        }
        
        <span class="hljs-comment">// 标记为已提交</span>
        duplicateChecker.<span class="hljs-title function_">markAsSubmitted</span>(lockKey);
        
        <span class="hljs-comment">// 执行业务逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">processData</span>(data);
    }
}
</code></pre>
<h3 data-id="heading-7">方案4：Token令牌机制（最经典的方案）</h3>
<p>这个方案就像发门票，一张票只能进一个人！</p>
<p><strong>步骤1：生成Token</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenController</span> {
    
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/api/getToken"</span>)</span>
    <span class="hljs-keyword">public</span> ApiResult getToken() {
        String token = UUID.randomUUID().toString();
        
        <span class="hljs-comment">// 存入Redis，有效期5分钟</span>
        redisTemplate.opsForValue().<span class="hljs-keyword">set</span>(
            <span class="hljs-string">"SUBMIT_TOKEN:"</span> + token, 
            <span class="hljs-string">"VALID"</span>, 
            <span class="hljs-number">5</span>, TimeUnit.MINUTES
        );
        
        <span class="hljs-keyword">return</span> ApiResult.success(token);
    }
}
</code></pre>
<p><strong>步骤2：验证Token</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
public class TokenCheckAspect {
    
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"@annotation(needTokenCheck)"</span>)
    public void <span class="hljs-built_in">pointcut</span>(NeedTokenCheck needTokenCheck) {
    }
    
    <span class="hljs-variable">@Around</span>(<span class="hljs-string">"pointcut(needTokenCheck)"</span>)
    public Object <span class="hljs-built_in">checkToken</span>(ProceedingJoinPoint joinPoint, 
                            NeedTokenCheck needTokenCheck) throws Throwable {
        
        <span class="hljs-selector-tag">HttpServletRequest</span> <span class="hljs-selector-tag">request</span> = ((ServletRequestAttributes) 
            RequestContextHolder.<span class="hljs-built_in">getRequestAttributes</span>())<span class="hljs-selector-class">.getRequest</span>();
        
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">token</span> = <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.getHeader</span>(<span class="hljs-string">"X-Submit-Token"</span>);
        <span class="hljs-selector-tag">if</span> (StringUtils.<span class="hljs-built_in">isBlank</span>(token)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(<span class="hljs-string">"提交令牌缺失"</span>);
        }
        
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">redisKey</span> = "<span class="hljs-selector-tag">SUBMIT_TOKEN</span>:" + <span class="hljs-selector-tag">token</span>;
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span> = (String) <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.get</span>(redisKey);
        
        <span class="hljs-selector-tag">if</span> (!<span class="hljs-string">"VALID"</span>.<span class="hljs-built_in">equals</span>(value)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(<span class="hljs-string">"无效的提交令牌"</span>);
        }
        
        <span class="hljs-comment">// 删除令牌（一次性使用）</span>
        <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.delete</span>(redisKey);
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">joinPoint</span><span class="hljs-selector-class">.proceed</span>();
    }
}
</code></pre>
<p><strong>步骤3：前端配合</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 提交前先获取令牌</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitWithToken</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-comment">// 1. 获取令牌</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/getToken'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>());
    
    <span class="hljs-comment">// 2. 携带令牌提交</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/submit'</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">headers</span>: {
            <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
            <span class="hljs-string">'X-Submit-Token'</span>: token
        },
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
    });
    
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h2 data-id="heading-8">三、方案对比总结</h2>



































<table><thead><tr><th align="left">方案</th><th align="left">优点</th><th align="left">缺点</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left"><strong>AOP + Redis锁</strong></td><td align="left">灵活可控，支持复杂规则</td><td align="left">依赖Redis，增加系统复杂度</td><td align="left">分布式系统，需要精细控制</td></tr><tr><td align="left"><strong>数据库唯一约束</strong></td><td align="left">绝对可靠，永不漏网</td><td align="left">对数据库有压力，需要设计唯一键</td><td align="left">核心业务（如支付、订单）</td></tr><tr><td align="left"><strong>本地缓存</strong></td><td align="left">性能极高，零延迟</td><td align="left">仅限单机，集群无效</td><td align="left">单体应用，高频但非核心接口</td></tr><tr><td align="left"><strong>Token机制</strong></td><td align="left">安全性高，前端可控</td><td align="left">需要两次请求，增加交互</td><td align="left">表单提交，需要严格防重</td></tr></tbody></table>
<h2 data-id="heading-9">四、防抖策略选择指南</h2>
<ol>
<li>
<p><strong>根据业务重要性选择</strong>：</p>
<ul>
<li>金融支付 → 数据库唯一约束 + Redis锁（双重保险）</li>
<li>普通表单 → Token机制或AOP锁</li>
<li>查询接口 → 本地缓存防抖</li>
</ul>
</li>
<li>
<p><strong>根据系统架构选择</strong>：</p>
<ul>
<li>单机应用 → 本地缓存最香</li>
<li>分布式集群 → Redis是王道</li>
<li>微服务 → 考虑分布式锁服务</li>
</ul>
</li>
<li>
<p><strong>实用小贴士</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 最佳实践：组合拳！</span>
<span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/important/submit"</span>)
<span class="hljs-variable">@PreventDuplicateSubmit</span>(lockTime = <span class="hljs-number">5</span>)
<span class="hljs-variable">@Transactional</span>(rollbackFor = Exception.class)
public ApiResult <span class="hljs-built_in">importantSubmit</span>(<span class="hljs-variable">@RequestBody</span> <span class="hljs-variable">@Valid</span> RequestDTO dto) {
    <span class="hljs-comment">// 1. 检查请求ID是否重复</span>
    <span class="hljs-selector-tag">checkRequestId</span>(dto.<span class="hljs-built_in">getRequestId</span>());
    
    <span class="hljs-comment">// 2. 执行业务</span>
    <span class="hljs-comment">// 3. 数据库唯一约束兜底</span>
    
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ApiResult</span><span class="hljs-selector-class">.success</span>();
}
</code></pre>
</li>
</ol>
<h2 data-id="heading-10">五、最后</h2>
<ol>
<li><strong>不要过度设计</strong>：简单的业务用简单的方案，杀鸡不要用牛刀</li>
<li><strong>用户体验很重要</strong>：防抖提示要友好，别让用户一脸懵逼</li>
<li><strong>监控不能少</strong>：记录被拦截的请求，分析用户行为</li>
<li><strong>前端也要防</strong>：前后端双重防护才是王道</li>
</ol>
<p>防抖的目的不是为难用户，而是<strong>保护系统和数据的安全</strong>。就像给你的接口穿上防弹衣，既能抵挡"手抖攻击"，又能让正常请求畅通无阻！</p>
<hr/>
<p><strong>程序员防抖口诀</strong>：</p>
<blockquote>
<p>前端防抖先出手，后端加锁不能少。</p>
<p>令牌机制来帮忙，唯一约束最可靠。</p>
<p>根据场景选方案，系统稳定没烦恼。</p>
<p>用户手抖不可怕，我有妙招来护驾！</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e3690d4dfdb481c856f9f5bab62b72a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981511&amp;x-signature=C8aouKSb1dKZyxd%2BAsuOTcK32%2Bg%3D" alt="SpringBoot接口防抖大作战，拒绝“手抖”重复提交！.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python项目部署之pytandic与.env的使用教程]]></title>    <link>https://juejin.cn/post/7586136543954944038</link>    <guid>https://juejin.cn/post/7586136543954944038</guid>    <pubDate>2025-12-22T05:14:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543954944038" data-draft-id="7585897699603251226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python项目部署之pytandic与.env的使用教程"/> <meta itemprop="keywords" content="Docker,Python"/> <meta itemprop="datePublished" content="2025-12-22T05:14:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天下不喵"/> <meta itemprop="url" content="https://juejin.cn/user/9257993379453"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python项目部署之pytandic与.env的使用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/9257993379453/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天下不喵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:14:17.000Z" title="Mon Dec 22 2025 05:14:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Pydantic是什么？为什么这么好用？</h2>
<p>Pydantic是一个基于Python类型提示的<strong>数据验证和设置管理工具库</strong>，它能自动检查数据类型、进行类型转换，还能从.env文件中读取环境变量，让你的配置管理变得简单又安全。</p>
<p>✨ <strong>Pydantic 2.x的优势</strong>：</p>
<ul>
<li>基于标准Python类型注解</li>
<li>自动类型转换与错误提示</li>
<li>支持嵌套模型和复杂校验</li>
<li>通过<code>pydantic-settings</code>支持环境变量</li>
<li><strong>性能提升</strong>：2.x内核部分用Rust重写，比1.x快2倍</li>
</ul>
<h2 data-id="heading-1">二、安装Pydantic和相关依赖</h2>
<pre><code class="hljs language-ini" lang="ini">Bash
编辑
1<span class="hljs-comment"># 安装Pydantic 2.x和pydantic-settings</span>
2pip install pydantic <span class="hljs-attr">pydantic-settings</span>==<span class="hljs-number">2.8</span>.<span class="hljs-number">1</span>
</code></pre>
<blockquote>
<p>💡 提示：<code>pydantic-settings</code>是Pydantic 2.x的环境管理专用包，会自动安装<code>pydantic</code>和<code>python-dotenv</code>。</p>
</blockquote>
<h2 data-id="heading-2">三、创建.env文件</h2>
<p>在项目根目录创建<code>.env</code>文件，添加你的环境变量：</p>
<pre><code class="hljs language-ini" lang="ini">Ini
编辑
1<span class="hljs-comment"># .env 文件示例</span>
<span class="hljs-attr">2DATABASE_URL</span>=postgres://user:password@localhost:<span class="hljs-number">5432</span>/mydb
<span class="hljs-attr">3API_KEY</span>=your_api_key_here
<span class="hljs-attr">4DEBUG_MODE</span>=<span class="hljs-literal">True</span>
</code></pre>
<blockquote>
<p>⚠️ 重要：记得将<code>.env</code>添加到<code>.gitignore</code>中，避免敏感信息泄露！</p>
</blockquote>
<h2 data-id="heading-3">四、使用Pydantic加载.env配置</h2>
<h3 data-id="heading-4">1. 创建配置文件</h3>
<p>在项目中创建<code>config.py</code>：</p>
<pre><code class="hljs language-ini" lang="ini">Python
编辑
1from pydantic_settings import BaseSettings, SettingsConfigDict
2
3class Settings(BaseSettings):
4    DATABASE_URL: str
5    API_KEY: str
6    DEBUG_MODE: <span class="hljs-attr">bool</span> = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 提供默认值</span>
7    
8    <span class="hljs-attr">model_config</span> = SettingsConfigDict(
9        <span class="hljs-attr">env_file</span>=<span class="hljs-string">".env"</span>,  <span class="hljs-comment"># 指定.env文件位置</span>
10        <span class="hljs-attr">env_file_encoding</span>=<span class="hljs-string">'utf-8'</span>,  <span class="hljs-comment"># 编码</span>
11        <span class="hljs-attr">extra</span>=<span class="hljs-string">'ignore'</span>  <span class="hljs-comment"># 忽略未在配置中定义的环境变量</span>
12    )
13
14<span class="hljs-comment"># 实例化配置</span>
<span class="hljs-attr">15settings</span> = Settings()
</code></pre>
<h3 data-id="heading-5">2. 在项目中使用配置</h3>
<pre><code class="hljs language-python" lang="python">Python
编辑
<span class="hljs-number">1</span><span class="hljs-comment"># 使用示例</span>
<span class="hljs-number">2</span><span class="hljs-keyword">def</span> connect_db():
<span class="hljs-number">3</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Connecting to <span class="hljs-subst">{settings.DATABASE_URL}</span> with debug mode: <span class="hljs-subst">{settings.DEBUG_MODE}</span>"</span>)
<span class="hljs-number">4</span>    
<span class="hljs-number">5</span><span class="hljs-comment"># 调用</span>
6connect_db()
</code></pre>
<h2 data-id="heading-6">五、在普通Python虚拟环境中使用</h2>
<h3 data-id="heading-7">1. 创建虚拟环境（venv）</h3>
<pre><code class="hljs language-bash" lang="bash">Bash
编辑
1<span class="hljs-comment"># 创建虚拟环境</span>
2python -m venv venv
3
4<span class="hljs-comment"># 激活虚拟环境</span>
5<span class="hljs-comment"># Windows</span>
6venv\Scripts\activate
7<span class="hljs-comment"># macOS/Linux</span>
8source venv/bin/activate
9
10<span class="hljs-comment"># 安装依赖</span>
11pip install pydantic pydantic-settings
</code></pre>
<h3 data-id="heading-8">2. 验证配置</h3>
<p>在虚拟环境中运行一个简单的测试脚本：</p>
<pre><code class="hljs language-python" lang="python">Python
编辑
<span class="hljs-number">1</span><span class="hljs-comment"># test_config.py</span>
<span class="hljs-number">2</span><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> settings
<span class="hljs-number">3</span>
4<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Database URL: <span class="hljs-subst">{settings.DATABASE_URL}</span>"</span>)
5<span class="hljs-built_in">print</span>(<span class="hljs-string">f"API Key: <span class="hljs-subst">{settings.API_KEY}</span>"</span>)
6<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Debug Mode: <span class="hljs-subst">{settings.DEBUG_MODE}</span>"</span>)
</code></pre>
<pre><code class="hljs language-bash" lang="bash">Bash
编辑
1<span class="hljs-comment"># 运行测试</span>
2python test_config.py
</code></pre>
<p>如果一切正常，你会看到从<code>.env</code>中读取的配置信息。</p>
<h2 data-id="heading-9">六、在Docker中使用Pydantic和.env</h2>
<p>Docker部署时，我们通常会将.env文件作为配置的一部分，但要注意<strong>不要将.env文件添加到Docker镜像中</strong>（避免泄露敏感信息）。</p>
<h3 data-id="heading-10">1. Docker部署方案</h3>
<h4 data-id="heading-11">方案一：通过命令行参数<code>-e</code>传递环境变量</h4>
<pre><code class="hljs language-bash" lang="bash">Dockerfile
编辑
1<span class="hljs-comment"># Dockerfile</span>
2FROM python:3.10-slim
3
4WORKDIR /app
5
6<span class="hljs-comment"># 复制依赖文件</span>
7COPY requirements.txt .
8RUN pip install --no-cache-dir -r requirements.txt
9
10<span class="hljs-comment"># 复制应用代码</span>
11COPY . .
12
13<span class="hljs-comment"># 设置环境变量（推荐方式）</span>
14<span class="hljs-comment"># 通过docker run -e传递，或使用.env文件</span>
15<span class="hljs-comment"># EXPOSE 5000</span>
16CMD [<span class="hljs-string">"python"</span>, <span class="hljs-string">"app.py"</span>]
</code></pre>
<pre><code class="hljs language-ini" lang="ini">Bash
编辑
1<span class="hljs-comment"># 运行容器（通过命令行传递环境变量）</span>
2docker run -p 5000:5000 \
3  -e <span class="hljs-attr">DATABASE_URL</span>=<span class="hljs-string">"postgres://user:password@db:5432/mydb"</span> \
4  -e <span class="hljs-attr">API_KEY</span>=<span class="hljs-string">"your_api_key"</span> \
5  -e <span class="hljs-attr">DEBUG_MODE</span>=<span class="hljs-string">"True"</span> \
6  my-python-app
</code></pre>
<h4 data-id="heading-12">方案二：使用.env文件（Docker Compose推荐）</h4>
<h5 data-id="heading-13">在Docker compose中使用(env_file)</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Yaml</span>
<span class="hljs-string">编辑</span>
<span class="hljs-number">1</span><span class="hljs-comment"># docker-compose.yml</span>
<span class="hljs-attr">2version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">3services:</span>
<span class="hljs-attr">4  app:</span>
<span class="hljs-attr">5    build:</span> <span class="hljs-string">.</span>
<span class="hljs-attr">6    ports:</span>
<span class="hljs-number">7</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">"5000:5000"</span>
<span class="hljs-attr">8    env_file:</span>
<span class="hljs-number">9</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">.env</span>
</code></pre>
<blockquote>
<p>💡 提示：在<code>docker-compose.yml</code>中指定<code>env_file</code>，Docker会自动读取该文件中的环境变量。</p>
</blockquote>
<h5 data-id="heading-14">在docker中使用(--env_file)</h5>
<pre><code class="hljs language-ini" lang="ini">1<span class="hljs-comment"># 运行容器（通过命令行传递环境变量）</span>
2docker run -p 5000:5000 \
3  --env-file $(pwd)/.env.prod  \
4  -e <span class="hljs-attr">API_KEY</span>=<span class="hljs-string">"your_api_key"</span> \
5  -e <span class="hljs-attr">DEBUG_MODE</span>=<span class="hljs-string">"True"</span> \
6  my-python-app

</code></pre>
<pre><code class="hljs"/></pre>
<h3 data-id="heading-15">2. Docker部署完整示例</h3>
<ol>
<li>创建项目结构：</li>
</ol>
<pre><code class="hljs language-Text" lang="Text">编辑
1project/
2├── app.py
3├── config.py
4├── .env
5├── requirements.txt
6└── Dockerfile
</code></pre>
<ol start="2">
<li><code>config.py</code>（已包含在前面部分）</li>
<li><code>app.py</code>：</li>
</ol>
<pre><code class="hljs language-python" lang="python">Python
编辑
<span class="hljs-number">1</span><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> settings
<span class="hljs-number">2</span>
<span class="hljs-number">3</span><span class="hljs-keyword">def</span> main():
<span class="hljs-number">4</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Application starting with DB: <span class="hljs-subst">{settings.DATABASE_URL}</span>"</span>)
<span class="hljs-number">5</span>    <span class="hljs-comment"># 你的应用逻辑</span>
<span class="hljs-number">6</span>
<span class="hljs-number">7</span><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
<span class="hljs-number">8</span>    main()
</code></pre>
<ol start="4">
<li><code>Dockerfile</code>：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql">Dockerfile
编辑
<span class="hljs-number">1</span><span class="hljs-keyword">FROM</span> python:<span class="hljs-number">3.10</span><span class="hljs-operator">-</span>slim
<span class="hljs-number">2</span>
<span class="hljs-number">3</span>WORKDIR <span class="hljs-operator">/</span>app
<span class="hljs-number">4</span>
<span class="hljs-number">5</span><span class="hljs-keyword">COPY</span> requirements.txt .
<span class="hljs-number">6</span>RUN pip install <span class="hljs-comment">--no-cache-dir -r requirements.txt</span>
<span class="hljs-number">7</span>
<span class="hljs-number">8</span><span class="hljs-keyword">COPY</span> . .
<span class="hljs-number">9</span>
<span class="hljs-number">10</span>EXPOSE <span class="hljs-number">5000</span>
<span class="hljs-number">11</span>CMD ["python", "app.py"]
</code></pre>
<ol start="5">
<li><code>requirements.txt</code>：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">Text
编辑
1pydantic
<span class="hljs-attr">2pydantic-settings</span>==<span class="hljs-number">2.8</span>.<span class="hljs-number">1</span>
</code></pre>
<ol start="6">
<li>构建并运行：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">Bash
编辑
1<span class="hljs-comment"># 构建镜像</span>
2docker build -t my-app .
3
4<span class="hljs-comment"># 运行容器（使用.env文件）</span>
5docker run -p 5000:5000 -v $(<span class="hljs-built_in">pwd</span>)/.env:/app/.env my-app  <span class="hljs-comment"># 直接将环境变量映射到容器中，不可取</span>
</code></pre>
<blockquote>
<p>💡 重要：<code>-v $(pwd)/.env:/app/.env</code> 将本地的.env文件挂载到容器中，确保配置正确读取。</p>
</blockquote>
<h2 data-id="heading-16">七、常见问题解决</h2>
<h3 data-id="heading-17">1. 无法读取.env文件</h3>
<ul>
<li>确认文件名是<code>.env</code>（注意开头的点）</li>
<li>确认文件路径正确（在Docker中，确保.env在镜像构建上下文中）</li>
<li>检查<code>model_config</code>中<code>env_file</code>的路径</li>
</ul>
<h3 data-id="heading-18">2. 环境变量类型转换问题</h3>
<p>Pydantic会自动将环境变量转换为指定类型，但要注意：</p>
<ul>
<li><code>DEBUG_MODE</code>在.env中是<code>True</code>，在Python中会是字符串，需要在配置中指定为<code>bool</code></li>
<li>解决方法：在<code>Settings</code>类中明确指定类型，如<code>DEBUG_MODE: bool = False</code></li>
</ul>
<h3 data-id="heading-19">3. 敏感信息泄露</h3>
<ul>
<li><strong>永远不要</strong>将.env文件提交到Git</li>
<li>在Docker中，使用<code>docker secret</code>或云服务的密钥管理</li>
<li>使用<code>env_file</code>时，确保.env文件不在Git中</li>
</ul>
<h2 data-id="heading-20">八、高级技巧</h2>
<h3 data-id="heading-21">1. 多环境配置</h3>
<pre><code class="hljs language-ini" lang="ini">Python
编辑
1<span class="hljs-comment"># config.py</span>
2class Settings(BaseSettings):
3    ENVIRONMENT: <span class="hljs-attr">str</span> = <span class="hljs-string">"dev"</span>
4    
5    class Config:
6        <span class="hljs-attr">env_file</span> = f<span class="hljs-string">".env.{ENVIRONMENT}"</span>
7        <span class="hljs-attr">env_file_encoding</span> = <span class="hljs-string">'utf-8'</span>
</code></pre>
<p>然后创建<code>.env.dev</code>、<code>.env.prod</code>等文件，通过设置<code>ENVIRONMENT</code>环境变量切换。</p>
<h3 data-id="heading-22">2. 使用@env()函数（Data API Builder）</h3>
<p>如果你在使用Data API Builder，可以这样使用：</p>
<pre><code class="hljs language-perl" lang="perl">Json
编辑
<span class="hljs-number">1</span>{
<span class="hljs-number">2</span>  <span class="hljs-string">"data-source"</span>: {
<span class="hljs-number">3</span>    <span class="hljs-string">"connection-string"</span>: <span class="hljs-string">"@env('DATABASE_URL')"</span>
<span class="hljs-number">4</span>  }
<span class="hljs-number">5</span>}
</code></pre>
<h3 data-id="heading-23">3. 与FastAPI集成</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Python
编辑
1from fastapi <span class="hljs-keyword">import</span> FastAPI
2from config <span class="hljs-keyword">import</span> settings
<span class="hljs-number">3</span>
4app = FastAPI()
<span class="hljs-number">5</span>
<span class="hljs-number">6</span><span class="hljs-meta">@app</span>.<span class="hljs-keyword">get</span>(<span class="hljs-string">"/"</span>)
7def read_root():
<span class="hljs-number">8</span>    <span class="hljs-keyword">return</span> {<span class="hljs-string">"database"</span>: settings.DATABASE_URL}
</code></pre>
<h2 data-id="heading-24">总结</h2>
<p>Pydantic + .env的组合是Python配置管理的黄金搭档！它让你的项目配置变得清晰、安全、可维护。</p>
<ul>
<li>在<strong>普通Python环境</strong>中，用venv隔离环境，用Pydantic读取.env</li>
<li>在<strong>Docker部署</strong>中，通过<code>env_file</code>或命令行传递环境变量</li>
<li>保持<code>.env</code>文件在<code>.gitignore</code>中，保护敏感信息</li>
</ul>
<h2 data-id="heading-25">九、实际使用遇到的问题汇总</h2>
<h4 data-id="heading-26">1. 带空格的字符串</h4>
<p>原本以为，带空格的值，可能需要加单引号或者双引号，以避免解析不全的问题。然而这样实际反而会出问题。
带空格的字符串不需要加单引号或者双引号，否则引号会被解析为值的一部分，且<code>pydantic</code>的值为<code>=</code>右侧的值，故不会受值中间的空格影响</p>
<pre><code class="hljs language-.env" lang=".env">a=a b  //解析为a="a b"
a="a b" //解析为a='"a b"'

</code></pre>
<h4 data-id="heading-27">2. 列表元素</h4>
<p>我的使用场景是需要传入两个字符串，且字符串的取值是固定的。
例如</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># config.py</span>
<span class="hljs-keyword">from</span> pydantic-settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    lang:<span class="hljs-type">List</span>[[<span class="hljs-type">Literal</span>[<span class="hljs-string">"python"</span>,<span class="hljs-string">"java"</span>,<span class="hljs-string">"c"</span>,<span class="hljs-string">"go"</span>]]

</code></pre>
<pre><code class="hljs language-text" lang="text"># .env
LANG=python,java # 解析失败，未解析为列表
LANG="python","java"  # 也解析失败
LANG=["python","java"] # 可行
</code></pre>
<h4 data-id="heading-28">3. <code>.env</code>文件命名</h4>
<p>实际上，并非只可使用<code>.env</code>命名，加其他后缀也可以，比如<code>.env.test</code>，<code>.env.prod</code>等
但是必须显式声明</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># config.py</span>
<span class="hljs-keyword">from</span> pydantic-settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    lang:<span class="hljs-type">List</span>[[<span class="hljs-type">Literal</span>[<span class="hljs-string">"python"</span>,<span class="hljs-string">"java"</span>,<span class="hljs-string">"c"</span>,<span class="hljs-string">"go"</span>]]

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
        env_file = <span class="hljs-string">".env.prod"</span> <span class="hljs-comment"># 声明env文件名称</span>
</code></pre>
<pre><code class="hljs language-docker" lang="docker">docker run -p 5000:5000 \
  --env-file $(pwd)/.env.prod  \
  -e API_KEY="your_api_key" \
  -e DEBUG_MODE="True" \
  my-python-app

</code></pre>
<h4 data-id="heading-29">4. 环境变量前缀<code>env_prefix</code></h4>
<p><code>env_prefix</code>非必选项，可用不做设置，但是如果有有个环境，或者服务需要做区分时，可以设置用作区分。
<code>.env</code>中的环境变量去掉<code>env_prefix</code>后，即为配置文件中的环境变量
例如</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># config.py</span>
<span class="hljs-keyword">from</span> pydantic-settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    lang:<span class="hljs-type">List</span>[[<span class="hljs-type">Literal</span>[<span class="hljs-string">"python"</span>,<span class="hljs-string">"java"</span>,<span class="hljs-string">"c"</span>,<span class="hljs-string">"go"</span>]]

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
        env_file = <span class="hljs-string">".env.prod"</span> <span class="hljs-comment"># 声明env文件名称</span>
        env_prefix=test
</code></pre>
<pre><code class="hljs language-text" lang="text"># .env
TEST_LANG=["python","java"] # 可行
</code></pre>
<h4 data-id="heading-30">5. <code>.env</code>文件中变量名为对应的python配置类中的环境变量全部字母大写</h4>
<h4 data-id="heading-31">6. <code>.env</code>文件中只存放不敏感的环境变量，敏感环境变量可以使用<code>-e</code>参数在docker运行时设置</h4>
<h4 data-id="heading-32">7. <code>pydantic-settings</code>接受默认值，但是如果是必填项，则不设默认值</h4>
<h4 data-id="heading-33">8. <code>pydantic</code>支持参数类型校验，与python的类型声明用法完全一致</h4>
<h4 data-id="heading-34">9. 同一个环境变量，不同设置方式的优先顺序</h4>
<p><code>pydantic-settings</code> 完全支持为从 <code>.env</code> 文件读取的环境变量<strong>设置默认值</strong>，但<strong>仅在未找到环境变量时才会使用这些默认值</strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43499921%2Farticle%2Fdetails%2F153728040" target="_blank" title="https://blog.csdn.net/qq_43499921/article/details/153728040" ref="nofollow noopener noreferrer">-1</a><a href="https://juejin.cn/post/7513916131243491365" target="_blank" title="https://juejin.cn/post/7513916131243491365">-4</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_41783424%2Farticle%2Fdetails%2F149642013" target="_blank" title="https://blog.csdn.net/weixin_41783424/article/details/149642013" ref="nofollow noopener noreferrer">-10</a>。</p>
<p>理解其工作原理和最佳实践至关重要，这能帮你构建健壮的配置系统。</p>
<h3 data-id="heading-35">⚙️ 默认值的工作原理与优先级</h3>
<p><code>pydantic-settings</code> 的配置加载遵循一个固定的优先级顺序。核心原则是：<strong>优先级高的来源会覆盖优先级低的来源</strong>。</p>
<p>其四层加载优先级如下（从高到低）：</p>



































<table><thead><tr><th>优先级</th><th>配置来源</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>1. 最高</strong></td><td><strong>初始化参数</strong></td><td>实例化模型时直接传入的值。</td><td><code>Settings(api_key="直接传入的值")</code></td></tr><tr><td><strong>2. 次高</strong></td><td><strong>系统环境变量</strong></td><td>操作系统中的环境变量。</td><td>在终端设置 <code>export APP_API_KEY=env_value</code></td></tr><tr><td><strong>3. 中</strong></td><td><strong><code>.env</code> 文件变量</strong></td><td>项目目录下的 <code>.env</code> 文件中定义的值<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43499921%2Farticle%2Fdetails%2F153728040" target="_blank" title="https://blog.csdn.net/qq_43499921/article/details/153728040" ref="nofollow noopener noreferrer">-1</a><a href="https://juejin.cn/post/7513916131243491365" target="_blank" title="https://juejin.cn/post/7513916131243491365">-4</a>。</td><td>在 <code>.env</code> 中写 <code>APP_API_KEY=dotenv_value</code></td></tr><tr><td><strong>4. 最低</strong></td><td><strong>模型字段默认值</strong></td><td>在 <code>Settings</code> 类中为字段定义的默认值。</td><td><code>api_key: str = “default_value”</code></td></tr></tbody></table>
<h3 data-id="heading-36">📝 如何设置默认值</h3>
<p>设置默认值非常简单，主要有以下两种方式：</p>
<ol>
<li>
<p><strong>直接赋值</strong>：这是最直接的方法，在字段类型注解后直接赋值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic_settings <span class="hljs-keyword">import</span> BaseSettings

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    database_host: <span class="hljs-built_in">str</span> = <span class="hljs-string">"localhost"</span>  <span class="hljs-comment"># 默认值</span>
    api_key: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># 没有默认值，必须从环境变量或.env文件提供</span>
    port: <span class="hljs-built_in">int</span> = <span class="hljs-number">8000</span>  <span class="hljs-comment"># 默认值，并自动完成类型转换</span>
</code></pre>
</li>
<li>
<p><strong>使用 <code>Field</code> 函数</strong>：当需要更复杂的配置（如设置别名、添加描述）时，可以使用 <code>Field</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic_settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> Field

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Settings</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    db_host: <span class="hljs-built_in">str</span> = Field(
        default=<span class="hljs-string">"127.0.0.1"</span>,  <span class="hljs-comment"># 默认值</span>
        validation_alias=<span class="hljs-string">"DB_HOST"</span>  <span class="hljs-comment"># 指定从 DB_HOST 环境变量读取</span>
    )
</code></pre>
</li>
</ol>
<h3 data-id="heading-37">✅ 是否建议设置默认值？分情况讨论</h3>
<p>这取决于配置项的性质和项目的运行环境。</p>
<h4 data-id="heading-38"><strong>建议设置默认值的情况</strong></h4>
<ul>
<li><strong>本地开发/测试环境</strong>：为非敏感配置（如数据库端口、日志级别）设置本地默认值，可以简化开发流程。</li>
<li><strong>非关键且有合理后备值的配置</strong>：例如，应用名称、超时时间、可选功能的开关。</li>
<li><strong>提供清晰的配置示例</strong>：默认值可以作为一种配置格式的文档，让其他开发者快速理解。</li>
</ul>
<h4 data-id="heading-39"><strong>不建议设置默认值（或应设置为空值）的情况</strong></h4>
<ul>
<li><strong>敏感信息</strong>：<strong>绝对不要</strong>为 <code>API密钥</code>、<code>数据库密码</code>、<code>加密盐</code> 等敏感信息设置硬编码的默认值，尤其是生产环境的。应强制从外部环境变量或保密管理服务加载<a href="https://juejin.cn/post/7513916131243491365" target="_blank" title="https://juejin.cn/post/7513916131243491365">-4</a>。</li>
<li><strong>环境差异性大的配置</strong>：如数据库连接字符串，在不同环境（开发、测试、生产）中必然不同，应由环境变量或 <code>.env</code> 文件明确指定。</li>
<li><strong>防止本地配置泄漏到生产环境</strong>：如果本地开发使用了带默认值的配置，可能会无意中让生产环境应用运行在不正确的配置下。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[享元模式深度解析：看Java如何优雅节省内存]]></title>    <link>https://juejin.cn/post/7585897699603759130</link>    <guid>https://juejin.cn/post/7585897699603759130</guid>    <pubDate>2025-12-22T04:34:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603759130" data-draft-id="7586136543954829350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="享元模式深度解析：看Java如何优雅节省内存"/> <meta itemprop="keywords" content="设计模式,Java"/> <meta itemprop="datePublished" content="2025-12-22T04:34:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            享元模式深度解析：看Java如何优雅节省内存
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:34:41.000Z" title="Mon Dec 22 2025 04:34:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">享元模式深度解析：从原理到实战，看Java如何优雅节省内存</h2>
<h3 data-id="heading-1">前言</h3>
<p>在当今互联网高并发场景下，系统性能优化已成为每个开发者必须面对的挑战。你是否遇到过这样的问题：创建大量相似对象导致内存暴涨？频繁创建销毁对象引发GC频繁？今天，我们将深入探讨一个经典而强大的设计模式——<strong>享元模式（Flyweight Pattern）</strong> ，看它如何在JDK源码、各大开源框架中大显身手，帮助我们优雅地解决这些难题。</p>
<h3 data-id="heading-2">一、什么是享元模式？</h3>
<h3 data-id="heading-3">1.1 核心概念</h3>
<p>享元模式是一种结构型设计模式，其核心思想是：<strong>通过共享技术有效支持大量细粒度对象的复用</strong>。简单来说，就是将对象的状态分为<strong>内部状态</strong>和<strong>外部状态</strong>：</p>
<pre><code class="hljs">内部状态（Intrinsic State）：存储在享元对象内部，不会随环境改变而改变，可以共享
外部状态（Extrinsic State）：随环境改变而改变，不可共享，由客户端保存并在需要时传入
</code></pre>
<h3 data-id="heading-4">1.2 适用场景</h3>
<p>享元模式特别适合以下场景：</p>
<pre><code class="hljs">系统中存在大量相似对象，这些对象占用大量内存
对象的大部分状态可以外部化，可以将这些外部状态传入对象中
使用享元模式需要维护一个享元池，且这种额外开销能被节省的内存抵消
需要缓冲池的场景，如数据库连接池、线程池等
</code></pre>
<h3 data-id="heading-5">1.3 模式结构</h3>
<p>享元模式主要包含以下角色：</p>
<pre><code class="hljs">Flyweight（抽象享元）：定义享元对象的接口，通过该接口可以接受并作用于外部状态
ConcreteFlyweight（具体享元）：实现抽象享元接口，为内部状态增加存储空间
UnsharedConcreteFlyweight（非共享享元）：不需要共享的享元子类
FlyweightFactory（享元工厂）：负责创建和管理享元对象，确保合理地共享享元
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a20cbb78272e43cc9293607352d9c9cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=7chF3afsEN5denCH51ZGD106uAU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">二、经典案例：五子棋游戏中的棋子管理</h3>
<h3 data-id="heading-7">2.1 问题场景</h3>
<p>想象一个五子棋游戏，棋盘有15×15=225个位置，每个位置可能放置黑棋或白棋。如果为每个棋子都创建一个对象，内存消耗巨大。但实际上，所有黑棋的颜色、形状都相同，只有位置不同。</p>
<h3 data-id="heading-8">2.2 代码实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 抽象享元：棋子接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ChessPiece</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>;
}

<span class="hljs-comment">// 具体享元：具体棋子</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteChessPiece</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChessPiece</span> {
    <span class="hljs-keyword">private</span> String color; <span class="hljs-comment">// 内部状态：颜色</span>
    <span class="hljs-keyword">private</span> String shape; <span class="hljs-comment">// 内部状态：形状</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConcreteChessPiece</span><span class="hljs-params">(String color)</span> {
        <span class="hljs-built_in">this</span>.color = color;
        <span class="hljs-built_in">this</span>.shape = <span class="hljs-string">"圆形"</span>;
        System.out.println(<span class="hljs-string">"创建了一个"</span> + color + <span class="hljs-string">"棋子对象"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
        System.out.println(<span class="hljs-string">"在位置["</span> + x + <span class="hljs-string">","</span> + y + <span class="hljs-string">"]放置"</span> + color + shape + <span class="hljs-string">"棋子"</span>);
    }
}

<span class="hljs-comment">// 享元工厂</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChessPieceFactory</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, ChessPiece&gt; pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ChessPiece <span class="hljs-title function_">getChessPiece</span><span class="hljs-params">(String color)</span> {
        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">piece</span> <span class="hljs-operator">=</span> pool.get(color);
        <span class="hljs-keyword">if</span> (piece == <span class="hljs-literal">null</span>) {
            piece = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteChessPiece</span>(color);
            pool.put(color, piece);
        }
        <span class="hljs-keyword">return</span> piece;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTotalPieces</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> pool.size();
    }
}

<span class="hljs-comment">// 客户端测试</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChessGame</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 放置10个棋子</span>
        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">black1</span> <span class="hljs-operator">=</span> ChessPieceFactory.getChessPiece(<span class="hljs-string">"黑色"</span>);
        black1.display(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">white1</span> <span class="hljs-operator">=</span> ChessPieceFactory.getChessPiece(<span class="hljs-string">"白色"</span>);
        white1.display(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);

        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">black2</span> <span class="hljs-operator">=</span> ChessPieceFactory.getChessPiece(<span class="hljs-string">"黑色"</span>);
        black2.display(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>);

        <span class="hljs-type">ChessPiece</span> <span class="hljs-variable">white2</span> <span class="hljs-operator">=</span> ChessPieceFactory.getChessPiece(<span class="hljs-string">"白色"</span>);
        white2.display(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);

        System.out.println(<span class="hljs-string">"\n实际创建的棋子对象数量："</span> + ChessPieceFactory.getTotalPieces());
        System.out.println(<span class="hljs-string">"black1 == black2: "</span> + (black1 == black2)); <span class="hljs-comment">// true</span>
    }
}
</code></pre>
<p><strong>输出结果：</strong></p>
<pre><code class="hljs language-ini" lang="ini">创建了一个黑色棋子对象
在位置<span class="hljs-section">[1,1]</span>放置黑色圆形棋子
创建了一个白色棋子对象
在位置<span class="hljs-section">[1,2]</span>放置白色圆形棋子
在位置<span class="hljs-section">[2,1]</span>放置黑色圆形棋子
在位置<span class="hljs-section">[2,2]</span>放置白色圆形棋子

实际创建的棋子对象数量：2
<span class="hljs-attr">black1</span> == black2: <span class="hljs-literal">true</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f59fe6ad78a04b78a1c07503c8d5437a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=oi2U%2FwyOkO2Wl4WVl4nhfUFQW4M%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">三、JDK中的享元模式应用</h3>
<h3 data-id="heading-10">3.1 String常量池</h3>
<p>Java的String常量池是享元模式的典型应用。当我们使用字符串字面量时，JVM会自动将其放入常量池中实现共享。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringPoolExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 字符串字面量，存储在常量池中</span>
        <span class="hljs-title class_">String</span> s1 = <span class="hljs-string">"Hello"</span>;
        <span class="hljs-title class_">String</span> s2 = <span class="hljs-string">"Hello"</span>;
        <span class="hljs-title class_">String</span> s3 = <span class="hljs-string">"Hello"</span>;

        <span class="hljs-comment">// 使用new关键字，创建新对象</span>
        <span class="hljs-title class_">String</span> s4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"Hello"</span>);

        <span class="hljs-comment">// 手动调用intern()，将字符串加入常量池</span>
        <span class="hljs-title class_">String</span> s5 = s4.<span class="hljs-title function_">intern</span>();

        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1 == s2: "</span> + (s1 == s2)); <span class="hljs-comment">// true</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1 == s3: "</span> + (s1 == s3)); <span class="hljs-comment">// true</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1 == s4: "</span> + (s1 == s4)); <span class="hljs-comment">// false</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1 == s5: "</span> + (s1 == s5)); <span class="hljs-comment">// true</span>

        <span class="hljs-comment">// 查看对象地址</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"\n对象地址："</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s1: "</span> + <span class="hljs-title class_">System</span>.<span class="hljs-title function_">identityHashCode</span>(s1));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s2: "</span> + <span class="hljs-title class_">System</span>.<span class="hljs-title function_">identityHashCode</span>(s2));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"s4: "</span> + <span class="hljs-title class_">System</span>.<span class="hljs-title function_">identityHashCode</span>(s4));
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c055edc8ad52479882fd5bb81fe75981~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=4brV0LmrTSFeED6R0X9gwpRIHXs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">四、生产级应用：数据库连接池</h3>
<h3 data-id="heading-12">4.1 为什么需要连接池？</h3>
<p>数据库连接是一种重量级资源，创建和销毁连接的开销非常大：</p>
<ul>
<li>TCP三次握手建立连接：耗时10-50ms</li>
<li>数据库认证过程：耗时5-20ms</li>
<li>资源分配（内存、文件描述符等）
如果每次数据库操作都创建新连接，在高并发场景下系统性能将严重下降。</li>
</ul>
<h3 data-id="heading-13">4.2 简化版连接池实现</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 数据库连接（享元对象）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DatabaseConnection</span> {
    <span class="hljs-keyword">private</span> String connectionId;
    <span class="hljs-keyword">private</span> boolean inUse;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DatabaseConnection</span>(<span class="hljs-params">String id</span>)</span> {
        <span class="hljs-keyword">this</span>.connectionId = id;
        <span class="hljs-keyword">this</span>.inUse = <span class="hljs-literal">false</span>;
        <span class="hljs-comment">// 模拟创建连接的耗时操作</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">100</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"创建数据库连接："</span> + id);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeQuery</span>(<span class="hljs-params">String sql</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"["</span> + connectionId + <span class="hljs-string">"] 执行SQL: "</span> + sql);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">isInUse</span>()</span> {
        <span class="hljs-keyword">return</span> inUse;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setInUse</span>(<span class="hljs-params">boolean inUse</span>)</span> {
        <span class="hljs-keyword">this</span>.inUse = inUse;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getConnectionId</span>()</span> {
        <span class="hljs-keyword">return</span> connectionId;
    }
}

<span class="hljs-comment">// 连接池工厂（享元工厂）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-built_in">int</span> POOL_SIZE = <span class="hljs-number">5</span>;
    <span class="hljs-keyword">private</span> List&lt;DatabaseConnection&gt; connections = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ConnectionPool</span>()</span> {
        <span class="hljs-comment">// 初始化连接池</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; POOL_SIZE; i++) {
            connections.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> DatabaseConnection(<span class="hljs-string">"CONN-"</span> + (i + <span class="hljs-number">1</span>)));
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> synchronized DatabaseConnection <span class="hljs-title">getConnection</span>()</span> {
        <span class="hljs-keyword">for</span> (DatabaseConnection conn : connections) {
            <span class="hljs-keyword">if</span> (!conn.isInUse()) {
                conn.setInUse(<span class="hljs-literal">true</span>);
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"从连接池获取连接："</span> + conn.getConnectionId());
                <span class="hljs-keyword">return</span> conn;
            }
        }
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"连接池已满，等待中..."</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title">releaseConnection</span>(<span class="hljs-params">DatabaseConnection conn</span>)</span> {
        conn.setInUse(<span class="hljs-literal">false</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"释放连接回连接池："</span> + conn.getConnectionId());
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getAvailableCount</span>()</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">int</span>) connections.stream().filter(c -&gt; !c.isInUse()).count();
    }
}

<span class="hljs-comment">// 测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ConnectionPoolTest</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-built_in">long</span> startTime = System.currentTimeMillis();

        ConnectionPool pool = <span class="hljs-keyword">new</span> ConnectionPool();
        <span class="hljs-built_in">long</span> initTime = System.currentTimeMillis() - startTime;
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"连接池初始化耗时："</span> + initTime + <span class="hljs-string">"ms\n"</span>);

        <span class="hljs-comment">// 模拟10次数据库操作</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            DatabaseConnection conn = pool.getConnection();
            <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
                conn.executeQuery(<span class="hljs-string">"SELECT * FROM users WHERE id = "</span> + i);
                pool.releaseConnection(conn);
            }
        }

        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n可用连接数："</span> + pool.getAvailableCount());
    }
}
</code></pre>
<h3 data-id="heading-14">4.3 对比：使用vs不使用连接池</h3>



































<table><thead><tr><th>指标</th><th>不使用连接池</th><th>使用连接池</th><th>性能提升</th></tr></thead><tbody><tr><td>每次操作耗时</td><td>~150ms</td><td>~5ms</td><td>30倍</td></tr><tr><td>1000次操作总耗时</td><td>~150秒</td><td>~5秒</td><td>30倍</td></tr><tr><td>内存占用</td><td>不稳定（频繁GC）</td><td>稳定</td><td>减少70%</td></tr><tr><td>并发能力</td><td>低</td><td>高</td><td>提升80%</td></tr></tbody></table>
<h3 data-id="heading-15"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ac4bbe7708d4878913fc615075708be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=TYSuS6K9T5gPJoLREzo0QKzShm4%3D" alt="" loading="lazy"/></h3>
<h3 data-id="heading-16">五、开源框架中的享元模式</h3>
<h3 data-id="heading-17">5.1 Apache Commons Pool</h3>
<p>Apache Commons Pool是一个通用的对象池化框架，广泛应用于各种池化场景。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> org.apache.commons.pool2.BasePooledObjectFactory;
<span class="hljs-keyword">import</span> org.apache.commons.pool2.PooledObject;
<span class="hljs-keyword">import</span> org.apache.commons.pool2.impl.DefaultPooledObject;
<span class="hljs-keyword">import</span> org.apache.commons.pool2.impl.GenericObjectPool;
<span class="hljs-keyword">import</span> org.apache.commons.pool2.impl.GenericObjectPoolConfig;

<span class="hljs-comment">// 定义可池化的对象</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpensiveObject</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> id;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ExpensiveObject</span><span class="hljs-params">(<span class="hljs-type">String</span> id)</span> </span>{
        <span class="hljs-keyword">this</span>.id = id;
        <span class="hljs-comment">// 模拟耗时的创建过程</span>
        <span class="hljs-keyword">try</span> {
            Thread.<span class="hljs-built_in">sleep</span>(<span class="hljs-number">50</span>);
        } <span class="hljs-built_in">catch</span> (InterruptedException e) {
            e.<span class="hljs-built_in">printStackTrace</span>();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">doWork</span><span class="hljs-params">(<span class="hljs-type">String</span> task)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"["</span> + id + <span class="hljs-string">"] 执行任务: "</span> + task);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> id;
    }
}

<span class="hljs-comment">// 对象工厂</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpensiveObjectFactory</span> extends BasePooledObjectFactory&lt;ExpensiveObject&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> counter = <span class="hljs-number">0</span>;

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> ExpensiveObject <span class="hljs-title">create</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ExpensiveObject</span>(<span class="hljs-string">"OBJ-"</span> + (++counter));
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> PooledObject&lt;ExpensiveObject&gt; <span class="hljs-title">wrap</span><span class="hljs-params">(ExpensiveObject obj)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultPooledObject&lt;&gt;(obj);
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">destroyObject</span><span class="hljs-params">(PooledObject&lt;ExpensiveObject&gt; p)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"销毁对象: "</span> + p.<span class="hljs-built_in">getObject</span>().<span class="hljs-built_in">getId</span>());
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsPoolExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> throws Exception </span>{
        <span class="hljs-comment">// 配置对象池</span>
        GenericObjectPoolConfig&lt;ExpensiveObject&gt; config = <span class="hljs-keyword">new</span> GenericObjectPoolConfig&lt;&gt;();
        config.<span class="hljs-built_in">setMaxTotal</span>(<span class="hljs-number">5</span>);  <span class="hljs-comment">// 最大对象数</span>
        config.<span class="hljs-built_in">setMaxIdle</span>(<span class="hljs-number">3</span>);   <span class="hljs-comment">// 最大空闲对象数</span>
        config.<span class="hljs-built_in">setMinIdle</span>(<span class="hljs-number">1</span>);   <span class="hljs-comment">// 最小空闲对象数</span>

        <span class="hljs-comment">// 创建对象池</span>
        GenericObjectPool&lt;ExpensiveObject&gt; pool =
            <span class="hljs-keyword">new</span> GenericObjectPool&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-built_in">ExpensiveObjectFactory</span>(), config);

        <span class="hljs-comment">// 使用对象池</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            ExpensiveObject obj = pool.<span class="hljs-built_in">borrowObject</span>();
            obj.<span class="hljs-built_in">doWork</span>(<span class="hljs-string">"任务-"</span> + i);
            pool.<span class="hljs-built_in">returnObject</span>(obj);
        }

        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n池化统计："</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"创建对象数："</span> + pool.<span class="hljs-built_in">getCreatedCount</span>());
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"当前活跃对象数："</span> + pool.<span class="hljs-built_in">getNumActive</span>());
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"当前空闲对象数："</span> + pool.<span class="hljs-built_in">getNumIdle</span>());

        pool.<span class="hljs-built_in">close</span>();
    }
}
</code></pre>
<h3 data-id="heading-18">5.2 线程池（ThreadPoolExecutor）</h3>
<p>Java的线程池也是享元模式的典型应用，通过复用线程避免频繁创建销毁的开销。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建固定大小的线程池</span>
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);

        <span class="hljs-comment">// 提交10个任务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> i;
            executor.submit(() -&gt; {
                System.out.println(<span class="hljs-string">"任务 "</span> + taskId +
                    <span class="hljs-string">" 由线程 "</span> + Thread.currentThread().getName() + <span class="hljs-string">" 执行"</span>);
                <span class="hljs-keyword">try</span> {
                    Thread.sleep(<span class="hljs-number">1000</span>);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    e.printStackTrace();
                }
            });
        }

        executor.shutdown();
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a82e3cfb3a0f4c7a847225bdccddca48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=qWbgkFrYEXCg7Bk8t7cj%2FcvhhJs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-19">六、享元模式的优缺点</h3>
<h3 data-id="heading-20">6.1 优点</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  大幅减少对象创建数量，降低内存占用
<span class="hljs-bullet">2.</span>  提高系统性能，避免频繁GC
<span class="hljs-bullet">3.</span>  提高对象复用率，减少创建销毁开销
<span class="hljs-bullet">4.</span>  外部状态独立，不会影响内部状态
</code></pre>
<h3 data-id="heading-21">6.2 缺点</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  增加系统复杂度，需要分离内部和外部状态
<span class="hljs-bullet">2.</span>  读取外部状态的开销，可能抵消部分性能提升
<span class="hljs-bullet">3.</span>  线程安全问题，共享对象需要考虑并发访问
<span class="hljs-bullet">4.</span>  不适合状态经常变化的对象
</code></pre>
<h3 data-id="heading-22">七、最佳实践</h3>
<h3 data-id="heading-23">7.1 何时使用享元模式？</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  对象数量巨大：系统中存在大量相似对象
<span class="hljs-bullet">2.</span>  内存压力大：对象占用内存导致频繁GC
<span class="hljs-bullet">3.</span>  对象可共享：大部分状态可以外部化
<span class="hljs-bullet">4.</span>  创建开销大：对象创建消耗大量资源
</code></pre>
<h3 data-id="heading-24">7.2 实现要点</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlyweightBestPractice</span> {
    <span class="hljs-comment">// 1. 使用线程安全的容器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">ConcurrentHashMap</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; pool =
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 2. 使用双重检查锁确保线程安全</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getFlyweight</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-title class_">Object</span> obj = pool.<span class="hljs-title function_">get</span>(key);
        <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) {
            synchronized (pool) {
                obj = pool.<span class="hljs-title function_">get</span>(key);
                <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) {
                    obj = <span class="hljs-title function_">createObject</span>(key);
                    pool.<span class="hljs-title function_">put</span>(key, obj);
                }
            }
        }
        <span class="hljs-keyword">return</span> obj;
    }

    <span class="hljs-comment">// 3. 设置池的大小上限</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final int <span class="hljs-variable constant_">MAX_POOL_SIZE</span> = <span class="hljs-number">100</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getFlyweightWithLimit</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">if</span> (pool.<span class="hljs-title function_">size</span>() &gt;= <span class="hljs-variable constant_">MAX_POOL_SIZE</span>) {
            <span class="hljs-comment">// 可以使用LRU策略移除最少使用的对象</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">createObject</span>(key);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getFlyweight</span>(key);
    }

    <span class="hljs-comment">// 4. 提供清理机制</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
        pool.<span class="hljs-title function_">clear</span>();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">createObject</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    }
}
</code></pre>
<h3 data-id="heading-25">7.3 与其他模式的协作</h3>
<pre><code class="hljs">与工厂模式结合：享元工厂负责创建和管理享元对象
与单例模式结合：享元工厂通常设计为单例
与状态模式结合：享元对象的状态变化可以用状态模式管理
与组合模式结合：可以将享元对象组合成更复杂的结构
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1a4512e088642e8aa1ac42d3c74a3d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982881&amp;x-signature=CHdtcG2qBLctpmHNirdW%2FmkWgU4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-26">八、性能对比</h3>
<h3 data-id="heading-27">8.1 内存对比测试</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MemoryComparisonTest</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">HeavyObject</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>]; <span class="hljs-comment">// 1KB</span>
        <span class="hljs-keyword">private</span> String type;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HeavyObject</span>(<span class="hljs-params">String type</span>)</span> {
            <span class="hljs-keyword">this</span>.type = type;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        Runtime runtime = Runtime.getRuntime();

        <span class="hljs-comment">// 测试1：不使用享元模式</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== 不使用享元模式 ==="</span>);
        <span class="hljs-built_in">long</span> memBefore1 = runtime.totalMemory() - runtime.freeMemory();

        List&lt;HeavyObject&gt; list1 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            list1.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> HeavyObject(i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span> ? <span class="hljs-string">"TypeA"</span> : <span class="hljs-string">"TypeB"</span>));
        }

        <span class="hljs-built_in">long</span> memAfter1 = runtime.totalMemory() - runtime.freeMemory();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"创建对象数：10000"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"内存占用："</span> + (memAfter1 - memBefore1) / <span class="hljs-number">1024</span> + <span class="hljs-string">" KB\n"</span>);

        <span class="hljs-comment">// 测试2：使用享元模式</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== 使用享元模式 ==="</span>);
        Map&lt;String, HeavyObject&gt; pool = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
        pool.put(<span class="hljs-string">"TypeA"</span>, <span class="hljs-keyword">new</span> HeavyObject(<span class="hljs-string">"TypeA"</span>));
        pool.put(<span class="hljs-string">"TypeB"</span>, <span class="hljs-keyword">new</span> HeavyObject(<span class="hljs-string">"TypeB"</span>));

        <span class="hljs-built_in">long</span> memBefore2 = runtime.totalMemory() - runtime.freeMemory();

        List&lt;HeavyObject&gt; list2 = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            String type = i % <span class="hljs-number">10</span> == <span class="hljs-number">0</span> ? <span class="hljs-string">"TypeA"</span> : <span class="hljs-string">"TypeB"</span>;
            list2.<span class="hljs-keyword">add</span>(pool.<span class="hljs-keyword">get</span>(type));
        }

        <span class="hljs-built_in">long</span> memAfter2 = runtime.totalMemory() - runtime.freeMemory();
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"创建对象数：2"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"内存占用："</span> + (memAfter2 - memBefore2) / <span class="hljs-number">1024</span> + <span class="hljs-string">" KB"</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n内存节省："</span> +
            ((memAfter1 - memBefore1 - (memAfter2 - memBefore2)) * <span class="hljs-number">100</span> /
            (memAfter1 - memBefore1)) + <span class="hljs-string">"%"</span>);
    }
}
</code></pre>
<h3 data-id="heading-28">九、总结</h3>
<p>享元模式是一个强大的性能优化工具，通过对象共享实现内存和性能的双重优化。在实际开发中，我们已经在使用它：</p>
<ol>
<li><strong>JDK自带</strong>：String常量池、包装类缓存池</li>
<li><strong>数据库领域</strong>：连接池（HikariCP、Druid）</li>
<li><strong>并发编程</strong>：线程池（ThreadPoolExecutor）</li>
<li><strong>缓存框架</strong>：Redis连接池、对象池。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[006_prompt]]></title>    <link>https://juejin.cn/post/7585969437032792106</link>    <guid>https://juejin.cn/post/7585969437032792106</guid>    <pubDate>2025-12-22T05:20:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585969437032792106" data-draft-id="7586481379589816339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="006_prompt"/> <meta itemprop="keywords" content="后端,OpenAI"/> <meta itemprop="datePublished" content="2025-12-22T05:20:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="游浪踏"/> <meta itemprop="url" content="https://juejin.cn/user/4103803477695373"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            006_prompt
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4103803477695373/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    游浪踏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:20:29.000Z" title="Mon Dec 22 2025 05:20:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">prompt 是什么</h2>
<p><strong>提示词</strong>的核心价值是<strong>标准化大模型的输入指令</strong></p>
<ul>
<li>通过自然语言或结构化语言（如 JSON、XML）告诉模型 “要做什么、输入是什么、输出格式是什么”。</li>
<li>例如：<code>“请将以下文本翻译成英文，输入：‘你好世界’，输出格式为纯英文句子”</code>。</li>
<li>使用者和大模型只要遵守提示词的约定，就能减少模型的 “幻觉”，得到预期结果。</li>
</ul>
<h2 data-id="heading-1">prompt 提示词类型</h2>
<p>提示词消息分成了多种角色。每个消息都被分配了特定的角色。 这些角色负责对信息进行分类，明确提示中每个部分的上下文和目的，供AI模型使用。 这种结构化的方法增强了与AI沟通的细腻度和有效性，因为提示的每个部分在互动中都扮演着独特且明确的角色。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/306a56bcade447399df99bf6db89f0e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ri45rWq6LiP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766985628&amp;x-signature=0nLdRejBMg%2F%2FkxTZJauZSJwAlUI%3D" alt="image.png" loading="lazy"/></p>
<p>主要职责包括：</p>
<ul>
<li>系统角色：指导AI的行为和响应风格，设定AI如何解释和响应输入的参数或规则。这就像在发起对话前先给AI提供指令。</li>
<li>用户角色：代表用户的输入——他们对AI的问题、命令或陈述。这一角色至关重要，因为它构成了人工智能应对的基础。</li>
<li>助理角色：AI对用户输入的回应。 这不仅仅是一个回答或反应，更对于保持对话的流畅性至关重要。 通过追踪AI之前的回复（其“助理角色”消息），系统确保互动连贯且符合上下文。 助手消息也可能包含功能工具调用请求信息。 它就像AI中的一个特殊功能，用于执行特定功能，比如计算、获取数据或其他不仅仅是说话的任务。</li>
<li>工具/功能角色：工具/功能角色专注于回复工具呼叫助手消息时返回更多信息。</li>
</ul>
<h4 data-id="heading-2">1. <code>SYSTEM</code>（系统角色）</h4>
<ul>
<li>
<p><strong>核心用途</strong>：定义大模型的<strong>行为准则、角色定位、能力边界和全局约束</strong>，相当于给模型设定 “工作手册”，贯穿整个对话流程。</p>
</li>
<li>
<p><strong>特点</strong>：优先级较高，会影响模型后续所有回复的风格、逻辑和范围，通常在对话开头传入，无需频繁修改。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 系统消息：定义模型为Java技术助手，指定回答约束</span>
<span class="hljs-type">SystemMessage</span> <span class="hljs-variable">systemMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemMessage</span>(<span class="hljs-string">"你是一名资深Java开发顾问，回答需简洁专业，仅围绕技术问题，不涉及无关内容"</span>);
</code></pre>
</li>
</ul>
<h4 data-id="heading-3">2. <code>USER</code>（用户角色）</h4>
<ul>
<li>
<p><strong>核心用途</strong>：代表<strong>用户的输入、问题、指令或需求</strong>，是触发模型回复的核心消息类型。</p>
</li>
<li>
<p><strong>特点</strong>：在多轮对话中可多次出现，每一条用户消息通常对应一条助手回复，携带用户的具体诉求。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户消息：提出具体技术问题</span>
<span class="hljs-type">UserMessage</span> <span class="hljs-variable">userMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(<span class="hljs-string">"请解释Spring AI中PromptTemplate的作用"</span>);
</code></pre>
</li>
</ul>
<h4 data-id="heading-4">3. <code>ASSISTANT</code>（助手角色）</h4>
<ul>
<li>
<p><strong>核心用途</strong>：代表<strong>大模型返回的回答、生成结果或反馈</strong>，主要用于<strong>携带对话上下文</strong>，让模型记住之前的交互内容，实现多轮连贯对话。</p>
</li>
<li>
<p><strong>特点</strong>：通常由模型生成后存储，在后续对话中随用户新消息一起传入，供模型参考历史交互。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 助手消息：模拟模型之前的回复（作为上下文）</span>
<span class="hljs-type">AssistantMessage</span> <span class="hljs-variable">assistantMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantMessage</span>(<span class="hljs-string">"PromptTemplate用于封装可复用的提示词模板，通过占位符填充参数，提升
</span></code></pre>
</li>
</ul>
<h4 data-id="heading-5">4. <code>FUNCTION</code> / <code>TOOL</code>（函数 / 工具角色，两者功能一致，命名略有差异）</h4>
<ul>
<li>
<p><strong>核心用途</strong>：有两个核心场景：</p>
<ol>
<li>模型向外部系统<strong>发送工具调用请求</strong>：携带函数名称、参数等结构化信息，告知应用程序需要调用哪个工具完成任务。</li>
<li>外部系统向模型<strong>返回工具调用结果</strong>：将工具执行后的返回数据传递给模型，供模型基于该结果生成最终回复。</li>
</ol>
</li>
<li>
<p><strong>特点</strong>：需要配合结构化参数传递，是实现 “AI + 工具” 能力的关键角色（Spring AI 中常用<code>FunctionMessage</code>实现）。</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 模型发送工具调用请求（函数角色：指定要调用的天气查询工具及参数）</span>
Map&lt;String, Object&gt; funcParams = Map.of(<span class="hljs-string">"city"</span>, <span class="hljs-string">"上海"</span>, <span class="hljs-string">"date"</span>, <span class="hljs-string">"2025-12-22"</span>);
<span class="hljs-type">FunctionMessage</span> <span class="hljs-variable">funcCallMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctionMessage</span>(<span class="hljs-string">"get_weather_info"</span>, funcParams);

<span class="hljs-comment">// 2. 外部工具执行后，返回结果给模型（同样用FunctionMessage承载）</span>
<span class="hljs-type">FunctionMessage</span> <span class="hljs-variable">funcResultMsg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctionMessage</span>(<span class="hljs-string">"get_weather_info"</span>, Map.of(<span class="hljs-string">"temperature"</span>, <span class="hljs-string">"10℃"</span>, <span class="hljs-string">"weather"</span>, <span class="hljs-string">"多云"</span>));
</code></pre>
</li>
</ul>
<h4 data-id="heading-6">补充：<code>TOOL_CALL</code>（工具调用请求）与<code>TOOL_RESULT</code>（工具调用结果）</h4>
<p>部分大模型适配场景中，Spring AI 会细分这两个角色，职责更明确：</p>
<ul>
<li><code>TOOL_CALL</code>：仅用于模型发起工具调用请求，不承载结果。</li>
<li><code>TOOL_RESULT</code>：仅用于返回工具执行结果，与<code>TOOL_CALL</code>一一对应，结构更清晰。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot+Spring AI 构建企业知识库]]></title>    <link>https://juejin.cn/post/7586157459972374580</link>    <guid>https://juejin.cn/post/7586157459972374580</guid>    <pubDate>2025-12-22T05:21:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459972374580" data-draft-id="7586482851098787880" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot+Spring AI 构建企业知识库"/> <meta itemprop="keywords" content="OpenAI"/> <meta itemprop="datePublished" content="2025-12-22T05:21:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户90832460273"/> <meta itemprop="url" content="https://juejin.cn/user/307518986530984"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot+Spring AI 构建企业知识库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/307518986530984/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户90832460273
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:21:38.000Z" title="Mon Dec 22 2025 05:21:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在之前的文章中我们使用 SpringBoot 配合 DeepSeek 构建了一个拥有聊天记忆的问答机器人，如果没有看过的可以翻下我之前的帖子。这次构建企业知识库将基于之前的内容来添砖加瓦。</p>
<h2 data-id="heading-1">构建知识库</h2>
<p>在开始之前，我们需要了解 2 个概念：<strong>向量数据库</strong>和<strong>检索增强生成（RAG）</strong></p>
<ul>
<li>**向量数据库：**顾名思义，存储向量的数据库。什么是向量？可以简单理解为，文本、图片、视频等数据在空间中的坐标，语义相似的词在向量空间中距离更近，AI 根据距离来判断相似度。</li>
<li>**检索增强生成（RAG）：**当需要将用户查询发送到 AI 模型时，首先检索一组相似的文档。这些文档随后作为用户问题的上下文，与用户查询一起发送给 AI 模型。这种技术被称为检索增强生成（RAG）。</li>
</ul>
<h3 data-id="heading-2">添加依赖</h3>
<p>之前我们是直接使用的 DeepSeek 的依赖包，但是由于在<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fi%2F5I4ebAG9" target="_blank" title="https://cloud.siliconflow.cn/i/5I4ebAG9" ref="nofollow noopener noreferrer">硅基流动</a>中没找到 DeepSeek 的嵌入模型，这里使用的千问的嵌入模型， Open AI 都能兼容。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-advisors-vector-store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-openai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-rag<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">配置嵌入模型</h3>
<p><strong>为什么要配置嵌入模型？</strong></p>
<p>前面提到 AI 通过向量可以判断相似度，而嵌入模型就是用于生成向量。嵌入模型可以到<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fi%2F5I4ebAG9" target="_blank" title="https://cloud.siliconflow.cn/i/5I4ebAG9" ref="nofollow noopener noreferrer">硅基流动</a>搜索 Embedding 关键字，这里就直接使用的千问模型。</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">openai:</span>
      <span class="hljs-attr">api-key:</span> <span class="hljs-string">xxxx</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">https://api.siliconflow.cn</span>
      <span class="hljs-attr">embedding:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">Qwen/Qwen3-Embedding-0.6B</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-ai/DeepSeek-R1-0528-Qwen3-8B</span>
          <span class="hljs-attr">temperature:</span> <span class="hljs-number">0.7</span>
</code></pre>
<h3 data-id="heading-4">聊天客户端配置</h3>
<p>之前是直接在控制器中使用构造器的方式进行注入：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/chat")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatBotController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatBotController</span><span class="hljs-params">(ChatClient.Builder chatClientBuilder)</span> {
        <span class="hljs-built_in">this</span>.chatClient = chatClientBuilder.build();
    }
}
</code></pre>
<p>现在我们直接抽取成配置。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ChatClient <span class="hljs-title function_">chatClient</span><span class="hljs-params">(ChatModel chatModel, EmbeddingModel embeddingModel, ChatMemory chatMemory)</span> {
        <span class="hljs-keyword">return</span> ChatClient.builder(chatModel)
                .defaultSystem(<span class="hljs-string">"你是一个客服人员，针对用户的问题总是能以友好愉悦的方式去进行交流，希望带给客户很好的体验。"</span>)
                .defaultAdvisors(MessageChatMemoryAdvisor.builder(chatMemory).build())
                .defaultAdvisors(VectorStoreChatMemoryAdvisor.builder(SimpleVectorStore.builder(embeddingModel).build()).build())
                .build();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> VectorStore <span class="hljs-title function_">vectorStore</span><span class="hljs-params">(EmbeddingModel embeddingModel)</span> {
        <span class="hljs-keyword">return</span> SimpleVectorStore.builder(embeddingModel).build();

    }

}
</code></pre>
<p>我们可以看到 <code>ChatClient</code>​ 的 bean 配置了 <code>defaultSystem</code>​和 <code>defaultAdvisors</code>​，<code>defaultSystem</code>​用来生成默认的提示词，这里我给了个提示让它作为一名客服人员去回答问题。<code>defaultAdvisors</code>​则是添加顾问，可以理解为一种拦截器，在请求 AI 前的一些操作，这里告诉 AI 使用内存作为记忆，并且使用内存作为向量数据库。</p>
<p>当然，实际企业不会直接使用内存作为记忆和向量数据库，我们可以直接基于自身的项目的架构选择合适的向量数据库和记忆会话历史。比如使用 mysql 存储会话历史，使用 redis-stack 做为向量数据库都是不错的选择。</p>
<p>到目前为止已经解决了之前思考问题：”我们怎么给 AI 预置一个角色？比如让它作为一个智能客服或者作为一个营养师。“</p>
<h3 data-id="heading-5">添加知识库</h3>
<p>这里为了方便，直接使用了 <code>PostConstruct</code>​模拟了知识库初始化，真实数据可以从数据库中获取，使用 <code>CommandLineRunner</code>​接口加载数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> VectorStore vectorStore;

<span class="hljs-meta">@PostConstruct</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadStore</span><span class="hljs-params">()</span> {
    List&lt;Document&gt; documents = List.of(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"lanjii是开箱即用的 RBAC 权限管理系统。后端基于 Spring Boot3 构建， 集成了 JWT 认证、Spring Security 6、MyBatis-Plus\u200B 和 WebSocket\u200B 等核心技术。前端使用了 Vue3 +Vite + Element Plus + Pinia 构建。它是一个简洁、高效、无过多依赖的项目，支持按钮级别的权限控制，使用简单，开箱即用。"</span>)
    );
    vectorStore.add(documents);
}
</code></pre>
<h3 data-id="heading-6">挂载知识库</h3>
<p>在聊天客户端中直接添加 <code>QuestionAnswerAdvisor</code>​就可以让我们在问 AI 时先从知识库中获取数据，然后经过 AI 整合后回答我们。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/chat")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatBotController_demo</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChatClient chatClient;
	<span class="hljs-meta">@Autowired</span>
	<span class="hljs-keyword">private</span> VectorStore vectorStore;

	<span class="hljs-meta">@PostConstruct</span>
	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadStore</span><span class="hljs-params">()</span> {
	    List&lt;Document&gt; documents = List.of(
	            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<span class="hljs-string">"lanjii是开箱即用的 RBAC 权限管理系统。后端基于 Spring Boot3 构建， 集成了 JWT 认证、Spring Security 6、MyBatis-Plus\u200B 和 WebSocket\u200B 等核心技术。前端使用了 Vue3 +Vite + Element Plus + Pinia 构建。它是一个简洁、高效、无过多依赖的项目，支持按钮级别的权限控制，使用简单，开箱即用。"</span>)
	    );
	    vectorStore.add(documents);
	}

    <span class="hljs-meta">@GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chatStream</span><span class="hljs-params">(String message, String conversationId)</span> {
        <span class="hljs-keyword">return</span> chatClient.prompt()
                .advisors(
                        a -&gt; a.param(ChatMemory.CONVERSATION_ID, conversationId)
                )
                .advisors(QuestionAnswerAdvisor.builder(vectorStore).build())
                .user(message)
                .stream()
                .content();
    }

}
</code></pre>
<p>不知大家有没有注意到这里使用到了 <code>ChatMemory.CONVERSATION_ID</code>​，这是将聊天数据的上下文进行关联。上篇文章留下的思考中：如果用户 A 和用户 B 同时对 AI 进行对话，怎么让对话进行隔离？这里直接让不同的会话使用不同的 conversationId 即可。</p>
<p>至此，一个简单的知识库就构建好了，看下效果吧：
​<img src="http://openwrite.cn/uploads/20173/57679/99aa6dbd-ea84-4d8d-9194-841be7063502.png" alt="image.png" loading="lazy"/></p>
<p>更可以达到这样的效果：
​<img src="http://openwrite.cn/uploads/20173/57679/8e12b4f0-16a5-47ef-b1bd-c0e9815564f1.png" alt="image.png" loading="lazy"/>​</p>
<p>这样一个即有记忆功能，又能对话隔离，并且能直接关联知识库的问答系统就构建好了。</p>
<h3 data-id="heading-7">思考</h3>
<p>又到了思考环节，按理说 AI 的场景运用到这里已经结束了，但是！！！</p>
<ul>
<li>如果通过对话直接让 AI 跟我们完成业务操作，比如跟我下单，或者说取消机票？</li>
</ul>
<h2 data-id="heading-8">完整代码</h2>
<p>后续我会整理后将代码放在 Gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fleven2018%2Flanjii" target="_blank" title="https://gitee.com/leven2018/lanjii" ref="nofollow noopener noreferrer">lanjii: 开箱即用的 RBAC 权限管理系统。后端基于 Spring Boot3 构建， 集成了 JWT 认证、Spring Security 6、MyBatis-Plus</a></p>
<p>这是一款 MIT 协议可商用的 SpringBoot 脚手架，拥有完整的权限控制和常用的基础功能。希望大家给个 Star，后面有新的功能和一些 BUG 的修复也会提交到 Gitee。
<img src="http://openwrite.cn/uploads/20173/57679/da7e025d-f4d6-4a7f-93d6-e9c89c5fb855.png" alt="image.png" loading="lazy"/>
<img src="http://openwrite.cn/uploads/20173/57679/34583a43-a1b4-469c-b020-78876337a69b.png" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">小结</h2>
<p>没得小结~~~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别杂乱数字：用 Intl.NumberFormat 打造全球友好的前端体验]]></title>    <link>https://juejin.cn/post/7586139603691094035</link>    <guid>https://juejin.cn/post/7586139603691094035</guid>    <pubDate>2025-12-22T05:04:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586139603691094035" data-draft-id="7586540799219793961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别杂乱数字：用 Intl.NumberFormat 打造全球友好的前端体验"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-22T05:04:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CC码码"/> <meta itemprop="url" content="https://juejin.cn/user/3800389147179720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别杂乱数字：用 Intl.NumberFormat 打造全球友好的前端体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3800389147179720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CC码码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:04:48.000Z" title="Mon Dec 22 2025 05:04:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是CC，在这里欢迎大家的到来～</p>
<h2 data-id="heading-0">开场</h2>
<p>书接上文，<strong>Intl</strong> 下的 <strong>Segmenter</strong> 对象可以实现对文本的分割，<strong>Collator</strong> 对象可以处理字符串的比较，除此之外，还有数字格式化、日期格式化等其他功能。</p>
<p>这篇文章先来看看数字格式化，现在来理论加实践一下。</p>
<h2 data-id="heading-1">数字格式化</h2>
<p><code>Intl.NumberFormat</code>使数字在特定语言环境下格式化。</p>
<h3 data-id="heading-2">配置项</h3>
<p>为了方便阅读，属性列表根据用途划分为多个部分，包括区域选项、样式选项、数字选项和其他选项。</p>
<p><strong>区域选项</strong></p>
<ul>
<li>localeMatcher</li>
</ul>

<ul>
<li>
<ul>
<li>使用的区域匹配算法，可能的值包括：</li>
<li>默认值为 best fit，还有 lookup</li>
</ul>
</li>
</ul>

<ul>
<li>numberingSystem</li>
</ul>

<ul>
<li>
<ul>
<li>数字格式化的数字系统，像阿拉伯数字 arab、简体中文数字 hans、无衬线数字 mathsans</li>
<li>默认值取决于区域</li>
<li>同 locales 的 Unicode 扩展键 nu 设置，但优先级高于他</li>
</ul>
</li>
</ul>
<p><strong>样式选项</strong></p>
<ul>
<li>style</li>
</ul>

<ul>
<li>
<ul>
<li>使用的格式化样式，可选的值包括：</li>
<li>decimal: 普通数字格式化</li>
<li>currency: 货币格式化</li>
<li>percent: 百分比格式化</li>
<li>unit: 单位格式化</li>
<li>默认值是 decimal</li>
</ul>
</li>
</ul>

<ul>
<li>currency</li>
</ul>

<ul>
<li>
<ul>
<li>货币格式化中使用的货币，像美元 USD、欧元 EUR 和人民币 CNY。</li>
<li>没有默认值，style 为 currency 时必须提供，内容会被转换为大写。</li>
</ul>
</li>
</ul>

<ul>
<li>currencyDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>货币格式化中如何显示货币，可选的值包括：</li>
<li>code: 使用 ISO 货币代码</li>
<li>symbol: 使用本地化货币符号</li>
<li>narrowSymbol: 使用窄格式符号，像 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mtext>而不是</mtext><mi>U</mi><mi>S</mi></mrow><annotation encoding="application/x-tex">100 而不是 US</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">100</span><span class="mord cjk_fallback">而不是</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span>100</li>
<li>name: 使用本地化货币名称，像 dollar</li>
</ul>
</li>
</ul>

<ul>
<li>currencySign</li>
</ul>

<ul>
<li>
<ul>
<li>使用括号将数字括起来，而不是添加负号，可选的值包括：</li>
<li>standard: 默认值</li>
<li>accounting: 会计</li>
</ul>
</li>
</ul>

<ul>
<li>unit</li>
</ul>

<ul>
<li>
<ul>
<li>格式化的单位</li>
<li>style 为 unit 时必填</li>
</ul>
</li>
</ul>

<ul>
<li>unitDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>unit 格式化时使用的格式化风格，可选的值包括：</li>
<li>short: 默认值，例如 16 l</li>
<li>narrow: 例如 16l</li>
<li>long: 例如 16 litres</li>
</ul>
</li>
</ul>
<p><strong>数字选项，由</strong> <code>Intl.PluralRules</code> <strong>支持</strong></p>
<ul>
<li>minimumIntegerDigits</li>
</ul>

<ul>
<li>
<ul>
<li>最小整数位数，默认值为 1，范围是 1~21</li>
<li>若实际整数位数不足会在左侧用 0 补足，比如对于数字 5 该值设置为 3 则显示为“005”</li>
</ul>
</li>
</ul>

<ul>
<li>minimumFractionDigits</li>
</ul>

<ul>
<li>
<ul>
<li>小数部分的最小位数，范围是 0~100</li>
<li>若小数位数不足时会在右侧补 0，超过时会按四舍五入截断</li>
<li>默认值对于普通数字和百分比是 0，对于 currency 是 2（ISO 4217 标准小数位数）</li>
</ul>
</li>
</ul>

<ul>
<li>maximumFractionDigits</li>
</ul>

<ul>
<li>
<ul>
<li>小数部分的最大位数，范围是 0~100</li>
<li>若小数位数不足时会在右侧补 0，超过时会按四舍五入截断</li>
<li>默认值对于普通数字和百分比是 3，对于 currency 是 2（ISO 4217 标准小数位数）</li>
</ul>
</li>
</ul>

<ul>
<li>minimumSignificanntDigits</li>
</ul>

<ul>
<li>
<ul>
<li>最小有效数字，默认值为 1。范围是 1~21。</li>
<li>优先级高于 minimumFractionDigits</li>
</ul>
</li>
</ul>

<ul>
<li>maximumSignificanntDigits</li>
</ul>

<ul>
<li>
<ul>
<li>最大有效数字，默认值为 21。范围是 1~21。</li>
<li>优先级高于 maximumFractionDigits</li>
</ul>
</li>
</ul>

<ul>
<li>roundingPriority</li>
</ul>

<ul>
<li>
<ul>
<li>当同时使用 FractionDigits 和 SignificantDigits 时指定如何解决四舍五入冲突，可选的值包括：</li>
<li>auto: 默认值，使用有效数字属性</li>
<li>morePrecision: 使用精度更高的属性</li>
<li>lessPrecision: 使用精度更低的属性</li>
<li>auto 属性会在 natation 为 compact 时且未设置任何四个 FractionDigits/SignificantDigits 时会被设置为 morePrecision</li>
<li>除 auto 属性以外的值会根据 maximumSignificanntDigits 和 maximumFractionDigits 计算出更高精度，忽略最小小数位和有效数字位</li>
</ul>
</li>
</ul>

<ul>
<li>roundingIncrement</li>
</ul>

<ul>
<li>
<ul>
<li>相对于计算出的舍入单位的舍入增量</li>
<li>默认值为 1，其他值包括 1、2、5、10、20、25、50、100、200、250、500、1000、2000、5000</li>
<li>不能与有效数字位舍入或任何 roundingPriority（除了 auto） 混合使用</li>
</ul>
</li>
</ul>

<ul>
<li>roundingMode</li>
</ul>

<ul>
<li>
<ul>
<li>对小数进行舍入，可选的值包括：</li>
<li>ceil: 向正无穷舍入，正数向上，负数“向正”</li>
<li>floor: 向负无穷舍入，正数向下，负数“向负”</li>
<li>expand: 四舍五入远离 0，绝对值增大</li>
<li>trunc: 四舍五入朝向 0，绝对值减小</li>
<li>halfCeil: 趋向于正无穷舍入，包括半值</li>
<li>halfFloor: 趋向于负无穷舍入，包括半值</li>
<li>halfExpand: 默认值，半值远离 0 舍入</li>
<li>halfTrunc: 向 0 取整，包括半值</li>
<li>halfEven: 半值向最接近的偶数整数舍入，常用于统计，减少片差</li>
</ul>
</li>
</ul>

<ul>
<li>trailingZeroDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>整数末尾 0 的显示策略，可选的值包括：</li>
<li>auto: 默认值，根据 minimumFractionDigits 和 minimumSignificanntDigits 保持末尾 0</li>
<li>stripIfInteger: 如果小数部分全为 0 则删除小数部分，如果小数部分有任何非零数则与 auto 相同</li>
</ul>
</li>
</ul>
<p><strong>其他选项</strong></p>
<ul>
<li>notation</li>
</ul>

<ul>
<li>
<ul>
<li>数字的显示格式，可选的值包括：</li>
<li>standard: 默认值，纯数字格式</li>
<li>scientific: 返回格式化数字的数量级</li>
<li>engineering: 返回能被 3 整除的 10 的指数</li>
<li>compact: 表示指数的字符串，默认使用 short 形式</li>
</ul>
</li>
</ul>

<ul>
<li>compactDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>仅当 notation 为 compact 时使用，可选的值包括：</li>
<li>short: 默认值</li>
<li>long</li>
</ul>
</li>
</ul>

<ul>
<li>useGrouping</li>
</ul>

<ul>
<li>
<ul>
<li>是否使用分组分隔符，像千位分隔符或者千/十万/千万分隔符，可选的值包括：</li>
<li>always: 即使 locale 偏好不同也展示分组分隔符</li>
<li>auto: 根据 locale 偏好显示分组分隔符，也取决于货币</li>
<li>min2: 当一组数字至少有 2 位数字时显示分组分隔符</li>
<li>true: 同 always</li>
<li>false: 不展示分组分隔符</li>
<li>当 notation 为 compact 时默认值为 min2，否则默认值为 auto</li>
<li>字符串 true 和 false 会被转化为默认值</li>
</ul>
</li>
</ul>

<ul>
<li>signDisplay</li>
</ul>

<ul>
<li>
<ul>
<li>何时显示数字符号，可选的值包括：</li>
<li>auto: 默认值</li>
<li>always: 总是显示</li>
<li>exceptZero: 正数和负数显示符号，但 0 不显示</li>
<li>negative: 仅显示负数的符号，不包括负零</li>
<li>never: 从不展示</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">格式化</h3>
<p><code>format()</code>方法会基于区域和格式化选项进行数字格式化。支持数字、大数和字符串。</p>
<p>数字可能因为太大或太小而丢失精度</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numberFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFormat.<span class="hljs-title function_">format</span>(<span class="hljs-number">987654321987654321</span>));
<span class="hljs-comment">// 987,654,321,987,654,300</span>
</code></pre>
<p>但是使用大数就不会有问题</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numberFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFormat.<span class="hljs-title function_">format</span>(<span class="hljs-number">987654321987654321n</span>));
<span class="hljs-comment">// 987,654,321,987,654,321</span>
</code></pre>
<p>字符串也不会丢失精度</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numberFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFormat.<span class="hljs-title function_">format</span>(<span class="hljs-string">"987654321987654321"</span>));
<span class="hljs-comment">// 987,654,321,987,654,321</span>
</code></pre>
<p>使用指数表示</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> numberFormat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>);
<span class="hljs-keyword">const</span> bigNum = <span class="hljs-number">987654321987654321n</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberFormat.<span class="hljs-title function_">format</span>(<span class="hljs-string">`<span class="hljs-subst">${bigNum}</span>E-6`</span>));
<span class="hljs-comment">// 987,654,321,987.654</span>
</code></pre>
<h3 data-id="heading-4">格式化分割成多部分</h3>
<p><code>formatToParts()</code>将会返回一个对象数组，包含格式化后的每一部分，适合用来自定义字符串格式化。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> number = <span class="hljs-number">3500</span>;

<span class="hljs-keyword">const</span> formatter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"de-DE"</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">"currency"</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">"EUR"</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formatter.<span class="hljs-title function_">format</span>(number));
<span class="hljs-comment">// "3.500,00 €"</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formatter.<span class="hljs-title function_">formatToParts</span>(number));
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   { type: "integer", value: "3" },</span>
<span class="hljs-comment">//   { type: "group", value: "." },</span>
<span class="hljs-comment">//   { type: "integer", value: "500" },</span>
<span class="hljs-comment">//   { type: "decimal", value: "," },</span>
<span class="hljs-comment">//   { type: "fraction", value: "00" },</span>
<span class="hljs-comment">//   { type: "literal", value: " " },</span>
<span class="hljs-comment">//   { type: "currency", value: "€" },</span>
<span class="hljs-comment">// ];</span>
</code></pre>
<h3 data-id="heading-5">格式化数字范围</h3>
<p><code>formatRange()</code>返回一个字符串表示数字范围格式化后的内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> nf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"en-US"</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">"currency"</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">"USD"</span>,
  <span class="hljs-attr">maximumFractionDigits</span>: <span class="hljs-number">0</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nf.<span class="hljs-title function_">formatRange</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>));
<span class="hljs-comment">// "$3 – $5"</span>
</code></pre>
<p>如果<strong>开始值和结束值四舍五入值相同或者完全相同</strong>时则会添加<strong>近似等于</strong>符号。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nf.<span class="hljs-title function_">formatRange</span>(<span class="hljs-number">2.9</span>, <span class="hljs-number">3.1</span>));
<span class="hljs-comment">// "~$3"</span>
</code></pre>
<h3 data-id="heading-6">格式化数字范围分割成多部分</h3>
<p><code>formatRangeToParts()</code>返回一个对象数组，包含格式化后的每一部分，适合用来自定义数字字符串的格式化范围。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> startRange = <span class="hljs-number">3500</span>;
<span class="hljs-keyword">const</span> endRange = <span class="hljs-number">9500</span>;

<span class="hljs-keyword">const</span> formatter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"de-DE"</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">"currency"</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">"EUR"</span>,
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formatter.<span class="hljs-title function_">formatRange</span>(startRange, endRange));
<span class="hljs-comment">// "3.500,00–9.500,00 €"</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(formatter.<span class="hljs-title function_">formatRangeToParts</span>(startRange, endRange));
<span class="hljs-comment">// [</span>
<span class="hljs-comment">//   { type: "integer", value: "3", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "group", value: ".", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "integer", value: "500", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "decimal", value: ",", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "fraction", value: "00", source: "startRange" },</span>
<span class="hljs-comment">//   { type: "literal", value: "–", source: "shared" },</span>
<span class="hljs-comment">//   { type: "integer", value: "9", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "group", value: ".", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "integer", value: "500", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "decimal", value: ",", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "fraction", value: "00", source: "endRange" },</span>
<span class="hljs-comment">//   { type: "literal", value: " ", source: "shared" },</span>
<span class="hljs-comment">//   { type: "currency", value: "€", source: "shared" },</span>
<span class="hljs-comment">// ]</span>
</code></pre>
<h3 data-id="heading-7">获取配置项</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> de = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">NumberFormat</span>(<span class="hljs-string">"de-DE"</span>, {
  <span class="hljs-attr">style</span>: <span class="hljs-string">"currency"</span>,
  <span class="hljs-attr">currency</span>: <span class="hljs-string">"USD"</span>,
  <span class="hljs-attr">maximumFractionDigits</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">roundingIncrement</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">roundingMode</span>: <span class="hljs-string">"halfCeil"</span>,
});

<span class="hljs-keyword">const</span> usedOptions = de.<span class="hljs-title function_">resolvedOptions</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">locale</span>); <span class="hljs-comment">// "de-DE"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">numberingSystem</span>); <span class="hljs-comment">// "latn"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">compactDisplay</span>); <span class="hljs-comment">// undefined ("notation" not set to "compact")</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">currency</span>); <span class="hljs-comment">// "USD"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">currencyDisplay</span>); <span class="hljs-comment">// "symbol"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">currencySign</span>); <span class="hljs-comment">// "standard"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">minimumIntegerDigits</span>); <span class="hljs-comment">// 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">minimumFractionDigits</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">maximumFractionDigits</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">minimumSignificantDigits</span>); <span class="hljs-comment">// undefined (maximumFractionDigits is set)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">maximumSignificantDigits</span>); <span class="hljs-comment">// undefined (maximumFractionDigits is set)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">notation</span>); <span class="hljs-comment">// "standard"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">roundingIncrement</span>); <span class="hljs-comment">// 5</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">roundingMode</span>); <span class="hljs-comment">// halfCeil</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">roundingPriority</span>); <span class="hljs-comment">// auto</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">signDisplay</span>); <span class="hljs-comment">// "auto"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">style</span>); <span class="hljs-comment">// "currency"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">trailingZeroDisplay</span>); <span class="hljs-comment">// auto</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(usedOptions.<span class="hljs-property">useGrouping</span>); <span class="hljs-comment">// auto</span>
</code></pre>
<h3 data-id="heading-8">判断返回支持的 locale</h3>
<p>在给定的 <strong>locales</strong> 数组中判断出 <code>NumberFormat</code> 支持的 <code>locales</code>。但是可能每个浏览器支持的不大一样。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> locales = [<span class="hljs-string">"ban"</span>, <span class="hljs-string">"id-u-co-pinyin"</span>, <span class="hljs-string">"de-ID"</span>];
<span class="hljs-keyword">const</span> options = { <span class="hljs-attr">localeMatcher</span>: <span class="hljs-string">"lookup"</span> };

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Intl</span>.<span class="hljs-property">NumberFormat</span>.<span class="hljs-title function_">supportedLocalesOf</span>(locales, options));
<span class="hljs-comment">// ["id-u-co-pinyin", "de-ID"]</span>
</code></pre>
<h2 data-id="heading-9">总结</h2>
<p><code>Intl.NumberFormat</code>用于根据语言和地区格式化数字内容，像把数字格式化为货币、百分比或带单位的本地化字符串，精确控制数字的小数位数、有效数字和整数部分的最小位数，设置丰富的舍入模式像四舍五入、向零舍入或银行家舍入法这些场景下都十分适用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙Next —— 状态管理实践]]></title>    <link>https://juejin.cn/post/7585920796100673563</link>    <guid>https://juejin.cn/post/7585920796100673563</guid>    <pubDate>2025-12-22T04:05:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585920796100673563" data-draft-id="7585866811717664795" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙Next —— 状态管理实践"/> <meta itemprop="keywords" content="HarmonyOS,MVVM,客户端"/> <meta itemprop="datePublished" content="2025-12-22T04:05:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="磊少工作室_CTO"/> <meta itemprop="url" content="https://juejin.cn/user/3034307821836200"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙Next —— 状态管理实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307821836200/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    磊少工作室_CTO
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:05:42.000Z" title="Mon Dec 22 2025 04:05:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MVVM模式</h2>
<p>MVVM模式是一种软件架构模式，由三个部分组成：Model（数据模型层），View（视图层），ViewModel（视图模型层）。核心是分离应用程序的视图和业务逻辑，通过数据绑定实现视图和业务逻辑的解耦。</p>
<p>以下是ArkUI MVVM模式示意图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abefea2671114d55b91a9741cbf0f1f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=Tg4hMybK2VF9GjcCmVYlL7%2FAfRc%3D" alt="" loading="lazy"/></p>
<ul>
<li>Model层：存储数据和相关逻辑的模型。它表示组件或其他相关业务逻辑之间传输的数据。Model是对原始数据的进一步处理。</li>
<li>View层：在ArkUI中通常是@Component装饰组件渲染的UI。</li>
<li>ViewModel层：在ArkUI中，ViewModel是存储在自定义组件的状态变量（如@State @Prop等装饰器修饰的变量）、LocalStorage和AppStorage中的数据。</li>
</ul>

<ul>
<li>
<ul>
<li>自定义组件通过执行其build()方法或者@Builder装饰的方法来渲染UI，即ViewModel可以渲染View。</li>
<li>View可以通过相应event handler来改变ViewModel，即事件驱动ViewModel的改变，另外ViewModel提供了@Watch回调方法用于监听状态数据的改变。</li>
<li>在ViewModel被改变时，需要同步回Model层，这样才能保证ViewModel和Model的一致性，即应用自身数据的一致性。</li>
<li>ViewModel结构设计应始终为了适配自定义组件的构建和更新，这也是将Model和ViewModel分开的原因。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">二、组件内状态管理(V1)</h2>
<p>V1状态管理中装饰器有：@State, @Prop, @Link, @Observerd, @ObjectLink, @Provide, @Consume, @LocalStorageLink, @LocalStorageProp, @StorageLink, @StorageProp, @Watch，我们下面一一分析这些装饰器的作用。</p>
<h3 data-id="heading-2">@State 组件内状态</h3>
<p>@State修饰的变量称之为状态变量，它是组件内状态装饰器，当状态变量改变时对应的UI也会发生相应的变化，大部分时候和其他装饰器联用时@State修饰的变量往往是作为数据源。</p>
<p>@State支持修饰基础类型、class、数组、map、set等类型，现在先来感受下组件内状态管理的基本用法：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct EntryIndex {
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">count</span>: number = <span class="hljs-number">0</span>
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Scroll</span>() {
      <span class="hljs-selector-tag">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`${this.count}`</span>, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.count</span>++
          })
      }
    }
  }
}
</code></pre>
<p>以上示例中点击按钮后count计数会+1，这个时候因为组件Button和count变量有数据绑定的关系，所以Button组件会重新渲染内容改变。这就是@State最基础的用法，实际项目中有很多情况是复杂组件之间的变量传递，下面这张图体现了 哪些装饰器修饰的变量可以传递给@State 以及 @State装饰的变量可以传递给哪些装饰器修饰的变量</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8088d82b8c74e02a2c3708150675689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=OJwFXLGFoIjnJ6rD75k%2BLJoA1SI%3D" alt="" loading="lazy"/></p>
<p>@State状态变量是不会根据父组件或子组件传递变量的改变而改变，所以他是组件内状态，接下来看下他是如何与其他装饰器联动的。</p>
<h3 data-id="heading-3">@Prop 父子单向同步</h3>
<p>@Prop 装饰的变量可以和父组件建立单向同步的关系，@Prop状态变量是可变的，但是它的变化是不会同步给父组件，父组件变量变化会同步给该@Prop状态变量。</p>
<p>@Prop支持装饰基础类型、class、数组、map、set等类型，大多数情况下父组件传递变量是@State修饰的。下图体现了 @Prop状态变量可以接收哪些父组件装饰器的状态变量 以及 @Prop状态变量可以传递哪些装饰器修饰的子组件状态变量</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74352fb819e649659eaf02a9b6c5e928~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=8nAs5LebozXE5SC07xjtKDNgca8%3D" alt="" loading="lazy"/></p>
<p>看起来基本和@State支持情况一致。ps: @Prop是深度拷贝变量，所以会有一定的性能损耗，大对象建议用Link代替。</p>
<h3 data-id="heading-4">@Link 父子双向同步</h3>
<p>@Link 装饰的变量可以和父组件建立单向同步的关系，@Link状态变量是可变的，但是它的变化会同步给父组件，父组件变量变化会同步给该@Link状态变量。</p>
<p>@Link支持装饰基础类型、class、数组、map、set等类型。其实总结就一句话，@Link除了能父子双向同步之外和@Prop基本一致。</p>
<p>我们直接看下实际代码应用中@Link和@Prop的差异：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct EntryIndex {
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">count</span>: number = <span class="hljs-number">0</span>
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Scroll</span>() {
      <span class="hljs-selector-tag">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`关联子组件的计数器: ${this.count}`</span>, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.count</span>++
          })
        <span class="hljs-selector-tag">ChildComponent1</span>({
          count: this.count,
        })
      }
    }
  }
}

<span class="hljs-variable">@Component</span>
struct ChildComponent1 {
  <span class="hljs-variable">@Prop</span> <span class="hljs-attribute">count</span>: number
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`子组件1的计数器（Prop）: ${this.count}`</span>, {
        type: ButtonType.Capsule
      })<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">12</span>)
        <span class="hljs-selector-class">.onClick</span>(() =&gt; {
          <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.count</span>++
        })
    }
  }
}

@<span class="hljs-selector-tag">Component</span>
<span class="hljs-selector-tag">struct</span> <span class="hljs-selector-tag">ChildComponent2</span> {
  <span class="hljs-variable">@Link</span> <span class="hljs-attribute">count</span>: number
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`子组件2的计数器（Link）: ${this.count}`</span>, {
        type: ButtonType.Capsule
      })<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">12</span>)
        <span class="hljs-selector-class">.onClick</span>(() =&gt; {
          <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.count</span>++
        })
    }
  }
}
</code></pre>
<p>父组件有一个@State装饰的count状态变量，分别传递给两个子组件，子组件1的count是用@Prop装饰，子组件2的count是用@Link装饰。当代码运行时：</p>
<ul>
<li>点击父组件的Button，无论是父组件自身的Button内容会+1，还是其他两个子组件的Button都会+1。</li>
<li>点击子组件1的Button，仅仅只有子组件1的Button内容会+1，父组件和子组件2的Button内容不变。</li>
<li>点击子组件2的Button，父组件和子组件2Button内容会+1，子组件1的Button内容变成和父组件和子组件2一致。</li>
</ul>
<p>以上几种装饰器已经能实现大部分组件状态管理的需求，但实际项目中还是有很多更复杂的场景，比如跨代组件状态同步。</p>
<h3 data-id="heading-5">@Provide和@Consume：后代组件双向同步</h3>
<p>@Provider和@Consume两者配合应用于跨代组件双向同步（不仅仅是爷孙组件），所以他们不需要传递变量，而是采用别名绑定的方式。</p>
<p>@Provider和@Consume支持装饰基础类型、class、数组、map、set、Date等类型。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct EntryIndex {
  <span class="hljs-keyword">@Provide</span>(<span class="hljs-string">'desCount'</span>) <span class="hljs-attribute">desCount</span>: number = <span class="hljs-number">0</span>
  build() {
    Scroll() {
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(`关联后代组件的计数器: ${this.desCount}`, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            this<span class="hljs-selector-class">.desCount</span>++
          })
        <span class="hljs-comment">// 伪代码表示组件层级嵌套</span>
        <span class="hljs-built_in">Child</span>(){
          <span class="hljs-built_in">DeDescendComponent1</span>()
        }
      }
    }
  }
}

<span class="hljs-keyword">@Component</span>
struct DescendComponent1 {
  <span class="hljs-keyword">@Consume</span>(<span class="hljs-string">'desCount'</span>) <span class="hljs-attribute">desCount</span>: number
  build() {
    <span class="hljs-built_in">Column</span>() {
      <span class="hljs-selector-tag">Button</span>(`后代组件<span class="hljs-number">1</span>的计数器: ${this.desCount}`, {
        type: ButtonType.Capsule
      })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
          this<span class="hljs-selector-class">.desCount</span>++
        })
    }
  }
}
</code></pre>
<p>以上用@Provider和@Consume装饰的且别名为"desCount"的变量数据会双向同步。</p>
<p>@Provider装饰的变量当然也可以传递，只是这个变量不会同步数据，它只有和@Consume配合才能双向同步。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80c3d8dffaaf42e296ce1e3515439e30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=5symrNcy2iCihiBfyf4xtHcqMY8%3D" alt="" loading="lazy"/></p>
<p>@Consume会特殊一些，它是禁止父组件传递变量给@Consume装饰的变量，因此它只有传递给子组件的权力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab482b41ec1d4eeb83a45420633cea6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=0aQMpba8AuwggnBaRd42IEEpmPY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">@Observed 和 @ObjectLink：嵌套类对象属性变化</h3>
<p>在实际应用开发中，对象传递可能比基础类型传递要更加常见，以上已经提及的装饰器只能观察到第一层，也就是说如果对象内部属性的变化是无法被观察到的。举个例子：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 定义一个类</span>
<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">CountObj</span> {
  name: string = ''
  count: number = 0
}

<span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct EntryIndex {
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">countObj</span>: CountObj = new <span class="hljs-built_in">CountObj</span>()
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Scroll</span>() {
      <span class="hljs-selector-tag">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-built_in">`${this.countObj.count}`</span>, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.countObj</span><span class="hljs-selector-class">.count</span>++
          })
      }
    }
  }
}
</code></pre>
<p>在这个示例里，this.countObj.count++是不会让Button重新渲染的，因为@State只能监听 countObj 本身，而不能监听到内部属性，所以我们要做的第一步是用@Observed装饰这个类，使这个类具备了内部属性被观察的能力，但这也仅仅是第一层属性，如果内部属性是对象，我们还是要给这个对象类用@Observed装饰。</p>
<p>@ObjectLink装饰的对象实例必须是已经用@Observed装饰的类，@ObjectLink仅支持装饰 class 对象类型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41e5ec49c28a4391a17f26abd771dde6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=v7VETj1%2FxWv94zZHMk08NdYh9R8%3D" alt="" loading="lazy"/></p>
<p>下面是一个使用示例，涉及到父组件 -&gt; 子组件 -&gt; 孙子组件的状态管理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct EntryIndex {
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">countArr</span>: CountObj[] = []
  build() {
    Scroll() {
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-selector-tag">Button</span>(`增加对象计数器`, {
          type: ButtonType.Capsule
        })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
            let countObj = new <span class="hljs-built_in">CountObj</span>()
            countObj<span class="hljs-selector-class">.name</span> = '测试'
            countObj<span class="hljs-selector-class">.count</span> = <span class="hljs-number">1</span>
            this<span class="hljs-selector-class">.countArr</span><span class="hljs-selector-class">.push</span>(countObj)
          })
        <span class="hljs-built_in">ChildComponent2</span>({
          countArr: this.countArr
        })
      }
    }
  }
}

<span class="hljs-keyword">@Component</span>
struct ChildComponent2 {
  <span class="hljs-keyword">@Link</span> <span class="hljs-attribute">countArr</span>: CountObj[]
  build() {
    <span class="hljs-built_in">Column</span>() {
      <span class="hljs-built_in">List</span>(){
        <span class="hljs-built_in">ForEach</span>(this.countArr, (item: CountObj) =&gt; {
          <span class="hljs-built_in">ListItem</span>(){
            <span class="hljs-built_in">DescendComponentList2</span>({
              desCountObj: item
            })
          }
        })
      }
    }
  }
}

<span class="hljs-keyword">@Component</span>
struct DescendComponentList2 {
  <span class="hljs-keyword">@ObjectLink</span> <span class="hljs-attribute">desCountObj</span>: CountObj
  build() {
    Text(`对象计数器(ObjectLink)${this<span class="hljs-selector-class">.desCountObj</span><span class="hljs-selector-class">.name</span>}：${this<span class="hljs-selector-class">.desCountObj</span><span class="hljs-selector-class">.count</span>}`)
      <span class="hljs-selector-class">.onClick</span>(() =&gt; {
        this<span class="hljs-selector-class">.desCountObj</span><span class="hljs-selector-class">.count</span>++
      })
  }
}
</code></pre>
<ol>
<li>父组件里@State装饰countArr数组对象，把countArr变量传递给了子组件，子组件用@Link装饰变量接收，这样保证父子是双向同步的，父组件和子组件都能观察到内数组的增删改查。</li>
<li>点击Button给countArr增加一个countObj对象，子组件观察到数组增加了，于是列表项增加了一个孙子组件。</li>
<li>孙子组件用@ObjectLink装饰了desCountObj变量，同时CountObj已经被@Observed装饰了，这个时候孙子组件内对desCountObj对象内属性的操作都会同步给子组件和父组件。</li>
</ol>
<p>通过这样的方式，未来增加其他兄弟组件都能观察到属性的变化，从而实现各组件UI联动。</p>
<h2 data-id="heading-7">三、管理应用内状态</h2>
<p>在第二章已经介绍了组件树上共享状态变量，从而实现UI和数据的绑定和联动。那么实际项目遇到的情况可能更加复杂，不同页面之间甚至是不同UIAbility之间都存在数据共享的情况。</p>
<h3 data-id="heading-8">页面间状态存储</h3>
<p>LocalStorage是ArkTS提供的页面级别的状态存储，可以从应用逻辑里使用LocalStorage，也可以从UI内部使用LocalStorage。</p>
<p>应用逻辑中使用简单看下示例代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">para</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>,<span class="hljs-built_in">number</span>&gt; = { <span class="hljs-string">'PropA'</span>: <span class="hljs-number">47</span> };
<span class="hljs-keyword">let</span> <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>(para); <span class="hljs-comment">// 创建新实例并使用给定对象初始化</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">propA</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = storage.<span class="hljs-title function_">get</span>(<span class="hljs-string">'PropA'</span>) <span class="hljs-comment">// propA == 47</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">link1</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = storage.<span class="hljs-title function_">link</span>(<span class="hljs-string">'PropA'</span>); <span class="hljs-comment">// link1.get() == 47</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">link2</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = storage.<span class="hljs-title function_">link</span>(<span class="hljs-string">'PropA'</span>); <span class="hljs-comment">// link2.get() == 47</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">prop</span>: <span class="hljs-title class_">SubscribedAbstractProperty</span>&lt;<span class="hljs-built_in">number</span>&gt; = storage.<span class="hljs-title function_">prop</span>(<span class="hljs-string">'PropA'</span>); <span class="hljs-comment">// prop.get() == 47</span>
link1.<span class="hljs-title function_">set</span>(<span class="hljs-number">48</span>); <span class="hljs-comment">// two-way sync: link1.get() == link2.get() == prop.get() == 48</span>
prop.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// one-way sync: prop.get() == 1; but link1.get() == link2.get() == 48</span>
link1.<span class="hljs-title function_">set</span>(<span class="hljs-number">49</span>); <span class="hljs-comment">// two-way sync: link1.get() == link2.get() == prop.get() == 49</span>
</code></pre>
<p>这样在LocalStorage对象内保存了 'PropA' 属性，由link方法获取的变量支持双向同步，prop方法获取的变量支持单向同步。我们重点看下UI内部的使用方式。</p>
<p>首先有两个装饰器@LocalStorageLink和@LocalStorageProp，一看名字我们就大致明白了这两个装饰器的作用，@LocalStorageLink支持双向同步，@LocalStorageProp支持单向同步，他们都是用别名的方式来绑定关系，接下来看一个示例来理解下：</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">let</span> <span class="hljs-variable language_">localStorage</span> = <span class="hljs-title class_">LocalStorage</span>.<span class="hljs-title function_">getShared</span>()
<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"count"</span>, <span class="hljs-number">0</span>)

<span class="hljs-meta">@Entry</span>(<span class="hljs-title class_">LocalStorage</span>.<span class="hljs-title function_">getShared</span>())
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">EntryIndex</span> {
  <span class="hljs-meta">@LocalStorageLink</span>(<span class="hljs-string">'count'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Scroll</span>() {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Button</span>(<span class="hljs-string">`关联其他页面的计数器: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>, {
          <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>
        }).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
          })
      }
    }
  }
}

<span class="hljs-meta">@Entry</span>(<span class="hljs-title class_">LocalStorage</span>.<span class="hljs-title function_">getShared</span>())
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">EntryNextPage</span> {
  <span class="hljs-meta">@LocalStorageProp</span>(<span class="hljs-string">'count'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>(){
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`单向关联上个页面的计数器: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>, {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>
      }).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
        })
    }
  }
}
</code></pre>
<ul>
<li>首先第一步要绑定LocalStorage和页面，两个页面的@Entry都绑定LocalStorage.getShared()，这代表他们共用一个LocalStorage对象，然后创建一个key为count的共享属性。</li>
<li>接着我们在组件内就可以通过定义相同的别名'count'来观察到属性变化，在第一个页面用的是@LocalStorageLink双向同步，所以当点击按钮后count++，其他所有被@LocalStorageLink和@LocalStorageProp装饰的变量都会观察到+1，从而重新渲染组件内容。</li>
<li>在第二个页面采用@LocalStorageProp观察count，所以点击Button使count++，这只能让自身页面的Button内容改变，而不能让其他页面同步变化。</li>
</ul>
<h3 data-id="heading-9">应用全局状态存储</h3>
<p>AppStorage是应用全局的UI状态存储，是和应用的进程绑定的。其实它的用法和LocalStorage基本上一模一样，装饰器@StorageLink双向同步和@StorageProp单向同步。使用示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">"count"</span>, <span class="hljs-number">0</span>)
<span class="hljs-comment">// EntryIndex是EntryAbility的页面</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">EntryIndex</span> {
  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'count'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Scroll</span>() {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Button</span>(<span class="hljs-string">`关联全局的计数器: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>, {
          <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>
        }).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
          })
      }
    }
  }
}

<span class="hljs-comment">// SecondIndex是SecondAbility的页面</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">export</span> struct <span class="hljs-title class_">SecondIndex</span> {
  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'count'</span>) <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>(){

      <span class="hljs-title class_">Button</span>(<span class="hljs-string">`关联全局的计数器: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>`</span>, {
        <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>
      }).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
        })
    }
  }
}
</code></pre>
<p>AppStorage.setOrCreate("count", 0)创建了一个共享属性，其他页面通过@StorageLink和@StorageProp就能联动了，</p>
<p>以上存储属于运行时内存存储，如果想要持久化存储，可以使用PersistentStorage，而且ArkTS已经把PersistentStorage和AppStorage关联起来可以共享同一属性，我们在UI内部使用时依然只需要关心@StorageLink和@StorageProp装饰器，在某处创建好需要持久化的属性即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4672987373a4a79b682f112e280cd56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56OK5bCR5bel5L2c5a6kX0NUTw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981224&amp;x-signature=oy3jgyZEhPJ2p4L4Yj5d15rm2PM%3D" alt="" loading="lazy"/></p>
<p><strong>参考资料</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Fapplication-dev-guide-V5%3FcatalogVersion%3DV5" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/application-dev-guide-V5?catalogVersion=V5" ref="nofollow noopener noreferrer">状态管理概述</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3 Flash 技术深度解析：多模态、推理引擎与开发者新特性]]></title>    <link>https://juejin.cn/post/7585897699603611674</link>    <guid>https://juejin.cn/post/7585897699603611674</guid>    <pubDate>2025-12-22T03:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603611674" data-draft-id="7585920796100591643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3 Flash 技术深度解析：多模态、推理引擎与开发者新特性"/> <meta itemprop="keywords" content="人工智能,AI编程,Gemini"/> <meta itemprop="datePublished" content="2025-12-22T03:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有痣青年"/> <meta itemprop="url" content="https://juejin.cn/user/905653309947037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3 Flash 技术深度解析：多模态、推理引擎与开发者新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309947037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有痣青年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:55:36.000Z" title="Mon Dec 22 2025 03:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入剖析 Google 最新 AI 模型 Gemini 3 Flash 的技术架构，了解它如何在保持极速响应的同时，实现 Pro 级别的推理能力。</p>
</blockquote>
<h2 data-id="heading-0">一、技术定位：打破速度与智能的对立</h2>
<p>传统观念认为，AI模型要么快但笨，要么强但慢。Gemini 3 Flash 的设计哲学是：<strong>用更聪明的架构设计，而非简单的参数堆砌，来同时实现速度和智能</strong>。</p>
<p>Google DeepMind 将其定位为：</p>
<blockquote>
<p>"Pro-grade reasoning with Flash-level latency, efficiency, and cost."
（Pro级推理能力 + Flash级延迟、效率和成本）</p>
</blockquote>
<p>这不是一句营销口号。从技术实现上看，Gemini 3 Flash 引入了多项创新机制来实现这一目标。</p>
<h2 data-id="heading-1">二、多模态架构详解</h2>
<h3 data-id="heading-2">2.1 原生多模态 vs 后融合多模态</h3>
<p>许多所谓的"多模态"模型实际上是在文本模型基础上拼接视觉/音频编码器。Gemini 3 Flash 采用的是<strong>原生多模态架构</strong>——从训练阶段就同时处理多种模态数据。</p>
<p><strong>支持的输入类型</strong>：</p>





























<table><thead><tr><th>模态</th><th>详情</th></tr></thead><tbody><tr><td>文本</td><td>自然语言、代码、结构化数据</td></tr><tr><td>图像</td><td>PNG, JPEG, WebP, GIF 等</td></tr><tr><td>音频</td><td>最长8.4小时，支持多格式</td></tr><tr><td>视频</td><td>帧级别分析能力</td></tr><tr><td>文档</td><td>PDF原生支持，无需OCR预处理</td></tr></tbody></table>
<h3 data-id="heading-3">2.2 视觉推理能力</h3>
<p>Gemini 3 Flash 在视觉理解上实现了重要突破：</p>
<ol>
<li><strong>空间推理</strong>：能够理解图像中元素的位置关系</li>
<li><strong>视觉代码执行</strong>：支持基于视觉输入执行代码</li>
<li><strong>复杂数据提取</strong>：从扫描文档、复杂布局中提取数据，准确率比上一代提升 <strong>15%</strong></li>
</ol>
<p>在 MMMU-Pro（多模态理解基准）测试中，Gemini 3 Flash 拿下 <strong>81.2%</strong> 的最高分，超越了 GPT-5.2 的 79.5%。</p>
<h3 data-id="heading-4">2.3 音频处理能力</h3>

























<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td>音频摘要</td><td>自动生成音频内容摘要</td></tr><tr><td>转录</td><td>高精度语音转文字</td></tr><tr><td>翻译</td><td>跨语言音频理解</td></tr><tr><td>容量</td><td>单次请求最长约8.4小时</td></tr></tbody></table>
<h2 data-id="heading-5">三、Thinking Level：可控的推理深度</h2>
<h3 data-id="heading-6">3.1 为什么需要可控推理？</h3>
<p>不同任务对推理深度的要求不同：</p>
<ul>
<li>简单问答 → 快速响应更重要</li>
<li>数学证明 → 深度推理更重要</li>
<li>代码调试 → 需要平衡</li>
</ul>
<p>Gemini 3 Flash 引入了 <code>thinking_level</code> 参数，让开发者可以<strong>显式控制模型的推理深度</strong>。</p>
<h3 data-id="heading-7">3.2 四个推理等级</h3>






























<table><thead><tr><th>等级</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><code>minimal</code></td><td>最快速度，最低延迟</td><td>简单问答、快速响应</td></tr><tr><td><code>low</code></td><td>轻度推理</td><td>日常对话、信息检索</td></tr><tr><td><code>medium</code></td><td>平衡选择</td><td>一般分析、内容生成</td></tr><tr><td><code>high</code></td><td>深度推理</td><td>复杂问题、数学推导</td></tr></tbody></table>
<h3 data-id="heading-8">3.3 与 Gemini 2.5 的对比</h3>




















<table><thead><tr><th>版本</th><th>控制方式</th><th>灵活性</th></tr></thead><tbody><tr><td>Gemini 2.5 Flash</td><td><code>thinking_budget</code>（token预算）</td><td>数值控制</td></tr><tr><td>Gemini 3 Flash</td><td><code>thinking_level</code>（推理等级）</td><td>语义控制，更直观</td></tr></tbody></table>
<p><strong>关键提示</strong>：在 <code>minimal</code> 级别下，Gemini 3 Flash 可以达到与 Gemini 2.5 Flash（thinking_budget=0）相似的延迟和成本。</p>
<h2 data-id="heading-9">四、Thought Signatures：推理连续性的秘密</h2>
<h3 data-id="heading-10">4.1 什么是 Thought Signatures？</h3>
<p>Thought Signatures（思维签名）是 Gemini 3 引入的一项关键技术创新。它是模型内部推理过程的<strong>加密表示</strong>，用于在多轮API调用间保持推理的连贯性。</p>
<p>类比理解：如果把 AI 的推理过程比作一个人解数学题，Thought Signatures 就像是他的"草稿纸"——虽然最终答案写在答题纸上，但没有草稿纸就无法保持解题思路的连贯性。</p>
<h3 data-id="heading-11">4.2 工作机制</h3>
<pre><code class="hljs language-markdown" lang="markdown">请求1 → 模型推理 → 响应1 + Thought Signature
<span class="hljs-code">                            ↓
请求2 + Thought Signature → 模型推理（继承上下文）→ 响应2 + 新的 Thought Signature
</span></code></pre>
<h3 data-id="heading-12">4.3 开发者注意事项</h3>
<p>⚠️ <strong>关键规则</strong>：</p>
<ol>
<li>必须原样返回收到的 Thought Signatures</li>
<li>即使 <code>thinking_level</code> 设为 <code>minimal</code>，也需要传递 Thought Signatures</li>
<li>特别是在多轮函数调用场景中，这一点至关重要</li>
</ol>
<h2 data-id="heading-13">五、Media Resolution：精细化视觉控制</h2>
<h3 data-id="heading-14">5.1 参数说明</h3>
<p><code>media_resolution</code> 参数允许开发者控制视觉输入的处理精度：</p>






























<table><thead><tr><th>级别</th><th>Token消耗</th><th>适用场景</th></tr></thead><tbody><tr><td><code>low</code></td><td>最少</td><td>快速预览、简单识别</td></tr><tr><td><code>medium</code></td><td>中等</td><td>一般图像分析</td></tr><tr><td><code>high</code></td><td>较多</td><td>细节识别、文字提取</td></tr><tr><td><code>ultra-high</code></td><td>最多</td><td>精密分析、小字体识别</td></tr></tbody></table>
<h3 data-id="heading-15">5.2 使用建议</h3>
<ul>
<li><strong>需要识别图像中的小字体</strong> → 使用 <code>high</code> 或 <code>ultra-high</code></li>
<li><strong>只需了解图像大意</strong> → 使用 <code>low</code> 节省成本</li>
<li><strong>不确定时</strong> → 从 <code>medium</code> 开始，根据效果调整</li>
</ul>
<h2 data-id="heading-16">六、开发者 API 新特性</h2>
<h3 data-id="heading-17">6.1 Streaming Function Calling</h3>
<p>Gemini 3 Flash 支持<strong>流式函数调用</strong>——在函数执行过程中就开始返回部分参数，而不是等待完整结果。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">传统方式: 等待完整参数 → 一次性返回</span>
<span class="hljs-section">流式方式: 参数1 → 参数2 → 参数3 → ... (逐步返回)</span>
</code></pre>
<p>应用价值：用户可以更早看到响应开始，提升交互体验。</p>
<h3 data-id="heading-18">6.2 多模态函数响应</h3>
<p>函数调用的响应不再局限于文本，现在可以包含：</p>
<ul>
<li>图像</li>
<li>PDF</li>
<li>其他多模态对象</li>
</ul>
<p>这为构建复杂的视觉工作流提供了可能。</p>
<h3 data-id="heading-19">6.3 Tool Use 能力</h3>





























<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td>Google Search Grounding</td><td>使用搜索增强回答</td></tr><tr><td>Code Execution</td><td>执行代码验证结果</td></tr><tr><td>System Instructions</td><td>系统级指令控制</td></tr><tr><td>Structured Output</td><td>强制输出JSON等结构化数据</td></tr><tr><td>Function Calling</td><td>调用外部函数/API</td></tr></tbody></table>
<h2 data-id="heading-20">七、与 Gemini 2.5 Flash 技术对比</h2>























































<table><thead><tr><th>技术特性</th><th>Gemini 2.5 Flash</th><th>Gemini 3 Flash</th></tr></thead><tbody><tr><td>推理控制</td><td>thinking_budget</td><td>thinking_level</td></tr><tr><td>推理连续性</td><td>无</td><td>Thought Signatures</td></tr><tr><td>视觉控制</td><td>基础</td><td>media_resolution参数</td></tr><tr><td>函数调用</td><td>同步</td><td>支持流式</td></tr><tr><td>函数响应</td><td>仅文本</td><td>多模态对象</td></tr><tr><td>代码执行</td><td>仅文本输入</td><td>支持视觉输入</td></tr><tr><td>图像分割</td><td>✅ 支持</td><td>❌ 不支持</td></tr><tr><td>整体准确性</td><td>基准</td><td>+15%</td></tr><tr><td>Token效率</td><td>基准</td><td>-30%</td></tr></tbody></table>
<h2 data-id="heading-21">八、底层优化推测</h2>
<p>虽然 Google 没有公开完整的技术细节，但从公开信息可以推测一些优化方向：</p>
<h3 data-id="heading-22">8.1 Token 效率优化</h3>
<p>相同任务减少30%的token使用量，可能涉及：</p>
<ul>
<li>更高效的tokenizer</li>
<li>更紧凑的内部表示</li>
<li>智能的上下文压缩</li>
</ul>
<h3 data-id="heading-23">8.2 推理加速</h3>
<p>3倍速度提升，可能来自：</p>
<ul>
<li>模型架构优化（稀疏化、知识蒸馏等）</li>
<li>推理引擎优化（更好的batching策略）</li>
<li>硬件协同优化（TPU深度定制）</li>
</ul>
<h3 data-id="heading-24">8.3 多模态融合</h3>
<p>原生多模态带来的好处：</p>
<ul>
<li>减少模态转换开销</li>
<li>更好的跨模态理解</li>
<li>统一的表示空间</li>
</ul>
<h2 data-id="heading-25">九、开发者快速上手</h2>
<h3 data-id="heading-26">9.1 获取 API Key</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：Google AI Studio（推荐新手）</span>
访问 https://aistudio.google.com
登录 → 选择 Gemini 3 Flash → 生成 API Key

<span class="hljs-comment"># 方式2：Vertex AI（推荐生产环境）</span>
gcloud auth application-default login
</code></pre>
<h3 data-id="heading-27">9.2 基础调用示例（概念）</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">POST /v1beta/models/gemini-<span class="hljs-number">3</span>-flash-preview:generateContent
<span class="hljs-symbol">Header:</span> x-goog-api-<span class="hljs-keyword">key</span>: YOUR_API_KEY

<span class="hljs-symbol">Body:</span>
{
  <span class="hljs-string">"contents"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"parts"</span>: [{<span class="hljs-string">"text"</span>: <span class="hljs-string">"你的问题"</span>}]}],
  <span class="hljs-string">"generationConfig"</span>: {
    <span class="hljs-string">"thinking_level"</span>: <span class="hljs-string">"medium"</span>
  }
}
</code></pre>
<h3 data-id="heading-28">9.3 最佳实践</h3>
<ol>
<li><strong>保持 temperature 为 1.0</strong> —— 偏离默认值可能影响推理性能</li>
<li><strong>实现重试逻辑</strong> —— 使用指数退避处理临时错误</li>
<li><strong>监控 token 使用</strong> —— 记录每次请求的输入/输出token</li>
<li><strong>使用 Context Caching</strong> —— 重复上下文可节省90%成本</li>
<li><strong>关注官方更新</strong> —— 预览版本会持续迭代</li>
</ol>
<h2 data-id="heading-29">十、总结</h2>
<p>Gemini 3 Flash 的技术创新体现在多个层面：</p>
<ol>
<li><strong>可控推理</strong>：thinking_level让开发者可以根据场景灵活调整</li>
<li><strong>推理连续性</strong>：Thought Signatures确保多轮对话的连贯性</li>
<li><strong>精细视觉控制</strong>：media_resolution平衡精度与成本</li>
<li><strong>增强的工具使用</strong>：流式函数调用、多模态响应</li>
<li><strong>效率突破</strong>：3倍速度提升，30%token节省</li>
</ol>
<p>对于需要在<strong>生产环境中大规模部署AI能力</strong>的团队来说，这些技术创新意味着：更低的成本、更快的响应、更好的用户体验，以及更强的可控性——这正是Gemini 3 Flash的核心价值所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[线程数突增！领导：谁再这么写就滚蛋！]]></title>    <link>https://juejin.cn/post/7586157459972423732</link>    <guid>https://juejin.cn/post/7586157459972423732</guid>    <pubDate>2025-12-22T05:39:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459972423732" data-draft-id="7586157459972390964" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="线程数突增！领导：谁再这么写就滚蛋！"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2025-12-22T05:39:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马卡巴卡"/> <meta itemprop="url" content="https://juejin.cn/user/1892677617451163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            线程数突增！领导：谁再这么写就滚蛋！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892677617451163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马卡巴卡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:39:01.000Z" title="Mon Dec 22 2025 05:39:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>分享一个线上问题引出的一次思考，过程比较长，但是挺有意思。</p>
<p>下面是正文。</p>
<p>今天上班把需求写完，出于学习（摸鱼）的心理上 skywalking 看看，突然发现我们的一个应用，应用内线程数超过 900 条，接近 1000 条，但是 cpu 并没有高涨，内存也不算高峰。</p>
<p>但是敏锐的我还是立刻意识到这个应用有不妥，因为线程数太多了，不符合我们一个正常健康的应用数量。熟练的打出 cpu dump 观察，首先看线程组名的概览。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f925bc7dabb5492586ec6fbc55ce5f77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=buIKXpI2Mda03hmzLCQW8RIRqgA%3D" alt="" loading="lazy"/></p>
<p>从线程分组看，pool 名开头线程占 616 条，而且 waiting 状态也是 616 条，这个点就非常可疑了，我断定就是这个 pool 开头线程池导致的问题。我们先排查为何这个线程池中会有 600+的线程处于 waiting 状态并且无法释放，记接下来我们找几条线程的堆栈观察具体堆栈：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e92a108536394548beb7ed029f61be74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=BR6vFbTFZsSPMA1xi%2FKOC0Cg2aY%3D" alt="" loading="lazy"/></p>
<p>这个堆栈看上去很合理，线程在线程池中不断的循环获取任务，因为获取不到任务所以进入了 waiting 状态，等待着有任务后被唤醒。</p>
<p>看上去不只一个线程池，并且这些线程池的名字居然是一样的，我大胆的猜测一下，是不断的创建同样的线程池，但是线程池无法被回收导致的线程数，所以接下来我们要分析两个问题，首先这个线程池在代码里是哪个线程池，第二这个线程池是怎么被创建的？为啥释放不了？</p>
<p>我在 idea 搜索<code>new ThreadPoolExecutor()</code>得到的结果是这样的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32d2cbce57745b1abb0e723caae21ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=hAFJTEt%2FZ2qJXwgBy3s%2FiaDBNPQ%3D" alt="" loading="lazy"/></p>
<p>于是我陷入懵逼的状态，难道还有其他骚操作？</p>
<p>正在这时，一位不知名的郑网友发来一张截图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de58d5e910e142ba98808976dd4c2aa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=hJHQ4l0fV%2BoIDt%2Fag%2BQ4DaZbyl8%3D" alt="" loading="lazy"/></p>
<p>好家伙！竟然是用<code>new FixedTreadPool()</code>整出来的。难怪我完全搜不到，因为用的<code>new FixedTreadPool()</code>，所以线程池中的线程名是默认的 pool（又多了一个不使用 Executors 来创建线程池的理由）。</p>
<p>然后我迫不及 die 的打开代码，试图找到罪魁祸首，结果发现作者居然是我自己。这是另一个惊喜，惊吓的惊。</p>
<p>冷静下来后我梳理一遍代码，这个接口是我两年前写的，主要是功能是统计用户的钱包每个月的流水，因为担心统计比较慢，所以使用了线程池，做了批量的处理，没想到居然导致了线程数过高，虽然没有导致事故，但是确实是潜在的隐患，现在没出事不代表以后不会出事。</p>
<p>去掉多余业务逻辑，我简单的还原一个代码给大家看，还原现场：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">threadDontGcDemo</span>()</span>{
    ExecutorService executorService = Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
    executorService.submit(() -&gt; {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"111"</span>);
    });
}
</code></pre>
<h2 data-id="heading-0">那么为啥线程池里面的线程和线程池都没释放呢</h2>
<p>难道是因为没有调用 shutdown？我大概能理解我两年前当时为啥不调用 shutdown，是因为当初我觉得接口跑完，方法走到结束，理论上栈帧出栈，局部变量应该都销毁了，按理说<code>executorService</code>这个变量应该直接 GG 了，那么按理说我是不用调用 shutdown 方法的。</p>
<p>我简单的跑了个 demo，循环的去 new 线程池，不调用 shutdown 方法，看看线程池能不能被回收</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22702809273c472fb4598c3de6fdf026~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=jGg4f77YvEmKG7E5G32k%2BDF7YFw%3D" alt="" loading="lazy"/></p>
<p>打开<code>java visual vm</code>查看实时线程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c9433b90bbc461ab694d123e0d71765~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=UPmRp7xb3FI788AsOa33bInb47w%3D" alt="" loading="lazy"/></p>
<p>可以看到线程数和线程池都一直在增加，但是一直没有被回收，确实符合发生的问题状况，那么假如我在方法结束前调用 shutdown 方法呢，会不会回收线程池和线程呢？</p>
<p>简单写个 demo 结合 jvisualvm 验证下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e13d76131834d8396874a8596fac242~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=2n%2FWVKmr2ZOPVhpMhN%2F%2B5YbyOL8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b621501a385d4f86ac1d2e91e8ed8734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=ZcUbcy4%2BubwOlVthqe5%2BiGpqsDc%3D" alt="" loading="lazy"/></p>
<p><strong>结果是线程和线程池都被回收了。也就是说，执行了 shutdown 的线程池最后会回收线程池和线程对象。</strong></p>
<p>我们知道，一个对象能不能回收，是看它到 gc root 之间有没有可达路径，线程池不能回收说明到达线程池的 gc root 还是有可达路径的。这里讲个冷知识，这里的线程池的 gc root 是线程，具体的 gc 路径是<code>thread-&gt;workers-&gt;线程池</code>。</p>
<p>线程对象是线程池的 gc root，假如线程对象能被 gc，那么线程池对象肯定也能被 gc 掉（因为线程池对象已经没有到 gc root 的可达路径了）。</p>
<h2 data-id="heading-1">那么现在问题就转为线程对象是在什么时候 gc</h2>
<p>郑网友给了一个粗浅但是合理的解释，线程对象肯定不是在运行中的时候被回收的，因为 jvm 肯定不可能去回收一条在运行中的线程，至少 runnalbe 状态的线程 jvm 不可能去回收。</p>
<p>在 stackoverflow 上我找到了更准确的答案：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f6387372d7149a89d61d0a02f10fbae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Y2h5be05Y2h:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766986741&amp;x-signature=nYk1B749hAmjO9AT2aLTNvxZT3U%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>A running thread is considered a so called garbage collection root and is one of those things keeping stuff from being garbage collected</p>
</blockquote>
<p>这句话的意思是，一条正在运行的线程是 gc root，注意，是正在运行，这个正在运行我先透露下，即使是 waiting 状态，也算正在运行。这个回答的整体的意思是，运行的线程是 gc root，但是非运行的线程不是 gc root（可以被回收）。</p>
<p>现在比较清楚了，线程池和线程被回收的关键就在于线程能不能被回收，那么回到原来的起点，为何调用线程池的 shutdown 方法能够导致线程和线程池被回收呢？难道是 shutdown 方法把线程变成了非运行状态吗？</p>
<blockquote>
<p>talk is cheap,show me the code</p>
</blockquote>
<p>我们直接看看线程池的 shutdown 方法的源码</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">shutdown</span>() {
    final ReentrantLock mainLock = this<span class="hljs-selector-class">.mainLock</span>;
    mainLock<span class="hljs-selector-class">.lock</span>();
    try {
        <span class="hljs-built_in">checkShutdownAccess</span>();
        <span class="hljs-built_in">advanceRunState</span>(SHUTDOWN);
        <span class="hljs-built_in">interruptIdleWorkers</span>();
        <span class="hljs-built_in">onShutdown</span>(); <span class="hljs-comment">// hook for ScheduledThreadPoolExecutor</span>
    } finally {
        mainLock<span class="hljs-selector-class">.unlock</span>();
    }
    <span class="hljs-built_in">tryTerminate</span>();
}

private void <span class="hljs-built_in">interruptIdleWorkers</span>() {
    <span class="hljs-built_in">interruptIdleWorkers</span>(false);
}

private void <span class="hljs-built_in">interruptIdleWorkers</span>(boolean onlyOne) {
    final ReentrantLock mainLock = this<span class="hljs-selector-class">.mainLock</span>;
    mainLock<span class="hljs-selector-class">.lock</span>();
    try {
        for (Worker w : workers) {
            Thread t = w<span class="hljs-selector-class">.thread</span>;
            if (!t.isInterrupted() &amp;&amp; w<span class="hljs-selector-class">.tryLock</span>()) {
                try {
                    t<span class="hljs-selector-class">.interrupt</span>();
                } catch (SecurityException ignore) {
                } finally {
                    w<span class="hljs-selector-class">.unlock</span>();
                }
            }
            if (onlyOne)
                break;
        }
    } finally {
        mainLock<span class="hljs-selector-class">.unlock</span>();
    }
}
</code></pre>
<p>我们从<code>interruptIdleWorkers</code>方法入手，这方法看上去最可疑，看到<code>interruptIdleWorkers</code>方法，这个方法里面主要就做了一件事，遍历当前线程池中的线程，并且调用线程的<code>interrupt()</code>方法，通知线程中断，也就是说 shutdown 方法只是去遍历所有线程池中的线程，然后通知线程中断。所以我们需要了解线程池里的线程是怎么处理中断的通知的。</p>
<p>我们点开 worker 对象，这个 worker 对象是线程池中实际运行的线程，所以我们直接看 worker 的 run 方法，中断通知肯定是在里面被处理了</p>
<pre><code class="hljs language-ini" lang="ini">//WOrker的run方法里面直接调用的是这个方法
final void runWorker(Worker w) {
    Thread <span class="hljs-attr">wt</span> = Thread.currentThread()<span class="hljs-comment">;</span>
    Runnable <span class="hljs-attr">task</span> = w.firstTask<span class="hljs-comment">;</span>
    <span class="hljs-attr">w.firstTask</span> = null<span class="hljs-comment">;</span>
    w.unlock()<span class="hljs-comment">; // allow interrupts</span>
    boolean <span class="hljs-attr">completedAbruptly</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    try {
        while (task != null || (<span class="hljs-attr">task</span> = getTask()) != null) {
            w.lock()<span class="hljs-comment">;</span>
            // If pool is stopping, ensure thread is interrupted<span class="hljs-comment">;</span>
            // if not, ensure thread is not interrupted.  This
            // requires a recheck in second case to deal with
            // shutdownNow race while clearing interrupt
            if ((runStateAtLeast(ctl.get(), STOP) ||
                 (Thread.interrupted() &amp;&amp;
                  runStateAtLeast(ctl.get(), STOP))) &amp;&amp;
                !wt.isInterrupted())
                wt.interrupt()<span class="hljs-comment">;</span>
            try {
                beforeExecute(wt, task)<span class="hljs-comment">;</span>
                Throwable <span class="hljs-attr">thrown</span> = null<span class="hljs-comment">;</span>
                try {
                    task.run()<span class="hljs-comment">;</span>
                } catch (RuntimeException x) {
                    <span class="hljs-attr">thrown</span> = x<span class="hljs-comment">; throw x;</span>
                } catch (Error x) {
                    <span class="hljs-attr">thrown</span> = x<span class="hljs-comment">; throw x;</span>
                } catch (Throwable x) {
                    <span class="hljs-attr">thrown</span> = x<span class="hljs-comment">; thrownew Error(x);</span>
                } finally {
                    afterExecute(task, thrown)<span class="hljs-comment">;</span>
                }
            } finally {
                <span class="hljs-attr">task</span> = null<span class="hljs-comment">;</span>
                w.completedTasks++<span class="hljs-comment">;</span>
                w.unlock()<span class="hljs-comment">;</span>
            }
        }
        <span class="hljs-attr">completedAbruptly</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    } finally {
        processWorkerExit(w, completedAbruptly)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>这个 runwoker 属于是线程池的核心方法了，相当的有意思，线程池能不断运作的原理就是这里，我们一点点看。</p>
<p>首先最外层用一个 while 循环套住，然后不断的调用<code>gettask()</code>方法不断从队列中取任务，假如拿不到任务或者任务执行发生异常（抛出异常了）那就属于异常情况，直接将<code>completedAbruptly</code> 设置为 true，并且进入异常的<code>processWorkerExit</code>流程。</p>
<p>我们看看<code>gettask()</code>方法，了解下啥时候可能会抛出异常：</p>
<pre><code class="hljs language-ini" lang="ini">private Runnable getTask() {
    boolean <span class="hljs-attr">timedOut</span> = <span class="hljs-literal">false</span><span class="hljs-comment">; // Did the last poll() time out?</span>

    for (<span class="hljs-comment">;;) {</span>
        int <span class="hljs-attr">c</span> = ctl.get()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">rs</span> = runStateOf(c)<span class="hljs-comment">;</span>

        // Check if queue empty only if necessary.
        if (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) {
            decrementWorkerCount()<span class="hljs-comment">;</span>
            returnnull<span class="hljs-comment">;</span>
        }

        int <span class="hljs-attr">wc</span> = workerCountOf(c)<span class="hljs-comment">;</span>

        // Are workers subject to culling?
        boolean <span class="hljs-attr">timed</span> = allowCoreThreadTimeOut || wc &gt; corePoolSize<span class="hljs-comment">;</span>

        if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut))
            &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) {
            if (compareAndDecrementWorkerCount(c))
                returnnull<span class="hljs-comment">;</span>
            continue<span class="hljs-comment">;</span>
        }

        try {
            Runnable <span class="hljs-attr">r</span> = timed ?
                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
            workQueue.take()<span class="hljs-comment">;</span>
            if (r != null)
                return r<span class="hljs-comment">;</span>
            <span class="hljs-attr">timedOut</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        } catch (InterruptedException retry) {
            <span class="hljs-attr">timedOut</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<p>这样很清楚了，抛去前面的大部分代码不看，这句代码解释了 gettask 的作用：</p>
<pre><code class="hljs language-ini" lang="ini">Runnable <span class="hljs-attr">r</span> = timed ?
    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :
workQueue.take()
</code></pre>
<p>gettask 就是从工作队列中取任务，但是前面还有个 timed，这个 timed 的语义是这样的：如果<code>allowCoreThreadTimeOut</code>参数为 true（一般为 false）或者当前工作线程数超过核心线程数，那么使用队列的 poll 方法取任务，反之使用 take 方法。</p>
<p>这两个方法不是重点，重点是 poll 方法和 take 方法都会让当前线程进入<code>time_waiting</code>或者 waiting 状态。而当线程处于在等待状态的时候，我们调用线程的 interrupt 方法，毫无疑问会使线程当场抛出异常！</p>
<p><strong>也就是说线程池的<code>shutdownnow</code>方法调用<code>interruptIdleWorkers</code>去对线程对象 interrupt 是为了让处于 waiting 或者是<code>time_waiting</code>的线程抛出异常。</strong></p>
<p>那么线程池是在哪里处理这个异常的呢？我们看<code>runwoker</code>中的调用的<code>processWorkerExit</code>方法，说实话这个方法看着就像处理抛出异常的方法：</p>
<pre><code class="hljs language-ini" lang="ini">private void processWorkerExit(Worker w, boolean completedAbruptly) {
    if (completedAbruptly) // If abrupt, then workerCount wasn't adjusted
        decrementWorkerCount()<span class="hljs-comment">;</span>

    final ReentrantLock <span class="hljs-attr">mainLock</span> = this.mainLock<span class="hljs-comment">;</span>
    mainLock.lock()<span class="hljs-comment">;</span>
    try {
        completedTaskCount += w.completedTasks<span class="hljs-comment">;</span>
        workers.remove(w)<span class="hljs-comment">;</span>
    } finally {
        mainLock.unlock()<span class="hljs-comment">;</span>
    }

    tryTerminate()<span class="hljs-comment">;</span>

    int <span class="hljs-attr">c</span> = ctl.get()<span class="hljs-comment">;</span>
    if (runStateLessThan(c, STOP)) {
        if (!completedAbruptly) {
            int <span class="hljs-attr">min</span> = allowCoreThreadTimeOut ? <span class="hljs-number">0</span> : corePoolSize<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">min</span> == <span class="hljs-number">0</span> &amp;&amp; ! workQueue.isEmpty())
                <span class="hljs-attr">min</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
            if (workerCountOf(c) &gt;= min)
                return<span class="hljs-comment">; // replacement not needed</span>
        }
        addWorker(null, false)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>我们可以看到，在这个方法里有一个很明显的<code>workers.remove(w)</code>方法，也就是在这里，这个 w 的变量，被移出了 workers 这个集合，导致 worker 对象不能到达 gc root，于是 workder 对象顺理成章的变成了一个垃圾对象，被回收掉了。</p>
<p>然后等到 worker 中所有的 worker 都被移出 works 后，并且当前请求线程也完成后，线程池对象也成为了一个孤儿对象，没办法到达<code>gc root</code>，于是线程池对象也被 gc 掉了。写了挺长的篇幅，我小结一下：</p>
<ul>
<li>线程池调用<code>shutdownnow</code>方法是为了调用 worker 对象的 interrupt 方法，来打断那些沉睡中的线程（waiting 或者<code>time_waiting</code>状态），使其抛出异常</li>
<li>线程池会把抛出异常的 worker 对象从 workers 集合中移除引用，此时被移除的 worker 对象因为没有到达<code>gc root</code>的路径已经可以被 gc 掉了</li>
<li>等到 workers 对象空了，并且当前 tomcat 线程也结束，此时线程池对象也可以被 gc 掉，整个线程池对象成功释放</li>
</ul>
<h2 data-id="heading-2">总结</h2>
<p>如果只是在局部方法中使用线程池，线程池对象不是 bean 的情况时，记得要合理的使用<code>shutdown</code>或者<code>shutdownnow</code>方法来释放线程和线程池对象，如果不使用，会造成线程池和线程对象的堆积。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[推荐 6 个近期火火火的 GitHub 项目]]></title>    <link>https://juejin.cn/post/7585928504949702692</link>    <guid>https://juejin.cn/post/7585928504949702692</guid>    <pubDate>2025-12-22T05:48:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585928504949702692" data-draft-id="7586540799219892265" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="推荐 6 个近期火火火的 GitHub 项目"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-22T05:48:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            推荐 6 个近期火火火的 GitHub 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:48:04.000Z" title="Mon Dec 22 2025 05:48:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01、AI 对冲基金团队</h2>
<p>AI Hedge Fund 搞了一个由多个 AI 智能体组成的虚拟对冲基金团队。</p>
<p>现在在 GitHub 上都 43K 的 Star 了。</p>
<p>核心理念就是用大模型分别扮演不同的投资专家角色：比如巴菲特（价值投资）、凯瑟琳·伍德（成长型投资）、Bill Ackman（激进投资）等。</p>
<p>这些 AI 智能体会协同工作，通过分析数据来制定交易决策。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c573dbccf8457b82d4b0938ac05614~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=RoExG4JyKFfL1zV48OOG%2FEORWcI%3D" alt="图片" loading="lazy"/></p>
<p>而且这些智能体分工很明确，有的负责估值、有的分析市场情绪、研究基本面、技术分析。</p>
<p>所有的分析结果最终汇总给投资组合经理进行综合权衡，并由风险控制模块把关，最终模拟出买入或卖出的指令。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9efc4f894604bc0b5e13a573128a263~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=V%2B9%2B6DgiOm7a1SVQ1%2BPGWYgufAM%3D" alt="图片" loading="lazy"/></p>
<p>这个开源项目仅仅用于教育和研究目的哈，别用于真实的真金白银交易哦。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/virattt/ai-hedge-fund</span>
</code></pre>
<h2 data-id="heading-1">02、AI Agent 搭建平替</h2>
<p>Sim 是一个 22K  Star 的开源 AI  Agent工作流构建与部署平台，通过可视化的拖拽界面降低 AI 应用的开发门槛。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af1f811ed9f8446f90e6d44d32d46a25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=XcHmu8ijCSVgUnK3Evn6K3uLo0c%3D" alt="图片" loading="lazy"/></p>
<p><strong>这个开源项目的核心是</strong> Agent 可视化编排，就像下面视频演示的，像画流程图一样设计 AI 复杂的思考逻辑，比如如循环推理、反思。比较适合搭建一个深度定制的 AI 应用。</p>
<p><strong>之前提到的 n8n</strong> 更多是自动化工作流 <strong>，它的强项是</strong>连接，主要用于把不同的应用节点串联起来自动执行任务，AI 只是一个节点。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/simstudioai/sim</span>
</code></pre>
<h2 data-id="heading-2">03、浙大开源的大模型基础书籍</h2>
<p>这是一本浙江大学开源的大模型书籍，系统地介绍了大模型的基础知识和前沿技术。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95160ad390bb415c9483ca4b94686f3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=yvAMXSPJNeQXvvTGi7Em5Xxnu0w%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这本书内容挺详实的，从传统统计语言模型到现代 Transformer 架构的演进过程。</p>
<p>而且还有 Prompt 工程、参数高效微调（PEFT）、模型编辑以及 RAG 等主题，是学习 LLM 理论与实践的绝佳资料。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2ef1cb189d6425e913beaa970eb1a27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=0p%2B9GWaCrYRyOHvkWQVeL9nOaO8%3D" alt="图片" loading="lazy"/></p>
<p>重点是每一章都配备了详细的论文列表，帮助你追踪相关领域的最新研究进展。</p>
<p>作者团队还说会进行月度更新，并积极听取开源社区的反馈修正谬误和补充新内容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f44e0dc3488c4b5c98a95a80ef9a9937~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=B%2BqbXGRitL7Ip7zWzGUrfJgomTw%3D" alt="图片" loading="lazy"/></p>
<p>这个开源项目很适合计算机相关专业的学生作为入门教材，也可以作为科研人员和工程师的参考手册。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/ZJU-LLMs/Foundations-of-LLMs</span>
</code></pre>
<h2 data-id="heading-3">04、claude-mem</h2>
<p>Claude-Mem 是一个 Claude Code 插件，解决长对话中失忆的问题。</p>
<p>随着编程会话的深入，上下文窗口往往会耗尽，导致 AI 忘记之前的决策或代码变更。</p>
<p>Claude-Mem 通过自动捕获所有的工具使用记录、生成语义摘要，并将关键上下文注入到未来的会话中，赋予了 Claude 持久的记忆力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ad0e4344e3445579a23d5e35fb6587b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=52Emh6eZq8GBNw7vbEZkR1DbgHY%3D" alt="图片" loading="lazy"/></p>
<p>这个项目的技术实现非常精妙，它结合了 SQLite 数据库和向量搜索（ChromaDB）。</p>
<p>你进行开发时，插件会在后台默默工作，将交互过程压缩并存储。当你开启新会话或询问过去的工作时，它能通过 mem-search 技能，利用关键词和语义检索快速找回相关的背景信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0012ef2691ca44f5ad713252056a8eef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=u85PqoB7cYTIlETvi%2FFSIwd%2Bax0%3D" alt="图片" loading="lazy"/></p>
<p>这意味着即使你关闭终端甚至重启电脑，Claude 依然能记得上一次你们修了哪个 Bug 或讨论了哪种架构。</p>
<p>Claude-Mem 还引入了一个 Endless Mode，试图打破上下文长度的限制。</p>
<p>它通过实时压缩历史记录，将庞大的对话历史转化为精简的 Observations，从而在理论上支持无限长的编程会话。</p>
<p>这不仅节省了大量的 Token 成本，也极大地提升了处理大型重构任务时的连续性和准确性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3652b9a838b4f4bbe2850a82959ada4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=IVdTHKbkOwZy6nDdIMijyxvPHUE%3D" alt="图片" loading="lazy"/></p>
<p>如果想用一用，可以在终端中启动一个新的 Claude Code 会话，并输入以下命令就行了： </p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt;</span><span class="bash"> /plugin marketplace add thedotmack/claude-mem &gt; /plugin install claude-mem</span> 
</code></pre>
<p>重新启动 Claude Code。之前会话的上下文将会自动出现在新会话中。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/thedotmack/claude-mem</span>
</code></pre>
<h2 data-id="heading-4">05、ConvertX</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c81540b9fdb14f25a3349e757e556761~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=MCEYkDWp1CfREhT%2BKwFxEwktoVY%3D" alt="图片" loading="lazy"/></p>
<p>ConvertX 是一个功能强大的在线文件转换工具，支持超过 1000 种不同格式之间的相互转换。</p>
<p>它的特点就是：私有、安全、免费开源。无论是图片、文档、电子书、音频还是视频，它都能处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/002d61d02aae4a7587dcc4d0ee4242f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=h7TweEFDJjfjNiX29kKmpCXkYRI%3D" alt="图片" loading="lazy"/></p>
<p>基于 TypeScript 开发，使用了高效的 Bun 运行时和 Elysia 框架，后端集成了 FFmpeg、ImageMagick、LibreOffice 等众多工业级开源转换工具。</p>
<p>它的转换能力非常硬核，甚至支持矢量图处理、LaTeX 编译以及复杂的视频转码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ee17f122f84244bc99ee94c773bdec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=TpWJ3Z%2FYTb%2BMb1QoSRBes5bJ7fs%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>用户可以通过 Docker 轻松部署，且界面简洁现代，支持拖拽上传和批量处理。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/C4illin/ConvertX</span>
</code></pre>
<h2 data-id="heading-5">06、PowerShell 脚本</h2>
<p>Win11Debloat 是一个简单易用且轻量级的 PowerShell 脚本，帮助你净化和优化 Windows 10 及 Windows 11 系统。</p>
<p>GitHub 上已经斩获 36K 的 Star 了。</p>
<p>该脚本提供了一键式的解决方案，帮助用户移除臃肿软件，提升系统的运行速度和隐私安全性。</p>
<p>解决 Windows 预装大量推广应用、遥测追踪和广告的烦恼。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/032985f090c545f0a42844be6974e338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=kxMDTEiS9VmS9J4ggacgl7rsS4M%3D" alt="图片" loading="lazy"/></p>
<p>而且不需要记复杂的命令，只需运行脚本后根据屏幕提示选择相应的选项就行了。</p>
<p>它不仅能卸载预装的各种 App（如 Xbox、天气、新闻等），还能禁用遥测、移除 Bing 搜索集成、隐藏任务栏上的 Copilot 图标，甚至调整文件资源管理器的默认视图。</p>
<p>它有一个默认模式，可以根据大多数人的需求自动执行推荐的优化操作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caa5a46ce6c74a0486f8e3a899cdb0ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987283&amp;x-signature=B9ABo27wSbCLn6CU7402enAu%2BCk%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/Raphire/Win11Debloat</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通用 Token 管理工具（详细注释 + 完整使用示例 + 设计说明）]]></title>    <link>https://juejin.cn/post/7586157459972472884</link>    <guid>https://juejin.cn/post/7586157459972472884</guid>    <pubDate>2025-12-22T05:43:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459972472884" data-draft-id="7585410547337543730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通用 Token 管理工具（详细注释 + 完整使用示例 + 设计说明）"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-12-22T05:43:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杰AJie"/> <meta itemprop="url" content="https://juejin.cn/user/3871838955636704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通用 Token 管理工具（详细注释 + 完整使用示例 + 设计说明）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871838955636704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杰AJie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:43:49.000Z" title="Mon Dec 22 2025 05:43:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面是一份 <strong>“可直接复制进项目用”的通用 Token 管理工具</strong>，<strong>逐行详细注释 + 完整使用示例 + 设计说明</strong>。<br/>
不依赖企业微信，<strong>任何第三方 Token 都能用</strong>。</p>
<p>我会按 <strong>「是什么 → 怎么用 → 为什么这样设计」</strong> 的顺序来讲，保证你以后回头看也能秒懂。</p>
<hr/>
<h2 data-id="heading-0">一、整体使用方式（先给你一个全景）</h2>
<p>你最终在业务代码里只需要这样用：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">String</span> token = tokenManager.<span class="hljs-built_in">getToken</span>(
    <span class="hljs-string">"wx:login"</span>,
    () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">DefaultAccessToken</span>(<span class="hljs-built_in">fetchTokenFromRemote</span>(), <span class="hljs-number">7200</span>)
);
</code></pre>
<p>你只关心两件事：</p>
<ol>
<li><strong>key 是什么</strong></li>
<li><strong>怎么获取新 token</strong></li>
</ol>
<p>其余全部交给 <code>TokenManager</code></p>
<hr/>
<h2 data-id="heading-1">二、核心接口与类（逐个讲）</h2>
<hr/>
<h3 data-id="heading-2">1️⃣ AccessToken 接口（Token 抽象）</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 通用 AccessToken 抽象
 *
 * 代表“一个有生命周期的 token”
 * 不关心 token 从哪里来
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">AccessToken</span> {

    <span class="hljs-comment">/**
     * @return 实际可用于请求的 token 字符串
     */</span>
    <span class="hljs-function">String <span class="hljs-title">getToken</span>()</span>;

    <span class="hljs-comment">/**
     * @return 当前 token 是否已过期
     */</span>
    <span class="hljs-function">boolean <span class="hljs-title">isExpired</span>()</span>;
}
</code></pre>
<h4 data-id="heading-3">设计目的</h4>
<ul>
<li>解耦平台</li>
<li>JWT / OAuth / 内部 token 都可以实现它</li>
</ul>
<hr/>
<h3 data-id="heading-4">2️⃣ DefaultAccessToken（默认实现）</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * 默认 Token 实现
 *
 * 使用“绝对过期时间”判断是否失效
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultAccessToken</span> implements AccessToken {

    <span class="hljs-comment">/** token 字符串 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> token;

    <span class="hljs-comment">/** token 过期时间点（毫秒时间戳） */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> expireAt;

    <span class="hljs-comment">/**
     * @param token              token 字符串
     * @param expiresInSeconds   过期秒数（通常接口返回）
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">DefaultAccessToken</span><span class="hljs-params">(<span class="hljs-type">String</span> token, <span class="hljs-type">long</span> expiresInSeconds)</span> </span>{
        <span class="hljs-keyword">this</span>.token = token;
        <span class="hljs-comment">// 提前 5 分钟过期，避免临界失效</span>
        <span class="hljs-keyword">this</span>.expireAt = System.<span class="hljs-built_in">currentTimeMillis</span>()
                + (expiresInSeconds - <span class="hljs-number">300</span>) * <span class="hljs-number">1000</span>;
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getToken</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> token;
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">isExpired</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> System.<span class="hljs-built_in">currentTimeMillis</span>() &gt;= expireAt;
    }
}
</code></pre>
<h4 data-id="heading-5">为什么要提前 5 分钟过期？</h4>
<ul>
<li>
<p>防止：</p>
<ul>
<li>网络延迟</li>
<li>服务器时间偏差</li>
<li>请求刚发出 token 就失效</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">3️⃣ TokenProvider（获取 Token 的策略）</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * Token 提供器
 *
 * 由业务方实现“如何获取一个新的 token”
 */</span>
@FunctionalInterface
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">TokenProvider</span> {

    <span class="hljs-comment">/**
     * 获取新的 token
     *
     * @return 新的 AccessToken
     */</span>
    <span class="hljs-function">AccessToken <span class="hljs-title">refresh</span>()</span>;
}
</code></pre>
<h4 data-id="heading-7">为什么用接口？</h4>
<ul>
<li>
<p>TokenManager 不依赖任何 SDK / HTTP / 平台</p>
</li>
<li>
<p>你可以：</p>
<ul>
<li>HTTP 调用</li>
<li>SDK 调用</li>
<li>数据库</li>
<li>本地生成</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">4️⃣ TokenManager（核心）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TokenManager</span> {

    <span class="hljs-comment">/** token 缓存池 */</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">AccessToken</span>&gt; tokenCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">/** 每个 key 一把锁，避免并发刷新 */</span>
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; lockMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">/**
     * 获取 token（通用方法）
     *
     * <span class="hljs-doctag">@param</span> key           token 唯一标识（非常重要）
     * <span class="hljs-doctag">@param</span> tokenProvider token 刷新逻辑
     * <span class="hljs-doctag">@return</span> 可用 token 字符串
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getToken</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key, TokenProvider tokenProvider</span>) {
        <span class="hljs-title class_">AccessToken</span> token = tokenCache.<span class="hljs-title function_">get</span>(key);

        <span class="hljs-comment">// token 不存在 或 已过期</span>
        <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span> || token.<span class="hljs-title function_">isExpired</span>()) {

            <span class="hljs-comment">// 每个 key 独立一把锁</span>
            <span class="hljs-title class_">Object</span> lock = lockMap.<span class="hljs-title function_">computeIfAbsent</span>(key, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>());

            synchronized (lock) {
                <span class="hljs-comment">// 双重检查，防止重复刷新</span>
                token = tokenCache.<span class="hljs-title function_">get</span>(key);
                <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span> || token.<span class="hljs-title function_">isExpired</span>()) {
                    token = tokenProvider.<span class="hljs-title function_">refresh</span>();
                    tokenCache.<span class="hljs-title function_">put</span>(key, token);
                }
            }
        }
        <span class="hljs-keyword">return</span> token.<span class="hljs-title function_">getToken</span>();
    }

    <span class="hljs-comment">/**
     * 主动清除 token（例如配置变更）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">invalidate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        tokenCache.<span class="hljs-title function_">remove</span>(key);
        lockMap.<span class="hljs-title function_">remove</span>(key);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-9">三、详细使用示例（你照抄就能用）</h2>
<hr/>
<h3 data-id="heading-10">示例 1️⃣：第三方 OAuth Token（通用）</h3>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">token</span> = tokenManager.getToken(
    "oauth:system",
    () -&gt; {
        OAuthDTO <span class="hljs-attr">dto</span> = oauthClient.getToken()<span class="hljs-comment">;</span>
        return new DefaultAccessToken(dto.getToken(), dto.getExpireIn())<span class="hljs-comment">;</span>
    }
)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">示例 2️⃣：企业微信 / 钉钉 / 飞书（完全通用）</h3>
<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">token</span> = tokenManager.getToken(
    "wx:addressBook",
    () -&gt; {
        WxTokenDTO <span class="hljs-attr">dto</span> = callWxTokenApi()<span class="hljs-comment">;</span>
        return new DefaultAccessToken(dto.getAccess_token(), dto.getExpires_in())<span class="hljs-comment">;</span>
    }
)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">示例 3️⃣：JWT（本地生成）</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">String</span> token = tokenManager.<span class="hljs-built_in">getToken</span>(
    <span class="hljs-string">"jwt:internal"</span>,
    () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">DefaultAccessToken</span>(jwtService.<span class="hljs-built_in">generate</span>(), <span class="hljs-number">3600</span>)
);
</code></pre>
<hr/>
<h3 data-id="heading-13">示例 4️⃣：自研系统登录</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">String</span> token = tokenManager.<span class="hljs-built_in">getToken</span>(
    <span class="hljs-string">"internal:api"</span>,
    () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-built_in">DefaultAccessToken</span>(<span class="hljs-built_in">loginAndGetToken</span>(), <span class="hljs-number">7200</span>)
);
</code></pre>
<hr/>
<h2 data-id="heading-14">四、key 的设计规范（非常重要）</h2>
<h4 data-id="heading-15">推荐格式：</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">平台:用途</span>
</code></pre>
<p>例如：</p>
<ul>
<li><code>wx:login</code></li>
<li><code>wx:user</code></li>
<li><code>ding:token</code></li>
<li><code>aliyun:ram</code></li>
<li><code>internal:api</code></li>
</ul>
<p>❌ 不推荐：</p>
<ul>
<li>使用 corpSecret</li>
<li>使用 URL</li>
<li>使用随机字符串</li>
</ul>
<hr/>
<h2 data-id="heading-16">五、常见问题（你以后一定会遇到）</h2>
<h4 data-id="heading-17">Q1：多个线程同时获取 token 会不会重复请求？</h4>
<p>👉 不会</p>
<ul>
<li>每个 key 独立锁</li>
<li>双重检查</li>
</ul>
<hr/>
<h4 data-id="heading-18">Q2：token 过期了会不会阻塞请求？</h4>
<p>👉 只会阻塞 <strong>第一次刷新</strong></p>
<ul>
<li>其余线程复用新 token</li>
</ul>
<hr/>
<h4 data-id="heading-19">Q3：能不能换成 Redis？</h4>
<p>👉 可以，而且 <strong>不用改使用方式</strong></p>
<p>只需替换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">AccessToken</span>&gt; tokenCache
</code></pre>
<hr/>
<h2 data-id="heading-20">六、推荐的项目结构</h2>
<pre><code class="hljs language-markdown" lang="markdown">infrastructure/
 └── token/
<span class="hljs-code">     ├── AccessToken.java
     ├── DefaultAccessToken.java
     ├── TokenProvider.java
     └── TokenManager.java
</span></code></pre>
<hr/>
<h2 data-id="heading-21">七、设计总结（你可以写进技术文档）</h2>
<blockquote>
<p>TokenManager 负责：</p>
<ul>
<li>缓存</li>
<li>过期判断</li>
<li>并发控制</li>
</ul>
<p>TokenProvider 负责：</p>
<ul>
<li>如何获取 token</li>
</ul>
<p>二者解耦，支持任意平台、任意 Token 类型。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并发编程里的"堵车"与"红绿灯"：死锁、活锁与两种锁策略（乐观锁、悲观锁）]]></title>    <link>https://juejin.cn/post/7585866811717976091</link>    <guid>https://juejin.cn/post/7585866811717976091</guid>    <pubDate>2025-12-22T05:59:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585866811717976091" data-draft-id="7585920796100886555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并发编程里的&quot;堵车&quot;与&quot;红绿灯&quot;：死锁、活锁与两种锁策略（乐观锁、悲观锁）"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-12-22T05:59:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并发编程里的"堵车"与"红绿灯"：死锁、活锁与两种锁策略（乐观锁、悲观锁）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:59:13.000Z" title="Mon Dec 22 2025 05:59:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>搞后端或者数据库开发，永远绕不开"资源争抢"这个问题。</p>
<p>今天把这几个老生常谈的概念——<strong>死锁、活锁、悲观锁、乐观锁</strong>，放在一起捋一捋。前两个是"事故现场"，后两个是"交通规则"。一起学习一下</p>
<hr/>
<h2 data-id="heading-0">一、 事故现场：当线程打起来了</h2>
<h3 data-id="heading-1">1. 死锁 (Deadlock)：互不相让</h3>
<p>这是最常见的"事故"。说白了就是：<strong>也就是你也动不了，我也动不了，大家都耗着。</strong></p>
<p><strong>真实场景</strong>： 你有两个资源：<code>OrderTable</code>（订单表）和 <code>StockTable</code>（库存表）。</p>
<ul>
<li>线程 A：锁住了 <code>OrderTable</code>，准备去扣减 <code>StockTable</code>。</li>
<li>线程 B：锁住了 <code>StockTable</code>，准备去写入 <code>OrderTable</code>。</li>
</ul>
<p>结果就是：A 拿着 B 想要的东西，B 拿着 A 想要的东西，谁都不撒手。</p>
<p><strong>代码模拟（伪代码）</strong> ：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 错误的加锁顺序导致死锁</span>
​
<span class="hljs-comment">// 线程 1</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">transactionA</span>()</span> {
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">lock</span>(<span class="hljs-string">'Order'</span>); <span class="hljs-comment">// 拿到了 Order 锁</span>
  <span class="hljs-keyword">await</span> sleep(<span class="hljs-number">100</span>);    <span class="hljs-comment">// 稍微慢一点，等线程 2 锁住 Stock</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">lock</span>(<span class="hljs-string">'Stock'</span>); <span class="hljs-comment">// 此时卡住，因为 Stock 被线程 2 锁了</span>
}
​
<span class="hljs-comment">// 线程 2</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">transactionB</span>()</span> {
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">lock</span>(<span class="hljs-string">'Stock'</span>); <span class="hljs-comment">// 拿到了 Stock 锁</span>
  <span class="hljs-keyword">await</span> sleep(<span class="hljs-number">100</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">lock</span>(<span class="hljs-string">'Order'</span>); <span class="hljs-comment">// 此时卡住，因为 Order 被线程 1 锁了</span>
}
</code></pre>
<p><strong>怎么解？</strong> 最简单的解法是<strong>定规矩</strong>：所有人必须按照<strong>相同的顺序</strong>拿锁。比如规定"必须先拿 Order 再拿 Stock"，死锁瞬间就解了。</p>
<h3 data-id="heading-2">2. 活锁 (Livelock)：过分礼让</h3>
<p>活锁比较隐蔽，它不会卡死，但就是干不成事。</p>
<p><strong>真实场景</strong>： 两人在走廊迎面相遇。</p>
<ul>
<li>你往左躲，他也往左躲（撞）。</li>
<li>你赶紧往右躲，他也往右躲（又撞）。</li>
<li>你们俩一直在动，CPU 也就是一直在忙（出汗了），但谁也没过去。</li>
</ul>
<p><strong>代码里的表现</strong>： 通常发生在处理消息队列或者重试机制里。 比如一个任务处理失败了，系统立刻重试，又失败，又立刻重试... 资源一直在消耗，日志一直在打，但任务永远处于"处理中"。</p>
<p><strong>怎么解？</strong> 引入<strong>随机性</strong>。以太网的"指数退避算法"就是这个原理：撞了之后，不要立刻重试，你等 10ms，我等 50ms，错峰出行。</p>
<hr/>
<h2 data-id="heading-3">二、 交通规则：怎么防止出事故？</h2>
<p>为了防止上面那种乱套的情况，我们需要锁。根据"心态"的不同，分成了<strong>悲观</strong>和<strong>乐观</strong>两派。</p>
<h3 data-id="heading-4">1. 悲观锁 (Pessimistic Locking)</h3>
<p><strong>心态</strong>："这世界坏人多，总有人想抢我的数据。也就是我操作的时候，谁也别想动！"</p>
<p><strong>做法</strong>： 在查数据的时候，直接把数据锁死，直到我提交事务，别人才能查或改。</p>
<h3 data-id="heading-5">2. 乐观锁 (Optimistic Locking)</h3>
<p><strong>心态</strong>："这世界还是好人多，大部分时候没人跟我抢。我就先跑着，最后检查一下就行。"</p>
<p><strong>做法</strong>： 我不锁数据，大家都随便读、随便改。但是！我在更新的那一瞬间，会检查一下： <strong>"这数据自从我读走之后，有没有被人改过？"</strong></p>
<p><strong>实现方式（CAS / 版本号）</strong> ： 给表加一个 <code>version</code> 字段。</p>
<pre><code class="hljs language-ini" lang="ini">-- 1. 先查出来，假设拿到 <span class="hljs-attr">version</span> = <span class="hljs-number">1</span>
SELECT id, stock, version FROM goods WHERE <span class="hljs-attr">id</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
​
-- 2. 内存里计算 stock - 1
​
-- 3. 更新时，带上版本号做条件
UPDATE goods 
SET <span class="hljs-attr">stock</span> = stock - <span class="hljs-number">1</span>, version = version + <span class="hljs-number">1</span> 
WHERE <span class="hljs-attr">id</span> = <span class="hljs-number">1</span> AND version = <span class="hljs-number">1</span><span class="hljs-comment">; </span>
-- 关键在这里！如果 version 已经被别人改成 2 了，这条 SQL 影响行数就是 0，更新失败。
</code></pre>
<ul>
<li><strong>优点</strong>：快！没有锁等待，大家都能读，并发能力强。</li>
<li><strong>缺点</strong>：如果竞争真的很激烈（比如抢火车票），会一直失败重试，CPU 可能会飙高。</li>
</ul>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌Opal + Gemini 3 Pro 强强合体：手搓“AI漫剧生成器”只需 5 分钟！]]></title>    <link>https://juejin.cn/post/7586301866910416947</link>    <guid>https://juejin.cn/post/7586301866910416947</guid>    <pubDate>2025-12-22T05:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586301866910416947" data-draft-id="7585897699603775514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌Opal + Gemini 3 Pro 强强合体：手搓“AI漫剧生成器”只需 5 分钟！"/> <meta itemprop="keywords" content="Gemini,AIGC,Google"/> <meta itemprop="datePublished" content="2025-12-22T05:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌Opal + Gemini 3 Pro 强强合体：手搓“AI漫剧生成器”只需 5 分钟！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T05:59:45.000Z" title="Mon Dec 22 2025 05:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>哈喽大家好，我是后端小肥肠！<strong>谷歌憋了大半年的大招终于藏不住了！</strong> 今天带大家揭秘这个被低估的神器——<strong>Opal</strong>。别再纠结复杂的 Python 脚本了，看我如何调用 <strong>Gemini 3 Pro</strong>，用<strong>5分钟</strong>、<strong>一句话</strong>，把枯燥的小说文本直接变成可视化的漫剧分镜图片！</p>
<h2 data-id="heading-0">1. 前言</h2>
<p>上周六我基于 Coze 编程发布了文章<a href="https://juejin.cn/post/7585463258690600969" target="_blank" title="https://juejin.cn/post/7585463258690600969">Coze编程首测：我用大白话搭了个“AI漫剧流水线”，太离谱了！</a>，后台反响特别热烈，看来大家对<strong>小说可视化</strong>这个方向真的刚需。<strong>昨天逛 B 站的时候</strong>，偶然刷到一位技术圈大佬分享了谷歌的神器——<strong>Opal</strong>。大佬在视频里演示的效果直接给我看愣了：居然也可以<strong>一句话生成</strong> <strong>工作流</strong>？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a8b0320d0c4e9db24963f657100841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=ZNIBPcJyP%2FwzDbAKwkQ%2Fr4KmtwU%3D" alt="" loading="lazy"/></p>
<p><strong>出于技术人的敏感，我立马去扒了一下它的背景：原来这玩意儿 Google 早在今年 7 月就发布了，只是当时比较低调。 但最近随着 AI 能力的迭代，它又在开发者圈子里火了一把。什么是 Opal？ 简单来说，Opal 是谷歌推出的可视化应用构建平台。它最大的噱头就是 "Prompt to App" ——你不需要拖拽复杂的节点，只需像聊天一样说出需求，它就能自动生成包含后端逻辑和前端界面的完整应用。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/249f817b1b6844a9916c66d912833e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=ecumRDo%2B8plbWsA1yW%2FACgZPuT0%3D" alt="" loading="lazy"/></p>
<p>更厉害的是，Opal 可以调用谷歌家一众神仙模型，包括语言模型 <strong>Gemini 2.5 Flash、Gemini 2.5 Pro、Gemini 3 Pro</strong>，图像生成模型 <strong>Imagen 4、Gemini 2.5 Flash Image (Nano Banana)、Gemini 3 Pro Image (Nano Banana)</strong> ，还有音频模型 <strong>AudioLM</strong>，视频模型 <strong>Veo</strong>，以及音乐模型 <strong>Lyria 2</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6335e3c05d52419eb1457b42f52e7773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=nu50xvZWw7cgWSrJYALV5yYiR3I%3D" alt="" loading="lazy"/></p>
<p><strong>今天，我就用opal，把周六的小说转漫剧分镜图流程重新跑一遍，看看它到底有多强！文章结尾送</strong> <strong>工作流</strong> <strong>还送原件哦~</strong></p>
<h2 data-id="heading-1">2. 工作流构建</h2>
<p>工作流的构建非常简单，全程只需要5分钟。输入网址<a href="https://link.juejin.cn?target=https%3A%2F%2Fopal.google%2F" target="_blank" title="https://opal.google/" ref="nofollow noopener noreferrer">opal.google/</a> ，来到opal界面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff39bba35c3b416ea16457bbb0a3fd21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=E3L0lLzALgmGnEa7qKiAZr4C0Ho%3D" alt="" loading="lazy"/></p>
<p>点击右上角的【+Create New】按钮，跳转至构造工作流界面，在下方对话会输入你的构建需求点击【发送】按钮，等等几分钟就能完成工作流构建。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51ac9d2a3a54bd49497b2e6fc30f657~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=S1g%2F6jw6s4V%2B7rJMCi8gQE%2F2pC8%3D" alt="" loading="lazy"/></p>
<p>我输入的构建需求：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 理解小说内容转换为短剧剧本
<span class="hljs-bullet">2.</span> 提取短剧剧本中的角色信息，生成角色构造信息
<span class="hljs-bullet">3.</span> 基于短剧剧本进行分镜，生成每个分镜的文生图提示词
<span class="hljs-bullet">4.</span> 基于分镜文生图提示词和角色信息调用生图工具进行生图
<span class="hljs-bullet">5.</span> 基于html界面展示图片与分镜信息
</code></pre>
<p>等待几分钟完整工作流就完整呈现在了面板中：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2cb0179bdd841daa9a4d2cf6feba184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=FCWm4pbfDch688qWGJU1KArGguI%3D" alt="" loading="lazy"/></p>
<p>点击【Preview】来到工作流试运行界面，点击【Start】按钮后在底部的对话框输出小说内容，建议按照章节输入。我输入的是之前工作流生产的末日系列小说的第一章：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/315be7fe24544491a2e8f5d278bbb66c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=Q3wL6%2Fn3W9QX%2Fe%2BJ8zLXk%2BChJmU%3D" alt="" loading="lazy"/></p>
<p><strong>工作流</strong> <strong>文章指引：</strong> <a href="https://juejin.cn/post/7582561515816484927" target="_blank" title="https://juejin.cn/post/7582561515816484927">突破 LLM 极限！n8n + MemMachine 打造“无限流”小说生成器</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b633cc710edf4d6585772a545463ba45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=EdTFGc%2FzXaSnF6DDXt%2B6uVVIpgo%3D" alt="" loading="lazy"/></p>
<p>等待几分钟就可以看到分镜图片的结果展示在了右边工具栏中：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96c0a807608a4eacad0ec79d2d798499~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=PZRTtiMwObJgUOH59qq5hVUxA0U%3D" alt="" loading="lazy"/></p>
<p><strong>需要了解我分镜图片细节和查看</strong> <strong>工作流</strong> <strong>原件的朋友可以访问链接：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fopal.google%2F%3Fflow%3Ddrive%3A%2F1w_SSuWfwSz7UG4fPWiwS9x4GDGQIX9nf%26shared%26results%3D1nO3cFHVYWNp7Wxqk5jRMJEAg4s3nwzVu%26mode%3Dapp" target="_blank" title="https://opal.google/?flow=drive:/1w_SSuWfwSz7UG4fPWiwS9x4GDGQIX9nf&amp;shared&amp;results=1nO3cFHVYWNp7Wxqk5jRMJEAg4s3nwzVu&amp;mode=app" ref="nofollow noopener noreferrer">opal.google/?flow=drive…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f04d29fa1d04b4bb1655b9b9aed70ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=pn5ajCNouR6SyXtvMpMdC0ki%2Fmg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3. 结语</h2>
<p>今天的实战就到这里。通过 Google Opal，我们只用了几分钟的时间，仅仅通过自然语言的描述，就构建出了一个包含<strong>剧情理解-角色提取-分镜绘制-网页展示</strong>的完整应用。</p>
<p>看着文字小说在网页上实时变身成一幅幅生动的分镜图，这种<strong>所想即所得</strong>的体验确实令人印象深刻。对于我们创作者而言，这意味着技术门槛正在无限降低——你不需要懂代码，也不需要精通复杂的各种软件，只要你有好的故事和创意，现在的 AI 工具就能帮你把想象变成现实。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ede5875ec7464b7d94b2c0ec4aa5c4b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766987984&amp;x-signature=8rUcouqzG60nz67nYFqA1Ay5vNc%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[那个把代码写得亲妈都不认的同事，最后被劝退了🤷‍♂️]]></title>    <link>https://juejin.cn/post/7585897699603693594</link>    <guid>https://juejin.cn/post/7585897699603693594</guid>    <pubDate>2025-12-22T04:03:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603693594" data-draft-id="7586136543954632742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="那个把代码写得亲妈都不认的同事，最后被劝退了🤷‍♂️"/> <meta itemprop="keywords" content="前端,JavaScript,代码规范"/> <meta itemprop="datePublished" content="2025-12-22T04:03:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            那个把代码写得亲妈都不认的同事，最后被劝退了🤷‍♂️
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:03:34.000Z" title="Mon Dec 22 2025 04:03:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好😁。</p>
<p>上上周，我们在例会上送别了团队里的一位技术大牛，阿K。</p>
<p>说实话，阿K 的技术底子很强。他能手写 Webpack 插件，熟读 ECMA 规范，对 Chrome 的渲染管线了如指掌。</p>
<p>但最终，CTO 还是决定劝退他了。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a7672acbb864ef1ae09c60dd7b20838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981014&amp;x-signature=054la%2BeYJnC0QPIt8VTi%2FOqNCfs%3D" alt="Suggestion.gif" loading="lazy"/></p>
<p>理由很残酷，只有一句话： <strong>你的代码，团队里没人敢接手。🤷‍♂️</strong></p>
<p><strong>为了所谓的极致性能，牺牲代码的可读性，到底值不值？</strong></p>
<hr/>
<h4 data-id="heading-0"><strong>事件的开始</strong></h4>
<p>我们有一个很普通的后台管理系统重构。</p>
<p>阿K 负责最核心的权限校验模块。这本是一个很简单的逻辑：后端返回一个权限列表，前端判断一下用户有没有某个按钮的权限。</p>
<p>普通人（比如我）大概会这么写：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 一眼就能看懂</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">hasPermission</span> = (<span class="hljs-params">userPermissions, requiredPermission</span>) =&gt; {
  <span class="hljs-keyword">return</span> userPermissions.<span class="hljs-title function_">includes</span>(requiredPermission);
};

<span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasPermission</span>(currentUser.<span class="hljs-property">permissions</span>, <span class="hljs-string">'DELETE_USER'</span>)) {
  <span class="hljs-title function_">showDeleteButton</span>();
}
</code></pre>
<p>但是，阿K 看到这段代码时，露出了鄙夷的神情😒。</p>
<p><strong>includes 这种遍历操作太慢了！我们要处理的是十万级的用户并发（并没有），必须优化！</strong></p>
<p>于是，他闭关三天，重写了整个模块。</p>
<p>Code Review 的时候，我们所有人都傻了。屏幕上出现了一堆我们看不懂的天书😖：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 全程位运算，没有任何注释</span>
<span class="hljs-keyword">const</span> P = { <span class="hljs-attr">r</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">w</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">e</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">8</span> }; 
<span class="hljs-keyword">const</span> <span class="hljs-title function_">_c</span> = (<span class="hljs-params">u, p</span>) =&gt; (u &amp; p) === p;

<span class="hljs-comment">// 这里甚至用了一个位移掩码生成的哈希表</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">_m</span> = (<span class="hljs-params">l</span>) =&gt; l.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, c</span>) =&gt;</span> a | (P[c] || <span class="hljs-number">0</span>), <span class="hljs-number">0</span>);

<span class="hljs-comment">// 像不像一段乱码？</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">chk</span> = (<span class="hljs-params">u, r</span>) =&gt; <span class="hljs-title function_">_c</span>(<span class="hljs-title function_">_m</span>(u.<span class="hljs-property">r</span>), P[r]);
</code></pre>
<p>我问他：阿K，这 <code>_c</code> 和 <code>_m</code> 是啥意思？能加个注释吗？</p>
<p>阿K 振振有词： <strong>好的代码不需要注释！位运算是计算机执行最快的操作，比字符串比对快几百倍！这不仅仅是代码，这是对 CPU 的尊重，是艺术！</strong></p>
<p>我： <strong>。 。 。 。🤣</strong></p>
<p>在那个没有性能瓶颈的后台管理系统里，他为了那肉眼不可见的 0.0001 毫秒提升，制造了一个维护麻烦。</p>
<hr/>
<h4 data-id="heading-1"><strong>屎山💩崩溃的那一天</strong></h4>
<p>灾难发生在两个月后。</p>
<p>业务方突然提了一个需求： <strong>权限逻辑要改，现在支持‘反向排除’权限，而且权限字段要从数字改成字符串组。</strong></p>
<p>那天，阿K 正好去年假了，手机关机😒。</p>
<p>任务落到了刚入职的实习生小李头上。</p>
<p>小李打开 <code>permission.js</code>，看着满屏的 <code>&gt;&gt;</code>、<code>&amp;</code>、<code>|</code> 和单字母变量，整个人僵在了工位上。</p>
<p>他试图去理解那个位移掩码的逻辑，但他发现，只要改动一个字符，整个系统的权限就全乱套了——管理员突然看不了页面，实习生突然能删库了🤔。</p>
<p><strong>这代码有毒吧……</strong> 小李在第 10 次尝试修复失败后，差点哭出来😭。</p>
<p>因为这个模块的逻辑过于晦涩，且和其他模块高度耦合（阿K 为了复用，把这些位运算逻辑注入到了全局原型链里），我们根本不敢动。</p>
<p>结果是：<strong>那个简单的需求，被硬生生拖了一周。</strong> 业务方投诉到了 CTO 那里。</p>
<p>CTO 看了眼代码，沉默了三分钟，然后问了一句：</p>
<p>写这玩意儿的人，是觉得以后都不用维护了吗？😥</p>
<hr/>
<h4 data-id="heading-2"><strong>过早优化是万恶之源 !</strong></h4>
<p>阿K 回来后，很不服气。他觉得是我们技术太菜，看不懂他的高级操作。</p>
<p>他拿出了 Chrome Profiler 的截图，指着那微乎其微的差距说：看！我的写法比你们快了 40%！</p>
<p>但他忽略了软件工程中最重要的一条公式：</p>
<blockquote>
<p><strong>代码价值 = (实现功能 + 可维护性) / 复杂度</strong></p>
</blockquote>
<p><strong>过早优化是万恶之源 ! ! !</strong></p>
<p>在 99% 的业务场景下，V8 引擎已经足够快了。</p>
<ul>
<li>你把 <code>forEach</code> 改成 <code>while</code> 倒序循环，性能确实提升了，但代码变得难读了。</li>
<li>你把清晰的 <code>switch-case</code> 改成了晦涩的 <code>lookup table</code> 还没有类型提示，Bug 率上升了。</li>
<li>你为了省几个字节的内存，用各种黑魔法操作对象，导致后来的人根本不敢碰😖。</li>
</ul>
<p><strong>这种所谓的性能优化，其实是程序员的自嗨。</strong></p>
<p>它是用<strong>团队的维护成本</strong>，去换取<strong>机器那一瞬间的快感</strong>。它不是优化，它是给项目埋雷。</p>
<hr/>
<h4 data-id="heading-3"><strong>什么样的代码才是好代码？</strong></h4>
<p>后来，我们将阿K 的那坨代码 通过 chatGPT 全部推倒重写。</p>
<p>1️⃣ 权限定义（语义清晰）</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// permissions.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Permission</span> {
  <span class="hljs-variable constant_">READ</span> = <span class="hljs-string">'read'</span>,
  <span class="hljs-variable constant_">WRITE</span> = <span class="hljs-string">'write'</span>,
  <span class="hljs-variable constant_">EDIT</span> = <span class="hljs-string">'edit'</span>,
  <span class="hljs-variable constant_">DELETE</span> = <span class="hljs-string">'delete'</span>,
}
</code></pre>
<p>2️⃣ 用户模型</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// user.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Permission</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./permissions'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">permissions</span>: <span class="hljs-title class_">Permission</span>[];
}

</code></pre>
<p>3️⃣ 权限校验函数（核心）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// auth.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Permission</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./permissions'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hasPermission</span>(<span class="hljs-params">
  user: User,
  required: Permission
</span>): boolean {
  <span class="hljs-keyword">return</span> user.<span class="hljs-property">permissions</span>.<span class="hljs-title function_">includes</span>(required);
}

</code></pre>
<p>4️⃣ 批量权限校验</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hasAllPermissions</span>(<span class="hljs-params">
  user: User,
  required: Permission[]
</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">return</span> required.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> user.<span class="hljs-property">permissions</span>.<span class="hljs-title function_">includes</span>(p));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hasAnyPermission</span>(<span class="hljs-params">
  user: User,
  required: Permission[]
</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">return</span> required.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> user.<span class="hljs-property">permissions</span>.<span class="hljs-title function_">includes</span>(p));
}

</code></pre>
<p>5️⃣ 判断方法</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (!<span class="hljs-title function_">hasPermission</span>(user, <span class="hljs-title class_">Permission</span>.<span class="hljs-property">DELETE</span>)) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'No permission to delete'</span>);
}
</code></pre>
<p>用回了用户权限结构清晰可见的，权限判断，一眼就懂。甚至都不需要注释🤷‍♂️</p>
<p>虽然跑分慢了那么一丁点（用户根本无感知），但任何一个新来的同事，只要 5 分钟就能看懂并上手修改。</p>
<p>这件事给我留下了深刻的教训：</p>
<ol>
<li>
<p>代码是写给人看的，顺便给机器运行。</p>
<p>如果一段代码只有你现在能看懂，那它就是垃圾代码；如果一段代码连你一个月后都看不懂，那它就是有害代码。</p>
</li>
<li>
<p>不要在非瓶颈处炫技。</p>
<p>如果页面卡顿是因为 DOM 节点太多，你去优化 JS 的变量赋值速度，那就是隔靴搔痒。找到真正的瓶颈（Network, Layout, Paint），再对症下药。</p>
</li>
<li>
<p>可读性 &gt; 巧技。</p>
<p>简单的逻辑，是对同事最大的善意。</p>
</li>
</ol>
<hr/>
<p>阿K 走的时候，还是觉得自己怀才不遇，觉得这家公司配不上他的技术🤣。</p>
<p>我祝他未来前程似锦。</p>
<p>但我更希望看到这篇文章的你，下次在想要按下键盘写一段绝妙的、只有你看懂的单行代码时，能停下来想一想：</p>
<p><strong>如果明天我离职了，接手的人会不会骂娘？</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/946390729f864eefab5bc9c87661f25a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981014&amp;x-signature=ZW21Xm6N1gqLt9uV5DQARa2U1XQ%3D" alt="你是脑残么.gif" loading="lazy"/></p>
<p><strong>毕竟，我们不想让亲妈都不认识代码，我们更不想让同事在那骂娘。</strong></p>
<p>谢谢大家👏</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[canvas.rotate(rotation); 到底是往哪个方向转动]]></title>    <link>https://juejin.cn/post/7586509410567733289</link>    <guid>https://juejin.cn/post/7586509410567733289</guid>    <pubDate>2025-12-22T04:09:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567733289" data-draft-id="7586136543954780198" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" canvas.rotate(rotation); 到底是往哪个方向转动"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T04:09:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             canvas.rotate(rotation); 到底是往哪个方向转动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:09:03.000Z" title="Mon Dec 22 2025 04:09:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e1d157c31b243bca94a14ccdfb24ab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=WES6egmMg0OPkJR7b519kOgFgCQ%3D" alt="image.png" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/748f551b923f4cbea15db69632e5fc7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=mipmL62Xy%2BAOlz%2FwEqyL0mnqnoQ%3D" alt="image.png" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2109f15d2b44b65835f654bc8509dc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=TFCV4NKDU9CCJw91ihwMfzvy1Bs%3D" alt="image.png" width="30%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00456e3c3c054db18633506fe29b2ba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=ynsvmkj7GID6i542CRSgfz3CCGw%3D" alt="image.png" width="30%" loading="lazy"/>
<p>上面的四张图 就是x y轴在不同方向的时候 旋转方向的示意图。我们可以发现都是x轴向y轴方向旋转。</p>
<p>这个有什么用？主要就是为了纠正有时候 我们认为旋转总应该是顺时针的错觉。比如第一张图是正常的画布的坐标系,我们正常旋转画布也是按这个方向旋转，但是如果我们执行了 scale(1,-1),画布就会变成第三张图，再旋转 pi/4，就是反方向旋转了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f47c39a65e647369340c126e22c0ee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766981343&amp;x-signature=FiIZoFfkG6MF7kQ4Z2%2FtXWadJtw%3D" alt="image.png" loading="lazy"/></p>
<p>这是一个旋转了指定角度的矩形，我现在想绘制一个跟这个矩形在水平方向对称的图形，应该怎么画?。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis实战精要：5种高频使用场景与性能优化全解析｜得物技术]]></title>    <link>https://juejin.cn/post/7586237019987902464</link>    <guid>https://juejin.cn/post/7586237019987902464</guid>    <pubDate>2025-12-22T04:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586237019987902464" data-draft-id="7586208617603694626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis实战精要：5种高频使用场景与性能优化全解析｜得物技术"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-22T04:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis实战精要：5种高频使用场景与性能优化全解析｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:20:09.000Z" title="Mon Dec 22 2025 04:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis实战精要：5种高频使用场景与性能优化全解析｜得物技术</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Redis作为一款高性能的内存数据库，已成为现代分布式系统中的核心组件。其丰富的数据结构、超高的吞吐量以及灵活的扩展能力，使其在缓存、会话管理、排行榜等场景中表现出色。然而，在实际应用中，许多开发者仅停留在基础使用层面，未能充分发挥Redis的潜力。本文将深入剖析Redis的5种高频使用场景，并结合得物技术的实战经验，从架构设计到性能优化进行全面解析。</p>
<hr/>
<h2 data-id="heading-2">一、Redis核心优势回顾</h2>
<p>在深入具体场景之前，我们先简要回顾Redis的核心特性：</p>
<ol>
<li><strong>亚毫秒级响应</strong>：内存存储+单线程模型带来极致性能</li>
<li><strong>丰富的数据结构</strong>：String/Hash/List/Set/ZSet等多样化选择</li>
<li><strong>持久化机制</strong>：RDB快照与AOF日志双重保障</li>
<li><strong>高可用架构</strong>：Sentinel和Cluster方案成熟</li>
<li><strong>原子操作</strong>：Lua脚本支持复杂事务</li>
</ol>
<p>这些特性使Redis能在特定场景下替代传统关系型数据库的部分功能。</p>
<hr/>
<h2 data-id="heading-3">二、五大高频使用场景深度解析</h2>
<h3 data-id="heading-4">场景1：缓存加速——电商商品详情页实践</h3>
<h4 data-id="heading-5">典型架构</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 客户端请求 → Nginx → 
<span class="hljs-bullet">2.</span> 查询Redis → 
<span class="hljs-bullet">3.</span> 未命中时回源数据库 →
<span class="hljs-bullet">4.</span> 异步更新缓存（Cache-Aside模式）
</code></pre>
<h4 data-id="heading-6">得物技术实践：</h4>
<ul>
<li><strong>多级Key设计</strong>：<code>product:{id}:base_info</code> + <code>product:{id}:ext_info</code></li>
<li><strong>热点探测</strong>：通过<code>redis-cli --hotkeys</code>识别并特殊处理热Key</li>
<li><strong>一致性保障</strong>：
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua脚本保证原子性删除</span>
<span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">"get"</span>,KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">"del"</span>,KEYS[<span class="hljs-number">1</span>])
<span class="hljs-keyword">end</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-7">性能优化点：</h4>
<ul>
<li>Value大小控制在10KB以内（避免网络传输瓶颈）</li>
<li>Pipeline批量读取降低RTT影响</li>
<li>TTL采用随机过期防止缓存雪崩</li>
</ul>
<h3 data-id="heading-8">场景2：分布式锁——秒杀系统实现方案</h3>
<h4 data-id="heading-9">Redlock算法要点：</h4>
<ol>
<li>获取当前毫秒时间戳T1</li>
<li>顺序向N个节点请求加锁（SET key random_value NX PX）</li>
<li>当获得(N/2)+1个成功响应时计算耗时T2-T1</li>
<li>T2-T1 &lt; 锁有效期时才视为成功</li>
</ol>
<h4 data-id="heading-10">Java实现示例：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(JedisPool[] pools, String lockName, <span class="hljs-type">long</span> expireTime)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">identifier</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
    <span class="hljs-type">int</span> <span class="hljs-variable">lockedCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">for</span> (JedisPool pool : pools) {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> pool.getResource()) {
            <span class="hljs-keyword">if</span> (<span class="hljs-string">"OK"</span>.equals(jedis.set(lockName, identifier, <span class="hljs-string">"NX"</span>, <span class="hljs-string">"PX"</span>, expireTime))) {
                lockedCount++;
            }
        }
    }
    <span class="hljs-keyword">return</span> lockedCount &gt;= pools.length/<span class="hljs-number">2</span> + <span class="hljs-number">1</span>;
}
</code></pre>
<h4 data-id="heading-11">CAP权衡建议：</h4>
<ul>
<li>CP系统首选Redlock（如库存扣减）</li>
<li>AP系统可考虑乐观锁（如点赞计数）</li>
</ul>
<h3 data-id="heading-12">场景3：实时排行榜——运动社区榜单设计</h3>
<h4 data-id="heading-13">ZSet最佳实践：</h4>
<pre><code class="hljs language-bash" lang="bash">ZADD leaderboard timestamp_score user_id   <span class="hljs-comment"># timestamp保证同分有序性</span>
ZREVRANGE leaderboard 0 topN WITHSCORES     <span class="hljs-comment"># TOPN查询</span>
ZSCORE leaderboard user_id                  <span class="hljs-comment">#个人排名查询  </span>
</code></pre>
<h4 data-id="heading-14">GC压力优化：</h4>
<p>对于海量用户（如&gt;1000万）：</p>
<ol>
<li>Sharding策略：按uid哈希分片存储</li>
<li>Cold-Hot分离：活跃用户单独ZSet存储</li>
</ol>
<h3 data-id="heading-15">场景4：消息队列——物流状态变更通知</h3>
<h4 data-id="heading-16">Stream方案对比传统MQ：</h4>






























<table><thead><tr><th>特性</th><th>Redis Stream</th><th>Kafka</th></tr></thead><tbody><tr><td>延迟</td><td>&lt;10ms</td><td>~50ms</td></tr><tr><td>持久化</td><td>AOF+RDB</td><td>Segment文件</td></tr><tr><td>消费组</td><td>≥6.x支持</td><td>原生支持</td></tr><tr><td>回溯消费</td><td>XREAD支持</td><td>原生支持</td></tr></tbody></table>
<h4 data-id="heading-17">ACK机制实现：</h4>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua脚本处理消费确认和重试队列  </span>
<span class="hljs-keyword">local</span> msg = redis.call(<span class="hljs-string">"XREADGROUP"</span>, <span class="hljs-string">"GROUP"</span>, ARGV[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>], <span class="hljs-string">"COUNT"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"STREAMS"</span>, KEYS[<span class="hljs-number">1</span>], <span class="hljs-string">"&gt;"</span>)
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-keyword">end</span>
    
redis.call(<span class="hljs-string">"XACK"</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>], msg[<span class="hljs-number">0</span>])
<span class="hljs-keyword">return</span> msg 
</code></pre>
<h3 data-id="heading-18">场景5：社交关系图谱——关注粉丝列表存储</h3>
<h4 data-id="heading-19">Hybrid存储方案：</h4>
<pre><code class="hljs language-markdown" lang="markdown">String:  存储用户基础信息（JSON格式）
Set:     存双向关系(userA<span class="hljs-emphasis">_followers/userA_</span>following)
Hash:    存关系元数据(关注时间等)
</code></pre>
<h4 data-id="heading-20">Gears模块应用：</h4>
<p>利用RedisGears实现异步处理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python函数注册为后台任务  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_new_follower</span>(<span class="hljs-params">record</span>):
    execute(<span class="hljs-string">'HINCRBY'</span>, <span class="hljs-string">'user:%s'</span>%record[<span class="hljs-string">'key'</span>], <span class="hljs-string">'follower_count'</span>, <span class="hljs-number">1</span>)

gb.register(<span class="hljs-string">'*'</span>, event_types=[<span class="hljs-string">'hset'</span>], callback=process_new_follower)
</code></pre>
<hr/>
<p>##三、高级性能优化策略</p>
<p>###内存管理三板斧：</p>
<p>1.<strong>jemalloc调参</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">修改redis.conf:</span>
<span class="hljs-section">jemalloc_bg_thread: yes  </span>
<span class="hljs-section">arena_max:16 # CPU核心数×4 </span>
</code></pre>
<p>2.<strong>主动碎片整理</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">#运行时配置动态调整  
config set activedefrag yes  
config set active-defrag-threshold-lower <span class="hljs-number">20</span> 
</code></pre>
<p>3.<strong>Value压缩</strong>
对于超过8KB的Value启用LZF压缩:</p>
<pre><code class="hljs language-arduino" lang="arduino">config set hash-max-ziplist-value <span class="hljs-number">8000</span> 
</code></pre>
<p>###网络优化Checklist：</p>
<p>✓ Linux内核参数调优:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">net.core.somaxconn</span> = <span class="hljs-number">2048</span>  
<span class="hljs-attr">vm.swappiness</span>=<span class="hljs-number">10</span>  
</code></pre>
<p>✓ TCP快速打开:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> 3 &gt; /proc/sys/net/ipv4/tcp_fastopen 
</code></pre>
<p>✓ Client连接池配置:
最大连接数=QPS×平均RT(ms)/1000 × 冗余系数(建议≥3)</p>
<hr/>
<p>##四、故障排查工具箱</p>
<p>###慢查询分析三步法:</p>
<p>Step①开启监控:</p>
<pre><code class="hljs language-lua" lang="lua">slowlog-<span class="hljs-built_in">log</span>-slower-than <span class="hljs-number">5000</span> #微秒单位  
slowlog-<span class="hljs-built_in">max</span>-<span class="hljs-built_in">len</span> <span class="hljs-number">1024</span>  
</code></pre>
<p>Step②关键指标关联分析:</p>
<pre><code class="hljs language-bash" lang="bash">redis-cli --latency-history -i5   <span class="hljs-comment">#每5秒采样一次P99延迟   </span>
info commandstats                 <span class="hljs-comment">#命令调用统计TOP20   </span>
</code></pre>
<p>Step③热点Key定位:</p>
<pre><code class="hljs language-perl" lang="perl">redis-cli --bigkeys --memkeys     <span class="hljs-comment">#内存占用TOP分析    </span>
monitor | <span class="hljs-keyword">grep</span> -E <span class="hljs-string">'GETSET|HSET'</span>   <span class="hljs-comment">#实时流量观测   </span>
</code></pre>
<hr/>
<p>##五、总结展望</p>
<p>随着Redis7推出Function数据结构和多线程IO等新特性，其在实时计算领域的潜力将进一步释放。建议开发者重点关注以下方向：</p>
<p>• RedisGraph在图数据查询中的表现提升<br/>
• Serverless模式下自动扩缩容方案<br/>
• WASM运行时对Lua脚本的替代可能性</p>
<p>通过本文的场景分析和优化建议，希望能帮助开发者在实际业务中构建更高性能的Redis体系架构。记住："没有银弹"，所有技术选型都应基于真实业务诉求和数据特征做出权衡决策。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 证书如何创建，从能生成到能长期使用]]></title>    <link>https://juejin.cn/post/7586182451598065710</link>    <guid>https://juejin.cn/post/7586182451598065710</guid>    <pubDate>2025-12-22T04:20:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586182451598065710" data-draft-id="7586182451598049326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 证书如何创建，从能生成到能长期使用"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T04:20:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 证书如何创建，从能生成到能长期使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:20:05.000Z" title="Mon Dec 22 2025 04:20:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 开发中，证书几乎是所有流程的起点。
但在实际项目里，证书往往不是“不会创建”，而是 <strong>创建方式并不适合当前的工程状态</strong>。</p>
<p>我见过不少项目，证书生成时一切顺利，却在后续阶段反复出问题：
构建机无法使用、成员之间无法复用、证书到期没人注意，甚至在上架当天才发现私钥只存在于某一台 Mac 上。</p>
<p>这些问题并不是技术难度造成的，而是 <strong>证书创建方式与工程协作方式不匹配</strong>。</p>
<hr/>
<h2 data-id="heading-0"><strong>证书的本质，并不是一个步骤，而是一个工程资源</strong></h2>
<p>在官方文档里，证书通常被描述为一次性的配置。但在真实项目中，证书更像一种长期存在的工程资源：</p>
<ul>
<li>会被构建系统反复使用</li>
<li>会被多个应用共享</li>
<li>会跨设备、跨人员流转</li>
<li>会在一年后过期</li>
</ul>
<p>如果证书在创建之初就被绑定在某一台 Mac 或某一个人身上，后续问题几乎是必然的。</p>
<hr/>
<h2 data-id="heading-1"><strong>常见的几种证书创建方式，各自都有边界</strong></h2>
<p>在项目中，我接触过几种常见的证书创建路径：</p>
<ul>
<li><strong>Xcode 自动管理</strong>
适合单人开发或原型阶段，但证书和私钥高度依赖钥匙串，迁移成本高。</li>
<li><strong>Apple Developer 后台 + Keychain</strong>
可控性更强，但操作步骤繁琐，对新成员不友好。</li>
<li><strong>Fastlane match</strong>
适合成熟 CI 团队，但对流程理解要求较高，一旦出问题排查成本不低。</li>
</ul>
<p>这些方式本身没有问题，问题在于：
当项目成员不全使用 macOS，或者构建、发布节点开始拆分时，证书就需要一种 <strong>更中性的管理方式</strong>。</p>
<hr/>
<h2 data-id="heading-2"><strong>为什么在一些项目中会引入 Appuploader 创建证书</strong></h2>
<p>在部分跨平台或 CI 驱动的项目中，我们开始使用 <strong>开心上架（Appuploader）</strong> 来创建和管理 iOS 证书，并不是为了替代官方流程，而是为了满足几个现实需求：</p>
<ul>
<li>不依赖 Mac 或钥匙串</li>
<li>证书文件可以直接落地保存</li>
<li>同一证书可在多台机器上使用</li>
<li>证书状态更容易被确认和复查</li>
</ul>
<p>尤其在 Windows / Linux 成员参与发布的项目中，这种方式可以显著降低沟通和迁移成本。</p>
<hr/>
<h2 data-id="heading-3"><strong>开发证书与发布证书，在工程里的角色差异</strong></h2>
<p>在实际工程中，区分证书类型非常重要，但很多问题并不是“选错类型”，而是 <strong>使用场景混淆</strong>。</p>
<ul>
<li><strong>开发证书（iOS App Development / Apple Development）</strong>
更适合本地调试、测试设备安装，生命周期短，变动频繁。</li>
<li><strong>发布证书（iOS Distribution）</strong>
直接关系到 App Store 上传，应尽量保持稳定、可复用。</li>
</ul>
<p>在一些项目里，发布证书会被严格限制创建次数，甚至只保留一到两份。这种策略本身没问题，但前提是：
证书的创建、保存和同步方式足够清晰。</p>
<hr/>
<h2 data-id="heading-4"><strong>证书创建完成之后，真正重要的是能否被正确使用</strong></h2>
<p>证书生成并不等于流程结束。
在真实项目中，证书至少还会经历这些阶段：</p>
<ul>
<li>被描述文件引用</li>
<li>被构建工具使用</li>
<li>被 CI 节点加载</li>
<li>被上传流程验证</li>
</ul>
<p>如果证书文件本身不可复用、密码不清楚、来源不明确，后续每一步都会增加风险。</p>
<p>这也是为什么在一些项目中，会选择使用 <strong>Appuploader 的证书同步能力</strong>，让证书不再依赖某一台电脑的本地状态。</p>
<hr/>
<h2 data-id="heading-5"><strong>关于免费账号与证书有效期的现实限制</strong></h2>
<p>需要特别说明的是：
使用 Apple 免费开发者账号生成的证书，本身就存在明确限制，例如：</p>
<ul>
<li>有效期较短（7 天）</li>
<li>无法用于 App Store 上架</li>
</ul>
<p>这并不是工具限制，而是苹果账号体系的规则。
在实际项目中，如果目标是发布应用，这一点必须在证书创建阶段就考虑清楚。</p>
<hr/>
<h2 data-id="heading-6"><strong>证书管理并不是“创建一次就结束”</strong></h2>
<p>在经历过多次证书问题之后，我逐渐形成一个共识：
证书创建只是开始，管理方式才决定它是否会成为隐患。</p>
<p>一些实践经验包括：</p>
<ul>
<li>证书名称具有可读性</li>
<li>密码统一规则并妥善保存</li>
<li>避免重复创建同类型证书</li>
<li>明确证书与项目的使用关系</li>
</ul>
<p>这些并不依赖某一个工具，但工具是否支持这些行为，会直接影响执行成本。</p>
<hr/>
<p>下面这部分，是 <strong>使用 开心上架（Appuploader）制作 Apple 证书的完整实操流程</strong>。
它是对应前面讨论的一个具体实现方式，适合：</p>
<ul>
<li>不想依赖 Mac</li>
<li>需要证书跨设备使用</li>
<li>希望快速生成可用证书</li>
</ul>
<hr/>
<h2 data-id="heading-7">如何使用 AppUploader 制作 Apple 证书</h2>
<p>本文将介绍如何使用 AppUploader 工具制作 iOS 开发与发布所需的证书，帮助初学者快速掌握证书的生成流程，并在实际工程中正确使用证书。</p>
<hr/>
<p>在 iOS 开发中，证书是应用打包、调试和上架的必备条件。
苹果要求开发者为应用创建相应的证书，但对于初学者来说，相关步骤往往较为复杂，且容易与钥匙串、Xcode 流程混在一起。
下面将通过 AppUploader，逐步完成证书的创建过程。</p>
<hr/>
<h2 data-id="heading-8"><strong>第一步：进入证书管理界面</strong></h2>
<ol>
<li>打开 <strong>AppUploader</strong> 工具</li>
<li>在主页面点击 <strong>证书管理</strong></li>
<li>进入证书管理界面
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c920562e056748f89b7ef6db5d295387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982005&amp;x-signature=zc%2BvEoRvJX1lQr6C8IwZN43udLw%3D" alt="进入" loading="lazy"/></li>
</ol>
<hr/>
<h2 data-id="heading-9"><strong>第二步：新建证书</strong></h2>
<ol>
<li>在证书管理界面点击 <strong>添加</strong></li>
<li>新建证书</li>
</ol>
<p>在弹出的对话框中选择证书类型：</p>
<ul>
<li><strong>开发证书（iOS App Development）</strong>
用于安装和调试测试 App</li>
<li><strong>发布证书（iOS Distribution）</strong>
用于上传到 App Store（需 Apple 开发者年费账号）
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a05390dfc38341d78c394d82c9a4eed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766982005&amp;x-signature=FqtlyKCkO%2FKS3CjkDEgbjf2AQVs%3D" alt="新建" loading="lazy"/></li>
</ul>
<hr/>
<h2 data-id="heading-10"><strong>第三步：设置证书信息</strong></h2>
<p>在证书生成界面填写以下内容：</p>
<ul>
<li><strong>类型</strong>
<ul>
<li><code>development</code> → 开发证书</li>
<li><code>distribution</code> → 发布证书</li>
</ul>
</li>
<li><strong>名称</strong>
用于区分证书，建议使用字母与数字组合，便于后续管理和识别</li>
<li><strong>密码</strong>
这是生成的 <code>.p12</code> 文件密码（不是 Apple 账号密码）
<ul>
<li>建议使用字母数字组合</li>
<li>密码遗忘后无法修改，只能重新生成证书</li>
</ul>
</li>
</ul>
<blockquote>
<p>注意：
免费账号生成的证书有效期仅 7 天，且无法上传至 App Store。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11"><strong>第四步：使用 AppUploader 服务同步证书</strong></h2>
<p>如果勾选 <strong>使用 AppUploader 服务同步证书</strong>：</p>
<ul>
<li>可在不同电脑上下载并使用该证书</li>
<li>无需依赖 Mac 或 Xcode</li>
<li>方便在 Windows、Linux 环境中上传 IPA 至 App Store</li>
</ul>
<hr/>
<h2 data-id="heading-12"><strong>证书完成</strong></h2>
<ul>
<li>生成的证书文件为 <code>.p12</code> 格式</li>
<li>可直接使用，无需额外转换</li>
<li>证书生成成功后即可用于后续流程</li>
</ul>
<hr/>
<h2 data-id="heading-13"><strong>补充说明</strong></h2>
<ul>
<li>一个证书可以对应多个 App，并非一一绑定</li>
<li>建议统一管理证书，避免重复创建</li>
<li>清晰的证书策略，往往比“会不会生成”更重要</li>
</ul>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.appuploader.net%2Ftutorial%2Fzh%2F4%2F4.html" target="_blank" title="https://www.appuploader.net/tutorial/zh/4/4.html" ref="nofollow noopener noreferrer">www.appuploader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当硅基神明撞上人类的“叹息之墙”：距离证明哥德巴赫猜想，AI还有多远？]]></title>    <link>https://juejin.cn/post/7586136543954878502</link>    <guid>https://juejin.cn/post/7586136543954878502</guid>    <pubDate>2025-12-22T04:39:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543954878502" data-draft-id="7585866811717697563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 当硅基神明撞上人类的“叹息之墙”：距离证明哥德巴赫猜想，AI还有多远？"/> <meta itemprop="keywords" content="算法,架构,前端"/> <meta itemprop="datePublished" content="2025-12-22T04:39:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HiStewie"/> <meta itemprop="url" content="https://juejin.cn/user/1591748568038823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             当硅基神明撞上人类的“叹息之墙”：距离证明哥德巴赫猜想，AI还有多远？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748568038823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HiStewie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:39:25.000Z" title="Mon Dec 22 2025 04:39:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>吃个瓜，近期热点事件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F1981623306370180619%2Fanswer%2F1982117455234089374" target="_blank" title="https://www.zhihu.com/question/1981623306370180619/answer/1982117455234089374" ref="nofollow noopener noreferrer">26岁文科博导引争议</a>，22岁数学教授实至名归。</p>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fbilibili.com%2Fvideo%2FBV1PPqjBLEst%2F%3Fspm_id_from%3D333.1007.top_right_bar_window_custom_collection.content.click%26vd_source%3D0bcafb665fe6140f5a86a181137e5c7d" target="_blank" title="http://bilibili.com/video/BV1PPqjBLEst/?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click&amp;vd_source=0bcafb665fe6140f5a86a181137e5c7d" ref="nofollow noopener noreferrer">bilibili.com/video/BV1PP…</a></p>
</blockquote>
<p>最近高强度使用 AI 协助工作，让我不禁有些恍惚：眼下的 Gemini 3 Pro 通识水平已然媲美博士，那距离传说中的<code>超人类智能</code>究竟还有多远？ 带着这份好奇，我重读了那段波澜壮阔的数学史，试着将人类的智力征途与当下顶尖 AI 的能力版图做了一次对照。</p>
<p>这篇科普小文算是一次粗浅的探索，若有疏漏，期待大家指正。</p>
<h2 data-id="heading-0">1. 两个世界的碰撞：当碳基天才遇上硅基神明</h2>
<p>时间倒回 <strong>2010 年</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e9f738c908d4771bc326151c7ab04c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=KcPfUzk0bMuh0Ly5gBtm6Bgx5HI%3D" alt="截屏2025-12-22 12.33.16.png" loading="lazy"/></p>
<p>中南大学的大三学生刘路，在寝室里百无聊赖地翻着书。窗外是喧嚣的校园，但他脑海里却是一片死寂的深海。 他面对的是 <strong>“西塔潘猜想”</strong> ——这是一个关于<strong>反推数学</strong>的逻辑陷阱。简单来说，国际数学界苦战了十几年，试图找到一种特定的逻辑路径来证明它成立。无数专家都在这迷宫里撞了南墙。</p>
<p>突然，灵感像一道闪电划破了寂静。刘路意识到：<strong>既然找不到路，也许是因为路根本就不存在？</strong></p>
<p>他连夜写出了一篇论文，不再试图去证明它是对的，而是反其道而行之。他利用<strong>组合数学中的染色法</strong>，构造了一个极其特殊的数学模型——<strong>这个模型虽然完美符合了“拉姆齐定理”的规则，却唯独推导不出那个预期的“引理”</strong> 。</p>
<p>这就像是所有人都试图证明“A 必然导致 B”，而刘路直接造出了一个“有 A 却没有 B”的数学世界。他用这个无懈可击的反例，像手术刀一样切断了两个公理之间被人们误以为存在的逻辑链条，彻底终结了这个猜想。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e86357f67de04928b893994a8fe31da0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=B0myHvpvdTIsIvV6JBZ%2FtdO49wA%3D" alt="截屏2025-12-22 12.31.33.png" loading="lazy"/></p>
<p><strong>结果我们都知道了</strong>：22 岁，破格晋升正教授，百万奖金，一夜封神。 刘路靠的不是超级计算机，不是海量数据，仅仅是一颗 1.4 公斤重的人脑，和那一瞬间极其优美、不可复制的“逻辑闭环”。</p>
<p>时间来到 <strong>2025 年 12 月</strong>的今天。</p>
<p>我们手里的工具已经进化到了“博士”的级别：</p>
<ul>
<li><strong>GPT-5.2</strong> 能在几秒钟内写出以假乱真的诺贝尔文学奖风格小说；</li>
<li><strong>Claude 4.5 Opus</strong> 能独自重构数百万行的企业级代码库；</li>
<li><strong>Gemini 3 Pro</strong> 结合 AlphaProof 2.0，甚至刚刚拿下了国际奥数（IMO）的满分金牌。</li>
</ul>
<p><strong>这里就出现了一个巨大的认知冲突：</strong></p>
<p>按理说，AI 的智商和知识储备已经碾压了人类。</p>
<p>但如果我告诉你，面对数学皇冠上的明珠——<strong>哥德巴赫猜想</strong>，这三位“硅基大神”目前的表现，可能还不如当年的那个本科生刘路。</p>
<p>为什么？是 AI 在装傻，还是在数学那深不见底的深渊里，藏着某种连硅基生命都无法逾越的 <strong>“叹息之墙”</strong> ？</p>
<hr/>
<h2 data-id="heading-1">2. 凡人的弑神之路：从欧拉到陈景润的 200 年血泪</h2>
<p>为了理解 AI 为什么“吃瘪”，我们必须先回头看看，人类为了攻克这座堡垒，付出了怎样惨烈的代价。这绝不是简单的算术题，而是一场跨越三个世纪的智力接力。</p>
<p><strong>真正的定义（1742年提出）：</strong></p>
<p><strong>“任一大于 2 的偶数，都可以写成两个质数之和。”</strong></p>
<ul>
<li><strong>举个栗子</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>=</mo><mn>2</mn><mo>+</mo></mrow><annotation encoding="application/x-tex">4 = 2 + </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mord">+</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mo>=</mo><mn>3</mn><mo>+</mo></mrow><annotation encoding="application/x-tex">10 = 3 + </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mord">+</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo>=</mo><mn>3</mn><mo>+</mo><mn>9</mn></mrow><annotation encoding="application/x-tex">100 = 3 + 9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">9</span></span></span></span></span></li>
<li>...</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mo separator="true">,</mo><mn>000</mn><mo separator="true">,</mo><mn>000</mn><mo>=</mo><mn>53</mn><mo>+</mo><mn>99</mn><mo separator="true">,</mo><mn>999</mn><mo separator="true">,</mo><mn>94</mn></mrow><annotation encoding="application/x-tex">100,000,000 = 53 + 99,999,94</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">100</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">000</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">000</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">53</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">99</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">999</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">94</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>看起来人畜无害，对吧？只要你有一个计算器，似乎就能无限验证下去。</p>
<p><strong>但这就是陷阱。</strong></p>
<p>数学家面对的是 <strong>“无穷”</strong> 。偶数是无穷无尽的，而质数在数轴上的分布却是无序且混沌的。</p>
<p>这就好比让你在无限延伸的沙滩上，保证<strong>每一粒沙子</strong>（偶数）都能被完美拆解成<strong>两颗特定的珍珠</strong>（质数）。</p>
<p>只要宇宙尽头存在<strong>一个</strong>反例，整个猜想就会崩塌。</p>
<h3 data-id="heading-2">第一棒：巨人的叹息（1742-1900）</h3>
<p>一切始于哥德巴赫给欧拉的一封信。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a6fd286ba0542d3b9a3fa248365d18c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=HSJLEViP9a7sw26%2B5xtbjz4SRqc%3D" alt="截屏2025-12-22 12.35.56.png" loading="lazy"/></p>
<p>当时的数学之神<strong>欧拉</strong>，穷尽毕生精力后无奈回复：“虽然我无法证明，但我确信它是真的。”</p>
<p>连欧拉都缴械投降，这道题沉睡了 160 年。这期间，人类绝望地意识到：面对无穷尽的偶数，靠“算”是没用的，必须找到通用的逻辑武器。</p>
<h3 data-id="heading-3">第二棒：重武器登场（1920s - 圆法与筛法）</h3>
<p>20 世纪初，数学家们终于造出了两把神兵：</p>
<ul>
<li><strong>圆法 (Circle Method)</strong> ：哈代和李特尔伍德引入了复变函数，把数论问题转化成了积分问题。这就像是用大炮轰蚊子，威力巨大但精度不够，只能解决“三个质数之和”。</li>
<li><strong>筛法 (Sieve Method)</strong> ：这是后来的主战场。挪威数学家布朗把它进化成了精密的手术刀。简单说，就是把不符合条件的数像过筛子一样滤掉。</li>
</ul>
<h3 data-id="heading-4">第三棒：悲壮的包围战（1920-1962）</h3>
<p>既然直接证明“1+1”（一个质数+一个质数）太难，人类决定采用 <strong>“迂回包围战术”</strong> ：</p>
<p>先证明“大偶数 = 一个质数 + 一个<strong>由不超过 N 个质数乘积组成的合数</strong>”。</p>
<ul>
<li>1920年，布朗证明了“9+9”。</li>
<li>1948年，雷尼证明了“1+c”。</li>
<li>1962年，中国的潘承洞证明了“1+5”。</li>
</ul>
<p><strong>包围圈越来越小，人类离真理越来越近，空气也越来越稀薄。</strong></p>
<h3 data-id="heading-5">最后一棒：陈景润的孤勇（1966）</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/886ca48ae0814da9977e62fbe2225945~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=Ix4ANJ3Eb4GB1EfHEogMTSmDvgM%3D" alt="截屏2025-12-22 12.35.00.png" loading="lazy"/></p>
<p><strong>这是中国数学史上最耀眼的时刻，也是最令人心碎的时刻。</strong></p>
<p>在只有 6 平方米的斗室里，借着煤油灯微弱的光，陈景润把“筛法”运用到了极致。他消耗了几麻袋的草稿纸，甚至消耗了自己的生命，成功证明了：</p>
<p><strong>“任何充分大的偶数，都可以表示为一个质数和一个‘由不超过两个质数乘积’的数之和。”</strong></p>
<p>这就是著名的 <strong>“1+2”</strong> 。</p>
<p>我们终于站在了海拔 8800 米的地方，距离 8848 米的顶峰（1+1），只差最后一步。</p>
<p><strong>但这最后一步，我们卡了整整 60 年，人类卡了整整60年。</strong></p>
<p>因为数学界悲哀地发现，传统的筛法已经用尽了潜力，我们撞上了一堵叫 <strong>“奇偶性障碍（Parity Problem）</strong> ”的墙。要翻过这堵墙，必须发明全新的数学工具。</p>
<hr/>
<h2 data-id="heading-6">3. 2025年的 AI 战况：为什么跨不过这最后一步？</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e42096c6624fa1bfe584d498402734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=XLDwn2u7deBDusCztRlfusugGw4%3D" alt="nthme-1766376500477.png" loading="lazy"/></p>
<p>现在你明白了，要解决这个问题，不能靠暴力的“算”，而是要发明像“筛法”或“圆法”这样 <strong>全新的数学工具</strong>。</p>
<p>让我们看看 2025 年的三大 AI 模型在做什么。</p>
<h3 data-id="heading-7">OpenAI GPT-5.2：有灵感，无逻辑的“文科生”</h3>
<p>GPT-5.2 是目前最强的直觉机器。</p>
<p>如果你问它如何证明，它会模仿陈景润的论文风格，写得头头是道。它甚至会建议你：“试着结合椭圆曲线和模形式...”</p>
<p><strong>但它有一个致命伤：幻觉。</strong></p>
<p>它不懂什么是严谨的推导。它是在用概率预测下一个字，而不是在构建逻辑链。它给出的证明，往往在第 5-10 步就引用了一个根本不存在的定理。</p>
<p><strong>它像一个喝醉了的天才，满嘴金句，但走不成直线。</strong></p>
<h3 data-id="heading-8">Anthropic Claude 4.5 Opus：有逻辑，无方向的“做题家”</h3>
<p>Claude 4.5 接入了 Lean 4（形式化验证语言）。它是最严谨的。</p>
<p>它能完美地复现陈景润当年的“1+2”证明过程，每一步都无懈可击。</p>
<p><strong>但它卡在了“创造性”上。</strong></p>
<p>目前的 AI 只能在<strong>已有的公理体系</strong>内进行搜索。而要从“1+2”跨越到“1+1”，数学界公认现有的“筛法”已经用到了极限，必须有颠覆性的新方法。</p>
<p><strong>Claude 4.5 就像一个完美的工匠，它能把旧地图画得无比精细，但它无法画出地图上没有的新大陆。</strong></p>
<h3 data-id="heading-9">Google Gemini 3 Pro：暴力美学的极限</h3>
<p>Google 试图用 DeepMind 的 AlphaProof 2.0 暴力破解。</p>
<p>它把数学证明变成了一个<strong>搜索树</strong>问题。在奥数题里，搜索深度可能只有几十层，它能算出最优解。</p>
<p>但在哥德巴赫猜想面前，搜索空间是<strong>指数级爆炸</strong>的。即使是 2025 年的量子辅助算力，面对这种量级，也像是在太平洋里捞一根针。</p>
<p><strong>它就像西西弗斯，拥有推得动巨石的算力，却被困在了“无穷”这座永远推不到顶的山脚下。</strong></p>
<p>这三个 AI 就分别代表了：<strong>混乱的直觉</strong>、<strong>僵化的守成</strong>、<strong>徒劳的暴力</strong>。更衬托出人类“灵感”的珍贵。</p>
<hr/>
<h2 data-id="heading-10">4. AI 的高维困境：为什么“暴力计算”失效了？</h2>
<p>看完历史，你就明白了：<strong>哥德巴赫猜想不是计算量的问题，而是逻辑架构的问题。</strong></p>
<p>目前的 AI（GPT-5.2, Gemini 3 Pro, Claude 4.5）虽然强大，但本质上还是 <strong>“超级模仿者”</strong> 。它们在做的是：</p>
<ol>
<li><strong>概率预测</strong>：根据已有的数学论文，猜下一个词。</li>
<li><strong>搜索优化</strong>：在已知的解题路径里找最优解。</li>
</ol>
<p>但要证明哥德巴赫猜想，AI 必须从 <strong>“模仿者”</strong> 进化为 <strong>“概念创造者”</strong> 。</p>
<p>这需要 AI 跨越三个具体的进化阶段：</p>
<h3 data-id="heading-11">阶段一：翻译官——从“自然语言”到“形式化数学”（当前阶段）</h3>
<p>目前的 AI 经常一本正经地胡说八道（幻觉）。要解决数学难题，第一步是 <strong>“去模糊化”</strong> 。</p>
<ul>
<li><strong>目标</strong>：AI 需要把陈景润、陶哲轩等人的论文，完美无误地翻译成计算机能绝对理解的严谨语言（如 Lean 或 Coq）。</li>
<li><strong>现状</strong>：Claude 4.5 Opus 已经能做得很好了，但这只是打好了地基。</li>
</ul>
<h3 data-id="heading-12">阶段二：逻辑大师——掌握“长链条推理”（AlphaProof 阶段）</h3>
<p>奥数题的证明通常只有几十步，而哥德巴赫猜想可能需要<strong>数万步</strong>极其严密的逻辑跳跃。</p>
<ul>
<li><strong>目标</strong>：神经符号系统的成熟。</li>
</ul>

<ul>
<li>
<ul>
<li><strong>左脑（符号逻辑）</strong> ：保证每一步推导绝对正确，像计算器一样严谨。</li>
<li><strong>右脑（神经网络）</strong> ：像人类大师一样拥有“直觉”，在茫茫的逻辑迷宫中，瞬间判断出哪条路通向终点。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>现状</strong>：Google DeepMind 在这方面刚起步，拿到了 IMO 银牌，但距离“万步推理”还有数量级的差距。</li>
</ul>
<h3 data-id="heading-13">阶段三：造物主——具备“概念创造”能力（关键转折点）</h3>
<p>这是最难的一步，也是目前 AI 的<strong>绝对盲区</strong>。</p>
<p>回顾历史，陈景润之所以能做到“1+2”，是因为他<strong>改进</strong>了筛法。</p>
<p>要解决“1+1”，AI 不能只在旧规则里玩游戏（像下围棋那样），<strong>它必须修改规则！！</strong></p>
<ul>
<li><strong>目标</strong>：突破“奇偶性障碍”。AI 需要凭空发明出人类未曾设想过的数学对象（比如定义一种“广义素数”或“高维筛法”）。</li>
<li><strong>本质</strong>：这不仅仅是解题，这是<strong>爱因斯坦提出相对论级别的思维飞跃</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-14">5. 终极预测：我们距离那一天还有多远？</h2>
<p>如果未来某天你看到以下新闻，说明 AI 距离摘下皇冠不远了。我们可以把这个进度条量化为四个里程碑：</p>



































<table><thead><tr><th><strong>发展阶段</strong></th><th><strong>标志性事件</strong></th><th><strong>预计实现时间</strong></th><th><strong>距离终极真理</strong></th></tr></thead><tbody><tr><td><strong>L1: 辅助者</strong></td><td>AI 无错误地检查顶尖论文，查漏补缺。</td><td><strong>当前已实现</strong></td><td>遥远 (依然是工具)</td></tr><tr><td><strong>L2: 竞赛者</strong></td><td>AI 在国际奥数 (IMO) 拿满分金牌，解法比人类优美。</td><td><strong>1-2 年内</strong></td><td>还有距离 (只会做题，不会出题)</td></tr><tr><td><strong>L3: 发现者</strong></td><td>AI 独立发现并证明一个人类未知的、有意义的新定理。</td><td><strong>5-10 年</strong></td><td>接近 (具备了初步创造力)</td></tr><tr><td><strong>L4: 创造者</strong></td><td><strong>AI 发明全新的数学定义或框架 (如新筛法)。</strong></td><td><strong>未知 / 奇点</strong></td><td>临门一脚 (打破叹息之墙)</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">6. 结语</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf054906a7de45f58c9d430da0ccccc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766983164&amp;x-signature=FKR5J7N5LL0yScoU2y%2FtpOJC4kM%3D" alt="e891b3de8bbd391592c279c7186a1491_1766376928.png" loading="lazy"/>
回到最初的故事。22 岁的刘路之所以能震撼世界，是因为他在旧有的知识体系上，捅破了一层窗户纸。</p>
<p>而哥德巴赫猜想，是一堵厚重的墙。</p>
<p>2025 年的 AI，依然是最好的<strong>副驾驶</strong>。它能帮我们把车开得飞快，能帮我们避开路上的坑，但它还不知道如何<strong>飞越</strong>这堵墙。</p>
<p><strong>哥德巴赫猜想的皇冠，最终可能不会戴在 AI 的头上。</strong></p>
<p>它大概率会戴在下一位人类天才的头上——而这位天才的手里，一定紧紧握着通往 AI 算力深处的钥匙。</p>
<p><strong>不是 AI 战胜了数学，而是人类利用 AI，再一次战胜了自己。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能体基础概念笔记]]></title>    <link>https://juejin.cn/post/7586192313635520546</link>    <guid>https://juejin.cn/post/7586192313635520546</guid>    <pubDate>2025-12-22T04:41:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586192313635520546" data-draft-id="7586192313635487778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能体基础概念笔记"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-22T04:41:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能体基础概念笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T04:41:34.000Z" title="Mon Dec 22 2025 04:41:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读34分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI核心技术体系笔记：大模型、智能体与关键支撑技术</h2>
<p>本文系统梳理AI领域核心技术模块——大模型（LLM）、智能体（Agent）、提示词（Prompt）、检索增强生成（RAG）、工具调用（Function Calling）的定义、核心能力、应用场景及内在关联，构建完整的技术认知框架，助力理解AI技术的落地逻辑与价值边界。</p>
<h2 data-id="heading-1">一、基础核心：大模型（LLM）——AI能力的“原生引擎”</h2>
<p>大模型是整个AI技术体系的基础组件，提供核心的自然语言理解与生成等基础智能能力，是后续技术延伸（如智能体、RAG等）的前提。</p>
<h3 data-id="heading-2">1.1 核心定义</h3>
<p>基于Transformer架构、海量文本/多模态数据预训练的通用深度学习模型，通常具备数十亿至数万亿级参数，通过自监督学习掌握语言统计规律与语义逻辑，核心优势集中于自然语言理解与生成、代码补全、信息抽取、逻辑推理等基础智能能力，是人工智能的核心基础组件。</p>
<ul>
<li>补充要点：强调Transformer架构与自监督学习的核心地位，明确参数规模与训练范式是大模型能力涌现的关键。</li>
</ul>
<h3 data-id="heading-3">1.2 核心特征</h3>
<ol>
<li>无原生长期记忆：仅支持短期上下文记忆，依赖当前会话的上下文窗口（Token数量限制）存储临时信息，会话结束后记忆自动清空，无法跨会话复用数据；仅能通过外部工具（如向量数据库）实现长期记忆模拟。</li>
<li>被动响应模式：需依赖外部指令（Prompt）驱动运行，无自主设定目标、规划任务的意识，仅能针对输入指令输出对应结果，不具备主动感知与决策能力。</li>
<li>能力涌现特性：参数、数据规模达到阈值后，会涌现出小模型不具备的复杂推理、小样本学习等能力，这是大模型区别于传统AI的核心标志。</li>
</ol>
<h3 data-id="heading-4">1.3 能力边界（核心短板）</h3>
<ol>
<li>上下文窗口有限：处理长文本时需分段输入，或结合检索工具辅助补充信息，窗口外信息难以有效关联。</li>
<li>实时数据获取受限：训练数据存在时间截止点，无法原生联网获取最新动态数据，需通过插件/API等工具扩展。</li>
<li>专业领域深度不足：通用模型在医疗、法律、工业等垂直领域的专业精度不足，需通过微调、RAG等方式提升适配度。</li>
<li>私域知识无法原生应答：未纳入训练数据的企业内部文档、专属客户数据等私域信息，模型无法原生应答，需通过知识注入解决。</li>
<li>存在“幻觉”风险：生成内容可能与事实不符，核心诱因是依赖参数记忆+短期上下文记忆，缺乏长期事实校验机制，在复杂推理与模糊信息场景中更易出现。</li>
<li>缺乏任务闭环能力：无法自主拆解复杂多步任务，也不能根据执行结果调整策略，需外部框架（如智能体）实现任务规划与反馈迭代。</li>
</ol>
<h3 data-id="heading-5">1.4 适用场景</h3>
<p>问答互动、文本摘要、内容改写、数据分类、语言翻译、代码草稿生成等单一、短流程任务。</p>
<ul>
<li>
<p>场景示例：</p>
</li>
<li>
<p>内容创作：公众号文章初稿、产品文案生成；</p>
</li>
<li>
<p>办公效率：会议纪要自动整理、邮件智能回复；</p>
</li>
<li>
<p>研发辅助：代码片段补全、简单Bug排查；</p>
</li>
<li>
<p>数据处理：结构化数据分类、非结构化信息抽取。</p>
</li>
</ul>
<h2 data-id="heading-6">二、能力升级：智能体（Agent）——大模型的“主动执行载体”</h2>
<p>智能体以大模型为核心“大脑”，通过整合多模块能力，解决大模型的被动响应和任务闭环短板，实现从“工具”到“系统”的升级。</p>
<h3 data-id="heading-7">2.1 核心定义</h3>
<p>以大模型为核心“大脑”，整合感知模块、决策规划模块、工具调用模块、记忆管理模块的完整智能系统，具备自主感知环境、设定目标、拆解任务并执行闭环的能力。</p>
<h3 data-id="heading-8">2.2 核心特征</h3>
<ol>
<li>具备长期记忆与状态管理：可通过外部数据库/向量库，维护任务全流程的关键信息与执行状态，支持跨步骤、跨场景复用记忆，从源头减少“脑补”需求，弥补大模型长期记忆缺失短板。</li>
<li>主动闭环能力：形成“感知→规划→执行→反思优化”的自主循环，无需人类持续干预，解决大模型被动响应与任务闭环缺失问题。</li>
</ol>
<h3 data-id="heading-9">2.3 核心能力</h3>
<ol>
<li>任务拆解与规划：将复杂目标拆分为可执行的多步子任务，明确各步骤优先级与执行路径，适配复杂任务需求。</li>
<li>工具调用扩展：灵活调用外部工具（API、数据库、浏览器、RAG系统等），弥补大模型原生短板（如实时数据获取、专业领域精度不足等）。</li>
<li>动态调整策略：基于工具反馈与执行结果反思优化，应对任务中的变量与突发情况，保障任务推进的稳定性。</li>
</ol>
<h3 data-id="heading-10">2.4 适用场景</h3>
<p>自动化工作流搭建、数据采集与分析处理、长链路复杂任务（如项目开发辅助、活动策划）、智能运维、个性化助理等需自主闭环的场景。</p>
<ul>
<li>
<p>场景示例：</p>
</li>
<li>
<p>项目开发辅助：自动拆解开发任务、分配模块、调用代码检查工具、生成开发进度报告；</p>
</li>
<li>
<p>智能运维：实时监测系统状态、识别异常、调用修复工具执行应急处理、记录运维日志；</p>
</li>
<li>
<p>个性化助理：根据用户日程规划每日行程、调用票务API预订交通、推送相关行程提醒。</p>
</li>
</ul>
<h3 data-id="heading-11">2.5 与大模型的核心关联</h3>
<ol>
<li>大模型是智能体的“核心组件”：为智能体提供基础的理解、推理能力，是决策规划模块的核心支撑，决定智能体的基础智能上限。</li>
<li>智能体是大模型的“落地载体”：通过补充记忆管理、工具调用、任务闭环能力，让大模型从“被动响应工具”升级为“主动执行系统”，适配复杂实际场景。</li>
<li>关键联动：智能体通过优化“记忆机制”（外部长期记忆）和“事实校验机制”（工具调用+RAG），针对性解决大模型的“记忆短板”与“幻觉风险”，实现1+1&gt;2的应用效果。</li>
</ol>
<h2 data-id="heading-12">三、交互桥梁：提示词（Prompt）——驱动智能的“精准指令系统”</h2>
<p>提示词是用户与大模型/智能体交互的核心媒介，通过结构化指令对齐双方预期，同时弥补大模型的部分原生短板（如幻觉、输出不规范等）。</p>
<h3 data-id="heading-13">3.1 核心定义</h3>
<p>向大模型输入的结构化指令、问题或上下文信息的集合，用于精准引导模型理解任务目标、约束条件与输出要求，进而生成符合预期的结果。</p>
<h3 data-id="heading-14">3.2 核心作用</h3>
<ol>
<li>弥补大模型原生短板：明确任务边界与事实约束，减少“幻觉”风险；限定输出范式，降低后续内容加工成本。</li>
<li>对齐用户与模型预期：将模糊需求（如“写一篇好的文案”）转化为模型可理解的明确指令（如“写一篇面向年轻女性的护肤品推广文案，风格活泼，突出保湿功效，300字以内”），避免生成内容偏离核心目标。</li>
<li>适配专业场景需求：通过角色与规则定义，让模型输出贴合特定领域（如前端开发、数据分析、医疗诊断）的专业内容，提升输出精准度。</li>
</ol>
<h3 data-id="heading-15">3.3 核心组成（结构化Prompt六要素）</h3>
<ol>
<li>角色定位：明确模型的任务身份（如“资深Vue前端工程师”“智能体任务规划师”“医疗文案审核专家”），引导模型匹配对应角色的专业用语与思维逻辑。</li>
<li>任务描述：清晰阐述核心需求与达成标准，避免模糊表述，例如“生成Vue3商品列表组件代码，需支持下拉刷新与上拉加载，兼容移动端”。</li>
<li>工具调用要求（可选）：针对智能体专属场景，明确需要调用的外部工具及调用规则，例如“调用浏览器检索Vue官方最新API文档，优先参考Composition API用法”。</li>
<li>工作流要求（可选）：明确任务执行的步骤顺序与衔接规则，例如“先梳理组件核心功能点，再编写代码，最后添加详细注释”，适用于多步骤、有先后顺序的复杂任务。</li>
<li>输出格式：指定内容的呈现类型与规范细节，例如“带详细注释的JavaScript代码”“Markdown表格”“分点式报告”，同时明确排版、篇幅、版本兼容等要求。</li>
<li>参考示例（可选）：提供1-2组输入输出范例，帮助模型快速理解任务标准，适用于复杂或定制化需求（如“按以下示例格式生成数据分类结果：输入：苹果；输出：水果-常见鲜果”）。</li>
<li>约束条件：划定内容的边界与禁忌，例如“禁止编造未经验证的Vue API用法”“回答长度控制在300字以内”“避免使用专业术语，采用通俗表达”。</li>
</ol>
<h3 data-id="heading-16">3.4 编写关键原则</h3>
<ol>
<li>结构化优先：避免大段无条理文本，采用分段、编号、分点形式明确逻辑关系，降低模型理解成本。</li>
<li>指令精准化：减少模糊表述，用具体、量化要求替代抽象描述，例如将“写一个组件”优化为“写一个基于Composition API的Vue3商品列表组件，支持分页功能”。</li>
<li>上下文适配性：多轮对话场景下，嵌入历史会话关键信息，利用模型短期上下文记忆提升回答连贯性，例如“基于上一轮生成的组件框架，补充搜索功能模块代码”。</li>
</ol>
<h3 data-id="heading-17">3.5 使用场景</h3>
<ol>
<li>系统提示词：会话初始化时注入的全局指令，定义模型基础角色、通用规则与响应范式，贯穿整个对话，适用于长期稳定的交互场景（如企业智能客服的角色定义）。</li>
<li>用户提示词：针对具体需求输入的即时指令，补充任务细节、约束与输出偏好，适配单次/单轮任务（如临时生成一份会议纪要）。</li>
</ol>
<h2 data-id="heading-18">四、知识增强：检索增强生成（RAG）——大模型的“开卷考试工具”</h2>
<p>RAG通过融合外部知识库检索与大模型生成能力，针对性解决大模型的幻觉、私域知识缺失、知识滞后等核心短板，是大模型知识补充的核心技术框架。</p>
<h3 data-id="heading-19">4.1 核心定义</h3>
<p>检索增强生成（Retrieval-Augmented Generation，RAG）是融合检索器（获取相关文档）与生成器（大模型）的技术框架，核心是生成答案前先从权威外部知识库（含私域文档、专业资料、实时数据等）检索相关事实信息，将其作为参考补充到提示词中，再驱动大模型生成准确、可追溯的结果，本质是为大模型提供“开卷考试”能力。</p>
<h3 data-id="heading-20">4.2 核心价值（精准解决大模型四大痛点）</h3>
<ol>
<li>对抗幻觉风险：回答基于检索到的真实权威内容，确保信息有依据且可溯源，显著降低编造错误信息的概率。</li>
<li>补充私域知识：通过检索企业内部文档、专属客户数据等私域资源，解决大模型“私域知识无法回答”的问题，无需对大模型进行全量微调。</li>
<li>保持知识新鲜：无需重新训练模型，仅更新外部知识库即可纳入最新信息（如行业新规、热点事件），突破训练数据时间局限。</li>
<li>提升专业精度：依托垂直领域权威资料（如医疗文献、行业规范、法律条文），让输出更贴合专业场景需求，提升垂直领域应用价值。</li>
</ol>
<h3 data-id="heading-21">4.3 核心工作流程（五阶段闭环）</h3>
<ol>
<li>文档分块：将长文本（如PDF、企业手册、学术论文）拆解为语义完整的小块，平衡上下文完整性与检索精准度，避免因文本过长导致的检索偏差。</li>
<li>索引构建：通过嵌入模型（如BERT、Sentence-BERT）将文本块转换为高维向量，存入向量数据库（如FAISS、Chroma、Milvus），形成可快速检索的向量索引。</li>
<li>目标检索：将用户问题向量化后，在向量数据库中通过语义相似度匹配，召回语义最相关的Top-K文本块（K值可根据场景调整，通常为3-5），精准筛选有用信息。</li>
<li>提示增强：将检索到的文本片段与用户问题、任务要求、约束条件整合，构建结构化提示词，为大模型提供明确的事实参考。</li>
<li>生成输出：大模型基于增强提示词，整合参考信息生成流畅、准确的回答，同时可关联原始文档来源（如文档名称、页码），方便验证信息真实性。</li>
</ol>
<h3 data-id="heading-22">4.4 关键技术细节</h3>
<ol>
<li>分块策略：常用固定尺寸分块（按Token数量拆分，设10%-20%重叠部分，保障语义连贯性）和递归分块（按段落、句子自适应拆分，适配结构化文档）。</li>
<li>检索核心：由嵌入模型（负责语义转换，决定向量表征的精准度）和向量数据库（负责快速近似匹配，决定检索效率）组成，二者共同影响检索质量。</li>
<li>溯源能力：生成结果时关联原始文档来源，实现“答案-依据”的一一对应，便于后续事实校验与责任追溯，适用于医疗、法律等严谨场景。</li>
<li>优化技巧：通过重排序模型（如Cross-BERT）过滤低相关度文本；通过上下文压缩减少Token占用，适配大模型上下文窗口限制；采用多轮检索补充遗漏信息，提升检索全面性。</li>
</ol>
<h3 data-id="heading-23">4.5 主流应用场景</h3>
<ol>
<li>企业知识管理：如银泰商业通过RAG构建内部知识库，实现员工手册、业务流程、产品资料的快速查询，提升内部协作效率。</li>
<li>智能客服/问答：如伯俊科技“AI通识小助手”，通过检索企业商品数据库，实现商品标签映射、库存调度等场景的秒级响应，提升客户服务体验。</li>
<li>专业领域支持：医疗诊断建议（检索临床指南、病例文献）、法律条文解读（检索法律法规、判例资料）、金融风险评估（检索行业政策、市场报告）。</li>
<li>长文本处理：论文辅助写作（检索参考文献、学术观点）、合同审核（检索法律条款、行业标准）、书籍摘要（检索核心章节内容）。</li>
<li>事实校验：对大模型生成内容的关键数据（如统计数据、政策条款）进行检索验证，修正过时或错误信息，保障内容准确性。</li>
</ol>
<h3 data-id="heading-24">4.6 局限性与优化方向</h3>
<ol>
<li>现存局限：检索精度受嵌入模型性能与分块策略影响，易出现“漏检”“误检”；长知识库场景下（如百万级文档）存在检索效率瓶颈；无法直接处理非文本数据（如图片、音频、表格）。</li>
<li>优化方向：结合多模态嵌入模型支持跨媒体检索（如图片+文本混合检索）；引入知识图谱提升结构化知识检索能力，解决文本检索的歧义问题；通过强化学习优化检索-生成联动逻辑，提升整体效果。</li>
</ol>
<h3 data-id="heading-25">4.7 与其他技术的关联</h3>
<ol>
<li>与大模型：RAG是大模型的“能力延伸工具”，无需改变大模型参数，通过外部知识补充的方式，低成本弥补其私域知识缺失、幻觉、知识滞后等短板。</li>
<li>与智能体：RAG是智能体的核心组成部分，为智能体提供稳定的外部知识检索能力，配合工具调用模块支撑复杂任务闭环（如智能体规划任务时，通过RAG检索相关流程规范）。</li>
<li>与提示词：RAG检索到的事实信息是提示词的重要组成部分，通过“问题+事实参考”的增强提示词，让大模型生成的内容更精准、有依据。</li>
</ol>
<h2 data-id="heading-26">五、交互延伸：工具调用（Function Calling）——智能体的“现实交互接口”</h2>
<p>Function Calling是大模型/智能体与外部系统交互的核心技术，让模型突破“纯文本生成”的局限，具备获取实时数据、执行专业操作的能力，是连接AI与现实世界的关键桥梁。</p>
<h3 data-id="heading-27">5.1 核心定义</h3>
<p>Function Calling是大模型/智能体与外部系统、工具、API交互的核心技术，指模型根据任务需求自主识别并调用预设函数/接口，获取外部数据或执行特定操作，再将结果整合到生成内容中，本质是让模型具备与现实世界交互的能力。</p>
<h3 data-id="heading-28">5.2 核心价值（弥补大模型三大核心短板）</h3>
<ol>
<li>获取实时动态数据：调用浏览器、股票行情API、天气API等，解决大模型训练数据“时间截止点”问题，支持查询最新新闻、实时股价、当日天气等动态信息。</li>
<li>执行专业计算/操作：调用代码编译器、数据库查询接口、Excel工具等，完成复杂运算（如数学建模、统计分析）、数据读写（如查询企业销售数据库、修改表格数据）等任务。</li>
<li>联动第三方工具链：对接行业专属工具（如CAD设计接口、医疗影像分析工具、财务报销系统）、自动化工作流（如钉钉消息推送、邮件发送），拓展垂直领域落地场景。</li>
</ol>
<h3 data-id="heading-29">5.3 核心工作流程（四步执行闭环）</h3>
<ol>
<li>任务解析与函数匹配：大模型接收指令后，分析任务所需的外部能力，从预设函数列表中匹配最合适的函数（明确函数名、入参格式、功能描述），判断是否需要调用工具。</li>
<li>参数生成与格式校验：模型根据任务需求生成函数所需的标准化入参（如调用“天气查询”函数时生成<code>city: 上海, date: 2025-12-19</code>），并严格遵循预设格式（如JSON、XML），避免调用失败。</li>
<li>函数执行与结果返回：外部执行环境（如LangChain、AgentBuilder）调用目标函数/API，执行具体操作并获取结果（如返回上海当日天气“晴，10-18℃”），同时处理调用异常（如参数错误、接口超时）。</li>
<li>结果整合与生成输出：模型将外部工具执行结果与自身推理能力结合，生成自然语言回答，可标注数据来源（如“数据来源：XX天气API”），提升结果可信度。</li>
</ol>
<h3 data-id="heading-30">5.4 关键技术细节</h3>
<ol>
<li>函数定义规范：需提供清晰的函数描述文档，包含功能说明、入参要求（名称、类型、必填项、取值范围）、出参格式、错误码说明，帮助模型准确理解函数功能。</li>
<li>格式约束与容错机制：通过Prompt强制模型输出标准化调用格式（如“所有函数调用必须采用JSON格式，示例：{"name":"get_weather","parameters":{"city":"上海","date":"2025-12-19"}}”）；设置容错逻辑，当参数缺失或格式错误时，主动追问用户补充信息，或重新生成参数。</li>
<li>安全管控策略：对调用权限分级管理（区分“只读接口”如数据查询、“读写接口”如数据修改、“执行接口”如系统操作），避免误操作风险；设置操作超时与异常处理机制（如接口调用超时后重试3次，失败则提示用户），避免任务中断。</li>
</ol>
<h3 data-id="heading-31">5.5 与RAG的区别与协同</h3>






























<table><thead><tr><th>特性</th><th>Function Calling（工具调用）</th><th>RAG（检索增强生成）</th></tr></thead><tbody><tr><td>核心目标</td><td>与外部工具交互，执行动态操作、获取实时数据</td><td>从静态知识库检索事实信息，补充模型知识</td></tr><tr><td>数据类型</td><td>实时动态数据、可执行操作结果</td><td>静态结构化/非结构化文档知识</td></tr><tr><td>核心优势</td><td>动态交互、实时性强、可执行操作</td><td>知识补充成本低、可溯源、稳定性高</td></tr><tr><td>应用场景</td><td>实时查询、专业计算、工具联动、自动化操作</td><td>私域知识问答、文档解读、事实校验、专业资料查询</td></tr></tbody></table>
<p>协同模式：在智能体架构中，Function Calling与RAG形成互补——当RAG检索的静态知识不足以完成任务时，模型可调用工具获取实时数据；当工具调用需要专业知识支撑时，可通过RAG检索相关规范。例如“先从企业知识库（RAG）检索产品基础参数，再调用电商平台API（Function Calling）获取最新销量数据，最终生成销售分析报告”，实现静态知识与动态数据的深度融合。</p>
<h3 data-id="heading-32">5.6 与大模型/智能体的关联</h3>
<ol>
<li>与大模型：Function Calling是大模型从“被动生成”转向“主动交互”的关键能力，但单独大模型的工具调用需依赖人工定义函数列表和格式约束，无法自主规划调用逻辑。</li>
<li>与智能体：Function Calling是智能体工具模块的核心技术，与任务规划模块、记忆模块深度联动——智能体可自主决定“何时调用工具、调用哪种工具、如何处理调用结果”，并将执行结果存入长期记忆，用于后续决策优化，实现端到端的任务闭环。</li>
</ol>
<h3 data-id="heading-33">5.7 典型应用场景</h3>
<ol>
<li>智能数据分析：调用企业数据库接口提取销售数据→调用Python编译器进行趋势建模→生成可视化分析报告→推送至管理层邮箱。</li>
<li>自动化办公助手：识别用户需求“整理本周会议纪要”→调用企业邮箱API获取会议邮件→调用语音转文字工具处理会议录音→生成纪要并推送至钉钉群。</li>
<li>实时信息查询助手：回答用户问题“今日上证指数收盘情况”→调用股票行情API获取实时数据→整合数据生成自然语言回答，标注数据来源与查询时间。</li>
<li>垂直领域工具联动：医疗智能体调用影像分析API处理CT影像→通过RAG检索相关病例文献→结合两者结果生成诊断建议；工业智能体调用设备传感器API获取运行数据→调用故障诊断工具识别异常→生成运维方案。</li>
</ol>
<h2 data-id="heading-34">六、工作流——AI技术落地的“流程化载体”</h2>
<p>工作流是AI技术从“零散能力”走向“规模化落地”的关键支撑，通过定义标准化的任务执行步骤、角色分工与衔接规则，将大模型、智能体、RAG、工具调用等技术模块串联起来，实现复杂业务需求的端到端闭环处理。其核心价值在于降低技术落地的复杂度，提升任务执行的稳定性与可复用性。</p>
<h3 data-id="heading-35">6.1 核心定义</h3>
<p>AI领域的工作流是指为完成特定业务目标，对多步任务进行结构化拆解，明确各步骤的执行主体（大模型/智能体）、依赖资源（外部工具/知识库）、输入输出标准及衔接条件的流程框架。它并非独立技术，而是整合各类AI技术的“串联器”，让分散的技术能力形成协同效应。</p>
<h3 data-id="heading-36">6.2 与核心技术模块的关联</h3>
<ol>
<li>与智能体：工作流是智能体任务规划的具象化呈现，智能体的“任务拆解与规划”能力需依托工作流定义的步骤逻辑，确保任务推进的有序性；同时，智能体的动态调整策略可反哺工作流优化，实现流程的柔性适配。</li>
<li>与提示词：提示词中的“工作流要求”是工作流在交互层的具体体现，通过向大模型/智能体传递步骤规则，引导其按预设流程执行任务；而工作流则为提示词提供了标准化的流程框架，避免步骤描述的模糊性。</li>
<li>与RAG+工具调用：工作流明确了RAG（静态知识补充）与工具调用（动态操作执行）的触发时机与衔接逻辑，例如“先通过RAG检索业务规范→再调用数据查询工具获取实操数据→最后由大模型生成分析报告”，确保两类技术精准配合。</li>
<li>与大模型：大模型是工作流各步骤的核心执行单元，负责理解任务需求、处理文本信息、生成中间结果；工作流则为大模型限定了执行边界，避免其因缺乏流程约束而偏离任务目标。</li>
</ol>
<h3 data-id="heading-37">6.3 核心类型与应用场景</h3>
<ol>
<li>固定流程型工作流：适用于步骤明确、规则固定的标准化任务，核心是通过流程固化提升效率。 - 场景示例：企业发票审核（步骤：调用OCR工具识别发票信息→通过RAG检索报销规范→调用财务系统校验金额→生成审核结果并推送）、客户咨询应答（步骤：接收用户问题→RAG检索知识库→大模型生成标准化回答→人工复核（可选）→推送结果）。</li>
<li>柔性适配型工作流：适用于需求多变、步骤存在不确定性的复杂任务，核心是结合智能体的动态调整能力实现流程适配。 - 场景示例：项目方案策划（步骤：明确策划目标→智能体拆解子任务（市场调研、需求分析、方案撰写等）→调用浏览器获取行业数据（工具调用）→RAG检索同类方案参考→大模型生成初稿→智能体反思优化→输出终稿）、个性化诊疗辅助（步骤：获取患者病历→调用影像分析工具处理检查结果→RAG检索临床指南→大模型生成初步诊疗建议→智能体结合医生反馈调整→形成最终方案）。</li>
</ol>
<h3 data-id="heading-38">6.4 落地关键要点</h3>
<ol>
<li>步骤拆解颗粒度：平衡“精细化”与“高效性”，过细的步骤会增加交互成本，过粗的步骤则会降低可控性；建议按“单一职责原则”拆解，确保每个步骤仅完成一项核心任务。</li>
<li>输入输出标准化：为每个步骤定义清晰的输入格式（如数据类型、参数要求）与输出标准（如结果格式、错误码规范），避免因数据不兼容导致流程中断。</li>
<li>异常处理机制：预设流程中断的应对策略，例如工具调用失败时的重试逻辑、RAG检索无结果时的兜底方案（如转人工处理）、大模型生成内容不符合要求时的重新生成规则。</li>
<li>可追溯性设计：记录工作流各步骤的执行日志（如执行时间、调用工具、生成结果、操作主体），便于后续问题排查、流程优化与责任追溯。</li>
</ol>
<h3 data-id="heading-39">6.5 主流实现工具</h3>
<p>落地工作流需依托专门的框架工具，实现流程的可视化搭建、执行与管理： - 通用框架：LangChain（支持与大模型、工具、RAG的深度集成，适合快速搭建简单工作流）、Airflow（侧重任务调度与监控，适合复杂定时工作流）； - 低代码平台：Make（原Integromat）、Zapier（支持无代码拖拽搭建工作流，适配非技术人员使用）； - 垂直领域工具：医疗领域的DrChrono（集成诊疗工作流与AI辅助能力）、企业办公领域的飞书多维表格（通过AI插件联动工作流）。</p>
<h2 data-id="heading-40">七、数据双引擎：数据库——智能体的业务操作与语义记忆载体</h2>
<p>智能体的运行依赖两类数据库的协同支撑，二者分工明确，分别承载“业务数据操作”和“语义记忆检索”两大核心需求，是智能体实现“业务落地+记忆进化”的基础。其中，结构化数据库的功能提供了一种简单、高效的方式来管理和处理结构化数据，开发者和用户可通过自然语言插入、查询、修改或删除数据库中的数据。</p>
<h3 data-id="heading-41">7.1 核心分类与定位</h3>


























<table><thead><tr><th>数据库类型</th><th>核心定位</th><th>关联技术</th><th>操作方式</th><th>典型工具</th></tr></thead><tbody><tr><td>结构化数据库</td><td>智能体操作真实业务数据的核心载体</td><td>工具调用（Function Calling）</td><td>大模型生成SQL语句，直接增删改查；支持自然语言驱动的数操作</td><td>MySQL、PostgreSQL、MongoDB（半结构化）</td></tr><tr><td>向量数据库</td><td>智能体RAG与长期记忆的专属语义载体</td><td>RAG、智能体长期记忆</td><td>嵌入模型生成向量+语义相似度检索，无SQL操作</td><td>FAISS、Chroma、Milvus、Pinecone</td></tr></tbody></table>
<h3 data-id="heading-42">7.2 结构化数据库：智能体的“业务操作中枢”</h3>
<h4 data-id="heading-43">7.2.1 核心定义</h4>
<p>存储企业结构化业务数据（客户信息、销售订单、库存台账、任务日志等）的载体，其功能提供了一种简单、高效的方式来管理和处理结构化数据。智能体可通过大模型将用户自然语言指令转换为标准化SQL语句，直接对数据进行插入、查询、修改或删除，无需用户手动编写SQL，是连接AI与现实业务系统的唯一接口。</p>
<h4 data-id="heading-44">7.2.2 智能体操作流程（SQL驱动闭环）</h4>
<ol>
<li>需求解析：智能体接收自然语言指令（如“查询2025年12月北京地区的空调销量”），依托大模型提取核心条件（时间、地区、品类）。</li>
<li>SQL生成与校验：大模型根据指令生成符合数据库语法的SQL语句，同时校验字段合法性与权限范围，示例： <code> SELECT product_model, sales_volume  `` FROM sales_data  ``WHERE sale_month = '2025-12' AND region = '北京' AND product_type = '空调';</code></li>
<li>权限管控与执行：智能体通过工具调用接口执行SQL，仅赋予“最小必要权限”（如查询类任务仅开放<code>SELECT</code>权限，禁止<code>DROP/ALTER</code>等高危操作），避免误操作风险。</li>
<li>结果转化与反馈：将数据库返回的结构化结果，通过大模型转换为自然语言回答，同时可生成可视化图表（如柱状图）辅助呈现。</li>
</ol>
<h4 data-id="heading-45">7.2.3 典型应用场景</h4>
<ul>
<li>销售业务：生成SQL查询客户历史订单、录入新订单数据、更新客户回款状态；</li>
<li>仓储管理：生成SQL扣减已发货商品库存、查询库存预警商品、新增入库记录；</li>
<li>任务日志：生成SQL记录智能体执行任务的时间、步骤、结果，用于后续流程追溯。</li>
</ul>
<h3 data-id="heading-46">7.3 向量数据库：智能体的“语义记忆中枢”</h3>
<h4 data-id="heading-47">7.3.1 核心定义</h4>
<p>存储非结构化数据向量表征（用户对话历史、私域文档片段、任务经验总结等）的载体，不支持SQL操作，仅通过“嵌入模型+语义检索”为RAG和长期记忆提供支撑，是智能体实现“语义级记忆”的核心工具。</p>
<h4 data-id="heading-48">7.3.2 核心工作流程（语义检索闭环）</h4>
<ol>
<li>向量生成：通过嵌入模型（如Sentence-BERT、text-embedding-ada-002）将非结构化数据转换为高维向量，向量距离越近，代表语义相似度越高；</li>
<li>向量存储：将生成的向量存入向量数据库，通过近似最近邻（ANN）算法构建索引，提升检索效率；</li>
<li>语义检索：将用户新指令转为向量，在数据库中检索相似度最高的Top-K向量，映射回原始文本数据（如用户上周提到的“偏好简洁报告”）；</li>
<li>结果应用：将检索到的语义信息整合到提示词中，指导智能体生成个性化、上下文连贯的输出。</li>
</ol>
<h4 data-id="heading-49">7.3.3 典型应用场景</h4>
<ul>
<li>RAG知识检索：检索企业产品手册、技术文档的向量片段，为大模型提供精准事实参考，对抗幻觉；</li>
<li>用户记忆检索：检索用户历史对话向量，记住用户偏好（如“不喜欢专业术语”）、需求（如“需要每周生成销售报告”）；</li>
<li>任务经验检索：检索同类任务的执行经验向量，复用成功策略（如“某类数据分析需调用特定API”）。</li>
</ul>
<h3 data-id="heading-50">7.4 两类数据库的协同逻辑（智能体视角）</h3>
<p>以“生成客户个性化跟进报告”为例，看两类数据库的联动流程：</p>
<ol>
<li>智能体接收指令：“生成客户李总的跟进报告，包含他的历史订单和上次提到的需求”；</li>
<li>调用结构化数据库：大模型生成SQL，查询<code>customer_order</code>表中李总的历史订单数据（订单号、金额、产品类型）；</li>
<li>调用向量数据库：将指令转为向量，检索与“李总上次需求”相关的对话向量，获取“需要定制化售后方案”的语义信息；</li>
<li>整合生成报告：大模型结合结构化订单数据和向量检索的需求信息，生成个性化跟进报告；</li>
<li>数据存储闭环：将报告内容转为向量存入向量数据库（更新长期记忆），同时将报告生成记录存入结构化数据库（更新任务日志）。</li>
</ol>
<h2 data-id="heading-51">八、能力沉淀：长期记忆——智能体的“语义经验库”</h2>
<p>智能体的长期记忆是基于向量数据库构建的语义级记忆系统，专注存储非结构化的交互经验与知识，支持跨会话复用，是智能体从“单次执行者”升级为“可进化伙伴”的核心能力。</p>
<h3 data-id="heading-52">8.1 核心定义</h3>
<p>智能体依托向量数据库，对用户交互历史、任务执行经验、RAG检索知识进行语义化存储与复用的能力，核心特征是“语义关联检索”，而非结构化数据的增删改查。</p>
<h3 data-id="heading-53">8.2 核心分类与存储载体</h3>
<p>长期记忆的所有内容均以向量形式存储在向量数据库中，按用途分为三类：</p>





























<table><thead><tr><th>记忆类型</th><th>存储内容</th><th>核心作用</th><th>检索触发条件</th></tr></thead><tbody><tr><td>用户记忆</td><td>用户身份信息、沟通偏好（如“喜欢简洁表达”）、历史需求（如“需要月度库存报告”）</td><td>实现个性化交互，避免重复提问，提升用户体验</td><td>接收到同一用户的新指令时</td></tr><tr><td>任务记忆</td><td>任务拆解步骤、工具调用策略、执行成功/失败经验（如“某API调用需传入region参数”）</td><td>复用同类任务经验，优化执行效率，减少试错成本</td><td>接收到同类任务指令时</td></tr><tr><td>知识记忆</td><td>RAG检索到的权威知识（如产品参数、行业规范）、外部工具获取的关键信息</td><td>补充智能体专业知识储备，提升复杂任务的决策精度</td><td>接收到涉及专业领域的指令时</td></tr></tbody></table>
<h3 data-id="heading-54">8.3 核心工作流程（向量驱动的记忆闭环）</h3>
<h4 data-id="heading-55">8.3.1 记忆存储</h4>
<p>智能体在任务执行过程中，将三类非结构化数据转换为向量，存入向量数据库：</p>
<ol>
<li>用户交互数据：将用户对话内容（如“报告不要超过3页”）通过嵌入模型转为向量；</li>
<li>任务执行数据：将任务拆解步骤、工具调用结果（如“调用天气API失败，因参数格式错误”）转为向量；</li>
<li>知识数据：将RAG检索到的文档片段（如“产品A的保修期为2年”）转为向量。</li>
</ol>
<h4 data-id="heading-56">8.3.2 记忆检索</h4>
<p>智能体接收新指令后，通过“语义匹配”检索相关记忆：</p>
<ol>
<li>将新指令转为向量，在向量数据库中检索相似度最高的Top-K向量；</li>
<li>过滤冗余信息（如已失效的任务经验），优先检索高价值记忆（如用户长期偏好）；</li>
<li>将检索到的记忆内容整合到提示词中，指导任务执行。</li>
</ol>
<h4 data-id="heading-57">8.3.3 记忆更新与进化</h4>
<p>任务完成后，智能体根据执行反馈更新记忆：</p>
<ol>
<li>新增有效记忆：将成功的任务策略（如“查询销量需同时筛选时间和地区”）转为向量存入；</li>
<li>标记无效记忆：将失败经验（如“某API已停用”）标注为低优先级，避免后续复用；</li>
<li>记忆压缩：定期清理重复、过时的向量数据，提升检索效率。</li>
</ol>
<h3 data-id="heading-58">8.4 关键技术挑战与优化方向</h3>
<h4 data-id="heading-59">8.4.1 核心挑战</h4>
<ol>
<li>记忆冗余：长期积累的海量向量数据可能包含无效信息，导致检索效率下降；</li>
<li>语义歧义：相似表述可能被误判为不同语义（如“简洁报告”和“简短报告”）；</li>
<li>隐私风险：用户记忆包含敏感信息（如联系方式、业务需求），存在泄露风险。</li>
</ol>
<h4 data-id="heading-60">8.4.2 优化方向</h4>
<ol>
<li>记忆清洗：基于使用频率和有效性，自动清理低价值向量数据；</li>
<li>语义增强：采用更先进的嵌入模型（如多模态嵌入），提升语义检索的精准度；</li>
<li>隐私保护：对用户敏感信息向量进行加密存储，设置检索权限分级。</li>
</ol>
<h3 data-id="heading-61">8.5 与核心技术的关联</h3>
<ol>
<li>与向量数据库：向量数据库是长期记忆的唯一存储载体，没有向量数据库，智能体无法实现语义级的记忆与检索；</li>
<li>与RAG：RAG检索的知识是长期记忆的重要来源，而长期记忆中的知识可反哺RAG，提升后续检索的精准度；</li>
<li>与智能体：长期记忆是智能体“自主进化”的核心支撑，让智能体能够从历史经验中学习，而非每次从零开始。</li>
</ol>
<h2 data-id="heading-62">九、技术体系核心逻辑总结</h2>
<p>整个AI核心技术体系围绕“大模型能力延伸+智能体闭环落地”展开，形成“基础层-交互层-增强层-数据层-应用层”的五层协同架构，各模块分工明确、相互支撑，共同推动AI从“基础智能工具”走向“复杂业务系统”。</p>
<ol>
<li><strong>基础层：大模型（LLM）—— 原生智能引擎</strong>提供自然语言理解、生成、逻辑推理的核心能力，是整个技术体系的底层基础。其原生短板（被动响应、无长期记忆、易幻觉）是所有上层技术需要解决的核心目标，决定了体系的基础智能上限。</li>
<li><strong>交互层：提示词（Prompt）—— 精准指令桥梁</strong>作为用户与AI系统的交互媒介，通过结构化指令对齐用户需求与模型能力，约束输出边界、减少幻觉风险。同时为智能体的任务规划、RAG的检索增强、工具调用的参数生成提供明确指引，是提升AI输出精准度的“低成本杠杆”。</li>
<li><strong>增强层：RAG + 工具调用（Function Calling）—— 能力延伸双抓手</strong>从两个维度弥补大模型的核心短板，实现“静态知识+动态操作”的双重增强：</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索]]></title>    <link>https://juejin.cn/post/7585808181240102963</link>    <guid>https://juejin.cn/post/7585808181240102963</guid>    <pubDate>2025-12-22T02:47:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181240102963" data-draft-id="7585839411123191854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索"/> <meta itemprop="keywords" content="前端,JavaScript,ECMAScript 6"/> <meta itemprop="datePublished" content="2025-12-22T02:47:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 中 this 的终极解析：从 call、bind 到箭头函数的深度探索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:47:59.000Z" title="Mon Dec 22 2025 02:47:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 JavaScript 编程的世界里，<code>this</code> 是一个既基础又令人困惑的概念。它看似简单，却常常在不经意间“背叛”我们的预期；它灵活多变，却又遵循着一套严格的规则。尤其当与 <code>call</code>、<code>apply</code>、<code>bind</code> 以及 ES6 引入的<strong>箭头函数</strong>结合时，<code>this</code> 的行为变得更加微妙而强大。</p>
<p>本文将结合代码，对 <code>this</code> 的机制进行一次全面、深入且生动的剖析。我们将逐字引用原始代码片段，还原其技术含义，并通过大量示例揭示背后的原理。无论你是初学者还是资深开发者，相信都能从中获得新的洞见。</p>
<hr/>
<h2 data-id="heading-1">一、核心内容</h2>
<p>我们可以将this问题拆解为几个核心命题：</p>
<ol>
<li><strong><code>this</code> 可以被覆盖</strong></li>
<li><strong><code>bind</code> 用于定时器中绑定 <code>this</code>，延迟执行</strong></li>
<li><strong><code>call</code> / <code>apply</code> 可指定 <code>this</code> 指向，并立即运行</strong></li>
<li><strong><code>that = this</code> 利用作用域链保存 <code>this</code></strong></li>
<li><strong>箭头函数没有自己的 <code>this</code>，而是继承父级作用域的 <code>this</code></strong></li>
</ol>
<p>接下来，我们将围绕这五点展开详细论述。</p>
<p>源代码链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Ftree%2Fmaster%2Fbatjtmd%2Fthis" title="https://gitee.com/giaoZou/lesson_zp/tree/master/batjtmd/this" target="_blank" ref="nofollow noopener noreferrer">lesson_zp/batjtmd/this: AI + 全栈学习仓库</a></p>
<hr/>
<h2 data-id="heading-2">二、this 的默认行为：谁调用，就属于谁</h2>
<p>在深入高级技巧前，必须先理解 <code>this</code> 的<strong>默认绑定规则</strong>。</p>
<h3 data-id="heading-3">1. 全局上下文中的 this</h3>
<p>在非严格模式下，全局作用域中的 <code>this</code> 指向全局对象（浏览器中是 <code>window</code>，Node.js 中是 <code>global</code>）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span> === <span class="hljs-variable language_">window</span>); <span class="hljs-comment">// true (浏览器)</span>
</code></pre>
<p>在严格模式下，全局函数中的 <code>this</code> 为 <code>undefined</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">'use strict'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); }
<span class="hljs-title function_">f</span>(); <span class="hljs-comment">// undefined</span>
</code></pre>
<h3 data-id="heading-4">2. 对象方法中的 this</h3>
<p>当函数作为对象的方法被调用时，<code>this</code> 指向该对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>,
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  }
};
obj.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// "Alice"</span>
</code></pre>
<p>但注意：<strong>函数一旦脱离对象调用，this 就会丢失</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fn</span> = obj.greet<span class="hljs-comment">;</span>
fn()<span class="hljs-comment">; // 非严格模式下输出 undefined（this 指向 window）</span>
</code></pre>
<p>这就是为什么我们需要 <code>call</code>、<code>bind</code> 等工具来“拯救”迷失的 <code>this</code>。</p>
<hr/>
<h2 data-id="heading-5">三、call 与 apply：强制指定 this，立即执行！</h2>
<h3 data-id="heading-6">原理与语法</h3>
<ul>
<li><code>func.call(thisArg, arg1, arg2, ...)</code></li>
<li><code>func.apply(thisArg, [arg1, arg2, ...])</code></li>
</ul>
<p>两者功能相同，区别仅在于参数传递方式。</p>
<blockquote>
<p>“call apply 指定this 指向 立即运行”</p>
</blockquote>
<p><code>call</code> 和 <code>apply</code> 的核心作用就是在<strong>调用函数的同时</strong>，显式指定 <code>this</code> 的值，并<strong>立刻执行</strong>该函数。</p>
<h3 data-id="heading-7">示例演示</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">introduce</span>(<span class="hljs-params">age</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>, <span class="hljs-subst">${age}</span> years old.`</span>);
}

<span class="hljs-keyword">const</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span> };

introduce.<span class="hljs-title function_">call</span>(person, <span class="hljs-number">25</span>);   <span class="hljs-comment">// I'm Bob, 25 years old.</span>
introduce.<span class="hljs-title function_">apply</span>(person, [<span class="hljs-number">30</span>]); <span class="hljs-comment">// I'm Bob, 30 years old.</span>
</code></pre>
<p>即使 <code>introduce</code> 不是 <code>person</code> 的方法，我们也能让它“假装”是——这就是 <code>this</code> 的灵活性。</p>
<h3 data-id="heading-8">实际应用场景</h3>
<ul>
<li>
<p>数组方法借用（如将类数组转为真数组）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> args = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">slice</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">arguments</span>);
</code></pre>
</li>
<li>
<p>通用工具函数适配不同上下文。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">四、bind：永久绑定 this，延迟执行</h2>
<h3 data-id="heading-10">原理与语法</h3>
<p><code>func.bind(thisArg, arg1, arg2, ...)</code> 返回一个<strong>新函数</strong>，该函数的 <code>this</code> 被永久绑定到 <code>thisArg</code>，且可预设部分参数（柯里化）。</p>
<blockquote>
<p>“bind 定时器this绑定(a) 以后再执行”</p>
</blockquote>
<p>这句话精准指出了 <code>bind</code> 的两大特点：</p>
<ol>
<li><strong>常用于定时器等异步回调中绑定 <code>this</code></strong></li>
<li><strong>不立即执行，而是返回一个可稍后调用的函数</strong></li>
</ol>
<h3 data-id="heading-11">经典问题：setTimeout 中的 this 丢失</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>++; <span class="hljs-comment">// ❌ this 指向 global/window</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>);
    }, <span class="hljs-number">1000</span>);
  }
};
timer.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 输出 NaN（因为 window.seconds 未定义）</span>
</code></pre>
<h3 data-id="heading-12">解决方案一：使用 bind</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>++;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">seconds</span>);
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">// ✅ 绑定外层 this</span>
  }
};
timer.<span class="hljs-title function_">start</span>(); <span class="hljs-comment">// 1, 2, 3...</span>
</code></pre>
<p>这里，<code>.bind(this)</code> 创建了一个新函数，其 <code>this</code> 永久指向 <code>timer</code> 对象，无论何时被调用都不会改变。</p>
<h3 data-id="heading-13">解决方案二：that = this（闭包保存）</h3>
<blockquote>
<p>“that = this; 作用域链保存this且指向”</p>
</blockquote>
<p>这是 ES5 时代的经典写法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> timer = {
  <span class="hljs-attr">seconds</span>: <span class="hljs-number">0</span>,
  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 保存 this 到变量</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      that.<span class="hljs-property">seconds</span>++; <span class="hljs-comment">// 通过闭包访问</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(that.<span class="hljs-property">seconds</span>);
    }, <span class="hljs-number">1000</span>);
  }
};
</code></pre>
<p>虽然有效，但需要额外变量，且在深层嵌套中容易混乱。<code>bind</code> 更加声明式和安全。</p>
<hr/>
<h2 data-id="heading-14">五、箭头函数：没有 this 的“佛系”函数</h2>
<h3 data-id="heading-15">核心特性</h3>
<p>箭头函数（Arrow Function）<strong>没有自己的 <code>this</code></strong>。它不会创建新的 <code>this</code> 上下文，而是<strong>词法地继承外层作用域的 <code>this</code></strong>。</p>
<blockquote>
<p>“Cherry箭头函数放弃了自己的this，没有this 指向指向 父级作用域的this”</p>
</blockquote>
<p>这句话堪称对箭头函数 <code>this</code> 行为的完美概括！</p>
<ul>
<li>“放弃了自己的 this” → 箭头函数内部不存在 <code>this</code> 绑定。</li>
<li>“指向父级作用域的 this” → 它的 <code>this</code> 由定义时的外层作用域决定，与调用方式无关。</li>
</ul>
<h3 data-id="heading-16">示例对比</h3>
<h4 data-id="heading-17">普通函数（this 丢失）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'David'</span>,
  <span class="hljs-title function_">delayedLog</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ❌ undefined</span>
    }, <span class="hljs-number">100</span>);
  }
};
obj.<span class="hljs-title function_">delayedLog</span>();
</code></pre>
<h4 data-id="heading-18">箭头函数（自动继承）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Cherry'</span>, <span class="hljs-comment">// 注意：原文特意用了 "Cherry"</span>
  <span class="hljs-title function_">delayedLog</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ✅ "Cherry"</span>
    }, <span class="hljs-number">100</span>);
  }
};
obj.<span class="hljs-title function_">delayedLog</span>();
</code></pre>
<p>为什么能成功？因为箭头函数的 <code>this</code> 继承自 <code>delayedLog</code> 方法，而 <code>delayedLog</code> 的 <code>this</code> 指向 <code>obj</code>。</p>
<h3 data-id="heading-19">箭头函数的不可变性</h3>
<p>由于箭头函数没有 <code>this</code>，所以以下操作无效：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fn</span> = () =&gt; console.log(this.name)<span class="hljs-comment">;</span>
const <span class="hljs-attr">obj</span> = { name: <span class="hljs-string">'Eve'</span> }<span class="hljs-comment">;</span>

fn.call(obj)<span class="hljs-comment">;   // 仍输出全局作用域的 name（或 undefined）</span>
fn.bind(obj)()<span class="hljs-comment">; // 同上</span>
</code></pre>
<p><code>call</code>、<code>apply</code>、<code>bind</code> 对箭头函数的 <code>this</code> <strong>毫无影响</strong>。</p>
<h3 data-id="heading-20">适用场景 vs 陷阱</h3>
<p>✅ <strong>适合</strong>：</p>
<ul>
<li>回调函数（如 <code>map</code>, <code>filter</code>, <code>setTimeout</code>）</li>
<li>避免 <code>that = this</code> 的样板代码</li>
</ul>
<p>❌ <strong>不适合</strong>：</p>
<ul>
<li>对象方法（会继承外层 this，可能不是对象本身）</li>
<li>构造函数（箭头函数不能用 <code>new</code> 调用）</li>
<li>需要动态 <code>this</code> 的场景</li>
</ul>
<hr/>
<h2 data-id="heading-21">六、综合案例：四种方式对比</h2>
<p>假设我们有一个计数器对象，需要在 1 秒后打印当前值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> counter = {
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  
  <span class="hljs-comment">// 方式1：普通函数 + that = this</span>
  <span class="hljs-title function_">method1</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method1:'</span>, self.<span class="hljs-property">count</span>);
    }, <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式2：bind</span>
  <span class="hljs-title function_">method2</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method2:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>);
    }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式3：箭头函数</span>
  <span class="hljs-title function_">method3</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method3:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>);
    }, <span class="hljs-number">1000</span>);
  },

  <span class="hljs-comment">// 方式4：call（需立即执行，不适合定时器，但可模拟）</span>
  <span class="hljs-title function_">method4</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> fn = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'method4:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>); };
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>); <span class="hljs-comment">// 结合箭头+call</span>
  }
};

counter.<span class="hljs-title function_">method1</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method2</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method3</span>(); <span class="hljs-comment">// 0</span>
counter.<span class="hljs-title function_">method4</span>(); <span class="hljs-comment">// 0</span>
</code></pre>
<p>四种方式都能正确输出，但<strong>箭头函数最简洁</strong>，<strong>bind 最显式</strong>，<strong>that = this 最传统</strong>。</p>
<hr/>
<h2 data-id="heading-22">七、this 绑定优先级总结</h2>
<p>当多个规则同时存在时，JavaScript 按以下优先级确定 <code>this</code>：</p>
<ol>
<li><strong>new 绑定</strong>（构造函数）→ 最高</li>
<li><strong>显式绑定</strong>（<code>call</code> / <code>apply</code> / <code>bind</code>）</li>
<li><strong>隐式绑定</strong>（对象方法调用，如 <code>obj.fn()</code>）</li>
<li><strong>默认绑定</strong>（独立函数调用）</li>
</ol>
<blockquote>
<p>箭头函数不参与此规则，因为它根本没有 <code>this</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">八、常见误区与最佳实践</h2>
<h3 data-id="heading-24">误区1：认为箭头函数总是更好</h3>
<p>错！箭头函数在对象方法中会导致 <code>this</code> 指向外层（可能是全局）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> badObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Bad'</span>,
  <span class="hljs-attr">getName</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> <span class="hljs-comment">// ❌ this 指向全局</span>
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(badObj.<span class="hljs-title function_">getName</span>()); <span class="hljs-comment">// undefined</span>
</code></pre>
<p>应使用普通函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> goodObj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Good'</span>,
  <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>; } <span class="hljs-comment">// ✅</span>
};
</code></pre>
<h3 data-id="heading-25">误区2：bind 后还能被 call 覆盖</h3>
<p>不能！<code>bind</code> 创建的函数其 <code>this</code> 是<strong>永久锁定</strong>的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>); }
<span class="hljs-keyword">const</span> bound = f.<span class="hljs-title function_">bind</span>({<span class="hljs-attr">x</span>: <span class="hljs-number">1</span>});
bound.<span class="hljs-title function_">call</span>({<span class="hljs-attr">x</span>: <span class="hljs-number">2</span>}); <span class="hljs-comment">// 输出 1，不是 2！</span>
</code></pre>
<h3 data-id="heading-26">最佳实践</h3>
<ul>
<li>在类方法或对象方法中，使用普通函数。</li>
<li>在回调、事件监听、定时器中，优先考虑箭头函数。</li>
<li>若需兼容旧环境或需要预设参数，使用 <code>bind</code>。</li>
<li>避免过度使用 <code>that = this</code>，除非在不支持箭头函数的环境中。</li>
</ul>
<hr/>
<h2 data-id="heading-27">九、结语：掌握 this，就是掌握 JavaScript 的灵魂</h2>
<p>现在，我们不仅读懂了它，更理解了其背后的技术哲学：</p>
<ul>
<li><strong><code>call</code>/<code>apply</code></strong> 是“命令式”的干预——我要你现在就用这个 <code>this</code>！</li>
<li><strong><code>bind</code></strong> 是“防御式”的设计——无论何时调用，都必须用这个 <code>this</code>！</li>
<li><strong><code>that = this</code></strong> 是“妥协式”的智慧——既然你靠不住，我就自己存一份！</li>
<li><strong>箭头函数</strong> 是“声明式”的优雅——我不需要 <code>this</code>，我信任我的上下文！</li>
</ul>
<p>JavaScript 的魅力，正在于这种灵活性与规则性的统一。当你能自如地在这些工具之间切换，你就不再是 <code>this</code> 的奴隶，而是它的主人。</p>
<p>愿你在未来的代码中，不再对 <code>this</code> 感到迷茫，而是微笑着说：</p>
<blockquote>
<p>“我知道你是谁，也知道你该去哪。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验]]></title>    <link>https://juejin.cn/post/7586208617603366946</link>    <guid>https://juejin.cn/post/7586208617603366946</guid>    <pubDate>2025-12-22T03:23:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586208617603366946" data-draft-id="7585888537642450959" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-22T03:23:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gohchunlin"/> <meta itemprop="url" content="https://juejin.cn/user/3491704660036302"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Kubernetes 上通过 .NET + Argo Workflows 实现大规模并行仿真实验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3491704660036302/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gohchunlin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:23:47.000Z" title="Mon Dec 22 2025 03:23:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近我处理了一个离散事件仿真（Discrete Event Simulation，DES）的项目，面临一个经典难题：代码逻辑完全正确，但运行速度慢到令人绝望。</p>
<p>如果按照传统的单机思路，完成一次可靠的蒙特卡洛（Monte Carlo）实验需要到 2026 年才能跑出结果。本文将分享我如何打利用 Kubernetes （K8s） 和 Argo Workflows 构建一套“仿真实验室”，实现算力跃升。</p>
<h2 data-id="heading-1">核心痛点：为什么“加 CPU”解决不了问题？</h2>
<p>在离散事件仿真中，系统的完整性依赖于一个<strong>统一的虚拟时钟</strong>和<strong>中央未来事件列表（Future Event List, FEL）</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/197ecf5cebc8414185371a5a5139fb12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=9FuJE1Ep44sZTIiI3o6yRJMnhIg%3D" alt="" loading="lazy"/></p>
<p>DES 的核心逻辑是严格按时间顺序处理事件。这意味着：</p>
<ul>
<li>你无法将单个仿真任务拆分到多个 Pod 上跑。</li>
<li>各节点间的网络延迟会彻底摧毁事件的因果链。</li>
<li><strong>结论：</strong> 单次仿真任务在架构上是<strong>天然单线程</strong>的。</li>
</ul>
<p>虽然我们无法并行化“单个仿真”，但我们可以并行化“整个实验”。这是一个典型的 <strong>“尴尬并行”（Embarrassingly Parallel）</strong> 场景。</p>
<h2 data-id="heading-2">架构设计：从“服务器”转向“实验室”</h2>
<p>为了解决 5,000 次参数扫频（Parameter Sweeps）的需求，我将 Kubernetes 从一个“托管网站的平台”转化为一台“按需使用的超级计算机”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52d10789b1b24dde827de9d864ee11ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=zm80z4Mqx9u6FbuSlCnVbaydhxw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">执行引擎：Headless .NET 10</h3>
<p>底层基于 .NET Console 程序，关键点在于利用 System.CommandLine 建立容器与编排器之间的<strong>严格契约</strong>。</p>
<p>我们将仿真变量设置为 CLI 参数。</p>
<pre><code class="hljs language-dart" lang="dart">using System.CommandLine;

<span class="hljs-comment">// 定义根命令</span>
<span class="hljs-keyword">var</span> rootCommand = <span class="hljs-keyword">new</span> RootCommand { Description = <span class="hljs-string">"离散事件仿真 CLI 工具"</span> };

<span class="hljs-comment">// 核心参数：平均到达时间</span>
<span class="hljs-keyword">var</span> meanArrivalSecondsOption = <span class="hljs-keyword">new</span> Option&lt;<span class="hljs-built_in">double</span>&gt;(
    name: <span class="hljs-string">"--arrival-secs"</span>,
    description: <span class="hljs-string">"Mean arrival time in seconds."</span>,
    getDefaultValue: () =&gt; <span class="hljs-number">5.0</span>
);

<span class="hljs-keyword">var</span> simpleServerCommand = <span class="hljs-keyword">new</span> Command(<span class="hljs-string">"simple-server"</span>, <span class="hljs-string">"运行仿真演示"</span>);
simpleServerCommand.AddOption(meanArrivalSecondsOption);

simpleServerCommand.SetHandler((<span class="hljs-built_in">double</span> meanArrivalSeconds) =&gt;
{
    <span class="hljs-comment">// 这里的逻辑是单线程的，但它是可配置的</span>
    SimpleServerAndGenerator.RunDemo(loggerFactory, meanArrivalSeconds);
}, meanArrivalSecondsOption);
</code></pre>
<h3 data-id="heading-4">任务编排：Argo Workflows</h3>
<p>很多人第一反应是使用原生 K8s Job。但在大规模场景下，原生 Job 太过简陋，难以可视化，且异常处理成本极高。</p>
<p>我选择了 <strong>Argo Workflows</strong>。它的杀手锏是 withItems（或 withParam），可以轻松实现<strong>扇出（Fan-out）</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">argoproj.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Workflow</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">generateName:</span> <span class="hljs-string">sna-parallel-experiment-</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">entrypoint:</span> <span class="hljs-string">sna-demo</span>
  <span class="hljs-attr">templates:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">sna-demo</span>
    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">run-simulation</span>
        <span class="hljs-attr">template:</span> <span class="hljs-string">simulation-job</span>
        <span class="hljs-attr">arguments:</span>
          <span class="hljs-attr">parameters:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">arrival-secs</span>, <span class="hljs-attr">value:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{item}}</span>"</span>}]
        <span class="hljs-comment"># 核心：定义参数池，Argo 会自动调度成百上千的 Pod 并发执行</span>
        <span class="hljs-attr">withItems:</span> [<span class="hljs-string">"5"</span>, <span class="hljs-string">"10"</span>, <span class="hljs-string">"15"</span>, <span class="hljs-string">"20"</span>, <span class="hljs-string">"25"</span>] 

  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">simulation-job</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-attr">parameters:</span> [{<span class="hljs-attr">name:</span> <span class="hljs-string">arrival-secs</span>}]
    <span class="hljs-attr">container:</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">my-registry/sna-demo:latest</span>
      <span class="hljs-attr">args:</span> [<span class="hljs-string">"demo"</span>, <span class="hljs-string">"simple-server"</span>, <span class="hljs-string">"--arrival-secs"</span>, <span class="hljs-string">"<span class="hljs-template-variable">{{inputs.parameters.arrival-secs}}</span>"</span>]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/276d08d3e8df4167811067428bc28dd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=V21tZI4TjxDMLIK6KcqmGE0Tce4%3D" alt="" loading="lazy"/></p>
<p>Argo 帮我们处理了节流（Throttling）、并发控制和失败重试，我们只需声明实验目标。</p>
<h3 data-id="heading-5">结构化日志</h3>
<p>当一千个 Pod 同时运行时，kubectl logs 毫无意义。我们所要面对的是每分钟数大量的文本流。</p>
<p>因此，我们必须弃用纯文本日志，改用 <strong>结构化日志 (Structured Logging)</strong>。通过 Serilog 将参数和结果绑定为 JSON：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-05-20T10:00:00"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Level"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Information"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Simulation Completed"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"WorkerCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ServiceTime"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12.5</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Throughput"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.98</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c7724ded21d4b06873313af21e0473e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=HllnWYa%2FFXwdWVDHWfE1caaaHJk%3D" alt="" loading="lazy"/></p>
<p>配合 <strong>Seq</strong> 或 <strong>ELK</strong>，我们就可以直接通过 SQL 语句在几万份实验结果中精准定位异常点。</p>
<h2 data-id="heading-6">实战复盘</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a022624743dc46329e69c114b26353d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29oY2h1bmxpbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978627&amp;x-signature=286usV3R9RNVSKwDuvb%2BFWBya2Q%3D" alt="" loading="lazy"/></p>
<p>在最近的台北 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fhwdc.ithome.com.tw%2F2025%2Fsession-page%2F4063" target="_blank" title="https://hwdc.ithome.com.tw/2025/session-page/4063" ref="nofollow noopener noreferrer">Hello World Developer Conference 2025</a></strong> 上，我也分享了这一模型。通过这套架构：</p>
<ol>
<li><strong>开发效率：</strong> C# 核心逻辑无需任何分布式改造。</li>
<li><strong>算力利用：</strong> 以前单机跑一周的实验，现在在 K8s 集群上 10 分钟内跑完。</li>
<li><strong>可维护性：</strong> 所有的实验参数都是声明式的，可追溯、可重现。</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<p>Kubernetes 的强大不仅在于托管微服务，更在于它处理<strong>大规模并发计算</strong>的能力。通过将“执行引擎”与“编排大脑”解耦，我们能让老旧的单线程程序在云原生时代焕发新生。</p>
<p><strong>项目开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgcl-team%2FSNA**" target="_blank" title="https://github.com/gcl-team/SNA**" ref="nofollow noopener noreferrer">github.com/gcl-team/SN…</a> (欢迎交流指正)</p>
<p>--------</p>
<p><em>作者简介：坐标新加坡，20年架构/SRE经验。专注可观测性 (O11y) 与系统稳定性。Grafana &amp; Friends SG 社区主理人。 业余项目：正在开发 SNA。试图用算法模拟高并发场景下的排队论与系统瓶颈（用 AI 辅助构建）。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[利用 WebMKS 和 Java 实现前端访问虚拟机网页]]></title>    <link>https://juejin.cn/post/7586157459971538996</link>    <guid>https://juejin.cn/post/7586157459971538996</guid>    <pubDate>2025-12-22T02:55:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459971538996" data-draft-id="7585850609017110543" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="利用 WebMKS 和 Java 实现前端访问虚拟机网页"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T02:55:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="404NotFound305"/> <meta itemprop="url" content="https://juejin.cn/user/270910253182796"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            利用 WebMKS 和 Java 实现前端访问虚拟机网页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/270910253182796/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    404NotFound305
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:55:56.000Z" title="Mon Dec 22 2025 02:55:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">实战干货：手把手教你用 WebMKS 和 Java 搞定 ESXi 虚拟机网页控制台</h2>
<p>最近在折腾虚拟机网页控制台，发现用 VMware 原生的 WebMKS SDK 配合 ESXi 的 API 效果最好。这套方案不用装插件，直接在浏览器里就能操作。把中间踩过的坑和实现逻辑整理出来，希望能帮到大家。</p>
<hr/>
<h3 data-id="heading-1">1. 准备工作：依赖得放本地</h3>
<p>WebMKS 这个 SDK 比较老派，它离不开 <strong>jQuery</strong>。为了稳妥，别用 CDN，直接把这几个文件下载下来放到你项目的 <code>public/static/wmks</code> 目录下。</p>
<h4 data-id="heading-2">怎么引入？</h4>
<p>在 <code>index.html</code> 里按这个顺序排好，jQuery 必须在最前面，不然 SDK 报错。</p>
<p>HTML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/static/wmks/css/wmks-all.css"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/jquery.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/jquery-ui.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/static/wmks/wmks.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">2. 后端：Java 怎么拿 Ticket</h3>
<p>控制台连接前得先要个“门票”（Ticket）。后端用 Java 调用官方的 <code>vijava</code> 库，去 ESXi 那里申请一个。</p>
<p><strong>核心逻辑：</strong></p>
<ol>
<li>连上 ESXi。</li>
<li>靠 UUID 找到那台虚拟机。</li>
<li>申请一个类型叫 <code>webmks</code> 的票据。</li>
</ol>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> TicketInfo <span class="hljs-title function_">getVmTicket</span><span class="hljs-params">(String host, String user, String pwd, String vmUuid)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 建立连接</span>
    <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">si</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceInstance</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">"https://"</span> + host + <span class="hljs-string">"/sdk"</span>), user, pwd, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">InventoryNavigator</span> <span class="hljs-variable">nav</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryNavigator</span>(si.getRootFolder());
        <span class="hljs-type">VirtualMachine</span> <span class="hljs-variable">vm</span> <span class="hljs-operator">=</span> (VirtualMachine) nav.searchManagedEntity(<span class="hljs-string">"VirtualMachine"</span>, vmUuid);
        
        <span class="hljs-comment">// 关键：拿 webmks 票据</span>
        <span class="hljs-type">VirtualMachineTicket</span> <span class="hljs-variable">vmt</span> <span class="hljs-operator">=</span> vm.acquireTicket(<span class="hljs-string">"webmks"</span>);
        
        <span class="hljs-comment">// 把票据、主机IP、端口发给前端</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TicketInfo</span>(vmt.getTicket(), vmt.getHost(), <span class="hljs-number">443</span>);
    } <span class="hljs-keyword">finally</span> {
        si.getServerConnection().logout(); <span class="hljs-comment">// 记得退出登录，不然会话堆积</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-4">3. 前端：Vue 3 里的核心控制</h3>
<h4 data-id="heading-5">初始化连接</h4>
<p>在 Vue 里的思路是：拿到票据后，立刻初始化 SDK 并连上 WebSocket。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">startWMKS</span> = (<span class="hljs-params">ticket: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WMKS_LIB</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">WMKS</span>;
  
  <span class="hljs-comment">// 初始化配置</span>
  wmksInstance.<span class="hljs-property">value</span> = <span class="hljs-variable constant_">WMKS_LIB</span>.<span class="hljs-title function_">createWMKS</span>(<span class="hljs-string">"wmks-container"</span>, {
    <span class="hljs-attr">enableHints</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">changeResolutionOnResizing</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 窗口变了，分辨率也跟着变</span>
    <span class="hljs-attr">rescaleOnParentResize</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 自动缩放</span>
    <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>
  });

  <span class="hljs-comment">// 连上 ESXi 的 443 端口</span>
  wmksInstance.<span class="hljs-property">value</span>.<span class="hljs-title function_">connect</span>(<span class="hljs-string">`wss://<span class="hljs-subst">${activeVM.value.host}</span>:443/ticket/<span class="hljs-subst">${ticket}</span>`</span>);
};
</code></pre>
<h4 data-id="heading-6">全屏怎么变清晰？</h4>
<p>全屏时如果直接拉伸，画面会糊。我的办法是：<strong>先断开，变全屏，再重连</strong>。虽然多等了半秒，但画面会根据全屏后的尺寸重新协商，清晰度瞬间提升。</p>
<hr/>
<h3 data-id="heading-7">4. Windows 虚拟机的专项关照</h3>
<p>搞 Linux 基本没啥事，但 Windows 挺挑剔，这几点没做到肯定出问题：</p>
<ol>
<li><strong>必装 VMware Tools</strong>：不装的话，显卡驱动不行，画面传输慢甚至直接黑屏。</li>
<li><strong>显存给够</strong>：Windows 10 这种系统，显存起码给到 <strong>128MB</strong>。</li>
<li><strong>CAD 按钮</strong>：Windows 登录得按 <code>Ctrl+Alt+Del</code>。网页里按没用，必须给用户做个按钮调用 <code>wmksInstance.sendCAD()</code>。</li>
</ol>
<hr/>
<h3 data-id="heading-8">5. 样式：别留白边</h3>
<p>为了让黑色背景铺满整个弹窗，CSS 得这么写：</p>
<p>SCSS</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 弹窗样式 */</span>
:<span class="hljs-built_in">deep</span>(.vnc-session-dialog) {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span> <span class="hljs-meta">!important</span>;

  <span class="hljs-comment">/* 全屏模式强行占满 */</span>
  &amp;<span class="hljs-selector-class">.is-fullscreen</span> { 
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-selector-class">.el-dialog__body</span> { <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">flex-direction</span>: column; }
  }

  <span class="hljs-comment">/* 核心：让 body 自动撑开 */</span>
  <span class="hljs-selector-class">.el-dialog__body</span> {
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">总结一下</h3>
<p>做这玩意儿逻辑其实不难，关键在于细节：</p>
<ul>
<li><strong>顺序</strong>：jQuery 必须先引。</li>
<li><strong>时机</strong>：全屏重连能解决画面糊的问题。</li>
<li><strong>补丁</strong>：给 Windows 留个 CAD 按钮，装好 VMware Tools。</li>
</ul>
<p>只要这几点对齐了，剩下的就是调 UI 让它看着更顺手的事儿了。
最后放上图片和源码</p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vnc-app-wrapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"page-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"brand"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"28"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"#409eff"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Monitor</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>VMware 虚拟化资源管理<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-grid"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(vm, index) in vmList"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-mini-card"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-status-bar"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"vm.status"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-card-body"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-icon"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Platform</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"vm.os === 'windows'"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Cpu</span> <span class="hljs-attr">v-else</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-details"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-name"</span>&gt;</span>{{ vm.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-ip"</span>&gt;</span>{{ vm.host }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-actions"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">plain</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"openConsole(vm)"</span>&gt;</span>
              连接控制台
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"vm-footer"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>UUID: {{ vm.vmUuid.substring(0, 14) }}...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">el-dialog</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"vncDialogVisible"</span> 
      <span class="hljs-attr">:fullscreen</span>=<span class="hljs-string">"isFullscreen"</span>
      <span class="hljs-attr">:width</span>=<span class="hljs-string">"isFullscreen ? '100%' : '1100px'"</span> 
      <span class="hljs-attr">top</span>=<span class="hljs-string">"5vh"</span>
      <span class="hljs-attr">:draggable</span>=<span class="hljs-string">"true"</span>
      <span class="hljs-attr">:show-close</span>=<span class="hljs-string">"false"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"vnc-session-dialog"</span>
      <span class="hljs-attr">:before-close</span>=<span class="hljs-string">"handleCloseVNC"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-header drag-area"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-info"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-indicator"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"connectionClass"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-name"</span>&gt;</span>
              {{ activeVM?.name }} | {{ activeVM?.host }}
            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"session-controls"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendCAD"</span>&gt;</span>CAD<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleFullscreen"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"16"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">FullScreen</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!isFullscreen"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">CopyDocument</span> <span class="hljs-attr">v-else</span> /&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span> <span class="hljs-attr">link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"danger"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleCloseVNC"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"16"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">Close</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
        <span class="hljs-attr">class</span>=<span class="hljs-string">"session-stage"</span> 
        <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"reloading"</span> 
        <span class="hljs-attr">element-loading-background</span>=<span class="hljs-string">"rgba(0, 0, 0, 0.9)"</span>
        <span class="hljs-attr">element-loading-text</span>=<span class="hljs-string">"正在重构画面..."</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"wmks-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-dialog</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { ref, nextTick, computed, onBeforeUnmount } from 'vue'
import { ElMessage } from 'element-plus'
import { Monitor, FullScreen, Close, CopyDocument, Platform, Cpu } from '@element-plus/icons-vue'
import { getVmConsoleTicket } from '@/api/taskManagement/vmConsole'


const vmList = ref([
  { 
    name: 'Windows-测试机', 
    host: '', 
    username: '', 
    password: '', 
    vmUuid: '',
    os: 'windows',
    status: 'online'
  },
  { 
    name: 'Linux-生产机', 
    host: '', 
    username: '', 
    password: '', 
    vmUuid: '',
    os: 'linux',
    status: 'online'
  }
])

const activeVM = ref&lt;any&gt;(null)
const vncDialogVisible = ref(false)
const isFullscreen = ref(false)
const reloading = ref(false)
const vncStatus = ref('disconnected')
const wmksInstance = ref&lt;any&gt;(null)

const connectionClass = computed(() =&gt; ({
  'is-connecting': vncStatus.value === 'connecting',
  'is-connected': vncStatus.value === 'connected'
}))


const openConsole = (vm: any) =&gt; {
  activeVM.value = vm;
  handleConnect(false);
}

const toggleFullscreen = async () =&gt; {
  reloading.value = true;
  if (wmksInstance.value) {
    wmksInstance.value.disconnect();
    wmksInstance.value.destroy();
    wmksInstance.value = null;
  }
  isFullscreen.value = !isFullscreen.value;
  await nextTick();
  setTimeout(async () =&gt; {
    try { await handleConnect(true); } finally { reloading.value = false; }
  }, 500);
}

const handleConnect = async (isRetry = false) =&gt; {
  const win = window as any;
  if (!win.WMKS) return ElMessage.error("SDK 未加载");

  try {
    vncStatus.value = 'connecting';
    if (!isRetry) vncDialogVisible.value = true;

    const res = await getVmConsoleTicket({
      host: activeVM.value.host,
      username: activeVM.value.username,
      password: activeVM.value.password,
      vmUuid: activeVM.value.vmUuid
    });
    
    const ticket = res.data?.ticket || res.ticket || res;
    await nextTick();
    startWMKS(ticket);
  } catch (err) {
    ElMessage.error("Ticket 申请失败，请检查机房连接");
    vncStatus.value = 'disconnected';
  }
}

const startWMKS = (ticket: string) =&gt; {
  const WMKS_LIB = (window as any).WMKS;
  wmksInstance.value = WMKS_LIB.createWMKS("wmks-container", {
    enableHints: true,
    useVNCHandshake: false,
    changeResolutionOnResizing: true,
    rescaleOnParentResize: true,
    position: 'absolute'
  });
  
  wmksInstance.value.register(WMKS_LIB.CONST.Events.CONNECTION_STATE_CHANGE, (evt: any, data: any) =&gt; {
    if (data.state === WMKS_LIB.CONST.ConnectionState.CONNECTED) {
      vncStatus.value = 'connected';
    }
  });

  wmksInstance.value.connect(`wss://${activeVM.value.host}:443/ticket/${ticket}`);
}

const sendCAD = () =&gt; wmksInstance.value?.sendCAD();
const handleCloseVNC = () =&gt; {
  if (wmksInstance.value) {
    wmksInstance.value.disconnect();
    wmksInstance.value.destroy();
    wmksInstance.value = null;
  }
  vncDialogVisible.value = false;
  isFullscreen.value = false;
  vncStatus.value = 'disconnected';
}

onBeforeUnmount(handleCloseVNC);
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
.vnc-app-wrapper {
  padding: 40px;
  background-color: #f8fafc;
  min-height: 100vh;
}

.page-header {
  max-width: 1200px;
  margin: 0 auto 40px;
  .brand {
    display: flex; align-items: center; gap: 12px;
    h1 { font-size: 22px; color: #334155; margin: 0; }
  }
}

.vm-grid {
  max-width: 1200px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 24px;
}

.vm-mini-card {
  background: #fff; border-radius: 12px; overflow: hidden;
  border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
  transition: transform 0.2s;
  &amp;:hover { transform: translateY(-4px); }

  .vm-status-bar { 
    height: 4px; background: #cbd5e1;
    &amp;.online { background: #10b981; }
  }
  
  .vm-card-body {
    padding: 24px; display: flex; flex-direction: column; align-items: center;
    .vm-icon {
      font-size: 32px; color: #3b82f6; margin-bottom: 16px;
      padding: 12px; background: #eff6ff; border-radius: 12px;
    }
    .vm-name { font-size: 17px; font-weight: 600; color: #1e293b; margin: 0 0 4px; }
    .vm-ip { font-size: 13px; color: #64748b; margin-bottom: 24px; }
    .vm-actions { width: 100%; .el-button { width: 100%; } }
  }

  .vm-footer {
    padding: 12px 20px; background: #f8fafc; border-top: 1px solid #f1f5f9;
    font-size: 11px; color: #94a3b8; font-family: ui-monospace, SFMono-Regular;
  }
}

:deep(.vnc-session-dialog) {
  display: flex; flex-direction: column;
  background: #000 !important; border-radius: 12px; overflow: hidden;
  
  .el-dialog__header {
    padding: 0 !important;
    margin: 0 !important;
    height: 50px;
    cursor: move; 
  }

  .el-dialog__body {
    flex: 1; display: flex; flex-direction: column;
    padding: 0 !important;
  }
  
  &amp;.is-fullscreen { border-radius: 0; }
}

.session-header {
  height: 50px; background: #1e293b; padding: 0 20px;
  display: flex; justify-content: space-between; align-items: center;
  
  .session-info {
    display: flex; align-items: center; gap: 10px;
    pointer-events: none; 
    .status-indicator { 
      width: 8px; height: 8px; border-radius: 50%; background: #64748b;
      &amp;.is-connected { background: #10b981; box-shadow: 0 0 8px #10b981; }
    }
    .session-name { color: #f1f5f9; font-size: 14px; font-weight: 500; }
  }
  
  .session-controls {
    pointer-events: auto;
    display: flex; align-items: center; gap: 10px;
    .divider { width: 1px; height: 16px; background: #334155; }
    .el-button { color: #94a3b8; &amp;:hover { color: #fff; } }
  }
}

.session-stage {
  flex: 1; width: 100%; min-height: 600px;
  background: #000; position: relative;
  #wmks-container { width: 100% !important; height: 100% !important; position: absolute; }
}

:deep(.el-dialog__headerbtn) { display: none; }
&lt;/style&gt;
</code></pre>
<p>这是index.html下面需要引入的内容</p>
<pre><code class="hljs language-js" lang="js">    &lt;link rel=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"/WebMKS_SDK_2.2.0/css/wmks-all.css"</span>&gt;

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://code.jquery.com/jquery-3.6.0.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
    
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'JQuery Check:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">fn</span>.<span class="hljs-property">jquery</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/jquery-ui.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/WebMKS_SDK_2.2.0/wmks.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span> &amp;&amp; (<span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">ui</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">jQuery</span>.<span class="hljs-property">widget</span>)) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Result: jQuery UI is fully loaded and attached to jQuery.'</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Result: jQuery UI failed to attach to window.jQuery!'</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaddee8e7016447088ca752d2d4960da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgNDA0Tm90Rm91bmQzMDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976955&amp;x-signature=4yNg4PNckCnrq4fr35duMAE5rx4%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪]]></title>    <link>https://juejin.cn/post/7586482851098165288</link>    <guid>https://juejin.cn/post/7586482851098165288</guid>    <pubDate>2025-12-22T03:25:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851098165288" data-draft-id="7585948869844795427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪"/> <meta itemprop="keywords" content="前端,后端,前端框架"/> <meta itemprop="datePublished" content="2025-12-22T03:25:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            插件开发实录：我用Comate在VS Code里造了一场“能被代码融化”的初雪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:25:58.000Z" title="Mon Dec 22 2025 03:25:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年的第一场雪，我是在报错日志里度过的😭</p>
<p>朋友圈在晒雪景，我在盯着 VS Code 万年不变的界面发呆。</p>
<p>既然错过了现实里的初雪，那我为什么不能在我的 IDE 里下一场雪？</p>
<p>于是，一个极其离谱又带感的脑洞诞生了——我想做一个VS Code插件，实现：</p>
<ul>
<li>落雪：当我停下来思考或者单纯摸鱼时，让屏幕飘落初雪，积雪慢慢覆盖代码，假装我也在过冬。</li>
<li>燃火：一旦我开始狂修 Bug，指尖的每一次敲击都要在屏幕底部点燃烈火。手速越快，火势越旺，甚至要让火星子溅满整个屏幕，主打一个物理取暖和辛劳可视化。</li>
<li>互动：圣诞节快到了，在没有操作的时候，跳出NPC和我互动，增添圣诞氛围。</li>
</ul>
<p>想法很丰满，现实很骨感。</p>
<p>要在 VS Code 极其受限的 Webview 环境里，同时跑通物理积雪堆叠算法和 Doom Fire 火焰渲染，还要保证不卡顿，这对我这个只有碎片时间的开发者来说，简直是降维打击。</p>
<p>好在，这个冬天，虽然没有女朋友暖手，但我有随叫随到的 文心快码（Comate） 暖心🐶</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f6018bc8df3430d9ea0a86424d2cf2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=qsGAUFFmMbRqdHUD16zveDlvSdE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">01 智能规划：从一句话需求到 MVP落地</h2>
<p>﻿项目启动阶段，我面临的最大挑战是架构设计。VS Code 插件开发涉及 Extension 主进程与 Webview 渲染进程的通信，配置繁琐且容易出错。这次我没有直接写代码，而是使用了 Comate 的 Spec 模式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d85396cb8fcc40cd8fc933d50ca1d759~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=RwlFV%2B3qe7DhHPyB4e9vLnO2fjE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我向 Comate 抛出了我的核心构想：</p>
<blockquote>
<p>“我要做一个 VS Code 插件，核心逻辑是监听键盘输入。输入频率高时底部渲染火焰，闲置时顶部下雪并积雪。请帮我设计架构并生成代码。”</p>
</blockquote>
<p>Comate 迅速进入了需求分析模式，几秒钟后，它返还了一份结构完整的 FrostFire 插件需求文档。我仔细审视了这份文档，发现大框架非常完美，逻辑层和渲染层分得清清楚楚。</p>
<p>插件需求文档见文章末尾【附录1】</p>
<p>为了把错误拦截在开发之前，我基于这份文档进行了一些微调：</p>
<ul>
<li>package.json：我补充了 activationEvents 配置，确保插件在打开任何文件时都能自动激活，而不仅仅是特定语言。</li>
<li>src/webview/index.html：我特别强调了要配置 CSP 策略，并将背景强制设为纯黑，以配合 Canvas 的渲染效果。</li>
</ul>
<p>确认修改后，Comate 自动根据需求文档拆解出了具体的开发任务列表（Tasks），从环境配置到核心算法实现，条理清晰。</p>
<p>插件开发任务计划见文章末尾【附录2】</p>
<p>随着一个个 Task 被自动执行，仅仅10分钟，FrostFire 的 V1.0 版本（MVP）诞生了。</p>
<p>生成完毕后，Comate还给出了贴心的下一步引导，清晰地告诉了我们如何迁移到VS Code里使用插件⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df89bc9d45c24cb2b71654509a4e2e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=5iu8bNfYhcCEmbUt2eEbyEMeofg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我打开VS Code，按照它说的一步步做，屏幕上真的燃起了火焰！</p>
<p>👉观看燃起火焰效果视频<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<p>对了，VS Code里也支持文心快码插件～插件市场搜索文心快码，即可下载～</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7813a94ce9f4c96b9190fbda78d6255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=GntUHX9i3D%2BWa2vu7qOZE9G6Q18%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>文心快码插件下载下来后，会自动出生在左边，有点和文件目录重合了。没关系，我们可以点击左侧项目栏中文心快码标识，把它拖到右边</p>
<p>👉观看具体操作视频<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<h2 data-id="heading-1">02 核心维稳：用“记忆”根除鬼火Bug</h2>
<p>然而，V1 版本很快暴露出了严重的稳定性问题——幽灵火。</p>
<p>症状非常诡异：</p>
<ol>
<li>有时候我明明双手离开了键盘，屏幕上的火却突然烧了起来。</li>
<li>刚打开 VS Code，还没开始工作，火焰就直接铺满了屏幕。</li>
</ol>
<p>经过排查，原来是后端的心跳包和自动保存机制干扰了 idleTime 的计算，导致系统误判我有输入。</p>
<p>为了解决这个问题，我与 Comate 进行了多次深度的 Debug 交互。最终，我们共同制定了一套基于趋势判定的“安全栓”逻辑：只有当监测到闲置时间出现骤降（时间倒流）时，才认定为有效输入，绝不能仅依赖数值大小来判断。</p>
<p>这段逻辑非常关键，为了防止在未来的迭代中 Comate 忘记这个核心规则，我使用了 Comate 的 Memory（记忆） 功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32661a4995e4cf6abbbbbb72ccabdb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=aMzE9hexqU1vd7DooVSmpCp266A%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>我在 Memory 设置中手动录入了一条核心指令：</p>
<blockquote>
<p>“在 FrostFire 项目中，必须始终保留基于‘安全栓’（如 hasWitnessedDrop 变量）的逻辑：只有当检测到 idleTime 确实发生下降（current &lt; prev）时才允许解锁点火功能，绝对不能仅依赖 idleTime的绝对数值来判定打字状态，以防止‘刚打开或静止时自动起火’的 Bug 复发。”</p>
</blockquote>
<p>这一步操作至关重要。 从此之后，无论我要求 Comate 如何重构代码，它都会死死守住这条“安全底线”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c89006bc7dbc4376b7defcdd09d114af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=mfalusOizTnIuGjgy1mIXl4mnZ4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当 Comate 生成了最终修复版的代码后，我点击了对话框下方的 “赞” 按钮反馈了满意度，并使用了 “全文复制”功能，一键将这段复杂的逻辑同步到了我的项目中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e5200c18e0d4d49a8a198abe647182c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=iHTCJqaboYuHTAJ0L9AhxhNuMsA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-2">03 迭代开发：从“能用”到“惊艳”</h2>
<p>搞定了稳定性之后，FrostFire 虽然能跑了，但看起来还很廉价。我决定给它注入灵魂，开启了三次关键的迭代。</p>
<h3 data-id="heading-3">迭代一：挑战“物理积雪”算法</h3>
<p>我希望雪花落下时，能像真实的沙堆一样，形成中间高、两边低的自然坡度，而不是像水一样平铺。但这需要编写复杂的“休止角”算法，涉及大量的数据结构计算。</p>
<p>我向 Comate 描述了需求：</p>
<blockquote>
<p>“我需要积雪堆叠的感觉，最高堆叠到屏幕最上方。”</p>
</blockquote>
<p>Comate 完美执行了我的指令。它在 snowEffect.js 中重构了数据结构，引入了一个双向平滑算法。 现在的积雪，不仅有自然的起伏，甚至能把代码编辑器底部的状态栏慢慢“埋”起来，那种沉浸感简直绝了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/457d367cd28e45b58ba3895ec021962b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=lvkEZk3x9Ufxk9c7N66JMFoaMi8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-4">迭代二：手感调优与温和模式</h3>
<p>V1 的火焰太暴躁了，稍微打几个字就满屏火光。我希望它能更优雅一些，引入一种温和模式：平时只是小火苗，只有在疯狂输出时才会有火星四溅的效果。而且，单纯的“不打字下雪，打字起火”太生硬了。我想要一种线性的对抗感。</p>
<p>怕智能体乱改改错，我换成了Ask智能体，觉得AI说的有道理，就点插入，代码就自动插入到了我的光标位置，体验感十分丝滑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62213cd3f4fe4cda8f256dfa4c2a6fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=m8qfuWaj27K%2BZbmOJ7B3Q732460%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-5">迭代三：节日限定的浪漫</h3>
<p>既然是圣诞特供，怎么能少了节日气氛？</p>
<p>我给 Comate 下达了新的增量需求：</p>
<blockquote>
<p>“我需要增加两个彩蛋。第一，当积雪变厚时，雪地里要钻出一个雪人；一旦我开始打字起火，雪人要表现得很惊恐并逃跑。第二，在火势旺盛时，偶尔要有圣诞老人坐雪橇飞过，投递礼物。”</p>
</blockquote>
<p>Comate 的表现令人惊喜：</p>
<ul>
<li>怕热的雪人：它设计了一个简易的状态机。雪人平时在发呆，检测到热量上升时，会绘制出流汗和颤抖的动画，并加速移出屏幕。</li>
<li>圣诞空投：它完美实现了雪橇的飞行轨迹和礼物盒的物理抛物线。</li>
</ul>
<p>最让我感动的是，Comate 还记得我之前的 Memory。在实现这些新功能时，它依然严格遵守了“安全栓”逻辑，确保雪人和圣诞老人不会因为误触而乱跑。</p>
<p>最后，让我们一起来看看最终版本视频🤩：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzDAbDvEc-2-8yKNBEeY86A" target="_blank" title="https://mp.weixin.qq.com/s/zDAbDvEc-2-8yKNBEeY86A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/zDAbDvEc-…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce901f063c1843b2ad31cbc12418556c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978758&amp;x-signature=tvXwEXmdcTtd4zzbWJOJ8sCSOG4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-6">04 总结：AI 时代的开发新范式</h2>
<p>回看 FrostFire 的开发历程，从解决底层的“幽灵火”逻辑漏洞，到实现细腻的物理积雪，再到充满创意的圣诞彩蛋，文心快码（Comate） 展现出的能力远超一个代码补全工具。</p>
<ul>
<li>Spec 模式 让架构设计不再是难题，将我的抽象想法快速转化为可执行的代码框架。</li>
<li>Memory 机制 解决了 AI 容易“遗忘上下文”的痛点，让它成为了一个越用越懂我的专属工程师。</li>
<li>流畅的交互体验（如可编辑输入、一键复制）则极大地降低了沟通成本，让开发过程如丝般顺滑。</li>
</ul>
<p>现在的 FrostFire，已经不仅仅是一个插件，它是我在 Comate 协助下，送给自己和所有开发者的一份冬日礼物。</p>
<p>在这个项目中，我只需负责构想和决策，而那些繁琐的实现细节，全部交给了 AI。</p>
<p>如果你也想体验这种心想事成的开发快感，不妨试试让文心快码成为你的AI编程助手。或许你的下一个脑洞，就是下一个爆款。</p>
<h2 data-id="heading-7">【附录1】插件需求文档</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># FrostFire VS Code 插件需求文档</span>

<span class="hljs-comment">## 1. 项目概述</span>

**FrostFire** 是一个增加编程趣味性的 VS Code 视觉增强插件，通过在编辑器中渲染动态视觉效果（火焰和雪花），让编程体验更加生动有趣。

<span class="hljs-comment">## 2. 核心功能</span>

<span class="hljs-comment">### 2.1 Fire 状态（火焰效果）</span>
- **触发条件**：用户键盘输入频率（Keystrokes per minute, KPM）较高时触发
- **视觉效果**：编辑器底部渲染像素风格火焰（基于 Doom Fire Algorithm）
- **动态响应**：输入越快，火焰越高越旺盛
- **热度计算**：根据最近一段时间内的按键频率计算"热度值"

<span class="hljs-comment">### 2.2 Ice 状态（雪花效果）</span>
- **触发条件**：用户停止输入超过 15 秒
- **视觉效果**：编辑器顶部开始下雪
- **积雪机制**：停止输入超过 60 秒后，雪花在底部积累形成积雪层
- **遮挡效果**：积雪可轻微遮挡代码区域，增强沉浸感

<span class="hljs-comment">### 2.3 状态切换</span>
- Fire 和 Ice 状态互斥，不会同时出现
- 用户开始输入时，雪花效果逐渐消失，火焰效果逐渐出现
- 状态切换有平滑过渡动画

<span class="hljs-comment">## 3. 技术架构</span>

<span class="hljs-comment">### 3.1 技术栈</span>
- **语言**：TypeScript
- **API**：VS Code Extension API
- **渲染**：HTML5 Canvas（在 Webview 中运行）

<span class="hljs-comment">### 3.2 项目目录结构</span>
```
frostfire/
├── .vscode/
│   └── launch.json              <span class="hljs-comment"># 调试配置</span>
├── src/
│   ├── extension.ts             <span class="hljs-comment"># 插件入口，注册命令和监听器</span>
│   ├── activityTracker.ts       <span class="hljs-comment"># 用户活跃度追踪器</span>
│   ├── webviewProvider.ts       <span class="hljs-comment"># Webview 面板管理</span>
│   └── webview/
│       ├── index.html           <span class="hljs-comment"># Webview HTML 模板</span>
│       ├── main.js              <span class="hljs-comment"># Webview 主逻辑</span>
│       ├── fireEffect.js        <span class="hljs-comment"># Doom Fire 火焰算法实现</span>
│       └── snowEffect.js        <span class="hljs-comment"># 雪花和积雪效果实现</span>
├── package.json                 <span class="hljs-comment"># 插件配置清单</span>
├── tsconfig.json                <span class="hljs-comment"># TypeScript 配置</span>
└── README.md                    <span class="hljs-comment"># 项目说明</span>
```

<span class="hljs-comment">### 3.3 架构设计</span>

```
┌─────────────────────────────────────────────────────────────┐
│                     VS Code Extension Host                   │
├─────────────────────────────────────────────────────────────┤
│  extension.ts                                                │
│  ┌─────────────────┐    ┌──────────────────┐                │
│  │ ActivityTracker │───▶│ WebviewProvider  │                │
│  │ - 监听文档变化   │    │ - 管理 Webview   │                │
│  │ - 计算热度值     │    │ - 发送状态消息    │                │
│  │ - 判断状态切换   │    │                  │                │
│  └─────────────────┘    └────────┬─────────┘                │
│                                  │ postMessage               │
└──────────────────────────────────┼──────────────────────────┘
                                   ▼
┌─────────────────────────────────────────────────────────────┐
│                        Webview (Canvas)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌──────────────────┐                │
│  │   FireEffect    │    │   SnowEffect     │                │
│  │ - Doom Fire算法  │    │ - 雪花粒子系统   │                │
│  │ - 火焰高度控制   │    │ - 积雪累积逻辑   │                │
│  └─────────────────┘    └──────────────────┘                │
│                    main.js (消息调度)                        │
└─────────────────────────────────────────────────────────────┘
```

<span class="hljs-comment">## 4. 实现细节</span>

<span class="hljs-comment">### 4.1 ActivityTracker（活跃度追踪器）</span>

```typescript
// src/activityTracker.ts
export class ActivityTracker {
    private keystrokeTimestamps: number<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;  // 记录按键时间戳</span>
    private readonly <span class="hljs-attr">WINDOW_SIZE</span> = <span class="hljs-number">60000</span><span class="hljs-comment">;         // 统计窗口：60秒</span>
    private readonly <span class="hljs-attr">IDLE_THRESHOLD</span> = <span class="hljs-number">15000</span><span class="hljs-comment">;      // 空闲阈值：15秒</span>
    private readonly <span class="hljs-attr">SNOW_ACCUMULATE_THRESHOLD</span> = <span class="hljs-number">60000</span><span class="hljs-comment">; // 积雪阈值：60秒</span>
    
    // 记录一次按键
    public recordKeystroke(): void {
        const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
        this.keystrokeTimestamps.push(now)<span class="hljs-comment">;</span>
        this.cleanOldTimestamps(now)<span class="hljs-comment">;</span>
    }
    
    // 清理过期的时间戳
    private cleanOldTimestamps(now: number): void {
        <span class="hljs-attr">this.keystrokeTimestamps</span> = this.keystrokeTimestamps.filter(
            <span class="hljs-attr">ts</span> =&gt; now - ts &lt; this.WINDOW_SIZE
        )<span class="hljs-comment">;</span>
    }
    
    // 计算当前热度值 (0-100)
    public getHeatLevel(): number {
        const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
        this.cleanOldTimestamps(now)<span class="hljs-comment">;</span>
        // 基于最近10秒的按键数计算热度
        const <span class="hljs-attr">recentKeystrokes</span> = this.keystrokeTimestamps.filter(
            <span class="hljs-attr">ts</span> =&gt; now - ts &lt; <span class="hljs-number">10000</span>
        ).length<span class="hljs-comment">;</span>
        // 假设每秒6次按键为满热度
        return Math.min(100, (recentKeystrokes / 60) * 100)<span class="hljs-comment">;</span>
    }
    
    // 获取空闲时间（毫秒）
    public getIdleTime(): number {
        if (<span class="hljs-attr">this.keystrokeTimestamps.length</span> === <span class="hljs-number">0</span>) return Infinity<span class="hljs-comment">;</span>
        const <span class="hljs-attr">lastKeystroke</span> = Math.max(...this.keystrokeTimestamps)<span class="hljs-comment">;</span>
        return Date.now() - lastKeystroke<span class="hljs-comment">;</span>
    }
    
    // 判断当前状态
    public getCurrentState(): 'fire' | 'idle' | 'snow' | 'snow_accumulate' {
        const <span class="hljs-attr">idleTime</span> = this.getIdleTime()<span class="hljs-comment">;</span>
        if (idleTime &gt;= this.SNOW_ACCUMULATE_THRESHOLD) return 'snow_accumulate'<span class="hljs-comment">;</span>
        if (idleTime &gt;= this.IDLE_THRESHOLD) return 'snow'<span class="hljs-comment">;</span>
        if (this.getHeatLevel() &gt; 10) return 'fire'<span class="hljs-comment">;</span>
        return 'idle'<span class="hljs-comment">;</span>
    }
}
```

<span class="hljs-comment">### 4.2 Extension 核心逻辑</span>

```typescript
// src/extension.ts
import * as vscode from 'vscode'<span class="hljs-comment">;</span>
import { ActivityTracker } from './activityTracker'<span class="hljs-comment">;</span>
import { FrostFireWebviewProvider } from './webviewProvider'<span class="hljs-comment">;</span>

let activityTracker: ActivityTracker<span class="hljs-comment">;</span>
let webviewProvider: FrostFireWebviewProvider<span class="hljs-comment">;</span>
let updateInterval: NodeJS.Timeout<span class="hljs-comment">;</span>

export function activate(context: vscode.ExtensionContext) {
    <span class="hljs-attr">activityTracker</span> = new ActivityTracker()<span class="hljs-comment">;</span>
    <span class="hljs-attr">webviewProvider</span> = new FrostFireWebviewProvider(context.extensionUri)<span class="hljs-comment">;</span>
    
    // 注册 Webview 视图
    context.subscriptions.push(
        vscode.window.registerWebviewViewProvider(
            'frostfire.effectView',
            webviewProvider
        )
    )<span class="hljs-comment">;</span>
    
    // 注册启动命令
    context.subscriptions.push(
        vscode.commands.registerCommand('frostfire.start', () =&gt; {
            vscode.commands.executeCommand('frostfire.effectView.focus')<span class="hljs-comment">;</span>
        })
    )<span class="hljs-comment">;</span>
    
    // 监听文档变化（用户输入）
    context.subscriptions.push(
        vscode.workspace.onDidChangeTextDocument((event) =&gt; {
            // 只统计实际的文本变化
            if (event.contentChanges.length &gt; 0) {
                activityTracker.recordKeystroke()<span class="hljs-comment">;</span>
            }
        })
    )<span class="hljs-comment">;</span>
    
    // 定时更新状态到 Webview
    <span class="hljs-attr">updateInterval</span> = setInterval(() =&gt; {
        const <span class="hljs-attr">state</span> = activityTracker.getCurrentState()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">heatLevel</span> = activityTracker.getHeatLevel()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">idleTime</span> = activityTracker.getIdleTime()<span class="hljs-comment">;</span>
        
        webviewProvider.postMessage({
            type: 'stateUpdate',
            state: state,
            heatLevel: heatLevel,
            idleTime: idleTime
        })<span class="hljs-comment">;</span>
    }, 100)<span class="hljs-comment">; // 每100ms更新一次</span>
    
    context.subscriptions.push({
        dispose: () =&gt; clearInterval(updateInterval)
    })<span class="hljs-comment">;</span>
}

export function deactivate() {
    if (updateInterval) {
        clearInterval(updateInterval)<span class="hljs-comment">;</span>
    }
}
```

<span class="hljs-comment">### 4.3 Doom Fire 火焰算法</span>

```javascript
// src/webview/fireEffect.js
class FireEffect {
    constructor(canvas) {
        <span class="hljs-attr">this.canvas</span> = canvas<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.fireWidth</span> = <span class="hljs-number">80</span><span class="hljs-comment">;  // 火焰像素宽度</span>
        <span class="hljs-attr">this.fireHeight</span> = <span class="hljs-number">50</span><span class="hljs-comment">; // 火焰像素高度</span>
        <span class="hljs-attr">this.firePixels</span> = []<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.fireColorPalette</span> = this.createPalette()<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.intensity</span> = <span class="hljs-number">0</span><span class="hljs-comment">;   // 火焰强度 0-100</span>
        this.initFire()<span class="hljs-comment">;</span>
    }
    
    // 创建火焰颜色调色板（36色）
    createPalette() {
        return <span class="hljs-section">[
            {r:7,g:7,b:7}, {r:31,g:7,b:7}, {r:47,g:15,b:7}, {r:71,g:15,b:7},
            {r:87,g:23,b:7}, {r:103,g:31,b:7}, {r:119,g:31,b:7}, {r:143,g:39,b:7},
            {r:159,g:47,b:7}, {r:175,g:63,b:7}, {r:191,g:71,b:7}, {r:199,g:71,b:7},
            {r:223,g:79,b:7}, {r:223,g:87,b:7}, {r:223,g:87,b:7}, {r:215,g:95,b:7},
            {r:215,g:103,b:15}, {r:207,g:111,b:15}, {r:207,g:119,b:15}, {r:207,g:127,b:15},
            {r:207,g:135,b:23}, {r:199,g:135,b:23}, {r:199,g:143,b:23}, {r:199,g:151,b:31},
            {r:191,g:159,b:31}, {r:191,g:159,b:31}, {r:191,g:167,b:39}, {r:191,g:167,b:39},
            {r:191,g:175,b:47}, {r:183,g:175,b:47}, {r:183,g:183,b:47}, {r:183,g:183,b:55},
            {r:207,g:207,b:111}, {r:223,g:223,b:159}, {r:239,g:239,b:199}, {r:255,g:255,b:255}
        ]</span><span class="hljs-comment">;</span>
    }
    
    // 初始化火焰数组
    initFire() {
        const <span class="hljs-attr">totalPixels</span> = this.fireWidth * this.fireHeight<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.firePixels</span> = new Array(totalPixels).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    }
    
    // 设置火焰强度
    setIntensity(level) {
        <span class="hljs-attr">this.intensity</span> = Math.max(<span class="hljs-number">0</span>, Math.min(<span class="hljs-number">100</span>, level))<span class="hljs-comment">;</span>
        // 根据强度设置底部火源
        const <span class="hljs-attr">maxColorIndex</span> = Math.floor((this.intensity / <span class="hljs-number">100</span>) * <span class="hljs-number">35</span>)<span class="hljs-comment">;</span>
        for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
            const <span class="hljs-attr">bottomIndex</span> = (this.fireHeight - <span class="hljs-number">1</span>) * this.fireWidth + x<span class="hljs-comment">;</span>
            this.firePixels<span class="hljs-section">[bottomIndex]</span> = this.intensity &gt; 5 ? maxColorIndex : 0<span class="hljs-comment">;</span>
        }
    }
    
    // 火焰传播算法
    spreadFire() {
        for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
            for (let <span class="hljs-attr">y</span> = <span class="hljs-number">1</span><span class="hljs-comment">; y &lt; this.fireHeight; y++) {</span>
                const <span class="hljs-attr">srcIndex</span> = y * this.fireWidth + x<span class="hljs-comment">;</span>
                const <span class="hljs-attr">pixel</span> = this.firePixels[srcIndex]<span class="hljs-comment">;</span>
                
                if (<span class="hljs-attr">pixel</span> === <span class="hljs-number">0</span>) {
                    this.firePixels<span class="hljs-section">[(y - 1) * this.fireWidth + x]</span> = 0<span class="hljs-comment">;</span>
                } else {
                    // 随机偏移产生飘动效果
                    const <span class="hljs-attr">randIdx</span> = Math.floor(Math.random() * <span class="hljs-number">3</span>)<span class="hljs-comment">;</span>
                    const <span class="hljs-attr">dstX</span> = Math.min(this.fireWidth - <span class="hljs-number">1</span>, Math.max(<span class="hljs-number">0</span>, x - randIdx + <span class="hljs-number">1</span>))<span class="hljs-comment">;</span>
                    const <span class="hljs-attr">dstIndex</span> = (y - <span class="hljs-number">1</span>) * this.fireWidth + dstX<span class="hljs-comment">;</span>
                    this.firePixels<span class="hljs-section">[dstIndex]</span> = Math.max(0, pixel - (randIdx &amp; 1))<span class="hljs-comment">;</span>
                }
            }
        }
    }
    
    // 渲染火焰
    render() {
        this.spreadFire()<span class="hljs-comment">;</span>
        
        const <span class="hljs-attr">pixelWidth</span> = this.canvas.width / this.fireWidth<span class="hljs-comment">;</span>
        const <span class="hljs-attr">pixelHeight</span> = this.canvas.height / this.fireHeight<span class="hljs-comment">;</span>
        
        for (let <span class="hljs-attr">y</span> = <span class="hljs-number">0</span><span class="hljs-comment">; y &lt; this.fireHeight; y++) {</span>
            for (let <span class="hljs-attr">x</span> = <span class="hljs-number">0</span><span class="hljs-comment">; x &lt; this.fireWidth; x++) {</span>
                const <span class="hljs-attr">colorIndex</span> = this.firePixels[y * this.fireWidth + x]<span class="hljs-comment">;</span>
                const <span class="hljs-attr">color</span> = this.fireColorPalette[colorIndex]<span class="hljs-comment">;</span>
                
                if (colorIndex &gt; 0) {
                    <span class="hljs-attr">this.ctx.fillStyle</span> = `rgba(<span class="hljs-variable">${color.r}</span>,<span class="hljs-variable">${color.g}</span>,<span class="hljs-variable">${color.b}</span>,<span class="hljs-number">0.9</span>)`<span class="hljs-comment">;</span>
                    this.ctx.fillRect(
                        x * pixelWidth,
                        y * pixelHeight,
                        pixelWidth + 1,
                        pixelHeight + 1
                    )<span class="hljs-comment">;</span>
                }
            }
        }
    }
}
```

<span class="hljs-comment">### 4.4 雪花效果</span>

```javascript
// src/webview/snowEffect.js
class SnowEffect {
    constructor(canvas) {
        <span class="hljs-attr">this.canvas</span> = canvas<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowflakes</span> = []<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowAccumulation</span> = []<span class="hljs-comment">; // 积雪层高度数组</span>
        <span class="hljs-attr">this.maxSnowflakes</span> = <span class="hljs-number">200</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        this.initAccumulation()<span class="hljs-comment">;</span>
    }
    
    // 初始化积雪层
    initAccumulation() {
        const <span class="hljs-attr">segments</span> = Math.floor(this.canvas.width / <span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.snowAccumulation</span> = new Array(segments).fill(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    }
    
    // 创建雪花
    createSnowflake() {
        return {
            x: Math.random() * this.canvas.width,
            y: -10,
            radius: Math.random() * 3 + 1,
            speed: Math.random() * 1 + 0.5,
            wind: Math.random() * 0.5 - 0.25,
            opacity: Math.random() * 0.5 + 0.5
        }<span class="hljs-comment">;</span>
    }
    
    // 开始下雪
    startSnow(<span class="hljs-attr">accumulate</span> = <span class="hljs-literal">false</span>) {
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = accumulate<span class="hljs-comment">;</span>
    }
    
    // 停止下雪
    stopSnow() {
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
    
    // 清除效果
    clear() {
        <span class="hljs-attr">this.snowflakes</span> = []<span class="hljs-comment">;</span>
        this.initAccumulation()<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isSnowing</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.isAccumulating</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
    
    // 更新雪花位置
    update() {
        // 添加新雪花
        if (this.isSnowing &amp;&amp; this.snowflakes.length &lt; this.maxSnowflakes) {
            if (Math.random() &lt; 0.3) {
                this.snowflakes.push(this.createSnowflake())<span class="hljs-comment">;</span>
            }
        }
        
        // 更新雪花位置
        for (let <span class="hljs-attr">i</span> = this.snowflakes.length - <span class="hljs-number">1</span><span class="hljs-comment">; i &gt;= 0; i--) {</span>
            const <span class="hljs-attr">flake</span> = this.snowflakes[i]<span class="hljs-comment">;</span>
            flake.y += flake.speed<span class="hljs-comment">;</span>
            flake.x += flake.wind<span class="hljs-comment">;</span>
            
            // 检查是否落到底部或积雪上
            const <span class="hljs-attr">segmentIndex</span> = Math.floor(flake.x / <span class="hljs-number">5</span>)<span class="hljs-comment">;</span>
            const <span class="hljs-attr">groundLevel</span> = this.canvas.height - (this.snowAccumulation[segmentIndex] || <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
            
            if (flake.y &gt;= groundLevel) {
                // 积雪
                if (this.isAccumulating &amp;&amp; segmentIndex &gt;= 0 &amp;&amp; segmentIndex &lt; this.snowAccumulation.length) {
                    this.snowAccumulation<span class="hljs-section">[segmentIndex]</span> = Math.min(
                        this.snowAccumulation<span class="hljs-section">[segmentIndex]</span> + 0.2,
                        this.canvas.height * 0.3 // 最大积雪高度30%
                    )<span class="hljs-comment">;</span>
                }
                this.snowflakes.splice(i, 1)<span class="hljs-comment">;</span>
            } else if (flake.x &lt; 0 || flake.x &gt; this.canvas.width) {
                this.snowflakes.splice(i, 1)<span class="hljs-comment">;</span>
            }
        }
    }
    
    // 渲染雪花和积雪
    render() {
        this.update()<span class="hljs-comment">;</span>
        
        // 绘制雪花
        <span class="hljs-attr">this.ctx.fillStyle</span> = <span class="hljs-string">'white'</span><span class="hljs-comment">;</span>
        for (const flake of this.snowflakes) {
            <span class="hljs-attr">this.ctx.globalAlpha</span> = flake.opacity<span class="hljs-comment">;</span>
            this.ctx.beginPath()<span class="hljs-comment">;</span>
            this.ctx.arc(flake.x, flake.y, flake.radius, 0, Math.PI * 2)<span class="hljs-comment">;</span>
            this.ctx.fill()<span class="hljs-comment">;</span>
        }
        <span class="hljs-attr">this.ctx.globalAlpha</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        
        // 绘制积雪
        if (this.isAccumulating) {
            <span class="hljs-attr">this.ctx.fillStyle</span> = <span class="hljs-string">'rgba(255, 255, 255, 0.8)'</span><span class="hljs-comment">;</span>
            this.ctx.beginPath()<span class="hljs-comment">;</span>
            this.ctx.moveTo(0, this.canvas.height)<span class="hljs-comment">;</span>
            
            for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; this.snowAccumulation.length; i++) {</span>
                const <span class="hljs-attr">x</span> = i * <span class="hljs-number">5</span><span class="hljs-comment">;</span>
                const <span class="hljs-attr">y</span> = this.canvas.height - this.snowAccumulation[i]<span class="hljs-comment">;</span>
                this.ctx.lineTo(x, y)<span class="hljs-comment">;</span>
            }
            
            this.ctx.lineTo(this.canvas.width, this.canvas.height)<span class="hljs-comment">;</span>
            this.ctx.closePath()<span class="hljs-comment">;</span>
            this.ctx.fill()<span class="hljs-comment">;</span>
        }
    }
}
```

<span class="hljs-comment">### 4.5 Webview 主逻辑</span>

```javascript
// src/webview/main.js
(function() {
    const <span class="hljs-attr">vscode</span> = acquireVsCodeApi()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">canvas</span> = document.getElementById(<span class="hljs-string">'effectCanvas'</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">ctx</span> = canvas.getContext(<span class="hljs-string">'2d'</span>)<span class="hljs-comment">;</span>
    
    let fireEffect, snowEffect<span class="hljs-comment">;</span>
    let <span class="hljs-attr">currentState</span> = <span class="hljs-string">'idle'</span><span class="hljs-comment">;</span>
    let animationId<span class="hljs-comment">;</span>
    
    // 初始化
    function init() {
        resizeCanvas()<span class="hljs-comment">;</span>
        <span class="hljs-attr">fireEffect</span> = new FireEffect(canvas)<span class="hljs-comment">;</span>
        <span class="hljs-attr">snowEffect</span> = new SnowEffect(canvas)<span class="hljs-comment">;</span>
        animate()<span class="hljs-comment">;</span>
    }
    
    // 调整画布大小
    function resizeCanvas() {
        <span class="hljs-attr">canvas.width</span> = window.innerWidth<span class="hljs-comment">;</span>
        <span class="hljs-attr">canvas.height</span> = window.innerHeight<span class="hljs-comment">;</span>
    }
    
    // 动画循环
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height)<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'fire'</span>) {
            fireEffect.render()<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow'</span> || currentState === <span class="hljs-string">'snow_accumulate'</span>) {
            snowEffect.render()<span class="hljs-comment">;</span>
        }
        
        <span class="hljs-attr">animationId</span> = requestAnimationFrame(animate)<span class="hljs-comment">;</span>
    }
    
    // 处理来自扩展的消息
    window.addEventListener('message', <span class="hljs-attr">event</span> =&gt; {
        const <span class="hljs-attr">message</span> = event.data<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">message.type</span> === <span class="hljs-string">'stateUpdate'</span>) {
            handleStateUpdate(message)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
    
    // 处理状态更新
    function handleStateUpdate(message) {
        const <span class="hljs-attr">newState</span> = message.state<span class="hljs-comment">;</span>
        
        if (newState !== currentState) {
            // 状态切换
            if (<span class="hljs-attr">newState</span> === <span class="hljs-string">'fire'</span>) {
                snowEffect.clear()<span class="hljs-comment">;</span>
            } else if (<span class="hljs-attr">newState</span> === <span class="hljs-string">'snow'</span> || newState === <span class="hljs-string">'snow_accumulate'</span>) {
                fireEffect.setIntensity(0)<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">currentState</span> = newState<span class="hljs-comment">;</span>
        }
        
        // 更新效果参数
        if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'fire'</span>) {
            fireEffect.setIntensity(message.heatLevel)<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow'</span>) {
            snowEffect.startSnow(false)<span class="hljs-comment">;</span>
        } else if (<span class="hljs-attr">currentState</span> === <span class="hljs-string">'snow_accumulate'</span>) {
            snowEffect.startSnow(true)<span class="hljs-comment">;</span>
        } else {
            fireEffect.setIntensity(0)<span class="hljs-comment">;</span>
            snowEffect.stopSnow()<span class="hljs-comment">;</span>
        }
    }
    
    // 窗口大小改变时重新调整
    window.addEventListener('resize', () =&gt; {
        resizeCanvas()<span class="hljs-comment">;</span>
        if (snowEffect) snowEffect.initAccumulation()<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
    
    // 启动
    init()<span class="hljs-comment">;</span>
})()<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## 5. 边界条件与异常处理</span>

<span class="hljs-comment">### 5.1 输入边界</span>
- 热度值范围：0-100，超出范围自动截断
- 空闲时间：使用 Infinity 表示从未输入
- 按键时间戳数组：定期清理过期数据，避免内存泄漏

<span class="hljs-comment">### 5.2 状态切换</span>
- 状态切换时清理前一状态的视觉残留
- 使用平滑过渡避免突兀感

<span class="hljs-comment">### 5.3 性能优化</span>
- 火焰像素矩阵使用固定大小（80x50），通过缩放渲染到实际尺寸
- 雪花数量上限 200 个，避免性能问题
- 使用 requestAnimationFrame 保证动画流畅

<span class="hljs-comment">### 5.4 Webview 生命周期</span>
- Webview 隐藏时暂停动画
- Webview 销毁时清理资源
- 重新显示时恢复状态

<span class="hljs-comment">## 6. 数据流动路径</span>

```
用户输入 → onDidChangeTextDocument → ActivityTracker.recordKeystroke()
                                            ↓
                                    计算热度值/空闲时间
                                            ↓
                              定时器(100ms) → getCurrentState()
                                            ↓
                              WebviewProvider.postMessage()
                                            ↓
                              Webview 接收消息 → handleStateUpdate()
                                            ↓
                              更新 FireEffect/SnowEffect 参数
                                            ↓
                              requestAnimationFrame → render()
```

<span class="hljs-comment">## 7. 预期成果</span>

完成后的 MVP 应具备：
1. ✅ 一键启动视觉效果面板
2. ✅ 实时响应用户输入，渲染火焰效果
3. ✅ 空闲时自动切换到雪花效果
4. ✅ 长时间空闲产生积雪效果
5. ✅ 流畅的动画和状态切换
6. ✅ 详细的代码注释，便于理解和扩展
</code></pre>
<h2 data-id="heading-8">【附录2】插件开发任务计划</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># FrostFire VS Code 插件开发任务计划</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">1</span><span class="hljs-string">：初始化项目结构与配置文件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`package.json`，配置插件元信息、activationEvents、commands</span> <span class="hljs-string">和</span> <span class="hljs-string">views（侧边栏注册）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.2:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`tsconfig.json`，配置</span> <span class="hljs-string">TypeScript</span> <span class="hljs-string">编译选项</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.3:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`.vscode/launch.json`，配置调试启动项</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.4:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`.vscode/tasks.json`，配置</span> <span class="hljs-string">watch</span> <span class="hljs-string">编译任务</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">1.5:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`README.md`，说明项目用途和使用方法</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">2</span><span class="hljs-string">：实现</span> <span class="hljs-string">ActivityTracker</span> <span class="hljs-string">活跃度追踪模块</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/activityTracker.ts`，定义</span> <span class="hljs-string">ActivityTracker</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`recordKeystroke()`</span> <span class="hljs-string">方法，记录按键时间戳</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getHeatLevel()`</span> <span class="hljs-string">方法，计算热度值（0-100）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getIdleTime()`</span> <span class="hljs-string">方法，计算空闲时间</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">2.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getCurrentState()`</span> <span class="hljs-string">方法，判断当前状态（fire/idle/snow/snow_accumulate）</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">3</span><span class="hljs-string">：实现</span> <span class="hljs-string">WebviewProvider</span> <span class="hljs-string">面板管理模块</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webviewProvider.ts`，定义</span> <span class="hljs-string">FrostFireWebviewProvider</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`resolveWebviewView()`</span> <span class="hljs-string">方法，创建并配置</span> <span class="hljs-string">Webview</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`getHtmlContent()`</span> <span class="hljs-string">方法，生成包含</span> <span class="hljs-string">Canvas</span> <span class="hljs-string">和脚本的</span> <span class="hljs-string">HTML</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">3.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`postMessage()`</span> <span class="hljs-string">方法，向</span> <span class="hljs-string">Webview</span> <span class="hljs-string">发送状态更新消息</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">4</span><span class="hljs-string">：实现插件主入口</span> <span class="hljs-string">extension.ts</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/extension.ts`，实现</span> <span class="hljs-string">`activate()`</span> <span class="hljs-string">函数</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.2:</span> <span class="hljs-string">注册</span> <span class="hljs-string">WebviewViewProvider</span> <span class="hljs-string">到</span> <span class="hljs-string">frostfire.effectView</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.3:</span> <span class="hljs-string">注册</span> <span class="hljs-string">frostfire.start</span> <span class="hljs-string">和</span> <span class="hljs-string">frostfire.stop</span> <span class="hljs-string">命令</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.4:</span> <span class="hljs-string">添加</span> <span class="hljs-string">`onDidChangeTextDocument`</span> <span class="hljs-string">监听器，记录用户输入</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.5:</span> <span class="hljs-string">设置定时器（100ms），定期向</span> <span class="hljs-string">Webview</span> <span class="hljs-string">发送状态更新</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">4.6:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`deactivate()`</span> <span class="hljs-string">函数，清理资源</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">5</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">前端效果（火焰效果）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/fireEffect.js`，定义</span> <span class="hljs-string">FireEffect</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`createPalette()`</span> <span class="hljs-string">方法，创建</span> <span class="hljs-number">36</span> <span class="hljs-string">色火焰调色板</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`setIntensity()`</span> <span class="hljs-string">方法，根据热度设置火焰强度</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`spreadFire()`</span> <span class="hljs-string">方法，Doom</span> <span class="hljs-string">Fire</span> <span class="hljs-string">传播算法</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">5.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`render()`</span> <span class="hljs-string">方法，渲染火焰到</span> <span class="hljs-string">Canvas</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">6</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">前端效果（雪花效果）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/snowEffect.js`，定义</span> <span class="hljs-string">SnowEffect</span> <span class="hljs-string">类</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`createSnowflake()`</span> <span class="hljs-string">方法，生成随机雪花粒子</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.3:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`startSnow()`</span> <span class="hljs-string">/</span> <span class="hljs-string">`stopSnow()`</span> <span class="hljs-string">/</span> <span class="hljs-string">`clear()`</span> <span class="hljs-string">控制方法</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.4:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`update()`</span> <span class="hljs-string">方法，更新雪花位置和积雪层</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">6.5:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`render()`</span> <span class="hljs-string">方法，渲染雪花和积雪到</span> <span class="hljs-string">Canvas</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">7</span><span class="hljs-string">：实现</span> <span class="hljs-string">Webview</span> <span class="hljs-string">主逻辑与</span> <span class="hljs-string">HTML</span> <span class="hljs-string">模板</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.1:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/main.js`，实现消息监听和状态调度</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.2:</span> <span class="hljs-string">实现</span> <span class="hljs-string">`handleStateUpdate()`</span> <span class="hljs-string">方法，根据状态切换效果</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.3:</span> <span class="hljs-string">实现动画循环</span> <span class="hljs-string">`animate()`，使用</span> <span class="hljs-string">requestAnimationFrame</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">7.4:</span> <span class="hljs-string">创建</span> <span class="hljs-string">`src/webview/index.html`，纯黑背景</span> <span class="hljs-string">Canvas</span> <span class="hljs-string">模板</span>

<span class="hljs-bullet">-</span> [ ] <span class="hljs-string">任务</span> <span class="hljs-number">8</span><span class="hljs-string">：安装依赖并编译验证</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.1:</span> <span class="hljs-string">执行</span> <span class="hljs-string">`npm</span> <span class="hljs-string">install`</span> <span class="hljs-string">安装</span> <span class="hljs-string">TypeScript</span> <span class="hljs-string">和</span> <span class="hljs-string">VS</span> <span class="hljs-string">Code</span> <span class="hljs-string">类型定义</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.2:</span> <span class="hljs-string">执行</span> <span class="hljs-string">`npm</span> <span class="hljs-string">run</span> <span class="hljs-string">compile`</span> <span class="hljs-string">编译</span> <span class="hljs-string">TypeScript</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.3:</span> <span class="hljs-string">检查编译输出，确保无报错</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">8.4:</span> <span class="hljs-string">提供调试启动指南，确认</span> <span class="hljs-string">MVP</span> <span class="hljs-string">可运行</span>
<span class="hljs-string">有问题吗</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 组件通讯全攻略：拒绝 "Props" 焦虑，掌握数据流动的艺术]]></title>    <link>https://juejin.cn/post/7586482851097968680</link>    <guid>https://juejin.cn/post/7586482851097968680</guid>    <pubDate>2025-12-22T03:06:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851097968680" data-draft-id="7585850609015914511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 组件通讯全攻略：拒绝 &quot;Props&quot; 焦虑，掌握数据流动的艺术"/> <meta itemprop="keywords" content="React.js,前端框架,前端"/> <meta itemprop="datePublished" content="2025-12-22T03:06:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漫天黄叶远飞"/> <meta itemprop="url" content="https://juejin.cn/user/2948205649344634"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 组件通讯全攻略：拒绝 "Props" 焦虑，掌握数据流动的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2948205649344634/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漫天黄叶远飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:06:38.000Z" title="Mon Dec 22 2025 03:06:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在 <strong>React</strong> 的开发旅程中，组件就像是乐高积木，我们把它们一个个搭起来构建出复杂的页面。但光搭起来还不够，这些积木之间必须有“电流”流通——这就是数据。<br/>
<strong>React</strong> 的设计哲学是单向数据流，就像瀑布一样，水流默认只能从高处流向低处。但在实际业务中，我们经常需要逆流而上，或者在两个平行的水池间交换水流。今天我们就来盘点 <strong>React</strong> 中最主流的四种“引水”方式，打通你的组件经脉。</p>
<hr/>
<h2 data-id="heading-1">1. 父传子：顺流而下的 Props</h2>
<p>这是 <strong>React</strong> 中最自然、最基础的通信方式。想象一下，父亲给孩子零花钱，父亲（父组件）只需要要把钱（数据）递过去，孩子（子组件）伸手接着就行。<br/>
在代码层面，父组件通过在子组件标签上写上自定义属性（msg）来传递数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'小饶'</span>
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 父亲把 '小饶' 这个名字打包进 msg 属性传给孩子 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">msg</span>=<span class="hljs-string">{state.name}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>孩子组件这边，所有接收到的礼物都装在一个叫 <code>props</code> 的盒子里。不过要注意，<code>Props</code> 是只读的——这意味着孩子只能使用这些数据，不能直接修改它。就像孩子不能自己修改父亲银行卡的余额一样，如果要改，必须请求父亲操作。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-comment">// 打开盒子看看收到了什么</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件 -- {props.msg}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-2">2. 子传父：给孩子一个“遥控器”</h2>
<p>既然水流默认向下，那子组件想要改变父组件的数据该怎么办？比如，孩子想告诉父亲：“我考了 100 分，请更新一下你的心情状态”。<br/>
这时候，父组件需要提前准备一个“遥控器”——也就是一个函数。父组件把这个函数通过 <code>props</code> 传给子组件，当子组件需要通信时，就按下这个遥控器（调用函数），并把数据作为参数传回去。
**父组件： 准备好 <code>getNum</code> 函数，用来接收数据并更新自己的 <code>count</code>。 **</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>)  

  <span class="hljs-comment">// 这就是那个“遥控器”函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getNum</span> = (<span class="hljs-params">n</span>) =&gt; {
    <span class="hljs-title function_">setCount</span>(n)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>父组件二 -- {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 把遥控器交给孩子 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">getNum</span>=<span class="hljs-string">{getNum}</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>子组件： 在合适的时机（比如点击按钮时），通过 props 拿到并按下这个“遥控器”。</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">props</span>) {
  
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">num</span>: <span class="hljs-number">100</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 此时调用的是父组件里的函数，把 100 传了回去</span>
    props.<span class="hljs-title function_">getNum</span>(state.<span class="hljs-property">num</span>)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件二<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{send}</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-3">3. 兄弟组件：找个共同的“家长”</h2>
<p>兄弟组件之间没有直接的连线，就像你和你的表弟住在不同的屋子里，想聊天得通过大厅里的长辈传话。
这种模式在 <strong>React</strong> 中通常被称为状态提升。既然 <strong>Brother1</strong> 想要给 <strong>Brother2</strong> 传值，那我们就把这个值保存在他们共同的父亲身上。</p>
<ul>
<li>Brother1 -&gt; Parent：Brother1 先把数据传给父亲（利用上面的子传父技巧）。</li>
<li>Parent -&gt; Brother2：父亲拿到数据后，更新自己的状态，再把这个新状态顺手传给 Brother2（利用父传子技巧）。</li>
</ul>
<p><strong>父组件（中间枢纽）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child1</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child1"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child2</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child2"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> [message, setMessage] = <span class="hljs-title function_">useState</span>()

  <span class="hljs-comment">// 接收老大传来的消息</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getMsg</span> = (<span class="hljs-params">msg</span>) =&gt; {
    <span class="hljs-title function_">setMessage</span>(msg)
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span> 父组件三 <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 接收者：从 Child1 收信 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child1</span> <span class="hljs-attr">getMsg</span>=<span class="hljs-string">{getMsg}</span> /&gt;</span>
      {/* 发送者：把信转交给 Child2 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Child2</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>Child1（消息发送方）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child1</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">const</span> state = {
    <span class="hljs-attr">msg</span>: <span class="hljs-string">'1 中的数据'</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"/>) {
    props.<span class="hljs-title function_">getMsg</span>(state.<span class="hljs-property">msg</span>)
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件1<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{send}</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>Child2（消息接收方）：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child2</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 坐等父亲把兄弟的消息送过来 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件2 --- {props.message}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<hr/>
<h2 data-id="heading-4">4. 跨代组件通信：Context 传送门</h2>
<p>如果组件层级很深，比如“爷爷 -&gt; 爸爸 -&gt; 儿子 -&gt; 孙子”，如果还用 <strong>Props</strong> 一层层传，那中间的爸爸和儿子就成了无辜的“搬运工”，代码会变得非常臃肿麻烦。<br/>
为了解决这个问题，<strong>React</strong> 提供了一个 <strong>Context</strong>（上下文）机制。这就像在家族里设立了一个“广播站”，爷爷在顶层广播，底下的任何一代子孙，只要想听，就可以直接接收信号，完全不需要中间人转手。<br/>
<strong>爷组件（数据源头）：</strong><br/>
我们需要先 <code>createContext</code> 创建一个信号塔，然后用 <code>&lt;Context.Provider&gt;</code> 把所有后代包起来，<code>value</code> 就是我们要广播的数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Parent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Parent"</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">Context</span> = <span class="hljs-title function_">createContext</span>()  <span class="hljs-comment">// 1. 建立信号塔</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Grand</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span> 爷组件 <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      {/* 2. 发射信号，内容是 value 中的数据 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Context.Provider</span> <span class="hljs-attr">value</span>= <span class="hljs-string">{</span>'<span class="hljs-attr">爷组件的数据</span>'}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Parent</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Context.Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>父组件（路人甲）：</strong><br/>
你看，父组件完全不需要碰这些数据，它只需要安静地渲染它的子组件即可。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>孙子组件（数据接收者）：</strong><br/>
孙子组件不需要管它离爷爷隔了多少代，直接用 <code>useContext</code> 这个钩子函数，就能连上信号塔拿到数据。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Grand'</span>  <span class="hljs-comment">// 3. 引入信号塔定义</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 4. 接收信号</span>
  <span class="hljs-keyword">const</span> msg = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">Context</span>)

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>孙子组件 --- {msg}<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-5">结语</h2>
<p>组件通信是 <strong>React</strong> 开发中最基本也最重要的内功。</p>
<ul>
<li>简单的父子关系，<strong>Props</strong> 和 <strong>Callback</strong> 是最轻量的选择；</li>
<li>兄弟组件，记得找共同的父级帮忙周转；</li>
<li>当层级太深感到繁琐时，<strong>Context</strong> 就是你的救星。</li>
</ul>
<p>掌握了这四招，你就能从容应对绝大多数的组件交互场景，让数据在你的应用中流动得井井有条。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包 => 放弃了，样式会丢]]></title>    <link>https://juejin.cn/post/7586509410567405609</link>    <guid>https://juejin.cn/post/7586509410567405609</guid>    <pubDate>2025-12-22T03:15:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567405609" data-draft-id="7585789195869388836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包  =&gt;  放弃了，样式会丢"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:15:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦想是准点下班"/> <meta itemprop="url" content="https://juejin.cn/user/2192851914196873"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【vue3】 + 【vite】 + 【vite-plugin-obfuscator】混淆打包  =&gt;  放弃了，样式会丢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2192851914196873/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦想是准点下班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:15:40.000Z" title="Mon Dec 22 2025 03:15:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>vite-plugin-obfuscator</code> 可以将你的代码进行混淆，一个依赖</p>
<hr/>
<p>安装</p>
<p>npm install vite-plugin-obfuscator --save-dev</p>
<p>配置文件引入和配置</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { viteObfuscateFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-obfuscator'</span>;

<span class="hljs-comment">// https://vitejs.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">vueJsx</span>(),
    <span class="hljs-title function_">viteMockServe</span>({
      <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'mock'</span>,
      <span class="hljs-attr">localEnabled</span>: <span class="hljs-literal">true</span>
    }),
    <span class="hljs-title function_">viteObfuscateFile</span>({
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">debugProtection</span>: <span class="hljs-literal">true</span>
      }
    })
  ],
</code></pre>
<p>报错：</p>
<p>无法找到模块“vite-plugin-obfuscator”的声明文件。</p>
<p>没有具体步骤，这个依赖缺少类型声明，ts进行报错，给它一个声明就行，例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 添加 vite-plugin-obfuscator 的类型声明</span>
declare <span class="hljs-variable language_">module</span> <span class="hljs-string">'vite-plugin-obfuscator'</span> {
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;

  interface <span class="hljs-title class_">ViteObfuscateFileOptions</span> {
    options?: any;
  }

  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">viteObfuscateFile</span>(<span class="hljs-params">options?: ViteObfuscateFileOptions</span>): <span class="hljs-title class_">Plugin</span>;
}
</code></pre>
<p>具体的混淆配置：</p>








































<table><thead><tr><th><code>compact</code></th><th><code>boolean</code></th><th><code>true</code></th><th>压缩代码，移除空格和换行符。</th><th>样式丢失</th></tr></thead><tbody><tr><td><code>debugProtection</code></td><td><code>boolean</code></td><td><code>false</code></td><td>防止在开发者工具中调试代码。</td><td/></tr><tr><td>-----------------</td><td>---------</td><td>-------</td><td>--------------</td><td/></tr><tr><td><code>renameGlobals</code></td><td><code>boolean</code></td><td><code>false</code></td><td>重命名全局变量和函数名。</td><td>接口路径失效</td></tr><tr><td>---------------</td><td>---------</td><td>-------</td><td>------------</td><td>---</td></tr></tbody></table>










<table><thead><tr><th><code>renameProperties</code></th><th><code>boolean</code></th><th><code>false</code></th><th>重命名对象的属性名。</th><th>样式丢失？</th></tr></thead></table>










<table><thead><tr><th><code>transformObjectKeys</code></th><th><code>boolean</code></th><th><code>false</code></th><th>转换对象的键名，增加代码的复杂性。</th><th>样式丢失？</th></tr></thead></table>
<p>难搞啊，样式会丢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高德地图-物流路线]]></title>    <link>https://juejin.cn/post/7586208617603285026</link>    <guid>https://juejin.cn/post/7586208617603285026</guid>    <pubDate>2025-12-22T03:13:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586208617603285026" data-draft-id="7585920796100395035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高德地图-物流路线"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:13:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星_离"/> <meta itemprop="url" content="https://juejin.cn/user/2652464856962254"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高德地图-物流路线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2652464856962254/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星_离
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:13:59.000Z" title="Mon Dec 22 2025 03:13:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有些时候我们的项目只使用原生一些内容是无法实现一些功能的，所以今天我带来了一个大家都熟悉的，也是生活中常见的一个功能，也就是大家在网购的时候，下单成功后就可以看到自己的订单，当然也可以查看物流信息，那么物流信息中有一个部分就是地图部分，这部分可以让用户看到自己购买的商品到了哪里。那这个功能我们使用原生大概率是无法完成的，这就需要我们使用高德地图、百度地图或者腾讯之类的开放地图类 API 的功能，那么今天我就来和大家分享一下如何去使用高德地图实现这一功能。</p>
<h2 data-id="heading-0">1. 准备工作</h2>
<h3 data-id="heading-1">1.1. 官方文档</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fjavascript-api-v2%2Fguide%2Fabc%2Famap-vue" target="_blank" title="https://lbs.amap.com/api/javascript-api-v2/guide/abc/amap-vue" ref="nofollow noopener noreferrer">lbs.amap.com/api/javascr…</a></p>
<h3 data-id="heading-2">1.2. 需要安装的依赖</h3>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">@amap</span>/amap-jsapi-loader --save
</code></pre>
<h2 data-id="heading-3">2. 开始</h2>
<p>首先我们需要给地图设置一个容器，命名为<code>container</code></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>设置样式</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>  <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
  <span class="hljs-selector-id">#container</span>{
      <span class="hljs-attribute">padding</span>:<span class="hljs-number">0px</span>;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0px</span>;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">800px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">2.1. 创建地图组件</h3>
<p>首先我们需要去扩展 window 接口类型的定义，如果不配置就会出现错误：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0385debae646ab83e710854d3b0ac3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=O8Y5ucWsYVL8ETeID06i8MZzUGk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117de5c26e2a46d782e2e04bf551cbcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=ymA2M1Ncx6aRcZ%2BWVgVHYCIGpLA%3D" alt="" loading="lazy"/></p>
<p>核心原因：</p>
<p>TypeScript 对 <code>window</code> 的类型有严格定义，默认的 <code>Window</code> 接口里没有 <code>_AMapSecurityConfig</code>，所以会提示 “该属性不存在”。但是高德地图又需要这个属性来配置安全密钥，所以我们就需要来扩展一下 window 类型。</p>
<p>那么我们就需要先来配置一下：按照以下路径创建 global.d.ts 文件</p>
<p>src--&gt;types--&gt;global.d.ts</p>
<p>进入文件配置以下内容：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">interface</span> <span class="hljs-title">Window</span> {
  _AMapSecurityConfig: {
      securityJsCode: <span class="hljs-built_in">string</span>
  }
}
</code></pre>
<h3 data-id="heading-5">2.2. 初始化地图组件</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span>  {onMounted,onUnmounted} <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AMapLoader</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@amap/amap-jsapi-loader'</span>;

<span class="hljs-keyword">let</span> map = <span class="hljs-literal">null</span>;
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">()=&gt;</span>{
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">_AMapSecurityConfig</span> = {
    <span class="hljs-attr">securityJsCode</span>: <span class="hljs-string">"379c75538f6ae27ee95c983a6feaf358"</span>,
  };
  <span class="hljs-title class_">AMapLoader</span>.<span class="hljs-title function_">load</span>({
    <span class="hljs-attr">key</span>:<span class="hljs-string">"3d0735cef9dc47489452066b7dbe2510"</span>,
    <span class="hljs-attr">version</span>:<span class="hljs-string">"2.0"</span>,
    <span class="hljs-attr">plugins</span>:[<span class="hljs-string">"AMap.scale"</span>]
  })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">AMap</span>)=&gt;</span>{
      map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">"container"</span>,{
        <span class="hljs-comment">//设置地图容器的Id</span>
        <span class="hljs-attr">viewMode</span>:<span class="hljs-string">"3D"</span>,<span class="hljs-comment">//是否为3D地图模式</span>
        <span class="hljs-attr">zoom</span>:<span class="hljs-number">11</span>,<span class="hljs-comment">//初始化地图级别</span>
        <span class="hljs-attr">center</span>:[<span class="hljs-number">116.397428</span>, <span class="hljs-number">39.90923</span>]
      })
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>)=&gt;</span>{
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e)
    })
})
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">()=&gt;</span>{
  map?.<span class="hljs-title function_">destroy</span>();
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">3. 路线规划</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fdemo%2Fjavascript-api-v2%2Fexample%2Fdriving-route%2Fplan-route-according-to-lnglat" target="_blank" title="https://lbs.amap.com/demo/javascript-api-v2/example/driving-route/plan-route-according-to-lnglat" ref="nofollow noopener noreferrer">lbs.amap.com/demo/javasc…</a></p>
<p>通过数据处理出起始点和途径点的坐标：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">logisticsInfo</span> = [
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"23.129152403638752"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"113.42775362698366"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"30.454012"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"114.42659"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.93182"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"118.633415"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.035032"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"121.611504"</span>
  }
]
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 物流轨迹的起始点</span>
  <span class="hljs-type">const</span> start = logisticsInfo.<span class="hljs-built_in">shift</span>()<span class="hljs-comment">//起点</span>
  <span class="hljs-type">const</span> end = logisticsInfo.<span class="hljs-built_in">pop</span>()<span class="hljs-comment">//终点</span>
  <span class="hljs-type">const</span> ways = logisticsInfo.<span class="hljs-built_in">map</span>(item =&gt; [item.longitude, item.latitude])<span class="hljs-comment">//途径点数组</span>
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino">AMap.<span class="hljs-built_in">plugin</span>(<span class="hljs-string">'AMap.Driving'</span>, () =&gt; {
  <span class="hljs-comment">//构造路线导航类</span>
  var driving = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Driving</span>({
    map: map, <span class="hljs-comment">// 指定绘制的路线轨迹显示到map地图</span>
    showTraffic: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭实时交通路况</span>
    hideMarkers: <span class="hljs-literal">false</span> <span class="hljs-comment">// 隐藏默认的图标</span>
  });
  <span class="hljs-comment">// 根据起终点经纬度规划驾车导航路线</span>
  driving.<span class="hljs-built_in">search</span>(<span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">LngLat</span>(start.longitude, start.latitude), <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">LngLat</span>(end.longitude, end.latitude), {
    waypoints:ways, <span class="hljs-comment">// 途经点这里是一个二维数组的格式[[经度, 维度], [经度, 维度]]</span>
  },<span class="hljs-built_in">function</span> (status: string, result: object) {

    <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'complete'</span>) {
      console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'绘制驾车路线完成'</span>)
      <span class="hljs-comment">// 调整视野达到最佳显示区域</span>
      map.<span class="hljs-built_in">setFitView</span>([ startMarker, endMarker, currentMarker ])
    } <span class="hljs-keyword">else</span> {
      console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'获取驾车数据失败：'</span> + result)
    }
  })
})
</code></pre>
<h2 data-id="heading-7">4. 自定义图标</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de6dc325047142c19f81746b5cb14ba1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=xhm3Jn3jEWk4eZt2q9BImk%2FzHmQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a63a855fae740b7ae3907546cc372bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=%2FFhHSgxw4JKWXH%2Fk7ea3Dv%2BtvCs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8322b3e6b50a459196d3e85bd56e3b3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pifX-emuw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766978039&amp;x-signature=CAVa0FgeYxN%2Fw9ERK8m9RarXZPg%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> startImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/start.png'</span>
<span class="hljs-keyword">import</span> endImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/end.png'</span>
<span class="hljs-keyword">import</span> carImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/car.png'</span>
</code></pre>
<p>自定义图标需要使用到 marker 类</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 自定义开始坐标图片</span>
<span class="hljs-type">const</span> startMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [start.longitude, start.latitude], <span class="hljs-comment">// 自定义图标位置</span>
  icon:startImg,
  map: map <span class="hljs-comment">// 指定图标显示在哪个地图实例</span>
})
<span class="hljs-comment">// 自定义终点坐标图片</span>
<span class="hljs-type">const</span> endMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [end.longitude, end.latitude],
  icon:endImg,
  map: map
})
<span class="hljs-comment">// 自定义当前坐标图片</span>
<span class="hljs-type">const</span> currentMarker = <span class="hljs-keyword">new</span> AMap.<span class="hljs-built_in">Marker</span>({
  position: [currentLocationInfo.longitude, currentLocationInfo.latitude],
  icon:carImg,
  map: map
})
</code></pre>
<h2 data-id="heading-8">5. 完整代码实现</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>地图组件<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:100%; height: 500px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AMapLoader</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@amap/amap-jsapi-loader'</span>
<span class="hljs-keyword">import</span> startImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/start.png'</span>
<span class="hljs-keyword">import</span> endImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/end.png'</span>
<span class="hljs-keyword">import</span> carImg <span class="hljs-keyword">from</span> <span class="hljs-string">'../public/car.png'</span>
<span class="hljs-comment">// 接口返回的数据</span>
<span class="hljs-keyword">const</span> logisticsInfo = [
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"23.129152403638752"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"113.42775362698366"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"30.454012"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"114.42659"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.93182"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"118.633415"</span>
  },
  {
    <span class="hljs-string">"latitude"</span>: <span class="hljs-string">"31.035032"</span>,
    <span class="hljs-string">"longitude"</span>: <span class="hljs-string">"121.611504"</span>
  }
]
<span class="hljs-comment">// 当前坐标</span>
<span class="hljs-keyword">const</span> currentLocationInfo = {
  <span class="hljs-attr">latitude</span>: <span class="hljs-string">"31.93182"</span>,
  <span class="hljs-attr">longitude</span>: <span class="hljs-string">"118.633415"</span>
}
<span class="hljs-variable language_">window</span>.<span class="hljs-property">_AMapSecurityConfig</span> = {
  <span class="hljs-attr">securityJsCode</span>: <span class="hljs-string">'2af1e64a8f6b16d6d79bfa8162c46755'</span>
}
<span class="hljs-title function_">onMounted</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">AMap</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AMapLoader</span>.<span class="hljs-title function_">load</span>({
    <span class="hljs-attr">key</span>: <span class="hljs-string">'9ac7a2671565e21bc21aca6df07eb5cb'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'2.0'</span>
  })
  <span class="hljs-comment">// 地图的创建</span>
  <span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Map</span>(<span class="hljs-string">'container'</span>, {
    <span class="hljs-attr">viewMode</span>: <span class="hljs-string">'2D'</span>, <span class="hljs-comment">// 默认使用 2D 模式，如果希望使用带有俯仰角的 3D 模式，请设置 viewMode: '3D'</span>
    <span class="hljs-attr">zoom</span>:<span class="hljs-number">16</span>, <span class="hljs-comment">// 初始化地图层级</span>
    <span class="hljs-attr">center</span>: [<span class="hljs-number">116.209804</span>,<span class="hljs-number">40.149393</span>], <span class="hljs-comment">// 初始化地图中心点</span>
    <span class="hljs-attr">plugins</span>:[<span class="hljs-string">"AMap.Driving"</span>]
  });


  <span class="hljs-comment">// 物流轨迹的起始点</span>
  <span class="hljs-keyword">const</span> start = logisticsInfo.<span class="hljs-title function_">shift</span>()
  <span class="hljs-keyword">const</span> end = logisticsInfo.<span class="hljs-title function_">pop</span>()
  <span class="hljs-keyword">const</span> ways = logisticsInfo.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> [item.<span class="hljs-property">longitude</span>, item.<span class="hljs-property">latitude</span>])
  <span class="hljs-comment">// 自定义开始坐标图片</span>
  <span class="hljs-keyword">const</span> startMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [start.<span class="hljs-property">longitude</span>, start.<span class="hljs-property">latitude</span>], <span class="hljs-comment">// 自定义图标位置</span>
    <span class="hljs-attr">icon</span>:startImg,
    <span class="hljs-attr">map</span>: map <span class="hljs-comment">// 指定图标显示在哪个地图实例</span>
  })
  <span class="hljs-comment">// 自定义终点坐标图片</span>
  <span class="hljs-keyword">const</span> endMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [end.<span class="hljs-property">longitude</span>, end.<span class="hljs-property">latitude</span>],
    <span class="hljs-attr">icon</span>:endImg,
    <span class="hljs-attr">map</span>: map
  })
<span class="hljs-comment">// 自定义当前坐标图片</span>
  <span class="hljs-keyword">const</span> currentMarker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Marker</span>({
    <span class="hljs-attr">position</span>: [currentLocationInfo.<span class="hljs-property">longitude</span>, currentLocationInfo.<span class="hljs-property">latitude</span>],
    <span class="hljs-attr">icon</span>:carImg,
    <span class="hljs-attr">map</span>: map
  })

  <span class="hljs-comment">// 绘制物流轨迹</span>
  <span class="hljs-title class_">AMap</span>.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'AMap.Driving'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">//构造路线导航类</span>
    <span class="hljs-keyword">var</span> driving = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">Driving</span>({
      <span class="hljs-attr">map</span>: map, <span class="hljs-comment">// 指定绘制的路线轨迹显示到map地图</span>
      <span class="hljs-attr">showTraffic</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭实时交通路况</span>
      <span class="hljs-attr">hideMarkers</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 隐藏默认的图标</span>
    });
    <span class="hljs-comment">// 根据起终点经纬度规划驾车导航路线</span>
    driving.<span class="hljs-title function_">search</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">LngLat</span>(start.<span class="hljs-property">longitude</span>, start.<span class="hljs-property">latitude</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">AMap</span>.<span class="hljs-title class_">LngLat</span>(end.<span class="hljs-property">longitude</span>, end.<span class="hljs-property">latitude</span>), {
      <span class="hljs-attr">waypoints</span>:ways, <span class="hljs-comment">// 途经点这里是一个二维数组的格式[[经度, 维度], [经度, 维度]]</span>
    },<span class="hljs-keyword">function</span> (<span class="hljs-params">status: string, result: object</span>) {

      <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'complete'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'绘制驾车路线完成'</span>)
        <span class="hljs-comment">// 调整视野达到最佳显示区域</span>
        map.<span class="hljs-title function_">setFitView</span>([ startMarker, endMarker, currentMarker ])
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取驾车数据失败：'</span> + result)
      }
    })
  })

})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lexical 富文本编辑器组件详解]]></title>    <link>https://juejin.cn/post/7586509410567438377</link>    <guid>https://juejin.cn/post/7586509410567438377</guid>    <pubDate>2025-12-22T03:18:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567438377" data-draft-id="7586136543954354214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lexical 富文本编辑器组件详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T03:18:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="细心细心再细心"/> <meta itemprop="url" content="https://juejin.cn/user/721738373803879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lexical 富文本编辑器组件详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/721738373803879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    细心细心再细心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:18:04.000Z" title="Mon Dec 22 2025 03:18:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">📚 Lexical 简介</h3>
<p><strong>Lexical</strong> 是 Meta 开源的基于 React 的富文本编辑器框架，用于替代 Draft.js，具有更好的性能、扩展性和稳定性。</p>
<h3 data-id="heading-1">🎯 核心特性</h3>
<ul>
<li>✅ 高性能、可扩展</li>
<li>✅ 无依赖、轻量级</li>
<li>✅ 完整的 TypeScript 支持</li>
<li>✅ 插件化架构</li>
<li>✅ 嵌套编辑器支持</li>
</ul>
<h3 data-id="heading-2">🔧 基础组件</h3>
<h4 data-id="heading-3">1. <strong>LexicalComposer</strong> - 编辑器容器</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> initialConfig = {
    <span class="hljs-attr">namespace</span>: <span class="hljs-string">'MyEditor'</span>,
    <span class="hljs-attr">theme</span>: theme,
    <span class="hljs-attr">nodes</span>: [],
    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error),
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
      {/* 其他插件组件 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-4">2. <strong>RichTextPlugin</strong> - 富文本核心</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">RichTextPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalRichTextPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContentEditable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalContentEditable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HistoryPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalHistoryPlugin'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Editor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>
          &lt;<span class="hljs-attr">ContentEditable</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-input"</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
              <span class="hljs-attr">minHeight:</span> '<span class="hljs-attr">150px</span>',
              <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>',
              <span class="hljs-attr">padding:</span> '<span class="hljs-attr">10px</span>',
            }}
          /&gt;</span>
        }
        placeholder={
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-placeholder"</span>&gt;</span>输入内容...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        }
        ErrorBoundary={LexicalErrorBoundary}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-5">3. <strong>完整的基础编辑器</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">LexicalComposer</span>, 
  <span class="hljs-title class_">RichTextPlugin</span>,
  <span class="hljs-title class_">ContentEditable</span>,
  <span class="hljs-title class_">HistoryPlugin</span>,
  <span class="hljs-title class_">AutoFocusPlugin</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HeadingNode</span>, <span class="hljs-title class_">QuoteNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/rich-text'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TableCellNode</span>, <span class="hljs-title class_">TableNode</span>, <span class="hljs-title class_">TableRowNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/table'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ListNode</span>, <span class="hljs-title class_">ListItemNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/list'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CodeHighlightNode</span>, <span class="hljs-title class_">CodeNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/code'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AutoLinkNode</span>, <span class="hljs-title class_">LinkNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/link'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">TRANSFORMERS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/markdown'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MarkdownShortcutPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalMarkdownShortcutPlugin'</span>;

<span class="hljs-keyword">const</span> theme = {
  <span class="hljs-comment">// 自定义样式</span>
  <span class="hljs-attr">text</span>: {
    <span class="hljs-attr">bold</span>: <span class="hljs-string">'editor-text-bold'</span>,
    <span class="hljs-attr">italic</span>: <span class="hljs-string">'editor-text-italic'</span>,
    <span class="hljs-attr">underline</span>: <span class="hljs-string">'editor-text-underline'</span>,
    <span class="hljs-attr">strikethrough</span>: <span class="hljs-string">'editor-text-strikethrough'</span>,
  }
};

<span class="hljs-keyword">const</span> initialConfig = {
  <span class="hljs-attr">namespace</span>: <span class="hljs-string">'MyEditor'</span>,
  theme,
  <span class="hljs-attr">nodes</span>: [
    <span class="hljs-title class_">HeadingNode</span>,
    <span class="hljs-title class_">QuoteNode</span>,
    <span class="hljs-title class_">TableNode</span>,
    <span class="hljs-title class_">TableCellNode</span>,
    <span class="hljs-title class_">TableRowNode</span>,
    <span class="hljs-title class_">ListNode</span>,
    <span class="hljs-title class_">ListItemNode</span>,
    <span class="hljs-title class_">CodeNode</span>,
    <span class="hljs-title class_">CodeHighlightNode</span>,
    <span class="hljs-title class_">AutoLinkNode</span>,
    <span class="hljs-title class_">LinkNode</span>
  ],
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error),
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyEditor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
          <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>
            &lt;<span class="hljs-attr">ContentEditable</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-input"</span> /&gt;</span>
          }
          placeholder={
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"editor-placeholder"</span>&gt;</span>开始写作...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          }
        /&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">AutoFocusPlugin</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MarkdownShortcutPlugin</span> <span class="hljs-attr">transformers</span>=<span class="hljs-string">{TRANSFORMERS}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-6">🔌 常用插件组件</h3>
<h4 data-id="heading-7">1. <strong>ToolbarPlugin</strong> - 工具栏组件</h4>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">import { 
  $getSelection, 
  $isRangeSelection, 
  FORMAT_TEXT_COMMAND 
} from 'lexical'<span class="hljs-comment">;</span>

function ToolbarPlugin() {
  const <span class="hljs-section">[isBold, setIsBold]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[isItalic, setIsItalic]</span> = useState(false)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">editor</span> = useLexicalComposerContext()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">updateToolbar</span> = useCallback(() =&gt; {
    const <span class="hljs-attr">selection</span> = <span class="hljs-variable">$getSelection</span>()<span class="hljs-comment">;</span>
    if ($isRangeSelection(selection)) {
      setIsBold(selection.hasFormat('bold'))<span class="hljs-comment">;</span>
      setIsItalic(selection.hasFormat('italic'))<span class="hljs-comment">;</span>
    }
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 监听编辑器状态变化
  useEffect(() =&gt; {
    return editor.registerUpdateListener(({ editorState }) =&gt; {
      editorState.read(() =&gt; {
        updateToolbar()<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[editor, updateToolbar]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"toolbar"</span>&gt;
      &lt;button
        <span class="hljs-attr">className</span>={isBold ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>}
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'bold'</span>)}
      &gt;
        加粗
      &lt;/button&gt;
      &lt;button
        <span class="hljs-attr">className</span>={isItalic ? <span class="hljs-string">'active'</span> : <span class="hljs-string">''</span>}
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'italic'</span>)}
      &gt;
        斜体
      &lt;/button&gt;
      &lt;button
        <span class="hljs-attr">onClick</span>={() =&gt; editor.dispatchCommand(FORMAT_TEXT_COMMAND, <span class="hljs-string">'underline'</span>)}
      &gt;
        下划线
      &lt;/button&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">2. <strong>ImagePlugin</strong> - 图片上传</h4>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">import { INSERT_IMAGE_COMMAND } from './ImagePlugin'<span class="hljs-comment">;</span>

function ImagePlugin() {
  const <span class="hljs-section">[editor]</span> = useLexicalComposerContext()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleImageUpload</span> = useCallback((files: FileList) =&gt; {
    const <span class="hljs-attr">reader</span> = new FileReader()<span class="hljs-comment">;</span>
    <span class="hljs-attr">reader.onload</span> = function () {
      if (typeof <span class="hljs-attr">reader.result</span> === <span class="hljs-string">'string'</span>) {
        editor.dispatchCommand(INSERT_IMAGE_COMMAND, {
          altText: '图片',
          src: reader.result,
        })<span class="hljs-comment">;</span>
      }
    }<span class="hljs-comment">;</span>
    reader.readAsDataURL(files<span class="hljs-section">[0]</span>)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[editor]</span>)<span class="hljs-comment">;</span>

  return (
    &lt;input
      <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span>
      <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>
      <span class="hljs-attr">onChange</span>={(e) =&gt; handleImageUpload(e.target.files)}
    /&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-9">3. <strong>LinkPlugin</strong> - 链接处理</h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LinkPlugin</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">LexicalLinkPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalLinkPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LinkNode</span>, <span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/link'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">LinkPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [editor] = <span class="hljs-title function_">useLexicalComposerContext</span>();
  <span class="hljs-keyword">const</span> [isLink, setIsLink] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> insertLink = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!isLink) {
      <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">prompt</span>(<span class="hljs-string">'输入链接地址:'</span>, <span class="hljs-string">'https://'</span>);
      <span class="hljs-keyword">if</span> (url) {
        editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span>, url);
      }
    } <span class="hljs-keyword">else</span> {
      editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">TOGGLE_LINK_COMMAND</span>, <span class="hljs-literal">null</span>);
    }
  }, [editor, isLink]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{insertLink}</span>&gt;</span>
        {isLink ? '取消链接' : '添加链接'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">LexicalLinkPlugin</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">📋 自定义节点组件</h3>
<h4 data-id="heading-11">1. <strong>自定义节点定义</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// CustomNode.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DecoratorNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lexical'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomNode</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">DecoratorNode</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getType</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'custom'</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">clone</span>(<span class="hljs-params">node</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomNode</span>(node.<span class="hljs-property">__key</span>);
  }

  <span class="hljs-title function_">createDOM</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    div.<span class="hljs-property">className</span> = <span class="hljs-string">'custom-node'</span>;
    <span class="hljs-keyword">return</span> div;
  }

  <span class="hljs-title function_">updateDOM</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-title function_">decorate</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">CustomComponent</span> <span class="hljs-attr">nodeKey</span>=<span class="hljs-string">{this.__key}</span> /&gt;</span></span>;
  }
}

<span class="hljs-comment">// 自定义组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CustomComponent</span>(<span class="hljs-params">{ nodeKey }</span>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'自定义内容'</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"custom-component"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setValue(e.target.value)}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 在配置中注册</span>
<span class="hljs-keyword">const</span> initialConfig = {
  <span class="hljs-attr">nodes</span>: [<span class="hljs-title class_">CustomNode</span>, ...其他节点],
};
</code></pre>
<h4 data-id="heading-12">2. <strong>自定义插件示例</strong></h4>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useLexicalComposerContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposerContext'</span>;


<span class="hljs-comment">// 自定义键盘快捷键插件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">KeyboardShortcutPlugin</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [editor] = <span class="hljs-title function_">useLexicalComposerContext</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleKeyDown</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-comment">// Ctrl + S 保存</span>
      <span class="hljs-keyword">if</span> ((event.<span class="hljs-property">ctrlKey</span> || event.<span class="hljs-property">metaKey</span>) &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">'s'</span>) {
        event.<span class="hljs-title function_">preventDefault</span>();
        <span class="hljs-comment">// 保存逻辑</span>
        editor.<span class="hljs-title function_">update</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-keyword">const</span> editorState = editor.<span class="hljs-title function_">getEditorState</span>();
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'保存内容:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(editorState.<span class="hljs-title function_">toJSON</span>()));
        });
      }
      
      <span class="hljs-comment">// Ctrl + B 加粗</span>
      <span class="hljs-keyword">if</span> ((event.<span class="hljs-property">ctrlKey</span> || event.<span class="hljs-property">metaKey</span>) &amp;&amp; event.<span class="hljs-property">key</span> === <span class="hljs-string">'b'</span>) {
        event.<span class="hljs-title function_">preventDefault</span>();
        editor.<span class="hljs-title function_">dispatchCommand</span>(<span class="hljs-variable constant_">FORMAT_TEXT_COMMAND</span>, <span class="hljs-string">'bold'</span>);
      }
    };

    <span class="hljs-keyword">return</span> editor.<span class="hljs-title function_">registerRootListener</span>(<span class="hljs-function">(<span class="hljs-params">rootElement</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (rootElement) {
        rootElement.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, handleKeyDown);
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
          rootElement.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'keydown'</span>, handleKeyDown);
        };
      }
    });
  }, [editor]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<h2 data-id="heading-13">实际使用</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalComposer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposer'</span>;
<span class="hljs-keyword">import</span> { useLexicalComposerContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalComposerContext'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ContentEditable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalContentEditable'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LexicalErrorBoundary</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalErrorBoundary'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HistoryPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalHistoryPlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OnChangePlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalOnChangePlugin'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RichTextPlugin</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@lexical/react/LexicalRichTextPlugin'</span>;


<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VariableTextNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./node'</span>;
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./style.module.css'</span>;

  <span class="hljs-keyword">const</span> initialConfig = {
    <span class="hljs-attr">namespace</span>: <span class="hljs-string">'prompt-composer'</span>,
    <span class="hljs-attr">nodes</span>: [<span class="hljs-title class_">VariableTextNode</span>],
    <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    },
    <span class="hljs-attr">theme</span>: {
      <span class="hljs-attr">paragraph</span>: styles.<span class="hljs-property">editorParagraph</span>,
    },
  };



<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.editorWrapper}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span> <span class="hljs-attr">initialConfig</span>=<span class="hljs-string">{initialConfig}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{cx(styles.editor,</span> <span class="hljs-attr">readOnly</span> &amp;&amp; <span class="hljs-attr">styles.editorReadonly</span>)}
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">height</span>, <span class="hljs-attr">minHeight</span> }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ContentEditable</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.contentEditable}</span> /&gt;</span>}
        placeholder={<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.placeholder}</span>&gt;</span>{placeholder || ''}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        ErrorBoundary={LexicalErrorBoundary}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">OnChangePlugin</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleEditorChange}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HistoryPlugin</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VariablePlugin</span> <span class="hljs-attr">variables</span>=<span class="hljs-string">{variables}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">VariableTransformerPlugin</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">EditorUpdatePlugin</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">OnBlurPlugin</span> <span class="hljs-attr">onBlur</span>=<span class="hljs-string">{onBlur}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span>
  {!readOnly &amp;&amp; (
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.resizeHandle}</span> <span class="hljs-attr">onMouseDown</span>=<span class="hljs-string">{beginResize}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.resizeIcon}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  )}
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-style.module.css" lang="style.module.css">//样式文件
.editorParagraph {
  margin: 0;
  position: relative;
}
</code></pre>
<pre><code class="hljs language-node.ts" lang="node.ts">//自定义节点
import { TextNode, SerializedTextNode, Spread, NodeKey, $applyNodeReplacement } from 'lexical';

import styles from './style.module.css';

export type SerializedVariableTextNode = Spread&lt;
  {
    variableName: string;
  },
  SerializedTextNode
&gt;;

// Custom Text Node to handle variable highlighting
export class VariableTextNode extends TextNode {
  __variableName: string;

  constructor(text: string, variableName: string, key?: NodeKey) {
    super(text, key);
    this.__variableName = variableName;
  }

  static getType(): string {
    return 'variable-text';
  }

  isSimpleText(): boolean {
    return false;
  }

  // Make this node behave as a single unit - cannot be partially selected or edited
  isTextEntity(): boolean {
    return true;
  }

  static clone(node: VariableTextNode): VariableTextNode {
    return new VariableTextNode(node.getTextContent(), node.__variableName, node.getKey());
  }

  createDOM(config: any): HTMLElement {
    const element = super.createDOM(config);
    element.className = styles.variableToken;
    element.dataset.variable = this.__variableName;
    return element;
  }

  updateDOM(prevNode: VariableTextNode, dom: HTMLElement, config: any): boolean {
    const isUpdated = super.updateDOM(prevNode as any, dom, config);
    if (prevNode.__variableName !== this.__variableName) {
      dom.dataset.variable = this.__variableName;
      return true;
    }
    return isUpdated;
  }

  exportJSON(): SerializedVariableTextNode {
    return {
      ...super.exportJSON(),
      variableName: this.__variableName,
      type: 'variable-text',
    };
  }

  static importJSON(serializedNode: SerializedVariableTextNode): VariableTextNode {
    const node = new VariableTextNode(serializedNode.text, serializedNode.variableName);
    node.setFormat(serializedNode.format);
    node.setDetail(serializedNode.detail);
    node.setMode(serializedNode.mode);
    node.setStyle(serializedNode.style);
    return node;
  }
}

export function $createVariableTextNode(text: string, variableName: string): VariableTextNode {
  return $applyNodeReplacement(new VariableTextNode(text, variableName));
}//创建并注册一个VariableTextNode节点实例



</code></pre>
<ul>
<li>$applyNodeReplacement的作用</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"/></pre>
<p>// 这是 Lexical 的内部工具函数
import { $applyNodeReplacement } from 'lexical';</p>
<p>// 它主要做三件事：
function $applyNodeReplacement(newNode) {
// 1. ✅ 检查节点是否已存在（通过 key）
// 2. ✅ 如果存在，返回已存在的节点（避免重复）
// 3. ✅ 如果不存在，注册新节点到编辑器状态
// 4. ✅ 确保节点在编辑器中被正确追踪
}</p>
<pre><code class="hljs"/></pre>
<h3 data-id="heading-14">📝 总结</h3>
<p>Lexical 提供了：</p>
<ol>
<li><strong>模块化架构</strong> - 按需加载插件</li>
<li><strong>完全控制</strong> - 自定义节点和命令</li>
<li><strong>高性能</strong> - 基于不可变数据</li>
<li><strong>扩展性强</strong> - 支持复杂需求</li>
</ol>
<p>推荐使用模式：</p>
<p>jsx</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">LexicalComposer</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Toolbar</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">RichTextPlugin</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">EssentialPlugins</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">CustomPlugins</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">UtilityPlugins</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LexicalComposer</span>&gt;</span>
</code></pre>
<ul>
<li>"@lexical/code": "^0.38.2"</li>
<li>"@lexical/link": "^0.38.2"</li>
<li>"@lexical/list": "^0.38.2"</li>
<li>"@lexical/react": "^0.16.0"</li>
<li>"@lexical/selection": "^0.38.2"</li>
<li>"@lexical/text": "^0.38.2"</li>
<li>"@lexical/utils": "^0.38.2"</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)]]></title>    <link>https://juejin.cn/post/7586157459971506228</link>    <guid>https://juejin.cn/post/7586157459971506228</guid>    <pubDate>2025-12-22T02:54:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459971506228" data-draft-id="7585888537642270735" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-22T02:54:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我有与与症"/> <meta itemprop="url" content="https://juejin.cn/user/4466629837071787"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kuikly 实战：手把手撸一个跨平台 AI 聊天助手 (ChatDemo)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466629837071787/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我有与与症
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:54:08.000Z" title="Mon Dec 22 2025 02:54:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent-TDS%2FKuiklyUI%2Ftree%2Fmain%2Fdemo%2Fsrc%2FcommonMain%2Fkotlin%2Fcom%2Ftencent%2Fkuikly%2Fdemo%2Fpages%2Fcompose%2FchatDemo" target="_blank" title="https://github.com/Tencent-TDS/KuiklyUI/tree/main/demo/src/commonMain/kotlin/com/tencent/kuikly/demo/pages/compose/chatDemo" ref="nofollow noopener noreferrer">GitHub</a></p>
<p> </p>
<p>在这个 AI 大模型满天飞的时代，谁不想拥有一个属于自己的 AI 助手呢？今天，我们就以 ChatDemo 为例，看看如何用一套 Kotlin 代码，在 Android、iOS 和 HarmonyOS 三端上通过 Kuikly Compose 完美复刻 ChatGPT 的流式对话体验。</p>
<p> </p>
<p>别被 AI 的高大上吓跑了，其实拆解下来，核心逻辑就像搭积木一样简单。准备好了吗？发车！</p>
<p> </p>
<h2 data-id="heading-0">页面结构分析</h2>
<p>打开 <code>ChatDemo.kt</code>，我们仿佛看到了一位身材曼妙的“美女”——哦不，是一段结构清晰的代码。整个聊天页面 (<code>ChatScreen</code>) 主要由三部分组成：</p>
<p> </p>
<ol>
<li>
<p>顶部导航栏 (NavBar)：展示标题和返回按钮，雷打不动的“天灵盖”。</p>
</li>
<li>
<p>聊天内容区 (MessageList)：显示对话流，这是核心的“躯干”。</p>
</li>
<li>
<p>底部输入区 (InputArea)：输入框和发送按钮，负责交互的“四肢”。</p>
</li>
</ol>
<p> </p>
<p>这种结构在 Kuikly Compose 中实现起来异常清爽，简直就是“所见即所得”：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 伪代码结构演示</span>

Box(modifier = Modifier.fillMaxSize()) {

    Column {

        NavBar() <span class="hljs-comment">// 1. 天灵盖</span>

        ChatList() <span class="hljs-comment">// 2. 躯干</span>

        InputArea() <span class="hljs-comment">// 3. 四肢</span>
    }
}

</code></pre>
<p> </p>
<h2 data-id="heading-1">Kuikly Compose 写法</h2>
<p> </p>
<h3 data-id="heading-2">页面定义</h3>
<p>不同于之前的 <code>BasePager</code> + DSL，Compose 风格的页面继承自 <code>ComposeContainer</code>，通过 <code>setContent</code> 开启 Compose 的世界：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-meta">@Page(<span class="hljs-string">"ChatDemo"</span>)</span>

<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatDemo</span> : <span class="hljs-type">ComposeContainer</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">willInit</span><span class="hljs-params">()</span></span> {

        <span class="hljs-keyword">super</span>.willInit()

        setContent {

            ChatScreen() <span class="hljs-comment">// 进入 Compose 的声明式 UI 世界</span>

        }
    }
}

</code></pre>
<p>简单粗暴，直接入题！</p>
<p> </p>
<h3 data-id="heading-3">组件与布局</h3>
<p>Kuikly Compose 完美复刻了 Jetpack Compose 的开发体验，让习惯了 Android 开发的同学们倍感亲切。</p>
<p> </p>
<h4 data-id="heading-4">1. 列表组件 (LazyColumn)</h4>
<p>聊天记录怎么展示？<code>LazyColumn</code> 也就是我们常说的 RecyclerView 的“升级版”。</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
LazyColumn(

    state = listState,

    modifier = Modifier.weight(<span class="hljs-number">1f</span>)

) {

    itemsIndexed(chatList) { index, message -&gt;

        <span class="hljs-comment">// 根据 index 判断是用户还是 AI，渲染不同的气泡</span>

        ChatMessageItem(message, isUser = (index % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>))

    }
}

</code></pre>
<p>看到没？没有 Adapter，没有 ViewHolder，就是一个简单的 Lambda，数据驱动 UI，清爽！</p>
<p> </p>
<h4 data-id="heading-5">2. 输入框 (TextField)</h4>
<p>底部的输入框使用了 <code>TextField</code>，这里有一个亮点——键盘避让。Kuikly 贴心地提供了 <code>keyboardHeightChange</code> 修饰符：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
TextField(

    modifier = Modifier

    .keyboardHeightChange {

        <span class="hljs-comment">// 键盘弹起时，自动调整高度，避免遮挡输入框</span>

        keyboardHeight = it.height
    }

)

</code></pre>
<p>这行代码一加，键盘弹起时的页面抖动、遮挡问题统统不见，丝般顺滑。</p>
<p> </p>
<h3 data-id="heading-6">样式与修饰符 (Modifier)</h3>
<p>在 Kuikly Compose 中，<code>attr {}</code> 变成了更强大的 <code>Modifier</code> 链式调用。比如首页那个好看的渐变色卡片：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
Box(
    modifier = Modifier

    .clip(RoundedCornerShape(<span class="hljs-number">16.</span>dp)) <span class="hljs-comment">// 裁个圆角</span>

    .background(

        <span class="hljs-comment">// 来个渐变色</span>

        Brush.horizontalGradient(listOf(box.startColor, box.endColor))
    )
    .clickable { ... } <span class="hljs-comment">// 加个点击事件</span>
)

</code></pre>
<p>这就是声明式 UI 的魅力，你要什么效果，直接往上“叠”就行了。</p>
<p> </p>
<h2 data-id="heading-7">核心黑科技：跨平台流式响应</h2>
<p> </p>
<p>界面画好了，怎么让 AI “动”起来？ChatDemo 的核心在于流式响应 (SSE)，也就是那个酷炫的“打字机”效果。这里展示了 Kuikly 强大的跨平台能力。</p>
<p> </p>
<h3 data-id="heading-8">Android &amp; iOS (Ktor 协程)</h3>
<p>这两兄弟关系好，直接用 Kotlin 协程配合 Ktor 网络库，处理起来行云流水：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// ChatDemo.kt</span>

<span class="hljs-keyword">val</span> channel = response.bodyAsChannel()

<span class="hljs-keyword">while</span> (!channel.isClosedForRead) {

    <span class="hljs-keyword">val</span> line = channel.readUTF8Line()

    <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"data:"</span>)) {
        <span class="hljs-comment">// 收到数据，更新 UI</span>
        withContext(Dispatchers.Main) {
            chatList[msgIndex] += delta <span class="hljs-comment">// 界面自动刷新</span>
        }
    }
}

</code></pre>
<p> </p>
<h3 data-id="heading-9">HarmonyOS (Native Module 桥接)</h3>
<p>鸿蒙这位新朋友，Kuikly 也有妙招。在第三方组件Ktor还未完善对鸿蒙的支持情况下，Kuikly提供了Module 桥接机制，99% 的代码用 KMP 共享，剩下 1% 搞不定的平台特性，通过 Module 轻松桥接原生能力。通过 <code>OhosStreamRequestModule</code>，我们能轻松调用鸿蒙原生的 ArkTS 能力：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// OhosStreamRequestModule.kt</span>

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">request</span><span class="hljs-params">(...)</span></span> {

    <span class="hljs-comment">// 呼叫鸿蒙原生层：帮我发个请求！</span>

    toNative(<span class="hljs-literal">true</span>, <span class="hljs-string">"request"</span>, params) { retEvent -&gt;
        <span class="hljs-comment">// 原生层收到 SSE 数据，回传给 Kotlin</span>
        callbackFn.invoke(eventObj)
    }
}

</code></pre>
<p>这就是 Kuikly 的哲学：能通用的通用，不能通用的桥接。一套架构，搞定所有平台。</p>
<p> </p>
<h2 data-id="heading-10">细节打磨：Markdown 渲染</h2>
<p>AI 返回的代码块、加粗字体怎么显示？直接塞进 <code>Text</code> 肯定不行。Kuikly 提供了 <code>Markdown</code> 组件：</p>
<p> </p>
<pre><code class="hljs language-kotlin" lang="kotlin">
Markdown(
    state = markdownState,
    colors = markdownColor(text = Color.Black), <span class="hljs-comment">// 定制颜色</span>
    typography = markdownTypography() <span class="hljs-comment">// 定制排版</span>
)

</code></pre>
<p>它能实时解析流式传输过来的 Markdown 文本，渲染过程毫无闪烁，稳如老狗。</p>
<p> </p>
<h2 data-id="heading-11">总结</h2>
<p>通过 Review <code>ChatDemo</code> 的源码，我们不仅学会了如何画界面，更解锁了 AI 应用开发的核心技能：</p>
<p> </p>
<ol>
<li>
<p>Compose 写法：用 <code>Modifier</code> 和声明式组件构建 UI，效率起飞。</p>
</li>
<li>
<p>状态管理：<code>mutableState</code> 让数据驱动界面更新，告别繁琐的 <code>setText</code>。</p>
</li>
<li>
<p>跨平台架构：Ktor 处理标准平台，Module 桥接新兴平台（鸿蒙），游刃有余。</p>
</li>
</ol>
<p> </p>
<p>Kuikly 已经把“地基”打好了，剩下的就看你们如何在上面盖出万丈高楼了！今天的代码 Review 就到这里，还不快去 Clone 下来跑一跑？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 => 打包报错]]></title>    <link>https://juejin.cn/post/7586509410567585833</link>    <guid>https://juejin.cn/post/7586509410567585833</guid>    <pubDate>2025-12-22T03:33:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586509410567585833" data-draft-id="7585751355593703443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 =&gt; 打包报错"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T03:33:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦想是准点下班"/> <meta itemprop="url" content="https://juejin.cn/user/2192851914196873"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【vue3】 + 【vite】 + 【rollup-plugin-obfuscator】混淆打包 =&gt; 打包报错
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2192851914196873/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦想是准点下班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:33:26.000Z" title="Mon Dec 22 2025 03:33:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>rollup-plugin-obfuscator</code> 可以在基于 Vite 的 Vue 3 项目中使用，因为 Vite 本身就是基于 Rollup 构建的</p>
<p>npm install --save-dev rollup-plugin-obfuscator javascript-obfuscator</p>
<p>yarn add javascript-obfuscator -D</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> obfuscator <span class="hljs-keyword">from</span> <span class="hljs-string">'rollup-plugin-obfuscator'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// base: "",</span>
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">minify</span>: <span class="hljs-string">'esbuild'</span>, <span class="hljs-comment">// 默认</span>
  },
  <span class="hljs-attr">esbuild</span>: {
    <span class="hljs-attr">drop</span>: [<span class="hljs-string">'console'</span>, <span class="hljs-string">'debugger'</span>],<span class="hljs-comment">//打包去除</span>
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">obfuscator</span>({
      <span class="hljs-attr">global</span>:<span class="hljs-literal">false</span>,
      <span class="hljs-comment">// options配置项实际为 javascript-obfuscator 选项，具体可查看https://github.com/javascript-obfuscator/javascript-obfuscator</span>
      <span class="hljs-attr">options</span>: {
        <span class="hljs-attr">compact</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">controlFlowFlattening</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">controlFlowFlatteningThreshold</span>: <span class="hljs-number">0.75</span>,
        <span class="hljs-attr">numbersToExpressions</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">simplify</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayShuffle</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">splitStrings</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">splitStringsChunkLength</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">rotateUnicodeArray</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">deadCodeInjection</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">deadCodeInjectionThreshold</span>: <span class="hljs-number">0.4</span>,
        <span class="hljs-attr">debugProtection</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">debugProtectionInterval</span>: <span class="hljs-number">2000</span>,
        <span class="hljs-attr">disableConsoleOutput</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">domainLock</span>: [],
        <span class="hljs-attr">identifierNamesGenerator</span>: <span class="hljs-string">"hexadecimal"</span>,
        <span class="hljs-attr">identifiersPrefix</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">inputFileName</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">log</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">renameGlobals</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">reservedNames</span>: [],
        <span class="hljs-attr">reservedStrings</span>: [],
        <span class="hljs-attr">seed</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">selfDefending</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">sourceMap</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">sourceMapBaseUrl</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">sourceMapFileName</span>: <span class="hljs-string">""</span>,
        <span class="hljs-attr">sourceMapMode</span>: <span class="hljs-string">"separate"</span>,
        <span class="hljs-attr">stringArray</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayEncoding</span>: [<span class="hljs-string">"base64"</span>],
        <span class="hljs-attr">stringArrayThreshold</span>: <span class="hljs-number">0.75</span>,
        <span class="hljs-attr">target</span>: <span class="hljs-string">"browser"</span>,
        <span class="hljs-attr">transformObjectKeys</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">unicodeEscapeSequence</span>: <span class="hljs-literal">true</span>,

        <span class="hljs-attr">domainLockRedirectUrl</span>: <span class="hljs-string">"about:blank"</span>,
        <span class="hljs-attr">forceTransformStrings</span>: [],
        <span class="hljs-attr">identifierNamesCache</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">identifiersDictionary</span>: [],
        <span class="hljs-attr">ignoreImports</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">optionsPreset</span>: <span class="hljs-string">"default"</span>,
        <span class="hljs-attr">renameProperties</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">renamePropertiesMode</span>: <span class="hljs-string">"safe"</span>,
        <span class="hljs-attr">sourceMapSourcesMode</span>: <span class="hljs-string">"sources-content"</span>,
       
        <span class="hljs-attr">stringArrayCallsTransform</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayCallsTransformThreshold</span>: <span class="hljs-number">0.5</span>,
       
        <span class="hljs-attr">stringArrayIndexesType</span>: [<span class="hljs-string">"hexadecimal-number"</span>],
        <span class="hljs-attr">stringArrayIndexShift</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayRotate</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayWrappersCount</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">stringArrayWrappersChainedCalls</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">stringArrayWrappersParametersMaxCount</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">stringArrayWrappersType</span>: <span class="hljs-string">"variable"</span>,
      }
    })
  ]
})

</code></pre>
<p>打包报错……</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器]]></title>    <link>https://juejin.cn/post/7585751355593834515</link>    <guid>https://juejin.cn/post/7585751355593834515</guid>    <pubDate>2025-12-22T03:33:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593834515" data-draft-id="7586509410567536681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器 "/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-22T03:33:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="儿歌八万首"/> <meta itemprop="url" content="https://juejin.cn/user/3034307822894333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 自定义 View 实战：打造一个跟随滑动的丝滑指示器 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307822894333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    儿歌八万首
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:33:37.000Z" title="Mon Dec 22 2025 03:33:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Android 开发中，我们经常需要为 <code>RecyclerView</code>、<code>ViewPager</code> 或 <code>HorizontalScrollView</code> 添加一个可视化的滚动指示器。虽然系统自带的 ScrollBar 能满足基本需求，但如果 UI 设计要求指示器有固定的宽度、圆角以及特定的颜色，自定义 View 往往是最佳选择。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a0c083739fd4b53a2c868c8355b1731~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YS_5q2M5YWr5LiH6aaW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766979217&amp;x-signature=YBCuhfCI3YuEJoPIIuQwPwpfeV8%3D" alt="" loading="lazy"/></p>
<p>本文将带你使用 Kotlin 实现一个轻量级、高性能的水平滑动指示器组件 <code>BottomLineView</code>，并详细讲解如何适配主流的滚动控件。</p>
<h2 data-id="heading-0">1. 核心组件实现：BottomLineView</h2>
<p>我们创建一个继承自 <code>View</code> 的类 <code>BottomLineView</code>。它不依赖具体的滚动控件，只接收<strong>指示器宽度</strong>和<strong>滚动比例</strong>两个参数，实现了高度解耦。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BottomLineView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
) : View(context, attrs, defStyleAttr) {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> paintGray: Paint  <span class="hljs-comment">// 背景线画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> paintGreen: Paint <span class="hljs-comment">// 指示器画笔</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> indicatorWidth = <span class="hljs-number">0f</span> <span class="hljs-comment">// 指示器的固定宽度</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentOffset = <span class="hljs-number">0f</span>  <span class="hljs-comment">// 当前偏移量</span>

    <span class="hljs-keyword">init</span> {
        initPaint()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initPaint</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 背景线：灰色，圆角</span>
        paintGray = Paint().apply {
            color = -<span class="hljs-number">0x333334</span> <span class="hljs-comment">// 0xFFCCCCCC</span>
            strokeCap = Paint.Cap.ROUND
            strokeWidth = <span class="hljs-number">10f</span>
            isAntiAlias = <span class="hljs-literal">true</span>
        }
        <span class="hljs-comment">// 指示器：绿色，圆角</span>
        paintGreen = Paint().apply {
            color = -<span class="hljs-number">0xff0100</span> <span class="hljs-comment">// 0xFF00FF00</span>
            strokeCap = Paint.Cap.ROUND
            strokeWidth = <span class="hljs-number">10f</span>
            isAntiAlias = <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)
        <span class="hljs-keyword">val</span> centerY = height / <span class="hljs-number">2f</span>
        <span class="hljs-keyword">val</span> totalWidth = width.toFloat()

        <span class="hljs-comment">// 1. 绘制背景线</span>
        canvas.drawLine(<span class="hljs-number">0f</span>, centerY, totalWidth, centerY, paintGray)

        <span class="hljs-comment">// 2. 绘制指示器（确保不越界）</span>
        <span class="hljs-keyword">val</span> start = max(<span class="hljs-number">0f</span>, min(currentOffset, totalWidth - indicatorWidth))
        <span class="hljs-keyword">val</span> end = start + indicatorWidth

        <span class="hljs-keyword">if</span> (indicatorWidth &gt; <span class="hljs-number">0</span>) {
            canvas.drawLine(start, centerY, end, centerY, paintGreen)
        }
    }

    <span class="hljs-comment">/** 设置指示器物理宽度 */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setIndicatorWidth</span><span class="hljs-params">(width: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">this</span>.indicatorWidth = width
        invalidate()
    }

    <span class="hljs-comment">/** 更新滚动比例 (0.0 ~ 1.0) */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateScrollRatio</span><span class="hljs-params">(ratio: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">val</span> maxOffset = width - indicatorWidth
        <span class="hljs-keyword">this</span>.currentOffset = maxOffset * ratio
        invalidate()
    }
}
</code></pre>
<h2 data-id="heading-1">2. 场景适配指南</h2>
<p>下面是三种最常见的滚动控件适配方案。</p>
<h3 data-id="heading-2">场景一：与 RecyclerView 联动</h3>
<p>这是最常用的场景。利用 <code>computeHorizontalScrollXXX</code> 系列方法可以精确计算滚动位置。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 设置指示器宽度</span>
bottomLineView.setIndicatorWidth(<span class="hljs-number">100f</span>)

<span class="hljs-comment">// 2. 监听滚动</span>
recyclerView.addOnScrollListener(<span class="hljs-keyword">object</span> : RecyclerView.OnScrollListener() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onScrolled</span><span class="hljs-params">(recyclerView: <span class="hljs-type">RecyclerView</span>, dx: <span class="hljs-type">Int</span>, dy: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 获取滚动参数</span>
        <span class="hljs-keyword">val</span> offset = recyclerView.computeHorizontalScrollOffset() <span class="hljs-comment">// 当前偏移</span>
        <span class="hljs-keyword">val</span> range = recyclerView.computeHorizontalScrollRange()   <span class="hljs-comment">// 内容总宽</span>
        <span class="hljs-keyword">val</span> extent = recyclerView.computeHorizontalScrollExtent() <span class="hljs-comment">// 可见宽度</span>
        
        <span class="hljs-comment">// 计算最大可滚动距离</span>
        <span class="hljs-keyword">val</span> maxScroll = range - extent
        
        <span class="hljs-keyword">if</span> (maxScroll &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">val</span> ratio = offset.toFloat() / maxScroll
            bottomLineView.updateScrollRatio(ratio)
        }
    }
})
</code></pre>
<h3 data-id="heading-3">场景二：与 HorizontalScrollView 联动</h3>
<p><code>HorizontalScrollView</code> 需要 API 23 (Android 6.0) 以上才能通过 <code>setOnScrollChangeListener</code> 监听。如果是低版本，可能需要继承并重写 <code>onScrollChanged</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">horizontalScrollView.setOnScrollChangeListener { _, scrollX, _, _, _ -&gt;
    <span class="hljs-comment">// 1. 获取子 View (内容)</span>
    <span class="hljs-keyword">val</span> contentView = horizontalScrollView.getChildAt(<span class="hljs-number">0</span>) ?: <span class="hljs-keyword">return</span><span class="hljs-symbol">@setOnScrollChangeListener</span>
    
    <span class="hljs-comment">// 2. 计算最大可滚动距离 = 内容宽度 - 容器宽度</span>
    <span class="hljs-keyword">val</span> maxScroll = contentView.width - horizontalScrollView.width
    
    <span class="hljs-keyword">if</span> (maxScroll &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">val</span> ratio = scrollX.toFloat() / maxScroll
        bottomLineView.updateScrollRatio(ratio)
    }
}
</code></pre>
<h3 data-id="heading-4">场景三：与 ViewPager2 联动</h3>
<p><code>ViewPager2</code> 的计算逻辑略有不同，因为它是按“页”滚动的。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">viewPager2.registerOnPageChangeCallback(<span class="hljs-keyword">object</span> : ViewPager2.OnPageChangeCallback() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageScrolled</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>, positionOffset: <span class="hljs-type">Float</span>, positionOffsetPixels: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onPageScrolled(position, positionOffset, positionOffsetPixels)
        
        <span class="hljs-comment">// 假设 Adapter 中有 itemCount</span>
        <span class="hljs-keyword">val</span> itemCount = adapter.itemCount
        
        <span class="hljs-keyword">if</span> (itemCount &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 计算总进度</span>
            <span class="hljs-comment">// 当前页索引 + 当前页偏移百分比</span>
            <span class="hljs-keyword">val</span> currentProgress = position + positionOffset
            
            <span class="hljs-comment">// 总的可移动页数 = 总页数 - 1</span>
            <span class="hljs-keyword">val</span> totalProgress = (itemCount - <span class="hljs-number">1</span>).toFloat()
            
            <span class="hljs-keyword">val</span> ratio = currentProgress / totalProgress
            bottomLineView.updateScrollRatio(ratio)
        }
    }
})
</code></pre>
<h2 data-id="heading-5">3. 总结</h2>
<p>通过将 UI 绘制逻辑封装在 <code>BottomLineView</code> 内部，并将状态更新抽象为 <code>updateScrollRatio(0.0~1.0)</code> 接口，我们成功地让这个指示器适配了 Android 所有的水平滚动组件。无论底层是用 RecyclerView 还是 ViewPager，UI 层的表现都一样丝滑流畅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>