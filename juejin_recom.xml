<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Vue3 动态路由下的 KeepAlive 设计方案]]></title>    <link>https://juejin.cn/post/7591672090790920211</link>    <guid>https://juejin.cn/post/7591672090790920211</guid>    <pubDate>2026-01-06T01:01:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591672090790920211" data-draft-id="7591715454134730815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 动态路由下的 KeepAlive 设计方案"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-06T01:01:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zmirror"/> <meta itemprop="url" content="https://juejin.cn/user/676954892932935"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 动态路由下的 KeepAlive 设计方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/676954892932935/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zmirror
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:01:43.000Z" title="Tue Jan 06 2026 01:01:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    34
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">1. 组件设置 name</h3>
<blockquote>
<p>核心：keep-alive 只认组件 name，所以 cachedViews 或 include 必须用组件 name，而不是路由 name。</p>
</blockquote>
<h4 data-id="heading-1">1. defineComponent模式</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;script lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { defineComponent} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'CustomName'</span>
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-2">2. setup语法糖</h4>
<blockquote>
<p>需要单独新增一个script标签</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 页面为 TSX 时，需将 &lt;script&gt; 标签改为 lang="tsx"</span>
&lt;script lang=<span class="hljs-string">"ts"</span>&gt;
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'CustomName'</span>,
    <span class="hljs-attr">inheritAttrs</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">customOptions</span>: {}
  }
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-3">3. 借助插件</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvue-macros%2Fvue-macros" target="_blank" title="https://github.com/vue-macros/vue-macros" ref="nofollow noopener noreferrer">vue-macros 插件</a></p>
<h3 data-id="heading-4">2. 动态生成组件 name 的实践方案</h3>
<blockquote>
<p>相较于前端存储全量路由结合接口权限过滤的方案，此方案借助 Vue2 createCustomComponent 的思路：</p>
</blockquote>
<ul>
<li>每条路由都会生成一个独立的组件对象，并为其分配唯一的 <code>name</code></li>
<li>在动态生成组件时，将组件的 <code>name</code> 设置为基于路由 <code>path</code> 处理后的安全名称</li>
</ul>
<h4 data-id="heading-5">1. createCustomComponent</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineAsyncComponent, defineComponent, h } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">/**
* <span class="hljs-doctag">@param</span> {<span class="hljs-type"> String </span>} name 组件自定义名称
* <span class="hljs-doctag">@param</span> {<span class="hljs-type"> Component | Promise&lt;Component&gt; </span>} <span class="hljs-variable">componentPromise</span>
* <span class="hljs-doctag">@return</span> {<span class="hljs-type"> Component </span>}
*/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createCustomComponent</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, componentPromise: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-comment">// 1. 将 Promise 包装成标准的异步组件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComp</span> = <span class="hljs-title function_">defineAsyncComponent</span>({
    <span class="hljs-attr">loader</span>: <span class="hljs-function">() =&gt;</span>
      componentPromise <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span> ? componentPromise : <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(componentPromise),
    <span class="hljs-comment">// 如果需要，可以在这里配置 loadingComponent</span>
  });

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">defineComponent</span>({
    name, <span class="hljs-comment">// 必须设置，用于匹配 keep-alive 的 include</span>
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 2. 直接返回渲染函数，渲染异步组件</span>
      <span class="hljs-comment">// 移除外层的 div，让 AsyncComp 成为 KeepAlive 的直接子级</span>
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">AsyncComp</span>);
    },
  });
}
</code></pre>
<h4 data-id="heading-6">2. 组件名转化</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 将 path 转成合法的组件名，避免 '/' 等字符</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genComponentNameByPath</span>(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\//g</span>, <span class="hljs-string">"_"</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^_/</span>, <span class="hljs-string">""</span>);
}
</code></pre>
<h4 data-id="heading-7">3. 路由接入示例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/views/dashboard/index.vue"</span>)
<span class="hljs-comment">// 调整为</span>
<span class="hljs-attr">component</span>: <span class="hljs-title function_">createCustomComponent</span>(<span class="hljs-string">"Dashboard"</span>, <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/views/dashboard/index.vue"</span>))
</code></pre>
<h3 data-id="heading-8">3. 通用组件缓存策略</h3>
<blockquote>
<p>疑问：如果共用一个组件来进行创建、编辑、详情，怎么根据路径进行匹配？</p>
</blockquote>
<p>假设路径是：<code>/banner-list/banner-create</code>、<code>/banner-list/banner-edit</code>、<code>/banner-list/banner-detail</code>
需要先进行路径命中匹配，无法命中则直接进行默认匹配：</p>
<ul>
<li>先解析上层路径，找到文件所在位置</li>
<li>再进行精准匹配，比如：公共组件统一命名为：basic-component</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 扫描views目录下的vue文件</span>
<span class="hljs-keyword">const</span> modules = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-title function_">glob</span>(<span class="hljs-string">"@/views/**/**.vue"</span>);
<span class="hljs-comment">// 全局需要 keepAlive 的 path 列表</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">pathKeepAliveList</span>: <span class="hljs-built_in">string</span>[] = [];

<span class="hljs-comment">/**
* 解析后端返回的路由数据
* <span class="hljs-doctag">@param</span> rawRoutes 后端返回的原始路由数据
* <span class="hljs-doctag">@returns</span> 解析后的路由配置数组
*/</span>
<span class="hljs-keyword">const</span> parseDynamicRoutes = (<span class="hljs-attr">rawRoutes</span>: <span class="hljs-title class_">AsyncRouter</span>[]): <span class="hljs-title class_">RouteRecordRaw</span>[] =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">parsedRoutes</span>: <span class="hljs-title class_">RouteRecordRaw</span>[] = [];

  rawRoutes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">childrenColumn</span>: <span class="hljs-title class_">RouteRecordRaw</span> = {
      <span class="hljs-attr">path</span>: item.<span class="hljs-property">path</span>,
      <span class="hljs-attr">name</span>: item.<span class="hljs-property">name</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title class_">Layout</span>,
      <span class="hljs-attr">meta</span>: {
        <span class="hljs-attr">title</span>: item.<span class="hljs-property">name</span>,
        <span class="hljs-attr">icon</span>: item.<span class="hljs-property">icon</span>,
      },
      <span class="hljs-attr">children</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-title class_">RouteRecordRaw</span>[],
    };
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">children</span>?.<span class="hljs-property">length</span>) {
      childrenColumn.<span class="hljs-property">redirect</span> = item.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>].<span class="hljs-property">path</span>;
      item.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> {
        childrenColumn.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">path</span>: v.<span class="hljs-property">path</span>,
          <span class="hljs-attr">name</span>: v.<span class="hljs-property">path</span>,
          <span class="hljs-attr">meta</span>: {
            <span class="hljs-attr">title</span>: v.<span class="hljs-property">name</span>,
            <span class="hljs-comment">// 满足条件的path开启 keepAlive</span>
            <span class="hljs-attr">keepAlive</span>: pathKeepAliveList.<span class="hljs-title function_">includes</span>(v.<span class="hljs-property">path</span>),
            <span class="hljs-comment">// 取二级路由为高亮，兼容二、三级路由匹配</span>
            <span class="hljs-attr">activeMenu</span>: v.<span class="hljs-property">path</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^/</span>[^<span class="hljs-regexp">/]+/</span>[^<span class="hljs-regexp">/]+/</span>)?.[<span class="hljs-number">0</span>],
          },
          <span class="hljs-attr">component</span>: <span class="hljs-title function_">createCustomComponent</span>(v.<span class="hljs-property">path</span>, modules[<span class="hljs-string">`/src/views<span class="hljs-subst">${v.path}</span>/index.vue`</span>]),
        });
      });
    }

    parsedRoutes.<span class="hljs-title function_">push</span>(childrenColumn);
  });

  <span class="hljs-keyword">return</span> parsedRoutes;
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise实例方法解析：then()、catch()、finally()]]></title>    <link>https://juejin.cn/post/7591715454134812735</link>    <guid>https://juejin.cn/post/7591715454134812735</guid>    <pubDate>2026-01-06T01:08:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591715454134812735" data-draft-id="7591715454134796351" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise实例方法解析：then()、catch()、finally()"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T01:08:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise实例方法解析：then()、catch()、finally()
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:08:47.000Z" title="Tue Jan 06 2026 01:08:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本专栏聚焦Promise的核心原理与高级应用，包含：
✓ Promise A+规范深度解读
✓ 手写实现与源码分析
✓ 异步编程设计模式
✓ 性能调优与错误处理</p>
</blockquote>
<blockquote>
<p>适合有JavaScript基础，希望深入异步编程的开发者。我们将用最少的篇幅，讲透最核心的知识。</p>
</blockquote>
<h2 data-id="heading-0">引言：Promise实例方法</h2>
<p>在之前的文章中，我们探讨了Promise的状态机模型和不可变原则。理解了Promise的内在状态后，现在让我们转向它的外在行为——实例方法。如果说状态是Promise的"骨骼"，那么实例方法就是它的"肌肉"，赋予了Promise处理异步操作的能力。</p>
<p>我们可以把Promise就像一台自动咖啡机。状态（<code>pending</code>、<code>fulfilled</code>、<code>rejected</code>）是它的指示灯，而<code>then()</code>、<code>catch()</code>、<code>finally()</code>方法就是它的操作按钮。只有了解每个按钮的确切功能和使用时机，我们才能制作出一杯完美的"异步咖啡"。</p>
<h2 data-id="heading-1">then()方法：链式调用的核心</h2>
<h3 data-id="heading-2">then()的基本语法</h3>
<p><code>Then()</code>方法是为Promise对象添加处理程序的主要方法，也是Promise中最核心、最复杂的方法。它可以接受两个参数：<code>onResolved处理函数</code> 和 <code>onRejected处理函数</code> 。这两个参数都是可选的，如果提供的话，则会在Promise进入 <code>fulfilled</code> 和 <code>rejected</code> 状态时执行，如以下示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onResolved</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"resolved:"</span> + id)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onRejected</span>(<span class="hljs-params">id</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"rejected:"</span> + id)
}

<span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-title function_">resolve</span>())
<span class="hljs-keyword">let</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>())

p1.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onResolved</span>(<span class="hljs-string">'p1'</span>),
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onRejected</span>(<span class="hljs-string">'p1'</span>))
p2.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onResolved</span>(<span class="hljs-string">'p2'</span>),
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">onRejected</span>(<span class="hljs-string">'p2'</span>))
</code></pre>
<p>上述代码中，由于Promise只能转换一次状态，所以p1和p2这两个操作一定是互斥的，其结果为：</p>
<pre><code class="hljs language-bash" lang="bash">resolved:p1
rejected:p2
</code></pre>
<p>由于<code>onResolved处理函数</code> 和 <code>onRejected处理函数</code> 这两个参数都是可选的，当我们只想提供 <code>onRejected处理函数</code> 时，可以在 <code>onResolved</code> 的位置上传入undefined或null，这样可以避免在内存中创建多余的对象，因此then()方法在实际使用中，其传参方式有三种：</p>
<pre><code class="hljs language-javascript" lang="javascript">promise.<span class="hljs-title function_">then</span>(onFulfilled)  <span class="hljs-comment">// 只处理成功</span>
promise.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected)  <span class="hljs-comment">// 只处理失败（不推荐）</span>
promise.<span class="hljs-title function_">then</span>(onFulfilled, onRejected)  <span class="hljs-comment">// 同时处理成功和失败</span>
</code></pre>
<blockquote>
<p>注：</p>
<ul>
<li>then()方法中，也可以传递一个非函数，如：promise.then(’Hello‘)，但会被静默忽略，因此不推荐这种写法。</li>
<li>promise.then(null, onRejected)这种写法也是不推荐的，因为一般默认要处理成功回调。</li>
</ul>
</blockquote>
<h3 data-id="heading-3">then()的链式调用</h3>
<p>Promise真正的威力来自于then()的链式调用能力，这不仅仅是语法糖，而是一种函数式编程范式的体现。我们来看看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 一个典型的链式调用示例</span>
<span class="hljs-title function_">fetchUserData</span>(userId)
  .<span class="hljs-title function_">then</span>(validateUser)            <span class="hljs-comment">// 1. 验证用户数据</span>
  .<span class="hljs-title function_">then</span>(enrichWithProfile)       <span class="hljs-comment">// 2. 丰富个人信息</span>
  .<span class="hljs-title function_">then</span>(saveToDatabase)          <span class="hljs-comment">// 3. 保存到数据库</span>
  .<span class="hljs-title function_">then</span>(notifySubscribers)       <span class="hljs-comment">// 4. 通知订阅者</span>
  .<span class="hljs-title function_">then</span>(updateCache)             <span class="hljs-comment">// 5. 更新缓存</span>
  .<span class="hljs-title function_">then</span>(finalizeOperation);      <span class="hljs-comment">// 6. 完成操作</span>
</code></pre>
<h4 data-id="heading-4">链式调用的四种返回值模式</h4>
<h5 data-id="heading-5">返回普通值</h5>
<p>当then()方法中返回一个普通值时，该值会被包装为一个新的Promise对象，如以下示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello'</span>);
})

myPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到:'</span>, value);
    <span class="hljs-keyword">return</span> <span class="hljs-string">'新的普通值'</span>;  <span class="hljs-comment">// 自动包装为 Promise.resolve('新的普通值')</span>
}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">newValue</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'链式传递:'</span>, newValue);  <span class="hljs-comment">// '新的普通值'</span>
});
</code></pre>
<h5 data-id="heading-6">返回Promise</h5>
<p>当then()方法中返回一个Promise对象时，会等待该Promise完成后，继续下一个then()方法的链式调用，如以下示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello'</span>)
})

myPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-title function_">resolve</span>(value + <span class="hljs-string">' World'</span>)
    }) <span class="hljs-comment">// 返回新的Promise</span>
}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-comment">// 等待new Promise完成</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'处理后的结果:'</span>, response)  <span class="hljs-comment">// Hello World</span>
});

</code></pre>
<h5 data-id="heading-7">抛出异常</h5>
<p>当then()方法中抛出异常时，会转换为一个rejected的Promise对象，如以下示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello'</span>)
})

myPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (!value.<span class="hljs-property">valid</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'数据无效'</span>)  <span class="hljs-comment">// 等价于 Promise.reject(new Error('数据无效'))</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">processValue</span>(value)
}).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到错误:'</span>, error.<span class="hljs-property">message</span>)  <span class="hljs-comment">// '数据无效'</span>
})
</code></pre>
<h5 data-id="heading-8">没有返回或返回undefined</h5>
<p>当then()方法中没有返回值，或返回值为undefined时，会将undefined作为一个值，继续传递，如以下示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello'</span>)
})

myPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'处理值:'</span>, value)
    <span class="hljs-comment">// 没有return语句</span>
}).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">nextValue</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'下一个值:'</span>, nextValue)  <span class="hljs-comment">// undefined</span>
})
</code></pre>
<h2 data-id="heading-9">catch()方法：错误处理</h2>
<h3 data-id="heading-10">catch()的本质</h3>
<p><code>Catch()</code> 用于给Promise添加拒绝处理程序，它只接受一个参数：<code>onRejected处理函数</code>。实际上，catch()方法是一个语法糖，相当于then(null, onRejected)的语法，它的出现极大地提高了代码的可读性。我们来看看下面一个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 以下两种写法完全等价</span>
promise.<span class="hljs-title function_">catch</span>(onRejected)
promise.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected)

<span class="hljs-comment">// 但.catch()的可读性更好</span>
<span class="hljs-title function_">fetchData</span>()
  .<span class="hljs-title function_">then</span>(process)
  .<span class="hljs-title function_">catch</span>(handleError)  <span class="hljs-comment">// 清晰：这里处理错误</span>
  .<span class="hljs-title function_">then</span>(continueAfterError)

<span class="hljs-comment">// 对比：使用.then()的第二个参数</span>
<span class="hljs-title function_">fetchData</span>()
  .<span class="hljs-title function_">then</span>(process, handleError)  <span class="hljs-comment">// 不清晰：是处理fetch错误还是process错误？</span>
  .<span class="hljs-title function_">then</span>(continueAfterError)
</code></pre>
<h3 data-id="heading-11">错误传播机制</h3>
<p>Promise的错误处理遵循冒泡原则：错误会沿着Promise链向后传递，直到被捕获，如以下示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误传播示例</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'步骤1: 成功'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">'第一步结果'</span>
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'步骤2: 收到'</span>, result)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'步骤2发生错误'</span>)  <span class="hljs-comment">// 抛出错误</span>
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'步骤3: 这行不会执行'</span>)  <span class="hljs-comment">// 被跳过</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">'第三步结果'</span>;
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到错误:'</span>, error.<span class="hljs-property">message</span>)  <span class="hljs-comment">// '步骤2发生错误'</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">'从错误中恢复'</span>;
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">recovery</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'恢复后继续:'</span>, recovery)  <span class="hljs-comment">// '从错误中恢复'</span>
    });
</code></pre>
<h2 data-id="heading-12">finally()方法：资源清理</h2>
<h3 data-id="heading-13">finally()方法的独特性</h3>
<p><code>Finally()</code>方法用于给Promise实例添加 <code>onFinally处理程序</code>，这个方法可以避免<code>onResolved处理函数</code> 和 <code>onRejected处理函数</code> 中出现冗余代码，无论Promise状态为 <code>fulfilled</code> 或 <code>rejected</code> 的都会执行，即无论Promise是成功还是失败，它都会执行。我们来看看下面的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// .finally()的基本使用</span>
<span class="hljs-title function_">fetchData</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据处理:'</span>, data);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">process</span>(data);
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'处理失败:'</span>, error);
        <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// 重新抛出，让外部知道失败</span>
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清理资源'</span>);  <span class="hljs-comment">// 无论成功失败都会执行</span>
        <span class="hljs-title function_">cleanupResources</span>();
    });
</code></pre>
<h3 data-id="heading-14">finally()方法的三个特性</h3>
<h4 data-id="heading-15">不接受参数</h4>
<pre><code class="hljs language-javascript" lang="javascript">promise.<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 这里无法访问Promise的结果或错误原因</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行清理'</span>)
})
</code></pre>
<h4 data-id="heading-16">原样传递上游的结果或错误</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'成功数据'</span>)
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'finally执行'</span>);
        <span class="hljs-comment">// 这里返回的值不会影响链的传递</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">'finally的返回值会被忽略'</span>;
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到:'</span>, value);  <span class="hljs-comment">// '成功数据'，不是'finally的返回值'</span>
    })
</code></pre>
<h4 data-id="heading-17">如果finally抛出错误，会覆盖之前的错误</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'原始数据'</span>)
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'finally中的错误'</span>);  <span class="hljs-comment">// 这个错误会覆盖之前的结果</span>
    })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这不会执行'</span>);  <span class="hljs-comment">// 被跳过</span>
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获的错误:'</span>, error.<span class="hljs-property">message</span>);  <span class="hljs-comment">// 'finally中的错误'</span>
    });
</code></pre>
<h2 data-id="heading-18">总结</h2>
<h3 data-id="heading-19">方法对比总结</h3>

































<table><thead><tr><th>方法</th><th>主要用途</th><th>返回值影响</th><th>执行时机</th><th>最佳实践</th></tr></thead><tbody><tr><td>then()</td><td>处理成功结果，链式传递</td><td>决定下一环的输入</td><td>前一个Promise完成后</td><td>保持纯函数，明确返回值</td></tr><tr><td>catch()</td><td>错误捕获和恢复</td><td>可恢复错误或重新抛出</td><td>链中任何错误发生时</td><td>在适当层级处理，不要过早吞没错误</td></tr><tr><td>finally()</td><td>资源清理和状态重置</td><td>不影响结果传递</td><td>无论如何都会执行</td><td>只做清理，不返回业务数据</td></tr></tbody></table>
<h3 data-id="heading-20">黄金法则</h3>
<ul>
<li>单一职责原则：每个then()应该只做一件事。</li>
<li>错误早抛，晚处理：让错误传播到合适的处理层。</li>
<li>finally()只清理：不要在finally中返回业务逻辑数据。</li>
<li>保持链的可读性：合理拆分长链，使用命名函数。</li>
<li>考虑可维护性：为复杂的链添加注释和文档。</li>
</ul>
<h2 data-id="heading-21">结语</h2>
<p>本文主要介绍了Promise的三种实例化方法，对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3+ElementUI树形菜单：构建层次化用户界面]]></title>    <link>https://juejin.cn/post/7592017365140602932</link>    <guid>https://juejin.cn/post/7592017365140602932</guid>    <pubDate>2026-01-06T01:48:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592017365140602932" data-draft-id="7591704324907597858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3+ElementUI树形菜单：构建层次化用户界面"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T01:48:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱分享的鱼鱼"/> <meta itemprop="url" content="https://juejin.cn/user/3901536646733133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3+ElementUI树形菜单：构建层次化用户界面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3901536646733133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱分享的鱼鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:48:01.000Z" title="Tue Jan 06 2026 01:48:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>树形菜单能够以层次化的方式展示具有父子关系的数据，使用户能够直观地理解复杂的权限结构、组织架构或内容分类。本文将深入探讨树形菜单的设计原理、实现方式以及在实际项目中的应用。</p>
<h2 data-id="heading-1">什么是树形菜单</h2>
<p>树形菜单（Tree Menu）是一种可视化地展示层次结构数据的UI组件。它通常用于表示具有父子关系的数据集合，如文件系统、组织架构、权限系统等。树形菜单的主要特点包括：</p>
<ul>
<li><strong>层次结构</strong>：清晰地展示数据之间的层级关系</li>
<li><strong>可折叠性</strong>：允许用户展开或折叠节点以控制信息密度</li>
<li><strong>可选择性</strong>：支持单选、多选或级联选择</li>
<li><strong>交互性</strong>：提供丰富的用户交互体验</li>
</ul>
<h2 data-id="heading-2">树形菜单的核心功能</h2>
<h3 data-id="heading-3">1. 展开/折叠功能</h3>
<p>树形菜单最基本的功能是允许用户展开或折叠节点，这有助于控制信息的显示密度。用户可以根据需要查看详细信息或保持界面简洁。</p>
<h3 data-id="heading-4">2. 多选功能</h3>
<p>在权限管理系统中，树形菜单通常需要支持多选功能，允许用户选择多个节点。特别是当需要实现级联选择时（选择父节点时自动选择所有子节点），这一功能尤为重要。</p>
<h3 data-id="heading-5">3. 搜索和过滤</h3>
<p>对于大型树形结构，搜索和过滤功能可以帮助用户快速定位特定节点。</p>
<h2 data-id="heading-6">实现树形菜单的关键技术</h2>
<h3 data-id="heading-7">数据结构</h3>
<p>树形菜单的数据结构通常采用递归结构，每个节点包含以下属性：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,                    <span class="hljs-comment">// 节点唯一标识</span>
  <span class="hljs-attr">name</span>: <span class="hljs-string">"系统管理"</span>,          <span class="hljs-comment">// 节点显示名称</span>
  <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>,           <span class="hljs-comment">// 父节点ID</span>
  <span class="hljs-attr">children</span>: [               <span class="hljs-comment">// 子节点数组</span>
    {
      <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">"用户管理"</span>,
      <span class="hljs-attr">parentId</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">children</span>: []
    }
  ]
}
</code></pre>
<h3 data-id="heading-8">转换算法</h3>
<p>将扁平化的数据转换为树形结构是实现树形菜单的关键步骤。常用的转换算法如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">listToTree</span> = (<span class="hljs-params">list, parentId = <span class="hljs-literal">null</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> list
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">parentId</span> === parentId)
    .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> ({
      ...item,
      <span class="hljs-attr">children</span>: <span class="hljs-title function_">listToTree</span>(list, item.<span class="hljs-property">id</span>)
    }))
}
</code></pre>
<h2 data-id="heading-9">在Vue项目中实现树形菜单</h2>
<p>以Element Plus UI库为例，我们可以使用其内置的<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">el-tree</a>组件来实现功能丰富的树形菜单。</p>
<h3 data-id="heading-10">基础实现</h3>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-tree</span>
    <span class="hljs-attr">:data</span>=<span class="hljs-string">"treeData"</span>
    <span class="hljs-attr">:props</span>=<span class="hljs-string">"treeProps"</span>
    <span class="hljs-attr">node-key</span>=<span class="hljs-string">"id"</span>
    <span class="hljs-attr">:default-expanded-keys</span>=<span class="hljs-string">"defaultExpandedKeys"</span>
    <span class="hljs-attr">:default-checked-keys</span>=<span class="hljs-string">"checkedKeys"</span>
    <span class="hljs-attr">show-checkbox</span>
  /&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 树形数据</span>
<span class="hljs-keyword">const</span> treeData = <span class="hljs-title function_">ref</span>([
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">label</span>: <span class="hljs-string">'系统管理'</span>,
    <span class="hljs-attr">children</span>: [
      {
        <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
        <span class="hljs-attr">label</span>: <span class="hljs-string">'用户管理'</span>,
        <span class="hljs-attr">children</span>: [
          { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'用户查看'</span> },
          { <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'用户编辑'</span> }
        ]
      }
    ]
  }
])

<span class="hljs-comment">// 树形组件属性配置</span>
<span class="hljs-keyword">const</span> treeProps = {
  <span class="hljs-attr">children</span>: <span class="hljs-string">'children'</span>,
  <span class="hljs-attr">label</span>: <span class="hljs-string">'label'</span>
}

<span class="hljs-comment">// 默认展开的节点</span>
<span class="hljs-keyword">const</span> defaultExpandedKeys = <span class="hljs-title function_">ref</span>([<span class="hljs-number">1</span>])

<span class="hljs-comment">// 默认选中的节点</span>
<span class="hljs-keyword">const</span> checkedKeys = <span class="hljs-title function_">ref</span>([<span class="hljs-number">3</span>])
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-11">高级功能实现</h3>
<h4 data-id="heading-12">1. 级联选择控制</h4>
<p>在某些场景下，我们可能需要控制是否启用级联选择：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;el-tree
  :data=<span class="hljs-string">"treeData"</span>
  node-key=<span class="hljs-string">"id"</span>
  show-checkbox
  :check-strictly=<span class="hljs-string">"true"</span>  &lt;!-- 禁用级联选择 --&gt;
/&gt;
</code></pre>
<h4 data-id="heading-13">2. 自定义节点内容</h4>
<p>通过作用域插槽可以自定义节点的显示内容：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;el-tree :data="treeData" :props="defaultProps" @node-click="handleNodeClick"&gt;
  &lt;template #default="{ node, data }"&gt;
    &lt;span class="custom-tree-node"&gt;
      &lt;span&gt;{{ node.label }}&lt;/span&gt;
      &lt;span&gt;
        &lt;el-button type="text" size="small"&gt;编辑&lt;/el-button&gt;
        &lt;el-button type="text" size="small"&gt;删除&lt;/el-button&gt;
      &lt;/span&gt;
    &lt;/span&gt;
  &lt;/template&gt;
&lt;/el-tree&gt;
</code></pre>
<h2 data-id="heading-14">树形菜单在权限管理中的应用</h2>
<p>权限管理是树形菜单最常见的应用场景之一。在角色权限分配中，树形菜单能够清晰地展示菜单权限的层级关系，使管理员能够直观地分配权限。</p>
<h3 data-id="heading-15">实际应用案例：PMS系统中的角色权限管理</h3>
<p>我的项目中，实现了基于树形菜单的角色权限管理功能。具体实现包括：</p>
<ol>
<li><strong>权限数据加载</strong>：从<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">menusApiService.js</a>获取所有可用的菜单权限</li>
<li><strong>树形结构构建</strong>：使用<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">listToTree</a>工具函数将扁平化的菜单数据转换为树形结构</li>
<li><strong>权限选择与保存</strong>：通过树形组件的多选功能实现权限的批量分配</li>
</ol>
<h3 data-id="heading-16">权限分配流程</h3>
<ol>
<li><strong>加载权限数据</strong>：从后端获取所有可用的权限节点</li>
<li><strong>构建树形结构</strong>：将权限数据转换为树形结构</li>
<li><strong>显示当前权限</strong>：在树形菜单中高亮显示已分配的权限</li>
<li><strong>选择权限</strong>：用户通过勾选节点来分配权限</li>
<li><strong>提交变更</strong>：将选择的权限保存到后端</li>
</ol>
<h3 data-id="heading-17">实际代码实现</h3>
<p>在<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">RolesView.vue</a>中，我们实现了完整的权限管理功能：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-form-item label="权限列表" prop="permissions" style="max-height: 180px"&gt;
    &lt;div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"&gt;
      &lt;div&gt;
        &lt;el-button size="small" @click="selectAllPermissions" type="primary"&gt;全选&lt;/el-button&gt;
        &lt;el-button size="small" @click="unselectAllPermissions" type="info" style="margin-left: 10px;"&gt;全不选&lt;/el-button&gt;
        &lt;el-button size="small" @click="invertSelectPermissions" type="warning"&gt;反选&lt;/el-button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;el-tree 
      ref="permissionTreeRef"
      :data="permissionTreeData" 
      node-key="id" 
      show-checkbox 
      :default-expanded-keys="defaultExpandedKeys"
      :props="treeProps" 
      style="border: 1px solid #dcdfe6; padding: 10px; border-radius: 4px; max-height: 400px; overflow-y: auto;"&gt;
    &lt;/el-tree&gt;
  &lt;/el-form-item&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-18">权限操作功能</h3>
<h4 data-id="heading-19">全选功能实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">selectAllPermissions</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (permissionTreeRef.<span class="hljs-property">value</span>) {
    <span class="hljs-comment">// 获取所有叶子节点的ID</span>
    <span class="hljs-keyword">const</span> allLeafIds = [];
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">collectLeafIds</span> = (<span class="hljs-params">nodes</span>) =&gt; {
      nodes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">children</span> &amp;&amp; node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-title function_">collectLeafIds</span>(node.<span class="hljs-property">children</span>);
        } <span class="hljs-keyword">else</span> {
          allLeafIds.<span class="hljs-title function_">push</span>(node.<span class="hljs-property">id</span>);
        }
      });
    };
    <span class="hljs-title function_">collectLeafIds</span>(permissionTreeData.<span class="hljs-property">value</span>);
    
    <span class="hljs-comment">// 全选所有叶子节点</span>
    permissionTreeRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">setCheckedKeys</span>(allLeafIds);
  }
};
</code></pre>
<h4 data-id="heading-20">全不选功能实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">unselectAllPermissions</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (permissionTreeRef.<span class="hljs-property">value</span>) {
    permissionTreeRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">setCheckedKeys</span>([]);
  }
};
</code></pre>
<h4 data-id="heading-21">反选功能实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">invertSelectPermissions</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (permissionTreeRef.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">const</span> checkedKeys = permissionTreeRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">getCheckedKeys</span>();
    <span class="hljs-keyword">const</span> allLeafIds = [];
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">collectLeafIds</span> = (<span class="hljs-params">nodes</span>) =&gt; {
      nodes.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">node</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">children</span> &amp;&amp; node.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-title function_">collectLeafIds</span>(node.<span class="hljs-property">children</span>);
        } <span class="hljs-keyword">else</span> {
          allLeafIds.<span class="hljs-title function_">push</span>(node.<span class="hljs-property">id</span>);
        }
      });
    };
    <span class="hljs-title function_">collectLeafIds</span>(permissionTreeData.<span class="hljs-property">value</span>);
    
    <span class="hljs-comment">// 计算未选中的叶子节点</span>
    <span class="hljs-keyword">const</span> uncheckedLeafIds = allLeafIds.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> !checkedKeys.<span class="hljs-title function_">includes</span>(id));
    
    <span class="hljs-comment">// 设置树的选中状态为反选</span>
    permissionTreeRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">setCheckedKeys</span>(uncheckedLeafIds);
  }
};
</code></pre>
<h2 data-id="heading-22">实际应用场景分析</h2>
<h3 data-id="heading-23">组织架构管理</h3>
<p>在企业管理系统中，组织架构通常呈现树形结构。树形菜单可以清晰地展示公司、部门、团队之间的层级关系，便于管理员进行组织结构的调整和人员分配。</p>
<h3 data-id="heading-24">文件目录管理</h3>
<p>文件管理系统中的目录结构天然具有树形特征。用户可以通过树形菜单直观地浏览和管理文件夹结构，进行文件的移动、复制等操作。</p>
<h3 data-id="heading-25">产品分类管理</h3>
<p>在电商系统中，产品分类通常采用多级分类结构。树形菜单可以帮助管理员更好地组织和管理商品分类，提高商品管理效率。</p>
<h2 data-id="heading-26">性能优化考虑</h2>
<h3 data-id="heading-27">大数据量处理</h3>
<p>当树形菜单包含大量节点时，需要考虑性能优化：</p>
<ol>
<li><strong>虚拟滚动</strong>：只渲染可视区域内的节点</li>
<li><strong>懒加载</strong>：按需加载子节点数据</li>
<li><strong>数据分页</strong>：对树形数据进行分页处理</li>
</ol>
<h3 data-id="heading-28">内存管理</h3>
<p>在长时间运行的应用中，需要关注内存使用情况：</p>
<ul>
<li>及时清理不需要的事件监听器</li>
<li>避免循环引用导致的内存泄漏</li>
<li>合理使用组件的生命周期钩子</li>
</ul>
<h3 data-id="heading-29">渲染优化</h3>
<p>对于大型树形结构，可以考虑以下优化策略：</p>
<ul>
<li>使用虚拟滚动技术减少DOM节点数量</li>
<li>实现节点的懒加载，只在用户展开时加载子节点</li>
<li>使用防抖技术优化搜索和过滤功能</li>
</ul>
<h2 data-id="heading-30">总结</h2>
<p>树形菜单作为展示层次化数据的重要组件，在现代Web应用中发挥着关键作用。通过合理的设计和实现，树形菜单不仅能够有效地组织复杂的数据结构，还能提供良好的用户体验。</p>
<p>在实际项目开发中，我们需要根据具体需求选择合适的实现方式，考虑性能、可访问性和用户体验等多个方面。随着前端技术的不断发展，树形菜单的实现方式也在不断演进，但其核心目标始终是帮助用户更好地理解和操作层次化数据。</p>
<p>通过本文的介绍，希望能够帮助开发者更好地理解和应用树形菜单组件，在实际项目中构建出功能强大且用户友好的层次化界面。树形菜单不仅是技术实现，更是用户体验设计的重要组成部分，需要在功能性和易用性之间找到平衡点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript的new魔法：从零创造一个对象的奇妙旅程]]></title>    <link>https://juejin.cn/post/7591972586360520723</link>    <guid>https://juejin.cn/post/7591972586360520723</guid>    <pubDate>2026-01-06T02:10:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591972586360520723" data-draft-id="7591672090791215123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript的new魔法：从零创造一个对象的奇妙旅程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T02:10:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JS_Likers"/> <meta itemprop="url" content="https://juejin.cn/user/1377017277975032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript的new魔法：从零创造一个对象的奇妙旅程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1377017277975032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JS_Likers
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:10:18.000Z" title="Tue Jan 06 2026 02:10:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：当代码开始“生孩子”</h2>
<p>想象一下，你是一位JavaScript魔法师，有一天你念出了一句咒语 <code>new Person()</code>，突然之间，一个全新的对象就出现在你的面前！这感觉就像是代码在“生孩子”，而<code>new</code>就是那个神奇的助产士。</p>
<p>今天，我们就来揭开这个魔法背后的秘密，看看当你在JavaScript中使用<code>new</code>关键字时，究竟发生了什么奇妙的事情。</p>
<h2 data-id="heading-1">一、先来看一个简单例子</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义一个简单的构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 给原型添加方法</span>
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好，我是<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，今年<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span>岁！`</span>);
}

<span class="hljs-comment">// 使用new创建对象</span>
<span class="hljs-keyword">const</span> xiaoming = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'小明'</span>, <span class="hljs-number">20</span>);
xiaoming.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// 输出：你好，我是小明，今年20岁！</span>
</code></pre>
<p>这一切看起来很简单，但幕后到底发生了什么呢？</p>
<h2 data-id="heading-2">二、new操作符的魔法四部曲</h2>
<p>让我们通过流程图来直观理解整个过程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[开始：new Constructor()] --&gt; B[第一步&lt;br&gt;创建空对象]
    B --&gt; C[第二步&lt;br&gt;设置原型链]
    C --&gt; D[第三步&lt;br&gt;执行构造函数&lt;br&gt;绑定this]
    D --&gt; E{构造函数有返回值吗？}
    E --&gt;|返回对象| F[返回该对象]
    E --&gt;|其他情况| G[返回新创建的对象]
    F --&gt; H[结束]
    G --&gt; H
</code></pre>
<p>现在，让我们一步步详细解释：</p>
<h3 data-id="heading-3"><strong>第一步：创建空对象</strong></h3>
<p>JavaScript会默默地创建一个全新的空对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> newObject = {};
</code></pre>
<h3 data-id="heading-4"><strong>第二步：设置原型链</strong></h3>
<p>这个新对象会连接到构造函数的原型：</p>
<pre><code class="hljs language-javascript" lang="javascript">newObject.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
</code></pre>
<p>（注：实际使用的是<code>Object.setPrototypeOf()</code>或内部机制，但<code>__proto__</code>更直观）</p>
<h3 data-id="heading-5"><strong>第三步：执行构造函数并绑定this</strong></h3>
<p>构造函数被调用，并且<code>this</code>被绑定到新创建的对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">call</span>(newObject, ...<span class="hljs-variable language_">arguments</span>);
</code></pre>
<h3 data-id="heading-6"><strong>第四步：处理返回值</strong></h3>
<ul>
<li>如果构造函数返回一个对象，那么这个对象会成为整个<code>new</code>表达式的结果</li>
<li>否则，返回新创建的那个对象</li>
</ul>
<h2 data-id="heading-7">三、亲手实现一个自己的new函数</h2>
<p>理解了原理，我们完全可以自己实现一个<code>new</code>的功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) {
    <span class="hljs-comment">// 1. 创建一个新对象</span>
    <span class="hljs-keyword">const</span> obj = {};
    
    <span class="hljs-comment">// 2. 将对象的原型指向构造函数的prototype</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, <span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
    
    <span class="hljs-comment">// 3. 执行构造函数，绑定this到新对象</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(obj, args);
    
    <span class="hljs-comment">// 4. 判断返回值类型</span>
    <span class="hljs-keyword">return</span> result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span> ? result : obj;
}

<span class="hljs-comment">// 测试我们自己的new</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">type, sound</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = type;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sound</span> = sound;
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">makeSound</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.type}</span>发出声音：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.sound}</span>`</span>);
}

<span class="hljs-keyword">const</span> cat = <span class="hljs-title function_">myNew</span>(<span class="hljs-title class_">Animal</span>, <span class="hljs-string">'猫'</span>, <span class="hljs-string">'喵喵'</span>);
cat.<span class="hljs-title function_">makeSound</span>(); <span class="hljs-comment">// 输出：猫发出声音：喵喵</span>
</code></pre>
<h2 data-id="heading-8">四、常见陷阱与趣事</h2>
<h3 data-id="heading-9">陷阱1：忘记使用new</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">model</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = model;
}

<span class="hljs-comment">// 错误用法（忘记new）</span>
<span class="hljs-keyword">const</span> myCar = <span class="hljs-title class_">Car</span>(<span class="hljs-string">'Tesla'</span>); 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myCar); <span class="hljs-comment">// undefined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">model</span>); <span class="hljs-comment">// Tesla（污染了全局变量！）</span>
</code></pre>
<p>解决方法：使用严格模式或在构造函数中做检查</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">model</span>) {
    <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Car</span>)) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(model);
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = model;
}
</code></pre>
<h3 data-id="heading-10">陷阱2：构造函数返回对象</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-string">'我不是狗'</span> }; <span class="hljs-comment">// 返回一个对象</span>
}

<span class="hljs-keyword">const</span> myDog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'旺财'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog.<span class="hljs-property">name</span>); <span class="hljs-comment">// "我不是狗"（不是预期的"旺财"！）</span>
</code></pre>
<h3 data-id="heading-11">趣事：箭头函数不能当构造函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Person</span> = (<span class="hljs-params">name</span>) =&gt; {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// 错误！箭头函数没有自己的this</span>
};

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'小明'</span>); <span class="hljs-comment">// TypeError: Person is not a constructor</span>
</code></pre>
<h2 data-id="heading-12">五、实际应用场景</h2>
<h3 data-id="heading-13">场景1：创建具有私有变量的对象</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 私有变量</span>
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 公共方法</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">increment</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        count++;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前计数：<span class="hljs-subst">${count}</span>`</span>);
    };
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">getCount</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> count;
    };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
counter.<span class="hljs-title function_">increment</span>(); <span class="hljs-comment">// 当前计数：1</span>
counter.<span class="hljs-title function_">increment</span>(); <span class="hljs-comment">// 当前计数：2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-property">count</span>); <span class="hljs-comment">// undefined（无法直接访问私有变量）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 2（通过公共方法访问）</span>
</code></pre>
<h3 data-id="heading-14">场景2：实现简单的继承</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Vehicle</span>(<span class="hljs-params">type</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = type;
}

<span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">move</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.type}</span>正在移动...`</span>);
};

<span class="hljs-comment">// 子类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">brand</span>) {
    <span class="hljs-title class_">Vehicle</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'汽车'</span>); <span class="hljs-comment">// 调用父类构造函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">brand</span> = brand;
}

<span class="hljs-comment">// 设置原型链</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Vehicle</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Car</span>;

<span class="hljs-comment">// 添加子类特有方法</span>
<span class="hljs-title class_">Car</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">honk</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.brand}</span>汽车：滴滴！`</span>);
};

<span class="hljs-keyword">const</span> myCar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">'宝马'</span>);
myCar.<span class="hljs-title function_">move</span>(); <span class="hljs-comment">// 汽车正在移动...</span>
myCar.<span class="hljs-title function_">honk</span>(); <span class="hljs-comment">// 宝马汽车：滴滴！</span>
</code></pre>
<h2 data-id="heading-15">六、面试常见问题（悄悄告诉你答案）</h2>
<ol>
<li>
<p><strong>Q: new一个函数发生了什么？</strong>
A: 四部曲：创建空对象 → 设置原型链 → 绑定this执行构造函数 → 处理返回值</p>
</li>
<li>
<p><strong>Q: 如果构造函数返回一个基本类型呢？</strong>
A: 会被忽略，仍然返回新创建的对象</p>
</li>
<li>
<p><strong>Q: 如何判断一个对象是否由某个构造函数创建？</strong>
A: 使用<code>instanceof</code>操作符或检查<code>obj.constructor</code>属性</p>
</li>
</ol>
<h2 data-id="heading-16">结语：new的真正魔法</h2>
<p>现在你知道了，<code>new</code>并不是真的魔法，它只是JavaScript提供的一种语法糖，封装了对象创建、原型设置和构造函数调用的过程。</p>
<p>下次当你使用<code>new</code>时，不妨在心里默念这四部曲，你会发现自己对JavaScript的理解又深了一层。而且，如果你愿意，完全可以不用<code>new</code>，自己手动实现整个流程——只是那样代码会看起来有点啰嗦罢了。</p>
<p>记住，理解这些底层机制，不是为了让你每天手动实现<code>new</code>，而是为了在遇到问题时，知道从哪里寻找答案。</p>
<hr/>
<p><strong>小彩蛋</strong>：你知道吗？在JavaScript早期，甚至有一种设计建议完全取消<code>new</code>关键字，因为开发者经常忘记使用它。但最终<code>new</code>还是保留了下来，成为了JavaScript的标志性特性之一。所以，下次当你忘记写<code>new</code>时，不要自责——连语言设计者都觉得这是个问题呢！</p>
<p>现在，去创造你的对象吧，年轻的JavaScript魔法师！🎩✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-204 混淆矩阵到ROC：不平衡二分类评估指标全梳理 sklearn]]></title>    <link>https://juejin.cn/post/7591799107486171146</link>    <guid>https://juejin.cn/post/7591799107486171146</guid>    <pubDate>2026-01-06T02:20:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591799107486171146" data-draft-id="7591799107486154762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-204 混淆矩阵到ROC：不平衡二分类评估指标全梳理 sklearn"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2026-01-06T02:20:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-204 混淆矩阵到ROC：不平衡二分类评估指标全梳理 sklearn
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:20:10.000Z" title="Tue Jan 06 2026 02:20:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：类别不平衡时 Accuracy 失真，业务更关心“少数类捕获”和“误伤成本”。</li>
<li>结论：用混淆矩阵统一口径，再用 Precision/Recall/F1 与 ROC/AUC 做权衡与阈值选择。</li>
<li>产出：TP/FP/FN/TN 定义与指标映射 + sklearn 指标/绘图接口版本要点 + 常见坑速查卡。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9d4e16393c34233af5bd512077e4a78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=1AlQ8XBWGepYP5FIiztY6U6urV0%3D" alt="大数据-204 混淆矩阵到ROC：不平衡二分类评估指标全梳理 sklearn" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>


















































<table><thead><tr><th>项/接口</th><th>已验证</th><th>说明</th></tr></thead><tbody><tr><td>scikit-learn</td><td>✅ 1.8.0</td><td>PyPI 标注最新稳定版，发布日期 2025-12-10；Requires: Python ≥3.11</td></tr><tr><td>Python</td><td>✅ ≥3.11</td><td>sklearn 1.8.0 明确要求 Python ≥3.11</td></tr><tr><td>NumPy</td><td>✅ ≥1.24.1</td><td>sklearn 1.8.0 依赖声明</td></tr><tr><td>SciPy</td><td>✅ ≥1.10.0</td><td>sklearn 1.8.0 依赖声明</td></tr><tr><td>sklearn.metrics.confusion_matrix</td><td>✅ 1.8.0</td><td>文档normalize={'true','pred','all'}：按真实/预测/全体归一化</td></tr><tr><td>sklearn.metrics.ConfusionMatrixDisplay</td><td>✅ 1.8.0</td><td>文档推荐用 from_estimator/from_predictions 生成展示对象</td></tr><tr><td>sklearn.metrics.roc_curve</td><td>✅ 1.8.0</td><td>文档签名含 pos_label，输入是 y_score（分数/概率），非离散标签</td></tr><tr><td>sklearn.metrics.RocCurveDisplay</td><td>✅ 1.8.0</td><td>文档从 estimator 直接生成 ROC 展示</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ba7655f18ae4632b82c78a283c001bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=0AaqgaoYgGhbgYYOboxXfDXDB6U%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-2">混淆矩阵</h2>
<p>从上一节的例子中可以看出，如果我们的目标是希望尽量捕获少数类，那准确率这个模型评估逐渐失效，所以我们需要新的模型评估指标来帮助我们。如果简单来看，其实我们只需要查看模型在少数类上的准确率就好了，只要能够将少数类尽量捕捉出来，就能够达到我们的目的。
但此时，新问题又出现了，我们对多数类判断错误后，会需要人工甄别或者更多的业务上的措施来一一排除我们判断错误的多数类，这种行为往往伴随着很高的成本。
比如银行在判断一个申请信用卡的客户是否会违约行为的时候，如果一个客户被判断为会违约，这个客户的信用卡申请就会驳回，如果为了捕捉会违约的人，大量地将不会违约的客户判断为会违约的客户，就会有许多无辜的客户的申请被驳回。
也就是说，单纯的追求捕捉少数类，就会成本太高，而不顾及少数类，又会无法达成模型的效果。所以在现实中，我们往往在寻找捕获少数类的能力和将多数判错后需要付出的成本的平衡。如果一个模型在能够尽量捕获少数类的情况下，还能够尽量对多数判断正确，则这个模型就非常优秀了。为了评估这样的能力，我们将引入新的模型评估指标：混淆矩阵可以帮助我们。</p>
<ul>
<li>混淆矩阵是二分类问题的多维衡量指标体系，在样本不平衡时极其有用</li>
<li>在混淆矩阵中，我们将少数类认为时正例，多数类认为时负例</li>
<li>在决策树，随机森林这些算法里，即是说少数类是1，多数类时 0</li>
<li>在 SVM 里，就是说少数类时 1，多数类时 -1</li>
</ul>
<p>普通的混淆里，一般使用「0，1」来表示，混淆矩阵如其名，十分容易让人混淆，在需要教材中各种各样的名称和定义让大家难以理解和记忆。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b09f0a77c544daa92904d08f390033b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=0UCqdg8h%2BieXoo4E8JFQVwC0zFM%3D" alt="混淆矩阵" loading="lazy"/></p>
<p>其中:</p>
<ul>
<li>行代表预测情况，列则表示实际情况</li>
<li>预测值是 1，记为 P（Positive）</li>
<li>预测值是 0，记为 N（Negative）</li>
<li>预测值与真实值相同，记为 T（True）</li>
<li>预测值与真实值相反，记为 F（False）</li>
</ul>
<p>因此矩阵中四个元素分别表示：</p>
<ul>
<li>TP（True Positive）真实为 1，预测为 1</li>
<li>FN（False Negative）真实为 1，预测为 0</li>
<li>FP（False Positive）真实为 0，预测为 1</li>
<li>TN（True Negative）真实为 0，预测为 0</li>
</ul>
<p>基于混淆矩阵，我们有一系列不同的模型评估指标，这些评估指标范围都在【0，1】之间，所以有11 和 00为分子的指标都是越来越接近 1 越好，所以 01 和 10 为分子的指标都是越来越接近 0 越好。
对于所有指标，我们用橙色表示分母，用绿色表示分子，则我们有：</p>
<h3 data-id="heading-3">准确率 Accuracy</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e41e503f1274fbb9b2088e500a270e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=aSmJvD0ofSWcO11680ZJisR70m8%3D" alt="准确率 Accuracy" loading="lazy"/></p>
<h3 data-id="heading-4">精确度 Precision</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29386a1884774279bdb2cd1e11066c08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=AgsBBw4S4KSuz0h1CrXdy%2Be55mE%3D" alt="精确度 Precision" loading="lazy"/>
精确度 Precision，又叫查准率，表示在所有预测结果为 1 的样例数中，实际为 1 的样例数所占比重。精确度越低，意味着 01 比重很大，则代表你的模型对多数类 0 误判率越高，误伤了过多的多数类。为了避免对多数类的误伤，需要追求高精确度。
精确度是将多数类判错后所需要付出成本的衡量</p>
<h3 data-id="heading-5">召回率 Recall</h3>
<p>召回率 Recall，又称为敏感度（sensitivity），真正率，查全率，表示所有真实为 1 的样本中，被我们预测正确的样本所占的比例。
召回率越高，代表我们尽量捕捉出了越多的少数类。召回率越低，代表我们捕捉出足够的少数类。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1afea7f61ce8411db448f678b5f9fb99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=IculmEEpNfkt5BllO9NTdSAR8Gw%3D" alt="召回率 Recall" loading="lazy"/>
我们希望不计代价，找出少数类（比如潜逃的犯罪分子），那我们会追求高召回率，相反如果我们的目标不是尽量捕获少数类，那我们就不需要在意召回率。
注意召回率和精确度的分子是相同的（都是 11），只是分母不同。
而召回率和精确度是此消彼长的，两者之间的平衡代表了捕捉少数类的需求和尽量不要误伤多数类的需要求的平衡。
究竟要偏向哪一方，取决于我们的业务需求：究竟是误伤多数类的成本更高，还是无法捕捉少数类的代表更高。</p>
<h3 data-id="heading-6">F1 Measure</h3>
<p>为了同时兼顾精确度和召回率，我们创造了两者的调和平均数作为考量两者平衡的综合性指标，称之为F1 Measure。
两个数之间的调和平均倾向于靠近两个数中比较小的那一个数，因此我们追求尽量高的F1 Measure，能够保证我们精确度和召回率都比较高。
F1 Measure 在 [0,1]之间分布，越接近 1 越好。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b64dfa85f5a041368d43cdb82eb92974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=KtAcDXUP58U3Imo5%2F7MeQCrgjGA%3D" alt="F1 Measure" loading="lazy"/></p>
<h3 data-id="heading-7">假负率</h3>
<p>从 Recall 延伸出来的另一个评估指标叫做假负率（False Negative Rate），它等于 1 - Recall，用于衡量。
所有真实为 1 的样本中，被我们错误判断为 0 的，通常用的不多。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aec03038738343b99de200c9bfbb10bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=62xoFRSi73sV85xkwFapAHlRti4%3D" alt="假负率" loading="lazy"/></p>
<h3 data-id="heading-8">ROC 曲线</h3>
<p>ROC 的全称是：Receiver Operating characteristic Curve，其主要的分析方法就是画这条特征曲线。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eddd6b7696f34945be14b04b18454568~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=PdRdpc8m9mRZrP%2FanHAM2EkuJhI%3D" alt="ROC 曲线" loading="lazy"/></p>
<p>该曲线的横坐标为假正率（False Positive Rate，FPR），N 是真实负样本的个数，FP 是N 个负样本中被分类器预测为正样本的个数。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb9b7f8244c8466b93b3c9d8022e3352~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=hvbRCr930uQStuOpY9TrOPPBMPY%3D" alt="ROC 曲线" loading="lazy"/>
纵坐标为召回率，真正率（True Positive Rate，TPR）：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa057827510a4f1c89b63c5fbd78f5a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=aJcdS5CAM6L%2BXRWkoG3eSZPiNjY%3D" alt="真正率（True Positive Rate，TPR）" loading="lazy"/>
P 是真实正样本的个数，TP 是 P 个正样本被分类器预测为正样本的个数。</p>
<h3 data-id="heading-9">sklearn 中的混淆矩阵</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af3301732c3f486b80f70f65dcf1c8c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270810&amp;x-signature=0vXSH%2BBFohjR9OvPr4hbRH4fI9w%3D" alt="sklearn 中的混淆矩阵" loading="lazy"/></p>
<h2 data-id="heading-10">决策树的算法评价</h2>
<h3 data-id="heading-11">决策树优点详解</h3>
<ol>
<li>
<p><strong>易于理解和解释</strong></p>
<ul>
<li>决策树采用树形结构展示决策过程，可视化程度高，非专业人士也能理解</li>
<li>每个节点代表一个特征判断，分支代表判断结果，叶子节点代表最终决策</li>
<li>示例：在银行贷款审批场景中，可以直观看到"收入&gt;5万→信用良好→批准"这样的决策路径</li>
</ul>
</li>
<li>
<p><strong>数据预处理要求低</strong></p>
<ul>
<li>不需要特征缩放或标准化（如决策树对特征的数值范围不敏感）</li>
<li>能直接处理类别型特征，无需one-hot编码（但sklearn实现需要）</li>
<li>注意：主流实现（如sklearn）确实不支持缺失值自动处理，需提前填充</li>
</ul>
</li>
<li>
<p><strong>预测效率高</strong></p>
<ul>
<li>预测时间复杂度为O(log n)，n是训练样本数</li>
<li>对比：KNN预测需要O(n)，SVM需要O(n_sv)支持向量数量</li>
<li>适合实时预测场景，如金融风控系统需要毫秒级响应</li>
</ul>
</li>
<li>
<p><strong>多类型数据处理能力</strong></p>
<ul>
<li>可混合处理数值特征（如年龄、收入）和类别特征（如性别、职业）</li>
<li>既可用于分类（预测类别标签）也可用于回归（预测连续值）</li>
<li>应用场景示例：房价预测（回归）和客户流失预测（分类）可使用相同算法</li>
</ul>
</li>
<li>
<p><strong>模型鲁棒性</strong></p>
<ul>
<li>对数据分布假设较少，即使特征间存在非线性关系也能较好处理</li>
<li>对异常值相对不敏感，因为分裂依据是特征排序而非绝对值</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">决策树缺点详解</h3>
<ol>
<li>
<p><strong>过拟合风险</strong></p>
<ul>
<li>容易生长出过于复杂的树，完美拟合训练数据但泛化能力差</li>
<li>解决方案：
<ul>
<li>预剪枝：设置max_depth（最大深度）、min_samples_leaf（叶节点最小样本数）</li>
<li>后剪枝：训练完整树后剪除不重要的分支</li>
<li>示例：限制max_depth=5通常能平衡模型复杂度与性能</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>模型不稳定性</strong></p>
<ul>
<li>训练数据微小变化可能导致完全不同的树结构</li>
<li>根本原因：贪婪算法的局部最优特性</li>
<li>改进方法：
<ul>
<li>使用集成学习（如随机森林）通过多棵树投票降低方差</li>
<li>随机森林中设置max_features参数控制特征采样随机性</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>局部最优问题</strong></p>
<ul>
<li>每次分裂只考虑当前节点的最优解，不能回溯调整之前的分裂</li>
<li>可能导致次优全局模型</li>
<li>解决方案：
<ul>
<li>集成方法：通过Bagging或Boosting组合多个弱学习器</li>
<li>特征工程：人工构造更有判别力的特征</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>类别不平衡敏感</strong></p>
<ul>
<li>当某一类别样本占比过大时，模型会偏向该类别</li>
<li>解决方法：
<ul>
<li>上采样少数类或下采样多数类</li>
<li>使用类别权重参数（如class_weight='balanced'）</li>
<li>采用AUC等对类别不平衡不敏感的评价指标</li>
</ul>
</li>
<li>示例：在欺诈检测中，正常交易占比99%时需特别处理不平衡问题</li>
</ul>
</li>
</ol>
<h2 data-id="heading-13">错误速查</h2>








































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>混淆矩阵“行列含义”对不上（看起来 TP/FP 被交换）</td><td>把轴含义记反（真实/预测放反）或画图工具默认顺序误读</td><td>用 3~5 条手工样例算一次 TP/FP/FN/TN，对照矩阵四格明确 confusion_matrix(y_true, y_pred) 语义；展示时统一标注“真实/预测”；必要时转置但要同步改口径</td></tr><tr><td>Precision/Recall 数值异常（Precision 很低或 Recall 很低且不符合直觉）</td><td>正例标签 pos_label 不一致（0/1 vs -1/1 vs 字符串）；labels 排序与业务正例不一致</td><td>打印 np.unique(y_true) 与 np.unique(y_pred)；检查“少数类是否真被当作正类”在 ROC/二分类指标里显式设 pos_label；在混淆矩阵里显式设 labels=[neg,pos] 保持业务顺序</td></tr><tr><td>ROC 曲线“像一条直线/点很少/与预期相反”</td><td>把 y_pred（0/1标签）当成 y_score；或分数方向反了（正例分数更小）</td><td>检查传入 roc_curve 的第二个参数是否只有 {0,1}；检查正例的分数均值是否更高传 predict_proba[:,1] 或 decision_function；必要时取反分数或修正正例定义（pos_label）</td></tr><tr><td>归一化后的混淆矩阵“百分比不对”（每行不和为1或每列不和为1）</td><td>误解 normalize='true'/'pred'/'all' 的分母</td><td>观察归一化后是“行和=1”还是“列和=1”需要“召回视角”用 normalize='true'；需要“精确视角”用 normalize='pred'；全体占比用 normalize='all'</td></tr><tr><td>Accuracy 很高但业务效果差（漏掉关键少数类）</td><td>类别不平衡导致多数类主导；阈值默认 0.5 不匹配成本函数</td><td>看混淆矩阵中 FN 是否偏大；看 Recall/TPR 是否偏低以 Precision/Recall/F1 或 ROC/AUC 为主；按业务成本调阈值，并在评估报告里固定“正例定义+阈值”</td></tr><tr><td>“捕获少数类”提升后，误伤多数类激增（审核/拒绝量爆炸）</td><td>单点追求 Recall，忽略 FP 成本</td><td>看 FP 与 Precision 的变化趋势以 Precision 作为成本约束，做阈值扫描/PR 权衡；在上线指标中同时锁定 Precision 下限与 Recall 下限</td></tr></tbody></table>
<h2 data-id="heading-14">其他系列</h2>
<h3 data-id="heading-15">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-16">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-17">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多智能体协作案例实践（一）：基于AgentScope框架]]></title>    <link>https://juejin.cn/post/7591730714140540970</link>    <guid>https://juejin.cn/post/7591730714140540970</guid>    <pubDate>2026-01-06T01:06:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591730714140540970" data-draft-id="7591506455973625910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多智能体协作案例实践（一）：基于AgentScope框架"/> <meta itemprop="keywords" content="后端,Python,人工智能"/> <meta itemprop="datePublished" content="2026-01-06T01:06:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木昆子"/> <meta itemprop="url" content="https://juejin.cn/user/825103640698564"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多智能体协作案例实践（一）：基于AgentScope框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/825103640698564/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木昆子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:06:31.000Z" title="Tue Jan 06 2026 01:06:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在之前<a href="https://juejin.cn/post/7591510742648602667" target="_blank" title="https://juejin.cn/post/7591510742648602667">《几种AI Agent开发框架对比》</a>这篇文章中，我们设计了一个高考信息查询智能助手业务场景，使用几种AI Agent开发框架分别实现进行对比分析，因为文档太长，其中多智能体协作章节就没有详细展开。</p>
<p>本文基于AgentScope框架，对多智能体协作场景进行详细实践和对比分析，后面还会有一篇基于LangGraph框架的实践分析。</p>
<p>为了更好地模拟，我们还是基于之前高考信息查询这个业务场景，将原有的单智能体拆分为四个模块，对应四个智能体如下：</p>
<p>Template Agent：模板匹配，我们将SQL Agent生成的SQL保存为模板，提取年份参数，当下一次追问仅仅是对年份的追问时，直接取模板内的SQL查询分析即可。</p>
<p>Rewrite Agent：意图识别，根据上下文改写问题完善条件，支持多轮追问场景。</p>
<p>SQL Agent：通过自然语言匹配表结构等信息，然后生成SQL，再执行SQL查询出数据。</p>
<p>Analysis Agent：分析结果数据并简要回答用户问题。</p>
<h2 data-id="heading-0">🧠 多智能体协作实现逻辑</h2>
<p>首先看一下业务场景，打算基于以上四个智能体协作，来支撑用户进行高考信息查询，并且要支持多轮对话，后续会基于以下案例来进行验证：</p>
<p>第一轮提问：2016年考生人数有多少？<br/>
第二轮追问年份：2018年呢？<br/>
第三轮追问其他：录取人数呢？</p>
<p>针对该业务场景，四个智能体之间的协作逻辑设计如下：</p>
<p>1）用户输入问题</p>
<p>2）TemplateAgent判断是否匹配模板，未匹配NO_MATCH转3，无上下文NO_CONTEXT则转4，匹配则转5</p>
<p>3）未匹配NO_MATCH即匹配失败，进入意图识别改写RewriteAgent，利用上下文对话背景进行问题改写，然后进入SQLAgent，RAG检索元数据、生成SQL、查询数据，最后进入AnalysisAgent分析回答</p>
<p>4）无上下文NO_CONTEXT即首次提问，直接进入SQLAgent，RAG检索元数据、生成SQL、查询数据，最后进入AnalysisAgent分析回答</p>
<p>5、直接AnalysisAgent分析回答</p>
<p>整体协作逻辑概览如下：</p>
<pre><code class="hljs language-css" lang="css">    <span class="hljs-selector-attr">[用户输入]</span>
        ↓
    <span class="hljs-selector-attr">[TemplateAgent]</span>
        ↓
    ┌─────────────────────匹配结果──────────────────────┐
    ↓                        ↓                        ↓
<span class="hljs-selector-attr">[匹配成功-管道1]</span>          <span class="hljs-selector-attr">[匹配失败有上下文-管道2]</span>   <span class="hljs-selector-attr">[匹配失败无上下文-管道3]</span>
    ↓                        ↓                        ↓
<span class="hljs-selector-attr">[AnalysisAgent]</span>         <span class="hljs-selector-attr">[RewriteAgent]</span>          <span class="hljs-selector-attr">[SQLAgent]</span>
                             ↓                        ↓
                        <span class="hljs-selector-attr">[SQLAgent]</span>              <span class="hljs-selector-attr">[AnalysisAgent]</span>
                             ↓                        
                        <span class="hljs-selector-attr">[AnalysisAgent]</span>               ↓
    ↓                        ↓
    └────────────输出结果──────────────┘
        ↑
        └──────── Memory + Context Reuse ────────────┘
</code></pre>
<p>针对以上协作逻辑中的三种分支处理逻辑，实际还是要通过手写代码方式来进行逻辑控制，然后其中每钟分支流程中如果涉及到多个Agent，则可以通过AgentScope框架提供的管道模式（sequential_pipeline）进行串联，具体代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># --- 对话主流程 ---</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"启动 AgentScope 多智能体系统（输入 exit 退出）"</span>)

    template_agent = TemplateAgent()
    rewrite_agent = RewriteAgent()
    sql_agent = SQLAgent()
    analysis_agent = AnalysisAgent()

    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        user_input = <span class="hljs-keyword">await</span> asyncio.get_event_loop().run_in_executor(
            <span class="hljs-literal">None</span>, <span class="hljs-built_in">input</span>, <span class="hljs-string">"👤 用户: "</span>
        )
        <span class="hljs-keyword">if</span> user_input.strip().lower() == <span class="hljs-string">"exit"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"退出程序"</span>)
            <span class="hljs-keyword">break</span>

        user_msg = Msg(<span class="hljs-string">"user"</span>, user_input, role=<span class="hljs-string">"user"</span>)
        <span class="hljs-comment"># 所有 Agent 观察输入</span>
        <span class="hljs-keyword">for</span> agent <span class="hljs-keyword">in</span> [template_agent, rewrite_agent, sql_agent, analysis_agent]:
            <span class="hljs-keyword">await</span> agent.observe(user_msg)

        <span class="hljs-comment"># Step 1️⃣ 模板匹配</span>
        template_res = <span class="hljs-keyword">await</span> template_agent.reply(user_msg)

        <span class="hljs-keyword">if</span> template_res.content.strip().upper() == <span class="hljs-string">"NO_MATCH"</span>:
            <span class="hljs-comment"># 模板失败 → 走 改写 → SQL → 分析</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"🌀 模板匹配失败，进入改写流程"</span>)
            final_msg = <span class="hljs-keyword">await</span> sequential_pipeline([rewrite_agent, sql_agent, analysis_agent], user_msg)
        <span class="hljs-keyword">elif</span> template_res.content.strip().upper() == <span class="hljs-string">"NO_CONTEXT"</span>:
            <span class="hljs-comment"># 无上下文 → 走 SQL → 分析</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"🌀 无上下文，进入SQL流程"</span>)
            final_msg = <span class="hljs-keyword">await</span> sequential_pipeline([sql_agent, analysis_agent], user_msg)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 模板成功匹配 → 走 SQL + 分析</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"🎯 模板匹配成功，直接进入分析流程"</span>)
            final_msg = <span class="hljs-keyword">await</span> sequential_pipeline([analysis_agent], template_res)

        <span class="hljs-comment"># 所有 Agent 观察结果</span>
        <span class="hljs-keyword">for</span> agent <span class="hljs-keyword">in</span> [template_agent, rewrite_agent, sql_agent, analysis_agent]:
            <span class="hljs-keyword">await</span> agent.observe(final_msg)

        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
</code></pre>
<p>代码中在启动时先创建了四个智能体，通过if else 来串联业务分支，一个分支对应由 sequential_pipeline() 构建一个包含多Agent组成的管道，管道内部每个 Agent 实现独立职责，并通过 Msg 消息结构传递数据与上下文记忆（InMemoryMemory）。</p>
<h3 data-id="heading-1"><strong>🔁 多轮对话之上下文记忆+全局变量</strong></h3>
<p>先看上下文记忆的相关机制，每个 Agent 都可以观察多轮对话，通过上下文memory，支持多轮追问与问题补全。如下面这段代码所示，将用户输入问题user_msg，以及最终输出结果final_msg，通过调用agent.observe这个方法来告知所有的智能体：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">user_msg</span> = Msg(<span class="hljs-string">"user"</span>, user_input, role=<span class="hljs-string">"user"</span>)
<span class="hljs-comment"># 所有 Agent 观察输入</span>
for agent in <span class="hljs-section">[template_agent, rewrite_agent, sql_agent, analysis_agent]</span>:
    await agent.observe(user_msg)

......

<span class="hljs-comment"># 所有 Agent 观察结果</span>
for agent in <span class="hljs-section">[template_agent, rewrite_agent, sql_agent, analysis_agent]</span>:
    await agent.observe(final_msg)
</code></pre>
<p>同时在所有Agent智能体的实现代码中，都定义了observe这个方法，来接收用户输入和系统输出的上下文对话历史，并保存到Agent内部的记忆模块：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">self, msg: Msg | <span class="hljs-built_in">list</span>[Msg] | <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-literal">None</span>:  
        <span class="hljs-keyword">await</span> self.memory.add(msg)
</code></pre>
<p>智能体内部记忆模块都会持有多轮对话的上下文历史，供处理用户新输入时使用，当然实际本案例中只有问题改写RewriteAgent才需要使用多轮对话上下文，其从记忆模块中获取上下文并用于问题改写的代码逻辑如下：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">reply</span>(<span class="hljs-params">self, msg: Msg</span>) -&gt; Msg:
        <span class="hljs-string">"""理解意图并改写"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 🟨 Rewrite Agent ==="</span>)
        user_query = msg.content

        <span class="hljs-comment"># 从记忆中取出历史上下文</span>
        history = <span class="hljs-keyword">await</span> self.memory.get_memory()

        <span class="hljs-comment"># 构造 prompt</span>
        user_prompt = <span class="hljs-string">f"""
            用户的问题可能是不完整的追问或模糊描述，请结合上下文补全成一个清晰的问题。

            【当前问题】
            "<span class="hljs-subst">{user_query}</span>"

            请将上面的问题改写成一个**可独立理解、完整表达查询意图**的自然语言问题。
            要求：
            1. 根据原意图内容补充信息，完善条件即可，无须发散联想
            2. 不超过 50 字
            3. 仅输出改写后的问题内容
        """</span>
        prompt = <span class="hljs-keyword">await</span> self.formatter.<span class="hljs-built_in">format</span>([
            Msg(<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个查询意图理解与改写专家。"</span>, <span class="hljs-string">"system"</span>),
            *history,
            Msg(<span class="hljs-string">"user"</span>, user_prompt, <span class="hljs-string">"user"</span>),
        ])

        result = <span class="hljs-keyword">await</span> self.model(prompt)
        final_res = <span class="hljs-keyword">await</span> get_response(result)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✍️ 改写后问题：<span class="hljs-subst">{final_res}</span>"</span>)
</code></pre>
<p>基于这段代码，针对用户简写的问题“录取人数呢？”，根据历史对话“2018年考生人数”相关的记忆来改写，改写补全后就变成“2018年录取人数有多少？”的完整问题。</p>
<p>除了记录多轮对话输入/输出Msg的上下文记忆模块Memory之外，还可以利用全局变量方式在多个智能体Agent之间进行结构化的参数传递，如下定义一个全局变量stata，存放历史查询SQL的模板，方便后续同类问题直接使用：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========================</span>
<span class="hljs-comment"># 🧠 全局变量定义</span>
<span class="hljs-comment"># ========================</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    original_intent: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 如 "2016年考生人数有多少？"</span>
    last_sql_template: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 带占位符的 SQL 模板，如 "SELECT ... WHERE year = {year}"</span>

state = State()
</code></pre>
<p>就可以实现在前一轮对话时，在SQLAgent智能体中将根据用户问题+匹配到的表结构信息生成对应查询SQL后，将该SQL和用户问题都置入全局变量中：</p>
<pre><code class="hljs language-python" lang="python">        <span class="hljs-comment"># 生成 SQL 模板（简单年份/数字替换）  </span>
        template_sql = re.sub(<span class="hljs-string">r'\b(19|20)\d{{2}}\b'</span>, <span class="hljs-string">'{year}'</span>, sql)  <span class="hljs-comment"># 年份  </span>
        template_sql = re.sub(<span class="hljs-string">r'\b\d+\b'</span>, <span class="hljs-string">'{year}'</span>, template_sql, count=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 兜底替换第一个数字  </span>
  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🧠 原始意图: <span class="hljs-subst">{user_query}</span>"</span>)  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📦 保存 SQL 模板: <span class="hljs-subst">{template_sql}</span>"</span>)  
  
        state[<span class="hljs-string">"original_intent"</span>] = user_query          
        state[<span class="hljs-string">"last_sql_template"</span>] = template_sql
</code></pre>
<p>然后在下一轮对话时，在TemplateAgent智能体中再从全局变量中取出该信息，利用LLM判断用户最新查询意图和全局变量中的用户问题是否同一种问题，只是查询条件不同的追问（如只是从2016年换成2018年），如果是的话，就直接利用全局变量中的SQL，替换掉查询条件进行查询即可，这样就不用走后续的SQLAgent，再去重新利用LLM去构建SQL了。</p>
<pre><code class="hljs language-python" lang="python">        <span class="hljs-built_in">print</span>(<span class="hljs-string">"🔄 检测到历史上下文，尝试参数化追问"</span>)  
        <span class="hljs-keyword">try</span>:  
            <span class="hljs-comment"># 1. 用 LLM 从追问中提取参数  </span>
            extract_prompt = <span class="hljs-string">f"""  
                原始意图: <span class="hljs-subst">{state[<span class="hljs-string">'original_intent'</span>]}</span>  
                当前问题: "<span class="hljs-subst">{user_query}</span>"  
  
                请判断一下用户是否在进行年份的追问。  
                1、如果不是对年份的追问，直接输出空JSON '{{}}'  
                2、如果是追问，从中提取**变化的参数值**（年份），以 JSON 格式返回。  
                示例：  
                - “那2017年呢？” → {{"year": "2017"}}  
  
                只输出 JSON，不要其他内容。  
            """</span>  
            formatted = <span class="hljs-keyword">await</span> self.formatter.<span class="hljs-built_in">format</span>([  
                Msg(<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个参数提取器。"</span>, <span class="hljs-string">"system"</span>),  
                Msg(<span class="hljs-string">"user"</span>, extract_prompt, <span class="hljs-string">"user"</span>),  
            ])  
  
            result = <span class="hljs-keyword">await</span> self.model(formatted)  
            json_str = <span class="hljs-keyword">await</span> get_response(result)  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🔍 提取参数: <span class="hljs-subst">{json_str}</span>"</span>)  
            params = json.loads(json_str)  
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-string">"year"</span>inparams:  
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 年份参数提取失败，进入改写流程"</span>)  
                returnMsg(self.name, <span class="hljs-string">"NO_MATCH"</span>, role=<span class="hljs-string">"assistant"</span>)  
  
            <span class="hljs-comment"># 2. 填充 SQL 模板  </span>
            <span class="hljs-keyword">try</span>:  
                new_sql = state[<span class="hljs-string">"last_sql_template"</span>].<span class="hljs-built_in">format</span>(**params)  
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🛠️ 生成新 SQL: <span class="hljs-subst">{new_sql}</span>"</span>)
</code></pre>
<p>按上面三段代码所示，通过全局变量state，就可以实现多轮次对话之间的结构化参数传递。</p>
<p><strong>▶️ 案例测试结果</strong></p>
<p>运行验证结果如下：</p>
<pre><code class="hljs language-sql" lang="sql">启动 AgentScope 多智能体系统（输入 exit 退出）
👤 用户: <span class="hljs-number">2016</span>年考生人数有多少？
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟦 Template Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
⚠️ 不存在上下文，进入<span class="hljs-keyword">SQL</span> Agent流程
🌀 无上下文，进入<span class="hljs-keyword">SQL</span>流程
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟦 <span class="hljs-keyword">Sql</span> Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
调用大模型llama2向量化：<span class="hljs-number">2016</span>年考生人数有多少？
好的，用户问的是<span class="hljs-number">2016</span>年的考生人数有多少。首先，我需要查看提供的表结构。表名是college_entrance_examination，主键是examination_year，类型是<span class="hljs-type">int</span>。考生人数是candidates_count，类型是<span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)。

因为examination_year是主键，所以每个年份只有一条记录。因此，查询<span class="hljs-number">2016</span>年的考生人数不需要用聚合函数，直接<span class="hljs-keyword">SELECT</span> candidates_count即可。所以正确的<span class="hljs-keyword">SQL</span>应该是<span class="hljs-keyword">SELECT</span> candidates_count <span class="hljs-keyword">FROM</span> college_entrance_examination <span class="hljs-keyword">WHERE</span> examination_year <span class="hljs-operator">=</span><span class="hljs-number">2016</span>; 这里不需要聚合函数，因为数据是直接存储的，不是需要统计的。

💡 大模型生成的<span class="hljs-keyword">SQL</span>: [<span class="hljs-keyword">select</span> candidates_count <span class="hljs-keyword">from</span> college_entrance_examination <span class="hljs-keyword">where</span> examination_year <span class="hljs-operator">=</span><span class="hljs-number">2016</span> limit <span class="hljs-number">1</span>]
💡 数据查询成功: [{<span class="hljs-string">'candidates_count'</span>: <span class="hljs-number">940.0</span>}]
🧠 原始意图: <span class="hljs-number">2016</span>年考生人数有多少？
📦 保存 <span class="hljs-keyword">SQL</span> 模板: <span class="hljs-keyword">select</span> candidates_count <span class="hljs-keyword">from</span> college_entrance_examination <span class="hljs-keyword">where</span> examination_year <span class="hljs-operator">=</span> {<span class="hljs-keyword">year</span>} limit <span class="hljs-number">1</span>
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟩 Analysis Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
好的，我现在需要处理用户的问题：“<span class="hljs-number">2016</span>年考生人数有多少？”首先，我要确认用户的需求是获取<span class="hljs-number">2016</span>年的考生人数。根据提供的表结构信息，表名是college_entrance_examination，包含高考年份、考生人数和复读人数三个字段。用户提供的<span class="hljs-keyword">SQL</span>查询已经明确筛选了<span class="hljs-number">2016</span>年的考生人数，结果是<span class="hljs-number">940.0</span>万人。

接下来，。。。。。（略）

🧠 最终回答: <span class="hljs-number">2016</span>年全国高考考生人数为<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-number">940.0</span>万人<span class="hljs-operator">*</span><span class="hljs-operator">*</span>。该数据来源于考生人数与复读人数信息表（college_entrance_examination）中<span class="hljs-number">2016</span>年的记录。

<span class="hljs-comment">--------------------------------------------------</span>
👤 用户: <span class="hljs-number">2018</span>年呢
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟦 Template Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
🔄 检测到历史上下文，尝试参数化追问
好的，现在我需要处理用户的问题：“<span class="hljs-number">2018</span>年呢”。首先，用户之前问了<span class="hljs-number">2016</span>年的考生人数，现在问<span class="hljs-number">2018</span>年的情况，这明显是在进行年份的追问。根据之前的示例，用户希望得到一个包含年份的JSON对象。问题中的年份是<span class="hljs-number">2018</span>，所以需要提取这个参数。检查表结构，确认表中确实有examination_year字段，类型是<span class="hljs-type">int</span>，所以<span class="hljs-number">2018</span>是有效的输入。用户没有提到其他参数，所以只需要返回年份。因此，正确的JSON应该是{"year": "2018"}。

🔍 提取参数: {"year": "2018"}
🛠️ 生成新 <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">select</span> candidates_count <span class="hljs-keyword">from</span> college_entrance_examination <span class="hljs-keyword">where</span> examination_year <span class="hljs-operator">=</span><span class="hljs-number">2018</span> limit <span class="hljs-number">1</span>
✅ 追问查询成功，返回 <span class="hljs-number">1</span> 行
🎯 模板匹配成功，直接进入分析流程
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟩 Analysis Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
好的，用户之前问过<span class="hljs-number">2016</span>年的考生人数，现在又问<span class="hljs-number">2018</span>年的，我需要快速找到对应的答案。根据提供的表结构和数据信息，用户给出的<span class="hljs-keyword">SQL</span>查询是针对<span class="hljs-number">2018</span>年的，返回的结果是<span class="hljs-number">975.0</span>万人。所以。。。。。。就可以直接给出答案了。

🧠 最终回答: <span class="hljs-number">2018</span>年全国高考考生人数为<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-number">975.0</span>万人<span class="hljs-operator">*</span><span class="hljs-operator">*</span>。该数据来源于考生人数与复读人数信息表（college_entrance_examination）中<span class="hljs-number">2018</span>年的记录。

<span class="hljs-comment">--------------------------------------------------</span>
👤 用户: 录取人数呢？
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟦 Template Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
🔄 检测到历史上下文，尝试参数化追问
好的，我需要分析用户的问题是否在进行年份的追问。用户之前询问了<span class="hljs-number">2016</span>年和<span class="hljs-number">2018</span>年的考生人数，现在问的是“录取人数呢？”。首先，用户的问题从“考生人数”转向了“录取人数”，这可能涉及到另一个数据点，而不是同一字段的不同年份。根据提供的表结构，表中只有考生人数和复读人数，没有录取人数的字段。因此，用户可能在询问另一个未在表中提供的数据，而不是同一表中的不同年份。此外，问题中没有提到具体的年份，也没有使用“那...呢？”这样的结构，所以这应该不是对年份的追问。因此，应该返回空JSON。

🔍 提取参数: {}
⚠️ 年份参数提取失败，进入改写流程
🌀 模板匹配失败，进入改写流程
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟨 Rewrite Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
好的，用户之前问了<span class="hljs-number">2016</span>年和<span class="hljs-number">2018</span>年的高考考生人数，现在问“录取人数呢？”。我需要结合上下文补全问题。根据之前的对话，用户可能是在比较考生人数和录取人数。所以应该明确年份和具体是哪个年份的录取人数。可能指的是最近提到的<span class="hljs-number">2018</span>年，所以改写为“<span class="hljs-number">2018</span>年全国高考录取人数是多少？”

✍️ 改写后问题：<span class="hljs-number">2018</span>年全国高考录取人数是多少？
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟦 <span class="hljs-keyword">Sql</span> Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
调用大模型llama2向量化：<span class="hljs-number">2018</span>年全国高考录取人数是多少？
好的，用户现在问的是“录取人数呢？”，结合之前的对话历史来看，他们之前已经询问过<span class="hljs-number">2016</span>年和<span class="hljs-number">2018</span>年的考生人数，现在想知道<span class="hljs-number">2018</span>年的录取人数。根据用户提供的表结构，录取人数存储在college_entrance_admission表中，具体字段是admission_count，并且以万为单位。

首先，我需要确认用户的问题是否需要使用聚合函数。因为录取人数在表中是按年份记录的，每个年份对应一个具体的admission_count值，所以不需要SUM或AVG，而是直接查询该年份的记录即可。

接下来，检查表结构，admission_year是主键，所以<span class="hljs-number">2018</span>年只会有一条记录。因此，查询应该是<span class="hljs-keyword">SELECT</span> admission_count <span class="hljs-keyword">FROM</span> college_entrance_admission <span class="hljs-keyword">WHERE</span> admission_year <span class="hljs-operator">=</span><span class="hljs-number">2018</span>。

然后，确保字段类型是<span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)，所以结果会是精确到小数点后两位的数值。

💡 大模型生成的<span class="hljs-keyword">SQL</span>: [<span class="hljs-keyword">select</span> admission_count <span class="hljs-keyword">from</span> college_entrance_admission <span class="hljs-keyword">where</span> admission_year <span class="hljs-operator">=</span><span class="hljs-number">2018</span>]
💡 数据查询成功: [{<span class="hljs-string">'admission_count'</span>: <span class="hljs-number">790.99</span>}]
🧠 原始意图: <span class="hljs-number">2018</span>年全国高考录取人数是多少？
📦 保存 <span class="hljs-keyword">SQL</span> 模板: <span class="hljs-keyword">select</span> admission_count <span class="hljs-keyword">from</span> college_entrance_admission <span class="hljs-keyword">where</span> admission_year <span class="hljs-operator">=</span> {<span class="hljs-keyword">year</span>}
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 🟩 Analysis Agent <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
好的，用户现在问的是“录取人数呢？”，看起来他们之前已经询问过<span class="hljs-number">2016</span>年和<span class="hljs-number">2018</span>年的考生人数，现在想知道同一时期或相关年份的录取人数。我需要先回顾之前的对话历史，确保回答的一致性。

首先。。。。。。（略）

用户。。。。。。（略）

根据。。。。。。（略）

此外。。。。。。（略）

总结。。。。。。（略）

🧠 最终回答: <span class="hljs-number">2018</span>年全国高考录取人数为<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-number">790.99</span>万人<span class="hljs-operator">*</span><span class="hljs-operator">*</span>。该数据来源于录取人数与普通高校数信息表（college_entrance_admission）中<span class="hljs-number">2018</span>年的记录。若需了解其他年份的录取人数，可提供具体年份以便进一步查询。

<span class="hljs-comment">--------------------------------------------------</span>
👤 用户: 
</code></pre>
<p>第一轮问题：2016年考生人数有多少？</p>
<p>第一轮没有上下文，也没有全局变量模板，所以直接走SQL Agent + Analysis AgentRAG检索、生成SQL、查数、分析。同时SQL Agent生成成功后记录SQL模板到全局state。</p>
<p>第二轮问题：2018年呢？</p>
<p>第二轮我们追问2018年，这时存在全局变量模板，所以走模板匹配提取年份参数，直接查数然后通过业务判断存在数据，走Analysis Agent分析。</p>
<p>第三轮问题：录取人数呢？</p>
<p>第三轮我们追问录取人数，但是匹配不到模板，所以上层业务判断走Rewrite Agent + SQL Agent + Analysis Agent改写问题完善条件。改写时，参考Memory中上下文2016和2018年回答，改写为2018年全国高考录取人数是多少？然后走RAG检索、生成SQL、查数、分析。</p>
<h3 data-id="heading-2"><strong>🧩 AgentScope实现小结</strong></h3>
<p>AgentScope 提供了一个面向多智能体协作的开发框架，核心是「消息驱动 + 管道式执行」模型：</p>
<ul>
<li>通过 sequential_pipeline() 串联多个 Agent，每个智能体只需实现 reply() 方法。</li>
<li>使用 Msg 对象封装上下文，支持多模态内容（文本、结构化数据等）。</li>
<li>每个智能体内部InMemoryMemory 提供上下文记忆，可实现多轮对话追问。</li>
<li>多个智能体之间通过自定义全局变量State，实现跨轮次跨智能体的结构化参数传递。</li>
<li>利用OllamaChatFormatter 自动拼装 System Prompt + 历史记忆，实现语义连续性。</li>
</ul>
<p>特点：</p>
<ul>
<li>上手快、API 简洁，适合快速搭建多智能体应用。</li>
<li>内置异步流式输出，可直接打印模型“思考过程”。</li>
<li>强调「职责分离」：每个 Agent 只负责一类任务。</li>
</ul>
<p>适用场景 适合对「智能体职责清晰」「调用链固定」的任务。</p>
<h3 data-id="heading-3"><strong>附录：AgentScope中主要管道类型</strong></h3>
<p>AgentScope中主要有以下三类管道：</p>
<h4 data-id="heading-4">1）顺序 Pipeline (sequential_pipeline / SequentialPipeline)</h4>
<p>函数式调用：使用 sequential_pipeline(agents=[...], msg=...)。</p>
<ul>
<li>agents 参数：一个 agent 列表，按顺序执行。</li>
<li>msg 参数：初始消息（可以是 None 或一个 Msg 实例）作为第一个 agent 的输入。</li>
<li>返回值：最后一个 agent 的输出消息。</li>
</ul>
<p>类式调用：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">pipeline</span> = SequentialPipeline(agents=[...])
<span class="hljs-attr">msg</span> = await pipeline(msg=initial_msg)
</code></pre>
<ul>
<li>可以多次调用 pipeline(...) 重用该流水线。</li>
<li>适用场景：你希望依次将一个 agent 的输出传给下一个 agent——典型的流水线模式。</li>
</ul>
<h4 data-id="heading-5">2）分发／并行 Pipeline (fanout_pipeline / FanoutPipeline)</h4>
<p>函数式调用： fanout_pipeline(agents=[...], msg=..., enable_gather=False|True)。</p>
<ul>
<li>将同一个输入 msg 分发给 agents 列表中的每一个。</li>
<li>返回值：一个列表（每个 agent 的输出消息）。</li>
<li>enable_gather=True（默认）会并发执行所有 agent（利用 asyncio.gather()），适合 I/O 密集型场景。</li>
<li>enable_gather=False 会顺序执行，但是仍是分发模式（每个 agent 接收同一个输入）。</li>
</ul>
<p>类式调用：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">pipeline</span> = FanoutPipeline(agents=[...])
<span class="hljs-attr">msgs</span> = await pipeline(msg=initial_msg)
</code></pre>
<ul>
<li>同样可以重用。</li>
<li>适用场景：你希望多个 agent 基于同一个输入做“并行评估／多视角分析”，而不是一个接一个。</li>
</ul>
<h4 data-id="heading-6">3）MsgHub 使用模式</h4>
<ul>
<li>MsgHub 是一个异步（async）上下文管理器，传入一个 participants 列表（agent 实例列表）和一个 announcement 消息。</li>
<li>在上下文（async with MsgHub(...) as hub:）内部，参与者 agent 可以互相“观察”(observe) 消息，无需手动将一个 agent 的输出专门传给另一个。系统会自动广播。</li>
<li>MsgHub 支持动态管理参与者：通过 hub.add(...), hub.delete(...) 方法。</li>
</ul>
<p>示例（简化版）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> <span class="hljs-title">MsgHub</span>(<span class="hljs-params">participants=[alice, bob, charlie],
                  announcement=Msg(<span class="hljs-string">"user"</span>, <span class="hljs-string">"Introduce yourselves."</span>, <span class="hljs-string">"user"</span></span>)) <span class="hljs-keyword">as</span> hub:
    <span class="hljs-keyword">await</span> <span class="hljs-title">alice</span>()
    <span class="hljs-keyword">await</span> <span class="hljs-title">bob</span>()
    <span class="hljs-keyword">await</span> <span class="hljs-title">charlie</span>()
</span></code></pre>
<p>在这个例子中，alice,bob,charlie 会接收到 announcement，互相广播消息，无需手动传递。</p>
<p>源码参考：参与协作的四个智能体，以及具体协作控制逻辑代码，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMuKunZiAI%2Fcollege_entrance_ai%2Fblob%2Fmain%2Fagentscope_code%2Fagent_service_pipeline.py%25E3%2580%2582" target="_blank" title="https://github.com/MuKunZiAI/college_entrance_ai/blob/main/agentscope_code/agent_service_pipeline.py%E3%80%82" ref="nofollow noopener noreferrer">github.com/MuKunZiAI/c…</a></p>
<p>本文总结：本文通过高考信息智能查询的业务场景，基于AgentScope开发框架实践多智能体协作机制，通过管道+控制逻辑进行协作，通过上下文记忆+全局变量实现多轮对话和跨智能体之间参数传递，最后分享了AgentScope的几种管道类型。下一篇基于LangGraph框架的多智能体协作机制实践，敬请期待。</p>
<p>本文作者：Chaiys</p>
<p>本文原载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FO9wC9aU3iQ98Wij6C-AvWw" target="_blank" title="https://mp.weixin.qq.com/s/O9wC9aU3iQ98Wij6C-AvWw" ref="nofollow noopener noreferrer">公众号“木昆子记录AI”</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[监控不是日志：Prometheus 高基数避坑指南]]></title>    <link>https://juejin.cn/post/7591715454135238719</link>    <guid>https://juejin.cn/post/7591715454135238719</guid>    <pubDate>2026-01-06T02:21:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591715454135238719" data-draft-id="7591730714140950570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="监控不是日志：Prometheus 高基数避坑指南"/> <meta itemprop="keywords" content="后端,算法,监控"/> <meta itemprop="datePublished" content="2026-01-06T02:21:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            监控不是日志：Prometheus 高基数避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:21:47.000Z" title="Tue Jan 06 2026 02:21:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从 TSDB 原理到实战案例，帮助你理解为什么不能使用高基数标签，以及如何正确设计监控指标。一次性解决 Prometheus 查询慢、内存爆炸的根本问题。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、先问一个问题：为什么查询会变慢？</h2>
<p>想象一个场景：</p>
<pre><code class="hljs language-ini" lang="ini">你的电商系统监控突然变慢了：
- 以前查询 sum(order_total) 只要 10ms
- 现在需要 30 秒，经常超时
- Prometheus 内存从 2GB 涨到 16GB
- 告警延迟，运维半夜被叫醒

罪魁祸首：
order_total{<span class="hljs-attr">user_id</span>=<span class="hljs-string">"10086"</span>}  <span class="hljs-comment"># 给每个用户都创建了独立时序</span>
order_total{<span class="hljs-attr">user_id</span>=<span class="hljs-string">"10087"</span>}
...
<span class="hljs-comment"># 100万用户 = 100万条时序！</span>
</code></pre>
<p><strong>核心问题：为什么加个 user_id 标签就炸了？</strong></p>
<p>要理解这个问题，我们先用大白话讲清楚 Prometheus 是怎么存储数据的。</p>
<hr/>
<h2 data-id="heading-1">二、大白话类比：超市运作模型</h2>
<h3 data-id="heading-2">2.1 Prometheus = 一家超市</h3>
<p>把 Prometheus TSDB 想象成一家超市，就很好理解了：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph Frontend["前台 (内存)"]
        CAT["商品目录册
        可乐在B2货架"]
        SHELF["货架陈列区
        热销商品摆前面"]
    end
    
    subgraph Backend["后台 (磁盘)"]
        WAREHOUSE["大仓库
        整箱压缩存放"]
        LOG["出入库记录
        防止断电丢失"]
    end
    
    Frontend -.定期入库.-&gt; Backend
    
    style Frontend fill:#e8f5e9,stroke:#4caf50,stroke-width:3px
    style Backend fill:#fff3e0,stroke:#ff9800,stroke-width:3px
    style CAT fill:#c8e6c9,stroke:#4caf50
    style SHELF fill:#c8e6c9,stroke:#4caf50
    style WAREHOUSE fill:#ffe0b2,stroke:#ff9800
    style LOG fill:#ffe0b2,stroke:#ff9800
</code></pre>
<p><strong>为什么这样设计？</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">场景：顾客要买可乐

方案A（全放仓库）：
顾客：<span class="hljs-string">"要可乐"</span>
店员：<span class="hljs-string">"稍等，我去仓库找..."</span> → <span class="hljs-number">10</span>分钟
结果：顾客不买了 ✗

方案B（前台+后台）：
顾客：<span class="hljs-string">"要可乐"</span>
店员：<span class="hljs-string">"货架上有"</span> → <span class="hljs-number">10</span>秒
结果：立刻成交 ✓
</code></pre>
<p><strong>对应到监控：</strong></p>
<ul>
<li>告警需要实时查询（&lt;100ms）→ 必须用内存</li>
<li>历史分析可以慢点（几秒）→ 磁盘足够</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'16px'}}}%%
graph TB
    subgraph Prometheus["Prometheus Server"]
        subgraph Memory["内存层 Head Block (最近2小时热数据)"]
            SI["Series 索引表
            标签→ID映射"]
            PL["Posting Lists
            倒排索引"]
            AC["Active Chunks
            压缩数据块"]
        end
        
        Compress["定期压缩 (每2小时)"]
        
        subgraph Disk["磁盘层 Persistent Blocks (长期存储)"]
            IDX["index 文件
            倒排索引持久化"]
            CHK["chunks 文件
            XOR 压缩数据"]
            META["meta.json
            块元数据"]
        end
        
        Memory --&gt;|压缩| Compress
        Compress --&gt;|持久化| Disk
    end
    
    style Memory fill:#e1f5ff,stroke:#0288d1,stroke-width:3px
    style Disk fill:#fff3e0,stroke:#f57c00,stroke-width:3px
    style Compress fill:#f0f0f0,stroke:#666,stroke-width:2px
    style SI fill:#bbdefb,stroke:#0288d1
    style PL fill:#bbdefb,stroke:#0288d1
    style AC fill:#bbdefb,stroke:#0288d1
    style IDX fill:#ffe0b2,stroke:#f57c00
    style CHK fill:#ffe0b2,stroke:#f57c00
    style META fill:#ffe0b2,stroke:#f57c00
</code></pre>
<hr/>
<h2 data-id="heading-3">三、揭秘真实架构：TSDB 的技术实现</h2>
<p>好，理解了超市模型后，我们来看看 Prometheus 真实的技术架构。有了前面的铺垫，这张图你就能看懂了：</p>
<h3 data-id="heading-4">3.1 宏观架构图</h3>
<p>Prometheus 采用<strong>内存+磁盘</strong>的分层存储，核心设计思想是：<strong>热数据快速访问，冷数据压缩存储</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">%%{init: {'theme':'base', 'themeVariables': { 'fontSize':'16px'}}}%%
graph TB
    subgraph Prometheus["Prometheus Server"]
        subgraph Memory["内存层 Head Block (最近2小时热数据)"]
            SI["Series 索引表
            标签→ID映射"]
            PL["Posting Lists
            倒排索引"]
            AC["Active Chunks
            压缩数据块"]
        end
        
        Compress["定期压缩 (每2小时)"]
        
        subgraph Disk["磁盘层 Persistent Blocks (长期存储)"]
            IDX["index 文件
            倒排索引持久化"]
            CHK["chunks 文件
            XOR 压缩数据"]
            META["meta.json
            块元数据"]
        end
        
        Memory --&gt;|压缩| Compress
        Compress --&gt;|持久化| Disk
    end
    
    style Memory fill:#e1f5ff,stroke:#0288d1,stroke-width:3px
    style Disk fill:#fff3e0,stroke:#f57c00,stroke-width:3px
    style Compress fill:#f0f0f0,stroke:#666,stroke-width:2px
    style SI fill:#bbdefb,stroke:#0288d1
    style PL fill:#bbdefb,stroke:#0288d1
    style AC fill:#bbdefb,stroke:#0288d1
    style IDX fill:#ffe0b2,stroke:#f57c00
    style CHK fill:#ffe0b2,stroke:#f57c00
    style META fill:#ffe0b2,stroke:#f57c00
</code></pre>
<p><strong>对应到超市：</strong></p>
<ul>
<li><strong>Series 索引表</strong> = 商品目录册（"可乐在B2货架"）</li>
<li><strong>Posting Lists</strong> = 分类标签墙（"饮料类：可乐、雪碧..."）</li>
<li><strong>Active Chunks</strong> = 前台货架（最近进货的商品）</li>
<li><strong>index/chunks 文件</strong> = 后台大仓库（整箱压缩存放）</li>
</ul>
<h3 data-id="heading-5">3.2 关键数据：什么放内存，什么放磁盘？</h3>









































<table><thead><tr><th>数据类型</th><th>存储位置</th><th>大小估算</th><th>高基数影响</th></tr></thead><tbody><tr><td>Series 索引</td><td>内存</td><td>每时序 2-4 KB</td><td>直接膨胀</td></tr><tr><td>倒排索引</td><td>内存</td><td>随标签值增长</td><td>急剧增长</td></tr><tr><td>最新数据（2小时内）</td><td>内存</td><td>每时序 ~1 KB</td><td>线性增长</td></tr><tr><td>历史数据</td><td>磁盘</td><td>压缩后 1:10</td><td>碎片化</td></tr><tr><td>WAL日志</td><td>磁盘</td><td>未压缩</td><td>写入放大</td></tr></tbody></table>
<p><strong>核心公式：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">内存占用</span> <span class="hljs-string">≈</span> <span class="hljs-string">时序总数</span> <span class="hljs-string">×</span> <span class="hljs-number">3</span> <span class="hljs-string">KB</span>
<span class="hljs-string">推荐上限：单实例</span> <span class="hljs-string">&lt;</span> <span class="hljs-number">1000</span> <span class="hljs-string">万时序</span>
</code></pre>
<p><strong>现在再看开头的问题：</strong></p>
<pre><code class="hljs language-ini" lang="ini">order_total{<span class="hljs-attr">user_id</span>=<span class="hljs-string">"10086"</span>}  <span class="hljs-comment"># 100万用户 = 100万个 Series</span>
↓
Series 索引表：100万 × <span class="hljs-attr">3KB</span> = <span class="hljs-number">3</span>GB（仅索引就爆了！）
查询时要遍历 100万个货架位 → 30秒超时
</code></pre>
<h3 data-id="heading-6">3.4 内存结构详解</h3>
<p><strong>Series 索引表 = 商品总目录</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Normal["正常商品目录"]
        N1["可乐(瓶装) → B2货架
        对应: (method='GET') → ID:1"]
        N2["可乐(罐装) → B3货架
        对应: (method='POST') → ID:2"]
    end
    
    subgraph HighCard["❌ 高基数问题"]
        H1["张三的可乐 → A1货架
        对应: (user_id='10086') → ID:1"]
        H2["李四的可乐 → A2货架
        对应: (user_id='10087') → ID:2"]
        H3["王五的可乐 → A3货架
        对应: (user_id='10088') → ID:3"]
        H4["... 100万个顾客"]
    end
    
    style Normal fill:#c8e6c9,stroke:#4caf50,stroke-width:3px
    style HighCard fill:#ffcdd2,stroke:#f44336,stroke-width:3px
    style N1 fill:#a5d6a7,stroke:#2e7d32
    style N2 fill:#a5d6a7,stroke:#2e7d32
    style H1 fill:#ef9a9a,stroke:#c62828
    style H2 fill:#ef9a9a,stroke:#c62828
    style H3 fill:#ef9a9a,stroke:#c62828
    style H4 fill:#ef9a9a,stroke:#c62828
</code></pre>
<p><strong>Posting Lists = 分类标签墙</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph Drink["饮料类"]
        D1[可乐]
        D2[雪碧]
        D3[牛奶]
    end
    
    subgraph Snack["零食类"]
        S1[薯片]
        S2[饼干]
        S3[巧克力]
    end
    
    subgraph HighCard["❌ 高基数: 用户标签"]
        U1["user_id=10086
        SeriesID:100001"]
        U2["user_id=10087
        SeriesID:100002"]
        U3["user_id=10088
        SeriesID:100003"]
        U4["... 100万个标签"]
    end
    
    style Drink fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
    style Snack fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    style HighCard fill:#ffcdd2,stroke:#f44336,stroke-width:3px
    style D1 fill:#bbdefb,stroke:#0288d1
    style D2 fill:#bbdefb,stroke:#0288d1
    style D3 fill:#bbdefb,stroke:#0288d1
    style S1 fill:#e1bee7,stroke:#9c27b0
    style S2 fill:#e1bee7,stroke:#9c27b0
    style S3 fill:#e1bee7,stroke:#9c27b0
    style U1 fill:#ef9a9a,stroke:#c62828
    style U2 fill:#ef9a9a,stroke:#c62828
    style U3 fill:#ef9a9a,stroke:#c62828
    style U4 fill:#ef9a9a,stroke:#c62828
</code></pre>
<hr/>
<h2 data-id="heading-7">四、电商场景：好与坏的指标设计</h2>
<h3 data-id="heading-8">4.1 订单监控</h3>
<h4 data-id="heading-9">反面案例：每个用户、每个订单都是独立时序</h4>
<pre><code class="hljs language-prometheus" lang="prometheus"># 错误设计
order_created{
  user_id="10086",           # 100万个用户
  order_id="20240501001",    # 每天50万订单
  product_id="SKU12345"      # 10万个商品
}

问题分析：
├─ 时序数量：100万用户 × 1个指标 = 100万时序
├─ 内存占用：100万 × 3KB = 3GB（仅索引）
├─ 查询延迟：sum(order_created) → 30秒超时
└─ 存储浪费：大部分订单只有1个样本点
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Bad["❌ 错误设计: 高基数"]
        B1["user_id='10086'
        100万个用户"]
        B2["order_id='ABC123'
        每天50万订单"]
        B3["product_id='SKU001'
        10万个商品"]
        
        Result1["时序数: 100万+
        内存: 3GB
        查询: 30秒超时"]
    end
    
    B1 &amp; B2 &amp; B3 --&gt; Result1
    
    style Bad fill:#ffcdd2,stroke:#f44336,stroke-width:3px
    style B1 fill:#ef9a9a,stroke:#c62828
    style B2 fill:#ef9a9a,stroke:#c62828
    style B3 fill:#ef9a9a,stroke:#c62828
    style Result1 fill:#ffebee,stroke:#c62828,stroke-width:2px
</code></pre>
<p><strong>为什么错？</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Problem[超市类比] --&gt; P1["每个顾客的
    每件商品都单独上架"]
    P1 --&gt; P2["张三的可乐
    李四的可乐
    王五的可乐..."]
    P2 --&gt; P3["商品目录1000页
    货架爆满"]
    
    style Problem fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style P1 fill:#ffccbc,stroke:#ff5722
    style P2 fill:#ffccbc,stroke:#ff5722
    style P3 fill:#ffcdd2,stroke:#f44336,stroke-width:3px
</code></pre>
<h4 data-id="heading-10">正面案例：聚合维度</h4>
<pre><code class="hljs language-prometheus" lang="prometheus"># 正确设计
order_created_total{
  source="app|web|miniprogram",      # 3个值
  payment_method="alipay|wechat",    # 5个值
  product_category="electronics"     # 20个一级类目
}

优势：
├─ 时序数量：3 × 5 × 20 = 300时序
├─ 内存占用：300 × 3KB = 900KB
├─ 查询延迟：sum(order_created_total) → 10ms
└─ 存储效率：样本点密集，压缩率高
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Good["✓ 正确设计: 低基数"]
        G1["source
        3个值"]
        G2["payment_method
        5个值"]
        G3["product_category
        20个类目"]
        
        Result2["时序数: 300
        内存: 900KB
        查询: 10ms"]
    end
    
    G1 &amp; G2 &amp; G3 --&gt; Result2
    
    style Good fill:#c8e6c9,stroke:#4caf50,stroke-width:3px
    style G1 fill:#a5d6a7,stroke:#2e7d32
    style G2 fill:#a5d6a7,stroke:#2e7d32
    style G3 fill:#a5d6a7,stroke:#2e7d32
    style Result2 fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
</code></pre>
<p><strong>为什么对？</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    Solution[超市类比] --&gt; S1[按商品类型分类]
    S1 --&gt; S2["瓶装可乐
    罐装可乐
    ..."]
    S2 --&gt; S3["商品目录1页
    清晰明了"]
    
    style Solution fill:#e8f5e9,stroke:#4caf50,stroke-width:2px
    style S1 fill:#c8e6c9,stroke:#66bb6a
    style S2 fill:#c8e6c9,stroke:#66bb6a
    style S3 fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px
</code></pre>
<h3 data-id="heading-11">4.2 接口性能监控</h3>
<h4 data-id="heading-12">反面案例：动态URL路径</h4>
<pre><code class="hljs language-prometheus" lang="prometheus"># 错误设计
api_request_duration{
  path="/api/order/10086/detail",    # 每个订单号一个路径
  path="/api/order/10087/detail",
  path="/api/user/20001/profile",    # 每个用户ID一个路径
  ...
}

问题：
├─ URL数量：每天几十万个不同路径
├─ 时序爆炸：每个路径一条时序
└─ 无法聚合：sum() 毫无意义
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    URL1["api/order/10086/detail"] --&gt; TS1["时序1"]
    URL2["api/order/10087/detail"] --&gt; TS2["时序2"]
    URL3["api/order/10088/detail"] --&gt; TS3["时序3"]
    URL4["... 每天50万个URL"] --&gt; TS4["... 50万时序"]
    
    TS1 &amp; TS2 &amp; TS3 &amp; TS4 --&gt; Problem["❌ 无法聚合
    查询超时"]
    
    style URL1 fill:#ffccbc,stroke:#ff5722
    style URL2 fill:#ffccbc,stroke:#ff5722
    style URL3 fill:#ffccbc,stroke:#ff5722
    style URL4 fill:#ffccbc,stroke:#ff5722
    style TS1 fill:#ef9a9a,stroke:#c62828
    style TS2 fill:#ef9a9a,stroke:#c62828
    style TS3 fill:#ef9a9a,stroke:#c62828
    style TS4 fill:#ef9a9a,stroke:#c62828
    style Problem fill:#ffcdd2,stroke:#f44336,stroke-width:3px
</code></pre>
<h4 data-id="heading-13">正面案例：路径归一化</h4>
<pre><code class="hljs language-prometheus" lang="prometheus"># 正确设计
api_request_duration{
  path="/api/order/{id}/detail",     # 模板化
  method="GET",
  status="200|500"
}

实现方式：
在应用代码或网关层做路径归一化：
/api/order/10086/detail  → /api/order/{id}/detail
/api/user/20001/profile  → /api/user/{id}/profile
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    URL1["api/order/10086/detail"] --&gt; Normalize
    URL2["api/order/10087/detail"] --&gt; Normalize
    URL3["api/order/10088/detail"] --&gt; Normalize
    
    Normalize["路径归一化"] --&gt; Template["api/order/{id}/detail"]
    Template --&gt; TS["✓ 1个聚合时序
    查询快速"]
    
    style URL1 fill:#bbdefb,stroke:#0288d1
    style URL2 fill:#bbdefb,stroke:#0288d1
    style URL3 fill:#bbdefb,stroke:#0288d1
    style Normalize fill:#fff9c4,stroke:#fbc02d,stroke-width:2px
    style Template fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style TS fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px
</code></pre>
<h3 data-id="heading-14">4.3 库存监控</h3>
<h4 data-id="heading-15">反面案例：商品级别监控</h4>
<pre><code class="hljs language-prometheus" lang="prometheus"># 错误设计
inventory_level{
  product_id="SKU001",      # 10万个SKU
  warehouse_id="WH001",     # 100个仓库
  location="A-01-05"        # 1万个货位
}

时序数：10万 × 100 × 1万 = 1000亿（理论值）
实际：即使只有部分组合，也有百万级时序
</code></pre>
<h4 data-id="heading-16">正面案例：分层监控</h4>
<pre><code class="hljs language-prometheus" lang="prometheus"># 宏观监控（低基数）
inventory_health{
  category="electronics",       # 20个类目
  warehouse_region="south",     # 5个大区
  stock_status="low|normal|high" # 3个状态
}

# 详细监控（仅Top商品）
inventory_detail{
  product_id="SKU001",          # 仅监控Top 1000商品
  warehouse_id="WH001"
}
</code></pre>
<h3 data-id="heading-17">4.4 对比总结</h3>



































<table><thead><tr><th>维度</th><th>反面案例</th><th>正面案例</th><th>差距</th></tr></thead><tbody><tr><td>时序数量</td><td>100万+</td><td>300-1000</td><td>1000倍</td></tr><tr><td>内存占用</td><td>3GB+</td><td>&lt;5MB</td><td>600倍</td></tr><tr><td>查询延迟</td><td>30秒+</td><td>10-50ms</td><td>3000倍</td></tr><tr><td>告警响应</td><td>经常超时</td><td>实时</td><td>-</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-18">五、告警场景的共性抽取</h2>
<h3 data-id="heading-19">5.1 告警的本质需求</h3>
<p>Prometheus 作为告警系统，核心需求是：</p>
<pre><code class="hljs">快速回答：系统出了什么问题？
而不是：谁在什么时候做了什么？
</code></pre>
<p><strong>实际案例：</strong></p>
<pre><code class="hljs language-java" lang="java">告警需求                        需要的维度              不需要的维度
─────────────────────────────────────────────────────────
订单支付失败率超<span class="hljs-number">5</span>%              payment_method          user_id, order_id
                               error_type              
                               
API延迟P99超<span class="hljs-number">1</span>秒                 service_name            request_id
                               <span class="hljs-title function_">endpoint</span> <span class="hljs-params">(归一化)</span>        user_id
                               
库存水位低于阈值                category                product_id
                               warehouse_region        具体货位
</code></pre>
<h3 data-id="heading-20">5.2 告警指标的设计规律</h3>
<h4 data-id="heading-21">规律1：聚合维度，而非明细维度</h4>
<pre><code class="hljs language-ini" lang="ini">思考：你需要知道"哪些订单失败了"，还是"为什么失败"？

错误：
alert: order_failed{<span class="hljs-attr">order_id</span>=<span class="hljs-string">"xxx"</span>} &gt; <span class="hljs-number">0</span>
→ 每个订单都告警，无法处理

正确：
alert: rate(order_failed_total{<span class="hljs-attr">reason</span>=<span class="hljs-string">"timeout"</span>}[<span class="hljs-number">5</span>m]) &gt; <span class="hljs-number">0.05</span>
→ 超时导致的失败率超5%，立刻修复
</code></pre>
<h4 data-id="heading-22">规律2：技术维度比业务明细重要</h4>
<p><strong>必选维度（技术运维）：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">service</span>=<span class="hljs-string">"order-service"</span>     <span class="hljs-comment"># 哪个服务</span>
<span class="hljs-attr">instance</span>=<span class="hljs-string">"10.0.1.5:9090"</span>   <span class="hljs-comment"># 哪台机器</span>
<span class="hljs-attr">environment</span>=<span class="hljs-string">"production"</span>    <span class="hljs-comment"># 哪个环境</span>
</code></pre>
<p><strong>可选维度（业务聚合）：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">payment_method</span>=<span class="hljs-string">"alipay"</span>    <span class="hljs-comment"># 支付方式</span>
<span class="hljs-attr">category</span>=<span class="hljs-string">"electronics"</span>     <span class="hljs-comment"># 商品类目</span>
<span class="hljs-attr">region</span>=<span class="hljs-string">"华南"</span>              <span class="hljs-comment"># 地域</span>
</code></pre>
<p><strong>禁用维度（业务明细）：</strong></p>
<pre><code class="hljs language-bash" lang="bash">user_id                    <span class="hljs-comment"># 用户ID → 放日志</span>
order_id                   <span class="hljs-comment"># 订单号 → 放日志</span>
product_id                 <span class="hljs-comment"># 商品ID → 放日志（除非Top商品）</span>
</code></pre>
<h4 data-id="heading-23">规律3：状态聚合，而非状态穷举</h4>
<pre><code class="hljs language-ini" lang="ini">反面：
<span class="hljs-attr">order_status</span>=<span class="hljs-string">"created|paid|shipped|delivered|cancelled|refunded|..."</span>
→ 10+ 种状态，组合爆炸

正面：
<span class="hljs-attr">order_status</span>=<span class="hljs-string">"success|failed"</span>
<span class="hljs-attr">order_stage</span>=<span class="hljs-string">"processing|completed"</span>
→ 2-3 种状态，清晰明了
</code></pre>
<h3 data-id="heading-24">5.3 典型告警规则模板</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 订单成功率告警</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">OrderSuccessRateLow</span>
  <span class="hljs-attr">expr:</span> <span class="hljs-string">|
    rate(order_success_total{env="prod"}[5m]) 
    / 
    rate(order_total{env="prod"}[5m]) &lt; 0.95
</span>  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">summary:</span> <span class="hljs-string">"订单成功率低于95%"</span>
    
<span class="hljs-comment"># API延迟告警</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">APILatencyHigh</span>
  <span class="hljs-attr">expr:</span> <span class="hljs-string">|
    histogram_quantile(0.99, 
      rate(api_duration_bucket{service="order"}[5m])
    ) &gt; 1
</span>  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">summary:</span> <span class="hljs-string">"API P99延迟超过1秒"</span>

<span class="hljs-comment"># 库存水位告警</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">InventoryLow</span>
  <span class="hljs-attr">expr:</span> <span class="hljs-string">|
    inventory_level{status="low"} &gt; 100
</span>  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">summary:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{$labels.category}}</span> 类目库存不足"</span>
</code></pre>
<h3 data-id="heading-25">5.4 告警维度设计清单</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6a22dc6f914c2daa2b7cfe23da43e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LiP5rWq5peg55eV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270907&amp;x-signature=aOB1xfnKfOnAioSfmVtEpM43B2s%3D" alt="2.jpg" loading="lazy"/></p>
<p><strong>具体示例：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    subgraph Good["✓ 推荐使用"]
        G1["service_name
        知道哪个服务"]
        G2["error_type
        知道失败原因"]
        G3["payment_method
        5-10种"]
    end
    
    subgraph Bad["❌ 不要使用"]
        B1["user_id
        不关心是谁"]
        B2["request_id
        无限增长"]
        B3["order_id
        放日志即可"]
    end
    
    style Good fill:#c8e6c9,stroke:#4caf50,stroke-width:3px
    style Bad fill:#ffcdd2,stroke:#f44336,stroke-width:3px
    style G1 fill:#a5d6a7,stroke:#2e7d32
    style G2 fill:#a5d6a7,stroke:#2e7d32
    style G3 fill:#a5d6a7,stroke:#2e7d32
    style B1 fill:#ef9a9a,stroke:#c62828
    style B2 fill:#ef9a9a,stroke:#c62828
    style B3 fill:#ef9a9a,stroke:#c62828
</code></pre>
<hr/>
<h2 data-id="heading-26">六、操作指引与总结</h2>
<h3 data-id="heading-27">6.1 标签设计黄金法则</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Rule1["原则1: 基数控制"]
        R1A["单个标签 &lt; 100个值"]
        R1B["标签组合 &lt; 10,000时序"]
    end
    
    subgraph Rule2["原则2: 三不原则"]
        R2A["❌ 不用唯一标识
        user_id, order_id"]
        R2B["❌ 不用动态值
        完整URL, 堆栈"]
        R2C["❌ 不过度细化
        省市区 → 大区"]
    end
    
    subgraph Rule3["原则3: 分层存储"]
        R3A["聚合指标 → Prometheus
        用于告警"]
        R3B["明细数据 → ELK/ClickHouse
        用于分析"]
        R3C["链路追踪 → Jaeger
        用于调试"]
    end
    
    Rule1 --&gt; Rule2
    Rule2 --&gt; Rule3
    
    style Rule1 fill:#e1f5ff,stroke:#0288d1,stroke-width:3px
    style Rule2 fill:#fff3e0,stroke:#f57c00,stroke-width:3px
    style Rule3 fill:#f3e5f5,stroke:#9c27b0,stroke-width:3px
    style R1A fill:#bbdefb,stroke:#0288d1
    style R1B fill:#bbdefb,stroke:#0288d1
    style R2A fill:#ffe0b2,stroke:#f57c00
    style R2B fill:#ffe0b2,stroke:#f57c00
    style R2C fill:#ffe0b2,stroke:#f57c00
    style R3A fill:#e1bee7,stroke:#9c27b0
    style R3B fill:#e1bee7,stroke:#9c27b0
    style R3C fill:#e1bee7,stroke:#9c27b0
</code></pre>
<h3 data-id="heading-28">6.2 快速诊断清单</h3>
<p>发现查询变慢或内存飙升？按以下步骤检查：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    Start([发现性能问题]) --&gt; Step1
    
    Step1["Step 1: 查看 TSDB Status
    访问 /tsdb-status"] --&gt; Check1{时序总数 &gt; 500万?}
    
    Check1 --&gt;|是| Step2A["找出高基数指标
    Top 10 series count"]
    Check1 --&gt;|否| Step2B[检查查询复杂度]
    
    Step2A --&gt; Step3["Step 2: 执行基数分析
    topk查询"]
    Step3 --&gt; Analyze{哪类标签值最多?}
    
    Analyze --&gt;|user_id等唯一ID| Fix1["移除标签
    改为日志记录"]
    Analyze --&gt;|URL动态路径| Fix2["路径归一化
    使用模板"]
    Analyze --&gt;|省市区等细化| Fix3["聚合为大区
    降低维度"]
    
    Fix1 &amp; Fix2 &amp; Fix3 --&gt; Step4["Step 3: 应用修复
    使用 relabel_configs"]
    Step4 --&gt; Verify["验证效果
    监控时序数变化"]
    
    style Start fill:#e1f5ff,stroke:#0288d1,stroke-width:2px
    style Step1 fill:#fff9c4,stroke:#fbc02d
    style Check1 fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style Analyze fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style Fix1 fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style Fix2 fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style Fix3 fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    style Step4 fill:#bbdefb,stroke:#0288d1
    style Verify fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px
</code></pre>
<p><strong>Step 1: 查看 TSDB Status</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 访问 Prometheus UI</span>
http://localhost:9090/tsdb-status

重点关注：
• Head Cardinality Stats
• Top 10 label names with value count
• Top 10 series count by metric names

找出：哪个标签有10万+个值？哪个指标有10万+时序？
</code></pre>
<p><strong>Step 2: 执行基数分析查询</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 查看时序总数
count({__name__=~".+"})

# 找出高基数指标（Top 10）
topk(10, count by (__name__)({__name__=~".+"}))

# 找出高基数标签
# 在 TSDB Status 页面查看 "label names with value count"
</code></pre>
<p><strong>Step 3: 对症下药</strong></p>
<pre><code class="hljs language-bash" lang="bash">问题类型                    解决方案
─────────────────────────────────────────
user_id 等唯一ID            移除标签，改为日志记录

URL 动态路径                路径归一化：
                           /api/order/123 → /api/order/{<span class="hljs-built_in">id</span>}

过度细化（省市区）          聚合为大区

历史遗留高基数指标          使用 relabel_configs 丢弃
</code></pre>
<h3 data-id="heading-29">6.3 Relabel 配置示例</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># prometheus.yml</span>
<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'order-service'</span>
    <span class="hljs-attr">relabel_configs:</span>
      <span class="hljs-comment"># 丢弃高基数标签</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">action:</span> <span class="hljs-string">labeldrop</span>
        <span class="hljs-attr">regex:</span> <span class="hljs-string">'user_id|order_id|request_id'</span>
      
      <span class="hljs-comment"># URL 路径归一化</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__path__</span>]
        <span class="hljs-attr">target_label:</span> <span class="hljs-string">path</span>
        <span class="hljs-attr">regex:</span> <span class="hljs-string">'/api/order/[0-9]+/(.*)'</span>
        <span class="hljs-attr">replacement:</span> <span class="hljs-string">'/api/order/{id}/$1'</span>
</code></pre>
<h3 data-id="heading-30">6.4 核心要点回顾</h3>
<p><strong>存储分层原则：</strong></p>
<ul>
<li>索引和最新数据存储在内存，保证查询速度</li>
<li>历史数据存储在磁盘，通过压缩节省空间</li>
<li>热数据（2小时内）用于实时告警，冷数据用于历史分析</li>
</ul>
<p><strong>标签设计原则：</strong></p>
<ul>
<li>标签应该是可聚合的维度，而非唯一标识</li>
<li>用户ID、订单号等明细信息应该放在日志系统</li>
<li>控制标签基数是保证查询性能的关键</li>
</ul>
<p><strong>监控与追踪的分工：</strong></p>
<ul>
<li>监控系统关注整体趋势和异常模式，用于告警</li>
<li>追踪系统关注个体行为和详细路径，用于排查</li>
<li>Prometheus 负责"发生了什么"，日志/追踪负责"谁做了什么"</li>
</ul>
<h3 data-id="heading-31">6.5 总结</h3>
<p><strong>Prometheus 的设计哲学：</strong></p>
<blockquote>
<p>监控系统应该回答"发生了什么"（What happened），
而不是"谁做了什么"（Who did what）。</p>
</blockquote>
<p><strong>两个维度的数据分离：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/953e4d21fb32468fb546dfacca3ba947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LiP5rWq5peg55eV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768270907&amp;x-signature=A6VpvJiUFG8CADDqBBEGbpav20A%3D" alt="1.jpg" loading="lazy"/></p>
<p><strong>最后的建议：</strong></p>
<ol>
<li><strong>新指标上线前</strong>：先评估基数，计算 <code>时序数 = 各标签基数的乘积</code></li>
<li><strong>定期巡检</strong>：每周查看 TSDB Status，关注时序增长趋势</li>
<li><strong>告警优先</strong>：记住 Prometheus 主要用于告警，不是万能分析工具</li>
<li><strong>工具组合</strong>：Prometheus + ELK + Jaeger 才是完整的可观测性方案</li>
</ol>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li>Prometheus 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fprometheus.io%2Fdocs%2F" target="_blank" title="https://prometheus.io/docs/" ref="nofollow noopener noreferrer">prometheus.io/docs/</a></li>
<li>TSDB 设计论文：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffabxc.org%2Ftsdb%2F" target="_blank" title="https://fabxc.org/tsdb/" ref="nofollow noopener noreferrer">fabxc.org/tsdb/</a></li>
<li>基数分析工具：promtool tsdb analyze</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多智能体协作案例实践（二）：基于LangGraph框架]]></title>    <link>https://juejin.cn/post/7591697558377431082</link>    <guid>https://juejin.cn/post/7591697558377431082</guid>    <pubDate>2026-01-06T01:14:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591697558377431082" data-draft-id="7591672090790952979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多智能体协作案例实践（二）：基于LangGraph框架"/> <meta itemprop="keywords" content="后端,Python,人工智能"/> <meta itemprop="datePublished" content="2026-01-06T01:14:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木昆子"/> <meta itemprop="url" content="https://juejin.cn/user/825103640698564"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多智能体协作案例实践（二）：基于LangGraph框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/825103640698564/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木昆子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:14:04.000Z" title="Tue Jan 06 2026 01:14:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上篇<a href="https://juejin.cn/post/7591730714140540970" target="_blank" title="https://juejin.cn/post/7591730714140540970">《多智能体协作案例实践（一）：基于AgentScope框架》</a>文章中，Chaiys同学围绕高考信息查询智能助手业务场景，采用AgentScope框架进行多智能体协作的验证。</p>
<p>本文基于同样的业务场景和案例，采用LangGraph框架进行对比实践和验证，以便更深入地理解。</p>
<h2 data-id="heading-0">🧠 多智能体协作实现逻辑</h2>
<p>首先回顾一下业务场景，和上篇文章保持一致，还是支撑用户进行高考信息查询，并且要支持多轮对话，后续会基于以下案例来进行验证：</p>
<p>第一轮提问：2016年考生人数有多少？<br/>
第二轮追问年份：2018年呢？<br/>
第三轮追问其他：录取人数呢？</p>
<p>针对该业务场景，四个智能体之间的协作逻辑和AgentScope案例也完全保持一致：</p>
<p>1）用户输入问题</p>
<p>2）TemplateAgent判断是否有上下文历史，如果没有则转4，有则进一步匹配历史问题模板，如未匹配到则转3，如匹配到则基于模板SQL，从用户当前问题中提取查询参数植入模板SQL，执行后带查询结果转5</p>
<p>3）有上下文历史，但没有匹配的历史问题，则进入意图识别改写RewriteAgent，利用上下文对话背景对用户当前问题做改写，然后进入SQLAgent，RAG检索元数据、生成SQL、查询数据，最后进入AnalysisAgent分析回答</p>
<p>4）无上下文历史，代表用户是首次提问，则直接进入SQLAgent，RAG检索元数据、生成SQL、查询数据，最后进入AnalysisAgent分析回答</p>
<p>5）根据查询结果直接进入AnalysisAgent分析回答</p>
<p>这个协作逻辑基于 LangGraph框架的自定义状态图StataGraph实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========================</span>
<span class="hljs-comment"># 🧭 路由函数</span>
<span class="hljs-comment"># ========================</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_to_next_agent</span>(<span class="hljs-params">state: State</span>) -&gt; <span class="hljs-type">Literal</span>[<span class="hljs-string">"sql"</span>, <span class="hljs-string">"analysis"</span>, <span class="hljs-string">"rewrite"</span>, <span class="hljs-string">"__end__"</span>]:
    <span class="hljs-keyword">if</span> state.get(<span class="hljs-string">"next_agent"</span>) == <span class="hljs-string">"sql"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"sql"</span>
    <span class="hljs-keyword">if</span> state.get(<span class="hljs-string">"next_agent"</span>) == <span class="hljs-string">"analysis"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"analysis"</span>
    <span class="hljs-keyword">if</span> state.get(<span class="hljs-string">"next_agent"</span>) == <span class="hljs-string">"rewrite"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"rewrite"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"__end__"</span>
    
workflow = StateGraph(State)

workflow.add_node(<span class="hljs-string">"template"</span>, template_agent)
workflow.add_node(<span class="hljs-string">"rewrite"</span>, rewrite_agent)   <span class="hljs-comment"># 新增改写智能体</span>
workflow.add_node(<span class="hljs-string">"sql"</span>, sql_agent)
workflow.add_node(<span class="hljs-string">"analysis"</span>, analysis_agent)

workflow.add_edge(START, <span class="hljs-string">"template"</span>)

<span class="hljs-comment"># Template 之后根据条件流向</span>
workflow.add_conditional_edges(
    <span class="hljs-string">"template"</span>,
    route_to_next_agent,
    {
        <span class="hljs-string">"rewrite"</span>: <span class="hljs-string">"rewrite"</span>,     <span class="hljs-comment"># 新增 rewrite 分支</span>
        <span class="hljs-string">"sql"</span>: <span class="hljs-string">"sql"</span>,
        <span class="hljs-string">"analysis"</span>: <span class="hljs-string">"analysis"</span>,
        <span class="hljs-string">"__end__"</span>: END
    }
)

<span class="hljs-comment"># 改写智能体完成后交给 SQL</span>
workflow.add_edge(<span class="hljs-string">"rewrite"</span>, <span class="hljs-string">"sql"</span>)

<span class="hljs-comment"># SQL 执行后流向分析</span>
workflow.add_edge(<span class="hljs-string">"sql"</span>, <span class="hljs-string">"analysis"</span>)
workflow.add_edge(<span class="hljs-string">"analysis"</span>, END)

<span class="hljs-comment"># ========================</span>
<span class="hljs-comment"># ▶️ 主流程</span>
<span class="hljs-comment"># ========================</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">from</span> uuid <span class="hljs-keyword">import</span> uuid4

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 智能数据助手（支持追问、多轮上下文）"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> *<span class="hljs-number">80</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"💡 输入问题开始对话，输入 'exit' 退出。"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> *<span class="hljs-number">80</span>)

    <span class="hljs-comment"># 每次启动生成唯一 thread_id（上下文记忆关键）</span>
    thread_id = <span class="hljs-built_in">str</span>(uuid4())
    config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: thread_id}}

    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        user_input = <span class="hljs-built_in">input</span>(<span class="hljs-string">"\n👤 你: "</span>).strip()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user_input:
            <span class="hljs-keyword">continue</span>
        <span class="hljs-keyword">if</span> user_input.lower() <span class="hljs-keyword">in</span> {<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>}:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"👋 再见！会话已结束。"</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-comment"># 构造输入</span>
        input_data = {
            <span class="hljs-string">"messages"</span>: [HumanMessage(content=user_input)],
        }

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 流式执行</span>
            <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> app.stream(input_data, config=config):
                <span class="hljs-keyword">if</span> <span class="hljs-string">"analysis"</span> <span class="hljs-keyword">in</span> chunk:
                    msg = chunk[<span class="hljs-string">"analysis"</span>][<span class="hljs-string">"messages"</span>][<span class="hljs-number">0</span>]
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"💬 助手: <span class="hljs-subst">{msg.content.strip()}</span>"</span>)
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> *<span class="hljs-number">60</span>)
                <span class="hljs-keyword">elif</span> <span class="hljs-string">"sql"</span> <span class="hljs-keyword">in</span> chunk <span class="hljs-keyword">and</span> <span class="hljs-string">"messages"</span> <span class="hljs-keyword">in</span> chunk[<span class="hljs-string">"sql"</span>]:
                    <span class="hljs-comment"># SQL 生成失败的情况</span>
                    <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> chunk[<span class="hljs-string">"sql"</span>][<span class="hljs-string">"messages"</span>]:
                        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(m, AIMessage):
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"💬 助手: <span class="hljs-subst">{m.content.strip()}</span>"</span>)
                            <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> *<span class="hljs-number">60</span>)
                <span class="hljs-keyword">elif</span> <span class="hljs-string">"__end__"</span> <span class="hljs-keyword">in</span> chunk:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 对话结束"</span>)

        <span class="hljs-keyword">except</span> json.JSONDecodeError:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ JSON 解析失败，可能是 LLM 返回了非结构化内容。"</span>)
        <span class="hljs-keyword">except</span> KeyboardInterrupt:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n⏹️ 中断。输入 exit 可退出。"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"💥 出错：<span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<p>如以上代码所示，通过“workflow.add_node”方式添加四个Node节点：template、rewrite、sql、analysis分别代表四个智能体。<br/>
通过“workflow.add_edge”方式添加对应节点之间的跳转关系，其中“workflow.add_conditional_edges”是添加条件边，通过调用route_to_next_agent()路由函数根据智能体返回的next_agent字段决定流转到哪一个节点。</p>
<h3 data-id="heading-1"><strong>🔁 多轮对话之上下文记忆和状态机</strong></h3>
<p>LangGraph上下文记忆的相关机制，主要通过官方提供的 MemorySaver() 实现：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 启用记忆（支持多轮对话）</span>
<span class="hljs-attr">memory</span> = MemorySaver()
<span class="hljs-attr">app</span> = workflow.compile(checkpointer=memory)
</code></pre>
<p>MemorySaver会将每一个节点执行后的 State 存储到检查点（checkpoint）中，使得下一次调用可以从之前的对话状态继续执行。</p>
<p>其特点是原样存 储state状态机，不裁剪、不删减、不合并历史，真正关键的是你在 State 状态机中设计的业务逻辑。</p>
<p>使用“ StateGraph(State)”方式在状态图StateGraph初始化时就将自定义State状态机对象注入并绑定：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========================</span>
<span class="hljs-comment"># 🧠 增强状态定义</span>
<span class="hljs-comment"># ========================</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    messages: Annotated[<span class="hljs-built_in">list</span>[BaseMessage], add_messages]
    original_intent: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 如 "考生人数"</span>
    known_table_struct: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>]  <span class="hljs-comment"># 已确认的表结构</span>
    last_sql_template: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]  <span class="hljs-comment"># 带占位符的 SQL 模板，如 "SELECT ... WHERE year = {year}"</span>
    query_result: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">list</span>]  <span class="hljs-comment"># 最近一次查询结果</span>
    next_agent: <span class="hljs-built_in">str</span>
</code></pre>
<p>每轮对话都会在全局统一状态机中保存以下信息：</p>

































<table><thead><tr><th>key</th><th>含义</th></tr></thead><tbody><tr><td>messages</td><td>历史消息列表</td></tr><tr><td>original_intent</td><td>用户的核心意图（如“考生人数”）</td></tr><tr><td>known_table_struct</td><td>已识别的数据表结构</td></tr><tr><td>last_sql_template</td><td>参数化 SQL 模板，便于复用</td></tr><tr><td>query_result</td><td>查询结果</td></tr><tr><td>next_agent</td><td>下一步路由方向</td></tr></tbody></table>
<p>其中当我们使用 Annotated[list[BaseMessage], add_messages] 来定义 State 中的 messages 字段时，新的消息会自动被追加到现有的消息列表之后，这是 LangGraph 为管理对话历史等序列化数据提供的一种便捷且强大的状态更新机制。</p>
<p>LangGraph所有智能体Agent都要遵循统一规范，将Stata对象作为输入输出对象，如以下“模板匹配智能体”templateAgent的代码所示：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ========================</span>
<span class="hljs-comment"># 🍻模板匹配 智能体（支持追问模板复用）</span>
<span class="hljs-comment"># ========================</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">template_agent</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 🟦 Template Agent ==="</span>)
    current_query = state[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>].content

    <span class="hljs-comment"># ───────────────────────────────────────</span>
    <span class="hljs-comment"># 🔄 情况1：无上下文 → SQL Agent</span>
    <span class="hljs-comment"># ───────────────────────────────────────</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> state.get(<span class="hljs-string">"known_table_struct"</span>)
            <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> state.get(<span class="hljs-string">"original_intent"</span>)
            <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> state.get(<span class="hljs-string">"last_sql_template"</span>)):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 不存在上下文，进入SQL Agent流程"</span>)
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: state[<span class="hljs-string">"messages"</span>],
            <span class="hljs-string">"next_agent"</span>: <span class="hljs-string">"sql"</span>
        }

    <span class="hljs-comment"># ───────────────────────────────────────</span>
    <span class="hljs-comment"># 🔄 情况2：已有上下文 → 尝试参数化追问处理</span>
    <span class="hljs-comment"># ───────────────────────────────────────</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🔄 检测到历史上下文，尝试参数化追问"</span>)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 具体业务代码跳过...</span>

        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 追问查询成功，进入分析流程"</span>)
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"query_result"</span>: result,
            <span class="hljs-string">"next_agent"</span>: <span class="hljs-string">"analysis"</span>
        }


    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"参数提取失败: <span class="hljs-subst">{e}</span>"</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 追问处理失败，进入改写流程"</span>)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"messages"</span>: state[<span class="hljs-string">"messages"</span>],
        <span class="hljs-string">"next_agent"</span>: <span class="hljs-string">"rewrite"</span>
    }
</code></pre>
<h3 data-id="heading-2"><strong>▶️ 案例测试结果</strong></h3>
<p>我们测试一下LangGraph实现多智能体协作的效果：</p>
<pre><code class="hljs language-rust" lang="rust">🚀 智能数据助手（支持追问、多轮上下文）
================================================================================
💡 输入问题开始对话，输入 <span class="hljs-symbol">'exit</span>' 退出。
================================================================================

👤 你: <span class="hljs-number">2016</span>年考生人数有多少？
=== 🟦 Template Agent ===
⚠️ 不存在上下文，进入SQL Agent流程
=== 🟦 Sql Agent ===
🆕 启动完整查询流程
调用大模型llama2向量化：<span class="hljs-number">2016</span>年考生人数有多少？
📚 匹配表结构: ['{<span class="hljs-string">"表名"</span>: <span class="hljs-string">"college_entrance_examination"</span>, <span class="hljs-string">"表备注"</span>: <span class="hljs-string">"考生人数与复读人数信息表，包含字段：高考年份(主键)、考生人数(万人)、复读人数(万人)"</span>, <span class="hljs-string">"字段列表"</span>: [{<span class="hljs-string">"字段名"</span>: <span class="hljs-string">"examination_year"</span>, <span class="hljs-string">"字段类型"</span>: <span class="hljs-string">"int"</span>, <span class="hljs-string">"字段备注"</span>: <span class="hljs-string">"高考年份"</span>}, {<span class="hljs-string">"字段名"</span>: <span class="hljs-string">"candidates_count"</span>, <span class="hljs-string">"字段类型"</span>: <span class="hljs-string">"decimal(10,2)"</span>, <span class="hljs-string">"字段备注"</span>: <span class="hljs-string">"考生人数(万人)"</span>}, {<span class="hljs-string">"字段名"</span>: <span class="hljs-string">"retake_count"</span>, <span class="hljs-string">"字段类型"</span>: <span class="hljs-string">"decimal(10,2)"</span>, <span class="hljs-string">"字段备注"</span>: <span class="hljs-string">"复读人数(万人)"</span>}]}']
🧠 原始意图: <span class="hljs-number">2016</span>年考生人数有多少？
📦 保存 SQL 模板: SELECT candidates_count AS '考生人数' FROM college_entrance_examination WHERE examination_year = {year};
=== 🟩 Analysis Agent ===
💬 助手: **<span class="hljs-number">2016</span>年高考考生人数分析报告**  

**事实陈述**  
<span class="hljs-number">2016</span>年高考考生人数为 **<span class="hljs-number">940.00</span>万人**（数据来源：考生人数与复读人数信息表）。

**简要洞察**  
当前数据仅包含单一时间点的记录，暂无法直接推导趋势变化。若需分析考生人数增减规律，建议结合相邻年份数据（如<span class="hljs-number">2015</span>年及<span class="hljs-number">2017</span>年）进行对比。

**备注**  
数据单位为“万人”，数值保留两位小数，统计口径可能包含应届生与复读生。如需进一步解读，可补充复读人数或分省数据辅助分析。

---  
（报告基于提供的数据生成，内容简洁客观，避免过度推测。）
------------------------------------------------------------

👤 你: <span class="hljs-number">2018</span>年呢？
=== 🟦 Template Agent ===
🔄 检测到历史上下文，尝试参数化追问
🔍 提取参数: {<span class="hljs-string">"year"</span>: <span class="hljs-string">"2018"</span>}
🛠️ 生成新 SQL: SELECT candidates_count AS '考生人数' FROM college_entrance_examination WHERE examination_year = <span class="hljs-number">2018</span>;
✅ 追问查询成功，返回 <span class="hljs-number">1</span> 行
=== 🟩 Analysis Agent ===
💬 助手: **<span class="hljs-number">2016</span>年高考考生人数分析报告**  

**事实陈述**  
<span class="hljs-number">2016</span>年高考考生人数为 **<span class="hljs-number">975.0</span>万人**（数据来源：考生人数与复读人数信息表）。

**简要洞察**  
<span class="hljs-number">1</span>. 当前数据仅包含单一时间点的记录，暂无法分析趋势变化。若需观察考生人数增减趋势，建议补充相邻年份数据（如<span class="hljs-number">2015</span>年及<span class="hljs-number">2017</span>年数据）。  
<span class="hljs-number">2</span>. 表中还包含“复读人数”字段，若需进一步分析复读对考生总数的影响，可提供对应数据后补充说明。

**备注**  
数据单位为“万人”，实际考生人数为<span class="hljs-number">9</span>,<span class="hljs-number">750</span>,<span class="hljs-number">000</span>人。如需更深入的统计分析（如增长率、区域对比等），请提供扩展数据集。

---  
**报告说明**：本报告基于提供的数据直接呈现核心结论，避免对单一数据点进行推测性解读。
------------------------------------------------------------

👤 你: 录取人数呢？
=== 🟦 Template Agent ===
🔄 检测到历史上下文，尝试参数化追问
🔍 提取参数: {}
⚠️ 年份参数提取失败，进入改写流程
=== 🟨 Rewrite Agent ===
✍️ 改写后问题: <span class="hljs-number">2018</span>年全国高考录取人数是多少？
=== 🟦 Sql Agent ===
🆕 启动完整查询流程
调用大模型llama2向量化：<span class="hljs-number">2018</span>年全国高考录取人数是多少？
📚 匹配表结构: ['{<span class="hljs-string">"表名"</span>: <span class="hljs-string">"college_entrance_admission"</span>, <span class="hljs-string">"表备注"</span>: <span class="hljs-string">"录取人数与普通高校数信息表，包含字段：录取年份(主键)、录取人数(万人)、招生高校数、本科录取人数(万人)、专科录取人数(万人)"</span>, <span class="hljs-string">"字段列表"</span>: [{<span class="hljs-string">"字段名"</span>: <span class="hljs-string">"admission_year"</span>, <span class="hljs-string">"字段类型"</span>: <span class="hljs-string">"int"</span>, <span class="hljs-string">"字段备注"</span>: <span class="hljs-string">"录取年份"</span>}, {<span class="hljs-string">"字段名"</span>: <span class="hljs-string">"admission_count"</span>, <span class="hljs-string">"字段类型"</span>: <span class="hljs-string">"decimal(10,2)"</span>, <span class="hljs-string">"字段备注"</span>: <span class="hljs-string">"录取人数(万人)"</span>}, {<span class="hljs-string">"字段名"</span>: <span class="hljs-string">"university_count"</span>, <span class="hljs-string">"字段类型"</span>: <span class="hljs-string">"int"</span>, <span class="hljs-string">"字段备注"</span>: <span class="hljs-string">"招生高校数"</span>}, {<span class="hljs-string">"字段名"</span>: <span class="hljs-string">"undergraduate_admission_count"</span>, <span class="hljs-string">"字段类型"</span>: <span class="hljs-string">"decimal(10,2)"</span>, <span class="hljs-string">"字段备注"</span>: <span class="hljs-string">"本科录取人数(万人)"</span>}, {<span class="hljs-string">"字段名"</span>: <span class="hljs-string">"specialty_admission_count"</span>, <span class="hljs-string">"字段类型"</span>: <span class="hljs-string">"decimal(10,2)"</span>, <span class="hljs-string">"字段备注"</span>: <span class="hljs-string">"专科录取人数(万人)"</span>}]}']
🧠 原始意图: <span class="hljs-number">2018</span>年全国高考录取人数是多少？
📦 保存 SQL 模板: SELECT admission_count AS '考生人数' FROM college_entrance_admission WHERE admission_year = {year};
=== 🟩 Analysis Agent ===
💬 助手: **<span class="hljs-number">2018</span>年全国高考录取人数分析报告**  

**事实陈述**  
根据数据表 `college_entrance_admission` 记录，**<span class="hljs-number">2018</span>年全国高考录取人数为 <span class="hljs-number">790.99</span> 万人**。

**简要洞察**  
<span class="hljs-number">1</span>. **数据背景**：该数据反映当年普通高校（含本科及专科）录取总规模，但未提供与考生人数、录取率的对比信息。  
<span class="hljs-number">2</span>. **趋势参考**：若结合近年数据（需补充），可进一步分析录取人数变化趋势；当前单一数据点建议谨慎用于预测。  
<span class="hljs-number">3</span>. **结构细化**：表中包含本科与专科分层数据字段（未在本次结果中体现），后续可针对学历层次结构进行深入分析。

**注意事项**  
- 当前数据为单一数值，分析需避免过度推论。  
- 如需评估录取竞争程度，需补充同年高考报名人数或招生计划数据。

---  
**报告说明**：本分析基于提供的数据表结构及查询结果，确保表述与原始数据一致。
------------------------------------------------------------

👤 你: 
</code></pre>
<p>第一轮问题：2016年考生人数有多少？</p>
<p>第一轮没有上下文，也没有全局变量模板，所以直接走SQL Agent + Analysis AgentRAG检索、生成SQL、查数、分析。同时SQL Agent生成成功后记录SQL模板到全局state。</p>
<p>第二轮问题：2018年呢？</p>
<p>第二轮我们追问2018年，这时存在全局变量模板，所以走模板匹配提取年份参数，直接查数然后通过业务判断存在数据，走Analysis Agent分析。</p>
<p>第三轮问题：录取人数呢？</p>
<p>第三轮我们追问录取人数，但是匹配不到模板，所以上层业务判断走Rewrite Agent + SQL Agent + Analysis Agent改写问题完善条件。改写时，参考Memory中上下文2016和2018年回答，改写为2018年全国高考录取人数是多少？然后走RAG检索、生成SQL、查数、分析。</p>
<h3 data-id="heading-3"><strong>🧩 LangGraph实现小结</strong></h3>
<p>本文使用LangGraph的Custom图模式实现我们的多智能体协作处理业务：</p>
<ul>
<li>通过StataGraph状态图来管理Node节点（对应智能体Agent）+edge边（对应执行路径）；</li>
<li>通过Checkpoint Memory实现长时记忆，管理上下文和结构化参数（消息、SQL 模板、表结构、查询结果等），所有agent都要遵循一定规范，将状态机作为输入和输出。</li>
<li>相对来说，上一篇文章中介绍AgentScope框架更松散，其多Agent协作机制是通过自定义控制逻辑+管道pipeline来串联，通过框架提供的memory只能管理多轮对话的上下文，多智能体多轮次之间的参数传递，需要通过自定义全局变量来实现。</li>
<li/>
</ul>
<h3 data-id="heading-4"><strong>附录：LangGraph几种典型协作模式</strong></h3>
<p>LangGraph 是基于LangChain生态构建，它强调「状态图（StateGraph）」和「可追溯记忆（Checkpoint Memory）」，它提出了几种Multi-Agent模式，适用于不同的调用逻辑和控制流需求：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f53c2c4e854465f81f4a6811a0e3e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5piG5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768266843&amp;x-signature=HfB6%2BekD0f5QzPlS8FtuDeKFT7c%3D" alt="image.png" loading="lazy"/></p>
<p>网络（Network）模式</p>
<ul>
<li>各Agent节点彼此多对多通信：每个Agent有权限决定接下来调用哪个其他Agent。</li>
<li>适用于“没有固定顺序”“较灵活的调用关系”的场景。</li>
<li>代码示例中，Agent agent_1、agent_2、agent_3 均可跳转至其他两个或结束。</li>
</ul>
<p>主管（Supervisor）模式</p>
<ul>
<li>一个“主管Agent”负责决定下一步调用哪个子Agent。子Agent执行后再回到主管。</li>
<li>适用于“中央调度控制”“明确谁来决定流程”的场景。</li>
<li>示例：supervisor 决定调用 agent_1 或 agent_2。</li>
</ul>
<p>主管（Supervisor as Tools 工具调用）模式</p>
<ul>
<li>是“主管”模式的一个特例：子Agent被暴露为“工具”（tool），主管Agent像工具调用系统一样，决定调用哪个工具／子Agent。</li>
<li>典型流程：主管以 ReAct （思考→行动→思考）方式循环调用工具直到决策结束。</li>
<li>提供了 create_react_agent 等预置组件。</li>
</ul>
<p>分层（Hierarchical）模式</p>
<ul>
<li>当Agent数量增多、流程更复杂时，用“主管的主管”来管理团队／子系统，形成层级结构。</li>
<li>每个团队内有自己的主管+子Agent，再由顶层主管决定调用哪个团队。</li>
<li>适合更大规模、跨领域、多团队协作的系统。</li>
</ul>
<p>自定义（Custom Workflow）模式（对应本文案例）</p>
<ul>
<li>你也可以手动定义Agent节点及其顺序（显式控制流）或部分由 LLM 决定（动态控制流）。</li>
<li>显式控制流：在图中预先定义边 agent_1 → agent_2 → agent_3。</li>
<li>适合需要「强控制流」「复杂状态管理」「上下文复用」的场景。</li>
</ul>
<p>源码参考：参与协作的四个智能体，以及具体协作控制逻辑代码，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMuKunZiAI%2Fcollege_entrance_ai%2Fblob%2Fmain%2Flangchain_code%2Fagent_service_graph.py%25E3%2580%2582" target="_blank" title="https://github.com/MuKunZiAI/college_entrance_ai/blob/main/langchain_code/agent_service_graph.py%E3%80%82" ref="nofollow noopener noreferrer">github.com/MuKunZiAI/c…</a></p>
<p>本文总结：本文针对高考信息智能查询的业务场景，采用LangGraph框架验证多智能体协作机制，通过状态图StataGraph来管理节点+条件边组成协作执行路径，通过Checkpoint Memory来管理多轮对话上下文和跨智能体结构化参数传递，最后分享了LangGraph官网的几种典型协作模式</p>
<p>本文作者：Chaiys</p>
<p>本文原载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0pfVEeESi-UBYhHqmSNZaQ" target="_blank" title="https://mp.weixin.qq.com/s/0pfVEeESi-UBYhHqmSNZaQ" ref="nofollow noopener noreferrer">公众号“木昆子记录AI”</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agents 的 Skills 文件详解]]></title>    <link>https://juejin.cn/post/7591744411739242496</link>    <guid>https://juejin.cn/post/7591744411739242496</guid>    <pubDate>2026-01-06T01:45:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591744411739242496" data-draft-id="7591655106723921920" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agents 的 Skills 文件详解"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-06T01:45:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明月_清风"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170131006"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agents 的 Skills 文件详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170131006/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明月_清风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:45:47.000Z" title="Tue Jan 06 2026 01:45:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在2026年的AI代理（AI Agents）生态中，特别是多代理系统（Multi-Agent Systems）和主流框架如Claude、Codex、VS Code Copilot等，“skills 文件”已成为定义代理专长能力的核心方式。它是一种标准化、可复用、可共享的配置文件，帮助AI代理从通用模型转变为专精专家，而无需重新训练模型。</p>
<h4 data-id="heading-0">什么是 Skills 文件？</h4>
<p>Skills 文件本质上是<strong>SKILL.md</strong>（一个Markdown文件），位于一个专用文件夹中。它遵循开放标准（Agent Skills Specification，由Anthropic、OpenAI等推动），包含：</p>
<ul>
<li><strong>YAML Frontmatter</strong>：元数据，用于代理快速发现和选择技能。</li>
<li><strong>Markdown 正文</strong>：详细指令、指南、示例、边缘案例等，告诉代理“如何执行这项技能”。</li>
</ul>
<p>这种设计实现了“渐进式披露”（Progressive Disclosure）：代理启动时只加载技能的名称和描述（节省token），只有决定使用时才加载完整内容。</p>
<p>与其他框架对比：</p>
<ul>
<li><strong>CrewAI</strong>：使用YAML文件（如agents.yaml）定义代理的role、goal、backstory和tools，但不是“skills”标准。</li>
<li><strong>LangChain</strong>：更多依赖工具（tools）和动态加载提示，但可模拟skills。</li>
<li><strong>AutoGPT/Swarm</strong>：无专用skills文件，靠配置或代码定义能力。</li>
</ul>
<p>主流采用的是<strong>SKILL.md</strong>格式，已成为跨平台标准（Claude Code、Cursor、GitHub Copilot等均支持）。</p>
<h4 data-id="heading-1">SKILL.md 文件的基本结构</h4>
<p>一个典型的SKILL.md 文件示例：</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: code-review-master
description: 专业代码审查技能，按照团队最佳实践审查Pull Request，确保代码质量、安全性和可维护性。
metadata:
  short-description: 团队标准代码审查专家
  compatibility: claude-4, codex-2026
<span class="hljs-section">  license: Apache-2.0
---</span>

<span class="hljs-section"># 代码审查大师</span>

你是一个资深的代码审查专家，遵循以下严格流程审查代码变更。

<span class="hljs-section">## 核心原则</span>
<span class="hljs-bullet">-</span> 优先检查安全性（注入、泄漏、权限）。
<span class="hljs-bullet">-</span> 确保代码可读性、一致性和性能。
<span class="hljs-bullet">-</span> 提供建设性反馈，建议具体改进。

<span class="hljs-section">## 逐步审查流程</span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**理解上下文**</span>：阅读PR描述、相关文件和变更历史。
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**检查结构**</span>：验证架构是否合理，是否有更好的设计模式。
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**代码质量**</span>：检查命名、注释、错误处理和测试覆盖。
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**安全与性能**</span>：扫描潜在漏洞和优化点。
<span class="hljs-bullet">5.</span> <span class="hljs-strong">**输出格式**</span>：用Markdown表格总结问题，按严重度分类（Critical / Major / Minor）。

<span class="hljs-section">## 示例输出</span>
| 严重度 | 文件 | 行号 | 问题描述 | 建议修复 |
|--------|------|------|----------|----------|
| Critical | app.py | 45 | SQL注入风险 | 使用参数化查询 |

<span class="hljs-section">## 常见边缘案例</span>
<span class="hljs-bullet">-</span> 处理大型变更：先概述整体影响，再细化。
<span class="hljs-bullet">-</span> 第三方库：检查版本兼容性和已知漏洞。

（可选：文件夹中可附带脚本、模板或参考文件，如review<span class="hljs-emphasis">_template.md）
</span></code></pre>
<h4 data-id="heading-2">如何使用 Skills 文件？</h4>
<ol>
<li><strong>创建文件夹</strong>：如 <code>.claude/skills/code-review/</code> 或 <code>~/.codex/skills/code-review/</code>。</li>
<li><strong>放置 SKILL.md</strong>：确保文件名精确为SKILL.md。</li>
<li><strong>启用</strong>：在代理配置中允许skills（多数框架默认支持）。</li>
<li><strong>调用</strong>：代理会自动根据任务描述选择并加载技能。例如，你对Claude说：“用团队标准审查这个PR”，它会激活对应skills。</li>
</ol>
<h4 data-id="heading-3">为什么2026年 Skills 文件如此重要？</h4>
<ul>
<li><strong>模块化</strong>：一个技能文件即可赋予代理新能力，可共享（如GitHub仓库）。</li>
<li><strong>高效</strong>：避免每次提示都重复长指令，节省计算资源。</li>
<li><strong>协作</strong>：多代理系统中，不同代理可加载不同skills，实现专业分工。</li>
<li><strong>开源生态</strong>：已有大量社区skills（如PDF处理、Excel分析、代码生成），可直接下载使用。</li>
</ul>
<p>通过Skills文件，你可以将AI代理从“万金油”变成“专才团队”。在2026年，掌握这种配置方式，将是构建高效多代理系统的关键技能！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[抖音思路复刻：iOS 卡死（ANR）监控 + 自动符号化全流程实战]]></title>    <link>https://juejin.cn/post/7591704324907057186</link>    <guid>https://juejin.cn/post/7591704324907057186</guid>    <pubDate>2026-01-05T16:17:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591704324907057186" data-draft-id="7591655106724872192" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="抖音思路复刻：iOS 卡死（ANR）监控 + 自动符号化全流程实战"/> <meta itemprop="keywords" content="iOS,性能优化"/> <meta itemprop="datePublished" content="2026-01-05T16:17:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Daniel02"/> <meta itemprop="url" content="https://juejin.cn/user/2277843825853511"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            抖音思路复刻：iOS 卡死（ANR）监控 + 自动符号化全流程实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843825853511/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Daniel02
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T16:17:01.000Z" title="Mon Jan 05 2026 16:17:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 上，App 在启动 / 退出 / 响应系统事件等关键阶段如果长时间卡住，超过系统阈值就会触发保护机制，最终被 Watchdog 以 <strong>SIGKILL</strong> 强制终止。这类异常的共同特点是：<strong>不是进程内异常抛出，而是“进程外指令”直接结束进程</strong>，因此传统基于 signal/exception 的崩溃捕获往往覆盖不到，也就导致它在生产环境中经常“只见数据、不见堆栈”，长期被忽视。</p>
<p>为了解决这个盲区，我选择站在巨人的肩膀上：本文实践并复现字节跳动团队的文章<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FcEfIZGtUojKKbhIfUyhTMw" target="_blank" title="https://mp.weixin.qq.com/s/cEfIZGtUojKKbhIfUyhTMw" ref="nofollow noopener noreferrer">《iOS 稳定性问题治理：卡死崩溃监控原理及最佳实践</a>》，从 <strong>原理 → 代码实现 → 候选文件保存 → dSYM/atos/脚本符号化 + Swift demangle</strong>，把一整套卡死（ANR/Watchdog）监控链路完整跑通，并沉淀成一个可复用 Demo。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03ce7844ae014fe6be0ef3b24f3cd4c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGFuaWVsMDI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768234621&amp;x-signature=OgE%2FBhd1Zay%2BShb9QHdXc015j6Y%3D" alt="" width="200" height="400" loading="lazy"/></p>
<blockquote>
<p>文末给出完整代码链接</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">1. 痛点：卡死最难的不是“知道卡”，而是“知道卡在哪”</h2>
<p>线上卡死/假死常见现象：</p>
<ul>
<li>UI 不响应（点击无反应、滑动卡住），几秒后恢复或被系统杀掉</li>
<li>Crash 日志没有（不是进程内 crash），只剩用户反馈：“刚刚卡住了”</li>
<li>拿到的堆栈是一堆 <code>0x00000001....</code> 地址：<strong>不符号化就等于没有结论</strong></li>
</ul>
<p>所以要解决这类问题，本质是两件事：</p>
<ol>
<li><strong>卡死当下抓到主线程堆栈</strong>（或卡死期间持续采样）</li>
<li><strong>自动符号化</strong>：把地址变成可读函数名，并尽可能 demangle Swift 符号</li>
</ol>
<hr/>
<h2 data-id="heading-1">2. 原理：RunLoop 心跳 + 超阈值采样 = 还原卡死现场</h2>
<h3 data-id="heading-2">2.1 监控“主线程卡死”的本质</h3>
<p>主线程 RunLoop 正常情况下会不断在这些状态间流转：</p>
<ul>
<li><code>BeforeTimers</code></li>
<li><code>BeforeSources</code></li>
<li><code>BeforeWaiting</code></li>
<li><code>AfterWaiting</code></li>
</ul>
<p>当主线程执行重任务（大解析 / 同步 IO / 复杂布局 / 锁等待等），RunLoop 会长期卡在某个阶段不动，表现为 UI 无响应。</p>
<h3 data-id="heading-3">2.2 本 Demo 的检测策略（尽量向“抖音方案”靠拢）</h3>
<p>Demo 采用的策略（参数对齐你当前实现）：</p>
<ul>
<li><strong>阈值：8 秒</strong>（<code>hangThreshold = 8</code>）</li>
<li><strong>检测周期：1 秒窗口</strong>（<code>tickInterval = 1</code>）</li>
<li><strong>超过阈值后：每秒采样一次主线程栈</strong>（从 Live Report 中提取 <code>Thread 0</code>）</li>
<li><strong>最多保留 10 帧样本</strong>（<code>maxMainThreadSamples = 10</code>，保留最近 10 次）</li>
</ul>
<blockquote>
<p>这套策略的意义是：<br/>
<strong>先判断“已经卡死到足够严重”</strong>（接近 Watchdog 风险），再进入“持续采样”，避免把轻微卡顿也当成卡死去抓栈/写文件。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">3. Demo 实现结构</h2>
<h3 data-id="heading-5">3.1 项目目录骨架</h3>
<pre><code class="hljs language-text" lang="text">LagMonitorDemo/
├── LagMonitorDemo.xcodeproj
├── Sources/
│   └── Monitor/
│      ├── HMDANRMonitor.swift
│      ├── HMDLiveReportCapture.swift
│      ├── HMDANRRecord.swift
│      ├── HMDANRCandidateStore.swift
│      └── HMDDebugCacheCleaner.swift
├── Scripts/
│   └── hmd_anr_symbolicate.py
└── Samples/
    ├── hmd_anr_candidate.json
    └── symbolicated.txt
</code></pre>
<hr/>
<h3 data-id="heading-6">3.2 Monitor：HMDANRMonitor.swift（核心监控器）</h3>
<h4 data-id="heading-7">3.2.1 监控目标</h4>
<ul>
<li>主线程装 <code>CFRunLoopObserver</code>，每次回调认为 RunLoop 推进：<code>heartbeat += 1</code></li>
<li>监控线程用 <strong>1 秒观察窗口</strong>检查 <code>heartbeat</code> 是否变化
<ul>
<li><strong>1 秒内有推进</strong>：健康/恢复，清理候选</li>
<li><strong>1 秒内无推进</strong>：认为卡住，<code>hangSeconds += 1</code></li>
</ul>
</li>
<li>卡住累计达到 <strong>8 秒阈值</strong>：创建 candidate</li>
<li>超阈值后仍未恢复：<strong>每秒采样一次主线程栈</strong>，最多 10 帧</li>
</ul>
<h4 data-id="heading-8">3.2.2 为什么看起来“没 sleep 1 秒”，却实现了“每秒检查一次”？</h4>
<p>核心就在这一句：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> wakeSemaphore.wait(timeout: .now() <span class="hljs-operator">+</span> .seconds(config.tickInterval))
</code></pre>
<p>它等价于：</p>
<ul>
<li><strong>最多等待 1 秒</strong>（<code>tickInterval = 1</code>）作为一个观察窗口</li>
<li>如果期间 RunLoop 有推进，observer 会 <code>signal()</code> → 监控线程会<strong>提前醒来</strong></li>
<li>窗口结束后比较 <code>heartbeat</code>：若 1 秒内完全没变，才算这一秒“卡住”</li>
</ul>
<p>所以这里不是“固定每秒到点触发一次”，而是：</p>
<blockquote>
<p><strong>“最多等 1 秒，但只要 RunLoop 一推进就立刻醒来重置状态”</strong><br/>
这比 Timer 的“固定周期触发”更贴合我们想观察的对象（RunLoop 推进）。</p>
</blockquote>
<h4 data-id="heading-9">3.2.3 为什么不用 NSTimer / GCD 定时器，而用信号量？</h4>
<p><strong>Timer 触发本身就依赖调度与 RunLoop/线程状态，卡死时最容易抖动或延迟；信号量 + 超时是更稳定的“观察窗口”，还能被 RunLoop 推进即时唤醒。</strong></p>
<hr/>
<h3 data-id="heading-10">3.3 抓栈：HMDLiveReportCapture.swift（PLCrashReporter Live Report）</h3>
<p>抓栈使用 <code>PLCrashReporter</code> 的 Live Report 能力：</p>
<ul>
<li><code>generateLiveReportAndReturnError()</code>：生成“当下全线程现场”</li>
<li>再从文本中提取 <code>Thread 0</code> 作为主线程样本</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> CrashReporter

<span class="hljs-comment">/// 抓一次“全线程现场报告”</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">captureAllThreadsText</span>() -&gt; <span class="hljs-type">String</span>? {
    <span class="hljs-keyword">let</span> config <span class="hljs-operator">=</span> <span class="hljs-type">PLCrashReporterConfig</span>(signalHandlerType: .<span class="hljs-type">BSD</span>, symbolicationStrategy: .all)
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> reporter <span class="hljs-operator">=</span> <span class="hljs-type">PLCrashReporter</span>(configuration: config) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }

    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> reporter.generateLiveReportAndReturnError()
        <span class="hljs-keyword">let</span> report <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-type">PLCrashReport</span>(data: data)
        <span class="hljs-keyword">return</span> <span class="hljs-type">PLCrashReportTextFormatter</span>.stringValue(for: report, with: <span class="hljs-type">PLCrashReportTextFormatiOS</span>)
    } <span class="hljs-keyword">catch</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"[HMDLiveReportCapture] parse report error: <span class="hljs-subst">\(error)</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
}
</code></pre>
<blockquote>
<p>这里的思路就是：<br/>
<strong>卡死现场抓“全线程”，用于兜底；超阈值后持续采“主线程”，用于定位稳定卡点。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-11">3.4 保存：HMDANRCandidateStore.swift（hmd_anr_candidate.json）</h3>
<p>Demo 保存的核心数据结构是 <code>HMDANRRecord</code>，通过 <code>Codable</code> 编码为 JSON：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">HMDANRRecord</span>: <span class="hljs-title class_">Codable</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">let</span> recordID: <span class="hljs-type">String</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">let</span> timestamp: <span class="hljs-type">Date</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> hangSeconds: <span class="hljs-type">Int</span>

    <span class="hljs-comment">/// 超过阈值那一刻：全线程现场（PLCrash live report，文本）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> allThreadsReportText: <span class="hljs-type">String</span>?

    <span class="hljs-comment">/// 超阈值后：每秒采样主线程调用栈（最多保留最近 N 条）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">var</span> mainThreadSamples: [<span class="hljs-type">String</span>]
}
</code></pre>
<p>保存到 <code>Caches/hmd_anr_candidate.json</code> 后，大致字段长这样：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"recordID"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"E2D0...-...."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2026-01-05T12:34:56Z"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hangSeconds"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"allThreadsReportText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"PLCrashReporter live report text ..."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mainThreadSamples"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"Thread 0 ...\n0 LagMonitorDemo 0x...\n1 UIKitCore ..."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"Thread 0 ...\n0 LagMonitorDemo 0x...\n1 UIKitCore ..."</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p><strong><code>HMDANRCandidateStore</code>卡住时把记录保存到缓存文件；一旦主线程恢复推进就立刻删除；如果进程被系统强杀来不及上报，这个文件会留到下次启动再读取导出/符号化。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-12">4. 复现场景（Demo 内置）</h2>
<p>Demo 里包含几种典型卡死触发方式：</p>
<pre><code class="hljs language-swift" lang="swift">stack.addArrangedSubview(makeButton(<span class="hljs-string">"主线程 Busy 2s（轻微卡顿）"</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.busy(seconds: <span class="hljs-number">2</span>) })
stack.addArrangedSubview(makeButton(<span class="hljs-string">"主线程 Busy 20s（触发 candidate + 采样）"</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.busy(seconds: <span class="hljs-number">20</span>) })
stack.addArrangedSubview(makeButton(<span class="hljs-string">"锁竞争：子线程持锁 12s → 主线程尝试加锁"</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.lockContention() })
stack.addArrangedSubview(makeButton(<span class="hljs-string">"死锁：串行队列 sync + 主队列 sync（必卡死）"</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.deadlock() })
</code></pre>
<hr/>
<h2 data-id="heading-13">5. 自动符号化：从 hmd_anr_candidate.json 到“可读堆栈”</h2>
<p>我点击 <strong>“主线程 Busy 20s（触发 candidate + 采样）”</strong>，在第 10 秒手动杀掉 App，然后导出沙盒里的 <code>hmd_anr_candidate.json</code>。</p>
<p>你会看到类似信息：</p>
<ul>
<li><code>hangSeconds = 13</code>（很明确的主线程长时间阻塞）</li>
<li><code>mainThreadSamples</code> 有多次采样（证明卡住期间栈稳定）</li>
<li>但这些堆栈仍然是地址/偏移，无法直接定位业务代码</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c1957fa51734700b434f101e01aaef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGFuaWVsMDI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768234621&amp;x-signature=3gdvXM0dJ9yXommktWmHfoLS1C0%3D" alt="1.jpg" loading="lazy"/></p>
<p>因此需要做：</p>
<ul>
<li>从 <code>hmd_anr_candidate.json</code> 里解析 frame</li>
<li>用 <strong>dSYM + atos</strong> 还原符号；并对 <strong>Swift 符号 demangle</strong>（<code>$s... → Foundation.Date.init()</code>）</li>
</ul>
<p>本项目用脚本 <code>hmd_anr_symbolicate.py</code> 自动完成批量符号化：</p>
<pre><code class="hljs language-bash" lang="bash">python3 hmd_anr_symbolicate.py   --record hmd_anr_candidate.json   --app-dsym LagMonitorDemo.app.dSYM   --<span class="hljs-built_in">arch</span> arm64   --demangle   --out symbolicated.txt
</code></pre>
<p>符号化后的<code>symbolicated.txt</code>的大致内容如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac5db4a813f14d99827aed0b39f65fbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGFuaWVsMDI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768234621&amp;x-signature=t3nd8wnNgtuAUgumuuOmlykJBOQ%3D" alt="2.jpg" loading="lazy"/></p>
<blockquote>
<p><code>hmd_anr_symbolicate.py</code>在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwutao23yzd%2FuikitCombine" target="_blank" title="https://github.com/wutao23yzd/uikitCombine" ref="nofollow noopener noreferrer">GITHUB</a>项目的Scripts文件夹下，<code>hmd_anr_candidate.json</code>和<code>symbolicated.txt</code>在Samples文件下</p>
</blockquote>
<h3 data-id="heading-14">5.1 符号化后如何“从栈定位问题”？</h3>
<p>从 <code>symbolicated.txt</code> 里抽 <code>mainThreadSamples[0]</code> 的关键几帧（你这次 5 次采样基本一致）：</p>
<pre><code class="hljs language-text" lang="text">1   libsystem_c.dylib          gettimeofday
3   Foundation                 Date.init
4   LagMonitorDemo.debug.dylib ... (ViewController.swift:52)
5   LagMonitorDemo.debug.dylib ... (ViewController.swift:33)
6   LagMonitorDemo.debug.dylib ... (ViewController.swift:44)
7   UIKitCore                  ...
</code></pre>
<p>这说明卡死期间主线程一直在跑 <code>ViewController.swift</code> 的某段逻辑，并且频繁调用 <code>Date()</code>（最终落到 <code>gettimeofday/clock_gettime</code>），典型特征就是<strong>忙等/死循环式等待</strong>。</p>
<p>对应 Demo 中的实现：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">busy</span>(<span class="hljs-params">seconds</span>: <span class="hljs-type">Int</span>) {
    <span class="hljs-keyword">let</span> end <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>().addingTimeInterval(<span class="hljs-type">TimeInterval</span>(seconds))
    <span class="hljs-keyword">while</span> <span class="hljs-type">Date</span>() <span class="hljs-operator">&lt;</span> end {
        <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
    }
}
</code></pre>
<blockquote>
<p>这类栈顶常见现象就是：看起来“卡在 Date()”，其实根因是 <strong>while 循环让主线程一直跑</strong>。<br/>
采样刚好截在 <code>Date()</code> 这一行，于是栈顶表现为 <code>Date.init -&gt; gettimeofday</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">6. 结语：复刻的意义，是把“文章里的方案”变成“项目里能用的工具”</h2>
<p>大厂的稳定性方案往往更深、更体系化，但很多时候只停留在文章层面：看懂了思路，却很难在项目里直接落地。本文的目标就是把它“拆开 + 跑通”：</p>
<ul>
<li><strong>把抖音文章里的链路拆成可运行代码</strong>（监控、采样、保存、恢复、导出）</li>
<li><strong>把最后一公里补齐</strong>（dSYM/atos 自动符号化 + Swift demangle）</li>
<li>让“卡死问题”从 <strong>只有 SIGKILL 数字</strong>，变成 <strong>能指向具体业务函数/代码行</strong> 的结论</li>
</ul>
<p>你真正需要的不是“我们检测到了卡死”，而是：</p>
<blockquote>
<p><strong>卡死那 8～20 秒内，主线程到底在跑什么？它卡在谁身上？</strong></p>
</blockquote>
<p>当你把“采样 + 保存 + 下次启动捞取 + 自动符号化 + demangle”这条链路跑通，线上卡死排查效率会明显提升。</p>
<hr/>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwutao23yzd%2FuikitCombine" target="_blank" title="https://github.com/wutao23yzd/uikitCombine" ref="nofollow noopener noreferrer">GITHUB源码</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python异步编程：asyncio与async/await深度解析]]></title>    <link>https://juejin.cn/post/7591719013489426470</link>    <guid>https://juejin.cn/post/7591719013489426470</guid>    <pubDate>2026-01-06T00:25:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591719013489426470" data-draft-id="7591713442400239625" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Python异步编程：asyncio与async/await深度解析"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-06T00:25:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Python异步编程：asyncio与async/await深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:25:38.000Z" title="Tue Jan 06 2026 00:25:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、协程：异步编程的基础单元</h2>
<h3 data-id="heading-1">理解协程对象</h3>
<p>协程是可暂停和恢复的函数，使用<code>async def</code>定义：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Coroutine</span>

<span class="hljs-comment"># 基础协程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_coroutine</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, delay: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""一个简单的协程"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 开始执行，等待 <span class="hljs-subst">{delay}</span> 秒"</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(delay)  <span class="hljs-comment"># 非阻塞等待</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 执行完成"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-结果"</span>

<span class="hljs-comment"># 协程的三种状态</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">coroutine_lifecycle</span>():
    <span class="hljs-string">"""演示协程的生命周期"""</span>
    coro = simple_coroutine(<span class="hljs-string">"测试"</span>, <span class="hljs-number">1.0</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"协程类型: <span class="hljs-subst">{<span class="hljs-built_in">type</span>(coro)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"是协程对象: <span class="hljs-subst">{asyncio.iscoroutine(coro)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"是协程函数: <span class="hljs-subst">{asyncio.iscoroutinefunction(simple_coroutine)}</span>"</span>)
    
    <span class="hljs-comment"># 协程的状态</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"初始状态: <span class="hljs-subst">{coro.cr_running}</span>"</span>)  <span class="hljs-comment"># False，尚未运行</span>
    
    <span class="hljs-comment"># 运行协程</span>
    task = asyncio.create_task(coro)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"创建任务后: <span class="hljs-subst">{task._state}</span>"</span>)  <span class="hljs-comment"># 'PENDING'</span>
    
    <span class="hljs-keyword">await</span> task
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"完成后: <span class="hljs-subst">{task._state}</span>"</span>)  <span class="hljs-comment"># 'FINISHED'</span>

<span class="hljs-comment"># 手动控制协程执行</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">manual_coroutine_control</span>():
    <span class="hljs-string">"""手动控制协程执行（不推荐在生产中使用）"""</span>
    coro = simple_coroutine(<span class="hljs-string">"手动控制"</span>, <span class="hljs-number">0.5</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 手动推进协程</span>
        coro.send(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 或 next(coro)，启动协程</span>
    <span class="hljs-keyword">except</span> StopIteration <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"协程返回值: <span class="hljs-subst">{e.value}</span>"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"协程异常: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 运行</span>
asyncio.run(coroutine_lifecycle())
</code></pre>
<h2 data-id="heading-2">二、任务：并发执行的管理器</h2>
<h3 data-id="heading-3">任务的创建与取消</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> Task, CancelledError
<span class="hljs-keyword">import</span> signal

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">cancellable_task</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, duration: <span class="hljs-built_in">float</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""可取消的任务"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 开始长时间运行"</span>)
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">int</span>(duration * <span class="hljs-number">10</span>)):
            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 进度 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>/10"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 完成"</span>
    <span class="hljs-keyword">except</span> CancelledError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 被取消"</span>)
        <span class="hljs-keyword">raise</span>  <span class="hljs-comment"># 重新抛出以便调用者知道</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 清理资源"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">task_management</span>():
    <span class="hljs-string">"""任务管理示例"""</span>
    <span class="hljs-comment"># 创建多个任务</span>
    task1 = asyncio.create_task(cancellable_task(<span class="hljs-string">"任务1"</span>, <span class="hljs-number">2.0</span>))
    task2 = asyncio.create_task(cancellable_task(<span class="hljs-string">"任务2"</span>, <span class="hljs-number">3.0</span>))
    task3 = asyncio.create_task(cancellable_task(<span class="hljs-string">"任务3"</span>, <span class="hljs-number">1.0</span>))
    
    <span class="hljs-comment"># 等待一段时间后取消任务2</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1.5</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> task2.done():
        task2.cancel()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"已取消任务2"</span>)
    
    <span class="hljs-comment"># 收集结果</span>
    done, pending = <span class="hljs-keyword">await</span> asyncio.wait(
        [task1, task2, task3],
        timeout=<span class="hljs-number">2.0</span>,
        return_when=asyncio.FIRST_COMPLETED
    )
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"完成的任务数: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(done)}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"挂起的任务数: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(pending)}</span>"</span>)
    
    <span class="hljs-comment"># 处理结果</span>
    <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> done:
        <span class="hljs-keyword">if</span> task.exception():
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务异常: <span class="hljs-subst">{task.exception()}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务结果: <span class="hljs-subst">{task.result()}</span>"</span>)
    
    <span class="hljs-comment"># 取消剩余任务</span>
    <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> pending:
        task.cancel()

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">timeout_handling</span>():
    <span class="hljs-string">"""超时处理"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">slow_operation</span>():
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">5</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"慢操作完成"</span>
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 方式1：asyncio.wait_for</span>
        result = <span class="hljs-keyword">await</span> asyncio.wait_for(slow_operation(), timeout=<span class="hljs-number">2.0</span>)
        <span class="hljs-built_in">print</span>(result)
    <span class="hljs-keyword">except</span> asyncio.TimeoutError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"操作超时"</span>)
    
    <span class="hljs-comment"># 方式2：asyncio.shield（防止取消）</span>
    task = asyncio.create_task(slow_operation())
    <span class="hljs-keyword">try</span>:
        result = <span class="hljs-keyword">await</span> asyncio.wait_for(asyncio.shield(task), timeout=<span class="hljs-number">2.0</span>)
    <span class="hljs-keyword">except</span> asyncio.TimeoutError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"等待超时，但后台任务继续运行"</span>)
        <span class="hljs-comment"># 检查后台任务状态</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">3</span>)
        <span class="hljs-keyword">if</span> task.done():
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"后台任务最终结果: <span class="hljs-subst">{task.result()}</span>"</span>)

<span class="hljs-comment"># 运行</span>
asyncio.run(timeout_handling())
</code></pre>
<h2 data-id="heading-4">三、异步上下文管理器与迭代器</h2>
<h3 data-id="heading-5"><code>async with</code>和<code>async for</code></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> AsyncIterator, <span class="hljs-type">List</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncConnectionPool</span>:
    <span class="hljs-string">"""异步连接池"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, pool_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>):
        self.pool_size = pool_size
        self._connections: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = []
        self._semaphore = asyncio.Semaphore(pool_size)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__aenter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"初始化连接池"</span>)
        <span class="hljs-comment"># 模拟建立连接</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.pool_size):
            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)
            self._connections.append(<span class="hljs-string">f"连接-<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>"</span>)
        <span class="hljs-keyword">return</span> self
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__aexit__</span>(<span class="hljs-params">self, exc_type, exc_val, exc_tb</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"清理连接池"</span>)
        <span class="hljs-comment"># 模拟关闭连接</span>
        <span class="hljs-keyword">for</span> conn <span class="hljs-keyword">in</span> self._connections:
            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.05</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"关闭 <span class="hljs-subst">{conn}</span>"</span>)
        self._connections.clear()
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">acquire</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""获取连接"""</span>
        <span class="hljs-keyword">await</span> self._semaphore.acquire()
        conn = self._connections.pop()
        <span class="hljs-keyword">return</span> conn
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">release</span>(<span class="hljs-params">self, conn: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""释放连接"""</span>
        self._connections.append(conn)
        self._semaphore.release()
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""执行查询"""</span>
        conn = <span class="hljs-keyword">await</span> self.acquire()
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.5</span>)  <span class="hljs-comment"># 模拟查询</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{conn}</span>: 执行 '<span class="hljs-subst">{query}</span>' 的结果"</span>
        <span class="hljs-keyword">finally</span>:
            self.release(conn)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncDataStream</span>:
    <span class="hljs-string">"""异步数据流"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, data: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], delay: <span class="hljs-built_in">float</span> = <span class="hljs-number">0.1</span></span>):
        self.data = data
        self.delay = delay
        self.index = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__aiter__</span>(<span class="hljs-params">self</span>) -&gt; AsyncIterator[<span class="hljs-built_in">str</span>]:
        <span class="hljs-keyword">return</span> self
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__anext__</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">if</span> self.index &gt;= <span class="hljs-built_in">len</span>(self.data):
            <span class="hljs-keyword">raise</span> StopAsyncIteration
        
        item = self.data[self.index]
        self.index += <span class="hljs-number">1</span>
        
        <span class="hljs-comment"># 模拟异步获取数据</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(self.delay)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"处理: <span class="hljs-subst">{item}</span>"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">async_context_example</span>():
    <span class="hljs-string">"""异步上下文管理器示例"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncConnectionPool(<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> pool:
        tasks = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
            query = <span class="hljs-string">f"SELECT * FROM table<span class="hljs-subst">{i}</span>"</span>
            task = asyncio.create_task(pool.execute_query(query))
            tasks.append(task)
        
        results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="hljs-literal">True</span>)
        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, Exception):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询失败: <span class="hljs-subst">{result}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(result)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">async_iter_example</span>():
    <span class="hljs-string">"""异步迭代器示例"""</span>
    data = [<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>]
    stream = AsyncDataStream(data, delay=<span class="hljs-number">0.2</span>)
    
    <span class="hljs-comment"># 方式1：直接使用async for</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> stream:
        <span class="hljs-built_in">print</span>(item)
    
    <span class="hljs-comment"># 方式2：使用anext()</span>
    stream2 = AsyncDataStream(data)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            item = <span class="hljs-keyword">await</span> anext(stream2)  <span class="hljs-comment"># Python 3.10+</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"手动获取: <span class="hljs-subst">{item}</span>"</span>)
    <span class="hljs-keyword">except</span> StopAsyncIteration:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"迭代结束"</span>)
    
    <span class="hljs-comment"># 方式3：异步推导式</span>
    stream3 = AsyncDataStream(data)
    processed = [item <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> stream3]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"异步推导式结果: <span class="hljs-subst">{processed}</span>"</span>)

<span class="hljs-comment"># 运行</span>
asyncio.run(async_iter_example())
</code></pre>
<h2 data-id="heading-6">四、信号量与高级并发控制</h2>
<h3 data-id="heading-7">限制并发数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> asyncio <span class="hljs-keyword">import</span> Semaphore, BoundedSemaphore, Lock, Event, Condition
<span class="hljs-keyword">import</span> random

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">semaphore: Semaphore, name: <span class="hljs-built_in">str</span>, work_time: <span class="hljs-built_in">float</span></span>):
    <span class="hljs-string">"""使用信号量控制的工作器"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> semaphore:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 获取信号量，开始工作"</span>)
        <span class="hljs-keyword">await</span> asyncio.sleep(work_time)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: 完成工作，释放信号量"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-完成"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">semaphore_example</span>():
    <span class="hljs-string">"""信号量示例：限制最多3个并发任务"""</span>
    semaphore = Semaphore(<span class="hljs-number">3</span>)
    
    tasks = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
        work_time = random.uniform(<span class="hljs-number">0.5</span>, <span class="hljs-number">2.0</span>)
        task = asyncio.create_task(worker(semaphore, <span class="hljs-string">f"Worker-<span class="hljs-subst">{i}</span>"</span>, work_time))
        tasks.append(task)
    
    <span class="hljs-keyword">await</span> asyncio.gather(*tasks)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncRateLimiter</span>:
    <span class="hljs-string">"""异步速率限制器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, rate: <span class="hljs-built_in">float</span></span>):
        self.rate = rate  <span class="hljs-comment"># 每秒最多调用次数</span>
        self._tokens = rate
        self._last_update = asyncio.get_event_loop().time()
        self._lock = Lock()
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">acquire</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self._lock:
            now = asyncio.get_event_loop().time()
            elapsed = now - self._last_update
            
            <span class="hljs-comment"># 添加令牌</span>
            self._tokens = <span class="hljs-built_in">min</span>(self.rate, self._tokens + elapsed * self.rate)
            self._last_update = now
            
            <span class="hljs-keyword">if</span> self._tokens &gt;= <span class="hljs-number">1</span>:
                self._tokens -= <span class="hljs-number">1</span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 等待足够的令牌</span>
                wait_time = (<span class="hljs-number">1</span> - self._tokens) / self.rate
                <span class="hljs-keyword">await</span> asyncio.sleep(wait_time)
                self._tokens = <span class="hljs-number">0</span>
                self._last_update = asyncio.get_event_loop().time()
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">rate_limiter_example</span>():
    <span class="hljs-string">"""速率限制器示例"""</span>
    limiter = AsyncRateLimiter(rate=<span class="hljs-number">2.0</span>)  <span class="hljs-comment"># 每秒最多2次</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">make_request</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-keyword">await</span> limiter.acquire()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{time.strftime(<span class="hljs-string">'%H:%M:%S'</span>)}</span> <span class="hljs-subst">{name}</span>: 发送请求"</span>)
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)
    
    tasks = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
        task = asyncio.create_task(make_request(<span class="hljs-string">f"Req-<span class="hljs-subst">{i}</span>"</span>))
        tasks.append(task)
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)  <span class="hljs-comment"># 模拟请求间隔</span>
    
    <span class="hljs-keyword">await</span> asyncio.gather(*tasks)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncPipeline</span>:
    <span class="hljs-string">"""异步处理管道"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self._queue = asyncio.Queue(maxsize=<span class="hljs-number">10</span>)
        self._event = Event()
        self._condition = Condition()
        self._workers = []
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">producer</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, count: <span class="hljs-built_in">int</span></span>):
        <span class="hljs-string">"""生产者协程"""</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):
            item = <span class="hljs-string">f"<span class="hljs-subst">{name}</span>-项目<span class="hljs-subst">{i}</span>"</span>
            <span class="hljs-keyword">await</span> self._queue.put(item)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生产者 <span class="hljs-subst">{name}</span>: 生产 <span class="hljs-subst">{item}</span>"</span>)
            <span class="hljs-keyword">await</span> asyncio.sleep(random.uniform(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>))
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生产者 <span class="hljs-subst">{name}</span>: 完成"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">consumer</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""消费者协程"""</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-keyword">try</span>:
                item = <span class="hljs-keyword">await</span> asyncio.wait_for(self._queue.get(), timeout=<span class="hljs-number">2.0</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"消费者 <span class="hljs-subst">{name}</span>: 处理 <span class="hljs-subst">{item}</span>"</span>)
                <span class="hljs-keyword">await</span> asyncio.sleep(random.uniform(<span class="hljs-number">0.2</span>, <span class="hljs-number">0.5</span>))
                self._queue.task_done()
            <span class="hljs-keyword">except</span> asyncio.TimeoutError:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"消费者 <span class="hljs-subst">{name}</span>: 超时，退出"</span>)
                <span class="hljs-keyword">break</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, producer_count: <span class="hljs-built_in">int</span> = <span class="hljs-number">3</span>, consumer_count: <span class="hljs-built_in">int</span> = <span class="hljs-number">2</span></span>):
        <span class="hljs-string">"""运行管道"""</span>
        <span class="hljs-comment"># 创建生产者</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(producer_count):
            task = asyncio.create_task(self.producer(<span class="hljs-string">f"P<span class="hljs-subst">{i}</span>"</span>, <span class="hljs-number">5</span>))
            self._workers.append(task)
        
        <span class="hljs-comment"># 创建消费者</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(consumer_count):
            task = asyncio.create_task(self.consumer(<span class="hljs-string">f"C<span class="hljs-subst">{i}</span>"</span>))
            self._workers.append(task)
        
        <span class="hljs-comment"># 等待所有生产者完成</span>
        <span class="hljs-keyword">await</span> asyncio.gather(*self._workers[:producer_count])
        
        <span class="hljs-comment"># 等待队列清空</span>
        <span class="hljs-keyword">await</span> self._queue.join()
        
        <span class="hljs-comment"># 取消消费者</span>
        <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> self._workers[producer_count:]:
            task.cancel()
        
        <span class="hljs-comment"># 等待所有任务完成</span>
        <span class="hljs-keyword">await</span> asyncio.gather(*self._workers, return_exceptions=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 运行</span>
asyncio.run(AsyncPipeline().run())
</code></pre>
<h2 data-id="heading-8">五、异步IO与网络编程</h2>
<h3 data-id="heading-9">aiohttp和异步数据库</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp
<span class="hljs-keyword">import</span> asyncpg
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncWebScraper</span>:
    <span class="hljs-string">"""异步网页抓取器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, concurrency_limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):
        self.semaphore = Semaphore(concurrency_limit)
        self.session = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__aenter__</span>(<span class="hljs-params">self</span>):
        self.session = aiohttp.ClientSession()
        <span class="hljs-keyword">return</span> self
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__aexit__</span>(<span class="hljs-params">self, exc_type, exc_val, exc_tb</span>):
        <span class="hljs-keyword">if</span> self.session:
            <span class="hljs-keyword">await</span> self.session.close()
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_url</span>(<span class="hljs-params">self, url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""获取单个URL"""</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.semaphore:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.session.get(url, timeout=<span class="hljs-number">10</span>) <span class="hljs-keyword">as</span> response:
                    text = <span class="hljs-keyword">await</span> response.text()
                    <span class="hljs-keyword">return</span> {
                        <span class="hljs-string">'url'</span>: url,
                        <span class="hljs-string">'status'</span>: response.status,
                        <span class="hljs-string">'size'</span>: <span class="hljs-built_in">len</span>(text),
                        <span class="hljs-string">'content'</span>: text[:<span class="hljs-number">100</span>]  <span class="hljs-comment"># 只取前100字符</span>
                    }
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> {<span class="hljs-string">'url'</span>: url, <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e)}
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_multiple</span>(<span class="hljs-params">self, urls: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""并发获取多个URL"""</span>
        tasks = [self.fetch_url(url) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls]
        results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="hljs-literal">True</span>)
        
        processed = []
        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, Exception):
                processed.append({<span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(result)})
            <span class="hljs-keyword">else</span>:
                processed.append(result)
        
        <span class="hljs-keyword">return</span> processed

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncDatabase</span>:
    <span class="hljs-string">"""异步数据库操作"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, dsn: <span class="hljs-built_in">str</span></span>):
        self.dsn = dsn
        self.pool = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect</span>(<span class="hljs-params">self, pool_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):
        <span class="hljs-string">"""创建连接池"""</span>
        self.pool = <span class="hljs-keyword">await</span> asyncpg.create_pool(
            self.dsn,
            min_size=<span class="hljs-number">1</span>,
            max_size=pool_size,
            command_timeout=<span class="hljs-number">60</span>
        )
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""关闭连接池"""</span>
        <span class="hljs-keyword">if</span> self.pool:
            <span class="hljs-keyword">await</span> self.pool.close()
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">batch_insert</span>(<span class="hljs-params">self, table: <span class="hljs-built_in">str</span>, records: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""批量插入数据"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> records:
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
        
        <span class="hljs-comment"># 准备数据</span>
        columns = records[<span class="hljs-number">0</span>].keys()
        values = [<span class="hljs-built_in">tuple</span>(record[col] <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns) <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records]
        
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.pool.acquire() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-comment"># 开始事务</span>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> conn.transaction():
                stmt = <span class="hljs-keyword">await</span> conn.prepare(<span class="hljs-string">f"""
                    INSERT INTO <span class="hljs-subst">{table}</span> (<span class="hljs-subst">{<span class="hljs-string">','</span>.join(columns)}</span>)
                    VALUES (<span class="hljs-subst">{<span class="hljs-string">','</span>.join(<span class="hljs-string">f'$<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>'</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(columns)))}</span>)
                """</span>)
                
                <span class="hljs-comment"># 批量执行</span>
                <span class="hljs-keyword">await</span> stmt.executemany(values)
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(values)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">concurrent_queries</span>(<span class="hljs-params">self, queries: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]]:
        <span class="hljs-string">"""并发执行查询"""</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>):
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.pool.acquire() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> conn.fetch(query)
        
        tasks = [execute_query(query) <span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> queries]
        results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="hljs-literal">True</span>)
        
        processed = []
        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, Exception):
                processed.append({<span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(result)})
            <span class="hljs-keyword">else</span>:
                processed.append([<span class="hljs-built_in">dict</span>(record) <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> result])
        
        <span class="hljs-keyword">return</span> processed

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">web_scraper_example</span>():
    <span class="hljs-string">"""网页抓取示例"""</span>
    urls = [
        <span class="hljs-string">'https://httpbin.org/get'</span>,
        <span class="hljs-string">'https://httpbin.org/delay/1'</span>,
        <span class="hljs-string">'https://httpbin.org/delay/2'</span>,
        <span class="hljs-string">'https://httpbin.org/status/404'</span>,
        <span class="hljs-string">'https://nonexistent.example.com'</span>,
    ]
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncWebScraper(concurrency_limit=<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> scraper:
        results = <span class="hljs-keyword">await</span> scraper.fetch_multiple(urls * <span class="hljs-number">2</span>)  <span class="hljs-comment"># 重复URL测试去重</span>
        
        <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
            <span class="hljs-keyword">if</span> <span class="hljs-string">'error'</span> <span class="hljs-keyword">in</span> result:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: <span class="hljs-subst">{result[<span class="hljs-string">'url'</span>]}</span> - <span class="hljs-subst">{result[<span class="hljs-string">'error'</span>]}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功: <span class="hljs-subst">{result[<span class="hljs-string">'url'</span>]}</span> - 状态: <span class="hljs-subst">{result[<span class="hljs-string">'status'</span>]}</span>"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">database_example</span>():
    <span class="hljs-string">"""数据库示例（需要PostgreSQL数据库）"""</span>
    <span class="hljs-comment"># 注意：实际使用时需要替换为真实的数据库连接信息</span>
    dsn = <span class="hljs-string">"postgresql://user:password@localhost/dbname"</span>
    
    db = AsyncDatabase(dsn)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">await</span> db.connect()
        
        <span class="hljs-comment"># 创建测试表</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db.pool.acquire() <span class="hljs-keyword">as</span> conn:
            <span class="hljs-keyword">await</span> conn.execute(<span class="hljs-string">'''
                CREATE TABLE IF NOT EXISTS test_users (
                    id SERIAL PRIMARY KEY,
                    name TEXT NOT NULL,
                    age INTEGER,
                    created_at TIMESTAMP DEFAULT NOW()
                )
            '''</span>)
        
        <span class="hljs-comment"># 批量插入</span>
        users = [
            {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">25</span>},
            {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>},
            {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">35</span>},
        ]
        
        count = <span class="hljs-keyword">await</span> db.batch_insert(<span class="hljs-string">'test_users'</span>, users)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"插入了 <span class="hljs-subst">{count}</span> 条记录"</span>)
        
        <span class="hljs-comment"># 并发查询</span>
        queries = [
            <span class="hljs-string">"SELECT * FROM test_users WHERE age &gt; 20"</span>,
            <span class="hljs-string">"SELECT COUNT(*) as count FROM test_users"</span>,
            <span class="hljs-string">"SELECT name, age FROM test_users ORDER BY age DESC"</span>,
        ]
        
        results = <span class="hljs-keyword">await</span> db.concurrent_queries(queries)
        <span class="hljs-keyword">for</span> i, result <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(results):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"查询 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 结果: <span class="hljs-subst">{result}</span>"</span>)
            
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> db.close()

<span class="hljs-comment"># 运行示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 网页抓取示例 ==="</span>)
    <span class="hljs-keyword">await</span> web_scraper_example()
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 异步管道示例 ==="</span>)
    <span class="hljs-keyword">await</span> AsyncPipeline().run()

<span class="hljs-comment"># 注意：数据库示例需要真实数据库，这里只展示代码结构</span>
<span class="hljs-comment"># asyncio.run(main())</span>
</code></pre>
<h2 data-id="heading-10">六、调试与性能优化</h2>
<h3 data-id="heading-11">异步代码调试工具</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> contextvars <span class="hljs-keyword">import</span> ContextVar
<span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">import</span> uvloop  <span class="hljs-comment"># 高性能事件循环</span>

<span class="hljs-comment"># 设置异步调试日志</span>
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

<span class="hljs-comment"># 上下文变量</span>
request_id: ContextVar[<span class="hljs-built_in">str</span>] = ContextVar(<span class="hljs-string">'request_id'</span>, default=<span class="hljs-string">'unknown'</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncDebugger</span>:
    <span class="hljs-string">"""异步调试器"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">enable_debug_mode</span>():
        <span class="hljs-string">"""启用调试模式"""</span>
        <span class="hljs-comment"># 启用详细日志</span>
        logging.getLogger(<span class="hljs-string">'asyncio'</span>).setLevel(logging.DEBUG)
        
        <span class="hljs-comment"># 设置事件循环调试</span>
        loop = asyncio.get_event_loop()
        loop.set_debug(<span class="hljs-literal">True</span>)
        
        <span class="hljs-comment"># 慢回调警告（秒）</span>
        loop.slow_callback_duration = <span class="hljs-number">0.1</span>
        
        <span class="hljs-comment"># 安装异常处理器</span>
        loop.set_exception_handler(AsyncDebugger.exception_handler)
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">exception_handler</span>(<span class="hljs-params">loop, context</span>):
        <span class="hljs-string">"""处理事件循环异常"""</span>
        message = context.get(<span class="hljs-string">'message'</span>, <span class="hljs-string">'未处理的异常'</span>)
        exception = context.get(<span class="hljs-string">'exception'</span>)
        task = context.get(<span class="hljs-string">'task'</span>)
        
        logger.error(<span class="hljs-string">f"事件循环异常: <span class="hljs-subst">{message}</span>"</span>)
        
        <span class="hljs-keyword">if</span> exception:
            logger.error(<span class="hljs-string">f"异常详情: <span class="hljs-subst">{exception}</span>"</span>)
            logger.error(<span class="hljs-string">f"异常堆栈: <span class="hljs-subst">{traceback.format_exc()}</span>"</span>)
        
        <span class="hljs-keyword">if</span> task:
            logger.error(<span class="hljs-string">f"相关任务: <span class="hljs-subst">{task}</span>"</span>)
        
        <span class="hljs-comment"># 打印所有运行中的任务</span>
        tasks = asyncio.all_tasks(loop)
        <span class="hljs-keyword">if</span> tasks:
            logger.error(<span class="hljs-string">f"当前运行中的任务数: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tasks)}</span>"</span>)
            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tasks:
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> t.done():
                    logger.error(<span class="hljs-string">f"  任务: <span class="hljs-subst">{t}</span>, 状态: <span class="hljs-subst">{t._state}</span>"</span>)
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">trace_coroutine</span>(<span class="hljs-params">coro, name: <span class="hljs-built_in">str</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""跟踪协程执行"""</span>
        <span class="hljs-keyword">import</span> time
        start = time.time()
        
        <span class="hljs-keyword">try</span>:
            result = <span class="hljs-keyword">await</span> coro
            elapsed = time.time() - start
            logger.debug(<span class="hljs-string">f"协程 <span class="hljs-subst">{name <span class="hljs-keyword">or</span> coro.__name__}</span> 完成，耗时: <span class="hljs-subst">{elapsed:<span class="hljs-number">.3</span>f}</span>s"</span>)
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            elapsed = time.time() - start
            logger.error(<span class="hljs-string">f"协程 <span class="hljs-subst">{name <span class="hljs-keyword">or</span> coro.__name__}</span> 失败，耗时: <span class="hljs-subst">{elapsed:<span class="hljs-number">.3</span>f}</span>s, 错误: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">performance_example</span>():
    <span class="hljs-string">"""性能对比示例"""</span>
    <span class="hljs-comment"># 使用uvloop提升性能（Linux/macOS）</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">import</span> uvloop
        uvloop.install()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"使用uvloop事件循环"</span>)
    <span class="hljs-keyword">except</span> ImportError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"使用标准asyncio事件循环"</span>)
    
    <span class="hljs-comment"># 对比不同并发策略</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">io_bound_operation</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>: <span class="hljs-built_in">int</span></span>):
        <span class="hljs-string">"""模拟IO操作"""</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">id</span> * <span class="hljs-number">2</span>
    
    <span class="hljs-comment"># 方法1：顺序执行</span>
    start = asyncio.get_event_loop().time()
    results1 = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
        results1.append(<span class="hljs-keyword">await</span> io_bound_operation(i))
    time1 = asyncio.get_event_loop().time() - start
    
    <span class="hljs-comment"># 方法2：并发执行</span>
    start = asyncio.get_event_loop().time()
    tasks = [io_bound_operation(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]
    results2 = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)
    time2 = asyncio.get_event_loop().time() - start
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"顺序执行时间: <span class="hljs-subst">{time1:<span class="hljs-number">.3</span>f}</span>s"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"并发执行时间: <span class="hljs-subst">{time2:<span class="hljs-number">.3</span>f}</span>s"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"性能提升: <span class="hljs-subst">{time1/time2:<span class="hljs-number">.1</span>f}</span>倍"</span>)
    
    <span class="hljs-comment"># 内存使用分析</span>
    <span class="hljs-keyword">import</span> sys
    coro = io_bound_operation(<span class="hljs-number">1</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"协程对象大小: <span class="hljs-subst">{sys.getsizeof(coro)}</span> 字节"</span>)
    
    task = asyncio.create_task(io_bound_operation(<span class="hljs-number">1</span>))
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务对象大小: <span class="hljs-subst">{sys.getsizeof(task)}</span> 字节"</span>)

<span class="hljs-comment"># 运行</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">debug_demo</span>():
    <span class="hljs-string">"""调试演示"""</span>
    AsyncDebugger.enable_debug_mode()
    
    <span class="hljs-comment"># 设置请求ID</span>
    request_id.<span class="hljs-built_in">set</span>(<span class="hljs-string">"req-123"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">problematic_coroutine</span>():
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.05</span>)
        <span class="hljs-comment"># 模拟错误</span>
        <span class="hljs-keyword">if</span> random.random() &lt; <span class="hljs-number">0.3</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"随机错误"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"成功"</span>
    
    <span class="hljs-comment"># 使用调试包装器</span>
    <span class="hljs-keyword">await</span> AsyncDebugger.trace_coroutine(
        problematic_coroutine(),
        <span class="hljs-string">"测试协程"</span>
    )
    
    <span class="hljs-comment"># 创建多个任务观察调试输出</span>
    tasks = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
        task = asyncio.create_task(problematic_coroutine())
        tasks.append(task)
    
    <span class="hljs-keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 运行性能示例</span>
    asyncio.run(performance_example())
    
    <span class="hljs-comment"># 运行调试示例（取消注释以查看调试输出）</span>
    <span class="hljs-comment"># asyncio.run(debug_demo())</span>
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>Python异步编程通过<code>asyncio</code>和<code>async/await</code>提供了：</p>
<h3 data-id="heading-13">核心概念：</h3>
<ol>
<li><strong>协程</strong>：使用<code>async def</code>定义的异步函数</li>
<li><strong>任务</strong>：管理和调度协程的执行</li>
<li><strong>事件循环</strong>：协调所有异步操作的中央调度器</li>
</ol>
<h3 data-id="heading-14">关键特性：</h3>
<ol>
<li><strong>并发控制</strong>：信号量、锁、事件、条件变量</li>
<li><strong>异步上下文</strong>：<code>async with</code>和<code>async for</code></li>
<li><strong>错误处理</strong>：超时、取消、异常传播</li>
<li><strong>性能优化</strong>：连接池、速率限制、批处理</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用填充表格法-理解01背包及其变体问题]]></title>    <link>https://juejin.cn/post/7591697558377791530</link>    <guid>https://juejin.cn/post/7591697558377791530</guid>    <pubDate>2026-01-06T02:26:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591697558377791530" data-draft-id="7591730714141032490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用填充表格法-理解01背包及其变体问题"/> <meta itemprop="keywords" content="前端,JavaScript,算法"/> <meta itemprop="datePublished" content="2026-01-06T02:26:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用填充表格法-理解01背包及其变体问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:26:36.000Z" title="Tue Jan 06 2026 02:26:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读31分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用填充表格法-理解01背包及其变体问题</h2>
<p>动态规划（Dynamic Programming, DP）解决问题的核心逻辑，本质是通过<strong>填充表格</strong>逐步推导最优解——把复杂的多阶段决策问题，转化为按规则填充表格的可视化过程。以01背包问题（最经典的DP模型）为例，我们先明确最终要填充的核心表格形态，后续所有解题步骤都是为了按规则完成这张表格，表格填完之时，就是问题解决之日。（看此文前，如果动态规划零基础，请看下<a href="https://juejin.cn/post/7591207451778875418" target="_blank" title="https://juejin.cn/post/7591207451778875418">DP解题的5步「钥匙」</a>）</p>
<p>01背包问题核心表格（空表，后续逐步填充）：</p>





















































<table><thead><tr><th>前i个物品\背包容量j</th><th>0（容量为0）</th><th>1（容量为1）</th><th>2（容量为2）</th><th>...（容量递增）</th><th>C（背包最大容量）</th></tr></thead><tbody><tr><td>0（无物品）</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td></tr><tr><td>1（第1个物品）</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td></tr><tr><td>2（第2个物品）</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td></tr><tr><td>...（物品递增）</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td></tr><tr><td>n（第n个物品）</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充</td><td>待填充（最终答案）</td></tr></tbody></table>
<p>表格说明：表格中每个单元格<code>dp[i][j]</code>代表「前i个物品放入容量为j的背包的最大价值」，我们的目标就是按规则填充所有单元格，最终右下角<code>dp[n][C]</code>即为01背包问题的最优解。</p>
<p>要有序、正确地填充这张表格，需要遵循<a href="https://juejin.cn/post/7591207451778875418" target="_blank" title="https://juejin.cn/post/7591207451778875418">DP解题的5步「钥匙」</a>——这是贯穿所有DP问题的通用拆解思路，每一步都对应表格填充的关键环节：</p>
<ol>
<li>
<p><strong>确定dp数组及下标的含义</strong>：明确<code>dp[i]</code>（或二维<code>dp[i][j]</code>）代表什么物理意义（比如"第i阶台阶的爬法数"、"前i个物品放入容量为j的背包的最大价值"）；</p>
</li>
<li>
<p><strong>确定递推公式</strong>：找到<code>dp[i]</code>与子问题<code>dp[i-1]</code>/<code>dp[i-2]</code>等的依赖关系（这是DP的核心，本质是将大问题拆解为可复用的子问题）；</p>
</li>
<li>
<p><strong>dp数组如何初始化</strong>：根据问题边界条件，初始化无法通过递推得到的基础值（比如"背包容量为0时价值为0"、"无物品时价值为0"）；</p>
</li>
<li>
<p><strong>确定遍历顺序</strong>：保证计算<code>dp[i]</code>时，其依赖的子问题已经被计算完成。这里可以简单理解为「表格的填充顺序」—— 二维DP类似逐行逐列填充表格，一维DP则是按特定方向（正序/倒序）填充单行表格；</p>
</li>
<li>
<p><strong>打印dp数组（验证）</strong>：通过打印中间结果，验证递推逻辑是否正确（这是调试DP问题的必备步骤，能快速定位递推公式或遍历顺序的错误）。</p>
</li>
</ol>
<p>后续所有01背包及变体问题的分析，都将围绕这5步「钥匙」展开，本质就是用这5步规则完成对应表格的填充，最终通过表格得到问题答案。</p>
<h3 data-id="heading-1">一、01背包问题基础定义</h3>
<p>01背包的核心场景：有<code>n</code>个物品，每个物品<strong>只有1个</strong>（要么选、要么不选，即"0-1"选择），每个物品有对应的重量<code>w[i]</code>和价值<code>v[i]</code>，现有一个容量为<code>C</code>的背包，如何选择物品放入背包，使得放入物品的总价值最大？</p>
<p>示例：物品重量<code>weights = [2,3,4,5]</code>，价值<code>values = [3,4,5,6]</code>，背包容量<code>capacity = 8</code>，求最大价值。</p>
<h3 data-id="heading-2">二、基础解法：二维DP数组</h3>
<p>我们将严格按照DP解题的5步「钥匙」拆解二维DP解法，每一步都对应核心表格的填充规则：</p>
<h4 data-id="heading-3">2.1 步骤1：确定dp数组及下标的含义</h4>
<p>定义二维DP数组<code>dp[i][j]</code>：表示「前<code>i</code>个物品（从第1个到第<code>i</code>个），放入容量为<code>j</code>的背包中，能获得的最大价值」。</p>
<p>说明：</p>
<ul>
<li>
<p>「前<code>i</code>个物品」不是指编号为<code>i</code>的物品，而是范围上的前<code>i</code>个（比如<code>i=2</code>代表前2个物品）；</p>
</li>
<li>
<p>下标<code>i</code>的范围：0<del>n（<code>i=0</code>表示无物品），下标<code>j</code>的范围：0</del>C（<code>j=0</code>表示背包容量为0）。</p>
</li>
</ul>
<h4 data-id="heading-4">2.2 步骤2：确定递推公式</h4>
<p>对于第<code>i</code>个物品（重量<code>w[i-1]</code>、价值<code>v[i-1]</code>，因数组下标从0开始），有两种选择：选或不选，递推公式由此而来：</p>
<ol>
<li>
<p><strong><code>i</code></strong> <strong>不选第个物品</strong>：前<code>i</code>个物品的最大价值 = 前<code>i-1</code>个物品的最大价值，即<code>dp[i][j] = dp[i-1][j]</code>；</p>
</li>
<li>
<p><strong><code>i</code></strong> <strong>选第个物品</strong>：需保证背包容量<code>j ≥ w[i-1]</code>，此时价值 = 前<code>i-1</code>个物品放入容量<code>j - w[i-1]</code>的最大价值 + 第<code>i</code>个物品的价值，即<code>dp[i][j] = dp[i-1][j - w[i-1]] + v[i-1]</code>。</p>
</li>
</ol>
<p>综合两种情况，取最大值作为<code>dp[i][j]</code>的结果：</p>
<pre><code class="hljs language-Plain" lang="Plain">
dp[i][j] = max(dp[i-1][j], dp[i-1][j - w[i-1]] + v[i-1]) （当j ≥ w[i-1]时）
dp[i][j] = dp[i-1][j] （当j &lt; w[i-1]时，容量不足，无法选第i个物品）
</code></pre>
<h4 data-id="heading-5">2.3 步骤3：dp数组如何初始化</h4>
<p>根据边界条件初始化：</p>
<ol>
<li>
<p><code>i=0</code>（无物品）：无论背包容量多大，最大价值都是0，即<code>dp[0][j] = 0</code>（<code>j</code>从0到C）；</p>
</li>
<li>
<p><code>j=0</code>（背包容量为0）：无论有多少物品，都无法放入，最大价值都是0，即<code>dp[i][0] = 0</code>（<code>i</code>从0到n）。</p>
</li>
</ol>
<p>初始化后，DP数组的第一行和第一列都为0。</p>
<h4 data-id="heading-6">2.4 步骤4：确定遍历顺序（表格填充顺序）</h4>
<p>遍历顺序直接对应二维表格的填充顺序——即「按什么顺序逐个填写表格中的单元格」，这里有两种可行方式：</p>
<ol>
<li>
<p>先遍历物品（<code>i</code>从1到n），再遍历背包容量（<code>j</code>从1到C）；</p>
</li>
<li>
<p>先遍历背包容量（<code>j</code>从1到C），再遍历物品（<code>i</code>从1到n）。</p>
</li>
</ol>
<p>两种顺序都可行，因为计算<code>dp[i][j]</code>时，只依赖上一行（<code>i-1</code>行）的结果，无论先填行还是先填列，上一行的对应位置都已提前计算完成。这就像填充一张二维表格：先遍历物品再遍历容量，是<strong>逐行填充</strong>（每一行对应一个物品的决策，填完一行再处理下一个物品）；先遍历容量再遍历物品，是<strong>逐列填充</strong>（每一列对应一个固定容量，先确定所有物品在该容量下的最优解）。实际解题中更常用「先遍历物品，再遍历容量」的顺序，符合我们「逐个考虑物品是否放入」的思考逻辑。</p>
<h4 data-id="heading-7">2.5 步骤5：打印dp数组（验证）</h4>
<p>这一步是直接验证表格填充结果的正确性——通过逐步填充表格、打印中间状态，确认每一步都符合递推规则，避免因规则理解偏差导致填充错误。以示例<code>weights = [2,3,4,5]</code>、<code>values = [3,4,5,6]</code>、<code>capacity = 8</code>为例，逐步填充核心表格验证逻辑：</p>
<p>以示例<code>weights = [2,3,4,5]</code>、<code>values = [3,4,5,6]</code>、<code>capacity = 8</code>为例，逐步填充表格验证逻辑：</p>
<p>初始DP数组（第一行、第一列为0）：</p>





























<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>0（无物品）</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr></tbody></table>
<p>步骤1：处理第1个物品（重量2，价值3）</p>
<p>j≥2时取max(上一行j, 上一行j-2+3)：</p>





























<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>1（物品[2,3]）</td><td>0</td><td>0</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td></tr></tbody></table>
<p>步骤2：处理第2个物品（重量3，价值4）</p>
<p>j≥3时取max(上一行j, 上一行j-3+4)：</p>





























<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>2（物品[2,3]、[3,4]）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>4</td><td>7</td><td>7</td><td>7</td><td>7</td></tr></tbody></table>
<p>步骤3：处理第3个物品（重量4，价值5）</p>
<p>j≥4时取max(上一行j, 上一行j-4+5)：</p>





























<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>3（新增[4,5]）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>5</td><td>7</td><td>8</td><td>9</td><td>9</td></tr></tbody></table>
<p>步骤4：处理第4个物品（重量5，价值6）</p>
<p>j≥5时取max(上一行j, 上一行j-5+6)：</p>





























<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>4（新增[5,6]）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>5</td><td>7</td><td>8</td><td>9</td><td>10</td></tr></tbody></table>
<p>最终<code>dp[4][8] = 10</code>，与测试用例结果一致，即最大价值为10。</p>
<p>完整二维DP数组变化汇总表：</p>













































































<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>0（无物品）</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr><tr><td>1（物品[2,3]）</td><td>0</td><td>0</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td><td>3</td></tr><tr><td>2（物品[2,3]、[3,4]）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>4</td><td>7</td><td>7</td><td>7</td><td>7</td></tr><tr><td>3（新增[4,5]）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>5</td><td>7</td><td>8</td><td>9</td><td>9</td></tr><tr><td>4（新增[5,6]）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>5</td><td>7</td><td>8</td><td>9</td><td>10</td></tr></tbody></table>
<ul>
<li>
<p>时间复杂度：<code>O(n*C)</code>（<code>n</code>为物品数，<code>C</code>为背包容量）；</p>
</li>
<li>
<p>空间复杂度：<code>O(n*C)</code>（二维数组的空间开销）。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[NormalReconstructZ节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7591770429931257906</link>    <guid>https://juejin.cn/post/7591770429931257906</guid>    <pubDate>2026-01-06T02:38:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591770429931257906" data-draft-id="7591770429930569778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[NormalReconstructZ节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,Unity3D,图形学"/> <meta itemprop="datePublished" content="2026-01-06T02:38:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[NormalReconstructZ节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:38:41.000Z" title="Tue Jan 06 2026 02:38:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0">节点功能概述</h2>
<p>法线Z值重建节点（Normal Reconstruct Z Node）是Unity URP渲染管线中的关键组件，专门用于从法线向量的X和Y分量推导出正确的Z分量。该节点通过精确的数学计算，实现了法线数据的压缩存储与物理正确性保障，在法线贴图优化过程中发挥着重要作用。在实际渲染流程中，它能够有效解决因法线贴图压缩导致的数据丢失问题，确保光照计算的准确性，是高质量实时渲染不可或缺的一环。该节点的设计充分考虑了现代图形硬件的特性，能够在保持高质量视觉效果的同时，显著降低内存带宽和存储空间的需求，特别适合移动平台和性能敏感的应用场景。</p>
<h2 data-id="heading-1">端口与参数详解</h2>
<ul>
<li><strong>输入端口</strong>
<ul>
<li>In：Vector2类型，包含法线贴图的X和Y分量值，通常来自压缩后的法线贴图采样结果。在实际使用中，这些输入数据通常来自经过BC5/DXT5NM等压缩格式处理的法线贴图，这些格式专门设计用于存储双通道的法线数据。</li>
</ul>
</li>
<li><strong>输出端口</strong>
<ul>
<li>Out：Vector3类型，输出完整的法线向量，可直接用于光照计算和材质表现。输出的法线向量已经过归一化处理，确保在后续的着色器计算中能够正确参与光照方程的运算。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">数学原理与算法</h2>
<p>该节点基于单位向量的基本性质进行Z分量重建，核心算法流程如下：</p>
<ol>
<li>计算X和Y分量的平方和，即向量在XY平面上的长度平方，这一步骤实际上是计算法线在XY平面上的投影长度。</li>
<li>通过1减去该平方和得到Z分量的平方值，这一步骤基于单位向量模长为1的基本性质，即x² + y² + z² = 1的数学关系。</li>
<li>对结果取平方根获得Z分量值，需注意正负号的处理。在实际实现中，通常假设法线指向表面外侧，因此Z分量为正值。</li>
<li>对最终结果进行归一化处理，确保输出向量的单位长度，这对于保持光照计算的物理正确性至关重要。</li>
</ol>
<h2 data-id="heading-3">生成代码解析</h2>
<p>以下是该节点的典型HLSL实现代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">Unity_NormalReconstructZ_float</span><span class="hljs-params">(float2 In, out float3 Out)</span>
{
    <span class="hljs-type">float</span> reconstructZ = <span class="hljs-built_in">sqrt</span>(<span class="hljs-number">1.0</span> - saturate(dot(In.xy, In.xy)));
    float3 normalVector = float3(In.x, In.y, reconstructZ);
    Out = normalize(normalVector);
}
</code></pre>
<p>代码解析要点：</p>
<ul>
<li><code>dot(In.xy, In.xy)</code>计算X和Y分量的点积，等价于x² + y²，这是计算二维向量长度的平方的标准方法。</li>
<li><code>saturate()</code>函数确保计算结果被限制在0-1范围内，防止出现无效的负值开方，这对于处理可能存在的数值误差至关重要。</li>
<li><code>sqrt()</code>函数计算Z分量，重建法线向量的垂直分量，这是整个重建过程的核心计算步骤。</li>
<li><code>normalize()</code>函数保证输出为单位向量，确保光照计算的正确性，特别是在高光计算和反射计算中保持物理准确性。</li>
</ul>
<h2 data-id="heading-4">应用场景</h2>
<p>该节点在以下场景中具有重要应用价值：</p>
<ul>
<li>法线贴图压缩存储：通过仅存储XY分量显著减少纹理内存占用，在移动设备上可以节省高达50%的法线贴图内存使用。</li>
<li>动态法线生成：在运行时基于程序化纹理生成完整法线数据，适用于地形生成、水面模拟等动态环境。</li>
<li>法线贴图优化：在移动平台上实现高质量的法线渲染效果，同时保持较低的性能开销。</li>
<li>特殊材质效果实现：如水面波纹、布料褶皱等动态视觉效果，通过实时重建法线实现复杂的表面细节。</li>
<li>延迟渲染管线：在G-Buffer中优化法线数据存储结构，减少显存占用和带宽消耗。</li>
<li>多平台适配：有效解决不同平台法线贴图压缩格式差异问题，确保跨平台渲染的一致性。</li>
</ul>
<h2 data-id="heading-5">使用技巧与优化</h2>
<ul>
<li>参数调整指南：根据具体材质类型适当调整法线强度参数，对于金属材质可以适当增强法线效果，而对于粗糙表面则需要更细致的控制。</li>
<li>性能优化建议：在低端设备上可考虑简化部分计算步骤，比如在某些情况下可以省略归一化操作以获得性能提升。</li>
<li>常见问题解决方案：妥善处理法线方向异常和计算精度问题，特别是在边缘情况下需要特别注意数值稳定性。</li>
<li>移动端适配：针对移动GPU特性优化计算精度和性能表现，可以考虑使用半精度浮点数进行计算。</li>
<li>多光源场景：确保重建的法线在多光源环境下保持正确表现，需要特别注意法线在多个光源下的交互效果。</li>
</ul>
<h2 data-id="heading-6">注意事项</h2>
<ul>
<li>法线方向异常处理：特别注意切线空间法线的正确方向设定，确保重建的法线与原始法线方向一致。</li>
<li>纹理采样错误预防：确保输入数据处于正确的数值范围内，避免因纹理采样错误导致的重建失败。</li>
<li>锯齿边缘问题解决：适当使用各向异性过滤技术改善边缘质量，特别是在法线贴图包含高频细节时。</li>
<li>平台兼容性考量：注意不同图形API下的行为差异，特别是在OpenGL ES和Vulkan平台上的表现可能有所不同。</li>
<li>精度控制：避免因浮点精度不足导致的渲染瑕疵，在关键计算步骤中使用全精度浮点数。</li>
</ul>
<h2 data-id="heading-7">总结与拓展应用</h2>
<p>该节点在Unity URP管线中为法线贴图处理提供了高效的解决方案，通过严谨的数学推导实现Z分量重建，在保持视觉质量的同时优化了资源使用效率。其应用范围不仅限于基础法线处理，还可扩展至高级材质效果开发，如PBR材质系统、视差遮挡映射、曲面细分等先进渲染技术。随着实时渲染技术的持续发展，该节点在虚拟现实、增强现实等新兴领域也将发挥更加重要的作用。特别是在下一代图形API如DirectX 12 Ultimate和Vulkan的背景下，该技术将继续演进，为实时图形渲染提供更加高效和灵活的解决方案。</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战：构建基于 aio_periodic 的高性能异步 AI 绘图 Worker]]></title>    <link>https://juejin.cn/post/7591730714141098026</link>    <guid>https://juejin.cn/post/7591730714141098026</guid>    <pubDate>2026-01-06T02:39:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591730714141098026" data-draft-id="7591730714141048874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战：构建基于 aio_periodic 的高性能异步 AI 绘图 Worker"/> <meta itemprop="keywords" content="Python,AIGC"/> <meta itemprop="datePublished" content="2026-01-06T02:39:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战：构建基于 aio_periodic 的高性能异步 AI 绘图 Worker
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:39:03.000Z" title="Tue Jan 06 2026 02:39:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在分布式系统中，将计算密集型任务（如 AI 图像生成）从 Web 服务中剥离是常见的架构模式。本文将介绍如何使用 Python 的 <code>asyncio</code> 和 <code>aio_periodic</code> 构建一个健壮的 Worker，它能够调用本地 MLX 推理引擎生成图片，同时保持高并发下的稳定性。</p>
<h2 data-id="heading-0">1. 架构概述</h2>
<p>我们的目标是构建一个 Worker 节点，它负责：</p>
<ol>
<li><strong>监听任务</strong>：从 <code>periodicd</code> 任务服务器领取绘图任务。</li>
<li><strong>执行推理</strong>：调用适配 Apple Silicon 的 <code>z-image-turbo-mlx</code> 脚本。</li>
<li><strong>非阻塞交互</strong>：在长达数秒的生成过程中，保持与服务器的心跳连接。</li>
<li><strong>结果回传</strong>：将生成的图片转为 Base64 传回。</li>
</ol>
<h2 data-id="heading-1">2. 核心挑战：同步 vs 异步</h2>
<p>在早期实现中，开发者常直接使用 <code>os.system</code> 调用外部命令。这在异步框架（如 <code>asyncio</code>）中是致命的。</p>
<ul>
<li><strong>问题</strong>：<code>os.system</code> 会阻塞整个 Python 进程。在 AI 生成图片的 5-10 秒内，Event Loop 停止运转，Worker 无法发送心跳包（Heartbeat），导致服务器误判 Worker 掉线并重新分配任务，造成“僵尸任务”循环。</li>
<li><strong>解法</strong>：使用 <code>asyncio.create_subprocess_exec</code>。它允许我们在等待子进程结束时，让出 CPU 控制权，使 Worker 能继续处理网络 IO。</li>
</ul>
<h2 data-id="heading-2">3. 代码实现亮点</h2>
<h3 data-id="heading-3">3.1 安全的子进程调用</h3>
<p>为了防止 Shell 命令注入攻击（例如用户在 prompt 中输入 <code>; rm -rf /</code>），我们放弃字符串拼接，改用列表传参：</p>
<p>Python</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 推荐做法：列表传参</span>
<span class="hljs-attr">cmd</span> = [
    sys.executable, <span class="hljs-string">'generate_mlx.py'</span>,
    <span class="hljs-string">'--prompt'</span>, user_prompt,
    <span class="hljs-string">'--output'</span>, output_filename
]
<span class="hljs-comment"># asyncio 负责安全地将参数传给子进程，无需经过 Shell 解释</span>
<span class="hljs-attr">process</span> = await asyncio.create_subprocess_exec(*cmd)
</code></pre>
<h3 data-id="heading-4">3.2 保持 Event Loop 活跃</h3>
<p>对于文件读取这种 IO 操作，虽然 Python 的 <code>open()</code> 是同步的，但在高并发下依然可能造成微小的卡顿。我们利用 <code>run_in_executor</code> 将其放入线程池：</p>
<p>Python</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 将同步的文件读取扔到线程池，避免阻塞主循环</span>
<span class="hljs-attr">loop</span> = asyncio.get_running_loop()
<span class="hljs-attr">b64_str</span> = await loop.run_in_executor(
    None, 
    partial(blocking_image_to_base64, output_filename)
)
</code></pre>
<h3 data-id="heading-5">3.3 健壮的资源清理</h3>
<p>AI 任务常因显存不足或参数错误而失败。使用 <code>try...finally</code> 模式确保即使生成失败，临时文件也能被清理，保持环境整洁。</p>
<p>Python</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">await</span> run_generation()
except Exception:
    logger.error(<span class="hljs-string">"Job failed"</span>)
<span class="hljs-keyword">finally</span>:
    <span class="hljs-keyword">if</span> os.path.exists(temp_file):
        os.<span class="hljs-keyword">remove</span>(temp_file) <span class="hljs-meta"># 无论成功失败，必须清理垃圾</span>
</code></pre>
<h2 data-id="heading-6">4. 实时日志流</h2>
<p>为了方便运维监控，我们配置子进程直接继承父进程的标准输出。这意味着你在运行 Worker 的终端上，可以直接看到底层 <code>generate_mlx.py</code> 打印的进度条和日志，而无需复杂的管道转发。</p>
<h2 data-id="heading-7">5. 总结</h2>
<p>通过将 <code>aio_periodic</code> 的任务调度能力与 <code>asyncio</code> 的子进程管理结合，我们构建了一个既能利用本地强大算力（MLX），又完全符合分布式系统稳定性要求的 Worker。这种模式同样适用于视频转码、PDF 生成等其他耗时任务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[超实用的AI绘图提示词：快速绘制树状架构图]]></title>    <link>https://juejin.cn/post/7591672090791362579</link>    <guid>https://juejin.cn/post/7591672090791362579</guid>    <pubDate>2026-01-06T02:43:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591672090791362579" data-draft-id="7591730714141147178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="超实用的AI绘图提示词：快速绘制树状架构图"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-06T02:43:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="暖阳_"/> <meta itemprop="url" content="https://juejin.cn/user/1662117312465406"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            超实用的AI绘图提示词：快速绘制树状架构图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117312465406/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    暖阳_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:43:22.000Z" title="Tue Jan 06 2026 02:43:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">超实用的AI绘图提示词：快速绘制树状架构图</h2>
<p>今天给大家分享一个特别特别实用的绘图提示词，来帮你快速绘制树状架构图，生成结构化内容，不再需要打开各种脑图文件，直接在和AI对话时候就可以输出，并且支持随意编辑。</p>
<h3 data-id="heading-1">📋 提示词模板</h3>
<pre><code class="hljs language-markdown" lang="markdown">请帮我绘制一个树状系统架构图，使用以下格式规范：

【格式规范】
<span class="hljs-bullet">1.</span> 使用 ASCII 字符绘制树状结构：
<span class="hljs-bullet">   -</span> 竖线：│ （表示垂直连接）
<span class="hljs-bullet">   -</span> 分支：├─→ （表示向右的分支）
<span class="hljs-bullet">   -</span> 末分支：└─→ （表示最后一个分支）
<span class="hljs-bullet">   -</span> 方括号：[] （表示主要组件/模块）
<span class="hljs-bullet">   -</span> 花括号：{{}} （表示占位符，需要替换的内容）
<span class="hljs-bullet">   -</span> 圆括号：() （表示附加说明信息）
<span class="hljs-bullet">   -</span> 箭头：← → （表示数据流向或连接关系）

<span class="hljs-bullet">2.</span> 缩进规则：
<span class="hljs-bullet">   -</span> 每级子节点向右缩进 4 个空格
<span class="hljs-bullet">   -</span> 保持层级对齐

<span class="hljs-bullet">3.</span> 占位符使用：
<span class="hljs-bullet">   -</span> {{系统名称}} - 系统主名称
<span class="hljs-bullet">   -</span> {{层级名称}} - 各层级名称
<span class="hljs-bullet">   -</span> {{组件名称}} - 具体组件名称
<span class="hljs-bullet">   -</span> {{子组件}} - 子组件名称
<span class="hljs-bullet">   -</span> {{说明信息}} - 附加说明

【示例模板】
{{系统名称}}
<span class="hljs-code">    │
    ├─→ [{{第一层组件1}}]
    │       │
    │       ├─→ [{{子组件1-1}}]
    │       │       │
    │       │       └─→ [{{子组件1-1-1}}] ({{说明信息}})
    │       │
    │       └─→ [{{子组件1-2}}] ← {{连接说明}}
    │
    ├─→ [{{第一层组件2}}]
    │       │
    │       └─→ [{{子组件2-1}}] ─→ [{{目标组件}}] ({{参数}})
    │
    └─→ [{{第一层组件3}}]
            │
            ├─→ [{{子组件3-1}}]
            │
            └─→ [{{子组件3-2}}]
                    │
                    └─ {{连接线}} ─→ [{{最终组件}}]
</span>
【绘制要求】
<span class="hljs-bullet">1.</span> 保持树状结构的清晰和对称
<span class="hljs-bullet">2.</span> 每个节点使用方括号 [] 包裹
<span class="hljs-bullet">3.</span> 占位符使用双花括号 {{}} 包裹
<span class="hljs-bullet">4.</span> 附加信息使用圆括号 () 包裹
<span class="hljs-bullet">5.</span> 连接关系使用箭头 ← → 表示
<span class="hljs-bullet">6.</span> 确保所有分支对齐美观
</code></pre>
<h3 data-id="heading-2">🎯 使用示例</h3>
<h4 data-id="heading-3">示例1：用户登录系统架构</h4>
<p><strong>提示词：</strong></p>
<pre><code class="hljs language-diff" lang="diff">请使用树状图格式绘制用户登录系统架构，替换以下占位符：
<span class="hljs-deletion">- {{系统名称}} = 用户登录系统</span>
<span class="hljs-deletion">- {{第一层组件1}} = 前端层</span>
<span class="hljs-deletion">- {{子组件1-1}} = 登录页面</span>
<span class="hljs-deletion">- {{子组件1-2}} = 用户界面</span>
<span class="hljs-deletion">- {{第一层组件2}} = 后端服务</span>
<span class="hljs-deletion">- {{子组件2-1}} = 认证服务</span>
<span class="hljs-deletion">- {{目标组件}} = 数据库</span>
<span class="hljs-deletion">- {{参数}} = MySQL</span>
</code></pre>
<p><strong>效果：</strong></p>
<pre><code class="hljs language-scss" lang="scss">用户登录系统
    │
    ├─→ <span class="hljs-selector-attr">[前端层]</span>
    │       │
    │       ├─→ <span class="hljs-selector-attr">[登录页面]</span>
    │       │
    │       └─→ <span class="hljs-selector-attr">[用户界面]</span>
    │
    └─→ <span class="hljs-selector-attr">[后端服务]</span>
            │
            └─→ <span class="hljs-selector-attr">[认证服务]</span> ─→ <span class="hljs-selector-attr">[数据库]</span> (MySQL)
</code></pre>
<h4 data-id="heading-4">示例2：微服务架构</h4>
<p><strong>提示词：</strong></p>
<pre><code class="hljs language-diff" lang="diff">请绘制微服务架构图，包含：
<span class="hljs-deletion">- 网关层</span>
<span class="hljs-deletion">- 用户服务（连接MySQL）</span>
<span class="hljs-deletion">- 订单服务（连接Redis）</span>
<span class="hljs-deletion">- 支付服务（连接消息队列）</span>
</code></pre>
<p><strong>效果：</strong></p>
<pre><code class="hljs language-scss" lang="scss">微服务架构
    │
    ├─→ <span class="hljs-selector-attr">[API网关]</span>
    │       │
    │       ├─→ <span class="hljs-selector-attr">[用户服务]</span> ─→ <span class="hljs-selector-attr">[MySQL]</span> (数据存储)
    │       │
    │       ├─→ <span class="hljs-selector-attr">[订单服务]</span> ─→ <span class="hljs-selector-attr">[Redis]</span> (缓存)
    │       │
    │       └─→ <span class="hljs-selector-attr">[支付服务]</span> ─→ <span class="hljs-selector-attr">[消息队列]</span> (异步处理)
    │
    └─→ <span class="hljs-selector-attr">[监控中心]</span>
            │
            └─→ <span class="hljs-selector-attr">[日志收集]</span> ─→ <span class="hljs-selector-attr">[ELK]</span> (日志分析)
</code></pre>
<h4 data-id="heading-5">示例3：物联网设备架构</h4>
<p><strong>提示词：</strong></p>
<pre><code class="hljs language-scss" lang="scss">绘制物联网设备架构，参考格式：
<span class="hljs-selector-attr">[内容1]</span>
    │
    ├─→ <span class="hljs-selector-attr">[内容2]</span> ← USB充电口
    │
    └─→ {{内容三}}
            │
            ├─→ <span class="hljs-selector-attr">[{{子内容}}]</span> ─→ <span class="hljs-selector-attr">[舵机]</span> (<span class="hljs-number">5</span>V)
            │
            └─→ <span class="hljs-selector-attr">[{{子内容}}]</span> ─→ <span class="hljs-selector-attr">[ESP8266]</span> (<span class="hljs-number">3.3</span>V)
                    │
                    └─ GPIO2 ─→ <span class="hljs-selector-attr">[舵机信号线]</span>
</code></pre>
<p><strong>效果：</strong></p>
<pre><code class="hljs language-scss" lang="scss">物联网控制系统
    │
    ├─→ <span class="hljs-selector-attr">[电源模块]</span> ← USB充电口
    │
    └─→ <span class="hljs-selector-attr">[控制模块]</span>
            │
            ├─→ <span class="hljs-selector-attr">[执行器控制]</span> ─→ <span class="hljs-selector-attr">[舵机]</span> (<span class="hljs-number">5</span>V)
            │
            └─→ <span class="hljs-selector-attr">[通信模块]</span> ─→ <span class="hljs-selector-attr">[ESP8266]</span> (<span class="hljs-number">3.3</span>V)
                    │
                    └─ GPIO2 ─→ <span class="hljs-selector-attr">[舵机信号线]</span>
</code></pre>
<h3 data-id="heading-6">✨ 优势特点</h3>
<ol>
<li><strong>无需额外工具</strong>：不需要打开 XMind、Draw.io 等工具，直接在对话中生成</li>
<li><strong>快速编辑</strong>：可以随时修改占位符，AI 会重新生成</li>
<li><strong>格式统一</strong>：使用标准 ASCII 字符，在任何文本编辑器中都能正常显示</li>
<li><strong>易于复制</strong>：生成的图表可以直接复制到文档、代码注释、技术文档中</li>
<li><strong>灵活扩展</strong>：可以根据需要添加任意层级和节点</li>
</ol>
<h3 data-id="heading-7">💡 使用技巧</h3>
<ol>
<li><strong>占位符替换</strong>：先使用占位符生成模板，再逐步替换为实际内容</li>
<li><strong>层级控制</strong>：根据复杂度调整层级深度，建议不超过 5 层</li>
<li><strong>对齐检查</strong>：生成后检查缩进是否对齐，可以要求 AI 调整</li>
<li><strong>样式定制</strong>：可以根据需要调整连接符样式（如使用不同的箭头）</li>
</ol>
<h3 data-id="heading-8">🤝 欢迎分享</h3>
<p>如果你有更好的提示词或者使用技巧，欢迎在评论区分享！让我们一起提高 AI 绘图的效率和质量。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Git `git add -p` 命令中的交互选项]]></title>    <link>https://juejin.cn/post/7591770429931290674</link>    <guid>https://juejin.cn/post/7591770429931290674</guid>    <pubDate>2026-01-06T02:40:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591770429931290674" data-draft-id="7591799107486466058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Git `git add -p` 命令中的交互选项"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T02:40:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Git `git add -p` 命令中的交互选项
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:40:55.000Z" title="Tue Jan 06 2026 02:40:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入理解 Git <code>git add -p</code> 命令中的交互选项</h2>
<p>在使用 Git 进行版本控制时，我们通常会遇到需要有选择性地提交代码修改的情况。这种需求可能源于我们不希望将所有的修改都包含在一次提交中，或者希望将特定的修改分成多个提交，以便更好地记录变更历史。在这种情况下，<code>git add -p</code> 命令是一个非常有用的工具。本文将详细介绍 <code>git add -p</code> 命令的使用方法，特别是其中的交互选项 <code>[y,n,q,a,d,e,?]</code>，并通过实际案例说明其应用场景。</p>
<h3 data-id="heading-1">一、<code>git add -p</code> 命令概述</h3>
<p><code>git add -p</code> 命令用于交互式地将文件的部分修改（称为hunk）添加到暂存区（staging area）。在运行 <code>git add -p</code> 命令后，Git 会逐个显示每个文件的修改块，并提示用户选择是否将该块添加到暂存区。这个过程允许开发者在提交前细粒度地控制哪些修改应该被包含在提交中。</p>
<h3 data-id="heading-2">二、交互选项解释</h3>
<p>当 Git 显示一个修改块时，会提示用户选择操作：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Stage <span class="hljs-keyword">this</span> hunk [y,n,q,a,d,e,?]?
</code></pre>
<p>这些选项分别表示不同的操作：</p>
<ul>
<li><strong><code>y</code>（yes）</strong>：将当前显示的hunk（修改块）添加到暂存区。</li>
<li><strong><code>n</code>（no）</strong>：不将当前显示的hunk添加到暂存区，跳过这个修改。</li>
<li><strong><code>q</code>（quit）</strong>：退出 <code>git add -p</code> 命令，放弃本次交互式添加，不做任何更改。</li>
<li><strong><code>a</code>（all）</strong>：添加当前文件的所有修改到暂存区（stage all hunks for the current file）。</li>
<li><strong><code>d</code>（discard）</strong>：不添加当前文件的任何修改到暂存区（do not stage any hunks for the current file）。</li>
<li><strong><code>e</code>（edit）</strong>：手动编辑当前hunk，可以进入编辑模式，对当前hunk进行更细致的调整或修改。</li>
<li><strong><code>?</code>（help）</strong>：显示帮助信息，列出上述选项的含义和使用方法。</li>
</ul>
<h3 data-id="heading-3">三、实际案例</h3>
<h4 data-id="heading-4">案例一：逐块添加修改</h4>
<p>假设我们有一个文件 <code>example.txt</code>，其中包含以下修改：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">diff --git a/example.txt b/example.txt</span>
<span class="hljs-comment">index e69de29..d95f3ad 100644</span>
<span class="hljs-comment">--- a/example.txt</span>
<span class="hljs-comment">+++ b/example.txt</span>
<span class="hljs-meta">@@ -0,0 +1,4 @@</span>
<span class="hljs-addition">+First line of text</span>
<span class="hljs-addition">+Second line of text</span>
<span class="hljs-addition">+Third line of text</span>
<span class="hljs-addition">+Fourth line of text</span>
</code></pre>
<p>运行 <code>git add -p example.txt</code> 后，Git 会显示第一个修改块：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Stage <span class="hljs-keyword">this</span> hunk [y,n,q,a,d,e,?]?
</code></pre>
<p>在这个提示下，我们可以做出如下选择：</p>
<ul>
<li>输入 <code>y</code> 并回车：将这个修改块添加到暂存区。</li>
<li>输入 <code>n</code> 并回车：跳过这个修改块，不将其添加到暂存区。</li>
<li>输入 <code>q</code> 并回车：退出交互式添加过程，不对任何文件进行暂存。</li>
<li>输入 <code>a</code> 并回车：将 <code>example.txt</code> 文件的所有修改块添加到暂存区。</li>
<li>输入 <code>d</code> 并回车：跳过 <code>example.txt</code> 文件的所有修改块。</li>
<li>输入 <code>e</code> 并回车：进入编辑模式，可以手动调整当前的修改块。</li>
<li>输入 <code>?</code> 并回车：显示帮助信息，列出所有选项的含义。</li>
</ul>
<h4 data-id="heading-5">案例二：选择性提交</h4>
<p>假设我们只希望将 <code>example.txt</code> 文件中的第一行和第二行添加到暂存区，而不提交第三行和第四行的修改。我们可以通过以下步骤实现：</p>
<ol>
<li>
<p>运行 <code>git add -p example.txt</code>，Git 显示第一个修改块。</p>
</li>
<li>
<p>输入 <code>e</code> 并回车，进入编辑模式。</p>
</li>
<li>
<p>手动编辑hunk，只保留我们想添加的修改：</p>
<pre><code class="hljs language-diff" lang="diff">First line of text
Second line of text
</code></pre>
</li>
<li>
<p>保存并退出编辑器。</p>
</li>
</ol>
<p>此时，只有第一行和第二行会被添加到暂存区，而第三行和第四行的修改将不会包含在此次提交中。</p>
<h3 data-id="heading-6">四、交互选项的详细解释</h3>
<h4 data-id="heading-7">1. <code>y</code>（yes）</h4>
<p>输入 <code>y</code> 并回车，将当前hunk添加到暂存区。这是最常用的选项之一，用于确认将当前显示的修改添加到下次提交中。</p>
<h4 data-id="heading-8">2. <code>n</code>（no）</h4>
<p>输入 <code>n</code> 并回车，跳过当前hunk，不将其添加到暂存区。这个选项允许用户选择性地暂存修改，保留未暂存的修改以便以后处理。</p>
<h4 data-id="heading-9">3. <code>q</code>（quit）</h4>
<p>输入 <code>q</code> 并回车，退出交互式添加过程。选择 <code>q</code> 不会暂存任何后续的hunk，适用于希望中断当前操作的情况。</p>
<h4 data-id="heading-10">4. <code>a</code>（all）</h4>
<p>输入 <code>a</code> 并回车，将当前文件的所有剩余修改块添加到暂存区。这个选项适用于确定要将整个文件的修改全部提交的情况。</p>
<h4 data-id="heading-11">5. <code>d</code>（discard）</h4>
<p>输入 <code>d</code> 并回车，不将当前文件的任何修改块添加到暂存区。这个选项用于跳过整个文件的所有修改，适用于希望稍后再处理该文件的情况。</p>
<h4 data-id="heading-12">6. <code>e</code>（edit）</h4>
<p>输入 <code>e</code> 并回车，进入编辑模式。用户可以手动编辑当前的hunk，选择性地添加部分修改。这是一个非常强大的选项，允许精细控制哪些修改被暂存。</p>
<h4 data-id="heading-13">7. <code>?</code>（help）</h4>
<p>输入 <code>?</code> 并回车，显示帮助信息，列出所有交互选项的含义和用法。这是一个有用的选项，特别是在不确定某个选项的作用时。</p>
<h3 data-id="heading-14">五、应用场景</h3>
<h4 data-id="heading-15">1. 代码审查和提交规范</h4>
<p>在团队合作中，良好的提交规范有助于代码审查和版本管理。通过 <code>git add -p</code> 命令，开发者可以将功能完整、逻辑清晰的修改块分别提交，避免将无关或临时修改包含在一次提交中。</p>
<h4 data-id="heading-16">2. 错误修复和功能添加</h4>
<p>在修复错误和添加新功能时，常常会同时修改多个文件。使用 <code>git add -p</code> 可以确保将错误修复和功能添加分别提交，保持提交历史的清晰和可追溯性。</p>
<h4 data-id="heading-17">3. 分阶段提交</h4>
<p>有时，我们在开发过程中可能需要对同一个文件进行多次修改，但希望分阶段提交这些修改。<code>git add -p</code> 允许我们选择性地暂存修改块，实现分阶段提交。</p>
<h3 data-id="heading-18">六、总结</h3>
<p><code>git add -p</code> 命令是 Git 中一个非常强大的工具，能够帮助开发者精细控制哪些修改被包含在提交中。通过交互式的方式，开发者可以逐块选择性地添加修改，避免将不相关或未完成的修改包含在提交中。本文详细介绍了 <code>git add -p</code> 命令的交互选项 <code>[y,n,q,a,d,e,?]</code> 的含义和使用方法，并通过实际案例说明其应用场景。</p>
<p>希望通过本文的介绍，您能够更好地理解和使用 <code>git add -p</code> 命令，从而提升版本控制的效率和规范性。如果您有任何疑问或建议，欢迎在评论区留言讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[由浅入深全面解析ThreadLocal]]></title>    <link>https://juejin.cn/post/7591770429931339826</link>    <guid>https://juejin.cn/post/7591770429931339826</guid>    <pubDate>2026-01-06T02:41:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591770429931339826" data-draft-id="7591800417254998025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="由浅入深全面解析ThreadLocal"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T02:41:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金者阿豪"/> <meta itemprop="url" content="https://juejin.cn/user/4073055974333608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            由浅入深全面解析ThreadLocal
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4073055974333608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金者阿豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:41:51.000Z" title="Tue Jan 06 2026 02:41:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">由浅入深全面解析ThreadLocal</h2>
<p>@<a href="https://link.juejin.cn?target=%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">TOC</a></p>
<h3 data-id="heading-1">简介</h3>
<ol>
<li>线程并发：在多线程并发的场景下使用</li>
<li>传递数据：我们可以通过ThreadLocal在同一线程，不同组件中传递公共变量</li>
<li>线程隔离：每个线程的变量都是独立的，不会相互影响</li>
</ol>
<h3 data-id="heading-2">基本使用</h3>
<ol>
<li>
<p>常用方法
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7b62c9b11b1495f8ff3e87eca54dd7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272111&amp;x-signature=2JKieFUsgkIILRqrVSD4rjJQtlo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
<li>
<p>代码案例实现
(1) 不使用ThreadLocal时模拟多线程存取数据</p>
</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalDemo1</span> {
    <span class="hljs-keyword">private</span> String content;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> content;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> {
        <span class="hljs-built_in">this</span>.content = content;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ThreadLocalDemo1</span> <span class="hljs-variable">threadLocalDemo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalDemo1</span>();

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                    <span class="hljs-comment">/**
                     * 每一个线程存一个变量，过一会取出这个变量
                     */</span>
                    threadLocalDemo.setContent(Thread.currentThread().getName() + <span class="hljs-string">"的数据"</span>);
                    System.out.println(<span class="hljs-string">"------------------------"</span>);
                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"-----&gt;"</span> + threadLocalDemo.getContent());
                }
            });
            thread.setName(<span class="hljs-string">"线程"</span> + i);
            thread.start();
        }
    }
}
</code></pre>
<p>结果：</p>
<pre><code class="hljs language-java" lang="java">------------------------
线程<span class="hljs-number">0</span>-----&gt;线程<span class="hljs-number">4</span>的数据
------------------------
线程<span class="hljs-number">4</span>-----&gt;线程<span class="hljs-number">4</span>的数据
------------------------
线程<span class="hljs-number">2</span>-----&gt;线程<span class="hljs-number">4</span>的数据
------------------------
线程<span class="hljs-number">3</span>-----&gt;线程<span class="hljs-number">4</span>的数据
------------------------
线程<span class="hljs-number">1</span>-----&gt;线程<span class="hljs-number">4</span>的数据
</code></pre>
<p>（2） 使用ThreadLocal对多线程进行数据隔离，把数据绑定到ThreadLocal
（传统解决方案首先想到的就是加锁，确实可以实现，但是却牺牲了效率，需要等待上一个线程之行结束才可以往下之行）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadLocalDemo2</span> {
    ThreadLocal&lt;String&gt; threadLocal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

    <span class="hljs-keyword">private</span> String content;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> threadLocal.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> {
        threadLocal.set(content);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ThreadLocalDemo2</span> <span class="hljs-variable">threadLocalDemo2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocalDemo2</span>();

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                    <span class="hljs-comment">/**
                     * 每一个线程存一个变量，过一会取出这个变量
                     */</span>
                    threadLocalDemo2.setContent(Thread.currentThread().getName()+<span class="hljs-string">"的数据"</span>);
                    System.out.println(<span class="hljs-string">"------------------------"</span>);
                    System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"-----&gt;"</span> + threadLocalDemo2.getContent());
                }
            });
            thread.setName(<span class="hljs-string">"线程"</span> + i);
            thread.start();
        }
    }
}
</code></pre>
<p>结果：</p>
<pre><code class="hljs language-java" lang="java">------------------------
------------------------
------------------------
线程<span class="hljs-number">3</span>-----&gt;线程<span class="hljs-number">3</span>的数据
------------------------
线程<span class="hljs-number">2</span>-----&gt;线程<span class="hljs-number">2</span>的数据
线程<span class="hljs-number">1</span>-----&gt;线程<span class="hljs-number">1</span>的数据
线程<span class="hljs-number">0</span>-----&gt;线程<span class="hljs-number">0</span>的数据
------------------------
线程<span class="hljs-number">4</span>-----&gt;线程<span class="hljs-number">4</span>的数据
</code></pre>
<h3 data-id="heading-3">ThreadLocal与synchronized的区别</h3>
<p>二者都是用来处理多线程并发访问的问题，但是二者的原理和侧重点不一样，简要说就是，ThreadLocal牺牲了空间，而synchronized是牺牲了时间来保证线程安全（隔离）。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d37392525ef49dba9785f15ab746346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272111&amp;x-signature=6HO6ygutpvUzL%2BKmca%2FZmDoqdEI%3D" alt="在这里插入图片描述" loading="lazy"/>
总结：在上述的案例当中，使用ThreadLocal更为合理，这样保证了程序拥有了更高的并发性。</p>
<h3 data-id="heading-4">ThreadLocal现在的设计（JDK1.8）</h3>
<ol>
<li>简介
每一个Thread维护一个ThreadLocalMap，这个Map的key为ThreadLocal实例本身，而value则为实际存储的值。</li>
<li>具体过程
（1）每一个Thread内部都有一个Map（ThreadLocalMap）
（2）Map里面存储的ThreadLocal对象（key）和线程的变量副本（value）
（3）Thread的Map是由ThreadLocal来维护的，由ThreadLocal负责向Map获取和设置线程的变量值。
（4）对于线程获取值，每一个副本只能获取当前线程本地的副本值，别的线程无法访问到，互不干扰，实现了线程隔离。</li>
<li>对比与1.8之前的设计（相当于Thread与ThreadLocal的角色互换了）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee58abbba4d6481a82ae9b4dc2e6b133~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272111&amp;x-signature=hmiGeSxr%2BBAjeJwzdBxL4MVeY4I%3D" alt="在这里插入图片描述" loading="lazy"/></li>
<li>1.8设计的好处
（1）每个Map存储的Entry数量变少了（因为实际状况下Thread比ThreadLocal多）
（2）当Thread销毁时，ThreadLocalMap也会随之销毁，避免内存的浪费</li>
</ol>
<h3 data-id="heading-5">ThreadLocal核心方法源码分析</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16ffad45a77847ff852cd82b9da9e5b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272111&amp;x-signature=WxpReHgNWrEL9%2BS9N1oqKe8eFqw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>get方法源码</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {
		<span class="hljs-comment">// 获取当前线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-comment">// 获取ThreadLocalMap</span>
        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
        <span class="hljs-comment">// map不为空时，获取里面的Entry</span>
        <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
            ThreadLocalMap.<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>);
            <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) {
                <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
                <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (T)e.value;
                <span class="hljs-comment">// 返回结果</span>
                <span class="hljs-keyword">return</span> result;
            }
        }
        <span class="hljs-comment">// 没有则赋值初始值null并返回</span>
        <span class="hljs-keyword">return</span> setInitialValue();
    }
</code></pre>
<ol start="2">
<li>set方法源码</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> {
		<span class="hljs-comment">// 获取当前线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-comment">// 获取ThreadLocalMap</span>
        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
        <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
        	<span class="hljs-comment">// 不为空直接set</span>
            map.set(<span class="hljs-built_in">this</span>, value);
        } <span class="hljs-keyword">else</span> {
        	<span class="hljs-comment">// map为空则创建并set</span>
            createMap(t, value);
        }
    }
</code></pre>
<ol start="3">
<li>initialValue方法返回初始值（protected修饰为了让子类覆盖设计的）需要自定义初始值可以重写该方法</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> T <span class="hljs-title function_">initialValue</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
</code></pre>
<ol start="4">
<li>remove方法</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
		 <span class="hljs-comment">// 获取当前线程的ThreadLocalMap</span>
         <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> getMap(Thread.currentThread());
         <span class="hljs-keyword">if</span> (m != <span class="hljs-literal">null</span>) {
         	<span class="hljs-comment">// 移除ThreadLocalMap</span>
             m.remove(<span class="hljs-built_in">this</span>);
         }
     }
</code></pre>
<ol start="5">
<li>setInitialValue方法</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> T <span class="hljs-title function_">setInitialValue</span><span class="hljs-params">()</span> {
		<span class="hljs-comment">// 得到初始化值null</span>
        <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> initialValue();
        <span class="hljs-comment">// 获取当前线程</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();
        <span class="hljs-comment">// 获取线程中ThreadLocalMap</span>
        <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);
        <span class="hljs-comment">// map存在的话把null设置进去，不存在则创建一个并将null设置进去</span>
        <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) {
            map.set(<span class="hljs-built_in">this</span>, value);
        } <span class="hljs-keyword">else</span> {
            createMap(t, value);
        }
        <span class="hljs-comment">// 如果当前ThreadLocal属于TerminatingThreadLocal（关闭的ThreadLocal）则register（注册）到TerminatingThreadLocal</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> <span class="hljs-keyword">instanceof</span> TerminatingThreadLocal) {
            TerminatingThreadLocal.register((TerminatingThreadLocal&lt;?&gt;) <span class="hljs-built_in">this</span>);
        }
        <span class="hljs-keyword">return</span> value;
    }
</code></pre>
<h3 data-id="heading-6">ThreadLocalMap源码分析</h3>
<ol>
<li>简介
ThreadLocalMap是ThreadLocal的内部类，没有实现Map接口，是独自设计实现Map功能，内部的Entry也是独立的。</li>
<li>结构图解
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d16907aa70f24eafb773a976661dabd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272111&amp;x-signature=Uz%2BYtJDUBrji90vew0IkRMK%2FFMo%3D" alt="在这里插入图片描述" loading="lazy"/></li>
<li>成员变量</li>
</ol>
<pre><code class="hljs language-java" lang="java">		<span class="hljs-comment">// Entry类，继承弱应用，为了和Thread的生命周期解绑</span>
		<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; {
            <span class="hljs-comment">/** The value associated with this ThreadLocal. */</span>
            Object value;

            Entry(ThreadLocal&lt;?&gt; k, Object v) {
                <span class="hljs-built_in">super</span>(k);
                value = v;
            }
        }

        <span class="hljs-comment">/**
         * The initial capacity -- MUST be a power of two.
         * 初始容量，必须是二的幂
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INITIAL_CAPACITY</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>;

        <span class="hljs-comment">/**
         * The table, resized as necessary.
         * table.length MUST always be a power of two.
         * 根据需要调整大小。长度必须是2的幂。
         */</span>
        <span class="hljs-keyword">private</span> Entry[] table;

        <span class="hljs-comment">/**
         * The number of entries in the table.
         * table中的entrie数量
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-comment">/**
         * The next size value at which to resize.
         * 要调整大小的下一个大小值
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> threshold; <span class="hljs-comment">// Default to 0</span>

        <span class="hljs-comment">/**
         * Set the resize threshold to maintain at worst a 2/3 load factor.
         * 设置调整大小阈值以维持最坏的2/3负载因子
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setThreshold</span><span class="hljs-params">(<span class="hljs-type">int</span> len)</span> {
            threshold = len * <span class="hljs-number">2</span> / <span class="hljs-number">3</span>;
        }

        <span class="hljs-comment">/**
         * Increment i modulo len.
         * 增量一
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nextIndex</span><span class="hljs-params">(<span class="hljs-type">int</span> i, <span class="hljs-type">int</span> len)</span> {
            <span class="hljs-keyword">return</span> ((i + <span class="hljs-number">1</span> &lt; len) ? i + <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);
        }

        <span class="hljs-comment">/**
         * Decrement i modulo len.
         * 减量一
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">prevIndex</span><span class="hljs-params">(<span class="hljs-type">int</span> i, <span class="hljs-type">int</span> len)</span> {
            <span class="hljs-keyword">return</span> ((i - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span>) ? i - <span class="hljs-number">1</span> : len - <span class="hljs-number">1</span>);
        }
</code></pre>
<h3 data-id="heading-7">弱引用与内存泄露（内存泄漏和弱引用没有直接关系）</h3>
<ol>
<li>内存泄漏/溢出概念
（1）Memory overflow：内存溢出，没有足够的空间提供给申请者使用
（2）Memory leak：内存泄漏，系统中已动态分配的堆内存由于某种原因无法释放或者没有释放，导致系统内存堆积，影响系统运行，甚至导致系统崩溃。内存泄漏终将导致内存溢出。</li>
<li>强/弱引用概念
（1）Strong Referce：强引用，我们常见的对象引用，只要有一个强引用指向对象，也就表明还“活着”，这种状况下垃圾回收机制（GC）是不会回收的。
（2）Weak Referce：弱引用，继承了WeakReferce的对象，垃圾回收器发现了只具有弱引用的对象，不管当前系统的内存是否充足，都会回收他的内存。</li>
<li>如果key，即Entry使用强引用，也无法避免内存泄漏
因为Entry是在Thread当前线程中，生命周期和Thread一样，没有手动删除Entry时Entry就会内存泄漏。</li>
<li>也就是说，<strong>只要在调用完ThreadLocal后及时使用remove方法，才能避免内存泄漏</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42193776949a47409dc7cdb92e899735~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272111&amp;x-signature=9scZWgbu8re9Lja5Ys%2FtPQjYYe4%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ecedcf226df46698d6e595c02cafb80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6ICF6Zi_6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272111&amp;x-signature=mEy403lTwhzaTSZYNDJTeo8WSSM%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ol>
<h3 data-id="heading-8">ThreadLocal核心源码（Hash冲突解决）</h3>
<ol>
<li>从构造方法入手</li>
</ol>
<pre><code class="hljs language-java" lang="java">
		ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {
			<span class="hljs-comment">// 初始化table</span>
            table = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>[INITIAL_CAPACITY];
            <span class="hljs-comment">// 计算索引在数组中的位置（核心代码）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="hljs-number">1</span>);
            <span class="hljs-comment">// 设置值</span>
            table[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(firstKey, firstValue);
            size = <span class="hljs-number">1</span>;
            <span class="hljs-comment">// 设置阈值（INITIAL_CAPACITY的三分之二）</span>
            setThreshold(INITIAL_CAPACITY);
        }
</code></pre>
<ol start="2">
<li>重点分析int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">threadLocalHashCode</span> <span class="hljs-operator">=</span> nextHashCode();

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nextHashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);
    }
    
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">nextHashCode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>();

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">HASH_INCREMENT</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x61c88647</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAndAdd</span><span class="hljs-params">(<span class="hljs-type">int</span> delta)</span> {
        <span class="hljs-keyword">return</span> unsafe.getAndAddInt(<span class="hljs-built_in">this</span>, valueOffset, delta);
    }
</code></pre>
<p>（1）这里定义了一个AtomicInteger，每次获取并加上HASH_INCREMENT（0x61c88647，这个值与斐波那契数（黄金分割）有关），是为了让哈希码能够均匀的分布在2的n次方的数组（Entry[]）里面，也就尽可能避免了哈希冲突。
（2）hashcode &amp; (INITIAL_CAPACITY - 1)  相当于hashcode % (INITIAL_CAPACITY - 1)  的高效写法，所以size必须为2的次幂，这样最大程度避免了哈希冲突。</p>
<ol start="3">
<li>set方法源码分析</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key, Object value)</span> {
    		
            Entry[] tab = table;
            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;
            <span class="hljs-comment">// 计算索引</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (len-<span class="hljs-number">1</span>);
            <span class="hljs-comment">/**
            *
            * 使用线性探测法查找元素
            * */</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> tab[i];
                 e != <span class="hljs-literal">null</span>;
                 <span class="hljs-comment">// 使用线性探测法查找元素</span>
                 e = tab[i = nextIndex(i, len)]) {
                 <span class="hljs-comment">// 获取到该Entry对应的ThreadLocal</span>
                ThreadLocal&lt;?&gt; k = e.get();
                <span class="hljs-keyword">if</span> (k == key) {
                <span class="hljs-comment">// key存在则覆盖value</span>
                    e.value = value;
                    <span class="hljs-keyword">return</span>;
                }
                <span class="hljs-comment">// key为null但是值不为null，这说明了之前使用过，但是ThreadLocal被垃圾回收了，当前的Entry是一个陈旧的（Stale）元素</span>
                <span class="hljs-keyword">if</span> (k == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// key（ThreadLocal）不存在，则新Entry替换旧的Entry，此方法做了不少垃圾清理的动作，避免了内存泄漏。</span>
                    replaceStaleEntry(key, value, i);
                    <span class="hljs-keyword">return</span>;
                }
            }
            <span class="hljs-comment">// ThreadLocal中未找到key也没有陈旧的元素，此时则在这个位置新创建一个Entry</span>
            tab[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(key, value);
            <span class="hljs-type">int</span> <span class="hljs-variable">sz</span> <span class="hljs-operator">=</span> ++size;
            <span class="hljs-comment">// cleanSomeSlots用于清理e.get()为null的key，如果大于阈值（2/3容量）则rehash（执行一次全表扫描清理工作）</span>
            <span class="hljs-keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)
                rehash();
        }
		<span class="hljs-comment">/**
		* 线性探测法查找元素，到最后一个时重定位到第一个
		*/</span>
		<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">nextIndex</span><span class="hljs-params">(<span class="hljs-type">int</span> i, <span class="hljs-type">int</span> len)</span> {
            <span class="hljs-keyword">return</span> ((i + <span class="hljs-number">1</span> &lt; len) ? i + <span class="hljs-number">1</span> : <span class="hljs-number">0</span>);
        }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再堆if-else验参数了！FastAPI自带的参数验证器，至少省一半调试时间]]></title>    <link>https://juejin.cn/post/7591801024009486345</link>    <guid>https://juejin.cn/post/7591801024009486345</guid>    <pubDate>2026-01-06T02:40:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591801024009486345" data-draft-id="7591801024009437193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再堆if-else验参数了！FastAPI自带的参数验证器，至少省一半调试时间"/> <meta itemprop="keywords" content="Python,FastAPI"/> <meta itemprop="datePublished" content="2026-01-06T02:40:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王二哥的技术笔记"/> <meta itemprop="url" content="https://juejin.cn/user/3358381525700410"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再堆if-else验参数了！FastAPI自带的参数验证器，至少省一半调试时间
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3358381525700410/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王二哥的技术笔记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:40:50.000Z" title="Tue Jan 06 2026 02:40:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fbdf7cde6ef4ff4ace933f581acb422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5LqM5ZOl55qE5oqA5pyv56yU6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272050&amp;x-signature=eWQSslwYchRUsufwbtojDlaohPI%3D" alt="fHbUZC5Mq" loading="lazy"/></p>
<p>你是不是也遇到过这样的场景——用户传了个 <code>book_id=-1</code>，接口直接崩了？或者查询评分时塞进来一个 <code>rating=999</code>，数据库默默吐出所有内容？</p>
<p><strong>没验证的参数，就像没锁的门。</strong></p>
<p>上一期文章中，我们学习了如何使用 Pydantic 对请求体进行数据验证。今天，我们将深入探讨FastAPI的另外两种重要验证方式：<strong>路径参数验证</strong>和<strong>查询参数验证</strong>。</p>
<p>访问上一篇文章，请点击：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FzJd23wpb-IPqlIU-czHBKQ" target="_blank" title="https://mp.weixin.qq.com/s/zJd23wpb-IPqlIU-czHBKQ" ref="nofollow noopener noreferrer">跳转</a></p>
<h3 data-id="heading-0">为什么需要验证路径和查询参数？</h3>
<p>当我们构建RESTful API时，除了请求体数据，路径参数和查询参数同样需要严格的验证：</p>
<p><strong>路径参数</strong>：如<code>/books/{book_id}</code>中的<code>book_id</code></p>
<p><strong>查询参数</strong>：如<code>/books?rating=5</code>中的<code>rating</code></p>
<p>没有验证的参数就像没有安检的入口，可能导致各种安全问题和非预期行为。</p>
<h3 data-id="heading-1">路径参数验证：精准控制资源访问</h3>
<p><strong>问题场景分析</strong>：以图书查询接口为例</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/books/{book_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_book</span>(<span class="hljs-params">book_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-keyword">for</span> book <span class="hljs-keyword">in</span> BOOKS:
        <span class="hljs-keyword">if</span> book.<span class="hljs-built_in">id</span> == book_id:
            <span class="hljs-keyword">return</span> book
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p>这个接口会存在两个问题：</p>
<ol>
<li>书籍不存在时，返回<code>None</code>，用户体验不是很好。</li>
<li>没有对<code>book_id</code>参数进行合法性验证（如负数、零值）</li>
</ol>
<p><strong>解决方案：使用Path进行验证</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Path

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/books/{book_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_book</span>(<span class="hljs-params">book_id: <span class="hljs-built_in">int</span> = Path(<span class="hljs-params">gt=<span class="hljs-number">0</span></span>)</span>):
    <span class="hljs-keyword">for</span> book <span class="hljs-keyword">in</span> BOOKS:
        <span class="hljs-keyword">if</span> book.<span class="hljs-built_in">id</span> == book_id:
            <span class="hljs-keyword">return</span> book
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"error"</span>: <span class="hljs-string">"Book not found"</span>}
</code></pre>
<p>关键改进：</p>
<ol>
<li><code>Path(gt=0)</code> 确保 book_id 参数必须大于 0。</li>
<li>当书籍不存在时，给用户返回明确的错误提示。</li>
</ol>
<p><strong>验证效果展示</strong></p>
<p>回到浏览器的 Swagger UI 页面，刷新页面。我们进入 <code>GET /books/{book_id}</code> 接口，传入 <code>book_id=0</code>。</p>
<p>FastAPI自动返回422错误，及如下异常响应信息：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"detail"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"greater_than"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"loc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"path"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"book_id"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Input should be greater than 0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"ctx"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"gt"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>从错误信息中，用户就可以明确的了解到，我们传入的 <code>book_id</code> 参数必须大于 0。</p>
<p><strong>删除接口做同步优化</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.delete(<span class="hljs-params"><span class="hljs-string">"/books/{book_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_book</span>(<span class="hljs-params">book_id: <span class="hljs-built_in">int</span> = Path(<span class="hljs-params">gt=<span class="hljs-number">0</span></span>)</span>):
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(BOOKS)):
        <span class="hljs-keyword">if</span> BOOKS[i].<span class="hljs-built_in">id</span> == book_id:
            BOOKS.pop(i)
            <span class="hljs-keyword">break</span>
</code></pre>
<h3 data-id="heading-2">查询参数验证：确保筛选条件的合理性</h3>
<p><strong>问题场景分析</strong>：图书按评分查询接口为例</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/books/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_books_by_rating</span>(<span class="hljs-params">book_rating: <span class="hljs-built_in">int</span></span>):
    books_to_return = []
    <span class="hljs-keyword">for</span> book <span class="hljs-keyword">in</span> BOOKS:
        <span class="hljs-keyword">if</span> book.rating == book_rating:
            books_to_return.append(book)
    <span class="hljs-keyword">return</span> books_to_return
</code></pre>
<p>存在的问题：评分范围并没有做限制（如，可能会传入0或6）</p>
<p><strong>解决方案：使用Query进行验证</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Query

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/books/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_books_by_rating</span>(<span class="hljs-params">book_rating: <span class="hljs-built_in">int</span> = Query(<span class="hljs-params">gt=<span class="hljs-number">0</span>, lt=<span class="hljs-number">6</span></span>)</span>):
    books_to_return = []
    <span class="hljs-keyword">for</span> book <span class="hljs-keyword">in</span> BOOKS:
        <span class="hljs-keyword">if</span> book.rating == book_rating:
            books_to_return.append(book)
    <span class="hljs-keyword">return</span> books_to_return
</code></pre>
<p>验证规则说明：</p>
<p><code>gt=0</code>：必须大于 0
<code>lt=6</code>：必须小于 6</p>
<p>综合效果：只允许1-5的整数评分</p>
<p><strong>验证效果展示</strong></p>
<p>回到浏览器的 Swagger UI 页面，刷新页面。我们进入 <code>GET /books/</code> 接口，传入 <code>book_rating=0</code>。</p>
<p>FastAPI自动返回422错误，及如下异常响应信息：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"detail"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"greater_than"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"loc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"book_rating"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Input should be greater than 0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"ctx"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"gt"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>从错误信息中，用户就可以明确的了解到，我们传入的 <code>book_rating</code> 参数必须大于 0。</p>
<h3 data-id="heading-3">Path 与 Query 验证的对比</h3>






























<table><thead><tr><th>特性</th><th>Path 参数验证</th><th>Query 参数验证</th></tr></thead><tbody><tr><td>使用场景</td><td>资源标识（如ID）</td><td>筛选条件（如评分、分类）</td></tr><tr><td>导入方式</td><td><code>from fastapi import Path</code></td><td><code>from fastapi import Query</code></td></tr><tr><td>语法示例</td><td><code>book_id: int = Path(gt=0)</code></td><td><code>rating: int = Query(gt=0, lt=6)</code></td></tr><tr><td>验证重点</td><td>确保资源标识的合法性</td><td>确保查询条件的合理性</td></tr></tbody></table>
<h3 data-id="heading-4">最佳实践</h3>
<ol>
<li><strong>始终验证</strong>：对所有输入参数进行验证，不信任任何外部输入</li>
<li><strong>明确范围</strong>：为数值参数设置合理的上下限</li>
<li><strong>统一错误处理</strong>：保持错误响应格式的一致性</li>
<li><strong>文档完善</strong>：良好的验证规则会自动体现在API文档中</li>
</ol>
<h3 data-id="heading-5">下节预告</h3>
<p>掌握了这些基础验证后，下一期我们将深入探讨 FastAPI 中常用状态码和 HTTP 异常的实现，让你的 API 更加标准和专业。</p>
<p>欢迎 “关注”，我们在下一期一起来解锁这个问题。</p>
<hr/>
<p>-------- <strong>写在最后</strong> --------</p>
<p><strong>关注我</strong>，每天1分钟，轻松懂 Python</p>
<p><strong>我的同名公众号正在连载《FastAPI 开发实战》、《Python 核心技术》、《职场》。</strong></p>
<hr/>
<p><strong>点赞</strong> ：支持技术分享！</p>
<p><strong>分享</strong> ：分享给身边感兴趣的朋友！</p>
<p><strong>关注我</strong> ：获取更多FastAPI实战技巧！</p>
<hr/>
<p>#Python #FastAPI #API #Web开发 #程序员 #编程教程 #效率提升 #后端开发 #API设计 #参数验证</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1分钟解锁Python神技：用生成器轻松处理1亿条数据！]]></title>    <link>https://juejin.cn/post/7591801024009535497</link>    <guid>https://juejin.cn/post/7591801024009535497</guid>    <pubDate>2026-01-06T02:45:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591801024009535497" data-draft-id="7591792747776229386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1分钟解锁Python神技：用生成器轻松处理1亿条数据！"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-06T02:45:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王二哥的技术笔记"/> <meta itemprop="url" content="https://juejin.cn/user/3358381525700410"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1分钟解锁Python神技：用生成器轻松处理1亿条数据！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3358381525700410/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王二哥的技术笔记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:45:15.000Z" title="Tue Jan 06 2026 02:45:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0866826f7c24425aa1a4b7022e356173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5LqM5ZOl55qE5oqA5pyv56yU6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272314&amp;x-signature=FNSviGl8ywVB%2FERz3KX4V9OWPn8%3D" alt="202601052005209941" loading="lazy"/></p>
<p>欢迎来到「每天1分钟，轻松懂Python」！今天的主角是：<strong>生成器</strong>。</p>
<p>它能让你用几乎忽略不计的内存，处理无限大的数据流。比如，轻松遍历1亿条数据而不会撑爆你的内存。</p>
<p><strong>核心价值就一点：惰性计算——需要时才生产，绝不提前浪费空间。</strong></p>
<p>1分钟时间，我们从概念、代码、案例出发。让你不仅看懂，更能马上用起来！</p>
<h3 data-id="heading-0">容器、可迭代对象、迭代器</h3>
<p><strong>容器</strong>：在 Python 中一切皆为对象，对象的集合就是容器。</p>
<p><strong>可迭代对象</strong>：<strong>实现了<code>__iter__()</code>方法</strong>的对象，或者说，是能返回一个迭代器的对象。</p>
<p>所有容器都是可迭代对象，但可迭代对象不一定是容器。</p>
<p><strong>迭代器</strong>：<strong>实现了<code>__iter__()</code>和<code>__next__()</code>方法</strong>的对象。它提供一个 next 方法，当你调用这个方法后，要么得到下一个对象，要么抛出 StopIteration 异常。</p>
<h5 data-id="heading-1">1、判断可迭代对象</h5>
<p>通过 <code>iter()</code> 函数尝试转换，捕获 <code>TypeError</code> 判断：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_iterable</span>(<span class="hljs-params">param</span>):  
    <span class="hljs-keyword">try</span>:  
        <span class="hljs-built_in">iter</span>(param)  
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>  
    <span class="hljs-keyword">except</span> TypeError:  
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>  

<span class="hljs-comment"># 测试：列表、字典等返回 True，数字返回 False  </span>
</code></pre>
<h3 data-id="heading-2">生成器：更轻量的迭代器</h3>
<h5 data-id="heading-3">1、核心优势</h5>
<p><strong>惰性计算</strong>：仅在调用 <code>next()</code> 时生成元素，（比预先生成大列表 ）节省内存。</p>
<p><strong>简单语法</strong>：使用生成器表达式（<code>(i for i in range(10))</code> ）或 <code>yield</code> 关键字定义。</p>
<pre><code class="hljs language-lua" lang="lua">对于 <span class="hljs-built_in">yield</span>，可以理解为：
函数运行到这一行的时候，程序会从这里暂停，然后跳出。跳到 <span class="hljs-built_in">next</span>() 函数。
每次调用 `<span class="hljs-built_in">next</span>(gen)` 时，暂停的程序，就会从 <span class="hljs-built_in">yield</span> 这里向下继续执行；
</code></pre>
<h5 data-id="heading-4">2、基础用法</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 生成器表达式</span>
gen = (i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># 输出 0</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># 输出 1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># 输出 2</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># StopIteration</span>

<span class="hljs-comment"># 2. yield 关键字</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">my_generator</span>():
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>


gen = my_generator()
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># 输出 1</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># 输出 2</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># 输出 3</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(gen))  <span class="hljs-comment"># StopIteration</span>
</code></pre>
<h3 data-id="heading-5">实战应用</h3>
<h5 data-id="heading-6">1、内存优化对比</h5>
<p>生成器可以避免预存大量数据，适合处理超大序列：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pympler <span class="hljs-keyword">import</span> asizeof

<span class="hljs-comment"># 迭代器</span>
large_list = [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>**<span class="hljs-number">5</span>)]

<span class="hljs-comment"># 生成器</span>
<span class="hljs-comment"># 仅保存生成逻辑，内存大小不随数据量大小变化，内存占用极低</span>
large_gen = (i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>**<span class="hljs-number">5</span>))

<span class="hljs-comment"># 输出：列表占用内存: 3907.21 KB</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"列表占用内存: <span class="hljs-subst">{asizeof.asizeof(large_list) / <span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span> KB"</span>)
<span class="hljs-comment"># 输出：生成器占用内存: 0.45 KB</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器占用内存: <span class="hljs-subst">{asizeof.asizeof(large_gen) / <span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span> KB"</span>)
</code></pre>
<h5 data-id="heading-7">2、复杂逻辑实现：验证数学公式</h5>
<p>用生成器动态生成数列，验证等式 <code>(1+2+...+n)² = 1³+2³+...+n³</code>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用生成器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generator</span>(<span class="hljs-params">k</span>):  
    i = <span class="hljs-number">1</span>  
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:  
        <span class="hljs-keyword">yield</span> i**k  
        i += <span class="hljs-number">1</span>  

gen_1 = generator(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 生成 1,4,9...</span>
gen_3 = generator(<span class="hljs-number">3</span>)  <span class="hljs-comment"># 生成 1³,2³,3³...  </span>
</code></pre>
<h5 data-id="heading-8">3、算法简化：子序列判断</h5>
<p>用生成器 + 迭代器，可以更简洁实现 “判断子序列” 逻辑：</p>
<p>LeetCode 题目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.com%2Fproblems%2Fis-subsequence%2F" target="_blank" title="https://leetcode.com/problems/is-subsequence/" ref="nofollow noopener noreferrer">leetcode.com/problems/is…</a></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_subsequence</span>(<span class="hljs-params">a, b</span>):  
    b = <span class="hljs-built_in">iter</span>(b)  <span class="hljs-comment"># 转为迭代器  </span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">all</span>(i <span class="hljs-keyword">in</span> b <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> a)  

<span class="hljs-comment"># 测试：a = [1,3,5] 是 b = [1,2,3,4,5] 的子序列  </span>
<span class="hljs-built_in">print</span>(is_subsequence([<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]))  <span class="hljs-comment"># True  </span>
<span class="hljs-built_in">print</span>(is_subsequence([<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]))  <span class="hljs-comment"># False</span>
</code></pre>
<h3 data-id="heading-9">高频面试题</h3>
<p>01、<strong>可迭代对象和迭代器的区别？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">可迭代对象：实现 <span class="hljs-strong">__iter__</span>，可转为迭代器（如 list ）。
迭代器：实现 <span class="hljs-strong">__iter__</span> 和 <span class="hljs-strong">__next__</span>，支持 next() 逐个取元素。
</code></pre>
<p>02、<strong>生成器的 <code>yield</code> 有什么作用？</strong></p>
<pre><code class="hljs language-scss" lang="scss">暂停函数执行，保留当前状态（如变量值 ）。返回一个值给调用者。
下次 <span class="hljs-built_in">next</span>() 调用时从暂停处继续执行。
</code></pre>
<p>03、<strong>生成器为什么能节省内存？</strong></p>
<pre><code class="hljs language-scss" lang="scss">生成器是 “惰性计算”，不预存所有元素，仅在调用 <span class="hljs-built_in">next</span>() 时动态生成。
因此，内存占用远低于预先生成大列表的迭代器。
</code></pre>
<p>04、<code>for</code> 循环如何遍历可迭代对象？</p>
<pre><code class="hljs language-scss" lang="scss">for 循环自动将可迭代对象转为迭代器（调用 <span class="hljs-built_in">iter</span>() ）。
然后，循环调用 <span class="hljs-built_in">next</span>()，直到捕获 StopIteration 异常退出。
</code></pre>
<p>05、<strong>哪些场景适合用生成器？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 处理超大序列（如一亿条数据 ），避免内存溢出。
<span class="hljs-bullet">2.</span> 实现动态生成逻辑（如无限数列、实时数据流 ）。
<span class="hljs-bullet">3.</span> 简化代码（如子序列判断、复杂数学验证 ）。
</code></pre>
<p>06、生成器迭代结束后，继续调用 <code>next()</code> 会怎样？</p>
<pre><code class="hljs">抛出 StopIteration 异常，提示迭代已结束。
</code></pre>
<hr/>
<p>-------- <strong>写在最后</strong> --------</p>
<p><strong>关注我</strong>，每天1分钟，轻松懂 Python</p>
<p><strong>我的同名公众号正在连载《FastAPI 开发实战》、《Python 核心技术》、《职场》。</strong></p>
<hr/>
<p><strong>点赞</strong> ：如果觉得有收获，点赞支持一下吧！</p>
<p><strong>分享</strong> ：分享给身边同样对Python感兴趣的朋友！</p>
<p><strong>关注我</strong> ：不要错过每一篇 Python 实战内容！</p>
<hr/>
<p>#Python #FastAPI #API #Web开发 #程序员 #编程教程 #效率提升 #装饰器</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[003-spring cloud alibaba之gateway网关]]></title>    <link>https://juejin.cn/post/7592017365141061684</link>    <guid>https://juejin.cn/post/7592017365141061684</guid>    <pubDate>2026-01-06T02:52:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592017365141061684" data-draft-id="7591704324907728930" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="003-spring cloud alibaba之gateway网关"/> <meta itemprop="keywords" content="微服务"/> <meta itemprop="datePublished" content="2026-01-06T02:52:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="超级小猪"/> <meta itemprop="url" content="https://juejin.cn/user/3702810891008525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            003-spring cloud alibaba之gateway网关
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810891008525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    超级小猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T02:52:46.000Z" title="Tue Jan 06 2026 02:52:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">gateway</h2>
<blockquote>
<p>gateway网关主要就是对外接收各种请求，然后根据自己内容的路由逻辑将请求发给服务</p>
</blockquote>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
Start --&gt; gateway
gateway --&gt; 路由
路由 --&gt; user
路由 --&gt; base
路由 --&gt; order
路由 --&gt; ...
</code></pre>
<h3 data-id="heading-1">gateway服务搭建</h3>
<h4 data-id="heading-2">第1步：依赖</h4>
<p>构建一个gateway服务只需要增加相应的依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud-alibaba-version</span>&gt;</span>2021.1<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud-alibaba-version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>2020.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-cloud-alibaba-version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-cloud.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">第2步：创建yaml文件</h4>
<p>主要是要新增路由逻辑配置</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway-service</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">discovery:</span>
        <span class="hljs-attr">server-addr:</span> <span class="hljs-number">10.106</span><span class="hljs-number">.114</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>
    <span class="hljs-attr">gateway:</span>
      <span class="hljs-attr">routes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span>
          <span class="hljs-attr">uri:</span> <span class="hljs-string">http://10.106.114.1:9001/</span>
          <span class="hljs-attr">predicates:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/user/**</span>
</code></pre>
<p>上面配置的gateway.routes就是路由</p>
<ul>
<li>
<p>id：标记路由</p>
</li>
<li>
<p>predicates：路由配置</p>
<ul>
<li>Path：其中一个路径，上面<code>/user/**</code>表示当请求localhost:9999/user/xxx时，会将请求转发到<code>http://10.106.114.1:9001/user/xxx</code></li>
</ul>
</li>
<li>
<p>uri：转发的地址</p>
</li>
</ul>
<h4 data-id="heading-4">第3步：启动类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@EnableDiscoveryClient</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayStartApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(GatewayStartApplication.class,args);
    }
}
</code></pre>
<h4 data-id="heading-5">第4步创建user服务</h4>
<p>user服务主要要注意的是，由于请求是<code>http://10.106.114.1:9001/user/xxx</code>多了一个user，所以需要在user服务里面增加context-path。下面是user服务的配置</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">9001</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">context-path:</span> <span class="hljs-string">/user/</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">user</span>
  <span class="hljs-attr">cloud:</span>
    <span class="hljs-attr">discovery:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span>

<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-string">include:'*'</span>
</code></pre>
<h4 data-id="heading-6">第5步验证</h4>
<ul>
<li>启动nacos</li>
<li>启动gateway</li>
<li>启动user</li>
<li>访问9001：<a href="https://link.juejin.cn?target=http%3A%2F%2F10.106.114.1%3A9001%2Fuser%2Fhello" target="_blank" title="http://10.106.114.1:9001/user/hello" ref="nofollow noopener noreferrer">http://10.106.114.1:9001/user/hello</a> 确定user服务正常</li>
<li>访问9999：<a href="https://link.juejin.cn?target=http%3A%2F%2F10.106.114.1%3A9999%2Fuser%2Fhello" target="_blank" title="http://10.106.114.1:9999/user/hello" ref="nofollow noopener noreferrer">http://10.106.114.1:9999/user/hello</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/840f6d3c427a430e8ad3597e48a9bf1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn5bCP54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272765&amp;x-signature=k5m2Wq%2BHi%2FC8QYc80Jqp3zT1So8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">自定义路由</h3>
<p>上面使用的配置文件来实现路由。也可以使用自定义类来实现路由模式。</p>
<h4 data-id="heading-8">第1步：注释yaml里面的路由配置</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78ccb9e37a944c679d51557d0d6b8f4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn5bCP54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272765&amp;x-signature=oR1VO5Fk4mSZ%2BSsy6mMFrJC%2F1kU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">第2步：创建自定义类路由</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.cloud.gateway.route.RouteLocator;
<span class="hljs-keyword">import</span> org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;


<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title function_">customerRouteLocator</span><span class="hljs-params">(RouteLocatorBuilder routeLocatorBuilder)</span>{
        System.out.println(<span class="hljs-string">"加载路由"</span>);
        RouteLocatorBuilder.<span class="hljs-type">Builder</span> <span class="hljs-variable">routes</span> <span class="hljs-operator">=</span> routeLocatorBuilder.routes();
        routes.route(<span class="hljs-string">"user"</span>,
                r-&gt;r.path(<span class="hljs-string">"/user/**"</span>).uri(<span class="hljs-string">"http://10.106.114.1:9001/"</span>));
        <span class="hljs-keyword">return</span> routes.build();
    }
}
</code></pre>
<h4 data-id="heading-10">第3步：验证</h4>
<p>效果同样</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ccaa371421b4fca8c103383818fb09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn5bCP54yq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768272765&amp;x-signature=yXcOf8dMw4%2FwoP6t4kBF0on%2F714%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原型污染安全漏洞]]></title>    <link>https://juejin.cn/post/7591728734983012379</link>    <guid>https://juejin.cn/post/7591728734983012379</guid>    <pubDate>2026-01-05T15:59:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591728734983012379" data-draft-id="7591719013488394278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原型污染安全漏洞"/> <meta itemprop="keywords" content="前端,强化学习"/> <meta itemprop="datePublished" content="2026-01-05T15:59:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在西安放羊的牛油果"/> <meta itemprop="url" content="https://juejin.cn/user/2946346894233133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原型污染安全漏洞
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2946346894233133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在西安放羊的牛油果
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T15:59:03.000Z" title="Mon Jan 05 2026 15:59:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概念</h2>
<p><strong>原型污染安全漏洞（Prototype Pollution）</strong> 是前端 / Node.js 生态里非常重要、也非常容易被忽略的一类漏洞。该漏洞最终可导致权限绕过，是前端安全中的高危问题。</p>
<h2 data-id="heading-1">什么是原型污染？</h2>
<p>攻击者通过可控输入，修改 <code>Object.prototype</code> 或其他内建原型，从而影响所有对象的行为。</p>
<p>JS 原型链</p>
<pre><code class="hljs language-javascript" lang="javascript">obj → <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> → <span class="hljs-literal">null</span>
</code></pre>
<p>一旦污染了 <code>Object.prototype</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Object.prototype.isAdmin</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
({}).<span class="hljs-attr">isAdmin</span> === <span class="hljs-literal">true</span><span class="hljs-comment">; // 💣</span>
</code></pre>
<h2 data-id="heading-2">模拟攻击</h2>
<p>下面我们通过一段代码来分析一下什么是原型污染。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepMerge</span>(<span class="hljs-params">target, source</span>) { 
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) { 
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> source[key] === <span class="hljs-string">'object'</span>) { 
      <span class="hljs-keyword">if</span> (!target[key]) { 
        target[key] = {}; 
      } 
      <span class="hljs-title function_">deepMerge</span>(target[key], source[key]); 
    } <span class="hljs-keyword">else</span> { 
      target[key] = source[key]; 
    } 
  } 
  <span class="hljs-keyword">return</span> target; 
} 
 
<span class="hljs-comment">// 模拟业务代码 </span>
<span class="hljs-comment">// 方案1：监听 message 事件 </span>
<span class="hljs-keyword">const</span> config = {}; 
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> { 
  <span class="hljs-title function_">deepMerge</span>(config, e.<span class="hljs-property">data</span>); 
}); 
 
<span class="hljs-comment">// 方案2：使用 qs 解析 query </span>
<span class="hljs-keyword">import</span> qs <span class="hljs-keyword">from</span> <span class="hljs-string">'qs'</span>; 
<span class="hljs-keyword">const</span> searchQuery = qs.<span class="hljs-title function_">parse</span>(location.<span class="hljs-property">search</span>); 
<span class="hljs-keyword">const</span> routeQuery = { 
  <span class="hljs-attr">type</span>: <span class="hljs-string">'low'</span>, 
  <span class="hljs-attr">tab</span>: <span class="hljs-number">1</span>, 
}; 
<span class="hljs-title function_">deepMerge</span>(routeQuery, searchQuery); 
 
 
<span class="hljs-comment">// 业务逻辑 </span>
<span class="hljs-keyword">const</span> userInfo = {}; 
<span class="hljs-keyword">if</span> (userInfo.<span class="hljs-property">isAdmin</span>) { 
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你是管理员'</span>); 
} 

 <span class="hljs-comment">// 我想成为管理员，请输入攻击荷载： </span>
</code></pre>
<p>这段代码<strong>存在典型的原型污染（Prototype Pollution）安全漏洞</strong>，而且两个“方案”都能成为攻击入口。下面我按「问题 → 利用方式 → 影响 → 修复建议」来拆解。</p>
<hr/>
<h3 data-id="heading-3">一、核心问题在哪？</h3>
<h4 data-id="heading-4">不安全的 <code>deepMerge</code></h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepMerge</span>(<span class="hljs-params">target, source</span>) { 
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) { 
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> source[key] === <span class="hljs-string">'object'</span>) { 
      <span class="hljs-keyword">if</span> (!target[key]) { 
        target[key] = {}; 
      } 
      <span class="hljs-title function_">deepMerge</span>(target[key], source[key]); 
    } <span class="hljs-keyword">else</span> { 
      target[key] = source[key]; 
    } 
  } 
}
</code></pre>
<p><strong>问题点：</strong></p>
<ul>
<li>使用 <code>for...in</code>（会遍历原型链）</li>
<li>未过滤 <code>proto</code> / <code>constructor</code> / <code>prototype</code></li>
<li>未判断是否为「纯对象」</li>
<li>直接递归写入 <code>target[key]</code></li>
</ul>
<p>👉 <strong>攻击者可以修改</strong> <strong><code>Object.prototype</code></strong></p>
<hr/>
<h3 data-id="heading-5">二、两个业务场景为什么都危险？</h3>
<h4 data-id="heading-6">方案1：</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
  <span class="hljs-title function_">deepMerge</span>(config, e.<span class="hljs-property">data</span>);
});
</code></pre>
<h5 data-id="heading-7">攻击 payload</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>({<span class="hljs-attr">proto</span>: {<span class="hljs-attr">isAdmin</span>: <span class="hljs-literal">true</span>
  }
}, <span class="hljs-string">'*'</span>);
</code></pre>
<h5 data-id="heading-8">结果</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> userInfo = {};
userInfo.<span class="hljs-property">isAdmin</span> === <span class="hljs-literal">true</span>; <span class="hljs-comment">// 💣</span>
</code></pre>
<p>🎯 <strong>攻击者无需控制 userInfo，只要污染原型即可</strong></p>
<hr/>
<h4 data-id="heading-9">方案2：</h4>
<pre><code class="hljs language-js" lang="js">qs.<span class="hljs-title function_">parse</span>(location.<span class="hljs-property">search</span>)
<span class="hljs-keyword">const</span> searchQuery = qs.<span class="hljs-title function_">parse</span>(location.<span class="hljs-property">search</span>);
<span class="hljs-title function_">deepMerge</span>(routeQuery, searchQuery);
</code></pre>
<h5 data-id="heading-10">恶意 URL</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">https</span>:<span class="hljs-comment">//example.com/?_proto_[isAdmin]=true</span>
</code></pre>
<p>或（更隐蔽）</p>
<pre><code class="hljs language-js" lang="js">?constructor[prototype][isAdmin]=<span class="hljs-literal">true</span>
</code></pre>
<h5 data-id="heading-11">结果同样是：</h5>
<pre><code class="hljs language-js" lang="js">({}).<span class="hljs-property">isAdmin</span> === <span class="hljs-literal">true</span>;
</code></pre>
<hr/>
<h3 data-id="heading-12">三、最终危害点（业务逻辑被绕过）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> userInfo = {};
<span class="hljs-keyword">if</span> (userInfo.<span class="hljs-property">isAdmin</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'你是管理员'</span>);
}
</code></pre>
<p>🚨 <strong>这是一个权限绕过漏洞</strong> 在真实系统中，可能导致：</p>
<ul>
<li>后台权限获取</li>
<li>功能越权</li>
<li>安全校验全部失效</li>
</ul>
<hr/>
<h3 data-id="heading-13">四、为什么这是“高危漏洞”？</h3>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>利用门槛</td><td>低（URL / postMessage 即可）</td></tr><tr><td>影响范围</td><td>全局（污染 Object.prototype）</td></tr><tr><td>隐蔽性</td><td>高（调试很难发现）</td></tr><tr><td>常见度</td><td>非常高（deepMerge / lodash.merge）</td></tr></tbody></table>
<p>👉 已多次出现在真实 CVE (Common Vulnerabilities and Exposures) 中。</p>
<hr/>
<h3 data-id="heading-14">五、正确的修复方式 ✅</h3>
<h4 data-id="heading-15">✅ 1. 严格过滤危险 key（必须）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> blockedKeys = [<span class="hljs-string">'__proto__'</span>, <span class="hljs-string">'prototype'</span>, <span class="hljs-string">'constructor'</span>];

<span class="hljs-keyword">function</span> <span class="hljs-title function_">safeDeepMerge</span>(<span class="hljs-params">target, source</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(source)) {
    <span class="hljs-keyword">if</span> (blockedKeys.<span class="hljs-title function_">includes</span>(key)) <span class="hljs-keyword">continue</span>;

    <span class="hljs-keyword">if</span> (
      <span class="hljs-keyword">typeof</span> source[key] === <span class="hljs-string">'object'</span> &amp;&amp;
      source[key] !== <span class="hljs-literal">null</span> &amp;&amp;
      !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(source[key])
    ) {
      <span class="hljs-keyword">if</span> (!target[key]) target[key] = {};
      <span class="hljs-title function_">safeDeepMerge</span>(target[key], source[key]);
    } <span class="hljs-keyword">else</span> {
      target[key] = source[key];
    }
  }
}
</code></pre>
<hr/>
<h4 data-id="heading-16">✅ 2. postMessage 必须校验来源</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">origin</span> !== <span class="hljs-string">'https://trusted.com'</span>) <span class="hljs-keyword">return</span>;
  <span class="hljs-title function_">safeDeepMerge</span>(config, e.<span class="hljs-property">data</span>);
});
</code></pre>
<hr/>
<h4 data-id="heading-17">✅ 3. qs 使用安全模式</h4>
<pre><code class="hljs language-js" lang="js">qs.<span class="hljs-title function_">parse</span>(location.<span class="hljs-property">search</span>, {
  <span class="hljs-attr">allowPrototypes</span>: <span class="hljs-literal">false</span>
});
</code></pre>
<p>⚠️ <strong>默认 qs 是危险的（旧版本尤其）</strong></p>
<hr/>
<h4 data-id="heading-18">✅ 4. 使用成熟库</h4>
<p>如 URLSearchParams</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> params = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(location.<span class="hljs-property">search</span>));
</code></pre>
<h4 data-id="heading-19">✅ 5. 防御性编程（推荐）</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> userInfo = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);
</code></pre>
<p>或</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hasOwnProperty</span>.<span class="hljs-title function_">call</span>(userInfo, <span class="hljs-string">'isAdmin'</span>)) {
  ...
}
</code></pre>
<hr/>
<h2 data-id="heading-20">为什么它是“安全漏洞”而不是 Bug？</h2>
<p>因为它会导致：</p>





























<table><thead><tr><th><strong>后果</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td>权限绕过</td><td>if (user.isAdmin)</td></tr><tr><td>逻辑篡改</td><td>if (config.debug)</td></tr><tr><td>RCE（Node）</td><td>与 eval / child_process 结合</td></tr><tr><td>XSS</td><td>模板渲染、配置拼接</td></tr><tr><td>DoS</td><td>JSON stringify / 递归崩溃</td></tr></tbody></table>
<p>👉 <strong>影响是“全局的、隐式的、持久的”</strong></p>
<hr/>
<h2 data-id="heading-21">真实世界中的 CVE (Common Vulnerabilities and Exposures)</h2>





























<table><thead><tr><th><strong>库</strong></th><th><strong>CVE</strong></th></tr></thead><tbody><tr><td>lodash.merge</td><td>CVE-2019-10744</td></tr><tr><td>jQuery.extend</td><td>CVE-2019-11358</td></tr><tr><td>minimist</td><td>CVE-2020-7598</td></tr><tr><td>yargs</td><td>CVE-2020-7608</td></tr><tr><td>qs</td><td>多次</td></tr></tbody></table>
<p>📌 <strong>这不是“理论漏洞”，而是“被打烂的漏洞类型”</strong></p>
<hr/>
<h2 data-id="heading-22">如何判断你的代码是否有原型污染？</h2>
<h3 data-id="heading-23">🔍 自查 checklist</h3>
<ul>
<li>是否把 <strong>用户输入</strong> merge 到对象？</li>
<li>是否使用 <code>for...in</code>？</li>
<li>是否递归拷贝对象？</li>
<li>是否信任 <code>qs.parse</code> / JSON？</li>
<li>是否存在 <code>obj[key] = value</code>，且 <code>key</code> 来自外部？</li>
</ul>
<p>如果有 2 条以上，<strong>高风险</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 性能优化利器：深入理解 useMemo 与 useCallback]]></title>    <link>https://juejin.cn/post/7591708519449100297</link>    <guid>https://juejin.cn/post/7591708519449100297</guid>    <pubDate>2026-01-05T14:32:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591708519449100297" data-draft-id="7591719013488230438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 性能优化利器：深入理解 useMemo 与 useCallback"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2026-01-05T14:32:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yira"/> <meta itemprop="url" content="https://juejin.cn/user/262123324974122"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 性能优化利器：深入理解 useMemo 与 useCallback
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/262123324974122/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yira
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T14:32:05.000Z" title="Mon Jan 05 2026 14:32:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 性能优化利器：深入理解 <code>useMemo</code> 与 <code>useCallback</code></h2>
<p>在 React 应用开发中，随着组件复杂度的提升，性能问题逐渐显现。即使状态更新只影响局部 UI，整个组件函数也会重新执行，导致不必要的计算或子组件重渲染。为解决这些问题，React 提供了两个关键的性能优化 Hook：<strong><code>useMemo</code></strong> 和 <strong><code>useCallback</code></strong>。它们虽小，却能在关键时刻显著提升应用性能与用户体验。</p>
<p>本文将结合具体代码示例，深入剖析这两个 Hook 的原理、使用场景及最佳实践。</p>
<hr/>
<h3 data-id="heading-1">一、为什么需要性能优化？</h3>
<p>React 的核心理念是“<strong>状态驱动视图</strong>”。当组件的状态（state）或属性（props）发生变化时，组件函数会重新执行，生成新的 JSX。这种机制简洁高效，但也带来潜在性能隐患：</p>
<ul>
<li><strong>昂贵的计算重复执行</strong>：如过滤大量数据、复杂数学运算等。</li>
<li><strong>子组件无谓重渲染</strong>：即使 props 未变，父组件更新仍会触发子组件重新渲染。</li>
</ul>
<p>若不加以控制，这些冗余操作会拖慢应用响应速度，尤其在低端设备或大型列表场景下更为明显。</p>
<hr/>
<h3 data-id="heading-2">二、<code>useMemo</code>：缓存计算结果</h3>
<h4 data-id="heading-3">1. 问题场景</h4>
<p>假设我们有一个水果列表，并根据用户输入的关键词进行过滤：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">list</span> = [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'peach'</span>]<span class="hljs-comment">;</span>
const <span class="hljs-section">[keyword, setKeyword]</span> = useState('')<span class="hljs-comment">;</span>
const <span class="hljs-attr">filterList</span> = list.filter(item =&gt; item.includes(keyword))<span class="hljs-comment">;</span>
</code></pre>
<p>表面看没问题，但若组件中还有另一个无关状态（如 <code>count</code>）：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);
</code></pre>
<p>当点击“+1”按钮更新 <code>count</code> 时，整个 <code>App</code> 组件重新运行，<code>filterList</code> 也会被重新计算——<strong>尽管 <code>keyword</code> 并未改变</strong>！这不仅浪费 CPU 资源，还可能引发视觉闪烁等问题。</p>
<h4 data-id="heading-4">2. <code>useMemo</code> 的解决方案</h4>
<p><code>useMemo</code> 允许我们将<strong>计算过程缓存起来</strong>，仅在依赖项变化时才重新计算：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">filterList</span> = useMemo(() =&gt; {
  console.log('filter 执行了')<span class="hljs-comment">;</span>
  return list.filter(<span class="hljs-attr">item</span> =&gt; item.includes(keyword))<span class="hljs-comment">;</span>
}, <span class="hljs-section">[keyword]</span>)<span class="hljs-comment">; // 仅当 keyword 变化时重新计算</span>
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：第二个参数是依赖数组。只有数组中的值发生变化，才会触发重新计算。</p>
</blockquote>
<h4 data-id="heading-5">3. 处理昂贵计算</h4>
<p>对于更复杂的场景，比如计算大数累加：</p>
<pre><code class="hljs language-ini" lang="ini">function slowSum(n) {
  let <span class="hljs-attr">sum</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n * 1000000; i++) {</span>
    sum += i<span class="hljs-comment">;</span>
  }
  return sum<span class="hljs-comment">;</span>
}
</code></pre>
<p>若直接调用 <code>slowSum(num)</code>，每次组件更新都会卡顿。使用 <code>useMemo</code> 可有效避免：</p>
<pre><code class="hljs language-scss" lang="scss">const result = <span class="hljs-built_in">useMemo</span>(() =&gt; <span class="hljs-built_in">slowSum</span>(num), <span class="hljs-selector-attr">[num]</span>);
</code></pre>
<p>这样，只有 <code>num</code> 改变时才会执行耗时运算，极大提升流畅度。</p>
<h4 data-id="heading-6">4. 注意事项</h4>
<ul>
<li><strong>不要滥用</strong>：简单计算（如 <code>a + b</code>）无需 <code>useMemo</code>，反而增加内存开销。</li>
<li><strong>依赖项必须完整</strong>：遗漏依赖会导致使用过期值。</li>
<li><strong><code>includes("")</code> 返回 true</strong>：空字符串匹配所有项，需额外处理边界情况（如 <code>keyword.trim()</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-7">三、<code>useCallback</code>：缓存函数引用</h3>
<h4 data-id="heading-8">1. 子组件重渲染问题</h4>
<p>考虑以下父子组件结构：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'click'</span>);
};

<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;count +1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{count}</span> <span class="hljs-attr">handleClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span>
  <span class="hljs-tag">&lt;/&gt;</span></span>
);
</code></pre>
<p>每次父组件更新（如修改 <code>num</code>），<code>handleClick</code> 都会<strong>重新创建一个新函数</strong>。即使 <code>count</code> 没变，<code>Child</code> 组件因接收到新的 <code>handleClick</code> 引用，也会被强制重渲染。</p>
<h4 data-id="heading-9">2. <code>memo</code> + <code>useCallback</code> 的组合拳</h4>
<h5 data-id="heading-10">步骤一：用 <code>memo</code> 包裹子组件</h5>
<p><code>memo</code> 是一个高阶组件（HOC），它会对 props 进行浅比较。若 props 未变，则跳过渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ count, handleClick }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child 重新渲染'</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>子组件 {count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
});
</code></pre>
<h5 data-id="heading-11">步骤二：用 <code>useCallback</code> 缓存回调函数</h5>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">handleClick</span> = useCallback(() =&gt; {
  console.log('click')<span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">; // 无依赖，函数引用永久不变</span>
</code></pre>
<p>现在，只有当 <code>count</code> 改变时，<code>Child</code> 才会更新；修改 <code>num</code> 不再触发子组件重渲染。</p>
<h4 data-id="heading-12">3. 依赖项的正确使用</h4>
<p>若回调函数依赖某个状态，必须将其加入依赖数组：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">handleClick</span> = useCallback(() =&gt; {
  console.log('当前 count:', count)<span class="hljs-comment">;</span>
}, <span class="hljs-section">[count]</span>)<span class="hljs-comment">; // 依赖 count</span>
</code></pre>
<p>否则，函数内部会捕获旧的 <code>count</code> 值（闭包陷阱）。</p>
<blockquote>
<p>💡 <strong>设计哲学</strong>：React 的数据流是“父管状态，子管展示”。通过 <code>memo</code> + <code>useCallback</code>，我们确保子组件仅在必要时更新，符合单一职责原则。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">四、<code>useMemo</code> vs <code>useCallback</code>：本质区别</h3>
<p>虽然两者都用于缓存，但用途不同：</p>




















<table><thead><tr><th>Hook</th><th>用途</th><th>返回值</th></tr></thead><tbody><tr><td><code>useMemo</code></td><td>缓存<strong>计算结果</strong></td><td>值（如数组、对象、数字）</td></tr><tr><td><code>useCallback</code></td><td>缓存<strong>函数引用</strong></td><td>函数</td></tr></tbody></table>
<p>实际上，<code>useCallback(fn, deps)</code> 等价于 <code>useMemo(() =&gt; fn, deps)</code>。但语义上，<code>useCallback</code> 更清晰表达“这是一个回调函数”。</p>
<hr/>
<h3 data-id="heading-14">五、何时使用？何时避免？</h3>
<h4 data-id="heading-15">推荐使用场景：</h4>
<ul>
<li>
<p><strong><code>useMemo</code></strong>：</p>
<ul>
<li>过滤/排序大型列表；</li>
<li>复杂数学或逻辑计算；</li>
<li>创建不可变对象（如 <code>{ ... }</code>）传递给子组件。</li>
</ul>
</li>
<li>
<p><strong><code>useCallback</code></strong>：</p>
<ul>
<li>传递给 <code>memo</code> 包裹的子组件的事件处理器；</li>
<li>作为 <code>useEffect</code> 的依赖项（避免无限循环）；</li>
<li>传递给第三方库（如 <code>react-window</code> 的 <code>itemData</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-16">避免滥用：</h4>
<ul>
<li>简单组件无需优化；</li>
<li>过度使用会增加内存占用和代码复杂度；</li>
<li>先用性能分析工具（如 React DevTools Profiler）定位瓶颈，再针对性优化。</li>
</ul>
<hr/>
<h3 data-id="heading-17">六、总结</h3>
<p><code>useMemo</code> 和 <code>useCallback</code> 是 React 性能优化的重要工具，它们通过<strong>缓存机制</strong>减少不必要的计算与渲染：</p>
<ul>
<li><strong><code>useMemo</code></strong> 解决“重复计算”问题，适用于派生数据；</li>
<li><strong><code>useCallback</code></strong> 解决“函数引用变化”问题，常与 <code>memo</code> 配合使用，防止子组件无谓更新。</li>
</ul>
<p>掌握它们的关键在于理解 <strong>“依赖项”</strong> 的作用：<strong>只有依赖变化时，才重新计算或生成新函数</strong>。合理使用这两个 Hook，不仅能提升应用性能，还能写出更清晰、可维护的代码。</p>
<p>记住：<strong>优化不是目的，而是手段</strong>。在保证功能正确的前提下，针对真实性能瓶颈进行精准优化，才是工程化的最佳实践。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 Vue 中保存页面状态的完整指南：让用户永远不丢失进度]]></title>    <link>https://juejin.cn/post/7591728734982963227</link>    <guid>https://juejin.cn/post/7591728734982963227</guid>    <pubDate>2026-01-05T15:05:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591728734982963227" data-draft-id="7591713442399322121" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 Vue 中保存页面状态的完整指南：让用户永远不丢失进度"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-05T15:05:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 Vue 中保存页面状态的完整指南：让用户永远不丢失进度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T15:05:57.000Z" title="Mon Jan 05 2026 15:05:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：为什么需要保存页面状态？</h2>
<p>作为前端开发者，你一定遇到过这样的场景：用户在一个复杂的表单页面填写了大量信息，不小心刷新了页面或点击了返回按钮，所有数据都消失了！用户只能无奈地重新填写...</p>
<p><strong>保存页面状态不仅仅是技术需求，更是提升用户体验的关键</strong>。今天我们来深入探讨在 Vue 中实现页面状态保存的各种方法。</p>
<h2 data-id="heading-1">一、应用场景分析</h2>
<p>在我们开始技术实现之前，先看看哪些场景需要状态保存：</p>
<ol>
<li>1. <strong>复杂表单页面</strong>：用户填写了一半的表单</li>
<li>2. <strong>数据筛选页面</strong>：用户设置了复杂的筛选条件</li>
<li>3. <strong>分页列表</strong>：用户浏览到第5页，返回后希望还在第5页</li>
<li>4. <strong>多步骤流程</strong>：购物车结算流程、注册流程</li>
<li>5. <strong>用户偏好设置</strong>：主题、语言、布局等</li>
</ol>
<h2 data-id="heading-2">二、技术方案对比</h2>
<h3 data-id="heading-3">方案对比流程图</h3>
<pre><code class="hljs">少量简单数据

大量复杂数据

临时会话数据

需要服务端同步

需要保存页面状态数据特点LocalStorageVuex/Pinia + 持久化SessionStorageIndexedDB + 后端API刷新/关闭后仍存在全局状态管理仅当前会话离线可用
</code></pre>
<h2 data-id="heading-4">三、具体实现方法</h2>
<h3 data-id="heading-5">方法1：使用 localStorage 保存简单状态</h3>
<p><strong>适用场景</strong>：数据量小、结构简单的状态保存</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>用户信息表单<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">form</span> @<span class="hljs-attr">submit.prevent</span>=<span class="hljs-string">"handleSubmit"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>姓名：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
          <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.name"</span> 
          @<span class="hljs-attr">input</span>=<span class="hljs-string">"saveToLocalStorage"</span>
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入姓名"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>邮箱：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
          <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.email"</span>
          @<span class="hljs-attr">input</span>=<span class="hljs-string">"saveToLocalStorage"</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span>
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入邮箱"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">label</span>&gt;</span>备注：<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> 
          <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.remarks"</span>
          @<span class="hljs-attr">input</span>=<span class="hljs-string">"saveToLocalStorage"</span>
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入备注信息"</span>
        &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"clearStorage"</span>&gt;</span>清除缓存<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'UserForm'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">formData</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">remarks</span>: <span class="hljs-string">''</span>
      }
    }
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 组件加载时从 localStorage 恢复数据</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">restoreFromLocalStorage</span>()
    
    <span class="hljs-comment">// 监听页面卸载事件，确保离开前保存</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveToLocalStorage</span>)
  },
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 清理事件监听</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveToLocalStorage</span>)
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 保存到 localStorage</span>
    <span class="hljs-title function_">saveToLocalStorage</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'userFormData'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>))
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据已保存到本地存储'</span>)
    },
    
    <span class="hljs-comment">// 从 localStorage 恢复</span>
    <span class="hljs-title function_">restoreFromLocalStorage</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> savedData = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'userFormData'</span>)
      <span class="hljs-keyword">if</span> (savedData) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(savedData)
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据已从本地存储恢复'</span>)
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'恢复数据失败:'</span>, error)
        }
      }
    },
    
    <span class="hljs-comment">// 处理表单提交</span>
    <span class="hljs-title function_">handleSubmit</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'提交数据:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>)
      <span class="hljs-comment">// 提交成功后清除缓存</span>
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'userFormData'</span>)
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'提交成功！本地缓存已清除。'</span>)
    },
    
    <span class="hljs-comment">// 清除缓存</span>
    <span class="hljs-title function_">clearStorage</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'userFormData'</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span> = { <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">remarks</span>: <span class="hljs-string">''</span> }
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'缓存已清除'</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">方法2：Vuex + 持久化插件方案</h3>
<p><strong>适用场景</strong>：大型应用，需要全局状态管理</p>
<p><strong>第一步：安装必要依赖</strong></p>
<pre><code class="hljs">npm install vuex-persistedstate
</code></pre>
<p><strong>第二步：创建 Vuex Store 并配置持久化</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// store/index.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vuex</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>
<span class="hljs-keyword">import</span> createPersistedState <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex-persistedstate'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Vuex</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
  <span class="hljs-attr">state</span>: {
    <span class="hljs-attr">userPreferences</span>: {
      <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span>,
      <span class="hljs-attr">language</span>: <span class="hljs-string">'zh-CN'</span>,
      <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>
    },
    <span class="hljs-attr">shoppingCart</span>: [],
    <span class="hljs-attr">formStates</span>: {} <span class="hljs-comment">// 存储各个表单的状态</span>
  },
  
  <span class="hljs-attr">mutations</span>: {
    <span class="hljs-title function_">SET_USER_PREFERENCE</span>(<span class="hljs-params">state, { key, value }</span>) {
      <span class="hljs-keyword">if</span> (state.<span class="hljs-property">userPreferences</span>.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
        state.<span class="hljs-property">userPreferences</span>[key] = value
      }
    },
    
    <span class="hljs-title function_">ADD_TO_CART</span>(<span class="hljs-params">state, product</span>) {
      <span class="hljs-keyword">const</span> existingItem = state.<span class="hljs-property">shoppingCart</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === product.<span class="hljs-property">id</span>)
      <span class="hljs-keyword">if</span> (existingItem) {
        existingItem.<span class="hljs-property">quantity</span> += product.<span class="hljs-property">quantity</span> || <span class="hljs-number">1</span>
      } <span class="hljs-keyword">else</span> {
        state.<span class="hljs-property">shoppingCart</span>.<span class="hljs-title function_">push</span>({ ...product, <span class="hljs-attr">quantity</span>: product.<span class="hljs-property">quantity</span> || <span class="hljs-number">1</span> })
      }
    },
    
    <span class="hljs-title function_">SAVE_FORM_STATE</span>(<span class="hljs-params">state, { formId, data }</span>) {
      state.<span class="hljs-property">formStates</span>[formId] = data
    },
    
    <span class="hljs-title function_">CLEAR_FORM_STATE</span>(<span class="hljs-params">state, formId</span>) {
      <span class="hljs-keyword">if</span> (state.<span class="hljs-property">formStates</span>[formId]) {
        <span class="hljs-keyword">delete</span> state.<span class="hljs-property">formStates</span>[formId]
      }
    }
  },
  
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">saveFormState</span>(<span class="hljs-params">{ commit }, payload</span>) {
      <span class="hljs-title function_">commit</span>(<span class="hljs-string">'SAVE_FORM_STATE'</span>, payload)
    },
    
    <span class="hljs-comment">// 清除过期数据（例如24小时前的数据）</span>
    <span class="hljs-title function_">clearExpiredStates</span>(<span class="hljs-params">{ state, commit }</span>) {
      <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
      <span class="hljs-keyword">const</span> expirationTime = <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 24小时</span>
      
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(state.<span class="hljs-property">formStates</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">formId</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> formData = state.<span class="hljs-property">formStates</span>[formId]
        <span class="hljs-keyword">if</span> (formData.<span class="hljs-property">_timestamp</span> &amp;&amp; now - formData.<span class="hljs-property">_timestamp</span> &gt; expirationTime) {
          <span class="hljs-title function_">commit</span>(<span class="hljs-string">'CLEAR_FORM_STATE'</span>, formId)
        }
      })
    }
  },
  
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">getFormState</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">formId</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> state.<span class="hljs-property">formStates</span>[formId] || <span class="hljs-literal">null</span>
    },
    
    <span class="hljs-attr">cartTotalItems</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> state.<span class="hljs-property">shoppingCart</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">total, item</span>) =&gt;</span> total + item.<span class="hljs-property">quantity</span>, <span class="hljs-number">0</span>)
    }
  },
  
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">createPersistedState</span>({
      <span class="hljs-attr">key</span>: <span class="hljs-string">'vuex-app-state'</span>,
      <span class="hljs-attr">paths</span>: [
        <span class="hljs-string">'userPreferences'</span>,
        <span class="hljs-string">'shoppingCart'</span>,
        <span class="hljs-string">'formStates'</span>
      ],
      
      <span class="hljs-comment">// 自定义存储方式，可以添加加密</span>
      <span class="hljs-attr">storage</span>: {
        <span class="hljs-attr">getItem</span>: <span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> data = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key)
          <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 这里可以添加解密逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data)
          } <span class="hljs-keyword">catch</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
          }
        },
        <span class="hljs-attr">setItem</span>: <span class="hljs-function">(<span class="hljs-params">key, value</span>) =&gt;</span> {
          <span class="hljs-comment">// 这里可以添加加密逻辑</span>
          <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value))
        },
        <span class="hljs-attr">removeItem</span>: <span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key)
      },
      
      <span class="hljs-comment">// 数据过滤，可以排除不需要持久化的数据</span>
      <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> { formStates, ...rest } = state
        
        <span class="hljs-comment">// 过滤掉时间戳字段</span>
        <span class="hljs-keyword">const</span> filteredFormStates = {}
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(formStates).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> { _timestamp, ...formData } = formStates[key]
          filteredFormStates[key] = formData
        })
        
        <span class="hljs-keyword">return</span> {
          ...rest,
          <span class="hljs-attr">formStates</span>: filteredFormStates
        }
      }
    })
  ]
})
</code></pre>
<p><strong>第三步：在组件中使用</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ProductList.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"product-list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>商品列表<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"products"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
        <span class="hljs-attr">v-for</span>=<span class="hljs-string">"product in products"</span> 
        <span class="hljs-attr">:key</span>=<span class="hljs-string">"product.id"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"product-card"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{{ product.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>价格: ¥{{ product.price }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"addToCart(product)"</span>&gt;</span>
          加入购物车
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 购物车预览 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"cart-preview"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>购物车 ({{ cartTotalItems }}件商品)<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"goToCart"</span>&gt;</span>去结算<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { mapMutations, mapGetters } <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'ProductList'</span>,
  
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">products</span>: [
        { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'商品A'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'商品B'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">200</span> },
        { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'商品C'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">300</span> }
      ]
    }
  },
  
  <span class="hljs-attr">computed</span>: {
    ...<span class="hljs-title function_">mapGetters</span>([<span class="hljs-string">'cartTotalItems'</span>])
  },
  
  <span class="hljs-attr">methods</span>: {
    ...<span class="hljs-title function_">mapMutations</span>([<span class="hljs-string">'ADD_TO_CART'</span>]),
    
    <span class="hljs-title function_">addToCart</span>(<span class="hljs-params">product</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">ADD_TO_CART</span>({
        ...product,
        <span class="hljs-attr">quantity</span>: <span class="hljs-number">1</span>
      })
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'已添加到购物车！刷新页面或重新打开浏览器，购物车数据仍然存在。'</span>)
    },
    
    <span class="hljs-title function_">goToCart</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/cart'</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">方法3：使用路由守卫保存页面状态</h3>
<p><strong>适用场景</strong>：基于路由的页面状态保存</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// router/index.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueRouter</span>)

<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/form'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'FormPage'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'../views/FormPage.vue'</span>),
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">keepAlive</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 需要缓存</span>
      <span class="hljs-attr">saveState</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 需要保存状态</span>
    }
  },
  <span class="hljs-comment">// ...其他路由</span>
]

<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueRouter</span>({
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'history'</span>,
  routes
})

<span class="hljs-comment">// 页面状态缓存对象</span>
<span class="hljs-keyword">const</span> pageStateCache = {}

<span class="hljs-comment">// 全局前置守卫</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 离开需要保存状态的页面时，保存当前页面状态</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">from</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">saveState</span>) {
    <span class="hljs-title function_">savePageState</span>(<span class="hljs-keyword">from</span>)
  }
  
  <span class="hljs-title function_">next</span>()
})

<span class="hljs-comment">// 全局后置守卫</span>
router.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {
  <span class="hljs-comment">// 进入需要恢复状态的页面时，恢复页面状态</span>
  <span class="hljs-keyword">if</span> (to.<span class="hljs-property">meta</span>.<span class="hljs-property">saveState</span>) {
    <span class="hljs-title function_">restorePageState</span>(to)
  }
})

<span class="hljs-comment">/**
 * 保存页面状态
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">savePageState</span>(<span class="hljs-params">route</span>) {
  <span class="hljs-keyword">const</span> pageKey = <span class="hljs-title function_">getPageKey</span>(route)
  <span class="hljs-keyword">const</span> stateToSave = {
    <span class="hljs-attr">scrollPosition</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageYOffset</span>,
    <span class="hljs-attr">formData</span>: <span class="hljs-title function_">getFormDataFromPage</span>(),
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
  }
  
  pageStateCache[pageKey] = stateToSave
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">`pageState_<span class="hljs-subst">${pageKey}</span>`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(stateToSave))
}

<span class="hljs-comment">/**
 * 恢复页面状态
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">restorePageState</span>(<span class="hljs-params">route</span>) {
  <span class="hljs-keyword">const</span> pageKey = <span class="hljs-title function_">getPageKey</span>(route)
  <span class="hljs-keyword">let</span> state
  
  <span class="hljs-comment">// 先从内存缓存中获取</span>
  <span class="hljs-keyword">if</span> (pageStateCache[pageKey]) {
    state = pageStateCache[pageKey]
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 内存中没有则从localStorage获取</span>
    <span class="hljs-keyword">const</span> savedState = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">`pageState_<span class="hljs-subst">${pageKey}</span>`</span>)
    <span class="hljs-keyword">if</span> (savedState) {
      <span class="hljs-keyword">try</span> {
        state = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(savedState)
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'恢复页面状态失败:'</span>, e)
      }
    }
  }
  
  <span class="hljs-keyword">if</span> (state) {
    <span class="hljs-comment">// 恢复滚动位置</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">scrollPosition</span>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>(<span class="hljs-number">0</span>, state.<span class="hljs-property">scrollPosition</span>)
      }, <span class="hljs-number">100</span>)
    }
    
    <span class="hljs-comment">// 恢复表单数据</span>
    <span class="hljs-keyword">if</span> (state.<span class="hljs-property">formData</span>) {
      <span class="hljs-title function_">restoreFormDataToPage</span>(state.<span class="hljs-property">formData</span>)
    }
  }
}

<span class="hljs-comment">/**
 * 生成页面唯一标识
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPageKey</span>(<span class="hljs-params">route</span>) {
  <span class="hljs-keyword">return</span> route.<span class="hljs-property">path</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(route.<span class="hljs-property">query</span>) + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(route.<span class="hljs-property">params</span>)
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<h3 data-id="heading-8">方法4：使用 keep-alive 组件缓存组件实例</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 使用keep-alive缓存需要保持状态的组件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">keep-alive</span> <span class="hljs-attr">:include</span>=<span class="hljs-string">"cachedComponents"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"$route.meta.keepAlive"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">keep-alive</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 不需要缓存的组件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!$route.meta.keepAlive"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'App'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">cachedComponents</span>: [<span class="hljs-string">'ProductList'</span>, <span class="hljs-string">'UserForm'</span>] <span class="hljs-comment">// 需要缓存的组件名</span>
    }
  },
  
  <span class="hljs-comment">// 使用keep-alive的组件会触发这些生命周期</span>
  <span class="hljs-title function_">beforeRouteLeave</span>(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) {
    <span class="hljs-comment">// 在离开前可以保存一些数据</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveState</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveState</span>()
    }
    <span class="hljs-title function_">next</span>()
  },
  
  <span class="hljs-title function_">activated</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 组件被激活时调用</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件被激活，可以恢复状态'</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">restoreState</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">restoreState</span>()
  },
  
  <span class="hljs-title function_">deactivated</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 组件被停用时调用</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件被停用，可以保存状态'</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveState</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveState</span>()
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-9">四、高级方案：IndexedDB 存储大量数据</h2>
<p>当需要存储大量数据或复杂对象时，IndexedDB 是更好的选择。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/db.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StateDB</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">dbName = <span class="hljs-string">'VueAppState'</span>, version = <span class="hljs-number">1</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dbName</span> = dbName
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">version</span> = version
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span> = <span class="hljs-literal">null</span>
  }

  <span class="hljs-comment">// 打开数据库</span>
  <span class="hljs-title function_">open</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> request = indexedDB.<span class="hljs-title function_">open</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dbName</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">version</span>)

      request.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(request.<span class="hljs-property">error</span>)
      request.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span> = request.<span class="hljs-property">result</span>
        <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>)
      }

      request.<span class="hljs-property">onupgradeneeded</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> db = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>
        
        <span class="hljs-comment">// 创建对象存储空间</span>
        <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">'pageStates'</span>)) {
          <span class="hljs-keyword">const</span> store = db.<span class="hljs-title function_">createObjectStore</span>(<span class="hljs-string">'pageStates'</span>, { <span class="hljs-attr">keyPath</span>: <span class="hljs-string">'id'</span> })
          store.<span class="hljs-title function_">createIndex</span>(<span class="hljs-string">'timestamp'</span>, <span class="hljs-string">'timestamp'</span>, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">false</span> })
        }
        
        <span class="hljs-keyword">if</span> (!db.<span class="hljs-property">objectStoreNames</span>.<span class="hljs-title function_">contains</span>(<span class="hljs-string">'userData'</span>)) {
          db.<span class="hljs-title function_">createObjectStore</span>(<span class="hljs-string">'userData'</span>, { <span class="hljs-attr">keyPath</span>: <span class="hljs-string">'key'</span> })
        }
      }
    })
  }

  <span class="hljs-comment">// 保存页面状态</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">savePageState</span>(<span class="hljs-params">pageId, state</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>) <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">open</span>()
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> transaction = <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">transaction</span>([<span class="hljs-string">'pageStates'</span>], <span class="hljs-string">'readwrite'</span>)
      <span class="hljs-keyword">const</span> store = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">'pageStates'</span>)
      
      <span class="hljs-keyword">const</span> record = {
        <span class="hljs-attr">id</span>: pageId,
        <span class="hljs-attr">state</span>: state,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
      }
      
      <span class="hljs-keyword">const</span> request = store.<span class="hljs-title function_">put</span>(record)
      
      request.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>()
      request.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(request.<span class="hljs-property">error</span>)
    })
  }

  <span class="hljs-comment">// 获取页面状态</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getPageState</span>(<span class="hljs-params">pageId</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>) <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">open</span>()
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> transaction = <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">transaction</span>([<span class="hljs-string">'pageStates'</span>], <span class="hljs-string">'readonly'</span>)
      <span class="hljs-keyword">const</span> store = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">'pageStates'</span>)
      <span class="hljs-keyword">const</span> request = store.<span class="hljs-title function_">get</span>(pageId)
      
      request.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(request.<span class="hljs-property">result</span>?.<span class="hljs-property">state</span>)
      request.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(request.<span class="hljs-property">error</span>)
    })
  }

  <span class="hljs-comment">// 清理过期数据（超过7天）</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">cleanupOldStates</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>) <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">open</span>()
    
    <span class="hljs-keyword">const</span> sevenDaysAgo = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - (<span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> transaction = <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">transaction</span>([<span class="hljs-string">'pageStates'</span>], <span class="hljs-string">'readwrite'</span>)
      <span class="hljs-keyword">const</span> store = transaction.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">'pageStates'</span>)
      <span class="hljs-keyword">const</span> index = store.<span class="hljs-title function_">index</span>(<span class="hljs-string">'timestamp'</span>)
      <span class="hljs-keyword">const</span> range = <span class="hljs-title class_">IDBKeyRange</span>.<span class="hljs-title function_">upperBound</span>(sevenDaysAgo)
      
      <span class="hljs-keyword">const</span> request = index.<span class="hljs-title function_">openCursor</span>(range)
      
      request.<span class="hljs-property">onsuccess</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> cursor = event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>
        <span class="hljs-keyword">if</span> (cursor) {
          cursor.<span class="hljs-title function_">delete</span>()
          cursor.<span class="hljs-title function_">continue</span>()
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">resolve</span>()
        }
      }
      
      request.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(request.<span class="hljs-property">error</span>)
    })
  }
}

<span class="hljs-comment">// 创建单例实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> stateDB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateDB</span>()

<span class="hljs-comment">// 在 Vue 插件中使用</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">StatePersistencePlugin</span> = {
  <span class="hljs-title function_">install</span>(<span class="hljs-params">Vue</span>) {
    <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$stateDB</span> = stateDB
    
    <span class="hljs-comment">// 混入方法到所有组件</span>
    <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">mixin</span>({
      <span class="hljs-attr">methods</span>: {
        <span class="hljs-keyword">async</span> <span class="hljs-title function_">saveComponentState</span>(<span class="hljs-params">stateKey, data</span>) {
          <span class="hljs-keyword">const</span> componentId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">name</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>?.<span class="hljs-property">path</span> || <span class="hljs-string">'unknown'</span>
          <span class="hljs-keyword">const</span> fullKey = <span class="hljs-string">`<span class="hljs-subst">${componentId}</span>_<span class="hljs-subst">${stateKey}</span>`</span>
          
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$stateDB</span>.<span class="hljs-title function_">savePageState</span>(fullKey, {
              data,
              <span class="hljs-attr">savedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
            })
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`状态已保存: <span class="hljs-subst">${fullKey}</span>`</span>)
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'保存状态失败:'</span>, error)
          }
        },
        
        <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadComponentState</span>(<span class="hljs-params">stateKey</span>) {
          <span class="hljs-keyword">const</span> componentId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">name</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>?.<span class="hljs-property">path</span> || <span class="hljs-string">'unknown'</span>
          <span class="hljs-keyword">const</span> fullKey = <span class="hljs-string">`<span class="hljs-subst">${componentId}</span>_<span class="hljs-subst">${stateKey}</span>`</span>
          
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> state = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$stateDB</span>.<span class="hljs-title function_">getPageState</span>(fullKey)
            <span class="hljs-keyword">return</span> state?.<span class="hljs-property">data</span> || <span class="hljs-literal">null</span>
          } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'加载状态失败:'</span>, error)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
          }
        }
      }
    })
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">StatePersistencePlugin</span>
</code></pre>
<h2 data-id="heading-10">五、最佳实践总结</h2>
<h3 data-id="heading-11">1. <strong>分层存储策略</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 根据数据类型选择不同的存储方式</span>
<span class="hljs-keyword">const</span> storageStrategy = {
  <span class="hljs-comment">// 用户设置：永久存储</span>
  <span class="hljs-attr">userPreferences</span>: <span class="hljs-variable language_">localStorage</span>,
  
  <span class="hljs-comment">// 购物车：IndexedDB + 服务端同步</span>
  <span class="hljs-attr">shoppingCart</span>: {
    <span class="hljs-attr">local</span>: indexedDB,
    <span class="hljs-attr">remote</span>: <span class="hljs-string">'api/cart'</span>
  },
  
  <span class="hljs-comment">// 表单草稿：sessionStorage（会话级）</span>
  <span class="hljs-attr">formDraft</span>: sessionStorage,
  
  <span class="hljs-comment">// 页面滚动位置：内存缓存</span>
  <span class="hljs-attr">scrollPosition</span>: <span class="hljs-string">'memory'</span>
}
</code></pre>
<h3 data-id="heading-12">2. <strong>数据版本管理</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 添加版本控制，避免数据结构变化导致的问题</span>
<span class="hljs-keyword">const</span> saveWithVersion = (key, <span class="hljs-keyword">data</span>) =&gt; {
  <span class="hljs-keyword">const</span> payload = {
    version: <span class="hljs-string">'1.0.0'</span>,
    savedAt: new Date().toISOString(),
    <span class="hljs-keyword">data</span>: <span class="hljs-keyword">data</span>
  }
  localStorage.setItem(key, JSON.stringify(payload))
}

<span class="hljs-keyword">const</span> loadWithVersion = (key, currentVersion = <span class="hljs-string">'1.0.0'</span>) =&gt; {
  <span class="hljs-keyword">const</span> saved = localStorage.getItem(key)
  <span class="hljs-keyword">if</span> (!saved) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { version, <span class="hljs-keyword">data</span> } = JSON.parse(saved)
    
    <span class="hljs-comment">// 版本迁移逻辑</span>
    <span class="hljs-keyword">if</span> (version !== currentVersion) {
      <span class="hljs-keyword">return</span> migrateData(<span class="hljs-keyword">data</span>, version, currentVersion)
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
  }
}
</code></pre>
<h3 data-id="heading-13">3. <strong>自动保存与防抖优化</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">formData</span>: {},
      <span class="hljs-attr">autoSaveEnabled</span>: <span class="hljs-literal">true</span>
    }
  },
  
  <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 使用防抖避免频繁保存</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debouncedSave</span> = <span class="hljs-title function_">debounce</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveFormState</span>, <span class="hljs-number">1000</span>)
  },
  
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-attr">formData</span>: {
      <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-title function_">handler</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">autoSaveEnabled</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">debouncedSave</span>()
        }
      }
    }
  },
  
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">saveFormState</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 保存逻辑</span>
    }
  }
}
</code></pre>
<h2 data-id="heading-14">六、安全注意事项</h2>
<ol>
<li>
<p>1. <strong>敏感信息不要保存在客户端</strong></p>
</li>
<li>
<ul>
<li>• 密码、token等敏感信息避免本地存储</li>
<li>• 必要时使用加密存储</li>
</ul>
</li>
<li>
<p>2. <strong>数据清理机制</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定期清理过期数据</span>
<span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> oneDayAgo = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">localStorage</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'temp_'</span>)) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> item = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key))
        <span class="hljs-keyword">if</span> (item.<span class="hljs-property">timestamp</span> &amp;&amp; item.<span class="hljs-property">timestamp</span> &lt; oneDayAgo) {
          <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key)
        }
      } <span class="hljs-keyword">catch</span> {}
    }
  })
}, <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) <span class="hljs-comment">// 每小时清理一次</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-15">结语</h2>
<p>保存页面状态是提升 Vue 应用用户体验的关键技术。根据不同的场景需求，我们可以选择：</p>
<ul>
<li>• <strong>简单场景</strong>：使用 localStorage 或 sessionStorage</li>
<li>• <strong>复杂应用</strong>：Vuex/Pinia + 持久化插件</li>
<li>• <strong>大量数据</strong>：IndexedDB 存储</li>
<li>• <strong>组件缓存</strong>：keep-alive + 路由守卫</li>
</ul>
<p>记住，最好的方案是<strong>分层存储、按需使用</strong>。合理使用状态保存，让你的 Vue 应用更加友好和健壮！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[依赖预构建]]></title>    <link>https://juejin.cn/post/7591702898080301071</link>    <guid>https://juejin.cn/post/7591702898080301071</guid>    <pubDate>2026-01-05T13:26:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591702898080301071" data-draft-id="7591703562134028322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="依赖预构建"/> <meta itemprop="keywords" content="Vite"/> <meta itemprop="datePublished" content="2026-01-05T13:26:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coderjc"/> <meta itemprop="url" content="https://juejin.cn/user/4279763486908104"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            依赖预构建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4279763486908104/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coderjc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T13:26:08.000Z" title="Mon Jan 05 2026 13:26:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>如果你用过 vite，那么想必对<strong>依赖预构建</strong>这一个名词并不陌生，本文就基于此来进行一些探讨。</p>
<p>PS：本文分析来自于笔者的个人理解，如果发现了错误，可以在进行指正。当然说的是 vite 依赖于 esbuild 和 rollup 的时候，而非 rolldown。</p>
</blockquote>
<h2 data-id="heading-0">为什么需要依赖预构建</h2>
<blockquote>
<p>通常如果要知道为什么需要一个东西，我们首要的前提就是知道“它解决了什么问题？”。这一点其实 vite 的文档已经给出了，主要是两个目的：<strong>规范兼容性</strong>和<strong>性能</strong>。</p>
</blockquote>
<h3 data-id="heading-1">性能</h3>
<p>我们知道，浏览器是可以通过给 script 标签添加 type="module" 来让其支持模块化的导入，所以，我简单写了一个 demo，demo 的结果如下：</p>
<pre><code class="hljs language-css" lang="css">依赖预构建
├── <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.js</span>
├── <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.js</span>
├── c<span class="hljs-selector-class">.js</span>
├── index<span class="hljs-selector-class">.html</span>
└── index<span class="hljs-selector-class">.js</span>
</code></pre>
<p>文件内容很简单，只要看一下 index.js 即可，如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { a } <span class="hljs-keyword">from</span> <span class="hljs-string">'./a.js'</span>
<span class="hljs-keyword">import</span> { b } <span class="hljs-keyword">from</span> <span class="hljs-string">'./b.js'</span>
<span class="hljs-keyword">import</span> { c } <span class="hljs-keyword">from</span> <span class="hljs-string">'./c.js'</span>
​
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'index.js -- start'</span>)
​
<span class="hljs-title function_">a</span>()
<span class="hljs-title function_">b</span>()
<span class="hljs-title function_">c</span>()
​
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'index.js -- end'</span>)
</code></pre>
<p>输出为：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.js</span> <span class="hljs-selector-tag">--</span> <span class="hljs-selector-tag">start</span>
<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.js</span>:<span class="hljs-number">2</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.js</span>
<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.js</span>:<span class="hljs-number">2</span> <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.js</span>
<span class="hljs-selector-tag">c</span><span class="hljs-selector-class">.js</span>:<span class="hljs-number">2</span> <span class="hljs-selector-tag">c</span><span class="hljs-selector-class">.js</span>
<span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.js</span>:<span class="hljs-number">11</span> <span class="hljs-selector-tag">index</span><span class="hljs-selector-class">.js</span> <span class="hljs-selector-tag">--</span> <span class="hljs-selector-tag">end</span>
</code></pre>
<p>好像一切都是岁月静好，但是其实它背后存在一个“负担”，我们来打开网络面板就可以看到了，如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c0b8422acb24569a9eb01d4b67fd39f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJqYw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768224367&amp;x-signature=yoD4ASaidkx1ZFLbbgrFPCED%2Ba8%3D" alt="image-20260105003506147.png" loading="lazy"/></p>
<p>三个导入就有三个请求，一个请求就是一个网络开销，而如果是一个成熟的第三方包，一个包就可能会有几十几百个文件的导入，这还是只是一个依赖，实际开发中，我们的项目是不会止步于一个依赖的。所以管中窥豹，就算再本地环境，这个网络开销也很难承受。</p>
<p>可能文字的描述还是略显苍白，那么让我们看一个引入 lodash 的例子，index.js 文件如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 因为这是浏览器环境，所以要知道精确的具体的 js 文件</span>
<span class="hljs-keyword">import</span> { toUpper } <span class="hljs-keyword">from</span> <span class="hljs-string">'./node_modules/lodash-es/lodash.js'</span>
​
<span class="hljs-keyword">const</span> msg = <span class="hljs-string">'hello world'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">toUpper</span>(msg))
​
</code></pre>
<p>请求效果如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f78c374380e34037b11771b1996a6d61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJqYw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768224367&amp;x-signature=QvbaNZIgt6Q%2FYT5%2Fi4RPGLIFKx4%3D" alt="image-20260105005215251.png" loading="lazy"/></p>
<p>可以看到这个数量还是很恐怖的。而如果有依赖预构建呢？我们看一下请求的效果图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f25aee4cbdc4daf985d608fb1e619ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJqYw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768224367&amp;x-signature=k5bFMEkHaaUSLr3UBX52SGHRYl8%3D" alt="image-20260105005717833.png" loading="lazy"/></p>
<p>可以看到，这个 lodash 请求数量都集中到一个文件，那么网络开销就少得多。而虽然这个文件的体积大很多，但是只需要进行一次网络的传输就可以了。这种大家可以尝试用一个较小的 node_modules 目录，进行复制传输或者打包压缩，它的时间比正常大文件的时间要多的多，</p>
<h3 data-id="heading-2">规范兼容性</h3>
<p>性能问题解决了，但还有一个更棘手的问题在等着我们。</p>
<p>不知道你有没有想过，npm 上那些第三方包，它内部用的是什么模块规范？你不知道它是 commonjs 还是 esmodule。</p>
<p>而这就会导致一个比较尴尬的状况，我们来看一个例子，假设某个第三方包 <code>some-package</code> 内部是这样写的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// some-package/index.js</span>
<span class="hljs-keyword">const</span> helper = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./helper.js'</span>)
​
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> helper.<span class="hljs-title function_">process</span>()
  }
}
</code></pre>
<p>当你在项目里 <code>import { doSomething } from 'some-package'</code> 的时候，你敢这么用，浏览器就敢来表演一下罢工，因为它压根不认识 <code>require</code> 和 <code>module.exports</code> 是啥。</p>
<p>所以就需要通过依赖预构建来解决这个问题，它会把这些 CommonJS 格式的代码转换成 ESM 格式，就像一个翻译官，把"方言"翻译成浏览器能听懂的"普通话"。转换后的代码大概如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 预构建后</span>
<span class="hljs-keyword">import</span> helper <span class="hljs-keyword">from</span> <span class="hljs-string">'./helper.js'</span>
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> helper.<span class="hljs-title function_">process</span>()
}
</code></pre>
<h2 data-id="heading-3">最小实现</h2>
<blockquote>
<p>本文对于 esbuild 不会做出过多赘述，有兴趣的读者可以自己去查阅相关资料</p>
</blockquote>
<h3 data-id="heading-4">分析</h3>
<p>通过查看上文的一个截图，我们大概能看出，其实依赖预构建，就是吧 lodash 这个包的函数都打包到了一个文件里面，然后做了一个统一的导出，所以我们来实现的依赖预构建，也就是要完成这一个目标。</p>
<p>要完成这个目标如果采用比较原始的方式，莫过于在 node 中读取入口文件，根据导入的路径去读取文件的内容，写入到一个文件里面，最后添加一端统一的导出字符串。</p>
<p>这种想法好像一看没什么问题，但是其中还是有些问题的，比如入口文件导入的那个依赖文件，它内部还依赖了其他文件，如果只是粗暴的分析一个入口文件，最后的打包的单文件一定是不完整的，而其中还会存在重复的依赖引入，比如一些通用的工具函数，所以我们需要换一种思路。</p>
<p>我们聊的东西本质上就是：<strong>如何从单一入口，递归地构建一个<code>依赖图</code>，并按依赖顺序读取所有模块内容</strong>。因此大概执行的步骤如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 从入口文件的依赖开始，比如 from './add'
<span class="hljs-bullet">2.</span> 再解析 add 内部的 import
<span class="hljs-bullet">3.</span> 后续的依赖文件也执行这个逻辑
<span class="hljs-bullet">4.</span> 直到最后没有新的依赖为止
</code></pre>
<p>生成<strong>依赖图</strong>，为什么是图而不是树呢？毕竟一想到递归，很多情况下大家不约而同的就想到了树结构，树结构如下：</p>
<pre><code class="hljs language-css" lang="css"># 树结构
entry
 ├─ <span class="hljs-selector-tag">a</span>
 │   └─ shared
 └─ <span class="hljs-selector-tag">b</span>
     └─ shared
</code></pre>
<p>那图结构有什么好处？</p>
<ol start="0">
<li>
<p><strong>一个模块可能被多个模块依赖（多父节点）</strong> ：这在真实项目里太常见了，工具函数、运行时垫片、第三方包内部的小工具……树结构天生表达不了“同一个东西被多处引用但只存在一份”。</p>
<p>什么是多父节点，比如：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span><span class="hljs-selector-class">.js</span>  ──┐
        ├──&gt;  utils<span class="hljs-selector-class">.js</span>
<span class="hljs-selector-tag">B</span><span class="hljs-selector-class">.js</span>  ──┘
</code></pre>
<ul>
<li><code>A.js</code> 里 <code>import utils from './utils.js'</code></li>
<li><code>B.js</code> 里 <code>import utils from './utils.js'</code></li>
<li>这个日常中很常见，于是 utils.js 就存在了两个父节点了，这就是多父节点</li>
</ul>
</li>
<li>
<p><strong>循环依赖是存在的</strong>：比如 <code>a</code> import <code>b</code>，<code>b</code> 又 import <code>a</code>。树要求“从上到下不能绕回来”，但依赖关系就是允许绕回来的，所以需要用图来描述，并且用“访问过就不再深入”的方式避免无限递归。</p>
</li>
</ol>
<p>所以这里我们从一开始就用“依赖图”的视角去做：一边递归收集依赖，一边用绝对路径做去重，保证每个模块最多处理一次。</p>
<h3 data-id="heading-5">构建依赖图</h3>
<p>因此第一步让我们来实现一个函数，给我一段文件源码字符串，在使用正则匹配出导入语句，如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">/**
 * 从文件内容中解析所有的 import/export <span class="hljs-keyword">from</span> 语句，提取依赖路径
 */
<span class="hljs-keyword">function</span> parseImports(content) {
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">imports</span> = []
​
    // 匹配 import xxx <span class="hljs-keyword">from</span> <span class="hljs-comment">'xxx' 或 export xxx from 'xxx'</span>
    <span class="hljs-keyword">const</span> importRegex =
        /(?:import|export)\s+(?:[^<span class="hljs-comment">'"]*)\s+from\s+['"]([^'"]+)['"]/g</span>
​
    <span class="hljs-keyword">let</span> match
    <span class="hljs-keyword">while</span> ((match = importRegex.exec(content)) !== null) {
        <span class="hljs-keyword">imports</span>.push(match[<span class="hljs-number">1</span>])
    }
​
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">imports</span>
}
​
// 使用 lodash 的入口文件两个导入代码来做测试
<span class="hljs-keyword">const</span> sourceCode = `export { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> add } <span class="hljs-keyword">from</span> <span class="hljs-comment">'./add.js';</span>
export { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> after } <span class="hljs-keyword">from</span> <span class="hljs-comment">'./after.js';`</span>
console.log(parseImports(sourceCode))
</code></pre>
<p>输入结果如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[ <span class="hljs-string">'./add.js'</span>, <span class="hljs-string">'./after.js'</span> ]</span>
</code></pre>
<p>那么下一步要做的事情就是，实现一个递归遍历函数，来反复执行这个过程，后面的代码就没什么特殊的，可以直接浏览一下相对完全的代码，如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>
​
<span class="hljs-keyword">const</span> entryFilePath = path.<span class="hljs-title function_">join</span>(
    process.<span class="hljs-title function_">cwd</span>(),
    <span class="hljs-string">'./node_modules/lodash-es/lodash.js'</span>
)
​
<span class="hljs-comment">/**
 * 从文件内容中解析所有的 import/export from 语句，提取依赖路径
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parseImports</span>(<span class="hljs-params">content</span>) {
    <span class="hljs-keyword">const</span> imports = []
​
    <span class="hljs-comment">// 匹配 import xxx from 'xxx' 或 export xxx from 'xxx'</span>
    <span class="hljs-keyword">const</span> importRegex =
        <span class="hljs-regexp">/(?:import|export)\s+(?:[^'"]*)\s+from\s+['"]([^'"]+)['"]/g</span>
​
    <span class="hljs-keyword">let</span> match
    <span class="hljs-keyword">while</span> ((match = importRegex.<span class="hljs-title function_">exec</span>(content)) !== <span class="hljs-literal">null</span>) {
        imports.<span class="hljs-title function_">push</span>(match[<span class="hljs-number">1</span>])
    }
​
    <span class="hljs-keyword">return</span> imports
}
​
<span class="hljs-comment">/**
 * 将相对路径解析为绝对路径
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">resolveModulePath</span>(<span class="hljs-params">importPath, currentFilePath</span>) {
    <span class="hljs-keyword">const</span> currentDir = path.<span class="hljs-title function_">dirname</span>(currentFilePath)
    <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">resolve</span>(currentDir, importPath)
}
​
<span class="hljs-comment">/**
 * 递归解析依赖，构建依赖图
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">buildDependencyGraph</span>(<span class="hljs-params">entryPath</span>) {
    <span class="hljs-comment">// 依赖图</span>
    <span class="hljs-keyword">const</span> graph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()
    <span class="hljs-comment">// 已访问过的文件</span>
    <span class="hljs-keyword">const</span> visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
​
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">traverse</span>(<span class="hljs-params">filePath</span>) {
        <span class="hljs-comment">// 规范化路径</span>
        <span class="hljs-keyword">const</span> normalizedPath = path.<span class="hljs-title function_">normalize</span>(filePath)
​
        <span class="hljs-comment">// 已访问过则跳过</span>
        <span class="hljs-keyword">if</span> (visited.<span class="hljs-title function_">has</span>(normalizedPath)) {
            <span class="hljs-keyword">return</span>
        }
​
        visited.<span class="hljs-title function_">add</span>(normalizedPath)
​
        <span class="hljs-comment">// 读取文件内容</span>
        <span class="hljs-keyword">let</span> content
        <span class="hljs-keyword">try</span> {
            content = fs.<span class="hljs-title function_">readFileSync</span>(normalizedPath, <span class="hljs-string">'utf-8'</span>)
        } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`无法读取文件: <span class="hljs-subst">${normalizedPath}</span>`</span>)
            <span class="hljs-keyword">return</span>
        }
​
        <span class="hljs-comment">// 解析 import 语句</span>
        <span class="hljs-keyword">const</span> imports = <span class="hljs-title function_">parseImports</span>(content)
​
        <span class="hljs-comment">// 解析为绝对路径</span>
        <span class="hljs-keyword">const</span> dependencies = imports.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">imp</span> =&gt;</span>
            <span class="hljs-title function_">resolveModulePath</span>(imp, normalizedPath)
        )
​
        <span class="hljs-comment">// 存入依赖图</span>
        graph.<span class="hljs-title function_">set</span>(normalizedPath, dependencies)
​
        <span class="hljs-comment">// 递归处理每个依赖</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dep <span class="hljs-keyword">of</span> dependencies) {
            <span class="hljs-title function_">traverse</span>(dep)
        }
    }
​
    <span class="hljs-title function_">traverse</span>(entryPath)
​
    <span class="hljs-keyword">return</span> graph
}
​
<span class="hljs-comment">// 构建依赖图</span>
<span class="hljs-keyword">const</span> dependencyGraph = <span class="hljs-title function_">buildDependencyGraph</span>(entryFilePath)
​
<span class="hljs-comment">// 输出依赖图信息</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n依赖图构建完成，共 <span class="hljs-subst">${dependencyGraph.size}</span> 个模块\n`</span>)
​
<span class="hljs-comment">// 打印依赖图结构</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [file, deps] <span class="hljs-keyword">of</span> dependencyGraph) {
    <span class="hljs-keyword">const</span> relativePath = path.<span class="hljs-title function_">relative</span>(process.<span class="hljs-title function_">cwd</span>(), file)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`+ <span class="hljs-subst">${relativePath}</span>`</span>)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> dep <span class="hljs-keyword">of</span> deps) {
        <span class="hljs-keyword">const</span> relativeDepPath = path.<span class="hljs-title function_">relative</span>(process.<span class="hljs-title function_">cwd</span>(), dep)
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   └── <span class="hljs-subst">${relativeDepPath}</span>`</span>)
    }
}
</code></pre>
<p>输出如下：</p>
<pre><code class="hljs language-bash" lang="bash">+ node_modules/lodash-es/lodash.js
   └── node_modules/lodash-es/add.js
   └── node_modules/lodash-es/after.js
+ node_modules/lodash-es/add.js
   └── node_modules/lodash-es/_createMathOperation.js
+ node_modules/lodash-es/_createMathOperation.js
   └── node_modules/lodash-es/_baseToNumber.js
   └── node_modules/lodash-es/_baseToString.js
+ node_modules/lodash-es/_baseToNumber.js
   └── node_modules/lodash-es/isSymbol.js
+ node_modules/lodash-es/isSymbol.js
   └── node_modules/lodash-es/_baseGetTag.js
   └── node_modules/lodash-es/isObjectLike.js
+ node_modules/lodash-es/_baseGetTag.js
   └── node_modules/lodash-es/_Symbol.js
   └── node_modules/lodash-es/_getRawTag.js
   └── node_modules/lodash-es/_objectToString.js
+ ...
</code></pre>
<p>有了这个依赖图之后，我们离这个核心就非常接近了，这个依赖图一眼看过去，都不知要如何遍历执行，所以我们还欠缺一个步骤，<strong>拓扑排序</strong>。</p>
<h3 data-id="heading-6">拓扑排序</h3>
<p>如果按照上面依赖图区进行遍历读取，肯定会出现问题的，但是在实际的 bundle 中，就会爆炸，要得到正确的 bundle 就要做到 <strong>所有模块按“依赖先、使用后”的顺序排好队</strong>，而这个排队就是拓扑排序。</p>
<p>而实现的手段不做限制，毕竟在 ai 如此流行的情况，我相信 ai 可以写的很好很完善，还可以解释每一行代码的意义，我这里就直接贴出代码，如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 对依赖图做拓扑排序，返回“依赖在前、被依赖在后”的模块顺序
 */</span>
function <span class="hljs-built_in">topologicalSort</span>(graph) {
    const allNodes = new <span class="hljs-built_in">Set</span>()
​
    for (const [filePath, deps] of graph) {
        allNodes<span class="hljs-selector-class">.add</span>(filePath)
        for (const dep of deps) {
            allNodes<span class="hljs-selector-class">.add</span>(dep)
        }
    }
​
    <span class="hljs-comment">// indegree：一个模块还剩多少“依赖”没有被处理（依赖越多 indegree 越大）</span>
    const indegree = new <span class="hljs-built_in">Map</span>()
    <span class="hljs-comment">// dependents：某个依赖被处理完后，哪些模块可以被推进</span>
    const dependents = new <span class="hljs-built_in">Map</span>()
​
    for (const node of allNodes) {
        indegree<span class="hljs-selector-class">.set</span>(node, <span class="hljs-number">0</span>)
        dependents<span class="hljs-selector-class">.set</span>(node, new Set())
    }
​
    for (const [filePath, deps] of graph) {
        for (const dep of deps) {
            if (!dependents.has(dep)) {
                dependents<span class="hljs-selector-class">.set</span>(dep, new Set())
            }
            dependents<span class="hljs-selector-class">.get</span>(dep)<span class="hljs-selector-class">.add</span>(filePath)
            indegree<span class="hljs-selector-class">.set</span>(filePath, (indegree.get(filePath) ?? <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>)
        }
    }
​
    const queue = <span class="hljs-selector-attr">[]</span>
    for (const node of allNodes) {
        if ((indegree.get(node) ?? <span class="hljs-number">0</span>) === <span class="hljs-number">0</span>) {
            queue<span class="hljs-selector-class">.push</span>(node)
        }
    }
​
    const sorted = <span class="hljs-selector-attr">[]</span>
    let idx = <span class="hljs-number">0</span>
    while (idx &lt; queue.length) {
        const node = queue<span class="hljs-selector-attr">[idx++]</span>
        sorted<span class="hljs-selector-class">.push</span>(node)
​
        const nextNodes = dependents<span class="hljs-selector-class">.get</span>(node)
        if (!nextNodes) continue
​
        for (const next of nextNodes) {
            const nextIn = (indegree.get(next) ?? <span class="hljs-number">0</span>) - <span class="hljs-number">1</span>
            indegree<span class="hljs-selector-class">.set</span>(next, nextIn)
            if (nextIn === <span class="hljs-number">0</span>) {
                queue<span class="hljs-selector-class">.push</span>(next)
            }
        }
    }
​
    if (sorted.length !== allNodes.size) {
        const cyclicNodes = <span class="hljs-selector-attr">[]</span>
        for (const [node, deg] of indegree) {
            if (deg &gt; <span class="hljs-number">0</span>) cyclicNodes<span class="hljs-selector-class">.push</span>(node)
        }
        throw new <span class="hljs-built_in">Error</span>(
            `检测到循环依赖，无法完成拓扑排序：\n${cyclicNodes.join('\n')}`
        )
    }
​
    return sorted
}
</code></pre>
<p>结果如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">[
  <span class="hljs-comment">// ...</span>
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/_baseGetTag.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/isSymbol.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/_baseToNumber.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/_baseToString.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/toNumber.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/_createMathOperation.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/toFinite.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/add.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/toInteger.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/after.js'</span>,
  <span class="hljs-string">'/Users/coderjc/Documents/test-code/原生/no-pre-bundle/node_modules/lodash-es/lodash.js'</span>
]
</code></pre>
<p>我们的例子中为了更好的观察，只保留了 add 和 after 两个函数的导入，从结果来看，是没什么问题的。</p>
<p>后续的步骤大概可以拆分为两步，一步是源码转换，一步是 bundle 生成，这一步其实比较简单，因为我们可以直接利用 esbuild 来完成。</p>
<p>当然也可以自己写，不过我是直接丢给 ai 实现，大概的结果如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20efef7ca650421f93df3879b6395a25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJqYw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768224367&amp;x-signature=2An8YXG2ag4Y43s3tQKAaJfaJYw%3D" alt="image-20260105211550397.png" loading="lazy"/></p>
<h3 data-id="heading-7">使用 esbuild 完成构建</h3>
<p>其实利用 esbuild 都不需要我们去自己实现依赖图什么的，只是为了说明大概做了什么事情而写的，下面看看使用 esbuild 如何实现。如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> esbuild <span class="hljs-keyword">from</span> <span class="hljs-string">'esbuild'</span>
​
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">prebundleDeps</span>(<span class="hljs-params">deps</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        deps.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
            <span class="hljs-keyword">return</span> esbuild.<span class="hljs-title function_">build</span>({
                <span class="hljs-attr">entryPoints</span>: [dep],
                <span class="hljs-attr">bundle</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">format</span>: <span class="hljs-string">'esm'</span>,
                <span class="hljs-attr">platform</span>: <span class="hljs-string">'browser'</span>,
                <span class="hljs-attr">outfile</span>: <span class="hljs-string">'./dist/lodash-es.js'</span>,
                <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>
            })
        })
    )
}
​
<span class="hljs-title function_">prebundleDeps</span>([<span class="hljs-string">'lodash-es'</span>])
</code></pre>
<p>打包结果如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2888223e2f44fa496d7590b1fe9c99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJqYw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768224367&amp;x-signature=OgjaaveEhD6KK%2B0OdytNW2t2KOU%3D" alt="image-20260105211942893.png" loading="lazy"/></p>
<p>大家可以和前文的网络请求的文件截图对比一下，结果都是一致的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Core Data 简化开发：NSPersistentContainer 从原理到实战]]></title>    <link>https://juejin.cn/post/7591687981688193070</link>    <guid>https://juejin.cn/post/7591687981688193070</guid>    <pubDate>2026-01-05T11:10:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591687981688193070" data-draft-id="7591694511246049318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Core Data 简化开发：NSPersistentContainer 从原理到实战"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2026-01-05T11:10:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JQShan"/> <meta itemprop="url" content="https://juejin.cn/user/1636535083759005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Core Data 简化开发：NSPersistentContainer 从原理到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1636535083759005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JQShan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T11:10:54.000Z" title="Mon Jan 05 2026 11:10:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为 iOS/macOS 开发者，本地数据存储是绕不开的话题。提起 Core Data，不少新手会皱眉头 —— 早期的 Core Data 配置繁琐，手动管理上下文、协调器这些组件很容易踩坑；而老开发者则清楚，自从 Apple 推出<code>NSPersistentContainer</code>后，Core Data 的使用体验直接 “起飞”。今天就跟大家聊聊，这个 “容器” 到底是什么、怎么用，以及它的那些优缺点。</p>
<h2 data-id="heading-0">一、先唠唠 Core Data 的 “老痛点”</h2>
<p>在 iOS 10/macOS 10.12 之前，想用 Core Data 得手动搭一套 “流水线”：</p>
<ol>
<li>加载<code>NSManagedObjectModel</code>（数据模型）；</li>
<li>创建<code>NSPersistentStoreCoordinator</code>（持久化存储协调器），指定存储类型（比如 SQLite）和路径；</li>
<li>实例化<code>NSManagedObjectContext</code>（托管对象上下文），并关联协调器；</li>
<li>还要处理线程安全、上下文合并这些问题。</li>
</ol>
<p>一套操作下来，代码又长又容易出错，光是初始化就能劝退一半新手。Apple 显然也发现了这个问题，于是<code>NSPersistentContainer</code>应运而生 —— 它把 Core Data 的核心组件全 “打包” 了，让我们不用再关心底层细节，专注于业务逻辑即可。</p>
<h2 data-id="heading-1">二、NSPersistentContainer：Core Data 的 “一站式工具箱”</h2>
<h3 data-id="heading-2">1. 核心原理：封装了什么？</h3>
<p><code>NSPersistentContainer</code>本质是对 Core Data 三大核心组件的封装，相当于给我们准备了一个开箱即用的 “数据管理容器”，内部结构如下：</p>

























<table><thead><tr><th>组件</th><th>作用</th><th>容器中的访问方式</th></tr></thead><tbody><tr><td><code>NSManagedObjectModel</code></td><td>定义数据结构（对应.xcdatamodeld 文件）</td><td><code>container.managedObjectModel</code></td></tr><tr><td><code>NSPersistentStoreCoordinator</code></td><td>管理数据存储（比如 SQLite 文件）</td><td><code>container.persistentStoreCoordinator</code></td></tr><tr><td><code>NSManagedObjectContext</code></td><td>操作数据的 “工作台”（增删改查）</td><td><code>container.viewContext</code>（主线程）/<code>container.newBackgroundContext()</code>（后台）</td></tr></tbody></table>
<p>简单说：你只需要告诉容器 “数据模型叫什么名字”，它会自动完成模型加载、协调器创建、上下文关联等所有底层工作，不用写一行冗余代码。</p>
<h3 data-id="heading-3">2. 最核心的两个上下文</h3>
<p>容器里最常用的是两个上下文，一定要分清：</p>
<ul>
<li><strong>viewContext</strong>：默认绑定<strong>主线程</strong>，专门用于 UI 相关的操作（比如列表展示读书笔记），线程安全，直接用就行；</li>
<li><strong>newBackgroundContext()</strong> ：每次调用都会生成一个新的后台上下文，用于耗时操作（比如批量导入历史读书笔记），避免阻塞主线程导致 UI 卡顿。</li>
</ul>
<h2 data-id="heading-4">三、实战：NSPersistentContainer 的基本用法</h2>
<p>光说不练假把式，我们用一个简单的 “读书笔记管理” 示例，看看怎么用容器搞定 Core Data 的增删改查。</p>
<h3 data-id="heading-5">前置准备</h3>
<ol>
<li>
<p>创建 iOS 项目时勾选「Use Core Data」（Xcode 会自动生成基础的容器代码）；</p>
</li>
<li>
<p>打开<code>.xcdatamodeld</code>文件，创建一个<code>BookNote</code>实体，添加三个属性：</p>
<ul>
<li><code>bookName</code>（String，书名）；</li>
<li><code>content</code>（String，笔记内容）；</li>
<li><code>createTime</code>（Date，创建时间，默认值可设为<code>@now</code>）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-6">1. 初始化容器（Xcode 自动生成，稍作优化）</h3>
<p>AppDelegate 中的核心代码，我们优化下错误处理（别用 fatalError，实际项目要友好）：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> CoreData

<span class="hljs-keyword">@UIApplicationMain</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppDelegate</span>: <span class="hljs-title class_">UIResponder</span>, <span class="hljs-title class_">UIApplicationDelegate</span> {
    <span class="hljs-comment">// 懒加载持久化容器</span>
    <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">var</span> persistentContainer: <span class="hljs-type">NSPersistentContainer</span> <span class="hljs-operator">=</span> {
        <span class="hljs-comment">// 模型文件名要和.xcdatamodeld文件名称一致（比如我命名为BookNoteModel）</span>
        <span class="hljs-keyword">let</span> container <span class="hljs-operator">=</span> <span class="hljs-type">NSPersistentContainer</span>(name: <span class="hljs-string">"BookNoteModel"</span>) 
        
        <span class="hljs-comment">// 加载持久化存储（默认是SQLite文件，存储在App沙盒中）</span>
        container.loadPersistentStores(completionHandler: { (storeDescription, error) <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> error <span class="hljs-keyword">as</span> <span class="hljs-type">NSError</span>? {
                <span class="hljs-comment">// 实际项目中替换为日志/弹窗提示，别直接崩溃</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"Core Data加载失败：(error.localizedDescription)"</span>)
            }
        })
        <span class="hljs-keyword">return</span> container
    }()

    <span class="hljs-comment">// 封装保存上下文的方法，复用性更高</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">saveContext</span>() {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> persistentContainer.viewContext
        <span class="hljs-keyword">guard</span> context.hasChanges <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> } <span class="hljs-comment">// 没有修改就不保存，减少IO消耗</span>
        
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">try</span> context.save()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"读书笔记保存成功✅"</span>)
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"保存失败❌：(error.localizedDescription)"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-7">2. 增删改查实战（ViewController 中）</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> UIKit
<span class="hljs-keyword">import</span> CoreData

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-comment">// 获取容器（实际项目建议用单例/依赖注入，别直接强转AppDelegate，这里为了简化）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> container: <span class="hljs-type">NSPersistentContainer</span> {
        <span class="hljs-keyword">let</span> appDelegate <span class="hljs-operator">=</span> <span class="hljs-type">UIApplication</span>.shared.delegate <span class="hljs-keyword">as!</span> <span class="hljs-type">AppDelegate</span>
        <span class="hljs-keyword">return</span> appDelegate.persistentContainer
    }

    <span class="hljs-comment">// 1. 添加读书笔记</span>
    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">addBookNote</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UIButton</span>) {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> container.viewContext
        <span class="hljs-comment">// 创建BookNote对象</span>
        <span class="hljs-keyword">let</span> note <span class="hljs-operator">=</span> <span class="hljs-type">BookNote</span>(context: context)
        note.bookName <span class="hljs-operator">=</span> <span class="hljs-string">"《小王子》"</span>
        note.content <span class="hljs-operator">=</span> <span class="hljs-string">"正是你为你的玫瑰花费的时光，才使你的玫瑰变得如此重要。"</span>
        note.createTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>() <span class="hljs-comment">// 也可以依赖模型的默认值，这里手动赋值更直观</span>
        
        <span class="hljs-comment">// 调用AppDelegate的保存方法</span>
        (<span class="hljs-type">UIApplication</span>.shared.delegate <span class="hljs-keyword">as!</span> <span class="hljs-type">AppDelegate</span>).saveContext()
    }

    <span class="hljs-comment">// 2. 查询所有读书笔记（可按创建时间倒序）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchAllBookNotes</span>() {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> container.viewContext
        <span class="hljs-comment">// 创建查询请求</span>
        <span class="hljs-keyword">let</span> fetchRequest: <span class="hljs-type">NSFetchRequest</span>&lt;<span class="hljs-type">BookNote</span>&gt; <span class="hljs-operator">=</span> <span class="hljs-type">BookNote</span>.fetchRequest()
        
        <span class="hljs-comment">// 按创建时间倒序排列，最新的笔记在前面</span>
        <span class="hljs-keyword">let</span> sortDescriptor <span class="hljs-operator">=</span> <span class="hljs-type">NSSortDescriptor</span>(keyPath: \<span class="hljs-type">BookNote</span>.createTime, ascending: <span class="hljs-literal">false</span>)
        fetchRequest.sortDescriptors <span class="hljs-operator">=</span> [sortDescriptor]
        
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">let</span> notes <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> context.fetch(fetchRequest)
            notes.forEach { note <span class="hljs-keyword">in</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"📚 书名：(note.bookName ?? "</span>未知<span class="hljs-string">")"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"✍️ 笔记：(note.content ?? "</span>无内容<span class="hljs-string">")"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"🕒 创建时间：(note.createTime ?? Date())<span class="hljs-subst">\n</span>"</span>)
            }
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"查询读书笔记失败：(error.localizedDescription)"</span>)
        }
    }

    <span class="hljs-comment">// 3. 删除读书笔记（示例：删除第一条《小王子》的笔记）</span>
    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">deleteBookNote</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UIButton</span>) {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> container.viewContext
        <span class="hljs-keyword">let</span> fetchRequest: <span class="hljs-type">NSFetchRequest</span>&lt;<span class="hljs-type">BookNote</span>&gt; <span class="hljs-operator">=</span> <span class="hljs-type">BookNote</span>.fetchRequest()
        
        <span class="hljs-comment">// 增加筛选条件：只删《小王子》的笔记</span>
        fetchRequest.predicate <span class="hljs-operator">=</span> <span class="hljs-type">NSPredicate</span>(format: <span class="hljs-string">"bookName == %@"</span>, <span class="hljs-string">"《小王子》"</span>)
        
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> targetNote <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> context.fetch(fetchRequest).first {
                context.delete(targetNote) <span class="hljs-comment">// 删除指定笔记对象</span>
                (<span class="hljs-type">UIApplication</span>.shared.delegate <span class="hljs-keyword">as!</span> <span class="hljs-type">AppDelegate</span>).saveContext()
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"《小王子》的笔记已删除"</span>)
            }
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"删除读书笔记失败：(error.localizedDescription)"</span>)
        }
    }

    <span class="hljs-comment">// 4. 后台批量导入读书笔记（重点：用后台上下文，不卡UI）</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">batchImportBookNotes</span>() {
        <span class="hljs-comment">// 创建后台上下文</span>
        <span class="hljs-keyword">let</span> backgroundContext <span class="hljs-operator">=</span> container.newBackgroundContext()
        <span class="hljs-comment">// 设置合并策略，避免多上下文操作冲突</span>
        backgroundContext.mergePolicy <span class="hljs-operator">=</span> <span class="hljs-type">NSMergeByPropertyObjectTrumpMergePolicy</span>
        
        <span class="hljs-comment">// 在后台线程执行批量操作，不会阻塞主线程</span>
        backgroundContext.perform { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// 模拟批量导入3本经典书籍的笔记</span>
            <span class="hljs-keyword">let</span> noteDatas <span class="hljs-operator">=</span> [
                (<span class="hljs-string">"《百年孤独》"</span>, <span class="hljs-string">"生命中真正重要的不是你遭遇了什么，而是你记住了哪些事，又是如何铭记的。"</span>),
                (<span class="hljs-string">"《解忧杂货店》"</span>, <span class="hljs-string">"其实所有纠结做选择的人心里早就有了答案，咨询只是想得到内心所倾向的选择。"</span>),
                (<span class="hljs-string">"《活着》"</span>, <span class="hljs-string">"人是为了活着本身而活着的，而不是为了活着之外的任何事物而活着。"</span>)
            ]
            
            <span class="hljs-comment">// 循环创建笔记对象</span>
            <span class="hljs-keyword">for</span> (bookName, content) <span class="hljs-keyword">in</span> noteDatas {
                <span class="hljs-keyword">let</span> note <span class="hljs-operator">=</span> <span class="hljs-type">BookNote</span>(context: backgroundContext)
                note.bookName <span class="hljs-operator">=</span> bookName
                note.content <span class="hljs-operator">=</span> content
                note.createTime <span class="hljs-operator">=</span> <span class="hljs-type">Date</span>()
            }
            
            <span class="hljs-comment">// 保存后台上下文的修改</span>
            <span class="hljs-keyword">do</span> {
                <span class="hljs-keyword">try</span> backgroundContext.save()
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"批量导入读书笔记完成✅"</span>)
            } <span class="hljs-keyword">catch</span> {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"批量导入失败❌：(error.localizedDescription)"</span>)
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-8">小提示</h3>
<ul>
<li>别在主线程做批量导入 / 大量查询操作！一定要用<code>newBackgroundContext()</code>；</li>
<li>后台上下文的<code>perform</code>方法会自动在对应的后台线程执行代码，不用手动写 GCD（比如<code>DispatchQueue.global().async</code>）；</li>
<li>实际项目中，建议把 Core Data 操作封装成单独的工具类（比如<code>BookNoteManager</code>），把增删改查的逻辑抽离出来，ViewController 只负责调用，代码更整洁易维护。</li>
</ul>
<h2 data-id="heading-9">四、NSPersistentContainer 的优缺点</h2>
<h3 data-id="heading-10">优点：新手友好，效率拉满</h3>
<ol>
<li><strong>极大简化配置</strong>：不用手动管理模型、协调器、上下文的关联，几行代码就能初始化 Core Data；</li>
<li><strong>线程安全</strong>：<code>viewContext</code>默认绑定主线程，避免了新手最容易踩的 “线程混乱” 坑；</li>
<li><strong>易于扩展</strong>：支持自定义存储路径、存储类型（比如内存存储，适合测试），满足进阶需求；</li>
<li><strong>官方维护</strong>：Apple 持续优化，兼容性和稳定性有保障。</li>
</ol>
<h3 data-id="heading-11">缺点：灵活度略有妥协</h3>
<ol>
<li><strong>底层封装过深</strong>：新手可能只知其然不知其所以然，遇到复杂问题（比如跨版本数据迁移）时，排查起来比较费劲；</li>
<li><strong>自定义配置稍麻烦</strong>：如果要修改默认的存储路径、缓存大小，需要额外写代码拆解容器；</li>
<li><strong>不支持跨平台（纯 Swift）</strong> ：Core Data 是 Apple 专属框架，如果你想做跨平台 App（比如 iOS+Android），还是得用 Realm、SQLite.swift 等。</li>
</ol>
<h2 data-id="heading-12">五、最后聊聊：什么时候用 NSPersistentContainer？</h2>
<ul>
<li>✅ <strong>推荐用</strong>：绝大多数常规 App（比如读书笔记、备忘录、待办清单类），只需要本地存储数据，不需要复杂的自定义配置；</li>
<li>❌ <strong>谨慎用</strong>：如果你需要深度定制 Core Data 的底层（比如自定义存储协调器、复杂的数据迁移策略），可能需要结合底层 API 使用；</li>
<li>📌 <strong>替代方案</strong>：如果追求跨平台 / 纯 Swift，可考虑 Realm、GRDB.swift；如果数据量极小，直接用 UserDefaults 就行。</li>
</ul>
<h2 data-id="heading-13">总结</h2>
<ol>
<li><code>NSPersistentContainer</code>是 Apple 为简化 Core Data 开发推出的 “利器”，封装了 Core Data 的核心组件，iOS 10 + 可直接用；</li>
<li>核心用法：初始化容器→用<code>viewContext</code>处理 UI 相关操作（比如展示读书笔记）→用<code>newBackgroundContext()</code>处理后台耗时操作（比如批量导入）→保存上下文；</li>
<li>它的优点是简单、安全、高效，缺点是底层封装过深，灵活度略有妥协，适合绝大多数常规 iOS/macOS 项目。</li>
</ol>
<p>Core Data 看似复杂，但有了<code>NSPersistentContainer</code>这个 “帮手”，新手也能快速上手。与其纠结底层原理，不如先动手写起来，遇到问题再深入研究，毕竟实践才是最好的老师～</p>
<hr/>
<h3 data-id="heading-14">关键点回顾</h3>
<ol>
<li>示例场景替换为「读书笔记管理」，实体<code>BookNote</code>包含<code>bookName</code>（书名）、<code>content</code>（笔记内容）、<code>createTime</code>（创建时间）三个核心属性；</li>
<li>核心代码逻辑不变，但所有增删改查、批量导入的操作都围绕 “读书笔记” 展开，更贴近日常开发场景；</li>
<li>保留了原博客轻松的语气和完整的讲解结构，同时补充了排序、筛选等更实用的查询技巧。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 Message 组件深度解析：从设计到实现的完整指南]]></title>    <link>https://juejin.cn/post/7591705084671328294</link>    <guid>https://juejin.cn/post/7591705084671328294</guid>    <pubDate>2026-01-05T15:26:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591705084671328294" data-draft-id="7591728734982979611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 Message 组件深度解析：从设计到实现的完整指南"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2026-01-05T15:26:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Spirited_Away"/> <meta itemprop="url" content="https://juejin.cn/user/2225067267204935"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 Message 组件深度解析：从设计到实现的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067267204935/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Spirited_Away
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T15:26:05.000Z" title="Mon Jan 05 2026 15:26:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>Message 组件是前端 UI 库中常见的提示组件，用于向用户提供即时反馈信息。本文将详细分析一个基于 Vue 3 的 Message 组件实现，涵盖组件设计、类型定义、实例管理等关键细节。这个组件不仅实现了基本的提示功能，还解决了多实例堆叠、动态布局、内存管理等复杂问题。</p>
<h2 data-id="heading-1">类型系统设计</h2>
<p>在 <code>types.ts</code> 中定义了完整的类型系统：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageProps</span> {
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">VNode</span>;                    <span class="hljs-comment">// 支持字符串和VNode内容</span>
  <span class="hljs-keyword">type</span>?: <span class="hljs-string">'success'</span> | <span class="hljs-string">'info'</span> | <span class="hljs-string">'warning'</span> | <span class="hljs-string">'danger'</span>;  <span class="hljs-comment">// 消息类型</span>
  duration?: <span class="hljs-built_in">number</span>;                          <span class="hljs-comment">// 显示持续时间</span>
  offset?: <span class="hljs-built_in">number</span>;                           <span class="hljs-comment">// 偏移距离</span>
  showClose?: <span class="hljs-built_in">boolean</span>;                       <span class="hljs-comment">// 是否显示关闭按钮</span>
  showIcon?: <span class="hljs-built_in">boolean</span>;                        <span class="hljs-comment">// 是否显示图标</span>
  id?: <span class="hljs-built_in">string</span>;                               <span class="hljs-comment">// 唯一标识</span>
  <span class="hljs-attr">onDestory</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>                      <span class="hljs-comment">// 销毁回调</span>
}
</code></pre>
<p><strong>设计亮点</strong>：</p>
<ul>
<li>支持字符串和 VNode 两种内容类型，提高组件灵活性</li>
<li>使用 <code>Omit&lt;MessageProps, 'id' | "onDestory"&gt;</code> 创建 <code>CreateMessageProps</code> 类型，自动排除内部管理的属性</li>
<li>严格遵循项目规范，确保必传属性不被遗漏</li>
</ul>
<h2 data-id="heading-2">核心组件实现</h2>
<h3 data-id="heading-3">1. Message.vue 组件</h3>
<h4 data-id="heading-4">属性定义和默认值</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> props = <span class="hljs-title function_">withDefaults</span>(defineProps&lt;<span class="hljs-title class_">MessageProps</span>&gt;(), {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'info'</span>,
  <span class="hljs-attr">duration</span>: <span class="hljs-number">3000</span>,
  <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">offset</span>: <span class="hljs-number">16</span>
})
</code></pre>
<h4 data-id="heading-5">图标映射系统</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> iconMap = {
  <span class="hljs-attr">primary</span>: <span class="hljs-string">'circle-info'</span>,
  <span class="hljs-attr">success</span>: <span class="hljs-string">'circle-check'</span>, 
  <span class="hljs-attr">warning</span>: <span class="hljs-string">'circle-exclamation'</span>,
  <span class="hljs-attr">danger</span>: <span class="hljs-string">'triangle-exclamation'</span>,
  <span class="hljs-attr">info</span>: <span class="hljs-string">'circle-info'</span>
}
</code></pre>
<p><strong>设计细节</strong>：</p>
<ul>
<li>图标映射确保不同类型的消息有对应的视觉标识</li>
<li>使用 Font Awesome 图标系统，符合项目技术选型</li>
</ul>
<h4 data-id="heading-6">定时器管理</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">startTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">duration</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>
  timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    visible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    props.<span class="hljs-title function_">onDestory</span>()
  }, props.<span class="hljs-property">duration</span>)
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">clearTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">clearTimeout</span>(timer)
}
</code></pre>
<p><strong>交互细节</strong>：</p>
<ul>
<li>鼠标悬停时暂停自动关闭 (<code>@mouseenter="clearTimer"</code>)</li>
<li>鼠标离开时重新开始计时 (<code>@mouseleave="startTimer"</code>)</li>
<li><code>duration</code> 为 0 时禁用自动关闭功能</li>
</ul>
<h4 data-id="heading-7">组件暴露接口</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">defineExpose</span>({
  <span class="hljs-attr">close</span>: <span class="hljs-function">() =&gt;</span> {
    visible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
  }
})
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>通过 <code>defineExpose</code> 暴露 <code>close</code> 方法，允许外部手动关闭消息</li>
<li>符合 Vue 3 的封装原则，只暴露必要的接口</li>
</ul>
<h2 data-id="heading-8">实例管理机制</h2>
<h3 data-id="heading-9">1. 全局实例管理</h3>
<p>在 <code>index.ts</code>中实现了完整的实例管理系统：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageInstance</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">el</span>: <span class="hljs-title class_">HTMLElement</span>,
  <span class="hljs-attr">instance</span>: <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Message</span>&gt;,
  <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>
}
</code></pre>
<p><strong>设计细节</strong>：</p>
<ul>
<li>每个实例包含 ID、DOM 元素、组件实例和计算出的偏移量</li>
</ul>
<h3 data-id="heading-10">2. 唯一ID生成</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> index = <span class="hljs-number">1</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">messageInstances</span>: <span class="hljs-title class_">MessageInstance</span>[] = []
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HmMessage</span>(<span class="hljs-params">props: CreateMessageProps</span>): <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Message</span>&gt; {
  <span class="hljs-keyword">const</span> id = <span class="hljs-string">`message_<span class="hljs-subst">${index++}</span>`</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>实现细节</strong>：</p>
<ul>
<li>使用递增索引确保每个消息实例有唯一ID</li>
<li>ID用于实例查找和管理，避免冲突</li>
</ul>
<h3 data-id="heading-11">3. 动态渲染策略</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">render</span>(<span class="hljs-title function_">h</span>(<span class="hljs-title class_">Message</span>, {
  ...props, id,
  offset,
  <span class="hljs-attr">onVnodeMounted</span>: <span class="hljs-function">(<span class="hljs-params">vnode: VNode</span>) =&gt;</span> {
    componentInstance = vnode.<span class="hljs-property">component</span>;
  },
  <span class="hljs-attr">onDestory</span>: close
}), container)

<span class="hljs-title function_">nextTick</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> el = container.<span class="hljs-property">firstElementChild</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLElement</span>
  el &amp;&amp; <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(el)
  <span class="hljs-comment">// 添加到实例数组</span>
})
</code></pre>
<p><strong>技术细节</strong>：</p>
<ul>
<li>使用 <code>render</code> 函数动态渲染组件，符合 Vue 3 的渲染 API</li>
<li>通过 <code>onVnodeMounted</code> 钩子获取组件实例</li>
<li><code>nextTick</code> 确保 DOM 渲染完成后再添加到 body</li>
</ul>
<h3 data-id="heading-12">4. 垂直排列算法</h3>
<p><code>calculateOffset</code>函数实现了智能的垂直排列：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateOffset</span>(<span class="hljs-params">baseOffset, lastMessage?: MessageInstance, delFirstEl = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-comment">// 销毁计算时，第一个元素特殊处理</span>
  <span class="hljs-keyword">if</span> (messageInstances.<span class="hljs-property">length</span> === <span class="hljs-number">0</span> || (delFirstEl &amp;&amp; !lastMessage)) {
    <span class="hljs-keyword">return</span> baseOffset;
  }

  lastMessage = lastMessage || messageInstances[messageInstances.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
  <span class="hljs-keyword">const</span> lastElement = lastMessage.<span class="hljs-property">el</span>;
  <span class="hljs-keyword">const</span> lastHeight = lastElement.<span class="hljs-property">offsetHeight</span>;
  <span class="hljs-keyword">const</span> lastOffset = lastMessage.<span class="hljs-property">offset</span>;

  <span class="hljs-keyword">return</span> lastOffset + lastHeight + baseOffset;
}
</code></pre>
<p><strong>算法逻辑</strong>：</p>
<ul>
<li>获取前一个消息的高度和位置</li>
<li>使用 <code>offsetHeight</code> 获取实际渲染高度，提升布局准确性</li>
<li>计算新消息的垂直偏移量，确保消息之间有适当的间距</li>
</ul>
<h2 data-id="heading-13">关闭和销毁机制</h2>
<h3 data-id="heading-14">1. 实例移除逻辑</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">close</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> index = messageInstances.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === id)
  <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
    messageInstances.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
  }
  componentInstance?.<span class="hljs-property">exposed</span>?.<span class="hljs-property">close</span>?.()
  <span class="hljs-comment">// 重新计算后续组件的offset</span>
  <span class="hljs-keyword">let</span> preIndex = index
  messageInstances.<span class="hljs-title function_">slice</span>(index).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
    item.<span class="hljs-property">offset</span> = <span class="hljs-title function_">calculateOffset</span>(props.<span class="hljs-property">offset</span> || <span class="hljs-number">16</span>, messageInstances[preIndex - <span class="hljs-number">1</span>], <span class="hljs-literal">true</span>)
    item.<span class="hljs-property">el</span>.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-string">`<span class="hljs-subst">${item.offset}</span>px`</span>
    preIndex++
  })
}
</code></pre>
<p><strong>销毁细节</strong>：</p>
<ul>
<li>从实例数组中移除当前消息</li>
<li>调用组件的 <code>close</code> 方法触发动画</li>
<li>重新计算并更新后续消息的位置，避免出现跳跃</li>
<li>使用 <code>slice(index)</code> 获取所有后续实例，确保布局紧凑无空隙</li>
</ul>
<h2 data-id="heading-15">样式和动画</h2>
<h3 data-id="heading-16">过渡动画</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;Transition name="fade-up"&gt;
  &lt;div class="hm-message" v-if="visible"&gt;
    &lt;!-- 消息内容 --&gt;
  &lt;/div&gt;
&lt;/Transition&gt;
</code></pre>
<p><strong>动画细节</strong>：</p>
<ul>
<li>使用 <code>fade-up</code> 过渡效果，提供平滑的显示/隐藏体验</li>
<li>CSS 类名遵循 BEM 规范</li>
<li>动画定义在全局样式中，确保一致性</li>
</ul>
<h2 data-id="heading-17">内容渲染策略</h2>
<h3 data-id="heading-18">VNode 支持</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;slot&gt;
  &lt;RenderVNode :vnode="message" v-if="message" /&gt;
&lt;/slot&gt;
</code></pre>
<p><strong>实现细节</strong>：</p>
<ul>
<li>使用 <code>RenderVNode</code> 组件渲染 VNode</li>
<li>支持复杂内容的动态渲染</li>
<li>同时兼容字符串和 VNode 两种内容类型</li>
</ul>
<h2 data-id="heading-19">使用方式</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建消息</span>
<span class="hljs-keyword">const</span> message = <span class="hljs-title class_">HmMessage</span>({
  <span class="hljs-attr">message</span>: <span class="hljs-string">'操作成功'</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">'success'</span>,
  <span class="hljs-attr">duration</span>: <span class="hljs-number">3000</span>,
  <span class="hljs-attr">showClose</span>: <span class="hljs-literal">true</span>
})

<span class="hljs-comment">// 手动关闭</span>
message.<span class="hljs-title function_">close</span>()
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>必须传入 <code>message</code> 和 <code>type</code> 属性</li>
<li>可通过返回的实例对象手动关闭消息</li>
</ul>
<h2 data-id="heading-20">总结</h2>
<p>这个 Message 组件的实现展现了现代 Vue 组件开发的多个最佳实践：</p>
<ol>
<li><strong>类型安全</strong>：完整的 TypeScript 类型定义，严格遵循项目规范</li>
<li><strong>实例管理</strong>：智能的全局实例管理系统，解决多实例堆叠问题</li>
<li><strong>交互体验</strong>：鼠标悬停暂停、平滑动画、可配置的关闭机制</li>
<li><strong>布局算法</strong>：基于实际渲染高度的动态垂直排列计算</li>
<li><strong>内存管理</strong>：正确的销毁和清理机制，避免内存泄漏</li>
<li><strong>内容灵活性</strong>：同时支持字符串和 VNode 内容渲染</li>
</ol>
<p>整个实现充分考虑了用户体验、性能优化和代码可维护性，是一个高质量的组件实现。它不仅解决了基础的提示需求，还通过精心设计的实例管理和布局算法，提供了专业级的用户体验，完全符合 hm-ui 组件库的设计理念和技术规范。</p>
<p>具体实现请访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzhang-glitch%2Fhm-ui%2Ftree%2Fhm-message" target="_blank" title="https://github.com/zhang-glitch/hm-ui/tree/hm-message" ref="nofollow noopener noreferrer">zhang-glitch github</a></p>
<h2 data-id="heading-21">往期年度总结</h2>
<ul>
<li><a href="https://juejin.cn/post/7310895905573716005" title="https://juejin.cn/post/7310895905573716005" target="_blank">四年沿海城市，刚毕业，一年3家公司</a></li>
<li><a href="https://juejin.cn/post/7254361990076055589" title="https://juejin.cn/post/7254361990076055589" target="_blank">七月仿佛又回到了那一年（2023年中总结）</a></li>
<li><a href="https://juejin.cn/post/7188374796114067511" title="https://juejin.cn/post/7188374796114067511" target="_blank">一位初入职场前端仔的年度终结 &lt;回顾2022，展望2023&gt;</a></li>
<li><a href="https://juejin.cn/post/7046248406464856100" title="https://juejin.cn/post/7046248406464856100" target="_blank">大学两年半的前端学习</a></li>
</ul>
<h2 data-id="heading-22">往期文章</h2>
<ul>
<li><a href="https://juejin.cn/post/7392071328528891956" title="https://juejin.cn/post/7392071328528891956" target="_blank">展示大量数据节点(tree)，引发的一次性能排查</a></li>
<li><a href="https://juejin.cn/post/7368662916151296039" title="https://juejin.cn/post/7368662916151296039" target="_blank">ts装饰器的那点东西</a></li>
<li><a href="https://juejin.cn/post/7360871152037052416" title="https://juejin.cn/post/7360871152037052416" target="_blank">这是你所知道的ts类型断言和类型守卫吗？</a></li>
<li><a href="https://juejin.cn/post/7202132390549356603" title="https://juejin.cn/post/7202132390549356603" target="_blank">TypeScript官网内容解读</a></li>
<li><a href="https://juejin.cn/post/7360498535077003304" title="https://juejin.cn/post/7360498535077003304" target="_blank">经常使用ts的你，知道这些内容？</a></li>
<li><a href="https://juejin.cn/post/7351336619595939880" title="https://juejin.cn/post/7351336619595939880" target="_blank">你有了解过原生css的scope？</a></li>
<li><a href="https://juejin.cn/post/7348832432072654886" title="https://juejin.cn/post/7348832432072654886" target="_blank">现在比较常用的移动端调试你知道哪些？</a></li>
<li><a href="https://juejin.cn/post/7345352532657848371" title="https://juejin.cn/post/7345352532657848371" target="_blank">众多跨标签页通信方式，你知道哪些？（二）</a></li>
<li><a href="https://juejin.cn/post/7340109700767383604" title="https://juejin.cn/post/7340109700767383604" target="_blank">众多跨标签页通信方式，你知道哪些？</a></li>
<li><a href="https://juejin.cn/post/7330021813823750159" title="https://juejin.cn/post/7330021813823750159" target="_blank">反调试吗？如何监听devtools的打开与关闭</a></li>
<li><a href="https://juejin.cn/post/7301908233291300900" title="https://juejin.cn/post/7301908233291300900" target="_blank">因为原生，选择一家公司（前端如何防笔试作弊）</a></li>
<li><a href="https://juejin.cn/post/7298294389478506548" title="https://juejin.cn/post/7298294389478506548" target="_blank">结合开发，带你熟悉package.json与tsconfig.json配置</a></li>
<li><a href="https://juejin.cn/post/7294541220440752165" title="https://juejin.cn/post/7294541220440752165" target="_blank">如何优雅的在项目中使用echarts</a></li>
<li><a href="https://juejin.cn/post/7293797226933764134" title="https://juejin.cn/post/7293797226933764134" target="_blank">如何优雅的做项目国际化</a></li>
<li><a href="https://juejin.cn/post/7292036126269063178" title="https://juejin.cn/post/7292036126269063178" target="_blank">近三个月的排错，原来的憧憬消失喽</a></li>
<li><a href="https://juejin.cn/post/7291955076100620342" title="https://juejin.cn/post/7291955076100620342" target="_blank">带你从0开始了解vue3核心（运行时）</a></li>
<li><a href="https://juejin.cn/post/7275550540620365878" title="https://juejin.cn/post/7275550540620365878" target="_blank">带你从0开始了解vue3核心（computed, watch）</a></li>
<li><a href="https://juejin.cn/post/7274072378606174263" title="https://juejin.cn/post/7274072378606174263" target="_blank">带你从0开始了解vue3核心（响应式）</a></li>
<li><a href="https://juejin.cn/post/7269225865619816483" title="https://juejin.cn/post/7269225865619816483" target="_blank">3w+字的后台管理通用功能解决方案送给你</a></li>
<li><a href="https://juejin.cn/post/7251878440327512124" title="https://juejin.cn/post/7251878440327512124" target="_blank">入职之前，狂补技术，4w字的前端技术解决方案送给你（vue3 + vite ）</a></li>
</ul>
<h2 data-id="heading-23">专栏文章</h2>
<ul>
<li><a href="https://juejin.cn/column/7036633477013307423" title="https://juejin.cn/column/7036633477013307423" target="_blank">重学vue及其生态</a></li>
<li><a href="https://juejin.cn/column/7085181986347679751" title="https://juejin.cn/column/7085181986347679751" target="_blank">前端面试</a></li>
<li><a href="https://juejin.cn/column/7215977393697587259" title="https://juejin.cn/column/7215977393697587259" target="_blank">前端工程化</a></li>
<li><a href="https://juejin.cn/column/7171775932809052174" title="https://juejin.cn/column/7171775932809052174" target="_blank">amis 低代码实战</a></li>
<li><a href="https://juejin.cn/column/7090398104549064718" title="https://juejin.cn/column/7090398104549064718" target="_blank">协议与安全</a></li>
<li><a href="https://juejin.cn/column/7073656450874081316" title="https://juejin.cn/column/7073656450874081316" target="_blank">重学react</a></li>
<li><a href="https://juejin.cn/column/7036633282204663822" title="https://juejin.cn/column/7036633282204663822" target="_blank">重学nodejs</a></li>
<li><a href="https://juejin.cn/column/7133877511707951111" title="https://juejin.cn/column/7133877511707951111" target="_blank">工作总结</a></li>
<li><a href="https://juejin.cn/column/7366457260414697509" title="https://juejin.cn/column/7366457260414697509" target="_blank">Typescript研究</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent案例实践：智能体开发模式详解之三（基于QwenAgent框架）]]></title>    <link>https://juejin.cn/post/7591506455973462070</link>    <guid>https://juejin.cn/post/7591506455973462070</guid>    <pubDate>2026-01-05T10:39:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591506455973462070" data-draft-id="7591510742648553515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent案例实践：智能体开发模式详解之三（基于QwenAgent框架）"/> <meta itemprop="keywords" content="后端,Python,人工智能"/> <meta itemprop="datePublished" content="2026-01-05T10:39:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木昆子"/> <meta itemprop="url" content="https://juejin.cn/user/825103640698564"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent案例实践：智能体开发模式详解之三（基于QwenAgent框架）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/825103640698564/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木昆子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T10:39:58.000Z" title="Mon Jan 05 2026 10:39:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>书接上文：<a href="https://juejin.cn/user/825103640698564/posts" target="_blank" title="https://juejin.cn/user/825103640698564/posts">AI Agent案例实践：三种智能体开发模式详解之二（基于LangChain框架）</a></p>
<h2 data-id="heading-0">四、开发实践（基于QwenAgent框架）</h2>
<p>前文中，我们使用LangChain框架实现了我们的智能体。下面让我们使用Qwen-Agent实现一版ReAct，体验下流程，具体的业务场景中需要根据需求，调研后决定具体使用哪种方式。</p>
<h3 data-id="heading-1">4.1. 什么是QwenAgent？</h3>
<ul>
<li>LangChain：一个开源框架，专为构建与大语言模型（LLMs）相关的应用设计，通过集成多个API、数据源和工具，助力开发者高效构建智能应用。它更像是AI应用开发的“行业标杆”和“基础设施”，提供了模块化设计（Chains、Agents、Memory）、多模型兼容（OpenAI、HuggingFace等）以及强大的工具调用能力。</li>
<li>Qwen-Agent：由阿里巴巴团队优化的Agent框架，特别针对中文场景和通义千问（Qwen）系列模型进行了深度优化。它更侧重于具体模型的落地应用，尤其是在处理长文本、复杂推理和多轮对话方面表现出色。</li>
</ul>
<p>Qwen-Agent 开发框架支持 ReAct 范式</p>
<p>Qwen-Agent 提供了 ReActChat 类来支持 ReAct 推理范式。这允许智能体像人类一样进行思考（Reasoning）、行动（Taking Action）（例如调用工具）和观察（Observing） 结果，并循环此过程直至任务完成 。</p>
<ul>
<li>工作原理：ReActChat 类继承自 FnCallAgent 类，其内部通过 while 循环来管理多轮的工具调用和推理过程 。开发者通常不需要干预这个循环的具体次数。</li>
<li>如何使用：你只需要定义好必要的工具（Tools），并将它们分配给智能体。智能体会根据你的查询和系统指令，自行决定是否需要以及如何通过 ReAct 循环来调用这些工具。</li>
</ul>
<p>关于迭代次数</p>
<p>在 Qwen-Agent 的上下文中，我们通常说的“迭代”指的是 ReAct 循环中模型调用工具并进行推理的轮次。</p>
<ol>
<li>1. 自动控制：这个迭代次数通常不需要开发者手动配置。它主要由底层的大语言模型（LLM）根据当前任务的复杂性、可用工具以及历史上下文来动态决定。模型会自主判断何时拥有了足够的信息来给出最终答案，从而终止循环 。</li>
<li>2. 与训练迭代的区别：需要注意的是，这不同于模型训练阶段的超参“迭代次数”（iterations/epochs）。训练迭代指的是整个训练数据集被完整地用于更新模型参数的次数，这在模型微调时需要配置 。但在 Qwen-Agent 框架中，你通常直接使用预训练好的模型，因此不涉及对此类训练迭代次数的配置。</li>
</ol>
<p>实用建议</p>
<ul>
<li>控制循环：虽然不需要直接设置迭代次数，但你可以通过优化提示词（Prompt）、工具描述的清晰度和准确性，来引导模型更高效地进行推理和工具调用，间接影响循环轮次</li>
</ul>
<p>接下来我们直接使用QwenAgent框架实现ReAct智能体模式。</p>
<h3 data-id="heading-2">4.2.代码实践</h3>
<p>具体开发实现如下(agent_service_qwen.py)：</p>
<pre><code class="hljs language-python" lang="python">mport sys  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">from</span> qwen_agent.agents <span class="hljs-keyword">import</span> Assistant  
<span class="hljs-keyword">from</span> qwen_agent.tools <span class="hljs-keyword">import</span> BaseTool  
<span class="hljs-keyword">from</span> api_service <span class="hljs-keyword">import</span> QueryService, SemanticServce, AnalysisService  
  
<span class="hljs-comment"># 初始化服务  </span>
queryService = QueryService()  
semanticService = SemanticServce()  
analysisService = AnalysisService()  
  
<span class="hljs-comment"># 自定义工具类  </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MatchMetadataTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):  
    name = <span class="hljs-string">'match_metadata'</span>  
    description = <span class="hljs-string">'根据输入文本语义匹配表结构，每次返回一个最相关的表结构。对于需要多表查询的问题，需要多次调用此工具。'</span>  
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">self, params, **kwargs</span>) -&gt; <span class="hljs-built_in">str</span>:  
        table = semanticService.hybrid_search(params, <span class="hljs-number">1</span>)  
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{[t[<span class="hljs-string">'table_info'</span>] <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> table]}</span>"</span>  
  
  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecuteSQLTool</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):  
    name = <span class="hljs-string">'execute_sql'</span>  
    description = <span class="hljs-string">'执行SQL查询并返回结果。输入应为标准SQL语句。注意：可能需要执行多个SQL查询来获取不同表中的数据。'</span>  
  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">call</span>(<span class="hljs-params">self, params, **kwargs</span>) -&gt; <span class="hljs-built_in">str</span>:  
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(params, <span class="hljs-built_in">str</span>):  
            jsonObj = json.loads(params)  
            <span class="hljs-keyword">if</span> <span class="hljs-string">'sql'</span><span class="hljs-keyword">in</span> jsonObj:  
                params = jsonObj[<span class="hljs-string">'sql'</span>]  
            <span class="hljs-keyword">if</span> <span class="hljs-string">'query'</span><span class="hljs-keyword">in</span> jsonObj:  
                params = jsonObj[<span class="hljs-string">'query'</span>]  
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(params, <span class="hljs-built_in">dict</span>):  
            <span class="hljs-keyword">if</span> <span class="hljs-string">'sql'</span><span class="hljs-keyword">in</span> params:  
                params = params[<span class="hljs-string">'sql'</span>]  
            <span class="hljs-keyword">if</span> <span class="hljs-string">'query'</span><span class="hljs-keyword">in</span> params:  
                params = params[<span class="hljs-string">'query'</span>]  
        <span class="hljs-keyword">if</span> params.endswith(<span class="hljs-string">';'</span>):  
            params = params[:-<span class="hljs-number">1</span>]  
        <span class="hljs-keyword">return</span> json.dumps(queryService.query_with_column(params))  
  
<span class="hljs-comment"># 创建Agent实例  </span>
agent = Assistant(  
    name=<span class="hljs-string">'ai_agent_assistant'</span>,  
    llm={  
        <span class="hljs-string">'model'</span>: <span class="hljs-string">'qwen3:32b'</span>,  
        <span class="hljs-string">'model_server'</span>: <span class="hljs-string">'http://localhost:11434/v1'</span>,  
    },  
    system_message=<span class="hljs-string">"""  
        你是一个数据分析助手，负责帮助用户查询数据库信息。  
        请特别注意：用户的问题可能需要从多个表中查询数据。  
        1. 首先确定需要查询哪些数据  
        2. 使用match_metadata工具分别匹配包含这些数据的表结构  
        3. 对每个表生成相应的SQL查询语句  
        4. 执行查询并汇总结果  
        5. 最后计算并给出答案  
      
        请确保逐步执行，不要跳过任何步骤。  
    """</span>,  
    function_list=[MatchMetadataTool(), ExecuteSQLTool()],  
)  
  
<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">user_query</span>):  
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行方法chat"</span>)  
    <span class="hljs-keyword">try</span>:  
        <span class="hljs-comment"># 运行Agent  </span>
        messages = [{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: user_query}]  
        response_generator = agent.run(messages=messages)  
        <span class="hljs-comment"># 处理生成器响应  </span>
        full_response = <span class="hljs-string">''</span>  
        start = <span class="hljs-number">0</span>  
        end = <span class="hljs-number">0</span>  
        <span class="hljs-keyword">for</span> response <span class="hljs-keyword">in</span> response_generator:  
            <span class="hljs-comment"># 检查响应类型并适当处理  </span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(response, <span class="hljs-built_in">list</span>):  
                <span class="hljs-comment"># 如果是列表，提取内容  </span>
                <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> response:  
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(item, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span><span class="hljs-string">'content'</span><span class="hljs-keyword">in</span> item:  
                        full_response = item[<span class="hljs-string">'content'</span>]  
                        end = full_response.__len__()  
                    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(item, <span class="hljs-built_in">str</span>):  
                        full_response = item  
                        end = full_response.__len__()  
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(response, <span class="hljs-built_in">dict</span>) <span class="hljs-keyword">and</span><span class="hljs-string">'content'</span><span class="hljs-keyword">in</span> response:  
                full_response = response[<span class="hljs-string">'content'</span>]  
                end = full_response.__len__()  
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">isinstance</span>(response, <span class="hljs-built_in">str</span>):  
                full_response = response  
                end = full_response.__len__()  
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{full_response[start:end]}</span>"</span>, end=<span class="hljs-string">""</span>)  
            start = end  
  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终结果: <span class="hljs-subst">{full_response}</span>"</span>)  
        <span class="hljs-keyword">return</span> full_response  
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"执行过程中出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)  
        <span class="hljs-comment"># 这里可以添加重试或更详细的错误处理逻辑  </span>
        <span class="hljs-keyword">return</span><span class="hljs-string">f"错误: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>  
  
  
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:  
    args = sys.argv[<span class="hljs-number">1</span>:]  
  
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"请提供参数：init或者chat+user_query"</span>)  
    <span class="hljs-keyword">elif</span> args[<span class="hljs-number">0</span>] == <span class="hljs-string">"init"</span>:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始执行方法init"</span>)  
        <span class="hljs-comment"># 这里可以添加初始化逻辑  </span>
    <span class="hljs-keyword">elif</span> args[<span class="hljs-number">0</span>] == <span class="hljs-string">"chat"</span>:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"user_query=<span class="hljs-subst">{args[<span class="hljs-number">1</span>]}</span>"</span>)  
        chat(args[<span class="hljs-number">1</span>])  
    <span class="hljs-keyword">else</span>:  
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未知参数: <span class="hljs-subst">{args[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre>
<p>依旧是和LangChain实现的ReAct同样的工具和提示词，只是这次我们使用QwenAgent框架实现。</p>
<h3 data-id="heading-3">4.3.测试结果</h3>
<p>多数据源RAG检索问题：2016年考生人数和录取人数分别有多少？</p>
<p>运行python agent_service_qwen.py chat '2016年考生人数和录取人数分别有多少？',输出如下：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-operator">&lt;</span>think<span class="hljs-operator">&gt;</span>
好的，用户问的是<span class="hljs-number">2016</span>年的考生人数和录取人数<span class="hljs-operator">。</span>首先我需要确定这两个数据分别存储在哪个表里<span class="hljs-operator">。</span>可能有一个表记录考生信息，另一个表记录录取情况<span class="hljs-operator">。</span>我需要先调用match_metadata工具来找到相关的表结构<span class="hljs-operator">。</span>

先查考生人数，输入“考生人数”看看匹配哪个表<span class="hljs-operator">。</span>假设返回的是enrollment表，里面有year和candidates字段<span class="hljs-operator">。</span>然后查录取人数，输入“录取人数”，可能对应admissions表，里面有year和admitted字段<span class="hljs-operator">。</span>接下来需要分别对这两个表执行<span class="hljs-type">SQL查询，筛选出year为2016年的数据</span><span class="hljs-operator">。</span>

执行第一个<span class="hljs-type">SQL：SELECT</span> candidates <span class="hljs-type">FROM</span> enrollment <span class="hljs-type">WHERE</span> year <span class="hljs-operator">=</span> <span class="hljs-number">2016</span>; 得到考生人数<span class="hljs-operator">。</span>再执行第二个<span class="hljs-type">SQL：SELECT</span> admitted <span class="hljs-type">FROM</span> admissions <span class="hljs-type">WHERE</span> year <span class="hljs-operator">=</span> <span class="hljs-number">2016</span>; 得到录取人数<span class="hljs-operator">。</span>然后把结果汇总，给出两个数值<span class="hljs-operator">。</span>需要确保两个表的年份字段都是<span class="hljs-number">2016</span>，并且字段名正确<span class="hljs-operator">。</span>如果有多个表可能涉及，可能需要进一步确认，但这里假设两次匹配都正确<span class="hljs-operator">。</span>最后计算结果并呈现给用户<span class="hljs-operator">。</span>
<span class="hljs-operator">&lt;/</span>think<span class="hljs-operator">&gt;</span>

调用大模型llama2向量化：{<span class="hljs-string">"query"</span>:<span class="hljs-string">"考生人数"</span>}
自然语言混合检索字段成功，匹配到的元数据信息：['{<span class="hljs-string">"表名"</span>:<span class="hljs-string">"college_entrance_examination"</span>,<span class="hljs-string">"表备注"</span>:<span class="hljs-string">"考生人数与复读人数信息表，包含字段：高考年份(主键)、考生人数(万人)、复读人数(万人)，考生人数是指参加高考的学生的数量，复读人数是指参加高考的复读学生的数量"</span>,<span class="hljs-string">"字段列表"</span>:[{<span class="hljs-string">"字段名"</span>:<span class="hljs-string">"examination_year"</span>,<span class="hljs-string">"字段类型"</span>:<span class="hljs-string">"int"</span>,<span class="hljs-string">"字段备注"</span>:<span class="hljs-string">"高考年份"</span>},{<span class="hljs-string">"字段名"</span>:<span class="hljs-string">"candidates_count"</span>,<span class="hljs-string">"字段类型"</span>:<span class="hljs-string">"decimal(10,2)"</span>,<span class="hljs-string">"字段备注"</span>:<span class="hljs-string">"考生人数(万人)"</span>},{<span class="hljs-string">"字段名"</span>:<span class="hljs-string">"retake_count"</span>,<span class="hljs-string">"字段类型"</span>:<span class="hljs-string">"decimal(10,2)"</span>,<span class="hljs-string">"字段备注"</span>:<span class="hljs-string">"复读人数(万人)"</span>}]}']
好的，用户的问题是关于<span class="hljs-number">2016</span>年的考生人数和录取人数<span class="hljs-operator">。</span>首先，我需要确认这两个数据分别存储在哪些表中<span class="hljs-operator">。</span>之前用户提到过“考生人数”，我调用match_metadata工具后得到了一个表college_entrance_examination，里面包含考生人数和复读人数，但没有录取人数<span class="hljs-operator">。</span>这说明录取人数可能在另一个表里<span class="hljs-operator">。</span>

接下来，我需要再次调用match_metadata工具，这次查询“录取人数”<span class="hljs-operator">。</span>输入关键词后，应该会有对应的表结构返回，比如可能有一个表叫college_admission，包含录取人数字段<span class="hljs-operator">。</span>假设返回的表结构中有字段admission_count，那么接下来需要分别对这两个表生成<span class="hljs-type">SQL查询语句</span><span class="hljs-operator">。</span>

对于college_entrance_examination表，<span class="hljs-type">SQL语句会是SELECT</span> candidates_count <span class="hljs-type">FROM</span> college_entrance_examination <span class="hljs-type">WHERE</span> examination_year <span class="hljs-operator">=</span> <span class="hljs-number">2016</span>; 这样可以得到<span class="hljs-number">2016</span>年的考生人数<span class="hljs-operator">。</span>然后，针对录取人数所在的表，假设是college_admission，<span class="hljs-type">SQL语句可能是SELECT</span> admission_count <span class="hljs-type">FROM</span> college_admission <span class="hljs-type">WHERE</span> admission_year <span class="hljs-operator">=</span> <span class="hljs-number">2016</span>; 执行这两个查询后，将结果汇总，就能得到用户需要的两个数据<span class="hljs-operator">。</span>

需要注意的是，确保两个表的年份字段名称和类型正确，避免因为字段名不同或数据类型不匹配导致查询错误<span class="hljs-operator">。</span>此外，如果存在多个相关表，需要确认哪一个包含正确的数据，可能需要进一步的信息验证<span class="hljs-operator">。</span>最后，将查询结果整理后，用清晰的方式呈现给用户，确保数据的准确性和可读性<span class="hljs-operator">。</span>
<span class="hljs-operator">&lt;/</span>think<span class="hljs-operator">&gt;</span>

调用大模型llama2向量化：{<span class="hljs-string">"query"</span>:<span class="hljs-string">"录取人数"</span>}
自然语言混合检索字段成功，匹配到的元数据信息：['{<span class="hljs-string">"表名"</span>:<span class="hljs-string">"college_entrance_admission"</span>,<span class="hljs-string">"表备注"</span>:<span class="hljs-string">"录取人数与普通高校数信息表，包含字段：录取年份(主键)、录取人数(万人)、招生高校数、本科录取人数(万人)、专科录取人数(万人)，录取人数是指录取或者招收、招录的学生的数量"</span>,<span class="hljs-string">"字段列表"</span>:[{<span class="hljs-string">"字段名"</span>:<span class="hljs-string">"admission_year"</span>,<span class="hljs-string">"字段类型"</span>:<span class="hljs-string">"int"</span>,<span class="hljs-string">"字段备注"</span>:<span class="hljs-string">"录取年份"</span>},{<span class="hljs-string">"字段名"</span>:<span class="hljs-string">"admission_count"</span>,<span class="hljs-string">"字段类型"</span>:<span class="hljs-string">"decimal(10,2)"</span>,<span class="hljs-string">"字段备注"</span>:<span class="hljs-string">"录取人数(万人)"</span>},{<span class="hljs-string">"字段名"</span>:<span class="hljs-string">"university_count"</span>,<span class="hljs-string">"字段类型"</span>:<span class="hljs-string">"int"</span>,<span class="hljs-string">"字段备注"</span>:<span class="hljs-string">"招生高校数"</span>},{<span class="hljs-string">"字段名"</span>:<span class="hljs-string">"undergraduate_admission_count"</span>,<span class="hljs-string">"字段类型"</span>:<span class="hljs-string">"decimal(10,2)"</span>,<span class="hljs-string">"字段备注"</span>:<span class="hljs-string">"本科录取人数(万人)"</span>},{<span class="hljs-string">"字段名"</span>:<span class="hljs-string">"specialty_admission_count"</span>,<span class="hljs-string">"字段类型"</span>:<span class="hljs-string">"decimal(10,2)"</span>,<span class="hljs-string">"字段备注"</span>:<span class="hljs-string">"专科录取人数(万人)"</span>}]}']
好，用户需要知道<span class="hljs-number">2016</span>年的考生人数和录取人数<span class="hljs-operator">。</span>首先，我需要确定这两个数据分别存储在哪个表里<span class="hljs-operator">。</span>

先处理考生人数<span class="hljs-operator">。</span>用户的问题中提到“考生人数”，之前调用match_metadata工具时已经找到了对应的表college_entrance_examination<span class="hljs-operator">。</span>这个表的字段有examination_year<span class="hljs-operator">、</span>candidates_count和retake_count<span class="hljs-operator">。</span>所以考生人数应该从这个表中查询，条件是examination_year等于<span class="hljs-number">2016</span><span class="hljs-operator">。</span>

然后是录取人数<span class="hljs-operator">。</span>用户的问题里提到“录取人数”，通过之前的工具调用，发现了表college_entrance_admission<span class="hljs-operator">。</span>这个表里有admission_year和admission_count，所以录取人数需要从这里查询，同样条件是admission_year等于<span class="hljs-number">2016</span><span class="hljs-operator">。</span>

接下来需要生成对应的<span class="hljs-type">SQL查询语句</span><span class="hljs-operator">。</span>对于考生人数，<span class="hljs-type">SQL应该是SELECT</span> candidates_count <span class="hljs-type">FROM</span> college_entrance_examination <span class="hljs-type">WHERE</span> examination_year <span class="hljs-operator">=</span> <span class="hljs-number">2016</span><span class="hljs-operator">。</span>而录取人数的<span class="hljs-type">SQL应该是SELECT</span> admission_count <span class="hljs-type">FROM</span> college_entrance_admission <span class="hljs-type">WHERE</span> admission_year <span class="hljs-operator">=</span> <span class="hljs-number">2016</span><span class="hljs-operator">。</span>

执行这两个查询后，会得到两个结果，可能都是小数（因为字段类型是decimal）<span class="hljs-operator">。</span>然后需要将这两个数字组合起来，用万人单位，并且四舍五入到合适的小数位数，可能保留两位小数<span class="hljs-operator">。</span>

比如，如果查询结果分别是<span class="hljs-number">872.21</span>万人和<span class="hljs-number">749.61</span>万人，那么最终答案就是考生人数<span class="hljs-number">872.21</span>万人，录取人数<span class="hljs-number">749.61</span>万人<span class="hljs-operator">。</span>需要确认年份是否对应，确保两个表的年份字段都正确匹配<span class="hljs-number">2016</span>年<span class="hljs-operator">。</span>

最后，将结果用中文清晰地呈现给用户，说明分别的数据并注明单位<span class="hljs-operator">。</span>
<span class="hljs-operator">&lt;/</span>think<span class="hljs-operator">&gt;</span>

执行<span class="hljs-type">SQL：SELECT</span> candidates_count <span class="hljs-type">FROM</span> college_entrance_examination <span class="hljs-type">WHERE</span> examination_year <span class="hljs-operator">=</span> <span class="hljs-number">2016</span>
[{<span class="hljs-string">"candidates_count"</span>:<span class="hljs-number">940.0</span>}]
好的，我需要回答用户关于<span class="hljs-number">2016</span>年考生人数和录取人数的问题<span class="hljs-operator">。</span>首先，用户已经通过两次match_metadata调用，分别获取了考生人数所在的表college_entrance_examination和录取人数所在的表college_entrance_admission<span class="hljs-operator">。</span>

接下来，用户执行了第一个<span class="hljs-type">SQL查询，从college_entrance_examination表中获取了2016年的考生人数，结果是940</span>.<span class="hljs-number">0</span>万人<span class="hljs-operator">。</span>现在需要处理录取人数的部分<span class="hljs-operator">。</span>根据第二个match_metadata的结果，录取人数在college_entrance_admission表的admission_count字段中，且年份字段是admission_year<span class="hljs-operator">。</span>

因此，我需要构造另一个<span class="hljs-type">SQL查询，从college_entrance_admission表中选择admission_count，其中admission_year等于2016</span><span class="hljs-operator">。</span>执行这个查询后，将得到录取人数的数据<span class="hljs-operator">。</span>最后，把两个结果合并，给出用户需要的答案<span class="hljs-operator">。</span>
<span class="hljs-operator">&lt;/</span>think<span class="hljs-operator">&gt;</span>

执行<span class="hljs-type">SQL：SELECT</span> admission_count <span class="hljs-type">FROM</span> college_entrance_admission <span class="hljs-type">WHERE</span> admission_year <span class="hljs-operator">=</span> <span class="hljs-number">2016</span>
[{<span class="hljs-string">"admission_count"</span>:<span class="hljs-number">772.0</span>}]
好的，用户问的是<span class="hljs-number">2016</span>年的考生人数和录取人数分别是多少<span class="hljs-operator">。</span>我需要先找到这两个数据分别存放在哪个表里<span class="hljs-operator">。</span>

首先，用户的问题涉及到“考生人数”，所以我调用了match_metadata工具，参数是“考生人数”<span class="hljs-operator">。</span>返回的结果是college_entrance_examination表，里面有考生人数的信息，字段是candidates_count，单位是万人<span class="hljs-operator">。</span>接着，用户又问到“录取人数”，于是再次调用match_metadata工具，参数是“录取人数”，得到的是college_entrance_admission表，对应的字段是admission_count，同样单位是万人<span class="hljs-operator">。</span>

接下来，我需要从这两个表中查询<span class="hljs-number">2016</span>年的数据<span class="hljs-operator">。</span>先执行第一个<span class="hljs-type">SQL查询，从college_entrance_examination表中选出examination_year等于2016年的考生人数，结果得到940</span>.<span class="hljs-number">0</span>万人<span class="hljs-operator">。</span>然后执行第二个<span class="hljs-type">SQL查询，从college_entrance_admission表中选出admission_year等于2016年的录取人数，结果是772</span>.<span class="hljs-number">0</span>万人<span class="hljs-operator">。</span>

确认两个结果都是<span class="hljs-number">2016</span>年的数据后，将这两个数值汇总，得到最终答案：<span class="hljs-number">2016</span>年考生人数是<span class="hljs-number">940</span>万人，录取人数是<span class="hljs-number">772</span>万人<span class="hljs-operator">。</span>需要确保单位正确，并且数据没有错误<span class="hljs-operator">。</span>这里的数据看起来合理，没有异常值，所以可以确定答案正确<span class="hljs-operator">。</span>
<span class="hljs-operator">&lt;/</span>think<span class="hljs-operator">&gt;</span>

<span class="hljs-number">2016</span>年的考生人数和录取人数分别为：

<span class="hljs-operator">-</span> <span class="hljs-operator">**</span>考生人数<span class="hljs-operator">**</span>：<span class="hljs-number">940</span>万人  
<span class="hljs-operator">-</span> <span class="hljs-operator">**</span>录取人数<span class="hljs-operator">**</span>：<span class="hljs-number">772</span>万人  

数据来源：
<span class="hljs-operator">-</span> 考生人数来自<span class="hljs-operator">《</span>考生人数与复读人数信息表<span class="hljs-operator">》</span>（`college_entrance_examination`）的 `candidates_count` 字段
<span class="hljs-operator">-</span> 录取人数来自<span class="hljs-operator">《</span>录取人数与普通高校数信息表<span class="hljs-operator">》</span>（`college_entrance_admission`）的 `admission_count` 字段最终结果: <span class="hljs-operator">&lt;</span>think<span class="hljs-operator">&gt;</span>
好的，用户问的是<span class="hljs-number">2016</span>年的考生人数和录取人数分别是多少<span class="hljs-operator">。</span>我需要先找到这两个数据分别存放在哪个表里<span class="hljs-operator">。</span>

首先，用户的问题涉及到“考生人数”，所以我调用了match_metadata工具，参数是“考生人数”<span class="hljs-operator">。</span>返回的结果是college_entrance_examination表，里面有考生人数的信息，字段是candidates_count，单位是万人<span class="hljs-operator">。</span>接着，用户又问到“录取人数”，于是再次调用match_metadata工具，参数是“录取人数”，得到的是college_entrance_admission表，对应的字段是admission_count，同样单位是万人<span class="hljs-operator">。</span>

接下来，我需要从这两个表中查询<span class="hljs-number">2016</span>年的数据<span class="hljs-operator">。</span>先执行第一个<span class="hljs-type">SQL查询，从college_entrance_examination表中选出examination_year等于2016年的考生人数，结果得到940</span>.<span class="hljs-number">0</span>万人<span class="hljs-operator">。</span>然后执行第二个<span class="hljs-type">SQL查询，从college_entrance_admission表中选出admission_year等于2016年的录取人数，结果是772</span>.<span class="hljs-number">0</span>万人<span class="hljs-operator">。</span>

确认两个结果都是<span class="hljs-number">2016</span>年的数据后，将这两个数值汇总，得到最终答案：<span class="hljs-number">2016</span>年考生人数是<span class="hljs-number">940</span>万人，录取人数是<span class="hljs-number">772</span>万人<span class="hljs-operator">。</span>需要确保单位正确，并且数据没有错误<span class="hljs-operator">。</span>这里的数据看起来合理，没有异常值，所以可以确定答案正确<span class="hljs-operator">。</span>
<span class="hljs-operator">&lt;/</span>think<span class="hljs-operator">&gt;</span>

<span class="hljs-number">2016</span>年的考生人数和录取人数分别为：

<span class="hljs-operator">-</span> <span class="hljs-operator">**</span>考生人数<span class="hljs-operator">**</span>：<span class="hljs-number">940</span>万人  
<span class="hljs-operator">-</span> <span class="hljs-operator">**</span>录取人数<span class="hljs-operator">**</span>：<span class="hljs-number">772</span>万人  

数据来源：
<span class="hljs-operator">-</span> 考生人数来自<span class="hljs-operator">《</span>考生人数与复读人数信息表<span class="hljs-operator">》</span>（`college_entrance_examination`）的 `candidates_count` 字段
<span class="hljs-operator">-</span> 录取人数来自<span class="hljs-operator">《</span>录取人数与普通高校数信息表<span class="hljs-operator">》</span>（`college_entrance_admission`）的 `admission_count` 字段
</code></pre>
<p>QwenAgent框架也是和第三章的LangChain框架ReAct流程一样，通过推理、观察、思考、行动完成了多数据源复杂问题的回答。</p>
<p>把复杂问题拆分为简单问题、然后利用我们制定好的流程查出数据，汇总输出！</p>
<h2 data-id="heading-4">五、展望</h2>
<p>本文AI Agent的实践过程中，我们了解了es8作为外接知识库检索的基本使用方式(RAG)，语义检索、数据查询、大模型分析的基本流程。了解了LangChain和QwenAgent框架的使用。</p>
<p>进一步实践方向：</p>
<ul>
<li>场景优化：加入部分心仪的高校数据，每个高校的每个专业在每个省份的招生情况，丰富Agent知识，提供更多更好的服务！</li>
<li>检索优化：本文只使用了ES8内部向量类型支持的基本KNN检索，利用余弦相似度计算+分词计算，混合得分后返回，后续可以尝试其他高级检索方式。</li>
<li>ReAct优化：本文我们的ReAct实践，只使用了LangChain框架的AgentType.STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION模式，可以实践其他模式效果！</li>
<li>流程优化：本文我们的ReAct工具只有语义检索与数据查询两个，没有涉及复杂计算，加入高校信息需要做分段同环比计算，需要加入新的流程，使用新的工具！流程比较简单，作为学习使用，场景丰富后可以进一步优化流程！</li>
<li>其他开发模式：本文所列三种开发实践都是基于代码的模式，还可以尝试用Dify、Coze Studio这类低代码工具来配置智能体。</li>
</ul>
<h2 data-id="heading-5">六、附录</h2>
<h3 data-id="heading-6">6.1. 开发环境</h3>
<p>核心工具与运行时 (Core Tools &amp; Runtimes)</p>






























<table><thead><tr><th>工具名称</th><th>推荐版本</th><th>说明</th></tr></thead><tbody><tr><td>操作系统</td><td>macOS 15.6.1</td><td>MacBook pro m1 max 32GB</td></tr><tr><td>Docker Desktop</td><td>28.3.2</td><td>本地Docker环境</td></tr><tr><td>Python</td><td>3.9</td><td>python实现我们的AI Agent</td></tr><tr><td>IDE/编辑器</td><td>VS Code / PyCharm</td><td>开发工具</td></tr></tbody></table>
<p>项目依赖与服务 (Project Dependencies &amp; Services)</p>





























<table><thead><tr><th>服务名称</th><th>版本</th><th>端口</th><th>说明</th></tr></thead><tbody><tr><td>Ollama</td><td>0.11.6</td><td>11434</td><td>大模型运行环境，运行deepseek-r1:32b、qwen3:32b、llama2</td></tr><tr><td>MySQL</td><td>8.4.6</td><td>3306</td><td>本地docker部署，'业务知识库'</td></tr><tr><td>ElasticSearch</td><td>8.19.0</td><td>9200</td><td>本地docker部署，支持向量存储、检索</td></tr></tbody></table>
<h3 data-id="heading-7">6.2. ES8检索</h3>
<p>为什么使用ES8？</p>
<p>ElasticSearch是一个开源的分布式搜索和分析引擎，主要用于海量文本检索与分析，使用 JSON 格式存储数据，能通过简单的 REST API 进行交互，便于集成。</p>
<p>7.x之前的版本支持text(全文检索字段，支持分词)、keyword(精确值字段，适合过滤、聚合)、numeric、binary、date等传统的基本的数据类型字段。</p>
<p>7.x之后引入dense_vector(向量类型，存储浮点数密集向量如BERT、Word2Vec、Sentence Transformers 生成的向量，维度dims必须提前定义声明，无法修改)。</p>
<p>从8.16版本之后，新增对位类型（bit，0或1）和字节类型（byte，以字节）向量的支持，通过element_type参数指定。默认float(4字节32位浮点数)。数据量较大时可指定byte或bit，牺牲精度以节省存储空间。</p>
<p>支持的量化类型：</p>
<p>7.3-7.4：新增多种向量相似度计算方式（如L2范数即欧几里得距离、点积、余弦相似度、最大内积（适用于负值向量）等）。</p>
<p>8.0：正式支持近似KNN搜索API（基于HNSW算法），显著提升大规模向量检索效率，存储成本大幅下降的同时保持较高的检索准确率。</p>
<p>8.16：扩展支持位(bit)和字节(byte)向量类型，优化存储和计算效率</p>
<p>示例：</p>
<pre><code class="hljs language-ruby" lang="ruby">{
<span class="hljs-string">"mappings"</span><span class="hljs-symbol">:</span>{
    <span class="hljs-string">"properties"</span><span class="hljs-symbol">:</span>{
      <span class="hljs-string">"my_vector"</span><span class="hljs-symbol">:</span>{<span class="hljs-regexp">//</span> 字段名称
        <span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"dense_vector"</span></span>,
        <span class="hljs-string">"dims"</span><span class="hljs-symbol">:</span><span class="hljs-number">768</span>,<span class="hljs-regexp">//</span> 和向量化使用的大模型的维度保持一致，不一致插入与检索存在异常
        <span class="hljs-string">"index"</span><span class="hljs-symbol">:true</span>,<span class="hljs-regexp">//</span> <span class="hljs-literal">true</span>时支持<span class="hljs-variable constant_">KNN</span>搜索
        <span class="hljs-string">"element_type"</span><span class="hljs-symbol">:<span class="hljs-string">"byte"</span></span>,<span class="hljs-regexp">//</span> int8一字节
        <span class="hljs-string">"index_options"</span><span class="hljs-symbol">:</span>{
          <span class="hljs-string">"type"</span><span class="hljs-symbol">:<span class="hljs-string">"int8_hnsw"</span>//</span> int8 量化 + <span class="hljs-variable constant_">HNSW</span> 算法，必须配置element_type=byte使用
        }
      }
    }
}
}
</code></pre>
<p>基于以上优点。</p>
<p>对于Mysql的表结构，我们需要将表字段存储到ES8做向量化，对于用户输入的自然语言，先进行语义检索匹配，索引设计如下：</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"mappings"</span>:{
      <span class="hljs-string">"properties"</span>:{
          <span class="hljs-string">"table_info"</span>:{<span class="hljs-string">"type"</span>:<span class="hljs-string">"keyword"</span>},
          <span class="hljs-string">"nomic_embedding"</span>:{
              <span class="hljs-string">"type"</span>:<span class="hljs-string">"dense_vector"</span>,
              <span class="hljs-string">"dims"</span>:<span class="hljs-number">4096</span>,
              <span class="hljs-string">"index"</span>: <span class="hljs-literal">True</span>,
              <span class="hljs-string">"similarity"</span>:<span class="hljs-string">"cosine"</span>,
          }
      }
}
}
</code></pre>
<p>table_info存储表结构信息，nomic_embedding存储表备注向量化信息，指定相似度检索算法为cosine余弦相似度。</p>
<h3 data-id="heading-8">6.3. LangChain 常见 AgentType</h3>
<p>本文我们使用LangChain的AgentType.STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION实现ReAct代理模式，主要含义如下：</p>

























<table><thead><tr><th>部分</th><th>含义</th></tr></thead><tbody><tr><td>STRUCTURED_CHAT</td><td>支持结构化输入（如 JSON 格式）的聊天式 Agent，能处理复杂参数</td></tr><tr><td>ZERO_SHOT</td><td>不依赖于之前的记忆或历史步骤，每一步都独立推理（无“计划”缓存）</td></tr><tr><td>REACT</td><td>使用 <strong>ReAct 框架</strong>（Reason + Act），即“思考 → 决策 → 执行 → 观察”循环</td></tr><tr><td>DESCRIPTION</td><td>工具通过其</td></tr></tbody></table>
<p>特点：</p>
<ul>
<li>✅ 支持多工具调用</li>
<li>✅ 支持带参数的复杂工具（如 SQL 查询带条件）</li>
<li>✅ 使用自然语言 + 结构化格式（如 JSON）进行工具调用</li>
<li>✅ 适合需要 多步推理 + 参数传递 的场景（如先语义解析再查数据库）</li>
<li>✅ 每次决策基于当前上下文重新推理（zero-shot），不依赖预定义流程</li>
</ul>
<p>其他类型：</p>





































































<table><thead><tr><th>AgentType</th><th>说明</th><th>是否支持多工具</th><th>是否支持结构化输入</th><th>是否支持 ReAct</th><th>适用场景</th></tr></thead><tbody><tr><td>ZERO_SHOT_REACT_DESCRIPTION</td><td>基础 ReAct Agent，文本形式调用工具</td><td>✅</td><td>❌（仅字符串）</td><td>✅</td><td>简单工具链，如计算器+搜索</td></tr><tr><td>STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION</td><td>支持结构化参数的 ReAct Agent</td><td>✅</td><td>✅（JSON 等）</td><td>✅</td><td>复杂工具调用（带参数）</td></tr><tr><td>CONVERSATIONAL_REACT_DESCRIPTION</td><td>支持对话记忆的 ReAct Agent，适合聊天机器人</td><td>✅</td><td>❌</td><td>✅</td><td>客服、对话式助手</td></tr><tr><td>SELF_ASK_WITH_SEARCH</td><td>使用“自问自答”机制 + 中间子问题分解</td><td>✅（有限）</td><td>❌</td><td>❌</td><td>复杂逻辑推理（如维基搜索）</td></tr><tr><td>REACT_DOCSTORE</td><td>基于文档存储的 ReAct（如查找文档）</td><td>✅</td><td>❌</td><td>✅</td><td>文档检索系统</td></tr><tr><td>OPENAI_FUNCTIONS</td><td>使用 OpenAI 的</td><td>✅</td><td>✅</td><td>✅</td><td>GPT-3.5-turbo / GPT-4 推荐</td></tr><tr><td>OPENAI_MULTI_FUNCTIONS</td><td>支持一次调用多个函数（OpenAI 扩展）</td><td>✅</td><td>✅</td><td>✅</td><td>高效批量工具调用</td></tr></tbody></table>
<p>本文说明：本文因为太长所以分成三篇文章，这是最后一篇，具体业务场景和其他两种方式参见之前文章。</p>
<p>本文作者：Chaiys</p>
<p>本文原载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAYlyJKKNauFtw0e9QbMUBg" target="_blank" title="https://mp.weixin.qq.com/s/AYlyJKKNauFtw0e9QbMUBg" ref="nofollow noopener noreferrer">公众号“木昆子记录AI”</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026年前端生存指南：我用MCP把繁琐的菜单配置全自动化了！]]></title>    <link>https://juejin.cn/post/7591770429930668082</link>    <guid>https://juejin.cn/post/7591770429930668082</guid>    <pubDate>2026-01-06T01:53:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591770429930668082" data-draft-id="7591805786397900826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026年前端生存指南：我用MCP把繁琐的菜单配置全自动化了！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-06T01:53:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="那个曾经的少年回来了"/> <meta itemprop="url" content="https://juejin.cn/user/2242659452477016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026年前端生存指南：我用MCP把繁琐的菜单配置全自动化了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659452477016/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    那个曾经的少年回来了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:53:09.000Z" title="Tue Jan 06 2026 01:53:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df3279b599b24b0dbd318cea03cb9e77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YKj5Liq5pu-57uP55qE5bCR5bm05Zue5p2l5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768269247&amp;x-signature=LvKHgw1tfk4wtLlMyf1q%2BGtdQyk%3D" alt="" loading="lazy"/>
先说一下背景，我相信很多前端可能有这样的情况。来了一个比较大的新的需求，暂时就先说PC web端吧。很多系统的设计都在后台有一个菜单管理，然后大致会讲过下面几个步骤。</p>
<ul>
<li>1、后台配置菜单：在管理后台添加新菜单的基本信息，有时也包括具体操作按钮的配置。</li>
<li>2、前端配置路由：在 Vue 或 React 路由配置中，添加对应的页面路由映射信息。</li>
<li>3、前端新建视图：在 views或 pages目录下，创建实际的页面文件。</li>
<li>4、角色权限绑定：找到当前角色，手动勾选刚才新增的菜单和按钮权限，使功能对当前账号可见。</li>
<li>5、增量迭代配置：开发中途若需新增按钮，需再次重复上述“后台配置”与“权限勾选”的动作。</li>
</ul>
<p>当然各种系统的配置可能不尽相同，有些系统可能更灵活一些，很多东西都考虑到了，都进行了自动化操作。</p>
<p>接下来我们的MCP登场了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cdc52e087824850b5d75f0f3f298245~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YKj5Liq5pu-57uP55qE5bCR5bm05Zue5p2l5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768269247&amp;x-signature=gqImvNgdkIiA3KxOfSvx2eKZkXI%3D" alt="" loading="lazy"/></p>
<p>通过截图可以看出来，我的MCP服务工具，有查询菜单列表、查询单个菜单、创建菜单、修改菜单、删除菜单、查询角色和为角色添加菜单权限，这里我MCP工具就是调用了后台管理的接口，有些接口不适配我又新增了适配（这个也没关系）。</p>
<p>再来看我在聊天回话框中的内容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfa8515646484a7f8c466a1ecc07aa9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YKj5Liq5pu-57uP55qE5bCR5bm05Zue5p2l5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768269247&amp;x-signature=Dw5q9YuwfL44uZutpyr9pGUTxtc%3D" alt="" loading="lazy"/>
首先我上传了一张截图，里面包含了几个按钮（当然之前页面已经有了三个操作按钮了），截图下我的意思也很明显了，生成按钮代码，根据按钮名称生成了code,然后让他添加菜单（这里它的理解就是调用我的MCP工具生成菜单）。</p>
<p>继续看我下面的截图，很清楚的就展现了先是先是调用search-menu来查找父级菜单的菜单ID，然后再调用create-menu插入菜单的过程。</p>
<p>中间还有截图太长了我就没继续截图了......</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a68be22c4cd04027aeb92eac821c4c83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YKj5Liq5pu-57uP55qE5bCR5bm05Zue5p2l5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768269247&amp;x-signature=P9g70Xj3gkVpsN%2Ffjn8AvlXGaH4%3D" alt="" loading="lazy"/></p>
<p>这是这个对话最后一部分的截图，可以看到一次性帮我把九个按钮操作全部调用MCP写入到了数据库，真的太棒了。</p>
<blockquote>
<p>其实最开始，我的想法就是每次执行一步。查找父级菜单==&gt;写入导入按钮操作==&gt;根据角色名称查找角色Id=&gt;为当前角色写入导入按钮操作，这样一个过程。</p>
</blockquote>
<blockquote>
<p>这样我不用在PC后台进行操作其实已经很爽了（个人觉得，因为我们的后端系统相对复杂，路径也比较深，数据量也比较大，导致维护菜单非常的浪费时间）。但是没想到这里它可以一次性就写入9个按钮的菜单信息，我当时就惊讶了。下面还有更令我happy的。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f232f8507f6f444e8724d4d125430b49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YKj5Liq5pu-57uP55qE5bCR5bm05Zue5p2l5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768269247&amp;x-signature=da9%2FJvpu5m%2BuKWHBdx7onemAlf4%3D" alt="" loading="lazy"/>
继续看上图，就是把上面所有的九个按钮操作权限全部添加到某个角色ID。当然这个角色是我单独查询出来的，然后写在上面的。（里面有一个提示500了，因为我之前已经添加过权限了，可以忽略）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b682bd0acde44ab802fcb919df613ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YKj5Liq5pu-57uP55qE5bCR5bm05Zue5p2l5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768269247&amp;x-signature=9sextStyaBTj4lJYWef6S06C%2FgI%3D" alt="" loading="lazy"/>
这就是最终把九个按钮操作权限都添加到该角色上了。</p>
<p>但是我在检查需求的时候发现少了一个按钮。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1f69d42590346ffbb0af44a237a8b1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YKj5Liq5pu-57uP55qE5bCR5bm05Zue5p2l5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768269247&amp;x-signature=9P06q9SIBH9s%2BPF4aGIKX0RDrkg%3D" alt="" loading="lazy"/></p>
<p>看我提示词非常简洁的对话。但是他就分析了一下，然后首先在页面上添加按钮生成code,然后生成菜单，并且把权限也添加上了。</p>
<p>真的让我大开眼界。通过截图可以发现后面两个还有多余的处理，就是修改菜单的按钮顺序报错了，其实是我写的接口有问题（后面接口问题我自己修改）了，不是他多余了。</p>
<p>所以MCP在现在AI Agent的强大下，让我大开眼界。好了本文就介绍到这里，好让前端的loster们都来尝试一下吧，，要不然2026年下一个被淘汰的可能就是你了。同时如果你看到了那就大胆的去玩吧。没有什么比实践更重要的了。</p>
<p>最后我现在使用的工具是Google Antigravity。</p>
<p>当然了电脑上也装了Claude code、Codex和OpenCode。</p>
<p>最近vibe coding对部分程序员的冲击非常大。尤其是在Claude Opus4.5的加持下，真的要变天了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[几种AI Agent开发框架对比：相比手写代码是否更便捷？]]></title>    <link>https://juejin.cn/post/7591510742648602667</link>    <guid>https://juejin.cn/post/7591510742648602667</guid>    <pubDate>2026-01-05T11:11:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591510742648602667" data-draft-id="7591506455973576758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="几种AI Agent开发框架对比：相比手写代码是否更便捷？"/> <meta itemprop="keywords" content="后端,Python,人工智能"/> <meta itemprop="datePublished" content="2026-01-05T11:11:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木昆子"/> <meta itemprop="url" content="https://juejin.cn/user/825103640698564"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            几种AI Agent开发框架对比：相比手写代码是否更便捷？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/825103640698564/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木昆子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T11:11:44.000Z" title="Mon Jan 05 2026 11:11:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在之前几篇文章中，Chaiys同学设计了一个高考信息查询智能助手AI Agent业务场景，分别使用<a href="https://juejin.cn/post/7591407298414493702" target="_blank" title="https://juejin.cn/post/7591407298414493702">手写代码</a>、<a href="https://juejin.cn/post/7591497387245994020" target="_blank" title="https://juejin.cn/post/7591497387245994020">LangChain框架</a>、<a href="https://juejin.cn/spost/7591506455973462070" target="_blank" title="https://juejin.cn/spost/7591506455973462070">QwenAgent框架</a>、<a href="https://juejin.cn/post/7591672090790461459" target="_blank" title="https://juejin.cn/post/7591672090790461459">AgentScope框架</a>实现了一次，学习了几大框架如何开发智能体。</p>
<p>在此基础上，我们进一步对比它们在业务逻辑编排、大模型调用、工具调用、上下文记忆、多智能体协作等方面的差异，看看框架是否确实能方便我们进行智能体开发。</p>
<h2 data-id="heading-0"><strong>业务逻辑编排对比</strong></h2>
<p>首先回顾一下我们的业务流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/621e749896194405ac3bd655abd4c2e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5piG5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768217065&amp;x-signature=NhKbwE5%2FF5jENst1FeI3j0xvCig%3D" alt="image.png" loading="lazy"/></p>
<p>接下来分别使用手写代码和几种框架来实现这个业务流程逻辑，看看差异所在。</p>
<h4 data-id="heading-1">1、手写代码</h4>
<p>纯编码时，我们直接根据业务逻辑来串联工作流：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># sql agent</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sql_agent</span>(<span class="hljs-params">user_query</span>):
    <span class="hljs-comment"># 1. 语义匹配</span>
    table = semanticService.hybrid_search(user_query, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> table:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未匹配到字段"</span>)
        <span class="hljs-keyword">return</span> Result.error()
    table_struct = [t[<span class="hljs-string">"table_info"</span>] <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> table]
    prompt = <span class="hljs-string">f"""
            你是一个MySQL专家。根据以下表结构信息：
            <span class="hljs-subst">{table_struct}</span>

            历史问答（仅供参考）："<span class="hljs-subst">{mm.get_messages(session_id)}</span>"
            
            用户查询："<span class="hljs-subst">{user_query}</span>"

            生成标准MYSQL查询语句。
            要求：
            1. 只输出MYSQL语句，不要额外解释
            2. 根据语义和字段类型，使用COUNT/SUM/AVG等聚合函数进行计算，非必须
            3. 给生成的字段取一个简短的中文名称
            输出格式：使用[]包含sql文本即可，不需要其他输出，便于解析，例如:[select 1 from dual]
        """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"SQL AGENT PROMPT=<span class="hljs-subst">{prompt}</span>"</span>)
    <span class="hljs-comment"># 2. 大模型生成SQL</span>
    str1 = analysisService.analysis(prompt)
    sql = re.search(<span class="hljs-string">r'[(.*?)]'</span>, str1, re.DOTALL).group(<span class="hljs-number">1</span>).strip()

    <span class="hljs-comment"># 3. 执行查询</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sql:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nSQL生成失败"</span>)
        <span class="hljs-keyword">return</span> Result.error()

    resultSet = queryService.query_with_column(sql)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resultSet:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nSQL查询失败"</span>)
        <span class="hljs-keyword">return</span> Result.error()
    <span class="hljs-keyword">return</span> Result.success(data={ <span class="hljs-string">"tableStruct"</span>: table_struct, <span class="hljs-string">"resultSet"</span>: resultSet, <span class="hljs-string">"sql"</span>: sql })

<span class="hljs-comment"># analysis agent</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analysis_agent</span>(<span class="hljs-params">user_query, data</span>):
    <span class="hljs-comment"># 基础分析</span>
    prompt = <span class="hljs-string">f"""
                根据以下表结构信息：
                <span class="hljs-subst">{data[<span class="hljs-string">'tableStruct'</span>]}</span>
                
                查询SQL：
                <span class="hljs-subst">{data[<span class="hljs-string">'sql'</span>]}</span>
                
                和以下数据信息：
                <span class="hljs-subst">{data[<span class="hljs-string">'resultSet'</span>]}</span>

                历史问答（仅供参考）："<span class="hljs-subst">{mm.get_messages(session_id)}</span>"
                
                用户查询："<span class="hljs-subst">{user_query}</span>"

                生成一段简要分析，加上一些预测总结的内容
            """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ANALYSIS AGENT PROMPT=<span class="hljs-subst">{prompt}</span>"</span>)
    <span class="hljs-keyword">return</span> Result.success(analysisService.analysis(prompt))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">workflow</span>(<span class="hljs-params">user_input</span>):
    <span class="hljs-comment"># 1 - SQL Agent</span>
    result = sql_agent(user_input)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result.success:
        returnNone
    <span class="hljs-comment"># 2 - Analysis Agent</span>
    <span class="hljs-keyword">return</span> analysis_agent(user_input, result.data)
</code></pre>
<h4 data-id="heading-2">2、LangChain框架</h4>
<p>使用LangChain框架的Chain模式时，可以手动串联业务流程逻辑：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 构建顺序链</span>
<span class="hljs-attr">overall_chain</span> = SequentialChain(
    <span class="hljs-attr">chains</span>=[
        TransformChain(
            input_variables=[<span class="hljs-string">"user_query"</span>],
            output_variables=[<span class="hljs-string">"table_schema"</span>],
            transform=get_table_schema
        ),
        TransformChain(
            input_variables=[<span class="hljs-string">"user_query"</span>, <span class="hljs-string">"table_schema"</span>],
            output_variables=[<span class="hljs-string">"sql_result"</span>, <span class="hljs-string">"generated_sql"</span>],
            transform=execute_sql
        ),
        analysis_chain
    ],
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"user_query"</span>],
    <span class="hljs-attr">output_variables</span>=[<span class="hljs-string">"analysis_result"</span>],
    <span class="hljs-attr">verbose</span>=<span class="hljs-literal">True</span>
)
</code></pre>
<p>LangChain 已经发展出丰富的 Chain 类型，用于构建复杂、模块化的 LLM 应用，这里就不一一介绍了。</p>
<p>LangChain框架除了提供Chain模式外，还可以使用的Agent模式来实现，通过提示词来指定业务流程逻辑，然后直接调用工具，如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 初始化Agent</span>
<span class="hljs-attr">agent</span> = initialize_agent(
    <span class="hljs-attr">tools</span>=[semantic_tool, sql_tool],
    <span class="hljs-attr">llm</span>=llm,
    <span class="hljs-attr">agent</span>=AgentType.STRUCTURED_CHAT_ZERO_SHOT_REACT_DESCRIPTION,
    <span class="hljs-attr">verbose</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">handle_parsing_errors</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">max_iterations</span>=<span class="hljs-number">10</span>,  <span class="hljs-comment"># 增加最大迭代次数以支持多步查询</span>
    <span class="hljs-attr">early_stopping_method</span>=<span class="hljs-string">"generate"</span>
)

def chat(user_query):
    print("执行方法chat")

    <span class="hljs-comment"># 更明确的指令</span>
    <span class="hljs-attr">enhanced_query</span> = f<span class="hljs-string">"""
    问题：{user_query}

    请特别注意：这个问题可能需要从多个表中查询数据。
    1. 首先确定需要查询哪些数据
    2. 使用match_metadata工具分别匹配包含这些数据的表结构
    3. 对每个表生成相应的SQL查询语句
    4. 执行查询并汇总结果
    5. 最后计算并给出答案

    请确保逐步执行，不要跳过任何步骤。
    """</span>

    try:
        <span class="hljs-attr">result</span> = agent.run(enhanced_query)
        print(f"\n最终结果: {result}")
    except Exception as e:
        print(f"执行过程中出错: {str(e)}")
        <span class="hljs-comment"># 这里可以添加重试或更详细的错误处理逻辑</span>
</code></pre>
<h4 data-id="heading-3">3、QwenAgent框架</h4>
<p>QwenAgent框架则只能通过提示词方式指定业务流程逻辑，然后直接调用Assistant等待用户输入：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建Agent实例</span>
<span class="hljs-attr">agent</span> = Assistant(
    <span class="hljs-attr">name</span>=<span class="hljs-string">'ai_agent_assistant'</span>,
    <span class="hljs-attr">llm</span>={
        'model': 'qwen3:32b',
        'model_server': 'http://localhost:11434/v1',
    },
    <span class="hljs-attr">system_message</span>=<span class="hljs-string">"""
        你是一个数据分析助手，负责帮助用户查询数据库信息。
        请特别注意：用户的问题可能需要从多个表中查询数据。
        1. 首先确定需要查询哪些数据
        2. 使用match_metadata工具分别匹配包含这些数据的表结构
        3. 对每个表生成相应的SQL查询语句
        4. 执行查询并汇总结果
        5. 最后计算并给出答案

        请确保逐步执行，不要跳过任何步骤。
    """</span>,
    <span class="hljs-attr">function_list</span>=[MatchMetadataTool(), ExecuteSQLTool()],
)
</code></pre>
<h4 data-id="heading-4">4、AgentScope框架</h4>
<p>AgentScope框架中支持单体Agent模式，将工具提供给框架，再通过提示词来指定业务流程逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">async def interactive_react_agent() -&gt; None:
    """创建一个支持多轮对话的ReAct智能体。"""
    <span class="hljs-comment"># 准备工具</span>
    <span class="hljs-attr">toolkit</span> = Toolkit()
    toolkit.register_tool_function(match_metadata)
    toolkit.register_tool_function(execute_sql)

    <span class="hljs-attr">jarvis</span> = ReActAgent(
        <span class="hljs-attr">name</span>=<span class="hljs-string">"Jarvis"</span>,
        <span class="hljs-attr">sys_prompt</span>=<span class="hljs-string">"""
            你是一个数据分析助手，负责帮助用户查询数据库信息。
            请特别注意：用户的问题可能需要从多个表中查询数据。
            1. 首先确定需要查询哪些数据
            2. 使用match_metadata工具分别匹配包含这些数据的表结构
            3. 对每个表生成相应的SQL查询语句
            4. 执行查询并汇总结果
            5. 最后计算并给出答案

            请确保逐步执行，不要跳过任何步骤。
        """</span>,
        <span class="hljs-attr">model</span>=OllamaChatModel(
            <span class="hljs-attr">model_name</span>=<span class="hljs-string">"qwen3:32b"</span>,  <span class="hljs-comment"># 指定模型名称</span>
            <span class="hljs-attr">stream</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 根据需要设置是否流式输出</span>
            <span class="hljs-attr">enable_thinking</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 为Qwen3启用思考功能（可选）</span>
            <span class="hljs-comment"># host="http://localhost:11434" # 如果Ollama不在默认地址，需指定</span>
        ),
        <span class="hljs-attr">formatter</span>=OllamaChatFormatter(),
        <span class="hljs-attr">toolkit</span>=toolkit,
        <span class="hljs-attr">memory</span>=InMemoryMemory(),
    )
</code></pre>
<h4 data-id="heading-5">小结</h4>
<p>手写代码需人工串联各个步骤，灵活但开发成本高，维护复杂。各框架则提供了丰富的链（Chain）或Agent模式，支持流程模块化、工具调用自动化，极大提升开发效率和可维护性。</p>
<h2 data-id="heading-6"><strong>模型调用对比</strong></h2>
<p>接下来看看手写代码和使用开发框架，都是如何调用大模型的，如何处理大模型的流式输出的。</p>
<h4 data-id="heading-7">1、手写代码</h4>
<p>通过HTTP方式调用外部大模型示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-comment"># Analysis API</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AnalysisService</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.ollama_host = <span class="hljs-string">"http://localhost:11434/api/chat"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">analysis</span>(<span class="hljs-params">self, prompt, model=<span class="hljs-string">"deepseek-r1:32b"</span>, messages=<span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># 发送POST请求</span>
        <span class="hljs-keyword">if</span> messages isNone:
            messages = []
        <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
        newMessages = messages[:]
        newMessages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt})
        <span class="hljs-comment"># 请求数据</span>
        data = {
            <span class="hljs-string">"model"</span>: model,
            <span class="hljs-string">"messages"</span>: newMessages,
            <span class="hljs-string">"stream"</span>: <span class="hljs-literal">True</span>
        }
        isThinking = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">with</span> requests.post(self.ollama_host, json=data, stream=<span class="hljs-literal">True</span>) <span class="hljs-keyword">as</span> response:
            <span class="hljs-comment"># 处理流式响应</span>
            <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> response.iter_lines():
                <span class="hljs-keyword">if</span> line:
                    decoded_line = line.decode(<span class="hljs-string">'utf-8'</span>)
                    <span class="hljs-keyword">try</span>:
                        <span class="hljs-comment"># 解析JSON数据</span>
                        chunk = json.loads(decoded_line)
                        content = chunk[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>]
                        <span class="hljs-keyword">if</span> <span class="hljs-string">"&lt;think&gt;"</span><span class="hljs-keyword">in</span> content:
                            isThinking = <span class="hljs-literal">True</span>
                        <span class="hljs-keyword">if</span> <span class="hljs-string">"&lt;/think&gt;"</span><span class="hljs-keyword">in</span> content:
                            isThinking = <span class="hljs-literal">False</span>
                        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isThinking <span class="hljs-keyword">and</span><span class="hljs-string">"&lt;/think&gt;"</span>notin content:
                            <span class="hljs-built_in">str</span> += chunk[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>]
                        <span class="hljs-comment"># 打印消息内容</span>
                        <span class="hljs-built_in">print</span>(chunk[<span class="hljs-string">'message'</span>][<span class="hljs-string">'content'</span>], end=<span class="hljs-string">''</span>, flush=<span class="hljs-literal">True</span>)
                    <span class="hljs-keyword">except</span> json.JSONDecodeError:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"无法解析JSON: <span class="hljs-subst">{decoded_line}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>
</code></pre>
<p>使用官方或社区封装的 Python 包（如 ollama 包）调用示例：</p>
<pre><code class="hljs language-ini" lang="ini">import ollama

<span class="hljs-comment"># 调用模型生成回复，流式输出</span>
for chunk in ollama.chat(
    <span class="hljs-attr">model</span>=<span class="hljs-string">'deepseek-r1:32b'</span>,
    <span class="hljs-attr">messages</span>=[{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: <span class="hljs-string">'讲一个笑话'</span>}],
    <span class="hljs-attr">stream</span>=<span class="hljs-literal">True</span>
):
    print(chunk<span class="hljs-section">['message']</span><span class="hljs-section">['content']</span>, <span class="hljs-attr">end</span>=<span class="hljs-string">''</span>, flush=<span class="hljs-literal">True</span>)
</code></pre>
<h4 data-id="heading-8">2、LangChain框架</h4>
<p>LangChain内部集成支持多种类型的模型调用，以下列举部分：</p>



































<table><thead><tr><th>模型类型</th><th>支持模型示例</th><th>示例代码</th></tr></thead><tbody><tr><td>GGUF 格式（Llama.cpp）</td><td>Llama 3, Mistral, Phi-3, Gemma 等</td><td><code>python from langchain_community.llms import LlamaCpp llm = LlamaCpp(model_path="/path/to/model.gguf", n_ctx=2048) </code></td></tr><tr><td>Transformers （PyTorch）</td><td>Llama 3, Qwen, GLM, Mistral, Falcon 等</td><td><code>python from langchain_community.llms import HuggingFacePipeline pipe = pipeline("text-generation", model="Qwen/Qwen2-7B-Instruct") llm = HuggingFacePipeline(pipeline=pipe) </code></td></tr><tr><td>vLLM （高性能推理）</td><td>支持所有 Transformers 模型</td><td><code>python from langchain_community.llms import VLLM llm = VLLM(model="Qwen/Qwen2-7B-Instruct", tensor_parallel_size=1) </code></td></tr><tr><td>Ollama</td><td>llama3, mistral, phi3, qwen2, gemma 等</td><td><code>python from langchain_ollama import OllamaLLM llm = OllamaLLM(model="llama3") </code></td></tr><tr><td>Local LLM via API</td><td>任意本地模型</td><td><code>python from langchain_openai import ChatOpenAI llm = ChatOpenAI( base_url="&lt;http://localhost:1234/v1&gt;", api_key="not-needed", model="local-model" ) </code></td></tr></tbody></table>
<h4 data-id="heading-9">3、QwenAgent框架</h4>
<p>QwenAgent内部集成支持通用HTTP方式调用大模型：</p>
<pre><code class="hljs language-ini" lang="ini">...
<span class="hljs-comment"># 创建Agent实例</span>
<span class="hljs-attr">agent</span> = Assistant(
    <span class="hljs-attr">name</span>=<span class="hljs-string">'ai_agent_assistant'</span>,
    <span class="hljs-attr">llm</span>={
        'model': 'qwen3:32b',
        'model_server': 'http://localhost:11434/v1',
    },
    ...
</code></pre>
<h4 data-id="heading-10">4、AgentScope框架</h4>
<p>AgentScope内部集成多模型支持：</p>



































<table><thead><tr><th>模型平台</th><th>类名</th><th>说明</th></tr></thead><tbody><tr><td>Ollama</td><td><code>OllamaChatModel</code></td><td>调用本地 Ollama 服务，支持 <code>qwen3:32b</code> 等模型，<strong>支持 <code>enable_thinking=True</code></strong></td></tr><tr><td>阿里云 DashScope（Qwen）</td><td><code>DashScopeChatModel</code></td><td>调用 Qwen 系列 API（qwen-max/plus/turbo/vl），<strong>支持 <code>enable_thinking</code>（Qwen3/QwQ/DeepSeek-R1）</strong></td></tr><tr><td>OpenAI</td><td><code>OpenAIChatModel</code></td><td>调用 GPT 系列（gpt-4o、gpt-3.5-turbo 等），支持 <code>reasoning_effort</code>（o3/o4）</td></tr><tr><td>Anthropic</td><td><code>AnthropicChatModel</code></td><td>调用 Claude 系列（opus/sonnet/haiku），支持 <code>thinking</code> 配置</td></tr><tr><td>Google Gemini</td><td><code>GeminiChatModel</code></td><td>调用 Gemini 1.5/2.0 系列，支持 <code>thinking_config</code>（如 <code>include_thoughts=True</code>）</td></tr></tbody></table>
<h4 data-id="heading-11">小结</h4>
<p>手写代码通常直接调用HTTP接口或使用官方SDK，需自行处理流式输出的循环响应和异常。而几种开发框架都内置对多种模型的统一封装，只要简单配置即可，简化了调用过程，提升了稳定性和扩展性。</p>
<h2 data-id="heading-12"><strong>工具调用对比</strong></h2>
<p>现在AI Agent中调用工具Tools已经是典型场景了，所以接下来对这块做个对比分析。</p>
<h4 data-id="heading-13">1、手写代码</h4>
<p>需要手动调用外部工具：</p>
<pre><code class="hljs language-python" lang="python">...
<span class="hljs-comment"># sql agent</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sql_agent</span>(<span class="hljs-params">user_query</span>):
    <span class="hljs-comment"># 1. 语义匹配</span>
    table = semanticService.hybrid_search(user_query, <span class="hljs-number">1</span>)
    ...
    <span class="hljs-comment"># 3. 执行查询</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sql:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nSQL生成失败"</span>)
        <span class="hljs-keyword">return</span> Result.error()
    
    resultSet = queryService.query_with_column(sql)
    ...
</code></pre>
<h4 data-id="heading-14">2、LangChain框架</h4>
<p>Agent模式初始化传入tools即可：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 初始化Agent</span>
<span class="hljs-attr">agent</span> = initialize_agent(
    <span class="hljs-attr">tools</span>=[semantic_tool, sql_tool],
    <span class="hljs-attr">llm</span>=llm,
    <span class="hljs-attr">agent</span>=AgentType.CONVERSATIONAL_REACT_DESCRIPTION,
    <span class="hljs-attr">verbose</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">handle_parsing_errors</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">max_iterations</span>=<span class="hljs-number">10</span>,  <span class="hljs-comment"># 增加最大迭代次数以支持多步查询</span>
    <span class="hljs-attr">early_stopping_method</span>=<span class="hljs-string">"generate"</span>,
    <span class="hljs-attr">memory</span>=memory
)
</code></pre>
<h4 data-id="heading-15">3、QwenAgent框架</h4>
<p>Agent模式初始化传入tools即可：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建Agent实例</span>
<span class="hljs-attr">agent</span> = Assistant(
    <span class="hljs-attr">name</span>=<span class="hljs-string">'ai_agent_assistant'</span>,
    <span class="hljs-attr">llm</span>={
        'model': 'qwen3:32b',
        'model_server': 'http://localhost:11434/v1',
    },
    <span class="hljs-attr">system_message</span>=<span class="hljs-string">"""
        你是一个数据分析助手，负责帮助用户查询数据库信息。
        请特别注意：用户的问题可能需要从多个表中查询数据。
        1. 首先确定需要查询哪些数据
        2. 使用match_metadata工具分别匹配包含这些数据的表结构
        3. 对每个表生成相应的SQL查询语句
        4. 执行查询并汇总结果
        5. 最后计算并给出答案

        请确保逐步执行，不要跳过任何步骤。
    """</span>,
    <span class="hljs-attr">function_list</span>=[MatchMetadataTool(), ExecuteSQLTool()],
)
</code></pre>
<p>需要处理一下流式输出结果，获取文本内容：</p>
<pre><code class="hljs language-ini" lang="ini">def read_steam_response(response_generator):
    <span class="hljs-comment"># 处理生成器响应</span>
    <span class="hljs-attr">full_response</span> = <span class="hljs-string">''</span>
    <span class="hljs-attr">start</span> = <span class="hljs-number">0</span>
    <span class="hljs-attr">end</span> = <span class="hljs-number">0</span>
    for response in response_generator:
        <span class="hljs-comment"># 检查响应类型并适当处理</span>
        if isinstance(response, list):
            <span class="hljs-comment"># 如果是列表，提取内容</span>
            for item in response:
                if isinstance(item, dict) and'content'in item:
                    <span class="hljs-attr">full_response</span> = item[<span class="hljs-string">'content'</span>]
                    <span class="hljs-attr">end</span> = full_response.__len__()
                elif isinstance(item, str):
                    <span class="hljs-attr">full_response</span> = item
                    <span class="hljs-attr">end</span> = full_response.__len__()
        elif isinstance(response, dict) and'content'in response:
            <span class="hljs-attr">full_response</span> = response[<span class="hljs-string">'content'</span>]
            <span class="hljs-attr">end</span> = full_response.__len__()
        elif isinstance(response, str):
            <span class="hljs-attr">full_response</span> = response
            <span class="hljs-attr">end</span> = full_response.__len__()
        print(f"{full_response<span class="hljs-section">[start:end]</span>}", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>)
        <span class="hljs-attr">start</span> = end

    return full_response
</code></pre>
<h4 data-id="heading-16">4、AgentScope框架</h4>
<p>Agent模式初始化传入tools即可：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 准备工具</span>
<span class="hljs-attr">toolkit</span> = Toolkit()
toolkit.register_tool_function(match_metadata)
toolkit.register_tool_function(execute_sql)

<span class="hljs-attr">jarvis</span> = ReActAgent(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"Jarvis"</span>,
    <span class="hljs-attr">sys_prompt</span>=<span class="hljs-string">"""
        你是一个数据分析助手，负责帮助用户查询数据库信息。
        请特别注意：用户的问题可能需要从多个表中查询数据。
        1. 首先确定需要查询哪些数据
        2. 使用match_metadata工具分别匹配包含这些数据的表结构
        3. 对每个表生成相应的SQL查询语句
        4. 执行查询并汇总结果
        5. 最后计算并给出答案

        请确保逐步执行，不要跳过任何步骤。
    """</span>,
    <span class="hljs-attr">model</span>=OllamaChatModel(
        <span class="hljs-attr">model_name</span>=<span class="hljs-string">"qwen3:32b"</span>,  <span class="hljs-comment"># 指定模型名称</span>
        <span class="hljs-attr">stream</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 根据需要设置是否流式输出</span>
        <span class="hljs-attr">enable_thinking</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 为Qwen3启用思考功能（可选）</span>
        <span class="hljs-comment"># host="http://localhost:11434" # 如果Ollama不在默认地址，需指定</span>
    ),
    <span class="hljs-attr">formatter</span>=OllamaChatFormatter(),
    <span class="hljs-attr">toolkit</span>=toolkit,
    <span class="hljs-attr">memory</span>=InMemoryMemory(),
)
</code></pre>
<h4 data-id="heading-17">小结</h4>
<p>手写开发中需显式调用语义检索、SQL查询等工具，几种框架都支持通过工具注册机制自动完成调用与路由，降低耦合并增强复用。</p>
<h2 data-id="heading-18"><strong>上下文记忆对比</strong></h2>
<p>在AI Agent实践过程中，如果需要实现多轮对话，就会碰到上下文记忆的处理，所以接下来对这块做个对比。</p>
<h4 data-id="heading-19">1、手写代码</h4>
<p>这种模式需要手写代码来管理上下文消息：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> typing importList, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>


<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span>:
    role: <span class="hljs-built_in">str</span><span class="hljs-comment"># "system", "user", "assistant"</span>
    content: <span class="hljs-built_in">str</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_dict</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"role"</span>: self.role, <span class="hljs-string">"content"</span>: self.content}


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageManager</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_history: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):
        <span class="hljs-string">"""
        初始化消息管理器

        :param max_history: 每个 session 最多保留的历史消息数量（不包括 system 消息）
        """</span>
        self.max_history = max_history
        self._sessions: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]] = {}
        self._lock = threading.Lock()  <span class="hljs-comment"># 保证线程安全</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">set_system_message</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""为指定 session 设置 system 消息（会覆盖旧的）"""</span>
        <span class="hljs-keyword">with</span> self._lock:
            <span class="hljs-keyword">if</span> session_id notinself._sessions:
                self._sessions[session_id] = {
                    <span class="hljs-string">"system"</span>: <span class="hljs-literal">None</span>,
                    <span class="hljs-string">"history"</span>: []  <span class="hljs-comment"># 只存 user/assistant 对话</span>
                }
            self._sessions[session_id][<span class="hljs-string">"system"</span>] = Message(role=<span class="hljs-string">"system"</span>, content=content)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_user_message</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""添加用户消息"""</span>
        self._add_message(session_id, <span class="hljs-string">"user"</span>, content)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_assistant_message</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""添加助手回复"""</span>
        self._add_message(session_id, <span class="hljs-string">"assistant"</span>, content)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_message</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span>, role: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">with</span> self._lock:
            <span class="hljs-keyword">if</span> session_id notin self._sessions:
                self._sessions[session_id] = {
                    <span class="hljs-string">"system"</span>: <span class="hljs-literal">None</span>,
                    <span class="hljs-string">"history"</span>: []
                }
            history = self._sessions[session_id][<span class="hljs-string">"history"</span>]
            history.append(Message(role=role, content=content))
            <span class="hljs-comment"># 限制历史长度（只保留最近的 max_history 条 user/assistant 消息）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(history) &gt; self.max_history * <span class="hljs-number">2</span>:  <span class="hljs-comment"># 每轮对话含 user + assistant</span>
                <span class="hljs-comment"># 保留最后 max_history * 2 条</span>
                self._sessions[session_id][<span class="hljs-string">"history"</span>] = history[-(self.max_history * <span class="hljs-number">2</span>):]

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_messages</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
        <span class="hljs-string">"""获取可用于 Ollama /api/chat 的 messages 列表"""</span>
        <span class="hljs-keyword">with</span> self._lock:
            session = self._sessions.get(session_id)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> session:
                <span class="hljs-keyword">return</span> []

            messages = []
            <span class="hljs-comment"># 添加 system 消息（如果有）</span>
            <span class="hljs-keyword">if</span> session[<span class="hljs-string">"system"</span>]:
                messages.append(session[<span class="hljs-string">"system"</span>].to_dict())
            <span class="hljs-comment"># 添加历史对话</span>
            <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> session[<span class="hljs-string">"history"</span>]:
                messages.append(msg.to_dict())
            <span class="hljs-keyword">return</span> messages

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear_session</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""清除指定 session 的所有消息"""</span>
        <span class="hljs-keyword">with</span> self._lock:
            self._sessions.pop(session_id, <span class="hljs-literal">None</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_sessions</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""列出所有 session ID"""</span>
        <span class="hljs-keyword">with</span> self._lock:
            returnlist(self._sessions.keys())

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_session</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""删除 session，返回是否删除成功"""</span>
        <span class="hljs-keyword">with</span> self._lock:
            <span class="hljs-keyword">if</span> session_id inself._sessions:
                <span class="hljs-keyword">del</span> self._sessions[session_id]
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>调用时手动传入：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># sql agent</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sql_agent</span>(<span class="hljs-params">user_query</span>):
    <span class="hljs-comment"># 1. 语义匹配</span>
    table = semanticService.hybrid_search(user_query, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> table:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未匹配到字段"</span>)
        <span class="hljs-keyword">return</span> Result.error()
    table_struct = [t[<span class="hljs-string">"table_info"</span>] <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> table]
    prompt = <span class="hljs-string">f"""
            你是一个MySQL专家。根据以下表结构信息：
            <span class="hljs-subst">{table_struct}</span>

            历史问答（仅供参考）："<span class="hljs-subst">{mm.get_messages(session_id)}</span>"
            
            用户查询："<span class="hljs-subst">{user_query}</span>"

            生成标准MYSQL查询语句。
            要求：
            1. 只输出MYSQL语句，不要额外解释
            2. 根据语义和字段类型，使用COUNT/SUM/AVG等聚合函数进行计算，非必须
            3. 给生成的字段取一个简短的中文名称
            输出格式：使用[]包含sql文本即可，不需要其他输出，便于解析，例如:[select 1 from dual]
        """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"SQL AGENT PROMPT=<span class="hljs-subst">{prompt}</span>"</span>)
    <span class="hljs-comment"># 2. 大模型生成SQL</span>
    str1 = analysisService.analysis(prompt)
    sql = re.search(<span class="hljs-string">r'[(.*?)]'</span>, str1, re.DOTALL).group(<span class="hljs-number">1</span>).strip()

    <span class="hljs-comment"># 3. 执行查询</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> sql:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nSQL生成失败"</span>)
        <span class="hljs-keyword">return</span> Result.error()

    resultSet = queryService.query_with_column(sql)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resultSet:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\nSQL查询失败"</span>)
        <span class="hljs-keyword">return</span> Result.error()
    <span class="hljs-keyword">return</span> Result.success(data={ <span class="hljs-string">"tableStruct"</span>: table_struct, <span class="hljs-string">"resultSet"</span>: resultSet, <span class="hljs-string">"sql"</span>: sql })

<span class="hljs-comment"># analysis agent</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">analysis_agent</span>(<span class="hljs-params">user_query, data</span>):
    <span class="hljs-comment"># 基础分析</span>
    prompt = <span class="hljs-string">f"""
                根据以下表结构信息：
                <span class="hljs-subst">{data[<span class="hljs-string">'tableStruct'</span>]}</span>
                
                查询SQL：
                <span class="hljs-subst">{data[<span class="hljs-string">'sql'</span>]}</span>
                
                和以下数据信息：
                <span class="hljs-subst">{data[<span class="hljs-string">'resultSet'</span>]}</span>

                历史问答（仅供参考）："<span class="hljs-subst">{mm.get_messages(session_id)}</span>"
                
                用户查询："<span class="hljs-subst">{user_query}</span>"

                生成一段简要分析，加上一些预测总结的内容
            """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ANALYSIS AGENT PROMPT=<span class="hljs-subst">{prompt}</span>"</span>)
    <span class="hljs-keyword">return</span> Result.success(analysisService.analysis(prompt))
</code></pre>
<h4 data-id="heading-20">2、LangChain框架</h4>
<p>Agent模式指定：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 记忆</span>
<span class="hljs-attr">memory</span> = ConversationBufferMemory(memory_key=<span class="hljs-string">"chat_history"</span>, return_messages=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 初始化Agent</span>
<span class="hljs-attr">agent</span> = initialize_agent(
    <span class="hljs-attr">tools</span>=[semantic_tool, sql_tool],
    <span class="hljs-attr">llm</span>=llm,
    <span class="hljs-attr">agent</span>=AgentType.CONVERSATIONAL_REACT_DESCRIPTION,
    <span class="hljs-attr">verbose</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">handle_parsing_errors</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">max_iterations</span>=<span class="hljs-number">10</span>,  <span class="hljs-comment"># 增加最大迭代次数以支持多步查询</span>
    <span class="hljs-attr">early_stopping_method</span>=<span class="hljs-string">"generate"</span>,
    <span class="hljs-attr">memory</span>=memory
)
</code></pre>
<p>除了上面用到的 <code>ConversationBufferMemory</code>，LangChain还提供了多种Memory组件，以适应不同场景的需求。可以根据具体情况选择：</p>

























<table><thead><tr><th><strong>Memory 类型</strong></th><th><strong>特点</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td><strong>ConversationBufferWindowMemory</strong></td><td>只保留<strong>最近K轮</strong>的对话内容，节省上下文空间。</td><td>对话频繁，且近期内容更为重要的场景。</td></tr><tr><td><strong>ConversationSummaryMemory</strong></td><td>对历史对话生成<strong>摘要</strong>，而非保存全部原文。</td><td>对话很长，需要压缩信息以节省Token消耗。</td></tr><tr><td><strong>ConversationTokenBufferMemory</strong></td><td>根据 <strong>Token 数量</strong>而非对话轮数来限制记忆长度。</td><td>需要精确控制输入给模型上下文的长度和成本。</td></tr></tbody></table>
<ul>
<li><strong>确认Agent类型</strong> <strong>兼容性</strong>：在选用Memory前，请确认你使用的 <code>AgentType</code> 支持Memory功能。例如，<code>ZERO_SHOT_REACT_DESCRIPTION</code> 默认不支持记忆，而 <code>CONVERSATIONAL_REACT_DESCRIPTION</code> 则专为多轮对话设计。</li>
<li><strong>注意上下文长度</strong>：为Agent添加记忆会占用模型的上下文窗口。如果对话很长，考虑使用 <code>ConversationSummaryMemory</code> 或 <code>ConversationBufferWindowMemory</code> 来避免超出限制。</li>
<li><strong>调试工具</strong>：将 <code>verbose</code> 参数设为 <code>True</code>，可以在控制台看到详细的决策过程，有助于观察Memory是否正常工作。</li>
</ul>
<h4 data-id="heading-21">3、QwenAgent框架</h4>
<p>Agent模式的Assistant类不支持，需要手动管理：</p>
<pre><code class="hljs language-ini" lang="ini">def analysis(user_query):
    try:
        <span class="hljs-comment"># 运行Agent</span>
        <span class="hljs-attr">messages</span> = mm.get_messages(session_id) + [{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: user_query}]
        <span class="hljs-attr">response_generator</span> = agent.run(messages=messages)
        <span class="hljs-comment"># 处理生成器响应</span>
        <span class="hljs-attr">full_response</span> = <span class="hljs-string">''</span>
        <span class="hljs-attr">start</span> = <span class="hljs-number">0</span>
        <span class="hljs-attr">end</span> = <span class="hljs-number">0</span>
        for response in response_generator:
            <span class="hljs-comment"># 检查响应类型并适当处理</span>
            if isinstance(response, list):
                <span class="hljs-comment"># 如果是列表，提取内容</span>
                for item in response:
                    ifisinstance(item, dict) and'content'in item:
                        <span class="hljs-attr">full_response</span> = item[<span class="hljs-string">'content'</span>]
                        <span class="hljs-attr">end</span> = full_response.__len__()
                    elifisinstance(item, str):
                        <span class="hljs-attr">full_response</span> = item
                        <span class="hljs-attr">end</span> = full_response.__len__()
            elif isinstance(response, dict) and'content'in response:
                <span class="hljs-attr">full_response</span> = response[<span class="hljs-string">'content'</span>]
                <span class="hljs-attr">end</span> = full_response.__len__()
            elif isinstance(response, str):
                <span class="hljs-attr">full_response</span> = response
                <span class="hljs-attr">end</span> = full_response.__len__()
            print(f"{full_response<span class="hljs-section">[start:end]</span>}", <span class="hljs-attr">end</span>=<span class="hljs-string">""</span>)
            <span class="hljs-attr">start</span> = end

        print(f"最终结果: {full_response}")
        <span class="hljs-comment"># 缓存历史对话</span>
        if full_response:
            mm.add_user_message(session_id, user_query)
            mm.add_assistant_message(session_id, full_response)
        return full_response
    except Exception as e:
        print(f"执行过程中出错: {str(e)}")
        <span class="hljs-comment"># 这里可以添加重试或更详细的错误处理逻辑</span>
        return f"错误: {str(e)}"
</code></pre>
<h4 data-id="heading-22">4、AgentScope框架</h4>
<p>Agent初始化指定对应类型即可：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">jarvis</span> = ReActAgent(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"Jarvis"</span>,
    <span class="hljs-attr">sys_prompt</span>=<span class="hljs-string">"""
        你是一个数据分析助手，负责帮助用户查询数据库信息。
        请特别注意：用户的问题可能需要从多个表中查询数据。
        1. 首先确定需要查询哪些数据
        2. 使用match_metadata工具分别匹配包含这些数据的表结构
        3. 对每个表生成相应的SQL查询语句
        4. 执行查询并汇总结果
        5. 最后计算并给出答案

        请确保逐步执行，不要跳过任何步骤。
    """</span>,
    <span class="hljs-attr">model</span>=OllamaChatModel(
        <span class="hljs-attr">model_name</span>=<span class="hljs-string">"qwen3:32b"</span>,  <span class="hljs-comment"># 指定模型名称</span>
        <span class="hljs-attr">stream</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 根据需要设置是否流式输出</span>
        <span class="hljs-attr">enable_thinking</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 为Qwen3启用思考功能（可选）</span>
        <span class="hljs-comment"># host="http://localhost:11434" # 如果Ollama不在默认地址，需指定</span>
    ),
    <span class="hljs-attr">formatter</span>=OllamaChatFormatter(),
    <span class="hljs-attr">toolkit</span>=toolkit,
    <span class="hljs-attr">memory</span>=InMemoryMemory(),
)
</code></pre>
<h4 data-id="heading-23">小结</h4>
<p>手写代码需自行实现消息管理和上下文传递，工作量大且需要手动维护。框架提供多样化记忆组件，支持对话上下文的灵活管理，适配不同对话场景，有效提升对话质量。</p>
<h2 data-id="heading-24"><strong>多智能体协作对比</strong></h2>
<p>自从Google提出A2A协议，多智能体协作已经成为业界实践过程的热点，为进一步对比手写代码和开发框架在多Agent协作上的区别，我们将本案例的程序设计拆分为以下两个Agent：</p>
<p>1、SQL Agent</p>
<ul>
<li>调用外部语义检索(RAG)API匹配元数据</li>
<li>调用大模型根据元数据和用户提问生成查数SQL</li>
<li>调用查数API查询数据</li>
</ul>
<p>2、Analysis Agent</p>
<ul>
<li>调用大模型分析数据回答问题</li>
</ul>
<h4 data-id="heading-25">1、手写代码</h4>
<p>需要手动串联多个Agent调用，消息格式自定义传递：</p>
<pre><code class="hljs language-python" lang="python">...
<span class="hljs-keyword">def</span> <span class="hljs-title function_">workflow</span>(<span class="hljs-params">user_input</span>):
    <span class="hljs-comment"># 1 - SQL Agent</span>
    result = sql_agent(user_input)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result.success:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-comment"># 2 - Analysis Agent</span>
    <span class="hljs-keyword">return</span> analysis_agent(user_input, result.data)
    ...
</code></pre>
<h4 data-id="heading-26">2、LangChain框架</h4>
<p>原生仅支持单体Agent，多Agent需要手动串联，实现类似手写代码。</p>
<h4 data-id="heading-27">3、QwenAgent框架</h4>
<p>原生仅支持单体Agent，多Agent需要手动串联，实现类似同手写代码。</p>
<h4 data-id="heading-28">4、AgentScope框架</h4>
<p>基于AgentScope框架，我们可以把 SQLAgent 和 AnalysisAgent 封装为 两个智能体（均继承 AgentBase），然后两个智能体的协作使用顺序管道sequential_pipeline来串联，实现“多智能体任务流转”。</p>
<p>AgentScope 中的主要管道类型包括：</p>















































<table><thead><tr><th>管道函数</th><th>类型</th><th>作用</th><th>特点</th></tr></thead><tbody><tr><td>sequential_pipeline</td><td>串行</td><td>按顺序执行多个 Agent（A → B → C）</td><td>简单、可控、常用于任务链</td></tr><tr><td>parallel_pipeline</td><td>并行</td><td>同时让多个 Agent 处理同一消息</td><td>高性能、适合意见汇总或对比</td></tr><tr><td>broadcast_pipeline</td><td>广播</td><td>将一条消息发送给多个 Agent，但每个独立回复</td><td>不等待所有返回，可异步</td></tr><tr><td>loop_pipeline</td><td>循环</td><td>将上一次输出作为下一轮输入，直到满足条件停止</td><td>适合多轮协作（例如思考-改进循环）</td></tr><tr><td>conditional_pipeline</td><td>条件分支</td><td>根据消息或 Agent 输出动态选择下一个 Agent</td><td>适合复杂决策流</td></tr><tr><td>MsgHub</td><td>管道</td><td>中心化消息调度 多 Agent 通过消息中心异步通信</td><td>实现发布-订阅、群聊模式</td></tr></tbody></table>
<p>这几种管道协作模式，具体实践敬请期待下篇文章分享。</p>
<h4 data-id="heading-29">小结</h4>
<p>手写代码多为线性调用，缺乏并行和复杂调度能力。AgentScope框架支持多Agent并行、条件分支、消息广播等复杂管道模式，适合构建复杂的多智能体协作系统。其他框架都需要手动组合实现。</p>
<h2 data-id="heading-30"><strong>对比总结</strong></h2>
<p>通过以上对比来看，在日常智能体开发中，尤其是需要多轮对话、实现多工具调用和多智能体协作时，几种开发框架确实提供了极大的便利和扩展能力，大幅降低开发门槛和维护成本，而手写代码则适合高度定制化需求，灵活性最高。</p>
<h3 data-id="heading-31"><strong>功能维度对比</strong></h3>






















































<table><thead><tr><th>功能模块</th><th>手写代码</th><th>LangChain</th><th>Qwen-Agent</th><th>AgentScope</th></tr></thead><tbody><tr><td>🔗 业务流程编排</td><td>⚪️ 需手动串联</td><td>✅ 多种Chain串联，强支持</td><td>⚪️ 依靠提示词指定业务流程</td><td>⚪️ 依靠提示词指定业务流程</td></tr><tr><td>🌐 模型调用（LLM）</td><td>⚪️ http调用或官方包</td><td>✅ 支持广泛</td><td>✅ 原生优化</td><td>✅ 可自定义适配器</td></tr><tr><td>🧰 工具调用（Tool）</td><td>⚪️ 需手动调用</td><td>✅ 自由定义Tool/组合Tool</td><td>✅ 原生支持</td><td>✅ 通过 Agent 工具化</td></tr><tr><td>💬 记忆（Memory）</td><td>⚪️ 需手动管理</td><td>✅ 多种类型（Buffer/Entity）</td><td>⚪️ 需手动管理</td><td>✅ 上下文共享MsgHub等</td></tr><tr><td>👥 多 Agent 协作</td><td>⚪️ 需手动串联</td><td>⚪️ 可通过手动组合实现</td><td>⚪️ 可通过手动组合实现</td><td>✅ 框架核心功能(多管道)</td></tr><tr><td>🔧 插件生态</td><td>⚪️ 需自定义调用</td><td>✅ 庞大（社区多）</td><td>⚪️ 早期阶段</td><td>⚪️ 逐步扩展中</td></tr></tbody></table>
<h3 data-id="heading-32"><strong>选型建议</strong></h3>



































<table><thead><tr><th>使用场景</th><th>推荐框架</th><th>理由</th></tr></thead><tbody><tr><td>构建通用 RAG / QA 系统</td><td>LangChain</td><td>生态成熟、插件丰富</td></tr><tr><td>构建 Qwen 系列专用 Agent</td><td>Qwen-Agent</td><td>接口最友好、集成最简单</td></tr><tr><td>构建多角色协作系统（Planner + Coder + Critic）</td><td>AgentScope</td><td>专为多 Agent 协作设计</td></tr><tr><td>做研究型实验 / 快速原型</td><td>Qwen-Agent / LangChain</td><td>开发快、文档齐全</td></tr><tr><td>做工业级多智能体调度系统</td><td>AgentScope</td><td>任务协调、上下文共享更强</td></tr></tbody></table>
<p>当然，当我们全定制化开发，还是手写代码更加合适。</p>
<p>🔹 <strong>LangChain</strong>：适合你搭建任何单体智能体系统（RAG、SQL、工具调用）。</p>
<p>🔹 <strong>Qwen-Agent</strong>：适合快速构建“基于 Qwen 模型”的问答或助手。</p>
<p>🔹 <strong>AgentScope</strong>：适合研究或实现<strong>多智能体协作系统</strong>（Planner、Coder、Critic 等角色联动）。</p>
<p>🔹 <strong>手写代码：</strong> 高度定制化开发，当我们的手写代码逐步抽象完善，使用的频率多了，就成了框架！</p>
<p>本文总结：本文通过设计高考信息查询智能助手的业务场景，分别采用手写代码和主流智能体框架（LangChain、QwenAgent、AgentScope）进行了实现与比较。我们从业务流程编排、模型调用、工具集成、上下文记忆管理以及多智能体协作等多个维度进行深入分析，对比手写代码与框架调用的异同。</p>
<p>本文作者：Chaiys</p>
<p>本文原载：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FusHSax8to_VNhnWMZHX6bA" target="_blank" title="https://mp.weixin.qq.com/s/usHSax8to_VNhnWMZHX6bA" ref="nofollow noopener noreferrer">公众号“木昆子记录AI”</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android车机代驾模式黑屏之谜：一次STR唤醒问题的深度剖析]]></title>    <link>https://juejin.cn/post/7591655106724560896</link>    <guid>https://juejin.cn/post/7591655106724560896</guid>    <pubDate>2026-01-05T14:03:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591655106724560896" data-draft-id="7591515844867506210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android车机代驾模式黑屏之谜：一次STR唤醒问题的深度剖析"/> <meta itemprop="keywords" content="性能优化,Android,Debug"/> <meta itemprop="datePublished" content="2026-01-05T14:03:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android车机代驾模式黑屏之谜：一次STR唤醒问题的深度剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T14:03:49.000Z" title="Mon Jan 05 2026 14:03:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>"要是当初知道代驾模式会触发用户切换就好了..." —— 某位调了三天bug的我</p>
</blockquote>
<p>作为一名Android车机系统工程师，我遇到过各种奇怪的问题，但这次的黑屏问题着实让人摸不着头脑。用户反馈：代驾模式下锁车休眠后启动车辆，桌面会短暂黑屏6-8秒。100%复现，影响用户体验，必须马上解决。</p>
<p>本文将带你走进这次问题分析的全过程，从日志收集、时序分析、到根因定位、再到解决方案设计。你将看到：</p>
<ul>
<li>如何系统性地分析Android系统问题</li>
<li>STR（Suspend To RAM）唤醒机制的工作原理</li>
<li>Android多用户切换时的窗口管理细节</li>
<li>FallbackHome的"副作用"</li>
<li>三种不同层次的解决方案设计</li>
</ul>
<p><strong>📷 [问题现象截图]</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10cfa5aa71e1496d837f39e0c1f5a620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226628&amp;x-signature=3%2BCI6guVF1Uf4Pathte6mSgiydA%3D" alt="case6-black-from-str.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">问题背景</h2>
<h3 data-id="heading-2">问题描述</h3>
<p><strong>前提条件</strong>: 车辆处于代驾模式（ChauffeurMode）</p>
<p><strong>复现步骤</strong>:</p>
<ol>
<li>启用代驾模式</li>
<li>锁车，触发STR休眠</li>
<li>启动车辆唤醒</li>
</ol>
<p><strong>实际表现</strong>: 桌面出现明显黑屏，持续6-8秒后恢复正常</p>
<p><strong>发生概率</strong>: 2/2 (100%复现)</p>
<h3 data-id="heading-3">什么是代驾模式？</h3>
<p>代驾模式(ChauffeurMode)是车机系统的一个特殊功能。当车主需要代驾服务时，启用此模式可以：</p>
<ul>
<li>切换到访客用户环境，保护车主隐私</li>
<li>限制代驾人员访问敏感数据和功能</li>
<li>记录代驾期间的行车轨迹</li>
</ul>
<p>简单理解，就像手机的"访客模式"，但应用在车机场景。</p>
<h3 data-id="heading-4">什么是STR？</h3>
<p>STR (Suspend To RAM) 是一种休眠模式，类似于笔记本电脑的"睡眠"状态：</p>
<ul>
<li>系统状态保存在内存中</li>
<li>CPU和大部分外设断电</li>
<li>唤醒速度快（通常1-2秒）</li>
<li>功耗极低</li>
</ul>
<p>车机系统在锁车后会进入STR模式以节省电量。</p>
<hr/>
<h2 data-id="heading-5">初步分析：日志在说什么</h2>
<h3 data-id="heading-6">时间线重构</h3>
<p>通过筛选日志，我重构出了整个事件的时间线：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02bc79c9a1164ce08847d2491c833ac1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226628&amp;x-signature=yFVfA5TfdGT8M7Vs2I8Cgg0mGi4%3D" alt="case6-str-wakeup-timeline.png" loading="lazy"/></p>
<p><em>图1: STR唤醒与黑屏发生的完整时序</em></p>


















































<table><thead><tr><th align="left">时间戳</th><th align="left">事件</th><th align="left">关键日志</th></tr></thead><tbody><tr><td align="left">14:34:39.000</td><td align="left">STR唤醒开始</td><td align="left">系统开始响应唤醒信号</td></tr><tr><td align="left">14:34:40.624</td><td align="left">STR退出完成</td><td align="left"><code>exit_str_vehiclehal</code></td></tr><tr><td align="left">14:34:42.503</td><td align="left">Launcher首次启动完成</td><td align="left"><code>wm_activity_launch_time: 744ms</code></td></tr><tr><td align="left">14:34:46.817</td><td align="left"><strong>触发用户切换</strong></td><td align="left"><code>switchUserByCarUserManager 12 success</code></td></tr><tr><td align="left">14:34:50.169</td><td align="left"><strong>FallbackHome启动</strong></td><td align="left"><strong>⚠️ 黑屏开始</strong></td></tr><tr><td align="left">14:34:51.293</td><td align="left">原Launcher销毁</td><td align="left"><code>destroySurfaces</code></td></tr><tr><td align="left">14:34:52.763</td><td align="left">新Launcher初始化</td><td align="left"><code>LauncherApplication: onCreate</code></td></tr><tr><td align="left">~14:34:56</td><td align="left">新Launcher完成</td><td align="left">黑屏结束</td></tr></tbody></table>
<p><strong>关键发现</strong>: 从 <code>14:34:42</code> Launcher首次启动，到 <code>14:34:46</code> 才触发用户切换，这中间为什么要先启动一次Launcher？</p>
<h3 data-id="heading-7">关键日志摘录</h3>
<p>让我们看看几段关键日志：</p>
<p><strong>1. 代驾模式状态检测</strong></p>
<pre><code class="hljs language-log" lang="log">12-18 14:34:39.021  4842  4842 I ChauffeurManager: PROP_CHAUFFEUR_MODE: mode：1,time:1766039095792,type:0
12-18 14:34:39.218  4842  4842 D ChauffeurModeService: UsageManager disignated_driver_mode: [state -&gt; 1]
</code></pre>
<p>系统检测到代驾模式处于启用状态（<code>mode: 1</code>）。</p>
<p><strong>2. Launcher首次启动（userId=10）</strong></p>
<pre><code class="hljs language-log" lang="log">12-18 14:34:42.503  2717  2749 I wm_activity_launch_time: [10,254202022,com.android.launcher/.main.LauncherActivity,744]
</code></pre>
<p>普通用户(userId=10)的Launcher启动，耗时744ms。此时屏幕应该已经可见。</p>
<p><strong>3. 用户切换触发</strong></p>
<pre><code class="hljs language-log" lang="log">12-18 14:34:46.817  4716  5601 I UserOperateManager: switchUserByCarUserManager 12 success
</code></pre>
<p>4秒后才触发用户切换，从userId=10切换到userId=12（访客用户/代驾用户）。</p>
<p><strong>4. FallbackHome登场</strong></p>
<pre><code class="hljs language-log" lang="log">12-18 14:34:50.169  2717  2750 I ActivityTaskManager: START u12 {cat=[android.intent.category.HOME] cmp=com.android.car.settings/.FallbackHome}
</code></pre>
<p>系统启动FallbackHome作为临时Home界面，这就是黑屏的"元凶"！</p>
<p><strong>5. 原Launcher被销毁</strong></p>
<pre><code class="hljs language-log" lang="log">12-18 14:34:50.181  2717  2750 I wm_pause_activity: [10,254202022,com.android.launcher/.main.LauncherActivity,userLeaving=true]
12-18 14:34:51.293  2717  5506 E WindowManager: win=Window{ae1f8e7 u10 com.android.launcher/...LauncherActivity} destroySurfaces: appStopped=true
</code></pre>
<p>原用户的Launcher被暂停并销毁窗口。</p>
<hr/>
<h2 data-id="heading-8">深入探究：为什么会黑屏？</h2>
<h3 data-id="heading-9">用户切换流程分析</h3>
<p>让我们用流程图来理解整个用户切换过程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fddc2dd1c9b41fbb7a1092646588947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226628&amp;x-signature=A52dic1ngv6AVEW%2Fj8t3fz14IhQ%3D" alt="case6-user-switch-flow.png" loading="lazy"/></p>
<p><em>图2: 代驾模式用户切换的完整流程</em></p>
<p>流程解析：</p>
<ol>
<li><strong>STR唤醒</strong> → 系统恢复到普通用户(userId=10)</li>
<li><strong>Launcher启动</strong> → userId=10的Launcher正常启动，此时屏幕可见</li>
<li><strong>检测到代驾模式</strong> → 系统发现需要切换到访客用户</li>
<li><strong>暂停原Launcher</strong> → 停止并销毁userId=10的Launcher</li>
<li><strong>启动FallbackHome</strong> → 临时占位界面，<strong>黑屏开始</strong></li>
<li><strong>新Launcher初始化</strong> → userId=12的Launcher从头开始加载</li>
<li><strong>界面恢复</strong> → 新Launcher准备就绪，黑屏结束</li>
</ol>
<h3 data-id="heading-10">FallbackHome是什么？</h3>
<p><code>FallbackHome</code> 是Android系统的一个内置组件，定义在 <code>com.android.car.settings/.FallbackHome</code>。</p>
<p>它的作用是：</p>
<ul>
<li>在用户环境未准备好时提供临时占位界面</li>
<li>通常是一个纯黑或纯白的简单界面</li>
<li>等待真正的Launcher准备完成后自动退出</li>
</ul>
<p>在正常的首次开机场景，FallbackHome的存在很合理。但在STR唤醒+用户切换场景下，它成了"黑屏元凶"。</p>
<h3 data-id="heading-11">根因架构图</h3>
<p>让我们从系统架构的角度看这个问题：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0818ce84fe8242d5bd17d3725fddd30b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226628&amp;x-signature=VY7oZKV0hVp%2FLpjemPJAlD%2FleB8%3D" alt="case6-root-cause-architecture.png" loading="lazy"/></p>
<p><em>图3: 问题根因的系统架构视图</em></p>
<p><strong>问题链条</strong>:</p>
<ol>
<li><code>ChauffeurModeService</code> 检测到代驾模式启用</li>
<li>触发 <code>UserManager</code> 进行用户切换</li>
<li><code>ActivityTaskManager</code> &amp; <code>WindowManager</code> 响应用户切换：
<ul>
<li>暂停并销毁原Launcher（userId=10）</li>
<li>启动FallbackHome（userId=12）临时占位</li>
<li>初始化新Launcher（userId=12）</li>
</ul>
</li>
<li>在步骤3的过程中，用户看到的是FallbackHome的黑屏界面</li>
</ol>
<h3 data-id="heading-12">为什么不能直接切换？</h3>
<p>你可能会问：为什么不能直接从旧Launcher切换到新Launcher，而要经过FallbackHome这一步？</p>
<p>原因在于Android的多用户机制设计：</p>
<ul>
<li>每个用户有独立的数据目录和应用实例</li>
<li>新用户的Launcher需要完整的初始化过程</li>
<li>初始化期间必须有界面占位，否则系统会陷入"无Home"状态</li>
</ul>
<p>FallbackHome就是这个"占位符"，保证系统始终有一个可用的Home界面。</p>
<hr/>
<h2 data-id="heading-13">解决方案：三个层次的思考</h2>
<p>面对这个问题，我设计了三个层次的解决方案，从根本性解决到用户体验改善。</p>
<h3 data-id="heading-14">方案一：优化用户切换时序（推荐）⭐</h3>
<p><strong>核心思想</strong>: 在STR休眠前预判，避免唤醒后切换</p>
<p><strong>实施方案</strong>:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ChauffeurModeService.kt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChauffeurModeService</span> {

    <span class="hljs-comment">// 在STR休眠前调用</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBeforeSTRSuspend</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> chauffeurModeEnabled = isChauffeurModeEnabled()
        <span class="hljs-keyword">val</span> currentUserId = getCurrentUserId()

        <span class="hljs-keyword">if</span> (chauffeurModeEnabled &amp;&amp; currentUserId != CHAUFFEUR_USER_ID) {
            <span class="hljs-comment">// 立即切换到代驾用户，不等到唤醒后</span>
            Log.i(TAG, <span class="hljs-string">"Switching to chauffeur user before STR"</span>)
            userManager.switchUser(CHAUFFEUR_USER_ID)
        }

        <span class="hljs-comment">// 保存状态供唤醒后使用</span>
        prefs.edit()
            .putBoolean(KEY_STR_WITH_CHAUFFEUR, chauffeurModeEnabled)
            .putInt(KEY_STR_USER_ID, getCurrentUserId())
            .apply()
    }

    <span class="hljs-comment">// STR唤醒后调用</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAfterSTRWakeup</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> strWithChauffeur = prefs.getBoolean(KEY_STR_WITH_CHAUFFEUR, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">val</span> strUserId = prefs.getInt(KEY_STR_USER_ID, UserHandle.USER_SYSTEM)

        <span class="hljs-comment">// 无需切换，直接恢复</span>
        Log.i(TAG, <span class="hljs-string">"STR wakeup with user <span class="hljs-variable">$strUserId</span>, no switch needed"</span>)
    }
}
</code></pre>
<p><strong>涉及模块</strong>:</p>
<ul>
<li><code>ChauffeurModeService</code> - 代驾模式服务</li>
<li><code>PowerManagerService</code> - 电源管理服务</li>
<li><code>UserManager</code> - 用户管理器</li>
</ul>
<p><strong>优势</strong>:</p>
<ul>
<li>✅ 从根本上消除用户切换导致的黑屏</li>
<li>✅ 唤醒速度更快</li>
<li>✅ 用户体验最佳</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>❌ 需要修改系统服务，改动范围较大</li>
<li>❌ 需要确保休眠前用户切换完成</li>
</ul>
<p><strong>实施难度</strong>: 中等</p>
<h3 data-id="heading-15">方案二：添加过渡动画/品牌Logo</h3>
<p><strong>核心思想</strong>: 黑屏不可避免，那就让它"有意义"</p>
<p><strong>实施方案</strong>:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// UserSwitchTransitionManager.kt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSwitchTransitionManager</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> transitionWindow: View? = <span class="hljs-literal">null</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showTransitionUI</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> windowManager = context.getSystemService(WindowManager::<span class="hljs-keyword">class</span>.java)

        <span class="hljs-comment">// 创建全屏过渡界面</span>
        <span class="hljs-keyword">val</span> transitionView = LayoutInflater.from(context)
            .inflate(R.layout.user_switch_transition, <span class="hljs-literal">null</span>)

        <span class="hljs-comment">// 显示品牌Logo和加载动画</span>
        transitionView.findViewById&lt;ImageView&gt;(R.id.brand_logo).apply {
            setImageResource(R.drawable.brand_logo)
            <span class="hljs-comment">// 添加渐入动画</span>
            alpha = <span class="hljs-number">0f</span>
            animate()
                .alpha(<span class="hljs-number">1f</span>)
                .setDuration(<span class="hljs-number">300</span>)
                .start()
        }

        transitionView.findViewById&lt;ProgressBar&gt;(R.id.loading_indicator).apply {
            visibility = View.VISIBLE
        }

        <span class="hljs-keyword">val</span> params = WindowManager.LayoutParams(
            WindowManager.LayoutParams.MATCH_PARENT,
            WindowManager.LayoutParams.MATCH_PARENT,
            WindowManager.LayoutParams.TYPE_SYSTEM_OVERLAY,
            WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE or
                WindowManager.LayoutParams.FLAG_FULLSCREEN,
            PixelFormat.TRANSLUCENT
        )

        windowManager.addView(transitionView, params)
        transitionWindow = transitionView
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hideTransitionUI</span><span class="hljs-params">()</span></span> {
        transitionWindow?.let { view -&gt;
            <span class="hljs-comment">// 添加渐出动画</span>
            view.animate()
                .alpha(<span class="hljs-number">0f</span>)
                .setDuration(<span class="hljs-number">200</span>)
                .withEndAction {
                    <span class="hljs-keyword">val</span> windowManager = context.getSystemService(WindowManager::<span class="hljs-keyword">class</span>.java)
                    windowManager.removeView(view)
                    transitionWindow = <span class="hljs-literal">null</span>
                }
                .start()
        }
    }
}

<span class="hljs-comment">// 在UserController中集成</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> transitionManager = UserSwitchTransitionManager(context)

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchUser</span><span class="hljs-params">(targetUserId: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 显示过渡界面</span>
        transitionManager.showTransitionUI()

        <span class="hljs-comment">// 执行用户切换</span>
        performUserSwitch(targetUserId)

        <span class="hljs-comment">// 监听新Launcher启动完成</span>
        registerLauncherReadyCallback {
            <span class="hljs-comment">// 隐藏过渡界面</span>
            transitionManager.hideTransitionUI()
        }
    }
}
</code></pre>
<p><strong>过渡界面布局示例</strong>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- res/layout/user_switch_transition.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/brand_background"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">"center"</span>
        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>
        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span>
            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/brand_logo"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"200dp"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"200dp"</span>
            <span class="hljs-attr">android:contentDescription</span>=<span class="hljs-string">"@string/brand_logo_desc"</span> /&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">ProgressBar</span>
            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/loading_indicator"</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"32dp"</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">"?android:attr/progressBarStyle"</span> /&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span>
            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"16dp"</span>
            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"@string/switching_user"</span>
            <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"@color/brand_text"</span>
            <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"18sp"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">FrameLayout</span>&gt;</span>
</code></pre>
<p><strong>优势</strong>:</p>
<ul>
<li>✅ 改善用户体验，黑屏变成"加载中"</li>
<li>✅ 实施相对简单</li>
<li>✅ 可以展示品牌元素</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>❌ 没有减少实际的切换时间</li>
<li>❌ 仍然有6-8秒的等待</li>
</ul>
<p><strong>实施难度</strong>: 简单</p>
<h3 data-id="heading-16">方案三：优化Launcher启动速度</h3>
<p><strong>核心思想</strong>: 减少新Launcher的初始化时间</p>
<p><strong>实施方案</strong>:</p>
<ol>
<li><strong>分析Launcher启动耗时</strong></li>
</ol>
<p>使用 <code>adb shell am start -W</code> 或 Perfetto 分析Launcher的启动瓶颈：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell am start -W -n com.android.launcher/.main.LauncherActivity
</code></pre>
<p>关注以下指标：</p>
<ul>
<li><code>TotalTime</code>: 总启动时间</li>
<li><code>WaitTime</code>: 等待时间</li>
<li><code>DisplayTime</code>: 首帧显示时间</li>
</ul>
<ol start="2">
<li><strong>优化策略</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LauncherActivity.kt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LauncherActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        <span class="hljs-comment">// 策略1: 延迟加载非关键UI</span>
        setContentView(R.layout.activity_launcher_skeleton)  <span class="hljs-comment">// 骨架屏</span>

        <span class="hljs-comment">// 策略2: 异步初始化组件</span>
        lifecycleScope.launch {
            <span class="hljs-comment">// 并行加载</span>
            <span class="hljs-keyword">val</span> widgetsDeferred = async { loadWidgets() }
            <span class="hljs-keyword">val</span> appsDeferred = async { loadRecentApps() }
            <span class="hljs-keyword">val</span> settingsDeferred = async { loadSettings() }

            <span class="hljs-comment">// 等待关键组件</span>
            widgetsDeferred.await()

            <span class="hljs-comment">// 显示主界面</span>
            setContentView(R.layout.activity_launcher_main)

            <span class="hljs-comment">// 非关键组件后台继续加载</span>
            appsDeferred.await()
            settingsDeferred.await()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadWidgets</span><span class="hljs-params">()</span></span> = withContext(Dispatchers.IO) {
        <span class="hljs-comment">// 预加载常用widget数据</span>
        widgetManager.preloadEssentialWidgets()
    }

    <span class="hljs-comment">// 策略3: 缓存用户数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadRecentApps</span><span class="hljs-params">()</span></span> = withContext(Dispatchers.IO) {
        <span class="hljs-comment">// 从缓存加载，避免重新计算</span>
        <span class="hljs-keyword">val</span> cache = appCache.<span class="hljs-keyword">get</span>(getCurrentUserId())
        <span class="hljs-keyword">if</span> (cache != <span class="hljs-literal">null</span> &amp;&amp; cache.isValid()) {
            <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> cache.apps
        }
        <span class="hljs-comment">// 缓存失效才重新加载</span>
        <span class="hljs-keyword">val</span> apps = queryRecentApps()
        appCache.put(getCurrentUserId(), apps)
        apps
    }
}
</code></pre>
<ol start="3">
<li><strong>启动页优化</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 添加启动页，提供即时反馈</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LauncherSplashActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)

        <span class="hljs-comment">// 检查Launcher是否已初始化</span>
        <span class="hljs-keyword">if</span> (LauncherApp.isInitialized()) {
            <span class="hljs-comment">// 直接跳转</span>
            startLauncherActivity()
            finish()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 显示启动页</span>
            setContentView(R.layout.activity_splash)

            <span class="hljs-comment">// 监听初始化完成</span>
            LauncherApp.observeInitialization().observe(<span class="hljs-keyword">this</span>) { isReady -&gt;
                <span class="hljs-keyword">if</span> (isReady) {
                    startLauncherActivity()
                    finish()
                }
            }
        }
    }
}
</code></pre>
<p><strong>优势</strong>:</p>
<ul>
<li>✅ 提升整体用户体验</li>
<li>✅ 适用于所有Launcher启动场景</li>
<li>✅ 减少黑屏时间</li>
</ul>
<p><strong>劣势</strong>:</p>
<ul>
<li>❌ 优化空间有限（从744ms优化到500ms左右）</li>
<li>❌ 无法完全消除黑屏</li>
</ul>
<p><strong>实施难度</strong>: 中等</p>
<hr/>
<h2 data-id="heading-17">验证方案：如何确认修复有效？</h2>
<h3 data-id="heading-18">测试用例设计</h3>
<p><strong>测试场景1: 代驾模式STR唤醒</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">前置条件: 代驾模式已启用
测试步骤:
<span class="hljs-bullet">  1.</span> 触发锁车(STR休眠)
<span class="hljs-bullet">  2.</span> 等待3秒
<span class="hljs-bullet">  3.</span> 解锁启动车辆
<span class="hljs-bullet">  4.</span> 观察桌面启动过程

预期结果:
<span class="hljs-bullet">  -</span> 方案一: 无黑屏或黑屏小于2秒
<span class="hljs-bullet">  -</span> 方案二: 显示过渡动画，无明显黑屏感
<span class="hljs-bullet">  -</span> 方案三: 黑屏时间缩短至4-5秒
</code></pre>
<p><strong>测试场景2: 非代驾模式STR唤醒（对比）</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">前置条件: 代驾模式已关闭</span>
<span class="hljs-section">测试步骤: (同上)</span>
<span class="hljs-section">预期结果: 无黑屏或黑屏&lt;1秒（作为基准对比）</span>
</code></pre>
<p><strong>测试场景3: 压力测试</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">测试步骤:
<span class="hljs-bullet">  1.</span> 启用代驾模式
<span class="hljs-bullet">  2.</span> 循环执行STR休眠→唤醒 20次
<span class="hljs-bullet">  3.</span> 记录每次黑屏时间

预期结果: 黑屏时间稳定，无退化
</code></pre>
<h3 data-id="heading-19">关键指标</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 性能监控代码</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LauncherPerformanceMonitor</span> {

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordUserSwitchMetrics</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> startTime = SystemClock.elapsedRealtime()

        <span class="hljs-comment">// 监听用户切换开始</span>
        userManager.registerUserSwitchObserver(<span class="hljs-keyword">object</span> : UserSwitchObserver() {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onUserSwitchComplete</span><span class="hljs-params">(newUserId: <span class="hljs-type">Int</span>)</span></span> {
                <span class="hljs-keyword">val</span> switchDuration = SystemClock.elapsedRealtime() - startTime

                <span class="hljs-comment">// 记录指标</span>
                logMetric(<span class="hljs-string">"user_switch_duration"</span>, switchDuration)

                <span class="hljs-comment">// 如果超过阈值，记录警告</span>
                <span class="hljs-keyword">if</span> (switchDuration &gt; <span class="hljs-number">2000</span>) {
                    Log.w(TAG, <span class="hljs-string">"User switch took <span class="hljs-subst">${switchDuration}</span>ms, exceeds 2s threshold"</span>)
                }
            }
        })
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordLauncherStartTime</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> launchStartTime = Process.getStartElapsedRealtime()

        <span class="hljs-comment">// 在Launcher完全加载后记录</span>
        window.decorView.post {
            <span class="hljs-keyword">val</span> duration = SystemClock.elapsedRealtime() - launchStartTime
            logMetric(<span class="hljs-string">"launcher_cold_start"</span>, duration)
        }
    }
}
</code></pre>
<p><strong>监控指标</strong>:</p>
<ul>
<li><code>user_switch_duration</code>: 用户切换总耗时（目标 小于2秒）</li>
<li><code>launcher_cold_start</code>: Launcher冷启动时间（目标 小于500ms）</li>
<li><code>fallback_home_visible_duration</code>: FallbackHome可见时长（目标 小于1秒或0）</li>
</ul>
<h3 data-id="heading-20">日志验证</h3>
<p>修复后，关键日志应该是这样的：</p>
<p><strong>方案一实施后</strong>:</p>
<pre><code class="hljs language-log" lang="log">// STR休眠前已完成用户切换
12-18 14:34:38.500 UserOperateManager: Switching to chauffeur user before STR
12-18 14:34:39.000 UserOperateManager: switchUserByCarUserManager 12 success

// STR唤醒直接恢复，无需切换
12-18 14:34:40.624 VHalProperty: STR_OS_DHUVehicleHal:exit_str_vehiclehal
12-18 14:34:42.100 wm_activity_launch_time: [12,xxx,com.android.launcher/.main.LauncherActivity,480]
// 注意: 无FallbackHome启动日志！
</code></pre>
<hr/>
<h2 data-id="heading-21">经验总结：从这个案例我学到了什么</h2>
<h3 data-id="heading-22">1. 系统性思维的重要性</h3>
<p>这个问题涉及多个子系统的交互：</p>
<ul>
<li>电源管理（STR）</li>
<li>用户管理（多用户切换）</li>
<li>窗口管理（Activity生命周期）</li>
<li>代驾模式业务逻辑</li>
</ul>
<p>如果只盯着"黑屏"本身，很容易陷入局部优化的陷阱。系统性地理解整个流程，才能找到根本性的解决方案。</p>
<h3 data-id="heading-23">2. 日志分析技巧</h3>
<p><strong>时间线重构</strong>是关键：</p>
<ul>
<li>筛选关键事件日志</li>
<li>按时间戳排序</li>
<li>识别因果关系</li>
<li>找出异常时序</li>
</ul>
<p>工具推荐：</p>
<ul>
<li><code>grep</code> + 正则表达式</li>
<li>Android Studio的Logcat过滤器</li>
<li>自定义脚本提取时序</li>
</ul>
<h3 data-id="heading-24">3. "临时方案"的陷阱</h3>
<p>FallbackHome的设计初衷是好的，但在特定场景下成了问题。这提醒我们：</p>
<ul>
<li>通用方案不一定适用所有场景</li>
<li>需要考虑边界情况</li>
<li>性能优化不能只看平均值</li>
</ul>
<h3 data-id="heading-25">4. 多层次解决方案</h3>
<p>好的工程师会提供多个选项：</p>
<ul>
<li><strong>根本性方案</strong>: 解决问题根因，但可能实施成本高</li>
<li><strong>折中方案</strong>: 平衡效果与实施难度</li>
<li><strong>临时方案</strong>: 快速缓解，为长期方案争取时间</li>
</ul>
<h3 data-id="heading-26">5. 用户体验优先</h3>
<p>技术问题最终要回归用户体验：</p>
<ul>
<li>6秒黑屏对用户来说是"永恒"</li>
<li>即使无法完全消除，也要让等待变得"有意义"</li>
<li>品牌Logo、加载动画都是改善感知的手段</li>
</ul>
<hr/>
<h2 data-id="heading-27">更多实战案例</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fcase1-android-ivi-lag-case-analysis-binder-consumed" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/case1-android-ivi-lag-case-analysis-binder-consumed" ref="nofollow noopener noreferrer">Android车机卡顿案例剖析:从Binder耗尽到单例缺失的深度排查</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fcase2-anr-audioserver-deadlock-system-failure" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/case2-anr-audioserver-deadlock-system-failure" ref="nofollow noopener noreferrer">ANR实战分析：一次audioserver死锁引发的系统级故障排查</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fcase3-android-black-screen-analysis" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/case3-android-black-screen-analysis" ref="nofollow noopener noreferrer">一次 Android 车机黑屏问题的深度剖析：当显示驱动遇上中断风暴</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fcase4-anr-velocitytracker-calculation-timeout" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/case4-anr-velocitytracker-calculation-timeout" ref="nofollow noopener noreferrer">一次必现ANR问题的深度分析与解决之旅:当NestedScrollView遇上VelocityTracker</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top%2Fblog%2Fandroid_stability_performance%2Fcase5-android-antipattern-system-exit-black-screen" target="_blank" title="https://home.wonlab.top/blog/android_stability_performance/case5-android-antipattern-system-exit-black-screen" ref="nofollow noopener noreferrer">Android反模式警示录：System.exit(0)如何制造546ms黑屏</a></li>
</ul>
<p><em>如有疑问或想深入讨论，欢迎留言交流！</em></p>
<p><em>本文基于真实案例整理，部分敏感信息已脱敏处理。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始玩转 Microsoft Agent Framework：我的 MAF 实践之旅-第二篇]]></title>    <link>https://juejin.cn/post/7591515844867129378</link>    <guid>https://juejin.cn/post/7591515844867129378</guid>    <pubDate>2026-01-05T12:01:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591515844867129378" data-draft-id="7591515844867080226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始玩转 Microsoft Agent Framework：我的 MAF 实践之旅-第二篇"/> <meta itemprop="keywords" content="后端,人工智能,.NET"/> <meta itemprop="datePublished" content="2026-01-05T12:01:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tonydf"/> <meta itemprop="url" content="https://juejin.cn/user/3809161241186638"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始玩转 Microsoft Agent Framework：我的 MAF 实践之旅-第二篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3809161241186638/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tonydf
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T12:01:49.000Z" title="Mon Jan 05 2026 12:01:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>书接<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FChBihUR6DGX-gnplVibrNQ" target="_blank" title="https://mp.weixin.qq.com/s/ChBihUR6DGX-gnplVibrNQ" ref="nofollow noopener noreferrer">上回</a>，关于MAF框架的探索，上次只聊了几个基本的Agent创建，本篇将深入探讨MAF框架的三个核心进阶特性：可观测性集成、聊天记录存储与持久化，以及为智能体赋予记忆能力。</p>
<p>我这里的案例代码都是跟着微软的官方文档，将智能体的角色案例改造成了一个“汽车大师”，包含了一些自己的理解，可能存在偏差和错误，推荐大家优先查阅官方文档。</p>
<blockquote>
<p>由于MAF框架，以及其相关的生态包，目前都是Preview状态（截止到2026.1.5），所以这里只是探索，目前上生产的话还是要慎重。</p>
</blockquote>
<h2 data-id="heading-1">可观测性</h2>
<p>这一趴，对应的文档地址是：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Fenable-observability%3Fpivots%3Dprogramming-language-csharp" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/enable-observability?pivots=programming-language-csharp" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
<blockquote>
<p>实际上，微软的文档是有一个机翻的中文版的，但机翻的效果我个人感觉有点拉，不如直接看原版，然后用翻译软件或者AI助手翻译，效果更好，当然能无障碍阅读原版是最好了。</p>
</blockquote>
<p>这一节，主要是展示MAF框架如何方便的开启可观测性。核心的目标是利用OpenTelemetry标准来自动记录和导出智能体育用户之间的交互数据。</p>
<p>整个接入流程可以概括为</p>
<ol>
<li>安装必要的Nuget包</li>
<li>启用OpenTelemtry（TracerProvider）</li>
<li>配置代理</li>
<li>查看输出结果</li>
</ol>
<p>好了，更具体的内容大家可以参考文档，我这里直接给出我的测试案例</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Azure.AI.OpenAI;
<span class="hljs-keyword">using</span> Microsoft.Agents.AI;
<span class="hljs-keyword">using</span> OpenAI;
<span class="hljs-keyword">using</span> OpenTelemetry;
<span class="hljs-keyword">using</span> OpenTelemetry.Trace;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.ClientModel;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AgentFrameworkQuickStart</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ObservabilityAgent</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> ModelProvider modelProvider;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ObservabilityAgent</span>(<span class="hljs-params">ModelProvider modelProvider</span>)</span>
        {
            <span class="hljs-keyword">this</span>.modelProvider = modelProvider;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ObservabilityDemo</span>()</span>
        {
            <span class="hljs-keyword">using</span> <span class="hljs-keyword">var</span> tracerProvider = Sdk.CreateTracerProviderBuilder()
            .AddSource(<span class="hljs-string">"agent-telemetry-source"</span>)
            .AddConsoleExporter()
            .Build();

            <span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> OpenAIClient(
               <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
               <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) })
               .GetChatClient(modelProvider.ModelId)
               .CreateAIAgent(instructions: <span class="hljs-string">"你是个资深汽车大师，了解很多汽车知识，包括配置，价格，驾驶体验的等等，回复内容尽可能简短高效，突出优缺点，给出综合购买建议，避免长篇大论"</span>, name: <span class="hljs-string">"汽车大师"</span>)
               .AsBuilder()
               .UseOpenTelemetry(sourceName: <span class="hljs-string">"agent-telemetry-source"</span>)
               .Build();

            <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> update <span class="hljs-keyword">in</span> agent.RunStreamingAsync(<span class="hljs-string">"介绍一下新款宝马X3 25L这款车"</span>))
            {
                Console.Write(update);
            }
        }
    }
}

</code></pre>
<p>然后可以在看一下运行效果</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17f82baa9a2e479ea2b6e0c3b077ac72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768219309&amp;x-signature=PpS4GIjju%2BtWQLuzfWvZUZM%2Bgto%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">存储聊天记录</h2>
<p>官方文档在可观测性之后，详细介绍了<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Fpersisted-conversation" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/persisted-conversation" ref="nofollow noopener noreferrer">持久化对话</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Fthird-party-chat-history-storage%3Fpivots%3Dprogramming-language-csharp" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/third-party-chat-history-storage?pivots=programming-language-csharp" ref="nofollow noopener noreferrer">第三方外部存储</a>。为了聚焦核心概念，本文将直接展示如何实现一个自定义的聊天记录存储，该方法也涵盖了持久化的核心思想，大家可以参考官网查看完整的教程。</p>
<p>默认情况下，ChatClientAgent的聊天记录存储在AgentThread对象中，也就是内存当中，为了实现对话的持久化、跨会话恢复或大规模历史管理，开发者需要提供自定义存储实现。</p>
<p>本文的案例就是基于官方教程，创建了一个自定义存储类，继承抽象类 ChatMessageStore并分别实现一个存储（AddMessagesAsync）和检索（GetMessagesAsync）的关键方法。这里要注意的是，在检索方法里要考虑Token的限制，不过我们这里是技术验证阶段，这个也可以先跳过，降低一些心智负担。</p>
<p>代码的大体逻辑是</p>
<ul>
<li>提供一个InMemoryVectorStore示例类VectorChatMessageStore</li>
<li>在第一次添加消息时生成一个唯一的 ThreadDbKey</li>
<li>定义了一个内部类ChatHistoryItem来保存消息文本、时间戳和序列化后的消息体。</li>
<li>Serialize 方法只返回ThreadDbKey这样下次加载线程时，就能根据这个 Key 找回历史。</li>
</ul>
<p>来看下代码</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> AgentFrameworkQuickStart.Models;
<span class="hljs-keyword">using</span> Microsoft.Agents.AI;
<span class="hljs-keyword">using</span> Microsoft.Extensions.AI;
<span class="hljs-keyword">using</span> Microsoft.Extensions.VectorData;
<span class="hljs-keyword">using</span> Microsoft.SemanticKernel.Connectors.InMemory;
<span class="hljs-keyword">using</span> OpenAI;
<span class="hljs-keyword">using</span> Spectre.Console;
<span class="hljs-keyword">using</span> System.ClientModel;
<span class="hljs-keyword">using</span> System.Text.Json;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AgentFrameworkQuickStart</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">InMemoryChatHistoryAgent</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ModelProvider _modelProvider;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">string</span> _threadStatePath;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> VectorStore _vectorStore = <span class="hljs-keyword">new</span> InMemoryVectorStore();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InMemoryChatHistoryAgent</span>(<span class="hljs-params">ModelProvider modelProvider, <span class="hljs-built_in">string</span> threadStateFileName = <span class="hljs-string">"thread_state.json"</span></span>)</span>
    {
        _modelProvider = modelProvider ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(modelProvider));
        _threadStatePath = Path.Combine(Directory.GetCurrentDirectory(), threadStateFileName);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RunInteractiveChatAsync</span>()</span>
    {
        <span class="hljs-comment">// 创建带自定义消息存储的 Agent</span>
        <span class="hljs-keyword">var</span> agent = <span class="hljs-keyword">new</span> OpenAIClient(
                <span class="hljs-keyword">new</span> ApiKeyCredential(_modelProvider.ApiKey),
                <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(_modelProvider.Endpoint) })
            .GetChatClient(_modelProvider.ModelId)
            .CreateAIAgent(
            <span class="hljs-keyword">new</span> ChatClientAgentOptions
            {
                Name = <span class="hljs-string">"记忆大师"</span>,
                Description = <span class="hljs-string">"你是一个有长期记忆的助手，能记住之前的对话。"</span>,
                ChatMessageStoreFactory = ctx =&gt; <span class="hljs-keyword">new</span> VectorChatMessageStore(_vectorStore, ctx.SerializedState, ctx.JsonSerializerOptions)
            });


        <span class="hljs-comment">// 尝试恢复线程</span>
        AgentThread thread;
        <span class="hljs-keyword">if</span> (File.Exists(_threadStatePath))
        {
            Console.WriteLine(<span class="hljs-string">"检测到已保存的对话状态，正在恢复..."</span>);
            <span class="hljs-built_in">string</span> json = <span class="hljs-keyword">await</span> File.ReadAllTextAsync(_threadStatePath);
            <span class="hljs-keyword">var</span> element = JsonSerializer.Deserialize&lt;JsonElement&gt;(json, JsonSerializerOptions.Web);
            thread = agent.DeserializeThread(element, JsonSerializerOptions.Web);
            Console.WriteLine(<span class="hljs-string">"对话已恢复！"</span>);
        }
        <span class="hljs-keyword">else</span>
        {
            Console.WriteLine(<span class="hljs-string">"开始新对话（使用 InMemory 向量存储记录历史）..."</span>);
            thread = agent.GetNewThread();
        }

        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
        {
            Console.Write(<span class="hljs-string">"\n💬 你: "</span>);
            <span class="hljs-built_in">string</span>? input = Console.ReadLine();

            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrWhiteSpace(input)) <span class="hljs-keyword">continue</span>;

            <span class="hljs-keyword">if</span> (input.Equals(<span class="hljs-string">"exit"</span>, StringComparison.OrdinalIgnoreCase))
            {
                <span class="hljs-keyword">var</span> state = thread.Serialize(JsonSerializerOptions.Web).GetRawText();
                <span class="hljs-keyword">await</span> File.WriteAllTextAsync(_threadStatePath, state);
                Console.WriteLine(<span class="hljs-string">"线程状态已保存，再见！"</span>);
                <span class="hljs-keyword">break</span>;
            }

            <span class="hljs-keyword">if</span> (input.Equals(<span class="hljs-string">"clear"</span>, StringComparison.OrdinalIgnoreCase))
            {
                <span class="hljs-keyword">if</span> (File.Exists(_threadStatePath)) 
                    File.Delete(_threadStatePath);
                thread = agent.GetNewThread();
                Console.WriteLine(<span class="hljs-string">"已开启全新对话（旧历史不可见）"</span>);
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> agent.RunAsync(input, thread);
                Console.WriteLine(<span class="hljs-string">$"\n助手: <span class="hljs-subst">{response}</span>"</span>);
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"错误: <span class="hljs-subst">{ex.Message}</span>"</span>);
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">var</span> updatedState = thread.Serialize(JsonSerializerOptions.Web).GetRawText();
            <span class="hljs-keyword">await</span> File.WriteAllTextAsync(_threadStatePath, updatedState);
        }
    }

    <span class="hljs-comment">//这个基本和文档的案例一致👇，我引入了AnsiConsole美化输出</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VectorChatMessageStore</span> : <span class="hljs-title">ChatMessageStore</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> VectorStore _vectorStore;
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? ThreadDbKey { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">VectorChatMessageStore</span>(<span class="hljs-params">
            VectorStore vectorStore,
            JsonElement serializedStoreState,
            JsonSerializerOptions? jsonSerializerOptions = <span class="hljs-literal">null</span></span>)</span>
        {
            _vectorStore = vectorStore ?? <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-keyword">nameof</span>(vectorStore));
            <span class="hljs-keyword">if</span> (serializedStoreState.ValueKind == JsonValueKind.String)
                ThreadDbKey = serializedStoreState.Deserialize&lt;<span class="hljs-built_in">string</span>&gt;(jsonSerializerOptions);
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddMessagesAsync</span>(<span class="hljs-params">
            IEnumerable&lt;ChatMessage&gt; messages,
            CancellationToken cancellationToken = <span class="hljs-literal">default</span></span>)</span>
        {
            ThreadDbKey ??= Guid.NewGuid().ToString(<span class="hljs-string">"N"</span>);

            AnsiConsole.MarkupLine(<span class="hljs-string">$"[cyan]【Add】 ThreadKey: <span class="hljs-subst">{ThreadDbKey}</span>, 消息数: <span class="hljs-subst">{messages.Count()}</span>[/]"</span>);

            <span class="hljs-keyword">var</span> collection = _vectorStore.GetCollection&lt;<span class="hljs-built_in">string</span>, ChatHistoryItem&gt;(<span class="hljs-string">"ChatHistory"</span>);
            <span class="hljs-keyword">await</span> collection.EnsureCollectionExistsAsync(cancellationToken);

            <span class="hljs-keyword">await</span> collection.UpsertAsync(
                messages.Select(msg =&gt; <span class="hljs-keyword">new</span> ChatHistoryItem
                {
                    Key = <span class="hljs-string">$"<span class="hljs-subst">{ThreadDbKey}</span>_<span class="hljs-subst">{msg.MessageId}</span>"</span>,
                    ThreadId = ThreadDbKey,
                    Timestamp = DateTimeOffset.UtcNow,
                    SerializedMessage = JsonSerializer.Serialize(msg, SourceGenerationContext.Default.ChatMessage),
                    MessageText = msg.Text ?? <span class="hljs-string">""</span>
                }),
                cancellationToken);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task&lt;IEnumerable&lt;ChatMessage&gt;&gt; GetMessagesAsync(
            CancellationToken cancellationToken = <span class="hljs-literal">default</span>)
        {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(ThreadDbKey))
                <span class="hljs-keyword">return</span> [];

            AnsiConsole.MarkupLine(<span class="hljs-string">$"[yellow]【Get】 从 ThreadKey: <span class="hljs-subst">{ThreadDbKey}</span> 读取消息[/]"</span>);


            <span class="hljs-keyword">var</span> collection = _vectorStore.GetCollection&lt;<span class="hljs-built_in">string</span>, ChatHistoryItem&gt;(<span class="hljs-string">"ChatHistory"</span>);
            <span class="hljs-keyword">await</span> collection.EnsureCollectionExistsAsync(cancellationToken);

            <span class="hljs-comment">// 获取该线程的所有消息（按时间倒序取最新 10 条）</span>
            <span class="hljs-keyword">var</span> records = collection.GetAsync(
                filter: x =&gt; x.ThreadId == ThreadDbKey,
                top: <span class="hljs-number">10</span>,
                options: <span class="hljs-keyword">new</span>() { OrderBy = x =&gt; x.Descending(y =&gt; y.Timestamp) },
                cancellationToken);

            <span class="hljs-keyword">var</span> messages = <span class="hljs-keyword">new</span> List&lt;ChatMessage&gt;();
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> <span class="hljs-keyword">record</span> <span class="hljs-title">in</span> <span class="hljs-title">records</span>)
            {
                messages.Add(JsonSerializer.Deserialize&lt;ChatMessage&gt;(
                    <span class="hljs-keyword">record</span>.SerializedMessage!,
                    SourceGenerationContext.Default.ChatMessage)!);
            }

            messages.Reverse();
            <span class="hljs-keyword">return</span> messages;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> JsonElement <span class="hljs-title">Serialize</span>(<span class="hljs-params">JsonSerializerOptions? options = <span class="hljs-literal">null</span></span>)</span>
            =&gt; JsonSerializer.SerializeToElement(ThreadDbKey, options);

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ChatHistoryItem</span>
        {
            [<span class="hljs-meta">VectorStoreKey</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Key { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
            [<span class="hljs-meta">VectorStoreData</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? ThreadId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
            [<span class="hljs-meta">VectorStoreData</span>] <span class="hljs-keyword">public</span> DateTimeOffset? Timestamp { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
            [<span class="hljs-meta">VectorStoreData</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? SerializedMessage { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
            [<span class="hljs-meta">VectorStoreData</span>] <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? MessageText { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        }
    }
}
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d1141f100f54777914da8e38bea106f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768219309&amp;x-signature=9gSP5N9LTb0pP4ntB6IB8nvL1o0%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b6b4acbcc274994ac8055f7f2a59570~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768219309&amp;x-signature=BurBPLWS%2F5EHKoOsL%2F5u9R%2FI2h8%3D" alt="" loading="lazy"/></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/694e3e4492bf4a6bb685b7f8d2cd9344~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768219309&amp;x-signature=ehsg22WipdhkhUnY9c78sS4fwc8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">为智能体添加记忆</h2>
<p>本节对应文档的地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Fmemory%3Fpivots%3Dprogramming-language-csharp" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/memory?pivots=programming-language-csharp" ref="nofollow noopener noreferrer">learn.microsoft.com/en-us/agent…</a></p>
<p>这一章关于概念性的内容我这里不过多介绍了，这里简单总结一下，我觉得这一篇是MAF的基础文档介绍中最为压轴的一篇，通过AIContextProvider可以让Agent具备“学习”和“个性化”的能力，构建出复杂交互系统。如文档所示</p>
<blockquote>
<p>AIContextProvider是一个抽象类，您可以从中继承，并且可以与AgentThread关联以用于ChatClientAgent。 该功能允许：</p>
<ul>
<li>在代理调用基础推理服务之前和之后运行自定义逻辑。</li>
<li>在调用基础推理服务之前，向代理提供其他上下文。</li>
<li>检查代理提供和生成的所有消息。</li>
</ul>
</blockquote>
<p>AIContextProvider本质上是一个拦截器或者说中间件，像是在Agent从“接受输入（InvokingAsync ）”到“调用模型（InvokedAsync）”这个执行流程上切了2刀，这个过程可以参考以下流程图。</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e8aefffa14d4fb5b2afd470d6f400c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768219309&amp;x-signature=gxqTKx6I2DCj9vPyic%2BOwPPblo8%3D" alt="" loading="lazy"/></p>
<p>更多概念性内容大家还是参考<a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Fagent-framework%2Ftutorials%2Fagents%2Fmemory%3Fpivots%3Dprogramming-language-csharp%23pre-and-post-invocation-events" target="_blank" title="https://learn.microsoft.com/en-us/agent-framework/tutorials/agents/memory?pivots=programming-language-csharp#pre-and-post-invocation-events" ref="nofollow noopener noreferrer">文档</a>吧，我这里就不再赘述了。咱们看案例吧</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> AgentFrameworkQuickStart.Models;
<span class="hljs-keyword">using</span> AgentFrameworkQuickStart.Tools;
<span class="hljs-keyword">using</span> Microsoft.Agents.AI;
<span class="hljs-keyword">using</span> Microsoft.Extensions.AI;
<span class="hljs-keyword">using</span> Microsoft.Extensions.VectorData;
<span class="hljs-keyword">using</span> Microsoft.SemanticKernel.Connectors.InMemory;
<span class="hljs-keyword">using</span> OpenAI;
<span class="hljs-keyword">using</span> Spectre.Console;
<span class="hljs-keyword">using</span> System.ClientModel;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Text.Json;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AgentFrameworkQuickStart</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CarMasterMemory</span> : <span class="hljs-title">AIContextProvider</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> IChatClient _innerClient;
        <span class="hljs-keyword">public</span> CarPreference Preference { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>; }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CarMasterMemory</span>(<span class="hljs-params">IChatClient client, CarPreference? pref = <span class="hljs-literal">null</span></span>)</span>
        {
            _innerClient = client;
            Preference = pref ?? <span class="hljs-keyword">new</span> CarPreference();
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CarMasterMemory</span>(<span class="hljs-params">IChatClient client, JsonElement serializedState, JsonSerializerOptions? options = <span class="hljs-literal">null</span></span>)</span>
        {
            _innerClient = client;
            Preference = serializedState.ValueKind == JsonValueKind.Object
                ? serializedState.Deserialize&lt;CarPreference&gt;(options) ?? <span class="hljs-keyword">new</span> CarPreference()
                : <span class="hljs-keyword">new</span> CarPreference();
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> ValueTask&lt;AIContext&gt; <span class="hljs-title">InvokingAsync</span>(<span class="hljs-params">InvokingContext context, CancellationToken ct = <span class="hljs-literal">default</span></span>)</span>
        {
            <span class="hljs-keyword">var</span> sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"\n[后台画像已加载]"</span>);
            <span class="hljs-keyword">if</span> (Preference.BudgetMax &gt; <span class="hljs-number">0</span>) sb.Append(<span class="hljs-string">$" | 预算上限：<span class="hljs-subst">{Preference.BudgetMax}</span>万"</span>);
            <span class="hljs-keyword">if</span> (Preference.EnergyType != <span class="hljs-string">"未指定"</span>) sb.Append(<span class="hljs-string">$" | 能源偏好：<span class="hljs-subst">{Preference.EnergyType}</span>"</span>);
            <span class="hljs-keyword">if</span> (Preference.MustHaves.Any()) sb.Append(<span class="hljs-string">$" | 关键需求：<span class="hljs-subst">{<span class="hljs-built_in">string</span>.Join(<span class="hljs-string">"、"</span>, Preference.MustHaves)}</span>"</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ValueTask&lt;AIContext&gt;(<span class="hljs-keyword">new</span> AIContext { Instructions = sb.ToString() });
        }


        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> ValueTask <span class="hljs-title">InvokedAsync</span>(<span class="hljs-params">InvokedContext context, CancellationToken ct = <span class="hljs-literal">default</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (context.RequestMessages.Any(m =&gt; m.Role == ChatRole.User))
            {
                <span class="hljs-keyword">try</span>
                {
                    <span class="hljs-keyword">var</span> lastUserMessage = context.RequestMessages.LastOrDefault(m =&gt; m.Role == ChatRole.User)?.Text;
                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(lastUserMessage)) <span class="hljs-keyword">return</span>;

                    <span class="hljs-keyword">var</span> analysisOptions = <span class="hljs-keyword">new</span> ChatOptions
                    {
                        ResponseFormat = ChatResponseFormat.Json,
                        Instructions = <span class="hljs-string">""</span><span class="hljs-string">"
                    你是一个数据提取器。请分析用户的输入，提取购车意向。
                    返回 JSON 格式如下：
                    {
                      "</span>BudgetMax<span class="hljs-string">": 数字 (如果是30万请写30, 必须是万为单位的数字),
                      "</span>EnergyType<span class="hljs-string">": "</span>字符串 (如: 纯电/燃油/混动)<span class="hljs-string">",
                      "</span>MustHaves<span class="hljs-string">": ["</span>需求点<span class="hljs-number">1</span><span class="hljs-string">", "</span>需求点<span class="hljs-number">2</span><span class="hljs-string">"] (如果没有提到任何具体配置或功能需求，请返回空数组 [])
                    }
                    注意：如果是配置需求(如: 智驾、全景天窗、大空间)，请放入 MustHaves。
                    "</span><span class="hljs-string">""</span>
                    };

                    <span class="hljs-keyword">var</span> extraction = <span class="hljs-keyword">await</span> _innerClient.GetResponseAsync&lt;CarPreference&gt;(
                        context.RequestMessages.TakeLast(<span class="hljs-number">2</span>), <span class="hljs-comment">// 只看最近一两轮</span>
                        analysisOptions);

                    <span class="hljs-keyword">if</span> (extraction.Result != <span class="hljs-literal">null</span>)
                    {
                        <span class="hljs-keyword">var</span> newInfo = extraction.Result;

                        <span class="hljs-keyword">if</span> (newInfo.BudgetMax &gt; <span class="hljs-number">5000</span>) newInfo.BudgetMax /= <span class="hljs-number">10000</span>;
                        <span class="hljs-keyword">if</span> (newInfo.BudgetMax &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.Preference.BudgetMax = newInfo.BudgetMax;

                        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">string</span>.IsNullOrEmpty(newInfo.EnergyType) &amp;&amp; newInfo.EnergyType != <span class="hljs-string">"未指定"</span> &amp;&amp; newInfo.EnergyType != <span class="hljs-string">"null"</span>)
                        {
                            <span class="hljs-keyword">this</span>.Preference.EnergyType = newInfo.EnergyType;
                        }

                        <span class="hljs-keyword">if</span> (newInfo.MustHaves != <span class="hljs-literal">null</span> &amp;&amp; newInfo.MustHaves.Any())
                        {
                            <span class="hljs-keyword">var</span> validNewItems = newInfo.MustHaves
                                .Where(s =&gt; !<span class="hljs-built_in">string</span>.IsNullOrWhiteSpace(s) &amp;&amp; s != <span class="hljs-string">"无"</span> &amp;&amp; s != <span class="hljs-string">"null"</span>);

                            <span class="hljs-keyword">var</span> updatedList = <span class="hljs-keyword">this</span>.Preference.MustHaves.Union(validNewItems, StringComparer.OrdinalIgnoreCase).ToList();
                            <span class="hljs-keyword">this</span>.Preference.MustHaves = updatedList;
                        }
                    }
                }
                <span class="hljs-keyword">catch</span> (Exception ex)
                {
                    <span class="hljs-comment">// 调试用</span>
                    <span class="hljs-comment">// Console.WriteLine($"[DEBUG] 提取失败: {ex.Message}");</span>
                }
            }
        }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> JsonElement <span class="hljs-title">Serialize</span>(<span class="hljs-params">JsonSerializerOptions? options = <span class="hljs-literal">null</span></span>)</span>
            =&gt; JsonSerializer.SerializeToElement(Preference, options);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CarMasterAgent</span> : <span class="hljs-title">BaseAgent</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> VectorStore _vectorStore = <span class="hljs-keyword">new</span> InMemoryVectorStore();

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CarMasterAgent</span>(<span class="hljs-params">ModelProvider modelProvider</span>) : <span class="hljs-title">base</span>(<span class="hljs-params">modelProvider</span>)</span> { }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RunMasterAsync</span>()</span>
        {
            <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> OpenAIClient(
                <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
                <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) });

            <span class="hljs-keyword">var</span> chatClient = client.GetChatClient(modelProvider.ModelId);

            <span class="hljs-keyword">var</span> agent = chatClient.CreateAIAgent(<span class="hljs-keyword">new</span> ChatClientAgentOptions
            {
                Name = <span class="hljs-string">"汽车大师"</span>,
                Description = <span class="hljs-string">"你是一个毒舌但专业的汽车大师。你会根据后台画像（预算、需求）给出精准建议。"</span>,
                <span class="hljs-comment">// 1. 对话记录存入向量数据库（你写的逻辑）</span>
                ChatMessageStoreFactory = ctx =&gt; <span class="hljs-keyword">new</span> VectorChatMessageStore(_vectorStore, ctx.SerializedState, ctx.JsonSerializerOptions),
                <span class="hljs-comment">// 2. 画像提炼存入上下文提供者（我优化的逻辑）</span>
                AIContextProviderFactory = ctx =&gt; <span class="hljs-keyword">new</span> CarMasterMemory(chatClient.AsIChatClient(), ctx.SerializedState, ctx.JsonSerializerOptions)
            });

            <span class="hljs-keyword">var</span> thread = agent.GetNewThread();

            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
            {
                <span class="hljs-keyword">var</span> input = AnsiConsole.Ask&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"[white]你:[/]"</span>);
                <span class="hljs-keyword">if</span> (input == <span class="hljs-string">"exit"</span>) <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> agent.RunAsync(input, thread);
                AnsiConsole.MarkupLine(<span class="hljs-string">$"\n[cyan]大师: <span class="hljs-subst">{response}</span>[/]"</span>);

                <span class="hljs-keyword">var</span> mem = thread.GetService&lt;CarMasterMemory&gt;()?.Preference;
                AnsiConsole.MarkupLine(<span class="hljs-string">$"[grey]&gt;&gt;&gt; 系统画像更新 | 预算: <span class="hljs-subst">{mem?.BudgetMax}</span>w | 能源: <span class="hljs-subst">{mem?.EnergyType}</span> | 需求数: <span class="hljs-subst">{mem?.MustHaves.Count}</span>[/]"</span>);
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RunMasterStreamAsync</span>()</span>
        {
            <span class="hljs-keyword">var</span> client = <span class="hljs-keyword">new</span> OpenAIClient(
                <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
                <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) });

            <span class="hljs-keyword">var</span> chatClient = client.GetChatClient(modelProvider.ModelId);

            <span class="hljs-keyword">var</span> agent = chatClient.CreateAIAgent(<span class="hljs-keyword">new</span> ChatClientAgentOptions
            {
                Name = <span class="hljs-string">"汽车大师"</span>,
                Description = <span class="hljs-string">"你是一个既毒舌又专业的汽车大师。你会根据后台画像（预算、需求）给出精准建议。重点突出优缺点，有没有排面，不要长篇大论，扯一些没用的。"</span>,
                <span class="hljs-comment">// 对话记录存入向量数据库</span>
                ChatMessageStoreFactory = ctx =&gt; <span class="hljs-keyword">new</span> VectorChatMessageStore(_vectorStore, ctx.SerializedState, ctx.JsonSerializerOptions),
                <span class="hljs-comment">// 画像提炼存入上下文提供者</span>
                AIContextProviderFactory = ctx =&gt; <span class="hljs-keyword">new</span> CarMasterMemory(chatClient.AsIChatClient(), ctx.SerializedState, ctx.JsonSerializerOptions)
            });

            <span class="hljs-keyword">var</span> thread = agent.GetNewThread();

            AnsiConsole.MarkupLine(<span class="hljs-string">"[bold green]--- 汽车大师已上线 (流式模式) ---[/]"</span>);

            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
            {
                <span class="hljs-keyword">var</span> input = AnsiConsole.Ask&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"\n[white]你:[/]"</span>);
                <span class="hljs-keyword">if</span> (input == <span class="hljs-string">"exit"</span>) <span class="hljs-keyword">break</span>;

                AnsiConsole.Markup(<span class="hljs-string">"[cyan]大师:[/] "</span>);

                <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> chunk <span class="hljs-keyword">in</span> agent.RunStreamingAsync(input, thread))
                {
                    <span class="hljs-comment">// 直接输出片段，不换行</span>
                    Console.Write(chunk);
                }

                Console.WriteLine(); <span class="hljs-comment">// 结束后手动换行</span>

                <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">500</span>);
                <span class="hljs-keyword">var</span> mem = thread.GetService&lt;CarMasterMemory&gt;()?.Preference;

                <span class="hljs-keyword">var</span> panel = <span class="hljs-keyword">new</span> Panel(<span class="hljs-string">$""</span><span class="hljs-string">"
            [yellow]预算限制：[/] {mem?.BudgetMax} 万
            [yellow]能源偏好：[/] {mem?.EnergyType}
            [yellow]核心需求：[/] {(mem?.MustHaves.Any() == true ? string.Join("</span>、<span class="hljs-string">", mem.MustHaves) : "</span>尚不明确<span class="hljs-string">")}
            "</span><span class="hljs-string">""</span>)
                {
                    Header = <span class="hljs-keyword">new</span> PanelHeader(<span class="hljs-string">"🚗 [bold]当前画像记录[/]"</span>),
                    Border = BoxBorder.Rounded
                };

                AnsiConsole.Write(panel);
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RunMasterWithToolsAsync</span>()</span>
        {
            <span class="hljs-keyword">var</span> chatClient = <span class="hljs-keyword">new</span> OpenAIClient(
                <span class="hljs-keyword">new</span> ApiKeyCredential(modelProvider.ApiKey),
                <span class="hljs-keyword">new</span> OpenAIClientOptions { Endpoint = <span class="hljs-keyword">new</span> Uri(modelProvider.Endpoint) })
                .GetChatClient(modelProvider.ModelId);

            <span class="hljs-keyword">var</span> agent = chatClient.CreateAIAgent(<span class="hljs-keyword">new</span> ChatClientAgentOptions
            {
                Name = <span class="hljs-string">"汽车大师"</span>,
                Description = <span class="hljs-string">"一个从业20年的专业汽车顾问，擅长结合用户画像进行精准推荐。"</span>,

                <span class="hljs-comment">// 将推理相关的配置放入 ChatOptions</span>
                ChatOptions = <span class="hljs-keyword">new</span> ChatOptions
                {
                    Instructions = <span class="hljs-string">"你是一个专业的汽车推荐助手。请优先参考后台画像。如果用户询问具体推荐，请调用 SearchCars 工具。"</span>,
                    Tools = [AIFunctionFactory.Create(<span class="hljs-keyword">new</span> CarTool().SearchCars)]
                },

                AIContextProviderFactory = ctx =&gt; <span class="hljs-keyword">new</span> CarMasterMemory(
                    chatClient.AsIChatClient(),
                    ctx.SerializedState,
                    ctx.JsonSerializerOptions),

                ChatMessageStoreFactory = ctx =&gt; <span class="hljs-keyword">new</span> VectorChatMessageStore(
                    _vectorStore,
                    ctx.SerializedState,
                    ctx.JsonSerializerOptions)
            });

            <span class="hljs-keyword">var</span> thread = agent.GetNewThread();

            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)
            {
                <span class="hljs-keyword">var</span> input = AnsiConsole.Ask&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">"\n[white]你:[/]"</span>);
                <span class="hljs-keyword">if</span> (input == <span class="hljs-string">"exit"</span>) <span class="hljs-keyword">break</span>;

                <span class="hljs-comment">// 使用流式输出</span>
                AnsiConsole.Markup(<span class="hljs-string">"[cyan]大师:[/] "</span>);
                <span class="hljs-keyword">await</span> <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> chunk <span class="hljs-keyword">in</span> agent.RunStreamingAsync(input, thread))
                {
                    Console.Write(chunk);
                }
                Console.WriteLine();

                <span class="hljs-keyword">var</span> mem = thread.GetService&lt;CarMasterMemory&gt;()?.Preference;
                AnsiConsole.Write(<span class="hljs-keyword">new</span> Panel(<span class="hljs-string">$"预算: <span class="hljs-subst">{mem?.BudgetMax}</span>w | 能源: <span class="hljs-subst">{mem?.EnergyType}</span>"</span>).Border(BoxBorder.Rounded));
            }
        }
    }
}

</code></pre>
<p>简单说明一下，这个案例，前半部分的代码是核心，重载了InvokingAsync和InvokedAsync两个方法，分别在调用模型前，和调用模型后做一些业务相关的操作，比如这个案例是根据用户输入，提炼一个用户画像，有多少预算，倾向买什么车等。</p>
<p>后半部分，定义了3个智能体，其中RunMasterAsync和RunMasterStreamAsync实际只有一个输出方式的区别，而RunMasterWithToolsAsync则包含了一个工具的调用，智能体会在合适的时机调用工具执行操作。</p>
<ul>
<li>不使用工具</li>
</ul>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1768cbcb420246d09fc96c9de986b8d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768219309&amp;x-signature=jAuPWw77dTvuZ56q810U6poGSNA%3D" alt="" loading="lazy"/></p>
<ul>
<li>使用工具（动图后半部分执行工具）</li>
</ul>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b547ec8d76ea436488ad90f0d9761b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768219309&amp;x-signature=rJGmQ9O%2Bfzg2v1dS8tGTNr3tNGU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">结语</h2>
<p>好了，受篇幅限制，就写到这里吧，下一篇再来聊聊工作流的部分。</p>
<blockquote>
<p>附一条小插曲，截止到笔者发文，刚刚看到C#获得了2025年年度编程语言，多年来，C#经历了根本性的变革。从语言设计的角度来看，C#常常率先采纳主流语言中的新趋势。与此同时，它成功完成了两次重大范式转变：从仅限Windows到跨平台，以及从微软专有到开源。C#始终能在恰当的时机实现与时俱进的演进。</p>

</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00ce0e157f1a40d0967709d11863a66a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdG9ueWRm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768219309&amp;x-signature=HFnEl4flnSjTZQBKiTgdFuBk2z8%3D" alt="" loading="lazy"/></p>
<blockquote>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[（源码+实例）大家都在说Agent，那么Agent到底是什么？]]></title>    <link>https://juejin.cn/post/7591703562134011938</link>    <guid>https://juejin.cn/post/7591703562134011938</guid>    <pubDate>2026-01-05T13:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591703562134011938" data-draft-id="7591293897085550642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="（源码+实例）大家都在说Agent，那么Agent到底是什么？"/> <meta itemprop="keywords" content="Agent,Python,LLM"/> <meta itemprop="datePublished" content="2026-01-05T13:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="寻找光_sxy"/> <meta itemprop="url" content="https://juejin.cn/user/1495754537711661"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            （源码+实例）大家都在说Agent，那么Agent到底是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1495754537711661/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    寻找光_sxy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T13:14:51.000Z" title="Mon Jan 05 2026 13:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在了解<code>Agent</code>之前，我们先了解一下<code>LLM</code>；</p>
<p>我们都知道22年11月30日，<code>OpenAI</code>发布了<code>ChatGPT</code>，而<code>ChatGPT</code>就是<code>LLM</code>的典型的应用实例之一，包括后面发布的文心一言、通义千问等大模型。</p>
<p><code>LLM</code>全称<code>Large Language Model</code>，中文为大语言模型，是人工智能领域中自然语言处理(<code>NLP</code>)方向的核心技术，也是当前生成式<code>AI</code>的底层支撑。它的本质是<strong>基于海量文本数据训练、具备强大语言理解与生成能力的深度学习模型</strong>。</p>
<p>我们从以上的概念中很容易就能看到<code>LLM</code>的一些局限，比如：</p>
<ul>
<li><strong>语言理解</strong>：只能基于训练过的文本数据去进行理解</li>
<li><strong>语言生成</strong>：只能以文本的方式去进行交互</li>
</ul>
<p>这两个局限使得<code>LLM</code>更像是一个建议者、开车时的副驾驶，无法执行具体的动作。</p>
<p>而在<code>AI</code>的发展中，我们更需要<code>AI</code>去做一个执行者，去做司机，去实际参与物理世界，由此，<code>Agent</code>发展出来了。</p>
<h2 data-id="heading-1">概念</h2>
<p>现在我们常常用这样的一个<strong>智能体架构公式</strong>去理解<code>Agent</code>:</p>
<blockquote>
<p>Agent(智能体) = LLM(大语言模型) + Perception(感知) + Planning(规划)+ Memory(记忆) + Tools(工具)</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1d7a394cfd94251a4923acad2f929fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768223768&amp;x-signature=Wq8HeUx%2BKRvdtSmpyhzxjTwWgq4%3D" alt="AI 的概念及应用.png" loading="lazy"/></p>
<p>有了 <strong>LLM(大语言模型)</strong>、<strong>Perception(感知)</strong>、<strong>Planning(规划)</strong>、<strong>Memory(记忆)</strong> 、<strong>Tools(工具)</strong>，<code>Agent</code>真正具备了五官与手脚，去理解、操作我们的物理世界：</p>
<ul>
<li><strong>LLM(大语言模型）</strong>：<code>Agent</code>的大脑
<ul>
<li>具体可参考前言部分</li>
</ul>
</li>
<li><strong>Perception(感知)</strong>：<code>Agent</code>与外部沟通的桥梁，通过多种渠道感知环境信息，类似于人的感官
<ul>
<li><strong>视觉感知（CV）</strong>
<ul>
<li>通过摄像头或图像输入，看到并理解内容</li>
</ul>
</li>
<li><strong>听觉感知(ASR)</strong>
<ul>
<li>通过麦克风或音频输入，听到并识别语音内容</li>
</ul>
</li>
<li><strong>其它感知</strong>
<ul>
<li>集成传感器，感知环境的物理状态，如温度、湿度、味道等</li>
</ul>
</li>
</ul>
</li>
<li><strong>Planning(规划)</strong>：<code>Agent</code>的决策执行引擎，负责将<code>LLM</code>拆解的目标转化为可执行的分布计划，并根据反馈动态调整策略
<ul>
<li><strong>任务拆解</strong>
<ul>
<li>将复杂目标拆解成一系列可执行的简单子任务</li>
</ul>
</li>
<li><strong>制定策略</strong>
<ul>
<li>为每个子任务规划出具体的执行步骤和方法</li>
</ul>
</li>
<li><strong>动态调整</strong>
<ul>
<li>根据执行反馈灵活调整计划，应对突发情况</li>
</ul>
</li>
</ul>
</li>
<li><strong>Memory(记忆)</strong>：<code>Agent</code>的长期知识库，解决<code>LLM</code>上下文窗口有限的问题，为<code>Agent</code>提供长期学习和经验积累的能力
<ul>
<li><strong>短期记忆</strong>
<ul>
<li>类似工作记忆，存储当前任务上下文，支持多轮对话与任务连贯性</li>
</ul>
</li>
<li><strong>长期记忆</strong>
<ul>
<li>类似知识库，持久化存储知识、偏好与经验，可随时检索利用</li>
</ul>
</li>
</ul>
</li>
<li><strong>Tools(工具)</strong>：<code>Agent</code>的双手，让<code>Agent</code>突破纯文本能力限制，实现"知行合一"的任务执行
<ul>
<li><strong>访问信息</strong>
<ul>
<li>通过搜索引擎获取最新、最准确的信息</li>
</ul>
</li>
<li><strong>执行计算</strong>
<ul>
<li>使用计算器或代码编辑器完成复杂运算和数据分析</li>
</ul>
</li>
<li><strong>控制设备</strong>
<ul>
<li>通过<code>API</code>调用，控制智能家居、工业机器人等物理设备</li>
</ul>
</li>
<li><strong>操作软件</strong>
<ul>
<li>自动操作电脑软件，如<code>Excel</code>、<code>Photoshop</code>等</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-2">Demo</h2>
<p>了解了上面的概念，我们来实操一下，搭建一个本地的<code>Agent</code>；</p>
<h3 data-id="heading-3">Demo介绍</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2878d43022d44dbb95f7295db0e0d48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768223768&amp;x-signature=YzrmbgYU8w4XuXaQizS0SIRpssg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">功能</h4>
<p>实现的<code>Agent</code>的功能点包括：</p>
<ul>
<li>理解用户的自然语言问题</li>
<li>自动判断是否需要调用外部工具</li>
<li>执行 <code>Python</code> 函数（如获取时间、数学计算求和）</li>
<li>将工具执行结果整合成人类可读的回答</li>
</ul>
<h4 data-id="heading-5">技术栈</h4>
<p>基于<code>ReAct</code>结构，用通义千问大模型作为<code>AI</code>基座，<code>Python3</code>作为开发语言：</p>
<ul>
<li><strong>大模型</strong>：阿里云百炼（通义千问）</li>
<li><strong>通信协议</strong>：<code>OpenAI</code> 兼容模式</li>
<li><strong>编程语言</strong>：<code>Python 3.8+</code></li>
</ul>
<h4 data-id="heading-6">文件目录</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/751b3a5fe0f74924ac5b069ed070b475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768223768&amp;x-signature=8Hol5V6aoyViSPviwV%2BsIAtzzJw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">Demo实现</h3>
<h4 data-id="heading-8">第一步：获取API Key</h4>
<p>我这里用的是阿里云的大模型：</p>
<ul>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2F" target="_blank" title="https://bailian.console.aliyun.com/" ref="nofollow noopener noreferrer">阿里云百炼控制台</a></li>
<li>注册/登录账号</li>
<li>创建 <code>API Key</code></li>
</ul>
<h4 data-id="heading-9">第二步：安装依赖</h4>
<p>创建 <code>requirements.txt</code> 文件：</p>
<pre><code class="hljs language-txt" lang="txt">openai
python-dotenv
</code></pre>
<p>安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pip3 install -r requirements.txt
</code></pre>
<h4 data-id="heading-10">第三步：配置环境变量</h4>
<p>创建 <code>.env</code> 文件：</p>
<pre><code class="hljs language-env" lang="env">DASHSCOPE_API_KEY=你的API_KEY
</code></pre>
<h4 data-id="heading-11">第四步：实现工具转换器（utils.py）</h4>
<p>创建<code>utils.py</code>文件，利用Python 的 <code>inspect</code> 模块，读取函数的函数名、参数列表和类型注解，生成大模型可理解的<code>JSON Schema</code>，让大模型去了解工具的功能和参数</p>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">import</span> inspect

<span class="hljs-keyword">def</span> <span class="hljs-title function_">function_to_json</span>(<span class="hljs-params">func</span>) -&gt; <span class="hljs-built_in">dict</span>:
    <span class="hljs-string">"""
    通过 Python 反射机制，自动将一个 Python 函数转换为 OpenAI/DashScope 兼容的工具定义 (JSON Schema)。
    这使得我们只需要编写普通的 Python 函数，就能直接被 Agent 识别和调用。
    """</span>
    <span class="hljs-comment"># 获取函数的签名信息（包含参数名、参数类型注解、默认值等）</span>
    sig = inspect.signature(func)
    parameters = {}
    required = []

    <span class="hljs-comment"># 遍历函数的所有参数</span>
    <span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> sig.parameters.items():
        <span class="hljs-comment"># 根据 Python 的类型注解推断 JSON Schema 的类型</span>
        <span class="hljs-keyword">if</span> param.annotation == <span class="hljs-built_in">float</span>:
            param_type = <span class="hljs-string">"number"</span>
        <span class="hljs-keyword">elif</span> param.annotation == <span class="hljs-built_in">int</span>:
            param_type = <span class="hljs-string">"integer"</span>
        <span class="hljs-keyword">elif</span> param.annotation == <span class="hljs-built_in">str</span>:
            param_type = <span class="hljs-string">"string"</span>
        <span class="hljs-keyword">elif</span> param.annotation == <span class="hljs-built_in">bool</span>:
            param_type = <span class="hljs-string">"boolean"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 默认设为 string</span>
            param_type = <span class="hljs-string">"string"</span>

        <span class="hljs-comment"># 构造单个参数的 schema 定义</span>
        parameters[name] = {<span class="hljs-string">"type"</span>: param_type}

        <span class="hljs-comment"># 如果参数没有设定默认值，则在 Schema 中标记为必填项 (required)</span>
        <span class="hljs-keyword">if</span> param.default <span class="hljs-keyword">is</span> inspect.Parameter.empty:
            required.append(name)

    <span class="hljs-comment"># 返回符合 OpenAI Tool 定义规范的字典结构</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-string">"name"</span>: func.__name__,                      <span class="hljs-comment"># 函数名</span>
            <span class="hljs-string">"description"</span>: inspect.getdoc(func) <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>,  <span class="hljs-comment"># 使用函数的 docstring 作为工具描述</span>
            <span class="hljs-string">"parameters"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: parameters,                <span class="hljs-comment"># 参数列表</span>
                <span class="hljs-string">"required"</span>: required,                    <span class="hljs-comment"># 必填参数列表</span>
            },
        },
    }

</code></pre>
<h4 data-id="heading-12">第五步：定义工具函数（tools/）</h4>
<p><strong>关键点</strong>：</p>
<ul>
<li>每个函数必须有清晰的 <strong>docstring</strong>（模型用它来理解工具用途）</li>
<li>使用 <strong>类型注解</strong>标注参数类型</li>
<li>函数名要有语义，便于模型选择</li>
</ul>
<h5 data-id="heading-13">5.1 时间工具（tools/time_tool.py）</h5>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime


<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_datetime</span>() -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""
    获取当前日期和时间的工具。
    Agent 可以调用此工具来了解当前的实时时间。
    :return: 格式化后的日期时间字符串，例如 "2024-01-05 12:00:00"。
    """</span>
    current_datetime = datetime.now()
    formatted_datetime = current_datetime.strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>)
    <span class="hljs-keyword">return</span> formatted_datetime

</code></pre>
<h5 data-id="heading-14">5.2 数学工具（tools/math_tools.py）</h5>
<pre><code class="hljs language-py" lang="py"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""
    计算两个整数的和。
    Agent 会在需要进行加法运算时自动调用此工具。
    """</span>
    <span class="hljs-keyword">return</span> a + b

</code></pre>
<h4 data-id="heading-15">第六步：实现 Agent 核心逻辑（agent.py）</h4>
<ul>
<li>维护对话历史（<code>Memory</code> - 短期记忆）</li>
<li>调用大模型（<code>LLM</code>）</li>
<li>解析工具调用指令（<code>Planning</code> - 任务规划）</li>
<li>执行工具并反馈结果（<code>Tools</code> - 工具执行）</li>
</ul>
<h5 data-id="heading-16">6.1 初始化</h5>
<p>初始化系统提示词，创建工具映射</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> utils <span class="hljs-keyword">import</span> function_to_json

SYSTEM_PROMPT = <span class="hljs-string">"""
你是一个人工智能助手。你的输出应该与用户的语言保持一致。
当用户的问题需要调用工具时，你可以从提供的工具列表中调用适当的工具函数。
"""</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Agent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, client: OpenAI, model: <span class="hljs-built_in">str</span> = <span class="hljs-string">"qwen-plus"</span>, 
                 tools: <span class="hljs-type">List</span> = <span class="hljs-literal">None</span>, verbose: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>):
        self.client = client
        self.tools = tools <span class="hljs-keyword">or</span> []
        self.model = model
        <span class="hljs-comment"># Memory: 初始化对话历史，包含系统提示词</span>
        self.messages = [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: SYSTEM_PROMPT}]
        self.verbose = verbose
        <span class="hljs-comment"># Tools: 创建工具映射：函数名 -&gt; 函数对象</span>
        self.tool_map = {tool.__name__: tool <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> self.tools}
</code></pre>
<h5 data-id="heading-17">6.2 工具 Schema 生成</h5>
<p>将时间工具和数学工具转换为模型可识别的<code>JSON Schema</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_tool_schema</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-string">"""将 Python 函数列表转换为模型可识别的 JSON Schema"""</span>
    <span class="hljs-keyword">return</span> [function_to_json(tool) <span class="hljs-keyword">for</span> tool <span class="hljs-keyword">in</span> self.tools]
</code></pre>
<h5 data-id="heading-18">6.3 工具调用处理</h5>
<p>处理模型发出的单个工具调用逻辑</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_tool_call</span>(<span class="hljs-params">self, tool_call</span>):
    <span class="hljs-string">"""处理模型发出的单个工具调用请求"""</span>
    function_name = tool_call.function.name
    function_args_str = tool_call.function.arguments
    function_id = tool_call.<span class="hljs-built_in">id</span>

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 解析 JSON 字符串参数</span>
        function_args = json.loads(function_args_str)
        
        <span class="hljs-comment"># 从映射表中查找并执行函数</span>
        <span class="hljs-keyword">if</span> function_name <span class="hljs-keyword">in</span> self.tool_map:
            <span class="hljs-keyword">if</span> self.verbose:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"&gt;&gt;&gt; 正在执行工具: <span class="hljs-subst">{function_name}</span>, 参数: <span class="hljs-subst">{function_args}</span>"</span>)
            
            func = self.tool_map[function_name]
            result = func(**function_args)
        <span class="hljs-keyword">else</span>:
            result = <span class="hljs-string">f"错误: 找不到名为 <span class="hljs-subst">{function_name}</span> 的工具"</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        result = <span class="hljs-string">f"工具执行过程中出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>,
        <span class="hljs-string">"content"</span>: <span class="hljs-built_in">str</span>(result),
        <span class="hljs-string">"tool_call_id"</span>: function_id,
    }
</code></pre>
<h5 data-id="heading-19">6.4 ReAct 循环（核心逻辑 - Planning）</h5>
<p>处理用户输入的核心方法，实现 <code>ReAct</code> 循环：</p>
<blockquote>
<p>Reasoning（推理）-&gt; Acting（行动）-&gt; Observing（观察）-&gt; Reasoning（再推理）</p>
</blockquote>
<p>实现 <code>Planning（规划）</code>的核心思想：</p>
<ul>
<li><strong>任务拆解</strong>：将用户问题拆解为可执行的工具调用</li>
<li><strong>制定策略</strong>：决定调用哪些工具、以什么顺序调用</li>
<li><strong>动态调整</strong>：根据工具执行结果调整后续策略</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_completion</span>(<span class="hljs-params">self, prompt: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
   
    <span class="hljs-comment"># Memory: 添加用户问题到历史</span>
    self.messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt})

    <span class="hljs-comment"># Planning: 第一次请求 - LLM 判断是否需要工具</span>
    response = self.client.chat.completions.create(
        model=self.model,
        messages=self.messages,
        tools=self.get_tool_schema() <span class="hljs-keyword">if</span> self.tools <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,
        stream=<span class="hljs-literal">False</span>,
    )

    message = response.choices[<span class="hljs-number">0</span>].message

    <span class="hljs-comment"># Planning: 循环处理工具调用（支持多次调用或链式调用）</span>
    <span class="hljs-keyword">while</span> message.tool_calls:
        <span class="hljs-comment"># Memory: 将模型的工具调用请求加入历史</span>
        self.messages.append(message)

        <span class="hljs-comment"># Tools: 执行所有请求的工具</span>
        <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> message.tool_calls:
            tool_result_message = self.handle_tool_call(tool_call)
            <span class="hljs-comment"># Memory: 将工具执行结果加入历史</span>
            self.messages.append(tool_result_message)

        <span class="hljs-comment"># Planning: 带着工具结果再次请求模型，进行动态调整</span>
        response = self.client.chat.completions.create(
            model=self.model,
            messages=self.messages,
            tools=self.get_tool_schema() <span class="hljs-keyword">if</span> self.tools <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,
            stream=<span class="hljs-literal">False</span>,
        )
        message = response.choices[<span class="hljs-number">0</span>].message

    <span class="hljs-comment"># Memory: 模型不再调用工具，返回最终回复，存入历史并返回</span>
    self.messages.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: message.content})
    <span class="hljs-keyword">return</span> message.content <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
</code></pre>
<h4 data-id="heading-20">第七步：创建主程序（main.py）</h4>
<ul>
<li>初始化<code>OpenAI</code></li>
<li>创建<code>Agent</code>实例，并注入工具</li>
<li>交互式对话循环</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> agent <span class="hljs-keyword">import</span> Agent
<span class="hljs-keyword">from</span> tools.time_tool <span class="hljs-keyword">import</span> get_current_datetime
<span class="hljs-keyword">from</span> tools.math_tools <span class="hljs-keyword">import</span> add, compare, count_letter_in_string

load_dotenv()

API_KEY = os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> API_KEY:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误: 请在 .env 文件中配置 DASHSCOPE_API_KEY"</span>)
        exit(<span class="hljs-number">1</span>)

    <span class="hljs-comment"># 初始化 OpenAI 客户端（使用阿里云百炼的兼容接口）</span>
    client = OpenAI(
        api_key=API_KEY,
        base_url=<span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
    )

    <span class="hljs-comment"># 创建 Agent 实例，注入工具</span>
    agent = Agent(
        client=client,
        model=<span class="hljs-string">"qwen-plus"</span>,
        tools=[get_current_datetime, add, compare, count_letter_in_string],
        verbose=<span class="hljs-literal">True</span>,
    )

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"JUN 人工智能助手已启动！(输入 'exit' 退出)"</span>)

    <span class="hljs-comment"># 交互式对话循环</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">try</span>:
            prompt = <span class="hljs-built_in">input</span>(<span class="hljs-string">"\033[94mUser: \033[0m"</span>)
            
            <span class="hljs-keyword">if</span> prompt.lower() <span class="hljs-keyword">in</span> [<span class="hljs-string">"exit"</span>, <span class="hljs-string">"quit"</span>, <span class="hljs-string">"退出"</span>]:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"再见！"</span>)
                <span class="hljs-keyword">break</span>

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> prompt.strip():
                <span class="hljs-keyword">continue</span>

            response = agent.get_completion(prompt)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\033[92mAssistant: \033[0m"</span>, response, <span class="hljs-string">"\n"</span>)

        <span class="hljs-keyword">except</span> KeyboardInterrupt:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n程序终止"</span>)
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\033[91m发生错误: <span class="hljs-subst">{e}</span>\033[0m"</span>)
</code></pre>
<h2 data-id="heading-21">总结</h2>
<p>以上是<code>Agent</code>的全部内容了，我们了解了<code>LLM</code>、<code>Agent</code>的基本概念，还简单在本地搭建了一个简易的<code>Agent</code>，用于帮你充分理解<code>Agent</code>的五大组成部分：<strong>LLM、感知、工具、记忆、规划</strong>，希望能对你有所帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor AI Skills 实战：自动生成 Flutter 页面、代码与文档]]></title>    <link>https://juejin.cn/post/7591704324906811426</link>    <guid>https://juejin.cn/post/7591704324906811426</guid>    <pubDate>2026-01-05T14:05:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591704324906811426" data-draft-id="7591704324906795042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor AI Skills 实战：自动生成 Flutter 页面、代码与文档"/> <meta itemprop="keywords" content="Flutter,Cursor,AI编程"/> <meta itemprop="datePublished" content="2026-01-05T14:05:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="独立开发者_猫哥"/> <meta itemprop="url" content="https://juejin.cn/user/2717648472245358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor AI Skills 实战：自动生成 Flutter 页面、代码与文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648472245358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    独立开发者_猫哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T14:05:15.000Z" title="Mon Jan 05 2026 14:05:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Cursor AI Skills 实战：自动生成 Flutter 页面、代码与文档</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6c19ef632544d738637b75e76b3df77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us56uL5byA5Y-R6ICFX-eMq-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226715&amp;x-signature=Nl4cYHzdSgvPVIcznTBef8gRoKI%3D" alt="flutter skills" loading="lazy"/></p>
<h3 data-id="heading-1">视频</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyoutu.be%2FUeJYlTpm4ek" target="_blank" title="https://youtu.be/UeJYlTpm4ek" ref="nofollow noopener noreferrer">youtu.be/UeJYlTpm4ek</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1xpipBYE24%2F" target="_blank" title="https://www.bilibili.com/video/BV1xpipBYE24/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1xp…</a></p>
<h3 data-id="heading-2">前言</h3>
<p>本文系统介绍如何使用 Cursor AI Skills 自动生成 Flutter 页面、初始化项目结构，并持续维护项目技术文档。适合 Flutter 开发者与 AI 编程实践者，快速构建高效、可复用的 Flutter 开发工作流。</p>
<blockquote>
<p>原文 <a href="https://link.juejin.cn?target=https%3A%2F%2Fducafecat.com%2Fblog%2Fcursor-ai-skills-flutter-auto-code" target="_blank" title="https://ducafecat.com/blog/cursor-ai-skills-flutter-auto-code" ref="nofollow noopener noreferrer">使用 Cursor AI Skills 实现 Flutter 自动化开发（完整指南）</a></p>
</blockquote>
<p>分类: Cursor AI / Cursor AI Skills、Flutter / Flutter AI、AI 编程 / AI 代码生成</p>
<h3 data-id="heading-3">参考</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2Fcn%2Fdocs%2Fcontext%2Fskills" target="_blank" title="https://cursor.com/cn/docs/context/skills" ref="nofollow noopener noreferrer">Cursor Agent Skills</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fen%2Fskills" target="_blank" title="https://code.claude.com/docs/en/skills" ref="nofollow noopener noreferrer">Claude Agent Skills</a></li>
</ul>
<h3 data-id="heading-4">正文</h3>
<h4 data-id="heading-5">配置 Cursor 支持 Skills</h4>
<p>进入 Cursor Setting -&gt; Beta , Update Access 选择 Nightly，升级后重启。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e83394173d9c482aa03d6471835747d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us56uL5byA5Y-R6ICFX-eMq-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226715&amp;x-signature=c5L3CfToHwoetii8HKcNmwxjVhE%3D" alt="Update Access 选择 Nightly" loading="lazy"/></p>
<p>在 Rules, Subagents，Commands 面板下，开启 Import Agent Skills 重启。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a02a068d49dd4b519373f9958beb0c10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us56uL5byA5Y-R6ICFX-eMq-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226715&amp;x-signature=8cH4lp3XIHR27LJCcbcbspZxudw%3D" alt="开启 Import Agent Skills" loading="lazy"/></p>
<blockquote>
<p>重启后 claude 、codex 的 skills 就会全局可用。</p>
</blockquote>
<h4 data-id="heading-6">例子 1： Flutter创建页面组手（全局）</h4>
<p>编写文件 .codex/skills/Flutter创建页面组手/SKILL.md</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: "Flutter创建页面组手"
<span class="hljs-section">description: "Flutter 项目中创建页面"
---</span>

<span class="hljs-section"># Flutter创建页面组手</span>

按规则生成空页面脚手架代码。

<span class="hljs-section">## 读取变量</span>

<span class="hljs-bullet">-</span> 读取 [保存目录]
<span class="hljs-bullet">-</span> 读取 [业务名称]
<span class="hljs-bullet">-</span> 通过 [业务名称] 生成 [业务代码] (我的页面 -&gt; my<span class="hljs-emphasis">_page)
- [业务代码] 使用规则举例如下:
  - 文件名 my_</span>page
<span class="hljs-bullet">  -</span> 类名 MyPage
<span class="hljs-bullet">  -</span> 变量名 myPage
<span class="hljs-bullet">  -</span> 接口名 IMyPage

<span class="hljs-section">## 约束规则</span>

页面必须包含在 lib/pages 目录下面

<span class="hljs-section">## 页面目录</span>

如果 [业务代码] 时 my<span class="hljs-emphasis">_page，目录结构如下:

- [保存目录]
  - my_</span>page             // 业务目录
<span class="hljs-bullet">    -</span> widget            // 业务组建
<span class="hljs-bullet">    -</span> view.dart         // 视图代码
<span class="hljs-bullet">    -</span> controller.dart   // 控制器代码
<span class="hljs-bullet">    -</span> index.dart        // index 导包代码

<span class="hljs-section">## 页面代码</span>

如果 [业务代码] 时 my<span class="hljs-emphasis">_page，代码如下:

- index.dart        // index 导包代码

```dart
library;

export './controller.dart';
export './view.dart';
```

- controller.dart   // 控制器代码

```dart
import 'package:get/get.dart';

class MyPageController extends GetxController {
  MyPageController();

  _</span>initData() {
<span class="hljs-code">    update(["my_page"]);
  }
</span>
  void onTap() {}

  // @override
  // void onInit() {
  //   super.onInit();
  // }

  @override
  void onReady() {
<span class="hljs-code">    super.onReady();
    _initData();
  }
</span>
  // @override
  // void onClose() {
  //   super.onClose();
  // }
}
<span class="hljs-code">```

- view.dart         // 视图代码

```</span>dart
import 'package:flutter/material.dart';
import 'package:get/get.dart';

import 'index.dart';

class MyPagePage extends GetView<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyPageController</span>&gt;</span></span> {
  const MyPagePage({super.key});

  // 主视图
  Widget <span class="hljs-emphasis">_buildView() {
    return const Center(
      child: Text("MyPagePage"),
    );
  }

  @override
  Widget build(BuildContext context) {
    return GetBuilder<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyPageController</span>&gt;</span></span>(
      init: MyPageController(),
      id: "my_</span>page",
<span class="hljs-code">      builder: (_) {
        return Scaffold(
          appBar: AppBar(title: const Text("my_page")),
          body: SafeArea(
            child: _buildView(),
          ),
        );
      },
    );
  }
}
```
</span>
<span class="hljs-section">## 保存总导包 index</span>

文件 lib/pages/index.dart

追加在这个文件中即可

</code></pre>
<p>提示词</p>
<pre><code class="hljs language-bash" lang="bash">用 skill 在 lib/pages/cart 中创建页面 业务 购物历史，业务代码 cart_history
</code></pre>
<p>输出</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eda8ceec79764367ad01fbd36a7e7c83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us56uL5byA5Y-R6ICFX-eMq-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226715&amp;x-signature=kae36jxlQLJ7djTnCc2%2BWLksiL0%3D" alt="cursor skills 新建页面" loading="lazy"/></p>
<h4 data-id="heading-7">例子 2：Flutter项目初始化（全局）</h4>
<p>编写文件 .codex/skills/Flutter项目初始化/SKILL.md</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: Flutter项目初始化
<span class="hljs-section">description: 用猫哥的 ducafe<span class="hljs-emphasis">_ui_</span>core + getx 初始化一个规范的 flutter 项目。
---</span>

<span class="hljs-section"># Flutter项目初始化</span>

<span class="hljs-section">## 安装依赖包</span>

<span class="hljs-code">```shell
flutter pub add get
flutter pub add ducafe_ui_core
```</span>

<span class="hljs-section">## 1 创建业务 index 页面</span>

<span class="hljs-bullet">-</span> 使用 skill 在 lib/pages 目录下创建业务 首页，业务代码 index。

<span class="hljs-bullet">-</span> 没有 lib/pages 目录自动创建。

<span class="hljs-section">## 2 创建全局 Global 模块</span>

文件位置 lib/global.dart

<span class="hljs-code">```dart
import 'package:flutter/material.dart';

class Global {
  static Future&lt;void&gt; init() async {
    // 插件初始化
    // WidgetsFlutterBinding.ensureInitialized();

    // // 工具类
    // await Storage().init();

    // // 提示框
    // Loading();

    // // 加载服务
    // Get.put&lt;ConfigService&gt;(ConfigService()); // 配置
    // Get.put&lt;WPHttpService&gt;(WPHttpService()); // 网络请求
    // Get.put&lt;UserService&gt;(UserService()); // 用户
    // Get.put&lt;CartService&gt;(CartService()); // 购物车

    // // 初始化配置
    // await ConfigService.to.init();
  }
}
```</span>

<span class="hljs-section">## 3 创建 common 通用模块</span>

文件位置 lib/common/

<span class="hljs-section">### 目录结构</span>

<span class="hljs-code">```text
lib/common/
├── api/              # API 接口
│   └── index.dart
├── components/       # 通用组件
│   └── index.dart
├── extension/        # 扩展方法
│   └── index.dart
├── i18n/             # 国际化
│   └── index.dart
├── models/           # 数据模型
│   └── index.dart
├── routers/          # 路由配置
│   ├── index.dart
│   ├── names.dart
│   └── pages.dart
├── services/         # 服务层
│   └── index.dart
├── style/            # 样式
│   └── index.dart
├── utils/            # 工具类
│   └── index.dart
├── values/           # 常量值
│   ├── index.dart
│   ├── constants.dart
│   ├── images.dart
│   └── svgs.dart
├── widgets/          # 通用小部件
│   └── index.dart
└── index.dart        # 统一导出
```</span>

<span class="hljs-section">### 文件规则</span>

<span class="hljs-section">#### lib/common/index.dart</span>

<span class="hljs-code">```dart
library;

export 'api/index.dart';
export 'components/index.dart';
export 'extension/index.dart';
export 'i18n/index.dart';
export 'models/index.dart';
export 'routers/index.dart';
export 'services/index.dart';
export 'style/index.dart';
export 'utils/index.dart';
export 'values/index.dart';
export 'widgets/index.dart';
```</span>

<span class="hljs-section">#### lib/common/routers/names.dart</span>

<span class="hljs-code">```dart
class RouteNames {
  static const main = '/';
}
```</span>

<span class="hljs-section">#### lib/common/routers/pages.dart</span>

<span class="hljs-code">```dart
class RoutePages {
  // 列表
  // static List&lt;GetPage&gt; list = [];
}
```</span>

<span class="hljs-section">#### lib/common/routers/index.dart</span>

<span class="hljs-code">```dart
library;

export 'names.dart';
export 'pages.dart';
```</span>

<span class="hljs-section">#### lib/common/values/constants.dart</span>

<span class="hljs-code">```dart
/// 常量
class Constants {
  // 服务 api
  static const apiUrl = 'https://api.example.com';
}
```</span>

<span class="hljs-section">#### lib/common/values/images.dart</span>

<span class="hljs-code">```dart
/// 图片 assets
class AssetsImages {
}
```</span>

<span class="hljs-section">#### lib/common/values/svgs.dart</span>

<span class="hljs-code">```dart
/// svgs assets
class AssetsSvgs {
}
```</span>

<span class="hljs-section">#### lib/common/values/index.dart</span>

<span class="hljs-code">```dart
library;

export 'constants.dart';
export 'images.dart';
export 'svgs.dart';
```</span>

<span class="hljs-section">#### 其他模块 index.dart 模板</span>

<span class="hljs-bullet">-</span> api
<span class="hljs-bullet">-</span> components
<span class="hljs-bullet">-</span> extension
<span class="hljs-bullet">-</span> i18n/
<span class="hljs-bullet">-</span> models
<span class="hljs-bullet">-</span> services
<span class="hljs-bullet">-</span> style
<span class="hljs-bullet">-</span> utils
<span class="hljs-bullet">-</span> widgets

这些目录下的 index.dart 统一使用：

<span class="hljs-code">```dart
library;

// export './xxxx.dart';
```</span>

<span class="hljs-section">## 重写 main.dart</span>

lib/main.dart

<span class="hljs-code">```dart
import 'package:ducafe_ui_core/ducafe_ui_core.dart';
import 'package:flutter/material.dart';
import 'package:get/get.dart';

import 'pages/index.dart';
import 'global.dart';

void main() async {
  await Global.init();
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return ScreenUtilInit(
      designSize: const Size(414, 896), // 设计稿中设备的尺寸(单位随意,建议dp,但在使用过程中必须保持一致)
      // splitScreenMode: false, // 支持分屏尺寸
      // minTextAdapt: false, // 是否根据宽度/高度中的最小值适配文字
      builder: (context, child) {
        return GetMaterialApp(
          title: 'Flutter Demo',
          theme: ThemeData(primarySwatch: Colors.blue),
          home: const IndexPage(),
        );
      },
    );
  }
}
```</span>

</code></pre>
<p>提示词</p>
<pre><code class="hljs">使用 skill 初始化当前 flutter 项目
</code></pre>
<p>输出</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b99ad4b38734a139aa10c5889943d5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us56uL5byA5Y-R6ICFX-eMq-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226715&amp;x-signature=BIDy5lARh8HQzXA%2BZvd6D2PfsdQ%3D" alt="skill 初始化 flutter 项目" loading="lazy"/></p>
<h4 data-id="heading-8">例子 3：编写技术说明（项目）</h4>
<p>编写 .cursor/skills/编写技术说明/SKILL.md</p>
<pre><code class="hljs language-markdown" lang="markdown">---
name: 编写技术说明
<span class="hljs-section">description:  对当前项目进行技术整理并保存到文档中。
---</span>

<span class="hljs-section"># 项目技术说明</span>

你是一名资深 Flutter 架构师和技术文档专家。

我将持续向你提供一个 Flutter 项目的代码结构、关键文件、以及最近一次“改动内容”。

你的任务是：
1️⃣ 对当前 Flutter 项目进行技术架构分析  
2️⃣ 在“已有技术文档”的基础上 <span class="hljs-strong">**增量更新**</span>，而不是全部重写  
3️⃣ 明确标注「本次新增 / 修改 / 废弃」的技术点  
4️⃣ 输出一份结构化、可长期维护的技术说明文档  

请始终假设：

<span class="hljs-bullet">-</span> 该项目是一个<span class="hljs-strong">**长期维护的真实业务项目**</span>
<span class="hljs-bullet">-</span> 文档读者是：中高级 Flutter 开发者
<span class="hljs-bullet">-</span> 目标是：<span class="hljs-strong">**可读、可持续演进**</span>

---

<span class="hljs-section">## 文档保存位置</span>

docs/技术说明.md

<span class="hljs-section">## 📌 项目信息（如有）</span>

<span class="hljs-bullet">-</span> 项目名称：
<span class="hljs-bullet">-</span> Flutter 版本：
<span class="hljs-bullet">-</span> 状态管理方案（如 Riverpod / Bloc / GetX 等）：
<span class="hljs-bullet">-</span> 架构风格（如 Clean Architecture / Feature First 等）：

<span class="hljs-section">## 📌 已有技术文档（如存在）</span>

【我会粘贴当前版本的技术文档】

<span class="hljs-section">## 📌 本次改动内容</span>

【我会描述或粘贴本次代码变更 / 新增模块 / 重构点】

---

<span class="hljs-section">## 🎯 输出要求</span>

<span class="hljs-section">### 一、项目整体架构（如无重大变化，简要说明）</span>

<span class="hljs-bullet">-</span> 架构分层
<span class="hljs-bullet">-</span> 模块职责
<span class="hljs-bullet">-</span> 关键设计原则

<span class="hljs-section">### 二、本次迭代技术变更（重点）</span>

<span class="hljs-bullet">-</span> 🆕 新增内容
<span class="hljs-bullet">-</span> 🔄 修改内容
<span class="hljs-bullet">-</span> 🗑️ 废弃或替代方案
<span class="hljs-bullet">-</span> 变更动机 &amp; 技术取舍说明

<span class="hljs-section">### 三、关键代码设计解读</span>

<span class="hljs-bullet">-</span> 重要类 / 模块职责
<span class="hljs-bullet">-</span> 状态流转说明
<span class="hljs-bullet">-</span> 数据流 &amp; 依赖方向

<span class="hljs-section">### 四、对项目长期维护的影响</span>

<span class="hljs-bullet">-</span> 可扩展性
<span class="hljs-bullet">-</span> 可测试性
<span class="hljs-bullet">-</span> 潜在风险 &amp; 建议

<span class="hljs-section">### 五、文档版本记录（必须输出）</span>

<span class="hljs-bullet">-</span> 文档版本号（如 v1.2.0）
<span class="hljs-bullet">-</span> 更新时间
<span class="hljs-bullet">-</span> 本次更新摘要（3～5 条）

---

<span class="hljs-section">## ✍️ 写作风格要求</span>

<span class="hljs-bullet">-</span> 使用 <span class="hljs-strong">**工程师视角**</span>，避免空话
<span class="hljs-bullet">-</span> 关键地方可用「为什么这样设计」
<span class="hljs-bullet">-</span> 允许适度口语化，但保持专业
<span class="hljs-bullet">-</span> 使用 Markdown 输出，方便直接入库或发布

</code></pre>
<p>提示词</p>
<pre><code class="hljs">使用 skill 编写技术说明
</code></pre>
<p>输出</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8de8b6051a9641f59ce29206f9910c8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54us56uL5byA5Y-R6ICFX-eMq-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768226715&amp;x-signature=MGEmQuL%2BKrjLvfhhMHXfDwwLbqo%3D" alt="使用 skill 编写技术说明" loading="lazy"/></p>
<h3 data-id="heading-9">总结要点</h3>
<p>通过 Cursor AI Skills，Flutter 开发者可以将页面创建、项目初始化以及技术文档维护等重复性工作交给 AI 自动完成。本文结合实际示例，系统讲解了如何构建全局与项目级别的 Cursor Skills，实现高效、可持续的 Flutter 自动化开发流程。这种 AI 辅助编程方式，正在成为 Flutter 项目提效的新标准。</p>
<p>感谢阅读本文</p>
<p>如果有什么建议，请在评论中让我知道。我很乐意改进。</p>
<hr/>
<p>© 猫哥
ducafecat.com</p>
<p>end</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Opencode CLI 安装成功,但是启动失败]]></title>    <link>https://juejin.cn/post/7591799107485761546</link>    <guid>https://juejin.cn/post/7591799107485761546</guid>    <pubDate>2026-01-06T01:56:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591799107485761546" data-draft-id="7591801024008945673" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Opencode CLI 安装成功,但是启动失败"/> <meta itemprop="keywords" content="AI编程,OpenAI,Claude"/> <meta itemprop="datePublished" content="2026-01-06T01:56:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我要充满正能量"/> <meta itemprop="url" content="https://juejin.cn/user/3034307824453607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Opencode CLI 安装成功,但是启动失败
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3034307824453607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我要充满正能量
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:56:08.000Z" title="Tue Jan 06 2026 01:56:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Opencode CLI 安装成功,但是启动失败</h2>
<blockquote>
<p>运行报错:It seems that your package manager failed to install the right version of the opencode CLI for your platform. You can try manually installing the "opencode-windows-x64" package</p>
</blockquote>
<h3 data-id="heading-1">原因：镜像源配置问题</h3>
<h3 data-id="heading-2">问题描述</h3>
<p>在使用 npm 安装 opencode AI 工具时，遇到了安装完成后无法正常运行的问题。具体表现为：</p>
<p><strong>安装命令：</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install -g opencode-ai
</code></pre>
<p><strong>运行时错误：</strong></p>
<pre><code class="hljs language-java" lang="java">It seems that your <span class="hljs-keyword">package</span> manager failed to install the right version of the opencode CLI <span class="hljs-keyword">for</span> your platform. You can <span class="hljs-keyword">try</span> manually installing the <span class="hljs-string">"opencode-windows-x64"</span> <span class="hljs-keyword">package</span>
</code></pre>
<p>翻译:错误提示包管理器无法为当前平台安装正确版本的 opencode CLI，并建议手动安装 <code>opencode-windows-x64</code> 包。(我后面就去下载了桌面版,其实cli版我用得更习惯,就继续找问题了)</p>
<h3 data-id="heading-3">原因分析</h3>
<p>经过排查，发现问题根源在于 <strong>npm 镜像仓库配置</strong>。当前 npm 使用的是淘宝镜像源（<code>https://registry.npm.taobao.org</code>），该镜像源可能存在以下问题：</p>
<ol>
<li>
<p><strong>包版本同步延迟</strong>：第三方镜像仓库在同步官方 npm 仓库的包时，可能存在一定的时间延迟，导致无法获取最新版本的 opencode 包。</p>
</li>
<li>
<p><strong>包完整性问题</strong>：部分镜像仓库在同步过程中可能出现包文件不完整或损坏的情况，影响包的正常使用。</p>
</li>
<li>
<p><strong>平台特定包分发问题</strong>：某些平台特定的二进制包（如 opencode-windows-x64）在镜像同步过程中可能出现分发问题。</p>
</li>
</ol>
<h3 data-id="heading-4">解决方案</h3>
<h4 data-id="heading-5">步骤一：检查当前镜像源</h4>
<p>在解决问题之前，建议先确认当前的 npm 镜像配置：</p>
<pre><code class="hljs language-bash" lang="bash">npm config get registry
</code></pre>
<p>如果返回结果为 <code>https://registry.npm.taobao.org/</code>，说明当前使用的是淘宝镜像源。</p>
<h4 data-id="heading-6">步骤二：使用官方源重新安装</h4>
<p>通过 <code>--registry</code> 参数指定使用官方 npm 镜像源进行安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g opencode-ai --registry=https://registry.npmjs.org
</code></pre>
<h4 data-id="heading-7">步骤三：验证安装结果</h4>
<p>安装完成后，运行以下命令验证安装是否成功：</p>
<pre><code class="hljs language-bash" lang="bash">opencode --version
</code></pre>
<p>或直接启动程序：</p>
<pre><code class="hljs language-bash" lang="bash">opencode
</code></pre>
<p>如果程序正常启动且无报错信息，说明安装成功。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ecf8fa1c1914ebdb1bbe53425e98fc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR6KaB5YWF5ruh5q2j6IO96YeP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768269367&amp;x-signature=U36WcbCNIpgLZsjin%2Fw0j6jSKYg%3D" alt="正常运行" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[K8s Gateway API与现有Ingress控制器如何实现平滑迁移?]]></title>    <link>https://juejin.cn/post/7591704324907647010</link>    <guid>https://juejin.cn/post/7591704324907647010</guid>    <pubDate>2026-01-06T01:56:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591704324907647010" data-draft-id="7592017365140635700" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="K8s Gateway API与现有Ingress控制器如何实现平滑迁移?"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2026-01-06T01:56:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            K8s Gateway API与现有Ingress控制器如何实现平滑迁移?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T01:56:27.000Z" title="Tue Jan 06 2026 01:56:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>要实现<strong>Gateway API与传统Ingress控制器的平滑迁移</strong>，需遵循 <strong>“兼容共存、逐步切换、最小化风险”</strong> 的原则，核心步骤包括<strong>环境准备、配置转换、测试验证、流量灰度切换</strong>。以下是具体迁移方案及关键注意事项：</p>
<h3 data-id="heading-0"><strong>一、平滑迁移的核心方案</strong></h3>
<h4 data-id="heading-1"><strong>1. 环境准备：安装Gateway API及控制器</strong></h4>
<ul>
<li>
<p><strong>安装Gateway API CRDs</strong>：通过官方脚本安装最新稳定版的Gateway API CRDs（如<code>v1.4.1</code>），确保集群支持<code>Gateway</code>、<code>HTTPRoute</code>等资源。</p>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.1/standard-install.yaml
</code></pre>
</li>
<li>
<p><strong>部署Gateway控制器</strong>：选择主流的Gateway API实现（如<strong>Envoy Gateway</strong>、<strong>Nginx Gateway Fabric</strong>），通过Helm或YAML部署。例如，部署Envoy Gateway：</p>
<pre><code class="hljs language-arduino" lang="arduino">helm install eg oci:<span class="hljs-comment">//ghcr.io/envoyproxy/gateway-helm \
  --namespace envoy-gateway-system \
  --create-namespace</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-2"><strong>2. 配置转换：从Ingress到Gateway API</strong></h4>
<p>使用**<code>ingress2gateway</code>工具**（Kubernetes SIG-NETWORK社区提供）自动转换现有Ingress资源为Gateway API格式（如<code>Gateway</code>、<code>HTTPRoute</code>）。该工具支持Nginx、Traefik等主流Ingress控制器的配置转换。</p>
<ul>
<li>
<p><strong>步骤</strong>：</p>
<ol>
<li>导出现有Ingress资源：<code>kubectl get ingress -A -o yaml &gt; ingresses.yaml</code>；</li>
<li>运行转换工具：<code>ingress2gateway --input ingresses.yaml --output gateway-api.yaml</code>；</li>
<li>手动调整：对于<code>ingress2gateway</code>无法处理的<strong>自定义注解</strong>（如Nginx的<code>nginx.ingress.kubernetes.io/rewrite-target</code>），需转换为Gateway API的标准配置（如<code>HTTPRoute</code>的<code>urlRewrite</code>过滤器）。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-3"><strong>3. 测试验证：确保配置正确性</strong></h4>
<ul>
<li>
<p><strong>部署Gateway API资源</strong>：将转换后的<code>gateway-api.yaml</code>应用到集群，验证<code>Gateway</code>和<code>HTTPRoute</code>的状态：</p>
<pre><code class="hljs language-csharp" lang="csharp">kubectl apply -f gateway-api.yaml
kubectl <span class="hljs-keyword">get</span> gateways -A  <span class="hljs-meta"># 检查Gateway是否就绪</span>
kubectl <span class="hljs-keyword">get</span> httproutes -A  <span class="hljs-meta"># 检查HTTPRoute是否关联成功</span>
</code></pre>
</li>
<li>
<p><strong>流量测试</strong>：通过<code>curl</code>或浏览器访问Gateway的外部IP，验证路由规则是否正确（如路径匹配、TLS终止）。例如，若<code>HTTPRoute</code>配置了<code>path: /api</code>，则访问<code>http://&lt;gateway-ip&gt;/api</code>应转发至目标服务。</p>
</li>
</ul>
<h4 data-id="heading-4"><strong>4. 流量切换：灰度迁移</strong></h4>
<p>为避免业务中断，采用<strong>灰度切流</strong>方式逐步将流量从Ingress控制器切换至Gateway API：</p>
<ul>
<li><strong>方案1：复用现有SLB</strong>：若集群使用云厂商的SLB（如阿里云SLB），可将Gateway API的节点添加至现有SLB的虚拟服务器组，通过调整<strong>权重</strong>（如Gateway占10%、Ingress占90%）逐步切换流量。</li>
<li><strong>方案2：DNS权重解析</strong>：在DNS服务商（如阿里云DNS）中为业务域名添加Gateway API的SLB地址，设置权重（如Gateway占10%），逐步增加权重至100%。</li>
</ul>
<h3 data-id="heading-5"><strong>二、迁移过程中的关键注意事项</strong></h3>
<h4 data-id="heading-6"><strong>1. 自定义注解的兼容性处理</strong></h4>
<p>传统Ingress依赖<strong>注解</strong>（如Nginx的<code>nginx.ingress.kubernetes.io/rewrite-target</code>）实现高级功能，而Gateway API通过<strong>结构化配置</strong>（如<code>HTTPRoute</code>的<code>filters</code>）替代注解。迁移时需注意：</p>
<ul>
<li><strong>可自动转换的注解</strong>：<code>ingress2gateway</code>工具可处理大部分常见注解（如<code>rewrite-target</code>→<code>urlRewrite</code>、<code>timeout</code>→<code>timeout</code>）；</li>
<li><strong>无法自动转换的注解</strong>：需手动调整，例如Nginx的<code>nginx.ingress.kubernetes.io/load-balance</code>需转换为Gateway API的<code>backendRefs</code>权重配置。</li>
</ul>
<h4 data-id="heading-7"><strong>2. TLS配置的迁移</strong></h4>
<p>Ingress的TLS配置（如<code>tls.secretName</code>）需转换为Gateway API的<code>Gateway</code>资源的<code>listeners.tls</code>配置。例如：</p>
<ul>
<li>
<p>Ingress的TLS配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">tls:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">secretName:</span> <span class="hljs-string">example-com-tls</span>
</code></pre>
</li>
<li>
<p>转换为Gateway API的<code>Gateway</code>配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spec:</span>
  <span class="hljs-attr">listeners:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">https</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">HTTPS</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">443</span>
    <span class="hljs-attr">tls:</span>
      <span class="hljs-attr">mode:</span> <span class="hljs-string">Terminate</span>
      <span class="hljs-attr">certificateRefs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">example-com-tls</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-8"><strong>3. 跨命名空间路由的处理</strong></h4>
<p>Gateway API默认<strong>禁止跨命名空间路由</strong>，需通过<code>ReferenceGrant</code>资源授权。例如，若<code>HTTPRoute</code>在<code>app</code>命名空间，需<code>Gateway</code>在<code>gateway</code>命名空间，则需创建：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">gateway.networking.k8s.io/v1alpha2</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ReferenceGrant</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">allow-cross-namespace</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">gateway</span>  <span class="hljs-comment"># Gateway所在命名空间</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">from:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">gateway.networking.k8s.io</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">HTTPRoute</span>
    <span class="hljs-attr">namespace:</span> <span class="hljs-string">app</span>  <span class="hljs-comment"># HTTPRoute所在命名空间</span>
  <span class="hljs-attr">to:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">group:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
</code></pre>
<h4 data-id="heading-9"><strong>4. 监控与回滚</strong></h4>
<ul>
<li><strong>监控</strong>：迁移过程中需监控Gateway API的指标（如请求量、错误率），可使用Prometheus+Grafana或云厂商的监控服务（如阿里云ARMS）；</li>
<li><strong>回滚</strong>：若发现问题，可通过调整SLB权重或DNS解析快速回滚至Ingress控制器，确保业务连续性。</li>
</ul>
<h3 data-id="heading-10"><strong>三、总结</strong></h3>
<p>Gateway API与传统Ingress的平滑迁移需遵循 <strong>“兼容共存、逐步切换”</strong> 的原则，核心步骤包括<strong>环境准备、配置转换、测试验证、流量灰度切换</strong>。迁移过程中需注意<strong>自定义注解的兼容性、TLS配置、跨命名空间路由</strong>等关键问题，并通过<strong>监控与回滚</strong>确保业务稳定性。对于企业用户，建议优先选择<strong>云厂商提供的迁移工具</strong>（如阿里云MSE Ingress），以降低迁移成本与风险。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[dbVisitor 使用 MyBatis 方式操作 MongoDB]]></title>    <link>https://juejin.cn/post/7591513171199721535</link>    <guid>https://juejin.cn/post/7591513171199721535</guid>    <pubDate>2026-01-05T13:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591513171199721535" data-draft-id="7591497387246551076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="dbVisitor 使用 MyBatis 方式操作 MongoDB"/> <meta itemprop="keywords" content="MongoDB,ORM"/> <meta itemprop="datePublished" content="2026-01-05T13:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈库纳"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779538552"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            dbVisitor 使用 MyBatis 方式操作 MongoDB
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779538552/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈库纳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T13:38:20.000Z" title="Mon Jan 05 2026 13:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Java 生态中，操作 MongoDB 最常见的方式莫过于使用官方的 <code>mongo-java-driver</code> 或者 Spring 家族的 <code>spring-data-mongodb</code>。这些工具非常强大，但对于习惯了关系型数据库（RDBMS）和 MyBatis 开发模式的开发者来说，切换到 MongoDB 往往意味着需要适应一套全新的 API 和思维模式。</p>
<p>特别是在一个混合架构的项目中，如果同时存在 MySQL 和 MongoDB，数据访问层的代码风格割裂感会非常强：一边是 MyBatis 的 Mapper 接口和 XML，另一边是 <code>MongoTemplate</code> 的链式调用或 Repository 接口。这种差异不仅增加了学习成本，也让诸如“分页查询”这样的通用功能难以统一实现。</p>
<p>本文将介绍如何使用 <strong>dbVisitor</strong>，以一种“类 MyBatis”的方式来操作 MongoDB，实现架构上的统一。</p>

<h2 data-id="heading-0">1. 传统方式的痛点</h2>
<p>在传统的混合架构中，我们可能会遇到以下问题：</p>
<ul>
<li><strong>API 风格不统一</strong>：RDBMS 使用 SQL 和 JDBC，MongoDB 使用 BSON 和专有协议。</li>
<li><strong>分页实现差异</strong>：MyBatis 通常配合 PageHelper 或 RowBounds，而 MongoDB 需要手动计算 <code>skip</code> 和 <code>limit</code>，或者使用 Spring Data 的 <code>Pageable</code>。</li>
<li><strong>维护成本高</strong>：需要维护两套完全不同的底层逻辑，增加了代码的复杂度和出错的概率。</li>
</ul>
<h2 data-id="heading-1">2. dbVisitor 的解决方案</h2>
<p>dbVisitor 通过提供一个 JDBC 驱动层（<code>dbvisitor-driver</code>）和适配器（<code>jdbc-mongo</code>），将 MongoDB 的操作封装成了标准的 JDBC 接口。这意味着你可以像操作 MySQL 一样操作 MongoDB。</p>
<p>更进一步，dbVisitor 提供了类似 MyBatis 的 ORM 功能，支持 Mapper 接口、XML 映射文件、注解以及 Lambda 表达式。</p>
<h3 data-id="heading-2">2.1 对象关系映射 (ORM)</h3>
<p>首先，我们定义一个 Java 对象，并使用注解进行映射。这与 MyBatis Plus 或 JPA 非常相似。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Table("user_info")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInfo</span> {
    <span class="hljs-comment">// 映射 _id 字段，并自动处理 ObjectId</span>
    <span class="hljs-meta">@Column(value = "_id", primary = true, keyType = KeyType.Auto, whereValueTemplate = "ObjectId(?)")</span>
    <span class="hljs-keyword">private</span> String id;

    <span class="hljs-meta">@Column("name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column("age")</span>
    <span class="hljs-keyword">private</span> Integer age;

    <span class="hljs-comment">// 省略 getter/setter</span>
}
</code></pre>
<h3 data-id="heading-3">2.2 使用 Mapper 接口 (注解方式)</h3>
<p>你可以定义一个 Mapper 接口，使用注解来编写 MongoDB 的命令。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SimpleMapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfoMapper</span> {
    <span class="hljs-comment">// 插入数据</span>
    <span class="hljs-meta">@Insert("test.user_info.insert(#{info})")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(<span class="hljs-meta">@Param("info")</span> UserInfo info)</span>;

    <span class="hljs-comment">// 根据 ID 查询</span>
    <span class="hljs-meta">@Query("test.user_info.find({_id: ObjectId(#{id})})")</span>
    UserInfo <span class="hljs-title function_">loadById</span><span class="hljs-params">(<span class="hljs-meta">@Param("id")</span> String id)</span>;

    <span class="hljs-comment">// 删除数据</span>
    <span class="hljs-meta">@Delete("test.user_info.remove({_id: ObjectId(#{id})})")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@Param("id")</span> String id)</span>;
}
</code></pre>
<h3 data-id="heading-4">2.3 使用通用 Mapper</h3>
<p>如果你不想写任何命令，可以直接继承 <code>BaseMapper</code>，dbVisitor 会自动生成基础的 CRUD 操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SimpleMapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfoBaseMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;UserInfo&gt; {
    <span class="hljs-comment">// 自动拥有 insert, update, delete, selectById, listBySample 等方法</span>
}
</code></pre>
<h3 data-id="heading-5">2.4 使用 Lambda 方式</h3>
<p>dbVisitor 也提供了类似 MyBatis Plus 的 Lambda 调用方式，完全类型安全。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">LambdaTemplate</span> <span class="hljs-variable">lambda</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaTemplate</span>(connection);

<span class="hljs-comment">// 查询 name = "mali" 的用户</span>
<span class="hljs-type">UserInfo</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> lambda.query(UserInfo.class)
    .eq(UserInfo::getName, <span class="hljs-string">"mali"</span>)
    .queryForObject();

<span class="hljs-comment">// 更新操作</span>
lambda.update(UserInfo.class)
    .eq(UserInfo::getId, user.getId())
    .updateTo(UserInfo::getAge, <span class="hljs-number">27</span>)
    .doUpdate();
</code></pre>
<h3 data-id="heading-6">2.5 使用 XML 管理 Mapper (MyBatis 风格)</h3>
<p>对于复杂的查询或需要统一管理 SQL 的场景，dbVisitor 支持使用 XML 文件来定义 Mapper，这与 MyBatis 的体验几乎一致。</p>
<p><strong>Mapper 接口：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RefMapper("mapper/user-mapper.xml")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfoXmlMapper</span> {
    <span class="hljs-type">int</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(<span class="hljs-meta">@Param("info")</span> UserInfo info)</span>;
    List&lt;UserInfo&gt; <span class="hljs-title function_">listByUserName</span><span class="hljs-params">(<span class="hljs-meta">@Param("userName")</span> String userName, Page page)</span>;
}
</code></pre>
<p><strong>XML 文件 (user-mapper.xml)：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//dbvisitor.net//DTD Mapper 1.0//EN"</span>
        <span class="hljs-string">"https://www.dbvisitor.net/schema/dbvisitor-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserInfoXmlMapper"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userResultMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.entity.UserInfo"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"_id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"age"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"saveUser"</span>&gt;</span>
        test.user_info.insert({
            name: #{info.name},
            age: #{info.age}
        })
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 支持自动分页 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"listByUserName"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"userResultMap"</span>&gt;</span>
        test.user_info.find({name: #{userName}})
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h2 data-id="heading-7">3. 统一的分页实现</h2>
<p>在 dbVisitor 中，无论是操作 MySQL 还是 MongoDB，分页查询的实现方式是完全统一的。你只需要传递一个 <code>Page</code> 对象。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建分页对象</span>
<span class="hljs-type">Page</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageObject</span>();
page.setPageSize(<span class="hljs-number">10</span>);
page.setPageNumber(<span class="hljs-number">0</span>); <span class="hljs-comment">// 第一页</span>

<span class="hljs-comment">// 执行查询，dbVisitor 会自动拦截并重写为分页查询</span>
<span class="hljs-comment">// 对于 MongoDB，会自动转换为 .skip(0).limit(10)</span>
List&lt;UserInfo&gt; list = mapper.listByUserName(<span class="hljs-string">"mali"</span>, page);

<span class="hljs-comment">// 获取总记录数（如果需要）</span>
<span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> page.getTotalCount();

<span class="hljs-comment">// 翻页</span>
page.nextPage();
list = mapper.listByUserName(<span class="hljs-string">"mali"</span>, page);
</code></pre>
<h2 data-id="heading-8">4. 总结</h2>
<p>通过 dbVisitor，我们可以在同一个项目中，用同一套 API、同一种思维方式（Mapper/XML/Lambda）同时操作关系型数据库和 MongoDB。这极大地降低了混合架构项目的开发和维护成本，让数据访问层变得更加整洁和统一。</p>
<p>如果你正在寻找一种能够统一 RDBMS 和 NoSQL 开发体验的工具，dbVisitor 绝对值得一试。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Cursor进阶实战·04】工作流革命：从"手动驾驶"到"自动驾驶"]]></title>    <link>https://juejin.cn/post/7591702898080350223</link>    <guid>https://juejin.cn/post/7591702898080350223</guid>    <pubDate>2026-01-05T13:53:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591702898080350223" data-draft-id="7591703562134093858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Cursor进阶实战·04】工作流革命：从&quot;手动驾驶&quot;到&quot;自动驾驶&quot;"/> <meta itemprop="keywords" content="Cursor,人工智能,AI编程"/> <meta itemprop="datePublished" content="2026-01-05T13:53:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Cursor进阶实战·04】工作流革命：从"手动驾驶"到"自动驾驶"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T13:53:07.000Z" title="Mon Jan 05 2026 13:53:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">传统工作流的问题与挑战</h2>
<p>在使用Cursor进行AI辅助开发时，开发者往往会遇到以下典型问题：</p>
<h3 data-id="heading-1">重复性工作</h3>
<p>当需要创建新功能时，开发者通常需要向AI详细说明项目规范和技术栈要求。例如，创建一个用户列表页面时，需要明确指定：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">帮我创建一个用户列表页面，使用<span class="hljs-keyword">Next</span>.js + TypeScript + TailwindCSS + Shadcn/UI
</code></pre>
<p>然而，AI生成的代码往往存在以下问题：</p>
<ul>
<li>❌ 使用了class组件而非函数组件</li>
<li>❌ 样式采用内联方式而非TailwindCSS</li>
<li>❌ API调用缺少错误处理</li>
<li>❌ 代码缺少必要的注释</li>
</ul>
<p>开发者需要花费15-20分钟手动修改这些问题，使代码符合团队规范。当需要创建类似功能时，又需要重复说明相同的规范要求。</p>
<h3 data-id="heading-2">质量保障缺失</h3>
<p>在实际开发中，还存在以下问题：</p>
<ul>
<li><strong>代码格式问题</strong>: 提交前忘记格式化，CI因格式问题失败，需要额外30分钟修复</li>
<li><strong>团队协作问题</strong>: 新成员不了解项目规范，AI生成的代码风格与现有代码不一致</li>
<li><strong>上下文理解问题</strong>: 每次都需要重新向AI解释项目架构和业务逻辑</li>
</ul>
<h3 data-id="heading-3">效率瓶颈</h3>
<p>这些问题导致开发效率低下：</p>
<ul>
<li>每次Prompt需要150字以上的详细说明</li>
<li>AI输出代码的可用率仅60%，需要大量手动修改</li>
<li>代码审查和格式修复占用大量时间</li>
<li>团队协作中代码风格不统一，增加维护成本</li>
</ul>
<h3 data-id="heading-4">解决方案：工作流自动化</h3>
<p>通过配置<strong>Rules、Context、Hooks</strong>三大工具，可以实现从"手动驾驶"到"自动驾驶"的转变：</p>
<ul>
<li><strong>Rules</strong>: 定义AI的行为规范，让AI自动遵守项目规范</li>
<li><strong>Context</strong>: 提供项目上下文，让AI理解项目架构和业务逻辑</li>
<li><strong>Hooks</strong>: 实现自动化质量检查，确保代码质量</li>
</ul>
<p><strong>本文目标</strong>:</p>
<ul>
<li>理解工作流自动化的三大支柱</li>
<li>掌握<code>.cursorrules</code>配置技巧</li>
<li>学会使用Context提供项目上下文</li>
<li>配置Hooks实现自动化质量检查</li>
<li>完整的配置方案和预期效果</li>
</ul>
<hr/>
<h2 data-id="heading-5">工作流的三大支柱</h2>
<p>在深入配置之前，先理解Cursor工作流自动化的架构：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee00f5ea2c3a40568631b4942eab8f8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768225987&amp;x-signature=do3s83d7piePuRHR%2Fxqvc5YJ5Ig%3D" alt="cursor04-工作流三大支柱架构图.png" loading="lazy"/></p>
<h3 data-id="heading-6">Rules：AI的行为规范手册</h3>
<p><strong>作用</strong>: 定义AI的输出风格、技术选型、代码规范</p>
<p><strong>位置</strong>:</p>
<ul>
<li>项目级：<code>.cursorrules</code> 文件（团队共享）</li>
<li>用户级：<code>~/.cursor/rules</code> 文件（个人偏好）</li>
</ul>
<p><strong>优先级</strong>: 项目级 &gt; 用户级</p>
<p><strong>核心价值</strong>:</p>
<blockquote>
<p>"像给AI做了一次'入职培训'，它会记住并执行团队规范。"</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">Context：AI的项目记忆</h3>
<p><strong>作用</strong>: 让AI理解当前项目的架构、技术栈、业务逻辑</p>
<p><strong>类型</strong>:</p>
<ul>
<li><code>@Codebase</code> - 全局代码搜索</li>
<li><code>@Docs</code> - 关联项目文档</li>
<li><code>@Web</code> - 实时网络信息</li>
<li><code>@Git</code> - 版本历史上下文</li>
</ul>
<p><strong>核心价值</strong>:</p>
<blockquote>
<p>"AI不再是'健忘'的助手，而是理解项目全貌的伙伴。"</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">Hooks：AI的自动化触发器</h3>
<p><strong>作用</strong>: 在特定时机自动执行AI任务</p>
<p><strong>位置</strong>: <code>.cursor/hooks.json</code> 文件</p>
<p><strong>类型</strong>:</p>
<ul>
<li><code>beforeSubmitPrompt</code> - 发送前检查</li>
<li><code>afterFileEdit</code> - 文件修改后处理</li>
<li><code>beforeShellExecution</code> - 命令执行前控制</li>
<li><code>stop</code> - Agent完成后审查</li>
</ul>
<p><strong>核心价值</strong>:</p>
<blockquote>
<p>"让AI从'被动响应'变成'主动守护'，24小时在线的质量守卫。"</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">三者的协同关系</h3>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────┐
│  Rules: 定义<span class="hljs-string">"怎么做"</span>                  │
│  - 技术栈规范                         │
│  - 代码风格                          │
│  - 输出要求                          │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  Context: 提供<span class="hljs-string">"做什么"</span>的上下文        │
│  - 项目架构                         │
│  - 业务规则                         │
│  - 历史代码                         │
└──────────────┬──────────────────────┘
               ↓
┌─────────────────────────────────────┐
│  Hooks: 确保<span class="hljs-string">"做对了"</span>                 │
│  - 自动检查                          │
│  - 格式化                            │
│  - 质量守护                          │
└─────────────────────────────────────┘
</code></pre>
<p><strong>对比效果</strong>:</p>






























<table><thead><tr><th align="left">维度</th><th align="left">传统工作流</th><th align="left">Cursor工作流</th></tr></thead><tbody><tr><td align="left">Prompt长度</td><td align="left">每次150字说明规范</td><td align="left">30字简单描述需求</td></tr><tr><td align="left">AI输出可用率</td><td align="left">60%需要手动修改</td><td align="left">95%直接可用</td></tr><tr><td align="left">代码审查</td><td align="left">30分钟手动检查</td><td align="left">5分钟自动完成</td></tr><tr><td align="left">团队协作</td><td align="left">各自配置，风格混乱</td><td align="left">统一配置，风格一致</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">Rules实战：打造专属AI助手</h2>
<h3 data-id="heading-11">基础配置模板</h3>
<p>创建项目根目录下的<code>.cursorrules</code>文件：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目信息</span>
<span class="hljs-bullet">-</span> 项目名称: [Your Project Name]
<span class="hljs-bullet">-</span> 技术栈: Next.js 14 + TypeScript + TailwindCSS
<span class="hljs-bullet">-</span> UI组件库: Shadcn/UI
<span class="hljs-bullet">-</span> 状态管理: Zustand
<span class="hljs-bullet">-</span> 包管理器: pnpm

<span class="hljs-section"># 代码规范</span>

<span class="hljs-section">## 组件规范</span>
<span class="hljs-bullet">-</span> 使用函数式组件和React Hooks
<span class="hljs-bullet">-</span> 优先使用Server Components（Next.js 14）
<span class="hljs-bullet">-</span> Props使用TypeScript接口定义
<span class="hljs-bullet">-</span> 组件文件命名: PascalCase.tsx

<span class="hljs-section">## 命名规范</span>
<span class="hljs-bullet">-</span> 文件名: kebab-case（my-component.tsx）
<span class="hljs-bullet">-</span> 组件名: PascalCase（MyComponent）
<span class="hljs-bullet">-</span> 函数名: camelCase（handleClick）
<span class="hljs-bullet">-</span> 常量名: UPPER<span class="hljs-emphasis">_SNAKE_</span>CASE（API<span class="hljs-emphasis">_BASE_</span>URL）

<span class="hljs-section">## 代码风格</span>
<span class="hljs-bullet">-</span> 使用函数式编程思想
<span class="hljs-bullet">-</span> 避免使用any类型
<span class="hljs-bullet">-</span> 使用可选链和空值合并运算符
<span class="hljs-bullet">-</span> 单个函数不超过50行

<span class="hljs-section"># 设计规范</span>

<span class="hljs-section">## 配色系统</span>
<span class="hljs-bullet">-</span> 主色调: slate系（深色模式为主）
<span class="hljs-bullet">-</span> 背景: bg-slate-950（主）、bg-slate-900（次）
<span class="hljs-bullet">-</span> 文字: text-slate-100（主）、text-slate-400（次）
<span class="hljs-bullet">-</span> 强调色: blue-600（链接）、green-600（成功）

<span class="hljs-section">## 布局规范</span>
<span class="hljs-bullet">-</span> 圆角: rounded-xl（卡片）、rounded-lg（按钮）
<span class="hljs-bullet">-</span> 间距: p-6（卡片内边距）、gap-4（元素间距）
<span class="hljs-bullet">-</span> 阴影: shadow-sm（轻微）、shadow-md（明显）

<span class="hljs-section">## 动画规范</span>
<span class="hljs-bullet">-</span> 过渡: transition-all duration-200
<span class="hljs-bullet">-</span> 悬停: hover:opacity-80、hover:scale-105

<span class="hljs-section"># 输出要求</span>

<span class="hljs-section">## 代码质量</span>
<span class="hljs-bullet">-</span> 所有函数必须添加注释说明用途和参数
<span class="hljs-bullet">-</span> 复杂逻辑添加行内注释
<span class="hljs-bullet">-</span> 导出的组件添加JSDoc注释

<span class="hljs-section">## 复用优先</span>
<span class="hljs-bullet">-</span> 优先使用项目中已有的组件
<span class="hljs-bullet">-</span> 不要重复造轮子
<span class="hljs-bullet">-</span> 修改代码前先理解现有实现

<span class="hljs-section">## 错误处理</span>
<span class="hljs-bullet">-</span> API调用必须有loading和error状态
<span class="hljs-bullet">-</span> 用户操作提供即时反馈
<span class="hljs-bullet">-</span> 异常情况显示友好错误信息

<span class="hljs-section"># 性能要求</span>
<span class="hljs-bullet">-</span> 图片使用Next.js Image组件
<span class="hljs-bullet">-</span> 大列表使用虚拟滚动
<span class="hljs-bullet">-</span> 避免不必要的重渲染
<span class="hljs-bullet">-</span> 使用React.memo优化组件
</code></pre>
<h3 data-id="heading-12">配置效果对比</h3>
<p><strong>场景</strong>: 让AI生成一个用户列表页面</p>
<p><strong>没有Rules时</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AI输出（需要7处修改）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{padding:</span> '<span class="hljs-attr">20px</span>'}}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>用户列表<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        {users.map(user =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{user.id}</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
</code></pre>
<p><strong>手动修改项</strong>:</p>
<ol>
<li>❌ 改成函数组件</li>
<li>❌ 移除内联样式</li>
<li>❌ 改用TailwindCSS</li>
<li>❌ 添加类型定义</li>
<li>❌ 添加注释</li>
<li>❌ 使用Shadcn/UI组件</li>
<li>❌ 添加loading状态</li>
</ol>
<p><strong>耗时</strong>: 15分钟</p>
<hr/>
<p><strong>有Rules后</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 用户列表页面
 * 显示所有用户信息，支持搜索和分页
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UserList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [users, setUsers] = useState&lt;<span class="hljs-title class_">User</span>[]&gt;([])
  <span class="hljs-keyword">const</span> [isLoading, setIsLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>)
  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchUsers</span>()
  }, [])

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUsers</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>)
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
      <span class="hljs-title function_">setUsers</span>(data)
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">setError</span>(<span class="hljs-string">'获取用户列表失败'</span>)
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setIsLoading</span>(<span class="hljs-literal">false</span>)
    }
  }

  <span class="hljs-keyword">if</span> (isLoading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span></span>
  <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorMessage</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{error}</span> /&gt;</span></span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"max-w-7xl mx-auto p-6"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-slate-100 text-2xl font-bold mb-6"</span>&gt;</span>
        用户列表
      <span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"grid gap-4"</span>&gt;</span>
        {users.map((user) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{user.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-6 bg-slate-900"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-slate-100 font-semibold"</span>&gt;</span>
              {user.name}
            <span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-slate-400"</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Badge</span> <span class="hljs-attr">variant</span>=<span class="hljs-string">"secondary"</span>&gt;</span>{user.role}<span class="hljs-tag">&lt;/<span class="hljs-name">Badge</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>预期结果</strong>:</p>
<ul>
<li>✅ 函数组件 + Hooks</li>
<li>✅ TypeScript类型定义</li>
<li>✅ TailwindCSS样式</li>
<li>✅ Shadcn/UI组件（Card、Badge）</li>
<li>✅ Loading和Error状态</li>
<li>✅ JSDoc注释</li>
<li>✅ 符合命名规范</li>
</ul>
<p><strong>修改次数</strong>: 0次
<strong>节省时间</strong>: 15分钟</p>
<hr/>
<h3 data-id="heading-13">进阶配置：分场景定制</h3>
<p>根据不同开发场景，可以添加特定规则：</p>
<p><strong>开发环境规则</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 开发模式规则</span>
<span class="hljs-bullet">-</span> 允许使用console.log调试
<span class="hljs-bullet">-</span> 可以暂时使用any类型
<span class="hljs-bullet">-</span> 代码注释可以更详细
</code></pre>
<p><strong>生产环境规则</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 生产模式规则</span>
<span class="hljs-bullet">-</span> 禁止console.log，使用logger
<span class="hljs-bullet">-</span> 严格禁止any类型
<span class="hljs-bullet">-</span> 必须处理所有边界情况
<span class="hljs-bullet">-</span> 性能优化优先
</code></pre>
<p><strong>重构场景规则</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 重构模式规则</span>
<span class="hljs-bullet">-</span> 不改变现有功能
<span class="hljs-bullet">-</span> 保持API兼容性
<span class="hljs-bullet">-</span> 添加足够的测试
<span class="hljs-bullet">-</span> 逐步迁移，不要一次性大改
</code></pre>

**最佳实践**: 将项目级Rules提交到Git，确保团队成员自动同步。个人偏好（如注释详细程度）放在用户级配置。

<hr/>
<h2 data-id="heading-14">Context实战：让AI理解项目</h2>
<h3 data-id="heading-15">四种Context类型对比</h3>








































<table><thead><tr><th align="left">Context</th><th align="left">作用</th><th align="left">使用场景</th><th align="center">响应速度</th><th align="left">示例</th></tr></thead><tbody><tr><td align="left">@Codebase</td><td align="left">全局代码搜索</td><td align="left">理解架构、查找实现</td><td align="center">慢</td><td align="left">@Codebase 权限系统怎么实现</td></tr><tr><td align="left">@Docs</td><td align="left">关联项目文档</td><td align="left">参考规范和文档</td><td align="center">快</td><td align="left">@Docs 查看API设计规范</td></tr><tr><td align="left">@Web</td><td align="left">实时网络信息</td><td align="left">查询最新技术</td><td align="center">中</td><td align="left">@Web Next.js 14新特性</td></tr><tr><td align="left">@Git</td><td align="left">版本历史上下文</td><td align="left">理解代码演进</td><td align="center">中</td><td align="left">查看这个函数的修改历史</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">@Docs配置方案</h3>
<p><strong>目录结构</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">.cursor/
└── docs/
    ├── architecture.md      <span class="hljs-comment"># 架构文档</span>
    ├── api-conventions.md   <span class="hljs-comment"># API规范</span>
    ├── coding-style.md      <span class="hljs-comment"># 代码约定</span>
    ├── component-library.md <span class="hljs-comment"># 组件库说明</span>
    └── business-rules.md    <span class="hljs-comment"># 业务规则</span>
</code></pre>
<p><strong>示例：API规范文档</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># API设计规范</span>

<span class="hljs-section">## 统一响应格式</span>

所有API接口必须返回以下格式：

<span class="hljs-code">```typescript
interface APIResponse&lt;T&gt; {
  code: number      // 状态码：0成功，其他失败
  message: string   // 提示信息
  data: T          // 实际数据
  timestamp: number // 时间戳
}
</span></code></pre>
<h2 data-id="heading-17">错误码定义</h2>






























<table><thead><tr><th align="left">错误码</th><th align="left">说明</th><th align="left">处理方式</th></tr></thead><tbody><tr><td align="left">1001</td><td align="left">参数错误</td><td align="left">检查请求参数</td></tr><tr><td align="left">2001</td><td align="left">未授权</td><td align="left">跳转登录页</td></tr><tr><td align="left">2002</td><td align="left">权限不足</td><td align="left">提示无权限</td></tr><tr><td align="left">5001</td><td align="left">服务器错误</td><td align="left">稍后重试</td></tr></tbody></table>
<h2 data-id="heading-18">命名规范</h2>
<ul>
<li>GET: /api/resources - 获取列表</li>
<li>GET: /api/resources/:id - 获取详情</li>
<li>POST: /api/resources - 创建资源</li>
<li>PUT: /api/resources/:id - 更新资源</li>
<li>DELETE: /api/resources/:id - 删除资源</li>
</ul>
<pre><code class="hljs language-php" lang="php">
**预期效果**: AI生成的API代码自动符合这个格式：

```typescript
<span class="hljs-comment">// AI自动生成符合规范的代码</span>
export async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GET</span>(<span class="hljs-params"/>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">users</span> = await db.user.<span class="hljs-title function_ invoke__">findMany</span>()

    <span class="hljs-keyword">return</span> NextResponse.<span class="hljs-title function_ invoke__">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'success'</span>,
      <span class="hljs-attr">data</span>: users,
      <span class="hljs-attr">timestamp</span>: Date.<span class="hljs-title function_ invoke__">now</span>()
    })
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> NextResponse.<span class="hljs-title function_ invoke__">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">5001</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'服务器错误'</span>,
      <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">timestamp</span>: Date.<span class="hljs-title function_ invoke__">now</span>()
    }, { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> })
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-19">Context组合使用技巧</h3>
<p><strong>场景</strong>: 添加JWT token刷新功能</p>
<p><strong>❌ 糟糕的Prompt</strong>:</p>
<pre><code class="hljs">帮我添加JWT token刷新功能
</code></pre>
<p><strong>结果</strong>: AI不了解现有认证实现，可能生成与项目架构不匹配的代码。</p>
<hr/>
<p><strong>✅ 优秀的Prompt</strong>:</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Codebase</span> 查看现有的用户认证实现
<span class="hljs-variable">@Docs</span> 参考API规范文档
<span class="hljs-variable">@Web</span> <span class="hljs-attribute">https</span>:<span class="hljs-comment">//jwt.io/introduction</span>

基于现有的认证架构，添加JWT token自动刷新功能：
<span class="hljs-number">1</span>. 检测token即将过期
<span class="hljs-number">2</span>. 自动调用刷新接口
<span class="hljs-number">3</span>. 更新本地存储
<span class="hljs-number">4</span>. 无感知续期
</code></pre>
<p><strong>预期效果</strong>:</p>
<ul>
<li>✅ 复用现有认证代码结构</li>
<li>✅ 遵守API响应格式规范</li>
<li>✅ 使用最新的JWT最佳实践</li>
<li>✅ 与现有中间件无缝集成</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5218bc05f394e02b2df34f38986cae3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768225987&amp;x-signature=VTxcunRE%2BntE9rJl%2BCQJuN0H%2BnI%3D" alt="cursor04-Context使用流程图.png" loading="lazy"/></p>

**性能优化提示**: 优先使用`@Docs`和精准的`@file`引用，避免频繁使用`@Codebase`全量搜索，可以显著提升响应速度。

<hr/>
<h2 data-id="heading-20">Hooks实战：自动化质量守护</h2>
<h3 data-id="heading-21">Hooks配置基础</h3>
<p><strong>文件位置</strong>: <code>.cursor/hooks.json</code></p>
<p><strong>基本结构</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"beforeSubmitPrompt"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.cursor/scripts/check-prompt.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"afterFileEdit"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.cursor/scripts/format-code.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"stop"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.cursor/scripts/review-changes.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>配置级别（优先级从高到低）</strong>:</p>
<ol>
<li>企业级：企业统一配置</li>
<li>项目级：<code>.cursor/hooks.json</code>（团队共享）</li>
<li>用户级：<code>~/.cursor/hooks.json</code>（个人配置）</li>
</ol>
<hr/>
<h3 data-id="heading-22">核心Hooks类型和应用场景</h3>
<h4 data-id="heading-23">1. beforeSubmitPrompt - 发送前安全检查</h4>
<p><strong>场景</strong>: 防止敏感信息泄露</p>
<p><strong>配置脚本</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 读取用户输入的prompt</span>
json_input=$(<span class="hljs-built_in">cat</span>)
prompt=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$json_input</span>"</span> | jq -r <span class="hljs-string">'.prompt'</span>)

<span class="hljs-comment"># 检查敏感信息模式</span>
sensitive_patterns=(
  <span class="hljs-string">"password"</span>
  <span class="hljs-string">"secret"</span>
  <span class="hljs-string">"token"</span>
  <span class="hljs-string">"api[_-]?key"</span>
  <span class="hljs-string">"private[_-]?key"</span>
)

<span class="hljs-comment"># 遍历检查</span>
<span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${sensitive_patterns[@]}</span>"</span>; <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$prompt</span>"</span> | grep -iE <span class="hljs-string">"<span class="hljs-variable">$pattern</span>"</span> &gt; /dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️ 检测到可能的敏感信息: <span class="hljs-variable">$pattern</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"请移除后再发送，或确认这是示例数据"</span>
    <span class="hljs-built_in">exit</span> 1
  <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># 通过检查</span>
<span class="hljs-built_in">exit</span> 0
</code></pre>
<p><strong>预期效果</strong>:</p>
<pre><code class="hljs language-arduino" lang="arduino">用户输入: <span class="hljs-string">"帮我把密码password123写入配置"</span>
    ↓
Hook拦截
    ↓
显示警告: <span class="hljs-string">"检测到可能的敏感信息: password"</span>
    ↓
阻止发送，要求用户修改
</code></pre>
<hr/>
<h4 data-id="heading-24">2. afterFileEdit - 文件修改后自动格式化</h4>
<p><strong>场景</strong>: 确保代码符合格式规范</p>
<p><strong>配置脚本</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 解析修改的文件信息</span>
json_input=$(<span class="hljs-built_in">cat</span>)
file_path=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$json_input</span>"</span> | jq -r <span class="hljs-string">'.file'</span>)

<span class="hljs-comment"># TypeScript/JavaScript文件处理</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$file_path</span> =~ \.(ts|tsx|js|jsx)$ ]]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"🔧 正在格式化: <span class="hljs-variable">$file_path</span>"</span>

  <span class="hljs-comment"># Prettier格式化</span>
  npx prettier --write <span class="hljs-string">"<span class="hljs-variable">$file_path</span>"</span> 2&gt;/dev/null

  <span class="hljs-comment"># ESLint修复</span>
  npx eslint --fix <span class="hljs-string">"<span class="hljs-variable">$file_path</span>"</span> 2&gt;/dev/null

  <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 格式化完成"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># JSON文件处理</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$file_path</span> =~ \.json$ ]]; <span class="hljs-keyword">then</span>
  <span class="hljs-comment"># 格式化JSON</span>
  jq <span class="hljs-string">'.'</span> <span class="hljs-string">"<span class="hljs-variable">$file_path</span>"</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$file_path</span>.tmp"</span> &amp;&amp; <span class="hljs-built_in">mv</span> <span class="hljs-string">"<span class="hljs-variable">$file_path</span>.tmp"</span> <span class="hljs-string">"<span class="hljs-variable">$file_path</span>"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">exit</span> 0
</code></pre>
<p><strong>预期效果</strong>:</p>
<pre><code class="hljs language-css" lang="css">AI修改了 <span class="hljs-attribute">src</span>/components/<span class="hljs-selector-tag">Button</span><span class="hljs-selector-class">.tsx</span>
    ↓
Hook自动触发
    ↓
执行: prettier --write Button.tsx
执行: eslint --fix Button.tsx
    ↓
代码自动符合团队规范
    ↓
显示: <span class="hljs-string">"✅ 格式化完成"</span>
</code></pre>
<hr/>
<h4 data-id="heading-25">3. stop - Agent完成后生成摘要</h4>
<p><strong>场景</strong>: 任务完成后的变更摘要和建议</p>
<p><strong>配置脚本</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"📊 生成变更摘要..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-comment"># 统计修改文件</span>
files_changed=$(git diff --name-only | <span class="hljs-built_in">wc</span> -l)
lines_added=$(git diff --<span class="hljs-built_in">stat</span> | <span class="hljs-built_in">tail</span> -1 | grep -oE <span class="hljs-string">'[0-9]+ insertion'</span> | awk <span class="hljs-string">'{print $1}'</span>)
lines_deleted=$(git diff --<span class="hljs-built_in">stat</span> | <span class="hljs-built_in">tail</span> -1 | grep -oE <span class="hljs-string">'[0-9]+ deletion'</span> | awk <span class="hljs-string">'{print $1}'</span>)

<span class="hljs-comment"># 显示摘要</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"📝 修改统计:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 修改文件: <span class="hljs-variable">$files_changed</span> 个"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 新增代码: <span class="hljs-variable">$lines_added</span> 行"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 删除代码: <span class="hljs-variable">$lines_deleted</span> 行"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-comment"># 检查是否有测试文件修改</span>
test_files=$(git diff --name-only | grep -E <span class="hljs-string">'\.test\.(ts|tsx|js|jsx)$'</span> | <span class="hljs-built_in">wc</span> -l)

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$test_files</span> -eq 0 ] &amp;&amp; [ <span class="hljs-variable">$files_changed</span> -gt 0 ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️ 建议: 代码已修改但未更新测试文件"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 提供后续建议</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"💡 后续建议:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  1. 运行测试: npm test"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  2. 本地验证功能"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  3. 提交代码: git add . &amp;&amp; git commit"</span>

<span class="hljs-built_in">exit</span> 0
</code></pre>
<p><strong>预期效果</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">Agent完成任务
<span class="hljs-code">    ↓
Hook自动执行
    ↓
显示摘要:
  📊 生成变更摘要...
</span>
  📝 修改统计:
<span class="hljs-code">    • 修改文件: 3 个
    • 新增代码: 127 行
    • 删除代码: 45 行
</span>
  ⚠️ 建议: 代码已修改但未更新测试文件

  💡 后续建议:
<span class="hljs-bullet">    1.</span> 运行测试: npm test
<span class="hljs-bullet">    2.</span> 本地验证功能
<span class="hljs-bullet">    3.</span> 提交代码: git add . &amp;&amp; git commit
</code></pre>
<hr/>
<h3 data-id="heading-26">高级Hooks场景</h3>
<h4 data-id="heading-27">场景1：权限控制 - 阻止危险命令</h4>
<p><strong>需求</strong>: 防止AI执行可能破坏系统的命令</p>
<p><strong>配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

json_input=$(<span class="hljs-built_in">cat</span>)
<span class="hljs-built_in">command</span>=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$json_input</span>"</span> | jq -r <span class="hljs-string">'.command'</span>)

<span class="hljs-comment"># 危险命令黑名单</span>
dangerous_commands=(
  <span class="hljs-string">"rm -rf /"</span>
  <span class="hljs-string">"rm -rf *"</span>
  <span class="hljs-string">"dd if=/dev/zero"</span>
  <span class="hljs-string">"mkfs"</span>
  <span class="hljs-string">"&gt; /dev/sda"</span>
  <span class="hljs-string">"chmod -R 777 /"</span>
)

<span class="hljs-comment"># 检查命令</span>
<span class="hljs-keyword">for</span> danger <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${dangerous_commands[@]}</span>"</span>; <span class="hljs-keyword">do</span>
  <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> == *<span class="hljs-string">"<span class="hljs-variable">$danger</span>"</span>* ]]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"{\"decision\": \"deny\", \"message\": \"🚫 危险命令已阻止: <span class="hljs-variable">$danger</span>\"}"</span>
    <span class="hljs-built_in">exit</span> 0
  <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># 允许执行</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"{\"decision\": \"allow\"}"</span>
<span class="hljs-built_in">exit</span> 0
</code></pre>
<p><strong>配置到hooks.json</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"beforeShellExecution"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.cursor/scripts/check-dangerous-commands.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>预期效果</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">AI尝试执行: <span class="hljs-built_in">rm</span> -rf /tmp/*
    ↓
Hook拦截
    ↓
返回: {<span class="hljs-string">"decision"</span>: <span class="hljs-string">"deny"</span>, <span class="hljs-string">"message"</span>: <span class="hljs-string">"🚫 危险命令已阻止"</span>}
    ↓
命令被阻止，不会执行
</code></pre>
<hr/>
<h4 data-id="heading-28">场景2：自动化测试 - 组件修改后运行测试</h4>
<p><strong>配置</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

json_input=$(<span class="hljs-built_in">cat</span>)
file_path=$(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$json_input</span>"</span> | jq -r <span class="hljs-string">'.file'</span>)

<span class="hljs-comment"># 如果是组件文件，运行对应测试</span>
<span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$file_path</span> == src/components/* ]]; <span class="hljs-keyword">then</span>
  <span class="hljs-comment"># 推导测试文件路径</span>
  test_file=<span class="hljs-string">"<span class="hljs-variable">${file_path%.tsx}</span>.test.tsx"</span>

  <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$test_file</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"🧪 运行相关测试: <span class="hljs-variable">$test_file</span>"</span>
    npm <span class="hljs-built_in">test</span> -- <span class="hljs-string">"<span class="hljs-variable">$test_file</span>"</span> --silent

    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 测试通过"</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 测试失败，请检查修改"</span>
      <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️ 未找到测试文件: <span class="hljs-variable">$test_file</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"💡 建议: 为新组件添加单元测试"</span>
  <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">exit</span> 0
</code></pre>
<p><strong>预期效果</strong>:</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">AI</span>修改了 <span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">components</span>/<span class="hljs-selector-tag">Button</span><span class="hljs-selector-class">.tsx</span>
    ↓
<span class="hljs-selector-tag">Hook</span>检测到组件修改
    ↓
查找: <span class="hljs-selector-tag">src</span>/<span class="hljs-selector-tag">components</span>/<span class="hljs-selector-tag">Button</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.tsx</span>
    ↓
执行: <span class="hljs-selector-tag">npm</span> <span class="hljs-selector-tag">test</span> <span class="hljs-selector-tag">--</span> <span class="hljs-selector-tag">Button</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.tsx</span>
    ↓
显示结果:
  🧪 运行相关测试: <span class="hljs-selector-tag">Button</span><span class="hljs-selector-class">.test</span><span class="hljs-selector-class">.tsx</span>
  ✅ 测试通过
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cd6dde5b3da48139541c28f5535cc09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768225987&amp;x-signature=%2FbEexaD9KOek1aOjLlX9E2xQJTA%3D" alt="cursor04-Hooks工作流程图.png" loading="lazy"/></p>

**重要提示**: Hook脚本必须有执行权限。创建后运行：`chmod +x .cursor/scripts/*.sh`

<hr/>
<h2 data-id="heading-29">完整工作流配置方案</h2>
<h3 data-id="heading-30">项目初始化配置清单</h3>
<p><strong>步骤1: 创建目录结构</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建配置目录</span>
<span class="hljs-built_in">mkdir</span> -p .cursor/docs
<span class="hljs-built_in">mkdir</span> -p .cursor/scripts

<span class="hljs-comment"># 创建配置文件</span>
<span class="hljs-built_in">touch</span> .cursorrules
<span class="hljs-built_in">touch</span> .cursor/hooks.json
</code></pre>
<p><strong>步骤2: 添加Rules配置</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑.cursorrules文件</span>
<span class="hljs-comment"># 填入项目规范（参考前文模板）</span>
</code></pre>
<p><strong>步骤3: 添加文档</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目文档</span>
<span class="hljs-built_in">touch</span> .cursor/docs/architecture.md
<span class="hljs-built_in">touch</span> .cursor/docs/api-conventions.md
<span class="hljs-built_in">touch</span> .cursor/docs/coding-style.md
<span class="hljs-built_in">touch</span> .cursor/docs/component-library.md
</code></pre>
<p><strong>步骤4: 配置Hooks脚本</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建hook脚本</span>
<span class="hljs-built_in">cat</span> &gt; .cursor/scripts/check-prompt.sh &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-comment"># ... (前文的脚本内容)</span>
EOF

<span class="hljs-comment"># 添加执行权限</span>
<span class="hljs-built_in">chmod</span> +x .cursor/scripts/*.sh
</code></pre>
<p><strong>步骤5: 配置hooks.json</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"beforeSubmitPrompt"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.cursor/scripts/check-prompt.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"afterFileEdit"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.cursor/scripts/format-code.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"stop"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.cursor/scripts/review-changes.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤6: 提交到版本控制</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加到Git</span>
git add .cursorrules .cursor/
git commit -m <span class="hljs-string">"feat: 配置Cursor工作流自动化"</span>

<span class="hljs-comment"># 推送到远程</span>
git push origin main
</code></pre>
<p><strong>完整目录结构</strong>:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d87753915b34a0ba4b7d6e6172eb3ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768225987&amp;x-signature=I5yu6ynEBhmJD%2BZzXi4fWienVBg%3D" alt="cursor04-项目目录结构图.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-31">团队协作配置策略</h3>
<p><strong>个人配置 vs 项目配置</strong>:</p>


























<table><thead><tr><th align="left">配置类型</th><th align="left">位置</th><th align="left">作用域</th><th align="center">版本控制</th><th align="left">适用内容</th></tr></thead><tbody><tr><td align="left"><strong>项目配置</strong></td><td align="left"><code>.cursorrules</code><br/><code>.cursor/</code></td><td align="left">整个团队</td><td align="center">✅ 提交到Git</td><td align="left">技术栈、代码规范、<br/>API设计、安全规则</td></tr><tr><td align="left"><strong>个人配置</strong></td><td align="left"><code>~/.cursor/rules</code><br/><code>~/.cursor/hooks.json</code></td><td align="left">仅自己</td><td align="center">❌ 不提交</td><td align="left">注释风格、个人偏好、<br/>快捷方式</td></tr></tbody></table>
<p><strong>最佳实践</strong>:</p>
<p><strong>项目配置（强制，团队共享）</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># .cursorrules</span>

<span class="hljs-section"># 技术栈规范（不可更改）</span>
<span class="hljs-bullet">-</span> 框架: Next.js 14
<span class="hljs-bullet">-</span> 语言: TypeScript
<span class="hljs-bullet">-</span> UI库: Shadcn/UI

<span class="hljs-section"># API设计规范（强制遵守）</span>
<span class="hljs-bullet">-</span> 统一响应格式
<span class="hljs-bullet">-</span> 错误码定义
<span class="hljs-bullet">-</span> 命名约定

<span class="hljs-section"># 安全要求（必须满足）</span>
<span class="hljs-bullet">-</span> 禁止硬编码密钥
<span class="hljs-bullet">-</span> SQL注入防护
<span class="hljs-bullet">-</span> XSS防护
</code></pre>
<p><strong>个人配置（可选，个人偏好）</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># ~/.cursor/rules</span>

<span class="hljs-section"># 个人代码风格</span>
<span class="hljs-bullet">-</span> 注释详细程度: 详细（我喜欢更多注释）
<span class="hljs-bullet">-</span> 变量命名: 描述性强（我喜欢长变量名）
<span class="hljs-bullet">-</span> 代码组织: 按功能分组（我的习惯）
</code></pre>
<p><strong>预期效果</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">新成员加入团队：
  ↓
git <span class="hljs-built_in">clone</span>项目
  ↓
Cursor自动加载.cursorrules和hooks.json
  ↓
AI输出自动符合团队规范
  ↓
无需手动配置，立即上手
</code></pre>

**团队协作建议**: 在项目README中添加Cursor配置说明，帮助新成员快速理解工作流配置。

<hr/>
<h2 data-id="heading-32">效率对比与收益分析</h2>
<h3 data-id="heading-33">数据对比</h3>
<p><strong>配置前 vs 配置后的真实数据</strong>:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1d5c87f82b942208291084039e747a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768225987&amp;x-signature=rtaHFLLKmkH6r5AVgUOFq1vJW4g%3D" alt="cursor04-效率提升对比图.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-34">避坑指南</h2>
<h3 data-id="heading-35">坑1: Rules过长导致AI记不住</h3>
<p><strong>❌ 问题</strong>: <code>.cursorrules</code>文件超过2000字，AI会忽略部分内容</p>
<p><strong>原因</strong>: AI上下文窗口限制，过长的规则会被截断</p>
<p><strong>✅ 解决</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 精简Rules - 只保留核心规范</span>

<span class="hljs-section">## 必须遵守（高优先级）</span>
<span class="hljs-bullet">-</span> 技术栈: Next.js 14 + TypeScript
<span class="hljs-bullet">-</span> 响应格式: {code, message, data}
<span class="hljs-bullet">-</span> 命名: kebab-case文件, PascalCase组件

<span class="hljs-section">## 建议遵守（中优先级）</span>
<span class="hljs-bullet">-</span> 配色: slate系
<span class="hljs-bullet">-</span> 圆角: rounded-xl

<span class="hljs-section">## 详细规范请参考</span>
@Docs 查看.cursor/docs/中的详细文档
</code></pre>
<p><strong>最佳实践</strong>: Rules控制在500-1000字，详细内容放到<code>@Docs</code>文档中。</p>
<hr/>
<h3 data-id="heading-36">坑2: Hook脚本路径错误</h3>
<p><strong>❌ 问题</strong>: 使用绝对路径，团队成员路径不一致</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"afterFileEdit"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/Users/yourname/.cursor/scripts/format.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>✅ 解决</strong>: 使用相对于<code>hooks.json</code>的相对路径</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"afterFileEdit"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span> <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./.cursor/scripts/format-code.sh"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-37">坑3: Context滥用导致响应慢</h3>
<p><strong>❌ 问题</strong>: 每次都用<code>@Codebase</code>全量搜索</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Codebase</span> 这个项目的架构是什么？
<span class="hljs-variable">@Codebase</span> 按钮组件在哪里？
<span class="hljs-variable">@Codebase</span> 权限检查怎么做的？
</code></pre>
<p><strong>结果</strong>: 每次搜索耗时10-30秒，体验差</p>
<p><strong>✅ 解决</strong>: 分层使用Context</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 理解整体架构（偶尔使用）</span>
@Codebase 项目整体架构

<span class="hljs-section"># 精准引用（常用）</span>
@file src/components/Button.tsx
@folder src/components/

<span class="hljs-section"># 查看文档（最快）</span>
@Docs architecture.md
</code></pre>
<p><strong>性能对比</strong>:</p>
<ul>
<li><code>@Docs</code>: ~1秒</li>
<li><code>@file</code>: ~2秒</li>
<li><code>@folder</code>: ~5秒</li>
<li><code>@Codebase</code>: ~15秒</li>
</ul>
<hr/>
<h3 data-id="heading-38">坑4: Hook过于严格导致无法工作</h3>
<p><strong>❌ 问题</strong>: 所有warning都当成error，阻止提交</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 过于严格的Hook</span>
<span class="hljs-keyword">if</span> eslint <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> | grep -q <span class="hljs-string">"warning"</span>; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"发现warning，禁止提交"</span>
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
<p><strong>结果</strong>: 轻微的warning也无法提交，影响开发效率</p>
<p><strong>✅ 解决</strong>: 严重问题<code>deny</code>，一般问题<code>ask</code></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 灵活的Hook策略</span>

<span class="hljs-comment"># 检查错误（严重问题）</span>
errors=$(eslint <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> --format json | jq <span class="hljs-string">'.[] | select(.errorCount &gt; 0)'</span>)
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$errors</span>"</span> ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"发现错误，必须修复"</span>
  <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 检查警告（一般问题）</span>
warnings=$(eslint <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> --format json | jq <span class="hljs-string">'.[] | select(.warningCount &gt; 0)'</span>)
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$warnings</span>"</span> ]; <span class="hljs-keyword">then</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠️ 发现warning，建议修复"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"是否继续？(y/n)"</span>
  <span class="hljs-comment"># 让用户决策</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<hr/>
<h3 data-id="heading-39">坑5: 团队配置冲突</h3>
<p><strong>❌ 问题</strong>: 多人各自修改<code>.cursorrules</code>，产生冲突</p>
<p><strong>场景</strong>:</p>
<ul>
<li>开发A: 喜欢详细注释，修改Rules要求"每个函数必须有注释"</li>
<li>开发B: 喜欢简洁代码，修改Rules要求"只在复杂逻辑添加注释"</li>
<li>结果: Git冲突，团队争吵</li>
</ul>
<p><strong>✅ 解决</strong>: 明确配置边界</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目.cursorrules（团队强制）</span>
<span class="hljs-bullet">-</span> 技术栈选择
<span class="hljs-bullet">-</span> API设计规范
<span class="hljs-bullet">-</span> 安全规则
<span class="hljs-bullet">-</span> 代码风格（核心部分）

<span class="hljs-section"># 个人~/.cursor/rules（个人偏好）</span>
<span class="hljs-bullet">-</span> 注释详细程度
<span class="hljs-bullet">-</span> 变量命名长度偏好
<span class="hljs-bullet">-</span> 代码组织习惯
</code></pre>
<p><strong>流程规范</strong>:</p>
<ol>
<li>项目Rules修改需要团队Review</li>
<li>个人Rules不提交到Git</li>
<li>冲突时项目配置优先级更高</li>
</ol>
<hr/>
<h2 data-id="heading-40">总结与下一步</h2>
<h3 data-id="heading-41">关键收获</h3>
<p>通过本文的学习，你现在掌握了Cursor工作流自动化的完整方案：</p>
<p><strong>三大支柱</strong>:</p>
<ol>
<li>✅ <strong>Rules</strong> = AI的行为手册（规范输出风格）</li>
<li>✅ <strong>Context</strong> = AI的项目记忆（理解业务上下文）</li>
<li>✅ <strong>Hooks</strong> = AI的自动触发器（质量自动守护）</li>
</ol>
<p><strong>核心价值</strong>:</p>
<ul>
<li>📈 <strong>效率提升</strong>: 单次任务效率提升6倍以上</li>
<li>🎯 <strong>质量保障</strong>: CI失败率降低4倍</li>
<li>🤝 <strong>团队协作</strong>: 新人上手时间从2天缩短到2小时</li>
<li>💰 <strong>成本收益</strong>: 5人团队每月相当于多3.5个全职开发者产出</li>
</ul>
<p><strong>从"手动驾驶"到"自动驾驶"</strong>:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">配置前: 每次重复说明规范 → 手动修改代码 → 手动检查格式</span>
    ↓
<span class="hljs-section">配置后: AI自动遵守规范 → 输出直接可用 → Hook自动检查</span>
</code></pre>
<hr/>
<h3 data-id="heading-42">立即实践</h3>
<p>跟着下面的清单，20分钟内完成工作流配置：</p>
<p><strong>配置清单</strong>:</p>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 创建<code>.cursorrules</code>文件，定义项目规范</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 配置<code>.cursor/docs/</code>目录，添加架构和API文档</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 创建<code>.cursor/hooks.json</code>，设置自动化检查</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 编写hook脚本（check-prompt、format-code、review-changes）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 添加执行权限：<code>chmod +x .cursor/scripts/*.sh</code></li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 提交到Git，让团队成员自动同步</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 尝试用简单Prompt测试效果</li>
</ul>
<p><strong>测试验证</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试Rules</span>
<span class="hljs-string">"创建一个用户列表页面"</span>
<span class="hljs-comment"># 观察AI是否自动遵守你定义的规范</span>

<span class="hljs-comment"># 测试Context</span>
<span class="hljs-string">"@Docs 查看API规范，创建新接口"</span>
<span class="hljs-comment"># 观察AI是否参考了文档内容</span>

<span class="hljs-comment"># 测试Hooks</span>
<span class="hljs-comment"># 修改代码后观察是否自动格式化</span>
<span class="hljs-comment"># 提交prompt时观察是否检查敏感信息</span>
</code></pre>
<hr/>
<h3 data-id="heading-43">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7589093939656687668" target="_blank" title="https://juejin.cn/post/7589093939656687668">【Cursor进阶实战·01】Figma设计稿一键还原</a></li>
<li><a href="https://juejin.cn/post/7589475497001287695" target="_blank" title="https://juejin.cn/post/7589475497001287695">【Cursor进阶实战·02】告别丑陋界面</a></li>
<li><a href="https://juejin.cn/post/7589918470789169186" target="_blank" title="https://juejin.cn/post/7589918470789169186">【Cursor进阶实战·03】四大模式完全指南：Agent/Plan/Debug/Ask的正确打开方式</a></li>
</ul>
<hr/>
<p><em>感谢阅读！如果这篇文章对你有帮助，欢迎点赞、收藏、分享。我们下期见！👋</em></p>
<p><em>有问题欢迎在评论区讨论，我会尽量回复每一条评论。</em></p>
<h3 data-id="heading-44">🎉 感谢关注,让我们一起享受技术带来的精彩!</h3>
<h3 data-id="heading-45"><strong>我做了一个个人主页，能找到所有我提供给你的资源</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a></h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[硬核干货：如何在运行的 PuTTY 中提取明文密码？从命令行到内存取证]]></title>    <link>https://juejin.cn/post/7591702898080284687</link>    <guid>https://juejin.cn/post/7591702898080284687</guid>    <pubDate>2026-01-05T13:02:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591702898080284687" data-draft-id="7591515844867325986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="硬核干货：如何在运行的 PuTTY 中提取明文密码？从命令行到内存取证"/> <meta itemprop="keywords" content="Linux,黑客"/> <meta itemprop="datePublished" content="2026-01-05T13:02:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一次就好602"/> <meta itemprop="url" content="https://juejin.cn/user/895432137124090"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            硬核干货：如何在运行的 PuTTY 中提取明文密码？从命令行到内存取证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/895432137124090/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一次就好602
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T13:02:10.000Z" title="Mon Jan 05 2026 13:02:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">硬核干货：如何在运行的 PuTTY 中提取明文密码？从命令行到内存取证</h2>
<p><strong>背景：</strong><br/>
很多时候，我们手头有一个正在运行的 PuTTY 窗口。<br/>
这种情况在<strong>高性能计算（HPC）</strong> 、<strong>自动化运维</strong>或者<strong>使用第三方集成工具</strong>时非常常见——软件自动弹出了一个终端窗口连上了服务器，但密码是封装在软件里的，我们根本不知道。</p>
<p>如果此时你需要用同样的账号登录 FTP 传文件，或者单纯出于技术好奇心想知道：“这软件到底用的什么密码？” 怎么办？</p>
<p>别急着重置密码。只要窗口还在运行，密码就在你的内存里。</p>
<p>今天分享两种方法：一种是<strong>极速查看的“巧劲”</strong> ，另一种是<strong>通用性极强的“内存取证”</strong> 。</p>
<hr/>
<h3 data-id="heading-1">方法一：巧用启动参数（极速解法）</h3>
<p>很多集成软件（如超算客户端、数据库工具）为了方便，在后台调用 PuTTY 时，会直接把密码通过命令行参数（<code>-pw</code>）传进去。</p>
<p>这是最容易被忽视的“灯下黑”。我们可以直接问操作系统： <strong>“这个进程是用什么命令启动的？”</strong></p>
<h4 data-id="heading-2">1. 命令行流（最快）</h4>
<p>打开 CMD 或 PowerShell，输入一行命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">wmic process where <span class="hljs-string">"name='putty.exe'"</span> get commandline
</code></pre>
<p><strong>效果：</strong><br/>
如果运气好，你会直接看到类似这样的输出：</p>
<pre><code class="hljs language-sql" lang="sql">CommandLine
"C:\HPC_Tools\bin\putty.exe" <span class="hljs-operator">-</span>ssh <span class="hljs-keyword">user</span><span class="hljs-variable">@10</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-operator">-</span>pw MySecretPassword123
</code></pre>
<p>那个 <code>-pw</code> 后面的字符串，就是你要的明文密码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1d26fe2562c452c91467b8ad13247c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5qyh5bCx5aW9NjAy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768222930&amp;x-signature=3yk2HizQWOF7XkRzHoZlHDA6BgM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. 图形界面流（直观）</h4>
<p>不喜欢敲命令？Windows 任务管理器也能看。</p>
<ol>
<li>1. <code>Ctrl + Shift + Esc</code> 打开任务管理器。</li>
<li>
<ol start="2">
<li>切换到  <strong>“详细信息” (Details)</strong>  页签。</li>
</ol>
</li>
<li>
<ol start="3">
<li>对着列标题右键 -&gt;  <strong>“选择列”</strong>  -&gt; 勾选  <strong>“命令行”</strong> 。</li>
</ol>
</li>
<li>
<ol start="4">
<li>找到 <code>putty.exe</code>，向右看，密码一览无余。</li>
</ol>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">方法二：内存转储取证（终极大招）</h3>
<p>如果方法一不管用怎么办？<br/>
比如你是<strong>手动双击</strong>打开的 PuTTY，然后在黑框框里手敲的密码；或者软件使用了 Session 加载模式，没有在启动参数里写密码。</p>
<p>这时候，启动参数里是空的。但别慌，<strong>凡走过必留痕</strong>。只要你输入过密码，或者 PuTTY 发送过密码，这串字符就一定存在于内存的某个角落。</p>
<p>我们需要动用一点“取证学”手段：<strong>Memory Dump（内存转储）</strong> 。</p>
<h4 data-id="heading-5">第一步：把内存“倒”出来</h4>
<ol>
<li>
<ol>
<li>打开任务管理器，找到 <code>putty.exe</code>。</li>
</ol>
</li>
<li>
<ol start="2">
<li>右键点击它，选择  <strong>“创建转储文件” (Create Dump File)</strong> 。</li>
</ol>
</li>
<li>
<ol start="3">
<li>系统会把当前这个进程的所有内存数据保存为一个 <code>.DMP</code> 文件（通常在 <code>C:\Users\用户名\AppData\Local\Temp</code> 目录下）。</li>
</ol>
</li>
</ol>
<h4 data-id="heading-6">第二步：从乱码中提取真相</h4>
<p>内存文件是二进制的，直接用记事本打开是乱码。我们需要提取其中的<strong>可读字符串</strong>。</p>
<p><strong>工具准备：</strong><br/>
推荐使用微软 Sysinternals 工具包中的 <code>strings.exe</code>，或者任何支持二进制搜索的编辑器（如 WinHex, Notepad++）。</p>
<p><strong>操作演示：</strong><br/>
在命令行中运行：</p>
<pre><code class="hljs language-css" lang="css">strings<span class="hljs-selector-class">.exe</span> putty<span class="hljs-selector-class">.DMP</span> &gt; <span class="hljs-attribute">content</span><span class="hljs-selector-class">.txt</span>
</code></pre>
<p>这行命令的意思是：把内存里所有的“人话”（可读文本）提取出来，存到 <code>content.txt</code> 里。</p>
<h4 data-id="heading-7">第三步：搜索关键线索</h4>
<p>打开这个文本文件，虽然内容庞杂，但我们要找的东西往往有迹可循。使用查找功能（Ctrl+F）：</p>
<ul>
<li>• <strong>搜索环境特征：</strong>  如果你记得登录后输入的第一条命令（比如 <code>ls</code> 或 <code>top</code>），搜索这个词。密码往往就在这行命令的<strong>输入缓冲区附近</strong>。</li>
<li>• <strong>搜索特定标记：</strong>  搜索 <code>password</code>、<code>pass</code> 或你的用户名。</li>
<li>• <strong>搜索启动参数：</strong>  即使 <code>wmic</code> 没显示，内存里有时候也会残留启动时的完整指令，搜索 <code>-pw</code> 依然是一个有效手段。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c2ba78547cf4d80bea9d4f2f4bedf25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5qyh5bCx5aW9NjAy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768222930&amp;x-signature=2%2B%2Bao8XYUfHPzX9saDfSURou15Q%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-8">💡 技术总结</h3>
<p>这两种方法展示了两种解决问题的维度：</p>
<ol>
<li>1. <strong>Command Line 查看</strong>：利用的是<strong>进程元数据</strong>。它快、准、狠，适用于自动化工具调用的场景。</li>
<li>2. <strong>Memory Dump 分析</strong>：利用的是<strong>数据残留</strong>。它是通用的取证手段，不仅能找 PuTTY 密码，理论上任何未对内存进行安全擦除的软件，其敏感数据都能通过这种方式提取。</li>
</ol>
<p><strong>运维与科研的乐趣，往往就在于这种“透过现象看本质”的探索之中。</strong></p>
<p>建议大家收藏备用，说不定哪天这个小技巧能救你于水火。</p>
<p>看得开心的老铁希望点个关注呀，这对我很重要，是我持续创作的动力来源！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在栈/堆上创建并初始化C++对象]]></title>    <link>https://juejin.cn/post/7591705084671148070</link>    <guid>https://juejin.cn/post/7591705084671148070</guid>    <pubDate>2026-01-05T13:21:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591705084671148070" data-draft-id="7591708519448723465" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在栈/堆上创建并初始化C++对象"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2026-01-05T13:21:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Grimmjow"/> <meta itemprop="url" content="https://juejin.cn/user/4188472097127035"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在栈/堆上创建并初始化C++对象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4188472097127035/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Grimmjow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T13:21:53.000Z" title="Mon Jan 05 2026 13:21:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entity</span> {</span>
private:
	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> name;
public:
	Entity():name(<span class="hljs-string">"unknown"</span>) {
		<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">" Creat susscifully!"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
	}
	Entity(<span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>&amp; name):name(name){
		<span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">" Creat susscifully!"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
	}
	~Entity() { <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Clear "</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">" object!"</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>; }
	<span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title function_">getname</span><span class="hljs-params">()</span> {
		<span class="hljs-keyword">return</span> name;
	}
};
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    {
        Entity <span class="hljs-title function_">Teru</span><span class="hljs-params">(<span class="hljs-string">"Miyanaga Teru"</span>)</span>;
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; Teru.getname() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
        <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; (&amp;Teru)-&gt;getname() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    }<span class="hljs-comment">//这里栈上的Teru的作用域结束，编译器自动释放内存</span>
    
    Entity* Ichigo = new Entity(<span class="hljs-string">"Kurosaki Ichigo"</span>);
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; Ichigo-&gt;getname() &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
    delete Ichigo;
    
    Entity* Gotei13 = new Entity[<span class="hljs-number">13</span>]{ {} ,{<span class="hljs-string">"suifeng"</span>},{<span class="hljs-string">"gin"</span>}};
    delete[] Gotei13;
}
</code></pre>
<p>对于一个类Entity，我们可以在栈上创建该类的对象，</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">Entity <span class="hljs-title">Teru</span><span class="hljs-params">(<span class="hljs-string">"Miyanaga Teru"</span>)</span></span>;
</code></pre>
<p><code>Teru</code>即为对象的名称，<code>&amp;Teru</code>访问地址。
在栈上创建的变量由编译器自动管理，使用结束后会自动执行析构函数<code>~Entity</code>释放内存。</p>
<p>在堆上创建对象，需要使用<code>new</code>关键字来申请内存。</p>
<pre><code class="hljs language-ini" lang="ini">Entity* <span class="hljs-attr">Ichigo</span> = new Entity(<span class="hljs-string">"Kurosaki Ichigo"</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>这里<code>new Entity("Kurosaki Ichigo")</code>实际上就是申请的内存的地址。在堆上创建对象我们得到的都是对象的地址，所以用的是指针形式<code>Entity* Ichigo</code>。从地址直接访问该对象中的元素可以使用箭头<code>Ichigo-&gt;getname()</code>，或者利用一般的方式<code>(*Ichigo).getname()</code>。</p>
<p>我们在利用<code>new</code>关键字申请内存后，在使用完毕后需要用<code>delete</code>关键字释放内存，此时也同时执行析构函数<code>~Entity</code>。</p>
<p>对于元素组的形式，我们的<code>delete</code>也要做对应改变，比如：</p>
<pre><code class="hljs language-ini" lang="ini">Entity* <span class="hljs-attr">Gotei13</span> = new Entity[<span class="hljs-number">13</span>]{ {} ,{<span class="hljs-string">"suifeng"</span>},{<span class="hljs-string">"gin"</span>}}<span class="hljs-comment">;</span>
delete<span class="hljs-section">[]</span> Gotei13<span class="hljs-comment">;</span>
        
int* <span class="hljs-attr">a</span> = new int[<span class="hljs-number">10</span>]<span class="hljs-comment">;</span>
for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 10; i++) {</span>
	a<span class="hljs-section">[i]</span> = i<span class="hljs-comment">;</span>
	printf("a<span class="hljs-section">[%d]</span>: %d\n", i, a<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
}
delete<span class="hljs-section">[]</span> a<span class="hljs-comment">;</span>
</code></pre>
<p>栈/堆的优劣势</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46492c2f74fd45ed8c8e7801b7a739f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR3JpbW1qb3c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768224113&amp;x-signature=sHV2L3blDfk6rrULvyptaosnahU%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python自动化实战：ElementTree库快速入门指南]]></title>    <link>https://juejin.cn/post/7591497387246338084</link>    <guid>https://juejin.cn/post/7591497387246338084</guid>    <pubDate>2026-01-05T11:59:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591497387246338084" data-draft-id="7591694511245443110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python自动化实战：ElementTree库快速入门指南"/> <meta itemprop="keywords" content="面试,后端"/> <meta itemprop="datePublished" content="2026-01-05T11:59:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UrbanJazzerati"/> <meta itemprop="url" content="https://juejin.cn/user/550205947391389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python自动化实战：ElementTree库快速入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/550205947391389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UrbanJazzerati
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-05T11:59:50.000Z" title="Mon Jan 05 2026 11:59:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、ElementTree 库简介</h2>
<p><code>xml.etree.ElementTree</code> 是 Python 处理 XML 的标准库，它：</p>
<ul>
<li>✅ <strong>轻量高效</strong>：比 DOM 解析器更简单，比 SAX 解析器更易用</li>
<li>✅ <strong>内置模块</strong>：无需安装任何第三方包</li>
<li>✅ <strong>Pythonic API</strong>：使用方式符合 Python 习惯</li>
</ul>
<h2 data-id="heading-1">二、核心操作快速上手</h2>
<h3 data-id="heading-2">1. <strong>解析 XML：读取与理解</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> xml.etree.ElementTree <span class="hljs-keyword">as</span> ET

<span class="hljs-comment"># 从字符串解析</span>
xml_string = <span class="hljs-string">'''
&lt;bookstore&gt;
    &lt;book category="编程"&gt;
        &lt;title&gt;Python编程从入门到实践&lt;/title&gt;
        &lt;author&gt;Eric Matthes&lt;/author&gt;
        &lt;year&gt;2016&lt;/year&gt;
        &lt;price&gt;89.00&lt;/price&gt;
    &lt;/book&gt;
&lt;/bookstore&gt;
'''</span>
root = ET.fromstring(xml_string)  <span class="hljs-comment"># 获取根元素</span>

<span class="hljs-comment"># 从文件解析</span>
tree = ET.parse(<span class="hljs-string">'books.xml'</span>)      <span class="hljs-comment"># 解析文件</span>
root = tree.getroot()             <span class="hljs-comment"># 获取根元素</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"根元素标签: <span class="hljs-subst">{root.tag}</span>"</span>)   <span class="hljs-comment"># 输出: bookstore</span>
</code></pre>
<h3 data-id="heading-3">2. <strong>遍历与访问元素</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 遍历所有子元素</span>
<span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> root:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"子元素: <span class="hljs-subst">{child.tag}</span>, 属性: <span class="hljs-subst">{child.attrib}</span>"</span>)
    <span class="hljs-comment"># 访问孙子元素</span>
    <span class="hljs-keyword">for</span> subchild <span class="hljs-keyword">in</span> child:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{subchild.tag}</span>: <span class="hljs-subst">{subchild.text}</span>"</span>)

<span class="hljs-comment"># 访问特定元素的文本</span>
title = root.find(<span class="hljs-string">'book/title'</span>)  <span class="hljs-comment"># 查找第一个匹配的元素</span>
<span class="hljs-keyword">if</span> title <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"书名: <span class="hljs-subst">{title.text}</span>"</span>)

<span class="hljs-comment"># 查找所有符合条件的元素</span>
all_books = root.findall(<span class="hljs-string">'book'</span>)  <span class="hljs-comment"># 查找所有book元素</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(all_books)}</span> 本书"</span>)
</code></pre>
<h3 data-id="heading-4">3. <strong>创建 XML 文档</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建根元素</span>
root = ET.Element(<span class="hljs-string">"bookstore"</span>)

<span class="hljs-comment"># 创建子元素并添加属性</span>
book = ET.SubElement(root, <span class="hljs-string">"book"</span>)
book.<span class="hljs-built_in">set</span>(<span class="hljs-string">"category"</span>, <span class="hljs-string">"编程"</span>)

<span class="hljs-comment"># 添加更多子元素</span>
title = ET.SubElement(book, <span class="hljs-string">"title"</span>)
title.text = <span class="hljs-string">"Python核心编程"</span>
author = ET.SubElement(book, <span class="hljs-string">"author"</span>)
author.text = <span class="hljs-string">"Wesley Chun"</span>

<span class="hljs-comment"># 创建XML树并写入文件</span>
tree = ET.ElementTree(root)
tree.write(<span class="hljs-string">"new_book.xml"</span>, encoding=<span class="hljs-string">"utf-8"</span>, xml_declaration=<span class="hljs-literal">True</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"XML文件创建成功！"</span>)
</code></pre>
<h3 data-id="heading-5">4. <strong>修改 XML 内容</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 修改元素文本</span>
<span class="hljs-keyword">for</span> price <span class="hljs-keyword">in</span> root.<span class="hljs-built_in">iter</span>(<span class="hljs-string">'price'</span>):  <span class="hljs-comment"># iter()遍历所有price元素</span>
    old_price = <span class="hljs-built_in">float</span>(price.text)
    price.text = <span class="hljs-built_in">str</span>(old_price * <span class="hljs-number">0.9</span>)  <span class="hljs-comment"># 打9折</span>
    price.<span class="hljs-built_in">set</span>(<span class="hljs-string">'discount'</span>, <span class="hljs-string">'10%'</span>)       <span class="hljs-comment"># 添加新属性</span>

<span class="hljs-comment"># 删除元素</span>
<span class="hljs-keyword">for</span> book <span class="hljs-keyword">in</span> root.findall(<span class="hljs-string">'book'</span>):
    year = book.find(<span class="hljs-string">'year'</span>)
    <span class="hljs-keyword">if</span> year <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">int</span>(year.text) &lt; <span class="hljs-number">2010</span>:
        root.remove(book)  <span class="hljs-comment"># 删除2010年以前的书</span>

<span class="hljs-comment"># 保存修改</span>
tree.write(<span class="hljs-string">'updated_books.xml'</span>)
</code></pre>
<h3 data-id="heading-6">5. <strong>查找元素的多种方式</strong></h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 使用XPath-like语法（有限支持）</span>
expensive_books = root.findall(<span class="hljs-string">"book[price&gt;50]"</span>)  <span class="hljs-comment"># 价格&gt;50的书</span>

<span class="hljs-comment"># 2. 遍历所有特定标签</span>
<span class="hljs-keyword">for</span> author <span class="hljs-keyword">in</span> root.<span class="hljs-built_in">iter</span>(<span class="hljs-string">'author'</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"作者: <span class="hljs-subst">{author.text}</span>"</span>)

<span class="hljs-comment"># 3. 复杂条件查找</span>
<span class="hljs-keyword">for</span> book <span class="hljs-keyword">in</span> root.findall(<span class="hljs-string">'book'</span>):
    price = <span class="hljs-built_in">float</span>(book.find(<span class="hljs-string">'price'</span>).text)
    category = book.get(<span class="hljs-string">'category'</span>)
    <span class="hljs-keyword">if</span> price &gt; <span class="hljs-number">80</span> <span class="hljs-keyword">and</span> category == <span class="hljs-string">'编程'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"昂贵的编程书: <span class="hljs-subst">{book.find(<span class="hljs-string">'title'</span>).text}</span>"</span>)
</code></pre>
<h2 data-id="heading-7">三、实用技巧与注意事项</h2>
<h3 data-id="heading-8">处理命名空间</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 带命名空间的XML</span>
ns_xml = <span class="hljs-string">'''
&lt;root xmlns:bk="http://example.com/books"&gt;
    &lt;bk:book&gt;
        &lt;bk:title&gt;Python学习手册&lt;/bk:title&gt;
    &lt;/bk:book&gt;
&lt;/root&gt;
'''</span>

<span class="hljs-comment"># 注册命名空间前缀（方便查找）</span>
namespaces = {<span class="hljs-string">'bk'</span>: <span class="hljs-string">'http://example.com/books'</span>}
root = ET.fromstring(ns_xml)
title = root.find(<span class="hljs-string">'bk:book/bk:title'</span>, namespaces)
</code></pre>
<h3 data-id="heading-9">处理大型 XML 文件</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用迭代解析，节省内存</span>
<span class="hljs-keyword">for</span> event, elem <span class="hljs-keyword">in</span> ET.iterparse(<span class="hljs-string">'large_file.xml'</span>, events=(<span class="hljs-string">'start'</span>, <span class="hljs-string">'end'</span>)):
    <span class="hljs-keyword">if</span> event == <span class="hljs-string">'start'</span> <span class="hljs-keyword">and</span> elem.tag == <span class="hljs-string">'book'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始处理书: <span class="hljs-subst">{elem.find(<span class="hljs-string">'title'</span>).text}</span>"</span>)
    <span class="hljs-keyword">elif</span> event == <span class="hljs-string">'end'</span> <span class="hljs-keyword">and</span> elem.tag == <span class="hljs-string">'book'</span>:
        <span class="hljs-comment"># 处理完成后清除元素，释放内存</span>
        elem.clear()

<span class="hljs-comment"># 只解析特定元素</span>
context = ET.iterparse(<span class="hljs-string">'large_file.xml'</span>, events=(<span class="hljs-string">'end'</span>,))
<span class="hljs-keyword">for</span> event, elem <span class="hljs-keyword">in</span> context:
    <span class="hljs-keyword">if</span> elem.tag == <span class="hljs-string">'book'</span> <span class="hljs-keyword">and</span> event == <span class="hljs-string">'end'</span>:
        <span class="hljs-comment"># 只处理book元素</span>
        process_book(elem)
        elem.clear()
</code></pre>
<h2 data-id="heading-10">四、常见错误与解决方法</h2>






























<table><thead><tr><th>错误情况</th><th>原因</th><th>解决方法</th></tr></thead><tbody><tr><td><code>SyntaxError</code></td><td>XML格式不正确</td><td>检查XML是否完整，标签是否闭合</td></tr><tr><td><code>AttributeError</code></td><td>元素不存在就访问属性</td><td>先用<code>if elem is not None:</code>判断</td></tr><tr><td>中文乱码</td><td>编码问题</td><td>确保读写时指定<code>encoding='utf-8'</code></td></tr><tr><td>找不到元素</td><td>命名空间问题</td><td>注册并使用命名空间前缀</td></tr></tbody></table>
<h2 data-id="heading-11">五、快速参考表</h2>























































<table><thead><tr><th>任务</th><th>方法</th><th>示例</th></tr></thead><tbody><tr><td><strong>解析XML</strong></td><td><code>ET.parse()</code></td><td><code>tree = ET.parse('file.xml')</code></td></tr><tr><td><strong>获取根</strong></td><td><code>.getroot()</code></td><td><code>root = tree.getroot()</code></td></tr><tr><td><strong>查找单个</strong></td><td><code>.find()</code></td><td><code>elem = root.find('path')</code></td></tr><tr><td><strong>查找所有</strong></td><td><code>.findall()</code></td><td><code>elems = root.findall('path')</code></td></tr><tr><td><strong>遍历所有</strong></td><td><code>.iter()</code></td><td><code>for el in root.iter('tag'):</code></td></tr><tr><td><strong>获取文本</strong></td><td><code>.text</code></td><td><code>text = elem.text</code></td></tr><tr><td><strong>获取属性</strong></td><td><code>.attrib</code></td><td><code>attr = elem.attrib</code></td></tr><tr><td><strong>设置属性</strong></td><td><code>.set()</code></td><td><code>elem.set('key', 'value')</code></td></tr><tr><td><strong>创建元素</strong></td><td><code>ET.SubElement()</code></td><td><code>child = ET.SubElement(parent, 'tag')</code></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 WinForm.NET 再次伟大！一个专门设计用于帮助 WinForms 应用程序迁移到 Blazor WASM 平台的项目]]></title>    <link>https://juejin.cn/post/7591672090790838291</link>    <guid>https://juejin.cn/post/7591672090790838291</guid>    <pubDate>2026-01-06T00:02:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591672090790838291" data-draft-id="7591697558377201706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 WinForm.NET 再次伟大！一个专门设计用于帮助 WinForms 应用程序迁移到 Blazor WASM 平台的项目"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2026-01-06T00:02:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 WinForm.NET 再次伟大！一个专门设计用于帮助 WinForms 应用程序迁移到 Blazor WASM 平台的项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:02:57.000Z" title="Tue Jan 06 2026 00:02:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>随着企业对网页端访问、界面现代化、跨平台支持、云集成和安全合规等能力的需求日益迫切，传统 .NET WinForms 应用的现代化转型已势在必行。<code>Blazor WebAssembly（WASM）</code> 凭借其可复用 C# 代码与基于浏览器的跨平台特性，成为迁移路径中的热门选择。然而大量 WinForms 应用程序使用了<code>System.Drawing</code> 模块调用<code>GDI+</code>进行复杂的自定义绘图和交互，使得常规迁移方案难以奏效，从而导致众多企业面临着高昂的重写成本和风险。</p>
<p>今天大姚给大家分享一个专门设计用于帮助 WinForms 应用程序迁移到 Blazor WASM 平台的项目：<strong>MWGA（Make WinForms Great Again）</strong> 。</p>
<h2 data-id="heading-1">MWGA 项目介绍</h2>
<p><strong>MWGA（Make WinForms Great Again）</strong> 是一个专门设计用于帮助 WinForms 应用程序迁移到 Blazor WASM 平台的项目，即使这些 WinForms 应用程序使用 GDI+ 功能，<strong>MWGA</strong> 项目也预期将对这些程序源码的修改量不超过10%。这极大的降低 WinForms 软件现代化的成本和风险。<strong>注意该项目是一个巨大的工程目前还在逐步规划、完善中，当前已开源演示项目，主要用于给大家演示迁移流程与验证兼容性</strong>（大家有更好的想法或解决方案欢迎前往开源地址提<strong>Issues</strong>）。</p>
<ul>
<li><strong>开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdcsoft-yyf%2FMWGA" target="_blank" title="https://github.com/dcsoft-yyf/MWGA" ref="nofollow noopener noreferrer">github.com/dcsoft-yyf/…</a></strong></li>
</ul>
<h2 data-id="heading-2">WinForms 介绍</h2>
<p>Windows Forms（简称 WinForms）是一个用于构建 Windows 桌面应用程序的用户界面框架。它是对 Windows 原生用户界面库（如 User32 和 GDI+）的 .NET 封装，并提供了 WinForms 特有的控件及其他功能。</p>
<h2 data-id="heading-3">应用场景</h2>
<ul>
<li><strong>传统 WinForms 应用现代化</strong>：全球范围内存在大量基于 WinForms 开发的传统桌面应用，这些应用面临界面老化、跨平台支持差等问题，急需现代化改造。</li>
<li><strong>网页端访问需求</strong>：随着 Web 应用的普及，用户期望能够通过浏览器访问原本仅限于桌面端的应用，提升使用的便捷性和灵活性。</li>
<li><strong>云集成与安全合规</strong>：企业需要将应用迁移至云端，以满足数据安全、合规性要求，并实现更好的资源管理和扩展性。</li>
<li><strong>跨平台访问需求</strong>：原本仅支持 Windows 的应用需在 macOS、Linux 或移动设备浏览器中运行。</li>
<li><strong>降低重写成本与技术风险：</strong> 避免从零开发新 Web 前端带来的高成本、长周期和功能遗漏风险。</li>
</ul>
<h2 data-id="heading-4">演示项目源代码</h2>
<ul>
<li>运行环境：.NET 9.0</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2705aad52313470087728b3a6ad7ec6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768262577&amp;x-signature=5aVqP1tVgtTcZ7y3cGDrOhqzMbU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d70a828ac24ba8a4a462feb12876ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768262577&amp;x-signature=4vsFC3YtUs48gQdPWJIFblltOJA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">演示项目效果展示</h2>
<ul>
<li><strong>演示项目在线访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdcsoft-yyf.github.io%2FMWGA%2FWinFormCalculator.html" target="_blank" title="https://dcsoft-yyf.github.io/MWGA/WinFormCalculator.html" ref="nofollow noopener noreferrer">dcsoft-yyf.github.io/MWGA/WinFor…</a></strong></li>
</ul>
<h3 data-id="heading-6">WinForm 计算器项目演示：</h3>
<p>下面是还未迁移到 Blazor WASM 平台的 WinForm 计算器项目演示效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d43049710c80487fad9e126fdb35088e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768262577&amp;x-signature=2Rr26OD0REx1c%2BE0iAWb4WFLZng%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e97a39f8c8534c38a1b94548101523cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768262577&amp;x-signature=NfL33i79tlxBvp%2FSNw543YbnQCw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">迁移到 Blazor WASM 平台演示：</h3>
<p>下面是已经通过 <strong>MWGA</strong> 项目迁移到 Blazor WASM 平台的 WinForm 计算器项目演示效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b639b063007c41ffab2d44497a1488e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768262577&amp;x-signature=KzNXnIPU0%2FVALYtEg3sZwLGSeNM%3D" alt="" loading="lazy"/></p>
<p><strong>Windows 浏览器和运行效果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3ebbf8c0f3148d3aeb593d63157a184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768262577&amp;x-signature=LazBFm74e1Q5xqc%2BxH7AUWPItC4%3D" alt="" loading="lazy"/></p>
<p><strong>安卓手机浏览器运行效果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bedc5f1b27514b4cbaa6baf552bbde53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768262577&amp;x-signature=khx1W6sBJrwSFZDmZkAbMIiQAbo%3D" alt="" loading="lazy"/></p>
<p><strong>结论：</strong></p>
<p>我实测后确认，同一套<code>Form.cs</code>和<code>Form.Designer.cs</code>代码，在 WinForms 环境下和 Blazor WASM 环境下，程序具有相同的用户界面和相同的运行逻辑。<code>button.Click</code>事件和<code>form.Resize</code>事件处理也符合预期。初步展示了将 WinForms 代码无修改的移植到 Blazor WASM 中的能力。这是<code>MWGA</code>的第一滴血，虽然还有很多不足，但还是为快速低成本的迁移 Winforms 程序带来明确的曙光。</p>
<h2 data-id="heading-8">演示项目核心代码</h2>
<p><strong>Program.cs：</strong> <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7140f5b61bf4394aacf6e98d681bf64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768262577&amp;x-signature=Y29LDBQprQ3ZDJ%2F7DTuO4zKcWnM%3D" alt="" loading="lazy"/></p>
<p><strong>DCWasmWinFormEngine.cs：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">DCSoft.WinForm2WASM</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DCWasmWinFormEngine</span>
    {
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 封装 Invoke 调用，强制使用「标识符 + params object[]」重载</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">InvokeJSFunction</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">string</span> identifier, <span class="hljs-keyword">params</span> <span class="hljs-built_in">object</span>?[]? args</span>)</span>
        {
            <span class="hljs-comment">// 直接调用 params 重载（因为 args 是显式的 object[]）</span>
            <span class="hljs-keyword">return</span> _jsRuntime.Invoke&lt;T&gt;(identifier, args);
        }
        [<span class="hljs-meta">JSInvokable</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InstallFontNames</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] fontNames</span>)</span>
        {
            WinForm2WASMPublish.SetFamilies(fontNames);
        }
        [<span class="hljs-meta">JSInvokable</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddStandardControlTypeName</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> typeName</span>)</span>
        {
            WinForm2WASMPublish.AddStandardControlTypeName(typeName);
        }
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Microsoft.JSInterop.JSInProcessRuntime _jsRuntime;
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Start</span>(<span class="hljs-params">Microsoft.JSInterop.JSInProcessRuntime rt</span>)</span>
        {
            <span class="hljs-keyword">if</span> (rt == <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">"rt"</span>);
            }
            _jsRuntime = rt;
            WinForm2WASMPublish.Start(<span class="hljs-keyword">new</span> MyJSRuntime(rt), <span class="hljs-keyword">typeof</span>(DCWasmWinFormEngine).Assembly);
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyJSRuntime</span> :<span class="hljs-title">DCSoft.IDCJSRuntime</span>
        {
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyJSRuntime</span>(<span class="hljs-params">JSInProcessRuntime rt</span>)</span>
            {
                <span class="hljs-keyword">if</span>(rt == <span class="hljs-literal">null</span> )
                {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">"rt"</span>);
                }
                <span class="hljs-keyword">this</span>._rt = rt;
            }
            <span class="hljs-keyword">private</span> JSInProcessRuntime _rt = <span class="hljs-literal">null</span>;
            <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">Invoke</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">string</span> identifier, <span class="hljs-keyword">params</span> <span class="hljs-built_in">object</span>?[]? args</span>)</span>
            {
                <span class="hljs-keyword">return</span> _rt.Invoke&lt;T&gt;(identifier, args);
            }
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ValueTask</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-title">InvokeAsync</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-built_in">string</span> identifier, <span class="hljs-keyword">params</span> <span class="hljs-built_in">object</span>?[]? args</span>)</span>
            {
                <span class="hljs-keyword">return</span> _rt.InvokeAsync&lt;T&gt;(identifier, args);
            }
            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InvokeVoidAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> identifier, <span class="hljs-keyword">params</span> <span class="hljs-built_in">object</span>?[]? args</span>)</span>
            {
                _rt.InvokeVoidAsync(identifier, args);
            }
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 设置屏幕大小</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="width"&gt;</span>宽度<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="height"&gt;</span>高度<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="defaultFontName"&gt;</span>默认字体名称<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="defaultFontSize"&gt;</span>Point为单位的默认字体大小<span class="hljs-doctag">&lt;/param&gt;</span></span>
        [<span class="hljs-meta">JSInvokable</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetScreenSize</span>(<span class="hljs-params">
            <span class="hljs-built_in">int</span> width,
            <span class="hljs-built_in">int</span> height,
            <span class="hljs-built_in">string</span> defaultFontName,
            <span class="hljs-built_in">float</span> defaultFontSize</span>)</span>
        {
            WinForm2WASMPublish.SetScreenSize(width, height, defaultFontName, defaultFontSize);
        }
        
        [<span class="hljs-meta">JSInvokable</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">PackageArgumentObjectToHandle</span>(<span class="hljs-params"> JsonNode json </span>)</span>
        {
            <span class="hljs-keyword">return</span> WinForm2WASMPublish.PackageToHandle(json);
        }

        [<span class="hljs-meta">JSInvokable</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMessage_WM_WINDOWPOSCHANGED</span>(<span class="hljs-params"> <span class="hljs-built_in">int</span> handle , JsonObject args </span>)</span>
        {
            WinForm2WASMPublish.SendMessage_WM_WINDOWPOSCHANGED(handle, args);
        }
        
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 发送消息到控件</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="handle"&gt;</span>控件句柄<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="msg"&gt;</span>消息类型<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="wParam"&gt;</span>参数1<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="lParam"&gt;</span>参数2<span class="hljs-doctag">&lt;/param&gt;</span></span>
        [<span class="hljs-meta">JSInvokable</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SendMessageToControl</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> handle , <span class="hljs-built_in">int</span> msg, <span class="hljs-built_in">int</span> wParam, <span class="hljs-built_in">int</span> lParam</span>)</span>
        {
            WinForm2WASMPublish.SendMessageToControl(handle, msg, wParam, lParam); 
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 处理已经发送的消息</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        [<span class="hljs-meta">JSInvokable</span>]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">HandlePostedMessage</span>()</span>
        {
            WinForm2WASMPublish.HandlePostedMessage();
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[生产环境使用C++实现算法的必要性]]></title>    <link>https://juejin.cn/post/7591792747775082506</link>    <guid>https://juejin.cn/post/7591792747775082506</guid>    <pubDate>2026-01-06T00:13:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591792747775082506" data-draft-id="7591728734982881307" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="生产环境使用C++实现算法的必要性"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-06T00:13:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            生产环境使用C++实现算法的必要性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:13:00.000Z" title="Tue Jan 06 2026 00:13:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问：使用tensorflow写的算法，为啥要使用C++部署呢？</h2>
<p><strong>算法工程化的核心矛盾</strong>：既然模型是用 TensorFlow（Python）写的，为什么还要用 C++ 来部署？这背后涉及性能、资源、系统集成和生产环境的现实需求。</p>
<p>下面从 <strong>5 个核心维度</strong>解释原因：</p>
<p><strong>1 性能：C++ 能榨干硬件极限</strong></p>
<ul>
<li><strong>低延迟</strong>：C++ 没有 Python 的 GIL（全局解释器锁）、垃圾回收、动态类型开销。在高并发、低延迟场景（如广告点击率预估、实时翻译），<strong>C++ 推理比 Python 快 2~10 倍</strong>很常见。</li>
<li><strong>CPU/GPU 利用率更高</strong>：C++ 可以精细控制内存布局（如连续内存块）、SIMD 指令、线程池，避免 Python 的内存碎片和调度开销。</li>
</ul>
<p>对延迟敏感的业务（金融交易、游戏 AI、车载系统），C++ 是刚需。</p>
<p><strong>2 稳定性与可控性</strong></p>
<p>Python 的动态特性（如 monkey patch、运行时 import）在生产环境是“定时炸弹”。</p>
<p>正因为这些语言更加高级，提供了更加易用的功能，开发方便，但是对于特定场合，比如部署运行，反而成了优化的负担。</p>
<p>C++ 编译期检查强，内存管理明确（RAII），更容易做：</p>
<ul>
<li>
<p>静态分析</p>
</li>
<li>
<p>内存泄漏检测</p>
</li>
<li>
<p>确定性行为（Determinism）</p>
</li>
</ul>
<p><strong>3 资源占用：更省内存、更少依赖</strong></p>
<p>Python 进程本身就要几百 MB 内存（加载 tensorflow、numpy 等），而 C++ 推理服务可以做到 &lt; 50MB。</p>
<p>在边缘设备（手机、IoT、车载芯片）或大规模集群（万级容器），内存节省 = 成本下降。
C++ 部署通常只链接必要的库（如 libtensorflow_cc.so），而 Python 需要整个解释器 + pip 包生态。</p>
<p>资源受限环境（端侧、边缘、高密度部署），C++ 更经济。</p>
<blockquote>
<p>总结前三点原因，可以看出，语言的特性是根本差异，因为C++集成了C语言，它足够原始，没有太多高级特性（内存自动回收），所以可控，性能也消耗最少，1，2，3其实都说的是1个原因。</p>
</blockquote>
<p><strong>4 系统集成性能：嵌入现有 C++ 生态</strong></p>
<p>很多公司核心系统是 C++ 写的（如游戏引擎、高频交易系统、数据库、自动驾驶中间件）。</p>
<p>如果推理服务也用 C++，可以直接 以内存函数调用方式集成，避免：</p>
<ul>
<li>进程间通信（IPC）</li>
<li>gRPC/HTTP 序列化开销</li>
<li>网络抖动风险</li>
</ul>
<p>自动驾驶感知模块（C++）需要实时调用 NLP 模型理解语音指令。</p>
<p>如果用 Python 服务，每帧都要走网络 → 增加 5~10ms 延迟 → 可能错过刹车时机。</p>
<p>用 C++ 直接调用模型 → 零拷贝、零网络 → 安全可靠。</p>
<p><strong>5 TensorFlow 本身就支持 C++ 部署</strong></p>
<p>TensorFlow 不只是 Python 库，它的底层是 C++ 写的，并提供了 官方 C++ API：<br/>
TensorFlow C++ API：直接加载 SavedModel，执行推理<br/>
TensorRT（NVIDIA）：将 TF 模型转为高度优化的 C++ 引擎（GPU 专用）<br/>
TF Lite：轻量级 C++ 推理库（适合移动端/嵌入式）</p>
<blockquote>
<p>4和5说的是生态原因，包括外部生态和内部生态。</p>
</blockquote>
<h2 data-id="heading-1">问：是不是所有场景都要用 C++？</h2>
<p>不是！ 以下情况用 Python 更合适：</p>
<p>快速原型验证（PoC）<br/>
批处理任务（离线分析，不追求低延迟）<br/>
模型频繁迭代，工程团队人力有限<br/>
使用 TF Serving / Triton 等托管服务（它们内部其实也是 C++）</p>
<h2 data-id="heading-2">使用C++部署模型的核心技能</h2>
<p>TensorFlow C++ API 或 ONNX Runtime C++（如果模型可转换）<br/>
SavedModel 格式 的加载与输入/输出张量处理<br/>
性能 profiling（如 perf、nsight）定位瓶颈</p>
<h2 data-id="heading-3">总结：c++运行tensorflow算法</h2>
<p>TensorFlow 的算法（Python 训练的模型）不需要“翻译”成 C++，而是：</p>
<p>用 C++ 直接加载训练好的模型文件，调用 TensorFlow 的 C++ 推理接口执行预测。</p>
<p>python关键代码实例：</p>
<pre><code class="hljs language-python" lang="python">model.save(<span class="hljs-string">"my_model"</span>)  <span class="hljs-comment"># 生成 my_model/ 目录（含 .pb 文件和 variables）</span>
</code></pre>
<p>c++关键代码实例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"tensorflow/cc/saved_model/loader.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"tensorflow/cc/serving/saved_model_bundle.h"</span></span>

tensorflow::SavedModelBundle bundle;
tensorflow::<span class="hljs-built_in">LoadSavedModel</span>(..., <span class="hljs-string">"my_model"</span>, ..., &amp;bundle);

<span class="hljs-comment">// 准备输入 Tensor（例如 shape=[1, 128] 的 float 输入）</span>
<span class="hljs-function">tensorflow::Tensor <span class="hljs-title">input</span><span class="hljs-params">(...)</span></span>;

<span class="hljs-comment">// 执行推理</span>
std::vector&lt;tensorflow::Tensor&gt; outputs;
bundle.session-&gt;<span class="hljs-built_in">Run</span>({{<span class="hljs-string">"input_tensor_name"</span>, input}}, {<span class="hljs-string">"output_tensor_name"</span>}, {}, &amp;outputs);
</code></pre>
<p>编译链接 TensorFlow C++ 库（需提前编译或下载 libtensorflow_cc.so）</p>
<p><strong>重点：</strong><br/>
不是重写算法，而是复用已训练好的模型<br/>
C++ 只负责：加载模型 + 构造输入 + 调用推理 + 解析输出<br/>
模型结构、权重全部由 SavedModel 文件提供，无需手写</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 21新特性实战：5个显著提升开发效率的语法糖与应用场景]]></title>    <link>https://juejin.cn/post/7591703562134487074</link>    <guid>https://juejin.cn/post/7591703562134487074</guid>    <pubDate>2026-01-06T00:16:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591703562134487074" data-draft-id="7591702898080710671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 21新特性实战：5个显著提升开发效率的语法糖与应用场景"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-06T00:16:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 21新特性实战：5个显著提升开发效率的语法糖与应用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:16:48.000Z" title="Tue Jan 06 2026 00:16:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java 21新特性实战：5个显著提升开发效率的语法糖与应用场景</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Java作为一门历经20多年演进的编程语言，始终保持着强大的生命力。2023年9月，Oracle正式发布了Java 21，这是一个长期支持（LTS）版本，带来了许多令人兴奋的新特性。其中，一些语法糖（Syntactic Sugar）的引入极大地提升了开发者的编码效率和代码可读性。</p>
<p>本文将深入探讨Java 21中5个最具实用价值的语法糖特性，并结合实际应用场景展示它们如何简化代码、减少模板代码（Boilerplate Code）并提升开发效率。无论你是Java初学者还是资深开发者，这些新特性都将为你的工具箱增添利器。</p>
<hr/>
<h3 data-id="heading-2">1. Switch表达式模式匹配（Pattern Matching for Switch）</h3>
<h4 data-id="heading-3">特性解析</h4>
<p>Java 21进一步完善了<code>switch</code>表达式的模式匹配能力，允许在<code>case</code>标签中直接使用类型模式（Type Patterns）和守卫条件（Guards）。这是对Java 17中预览特性的最终定稿。</p>
<h4 data-id="heading-4">语法示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Hello, Java 21"</span>;

<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">switch</span> (obj) {
    <span class="hljs-keyword">case</span> Integer i -&gt; <span class="hljs-string">"Integer: "</span> + i;
    <span class="hljs-keyword">case</span> String s &amp;&amp; s.length() &gt; <span class="hljs-number">5</span> -&gt; <span class="hljs-string">"Long String: "</span> + s;
    <span class="hljs-keyword">case</span> String s -&gt; <span class="hljs-string">"String: "</span> + s;
    <span class="hljs-keyword">default</span> -&gt; <span class="hljs-string">"Unknown"</span>;
};
</code></pre>
<h4 data-id="heading-5">应用场景</h4>
<ul>
<li><strong>多态处理</strong>：简化基于类型的多分支逻辑，避免频繁的<code>instanceof</code>检查和强制类型转换。</li>
<li><strong>数据解析</strong>：在处理JSON或XML等动态数据时，可以更优雅地匹配和处理不同类型的数据节点。</li>
</ul>
<h4 data-id="heading-6">优势</h4>
<ul>
<li><strong>代码简洁性</strong>：减少了冗余的类型检查和转换代码。</li>
<li><strong>可读性</strong>：通过直观的模式匹配表达意图，逻辑更加清晰。</li>
</ul>
<hr/>
<h3 data-id="heading-7">2. Record模式的解构（Record Patterns）</h3>
<h4 data-id="heading-8">特性解析</h4>
<p>Record是Java 16引入的一种不可变数据载体类。Java 21进一步扩展了Record的功能，支持在模式匹配中直接解构Record的字段值。</p>
<h4 data-id="heading-9">语法示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">record</span> <span class="hljs-title class_">Point</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {}

<span class="hljs-type">Point</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);

<span class="hljs-keyword">if</span> (p <span class="hljs-keyword">instanceof</span> <span class="hljs-title function_">Point</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span>) {
    System.out.println(<span class="hljs-string">"x: "</span> + x + <span class="hljs-string">", y: "</span> + y);
}
</code></pre>
<h4 data-id="heading-10">应用场景</h4>
<ul>
<li><strong>DTO处理</strong>：快速提取数据传输对象（DTO）中的字段值。</li>
<li><strong>模式匹配组合</strong>：与<code>switch</code>表达式结合使用，实现复杂数据结构的深度匹配和解构。</li>
</ul>
<h4 data-id="heading-11">优势</h4>
<ul>
<li><strong>减少样板代码</strong>：无需手动调用访问器方法即可获取字段值。</li>
<li><strong>增强表达力</strong>：直接通过模式声明变量的绑定关系。</li>
</ul>
<hr/>
<h3 data-id="heading-12">3. Sequenced Collections API</h3>
<h4 data-id="heading-13">特性解析</h4>
<p>Java 21引入了新的<code>SequencedCollection</code>、<code>SequencedSet</code>和<code>SequencedMap</code>接口，为有序集合提供了一组统一的操作方法，如获取首尾元素、反向视图等。</p>
<h4 data-id="heading-14">语法示例</h4>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(List.of(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, —));
<span class="hljs-type">int</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> list.getFirst(); <span class="hljs-comment">// Java 21新增方法</span>
<span class="hljs-type">int</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> list.getLast();
List&lt;Integer&gt; reversed = list.reversed();
</code></pre>
<p>#### 应用场景</p>
<ul>
<li><strong>队列和栈操作</strong>：简化首尾元素的访问和修改逻辑。</li>
<li><strong>算法实现</strong>：在需要反向遍历或处理边界元素的场景中减少冗余代码。</li>
</ul>
<p>#### 优势
-<strong>API标准化</strong>:统一了不同集合类型(如List.Deque)的首尾操作方法.
-<strong>功能增强</strong>:新增reversed()方法提供不可变的反向视图.</p>
<hr/>
<p>###4.String Templates(字符串模板)</p>
<p>#####特性解析</p>
<p>字符串模板是JEP430引入的特性旨在解决字符串拼接的繁琐问题.它允许开发者直接在字符串中嵌入表达式而无需显式拼接.</p>
<p>#####语法示例</p>
<pre><code class="hljs language-java" lang="java">String name=<span class="hljs-string">"John"</span>;
<span class="hljs-type">int</span> age=<span class="hljs-number">30</span>;

<span class="hljs-comment">//传统方式</span>
String message1=<span class="hljs-string">"Name:"</span>+name+<span class="hljs-string">"Age:"</span>+age;

<span class="hljs-comment">//Java 21字符串模板</span>
String message2=STR.<span class="hljs-string">"Name:\{name}Age:\{age}"</span>;
</code></pre>
<p>#####应用场景</p>
<p>-SQL查询构建:避免手写容易出错的SQL拼接语句.
-HTML生成:在Web应用中动态生成HTML片段时更安全便捷.</p>
<p>#####优势</p>
<p>-<strong>安全性</strong>:通过模板处理器可防止注入攻击.
-<strong>可读性</strong>:内嵌表达式使字符串结构一目了然.</p>
<hr/>
<p>###5.Unnamed Patterns and Variables(未命名模式和变量)</p>
<p>#####特性解析</p>
<p>该特性允许使用下划线_忽略未使用的模式或变量适用于需要声明但不使用的场景.</p>
<p>#####语法示例</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span>{
<span class="hljs-type">int</span> _=Integer.parseInt(<span class="hljs-string">"123"</span>);<span class="hljs-comment">//忽略结果</span>
}<span class="hljs-keyword">catch</span>(NumberFormatException _){
System.out.println(<span class="hljs-string">"Invalid number"</span>);
}

<span class="hljs-comment">//Record解构时忽略某些字段</span>
<span class="hljs-keyword">if</span>(point <span class="hljs-keyword">instanceof</span> <span class="hljs-title function_">Point</span><span class="hljs-params">(<span class="hljs-type">int</span> x,_)</span>){
System.out.println(<span class="hljs-string">"x:"</span>+x);
}
</code></pre>
<p>#####应用场景</p>
<p>-异常处理:忽略异常参数.
-Record解构:只提取部分字段值.</p>
<p>#####优势</p>
<p>-<strong>明确意图</strong>:通过_显式表明忽略该变量.
-<strong>减少噪音</strong>:避免未使用变量的警告提示.</p>
<hr/>
<p>##总结</p>
<p>Java21的这些语法糖不仅仅是表面的修饰它们从实际痛点出发显著提升了开发效率和代码质量:</p>
<p>1.Switch模式匹配让复杂的条件分支变得直观.
2.Record模式的解构简化了数据载体的处理.
3.Sequenced Collections为有序集合操作提供了统一API.
4.String Templates终结了繁琐的字符串拼接时代.
5.未命名模式和变量帮助开发者专注于真正需要的部分.</p>
<p>这些改进体现了Java团队对开发者体验的高度重视也展现了语言演进的务实方向.建议开发者尽快熟悉这些特性并将其应用到实际项目中以充分享受现代化Java带来的便利与高效.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 如何高效准备简历和面试]]></title>    <link>https://juejin.cn/post/7591730714140393514</link>    <guid>https://juejin.cn/post/7591730714140393514</guid>    <pubDate>2026-01-06T00:20:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591730714140393514" data-draft-id="7571726099688865811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 如何高效准备简历和面试"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-01-06T00:20:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端双越老师"/> <meta itemprop="url" content="https://juejin.cn/user/1714893868765373"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 如何高效准备简历和面试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893868765373/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端双越老师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:20:48.000Z" title="Tue Jan 06 2026 00:20:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是双越。前百度 滴滴 资深前端工程师，慕课网金牌讲师，PMP。我的代表作有：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wangeditor.com%2F" target="_blank" title="https://www.wangeditor.com/" ref="nofollow noopener noreferrer">wangEditor</a> 开源 web 富文本编辑器，GitHub 18k star，npm 周下载量 20k</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.huashuiai.com%2F" target="_blank" title="https://www.huashuiai.com/" ref="nofollow noopener noreferrer">划水AI</a> Node 全栈 AIGC 知识库，包括 AI 写作、多人协同编辑。复杂业务，真实上线。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshipai.com%2F" target="_blank" title="https://www.mianshipai.com/" ref="nofollow noopener noreferrer">前端面试派</a> 系统专业的面试导航，刷题，写简历，看面试技巧，内推工作。开源免费。</li>
</ul>
<blockquote>
<p>我在正在开发一个 AI Agent 智能体项目【<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhitalk.chat%2F" target="_blank" title="https://zhitalk.chat/" ref="nofollow noopener noreferrer">智语</a>】一个智能面试官，可以优化简历、模拟面试、解答题目等。对 AI 开发有兴趣的同学，可以围观、学习。</p>
</blockquote>
<h2 data-id="heading-0">开始</h2>
<p>近期已经有好几个同学和我说，裁员，不续约合同，或者看公司发展很不好，想跳槽。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0feef605b1734ac3b8279dacd70560f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768263647&amp;x-signature=gqTJp%2BRE2M5%2BYiMbjLjYAHcfekg%3D" alt="image.png" loading="lazy"/></p>
<p>当前这种大环境下，应该如何准备面试呢？尤其是很多同学在一个公司好几年了，也不知道外面什么行情。</p>
<p>按照前些年的想法，面试嘛，那肯定得好好准备一番。刷算法，背诵八股文，甚至还要专门花一段时间学习新的技能。</p>
<p>这么多内容，你如果挨着准备一遍，至少 2-3 个月过去了，这个时间跨度太久了。</p>
<h2 data-id="heading-1">当前不适合长时间准备</h2>
<p>前些年招聘市场火热，面试机会多，工资开的高，这就有两个特点</p>
<ul>
<li>只要出去面试，就一定能找到工作</li>
<li>面试造火箭，只要你准备的好，就很有可能拿到高工资</li>
</ul>
<p>所以那个时候适合多花点时间，多准备些面试题，反正机会多的是，尽量争取一个好机会，进大厂，拿高薪。</p>
<p>而现在情况恰恰相反</p>
<ul>
<li>面试机会少了</li>
<li>面试不再大量考八股文和算法，而是更注重项目，更加实用主义</li>
</ul>
<p>所以你现在如果花大量时间准备很多知识，面试的时候不一定能用的上，而且这段时间你会浪费掉很多机会。现在机会才是最重要的。</p>
<p>而且，你个人的技术能力不可能在短时间靠刷题来提升。尤其是在当前这种实用主义面试的情况下，你很难把自己背诵的题目应用到实际场景中。</p>
<h2 data-id="heading-2">认真写简历</h2>
<p>简历是什么？简历就是一个人的脸，一个人的妆，是 HR 和面试官对你的第一印象。</p>
<p>一个陌生人拿到你简历的第一秒钟，他还没看到内容，但已经可以看到简历的篇幅和格式。</p>
<p>有些同学简历写的太简单，技能就 2-3 个基础的，项目就 2-3 个而且没详细写，格式也字体大小不一致...给人的第一印象就不好。</p>
<p>程序员是一个要求认真仔细的岗位，而且你在工作中除了写代码，也是要写文档的。你对待自己的简历都尚且如此马虎简陋，我不相信你在工作中能写出多么好的文档。</p>
<p>尤其是在当前招聘市场竞争激烈的环境下，简历的作用会被放大，一旦感觉你简历不好，立马就放弃你。</p>
<p>所以简历要认真写，要向别人展示出你的能力和态度</p>
<ul>
<li>专业技能，要写全</li>
<li>工作经历，要写出自己的工作成果</li>
<li>项目，既要有数量，又要有内容，写出自己在项目中的贡献、使用的技能</li>
</ul>
<p>还有一些同学写的太详细了，工作才 3 年，写个简历写 5 页，内容太多了，第一眼看着就眼晕。</p>
<p>简历的核心价值在于“勾引”，你只需要写出最具有吸引力的部分，不用写的很细节，你能引起别人的注意和兴趣，他就会约你来面试。等面试的时候，有你详细表达的机会。</p>
<p>简历的每个模块、格式和细节可参考【面试派】里的介绍 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshipai.com%2Fdocs%2Fbefore-interview%2Fwrite-resume.html" target="_blank" title="https://www.mianshipai.com/docs/before-interview/write-resume.html" ref="nofollow noopener noreferrer">www.mianshipai.com/docs/before…</a></p>
<p>如果你职场经验不多，写好简历以后，找身边认识的有经验的人，尤其是做过面试官的人，找他看一眼，提提建议。有些问题自己死活看不出来，别人一眼就能看出来，多找几个人看看，自己再综合考虑。</p>
<h2 data-id="heading-3">准备好项目</h2>
<p>项目经验，是当前简历和面试中最重要的内容，尤其是对于有工作经验的人。所以要提前准备好。</p>
<p>这其实很好理解，在 AI 编程普及的情况下，八股文、语法、算法能力都被抹平了。如果你是一个老板，要招聘一个干活的程序员，考察项目经验是最直接有效的方式。</p>
<p>简历里一般会写 3-5 个项目，但重要程度不一样，你要找到自己的“代表作”，作为简历第一个项目，这个要重点准备。</p>
<p>首先，在简历里，第一个项目要详细写，多写一下自己的项目职责和工作，使用的技能，项目成果等，得有大量自己参与的内容，才有说服力。</p>
<p>然后，要提前准备面试时的问题。</p>
<p><strong>第一个问题：请介绍这个项目</strong></p>
<p>这个问题看似简单，但很多同学回答的都不好：</p>
<ul>
<li>上来就说技术细节，我压根都不知道你这个项目是个啥</li>
<li>长篇大论，一口气说 10 分钟，其实我在 2 分钟以后就听懵了</li>
</ul>
<p>大家要明白，你去面试，对面坐着的是一个完全陌生的人，他对你陌生，他对你的项目更陌生，他可能刚刚拿到你的简历，你一边讲他一边看。</p>
<p>但你却他把当作你身边的同时一样，直接讨论项目的技术细节，他能听懂吗？他听不懂你说的再好有用吗？</p>
<p>所以，介绍项目时，最重要的是让别人能听懂，这是绝大部分同学所面临的障碍。</p>
<p>面试，是一种沟通，你得感知对方是不是在听你说话，感知他是不是听懂了。沟通，不是你单方面的倾诉，你得适当的留出对方提问的间隙，而不是你一味的自我表达。</p>
<p><strong>第二个问题：项目的亮点或成就</strong></p>
<p>看到这个问题，很多同学的第一反应就是：我没有亮点也没有成就。</p>
<p>老板把你招聘过去，每个月给你开工资干活，你肯定每天都有产出。没有功劳还有苦劳嘛，即便没有亮点，你总有难点吧？</p>
<p>回顾一下你这半年，有没有为一个需求、一个问题、一个 bug 而加班熬夜甚至通宵，头发都抓掉好几把，肯定有吧。</p>
<p>即便再没有，没吃过猪肉也见过猪跑，你身边的同事总会有这种情况吧？你给他买杯奶茶，问问他。</p>
<p>叫法不重要，无论叫亮点、成就、还是难点，都行。你只要能讲出 1-2 段你在项目中的不俗的经历就可以。</p>
<p>然后怎么讲，也是有技巧的。既然要说亮点、难点，那得讲的出“亮”和“难”不能平淡如水。</p>
<p>你得把需求、背景、问题、分析、障碍、解决方案、结果，从头到尾都说出来。并且要体现出使用的技术，因为你是技术人员。</p>
<p>具体格式可以参考【面试派】给出的格式 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshipai.com%2Fdocs%2Fthird-exam%2Fproject.html" target="_blank" title="https://www.mianshipai.com/docs/third-exam/project.html" ref="nofollow noopener noreferrer">www.mianshipai.com/docs/third-…</a></p>
<p><strong>第三个问题，项目有没有做过什么优化？</strong></p>
<p>优化，一般是体验和性能，这其实是老生常谈的问题了。</p>
<p>但如果在项目中问这个问题，不要只背诵八股文，一定要结合项目实际功能，而且最好有量化标准。</p>
<p>总之，你得提前准备这个问题，否则万一被问到，现学现卖是来不及的。而且这种问题一旦回答失败，影响会非常大。</p>
<h2 data-id="heading-4">快速准备八股文和算法</h2>
<p>AI 时代八股文和算法会越来越少，就像 Vue React 时代不会再问你 DOM API 。</p>
<p>但是直接忽略他们，一点都不准备嘛？这肯定不行，万一被问到一个基础问题，你不会，这有点丢人。</p>
<p>我建议是：集中 2-3 天快速复习</p>
<ul>
<li>把本该会的、简单的过一遍，查缺补漏</li>
<li>那些不会的，有点难度的，就先不管了</li>
</ul>
<p>尤其是算法，不好短时间恶补，你如果现在不会，那就先这样吧，别强求了。等找到工作稳定了，再业余去刷吧。</p>
<p>基础八股文的快速复习，可以参考【面试派】里面整理的问题 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshipai.com%2Fdocs%2Fwritten-exam%2FJS-writing.html" target="_blank" title="https://www.mianshipai.com/docs/written-exam/JS-writing.html" ref="nofollow noopener noreferrer">www.mianshipai.com/docs/writte…</a></p>
<h2 data-id="heading-5">尽快投递简历</h2>
<p>上文已经分析了，不要想着：先认真复习 1-2 个人，再投简历。不要这样。</p>
<p>第一，你简历写好了，修改好了；第二，你项目准备好了。<strong>接下来就直接投递简历，不用等</strong>。每天都要投，广泛的投，不放过任何一个机会。</p>
<p>你投递到接到要求，最快也得 3-5 天的时间，这个时间用于快速复习基础八股文，足够了。</p>
<p>后面如果有面试，再根据面试情况归纳总结，复习更多的问题。</p>
<p>总之，要尽快博取机会，不要拖沓。现在竞争激烈，你一旦拖沓，一懒惰，很快 2-3 个月就过去了。</p>
<h2 data-id="heading-6">最后</h2>
<p>现在是买方市场，僧多粥少，不要过多准备。你在这精心准备着，那边机会早就被人给抢走了。</p>
<p>简历，项目，包括基础八股文，最多 2 周时间，然后就去投递，早投，多投。然后一边面试着，一遍再总结。</p>
<p>也许吧，快节奏已经不知不觉渗透到了工作生活的方方面面。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 开年盘点：GitHub 上备受关注的十大 AI Agent 框架]]></title>    <link>https://juejin.cn/post/7591702898080727055</link>    <guid>https://juejin.cn/post/7591702898080727055</guid>    <pubDate>2026-01-06T00:24:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591702898080727055" data-draft-id="7591702898080481295" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 开年盘点：GitHub 上备受关注的十大 AI Agent 框架"/> <meta itemprop="keywords" content="Agent,Python,TypeScript"/> <meta itemprop="datePublished" content="2026-01-06T00:24:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天行无忌"/> <meta itemprop="url" content="https://juejin.cn/user/4406498333033918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 开年盘点：GitHub 上备受关注的十大 AI Agent 框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498333033918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天行无忌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:24:46.000Z" title="Tue Jan 06 2026 00:24:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3798d7913bcd4b699161e5dfe9bd6b51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6KGM5peg5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768263886&amp;x-signature=M3%2FZTK0Vk4OCL2tzZdNGV4j3vE4%3D" alt="GitHub-上备受关注的十大-AI-Agent-框架.jpg" loading="lazy"/></p>
<p>AI 智能体正在重塑我们构建软件的方式。GitHub Star 星标数是开发者信任度与社区采纳度的重要体现。以下是截至2026年01月05日 GitHub 上备受关注的十大 AI Agent 框架。</p>
<h3 data-id="heading-0">1. LangChain</h3>
<p>最流行的用于构建 LLM 驱动应用的框架，提供用于链、智能体和检索的广泛工具。</p>
<p>借助 LangChain，只需不到 10 行代码即可接入 OpenAI、Anthropic、Google 等平台。它提供预建的智能体架构与模型集成，帮助开发者快速起步，轻松将 LLM 能力融入智能体与应用中。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain" target="_blank" title="https://github.com/langchain-ai/langchain" ref="nofollow noopener noreferrer">github.com/langchain-a…</a></li>
<li>🌟 Star：123K</li>
</ul>
<h3 data-id="heading-1">2. MetaGPT：多智能体框架</h3>
<p>一个模拟软件公司的多智能体框架，智能体在其中担任产品经理、架构师和工程师等角色。</p>
<ol>
<li>MetaGPT输入<strong>一句话的老板需求</strong>，输出<strong>用户故事 / 竞品分析 / 需求 / 数据结构 / APIs / 文件等</strong></li>
<li>MetaGPT内部包括<strong>产品经理 / 架构师 / 项目经理 / 工程师</strong>，它提供了一个<strong>软件公司</strong>的全过程与精心调配的SOP. <code>Code = SOP(Team)</code> 是核心哲学。将SOP具象化，并且用于LLM构成的团队</li>
</ol>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFoundationAgents%2FMetaGPT" target="_blank" title="https://github.com/FoundationAgents/MetaGPT" ref="nofollow noopener noreferrer">github.com/FoundationA…</a></li>
<li>🌟 Star：62.5K</li>
</ul>
<h3 data-id="heading-2">3. AutoGen</h3>
<p>AutoGen 是一个用于创建多智能体 AI 应用的框架，这些应用能够自主行动或与人类协同工作。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fautogen" target="_blank" title="https://github.com/microsoft/autogen" ref="nofollow noopener noreferrer">github.com/microsoft/a…</a></li>
<li>🌟 Star：53.2K</li>
</ul>
<h3 data-id="heading-3">4. LlamaIndex</h3>
<p>LlamaIndex（GPT Index）是为您的 LLM 应用程序设计的数据框架。使用 LlamaIndex 进行构建通常涉及 LlamaIndex 核心和一组选定的集成（或插件）。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frun-llama%2Fllama_index" target="_blank" title="https://github.com/run-llama/llama_index" ref="nofollow noopener noreferrer">github.com/run-llama/l…</a></li>
<li>🌟 Star：46.2K</li>
</ul>
<h3 data-id="heading-4">5. CrewAI</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e98e03b5c0492fb46f09cd345cb817~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6KGM5peg5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768263886&amp;x-signature=aNank6QvwSQbHPx5HiOp6ivfA%2BA%3D" alt="image.png" loading="lazy"/></p>
<p>一个用于编排角色扮演自主智能体的框架，这些智能体通过协作完成复杂任务。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FcrewAIInc%2FcrewAI" target="_blank" title="https://github.com/crewAIInc/crewAI" ref="nofollow noopener noreferrer">github.com/crewAIInc/c…</a></li>
<li>🌟 Star：42.3K</li>
</ul>
<h3 data-id="heading-5">6. Agno</h3>
<p>Agno 是一个多智能体框架、运行时和控制平面。用它来在你的云环境中构建私有且安全的 AI 产品。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagno-agi%2Fagno" target="_blank" title="https://github.com/agno-agi/agno" ref="nofollow noopener noreferrer">github.com/agno-agi/ag…</a></li>
<li>🌟 Star：36.6K</li>
</ul>
<p>Agno 提供了一套统一的堆栈，用于构建、运行和管理多智能体系统：</p>
<ul>
<li><strong>框架</strong>：借助记忆、知识库、状态管理、防护机制、人在回路、上下文压缩、MCP 协议、A2A 通信及 100 多种工具包，构建智能体、多智能体团队与工作流。</li>
<li><strong>AgentOS 运行时</strong>：通过安全无状态的运行环境及开箱即用的集成端点，在生产环境中运行多智能体系统。</li>
<li><strong>AgentOS 控制平面</strong>：通过全栈运行可视化管理跨环境部署的 AgentOS 系统，支持测试、监控与运维管理。可自主构建 Web 界面或直接使用 AgentOS 原生管理界面。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcf261691edb4385b647de869e32fb9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6KGM5peg5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768263886&amp;x-signature=sISSHLckm%2F9ZLQit4swC7Mei%2FHA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">7. Haystack</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c203eed6fa654f3eba422e6612f816eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6KGM5peg5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768263886&amp;x-signature=X3RyO32P6j%2BqKi5otoNJPulbUX4%3D" alt="image.png" loading="lazy"/></p>
<p>Haystack 是一个端到端的 LLM 框架，可让构建由 LLMs、Transformer 模型、向量搜索等技术驱动的应用程序。无论是想实现检索增强生成（RAG）、文档搜索、问答还是答案生成，Haystack 都能将先进的嵌入模型和 LLMs 编排到流水线中，构建端到端的 NLP 应用并满足用例需求。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepset-ai%2Fhaystack" target="_blank" title="https://github.com/deepset-ai/haystack" ref="nofollow noopener noreferrer">github.com/deepset-ai/…</a></li>
<li>🌟 Star：23.8K</li>
</ul>
<h3 data-id="heading-7">8. Open-AutoGLM</h3>
<p>一个开源的手机智能体模型和框架，用于构建移动设备自动化智能体。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzai-org%2FOpen-AutoGLM" target="_blank" title="https://github.com/zai-org/Open-AutoGLM" ref="nofollow noopener noreferrer">github.com/zai-org/Ope…</a></li>
<li>🌟 Star：20.8K</li>
</ul>
<h3 data-id="heading-8">9. Vercel AI SDK</h3>
<p>来自 Next.js 创造者的 TypeScript 人工智能工具包，专为构建 AI 驱动的网络应用而设计。AI SDK 是一个 TypeScript 工具包，旨在帮助开发者使用 React、Next.js、Vue、Svelte、Node.js 等技术构建由人工智能驱动的应用程序和智能体。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fai" target="_blank" title="https://github.com/vercel/ai" ref="nofollow noopener noreferrer">github.com/vercel/ai</a></li>
<li>🌟 Star：20.6K</li>
</ul>
<h3 data-id="heading-9">10. Mastra</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59f099a5780e4b1aafa839e9f400b348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp6KGM5peg5b-M:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768263886&amp;x-signature=2oZygGFKQXSSe7tXP6K9G7mpjPo%3D" alt="image.png" loading="lazy"/></p>
<p>Mastra 是一个用于使用现代化 TypeScript 技术栈构建 AI 驱动的应用程序和代理的框架。它包含了从早期原型到生产就绪应用程序所需的一切。Mastra 可以与前端和后端框架（如 React、Next.js 和 Node）集成，也可以作为独立服务器部署在任何地方。它是构建、调整和扩展可靠 AI 产品的最简便方式。</p>
<ul>
<li>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmastra-ai%2Fmastra" target="_blank" title="https://github.com/mastra-ai/mastra" ref="nofollow noopener noreferrer">github.com/mastra-ai/m…</a></li>
<li>🌟 Star：19.1K</li>
</ul>
<h3 data-id="heading-10">总结</h3>
<p>在上述十大 AI Agent 框架中，Python 生态占据主导地位，其中八个基于 Python 开发。对于前端开发者而言，基于 TypeScript 的 Vercel AI SDK 和 Mastra 是更贴合技术栈的优质选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 核心策略：如何判断 Agent 应该停止]]></title>    <link>https://juejin.cn/post/7592017365140308020</link>    <guid>https://juejin.cn/post/7592017365140308020</guid>    <pubDate>2026-01-06T00:32:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592017365140308020" data-draft-id="7591702898080759823" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 核心策略：如何判断 Agent 应该停止"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-06T00:32:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潘锦"/> <meta itemprop="url" content="https://juejin.cn/user/730549110707431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 核心策略：如何判断 Agent 应该停止
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/730549110707431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潘锦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:32:34.000Z" title="Tue Jan 06 2026 00:32:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单来讲，AI Agent 实现的的大逻辑就是一个大的循环 + 获取上下文 + 不停的 LLM 调用 + 工具的调用。</p>
<p>那么一个关键问题就出现了：这个循环什么时候应该停止？如果处理不当，Agent 可能会陷入无限循环，浪费计算资源，或者过早停止而无法完成任务。本文将深入探讨 AI Agent 停止策略的核心设计思路。</p>
<h2 data-id="heading-0">常用停止策略</h2>
<p>AI Agent 停止策略无外乎以下几种情况：</p>
<ol>
<li>硬性限制</li>
</ol>
<p>最简单粗暴的方法：</p>
<ul>
<li>最大步数限制（比如最多循环 30 次）</li>
<li>执行时间限制（比如最多跑 5 分钟）</li>
<li>API 调用次数限制（比如最多调 100 次）</li>
<li>API 调用 Token 数限制</li>
</ul>
<p>这种方法简单有效，但用户体验很差。经常出现任务做到一半被强制停止的情况。</p>
<ol start="2">
<li>任务完成检测</li>
</ol>
<p>让 LLM 判断任务是否完成：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 每次循环后问 LLM</span>
<span class="hljs-attr">response</span> = llm.ask(<span class="hljs-string">"任务是否已经完成？"</span>)
if <span class="hljs-attr">response</span> == <span class="hljs-string">"是"</span>:
    stop()
</code></pre>
<ol start="3">
<li>显式停止信号</li>
</ol>
<p>给 Agent 一个专门的"停止"工具：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">tools</span> = [
    <span class="hljs-string">"search"</span>,
    <span class="hljs-string">"calculate"</span>, 
    <span class="hljs-string">"terminate"</span>  <span class="hljs-comment"># 专门用来停止</span>
]
</code></pre>
<p>当 Agent 调用 terminate 工具时就停止。这个方法不错，但需要在 prompt 里教会 Agent 什么时候该调用它。</p>
<ol start="4">
<li>循环检测</li>
</ol>
<p>检测 Agent 是否在做重复的事：</p>
<ul>
<li>连续多次调用同一个工具</li>
<li>动作序列出现循环模式（A→B→A→B...）</li>
<li>输出内容高度相似</li>
</ul>
<ol start="5">
<li>错误累积</li>
</ol>
<p>连续失败多次就放弃：</p>
<pre><code class="hljs language-css" lang="css">if consecutive_errors &gt; <span class="hljs-number">3</span>:
    <span class="hljs-built_in">stop</span>(<span class="hljs-string">"连续失败太多次"</span>)
</code></pre>
<ol start="6">
<li>用户中断</li>
</ol>
<p>让用户能随时喊停。</p>
<p>下面我们以 OpenManus 和 Gemini CLI 的源码来看一下他们是怎么做的。</p>
<h2 data-id="heading-1">OpenManus 的停止逻辑</h2>
<p>OpenManus 的停止机制设计得比较完整，它用了一个多层防护的思路。</p>
<h2 data-id="heading-2">核心：terminate 工具</h2>
<p>OpenManus 给每个 Agent 都配了一个 terminate 工具：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Terminate</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"terminate"</span>
    description = <span class="hljs-string">"""当请求已满足或无法继续时终止交互。
    完成所有任务后，调用此工具结束工作。"""</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, status: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"交互已完成，状态：<span class="hljs-subst">{status}</span>"</span>
        
以上为示例，原始代码：
<span class="hljs-keyword">from</span> app.tool.base <span class="hljs-keyword">import</span> BaseTool


_TERMINATE_DESCRIPTION = <span class="hljs-string">"""Terminate the interaction when the request is met OR if the assistant cannot proceed further with the task.
When you have finished all the tasks, call this tool to end the work."""</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Terminate</span>(<span class="hljs-title class_ inherited__">BaseTool</span>):
    name: <span class="hljs-built_in">str</span> = <span class="hljs-string">"terminate"</span>
    description: <span class="hljs-built_in">str</span> = _TERMINATE_DESCRIPTION
    parameters: <span class="hljs-built_in">dict</span> = {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
            <span class="hljs-string">"status"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"The finish status of the interaction."</span>,
                <span class="hljs-string">"enum"</span>: [<span class="hljs-string">"success"</span>, <span class="hljs-string">"failure"</span>],
            }
        },
        <span class="hljs-string">"required"</span>: [<span class="hljs-string">"status"</span>],
    }

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, status: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""Finish the current execution"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"The interaction has been completed with status: <span class="hljs-subst">{status}</span>"</span>
</code></pre>
<p>OpenManus 使用的是方案 3，把「何时停止」的决策权交给了 LLM。prompt 里会明确告诉 Agent：任务完成了就调用 terminate。</p>
<h2 data-id="heading-3">状态机管理</h2>
<p>OpenManus 用状态机来管理 Agent 的生命周期：</p>
<pre><code class="hljs language-ini" lang="ini">class AgentState(Enum):
    <span class="hljs-attr">IDLE</span> = <span class="hljs-string">"idle"</span>
    <span class="hljs-attr">RUNNING</span> = <span class="hljs-string">"running"</span>  
    <span class="hljs-attr">FINISHED</span> = <span class="hljs-string">"finished"</span>
    <span class="hljs-attr">ERROR</span> = <span class="hljs-string">"error"</span>
</code></pre>
<p>当检测到特殊工具（如 terminate）被调用时，会触发状态转换：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_special_tool</span>(<span class="hljs-params">self, name: <span class="hljs-built_in">str</span>, result: <span class="hljs-type">Any</span></span>):
    <span class="hljs-keyword">if</span> name.lower() == <span class="hljs-string">"terminate"</span>:
        self.state = AgentState.FINISHED
        logger.info(<span class="hljs-string">"🏁 任务完成！"</span>)
</code></pre>
<h2 data-id="heading-4">步数限制</h2>
<p>不同类型的 Agent 有不同的步数上限：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ToolCallAgent: 30 步</span>
<span class="hljs-comment"># SWEAgent: 20 步</span>
<span class="hljs-comment"># PlanningFlow: 可配置</span>

<span class="hljs-keyword">while</span> self.current_step &lt; self.max_steps <span class="hljs-keyword">and</span> self.state != AgentState.FINISHED:
    self.current_step += <span class="hljs-number">1</span>
    <span class="hljs-keyword">await</span> self.step()

<span class="hljs-keyword">if</span> self.current_step &gt;= self.max_steps:
    results.append(<span class="hljs-string">f"达到最大步数限制 (<span class="hljs-subst">{self.max_steps}</span>)"</span>)
</code></pre>
<p>这是一个保底机制，防止 Agent 无限运行。</p>
<h2 data-id="heading-5">卡死检测</h2>
<p>OpenManus 还会检测 Agent 是否卡住了：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_stuck</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-comment"># 检查是否有重复的 assistant 消息</span>
    <span class="hljs-comment"># 如果最近的回复都一样，说明卡住了</span>
    recent_messages = self.get_recent_assistant_messages()
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">set</span>(recent_messages)) == <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<h2 data-id="heading-6">Planning Agent 的结束逻辑</h2>
<h3 data-id="heading-7">1. 计划完成的判断机制</h3>
<p>PlanningFlow 的结束判断并不是简单检查所有步骤是否完成：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在主执行循环中</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-comment"># 获取当前需要执行的步骤</span>
    self.current_step_index, step_info = <span class="hljs-keyword">await</span> self._get_current_step_info()
    
    <span class="hljs-comment"># 如果没有更多活跃步骤，则结束计划</span>
    <span class="hljs-keyword">if</span> self.current_step_index <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        result += <span class="hljs-keyword">await</span> self._finalize_plan()
        <span class="hljs-keyword">break</span>
</code></pre>
<h3 data-id="heading-8">2. 步骤状态检查逻辑</h3>
<p>_get_current_step_info() 方法负责判断是否还有未完成的步骤：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 查找第一个非完成状态的步骤</span>
<span class="hljs-keyword">for</span> i, step <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(steps):
    <span class="hljs-keyword">if</span> i &gt;= <span class="hljs-built_in">len</span>(step_statuses):
        status = PlanStepStatus.NOT_STARTED.value
    <span class="hljs-keyword">else</span>:
        status = step_statuses[i]
    
    <span class="hljs-comment"># 如果步骤状态为活跃状态（未开始或进行中），返回该步骤</span>
    <span class="hljs-keyword">if</span> status <span class="hljs-keyword">in</span> PlanStepStatus.get_active_statuses():
        <span class="hljs-keyword">return</span> i, step_info

<span class="hljs-comment"># 如果没找到活跃步骤，返回 None</span>
<span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>
</code></pre>
<p>其中 get_active_statuses() 返回 ["not_started", "in_progress"]，意味着只有当所有步骤都是 "completed" 或 "blocked" 状态时，计划才会结束。</p>
<h3 data-id="heading-9">3. 计划结束处理</h3>
<p>当没有更多活跃步骤时，会调用 _finalize_plan() 方法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_finalize_plan</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""使用 LLM 生成计划完成总结"""</span>
    plan_text = <span class="hljs-keyword">await</span> self._get_plan_text()
    
    <span class="hljs-comment"># 使用 LLM 生成总结</span>
    system_message = Message.system_message(
        <span class="hljs-string">"You are a planning assistant. Your task is to summarize the completed plan."</span>
    )
    
    user_message = Message.user_message(
        <span class="hljs-string">f"The plan has been completed. Here is the final plan status:\n\n<span class="hljs-subst">{plan_text}</span>\n\nPlease provide a summary of what was accomplished and any final thoughts."</span>
    )
    
    response = <span class="hljs-keyword">await</span> self.llm.ask(messages=[user_message], system_msgs=[system_message])
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Plan completed:\n\n<span class="hljs-subst">{response}</span>"</span>
</code></pre>
<h2 data-id="heading-10">Gemini CLI 的停止逻辑</h2>
<p>Gemini CLI 的设计思路完全不同，它用了一个更优雅但也更复杂的方案。</p>
<h2 data-id="heading-11">subagent 的停止逻辑</h2>
<h3 data-id="heading-12">1. 达到最大轮次（MAX_TURNS）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.runConfig.max_turns &amp;&amp; turnCounter &gt;= <span class="hljs-keyword">this</span>.runConfig.max_turns) {
    <span class="hljs-keyword">this</span>.output.terminate_reason = SubagentTerminateMode.MAX_TURNS;
    <span class="hljs-keyword">break</span>;
}
</code></pre>
<p>这是最简单的保护机制，防止无限循环。</p>
<h3 data-id="heading-13">2. 执行超时（TIMEOUT）</h3>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">durationMin</span> = (Date.now() - startTime) / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span>)<span class="hljs-comment">;</span>
if (durationMin &gt;= this.runConfig.max_time_minutes) {
    <span class="hljs-attr">this.output.terminate_reason</span> = SubagentTerminateMode.TIMEOUT<span class="hljs-comment">;</span>
    break<span class="hljs-comment">;</span>
}
</code></pre>
<p>注意这里检查了两次超时：</p>
<ul>
<li>在调用 LLM 之前检查一次</li>
<li>在调用 LLM 之后又检查一次</li>
</ul>
<p>这是因为 LLM 调用可能很耗时，要确保不会超时太多。</p>
<h3 data-id="heading-14">3. 用户中断（通过 AbortSignal）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">if</span> (abortController.signal.aborted) <span class="hljs-keyword">return</span>;
</code></pre>
<p>这个检查出现在 stream 处理循环里，确保能及时响应用户的取消操作。</p>
<h3 data-id="heading-15">4. 错误异常（ERROR）</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">catch</span> (<span class="hljs-keyword">error</span>) {
    console.<span class="hljs-keyword">error</span>(<span class="hljs-comment">'Error during subagent execution:', error);</span>
    this.output.terminate_reason = SubagentTerminateMode.<span class="hljs-keyword">ERROR</span>;
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">error</span>;
}
</code></pre>
<p>任何未捕获的异常都会导致停止。</p>
<h3 data-id="heading-16">5. 目标完成（GOAL）</h3>
<p>目标完成的判断分两种情况：</p>
<p>情况A：没有预定输出要求</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.outputConfig || Object.keys(<span class="hljs-keyword">this</span>.outputConfig.outputs).length === <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 没有要求特定输出，LLM 不调用工具就认为完成了</span>
    <span class="hljs-keyword">if</span> (functionCalls.length === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.output.terminate_reason = SubagentTerminateMode.GOAL;
        <span class="hljs-keyword">break</span>;
    }
}
</code></pre>
<p>情况B：有预定输出要求</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 检查是否所有要求的变量都已输出</span>
<span class="hljs-keyword">const</span> remainingVars = Object.keys(<span class="hljs-keyword">this</span>.outputConfig.outputs).filter(
    (key) =&gt; !(key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.output.emitted_vars)
);

<span class="hljs-keyword">if</span> (remainingVars.length === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>.output.terminate_reason = SubagentTerminateMode.GOAL;
    <span class="hljs-keyword">break</span>;
}
</code></pre>
<h2 data-id="heading-17">声明式输出系统的实现</h2>
<p>声明式输出系统的核心是 outputConfig：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 预先声明需要什么输出</span>
<span class="hljs-keyword">this</span>.outputConfig = {
    outputs: {
        <span class="hljs-string">"summary"</span>: <span class="hljs-string">"string"</span>,
        <span class="hljs-string">"recommendations"</span>: <span class="hljs-string">"array"</span>, 
        <span class="hljs-string">"risk_score"</span>: <span class="hljs-string">"number"</span>
    }
};

<span class="hljs-comment">// Agent 通过 self.emitvalue 工具来产生输出</span>
<span class="hljs-comment">// 每次调用会把值存到 this.output.emitted_vars 里</span>
<span class="hljs-keyword">this</span>.output.emitted_vars = {
    <span class="hljs-string">"summary"</span>: <span class="hljs-string">"这是总结..."</span>,
    <span class="hljs-string">"recommendations"</span>: [<span class="hljs-string">"建议1"</span>, <span class="hljs-string">"建议2"</span>]
    <span class="hljs-comment">// risk_score 还没输出</span>
};
</code></pre>
<p>系统会不断检查 emitted_vars 是否包含了所有 outputs 中声明的变量。只有全部输出了才认为目标完成。</p>
<h2 data-id="heading-18">Nudge 机制</h2>
<p>Nudge（轻推）机制代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (functionCalls.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {  <span class="hljs-comment">// LLM 停止调用工具了</span>
    <span class="hljs-comment">// 检查是否还有变量没输出</span>
    <span class="hljs-keyword">const</span> remainingVars = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">outputConfig</span>.<span class="hljs-property">outputs</span>).<span class="hljs-title function_">filter</span>(
        <span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> !(key <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>.<span class="hljs-property">emitted_vars</span>)
    );
    
    <span class="hljs-keyword">if</span> (remainingVars.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 还有变量没输出，"推"它一下</span>
        <span class="hljs-keyword">const</span> nudgeMessage = <span class="hljs-string">`You have stopped calling tools but have not emitted 
        the following required variables: <span class="hljs-subst">${remainingVars.join(<span class="hljs-string">', '</span>)}</span>. 
        Please use the 'self.emitvalue' tool to emit them now, 
        or continue working if necessary.`</span>;
        
        <span class="hljs-comment">// 把提醒作为新的用户消息发给 LLM</span>
        currentMessages = [{
            <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
            <span class="hljs-attr">parts</span>: [{ <span class="hljs-attr">text</span>: nudgeMessage }]
        }];
        
        <span class="hljs-comment">// 继续循环，不退出</span>
    }
}
</code></pre>
<h2 data-id="heading-19">完整的 subagent 执行流程</h2>
<pre><code class="hljs language-arduino" lang="arduino">开始
  ↓
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
  检查是否超时/超轮次 → 是 → 退出
    ↓ 否
  调用 LLM
    ↓
  LLM 返回工具调用？
    ├─ 是 → 执行工具 → 检查目标是否完成
    │         ├─ 是 → 退出
    │         └─ 否 → 继续循环
    │
    └─ 否（LLM 停止调用工具）
         ↓
       有预定输出要求吗？
         ├─ 没有 → 退出（认为完成）
         └─ 有 → 检查是否都输出了
                   ├─ 是 → 退出
                   └─ 否 → Nudge 提醒 → 继续循环
}
</code></pre>
<h2 data-id="heading-20">三层循环检测机制</h2>
<h3 data-id="heading-21">第一层：工具调用重复检测</h3>
<p>这是最简单直接的检测，针对 Agent 反复调用相同工具的情况。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> checkToolCallLoop(toolCall: { name: string; args: <span class="hljs-keyword">object</span> }): boolean {
    <span class="hljs-comment">// 把工具名和参数一起哈希，生成唯一标识</span>
    <span class="hljs-keyword">const</span> key = <span class="hljs-keyword">this</span>.getToolCallKey(toolCall);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lastToolCallKey === key) {
        <span class="hljs-comment">// 和上次调用完全一样，计数+1</span>
        <span class="hljs-keyword">this</span>.toolCallRepetitionCount++;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 不一样，重置计数</span>
        <span class="hljs-keyword">this</span>.lastToolCallKey = key;
        <span class="hljs-keyword">this</span>.toolCallRepetitionCount = <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-comment">// 连续5次调用相同工具+相同参数 = 循环</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.toolCallRepetitionCount &gt;= TOOL_CALL_LOOP_THRESHOLD) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>触发条件：连续 5 次调用完全相同的工具（包括参数）。</p>
<p>这种检测很严格——必须是连续的、完全相同的调用。如果中间插入了其他工具调用，计数就会重置。</p>
<h3 data-id="heading-22">第二层：内容重复检测（"咒语"检测）</h3>
<p>这是最复杂的部分，用来检测 LLM 输出重复内容的情况，就像在念咒语一样。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> checkContentLoop(content: string): boolean {
    <span class="hljs-comment">// 1. 先检查是否在特殊内容块中（代码块、表格、列表等）</span>
    <span class="hljs-keyword">const</span> numFences = (content.match(/```/g) ?? []).length;
    <span class="hljs-keyword">const</span> hasTable = /(^|\n)\s*(|.*||[|+-]{<span class="hljs-number">3</span>,})/.test(content);
    <span class="hljs-comment">// ... 检查各种格式</span>
    
    <span class="hljs-comment">// 在代码块中不检测循环（代码本来就可能有重复）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.inCodeBlock) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 2. 把新内容加入历史</span>
    <span class="hljs-keyword">this</span>.streamContentHistory += content;
    
    <span class="hljs-comment">// 3. 保持历史在 1000 字符以内</span>
    <span class="hljs-keyword">this</span>.truncateAndUpdate();
    
    <span class="hljs-comment">// 4. 分析内容块是否重复</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.analyzeContentChunksForLoop();
}
</code></pre>
<p>核心算法是滑动窗口 + 哈希检测：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> analyzeContentChunksForLoop(): boolean {
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.hasMoreChunksToProcess()) {
        <span class="hljs-comment">// 提取 50 字符的块</span>
        <span class="hljs-keyword">const</span> currentChunk = <span class="hljs-keyword">this</span>.streamContentHistory.substring(
            <span class="hljs-keyword">this</span>.lastContentIndex,
            <span class="hljs-keyword">this</span>.lastContentIndex + CONTENT_CHUNK_SIZE  <span class="hljs-comment">// 50</span>
        );
        
        <span class="hljs-comment">// 计算哈希</span>
        <span class="hljs-keyword">const</span> chunkHash = createHash(<span class="hljs-string">'sha256'</span>).update(currentChunk).digest(<span class="hljs-string">'hex'</span>);
        
        <span class="hljs-comment">// 检查这个块是否重复出现</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isLoopDetectedForChunk(currentChunk, chunkHash)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        
        <span class="hljs-comment">// 滑动窗口向前移动 1 个字符</span>
        <span class="hljs-keyword">this</span>.lastContentIndex++;
    }
}
</code></pre>
<p>判断循环的条件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> isLoopDetectedForChunk(chunk: string, hash: string): boolean {
    <span class="hljs-keyword">const</span> existingIndices = <span class="hljs-keyword">this</span>.contentStats.<span class="hljs-keyword">get</span>(hash);
    
    <span class="hljs-keyword">if</span> (!existingIndices) {
        <span class="hljs-comment">// 第一次见到这个块，记录位置</span>
        <span class="hljs-keyword">this</span>.contentStats.<span class="hljs-keyword">set</span>(hash, [<span class="hljs-keyword">this</span>.lastContentIndex]);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 验证内容确实相同（防止哈希碰撞）</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isActualContentMatch(chunk, existingIndices[<span class="hljs-number">0</span>])) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    existingIndices.push(<span class="hljs-keyword">this</span>.lastContentIndex);
    
    <span class="hljs-comment">// 需要出现至少 10 次</span>
    <span class="hljs-keyword">if</span> (existingIndices.length &lt; CONTENT_LOOP_THRESHOLD) {  <span class="hljs-comment">// 10</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 关键：这 10 次必须距离很近（平均距离 ≤ 75 字符）</span>
    <span class="hljs-keyword">const</span> recentIndices = existingIndices.slice(-CONTENT_LOOP_THRESHOLD);
    <span class="hljs-keyword">const</span> totalDistance = recentIndices[recentIndices.length - <span class="hljs-number">1</span>] - recentIndices[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> averageDistance = totalDistance / (CONTENT_LOOP_THRESHOLD - <span class="hljs-number">1</span>);
    <span class="hljs-keyword">const</span> maxAllowedDistance = CONTENT_CHUNK_SIZE * <span class="hljs-number">1.5</span>;  <span class="hljs-comment">// 75</span>
    
    <span class="hljs-keyword">return</span> averageDistance &lt;= maxAllowedDistance;
}
</code></pre>
<p>触发条件：同一个 50 字符的内容块，在很短的距离内重复出现 10 次。</p>
<h3 data-id="heading-23">第三层：LLM 智能检测</h3>
<p>这是最高级的检测，用 AI 来判断 AI 是否陷入循环。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">private</span> async <span class="hljs-title function_ invoke__">checkForLoopWithLLM</span>(<span class="hljs-attr">signal</span>: AbortSignal) {
    <span class="hljs-comment">// 取最近 20 轮对话</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">recentHistory</span> = this.config
        .<span class="hljs-title function_ invoke__">getGeminiClient</span>()
        .<span class="hljs-title function_ invoke__">getHistory</span>()
        .<span class="hljs-title function_ invoke__">slice</span>(-LLM_LOOP_CHECK_HISTORY_COUNT);  <span class="hljs-comment">// 20</span>
    
    <span class="hljs-comment">// 清理历史（去掉悬空的函数调用等）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">trimmedHistory</span> = this.<span class="hljs-title function_ invoke__">trimRecentHistory</span>(recentHistory);
    
    <span class="hljs-comment">// 让 Gemini Flash 模型分析</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">result</span> = await this.config.<span class="hljs-title function_ invoke__">getBaseLlmClient</span>().<span class="hljs-title function_ invoke__">generateJson</span>({
        <span class="hljs-attr">contents</span>: [...trimmedHistory, { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">parts</span>: [{ <span class="hljs-attr">text</span>: taskPrompt }] }],
        <span class="hljs-attr">schema</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
            <span class="hljs-attr">properties</span>: {
                <span class="hljs-attr">reasoning</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span> },
                <span class="hljs-attr">confidence</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span> }  // <span class="hljs-number">0</span>-<span class="hljs-number">1</span> 之间
            }
        },
        <span class="hljs-attr">model</span>: DEFAULT_GEMINI_FLASH_MODEL,
        <span class="hljs-attr">systemInstruction</span>: LOOP_DETECTION_SYSTEM_PROMPT
    });
    
    <span class="hljs-keyword">if</span> (result[<span class="hljs-string">'confidence'</span>] &gt; <span class="hljs-number">0.9</span>) {
        <span class="hljs-comment">// 高置信度认为是循环</span>
        console.<span class="hljs-title function_ invoke__">warn</span>(result[<span class="hljs-string">'reasoning'</span>]);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>触发时机：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">async turnStarted(signal: AbortSignal) {
    <span class="hljs-keyword">this</span>.turnsInCurrentPrompt++;
    
    <span class="hljs-keyword">if</span> (
        <span class="hljs-keyword">this</span>.turnsInCurrentPrompt &gt;= LLM_CHECK_AFTER_TURNS &amp;&amp;  <span class="hljs-comment">// 至少 30 轮</span>
        <span class="hljs-keyword">this</span>.turnsInCurrentPrompt - <span class="hljs-keyword">this</span>.lastCheckTurn &gt;= <span class="hljs-keyword">this</span>.llmCheckInterval
    ) {
        <span class="hljs-keyword">this</span>.lastCheckTurn = <span class="hljs-keyword">this</span>.turnsInCurrentPrompt;
        <span class="hljs-keyword">return</span> await <span class="hljs-keyword">this</span>.checkForLoopWithLLM(signal);
    }
}
</code></pre>
<ul>
<li>必须执行超过 30 轮才开始检查（避免误判）</li>
<li>不是每轮都检查，有间隔（默认 3 轮）</li>
<li>间隔会根据置信度动态调整（5-15 轮）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 动态调整检查频率</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">llmCheckInterval</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(
    <span class="hljs-variable constant_">MIN_LLM_CHECK_INTERVAL</span> +  <span class="hljs-comment">// 5</span>
    (<span class="hljs-variable constant_">MAX_LLM_CHECK_INTERVAL</span> - <span class="hljs-variable constant_">MIN_LLM_CHECK_INTERVAL</span>) * (<span class="hljs-number">1</span> - result[<span class="hljs-string">'confidence'</span>])
    <span class="hljs-comment">// 置信度越高，检查越频繁</span>
);
</code></pre>
<h2 data-id="heading-24">三种循环类型</h2>
<p>系统定义了三种循环类型：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">LoopType</span> {
    CONSECUTIVE_IDENTICAL_TOOL_CALLS,  <span class="hljs-comment">// 连续相同工具调用</span>
    CHANTING_IDENTICAL_SENTENCES,      <span class="hljs-comment">// 重复输出相同内容</span>
    LLM_DETECTED_LOOP                  <span class="hljs-comment">// LLM 检测到的逻辑循环</span>
}
</code></pre>
<p>每种都有不同的检测方法和触发条件。</p>
<p>这比较适合处理长对话场景，既能有效检测循环，又不会因为过于敏感而误判正常的迭代操作。</p>
<h2 data-id="heading-25">小结</h2>
<p>AI Agent 的停止策略是一个容易被忽视但极其重要的技术问题。从原理上看，Agent 就是一个大循环，不断调用 LLM 和工具来完成任务，但如果没有合理的停止机制，就会出现无限循环浪费资源，或者过早停止无法完成任务的问题。常见的停止方案包括硬性限制（步数、时间、API调用次数）、任务完成检测、显式停止信号、循环检测、错误累积和用户中断等，实际应用中需要组合使用多种策略。</p>
<p>OpenManus 采用了相对简单直接的设计：给每个 Agent 配备 terminate 工具，让 LLM 自己决定何时停止，同时用状态机管理生命周期，配合步数限制作为保底，并确保无论如何停止都会正确清理资源。</p>
<p>而 Gemini CLI 的设计更加精巧，核心是声明式输出系统——预先定义需要什么输出，只有全部输出才算完成，如果 Agent 停止调用工具但还有变量未输出，系统会通过 Nudge 机制温和提醒；在循环检测上，Gemini 实现了三层防护：工具调用重复检测（连续5次相同调用）、内容重复检测（滑动窗口+哈希算法检测"咒语"现象）、以及用 LLM 分析对话历史判断是否陷入逻辑循环。</p>
<p>实践中的关键是不要依赖单一停止机制，要组合使用多种策略形成多层防护，给 LLM 明确的停止指引，为不同类型的停止原因提供清晰的用户反馈，并确保资源能够可靠清理。停止策略的本质是在"让 Agent 完成任务"和"防止失控"之间找到平衡点。</p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[⏰前端周刊第447期（2025年12月28日–2026年1月3日）～新年好～]]></title>    <link>https://juejin.cn/post/7591703562134519842</link>    <guid>https://juejin.cn/post/7591703562134519842</guid>    <pubDate>2026-01-06T00:34:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591703562134519842" data-draft-id="7591703562134503458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="⏰前端周刊第447期（2025年12月28日–2026年1月3日）～新年好～"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-06T00:34:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ⏰前端周刊第447期（2025年12月28日–2026年1月3日）～新年好～
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:34:50.000Z" title="Tue Jan 06 2026 00:34:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>📢 <strong>宣言</strong>：<strong>每周更新国外论坛的前端热门文章，推荐大家阅读/翻译，紧跟时事，掌握前端技术动态，也为写作或突破新领域提供灵感~</strong></p>
<p>欢迎大家访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">github.com/TUARAN/fron…</a>
顺手点个 ⭐ star 支持，是我们持续输出的续航电池🔋✨！</p>
<p>在线网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffwdc.pages.dev%2F" target="_blank" title="https://fwdc.pages.dev/" ref="nofollow noopener noreferrer">fwdc.pages.dev/</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2506018f41948a6b94a2c8b3fb0d5d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768264490&amp;x-signature=81FACm2ZdQLtYOM5y6ZjtMVaKys%3D" alt="前端周刊封面" loading="lazy"/></p>
<hr/>
<p>💬 <strong>推荐语</strong></p>
<p>新年第一期更偏“趋势 + 实操 + 工程卫生”。</p>
<p>Web 开发部分从 2026 年趋势、Astro 月度更新与 HTML5 文档大纲的历史终章出发，同时复盘 React2Shell 安全漏洞的来龙去脉，并讨论分页是否该跳转新页面与 Hotwire 这类“HTML 驱动交互”的路线。工具与性能栏目聚焦更轻量的 Lint 体验、常用 DevTools 能力与性能排查方法论（含对“浅会话”SPA、第三方单点故障等问题的反思）；最后在 Web Components、CSS 与各框架生态（Svelte/React/Angular/TypeScript）里补齐组件化与类型安全的最新实践。</p>
<hr/>
<h2 data-id="heading-0">🗂 本期精选目录</h2>
<h3 data-id="heading-1">🧭 Web 开发</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.logrocket.com%2F8-trends-web-dev-2026%2F" target="_blank" title="https://blog.logrocket.com/8-trends-web-dev-2026/" ref="nofollow noopener noreferrer">The 8 trends that will define web development in 2026</a>：总结 2026 年可能主导 Web 开发方向的 8 个趋势，用于技术选型与团队规划参考。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fastro.build%2Fblog%2Fwhats-new-december-2025%2F" target="_blank" title="https://astro.build/blog/whats-new-december-2025/" ref="nofollow noopener noreferrer">What’s new in Astro — December 2025</a>：Astro 2025 年 12 月更新速览：新特性、改进与生态动态。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tempertemper.net%2Fblog%2Fthe-final-nail-in-the-html5-document-outline-coffin" target="_blank" title="https://www.tempertemper.net/blog/the-final-nail-in-the-html5-document-outline-coffin" ref="nofollow noopener noreferrer">The final nail in the HTML5 document outline coffin</a>：回顾并确认 HTML5 文档大纲（outline）机制的“最后一钉”，澄清围绕标题层级与语义结构的误解。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.csoonline.com%2Farticle%2F4111888%2Freact2shell-anatomy-of-a-max-severity-flaw-that-sent-shockwaves-through-the-web.html" target="_blank" title="https://www.csoonline.com/article/4111888/react2shell-anatomy-of-a-max-severity-flaw-that-sent-shockwaves-through-the-web.html" ref="nofollow noopener noreferrer">React2Shell: Anatomy of a max-severity flaw that sent shockwaves through the web</a>：拆解 React2Shell 这类高危漏洞的成因、影响面与修复要点，帮助理解供应链/框架级风险。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tempertemper.net%2Fblog%2Fshould-pagination-take-you-to-a-new-page" target="_blank" title="https://www.tempertemper.net/blog/should-pagination-take-you-to-a-new-page" ref="nofollow noopener noreferrer">Should pagination take you to a new page?</a>：讨论分页交互到底该“换页”还是“局部更新”，从可用性、可访问性与预期一致性出发给出权衡。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoworld.com%2Farticle%2F4100499%2Fintro-to-hotwire-interactive-javascript-built-from-html.html" target="_blank" title="https://www.infoworld.com/article/4100499/intro-to-hotwire-interactive-javascript-built-from-html.html" ref="nofollow noopener noreferrer">Intro to Hotwire: HTMX alternative for developing supercharged, responsive web applications.</a>：Hotwire 入门：以 HTML 为中心构建交互式应用的另一条路线，作为 HTMX 的备选/对照思路。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftympanus.net%2Fcodrops%2F2026%2F01%2F04%2Fefecto-building-real-time-ascii-and-dithering-effects-with-webgl-shaders%2F" target="_blank" title="https://tympanus.net/codrops/2026/01/04/efecto-building-real-time-ascii-and-dithering-effects-with-webgl-shaders/" ref="nofollow noopener noreferrer">Efecto: Building Real-Time ASCII and Dithering Effects with WebGL Shaders</a>：用 WebGL Shader 实时实现 ASCII 与抖动（dithering）视觉效果的完整拆解与实现路径。</li>
</ul>
<h4 data-id="heading-2">🛠 工具</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.flint.fyi%2Fblog%2Fintroducing-flint%2F" target="_blank" title="https://www.flint.fyi/blog/introducing-flint/" ref="nofollow noopener noreferrer">Introducing Flint — A fast, friendly linter for JavaScript, TypeScript, and more.</a>：Flint 代码检查器介绍：主打更快、更友好的 lint 体验，覆盖 JS/TS 等多语言场景。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcalendar.perfplanet.com%2F2025%2Fchrome-devtools-all-the-time%2F" target="_blank" title="https://calendar.perfplanet.com/2025/chrome-devtools-all-the-time/" ref="nofollow noopener noreferrer">Chrome DevTools Features I Use All the Time (and Why You Should Too)</a>：作者常用的 DevTools 功能清单与使用理由，适合查漏补缺提升调试效率。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.blog%2F2025%2F12%2F30%2Fa-new-era-of-stack-overflow%2F" target="_blank" title="https://stackoverflow.blog/2025/12/30/a-new-era-of-stack-overflow/" ref="nofollow noopener noreferrer">A new era of Stack Overflow</a>：Stack Overflow 的新阶段与产品方向变化，面向开发者社区生态的观察。</li>
</ul>
<h4 data-id="heading-3">⚡ 性能</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcalendar.perfplanet.com%2F2025%2Fthe-curious-case-of-the-shallow-session-spas%2F" target="_blank" title="https://calendar.perfplanet.com/2025/the-curious-case-of-the-shallow-session-spas/" ref="nofollow noopener noreferrer">The Curious Case of the Shallow Session SPAs</a>：分析“浅会话”SPA 的典型表现与潜在代价，反思留存、性能与体验之间的取舍。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcalendar.perfplanet.com%2F2025%2Fteaching-agents-about-performance-insights%2F" target="_blank" title="https://calendar.perfplanet.com/2025/teaching-agents-about-performance-insights/" ref="nofollow noopener noreferrer">Teaching Agents about Performance insights</a>：探讨如何把性能洞察与排查经验传递给 AI/Agent，让自动化分析更可靠、可复用。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcalendar.perfplanet.com%2F2025%2Fthird-parties-and-single-points-of-failure%2F" target="_blank" title="https://calendar.perfplanet.com/2025/third-parties-and-single-points-of-failure/" ref="nofollow noopener noreferrer">Third Parties and Single Points of Failure</a>：第三方依赖如何形成单点故障（SPOF），以及在架构与监控层面的缓解策略。</li>
</ul>
<h4 data-id="heading-4">🧩 Web Components</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aaron-gustafson.com%2Fnotebook%2Fa-web-component-starter-template%2F" target="_blank" title="https://www.aaron-gustafson.com/notebook/a-web-component-starter-template/" ref="nofollow noopener noreferrer">A Production-Ready Web Component Starter Template</a>：一个更贴近生产环境的 Web Component 脚手架/模板，覆盖工程化与发布所需的基础要素。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aaron-gustafson.com%2Fnotebook%2Ffullscreen-video-and-iframes-made-easy%2F" target="_blank" title="https://www.aaron-gustafson.com/notebook/fullscreen-video-and-iframes-made-easy/" ref="nofollow noopener noreferrer">Fullscreen Video and Iframes Made Easy with Web Component</a>：用 Web Component 封装全屏视频与 iframe 的常见交互与兼容细节，降低集成成本。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fcustom-elements-with-lit-html%2F" target="_blank" title="https://frontendmasters.com/blog/custom-elements-with-lit-html/" ref="nofollow noopener noreferrer">How I Write Custom Elements with lit-html</a>：用 lit-html 编写自定义元素的实践路线：模板渲染、状态更新与组件组织方式。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fheydonworks.com%2Farticle%2Fdynamically-loading-custom-elements%2F" target="_blank" title="https://heydonworks.com/article/dynamically-loading-custom-elements/" ref="nofollow noopener noreferrer">How To Dynamically Install Custom Elements</a>：动态加载/注册 Custom Elements 的方法与注意事项，兼顾性能与渐进增强。</li>
</ul>
<h3 data-id="heading-5">🎨 CSS</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fimportant-and-css-custom-properties%2F" target="_blank" title="https://frontendmasters.com/blog/important-and-css-custom-properties/" ref="nofollow noopener noreferrer">!important and CSS Custom Properties</a>：讨论 <code>!important</code> 与 CSS 自定义属性（变量）结合时的层叠与覆盖策略，避免样式失控。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffractaledmind.com%2F2026%2F01%2F02%2Fwriting-tailwind-compatible-semantic-css%2F" target="_blank" title="https://fractaledmind.com/2026/01/02/writing-tailwind-compatible-semantic-css/" ref="nofollow noopener noreferrer">Writing Tailwind-compatible Semantic CSS</a>：如何写“语义化但又兼容 Tailwind”的 CSS：在工具类与语义层之间找到可维护的平衡。</li>
</ul>
<h3 data-id="heading-6">💡 JavaScript</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fthenewstack.io%2Fwhy-developers-are-ditching-frameworks-for-vanilla-javascript%2F" target="_blank" title="https://thenewstack.io/why-developers-are-ditching-frameworks-for-vanilla-javascript/" ref="nofollow noopener noreferrer">Why Developers Are Ditching Frameworks for Vanilla JavaScript</a>：为什么有些团队在回归原生 JS：从复杂度、性能、长期维护与依赖风险角度讨论。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsvelte.dev%2Fblog%2Fwhats-new-in-svelte-january-2026" target="_blank" title="https://svelte.dev/blog/whats-new-in-svelte-january-2026" ref="nofollow noopener noreferrer">What’s new in Svelte: January 2026</a>：Svelte 2026 年 1 月更新汇总：新能力与生态进展速览。</li>
</ul>
<h4 data-id="heading-7">🧷 TypeScript</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhackers.pub%2F%40hongminhee%2F2026%2Ftypescript-sync-async-type-safety" target="_blank" title="https://hackers.pub/@hongminhee/2026/typescript-sync-async-type-safety" ref="nofollow noopener noreferrer">Designing type-safe sync/async mode support in TypeScript</a>：在 TS 中设计同时支持同步/异步模式的类型安全 API：约束、推断与调用体验的权衡。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftkdodo.eu%2Fblog%2Fbuilding-type-safe-compound-components" target="_blank" title="https://tkdodo.eu/blog/building-type-safe-compound-components" ref="nofollow noopener noreferrer">Building Type-Safe Compound Components</a>：构建类型安全的 Compound Components（组合组件）模式：让组合 API 更易用、更不易写错。</li>
</ul>
<h4 data-id="heading-8">⚛️ React</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhackyourmom.com%2Fen%2Fnovyny%2Fbotnet-rondodox-ekspluatuye-vrazlyvist-react2shell-dlya-zlamu-serveriv-next-js%2F" target="_blank" title="https://hackyourmom.com/en/novyny/botnet-rondodox-ekspluatuye-vrazlyvist-react2shell-dlya-zlamu-serveriv-next-js/" ref="nofollow noopener noreferrer">RondoDox botnet exploits React2Shell flaw to breach Next.js servers</a>：React2Shell 被用于攻击 Next.js 服务的案例报道，提醒及时修复与加强防护。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjsdev.space%2Freact-form-primitives%2F" target="_blank" title="https://jsdev.space/react-form-primitives/" ref="nofollow noopener noreferrer">Designing Predictable and Maintainable Forms in React</a>：用“表单原语”的思路设计可预测、可维护的 React 表单：状态边界、校验与可复用结构。</li>
</ul>
<h4 data-id="heading-9">🅰️ Angular</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.telerik.com%2Fblogs%2Fdata-fetching-modern-angular" target="_blank" title="https://www.telerik.com/blogs/data-fetching-modern-angular" ref="nofollow noopener noreferrer">Data Fetching in Modern Angular</a>：现代 Angular 的数据获取实践：常见方案与在工程中落地时的注意点。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fthis-is-angular%2Fng-news-angular-in-2025-307a" target="_blank" title="https://dev.to/this-is-angular/ng-news-angular-in-2025-307a" ref="nofollow noopener noreferrer">Ng-News: Angular in 2025</a>：回顾 2025 年 Angular 的关键变化与生态动态，帮助快速补齐近况。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学生图书馆管理系统第二弹]]></title>    <link>https://juejin.cn/post/7591719013489524774</link>    <guid>https://juejin.cn/post/7591719013489524774</guid>    <pubDate>2026-01-06T00:38:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591719013489524774" data-draft-id="7591708519449870345" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学生图书馆管理系统第二弹"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-06T00:38:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃马铃薯长大的土豆"/> <meta itemprop="url" content="https://juejin.cn/user/1162661349831369"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学生图书馆管理系统第二弹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1162661349831369/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃马铃薯长大的土豆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:38:45.000Z" title="Tue Jan 06 2026 00:38:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一篇纯分享代码的文章（纯展示），文章的开头先说明一下本文章的代码来源于B站博主，更详细的请去B站观看</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a3ece4c8fe74f7fb392a0e843a21f25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6ams6ZOD6Jav6ZW_5aSn55qE5Zyf6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768264725&amp;x-signature=T16gLC3o9N%2BXTU6dBUhd4L2pt78%3D" alt="屏幕截图 2026-01-05 154859.png" loading="lazy"/>
首先展示一下主播建的文件夹</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/702e7ec432e94d458b7b16574e0fab1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6ams6ZOD6Jav6ZW_5aSn55qE5Zyf6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768264725&amp;x-signature=qs8JLCDoEvKE16uwF7zvmb%2B7fuY%3D" alt="屏幕截图 2026-01-06 082112.png" loading="lazy"/></p>
<p>没错主播为了写这个建立了三个文件夹，至于原因请参考上一篇文章。（在这里说一下请大家观看视频的时候尽量和B站的博主写的一样不要加入自己的小巧思）好了下面就是代码展示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94c18eac54e2426e8e8c7ee0b593cf7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6ams6ZOD6Jav6ZW_5aSn55qE5Zyf6LGG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768264725&amp;x-signature=uzC6f6He2erWO4XwZocBG1iO8%2Bc%3D" alt="屏幕截图 2026-01-06 083324.png" loading="lazy"/></p>
<pre><code class="hljs">fan,123,普通用户
admin,123,管理员
chen,123,普通用户
TEST,123,普通用户
fain,123,普通用户
</code></pre>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">1</span>,心灵漏洞指南,老卡,<span class="hljs-literal">true</span>
<span class="hljs-number">2</span>,乌托邦说明书,帕拉图,<span class="hljs-literal">true</span>
<span class="hljs-number">3</span>,火星人成长日记,艾工,<span class="hljs-literal">true</span>
<span class="hljs-number">4</span>,大胡子文豪外史,林老师,<span class="hljs-literal">true</span>
<span class="hljs-number">5</span>,奶奶的回忆录像带,杨奶奶,<span class="hljs-literal">true</span>
<span class="hljs-number">6</span>,清代职场达人笔记,张史官,<span class="hljs-literal">true</span>
<span class="hljs-number">7</span>,心学使用手册,山叔,<span class="hljs-literal">true</span>
<span class="hljs-number">8</span>,晚年打怪日志,戴奶奶,<span class="hljs-literal">true</span>
<span class="hljs-number">9</span>,飞出山谷备忘录,塔拉,<span class="hljs-literal">true</span>
<span class="hljs-number">10</span>,红猫时代的幕后笔记,傅教授,<span class="hljs-literal">true</span>
<span class="hljs-number">11</span>,心灵漏洞指南,老卡,<span class="hljs-literal">true</span>
</code></pre>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">fan,1,心灵漏洞指南,2026-01-03T20:24:24.926523400,2026-01-03T21:31:44.418616</span>
</code></pre>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> org.app

<span class="hljs-keyword">import</span> org.app.models.{BookModel, UserModel}
<span class="hljs-keyword">import</span> org.app.service.{BookService, UserService}

<span class="hljs-keyword">import</span> scala.io.StdIn
<span class="hljs-keyword">import</span> scala.io.StdIn.readLine

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LibrarayPresentation</span> {

  <span class="hljs-keyword">private</span> <span class="hljs-type">val</span> <span class="hljs-variable">BookService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BookService</span>()
  <span class="hljs-keyword">private</span> <span class="hljs-type">val</span> <span class="hljs-variable">UserService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserService</span>()

  <span class="hljs-comment">// 辅助方法，输入图书的信息，返回一个BookModel对象</span>
  <span class="hljs-keyword">private</span> def <span class="hljs-title function_">inputBookInfo</span><span class="hljs-params">()</span>: BookModel = {
    println(<span class="hljs-string">"请输入图书的名称:"</span>)
    <span class="hljs-type">val</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> readLine().trim
    <span class="hljs-title function_">println</span><span class="hljs-params">(<span class="hljs-string">"请输入图书的作者:"</span>)</span>
    <span class="hljs-type">val</span> <span class="hljs-variable">author</span> <span class="hljs-operator">=</span> readLine().trim
    <span class="hljs-title function_">println</span><span class="hljs-params">(<span class="hljs-string">"请输入图书是否可以外接（true/false）:"</span>)</span>
    <span class="hljs-type">val</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> StdIn.readBoolean()
    <span class="hljs-comment">// 初始设置编号为0</span>
    BookModel(<span class="hljs-number">0</span>, name, author, available)
  }
  <span class="hljs-comment">// 显示游客的菜单</span>
  def <span class="hljs-title function_">showVisitorMenu</span><span class="hljs-params">()</span>: Unit = {
    <span class="hljs-type">var</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    <span class="hljs-title function_">while</span> <span class="hljs-params">(running)</span> {
      println(<span class="hljs-string">"欢迎来到我的图书管理系统，请选择"</span>)
      println(<span class="hljs-string">"1. 查看所有图书"</span>)
      println(<span class="hljs-string">"2. 查询图书"</span>)
      println(<span class="hljs-string">"3. 登录"</span>)
      println(<span class="hljs-string">"4. 离开"</span>)

      <span class="hljs-comment">// 获取用户的操作</span>
      <span class="hljs-type">val</span> <span class="hljs-variable">choice</span> <span class="hljs-operator">=</span> StdIn.readLine().trim
      choice match {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"1"</span> =&gt;
          <span class="hljs-comment">// TODO 查看所有图书</span>
          <span class="hljs-comment">// 调用业务逻辑层的方法</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">results</span> <span class="hljs-operator">=</span> BookService.searchBooks(<span class="hljs-string">""</span>)
          <span class="hljs-keyword">if</span>(results.nonEmpty){
            results.foreach(println)
          } <span class="hljs-keyword">else</span> {
            println(<span class="hljs-string">"没有找到图书"</span>)
          }
        <span class="hljs-keyword">case</span> <span class="hljs-string">"2"</span> =&gt;
        <span class="hljs-comment">// 提示用户输入查询关键字</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> readLine(<span class="hljs-string">"请输入查询关键字(书名, 作者):"</span>).trim
          <span class="hljs-comment">// 根据关键字去查询图书列表，找到满足条件的书</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">results</span> <span class="hljs-operator">=</span> BookService.searchBooks(query)
          <span class="hljs-comment">// 显示出来</span>
          <span class="hljs-keyword">if</span>(results.nonEmpty){
            println(<span class="hljs-string">"======查询图书的结果======="</span>)
            results.foreach(println)
          } <span class="hljs-keyword">else</span> {
            println(<span class="hljs-string">"没有找到图书"</span>)
          }

        <span class="hljs-keyword">case</span> <span class="hljs-string">"3"</span> =&gt;
          println(<span class="hljs-string">"请输入用户名: "</span>)
          <span class="hljs-type">val</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> StdIn.readLine().trim
          <span class="hljs-title function_">println</span><span class="hljs-params">(<span class="hljs-string">"请输入密码: "</span>)</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> StdIn.readLine().trim
          <span class="hljs-comment">// 调用Service的方法，进行登录</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">userOpt</span> <span class="hljs-operator">=</span> UserService.authenticateUser(username, password)
          <span class="hljs-keyword">if</span>(userOpt.isEmpty){
            println(<span class="hljs-string">"用户名或密码错误"</span>)
          } <span class="hljs-keyword">else</span> {
            println(<span class="hljs-string">"登录成功"</span>)
            <span class="hljs-comment">// 登录成功，显示登录用户的菜单</span>
            <span class="hljs-type">val</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userOpt.get
            user.role match {
              <span class="hljs-keyword">case</span> <span class="hljs-string">"管理员"</span> =&gt; showAdminMenu(user)
              <span class="hljs-keyword">case</span> <span class="hljs-string">"普通用户"</span> =&gt; showUserMenu(user)
            }
          }
        <span class="hljs-keyword">case</span> <span class="hljs-string">"4"</span> =&gt;
          running = <span class="hljs-literal">false</span>
          <span class="hljs-title function_">println</span><span class="hljs-params">(<span class="hljs-string">"感谢你的使用, 下次再见"</span>)</span>
        <span class="hljs-type">case</span> <span class="hljs-variable">_</span> <span class="hljs-operator">=</span>&gt; println(<span class="hljs-string">"无效的选择"</span>)
      }
    }
  }

  <span class="hljs-comment">// 显示管理员的菜单</span>
  def <span class="hljs-title function_">showAdminMenu</span><span class="hljs-params">(user:UserModel)</span>: Unit = {
    <span class="hljs-type">var</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    <span class="hljs-title function_">while</span> <span class="hljs-params">(running)</span> {
      println(s<span class="hljs-string">"欢迎管理员:${user.username},来到我的图书管理系统，请选择"</span>)
      println(<span class="hljs-string">"1. 添加图书"</span>)
      println(<span class="hljs-string">"2. 查询图书"</span>)
      println(<span class="hljs-string">"3. 添加用户"</span>)
      println(<span class="hljs-string">"4. 退出"</span>)

      <span class="hljs-comment">// 获取用户的操作</span>
      <span class="hljs-type">val</span> <span class="hljs-variable">choice</span> <span class="hljs-operator">=</span> StdIn.readLine().trim
      choice match {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"1"</span> =&gt;
          <span class="hljs-comment">// 1. 获取图书信息-书名，作者，状态</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> inputBookInfo()
          <span class="hljs-comment">// 2. 调用service层的方法，做添加到books.txt中操作</span>
          BookService.addBook(book)
          println(s<span class="hljs-string">"图书《${book.name}》添加成功"</span>)
        <span class="hljs-keyword">case</span> <span class="hljs-string">"2"</span> =&gt; <span class="hljs-comment">// println("查询图书")</span>
          <span class="hljs-comment">// 提示用户输入查询关键字</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> readLine(<span class="hljs-string">"请输入查询关键字(书名, 作者):"</span>).trim
          <span class="hljs-comment">// 根据关键字去查询图书列表，找到满足条件的书</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">results</span> <span class="hljs-operator">=</span> BookService.searchBooks(query)
          <span class="hljs-comment">// 显示出来</span>
          <span class="hljs-keyword">if</span>(results.nonEmpty){
            println(<span class="hljs-string">"======查询图书的结果======="</span>)
            results.foreach(println)
          } <span class="hljs-keyword">else</span> {
            println(<span class="hljs-string">"没有找到图书"</span>)
          }
        <span class="hljs-keyword">case</span> <span class="hljs-string">"3"</span> =&gt;
          <span class="hljs-comment">// 1. 获取用户信息-用户名</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> StdIn.readLine(<span class="hljs-string">"请输入用户名: "</span>)
          <span class="hljs-comment">// 2. 调用service层的方法，做添加到users.txt中操作</span>
          <span class="hljs-keyword">if</span>(UserService.addUser(username)){
            println(<span class="hljs-string">"用户添加成功"</span>)
          } <span class="hljs-keyword">else</span> {
            println(<span class="hljs-string">"用户添加失败"</span>)
          }
        <span class="hljs-keyword">case</span> <span class="hljs-string">"4"</span> =&gt; running = <span class="hljs-literal">false</span>
        <span class="hljs-type">case</span> <span class="hljs-variable">_</span> <span class="hljs-operator">=</span>&gt; println(<span class="hljs-string">"无效的选择"</span>)
      }
    }
  }
  <span class="hljs-comment">// 显示登录用户的菜单</span>
  def <span class="hljs-title function_">showUserMenu</span><span class="hljs-params">(user:UserModel)</span>: Unit = {
    <span class="hljs-type">var</span> <span class="hljs-variable">running</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
    <span class="hljs-title function_">while</span> <span class="hljs-params">(running)</span> {
      println(s<span class="hljs-string">"欢迎用户:${user.username},来到我的图书管理系统，请选择"</span>)
      println(<span class="hljs-string">"1. 借阅图书"</span>)
      println(<span class="hljs-string">"2. 查询借阅记录"</span>)
      println(<span class="hljs-string">"3. 还书"</span>)
      println(<span class="hljs-string">"4. 退出"</span>)

      <span class="hljs-comment">// 获取用户的操作</span>
      <span class="hljs-type">val</span> <span class="hljs-variable">choice</span> <span class="hljs-operator">=</span> StdIn.readLine().trim
      choice match {
        <span class="hljs-keyword">case</span> <span class="hljs-string">"1"</span> =&gt;
          <span class="hljs-comment">// UI: 提示用户输入图书的ID。校验：判断是不是整数</span>
          <span class="hljs-keyword">try</span> {
            <span class="hljs-type">val</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> readLine(<span class="hljs-string">"请输入图书的ID:"</span>).toInt
            BookService.borrowBook(user.username,id)
          } <span class="hljs-keyword">catch</span> {
            <span class="hljs-keyword">case</span> e:Exception =&gt;
              println(e)
              println(<span class="hljs-string">"输入的图书ID无效"</span>)
          }
        <span class="hljs-keyword">case</span> <span class="hljs-string">"2"</span> =&gt;
          <span class="hljs-comment">// 在BookService中实现根据用户名去查询借阅图书</span>
          <span class="hljs-type">val</span> <span class="hljs-variable">borrowRecords</span> <span class="hljs-operator">=</span> BookService.queryBorrowRecords(user.username)
          <span class="hljs-comment">// 判断是否为空</span>
          <span class="hljs-keyword">if</span>(borrowRecords.isEmpty){
            println(<span class="hljs-string">"没有借阅记录"</span>)
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 遍历借阅记录</span>
            <span class="hljs-comment">// println("查询结果，一共借了？本，换了？本，？本未归还")</span>
            <span class="hljs-keyword">for</span>(record &lt;- borrowRecords){
              <span class="hljs-type">val</span> <span class="hljs-variable">returnDate</span> <span class="hljs-operator">=</span> record.returnDate.getOrElse(<span class="hljs-string">"未归还"</span>)
              println(s<span class="hljs-string">"书名：${record.bookName} 借阅时间：${record.borrowDate}，归还日期：${returnDate}"</span>)
            }
          }
        <span class="hljs-keyword">case</span> <span class="hljs-string">"3"</span> =&gt;
          <span class="hljs-keyword">try</span> {
            <span class="hljs-type">val</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> readLine(<span class="hljs-string">"请输入要归还的图书ID:"</span>).toInt
            <span class="hljs-title function_">if</span><span class="hljs-params">(BookService.returnBook(user.username, id)</span>){
              println(<span class="hljs-string">"归还图书成功"</span>)
            } <span class="hljs-keyword">else</span> {
              println(<span class="hljs-string">"归还图书失败"</span>)
            }
          } <span class="hljs-keyword">catch</span> {
            <span class="hljs-keyword">case</span> e:Exception =&gt;
              println(e)
              println(<span class="hljs-string">"输入的图书ID无效"</span>)
          }
        <span class="hljs-keyword">case</span> <span class="hljs-string">"4"</span> =&gt; running = <span class="hljs-literal">false</span>
        <span class="hljs-type">case</span> <span class="hljs-variable">_</span> <span class="hljs-operator">=</span>&gt; println(<span class="hljs-string">"无效的选择"</span>)
      }
    }
  }

  def <span class="hljs-title function_">showMenu</span><span class="hljs-params">()</span>: Unit = {
    showVisitorMenu()
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 8.5 管道操作符 (|>) 告别嵌套函数地狱，写出清晰的数据管道]]></title>    <link>https://juejin.cn/post/7591697558377267242</link>    <guid>https://juejin.cn/post/7591697558377267242</guid>    <pubDate>2026-01-06T00:47:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591697558377267242" data-draft-id="7591672090790887443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 8.5 管道操作符 (|&gt;) 告别嵌套函数地狱，写出清晰的数据管道"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-06T00:47:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 8.5 管道操作符 (|&gt;) 告别嵌套函数地狱，写出清晰的数据管道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-06T00:47:19.000Z" title="Tue Jan 06 2026 00:47:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 8.5 管道操作符 (|&gt;) 告别嵌套函数地狱，写出清晰的数据管道</h2>
<p>我消失了一阵——故意的。年底冲刺完，假期认真休息了：断网、放慢节奏，允许自己暂时不想代码。</p>
<p>现在是一月初，感觉该带点新东西回来了。PHP 8.5 来了，虽然改进不少，但有个功能对日常可读性特别突出：管道操作符 (<code>|&gt;</code>)。</p>
<p>可以把它想成"让我的转换变可读"按钮。它让你从左到右写数据处理步骤，不用把它们埋在嵌套括号里。如果你写过（或继承过）<code>foo(bar(baz(trim($x))))</code> 这种代码，你已经知道为什么这很重要了。</p>
<p>下面用实际例子拆解——字符串、数组、错误处理——最后给个简单的重构清单，让你能安全地采用它。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fphp85-pipe-operator-clean-data-pipelines" target="_blank" title="https://catchadmin.com/post/2026-01/php85-pipe-operator-clean-data-pipelines" ref="nofollow noopener noreferrer">原文 PHP 8.5 管道操作符 (|&gt;) 告别嵌套函数地狱，写出清晰的数据管道</a></p>
<h3 data-id="heading-1">日常问题：嵌套调用 vs 顺序步骤</h3>
<p>写过一段时间 PHP，你可能见过这种代码：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">foo</span>(<span class="hljs-title function_ invoke__">bar</span>(<span class="hljs-title function_ invoke__">baz</span>(<span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$input</span>)))));
</code></pre>
<p>能跑。但也是那种让你在 review 时停下来、眯眼、默默从里往外重新解析括号的代码——像在做脑力体操。</p>
<p>PHP 开发者历史上有两种常见处理方式：</p>
<ul>
<li>嵌套函数调用（长了就难读）</li>
<li>逐步临时变量（更清晰，但有时啰嗦）</li>
</ul>
<p>PHP 8.5 引入第三种选择：管道操作符 (<code>|&gt;</code>)，让你从左到右写转换，跟你口头解释逻辑的方式一样。</p>
<p>不再是"取输入，小写，trim，验证……"埋在括号里，你可以写：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$email</span> = <span class="hljs-variable">$input</span>
    |&gt; <span class="hljs-title function_ invoke__">trim</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...)
    |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-variable">$v</span></span>) =&gt;</span> <span class="hljs-comment">/* validate */</span> <span class="hljs-variable">$v</span>);
</code></pre>
<p>这篇文章是管道操作符的实战教程——不会把你的代码库变成时髦但难读的"函数式汤"。</p>
<p>概括地说，管道操作符把左边的值传给右边的单参数 callable，产出 callable 的返回值。</p>
<h3 data-id="heading-2">核心概念：把前一个结果喂给下一个 callable</h3>
<p>PHP 8.5 里，管道操作符这样求值：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$result</span> = <span class="hljs-variable">$value</span> |&gt; <span class="hljs-title function_ invoke__">someCallable</span>(...);
</code></pre>
<p>逻辑上等于：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">someCallable</span>(<span class="hljs-variable">$value</span>);
</code></pre>
<p>链式调用才是它有用的地方：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$result</span> = <span class="hljs-variable">$value</span>
    |&gt; <span class="hljs-title function_ invoke__">firstStep</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">secondStep</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">thirdStep</span>(...);
</code></pre>
<p>每个阶段接收上一阶段的输出。</p>
<h4 data-id="heading-3">右边什么算 callable？</h4>
<p>右边可以是任何接受一个参数的 callable，包括：</p>
<ul>
<li>一等公民 callable 如 <code>trim(...)</code>、<code>strlen(...)</code></li>
<li>闭包/箭头函数如 <code>(fn ($x) =&gt; ...)</code></li>
<li>可调用对象（<code>__invoke()</code>）</li>
<li>实例方法 callable 如 <code>$obj-&gt;method(...)</code></li>
<li>静态方法 callable 如 <code>ClassName::method(...)</code></li>
</ul>
<p>关键规则：一个输入值流过去。</p>
<p>PHP 手册明确指出右边的 callable 必须接受单个参数，多于一个必需参数的函数直接用不了。</p>
<p>这个规则决定了你实际怎么写管道。后面会看到处理"多参数"函数的模式。</p>
<h3 data-id="heading-4">基础管道：字符串 → trim → 小写 → 验证</h3>
<p>来构建一个能直接放进项目的东西：一个小的邮箱规范化管道，同时验证并在失败时报错。</p>
<h4 data-id="heading-5">规范化</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-variable">$rawEmail</span> = <span class="hljs-string">"  Alice.Example+promo@GMAIL.com  "</span>;
<span class="hljs-variable">$normalized</span> = <span class="hljs-variable">$rawEmail</span>
    |&gt; <span class="hljs-title function_ invoke__">trim</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$normalized</span>;
<span class="hljs-comment">// "alice.example+promo@gmail.com"</span>
</code></pre>
<p>目前看起来像方法链——但它作用于普通字符串，不是对象。</p>
<h4 data-id="heading-6">验证（无效时停止管道）</h4>
<p><code>filter_var()</code> 是个好例子，因为验证不只是另一个"转换"。它可能失败。</p>
<p>而且 <code>filter_var($value, FILTER_VALIDATE_EMAIL)</code> 需要第二个参数才有意义。管道只传一个参数，所以要包装一下。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validateEmail</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$email</span></span>): <span class="hljs-title">string</span>
</span>{
    <span class="hljs-comment">// filter_var 返回过滤后的值或 false</span>
    <span class="hljs-variable">$validated</span> = <span class="hljs-title function_ invoke__">filter_var</span>(<span class="hljs-variable">$email</span>, FILTER_VALIDATE_EMAIL);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$validated</span> === <span class="hljs-literal">false</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Invalid email: <span class="hljs-subst">{$email}</span>"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$validated</span>;
}
<span class="hljs-variable">$rawEmail</span> = <span class="hljs-string">"  alice@example.com  "</span>;
<span class="hljs-variable">$email</span> = <span class="hljs-variable">$rawEmail</span>
    |&gt; <span class="hljs-title function_ invoke__">trim</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">validateEmail</span>(...);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$email</span>;
</code></pre>
<p>读起来很顺：trim → 小写 → 验证。</p>
<h4 data-id="heading-7">单行验证阶段（throw 作为表达式）</h4>
<p>如果你喜欢更紧凑的管道，PHP 的 <code>throw</code> 是表达式（PHP 8.0 起），可以这样：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-variable">$rawEmail</span> = <span class="hljs-string">"  alice@example.com  "</span>;
<span class="hljs-variable">$email</span> = <span class="hljs-variable">$rawEmail</span>
    |&gt; <span class="hljs-title function_ invoke__">trim</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...)
    |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$v</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">filter_var</span>(<span class="hljs-variable">$v</span>, FILTER_VALIDATE_EMAIL)
        ?: <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Invalid email: <span class="hljs-subst">{$v}</span>"</span>)
    );
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$email</span>;
</code></pre>
<p>一个小但重要的语法注意点：</p>
<p>在 <code>|&gt;</code> 右边用箭头函数时，必须用括号包起来，避免解析歧义。</p>
<p>所以这是必须的：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$value</span> |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">doSomething</span>(<span class="hljs-variable">$x</span>));
</code></pre>
<p>不是：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// ❌ 这会解析失败</span>
<span class="hljs-variable">$value</span> |&gt; <span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">doSomething</span>(<span class="hljs-variable">$x</span>);
</code></pre>
<h4 data-id="heading-8">让它"真实"：规范化 Gmail 地址</h4>
<p>加个实际的转换：对于 Gmail 地址，本地部分的点被忽略，<code>+tag</code> 也被忽略。很多系统会规范化这些。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">canonicalizeGmail</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$email</span></span>): <span class="hljs-title">string</span>
</span>{
    [<span class="hljs-variable">$local</span>, <span class="hljs-variable">$domain</span>] = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">'@'</span>, <span class="hljs-variable">$email</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$domain</span> !== <span class="hljs-string">'gmail.com'</span> &amp;&amp; <span class="hljs-variable">$domain</span> !== <span class="hljs-string">'googlemail.com'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$email</span>;
    }
    <span class="hljs-comment">// 移除 plus tag</span>
    <span class="hljs-variable">$local</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">'+'</span>, <span class="hljs-variable">$local</span>, <span class="hljs-number">2</span>)[<span class="hljs-number">0</span>];
    <span class="hljs-comment">// 移除点</span>
    <span class="hljs-variable">$local</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">'.'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$local</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$local</span> . <span class="hljs-string">'@gmail.com'</span>;
}
<span class="hljs-variable">$rawEmail</span> = <span class="hljs-string">"  Alice.Example+promo@GMAIL.com  "</span>;
<span class="hljs-variable">$email</span> = <span class="hljs-variable">$rawEmail</span>
    |&gt; <span class="hljs-title function_ invoke__">trim</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...)
    |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$v</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">filter_var</span>(<span class="hljs-variable">$v</span>, FILTER_VALIDATE_EMAIL)
        ?: <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Invalid email: <span class="hljs-subst">{$v}</span>"</span>)
    )
    |&gt; <span class="hljs-title function_ invoke__">canonicalizeGmail</span>(...);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$email</span>;
<span class="hljs-comment">// "aliceexample@gmail.com"</span>
</code></pre>
<p>这就是 <code>|&gt;</code> 开始发光的地方：加步骤时管道保持可读。</p>
<h3 data-id="heading-9">数组和集合的管道：map / filter / reduce（真实用例）</h3>
<p>字符串简单。数组是很多 PHP 代码库开始变乱的地方——因为标准库很强大，但函数签名经常不太适合管道化。</p>
<p>来个常见任务：处理原始订单数据，计算"已支付"订单的收入。</p>
<p>假设你读了 JSON，得到这样的数组：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$orders</span> = [
    [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'paid'</span>,   <span class="hljs-string">'total'</span> =&gt; <span class="hljs-number">120.50</span>],
    [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">2</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'failed'</span>, <span class="hljs-string">'total'</span> =&gt;  <span class="hljs-number">80.00</span>],
    [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">3</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'paid'</span>,   <span class="hljs-string">'total'</span> =&gt;  <span class="hljs-number">42.25</span>],
];
</code></pre>
<p>目标：用清晰的管道求已支付订单的 total 之和。</p>
<h4 data-id="heading-10">保持管道干净的辅助函数</h4>
<p><code>array_filter</code>、<code>array_map</code> 和 <code>array_reduce</code> 很好用，但不包装一下没法干净地接受单个"管道值"。</p>
<p>一个实用模式是创建小辅助函数，返回单参数 callable。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">map</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> <span class="hljs-variable">$fn</span></span>): <span class="hljs-title">Closure</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$items</span></span>): <span class="hljs-title">array</span> =&gt;</span> <span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-variable">$fn</span>, <span class="hljs-variable">$items</span>);
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> <span class="hljs-variable">$fn</span></span>): <span class="hljs-title">Closure</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$items</span></span>): <span class="hljs-title">array</span> =&gt;</span> <span class="hljs-title function_ invoke__">array_filter</span>(<span class="hljs-variable">$items</span>, <span class="hljs-variable">$fn</span>);
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reduce</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> <span class="hljs-variable">$fn</span>, <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$initial</span></span>): <span class="hljs-title">Closure</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$items</span></span>): <span class="hljs-title">mixed</span> =&gt;</span> <span class="hljs-title function_ invoke__">array_reduce</span>(<span class="hljs-variable">$items</span>, <span class="hljs-variable">$fn</span>, <span class="hljs-variable">$initial</span>);
}
</code></pre>
<p>现在可以顺畅地管道数组了。</p>
<h4 data-id="heading-11">已支付收入管道</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-variable">$orders</span> = [
    [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">1</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'paid'</span>,   <span class="hljs-string">'total'</span> =&gt; <span class="hljs-number">120.50</span>],
    [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">2</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'failed'</span>, <span class="hljs-string">'total'</span> =&gt;  <span class="hljs-number">80.00</span>],
    [<span class="hljs-string">'id'</span> =&gt; <span class="hljs-number">3</span>, <span class="hljs-string">'status'</span> =&gt; <span class="hljs-string">'paid'</span>,   <span class="hljs-string">'total'</span> =&gt;  <span class="hljs-number">42.25</span>],
];
<span class="hljs-variable">$paidRevenue</span> = <span class="hljs-variable">$orders</span>
    |&gt; <span class="hljs-title function_ invoke__">filter</span>(fn (<span class="hljs-keyword">array</span> <span class="hljs-variable">$o</span>) =&gt; <span class="hljs-variable">$o</span>[<span class="hljs-string">'status'</span>] === <span class="hljs-string">'paid'</span>)
    |&gt; <span class="hljs-title function_ invoke__">map</span>(fn (<span class="hljs-keyword">array</span> <span class="hljs-variable">$o</span>) =&gt; (<span class="hljs-keyword">float</span>) <span class="hljs-variable">$o</span>[<span class="hljs-string">'total'</span>])
    |&gt; <span class="hljs-title function_ invoke__">reduce</span>(fn (<span class="hljs-keyword">float</span> <span class="hljs-variable">$sum</span>, <span class="hljs-keyword">float</span> <span class="hljs-variable">$t</span>) =&gt; <span class="hljs-variable">$sum</span> + <span class="hljs-variable">$t</span>, <span class="hljs-number">0.0</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-variable">$paidRevenue</span>; <span class="hljs-comment">// 162.75</span>
</code></pre>
<p>像英语一样读：</p>
<ul>
<li>过滤已支付订单</li>
<li>映射到 total</li>
<li>归约成总和</li>
</ul>
<h4 data-id="heading-12">稍微丰富的真实例子：CSV 风格的行转干净记录</h4>
<p>假设你有一组行：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$lines</span> = [
    <span class="hljs-string">" alice@example.com , paid "</span>,
    <span class="hljs-string">" bob@invalid-domain , paid "</span>,
    <span class="hljs-string">" charlie@example.com , failed "</span>,
    <span class="hljs-string">"  dora@example.com, paid "</span>,
];
</code></pre>
<p>目标：</p>
<ul>
<li>解析成 <code>[email, status]</code></li>
<li>规范化邮箱</li>
<li>验证邮箱（丢弃无效的）</li>
<li>只保留已支付</li>
<li>返回规范化邮箱列表</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalizeEmail</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$email</span></span>): <span class="hljs-title">string</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$email</span>));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isValidEmail</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$email</span></span>): <span class="hljs-title">bool</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">filter_var</span>(<span class="hljs-variable">$email</span>, FILTER_VALIDATE_EMAIL) !== <span class="hljs-literal">false</span>;
}

<span class="hljs-variable">$lines</span> = [
    <span class="hljs-string">" alice@example.com , paid "</span>,
    <span class="hljs-string">" bob@invalid-domain , paid "</span>,
    <span class="hljs-string">" charlie@example.com , failed "</span>,
    <span class="hljs-string">"  dora@example.com, paid "</span>,
];

<span class="hljs-variable">$paidEmails</span> = <span class="hljs-variable">$lines</span>
    |&gt; <span class="hljs-title function_ invoke__">map</span>(fn (<span class="hljs-keyword">string</span> <span class="hljs-variable">$line</span>) =&gt; <span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-string">'trim'</span>, <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">','</span>, <span class="hljs-variable">$line</span>)))
    |&gt; <span class="hljs-title function_ invoke__">map</span>(fn (<span class="hljs-keyword">array</span> <span class="hljs-variable">$parts</span>) =&gt; [<span class="hljs-string">'email'</span> =&gt; <span class="hljs-title function_ invoke__">normalizeEmail</span>(<span class="hljs-variable">$parts</span>[<span class="hljs-number">0</span>]), <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$parts</span>[<span class="hljs-number">1</span>]])
    |&gt; <span class="hljs-title function_ invoke__">filter</span>(fn (<span class="hljs-keyword">array</span> <span class="hljs-variable">$r</span>) =&gt; <span class="hljs-title function_ invoke__">isValidEmail</span>(<span class="hljs-variable">$r</span>[<span class="hljs-string">'email'</span>]))
    |&gt; <span class="hljs-title function_ invoke__">filter</span>(fn (<span class="hljs-keyword">array</span> <span class="hljs-variable">$r</span>) =&gt; <span class="hljs-variable">$r</span>[<span class="hljs-string">'status'</span>] === <span class="hljs-string">'paid'</span>)
    |&gt; <span class="hljs-title function_ invoke__">map</span>(fn (<span class="hljs-keyword">array</span> <span class="hljs-variable">$r</span>) =&gt; <span class="hljs-variable">$r</span>[<span class="hljs-string">'email'</span>])
    |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$arr</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">array_values</span>(<span class="hljs-variable">$arr</span>));

<span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$paidEmails</span>);
<span class="hljs-comment">// ['alice@example.com', 'dora@example.com']</span>
</code></pre>
<p>注意：</p>
<ul>
<li>每个阶段是一个转换</li>
<li>验证在管道里，但不用 <code>normalizeEmail(...)</code> 因为它可能抛异常</li>
<li><code>array_filter</code> 保留键，所以最后 <code>array_values()</code> 是常见的清理步骤</li>
</ul>
<p>这种转换管道就是 <code>|&gt;</code> 发挥价值的地方。</p>
<h3 data-id="heading-13">管道 + 错误处理：try/catch vs 守卫子句</h3>
<p>管道是表达式。错误处理是很多团队要么喜欢要么讨厌这种风格的地方。</p>
<p>有两种健康的方式：</p>
<h4 data-id="heading-14">选项 A：管道外的守卫子句（无聊但很清晰）</h4>
<p>这是"别耍聪明"的方式：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-variable">$email</span> = <span class="hljs-variable">$rawEmail</span>
    |&gt; <span class="hljs-title function_ invoke__">trim</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$email</span> === <span class="hljs-string">''</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Email is required.'</span>);
}
<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">filter_var</span>(<span class="hljs-variable">$email</span>, FILTER_VALIDATE_EMAIL) === <span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Email is invalid.'</span>);
}
</code></pre>
<p>优点：</p>
<ul>
<li>非常明确</li>
<li>容易调试</li>
<li>闭包里没有异常技巧</li>
</ul>
<p>缺点：</p>
<ul>
<li>"故事"被拆成管道 + 单独的验证块</li>
</ul>
<h4 data-id="heading-15">选项 B：管道里抛异常，外面 catch（适合"全有或全无"）</h4>
<p>当管道逻辑上是一个操作——"解析并规范化这个输入，否则失败"——整个包起来可以很干净：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$email</span> = <span class="hljs-variable">$rawEmail</span>
        |&gt; <span class="hljs-title function_ invoke__">trim</span>(...)
        |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...)
        |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$v</span></span>) =&gt;</span> <span class="hljs-variable">$v</span> !== <span class="hljs-string">''</span>
            ? <span class="hljs-variable">$v</span>
            : <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Email is required.'</span>)
        )
        |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$v</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">filter_var</span>(<span class="hljs-variable">$v</span>, FILTER_VALIDATE_EMAIL)
            ?: <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Email is invalid.'</span>)
        );
    <span class="hljs-comment">// 使用 $email</span>
} <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">InvalidArgumentException</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-comment">// 处理验证错误</span>
}
</code></pre>
<p>优点：</p>
<ul>
<li>管道读起来像单个"事务"</li>
<li>适合请求解析/DTO 构建</li>
</ul>
<p>缺点：</p>
<ul>
<li>过度使用会让人觉得异常被当作控制流</li>
</ul>
<h4 data-id="heading-16">调试友好的模式：inspect()（管道的"tap"）</h4>
<p>管道代码的一个批评是"中间值更难调试"。</p>
<p>你可以插入一个阶段来记录并原样返回值，不用放弃管道。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inspect</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> <span class="hljs-variable">$fn</span></span>): <span class="hljs-title">Closure</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span></span>) <span class="hljs-keyword">use</span> (<span class="hljs-params"><span class="hljs-variable">$fn</span></span>) </span>{
        <span class="hljs-variable">$fn</span>(<span class="hljs-variable">$value</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;
    };
}
<span class="hljs-variable">$result</span> = <span class="hljs-variable">$rawEmail</span>
    |&gt; <span class="hljs-title function_ invoke__">trim</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">inspect</span>(fn (<span class="hljs-variable">$v</span>) =&gt; <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">"After trim: "</span> . <span class="hljs-variable">$v</span>))
    |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">inspect</span>(fn (<span class="hljs-variable">$v</span>) =&gt; <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-string">"After lower: "</span> . <span class="hljs-variable">$v</span>));
</code></pre>
<p>这保持了从左到右的流，同时让中间状态在调试时可见。</p>
<h3 data-id="heading-17">与函数和方法的互操作：写出保持可读的管道</h3>
<p>管道操作符很简单；艺术在于用它而不让代码看起来像聪明的谜题。</p>
<h4 data-id="heading-18">签名匹配时优先用一等公民 callable</h4>
<p>如果函数已经接受单个必需参数，这是最干净的形式：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$value</span> |&gt; <span class="hljs-title function_ invoke__">trim</span>(...) |&gt; <span class="hljs-title function_ invoke__">strtolower</span>(...);
</code></pre>
<p>因为 <code>trim(...)</code> 是 callable 引用，不是调用。它是"一个你可以传递的函数"。</p>
<h4 data-id="heading-19">用命名函数表达"业务含义"</h4>
<p>如果一个阶段不明显，给它起个名字。</p>
<p>不要：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$data</span> |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) =&gt;</span> <span class="hljs-comment">/* 12 行逻辑 */</span>);
</code></pre>
<p>要：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$data</span> |&gt; <span class="hljs-title function_ invoke__">normalizeCustomerPayload</span>(...);
</code></pre>
<p>管道应该读起来像高层脚本。</p>
<h4 data-id="heading-20">管道到方法（实例和静态）</h4>
<p>如果你有个 mapper 对象：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserMapper</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toDto</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$row</span></span>): <span class="hljs-title">UserDto</span>
    </span>{
        <span class="hljs-comment">// ...</span>
    }
}
<span class="hljs-variable">$mapper</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMapper</span>();
<span class="hljs-variable">$dto</span> = <span class="hljs-variable">$row</span>
    |&gt; <span class="hljs-variable">$mapper</span>-&gt;<span class="hljs-title function_ invoke__">toDto</span>(...);
</code></pre>
<p>或静态方法：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$dto</span> = <span class="hljs-variable">$row</span> |&gt; <span class="hljs-title class_">UserMapper</span>::<span class="hljs-title function_ invoke__">fromRow</span>(...);
</code></pre>
<h4 data-id="heading-21">处理需要额外参数的函数</h4>
<p>记住：管道传一个参数。很多 PHP 标准函数要更多。</p>
<p>例子：<code>explode('.', $value)</code> 需要两个必需参数，所以不能这样：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// ❌ explode 需要 2 个参数；这直接不行</span>
<span class="hljs-variable">$parts</span> = <span class="hljs-variable">$domain</span> |&gt; <span class="hljs-title function_ invoke__">explode</span>(...);
</code></pre>
<p>包装一下：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$parts</span> = <span class="hljs-variable">$domain</span> |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$v</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">'.'</span>, <span class="hljs-variable">$v</span>));
</code></pre>
<p>或者，如果你喜欢，创建一个小辅助函数来"预配置"函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">explodeBy</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$delimiter</span></span>): <span class="hljs-title">Closure</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">array</span> =&gt;</span> <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-variable">$delimiter</span>, <span class="hljs-variable">$value</span>);
}

<span class="hljs-variable">$parts</span> = <span class="hljs-variable">$domain</span> |&gt; <span class="hljs-title function_ invoke__">explodeBy</span>(<span class="hljs-string">'.'</span>);
</code></pre>
<p>这种"配置好的 callable"方式在真实代码里扩展性很好。</p>
<h4 data-id="heading-22">操作符优先级陷阱（用括号保持无聊）</h4>
<p>RFC 和手册指出 <code>|&gt;</code> 有定义的优先级且是左结合的。实际上，跟 <code>??</code>、三元运算符或更复杂的表达式混用时应该用括号，除非明显安全。</p>
<p>例子：先选 callable，再管道进去：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$fn</span> = <span class="hljs-variable">$flag</span> ? <span class="hljs-title function_ invoke__">enabledFunc</span>(...) : <span class="hljs-title function_ invoke__">disabledFunc</span>(...);
<span class="hljs-variable">$result</span> = <span class="hljs-variable">$value</span> |&gt; <span class="hljs-variable">$fn</span>;
</code></pre>
<p>如果你坚持内联，用括号：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$result</span> = <span class="hljs-variable">$value</span> |&gt; (<span class="hljs-variable">$flag</span> ? <span class="hljs-title function_ invoke__">enabledFunc</span>(...) : <span class="hljs-title function_ invoke__">disabledFunc</span>(...));
</code></pre>
<h4 data-id="heading-23">另一个尖锐边缘：引用传递的 callable 不允许</h4>
<p>有些 PHP 函数按引用接受参数。管道操作符不允许管道到需要引用传递参数的 callable。</p>
<p>大多数日常管道不需要引用——但知道为什么有些函数在管道里不工作是好的。</p>
<h3 data-id="heading-24">什么时候不该用 |&gt;（是的，这是真事）</h3>
<p>管道操作符是工具，不是宗教。这些情况通常是错误选择。</p>
<h4 data-id="heading-25">需要大量分支逻辑时</h4>
<p>如果你的转换有多个提前退出、复杂条件和嵌套循环，管道会变得勉强。</p>
<p>干净的 if/else 块通常比把所有东西塞进闭包好。</p>
<h4 data-id="heading-26">副作用是主要目的时</h4>
<p>管道在每个阶段是纯转换时最好：输入 → 输出。</p>
<p>如果目的是"发邮件"、"写数据库"、"发布事件"，你仍然可以管道，但容易在链里隐藏重要副作用，让流程更难理解。</p>
<p>如果确实需要副作用，优先用明确的 <code>inspect()</code> 阶段，让发生的事情清晰。</p>
<h4 data-id="heading-27">管道变成"闭包汤"时</h4>
<p>如果每隔一个阶段是：</p>
<pre><code class="hljs language-php" lang="php">|&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">someFunc</span>(<span class="hljs-variable">$x</span>, <span class="hljs-variable">$a</span>, <span class="hljs-variable">$b</span>, <span class="hljs-variable">$c</span>))
</code></pre>
<p>你可能在跟 PHP 的函数签名较劲太多。</p>
<p>这时候：</p>
<ul>
<li>提取命名辅助函数</li>
<li>或用直接的顺序代码</li>
</ul>
<h4 data-id="heading-28">调试是主要活动时</h4>
<p>管道可以调试，但如果你在事故响应的热循环里，临时变量仍然是你的朋友。</p>
<p>可读代码是你能快速插桩和检查的代码。</p>
<h4 data-id="heading-29">链太长时</h4>
<p>经验法则：如果管道超过 6-10 个阶段，考虑把阶段分组成命名函数。</p>
<p>不要：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$payload</span>
    |&gt; <span class="hljs-title function_ invoke__">step1</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">step2</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">step3</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">step4</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">step5</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">step6</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">step7</span>(...);
</code></pre>
<p>要：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$payload</span>
    |&gt; <span class="hljs-title function_ invoke__">normalizePayload</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">validatePayload</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">buildDto</span>(...);
</code></pre>
<h3 data-id="heading-30">重构清单：安全地从嵌套调用迁移到管道</h3>
<p>如果你想在现有代码库引入 <code>|&gt;</code>，这是个实用方法，不会搞坏东西或惹恼团队。</p>
<h4 data-id="heading-31">从有测试覆盖的转换开始</h4>
<p>选一个函数：</p>
<ul>
<li>有清晰的输入/输出</li>
<li>不修改全局状态</li>
<li>有单元或集成测试覆盖</li>
</ul>
<p>逻辑已经稳定时管道最容易（也最安全）。</p>
<h4 data-id="heading-32">先把嵌套调用转成顺序步骤（可选但有效）</h4>
<p>如果你从这开始：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$out</span> = <span class="hljs-title function_ invoke__">c</span>(<span class="hljs-title function_ invoke__">b</span>(<span class="hljs-title function_ invoke__">a</span>(<span class="hljs-variable">$in</span>)));
</code></pre>
<p>改写成：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$tmp</span> = <span class="hljs-variable">$in</span>;
<span class="hljs-variable">$tmp</span> = <span class="hljs-title function_ invoke__">a</span>(<span class="hljs-variable">$tmp</span>);
<span class="hljs-variable">$tmp</span> = <span class="hljs-title function_ invoke__">b</span>(<span class="hljs-variable">$tmp</span>);
<span class="hljs-variable">$out</span> = <span class="hljs-title function_ invoke__">c</span>(<span class="hljs-variable">$tmp</span>);
</code></pre>
<p>这让逻辑阶段明确。然后管道化：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$out</span> = <span class="hljs-variable">$in</span>
    |&gt; <span class="hljs-title function_ invoke__">a</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">b</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">c</span>(...);
</code></pre>
<h4 data-id="heading-33">用小的"可配置 callable"辅助函数处理多参数函数</h4>
<p>不要到处撒包装闭包，集中模式如：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">withDelimiter</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$d</span></span>): <span class="hljs-title">Closure</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$v</span></span>): <span class="hljs-title">array</span> =&gt;</span> <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-variable">$d</span>, <span class="hljs-variable">$v</span>);
}
</code></pre>
<p>这让管道保持干净一致。</p>
<h4 data-id="heading-34">保持验证语义一致</h4>
<p>如果你的旧代码失败时返回 null，不要在管道里悄悄换成抛异常，除非你准备好更新调用代码。</p>
<p>明确管道是：</p>
<ul>
<li>返回结果或 null</li>
<li>返回结果或 false</li>
<li>无效输入时抛异常</li>
</ul>
<p>管道可以表达任何这些风格——但随机混用让代码更难理解。</p>
<h4 data-id="heading-35">采用一种格式风格并坚持</h4>
<p>可读的管道通常这样：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$result</span> = <span class="hljs-variable">$value</span>
    |&gt; <span class="hljs-title function_ invoke__">step1</span>(...)
    |&gt; <span class="hljs-title function_ invoke__">step2</span>(...)
    |&gt; (<span class="hljs-function"><span class="hljs-keyword">fn</span> (<span class="hljs-params"><span class="hljs-variable">$x</span></span>) =&gt;</span> <span class="hljs-title function_ invoke__">step3</span>(<span class="hljs-variable">$x</span>))
    |&gt; <span class="hljs-title function_ invoke__">step4</span>(...);
</code></pre>
<p>常见做法：</p>
<ul>
<li>每行一个阶段</li>
<li>对齐管道符</li>
<li>闭包保持短</li>
<li>长闭包提取成命名函数</li>
</ul>
<h4 data-id="heading-36">加"检查点"调试，然后移除</h4>
<p>重构期间，插入 <code>inspect()</code> 阶段验证中间值。一切检查通过后，移除或降级成正式日志。</p>
<h4 data-id="heading-37">用代码审查强制"管道用于转换，不是用于一切"</h4>
<p>管道操作符可以提高可读性。也可以变成隐藏复杂性的时尚声明。</p>
<p>一个简单的审查指南有帮助：</p>
<ul>
<li>用 <code>|&gt;</code> 做转换管道</li>
<li>避免 <code>|&gt;</code> 做复杂分支或副作用密集的序列</li>
<li>优先命名函数而不是长内联闭包</li>
</ul>
<h3 data-id="heading-38">结论：|&gt; 最好用在读起来像故事的时候</h3>
<p>PHP 8.5 的管道操作符不是替代经典 PHP 风格——它是补充。</p>
<p>用它当你想：</p>
<ul>
<li>把转换表达成从左到右的流</li>
<li>减少嵌套括号</li>
<li>让"数据故事"在代码里可见</li>
</ul>
<p>避免它当它变成：</p>
<ul>
<li>隐藏的副作用</li>
<li>密集的闭包链</li>
<li>伪装成优雅的复杂分支</li>
</ul>
<p>如果你保持管道聚焦，给有意义的步骤命名，把调试/验证当作一等公民，<code>|&gt;</code> 能让 PHP 代码感觉明显更现代——不牺牲团队需要的实用、可读风格。</p>
<h3 data-id="heading-39">参考</h3>
<ul>
<li>PHP 手册："函数式操作符"（管道操作符 <code>|&gt;</code>；callable 约束；箭头函数括号要求）</li>
<li>PHP RFC："Pipe Operator v3"（设计、优先级说明、引用限制、性能说明）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>